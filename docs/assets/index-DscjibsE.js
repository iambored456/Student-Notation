var lv=Object.defineProperty;var cv=(n,e,s)=>e in n?lv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var Ps=(n,e,s)=>cv(n,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();function hv(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Sa={exports:{}};/*! For license information please see Tone.js.LICENSE.txt */var uv=Sa.exports,od;function dv(){return od||(od=1,function(n,e){(function(s,i){n.exports=i()})(typeof self<"u"?self:uv,()=>(()=>{var s={871:function(c,h,m){(function(f,v,y,w){var x=function(it,rt,at){return{endTime:rt,insertTime:at,type:"exponentialRampToValue",value:it}},A=function(it,rt,at){return{endTime:rt,insertTime:at,type:"linearRampToValue",value:it}},E=function(it,rt){return{startTime:rt,type:"setValue",value:it}},M=function(it,rt,at){return{duration:at,startTime:rt,type:"setValueCurve",values:it}},I=function(it,rt,at){var Tt=at.startTime,dt=at.target,Nt=at.timeConstant;return dt+(rt-dt)*Math.exp((Tt-it)/Nt)},R=function(it){return it.type==="exponentialRampToValue"},D=function(it){return it.type==="linearRampToValue"},G=function(it){return R(it)||D(it)},X=function(it){return it.type==="setValue"},F=function(it){return it.type==="setValueCurve"},H=function it(rt,at,Tt,dt){var Nt=rt[at];return Nt===void 0?dt:G(Nt)||X(Nt)?Nt.value:F(Nt)?Nt.values[Nt.values.length-1]:I(Tt,it(rt,at-1,Nt.startTime,dt),Nt)},Q=function(it,rt,at,Tt,dt){return at===void 0?[Tt.insertTime,dt]:G(at)?[at.endTime,at.value]:X(at)?[at.startTime,at.value]:F(at)?[at.startTime+at.duration,at.values[at.values.length-1]]:[at.startTime,H(it,rt-1,at.startTime,dt)]},K=function(it){return it.type==="cancelAndHold"},pt=function(it){return it.type==="cancelScheduledValues"},ut=function(it){return K(it)||pt(it)?it.cancelTime:R(it)||D(it)?it.endTime:it.startTime},_t=function(it,rt,at,Tt){var dt=Tt.endTime,Nt=Tt.value;return at===Nt?Nt:0<at&&0<Nt||at<0&&Nt<0?at*Math.pow(Nt/at,(it-rt)/(dt-rt)):0},xt=function(it,rt,at,Tt){return at+(it-rt)/(Tt.endTime-rt)*(Tt.value-at)},Zt=function(it,rt){var at=rt.duration,Tt=rt.startTime,dt=rt.values;return function(Nt,jt){var Bt=Math.floor(jt),ne=Math.ceil(jt);return Bt===ne?Nt[Bt]:(1-(jt-Bt))*Nt[Bt]+(1-(ne-jt))*Nt[ne]}(dt,(it-Tt)/at*(dt.length-1))},Wt=function(it){return it.type==="setTarget"},Jt=function(){return w(function it(rt){y(this,it),this._automationEvents=[],this._currenTime=0,this._defaultValue=rt},[{key:Symbol.iterator,value:function(){return this._automationEvents[Symbol.iterator]()}},{key:"add",value:function(it){var rt=ut(it);if(K(it)||pt(it)){var at=this._automationEvents.findIndex(function(Le){return pt(it)&&F(Le)?Le.startTime+Le.duration>=rt:ut(Le)>=rt}),Tt=this._automationEvents[at];if(at!==-1&&(this._automationEvents=this._automationEvents.slice(0,at)),K(it)){var dt=this._automationEvents[this._automationEvents.length-1];if(Tt!==void 0&&G(Tt)){if(dt!==void 0&&Wt(dt))throw new Error("The internal list is malformed.");var Nt=dt===void 0?Tt.insertTime:F(dt)?dt.startTime+dt.duration:ut(dt),jt=dt===void 0?this._defaultValue:F(dt)?dt.values[dt.values.length-1]:dt.value,Bt=R(Tt)?_t(rt,Nt,jt,Tt):xt(rt,Nt,jt,Tt),ne=R(Tt)?x(Bt,rt,this._currenTime):A(Bt,rt,this._currenTime);this._automationEvents.push(ne)}if(dt!==void 0&&Wt(dt)&&this._automationEvents.push(E(this.getValue(rt),rt)),dt!==void 0&&F(dt)&&dt.startTime+dt.duration>rt){var Xe=rt-dt.startTime,qt=(dt.values.length-1)/dt.duration,xe=Math.max(2,1+Math.ceil(Xe*qt)),Ue=Xe/(xe-1)*qt,Ze=dt.values.slice(0,xe);if(Ue<1)for(var Re=1;Re<xe;Re+=1){var Qe=Ue*Re%1;Ze[Re]=dt.values[Re-1]*(1-Qe)+dt.values[Re]*Qe}this._automationEvents[this._automationEvents.length-1]=M(Ze,dt.startTime,Xe)}}}else{var Te=this._automationEvents.findIndex(function(Le){return ut(Le)>rt}),Cs=Te===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[Te-1];if(Cs!==void 0&&F(Cs)&&ut(Cs)+Cs.duration>rt)return!1;var an=R(it)?x(it.value,it.endTime,this._currenTime):D(it)?A(it.value,rt,this._currenTime):it;if(Te===-1)this._automationEvents.push(an);else{if(F(it)&&rt+it.duration>ut(this._automationEvents[Te]))return!1;this._automationEvents.splice(Te,0,an)}}return!0}},{key:"flush",value:function(it){var rt=this._automationEvents.findIndex(function(dt){return ut(dt)>it});if(rt>1){var at=this._automationEvents.slice(rt-1),Tt=at[0];Wt(Tt)&&at.unshift(E(H(this._automationEvents,rt-2,Tt.startTime,this._defaultValue),Tt.startTime)),this._automationEvents=at}}},{key:"getValue",value:function(it){if(this._automationEvents.length===0)return this._defaultValue;var rt=this._automationEvents.findIndex(function(Ze){return ut(Ze)>it}),at=this._automationEvents[rt],Tt=(rt===-1?this._automationEvents.length:rt)-1,dt=this._automationEvents[Tt];if(dt!==void 0&&Wt(dt)&&(at===void 0||!G(at)||at.insertTime>it))return I(it,H(this._automationEvents,Tt-1,dt.startTime,this._defaultValue),dt);if(dt!==void 0&&X(dt)&&(at===void 0||!G(at)))return dt.value;if(dt!==void 0&&F(dt)&&(at===void 0||!G(at)||dt.startTime+dt.duration>it))return it<dt.startTime+dt.duration?Zt(it,dt):dt.values[dt.values.length-1];if(dt!==void 0&&G(dt)&&(at===void 0||!G(at)))return dt.value;if(at!==void 0&&R(at)){var Nt=Q(this._automationEvents,Tt,dt,at,this._defaultValue),jt=v(Nt,2),Bt=jt[0],ne=jt[1];return _t(it,Bt,ne,at)}if(at!==void 0&&D(at)){var Xe=Q(this._automationEvents,Tt,dt,at,this._defaultValue),qt=v(Xe,2),xe=qt[0],Ue=qt[1];return xt(it,xe,Ue,at)}return this._defaultValue}}])}();f.AutomationEventList=Jt,f.createCancelAndHoldAutomationEvent=function(it){return{cancelTime:it,type:"cancelAndHold"}},f.createCancelScheduledValuesAutomationEvent=function(it){return{cancelTime:it,type:"cancelScheduledValues"}},f.createExponentialRampToValueAutomationEvent=function(it,rt){return{endTime:rt,type:"exponentialRampToValue",value:it}},f.createLinearRampToValueAutomationEvent=function(it,rt){return{endTime:rt,type:"linearRampToValue",value:it}},f.createSetTargetAutomationEvent=function(it,rt,at){return{startTime:rt,target:it,timeConstant:at,type:"setTarget"}},f.createSetValueAutomationEvent=E,f.createSetValueCurveAutomationEvent=M})(h,m(821),m(805),m(989))},113:c=>{c.exports=function(h,m){(m==null||m>h.length)&&(m=h.length);for(var f=0,v=new Array(m);f<m;f++)v[f]=h[f];return v},c.exports.__esModule=!0,c.exports.default=c.exports},569:c=>{c.exports=function(h){if(Array.isArray(h))return h},c.exports.__esModule=!0,c.exports.default=c.exports},805:c=>{c.exports=function(h,m){if(!(h instanceof m))throw new TypeError("Cannot call a class as a function")},c.exports.__esModule=!0,c.exports.default=c.exports},989:(c,h,m)=>{var f=m(498);function v(y,w){for(var x=0;x<w.length;x++){var A=w[x];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(y,f(A.key),A)}}c.exports=function(y,w,x){return w&&v(y.prototype,w),x&&v(y,x),Object.defineProperty(y,"prototype",{writable:!1}),y},c.exports.__esModule=!0,c.exports.default=c.exports},474:c=>{c.exports=function(h,m){var f=h==null?null:typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(f!=null){var v,y,w,x,A=[],E=!0,M=!1;try{if(w=(f=f.call(h)).next,m===0){if(Object(f)!==f)return;E=!1}else for(;!(E=(v=w.call(f)).done)&&(A.push(v.value),A.length!==m);E=!0);}catch(I){M=!0,y=I}finally{try{if(!E&&f.return!=null&&(x=f.return(),Object(x)!==x))return}finally{if(M)throw y}}return A}},c.exports.__esModule=!0,c.exports.default=c.exports},18:c=>{c.exports=function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)},c.exports.__esModule=!0,c.exports.default=c.exports},821:(c,h,m)=>{var f=m(569),v=m(474),y=m(744),w=m(18);c.exports=function(x,A){return f(x)||v(x,A)||y(x,A)||w()},c.exports.__esModule=!0,c.exports.default=c.exports},327:(c,h,m)=>{var f=m(564).default;c.exports=function(v,y){if(f(v)!="object"||!v)return v;var w=v[Symbol.toPrimitive];if(w!==void 0){var x=w.call(v,y||"default");if(f(x)!="object")return x;throw new TypeError("@@toPrimitive must return a primitive value.")}return(y==="string"?String:Number)(v)},c.exports.__esModule=!0,c.exports.default=c.exports},498:(c,h,m)=>{var f=m(564).default,v=m(327);c.exports=function(y){var w=v(y,"string");return f(w)=="symbol"?w:w+""},c.exports.__esModule=!0,c.exports.default=c.exports},564:c=>{function h(m){return c.exports=h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(f){return typeof f}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},c.exports.__esModule=!0,c.exports.default=c.exports,h(m)}c.exports=h,c.exports.__esModule=!0,c.exports.default=c.exports},744:(c,h,m)=>{var f=m(113);c.exports=function(v,y){if(v){if(typeof v=="string")return f(v,y);var w=Object.prototype.toString.call(v).slice(8,-1);return w==="Object"&&v.constructor&&(w=v.constructor.name),w==="Map"||w==="Set"?Array.from(v):w==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(w)?f(v,y):void 0}},c.exports.__esModule=!0,c.exports.default=c.exports}},i={};function r(c){var h=i[c];if(h!==void 0)return h.exports;var m=i[c]={exports:{}};return s[c].call(m.exports,m,m.exports,r),m.exports}r.d=(c,h)=>{for(var m in h)r.o(h,m)&&!r.o(c,m)&&Object.defineProperty(c,m,{enumerable:!0,get:h[m]})},r.o=(c,h)=>Object.prototype.hasOwnProperty.call(c,h),r.r=c=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(c,"__esModule",{value:!0})};var a={};return(()=>{r.r(a),r.d(a,{AMOscillator:()=>Io,AMSynth:()=>Pl,Abs:()=>Hu,Add:()=>Zn,AmplitudeEnvelope:()=>$i,Analyser:()=>Yo,AudioToGain:()=>Jr,AutoFilter:()=>zl,AutoPanner:()=>Wl,AutoWah:()=>Vl,BaseContext:()=>vl,BiquadFilter:()=>No,BitCrusher:()=>Hl,Buffer:()=>iv,BufferSource:()=>rv,Buffers:()=>ov,Channel:()=>ti,Chebyshev:()=>jl,Chorus:()=>Ul,Clock:()=>Ri,Compressor:()=>gn,Context:()=>Ai,Convolver:()=>yc,CrossFade:()=>zi,DCMeter:()=>cc,Delay:()=>vs,Destination:()=>Yg,Distortion:()=>Yl,Draw:()=>tv,DuoSynth:()=>kl,EQ3:()=>vc,Emitter:()=>Ti,Envelope:()=>ze,FFT:()=>lc,FMOscillator:()=>Fi,FMSynth:()=>Il,FatOscillator:()=>Ro,FeedbackCombFilter:()=>Bo,FeedbackDelay:()=>Zl,Filter:()=>bs,Follower:()=>jo,Freeverb:()=>Jl,Frequency:()=>Ag,FrequencyClass:()=>Ke,FrequencyEnvelope:()=>Lo,FrequencyShifter:()=>Ql,Gain:()=>bt,GainToAudio:()=>Gu,Gate:()=>pc,GrainPlayer:()=>Ml,GreaterThan:()=>ea,GreaterThanZero:()=>ta,IntervalTimeline:()=>$u,JCReverb:()=>Kl,LFO:()=>es,Limiter:()=>mc,Listener:()=>Jg,Loop:()=>Wo,LowpassCombFilter:()=>$o,Master:()=>Zg,MembraneSynth:()=>Fo,Merge:()=>On,MetalSynth:()=>Rl,Meter:()=>ac,MidSideCompressor:()=>fc,MidSideMerge:()=>Uo,MidSideSplit:()=>Xo,Midi:()=>Ig,MidiClass:()=>Oi,Mono:()=>uc,MonoSynth:()=>Jn,MultibandCompressor:()=>gc,MultibandSplit:()=>Zo,Multiply:()=>de,Negate:()=>El,Noise:()=>Rn,NoiseSynth:()=>Dl,Offline:()=>kg,OfflineContext:()=>Mi,OmniOscillator:()=>pn,OnePoleFilter:()=>qo,Oscillator:()=>ue,PWMOscillator:()=>Do,PanVol:()=>ra,Panner:()=>Go,Panner3D:()=>dc,Param:()=>Et,Part:()=>Vo,Pattern:()=>ql,Phaser:()=>sc,PingPongDelay:()=>tc,PitchShift:()=>ec,Player:()=>qi,Players:()=>Al,PluckSynth:()=>Fl,PolySynth:()=>Bl,Pow:()=>Ni,PulseOscillator:()=>Bi,Recorder:()=>aa,Reverb:()=>nc,Sampler:()=>zo,Scale:()=>mn,ScaleExp:()=>sa,Sequence:()=>$l,Signal:()=>At,Solo:()=>we,Split:()=>Kn,StateTimeline:()=>ki,StereoWidener:()=>ic,Subtract:()=>Qn,SyncedSignal:()=>Lg,Synth:()=>Dn,Ticks:()=>Rg,TicksClass:()=>he,Time:()=>Sg,TimeClass:()=>fs,Timeline:()=>ms,ToneAudioBuffer:()=>$t,ToneAudioBuffers:()=>Di,ToneAudioNode:()=>ot,ToneBufferSource:()=>In,ToneEvent:()=>Ys,ToneOscillatorNode:()=>ko,Transport:()=>Xg,TransportTime:()=>Mg,TransportTimeClass:()=>Se,Tremolo:()=>oc,Unit:()=>h,UserMedia:()=>Po,Vibrato:()=>rc,Volume:()=>un,WaveShaper:()=>$s,Waveform:()=>hc,Zero:()=>Kr,connect:()=>ts,connectSeries:()=>gs,connectSignal:()=>Eo,context:()=>sv,dbToGain:()=>Ei,debug:()=>c,defaultArg:()=>Ms,disconnect:()=>wl,fanIn:()=>Eg,ftom:()=>Pn,gainToDb:()=>Mo,getContext:()=>re,getDestination:()=>Qg,getDraw:()=>ev,getListener:()=>Kg,getTransport:()=>Ug,immediate:()=>jg,intervalToFrequencyRatio:()=>Pi,isArray:()=>Be,isBoolean:()=>ul,isDefined:()=>It,isFunction:()=>Iu,isNote:()=>Co,isNumber:()=>ds,isObject:()=>cn,isString:()=>Fs,isUndef:()=>rs,loaded:()=>nv,mtof:()=>yl,now:()=>Gg,optionsFromArguments:()=>tt,setContext:()=>Ur,start:()=>xg,supported:()=>vg,version:()=>m});var c={};r.r(c),r.d(c,{assert:()=>wt,assertContextRunning:()=>dl,assertRange:()=>qe,assertUsedScheduleTime:()=>Ou,enterScheduledCallback:()=>pl,log:()=>Nu,setLogger:()=>yg,warn:()=>xi});var h={};r.r(h);const m="15.0.4";var f=r(871);const v=new WeakSet,y=new WeakMap,w=new WeakMap,x=new WeakMap,A=new WeakMap,E=new WeakMap,M=new WeakMap,I=new WeakMap,R=new WeakMap,D=new WeakMap,G={construct:()=>G},X=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,F=(p,t)=>{const o=[];let l=p.replace(/^[\s]+/,""),d=l.match(X);for(;d!==null;){const g=d[1].slice(1,-1),b=d[0].replace(/([\s]+)?;?$/,"").replace(g,new URL(g,t).toString());o.push(b),l=l.slice(d[0].length).replace(/^[\s]+/,""),d=l.match(X)}return[o.join(";"),l]},H=p=>{if(p!==void 0&&!Array.isArray(p))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Q=p=>{if(!(t=>{try{new new Proxy(t,G)}catch{return!1}return!0})(p))throw new TypeError("The given value for processorCtor should be a constructor.");if(p.prototype===null||typeof p.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},K=(p,t)=>{const o=p.get(t);if(o===void 0)throw new Error("A value with the given key could not be found.");return o},pt=(p,t)=>{const o=Array.from(p).filter(t);if(o.length>1)throw Error("More than one element was found.");if(o.length===0)throw Error("No element was found.");const[l]=o;return p.delete(l),l},ut=(p,t,o,l)=>{const d=K(p,t),g=pt(d,b=>b[0]===o&&b[1]===l);return d.size===0&&p.delete(t),g},_t=p=>K(M,p),xt=p=>{if(v.has(p))throw new Error("The AudioNode is already stored.");v.add(p),_t(p).forEach(t=>t(!0))},Zt=p=>"port"in p,Wt=p=>{if(!v.has(p))throw new Error("The AudioNode is not stored.");v.delete(p),_t(p).forEach(t=>t(!1))},Jt=(p,t)=>{!Zt(p)&&t.every(o=>o.size===0)&&Wt(p)},it={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},rt=(p,t)=>p.context===t,at=p=>{try{p.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Tt=()=>new DOMException("","IndexSizeError"),dt=p=>{var t;p.getChannelData=(t=p.getChannelData,o=>{try{return t.call(p,o)}catch(l){throw l.code===12?Tt():l}})},Nt={numberOfChannels:1},jt=-34028234663852886e22,Bt=34028234663852886e22,ne=p=>v.has(p),Xe={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},qt=p=>K(y,p),xe=p=>K(x,p),Ue=(p,t)=>{const{activeInputs:o}=qt(p);o.forEach(d=>d.forEach(([g])=>{t.includes(p)||Ue(g,[...t,p])}));const l=(d=>"playbackRate"in d)(p)?[p.playbackRate]:Zt(p)?Array.from(p.parameters.values()):(d=>"frequency"in d&&"gain"in d)(p)?[p.Q,p.detune,p.frequency,p.gain]:(d=>"offset"in d)(p)?[p.offset]:(d=>!("frequency"in d)&&"gain"in d)(p)?[p.gain]:(d=>"detune"in d&&"frequency"in d)(p)?[p.detune,p.frequency]:(d=>"pan"in d)(p)?[p.pan]:[];for(const d of l){const g=xe(d);g!==void 0&&g.activeInputs.forEach(([b])=>Ue(b,t))}ne(p)&&Wt(p)},Ze=p=>{Ue(p.destination,[])},Re=p=>"context"in p,Qe=p=>Re(p[0]),Te=(p,t,o,l)=>{for(const d of p)if(o(d)){if(l)return!1;throw Error("The set contains at least one similar element.")}return p.add(t),!0},Cs=(p,t,[o,l],d)=>{Te(p,[t,o,l],g=>g[0]===t&&g[1]===o,d)},an=(p,[t,o,l],d)=>{const g=p.get(t);g===void 0?p.set(t,new Set([[o,l]])):Te(g,[o,l],b=>b[0]===o,d)},Le=p=>"inputs"in p,Sn=(p,t,o,l)=>{if(Le(t)){const d=t.inputs[l];return p.connect(d,o,0),[d,o,0]}return p.connect(t,o,l),[t,o,l]},ui=(p,t,o)=>{for(const l of p)if(l[0]===t&&l[1]===o)return p.delete(l),l;return null},di=(p,t)=>{if(!_t(p).delete(t))throw new Error("Missing the expected event listener.")},pi=(p,t,o)=>{const l=K(p,t),d=pt(l,g=>g[0]===o);return l.size===0&&p.delete(t),d},Cn=(p,t,o,l)=>{Le(t)?p.disconnect(t.inputs[l],o,0):p.disconnect(t,o,l)},te=p=>K(w,p),Hn=p=>K(A,p),ln=p=>I.has(p),mi=p=>!v.has(p),Or=(p,t)=>new Promise(o=>{if(t!==null)o(!0);else{const l=p.createScriptProcessor(256,1,1),d=p.createGain(),g=p.createBuffer(1,2,44100),b=g.getChannelData(0);b[0]=1,b[1]=1;const _=p.createBufferSource();_.buffer=g,_.loop=!0,_.connect(l).connect(p.destination),_.connect(d),_.disconnect(d),l.onaudioprocess=C=>{const T=C.inputBuffer.getChannelData(0);Array.prototype.some.call(T,P=>P===1)?o(!0):o(!1),_.stop(),l.onaudioprocess=null,_.disconnect(l),l.disconnect(p.destination)},_.start()}}),go=(p,t)=>{const o=new Map;for(const l of p)for(const d of l){const g=o.get(d);o.set(d,g===void 0?1:g+1)}o.forEach((l,d)=>t(d,l))},fi=p=>"context"in p,Qa=p=>{const t=new Map;p.connect=(o=>(l,d=0,g=0)=>{const b=fi(l)?o(l,d,g):o(l,d),_=t.get(l);return _===void 0?t.set(l,[{input:g,output:d}]):_.every(C=>C.input!==g||C.output!==d)&&_.push({input:g,output:d}),b})(p.connect.bind(p)),p.disconnect=(o=>(l,d,g)=>{if(o.apply(p),l===void 0)t.clear();else if(typeof l=="number")for(const[b,_]of t){const C=_.filter(T=>T.output!==l);C.length===0?t.delete(b):t.set(b,C)}else if(t.has(l))if(d===void 0)t.delete(l);else{const b=t.get(l);if(b!==void 0){const _=b.filter(C=>C.output!==d&&(C.input!==g||g===void 0));_.length===0?t.delete(l):t.set(l,_)}}for(const[b,_]of t)_.forEach(C=>{fi(b)?p.connect(b,C.output,C.input):p.connect(b,C.output)})})(p.disconnect)},vo=(p,t,o,l,d)=>{const[g,b]=((_,C,T,P)=>{const{activeInputs:k,passiveInputs:O}=qt(C),N=ui(k[P],_,T);return N===null?[ut(O,_,T,P)[2],!1]:[N[2],!0]})(p,o,l,d);if(g!==null&&(di(p,g),!b||t||ln(p)||Cn(te(p),te(o),l,d)),ne(o)){const{activeInputs:_}=qt(o);Jt(o,_)}},yo=(p,t,o,l)=>{const[d,g]=((b,_,C)=>{const{activeInputs:T,passiveInputs:P}=xe(_),k=ui(T,b,C);return k===null?[pi(P,b,C)[1],!1]:[k[2],!0]})(p,o,l);d!==null&&(di(p,d),!g||t||ln(p)||te(p).disconnect(Hn(o),l))};class Nr{constructor(t){this._map=new Map(t)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(t,o=null){return this._map.forEach((l,d)=>t.call(o,l,d,this))}get(t){return this._map.get(t)}has(t){return this._map.has(t)}keys(){return this._map.keys()}values(){return this._map.values()}}const Lr={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function Gn(p,t,o,l,d){if(typeof p.copyFromChannel=="function")t[o].byteLength===0&&(t[o]=new Float32Array(128)),p.copyFromChannel(t[o],l,d);else{const g=p.getChannelData(l);if(t[o].byteLength===0)t[o]=g.slice(d,d+128);else{const b=new Float32Array(g.buffer,d*Float32Array.BYTES_PER_ELEMENT,128);t[o].set(b)}}}const gi=(p,t,o,l,d)=>{typeof p.copyToChannel=="function"?t[o].byteLength!==0&&p.copyToChannel(t[o],l,d):t[o].byteLength!==0&&p.getChannelData(l).set(t[o],d)},Fr=(p,t)=>{const o=[];for(let l=0;l<p;l+=1){const d=[],g=typeof t=="number"?t:t[l];for(let b=0;b<g;b+=1)d.push(new Float32Array(128));o.push(d)}return o},Rm=async(p,t,o,l,d,g,b)=>{const _=t===null?128*Math.ceil(p.context.length/128):t.length,C=l.channelCount*l.numberOfInputs,T=d.reduce((L,W)=>L+W,0),P=T===0?null:o.createBuffer(T,_,o.sampleRate);if(g===void 0)throw new Error("Missing the processor constructor.");const k=qt(p),O=await((L,W)=>{const z=K(D,L),B=te(W);return K(z,B)})(o,p),N=Fr(l.numberOfInputs,l.channelCount),$=Fr(l.numberOfOutputs,d),q=Array.from(p.parameters.keys()).reduce((L,W)=>({...L,[W]:new Float32Array(128)}),{});for(let L=0;L<_;L+=128){if(l.numberOfInputs>0&&t!==null)for(let W=0;W<l.numberOfInputs;W+=1)for(let z=0;z<l.channelCount;z+=1)Gn(t,N[W],z,z,L);g.parameterDescriptors!==void 0&&t!==null&&g.parameterDescriptors.forEach(({name:W},z)=>{Gn(t,q,W,C+z,L)});for(let W=0;W<l.numberOfInputs;W+=1)for(let z=0;z<d[W];z+=1)$[W][z].byteLength===0&&($[W][z]=new Float32Array(128));try{const W=N.map((B,J)=>k.activeInputs[J].size===0?[]:B),z=b(L/o.sampleRate,o.sampleRate,()=>O.process(W,$,q));if(P!==null)for(let B=0,J=0;B<l.numberOfOutputs;B+=1){for(let st=0;st<d[B];st+=1)gi(P,$[B],st,J+st,L);J+=d[B]}if(!z)break}catch(W){p.dispatchEvent(new ErrorEvent("processorerror",{colno:W.colno,filename:W.filename,lineno:W.lineno,message:W.message}));break}}return P},Dm={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Om={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Nm={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Lm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Fm={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Xh=p=>{const{port1:t,port2:o}=new MessageChannel;return new Promise(l=>{const d=()=>{o.onmessage=null,t.close(),o.close(),l()};o.onmessage=()=>d();try{t.postMessage(p,[p])}catch{}finally{d()}})},Bm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Br=(p,t,o)=>{const l=t[o];if(l===void 0)throw p();return l},qm={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},$m={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},De=()=>new DOMException("","InvalidStateError"),qr=()=>new DOMException("","InvalidAccessError"),zm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Uh=(p,t,o,l,d,g,b,_,C,T,P)=>{const k=T.length;let O=_;for(let N=0;N<k;N+=1){let $=o[0]*T[N];for(let q=1;q<d;q+=1){const L=O-q&C-1;$+=o[q]*g[L],$-=p[q]*b[L]}for(let q=d;q<l;q+=1)$+=o[q]*g[O-q&C-1];for(let q=d;q<t;q+=1)$-=p[q]*b[O-q&C-1];g[O]=T[N],b[O]=$,O=O+1&C-1,P[N]=$}return O},Wm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},bo=p=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const o=p.decodeAudioData(t.buffer,()=>{});return o!==void 0&&(o.catch(()=>{}),!0)}catch{}return!1},ce=(p,t,o)=>{const l=t[o];l!==void 0&&l!==p[o]&&(p[o]=l)},Ae=(p,t)=>{ce(p,t,"channelCount"),ce(p,t,"channelCountMode"),ce(p,t,"channelInterpretation")},Yh=p=>typeof p.getFloatTimeDomainData=="function",ge=(p,t,o)=>{const l=t[o];l!==void 0&&l!==p[o].value&&(p[o].value=l)},Ja=p=>{p.start=(t=>(o=0,l=0,d)=>{if(typeof d=="number"&&d<0||l<0||o<0)throw new RangeError("The parameters can't be negative.");t.call(p,o,l,d)})(p.start)},Ka=p=>{var t;p.stop=(t=p.stop,(o=0)=>{if(o<0)throw new RangeError("The parameter can't be negative.");t.call(p,o)})},Zh=(p,t)=>p===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(p*t))))),Qh=(p,t)=>{const o=p.createBiquadFilter();return Ae(o,t),ge(o,t,"Q"),ge(o,t,"detune"),ge(o,t,"frequency"),ge(o,t,"gain"),ce(o,t,"type"),o},wo=(p,t)=>{const o=p.createChannelSplitter(t.numberOfOutputs);return Ae(o,t),(l=>{const d=l.numberOfOutputs;Object.defineProperty(l,"channelCount",{get:()=>d,set:g=>{if(g!==d)throw De()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:g=>{if(g!=="explicit")throw De()}}),Object.defineProperty(l,"channelInterpretation",{get:()=>"discrete",set:g=>{if(g!=="discrete")throw De()}})})(o),o},vi=(p,t)=>(p.connect=t.connect.bind(t),p.disconnect=t.disconnect.bind(t),p),Jh=(p,t)=>{const o=p.createDelay(t.maxDelayTime);return Ae(o,t),ge(o,t,"delayTime"),o},os=(p,t)=>{const o=p.createGain();return Ae(o,t),ge(o,t,"gain"),o};function Vm(p,t){const o=t[0]*t[0]+t[1]*t[1];return[(p[0]*t[0]+p[1]*t[1])/o,(p[1]*t[0]-p[0]*t[1])/o]}function Kh(p,t){let o=[0,0];for(let g=p.length-1;g>=0;g-=1)d=t,o=[(l=o)[0]*d[0]-l[1]*d[1],l[0]*d[1]+l[1]*d[0]],o[0]+=p[g];var l,d;return o}const _o=(p,t,o,l)=>p.createScriptProcessor(t,o,l),Je=()=>new DOMException("","NotSupportedError"),Hm={numberOfChannels:1},Gm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},jm={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},Xm={disableNormalization:!1},Um={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Ym=()=>new DOMException("","UnknownError"),Zm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},tu=(p,t,o)=>p.copyFromChannel===void 0?p.getChannelData(o)[0]:(p.copyFromChannel(t,o),t[0]),eu=p=>{if(p===null)return!1;const t=p.length;return t%2!=0?p[Math.floor(t/2)]!==0:p[t/2-1]+p[t/2]!==0},xo=(p,t,o,l)=>{let d=p;for(;!d.hasOwnProperty(t);)d=Object.getPrototypeOf(d);const{get:g,set:b}=Object.getOwnPropertyDescriptor(d,t);Object.defineProperty(p,t,{get:o(g),set:l(b)})},su=(p,t,o)=>{try{p.setValueAtTime(t,o)}catch(l){if(l.code!==9)throw l;su(p,t,o+1e-7)}},tl=p=>{const t=p.createOscillator();try{t.start(-1)}catch(o){return o instanceof RangeError}return!1},nu=p=>{const t=p.createBuffer(1,1,44100),o=p.createBufferSource();o.buffer=t,o.start(),o.stop();try{return o.stop(),!0}catch{return!1}},el=p=>{const t=p.createOscillator();try{t.stop(-1)}catch(o){return o instanceof RangeError}return!1},Qm=()=>{try{new DOMException}catch{return!1}return!0},Jm=()=>new Promise(p=>{const t=new ArrayBuffer(0),{port1:o,port2:l}=new MessageChannel;o.onmessage=({data:d})=>p(d!==null),l.postMessage(t,[t])}),iu=(p,t)=>{const o=t.createGain();p.connect(o);const l=(d=>()=>{d.call(p,o),p.removeEventListener("ended",l)})(p.disconnect);p.addEventListener("ended",l),vi(p,o),p.stop=(d=>{let g=!1;return(b=0)=>{if(g)try{d.call(p,b)}catch{o.gain.setValueAtTime(0,b)}else d.call(p,b),g=!0}})(p.stop)},yi=(p,t)=>o=>{const l={value:p};return Object.defineProperties(o,{currentTarget:l,target:l}),typeof t=="function"?t.call(p,o):t.handleEvent.call(p,o)},Km=(p=>(t,o,[l,d,g],b)=>{p(t[d],[o,l,g],_=>_[0]===o&&_[1]===l,b)})(Te),tf=(p=>(t,o,[l,d,g],b)=>{const _=t.get(l);_===void 0?t.set(l,new Set([[d,o,g]])):p(_,[d,o,g],C=>C[0]===d&&C[1]===o,b)})(Te),ef=(p=>(t,o,l,d)=>p(t[d],g=>g[0]===o&&g[1]===l))(pt),ou=new WeakMap,sf=(p=>t=>{var o;return(o=p.get(t))!==null&&o!==void 0?o:0})(ou),Ts=($r=new Map,So=new WeakMap,(p,t)=>{const o=So.get(p);if(o!==void 0)return o;const l=$r.get(p);if(l!==void 0)return l;try{const d=t();return d instanceof Promise?($r.set(p,d),d.catch(()=>!1).then(g=>($r.delete(p),So.set(p,g),g))):(So.set(p,d),d)}catch{return So.set(p,!1),!1}});var $r,So;const Ns=typeof window>"u"?null:window,ru=((p,t)=>(o,l)=>{const d=o.createAnalyser();if(Ae(d,l),!(l.maxDecibels>l.minDecibels))throw t();return ce(d,l,"fftSize"),ce(d,l,"maxDecibels"),ce(d,l,"minDecibels"),ce(d,l,"smoothingTimeConstant"),p(Yh,()=>Yh(d))||(g=>{g.getFloatTimeDomainData=b=>{const _=new Uint8Array(b.length);g.getByteTimeDomainData(_);const C=Math.max(_.length,g.fftSize);for(let T=0;T<C;T+=1)b[T]=.0078125*(_[T]-128);return b}})(d),d})(Ts,Tt),sl=(p=>t=>{const o=p(t);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return o.renderer})(qt),Fe=((p,t,o)=>async(l,d,g)=>{const b=p(l);await Promise.all(b.activeInputs.map((_,C)=>Array.from(_).map(async([T,P])=>{const k=t(T),O=await k.render(T,d),N=l.context.destination;o(T)||l===N&&o(l)||O.connect(g,P,C)})).reduce((_,C)=>[..._,...C],[]))})(qt,sl,ln),nf=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,g){const b=l.get(g);return b!==void 0?Promise.resolve(b):(async(_,C)=>{let T=t(_);if(!rt(T,C)){const P={channelCount:T.channelCount,channelCountMode:T.channelCountMode,channelInterpretation:T.channelInterpretation,fftSize:T.fftSize,maxDecibels:T.maxDecibels,minDecibels:T.minDecibels,smoothingTimeConstant:T.smoothingTimeConstant};T=p(C,P)}return l.set(C,T),await o(_,C,T),T})(d,g)}}})(ru,te,Fe),ie=(au=E,p=>{const t=au.get(p);if(t===void 0)throw De();return t});var au;const Oe=(p=>p===null?null:p.hasOwnProperty("OfflineAudioContext")?p.OfflineAudioContext:p.hasOwnProperty("webkitOfflineAudioContext")?p.webkitOfflineAudioContext:null)(Ns),Kt=(p=>t=>p!==null&&t instanceof p)(Oe),lu=new WeakMap,cu=(p=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,o,l){if(o!==null){let d=this._listeners.get(o);d===void 0&&(d=p(this,o),typeof o=="function"&&this._listeners.set(o,d)),this._nativeEventTarget.addEventListener(t,d,l)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,o,l){const d=o===null?void 0:this._listeners.get(o);this._nativeEventTarget.removeEventListener(t,d===void 0?null:d,l)}})(yi),Tn=(p=>p===null?null:p.hasOwnProperty("AudioContext")?p.AudioContext:p.hasOwnProperty("webkitAudioContext")?p.webkitAudioContext:null)(Ns),nl=(p=>t=>p!==null&&t instanceof p)(Tn),il=(p=>t=>p!==null&&typeof p.AudioNode=="function"&&t instanceof p.AudioNode)(Ns),hu=(p=>t=>p!==null&&typeof p.AudioParam=="function"&&t instanceof p.AudioParam)(Ns),bi=(p=>p===null?null:p.hasOwnProperty("AudioWorkletNode")?p.AudioWorkletNode:null)(Ns),be=((p,t,o,l,d,g,b,_,C,T,P,k,O,N,$,q)=>class extends T{constructor(L,W,z,B){super(z),this._context=L,this._nativeAudioNode=z;const J=P(L);k(J)&&o(Or,()=>Or(J,q))!==!0&&Qa(z),w.set(this,z),M.set(this,new Set),L.state!=="closed"&&W&&xt(this),p(this,B,z)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(L){this._nativeAudioNode.channelCount=L}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(L){this._nativeAudioNode.channelCountMode=L}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(L){this._nativeAudioNode.channelInterpretation=L}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(L,W=0,z=0){if(W<0||W>=this._nativeAudioNode.numberOfOutputs)throw d();const B=P(this._context),J=$(B);if(O(L)||N(L))throw g();if(Re(L)){const j=te(L);try{const Z=Sn(this._nativeAudioNode,j,W,z),V=mi(this);(J||V)&&this._nativeAudioNode.disconnect(...Z),this.context.state!=="closed"&&!V&&mi(L)&&xt(L)}catch(Z){throw Z.code===12?g():Z}if(t(this,L,W,z,J)){const Z=C([this],L);go(Z,l(J))}return L}const st=Hn(L);if(st.name==="playbackRate"&&st.maxValue===1024)throw b();try{this._nativeAudioNode.connect(st,W),(J||mi(this))&&this._nativeAudioNode.disconnect(st,W)}catch(j){throw j.code===12?g():j}if(((j,Z,V,nt)=>{const{activeInputs:Y,passiveInputs:et}=xe(Z),{outputs:ct}=qt(j),ht=_t(j),Mt=yt=>{const vt=te(j),Pt=Hn(Z);if(yt){const gt=pi(et,j,V);Cs(Y,j,gt,!1),nt||ln(j)||vt.connect(Pt,V)}else{const gt=((kt,Lt,Vt)=>pt(kt,ae=>ae[0]===Lt&&ae[1]===Vt))(Y,j,V);an(et,gt,!1),nt||ln(j)||vt.disconnect(Pt,V)}};return!!Te(ct,[Z,V],yt=>yt[0]===Z&&yt[1]===V,!0)&&(ht.add(Mt),ne(j)?Cs(Y,j,[V,Mt],!0):an(et,[j,V,Mt],!0),!0)})(this,L,W,J)){const j=C([this],L);go(j,l(J))}}disconnect(L,W,z){let B;const J=P(this._context),st=$(J);if(L===void 0)B=((j,Z)=>{const V=qt(j),nt=[];for(const Y of V.outputs)Qe(Y)?vo(j,Z,...Y):yo(j,Z,...Y),nt.push(Y[0]);return V.outputs.clear(),nt})(this,st);else if(typeof L=="number"){if(L<0||L>=this.numberOfOutputs)throw d();B=((j,Z,V)=>{const nt=qt(j),Y=[];for(const et of nt.outputs)et[1]===V&&(Qe(et)?vo(j,Z,...et):yo(j,Z,...et),Y.push(et[0]),nt.outputs.delete(et));return Y})(this,st,L)}else{if(W!==void 0&&(W<0||W>=this.numberOfOutputs)||Re(L)&&z!==void 0&&(z<0||z>=L.numberOfInputs))throw d();if(B=((j,Z,V,nt,Y)=>{const et=qt(j);return Array.from(et.outputs).filter(ct=>!(ct[0]!==V||nt!==void 0&&ct[1]!==nt||Y!==void 0&&ct[2]!==Y)).map(ct=>(Qe(ct)?vo(j,Z,...ct):yo(j,Z,...ct),et.outputs.delete(ct),ct[0]))})(this,st,L,W,z),B.length===0)throw g()}for(const j of B){const Z=C([this],j);go(Z,_)}}})((uu=y,(p,t,o)=>{const l=[];for(let d=0;d<o.numberOfInputs;d+=1)l.push(new Set);uu.set(p,{activeInputs:l,outputs:new Set,passiveInputs:new WeakMap,renderer:t})}),((p,t,o,l,d,g,b,_,C,T,P,k,O)=>{const N=new WeakMap;return($,q,L,W,z)=>{const{activeInputs:B,passiveInputs:J}=g(q),{outputs:st}=g($),j=_($),Z=V=>{const nt=C(q),Y=C($);if(V){const et=ut(J,$,L,W);p(B,$,et,!1),z||k($)||o(Y,nt,L,W),O(q)&&xt(q)}else{const et=l(B,$,L,W);t(J,W,et,!1),z||k($)||d(Y,nt,L,W);const ct=b(q);if(ct===0)P(q)&&Jt(q,B);else{const ht=N.get(q);ht!==void 0&&clearTimeout(ht),N.set(q,setTimeout(()=>{P(q)&&Jt(q,B)},1e3*ct))}}};return!!T(st,[q,L,W],V=>V[0]===q&&V[1]===L&&V[2]===W,!0)&&(j.add(Z),P($)?p(B,$,[L,W,Z],!0):t(J,W,[$,L,Z],!0),!0)}})(Km,tf,Sn,ef,Cn,qt,sf,_t,te,Te,ne,ln,mi),Ts,((p,t,o,l,d,g)=>b=>(_,C)=>{const T=p.get(_);if(T===void 0){if(!b&&g(_)){const P=l(_),{outputs:k}=o(_);for(const O of k)if(Qe(O)){const N=l(O[0]);t(P,N,O[1],O[2])}else{const N=d(O[0]);P.disconnect(N,O[1])}}p.set(_,C)}else p.set(_,T+C)})(I,Cn,qt,te,Hn,ne),Tt,qr,Je,((p,t,o,l,d,g,b,_)=>(C,T)=>{const P=t.get(C);if(P===void 0)throw new Error("Missing the expected cycle count.");const k=g(C.context),O=_(k);if(P===T){if(t.delete(C),!O&&b(C)){const N=l(C),{outputs:$}=o(C);for(const q of $)if(Qe(q)){const L=l(q[0]);p(N,L,q[1],q[2])}else{const L=d(q[0]);N.connect(L,q[1])}}}else t.set(C,P-T)})(Sn,I,qt,te,Hn,ie,ne,Kt),((p,t,o)=>function l(d,g){const b=Re(g)?g:o(p,g);if((C=>"delayTime"in C)(b))return[];if(d[0]===b)return[d];if(d.includes(b))return[];const{outputs:_}=t(b);return Array.from(_).map(C=>l([...d,b],C[0])).reduce((C,T)=>C.concat(T),[])})(lu,qt,K),cu,ie,nl,il,hu,Kt,bi);var uu;const of=((p,t,o,l,d,g)=>class extends p{constructor(b,_){const C=d(b),T={...it,..._},P=l(C,T);super(b,!1,P,g(C)?t():null),this._nativeAnalyserNode=P}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(b){this._nativeAnalyserNode.fftSize=b}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(b){const _=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=b,!(b>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=_,o()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(b){const _=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=b,!(this._nativeAnalyserNode.maxDecibels>b))throw this._nativeAnalyserNode.minDecibels=_,o()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(b){this._nativeAnalyserNode.smoothingTimeConstant=b}getByteFrequencyData(b){this._nativeAnalyserNode.getByteFrequencyData(b)}getByteTimeDomainData(b){this._nativeAnalyserNode.getByteTimeDomainData(b)}getFloatFrequencyData(b){this._nativeAnalyserNode.getFloatFrequencyData(b)}getFloatTimeDomainData(b){this._nativeAnalyserNode.getFloatTimeDomainData(b)}})(be,nf,Tt,ru,ie,Kt),ol=new WeakSet,du=(p=>p===null?null:p.hasOwnProperty("AudioBuffer")?p.AudioBuffer:null)(Ns),pu=(rl=new Uint32Array(1),p=>(rl[0]=p,rl[0]));var rl;const al=((p,t)=>o=>{o.copyFromChannel=(l,d,g=0)=>{const b=p(g),_=p(d);if(_>=o.numberOfChannels)throw t();const C=o.length,T=o.getChannelData(_),P=l.length;for(let k=b<0?-b:0;k+b<C&&k<P;k+=1)l[k]=T[k+b]},o.copyToChannel=(l,d,g=0)=>{const b=p(g),_=p(d);if(_>=o.numberOfChannels)throw t();const C=o.length,T=o.getChannelData(_),P=l.length;for(let k=b<0?-b:0;k+b<C&&k<P;k+=1)T[k+b]=l[k]}})(pu,Tt),ll=(p=>t=>{t.copyFromChannel=(o=>(l,d,g=0)=>{const b=p(g),_=p(d);if(b<t.length)return o.call(t,l,_,b)})(t.copyFromChannel),t.copyToChannel=(o=>(l,d,g=0)=>{const b=p(g),_=p(d);if(b<t.length)return o.call(t,l,_,b)})(t.copyToChannel)})(pu),mu=((p,t,o,l,d,g,b,_)=>{let C=null;return class mp{constructor(P){if(d===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:k,numberOfChannels:O,sampleRate:N}={...Nt,...P};C===null&&(C=new d(1,1,44100));const $=l!==null&&t(g,g)?new l({length:k,numberOfChannels:O,sampleRate:N}):C.createBuffer(O,k,N);if($.numberOfChannels===0)throw o();return typeof $.copyFromChannel!="function"?(b($),dt($)):t(at,()=>at($))||_($),p.add($),$}static[Symbol.hasInstance](P){return P!==null&&typeof P=="object"&&Object.getPrototypeOf(P)===mp.prototype||p.has(P)}}})(ol,Ts,Je,du,Oe,(p=>()=>{if(p===null)return!1;try{new p({length:1,sampleRate:44100})}catch{return!1}return!0})(du),al,ll),zr=(p=>(t,o)=>{const l=p(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});o.connect(l).connect(t.destination);const d=()=>{o.removeEventListener("ended",d),o.disconnect(l),l.disconnect()};o.addEventListener("ended",d)})(os),fu=((p,t,o)=>async(l,d,g)=>{const b=t(l);await Promise.all(Array.from(b.activeInputs).map(async([_,C])=>{const T=p(_),P=await T.render(_,d);o(_)||P.connect(g,C)}))})(sl,xe,ln),Xs=(p=>(t,o,l)=>p(o,t,l))(fu),wi=((p,t,o,l,d,g,b,_,C,T,P)=>(k,O)=>{const N=k.createBufferSource();return Ae(N,O),ge(N,O,"playbackRate"),ce(N,O,"buffer"),ce(N,O,"loop"),ce(N,O,"loopEnd"),ce(N,O,"loopStart"),t(o,()=>o(k))||($=>{$.start=(q=>{let L=!1;return(W=0,z=0,B)=>{if(L)throw De();q.call($,W,z,B),L=!0}})($.start)})(N),t(l,()=>l(k))||($=>{$.start=(q=>(L=0,W=0,z)=>{const B=$.buffer,J=B===null?W:Math.min(B.duration,W);B!==null&&J>B.duration-.5/$.context.sampleRate?q.call($,L,0,0):q.call($,L,J,z)})($.start)})(N),t(d,()=>d(k))||T(N,k),t(g,()=>g(k))||Ja(N),t(b,()=>b(k))||P(N,k),t(_,()=>_(k))||Ka(N),p(k,N),N})(zr,Ts,p=>{const t=p.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},p=>{const t=p.createBufferSource(),o=p.createBuffer(1,1,44100);t.buffer=o;try{t.start(0,1)}catch{return!1}return!0},p=>{const t=p.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},tl,nu,el,0,(p=>(t,o)=>{const l=o.createBuffer(1,1,44100);t.buffer===null&&(t.buffer=l),p(t,"buffer",d=>()=>{const g=d.call(t);return g===l?null:g},d=>g=>d.call(t,g===null?l:g))})(xo),iu),Us=((p,t)=>(o,l,d)=>(p(l).replay(d),t(l,o,d)))((p=>t=>{const o=p(t);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return o.renderer})(xe),fu),rf=((p,t,o,l,d)=>()=>{const g=new WeakMap;let b=null,_=null;return{set start(C){b=C},set stop(C){_=C},render(C,T){const P=g.get(T);return P!==void 0?Promise.resolve(P):(async(k,O)=>{let N=o(k);const $=rt(N,O);if(!$){const q={buffer:N.buffer,channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,loop:N.loop,loopEnd:N.loopEnd,loopStart:N.loopStart,playbackRate:N.playbackRate.value};N=t(O,q),b!==null&&N.start(...b),_!==null&&N.stop(_)}return g.set(O,N),$?await p(O,k.playbackRate,N.playbackRate):await l(O,k.playbackRate,N.playbackRate),await d(k,O,N),N})(C,T)}}})(Xs,wi,te,Us,Fe),Ls=((p,t,o,l,d,g,b,_,C,T,P,k,O)=>(N,$,q,L=null,W=null)=>{const z=q.value,B=new f.AutomationEventList(z),J=$?(j=>({replay(Z){for(const V of j)if(V.type==="exponentialRampToValue"){const{endTime:nt,value:Y}=V;Z.exponentialRampToValueAtTime(Y,nt)}else if(V.type==="linearRampToValue"){const{endTime:nt,value:Y}=V;Z.linearRampToValueAtTime(Y,nt)}else if(V.type==="setTarget"){const{startTime:nt,target:Y,timeConstant:et}=V;Z.setTargetAtTime(Y,nt,et)}else if(V.type==="setValue"){const{startTime:nt,value:Y}=V;Z.setValueAtTime(Y,nt)}else{if(V.type!=="setValueCurve")throw new Error("Can't apply an unknown automation.");{const{duration:nt,startTime:Y,values:et}=V;Z.setValueCurveAtTime(et,Y,nt)}}}}))(B):null,st={get defaultValue(){return z},get maxValue(){return L===null?q.maxValue:L},get minValue(){return W===null?q.minValue:W},get value(){return q.value},set value(j){q.value=j,st.setValueAtTime(j,N.context.currentTime)},cancelAndHoldAtTime(j){if(typeof q.cancelAndHoldAtTime=="function")J===null&&B.flush(N.context.currentTime),B.add(d(j)),q.cancelAndHoldAtTime(j);else{const Z=Array.from(B).pop();J===null&&B.flush(N.context.currentTime),B.add(d(j));const V=Array.from(B).pop();q.cancelScheduledValues(j),Z!==V&&V!==void 0&&(V.type==="exponentialRampToValue"?q.exponentialRampToValueAtTime(V.value,V.endTime):V.type==="linearRampToValue"?q.linearRampToValueAtTime(V.value,V.endTime):V.type==="setValue"?q.setValueAtTime(V.value,V.startTime):V.type==="setValueCurve"&&q.setValueCurveAtTime(V.values,V.startTime,V.duration))}return st},cancelScheduledValues:j=>(J===null&&B.flush(N.context.currentTime),B.add(g(j)),q.cancelScheduledValues(j),st),exponentialRampToValueAtTime(j,Z){if(j===0)throw new RangeError;if(!Number.isFinite(Z)||Z<0)throw new RangeError;const V=N.context.currentTime;return J===null&&B.flush(V),Array.from(B).length===0&&(B.add(T(z,V)),q.setValueAtTime(z,V)),B.add(b(j,Z)),q.exponentialRampToValueAtTime(j,Z),st},linearRampToValueAtTime(j,Z){const V=N.context.currentTime;return J===null&&B.flush(V),Array.from(B).length===0&&(B.add(T(z,V)),q.setValueAtTime(z,V)),B.add(_(j,Z)),q.linearRampToValueAtTime(j,Z),st},setTargetAtTime:(j,Z,V)=>(J===null&&B.flush(N.context.currentTime),B.add(C(j,Z,V)),q.setTargetAtTime(j,Z,V),st),setValueAtTime:(j,Z)=>(J===null&&B.flush(N.context.currentTime),B.add(T(j,Z)),q.setValueAtTime(j,Z),st),setValueCurveAtTime(j,Z,V){const nt=j instanceof Float32Array?j:new Float32Array(j);if(k!==null&&k.name==="webkitAudioContext"){const Y=Z+V,et=N.context.sampleRate,ct=Math.ceil(Z*et),ht=Math.floor(Y*et),Mt=ht-ct,yt=new Float32Array(Mt);for(let Pt=0;Pt<Mt;Pt+=1){const gt=(nt.length-1)/V*((ct+Pt)/et-Z),kt=Math.floor(gt),Lt=Math.ceil(gt);yt[Pt]=kt===Lt?nt[kt]:(1-(gt-kt))*nt[kt]+(1-(Lt-gt))*nt[Lt]}J===null&&B.flush(N.context.currentTime),B.add(P(yt,Z,V)),q.setValueCurveAtTime(yt,Z,V);const vt=ht/et;vt<Y&&O(st,yt[yt.length-1],vt),O(st,nt[nt.length-1],Y)}else J===null&&B.flush(N.context.currentTime),B.add(P(nt,Z,V)),q.setValueCurveAtTime(nt,Z,V);return st}};return o.set(st,q),t.set(st,N),p(st,J),st})((gu=x,(p,t)=>{gu.set(p,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})}),lu,A,0,f.createCancelAndHoldAutomationEvent,f.createCancelScheduledValuesAutomationEvent,f.createExponentialRampToValueAutomationEvent,f.createLinearRampToValueAutomationEvent,f.createSetTargetAutomationEvent,f.createSetValueAutomationEvent,f.createSetValueCurveAutomationEvent,Tn,su);var gu;const af=((p,t,o,l,d,g,b,_)=>class extends p{constructor(C,T){const P=g(C),k={...Xe,...T},O=d(P,k),N=b(P),$=N?t():null;super(C,!1,O,$),this._audioBufferSourceNodeRenderer=$,this._isBufferNullified=!1,this._isBufferSet=k.buffer!==null,this._nativeAudioBufferSourceNode=O,this._onended=null,this._playbackRate=o(this,N,O.playbackRate,Bt,jt)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(C){if(this._nativeAudioBufferSourceNode.buffer=C,C!==null){if(this._isBufferSet)throw l();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(C){this._nativeAudioBufferSourceNode.loop=C}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(C){this._nativeAudioBufferSourceNode.loopEnd=C}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(C){this._nativeAudioBufferSourceNode.loopStart=C}get onended(){return this._onended}set onended(C){const T=typeof C=="function"?_(this,C):null;this._nativeAudioBufferSourceNode.onended=T;const P=this._nativeAudioBufferSourceNode.onended;this._onended=P!==null&&P===T?C:P}get playbackRate(){return this._playbackRate}start(C=0,T=0,P){if(this._nativeAudioBufferSourceNode.start(C,T,P),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=P===void 0?[C,T]:[C,T,P]),this.context.state!=="closed"){xt(this);const k=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",k),ne(this)&&Wt(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",k)}}stop(C=0){this._nativeAudioBufferSourceNode.stop(C),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=C)}})(be,rf,Ls,De,wi,ie,Kt,yi),lf=((p,t,o,l,d,g,b,_)=>class extends p{constructor(C,T){const P=g(C),k=b(P),O=d(P,T,k);super(C,!1,O,k?(N=>{const $=new WeakMap;return{render(q,L){const W=$.get(L);return W!==void 0?Promise.resolve(W):(async(z,B)=>{const J=B.destination;return $.set(B,J),await N(z,B,J),J})(q,L)}}})(_):null),this._isNodeOfNativeOfflineAudioContext=k,this._nativeAudioDestinationNode=O}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(C){if(this._isNodeOfNativeOfflineAudioContext)throw l();if(C>this._nativeAudioDestinationNode.maxChannelCount)throw o();this._nativeAudioDestinationNode.channelCount=C}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(C){if(this._isNodeOfNativeOfflineAudioContext)throw l();this._nativeAudioDestinationNode.channelCountMode=C}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(be,0,Tt,De,((p,t)=>(o,l,d)=>{const g=o.destination;if(g.channelCount!==l)try{g.channelCount=l}catch{}d&&g.channelCountMode!=="explicit"&&(g.channelCountMode="explicit"),g.maxChannelCount===0&&Object.defineProperty(g,"maxChannelCount",{value:l});const b=p(o,{channelCount:l,channelCountMode:g.channelCountMode,channelInterpretation:g.channelInterpretation,gain:1});return t(b,"channelCount",_=>()=>_.call(b),_=>C=>{_.call(b,C);try{g.channelCount=C}catch(T){if(C>g.maxChannelCount)throw T}}),t(b,"channelCountMode",_=>()=>_.call(b),_=>C=>{_.call(b,C),g.channelCountMode=C}),t(b,"channelInterpretation",_=>()=>_.call(b),_=>C=>{_.call(b,C),g.channelInterpretation=C}),Object.defineProperty(b,"maxChannelCount",{get:()=>g.maxChannelCount}),b.connect(g),b})(os,xo),ie,Kt,Fe),cf=((p,t,o,l,d)=>()=>{const g=new WeakMap;return{render(b,_){const C=g.get(_);return C!==void 0?Promise.resolve(C):(async(T,P)=>{let k=o(T);const O=rt(k,P);if(!O){const N={Q:k.Q.value,channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,detune:k.detune.value,frequency:k.frequency.value,gain:k.gain.value,type:k.type};k=t(P,N)}return g.set(P,k),O?(await p(P,T.Q,k.Q),await p(P,T.detune,k.detune),await p(P,T.frequency,k.frequency),await p(P,T.gain,k.gain)):(await l(P,T.Q,k.Q),await l(P,T.detune,k.detune),await l(P,T.frequency,k.frequency),await l(P,T.gain,k.gain)),await d(T,P,k),k})(b,_)}}})(Xs,Qh,te,Us,Fe),jn=(p=>(t,o)=>p.set(t,o))(ou),hf=((p,t,o,l,d,g,b,_)=>class extends p{constructor(C,T){const P=g(C),k={...Dm,...T},O=d(P,k),N=b(P);super(C,!1,O,N?o():null),this._Q=t(this,N,O.Q,Bt,jt),this._detune=t(this,N,O.detune,1200*Math.log2(Bt),-1200*Math.log2(Bt)),this._frequency=t(this,N,O.frequency,C.sampleRate/2,0),this._gain=t(this,N,O.gain,40*Math.log10(Bt),jt),this._nativeBiquadFilterNode=O,_(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(C){this._nativeBiquadFilterNode.type=C}getFrequencyResponse(C,T,P){try{this._nativeBiquadFilterNode.getFrequencyResponse(C,T,P)}catch(k){throw k.code===11?l():k}if(C.length!==T.length||T.length!==P.length)throw l()}})(be,Ls,cf,qr,Qh,ie,Kt,jn),An=((p,t)=>(o,l,d)=>{const g=new Set;return o.connect=(b=>(_,C=0,T=0)=>{const P=g.size===0;if(t(_))return b.call(o,_,C,T),p(g,[_,C,T],k=>k[0]===_&&k[1]===C&&k[2]===T,!0),P&&l(),_;b.call(o,_,C),p(g,[_,C],k=>k[0]===_&&k[1]===C,!0),P&&l()})(o.connect),o.disconnect=(b=>(_,C,T)=>{const P=g.size>0;if(_===void 0)b.apply(o),g.clear();else if(typeof _=="number"){b.call(o,_);for(const O of g)O[1]===_&&g.delete(O)}else{t(_)?b.call(o,_,C,T):b.call(o,_,C);for(const O of g)O[0]!==_||C!==void 0&&O[1]!==C||T!==void 0&&O[2]!==T||g.delete(O)}const k=g.size===0;P&&k&&d()})(o.disconnect),o})(Te,il),uf=((p,t)=>(o,l)=>{l.channelCount=1,l.channelCountMode="explicit",Object.defineProperty(l,"channelCount",{get:()=>1,set:()=>{throw p()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:()=>{throw p()}});const d=o.createBufferSource();t(l,()=>{const g=l.numberOfInputs;for(let b=0;b<g;b+=1)d.connect(l,0,b)},()=>d.disconnect(l))})(De,An),Mn=((p,t)=>(o,l)=>{const d=o.createChannelMerger(l.numberOfInputs);return p!==null&&p.name==="webkitAudioContext"&&t(o,d),Ae(d,l),d})(Tn,uf),df=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,g){const b=l.get(g);return b!==void 0?Promise.resolve(b):(async(_,C)=>{let T=t(_);if(!rt(T,C)){const P={channelCount:T.channelCount,channelCountMode:T.channelCountMode,channelInterpretation:T.channelInterpretation,numberOfInputs:T.numberOfInputs};T=p(C,P)}return l.set(C,T),await o(_,C,T),T})(d,g)}}})(Mn,te,Fe),pf=((p,t,o,l,d)=>class extends p{constructor(g,b){const _=l(g),C={...Om,...b};super(g,!1,o(_,C),d(_)?t():null)}})(be,df,Mn,ie,Kt),mf=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,g){const b=l.get(g);return b!==void 0?Promise.resolve(b):(async(_,C)=>{let T=t(_);if(!rt(T,C)){const P={channelCount:T.channelCount,channelCountMode:T.channelCountMode,channelInterpretation:T.channelInterpretation,numberOfOutputs:T.numberOfOutputs};T=p(C,P)}return l.set(C,T),await o(_,C,T),T})(d,g)}}})(wo,te,Fe),ff=((p,t,o,l,d,g)=>class extends p{constructor(b,_){const C=l(b),T=(P=>({...P,channelCount:P.numberOfOutputs}))({...Nm,..._});super(b,!1,o(C,T),d(C)?t():null)}})(be,mf,wo,ie,Kt),gf=((p,t,o,l)=>(d,{offset:g,...b})=>{const _=d.createBuffer(1,2,44100),C=t(d,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),T=o(d,{...b,gain:g}),P=_.getChannelData(0);P[0]=1,P[1]=1,C.buffer=_,C.loop=!0;const k={get bufferSize(){},get channelCount(){return T.channelCount},set channelCount(O){T.channelCount=O},get channelCountMode(){return T.channelCountMode},set channelCountMode(O){T.channelCountMode=O},get channelInterpretation(){return T.channelInterpretation},set channelInterpretation(O){T.channelInterpretation=O},get context(){return T.context},get inputs(){return[]},get numberOfInputs(){return C.numberOfInputs},get numberOfOutputs(){return T.numberOfOutputs},get offset(){return T.gain},get onended(){return C.onended},set onended(O){C.onended=O},addEventListener:(...O)=>C.addEventListener(O[0],O[1],O[2]),dispatchEvent:(...O)=>C.dispatchEvent(O[0]),removeEventListener:(...O)=>C.removeEventListener(O[0],O[1],O[2]),start(O=0){C.start.call(C,O)},stop(O=0){C.stop.call(C,O)}};return p(d,C),l(vi(k,T),()=>C.connect(T),()=>C.disconnect(T))})(zr,wi,os,An),_i=((p,t,o,l,d)=>(g,b)=>{if(g.createConstantSource===void 0)return o(g,b);const _=g.createConstantSource();return Ae(_,b),ge(_,b,"offset"),t(l,()=>l(g))||Ja(_),t(d,()=>d(g))||Ka(_),p(g,_),_})(zr,Ts,gf,tl,el),vf=((p,t,o,l,d)=>()=>{const g=new WeakMap;let b=null,_=null;return{set start(C){b=C},set stop(C){_=C},render(C,T){const P=g.get(T);return P!==void 0?Promise.resolve(P):(async(k,O)=>{let N=o(k);const $=rt(N,O);if(!$){const q={channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,offset:N.offset.value};N=t(O,q),b!==null&&N.start(b),_!==null&&N.stop(_)}return g.set(O,N),$?await p(O,k.offset,N.offset):await l(O,k.offset,N.offset),await d(k,O,N),N})(C,T)}}})(Xs,_i,te,Us,Fe),yf=((p,t,o,l,d,g,b)=>class extends p{constructor(_,C){const T=d(_),P={...Lm,...C},k=l(T,P),O=g(T),N=O?o():null;super(_,!1,k,N),this._constantSourceNodeRenderer=N,this._nativeConstantSourceNode=k,this._offset=t(this,O,k.offset,Bt,jt),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(_){const C=typeof _=="function"?b(this,_):null;this._nativeConstantSourceNode.onended=C;const T=this._nativeConstantSourceNode.onended;this._onended=T!==null&&T===C?_:T}start(_=0){if(this._nativeConstantSourceNode.start(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=_),this.context.state!=="closed"){xt(this);const C=()=>{this._nativeConstantSourceNode.removeEventListener("ended",C),ne(this)&&Wt(this)};this._nativeConstantSourceNode.addEventListener("ended",C)}}stop(_=0){this._nativeConstantSourceNode.stop(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=_)}})(be,Ls,vf,_i,ie,Kt,yi),vu=((p,t)=>(o,l)=>{const d=o.createConvolver();if(Ae(d,l),l.disableNormalization===d.normalize&&(d.normalize=!l.disableNormalization),ce(d,l,"buffer"),l.channelCount>2||(t(d,"channelCount",g=>()=>g.call(d),g=>b=>{if(b>2)throw p();return g.call(d,b)}),l.channelCountMode==="max"))throw p();return t(d,"channelCountMode",g=>()=>g.call(d),g=>b=>{if(b==="max")throw p();return g.call(d,b)}),d})(Je,xo),bf=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,g){const b=l.get(g);return b!==void 0?Promise.resolve(b):(async(_,C)=>{let T=t(_);if(!rt(T,C)){const P={buffer:T.buffer,channelCount:T.channelCount,channelCountMode:T.channelCountMode,channelInterpretation:T.channelInterpretation,disableNormalization:!T.normalize};T=p(C,P)}return l.set(C,T),Le(T)?await o(_,C,T.inputs[0]):await o(_,C,T),T})(d,g)}}})(vu,te,Fe),wf=((p,t,o,l,d,g)=>class extends p{constructor(b,_){const C=l(b),T={...Fm,..._},P=o(C,T);super(b,!1,P,d(C)?t():null),this._isBufferNullified=!1,this._nativeConvolverNode=P,T.buffer!==null&&g(this,T.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(b){if(this._nativeConvolverNode.buffer=b,b===null&&this._nativeConvolverNode.buffer!==null){const _=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=_.createBuffer(1,1,_.sampleRate),this._isBufferNullified=!0,g(this,0)}else this._isBufferNullified=!1,g(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(b){this._nativeConvolverNode.normalize=b}})(be,bf,vu,ie,Kt,jn),_f=((p,t,o,l,d)=>g=>{const b=new WeakMap;return{render(_,C){const T=b.get(C);return T!==void 0?Promise.resolve(T):(async(P,k)=>{let O=o(P);const N=rt(O,k);if(!N){const $={channelCount:O.channelCount,channelCountMode:O.channelCountMode,channelInterpretation:O.channelInterpretation,delayTime:O.delayTime.value,maxDelayTime:g};O=t(k,$)}return b.set(k,O),N?await p(k,P.delayTime,O.delayTime):await l(k,P.delayTime,O.delayTime),await d(P,k,O),O})(_,C)}}})(Xs,Jh,te,Us,Fe),xf=((p,t,o,l,d,g,b)=>class extends p{constructor(_,C){const T=d(_),P={...Bm,...C},k=l(T,P),O=g(T);super(_,!1,k,O?o(P.maxDelayTime):null),this._delayTime=t(this,O,k.delayTime),b(this,P.maxDelayTime)}get delayTime(){return this._delayTime}})(be,Ls,_f,Jh,ie,Kt,jn),yu=(p=>(t,o)=>{const l=t.createDynamicsCompressor();if(Ae(l,o),o.channelCount>2||o.channelCountMode==="max")throw p();return ge(l,o,"attack"),ge(l,o,"knee"),ge(l,o,"ratio"),ge(l,o,"release"),ge(l,o,"threshold"),l})(Je),Sf=((p,t,o,l,d)=>()=>{const g=new WeakMap;return{render(b,_){const C=g.get(_);return C!==void 0?Promise.resolve(C):(async(T,P)=>{let k=o(T);const O=rt(k,P);if(!O){const N={attack:k.attack.value,channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,knee:k.knee.value,ratio:k.ratio.value,release:k.release.value,threshold:k.threshold.value};k=t(P,N)}return g.set(P,k),O?(await p(P,T.attack,k.attack),await p(P,T.knee,k.knee),await p(P,T.ratio,k.ratio),await p(P,T.release,k.release),await p(P,T.threshold,k.threshold)):(await l(P,T.attack,k.attack),await l(P,T.knee,k.knee),await l(P,T.ratio,k.ratio),await l(P,T.release,k.release),await l(P,T.threshold,k.threshold)),await d(T,P,k),k})(b,_)}}})(Xs,yu,te,Us,Fe),Cf=((p,t,o,l,d,g,b,_)=>class extends p{constructor(C,T){const P=g(C),k={...qm,...T},O=l(P,k),N=b(P);super(C,!1,O,N?o():null),this._attack=t(this,N,O.attack),this._knee=t(this,N,O.knee),this._nativeDynamicsCompressorNode=O,this._ratio=t(this,N,O.ratio),this._release=t(this,N,O.release),this._threshold=t(this,N,O.threshold),_(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(C){const T=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=C,C>2)throw this._nativeDynamicsCompressorNode.channelCount=T,d()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(C){const T=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=C,C==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=T,d()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(be,Ls,Sf,yu,Je,ie,Kt,jn),Tf=((p,t,o,l,d)=>()=>{const g=new WeakMap;return{render(b,_){const C=g.get(_);return C!==void 0?Promise.resolve(C):(async(T,P)=>{let k=o(T);const O=rt(k,P);if(!O){const N={channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,gain:k.gain.value};k=t(P,N)}return g.set(P,k),O?await p(P,T.gain,k.gain):await l(P,T.gain,k.gain),await d(T,P,k),k})(b,_)}}})(Xs,os,te,Us,Fe),Af=((p,t,o,l,d,g)=>class extends p{constructor(b,_){const C=d(b),T={...$m,..._},P=l(C,T),k=g(C);super(b,!1,P,k?o():null),this._gain=t(this,k,P.gain,Bt,jt)}get gain(){return this._gain}})(be,Ls,Tf,os,ie,Kt),Mf=((p,t,o,l)=>(d,g,{channelCount:b,channelCountMode:_,channelInterpretation:C,feedback:T,feedforward:P})=>{const k=Zh(g,d.sampleRate),O=T instanceof Float64Array?T:new Float64Array(T),N=P instanceof Float64Array?P:new Float64Array(P),$=O.length,q=N.length,L=Math.min($,q);if($===0||$>20)throw l();if(O[0]===0)throw t();if(q===0||q>20)throw l();if(N[0]===0)throw t();if(O[0]!==1){for(let j=0;j<q;j+=1)N[j]/=O[0];for(let j=1;j<$;j+=1)O[j]/=O[0]}const W=o(d,k,b,b);W.channelCount=b,W.channelCountMode=_,W.channelInterpretation=C;const z=[],B=[],J=[];for(let j=0;j<b;j+=1){z.push(0);const Z=new Float32Array(32),V=new Float32Array(32);Z.fill(0),V.fill(0),B.push(Z),J.push(V)}W.onaudioprocess=j=>{const Z=j.inputBuffer,V=j.outputBuffer,nt=Z.numberOfChannels;for(let Y=0;Y<nt;Y+=1){const et=Z.getChannelData(Y),ct=V.getChannelData(Y);z[Y]=Uh(O,$,N,q,L,B[Y],J[Y],z[Y],32,et,ct)}};const st=d.sampleRate/2;return vi({get bufferSize(){return k},get channelCount(){return W.channelCount},set channelCount(j){W.channelCount=j},get channelCountMode(){return W.channelCountMode},set channelCountMode(j){W.channelCountMode=j},get channelInterpretation(){return W.channelInterpretation},set channelInterpretation(j){W.channelInterpretation=j},get context(){return W.context},get inputs(){return[W]},get numberOfInputs(){return W.numberOfInputs},get numberOfOutputs(){return W.numberOfOutputs},addEventListener:(...j)=>W.addEventListener(j[0],j[1],j[2]),dispatchEvent:(...j)=>W.dispatchEvent(j[0]),getFrequencyResponse(j,Z,V){if(j.length!==Z.length||Z.length!==V.length)throw p();const nt=j.length;for(let Y=0;Y<nt;Y+=1){const et=-Math.PI*(j[Y]/st),ct=[Math.cos(et),Math.sin(et)],ht=Vm(Kh(N,ct),Kh(O,ct));Z[Y]=Math.sqrt(ht[0]*ht[0]+ht[1]*ht[1]),V[Y]=Math.atan2(ht[1],ht[0])}},removeEventListener:(...j)=>W.removeEventListener(j[0],j[1],j[2])},W)})(qr,De,_o,Je),Wr=((p,t,o,l)=>d=>p(bo,()=>bo(d))?Promise.resolve(p(l,l)).then(g=>{if(!g){const b=o(d,512,0,1);d.oncomplete=()=>{b.onaudioprocess=null,b.disconnect()},b.onaudioprocess=()=>d.currentTime,b.connect(d.destination)}return d.startRendering()}):new Promise(g=>{const b=t(d,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});d.oncomplete=_=>{b.disconnect(),g(_.renderedBuffer)},b.connect(d.destination),d.startRendering()}))(Ts,os,_o,((p,t)=>()=>{if(t===null)return Promise.resolve(!1);const o=new t(1,1,44100),l=p(o,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(d=>{o.oncomplete=()=>{l.disconnect(),d(o.currentTime!==0)},o.startRendering()})})(os,Oe)),Ef=((p,t,o,l,d)=>(g,b)=>{const _=new WeakMap;let C=null;return{render(T,P){const k=_.get(P);return k!==void 0?Promise.resolve(k):(async(O,N)=>{let $=null,q=t(O);const L=rt(q,N);if(N.createIIRFilter===void 0?$=p(N,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):L||(q=N.createIIRFilter(b,g)),_.set(N,$===null?q:$),$!==null){if(C===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const z=new o(O.context.destination.channelCount,O.context.length,N.sampleRate);C=(async()=>(await l(O,z,z.destination),((B,J,st,j)=>{const Z=st instanceof Float64Array?st:new Float64Array(st),V=j instanceof Float64Array?j:new Float64Array(j),nt=Z.length,Y=V.length,et=Math.min(nt,Y);if(Z[0]!==1){for(let vt=0;vt<nt;vt+=1)V[vt]/=Z[0];for(let vt=1;vt<Y;vt+=1)Z[vt]/=Z[0]}const ct=new Float32Array(32),ht=new Float32Array(32),Mt=J.createBuffer(B.numberOfChannels,B.length,B.sampleRate),yt=B.numberOfChannels;for(let vt=0;vt<yt;vt+=1){const Pt=B.getChannelData(vt),gt=Mt.getChannelData(vt);ct.fill(0),ht.fill(0),Uh(Z,nt,V,Y,et,ct,ht,0,32,Pt,gt)}return Mt})(await d(z),N,g,b)))()}const W=await C;return $.buffer=W,$.start(0),$}return await l(O,N,q),q})(T,P)}}})(wi,te,Oe,Fe,Wr),Pf=(p=>(t,o,l)=>{if(t.createIIRFilter===void 0)return p(t,o,l);const d=t.createIIRFilter(l.feedforward,l.feedback);return Ae(d,l),d})(Mf),kf=((p,t,o,l,d,g)=>class extends p{constructor(b,_){const C=l(b),T=d(C),P={...zm,..._},k=t(C,T?null:b.baseLatency,P);super(b,!1,k,T?o(P.feedback,P.feedforward):null),(O=>{var N;O.getFrequencyResponse=(N=O.getFrequencyResponse,($,q,L)=>{if($.length!==q.length||q.length!==L.length)throw qr();return N.call(O,$,q,L)})})(k),this._nativeIIRFilterNode=k,g(this,1)}getFrequencyResponse(b,_,C){return this._nativeIIRFilterNode.getFrequencyResponse(b,_,C)}})(be,Pf,Ef,ie,Kt,jn),If=((p,t,o,l,d,g,b,_)=>(C,T)=>{const P=T.listener,{forwardX:k,forwardY:O,forwardZ:N,positionX:$,positionY:q,positionZ:L,upX:W,upY:z,upZ:B}=P.forwardX===void 0?(()=>{const J=new Float32Array(1),st=t(T,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),j=b(T);let Z=!1,V=[0,0,-1,0,1,0],nt=[0,0,0];const Y=()=>{if(Z)return;Z=!0;const Mt=l(T,256,9,0);Mt.onaudioprocess=({inputBuffer:yt})=>{const vt=[g(yt,J,0),g(yt,J,1),g(yt,J,2),g(yt,J,3),g(yt,J,4),g(yt,J,5)];vt.some((gt,kt)=>gt!==V[kt])&&(P.setOrientation(...vt),V=vt);const Pt=[g(yt,J,6),g(yt,J,7),g(yt,J,8)];Pt.some((gt,kt)=>gt!==nt[kt])&&(P.setPosition(...Pt),nt=Pt)},st.connect(Mt)},et=Mt=>yt=>{yt!==V[Mt]&&(V[Mt]=yt,P.setOrientation(...V))},ct=Mt=>yt=>{yt!==nt[Mt]&&(nt[Mt]=yt,P.setPosition(...nt))},ht=(Mt,yt,vt)=>{const Pt=o(T,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:yt});Pt.connect(st,0,Mt),Pt.start(),Object.defineProperty(Pt.offset,"defaultValue",{get:()=>yt});const gt=p({context:C},j,Pt.offset,Bt,jt);var kt,Lt,Vt,ae,ye,as,Ot;return _(gt,"value",mt=>()=>mt.call(gt),mt=>se=>{try{mt.call(gt,se)}catch(Qt){if(Qt.code!==9)throw Qt}Y(),j&&vt(se)}),gt.cancelAndHoldAtTime=(kt=gt.cancelAndHoldAtTime,j?()=>{throw d()}:(...mt)=>{const se=kt.apply(gt,mt);return Y(),se}),gt.cancelScheduledValues=(Lt=gt.cancelScheduledValues,j?()=>{throw d()}:(...mt)=>{const se=Lt.apply(gt,mt);return Y(),se}),gt.exponentialRampToValueAtTime=(Vt=gt.exponentialRampToValueAtTime,j?()=>{throw d()}:(...mt)=>{const se=Vt.apply(gt,mt);return Y(),se}),gt.linearRampToValueAtTime=(ae=gt.linearRampToValueAtTime,j?()=>{throw d()}:(...mt)=>{const se=ae.apply(gt,mt);return Y(),se}),gt.setTargetAtTime=(ye=gt.setTargetAtTime,j?()=>{throw d()}:(...mt)=>{const se=ye.apply(gt,mt);return Y(),se}),gt.setValueAtTime=(as=gt.setValueAtTime,j?()=>{throw d()}:(...mt)=>{const se=as.apply(gt,mt);return Y(),se}),gt.setValueCurveAtTime=(Ot=gt.setValueCurveAtTime,j?()=>{throw d()}:(...mt)=>{const se=Ot.apply(gt,mt);return Y(),se}),gt};return{forwardX:ht(0,0,et(0)),forwardY:ht(1,0,et(1)),forwardZ:ht(2,-1,et(2)),positionX:ht(6,0,ct(0)),positionY:ht(7,0,ct(1)),positionZ:ht(8,0,ct(2)),upX:ht(3,0,et(3)),upY:ht(4,1,et(4)),upZ:ht(5,0,et(5))}})():P;return{get forwardX(){return k},get forwardY(){return O},get forwardZ(){return N},get positionX(){return $},get positionY(){return q},get positionZ(){return L},get upX(){return W},get upY(){return z},get upZ(){return B}}})(Ls,Mn,_i,_o,Je,tu,Kt,xo),bu=new WeakMap,Rf=((p,t,o,l,d,g)=>class extends o{constructor(b,_){super(b),this._nativeContext=b,E.set(this,b),l(b)&&d.set(b,new Set),this._destination=new p(this,_),this._listener=t(this,b),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(b){const _=typeof b=="function"?g(this,b):null;this._nativeContext.onstatechange=_;const C=this._nativeContext.onstatechange;this._onstatechange=C!==null&&C===_?b:C}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(lf,If,cu,Kt,bu,yi),wu=((p,t,o,l,d,g)=>(b,_)=>{const C=b.createOscillator();return Ae(C,_),ge(C,_,"detune"),ge(C,_,"frequency"),_.periodicWave!==void 0?C.setPeriodicWave(_.periodicWave):ce(C,_,"type"),t(o,()=>o(b))||Ja(C),t(l,()=>l(b))||g(C,b),t(d,()=>d(b))||Ka(C),p(b,C),C})(zr,Ts,tl,nu,el,iu),Df=((p,t,o,l,d)=>()=>{const g=new WeakMap;let b=null,_=null,C=null;return{set periodicWave(T){b=T},set start(T){_=T},set stop(T){C=T},render(T,P){const k=g.get(P);return k!==void 0?Promise.resolve(k):(async(O,N)=>{let $=o(O);const q=rt($,N);if(!q){const L={channelCount:$.channelCount,channelCountMode:$.channelCountMode,channelInterpretation:$.channelInterpretation,detune:$.detune.value,frequency:$.frequency.value,periodicWave:b===null?void 0:b,type:$.type};$=t(N,L),_!==null&&$.start(_),C!==null&&$.stop(C)}return g.set(N,$),q?(await p(N,O.detune,$.detune),await p(N,O.frequency,$.frequency)):(await l(N,O.detune,$.detune),await l(N,O.frequency,$.frequency)),await d(O,N,$),$})(T,P)}}})(Xs,wu,te,Us,Fe),Of=((p,t,o,l,d,g,b)=>class extends p{constructor(_,C){const T=d(_),P={...Gm,...C},k=o(T,P),O=g(T),N=O?l():null,$=_.sampleRate/2;super(_,!1,k,N),this._detune=t(this,O,k.detune,153600,-153600),this._frequency=t(this,O,k.frequency,$,-$),this._nativeOscillatorNode=k,this._onended=null,this._oscillatorNodeRenderer=N,this._oscillatorNodeRenderer!==null&&P.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=P.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(_){const C=typeof _=="function"?b(this,_):null;this._nativeOscillatorNode.onended=C;const T=this._nativeOscillatorNode.onended;this._onended=T!==null&&T===C?_:T}get type(){return this._nativeOscillatorNode.type}set type(_){this._nativeOscillatorNode.type=_,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(_){this._nativeOscillatorNode.setPeriodicWave(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=_)}start(_=0){if(this._nativeOscillatorNode.start(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=_),this.context.state!=="closed"){xt(this);const C=()=>{this._nativeOscillatorNode.removeEventListener("ended",C),ne(this)&&Wt(this)};this._nativeOscillatorNode.addEventListener("ended",C)}}stop(_=0){this._nativeOscillatorNode.stop(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=_)}})(be,Ls,wu,Df,ie,Kt,yi),_u=(p=>(t,o)=>{const l=p(t,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),d=t.createBuffer(1,2,44100);return l.buffer=d,l.loop=!0,l.connect(o),l.start(),()=>{l.stop(),l.disconnect(o)}})(wi),Nf=((p,t,o,l,d)=>(g,{curve:b,oversample:_,...C})=>{const T=g.createWaveShaper(),P=g.createWaveShaper();Ae(T,C),Ae(P,C);const k=o(g,{...C,gain:1}),O=o(g,{...C,gain:-1}),N=o(g,{...C,gain:1}),$=o(g,{...C,gain:-1});let q=null,L=!1,W=null;const z={get bufferSize(){},get channelCount(){return T.channelCount},set channelCount(B){k.channelCount=B,O.channelCount=B,T.channelCount=B,N.channelCount=B,P.channelCount=B,$.channelCount=B},get channelCountMode(){return T.channelCountMode},set channelCountMode(B){k.channelCountMode=B,O.channelCountMode=B,T.channelCountMode=B,N.channelCountMode=B,P.channelCountMode=B,$.channelCountMode=B},get channelInterpretation(){return T.channelInterpretation},set channelInterpretation(B){k.channelInterpretation=B,O.channelInterpretation=B,T.channelInterpretation=B,N.channelInterpretation=B,P.channelInterpretation=B,$.channelInterpretation=B},get context(){return T.context},get curve(){return W},set curve(B){if(B!==null&&B.length<2)throw t();if(B===null)T.curve=B,P.curve=B;else{const J=B.length,st=new Float32Array(J+2-J%2),j=new Float32Array(J+2-J%2);st[0]=B[0],j[0]=-B[J-1];const Z=Math.ceil((J+1)/2),V=(J+1)/2-1;for(let nt=1;nt<Z;nt+=1){const Y=nt/Z*V,et=Math.floor(Y),ct=Math.ceil(Y);st[nt]=et===ct?B[et]:(1-(Y-et))*B[et]+(1-(ct-Y))*B[ct],j[nt]=et===ct?-B[J-1-et]:-(1-(Y-et))*B[J-1-et]-(1-(ct-Y))*B[J-1-ct]}st[Z]=J%2==1?B[Z-1]:(B[Z-2]+B[Z-1])/2,T.curve=st,P.curve=j}W=B,L&&(l(W)&&q===null?q=p(g,k):q!==null&&(q(),q=null))},get inputs(){return[k]},get numberOfInputs(){return T.numberOfInputs},get numberOfOutputs(){return T.numberOfOutputs},get oversample(){return T.oversample},set oversample(B){T.oversample=B,P.oversample=B},addEventListener:(...B)=>k.addEventListener(B[0],B[1],B[2]),dispatchEvent:(...B)=>k.dispatchEvent(B[0]),removeEventListener:(...B)=>k.removeEventListener(B[0],B[1],B[2])};return b!==null&&(z.curve=b instanceof Float32Array?b:new Float32Array(b)),_!==z.oversample&&(z.oversample=_),d(vi(z,N),()=>{k.connect(T).connect(N),k.connect(O).connect(P).connect($).connect(N),L=!0,l(W)&&(q=p(g,k))},()=>{k.disconnect(T),T.disconnect(N),k.disconnect(O),O.disconnect(P),P.disconnect($),$.disconnect(N),L=!1,q!==null&&(q(),q=null)})})(_u,De,os,eu,An),Vr=((p,t,o,l,d,g,b)=>(_,C)=>{const T=_.createWaveShaper();if(g!==null&&g.name==="webkitAudioContext"&&_.createGain().gain.automationRate===void 0)return o(_,C);Ae(T,C);const P=C.curve===null||C.curve instanceof Float32Array?C.curve:new Float32Array(C.curve);if(P!==null&&P.length<2)throw t();ce(T,{curve:P},"curve"),ce(T,C,"oversample");let k=null,O=!1;return b(T,"curve",N=>()=>N.call(T),N=>$=>(N.call(T,$),O&&(l($)&&k===null?k=p(_,T):l($)||k===null||(k(),k=null)),$)),d(T,()=>{O=!0,l(T.curve)&&(k=p(_,T))},()=>{O=!1,k!==null&&(k(),k=null)})})(_u,De,Nf,eu,An,Tn,xo),Lf=((p,t,o,l,d,g,b,_,C,T)=>(P,{coneInnerAngle:k,coneOuterAngle:O,coneOuterGain:N,distanceModel:$,maxDistance:q,orientationX:L,orientationY:W,orientationZ:z,panningModel:B,positionX:J,positionY:st,positionZ:j,refDistance:Z,rolloffFactor:V,...nt})=>{const Y=P.createPanner();if(nt.channelCount>2||nt.channelCountMode==="max")throw b();Ae(Y,nt);const et={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},ct=o(P,{...et,channelInterpretation:"speakers",numberOfInputs:6}),ht=l(P,{...nt,gain:1}),Mt=l(P,{...et,gain:1}),yt=l(P,{...et,gain:0}),vt=l(P,{...et,gain:0}),Pt=l(P,{...et,gain:0}),gt=l(P,{...et,gain:0}),kt=l(P,{...et,gain:0}),Lt=d(P,256,6,1),Vt=g(P,{...et,curve:new Float32Array([1,1]),oversample:"none"});let ae=[L,W,z],ye=[J,st,j];const as=new Float32Array(1);Lt.onaudioprocess=({inputBuffer:mt})=>{const se=[C(mt,as,0),C(mt,as,1),C(mt,as,2)];se.some((Ve,Ln)=>Ve!==ae[Ln])&&(Y.setOrientation(...se),ae=se);const Qt=[C(mt,as,3),C(mt,as,4),C(mt,as,5)];Qt.some((Ve,Ln)=>Ve!==ye[Ln])&&(Y.setPosition(...Qt),ye=Qt)},Object.defineProperty(yt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(vt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Pt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(gt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(kt.gain,"defaultValue",{get:()=>0});const Ot={get bufferSize(){},get channelCount(){return Y.channelCount},set channelCount(mt){if(mt>2)throw b();ht.channelCount=mt,Y.channelCount=mt},get channelCountMode(){return Y.channelCountMode},set channelCountMode(mt){if(mt==="max")throw b();ht.channelCountMode=mt,Y.channelCountMode=mt},get channelInterpretation(){return Y.channelInterpretation},set channelInterpretation(mt){ht.channelInterpretation=mt,Y.channelInterpretation=mt},get coneInnerAngle(){return Y.coneInnerAngle},set coneInnerAngle(mt){Y.coneInnerAngle=mt},get coneOuterAngle(){return Y.coneOuterAngle},set coneOuterAngle(mt){Y.coneOuterAngle=mt},get coneOuterGain(){return Y.coneOuterGain},set coneOuterGain(mt){if(mt<0||mt>1)throw t();Y.coneOuterGain=mt},get context(){return Y.context},get distanceModel(){return Y.distanceModel},set distanceModel(mt){Y.distanceModel=mt},get inputs(){return[ht]},get maxDistance(){return Y.maxDistance},set maxDistance(mt){if(mt<0)throw new RangeError;Y.maxDistance=mt},get numberOfInputs(){return Y.numberOfInputs},get numberOfOutputs(){return Y.numberOfOutputs},get orientationX(){return Mt.gain},get orientationY(){return yt.gain},get orientationZ(){return vt.gain},get panningModel(){return Y.panningModel},set panningModel(mt){Y.panningModel=mt},get positionX(){return Pt.gain},get positionY(){return gt.gain},get positionZ(){return kt.gain},get refDistance(){return Y.refDistance},set refDistance(mt){if(mt<0)throw new RangeError;Y.refDistance=mt},get rolloffFactor(){return Y.rolloffFactor},set rolloffFactor(mt){if(mt<0)throw new RangeError;Y.rolloffFactor=mt},addEventListener:(...mt)=>ht.addEventListener(mt[0],mt[1],mt[2]),dispatchEvent:(...mt)=>ht.dispatchEvent(mt[0]),removeEventListener:(...mt)=>ht.removeEventListener(mt[0],mt[1],mt[2])};return k!==Ot.coneInnerAngle&&(Ot.coneInnerAngle=k),O!==Ot.coneOuterAngle&&(Ot.coneOuterAngle=O),N!==Ot.coneOuterGain&&(Ot.coneOuterGain=N),$!==Ot.distanceModel&&(Ot.distanceModel=$),q!==Ot.maxDistance&&(Ot.maxDistance=q),L!==Ot.orientationX.value&&(Ot.orientationX.value=L),W!==Ot.orientationY.value&&(Ot.orientationY.value=W),z!==Ot.orientationZ.value&&(Ot.orientationZ.value=z),B!==Ot.panningModel&&(Ot.panningModel=B),J!==Ot.positionX.value&&(Ot.positionX.value=J),st!==Ot.positionY.value&&(Ot.positionY.value=st),j!==Ot.positionZ.value&&(Ot.positionZ.value=j),Z!==Ot.refDistance&&(Ot.refDistance=Z),V!==Ot.rolloffFactor&&(Ot.rolloffFactor=V),ae[0]===1&&ae[1]===0&&ae[2]===0||Y.setOrientation(...ae),ye[0]===0&&ye[1]===0&&ye[2]===0||Y.setPosition(...ye),T(vi(Ot,Y),()=>{ht.connect(Y),p(ht,Vt,0,0),Vt.connect(Mt).connect(ct,0,0),Vt.connect(yt).connect(ct,0,1),Vt.connect(vt).connect(ct,0,2),Vt.connect(Pt).connect(ct,0,3),Vt.connect(gt).connect(ct,0,4),Vt.connect(kt).connect(ct,0,5),ct.connect(Lt).connect(P.destination)},()=>{ht.disconnect(Y),_(ht,Vt,0,0),Vt.disconnect(Mt),Mt.disconnect(ct),Vt.disconnect(yt),yt.disconnect(ct),Vt.disconnect(vt),vt.disconnect(ct),Vt.disconnect(Pt),Pt.disconnect(ct),Vt.disconnect(gt),gt.disconnect(ct),Vt.disconnect(kt),kt.disconnect(ct),ct.disconnect(Lt),Lt.disconnect(P.destination)})})(Sn,De,Mn,os,_o,Vr,Je,Cn,tu,An),xu=(p=>(t,o)=>{const l=t.createPanner();return l.orientationX===void 0?p(t,o):(Ae(l,o),ge(l,o,"orientationX"),ge(l,o,"orientationY"),ge(l,o,"orientationZ"),ge(l,o,"positionX"),ge(l,o,"positionY"),ge(l,o,"positionZ"),ce(l,o,"coneInnerAngle"),ce(l,o,"coneOuterAngle"),ce(l,o,"coneOuterGain"),ce(l,o,"distanceModel"),ce(l,o,"maxDistance"),ce(l,o,"panningModel"),ce(l,o,"refDistance"),ce(l,o,"rolloffFactor"),l)})(Lf),Ff=((p,t,o,l,d,g,b,_,C,T)=>()=>{const P=new WeakMap;let k=null;return{render(O,N){const $=P.get(N);return $!==void 0?Promise.resolve($):(async(q,L)=>{let W=null,z=g(q);const B={channelCount:z.channelCount,channelCountMode:z.channelCountMode,channelInterpretation:z.channelInterpretation},J={...B,coneInnerAngle:z.coneInnerAngle,coneOuterAngle:z.coneOuterAngle,coneOuterGain:z.coneOuterGain,distanceModel:z.distanceModel,maxDistance:z.maxDistance,panningModel:z.panningModel,refDistance:z.refDistance,rolloffFactor:z.rolloffFactor},st=rt(z,L);if("bufferSize"in z)W=l(L,{...B,gain:1});else if(!st){const j={...J,orientationX:z.orientationX.value,orientationY:z.orientationY.value,orientationZ:z.orientationZ.value,positionX:z.positionX.value,positionY:z.positionY.value,positionZ:z.positionZ.value};z=d(L,j)}if(P.set(L,W===null?z:W),W!==null){if(k===null){if(b===null)throw new Error("Missing the native OfflineAudioContext constructor.");const ht=new b(6,q.context.length,L.sampleRate),Mt=t(ht,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});Mt.connect(ht.destination),k=(async()=>{const yt=await Promise.all([q.orientationX,q.orientationY,q.orientationZ,q.positionX,q.positionY,q.positionZ].map(async(vt,Pt)=>{const gt=o(ht,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Pt===0?1:0});return await _(ht,vt,gt.offset),gt}));for(let vt=0;vt<6;vt+=1)yt[vt].connect(Mt,0,vt),yt[vt].start(0);return T(ht)})()}const j=await k,Z=l(L,{...B,gain:1});await C(q,L,Z);const V=[];for(let ht=0;ht<j.numberOfChannels;ht+=1)V.push(j.getChannelData(ht));let nt=[V[0][0],V[1][0],V[2][0]],Y=[V[3][0],V[4][0],V[5][0]],et=l(L,{...B,gain:1}),ct=d(L,{...J,orientationX:nt[0],orientationY:nt[1],orientationZ:nt[2],positionX:Y[0],positionY:Y[1],positionZ:Y[2]});Z.connect(et).connect(ct.inputs[0]),ct.connect(W);for(let ht=128;ht<j.length;ht+=128){const Mt=[V[0][ht],V[1][ht],V[2][ht]],yt=[V[3][ht],V[4][ht],V[5][ht]];if(Mt.some((vt,Pt)=>vt!==nt[Pt])||yt.some((vt,Pt)=>vt!==Y[Pt])){nt=Mt,Y=yt;const vt=ht/L.sampleRate;et.gain.setValueAtTime(0,vt),et=l(L,{...B,gain:0}),ct=d(L,{...J,orientationX:nt[0],orientationY:nt[1],orientationZ:nt[2],positionX:Y[0],positionY:Y[1],positionZ:Y[2]}),et.gain.setValueAtTime(1,vt),Z.connect(et).connect(ct.inputs[0]),ct.connect(W)}}return W}return st?(await p(L,q.orientationX,z.orientationX),await p(L,q.orientationY,z.orientationY),await p(L,q.orientationZ,z.orientationZ),await p(L,q.positionX,z.positionX),await p(L,q.positionY,z.positionY),await p(L,q.positionZ,z.positionZ)):(await _(L,q.orientationX,z.orientationX),await _(L,q.orientationY,z.orientationY),await _(L,q.orientationZ,z.orientationZ),await _(L,q.positionX,z.positionX),await _(L,q.positionY,z.positionY),await _(L,q.positionZ,z.positionZ)),Le(z)?await C(q,L,z.inputs[0]):await C(q,L,z),z})(O,N)}}})(Xs,Mn,_i,os,xu,te,Oe,Us,Fe,Wr),Bf=((p,t,o,l,d,g,b)=>class extends p{constructor(_,C){const T=d(_),P={...jm,...C},k=o(T,P),O=g(T);super(_,!1,k,O?l():null),this._nativePannerNode=k,this._orientationX=t(this,O,k.orientationX,Bt,jt),this._orientationY=t(this,O,k.orientationY,Bt,jt),this._orientationZ=t(this,O,k.orientationZ,Bt,jt),this._positionX=t(this,O,k.positionX,Bt,jt),this._positionY=t(this,O,k.positionY,Bt,jt),this._positionZ=t(this,O,k.positionZ,Bt,jt),b(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(_){this._nativePannerNode.coneInnerAngle=_}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(_){this._nativePannerNode.coneOuterAngle=_}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(_){this._nativePannerNode.coneOuterGain=_}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(_){this._nativePannerNode.distanceModel=_}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(_){this._nativePannerNode.maxDistance=_}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(_){this._nativePannerNode.panningModel=_}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(_){this._nativePannerNode.refDistance=_}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(_){this._nativePannerNode.rolloffFactor=_}})(be,Ls,xu,Ff,ie,Kt,jn),qf=(p=>(t,{disableNormalization:o,imag:l,real:d})=>{const g=l instanceof Float32Array?l:new Float32Array(l),b=d instanceof Float32Array?d:new Float32Array(d),_=t.createPeriodicWave(b,g,{disableNormalization:o});if(Array.from(l).length<2)throw p();return _})(Tt),$f=((p,t,o,l)=>class fp{constructor(g,b){const _=t(g),C=(P=>{const{imag:k,real:O}=P;return k===void 0?O===void 0?{...P,imag:[0,0],real:[0,0]}:{...P,imag:Array.from(O,()=>0),real:O}:O===void 0?{...P,imag:k,real:Array.from(k,()=>0)}:{...P,imag:k,real:O}})({...Xm,...b}),T=p(_,C);return o.add(T),T}static[Symbol.hasInstance](g){return g!==null&&typeof g=="object"&&Object.getPrototypeOf(g)===fp.prototype||o.has(g)}})(qf,ie,new WeakSet),zf=((p,t,o,l,d,g)=>{const _=new Float32Array([1,1]),C=Math.PI/2,T={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},P={...T,oversample:"none"},k=(O,N,$,q,L)=>{if(N===1)return((W,z,B,J)=>{const st=new Float32Array(16385),j=new Float32Array(16385);for(let ct=0;ct<16385;ct+=1){const ht=ct/16384*C;st[ct]=Math.cos(ht),j[ct]=Math.sin(ht)}const Z=o(W,{...T,gain:0}),V=l(W,{...P,curve:st}),nt=l(W,{...P,curve:_}),Y=o(W,{...T,gain:0}),et=l(W,{...P,curve:j});return{connectGraph(){z.connect(Z),z.connect(nt.inputs===void 0?nt:nt.inputs[0]),z.connect(Y),nt.connect(B),B.connect(V.inputs===void 0?V:V.inputs[0]),B.connect(et.inputs===void 0?et:et.inputs[0]),V.connect(Z.gain),et.connect(Y.gain),Z.connect(J,0,0),Y.connect(J,0,1)},disconnectGraph(){z.disconnect(Z),z.disconnect(nt.inputs===void 0?nt:nt.inputs[0]),z.disconnect(Y),nt.disconnect(B),B.disconnect(V.inputs===void 0?V:V.inputs[0]),B.disconnect(et.inputs===void 0?et:et.inputs[0]),V.disconnect(Z.gain),et.disconnect(Y.gain),Z.disconnect(J,0,0),Y.disconnect(J,0,1)}}})(O,$,q,L);if(N===2)return((W,z,B,J)=>{const st=new Float32Array(16385),j=new Float32Array(16385),Z=new Float32Array(16385),V=new Float32Array(16385),nt=Math.floor(8192.5);for(let Lt=0;Lt<16385;Lt+=1)if(Lt>nt){const Vt=(Lt-nt)/(16384-nt)*C;st[Lt]=Math.cos(Vt),j[Lt]=Math.sin(Vt),Z[Lt]=0,V[Lt]=1}else{const Vt=Lt/(16384-nt)*C;st[Lt]=1,j[Lt]=0,Z[Lt]=Math.cos(Vt),V[Lt]=Math.sin(Vt)}const Y=t(W,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),et=o(W,{...T,gain:0}),ct=l(W,{...P,curve:st}),ht=o(W,{...T,gain:0}),Mt=l(W,{...P,curve:j}),yt=l(W,{...P,curve:_}),vt=o(W,{...T,gain:0}),Pt=l(W,{...P,curve:Z}),gt=o(W,{...T,gain:0}),kt=l(W,{...P,curve:V});return{connectGraph(){z.connect(Y),z.connect(yt.inputs===void 0?yt:yt.inputs[0]),Y.connect(et,0),Y.connect(ht,0),Y.connect(vt,1),Y.connect(gt,1),yt.connect(B),B.connect(ct.inputs===void 0?ct:ct.inputs[0]),B.connect(Mt.inputs===void 0?Mt:Mt.inputs[0]),B.connect(Pt.inputs===void 0?Pt:Pt.inputs[0]),B.connect(kt.inputs===void 0?kt:kt.inputs[0]),ct.connect(et.gain),Mt.connect(ht.gain),Pt.connect(vt.gain),kt.connect(gt.gain),et.connect(J,0,0),vt.connect(J,0,0),ht.connect(J,0,1),gt.connect(J,0,1)},disconnectGraph(){z.disconnect(Y),z.disconnect(yt.inputs===void 0?yt:yt.inputs[0]),Y.disconnect(et,0),Y.disconnect(ht,0),Y.disconnect(vt,1),Y.disconnect(gt,1),yt.disconnect(B),B.disconnect(ct.inputs===void 0?ct:ct.inputs[0]),B.disconnect(Mt.inputs===void 0?Mt:Mt.inputs[0]),B.disconnect(Pt.inputs===void 0?Pt:Pt.inputs[0]),B.disconnect(kt.inputs===void 0?kt:kt.inputs[0]),ct.disconnect(et.gain),Mt.disconnect(ht.gain),Pt.disconnect(vt.gain),kt.disconnect(gt.gain),et.disconnect(J,0,0),vt.disconnect(J,0,0),ht.disconnect(J,0,1),gt.disconnect(J,0,1)}}})(O,$,q,L);throw d()};return(O,{channelCount:N,channelCountMode:$,pan:q,...L})=>{if($==="max")throw d();const W=p(O,{...L,channelCount:1,channelCountMode:$,numberOfInputs:2}),z=o(O,{...L,channelCount:N,channelCountMode:$,gain:1}),B=o(O,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:q});let{connectGraph:J,disconnectGraph:st}=k(O,N,z,B,W);Object.defineProperty(B.gain,"defaultValue",{get:()=>0}),Object.defineProperty(B.gain,"maxValue",{get:()=>1}),Object.defineProperty(B.gain,"minValue",{get:()=>-1});const j={get bufferSize(){},get channelCount(){return z.channelCount},set channelCount(V){z.channelCount!==V&&(Z&&st(),{connectGraph:J,disconnectGraph:st}=k(O,V,z,B,W),Z&&J()),z.channelCount=V},get channelCountMode(){return z.channelCountMode},set channelCountMode(V){if(V==="clamped-max"||V==="max")throw d();z.channelCountMode=V},get channelInterpretation(){return z.channelInterpretation},set channelInterpretation(V){z.channelInterpretation=V},get context(){return z.context},get inputs(){return[z]},get numberOfInputs(){return z.numberOfInputs},get numberOfOutputs(){return z.numberOfOutputs},get pan(){return B.gain},addEventListener:(...V)=>z.addEventListener(V[0],V[1],V[2]),dispatchEvent:(...V)=>z.dispatchEvent(V[0]),removeEventListener:(...V)=>z.removeEventListener(V[0],V[1],V[2])};let Z=!1;return g(vi(j,W),()=>{J(),Z=!0},()=>{st(),Z=!1})}})(Mn,wo,os,Vr,Je,An),Su=((p,t)=>(o,l)=>{const d=l.channelCountMode;if(d==="clamped-max")throw t();if(o.createStereoPanner===void 0)return p(o,l);const g=o.createStereoPanner();return Ae(g,l),ge(g,l,"pan"),Object.defineProperty(g,"channelCountMode",{get:()=>d,set:b=>{if(b!==d)throw t()}}),g})(zf,Je),Wf=((p,t,o,l,d)=>()=>{const g=new WeakMap;return{render(b,_){const C=g.get(_);return C!==void 0?Promise.resolve(C):(async(T,P)=>{let k=o(T);const O=rt(k,P);if(!O){const N={channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,pan:k.pan.value};k=t(P,N)}return g.set(P,k),O?await p(P,T.pan,k.pan):await l(P,T.pan,k.pan),Le(k)?await d(T,P,k.inputs[0]):await d(T,P,k),k})(b,_)}}})(Xs,Su,te,Us,Fe),Vf=((p,t,o,l,d,g)=>class extends p{constructor(b,_){const C=d(b),T={...Um,..._},P=o(C,T),k=g(C);super(b,!1,P,k?l():null),this._pan=t(this,k,P.pan)}get pan(){return this._pan}})(be,Ls,Su,Wf,ie,Kt),Hf=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,g){const b=l.get(g);return b!==void 0?Promise.resolve(b):(async(_,C)=>{let T=t(_);if(!rt(T,C)){const P={channelCount:T.channelCount,channelCountMode:T.channelCountMode,channelInterpretation:T.channelInterpretation,curve:T.curve,oversample:T.oversample};T=p(C,P)}return l.set(C,T),Le(T)?await o(_,C,T.inputs[0]):await o(_,C,T),T})(d,g)}}})(Vr,te,Fe),Gf=((p,t,o,l,d,g,b)=>class extends p{constructor(_,C){const T=d(_),P={...Zm,...C},k=o(T,P);super(_,!0,k,g(T)?l():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=k,b(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(_){if(_===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(_.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=_}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(_){this._nativeWaveShaperNode.oversample=_}})(be,De,Vr,Hf,ie,Kt,jn),Cu=(p=>p!==null&&p.isSecureContext)(Ns),cl=(p=>(t,o,l)=>{Object.defineProperties(p,{currentFrame:{configurable:!0,get:()=>Math.round(t*o)},currentTime:{configurable:!0,get:()=>t}});try{return l()}finally{p!==null&&(delete p.currentFrame,delete p.currentTime)}})(Ns),Tu=new WeakMap,jf=((p,t)=>o=>{let l=p.get(o);if(l!==void 0)return l;if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");return l=new t(1,1,44100),p.set(o,l),l})(Tu,Oe),Xf=Cu?((p,t,o,l,d,g,b,_,C,T,P,k,O)=>{let N=0;return($,q,L={credentials:"omit"})=>{const W=P.get($);if(W!==void 0&&W.has(q))return Promise.resolve();const z=T.get($);if(z!==void 0){const st=z.get(q);if(st!==void 0)return st}const B=g($),J=B.audioWorklet===void 0?d(q).then(([st,j])=>{const[Z,V]=F(st,j);return o(`${Z};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${V}
})})(window,'_AWGS')`)}).then(()=>{const st=O._AWGS.pop();if(st===void 0)throw new SyntaxError;l(B.currentTime,B.sampleRate,()=>st(class{},void 0,(j,Z)=>{if(j.trim()==="")throw t();const V=R.get(B);if(V!==void 0){if(V.has(j))throw t();Q(Z),H(Z.parameterDescriptors),V.set(j,Z)}else Q(Z),H(Z.parameterDescriptors),R.set(B,new Map([[j,Z]]))},B.sampleRate,void 0,void 0))}):Promise.all([d(q),Promise.resolve(p(k,k))]).then(([[st,j],Z])=>{const V=N+1;N=V;const[nt,Y]=F(st,j),et=new Blob([`${nt};((AudioWorkletProcessor,registerProcessor)=>{${Y}
})(${Z?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${Z?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${Z?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${V}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),ct=URL.createObjectURL(et);return B.audioWorklet.addModule(ct,L).then(()=>{if(_(B))return B;const ht=b(B);return ht.audioWorklet.addModule(ct,L).then(()=>ht)}).then(ht=>{if(C===null)throw new SyntaxError;try{new C(ht,`__sac${V}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(ct))});return z===void 0?T.set($,new Map([[q,J]])):z.set(q,J),J.then(()=>{const st=P.get($);st===void 0?P.set($,new Set([q])):st.add(q)}).finally(()=>{const st=T.get($);st!==void 0&&st.delete(q)}),J}})(Ts,Je,(p=>t=>new Promise((o,l)=>{if(p===null)return void l(new SyntaxError);const d=p.document.head;if(d===null)l(new SyntaxError);else{const g=p.document.createElement("script"),b=new Blob([t],{type:"application/javascript"}),_=URL.createObjectURL(b),C=p.onerror,T=()=>{p.onerror=C,URL.revokeObjectURL(_)};p.onerror=(P,k,O,N,$)=>k===_||k===p.location.href&&O===1&&N===1?(T(),l($),!1):C!==null?C(P,k,O,N,$):void 0,g.onerror=()=>{T(),l(new SyntaxError)},g.onload=()=>{T(),o()},g.src=_,g.type="module",d.appendChild(g)}}))(Ns),cl,async p=>{try{const t=await fetch(p);if(t.ok)return[await t.text(),t.url]}catch{}throw new DOMException("","AbortError")},ie,jf,Kt,bi,new WeakMap,new WeakMap,((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const o=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new t(1,128,44100),d=URL.createObjectURL(o);let g=!1,b=!1;try{await l.audioWorklet.addModule(d);const _=new p(l,"a",{numberOfOutputs:0}),C=l.createOscillator();_.port.onmessage=()=>g=!0,_.onprocessorerror=()=>b=!0,C.connect(_),C.start(0),await l.startRendering(),await new Promise(T=>setTimeout(T))}catch{}finally{URL.revokeObjectURL(d)}return g&&!b})(bi,Oe),Ns):void 0,Uf=((p,t)=>o=>p(o)||t(o))(nl,Kt),Yf=((p,t,o,l,d,g,b,_,C,T,P)=>(k,O)=>{const N=b(k)?k:g(k);if(d.has(O)){const $=new DOMException("","DataCloneError");return Promise.reject($)}try{d.add(O)}catch{}return t(C,()=>C(N))?N.decodeAudioData(O).then($=>(Xh(O).catch(()=>{}),t(_,()=>_($))||P($),p.add($),$)):new Promise(($,q)=>{const L=async()=>{try{await Xh(O)}catch{}},W=z=>{q(z),L()};try{N.decodeAudioData(O,z=>{typeof z.copyFromChannel!="function"&&(T(z),dt(z)),p.add(z),L().then(()=>$(z))},z=>{W(z===null?new DOMException("","EncodingError"):z)})}catch(z){W(z)}})})(ol,Ts,0,0,new WeakSet,ie,Uf,at,bo,al,ll),Au=((p,t,o,l,d,g,b,_,C,T,P,k,O,N,$,q,L,W,z,B)=>class extends ${constructor(J,st){super(J,st),this._nativeContext=J,this._audioWorklet=p===void 0?void 0:{addModule:(j,Z)=>p(this,j,Z)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new t(this)}createBiquadFilter(){return new d(this)}createBuffer(J,st,j){return new o({length:st,numberOfChannels:J,sampleRate:j})}createBufferSource(){return new l(this)}createChannelMerger(J=6){return new g(this,{numberOfInputs:J})}createChannelSplitter(J=6){return new b(this,{numberOfOutputs:J})}createConstantSource(){return new _(this)}createConvolver(){return new C(this)}createDelay(J=1){return new P(this,{maxDelayTime:J})}createDynamicsCompressor(){return new k(this)}createGain(){return new O(this)}createIIRFilter(J,st){return new N(this,{feedback:st,feedforward:J})}createOscillator(){return new q(this)}createPanner(){return new L(this)}createPeriodicWave(J,st,j={disableNormalization:!1}){return new W(this,{...j,imag:st,real:J})}createStereoPanner(){return new z(this)}createWaveShaper(){return new B(this)}decodeAudioData(J,st,j){return T(this._nativeContext,J).then(Z=>(typeof st=="function"&&st(Z),Z),Z=>{throw typeof j=="function"&&j(Z),Z})}})(Xf,of,mu,af,hf,pf,ff,yf,wf,Yf,xf,Cf,Af,kf,Rf,Of,Bf,$f,Vf,Gf),Zf=((p,t,o,l)=>class extends p{constructor(d,g){const b=o(d),_=((C,T)=>C.createMediaElementSource(T.mediaElement))(b,g);if(l(b))throw TypeError();super(d,!0,_,null),this._nativeMediaElementAudioSourceNode=_}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(be,0,ie,Kt),Qf=((p,t,o,l)=>class extends p{constructor(d,g){const b=o(d);if(l(b))throw new TypeError;const _=((C,T)=>{const P=C.createMediaStreamDestination();return Ae(P,T),P.numberOfOutputs===1&&Object.defineProperty(P,"numberOfOutputs",{get:()=>0}),P})(b,{...Wm,...g});super(d,!1,_,null),this._nativeMediaStreamAudioDestinationNode=_}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(be,0,ie,Kt),Jf=((p,t,o,l)=>class extends p{constructor(d,g){const b=o(d),_=((C,{mediaStream:T})=>{const P=T.getAudioTracks();P.sort((N,$)=>N.id<$.id?-1:N.id>$.id?1:0);const k=P.slice(0,1),O=C.createMediaStreamSource(new MediaStream(k));return Object.defineProperty(O,"mediaStream",{value:T}),O})(b,g);if(l(b))throw new TypeError;super(d,!0,_,null),this._nativeMediaStreamAudioSourceNode=_}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(be,0,ie,Kt),Kf=((p,t)=>(o,{mediaStreamTrack:l})=>{if(typeof o.createMediaStreamTrackSource=="function")return o.createMediaStreamTrackSource(l);const d=new MediaStream([l]),g=o.createMediaStreamSource(d);if(l.kind!=="audio")throw p();if(t(o))throw new TypeError;return g})(De,Kt),tg=((p,t,o)=>class extends p{constructor(l,d){const g=o(l);super(l,!0,t(g,d),null)}})(be,Kf,ie),eg=((p,t,o,l,d,g,b,_,C)=>class extends p{constructor(T={}){if(C===null)throw new Error("Missing the native AudioContext constructor.");let P;try{P=new C(T)}catch(N){throw N.code===12&&N.message==="sampleRate is not in range"?o():N}if(P===null)throw l();if(!(N=>N===void 0||typeof N=="number"||typeof N=="string"&&(N==="balanced"||N==="interactive"||N==="playback"))(T.latencyHint))throw new TypeError(`The provided value '${T.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(T.sampleRate!==void 0&&P.sampleRate!==T.sampleRate)throw o();super(P,2);const{latencyHint:k}=T,{sampleRate:O}=P;if(this._baseLatency=typeof P.baseLatency=="number"?P.baseLatency:k==="balanced"?512/O:k==="interactive"||k===void 0?256/O:k==="playback"?1024/O:128*Math.max(2,Math.min(128,Math.round(k*O/128)))/O,this._nativeAudioContext=P,C.name==="webkitAudioContext"?(this._nativeGainNode=P.createGain(),this._nativeOscillatorNode=P.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(P.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,P.state==="running"){this._state="suspended";const N=()=>{this._state==="suspended"&&(this._state=null),P.removeEventListener("statechange",N)};P.addEventListener("statechange",N)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw t()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),Ze(this)}))}createMediaElementSource(T){return new d(this,{mediaElement:T})}createMediaStreamDestination(){return new g(this)}createMediaStreamSource(T){return new b(this,{mediaStream:T})}createMediaStreamTrackSource(T){return new _(this,{mediaStreamTrack:T})}resume(){return this._state==="suspended"?new Promise((T,P)=>{const k=()=>{this._nativeAudioContext.removeEventListener("statechange",k),this._nativeAudioContext.state==="running"?T():this.resume().then(T,P)};this._nativeAudioContext.addEventListener("statechange",k)}):this._nativeAudioContext.resume().catch(T=>{throw T===void 0||T.code===15?t():T})}suspend(){return this._nativeAudioContext.suspend().catch(T=>{throw T===void 0?t():T})}})(Au,De,Je,Ym,Zf,Qf,Jf,tg,Tn),hl=(p=>t=>{const o=p.get(t);if(o===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return o})(bu),sg=(p=>(t,o)=>{p(t).add(o)})(hl),Mu=(p=>(t,o,l=0,d=0)=>{const g=t[l];if(g===void 0)throw p();return fi(o)?g.connect(o,0,d):g.connect(o,0)})(Tt),ng=(p=>(t,o)=>{p(t).delete(o)})(hl),Eu=(p=>(t,o=void 0,l=void 0,d=0)=>o===void 0?t.forEach(g=>g.disconnect()):typeof o=="number"?Br(p,t,o).disconnect():fi(o)?l===void 0?t.forEach(g=>g.disconnect(o)):d===void 0?Br(p,t,l).disconnect(o,0):Br(p,t,l).disconnect(o,0,d):l===void 0?t.forEach(g=>g.disconnect(o)):Br(p,t,l).disconnect(o,0))(Tt),Pu=new WeakMap,ig=((p,t)=>o=>t(p,o))(Pu,K),og=((p,t,o,l,d,g,b,_,C,T,P,k,O)=>(N,$,q,L)=>{if(L.numberOfInputs===0&&L.numberOfOutputs===0)throw C();const W=Array.isArray(L.outputChannelCount)?L.outputChannelCount:Array.from(L.outputChannelCount);if(W.some(lt=>lt<1))throw C();if(W.length!==L.numberOfOutputs)throw t();if(L.channelCountMode!=="explicit")throw C();const z=L.channelCount*L.numberOfInputs,B=W.reduce((lt,Ht)=>lt+Ht,0),J=q.parameterDescriptors===void 0?0:q.parameterDescriptors.length;if(z+J>6||B>6)throw C();const st=new MessageChannel,j=[],Z=[];for(let lt=0;lt<L.numberOfInputs;lt+=1)j.push(b(N,{channelCount:L.channelCount,channelCountMode:L.channelCountMode,channelInterpretation:L.channelInterpretation,gain:1})),Z.push(d(N,{channelCount:L.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:L.channelCount}));const V=[];if(q.parameterDescriptors!==void 0)for(const{defaultValue:lt,maxValue:Ht,minValue:He,name:pe}of q.parameterDescriptors){const zt=g(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:L.parameterData[pe]!==void 0?L.parameterData[pe]:lt===void 0?0:lt});Object.defineProperties(zt.offset,{defaultValue:{get:()=>lt===void 0?0:lt},maxValue:{get:()=>Ht===void 0?Bt:Ht},minValue:{get:()=>He===void 0?jt:He}}),V.push(zt)}const nt=l(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,z+J)}),Y=Zh($,N.sampleRate),et=_(N,Y,z+J,Math.max(1,B)),ct=d(N,{channelCount:Math.max(1,B),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,B)}),ht=[];for(let lt=0;lt<L.numberOfOutputs;lt+=1)ht.push(l(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:W[lt]}));for(let lt=0;lt<L.numberOfInputs;lt+=1){j[lt].connect(Z[lt]);for(let Ht=0;Ht<L.channelCount;Ht+=1)Z[lt].connect(nt,Ht,lt*L.channelCount+Ht)}const Mt=new Nr(q.parameterDescriptors===void 0?[]:q.parameterDescriptors.map(({name:lt},Ht)=>{const He=V[Ht];return He.connect(nt,0,z+Ht),He.start(0),[lt,He.offset]}));nt.connect(et);let yt=L.channelInterpretation,vt=null;const Pt=L.numberOfOutputs===0?[et]:ht,gt={get bufferSize(){return Y},get channelCount(){return L.channelCount},set channelCount(lt){throw o()},get channelCountMode(){return L.channelCountMode},set channelCountMode(lt){throw o()},get channelInterpretation(){return yt},set channelInterpretation(lt){for(const Ht of j)Ht.channelInterpretation=lt;yt=lt},get context(){return et.context},get inputs(){return j},get numberOfInputs(){return L.numberOfInputs},get numberOfOutputs(){return L.numberOfOutputs},get onprocessorerror(){return vt},set onprocessorerror(lt){typeof vt=="function"&&gt.removeEventListener("processorerror",vt),vt=typeof lt=="function"?lt:null,typeof vt=="function"&&gt.addEventListener("processorerror",vt)},get parameters(){return Mt},get port(){return st.port2},addEventListener:(...lt)=>et.addEventListener(lt[0],lt[1],lt[2]),connect:p.bind(null,Pt),disconnect:T.bind(null,Pt),dispatchEvent:(...lt)=>et.dispatchEvent(lt[0]),removeEventListener:(...lt)=>et.removeEventListener(lt[0],lt[1],lt[2])},kt=new Map;var Lt,Vt;st.port1.addEventListener=(Lt=st.port1.addEventListener,(...lt)=>{if(lt[0]==="message"){const Ht=typeof lt[1]=="function"?lt[1]:typeof lt[1]=="object"&&lt[1]!==null&&typeof lt[1].handleEvent=="function"?lt[1].handleEvent:null;if(Ht!==null){const He=kt.get(lt[1]);He!==void 0?lt[1]=He:(lt[1]=pe=>{P(N.currentTime,N.sampleRate,()=>Ht(pe))},kt.set(Ht,lt[1]))}}return Lt.call(st.port1,lt[0],lt[1],lt[2])}),st.port1.removeEventListener=(Vt=st.port1.removeEventListener,(...lt)=>{if(lt[0]==="message"){const Ht=kt.get(lt[1]);Ht!==void 0&&(kt.delete(lt[1]),lt[1]=Ht)}return Vt.call(st.port1,lt[0],lt[1],lt[2])});let ae=null;Object.defineProperty(st.port1,"onmessage",{get:()=>ae,set:lt=>{typeof ae=="function"&&st.port1.removeEventListener("message",ae),ae=typeof lt=="function"?lt:null,typeof ae=="function"&&(st.port1.addEventListener("message",ae),st.port1.start())}}),q.prototype.port=st.port1;let ye=null;((lt,Ht,He,pe)=>{let zt=D.get(lt);zt===void 0&&(zt=new WeakMap,D.set(lt,zt));const le=(async(ls,Qs)=>{const Js=await(_c=>new Promise((xc,av)=>{const{port1:la,port2:Sc}=new MessageChannel;la.onmessage=({data:Cc})=>{la.close(),Sc.close(),xc(Cc)},la.onmessageerror=({data:Cc})=>{la.close(),Sc.close(),av(Cc)},Sc.postMessage(_c)}))(Qs);return new ls(Js)})(He,pe);return zt.set(Ht,le),le})(N,gt,q,L).then(lt=>ye=lt);const Ot=Fr(L.numberOfInputs,L.channelCount),mt=Fr(L.numberOfOutputs,W),se=q.parameterDescriptors===void 0?[]:q.parameterDescriptors.reduce((lt,{name:Ht})=>({...lt,[Ht]:new Float32Array(128)}),{});let Qt=!0;const Ve=()=>{L.numberOfOutputs>0&&et.disconnect(ct);for(let lt=0,Ht=0;lt<L.numberOfOutputs;lt+=1){const He=ht[lt];for(let pe=0;pe<W[lt];pe+=1)ct.disconnect(He,Ht+pe,pe);Ht+=W[lt]}},Ln=new Map;et.onaudioprocess=({inputBuffer:lt,outputBuffer:Ht})=>{if(ye!==null){const He=k(gt);for(let pe=0;pe<Y;pe+=128){for(let zt=0;zt<L.numberOfInputs;zt+=1)for(let le=0;le<L.channelCount;le+=1)Gn(lt,Ot[zt],le,le,pe);q.parameterDescriptors!==void 0&&q.parameterDescriptors.forEach(({name:zt},le)=>{Gn(lt,se,zt,z+le,pe)});for(let zt=0;zt<L.numberOfInputs;zt+=1)for(let le=0;le<W[zt];le+=1)mt[zt][le].byteLength===0&&(mt[zt][le]=new Float32Array(128));try{const zt=Ot.map((ls,Qs)=>{if(He[Qs].size>0)return Ln.set(Qs,Y/128),ls;const Js=Ln.get(Qs);return Js===void 0?[]:(ls.every(_c=>_c.every(xc=>xc===0))&&(Js===1?Ln.delete(Qs):Ln.set(Qs,Js-1)),ls)});Qt=P(N.currentTime+pe/N.sampleRate,N.sampleRate,()=>ye.process(zt,mt,se));for(let ls=0,Qs=0;ls<L.numberOfOutputs;ls+=1){for(let Js=0;Js<W[ls];Js+=1)gi(Ht,mt[ls],Js,Qs+Js,pe);Qs+=W[ls]}}catch(zt){Qt=!1,gt.dispatchEvent(new ErrorEvent("processorerror",{colno:zt.colno,filename:zt.filename,lineno:zt.lineno,message:zt.message}))}if(!Qt){for(let zt=0;zt<L.numberOfInputs;zt+=1){j[zt].disconnect(Z[zt]);for(let le=0;le<L.channelCount;le+=1)Z[pe].disconnect(nt,le,zt*L.channelCount+le)}if(q.parameterDescriptors!==void 0){const zt=q.parameterDescriptors.length;for(let le=0;le<zt;le+=1){const ls=V[le];ls.disconnect(nt,0,z+le),ls.stop()}}nt.disconnect(et),et.onaudioprocess=null,bc?Ve():id();break}}}};let bc=!1;const wc=b(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),nd=()=>et.connect(wc).connect(N.destination),id=()=>{et.disconnect(wc),wc.disconnect()};return nd(),O(gt,()=>{if(Qt){id(),L.numberOfOutputs>0&&et.connect(ct);for(let lt=0,Ht=0;lt<L.numberOfOutputs;lt+=1){const He=ht[lt];for(let pe=0;pe<W[lt];pe+=1)ct.connect(He,Ht+pe,pe);Ht+=W[lt]}}bc=!0},()=>{Qt&&(nd(),Ve()),bc=!1})})(Mu,Tt,De,Mn,wo,_i,os,_o,Je,Eu,cl,ig,An),rg=((p,t,o,l,d)=>(g,b,_,C,T,P)=>{if(_!==null)try{const N=new _(g,C,P),$=new Map;let q=null;if(Object.defineProperties(N,{channelCount:{get:()=>P.channelCount,set:()=>{throw p()}},channelCountMode:{get:()=>"explicit",set:()=>{throw p()}},onprocessorerror:{get:()=>q,set:L=>{typeof q=="function"&&N.removeEventListener("processorerror",q),q=typeof L=="function"?L:null,typeof q=="function"&&N.addEventListener("processorerror",q)}}}),N.addEventListener=(O=N.addEventListener,(...L)=>{if(L[0]==="processorerror"){const W=typeof L[1]=="function"?L[1]:typeof L[1]=="object"&&L[1]!==null&&typeof L[1].handleEvent=="function"?L[1].handleEvent:null;if(W!==null){const z=$.get(L[1]);z!==void 0?L[1]=z:(L[1]=B=>{B.type==="error"?(Object.defineProperties(B,{type:{value:"processorerror"}}),W(B)):W(new ErrorEvent(L[0],{...B}))},$.set(W,L[1]))}}return O.call(N,"error",L[1],L[2]),O.call(N,...L)}),N.removeEventListener=(k=N.removeEventListener,(...L)=>{if(L[0]==="processorerror"){const W=$.get(L[1]);W!==void 0&&($.delete(L[1]),L[1]=W)}return k.call(N,"error",L[1],L[2]),k.call(N,L[0],L[1],L[2])}),P.numberOfOutputs!==0){const L=o(g,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return N.connect(L).connect(g.destination),d(N,()=>L.disconnect(),()=>L.connect(g.destination))}return N}catch(N){throw N.code===11?l():N}var k,O;if(T===void 0)throw l();return(N=>{const{port1:$}=new MessageChannel;try{$.postMessage(N)}finally{$.close()}})(P),t(g,b,T,P)})(De,og,os,Je,An),ag=((p,t,o,l,d,g,b,_,C,T,P,k,O,N,$,q)=>(L,W,z)=>{const B=new WeakMap;let J=null;return{render(st,j){_(j,st);const Z=B.get(j);return Z!==void 0?Promise.resolve(Z):(async(V,nt)=>{let Y=P(V),et=null;const ct=rt(Y,nt),ht=Array.isArray(W.outputChannelCount)?W.outputChannelCount:Array.from(W.outputChannelCount);if(k===null){const Mt=ht.reduce((gt,kt)=>gt+kt,0),yt=d(nt,{channelCount:Math.max(1,Mt),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,Mt)}),vt=[];for(let gt=0;gt<V.numberOfOutputs;gt+=1)vt.push(l(nt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:ht[gt]}));const Pt=b(nt,{channelCount:W.channelCount,channelCountMode:W.channelCountMode,channelInterpretation:W.channelInterpretation,gain:1});Pt.connect=t.bind(null,vt),Pt.disconnect=C.bind(null,vt),et=[yt,vt,Pt]}else ct||(Y=new k(nt,L));if(B.set(nt,et===null?Y:et[2]),et!==null){if(J===null){if(z===void 0)throw new Error("Missing the processor constructor.");if(O===null)throw new Error("Missing the native OfflineAudioContext constructor.");const kt=V.channelCount*V.numberOfInputs,Lt=z.parameterDescriptors===void 0?0:z.parameterDescriptors.length,Vt=kt+Lt;J=Rm(V,Vt===0?null:await(async()=>{const ye=new O(Vt,128*Math.ceil(V.context.length/128),nt.sampleRate),as=[],Ot=[];for(let Qt=0;Qt<W.numberOfInputs;Qt+=1)as.push(b(ye,{channelCount:W.channelCount,channelCountMode:W.channelCountMode,channelInterpretation:W.channelInterpretation,gain:1})),Ot.push(d(ye,{channelCount:W.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:W.channelCount}));const mt=await Promise.all(Array.from(V.parameters.values()).map(async Qt=>{const Ve=g(ye,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Qt.value});return await N(ye,Qt,Ve.offset),Ve})),se=l(ye,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,kt+Lt)});for(let Qt=0;Qt<W.numberOfInputs;Qt+=1){as[Qt].connect(Ot[Qt]);for(let Ve=0;Ve<W.channelCount;Ve+=1)Ot[Qt].connect(se,Ve,Qt*W.channelCount+Ve)}for(const[Qt,Ve]of mt.entries())Ve.connect(se,0,kt+Qt),Ve.start(0);return se.connect(ye.destination),await Promise.all(as.map(Qt=>$(V,ye,Qt))),q(ye)})(),nt,W,ht,z,T)}const Mt=await J,yt=o(nt,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[vt,Pt,gt]=et;Mt!==null&&(yt.buffer=Mt,yt.start(0)),yt.connect(vt);for(let kt=0,Lt=0;kt<V.numberOfOutputs;kt+=1){const Vt=Pt[kt];for(let ae=0;ae<ht[kt];ae+=1)vt.connect(Vt,Lt+ae,ae);Lt+=ht[kt]}return gt}if(ct)for(const[Mt,yt]of V.parameters.entries())await p(nt,yt,Y.parameters.get(Mt));else for(const[Mt,yt]of V.parameters.entries())await N(nt,yt,Y.parameters.get(Mt));return await $(V,nt,Y),Y})(st,j)}}})(Xs,Mu,wi,Mn,wo,_i,os,ng,Eu,cl,te,bi,Oe,Us,Fe,Wr),lg=(p=>t=>p.get(t))(Tu),cg=(p=>(t,o)=>{p.set(t,o)})(Pu),ku=Cu?((p,t,o,l,d,g,b,_,C,T,P,k,O,N)=>class extends t{constructor($,q,L){var W;const z=_($),B=C(z),J=(et=>({...et,outputChannelCount:et.outputChannelCount!==void 0?et.outputChannelCount:et.numberOfInputs===1&&et.numberOfOutputs===1?[et.channelCount]:Array.from({length:et.numberOfOutputs},()=>1)}))({...Lr,...L});(et=>{const{port1:ct,port2:ht}=new MessageChannel;try{ct.postMessage(et)}finally{ct.close(),ht.close()}})(J);const st=R.get(z),j=st==null?void 0:st.get(q),Z=B||z.state!=="closed"?z:(W=b(z))!==null&&W!==void 0?W:z,V=d(Z,B?null:$.baseLatency,T,q,j,J);super($,!0,V,B?l(q,J,j):null);const nt=[];V.parameters.forEach((et,ct)=>{const ht=o(this,B,et);nt.push([ct,ht])}),this._nativeAudioWorkletNode=V,this._onprocessorerror=null,this._parameters=new Nr(nt),B&&p(z,this);const{activeInputs:Y}=g(this);k(V,Y)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror($){const q=typeof $=="function"?N(this,$):null;this._nativeAudioWorkletNode.onprocessorerror=q;const L=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=L!==null&&L===q?$:L}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(sg,be,Ls,ag,rg,qt,lg,ie,Kt,bi,0,cg,0,yi):void 0,hg=((p,t)=>(o,l,d)=>{if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(o,l,d)}catch(g){throw g.name==="SyntaxError"?p():g}})(Je,Oe),ug=((p,t,o,l,d,g,b,_)=>(C,T)=>o(C).render(C,T).then(()=>Promise.all(Array.from(l(T)).map(P=>o(P).render(P,T)))).then(()=>d(T)).then(P=>(typeof P.copyFromChannel!="function"?(b(P),dt(P)):t(g,()=>g(P))||_(P),p.add(P),P)))(ol,Ts,sl,hl,Wr,at,al,ll),dg=((p,t,o,l,d)=>class extends p{constructor(g,b,_){let C;if(typeof g=="number"&&b!==void 0&&_!==void 0)C={length:b,numberOfChannels:g,sampleRate:_};else{if(typeof g!="object")throw new Error("The given parameters are not valid.");C=g}const{length:T,numberOfChannels:P,sampleRate:k}={...Hm,...C},O=l(P,T,k);t(bo,()=>bo(O))||O.addEventListener("statechange",(()=>{let N=0;const $=q=>{this._state==="running"&&(N>0?(O.removeEventListener("statechange",$),q.stopImmediatePropagation(),this._waitForThePromiseToSettle(q)):N+=1)};return $})()),super(O,P),this._length=T,this._nativeOfflineAudioContext=O,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(o()):(this._state="running",d(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,Ze(this)}))}_waitForThePromiseToSettle(g){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(g):setTimeout(()=>this._waitForThePromiseToSettle(g))}})(Au,Ts,De,hg,ug),pg=((p,t)=>o=>{const l=p.get(o);return t(l)||t(o)})(E,nl),mg=((p,t)=>o=>p.has(o)||t(o))(w,il),fg=((p,t)=>o=>p.has(o)||t(o))(A,hu),gg=((p,t)=>o=>{const l=p.get(o);return t(l)||t(o)})(E,Kt),vg=()=>(async(p,t,o,l,d,g,b,_,C,T,P,k,O,N,$,q)=>!!(p(t,t)&&p(o,o)&&p(d,d)&&p(g,g)&&p(_,_)&&p(C,C)&&p(T,T)&&p(P,P)&&p(k,k)&&p(O,O)&&p(N,N))&&(await Promise.all([p(l,l),p(b,b),p($,$),p(q,q)])).every(L=>L))(Ts,(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createBuffer(1,1,44100);if(t.copyToChannel===void 0)return!0;const o=new Float32Array(2);try{t.copyFromChannel(o,0,0)}catch{return!1}return!0})(Oe),(p=>()=>{if(p===null)return!1;if(p.prototype!==void 0&&p.prototype.close!==void 0)return!0;const t=new p,o=t.close!==void 0;try{t.close()}catch{}return o})(Tn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);return new Promise(o=>{let l=!0;const d=b=>{l&&(l=!1,t.startRendering(),o(b instanceof TypeError))};let g;try{g=t.decodeAudioData(null,()=>{},d)}catch(b){d(b)}g!==void 0&&g.catch(d)})})(Oe),(p=>()=>{if(p===null)return!1;let t;try{t=new p({latencyHint:"balanced"})}catch{return!1}return t.close(),!0})(Tn),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createGain(),o=t.connect(t)===t;return t.disconnect(t),o})(Oe),((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const o=new Blob(['let c,p;class A extends AudioWorkletProcessor{constructor(){super();this.port.onmessage=(e)=>{p=e.data;p.onmessage=()=>{p.postMessage(c);p.close()};this.port.postMessage(0)}}process(){c=1}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new MessageChannel,d=new t(1,128,44100),g=URL.createObjectURL(o);let b=!1;try{await d.audioWorklet.addModule(g);const _=new p(d,"a",{numberOfOutputs:0}),C=d.createOscillator();await new Promise(T=>{_.port.onmessage=()=>T(),_.port.postMessage(l.port2,[l.port2])}),_.port.onmessage=()=>b=!0,C.connect(_),C.start(0),await d.startRendering(),b=await new Promise(T=>{l.port1.onmessage=({data:P})=>T(P===1),l.port1.postMessage(0)})}catch{}finally{l.port1.close(),URL.revokeObjectURL(g)}return b})(bi,Oe),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createChannelMerger();if(t.channelCountMode==="max")return!0;try{t.channelCount=2}catch{return!0}return!1})(Oe),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100);return t.createConstantSource===void 0||t.createConstantSource().offset.maxValue!==Number.POSITIVE_INFINITY})(Oe),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100),o=t.createConvolver();o.buffer=t.createBuffer(1,1,t.sampleRate);try{o.buffer=t.createBuffer(1,1,t.sampleRate)}catch{return!1}return!0})(Oe),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createConvolver();try{t.channelCount=1}catch{return!1}return!0})(Oe),Qm,(p=>()=>p!==null&&p.hasOwnProperty("isSecureContext"))(Ns),(p=>()=>{if(p===null)return!1;const t=new p;try{return t.createMediaStreamSource(new MediaStream),!1}catch{return!0}finally{t.close()}})(Tn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);if(t.createStereoPanner===void 0||t.createConstantSource===void 0)return Promise.resolve(!0);const o=t.createConstantSource(),l=t.createStereoPanner();return o.channelCount=1,o.offset.value=1,l.channelCount=1,o.start(),o.connect(l).connect(t.destination),t.startRendering().then(d=>d.getChannelData(0)[0]!==1)})(Oe),Jm);function rs(p){return p===void 0}function It(p){return p!==void 0}function Iu(p){return typeof p=="function"}function ds(p){return typeof p=="number"}function cn(p){return Object.prototype.toString.call(p)==="[object Object]"&&p.constructor===Object}function ul(p){return typeof p=="boolean"}function Be(p){return Array.isArray(p)}function Fs(p){return typeof p=="string"}function Co(p){return Fs(p)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(p)}function wt(p,t){if(!p)throw new Error(t)}function qe(p,t,o=1/0){if(!(t<=p&&p<=o))throw new RangeError(`Value must be within [${t}, ${o}], got: ${p}`)}function dl(p){p.isOffline||p.state==="running"||xi('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Ru=!1,Du=!1;function pl(p){Ru=p}function Ou(p){rs(p)&&Ru&&!Du&&(Du=!0,xi("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let ml=console;function yg(p){ml=p}function Nu(...p){ml.log(...p)}function xi(...p){ml.warn(...p)}const ps=typeof self=="object"?self:null,bg=ps&&(ps.hasOwnProperty("AudioContext")||ps.hasOwnProperty("webkitAudioContext"));function Bs(p,t,o,l){var d,g=arguments.length,b=g<3?t:l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")b=Reflect.decorate(p,t,o,l);else for(var _=p.length-1;_>=0;_--)(d=p[_])&&(b=(g<3?d(b):g>3?d(t,o,b):d(t,o))||b);return g>3&&b&&Object.defineProperty(t,o,b),b}function ee(p,t,o,l){return new(o||(o=Promise))(function(d,g){function b(T){try{C(l.next(T))}catch(P){g(P)}}function _(T){try{C(l.throw(T))}catch(P){g(P)}}function C(T){var P;T.done?d(T.value):(P=T.value,P instanceof o?P:new o(function(k){k(P)})).then(b,_)}C((l=l.apply(p,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;class wg{constructor(t,o,l,d){this._callback=t,this._type=o,this._minimumUpdateInterval=Math.max(128/(d||44100),.001),this.updateInterval=l,this._createClock()}_createWorker(){const t=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),o=URL.createObjectURL(t),l=new Worker(o);l.onmessage=this._callback.bind(this),this._worker=l}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},1e3*this._updateInterval)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(t){var o;this._updateInterval=Math.max(t,this._minimumUpdateInterval),this._type==="worker"&&((o=this._worker)===null||o===void 0||o.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(t){this._disposeClock(),this._type=t,this._createClock()}dispose(){this._disposeClock()}}function Xn(p){return fg(p)}function En(p){return mg(p)}function Hr(p){return gg(p)}function Si(p){return pg(p)}function _g(p,t){return p==="value"||Xn(t)||En(t)||function(o){return o instanceof mu}(t)}function As(p,...t){if(!t.length)return p;const o=t.shift();if(cn(p)&&cn(o))for(const l in o)_g(l,o[l])?p[l]=o[l]:cn(o[l])?(p[l]||Object.assign(p,{[l]:{}}),As(p[l],o[l])):Object.assign(p,{[l]:o[l]});return As(p,...t)}function tt(p,t,o=[],l){const d={},g=Array.from(t);if(cn(g[0])&&l&&!Reflect.has(g[0],l)&&(Object.keys(g[0]).some(b=>Reflect.has(p,b))||(As(d,{[l]:g[0]}),o.splice(o.indexOf(l),1),g.shift())),g.length===1&&cn(g[0]))As(d,g[0]);else for(let b=0;b<o.length;b++)It(g[b])&&(d[o[b]]=g[b]);return As(p,d)}function Ms(p,t){return rs(p)?t:p}function $e(p,t){return t.forEach(o=>{Reflect.has(p,o)&&delete p[o]}),p}class hn{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...t){(this.debug||ps&&this.toString()===ps.TONE_DEBUG_CLASS)&&Nu(this,...t)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}hn.version=m;const fl=1e-6;function Ci(p,t){return p>t+fl}function gl(p,t){return Ci(p,t)||qs(p,t)}function Gr(p,t){return p+fl<t}function qs(p,t){return Math.abs(p-t)<fl}function Un(p,t,o){return Math.max(Math.min(p,o),t)}class ms extends hn{constructor(){super(),this.name="Timeline",this._timeline=[];const t=tt(ms.getDefaults(),arguments,["memory"]);this.memory=t.memory,this.increasing=t.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(t){if(wt(Reflect.has(t,"time"),"Timeline: events must have a time attribute"),t.time=t.time.valueOf(),this.increasing&&this.length){const o=this._timeline[this.length-1];wt(gl(t.time,o.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(t)}else{const o=this._search(t.time);this._timeline.splice(o+1,0,t)}if(this.length>this.memory){const o=this.length-this.memory;this._timeline.splice(0,o)}return this}remove(t){const o=this._timeline.indexOf(t);return o!==-1&&this._timeline.splice(o,1),this}get(t,o="time"){const l=this._search(t,o);return l!==-1?this._timeline[l]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(t,o="time"){const l=this._search(t,o);return l+1<this._timeline.length?this._timeline[l+1]:null}getBefore(t){const o=this._timeline.length;if(o>0&&this._timeline[o-1].time<t)return this._timeline[o-1];const l=this._search(t);return l-1>=0?this._timeline[l-1]:null}cancel(t){if(this._timeline.length>1){let o=this._search(t);if(o>=0)if(qs(this._timeline[o].time,t)){for(let l=o;l>=0&&qs(this._timeline[l].time,t);l--)o=l;this._timeline=this._timeline.slice(0,o)}else this._timeline=this._timeline.slice(0,o+1);else this._timeline=[]}else this._timeline.length===1&&gl(this._timeline[0].time,t)&&(this._timeline=[]);return this}cancelBefore(t){const o=this._search(t);return o>=0&&(this._timeline=this._timeline.slice(o+1)),this}previousEvent(t){const o=this._timeline.indexOf(t);return o>0?this._timeline[o-1]:null}_search(t,o="time"){if(this._timeline.length===0)return-1;let l=0;const d=this._timeline.length;let g=d;if(d>0&&this._timeline[d-1][o]<=t)return d-1;for(;l<g;){let b=Math.floor(l+(g-l)/2);const _=this._timeline[b],C=this._timeline[b+1];if(qs(_[o],t)){for(let T=b;T<this._timeline.length&&qs(this._timeline[T][o],t);T++)b=T;return b}if(Gr(_[o],t)&&Ci(C[o],t))return b;Ci(_[o],t)?g=b:l=b+1}return-1}_iterate(t,o=0,l=this._timeline.length-1){this._timeline.slice(o,l+1).forEach(t)}forEach(t){return this._iterate(t),this}forEachBefore(t,o){const l=this._search(t);return l!==-1&&this._iterate(o,0,l),this}forEachAfter(t,o){const l=this._search(t);return this._iterate(o,l+1),this}forEachBetween(t,o,l){let d=this._search(t),g=this._search(o);return d!==-1&&g!==-1?(this._timeline[d].time!==t&&(d+=1),this._timeline[g].time===o&&(g-=1),this._iterate(l,d,g)):d===-1&&this._iterate(l,0,g),this}forEachFrom(t,o){let l=this._search(t);for(;l>=0&&this._timeline[l].time>=t;)l--;return this._iterate(o,l+1),this}forEachAtTime(t,o){const l=this._search(t);if(l!==-1&&qs(this._timeline[l].time,t)){let d=l;for(let g=l;g>=0&&qs(this._timeline[g].time,t);g--)d=g;this._iterate(g=>{o(g)},d,l)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Lu=[];function jr(p){Lu.push(p)}const Fu=[];function Xr(p){Fu.push(p)}class Ti extends hn{constructor(){super(...arguments),this.name="Emitter"}on(t,o){return t.split(/\W+/).forEach(l=>{rs(this._events)&&(this._events={}),this._events.hasOwnProperty(l)||(this._events[l]=[]),this._events[l].push(o)}),this}once(t,o){const l=(...d)=>{o(...d),this.off(t,l)};return this.on(t,l),this}off(t,o){return t.split(/\W+/).forEach(l=>{if(rs(this._events)&&(this._events={}),this._events.hasOwnProperty(l))if(rs(o))this._events[l]=[];else{const d=this._events[l];for(let g=d.length-1;g>=0;g--)d[g]===o&&d.splice(g,1)}}),this}emit(t,...o){if(this._events&&this._events.hasOwnProperty(t)){const l=this._events[t].slice(0);for(let d=0,g=l.length;d<g;d++)l[d].apply(this,o)}return this}static mixin(t){["on","once","off","emit"].forEach(o=>{const l=Object.getOwnPropertyDescriptor(Ti.prototype,o);Object.defineProperty(t.prototype,o,l)})}dispose(){return super.dispose(),this._events=void 0,this}}class vl extends Ti{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class Ai extends vl{constructor(){var t,o;super(),this.name="Context",this._constants=new Map,this._timeouts=new ms,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const l=tt(Ai.getDefaults(),arguments,["context"]);l.context?(this._context=l.context,this._latencyHint=((t=arguments[0])===null||t===void 0?void 0:t.latencyHint)||""):(this._context=function(d){return new eg(d)}({latencyHint:l.latencyHint}),this._latencyHint=l.latencyHint),this._ticker=new wg(this.emit.bind(this,"tick"),l.clockSource,l.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((o=arguments[0])===null||o===void 0)&&o.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=l.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var t;return this._initialized||(t=this,Lu.forEach(o=>o(t)),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(t,o,l){return this._context.createBuffer(t,o,l)}createChannelMerger(t){return this._context.createChannelMerger(t)}createChannelSplitter(t){return this._context.createChannelSplitter(t)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(t){return this._context.createDelay(t)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(t,o){return this._context.createIIRFilter(t,o)}createPanner(){return this._context.createPanner()}createPeriodicWave(t,o,l){return this._context.createPeriodicWave(t,o,l)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(t){return wt(Si(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(t)}createMediaElementSource(t){return wt(Si(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(t)}createMediaStreamDestination(){return wt(Si(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(t){return this._context.decodeAudioData(t)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(t){wt(!this._initialized,"The listener cannot be set after initialization."),this._listener=t}get transport(){return this.initialize(),this._transport}set transport(t){wt(!this._initialized,"The transport cannot be set after initialization."),this._transport=t}get draw(){return this.initialize(),this._draw}set draw(t){wt(!this._initialized,"Draw cannot be set after initialization."),this._draw=t}get destination(){return this.initialize(),this._destination}set destination(t){wt(!this._initialized,"The destination cannot be set after initialization."),this._destination=t}createAudioWorkletNode(t,o){return function(l,d,g){return wt(It(ku),"AudioWorkletNode only works in a secure context (https or localhost)"),new(l instanceof(ps==null?void 0:ps.BaseAudioContext)?ps==null?void 0:ps.AudioWorkletNode:ku)(l,d,g)}(this.rawContext,t,o)}addAudioWorkletModule(t){return ee(this,void 0,void 0,function*(){wt(It(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(t)),yield this._workletPromise})}workletsAreReady(){return ee(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(t){this._ticker.updateInterval=t}get clockSource(){return this._ticker.type}set clockSource(t){this._ticker.type=t}get lookAhead(){return this._lookAhead}set lookAhead(t){this._lookAhead=t,this.updateInterval=t?t/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return Si(this._context)?this._context.resume():Promise.resolve()}close(){return ee(this,void 0,void 0,function*(){var t;Si(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(t=this,Fu.forEach(o=>o(t)))})}getConstant(t){if(this._constants.has(t))return this._constants.get(t);{const o=this._context.createBuffer(1,128,this._context.sampleRate),l=o.getChannelData(0);for(let g=0;g<l.length;g++)l[g]=t;const d=this._context.createBufferSource();return d.channelCount=1,d.channelCountMode="explicit",d.buffer=o,d.loop=!0,d.start(0),this._constants.set(t,d),d}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(t=>this._constants[t].disconnect()),this.close(),this}_timeoutLoop(){const t=this.now();let o=this._timeouts.peek();for(;this._timeouts.length&&o&&o.time<=t;)o.callback(),this._timeouts.shift(),o=this._timeouts.peek()}setTimeout(t,o){this._timeoutIds++;const l=this.now();return this._timeouts.add({callback:t,id:this._timeoutIds,time:l+o}),this._timeoutIds}clearTimeout(t){return this._timeouts.forEach(o=>{o.id===t&&this._timeouts.remove(o)}),this}clearInterval(t){return this.clearTimeout(t)}setInterval(t,o){const l=++this._timeoutIds,d=()=>{const g=this.now();this._timeouts.add({callback:()=>{t(),d()},id:l,time:g+o})};return d(),l}}function Ct(p,t){Be(t)?t.forEach(o=>Ct(p,o)):Object.defineProperty(p,t,{enumerable:!0,writable:!1})}function To(p,t){Be(t)?t.forEach(o=>To(p,o)):Object.defineProperty(p,t,{writable:!0})}const Dt=()=>{};class $t extends hn{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Dt;const t=tt($t.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=t.reverse,this.onload=t.onload,Fs(t.url)?this.load(t.url).catch(t.onerror):t.url&&this.set(t.url)}static getDefaults(){return{onerror:Dt,onload:Dt,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:re().sampleRate}set(t){return t instanceof $t?t.loaded?this._buffer=t.get():t.onload=()=>{this.set(t),this.onload(this)}:this._buffer=t,this._reversed&&this._reverse(),this}get(){return this._buffer}load(t){return ee(this,void 0,void 0,function*(){const o=$t.load(t).then(l=>{this.set(l),this.onload(this)});$t.downloads.push(o);try{yield o}finally{const l=$t.downloads.indexOf(o);$t.downloads.splice(l,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(t){const o=Be(t)&&t[0].length>0,l=o?t.length:1,d=o?t[0].length:t.length,g=re(),b=g.createBuffer(l,d,g.sampleRate),_=o||l!==1?t:[t];for(let C=0;C<l;C++)b.copyToChannel(_[C],C);return this._buffer=b,this}toMono(t){if(ds(t))this.fromArray(this.toArray(t));else{let o=new Float32Array(this.length);const l=this.numberOfChannels;for(let d=0;d<l;d++){const g=this.toArray(d);for(let b=0;b<g.length;b++)o[b]+=g[b]}o=o.map(d=>d/l),this.fromArray(o)}return this}toArray(t){if(ds(t))return this.getChannelData(t);if(this.numberOfChannels===1)return this.toArray(0);{const o=[];for(let l=0;l<this.numberOfChannels;l++)o[l]=this.getChannelData(l);return o}}getChannelData(t){return this._buffer?this._buffer.getChannelData(t):new Float32Array(0)}slice(t,o=this.duration){wt(this.loaded,"Buffer is not loaded");const l=Math.floor(t*this.sampleRate),d=Math.floor(o*this.sampleRate);wt(l<d,"The start time must be less than the end time");const g=d-l,b=re().createBuffer(this.numberOfChannels,g,this.sampleRate);for(let _=0;_<this.numberOfChannels;_++)b.copyToChannel(this.getChannelData(_).subarray(l,d),_);return new $t(b)}_reverse(){if(this.loaded)for(let t=0;t<this.numberOfChannels;t++)this.getChannelData(t).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(t){this._reversed!==t&&(this._reversed=t,this._reverse())}static fromArray(t){return new $t().fromArray(t)}static fromUrl(t){return ee(this,void 0,void 0,function*(){return yield new $t().load(t)})}static load(t){return ee(this,void 0,void 0,function*(){const o=t.match(/\[([^\]\[]+\|.+)\]$/);if(o){const _=o[1].split("|");let C=_[0];for(const T of _)if($t.supportsType(T)){C=T;break}t=t.replace(o[0],C)}const l=$t.baseUrl===""||$t.baseUrl.endsWith("/")?$t.baseUrl:$t.baseUrl+"/",d=document.createElement("a");d.href=l+t,d.pathname=(d.pathname+d.hash).split("/").map(encodeURIComponent).join("/");const g=yield fetch(d.href);if(!g.ok)throw new Error(`could not load url: ${t}`);const b=yield g.arrayBuffer();return yield re().decodeAudioData(b)})}static supportsType(t){const o=t.split("."),l=o[o.length-1];return document.createElement("audio").canPlayType("audio/"+l)!==""}static loaded(){return ee(this,void 0,void 0,function*(){for(yield Promise.resolve();$t.downloads.length;)yield $t.downloads[0]})}}$t.baseUrl="",$t.downloads=[];class Mi extends Ai{constructor(){var t,o,l;super({clockSource:"offline",context:Hr(arguments[0])?arguments[0]:(t=arguments[0],o=arguments[1]*arguments[2],l=arguments[2],new dg(t,o,l)),lookAhead:0,updateInterval:Hr(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Hr(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(t){return ee(this,void 0,void 0,function*(){let o=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,o++;const l=Math.floor(this.sampleRate/128);t&&o%l==0&&(yield new Promise(d=>setTimeout(d,1)))}})}render(){return ee(this,arguments,void 0,function*(t=!0){yield this.workletsAreReady(),yield this._renderClock(t);const o=yield this._context.startRendering();return new $t(o)})}close(){return Promise.resolve()}}const Bu=new class extends vl{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(p,t,o){return{}}createChannelMerger(p){return{}}createChannelSplitter(p){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(p){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(p,t){return{}}createPanner(){return{}}createPeriodicWave(p,t,o){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(p){return{}}createMediaElementSource(p){return{}}createMediaStreamDestination(){return{}}decodeAudioData(p){return Promise.resolve({})}createAudioWorkletNode(p,t){return{}}get rawContext(){return{}}addAudioWorkletModule(p){return ee(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(p,t){return 0}clearTimeout(p){return this}setInterval(p,t){return 0}clearInterval(p){return this}getConstant(p){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(p){}get destination(){return{}}set destination(p){}now(){return 0}immediate(){return 0}};let Ao=Bu;function re(){return Ao===Bu&&bg&&Ur(new Ai),Ao}function Ur(p,t=!1){t&&Ao.dispose(),Ao=Si(p)?new Ai(p):Hr(p)?new Mi(p):p}function xg(){return Ao.resume()}if(ps&&!ps.TONE_SILENCE_LOGGING){const t=` * Tone.js v${m} * `;console.log(`%c${t}`,"background: #000; color: #fff")}function Ei(p){return Math.pow(10,p/20)}function Mo(p){return Math.log(p)/Math.LN10*20}function Pi(p){return Math.pow(2,p/12)}let Yr=440;function Pn(p){return Math.round(qu(p))}function qu(p){return 69+12*Math.log2(p/Yr)}function yl(p){return Yr*Math.pow(2,(p-69)/12)}class bl extends hn{constructor(t,o,l){super(),this.defaultUnits="s",this._val=o,this._units=l,this.context=t,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:t=>this._frequencyToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:t=>this._ticksToUnits(parseInt(t,10)),regexp:/^(\d+)i$/i},m:{method:t=>this._beatsToUnits(parseInt(t,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(t,o)=>{const l=parseInt(t,10),d=o==="."?1.5:1;return l===1?this._beatsToUnits(this._getTimeSignature())*d:this._beatsToUnits(4/l)*d},regexp:/^(\d+)n(\.?)$/i},number:{method:t=>this._expressions[this.defaultUnits].method.call(this,t),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:t=>this._secondsToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:t=>parseInt(t,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:t=>{const o=parseInt(t,10);return this._beatsToUnits(8/(3*Math.floor(o)))},regexp:/^(\d+)t$/i},tr:{method:(t,o,l)=>{let d=0;return t&&t!=="0"&&(d+=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),o&&o!=="0"&&(d+=this._beatsToUnits(parseFloat(o))),l&&l!=="0"&&(d+=this._beatsToUnits(parseFloat(l)/4)),d},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof bl&&this.fromType(this._val),rs(this._val))return this._noArg();if(Fs(this._val)&&rs(this._units)){for(const t in this._expressions)if(this._expressions[t].regexp.test(this._val.trim())){this._units=t;break}}else if(cn(this._val)){let t=0;for(const o in this._val)if(It(this._val[o])){const l=this._val[o];t+=new this.constructor(this.context,o).valueOf()*l}return t}if(It(this._units)){const t=this._expressions[this._units],o=this._val.toString().trim().match(t.regexp);return o?t.method.apply(this,o.slice(1)):t.method.call(this,this._val)}return Fs(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(t){return 1/t}_beatsToUnits(t){return 60/this._getBpm()*t}_secondsToUnits(t){return t}_ticksToUnits(t){return t*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(t){switch(this._units=void 0,this.defaultUnits){case"s":this._val=t.toSeconds();break;case"i":this._val=t.toTicks();break;case"hz":this._val=t.toFrequency();break;case"midi":this._val=t.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class fs extends bl{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:t=>this._now()+new this.constructor(this.context,t).valueOf(),regexp:/^\+(.+)/},quantize:{method:t=>{const o=new fs(this.context,t).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(o))},regexp:/^@(.+)/}})}quantize(t,o=1){const l=new this.constructor(this.context,t).valueOf(),d=this.valueOf();return d+(Math.round(d/l)*l-d)*o}toNotation(){const t=this.toSeconds(),o=["1m"];for(let g=1;g<9;g++){const b=Math.pow(2,g);o.push(b+"n."),o.push(b+"n"),o.push(b+"t")}o.push("0");let l=o[0],d=new fs(this.context,o[0]).toSeconds();return o.forEach(g=>{const b=new fs(this.context,g).toSeconds();Math.abs(b-t)<Math.abs(d-t)&&(l=g,d=b)}),l}toBarsBeatsSixteenths(){const t=this._beatsToUnits(1);let o=this.valueOf()/t;o=parseFloat(o.toFixed(4));const l=Math.floor(o/this._getTimeSignature());let d=o%1*4;o=Math.floor(o)%this._getTimeSignature();const g=d.toString();return g.length>3&&(d=parseFloat(parseFloat(g).toFixed(3))),[l,o,d].join(":")}toTicks(){const t=this._beatsToUnits(1);return this.valueOf()/t*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return Pn(this.toFrequency())}_now(){return this.context.now()}}function Sg(p,t){return new fs(re(),p,t)}class Ke extends fs{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Yr}static set A4(t){(function(o){Yr=o})(t)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(t){return this.defaultUnits==="midi"?t:Ke.mtof(t)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(t,o){const l=Cg[t.toLowerCase()]+12*(parseInt(o,10)+1);return this.defaultUnits==="midi"?l:Ke.mtof(l)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(t,o,l){let d=1;return t&&t!=="0"&&(d*=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),o&&o!=="0"&&(d*=this._beatsToUnits(parseFloat(o))),l&&l!=="0"&&(d*=this._beatsToUnits(parseFloat(l)/4)),d}}})}transpose(t){return new Ke(this.context,this.valueOf()*Pi(t))}harmonize(t){return t.map(o=>this.transpose(o))}toMidi(){return Pn(this.valueOf())}toNote(){const t=this.toFrequency(),o=Math.log2(t/Ke.A4);let l=Math.round(12*o)+57;const d=Math.floor(l/12);return d<0&&(l+=-12*d),Tg[l%12]+d.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const t=this._beatsToUnits(1),o=this.valueOf()/t;return Math.floor(o*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(t){return t}_ticksToUnits(t){return 1/(60*t/(this._getBpm()*this._getPPQ()))}_beatsToUnits(t){return 1/super._beatsToUnits(t)}_secondsToUnits(t){return 1/t}static mtof(t){return yl(t)}static ftom(t){return Pn(t)}}const Cg={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},Tg=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function Ag(p,t){return new Ke(re(),p,t)}class Se extends fs{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}function Mg(p,t){return new Se(re(),p,t)}class Ne extends hn{constructor(){super();const t=tt(Ne.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=t.context}static getDefaults(){return{context:re()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(t){return Ou(t),new fs(this.context,t).toSeconds()}toFrequency(t){return new Ke(this.context,t).toFrequency()}toTicks(t){return new Se(this.context,t).toTicks()}_getPartialProperties(t){const o=this.get();return Object.keys(o).forEach(l=>{rs(t[l])&&delete o[l]}),o}get(){const t=this.constructor.getDefaults();return Object.keys(t).forEach(o=>{if(Reflect.has(this,o)){const l=this[o];It(l)&&It(l.value)&&It(l.setValueAtTime)?t[o]=l.value:l instanceof Ne?t[o]=l._getPartialProperties(t[o]):Be(l)||ds(l)||Fs(l)||ul(l)?t[o]=l:delete t[o]}}),t}set(t){return Object.keys(t).forEach(o=>{Reflect.has(this,o)&&It(this[o])&&(this[o]&&It(this[o].value)&&It(this[o].setValueAtTime)?this[o].value!==t[o]&&(this[o].value=t[o]):this[o]instanceof Ne?this[o].set(t[o]):this[o]=t[o])}),this}}class ki extends ms{constructor(t="stopped"){super(),this.name="StateTimeline",this._initial=t,this.setStateAtTime(this._initial,0)}getValueAtTime(t){const o=this.get(t);return o!==null?o.state:this._initial}setStateAtTime(t,o,l){return qe(o,0),this.add(Object.assign({},l,{state:t,time:o})),this}getLastState(t,o){for(let l=this._search(o);l>=0;l--){const d=this._timeline[l];if(d.state===t)return d}}getNextState(t,o){const l=this._search(o);if(l!==-1)for(let d=l;d<this._timeline.length;d++){const g=this._timeline[d];if(g.state===t)return g}}}class Et extends Ne{constructor(){const t=tt(Et.getDefaults(),arguments,["param","units","convert"]);for(super(t),this.name="Param",this.overridden=!1,this._minOutput=1e-7,wt(It(t.param)&&(Xn(t.param)||t.param instanceof Et),"param must be an AudioParam");!Xn(t.param);)t.param=t.param._param;this._swappable=!!It(t.swappable)&&t.swappable,this._swappable?(this.input=this.context.createGain(),this._param=t.param,this.input.connect(this._param)):this._param=this.input=t.param,this._events=new ms(1e3),this._initialValue=this._param.defaultValue,this.units=t.units,this.convert=t.convert,this._minValue=t.minValue,this._maxValue=t.maxValue,It(t.value)&&t.value!==this._toType(this._initialValue)&&this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Ne.getDefaults(),{convert:!0,units:"number"})}get value(){const t=this.now();return this.getValueAtTime(t)}set value(t){this.cancelScheduledValues(this.now()),this.setValueAtTime(t,this.now())}get minValue(){return It(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return It(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(t,o){return this.units===o}_assertRange(t){return It(this.maxValue)&&It(this.minValue)&&qe(t,this._fromType(this.minValue),this._fromType(this.maxValue)),t}_fromType(t){return this.convert&&!this.overridden?this._is(t,"time")?this.toSeconds(t):this._is(t,"decibels")?Ei(t):this._is(t,"frequency")?this.toFrequency(t):t:this.overridden?0:t}_toType(t){return this.convert&&this.units==="decibels"?Mo(t):t}setValueAtTime(t,o){const l=this.toSeconds(o),d=this._fromType(t);return wt(isFinite(d)&&isFinite(l),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._assertRange(d),this.log(this.units,"setValueAtTime",t,l),this._events.add({time:l,type:"setValueAtTime",value:d}),this._param.setValueAtTime(d,l),this}getValueAtTime(t){const o=Math.max(this.toSeconds(t),0),l=this._events.getAfter(o),d=this._events.get(o);let g=this._initialValue;if(d===null)g=this._initialValue;else if(d.type!=="setTargetAtTime"||l!==null&&l.type!=="setValueAtTime")if(l===null)g=d.value;else if(l.type==="linearRampToValueAtTime"||l.type==="exponentialRampToValueAtTime"){let b=d.value;if(d.type==="setTargetAtTime"){const _=this._events.getBefore(d.time);b=_===null?this._initialValue:_.value}g=l.type==="linearRampToValueAtTime"?this._linearInterpolate(d.time,b,l.time,l.value,o):this._exponentialInterpolate(d.time,b,l.time,l.value,o)}else g=d.value;else{const b=this._events.getBefore(d.time);let _;_=b===null?this._initialValue:b.value,d.type==="setTargetAtTime"&&(g=this._exponentialApproach(d.time,_,d.value,d.constant,o))}return this._toType(g)}setRampPoint(t){t=this.toSeconds(t);let o=this.getValueAtTime(t);return this.cancelAndHoldAtTime(t),this._fromType(o)===0&&(o=this._toType(this._minOutput)),this.setValueAtTime(o,t),this}linearRampToValueAtTime(t,o){const l=this._fromType(t),d=this.toSeconds(o);return wt(isFinite(l)&&isFinite(d),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._assertRange(l),this._events.add({time:d,type:"linearRampToValueAtTime",value:l}),this.log(this.units,"linearRampToValueAtTime",t,d),this._param.linearRampToValueAtTime(l,d),this}exponentialRampToValueAtTime(t,o){let l=this._fromType(t);l=qs(l,0)?this._minOutput:l,this._assertRange(l);const d=this.toSeconds(o);return wt(isFinite(l)&&isFinite(d),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._events.add({time:d,type:"exponentialRampToValueAtTime",value:l}),this.log(this.units,"exponentialRampToValueAtTime",t,d),this._param.exponentialRampToValueAtTime(l,d),this}exponentialRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialRampToValueAtTime(t,l+this.toSeconds(o)),this}linearRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.linearRampToValueAtTime(t,l+this.toSeconds(o)),this}targetRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialApproachValueAtTime(t,l,o),this}exponentialApproachValueAtTime(t,o,l){o=this.toSeconds(o),l=this.toSeconds(l);const d=Math.log(l+1)/Math.log(200);return this.setTargetAtTime(t,o,d),this.cancelAndHoldAtTime(o+.9*l),this.linearRampToValueAtTime(t,o+l),this}setTargetAtTime(t,o,l){const d=this._fromType(t);wt(isFinite(l)&&l>0,"timeConstant must be a number greater than 0");const g=this.toSeconds(o);return this._assertRange(d),wt(isFinite(d)&&isFinite(g),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._events.add({constant:l,time:g,type:"setTargetAtTime",value:d}),this.log(this.units,"setTargetAtTime",t,g,l),this._param.setTargetAtTime(d,g,l),this}setValueCurveAtTime(t,o,l,d=1){l=this.toSeconds(l),o=this.toSeconds(o);const g=this._fromType(t[0])*d;this.setValueAtTime(this._toType(g),o);const b=l/(t.length-1);for(let _=1;_<t.length;_++){const C=this._fromType(t[_])*d;this.linearRampToValueAtTime(this._toType(C),o+_*b)}return this}cancelScheduledValues(t){const o=this.toSeconds(t);return wt(isFinite(o),`Invalid argument to cancelScheduledValues: ${JSON.stringify(t)}`),this._events.cancel(o),this._param.cancelScheduledValues(o),this.log(this.units,"cancelScheduledValues",o),this}cancelAndHoldAtTime(t){const o=this.toSeconds(t),l=this._fromType(this.getValueAtTime(o));wt(isFinite(o),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(t)}`),this.log(this.units,"cancelAndHoldAtTime",o,"value="+l);const d=this._events.get(o),g=this._events.getAfter(o);return d&&qs(d.time,o)?g?(this._param.cancelScheduledValues(g.time),this._events.cancel(g.time)):(this._param.cancelAndHoldAtTime(o),this._events.cancel(o+this.sampleTime)):g&&(this._param.cancelScheduledValues(g.time),this._events.cancel(g.time),g.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(l),o):g.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(l),o)),this._events.add({time:o,type:"setValueAtTime",value:l}),this._param.setValueAtTime(l,o),this}rampTo(t,o=.1,l){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(t,o,l):this.linearRampTo(t,o,l),this}apply(t){const o=this.context.currentTime;t.setValueAtTime(this.getValueAtTime(o),o);const l=this._events.get(o);if(l&&l.type==="setTargetAtTime"){const d=this._events.getAfter(l.time),g=d?d.time:o+2,b=(g-o)/10;for(let _=o;_<g;_+=b)t.linearRampToValueAtTime(this.getValueAtTime(_),_)}return this._events.forEachAfter(this.context.currentTime,d=>{d.type==="cancelScheduledValues"?t.cancelScheduledValues(d.time):d.type==="setTargetAtTime"?t.setTargetAtTime(d.value,d.time,d.constant):t[d.type](d.value,d.time)}),this}setParam(t){wt(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const o=this.input;return o.disconnect(this._param),this.apply(t),this._param=t,o.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(t,o,l,d,g){return l+(o-l)*Math.exp(-(g-t)/d)}_linearInterpolate(t,o,l,d,g){return o+(g-t)/(l-t)*(d-o)}_exponentialInterpolate(t,o,l,d,g){return o*Math.pow(d/o,(g-t)/(l-t))}}class ot extends Ne{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return It(this.input)?Xn(this.input)||this.input instanceof Et?1:this.input.numberOfInputs:0}get numberOfOutputs(){return It(this.output)?this.output.numberOfOutputs:0}_isAudioNode(t){return It(t)&&(t instanceof ot||En(t))}_getInternalNodes(){const t=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&t.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&t.push(this.output),t}_setChannelProperties(t){this._getInternalNodes().forEach(o=>{o.channelCount=t.channelCount,o.channelCountMode=t.channelCountMode,o.channelInterpretation=t.channelInterpretation})}_getChannelProperties(){const t=this._getInternalNodes();wt(t.length>0,"ToneAudioNode does not have any internal nodes");const o=t[0];return{channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCount:t}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCountMode:t}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelInterpretation:t}))}connect(t,o=0,l=0){return ts(this,t,o,l),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return xi("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(t,o=0,l=0){return wl(this,t,o,l),this}chain(...t){return gs(this,...t),this}fan(...t){return t.forEach(o=>this.connect(o)),this}dispose(){return super.dispose(),It(this.input)&&(this.input instanceof ot?this.input.dispose():En(this.input)&&this.input.disconnect()),It(this.output)&&(this.output instanceof ot?this.output.dispose():En(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function gs(...p){const t=p.shift();p.reduce((o,l)=>(o instanceof ot?o.connect(l):En(o)&&ts(o,l),l),t)}function ts(p,t,o=0,l=0){for(wt(It(p),"Cannot connect from undefined node"),wt(It(t),"Cannot connect to undefined node"),(t instanceof ot||En(t))&&wt(t.numberOfInputs>0,"Cannot connect to node with no inputs"),wt(p.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof ot||t instanceof Et;)It(t.input)&&(t=t.input);for(;p instanceof ot;)It(p.output)&&(p=p.output);Xn(t)?p.connect(t,o):p.connect(t,o,l)}function wl(p,t,o=0,l=0){if(It(t))for(;t instanceof ot;)t=t.input;for(;!En(p);)It(p.output)&&(p=p.output);Xn(t)?p.disconnect(t,o):En(t)?p.disconnect(t,o,l):p.disconnect()}function Eg(...p){const t=p.pop();It(t)&&p.forEach(o=>ts(o,t))}class bt extends ot{constructor(){const t=tt(bt.getDefaults(),arguments,["gain","units"]);super(t),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Et({context:this.context,convert:t.convert,param:this._gainNode.gain,units:t.units,value:t.gain,minValue:t.minValue,maxValue:t.maxValue}),Ct(this,"gain")}static getDefaults(){return Object.assign(ot.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Ii extends ot{constructor(t){super(t),this.onended=Dt,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new bt({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(o){const l=this.toSeconds(o);return this._startTime!==-1&&l>=this._startTime&&(this._stopTime===-1||l<=this._stopTime)?"started":"stopped"},this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut,this._curve=t.curve,this.onended=t.onended}static getDefaults(){return Object.assign(ot.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Dt})}_startGain(t,o=1){wt(this._startTime===-1,"Source cannot be started more than once");const l=this.toSeconds(this._fadeIn);return this._startTime=t+l,this._startTime=Math.max(this._startTime,this.context.currentTime),l>0?(this._gainNode.gain.setValueAtTime(0,t),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(o,t+l):this._gainNode.gain.exponentialApproachValueAtTime(o,t,l)):this._gainNode.gain.setValueAtTime(o,t),this}stop(t){return this.log("stop",t),this._stopGain(this.toSeconds(t)),this}_stopGain(t){wt(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const o=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(t)+o,this._stopTime=Math.max(this._stopTime,this.now()),o>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,o,t):this._gainNode.gain.targetRampTo(0,o,t):(this._gainNode.gain.cancelAndHoldAtTime(t),this._gainNode.gain.setValueAtTime(0,t)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const l=this._curve==="exponential"?2*o:0;this._stopSource(this.now()+l),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Dt&&(this.onended(this),this.onended=Dt,!this.context.isOffline)){const t=()=>this.dispose();window.requestIdleCallback!==void 0?window.requestIdleCallback(t):setTimeout(t,1e3)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),wt(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Dt,this}}class Zr extends Ii{constructor(){const t=tt(Zr.getDefaults(),arguments,["offset"]);super(t),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),ts(this._source,this._gainNode),this.offset=new Et({context:this.context,convert:t.convert,param:this._source.offset,units:t.units,value:t.offset,minValue:t.minValue,maxValue:t.maxValue})}static getDefaults(){return Object.assign(Ii.getDefaults(),{convert:!0,offset:1,units:"number"})}start(t){const o=this.toSeconds(t);return this.log("start",o),this._startGain(o),this._source.start(o),this}_stopSource(t){this._source.stop(t)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class At extends ot{constructor(){const t=tt(At.getDefaults(),arguments,["value","units"]);super(t),this.name="Signal",this.override=!0,this.output=this._constantSource=new Zr({context:this.context,convert:t.convert,offset:t.value,units:t.units,minValue:t.minValue,maxValue:t.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(ot.getDefaults(),{convert:!0,units:"number",value:0})}connect(t,o=0,l=0){return Eo(this,t,o,l),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(t,o){return this._param.setValueAtTime(t,o),this}getValueAtTime(t){return this._param.getValueAtTime(t)}setRampPoint(t){return this._param.setRampPoint(t),this}linearRampToValueAtTime(t,o){return this._param.linearRampToValueAtTime(t,o),this}exponentialRampToValueAtTime(t,o){return this._param.exponentialRampToValueAtTime(t,o),this}exponentialRampTo(t,o,l){return this._param.exponentialRampTo(t,o,l),this}linearRampTo(t,o,l){return this._param.linearRampTo(t,o,l),this}targetRampTo(t,o,l){return this._param.targetRampTo(t,o,l),this}exponentialApproachValueAtTime(t,o,l){return this._param.exponentialApproachValueAtTime(t,o,l),this}setTargetAtTime(t,o,l){return this._param.setTargetAtTime(t,o,l),this}setValueCurveAtTime(t,o,l,d){return this._param.setValueCurveAtTime(t,o,l,d),this}cancelScheduledValues(t){return this._param.cancelScheduledValues(t),this}cancelAndHoldAtTime(t){return this._param.cancelAndHoldAtTime(t),this}rampTo(t,o,l){return this._param.rampTo(t,o,l),this}get value(){return this._param.value}set value(t){this._param.value=t}get convert(){return this._param.convert}set convert(t){this._param.convert=t}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(t){this._param.overridden=t}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(t){return this._param.apply(t),this}}function Eo(p,t,o,l){(t instanceof Et||Xn(t)||t instanceof At&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof At&&(t.overridden=!0)),ts(p,t,o,l)}class _l extends Et{constructor(){const t=tt(_l.getDefaults(),arguments,["value"]);super(t),this.name="TickParam",this._events=new ms(1/0),this._multiplier=1,this._multiplier=t.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(t.value)}),this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Et.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(t,o,l){o=this.toSeconds(o),this.setRampPoint(o);const d=this._fromType(t),g=this._events.get(o),b=Math.round(Math.max(1/l,1));for(let _=0;_<=b;_++){const C=l*_+o,T=this._exponentialApproach(g.time,g.value,d,l,C);this.linearRampToValueAtTime(this._toType(T),C)}return this}setValueAtTime(t,o){const l=this.toSeconds(o);super.setValueAtTime(t,o);const d=this._events.get(l),g=this._events.previousEvent(d),b=this._getTicksUntilEvent(g,l);return d.ticks=Math.max(b,0),this}linearRampToValueAtTime(t,o){const l=this.toSeconds(o);super.linearRampToValueAtTime(t,o);const d=this._events.get(l),g=this._events.previousEvent(d),b=this._getTicksUntilEvent(g,l);return d.ticks=Math.max(b,0),this}exponentialRampToValueAtTime(t,o){o=this.toSeconds(o);const l=this._fromType(t),d=this._events.get(o),g=Math.round(Math.max(10*(o-d.time),1)),b=(o-d.time)/g;for(let _=0;_<=g;_++){const C=b*_+d.time,T=this._exponentialInterpolate(d.time,d.value,o,l,C);this.linearRampToValueAtTime(this._toType(T),C)}return this}_getTicksUntilEvent(t,o){if(t===null)t={ticks:0,time:0,type:"setValueAtTime",value:0};else if(rs(t.ticks)){const b=this._events.previousEvent(t);t.ticks=this._getTicksUntilEvent(b,t.time)}const l=this._fromType(this.getValueAtTime(t.time));let d=this._fromType(this.getValueAtTime(o));const g=this._events.get(o);return g&&g.time===o&&g.type==="setValueAtTime"&&(d=this._fromType(this.getValueAtTime(o-this.sampleTime))),.5*(o-t.time)*(l+d)+t.ticks}getTicksAtTime(t){const o=this.toSeconds(t),l=this._events.get(o);return Math.max(this._getTicksUntilEvent(l,o),0)}getDurationOfTicks(t,o){const l=this.toSeconds(o),d=this.getTicksAtTime(o);return this.getTimeOfTick(d+t)-l}getTimeOfTick(t){const o=this._events.get(t,"ticks"),l=this._events.getAfter(t,"ticks");if(o&&o.ticks===t)return o.time;if(o&&l&&l.type==="linearRampToValueAtTime"&&o.value!==l.value){const d=this._fromType(this.getValueAtTime(o.time)),g=(this._fromType(this.getValueAtTime(l.time))-d)/(l.time-o.time),b=Math.sqrt(Math.pow(d,2)-2*g*(o.ticks-t)),_=(-d+b)/g;return(_>0?_:(-d-b)/g)+o.time}return o?o.value===0?1/0:o.time+(t-o.ticks)/o.value:t/this._initialValue}ticksToTime(t,o){return this.getDurationOfTicks(t,o)}timeToTicks(t,o){const l=this.toSeconds(o),d=this.toSeconds(t),g=this.getTicksAtTime(l);return this.getTicksAtTime(l+d)-g}_fromType(t){return this.units==="bpm"&&this.multiplier?1/(60/t/this.multiplier):super._fromType(t)}_toType(t){return this.units==="bpm"&&this.multiplier?t/this.multiplier*60:super._toType(t)}get multiplier(){return this._multiplier}set multiplier(t){const o=this.value;this._multiplier=t,this.cancelScheduledValues(0),this.setValueAtTime(o,0)}}class xl extends At{constructor(){const t=tt(xl.getDefaults(),arguments,["value"]);super(t),this.name="TickSignal",this.input=this._param=new _l({context:this.context,convert:t.convert,multiplier:t.multiplier,param:this._constantSource.offset,units:t.units,value:t.value})}static getDefaults(){return Object.assign(At.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(t,o){return this._param.ticksToTime(t,o)}timeToTicks(t,o){return this._param.timeToTicks(t,o)}getTimeOfTick(t){return this._param.getTimeOfTick(t)}getDurationOfTicks(t,o){return this._param.getDurationOfTicks(t,o)}getTicksAtTime(t){return this._param.getTicksAtTime(t)}get multiplier(){return this._param.multiplier}set multiplier(t){this._param.multiplier=t}dispose(){return super.dispose(),this._param.dispose(),this}}class Sl extends Ne{constructor(){const t=tt(Sl.getDefaults(),arguments,["frequency"]);super(t),this.name="TickSource",this._state=new ki,this._tickOffset=new ms,this._ticksAtTime=new ms,this._secondsAtTime=new ms,this.frequency=new xl({context:this.context,units:t.units,value:t.frequency}),Ct(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Ne.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(t,o){const l=this.toSeconds(t);return this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),It(o)&&this.setTicksAtTime(o,l),this._ticksAtTime.cancel(l),this._secondsAtTime.cancel(l)),this}stop(t){const o=this.toSeconds(t);if(this._state.getValueAtTime(o)==="stopped"){const l=this._state.get(o);l&&l.time>0&&(this._tickOffset.cancel(l.time),this._state.cancel(l.time))}return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this.setTicksAtTime(0,o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}pause(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o)),this}cancel(t){return t=this.toSeconds(t),this._state.cancel(t),this._tickOffset.cancel(t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getTicksAtTime(t){const o=this.toSeconds(t),l=this._state.getLastState("stopped",o),d=this._ticksAtTime.get(o),g={state:"paused",time:o};this._state.add(g);let b=d||l,_=d?d.ticks:0,C=null;return this._state.forEachBetween(b.time,o+this.sampleTime,T=>{let P=b.time;const k=this._tickOffset.get(T.time);k&&k.time>=b.time&&(_=k.ticks,P=k.time),b.state==="started"&&T.state!=="started"&&(_+=this.frequency.getTicksAtTime(T.time)-this.frequency.getTicksAtTime(P),T.time!==g.time&&(C={state:T.state,time:T.time,ticks:_})),b=T}),this._state.remove(g),C&&this._ticksAtTime.add(C),_}get ticks(){return this.getTicksAtTime(this.now())}set ticks(t){this.setTicksAtTime(t,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(t){const o=this.now(),l=this.frequency.timeToTicks(t,o);this.setTicksAtTime(l,o)}getSecondsAtTime(t){t=this.toSeconds(t);const o=this._state.getLastState("stopped",t),l={state:"paused",time:t};this._state.add(l);const d=this._secondsAtTime.get(t);let g=d||o,b=d?d.seconds:0,_=null;return this._state.forEachBetween(g.time,t+this.sampleTime,C=>{let T=g.time;const P=this._tickOffset.get(C.time);P&&P.time>=g.time&&(b=P.seconds,T=P.time),g.state==="started"&&C.state!=="started"&&(b+=C.time-T,C.time!==l.time&&(_={state:C.state,time:C.time,seconds:b})),g=C}),this._state.remove(l),_&&this._secondsAtTime.add(_),b}setTicksAtTime(t,o){return o=this.toSeconds(o),this._tickOffset.cancel(o),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(t,o),ticks:t,time:o}),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}getStateAtTime(t){return t=this.toSeconds(t),this._state.getValueAtTime(t)}getTimeOfTick(t,o=this.now()){const l=this._tickOffset.get(o),d=this._state.get(o),g=Math.max(l.time,d.time),b=this.frequency.getTicksAtTime(g)+t-l.ticks;return this.frequency.getTimeOfTick(b)}forEachTickBetween(t,o,l){let d=this._state.get(t);this._state.forEachBetween(t,o,b=>{d&&d.state==="started"&&b.state!=="started"&&this.forEachTickBetween(Math.max(d.time,t),b.time-this.sampleTime,l),d=b});let g=null;if(d&&d.state==="started"){const b=Math.max(d.time,t),_=this.frequency.getTicksAtTime(b),C=_-this.frequency.getTicksAtTime(d.time);let T=Math.ceil(C)-C;T=qs(T,1)?0:T;let P=this.frequency.getTimeOfTick(_+T);for(;P<o;){try{l(P,Math.round(this.getTicksAtTime(P)))}catch(k){g=k;break}P+=this.frequency.getDurationOfTicks(1,P)}}if(g)throw g;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class Ri extends Ne{constructor(){const t=tt(Ri.getDefaults(),arguments,["callback","frequency"]);super(t),this.name="Clock",this.callback=Dt,this._lastUpdate=0,this._state=new ki("stopped"),this._boundLoop=this._loop.bind(this),this.callback=t.callback,this._tickSource=new Sl({context:this.context,frequency:t.frequency,units:t.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Ct(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Ne.getDefaults(),{callback:Dt,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(t,o){dl(this.context);const l=this.toSeconds(t);return this.log("start",l),this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),this._tickSource.start(l,o),l<this._lastUpdate&&this.emit("start",l,o)),this}stop(t){const o=this.toSeconds(t);return this.log("stop",o),this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._tickSource.stop(o),o<this._lastUpdate&&this.emit("stop",o),this}pause(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._tickSource.pause(o),o<this._lastUpdate&&this.emit("pause",o)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(t){this._tickSource.ticks=t}get seconds(){return this._tickSource.seconds}set seconds(t){this._tickSource.seconds=t}getSecondsAtTime(t){return this._tickSource.getSecondsAtTime(t)}setTicksAtTime(t,o){return this._tickSource.setTicksAtTime(t,o),this}getTimeOfTick(t,o=this.now()){return this._tickSource.getTimeOfTick(t,o)}getTicksAtTime(t){return this._tickSource.getTicksAtTime(t)}nextTickTime(t,o){const l=this.toSeconds(o),d=this.getTicksAtTime(l);return this._tickSource.getTimeOfTick(d+t,l)}_loop(){const t=this._lastUpdate,o=this.now();this._lastUpdate=o,this.log("loop",t,o),t!==o&&(this._state.forEachBetween(t,o,l=>{switch(l.state){case"started":const d=this._tickSource.getTicksAtTime(l.time);this.emit("start",l.time,d);break;case"stopped":l.time!==0&&this.emit("stop",l.time);break;case"paused":this.emit("pause",l.time)}}),this._tickSource.forEachTickBetween(t,o,(l,d)=>{this.callback(l,d)}))}getStateAtTime(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Ti.mixin(Ri);class vs extends ot{constructor(){const t=tt(vs.getDefaults(),arguments,["delayTime","maxDelay"]);super(t),this.name="Delay";const o=this.toSeconds(t.maxDelay);this._maxDelay=Math.max(o,this.toSeconds(t.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(o),this.delayTime=new Et({context:this.context,param:this._delayNode.delayTime,units:"time",value:t.delayTime,minValue:0,maxValue:this.maxDelay}),Ct(this,"delayTime")}static getDefaults(){return Object.assign(ot.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class un extends ot{constructor(){const t=tt(un.getDefaults(),arguments,["volume"]);super(t),this.name="Volume",this.input=this.output=new bt({context:this.context,gain:t.volume,units:"decibels"}),this.volume=this.output.gain,Ct(this,"volume"),this._unmutedVolume=t.volume,this.mute=t.mute}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(t){!this.mute&&t?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!t&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Cl extends ot{constructor(){const t=tt(Cl.getDefaults(),arguments);super(t),this.name="Destination",this.input=new un({context:this.context}),this.output=new bt({context:this.context}),this.volume=this.input.volume,gs(this.input,this.output,this.context.rawContext.destination),this.mute=t.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(t){this.input.mute=t}chain(...t){return this.input.disconnect(),t.unshift(this.input),t.push(this.output),gs(...t),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}jr(p=>{p.destination=new Cl({context:p})}),Xr(p=>{p.destination.dispose()});class Pg extends ot{constructor(){super(...arguments),this.name="Listener",this.positionX=new Et({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Et({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Et({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Et({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Et({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Et({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Et({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Et({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Et({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(ot.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}function kg(p,t){return ee(this,arguments,void 0,function*(o,l,d=2,g=re().sampleRate){const b=re(),_=new Mi(d,l,g);Ur(_),yield o(_);const C=_.render();Ur(b);const T=yield C;return new $t(T)})}jr(p=>{p.listener=new Pg({context:p})}),Xr(p=>{p.listener.dispose()});class Di extends hn{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const t=tt(Di.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=t.baseUrl,Object.keys(t.urls).forEach(o=>{this._loadingCount++;const l=t.urls[o];this.add(o,l,this._bufferLoaded.bind(this,t.onload),t.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Dt,onload:Dt,urls:{}}}has(t){return this._buffers.has(t.toString())}get(t){return wt(this.has(t),`ToneAudioBuffers has no buffer named: ${t}`),this._buffers.get(t.toString())}_bufferLoaded(t){this._loadingCount--,this._loadingCount===0&&t&&t()}get loaded(){return Array.from(this._buffers).every(([t,o])=>o.loaded)}add(t,o,l=Dt,d=Dt){return Fs(o)?(this.baseUrl&&o.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(t.toString(),new $t(this.baseUrl+o,l,d))):this._buffers.set(t.toString(),new $t(o,l,d)),this}dispose(){return super.dispose(),this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this}}class Oi extends Ke{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(t){return Pn(super._frequencyToUnits(t))}_ticksToUnits(t){return Pn(super._ticksToUnits(t))}_beatsToUnits(t){return Pn(super._beatsToUnits(t))}_secondsToUnits(t){return Pn(super._secondsToUnits(t))}toMidi(){return this.valueOf()}toFrequency(){return yl(this.toMidi())}transpose(t){return new Oi(this.context,this.toMidi()+t)}}function Ig(p,t){return new Oi(re(),p,t)}class he extends Se{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(t){return this._getPPQ()*t}_secondsToUnits(t){return Math.floor(t/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(t){return t}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}function Rg(p,t){return new he(re(),p,t)}class Dg extends Ne{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new ms,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(t,o){return this._events.add({callback:t,time:this.toSeconds(o)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(t){return this._events.cancel(this.toSeconds(t)),this}_drawLoop(){const t=this.context.currentTime;for(;this._events.length&&this._events.peek().time-this.anticipation<=t;){const o=this._events.shift();o&&t-o.time<=this.expiration&&o.callback()}this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}jr(p=>{p.draw=new Dg({context:p})}),Xr(p=>{p.draw.dispose()});class $u extends hn{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(t){wt(It(t.time),"Events must have a time property"),wt(It(t.duration),"Events must have a duration parameter"),t.time=t.time.valueOf();let o=new Og(t.time,t.time+t.duration,t);for(this._root===null?this._root=o:this._root.insert(o),this._length++;o!==null;)o.updateHeight(),o.updateMax(),this._rebalance(o),o=o.parent;return this}remove(t){if(this._root!==null){const o=[];this._root.search(t.time,o);for(const l of o)if(l.event===t){this._removeNode(l),this._length--;break}}return this}get length(){return this._length}cancel(t){return this.forEachFrom(t,o=>this.remove(o)),this}_setRoot(t){this._root=t,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(t,o){t.parent!==null?(t.isLeftChild()?t.parent.left=o:t.parent.right=o,this._rebalance(t.parent)):this._setRoot(o)}_removeNode(t){if(t.left===null&&t.right===null)this._replaceNodeInParent(t,null);else if(t.right===null)this._replaceNodeInParent(t,t.left);else if(t.left===null)this._replaceNodeInParent(t,t.right);else{let o,l=null;if(t.getBalance()>0)if(t.left.right===null)o=t.left,o.right=t.right,l=o;else{for(o=t.left.right;o.right!==null;)o=o.right;o.parent&&(o.parent.right=o.left,l=o.parent,o.left=t.left,o.right=t.right)}else if(t.right.left===null)o=t.right,o.left=t.left,l=o;else{for(o=t.right.left;o.left!==null;)o=o.left;o.parent&&(o.parent.left=o.right,l=o.parent,o.left=t.left,o.right=t.right)}t.parent!==null?t.isLeftChild()?t.parent.left=o:t.parent.right=o:this._setRoot(o),l&&this._rebalance(l)}t.dispose()}_rotateLeft(t){const o=t.parent,l=t.isLeftChild(),d=t.right;d&&(t.right=d.left,d.left=t),o!==null?l?o.left=d:o.right=d:this._setRoot(d)}_rotateRight(t){const o=t.parent,l=t.isLeftChild(),d=t.left;d&&(t.left=d.right,d.right=t),o!==null?l?o.left=d:o.right=d:this._setRoot(d)}_rebalance(t){const o=t.getBalance();o>1&&t.left?t.left.getBalance()<0?this._rotateLeft(t.left):this._rotateRight(t):o<-1&&t.right&&(t.right.getBalance()>0?this._rotateRight(t.right):this._rotateLeft(t))}get(t){if(this._root!==null){const o=[];if(this._root.search(t,o),o.length>0){let l=o[0];for(let d=1;d<o.length;d++)o[d].low>l.low&&(l=o[d]);return l.event}}return null}forEach(t){if(this._root!==null){const o=[];this._root.traverse(l=>o.push(l)),o.forEach(l=>{l.event&&t(l.event)})}return this}forEachAtTime(t,o){if(this._root!==null){const l=[];this._root.search(t,l),l.forEach(d=>{d.event&&o(d.event)})}return this}forEachFrom(t,o){if(this._root!==null){const l=[];this._root.searchAfter(t,l),l.forEach(d=>{d.event&&o(d.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(t=>t.dispose()),this._root=null,this}}class Og{constructor(t,o,l){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=l,this.low=t,this.high=o,this.max=this.high}insert(t){t.low<=this.low?this.left===null?this.left=t:this.left.insert(t):this.right===null?this.right=t:this.right.insert(t)}search(t,o){t>this.max||(this.left!==null&&this.left.search(t,o),this.low<=t&&this.high>t&&o.push(this),this.low>t||this.right!==null&&this.right.search(t,o))}searchAfter(t,o){this.low>=t&&(o.push(this),this.left!==null&&this.left.searchAfter(t,o)),this.right!==null&&this.right.searchAfter(t,o)}traverse(t){t(this),this.left!==null&&this.left.traverse(t),this.right!==null&&this.right.traverse(t)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let t=0;return this.left!==null&&this.right!==null?t=this.left.height-this.right.height:this.left!==null?t=this.left.height+1:this.right!==null&&(t=-(this.right.height+1)),t}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(t){this._left=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(t){this._right=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class Ng extends hn{constructor(t){super(),this.name="TimelineValue",this._timeline=new ms({memory:10}),this._initialValue=t}set(t,o){return this._timeline.add({value:t,time:o}),this}get(t){const o=this._timeline.get(t);return o?o.value:this._initialValue}}class ys extends ot{constructor(){super(tt(ys.getDefaults(),arguments,["context"]))}connect(t,o=0,l=0){return Eo(this,t,o,l),this}}class $s extends ys{constructor(){const t=tt($s.getDefaults(),arguments,["mapping","length"]);super(t),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Be(t.mapping)||t.mapping instanceof Float32Array?this.curve=Float32Array.from(t.mapping):Iu(t.mapping)&&this.setMap(t.mapping,t.length)}static getDefaults(){return Object.assign(At.getDefaults(),{length:1024})}setMap(t,o=1024){const l=new Float32Array(o);for(let d=0,g=o;d<g;d++){const b=d/(g-1)*2-1;l[d]=t(b,d)}return this.curve=l,this}get curve(){return this._shaper.curve}set curve(t){this._shaper.curve=t}get oversample(){return this._shaper.oversample}set oversample(t){wt(["none","2x","4x"].some(o=>o.includes(t)),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Ni extends ys{constructor(){const t=tt(Ni.getDefaults(),arguments,["value"]);super(t),this.name="Pow",this._exponentScaler=this.input=this.output=new $s({context:this.context,mapping:this._expFunc(t.value),length:8192}),this._exponent=t.value}static getDefaults(){return Object.assign(ys.getDefaults(),{value:1})}_expFunc(t){return o=>Math.pow(Math.abs(o),t)}get value(){return this._exponent}set value(t){this._exponent=t,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class kn{constructor(t,o){this.id=kn._eventId++,this._remainderTime=0;const l=Object.assign(kn.getDefaults(),o);this.transport=t,this.callback=l.callback,this._once=l.once,this.time=Math.floor(l.time),this._remainderTime=l.time-this.time}static getDefaults(){return{callback:Dt,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(t){if(this.callback){const o=this.transport.bpm.getDurationOfTicks(1,t);this.callback(t+this._remainderTime*o),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}kn._eventId=0;class Tl extends kn{constructor(t,o){super(t,o),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const l=Object.assign(Tl.getDefaults(),o);this.duration=l.duration,this._interval=l.interval,this._nextTick=l.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},kn.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(t){this._createEvents(t),super.invoke(t)}_createEvent(){return Gr(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new he(this.context,this._nextTick).toSeconds()):-1}_createEvents(t){Gr(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new he(this.context,this._nextTick).toSeconds()))}_restart(t){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const o=this.transport.getTicksAtTime(t);Ci(o,this.time)&&(this._nextTick=this.floatTime+Math.ceil((o-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Qr extends Ne{constructor(){const t=tt(Qr.getDefaults(),arguments);super(t),this.name="Transport",this._loop=new Ng(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new ms,this._repeatedEvents=new $u,this._syncedSignals=[],this._swingAmount=0,this._ppq=t.ppq,this._clock=new Ri({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=t.ppq,this.bpm.setValueAtTime(t.bpm,0),Ct(this,"bpm"),this._timeSignature=t.timeSignature,this._swingTicks=t.ppq/2}static getDefaults(){return Object.assign(Ne.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(t,o){if(this._loop.get(t)&&o>=this._loopEnd&&(this.emit("loopEnd",t),this._clock.setTicksAtTime(this._loopStart,t),o=this._loopStart,this.emit("loopStart",t,this._clock.getSecondsAtTime(t)),this.emit("loop",t)),this._swingAmount>0&&o%this._ppq!=0&&o%(2*this._swingTicks)!=0){const l=o%(2*this._swingTicks)/(2*this._swingTicks),d=Math.sin(l*Math.PI)*this._swingAmount;t+=new he(this.context,2*this._swingTicks/3).toSeconds()*d}pl(!0),this._timeline.forEachAtTime(o,l=>l.invoke(t)),pl(!1)}schedule(t,o){const l=new kn(this,{callback:t,time:new Se(this.context,o).toTicks()});return this._addEvent(l,this._timeline)}scheduleRepeat(t,o,l,d=1/0){const g=new Tl(this,{callback:t,duration:new fs(this.context,d).toTicks(),interval:new fs(this.context,o).toTicks(),time:new Se(this.context,l).toTicks()});return this._addEvent(g,this._repeatedEvents)}scheduleOnce(t,o){const l=new kn(this,{callback:t,once:!0,time:new Se(this.context,o).toTicks()});return this._addEvent(l,this._timeline)}clear(t){if(this._scheduledEvents.hasOwnProperty(t)){const o=this._scheduledEvents[t.toString()];o.timeline.remove(o.event),o.event.dispose(),delete this._scheduledEvents[t.toString()]}return this}_addEvent(t,o){return this._scheduledEvents[t.id.toString()]={event:t,timeline:o},o.add(t),t.id}cancel(t=0){const o=this.toTicks(t);return this._timeline.forEachFrom(o,l=>this.clear(l.id)),this._repeatedEvents.forEachFrom(o,l=>this.clear(l.id)),this}_bindClockEvents(){this._clock.on("start",(t,o)=>{o=new he(this.context,o).toSeconds(),this.emit("start",t,o)}),this._clock.on("stop",t=>{this.emit("stop",t)}),this._clock.on("pause",t=>{this.emit("pause",t)})}get state(){return this._clock.getStateAtTime(this.now())}start(t,o){let l;return this.context.resume(),It(o)&&(l=this.toTicks(o)),this._clock.start(t,l),this}stop(t){return this._clock.stop(t),this}pause(t){return this._clock.pause(t),this}toggle(t){return t=this.toSeconds(t),this._clock.getStateAtTime(t)!=="started"?this.start(t):this.stop(t),this}get timeSignature(){return this._timeSignature}set timeSignature(t){Be(t)&&(t=t[0]/t[1]*4),this._timeSignature=t}get loopStart(){return new fs(this.context,this._loopStart,"i").toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t)}get loopEnd(){return new fs(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t)}get loop(){return this._loop.get(this.now())}set loop(t){this._loop.set(t,this.now())}setLoopPoints(t,o){return this.loopStart=t,this.loopEnd=o,this}get swing(){return this._swingAmount}set swing(t){this._swingAmount=t}get swingSubdivision(){return new he(this.context,this._swingTicks).toNotation()}set swingSubdivision(t){this._swingTicks=this.toTicks(t)}get position(){const t=this.now(),o=this._clock.getTicksAtTime(t);return new he(this.context,o).toBarsBeatsSixteenths()}set position(t){const o=this.toTicks(t);this.ticks=o}get seconds(){return this._clock.seconds}set seconds(t){const o=this.now(),l=this._clock.frequency.timeToTicks(t,o);this.ticks=l}get progress(){if(this.loop){const t=this.now();return(this._clock.getTicksAtTime(t)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(t){if(this._clock.ticks!==t){const o=this.now();if(this.state==="started"){const l=this._clock.getTicksAtTime(o),d=o+this._clock.frequency.getDurationOfTicks(Math.ceil(l)-l,o);this.emit("stop",d),this._clock.setTicksAtTime(t,d),this.emit("start",d,this._clock.getSecondsAtTime(d))}else this.emit("ticks",o),this._clock.setTicksAtTime(t,o)}}getTicksAtTime(t){return this._clock.getTicksAtTime(t)}getSecondsAtTime(t){return this._clock.getSecondsAtTime(t)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(t){this._clock.frequency.multiplier=t}nextSubdivision(t){if(t=this.toTicks(t),this.state!=="started")return 0;{const o=this.now(),l=t-this.getTicksAtTime(o)%t;return this._clock.nextTickTime(l,o)}}syncSignal(t,o){const l=this.now();let d=this.bpm,g=1/(60/d.getValueAtTime(l)/this.PPQ),b=[];if(t.units==="time"){const C=.015625/g,T=new bt(C),P=new Ni(-1),k=new bt(C);d.chain(T,P,k),d=k,g=1/g,b=[T,P,k]}o||(o=t.getValueAtTime(l)!==0?t.getValueAtTime(l)/g:0);const _=new bt(o);return d.connect(_),_.connect(t._param),b.push(_),this._syncedSignals.push({initial:t.value,nodes:b,signal:t}),t.value=0,this}unsyncSignal(t){for(let o=this._syncedSignals.length-1;o>=0;o--){const l=this._syncedSignals[o];l.signal===t&&(l.nodes.forEach(d=>d.dispose()),l.signal.value=l.initial,this._syncedSignals.splice(o,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),To(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Ti.mixin(Qr),jr(p=>{p.transport=new Qr({context:p})}),Xr(p=>{p.transport.dispose()});class ve extends ot{constructor(t){super(t),this.input=void 0,this._state=new ki("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Dt,this._syncedStop=Dt,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new un({context:this.context,mute:t.mute,volume:t.volume}),this.volume=this._volume.volume,Ct(this,"volume"),this.onstop=t.onstop}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,onstop:Dt,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}_clampToCurrentTime(t){return this._synced?t:Math.max(t,this.context.currentTime)}start(t,o,l){let d=rs(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(d=this._clampToCurrentTime(d),this._synced||this._state.getValueAtTime(d)!=="started")if(this.log("start",d),this._state.setStateAtTime("started",d),this._synced){const g=this._state.get(d);g&&(g.offset=this.toSeconds(Ms(o,0)),g.duration=l?this.toSeconds(l):void 0);const b=this.context.transport.schedule(_=>{this._start(_,o,l)},d);this._scheduled.push(b),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>d&&this._syncedStart(this.now(),this.context.transport.seconds)}else dl(this.context),this._start(d,o,l);else wt(Ci(d,this._state.get(d).time),"Start time must be strictly greater than previous start time"),this._state.cancel(d),this._state.setStateAtTime("started",d),this.log("restart",d),this.restart(d,o,l);return this}stop(t){let o=rs(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(o=this._clampToCurrentTime(o),this._state.getValueAtTime(o)==="started"||It(this._state.getNextState("started",o))){if(this.log("stop",o),this._synced){const l=this.context.transport.schedule(this._stop.bind(this),o);this._scheduled.push(l)}else this._stop(o);this._state.cancel(o),this._state.setStateAtTime("stopped",o)}return this}restart(t,o,l){return t=this.toSeconds(t),this._state.getValueAtTime(t)==="started"&&(this._state.cancel(t),this._restart(t,o,l)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(t,o)=>{if(Ci(o,0)){const l=this._state.get(o);if(l&&l.state==="started"&&l.time!==o){const d=o-this.toSeconds(l.time);let g;l.duration&&(g=this.toSeconds(l.duration)-d),this._start(t,this.toSeconds(l.offset)+d,g)}}},this._syncedStop=t=>{const o=this.context.transport.getSecondsAtTime(Math.max(t-this.sampleTime,0));this._state.getValueAtTime(o)==="started"&&this._stop(t)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(t=>this.context.transport.clear(t)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Dt,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class In extends Ii{constructor(){const t=tt(In.getDefaults(),arguments,["url","onload"]);super(t),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,ts(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Et({context:this.context,param:this._source.playbackRate,units:"positive",value:t.playbackRate}),this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this._buffer=new $t(t.url,t.onload,t.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Ii.getDefaults(),{url:new $t,loop:!1,loopEnd:0,loopStart:0,onload:Dt,onerror:Dt,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t}get curve(){return this._curve}set curve(t){this._curve=t}start(t,o,l,d=1){wt(this.buffer.loaded,"buffer is either not set or not loaded");const g=this.toSeconds(t);this._startGain(g,d),o=this.loop?Ms(o,this.loopStart):Ms(o,0);let b=Math.max(this.toSeconds(o),0);if(this.loop){const _=this.toSeconds(this.loopEnd)||this.buffer.duration,C=this.toSeconds(this.loopStart),T=_-C;gl(b,_)&&(b=(b-C)%T+C),qs(b,this.buffer.duration)&&(b=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Gr(b,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(g,b)),It(l)){let _=this.toSeconds(l);_=Math.max(_,0),this.stop(g+_)}return this}_stopSource(t){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(t)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(t){this._source.loopStart=this.toSeconds(t)}get loopEnd(){return this._source.loopEnd}set loopEnd(t){this._source.loopEnd=this.toSeconds(t)}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._source.loop}set loop(t){this._source.loop=t,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}class Rn extends ve{constructor(){const t=tt(Rn.getDefaults(),arguments,["type"]);super(t),this.name="Noise",this._source=null,this._playbackRate=t.playbackRate,this.type=t.type,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ve.getDefaults(),{fadeIn:0,fadeOut:0,playbackRate:1,type:"white"})}get type(){return this._type}set type(t){if(wt(t in zu,"Noise: invalid type: "+t),this._type!==t&&(this._type=t,this.state==="started")){const o=this.now();this._stop(o),this._start(o)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._source&&(this._source.playbackRate.value=t)}_start(t){const o=zu[this._type];this._source=new In({url:o,context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,loop:!0,onended:()=>this.onstop(this),playbackRate:this._playbackRate}).connect(this.output),this._source.start(this.toSeconds(t),Math.random()*(o.duration-.001))}_stop(t){this._source&&(this._source.stop(this.toSeconds(t)),this._source=null)}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._source&&(this._source.fadeIn=this._fadeIn)}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._source&&(this._source.fadeOut=this._fadeOut)}_restart(t){this._stop(t),this._start(t)}dispose(){return super.dispose(),this._source&&this._source.disconnect(),this}}const Li=220500,dn={brown:null,pink:null,white:null},zu={get brown(){if(!dn.brown){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Li);p[t]=o;let l=0;for(let d=0;d<Li;d++){const g=2*Math.random()-1;o[d]=(l+.02*g)/1.02,l=o[d],o[d]*=3.5}}dn.brown=new $t().fromArray(p)}return dn.brown},get pink(){if(!dn.pink){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Li);let l,d,g,b,_,C,T;p[t]=o,l=d=g=b=_=C=T=0;for(let P=0;P<Li;P++){const k=2*Math.random()-1;l=.99886*l+.0555179*k,d=.99332*d+.0750759*k,g=.969*g+.153852*k,b=.8665*b+.3104856*k,_=.55*_+.5329522*k,C=-.7616*C-.016898*k,o[P]=l+d+g+b+_+C+T+.5362*k,o[P]*=.11,T=.115926*k}}dn.pink=new $t().fromArray(p)}return dn.pink},get white(){if(!dn.white){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Li);p[t]=o;for(let l=0;l<Li;l++)o[l]=2*Math.random()-1}dn.white=new $t().fromArray(p)}return dn.white}};class Po extends ot{constructor(){const t=tt(Po.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Ct(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,volume:0})}open(t){return ee(this,void 0,void 0,function*(){wt(Po.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const o=yield Po.enumerateDevices();ds(t)?this._device=o[t]:(this._device=o.find(g=>g.label===t||g.deviceId===t),!this._device&&o.length>0&&(this._device=o[0]),wt(It(this._device),`No matching device ${t}`));const l={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(l.audio.deviceId=this._device.deviceId);const d=yield navigator.mediaDevices.getUserMedia(l);if(!this._stream){this._stream=d;const g=this.context.createMediaStreamSource(d);ts(g,this.output),this._mediaStream=g}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return ee(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){return this._device?this._device.deviceId:void 0}get groupId(){return this._device?this._device.groupId:void 0}get label(){return this._device?this._device.label:void 0}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return It(navigator.mediaDevices)&&It(navigator.mediaDevices.getUserMedia)}}function Yn(p,t){return ee(this,void 0,void 0,function*(){const o=t/p.context.sampleRate,l=new Mi(1,o,p.context.sampleRate);return new p.constructor(Object.assign(p.get(),{frequency:2/o,detune:0,context:l})).toDestination().start(0),(yield l.render()).getChannelData(0)})}class ko extends Ii{constructor(){const t=tt(ko.getDefaults(),arguments,["frequency","type"]);super(t),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],ts(this._oscillator,this._gainNode),this.type=t.type,this.frequency=new Et({context:this.context,param:this._oscillator.frequency,units:"frequency",value:t.frequency}),this.detune=new Et({context:this.context,param:this._oscillator.detune,units:"cents",value:t.detune}),Ct(this,["frequency","detune"])}static getDefaults(){return Object.assign(Ii.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(t){const o=this.toSeconds(t);return this.log("start",o),this._startGain(o),this._oscillator.start(o),this}_stopSource(t){this._oscillator.stop(t)}setPeriodicWave(t){return this._oscillator.setPeriodicWave(t),this}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class ue extends ve{constructor(){const t=tt(ue.getDefaults(),arguments,["frequency","type"]);super(t),this.name="Oscillator",this._oscillator=null,this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),Ct(this,"frequency"),this.detune=new At({context:this.context,units:"cents",value:t.detune}),Ct(this,"detune"),this._partials=t.partials,this._partialCount=t.partialCount,this._type=t.type,t.partialCount&&t.type!=="custom"&&(this._type=this.baseType+t.partialCount.toString()),this.phase=t.phase}static getDefaults(){return Object.assign(ve.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(t){const o=this.toSeconds(t),l=new ko({context:this.context,onended:()=>this.onstop(this)});this._oscillator=l,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(o)}_stop(t){const o=this.toSeconds(t);this._oscillator&&this._oscillator.stop(o)}_restart(t){const o=this.toSeconds(t);return this.log("restart",o),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(o),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return ue._periodicWaveCache.find(t=>{return t.phase===this._phase&&(o=t.partials,l=this._partials,o.length===l.length&&o.every((d,g)=>l[g]===d));var o,l});{const t=ue._periodicWaveCache.find(o=>o.type===this._type&&o.phase===this._phase);return this._partialCount=t?t.partialCount:this._partialCount,t}}get type(){return this._type}set type(t){this._type=t;const o=["sine","square","sawtooth","triangle"].indexOf(t)!==-1;if(this._phase===0&&o)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=t);else{const l=this._getCachedPeriodicWave();if(It(l)){const{partials:d,wave:g}=l;this._wave=g,this._partials=d,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[d,g]=this._getRealImaginary(t,this._phase),b=this.context.createPeriodicWave(d,g);this._wave=b,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),ue._periodicWaveCache.push({imag:g,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:d,type:this._type,wave:this._wave}),ue._periodicWaveCache.length>100&&ue._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(t){this.partialCount&&this._type!=="custom"&&t!=="custom"?this.type=t+this.partialCount:this.type=t}get partialCount(){return this._partialCount}set partialCount(t){qe(t,0);let o=this._type;const l=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(l&&(o=l[1]),this._type!=="custom")this.type=t===0?o:o+t.toString();else{const d=new Float32Array(t);this._partials.forEach((g,b)=>d[b]=g),this._partials=Array.from(d),this.type=this._type}}_getRealImaginary(t,o){let l=2048;const d=new Float32Array(l),g=new Float32Array(l);let b=1;if(t==="custom"){if(b=this._partials.length+1,this._partialCount=this._partials.length,l=b,this._partials.length===0)return[d,g]}else{const _=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(t);_?(b=parseInt(_[2],10)+1,this._partialCount=parseInt(_[2],10),t=_[1],b=Math.max(b,2),l=b):this._partialCount=0,this._partials=[]}for(let _=1;_<l;++_){const C=2/(_*Math.PI);let T;switch(t){case"sine":T=_<=b?1:0,this._partials[_-1]=T;break;case"square":T=1&_?2*C:0,this._partials[_-1]=T;break;case"sawtooth":T=C*(1&_?1:-1),this._partials[_-1]=T;break;case"triangle":T=1&_?C*C*2*(_-1>>1&1?-1:1):0,this._partials[_-1]=T;break;case"custom":T=this._partials[_-1];break;default:throw new TypeError("Oscillator: invalid type: "+t)}T!==0?(d[_]=-T*Math.sin(o*_),g[_]=T*Math.cos(o*_)):(d[_]=0,g[_]=0)}return[d,g]}_inverseFFT(t,o,l){let d=0;const g=t.length;for(let b=0;b<g;b++)d+=t[b]*Math.cos(b*l)+o[b]*Math.sin(b*l);return d}getInitialValue(){const[t,o]=this._getRealImaginary(this._type,0);let l=0;const d=2*Math.PI;for(let g=0;g<32;g++)l=Math.max(this._inverseFFT(t,o,g/32*d),l);return Un(-this._inverseFFT(t,o,this._phase)/l,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(t){this._phase=t*Math.PI/180,this.type=this._type}asArray(){return ee(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}ue._periodicWaveCache=[];class Jr extends ys{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new $s({context:this.context,mapping:t=>(t+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class de extends At{constructor(){const t=tt(de.getDefaults(),arguments,["value"]);super(t),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new bt({context:this.context,minValue:t.minValue,maxValue:t.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class Io extends ve{constructor(){const t=tt(Io.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="AMOscillator",this._modulationScale=new Jr({context:this.context}),this._modulationNode=new bt({context:this.context}),this._carrier=new ue({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new ue({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new de({context:this.context,units:"positive",value:t.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Ct(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(ue.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){this._modulator.restart(t),this._carrier.restart(t)}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return ee(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class Fi extends ve{constructor(){const t=tt(Fi.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="FMOscillator",this._modulationNode=new bt({context:this.context,gain:0}),this._carrier=new ue({context:this.context,detune:t.detune,frequency:0,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.detune=this._carrier.detune,this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this._modulator=new ue({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new de({context:this.context,units:"positive",value:t.harmonicity}),this.modulationIndex=new de({context:this.context,units:"positive",value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Ct(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(ue.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){return this._modulator.restart(t),this._carrier.restart(t),this}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return ee(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Bi extends ve{constructor(){const t=tt(Bi.getDefaults(),arguments,["frequency","width"]);super(t),this.name="PulseOscillator",this._widthGate=new bt({context:this.context,gain:0}),this._thresh=new $s({context:this.context,mapping:o=>o<=0?-1:1}),this.width=new At({context:this.context,units:"audioRange",value:t.width}),this._triangle=new ue({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Ct(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(ve.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(t){t=this.toSeconds(t),this._triangle.start(t),this._widthGate.gain.setValueAtTime(1,t)}_stop(t){t=this.toSeconds(t),this._triangle.stop(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(0,t)}_restart(t){this._triangle.restart(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(1,t)}get phase(){return this._triangle.phase}set phase(t){this._triangle.phase=t}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(t){this._triangle.type=t}asArray(){return ee(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Ro extends ve{constructor(){const t=tt(Ro.getDefaults(),arguments,["frequency","type","spread"]);super(t),this.name="FatOscillator",this._oscillators=[],this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),this._spread=t.spread,this._type=t.type,this._phase=t.phase,this._partials=t.partials,this._partialCount=t.partialCount,this.count=t.count,Ct(this,["frequency","detune"])}static getDefaults(){return Object.assign(ue.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(t){t=this.toSeconds(t),this._forEach(o=>o.start(t))}_stop(t){t=this.toSeconds(t),this._forEach(o=>o.stop(t))}_restart(t){this._forEach(o=>o.restart(t))}_forEach(t){for(let o=0;o<this._oscillators.length;o++)t(this._oscillators[o],o)}get type(){return this._type}set type(t){this._type=t,this._forEach(o=>o.type=t)}get spread(){return this._spread}set spread(t){if(this._spread=t,this._oscillators.length>1){const o=-t/2,l=t/(this._oscillators.length-1);this._forEach((d,g)=>d.detune.value=o+l*g)}}get count(){return this._oscillators.length}set count(t){if(qe(t,1),this._oscillators.length!==t){this._forEach(o=>o.dispose()),this._oscillators=[];for(let o=0;o<t;o++){const l=new ue({context:this.context,volume:-6-1.1*t,type:this._type,phase:this._phase+o/t*360,partialCount:this._partialCount,onstop:o===0?()=>this.onstop(this):Dt});this.type==="custom"&&(l.partials=this._partials),this.frequency.connect(l.frequency),this.detune.connect(l.detune),l.detune.overridden=!1,l.connect(this.output),this._oscillators[o]=l}this.spread=this._spread,this.state==="started"&&this._forEach(o=>o.start())}}get phase(){return this._phase}set phase(t){this._phase=t,this._forEach((o,l)=>o.phase=this._phase+l/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(t){this._forEach(o=>o.baseType=t),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this._type="custom",this._forEach(o=>o.partials=t))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(t){this._partialCount=t,this._forEach(o=>o.partialCount=t),this._type=this._oscillators[0].type}asArray(){return ee(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(t=>t.dispose()),this}}class Do extends ve{constructor(){const t=tt(Do.getDefaults(),arguments,["frequency","modulationFrequency"]);super(t),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new de({context:this.context,value:2}),this._pulse=new Bi({context:this.context,frequency:t.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new ue({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Ct(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(ve.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(t){t=this.toSeconds(t),this._modulator.start(t),this._pulse.start(t)}_stop(t){t=this.toSeconds(t),this._modulator.stop(t),this._pulse.stop(t)}_restart(t){this._modulator.restart(t),this._pulse.restart(t)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(t){this._modulator.phase=t}asArray(){return ee(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const Wu={am:Io,fat:Ro,fm:Fi,oscillator:ue,pulse:Bi,pwm:Do};class pn extends ve{constructor(){const t=tt(pn.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OmniOscillator",this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),Ct(this,["frequency","detune"]),this.set(t)}static getDefaults(){return Object.assign(ue.getDefaults(),Fi.getDefaults(),Io.getDefaults(),Ro.getDefaults(),Bi.getDefaults(),Do.getDefaults())}_start(t){this._oscillator.start(t)}_stop(t){this._oscillator.stop(t)}_restart(t){return this._oscillator.restart(t),this}get type(){let t="";return["am","fm","fat"].some(o=>this._sourceType===o)&&(t=this._sourceType),t+this._oscillator.type}set type(t){t.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(3)):t==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):t==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=t)}get partials(){return this._oscillator.partials}set partials(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=t)}get partialCount(){return this._oscillator.partialCount}set partialCount(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=t)}set(t){return Reflect.has(t,"type")&&t.type&&(this.type=t.type),super.set(t),this}_createNewOscillator(t){if(t!==this._sourceType){this._sourceType=t;const o=Wu[t],l=this.now();if(this._oscillator){const d=this._oscillator;d.stop(l),this.context.setTimeout(()=>d.dispose(),this.blockTime)}this._oscillator=new o({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(l)}}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t}get sourceType(){return this._sourceType}set sourceType(t){let o="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(o=this._oscillator.type),t==="fm"?this.type="fm"+o:t==="am"?this.type="am"+o:t==="fat"?this.type="fat"+o:t==="oscillator"?this.type=o:t==="pulse"?this.type="pulse":t==="pwm"&&(this.type="pwm")}_getOscType(t,o){return t instanceof Wu[o]}get baseType(){return this._oscillator.baseType}set baseType(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||t==="pulse"||t==="pwm"||(this._oscillator.baseType=t)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(t){this._getOscType(this._oscillator,"fat")&&ds(t)&&(this._oscillator.count=t)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(t){this._getOscType(this._oscillator,"fat")&&ds(t)&&(this._oscillator.spread=t)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(t){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Fs(t)&&(this._oscillator.modulationType=t)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return ee(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}class Zn extends At{constructor(){super(tt(Zn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new bt({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,gs(this._constantSource,this._sum)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class mn extends ys{constructor(){const t=tt(mn.getDefaults(),arguments,["min","max"]);super(t),this.name="Scale",this._mult=this.input=new de({context:this.context,value:t.max-t.min}),this._add=this.output=new Zn({context:this.context,value:t.min}),this._min=t.min,this._max=t.max,this.input.connect(this.output)}static getDefaults(){return Object.assign(ys.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(t){this._min=t,this._setRange()}get max(){return this._max}set max(t){this._max=t,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class Kr extends ys{constructor(){super(tt(Kr.getDefaults(),arguments)),this.name="Zero",this._gain=new bt({context:this.context}),this.output=this._gain,this.input=void 0,ts(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),wl(this.context.getConstant(0),this._gain),this}}class es extends ot{constructor(){const t=tt(es.getDefaults(),arguments,["frequency","min","max"]);super(t),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=Et.prototype._fromType,this._toType=Et.prototype._toType,this._is=Et.prototype._is,this._clampValue=Et.prototype._clampValue,this._oscillator=new ue(t),this.frequency=this._oscillator.frequency,this._amplitudeGain=new bt({context:this.context,gain:t.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new At({context:this.context,units:"audioRange",value:0}),this._zeros=new Kr({context:this.context}),this._a2g=new Jr({context:this.context}),this._scaler=this.output=new mn({context:this.context,max:t.max,min:t.min}),this.units=t.units,this.min=t.min,this.max=t.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),Ct(this,["amplitude","frequency"]),this.phase=t.phase}static getDefaults(){return Object.assign(ue.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(0,t),this._oscillator.start(t),this}stop(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(this._stoppedValue,t),this._oscillator.stop(t),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(t){t=this._fromType(t),this._scaler.min=t}get max(){return this._toType(this._scaler.max)}set max(t){t=this._fromType(t),this._scaler.max=t}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(t){this._oscillator.partials=t,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t,this._setStoppedValue()}get units(){return this._units}set units(t){const o=this.min,l=this.max;this._units=t,this.min=o,this.max=l}get state(){return this._oscillator.state}connect(t,o,l){return(t instanceof Et||t instanceof At)&&(this.convert=t.convert,this.units=t.units),Eo(this,t,o,l),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}function Vu(p,t=1/0){const o=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(g){qe(g,p,t),o.set(this,g)}})}}function fn(p,t=1/0){const o=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(g){qe(this.toSeconds(g),p,t),o.set(this,g)}})}}class qi extends ve{constructor(){const t=tt(qi.getDefaults(),arguments,["url","onload"]);super(t),this.name="Player",this._activeSources=new Set,this._buffer=new $t({onload:this._onload.bind(this,t.onload),onerror:t.onerror,reverse:t.reverse,url:t.url}),this.autostart=t.autostart,this._loop=t.loop,this._loopStart=t.loopStart,this._loopEnd=t.loopEnd,this._playbackRate=t.playbackRate,this.fadeIn=t.fadeIn,this.fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ve.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Dt,onerror:Dt,playbackRate:1,reverse:!1})}load(t){return ee(this,void 0,void 0,function*(){return yield this._buffer.load(t),this._onload(),this})}_onload(t=Dt){t(),this.autostart&&this.start()}_onSourceEnd(t){this.onstop(this),this._activeSources.delete(t),this._activeSources.size!==0||this._synced||this._state.getValueAtTime(this.now())!=="started"||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(t,o,l){return super.start(t,o,l),this}_start(t,o,l){o=this._loop?Ms(o,this._loopStart):Ms(o,0);const d=this.toSeconds(o),g=l;l=Ms(l,Math.max(this._buffer.duration-d,0));let b=this.toSeconds(l);b/=this._playbackRate,t=this.toSeconds(t);const _=new In({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(t+b),this._state.setStateAtTime("stopped",t+b,{implicitEnd:!0})),this._activeSources.add(_),this._loop&&rs(g)?_.start(t,d):_.start(t,d,b-this.toSeconds(this.fadeOut))}_stop(t){const o=this.toSeconds(t);this._activeSources.forEach(l=>l.stop(o))}restart(t,o,l){return super.restart(t,o,l),this}_restart(t,o,l){var d;(d=[...this._activeSources].pop())===null||d===void 0||d.stop(t),this._start(t,o,l)}seek(t,o){const l=this.toSeconds(o);if(this._state.getValueAtTime(l)==="started"){const d=this.toSeconds(t);this._stop(l),this._start(l,d)}return this}setLoopPoints(t,o){return this.loopStart=t,this.loopEnd=o,this}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this.buffer.loaded&&qe(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(o=>{o.loopStart=t})}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this.buffer.loaded&&qe(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(o=>{o.loopEnd=t})}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._loop}set loop(t){if(this._loop!==t&&(this._loop=t,this._activeSources.forEach(o=>{o.loop=t}),t)){const o=this._state.getNextState("stopped",this.now());o&&this._state.cancel(o.time)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t;const o=this.now(),l=this._state.getNextState("stopped",o);l&&l.implicitEnd&&(this._state.cancel(l.time),this._activeSources.forEach(d=>d.cancelStop())),this._activeSources.forEach(d=>{d.playbackRate.setValueAtTime(t,o)})}get reverse(){return this._buffer.reverse}set reverse(t){this._buffer.reverse=t}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(t=>t.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}Bs([fn(0)],qi.prototype,"fadeIn",void 0),Bs([fn(0)],qi.prototype,"fadeOut",void 0);class Al extends ot{constructor(){const t=tt(Al.getDefaults(),arguments,["urls","onload"],"urls");super(t),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Ct(this,"volume"),this._buffers=new Di({urls:t.urls,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.mute=t.mute,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ve.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:Dt,onerror:Dt,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._players.forEach(o=>{o.fadeIn=t})}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._players.forEach(o=>{o.fadeOut=t})}get state(){return Array.from(this._players).some(([t,o])=>o.state==="started")?"started":"stopped"}has(t){return this._buffers.has(t)}player(t){if(wt(this.has(t),`No Player with the name ${t} exists on this object`),!this._players.has(t)){const o=new qi({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(t)}).connect(this.output);this._players.set(t,o)}return this._players.get(t)}get loaded(){return this._buffers.loaded}add(t,o,l){return wt(!this._buffers.has(t),"A buffer with that name already exists on this object"),this._buffers.add(t,o,l),this}stopAll(t){return this._players.forEach(o=>o.stop(t)),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach(t=>t.dispose()),this._buffers.dispose(),this}}class Ml extends ve{constructor(){const t=tt(Ml.getDefaults(),arguments,["url","onload"]);super(t),this.name="GrainPlayer",this._loopStart=0,this._loopEnd=0,this._activeSources=[],this.buffer=new $t({onload:t.onload,onerror:t.onerror,reverse:t.reverse,url:t.url}),this._clock=new Ri({context:this.context,callback:this._tick.bind(this),frequency:1/t.grainSize}),this._playbackRate=t.playbackRate,this._grainSize=t.grainSize,this._overlap=t.overlap,this.detune=t.detune,this.overlap=t.overlap,this.loop=t.loop,this.playbackRate=t.playbackRate,this.grainSize=t.grainSize,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.reverse=t.reverse,this._clock.on("stop",this._onstop.bind(this))}static getDefaults(){return Object.assign(ve.getDefaults(),{onload:Dt,onerror:Dt,overlap:.1,grainSize:.2,playbackRate:1,detune:0,loop:!1,loopStart:0,loopEnd:0,reverse:!1})}_start(t,o,l){o=Ms(o,0),o=this.toSeconds(o),t=this.toSeconds(t);const d=1/this._clock.frequency.getValueAtTime(t);this._clock.start(t,o/d),l&&this.stop(t+this.toSeconds(l))}restart(t,o,l){return super.restart(t,o,l),this}_restart(t,o,l){this._stop(t),this._start(t,o,l)}_stop(t){this._clock.stop(t)}_onstop(t){this._activeSources.forEach(o=>{o.fadeOut=0,o.stop(t)}),this.onstop(this)}_tick(t){const o=this._clock.getTicksAtTime(t),l=o*this._grainSize;if(this.log("offset",l),!this.loop&&l>this.buffer.duration)return void this.stop(t);const d=l<this._overlap?0:this._overlap,g=new In({context:this.context,url:this.buffer,fadeIn:d,fadeOut:this._overlap,loop:this.loop,loopStart:this._loopStart,loopEnd:this._loopEnd,playbackRate:Pi(this.detune/100)}).connect(this.output);g.start(t,this._grainSize*o),g.stop(t+this._grainSize/this.playbackRate),this._activeSources.push(g),g.onended=()=>{const b=this._activeSources.indexOf(g);b!==-1&&this._activeSources.splice(b,1)}}get playbackRate(){return this._playbackRate}set playbackRate(t){qe(t,.001),this._playbackRate=t,this.grainSize=this._grainSize}get loopStart(){return this._loopStart}set loopStart(t){this.buffer.loaded&&qe(this.toSeconds(t),0,this.buffer.duration),this._loopStart=this.toSeconds(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this.buffer.loaded&&qe(this.toSeconds(t),0,this.buffer.duration),this._loopEnd=this.toSeconds(t)}get reverse(){return this.buffer.reverse}set reverse(t){this.buffer.reverse=t}get grainSize(){return this._grainSize}set grainSize(t){this._grainSize=this.toSeconds(t),this._clock.frequency.setValueAtTime(this._playbackRate/this._grainSize,this.now())}get overlap(){return this._overlap}set overlap(t){const o=this.toSeconds(t);qe(o,0),this._overlap=o}get loaded(){return this.buffer.loaded}dispose(){return super.dispose(),this.buffer.dispose(),this._clock.dispose(),this._activeSources.forEach(t=>t.dispose()),this}}class Hu extends ys{constructor(){super(...arguments),this.name="Abs",this._abs=new $s({context:this.context,mapping:t=>Math.abs(t)<.001?0:Math.abs(t)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class Gu extends ys{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new $s({context:this.context,mapping:t=>2*Math.abs(t)-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class El extends ys{constructor(){super(...arguments),this.name="Negate",this._multiply=new de({context:this.context,value:-1}),this.input=this._multiply,this.output=this._multiply}dispose(){return super.dispose(),this._multiply.dispose(),this}}class Qn extends At{constructor(){super(tt(Qn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Subtract",this._sum=new bt({context:this.context}),this.input=this._sum,this.output=this._sum,this._neg=new El({context:this.context}),this.subtrahend=this._param,gs(this._constantSource,this._neg,this._sum)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._neg.dispose(),this._sum.dispose(),this}}class ta extends ys{constructor(){super(tt(ta.getDefaults(),arguments)),this.name="GreaterThanZero",this._thresh=this.output=new $s({context:this.context,length:127,mapping:t=>t<=0?0:1}),this._scale=this.input=new de({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class ea extends At{constructor(){const t=tt(ea.getDefaults(),arguments,["value"]);super(t),this.name="GreaterThan",this.override=!1,this._subtract=this.input=new Qn({context:this.context,value:t.value}),this._gtz=this.output=new ta({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,Ct(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class sa extends mn{constructor(){const t=tt(sa.getDefaults(),arguments,["min","max","exponent"]);super(t),this.name="ScaleExp",this.input=this._exp=new Ni({context:this.context,value:t.exponent}),this._exp.connect(this._mult)}static getDefaults(){return Object.assign(mn.getDefaults(),{exponent:1})}get exponent(){return this._exp.value}set exponent(t){this._exp.value=t}dispose(){return super.dispose(),this._exp.dispose(),this}}class Lg extends At{constructor(){const t=tt(At.getDefaults(),arguments,["value","units"]);super(t),this.name="SyncedSignal",this.override=!1,this._lastVal=t.value,this._synced=this.context.transport.scheduleRepeat(this._onTick.bind(this),"1i"),this._syncedCallback=this._anchorValue.bind(this),this.context.transport.on("start",this._syncedCallback),this.context.transport.on("pause",this._syncedCallback),this.context.transport.on("stop",this._syncedCallback),this._constantSource.disconnect(),this._constantSource.stop(0),this._constantSource=this.output=new Zr({context:this.context,offset:t.value,units:t.units}).start(0),this.setValueAtTime(t.value,0)}_onTick(t){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal!==o&&(this._lastVal=o,this._constantSource.offset.setValueAtTime(o,t))}_anchorValue(t){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal=o,this._constantSource.offset.cancelAndHoldAtTime(t),this._constantSource.offset.setValueAtTime(o,t)}getValueAtTime(t){const o=new Se(this.context,t).toSeconds();return super.getValueAtTime(o)}setValueAtTime(t,o){const l=new Se(this.context,o).toSeconds();return super.setValueAtTime(t,l),this}linearRampToValueAtTime(t,o){const l=new Se(this.context,o).toSeconds();return super.linearRampToValueAtTime(t,l),this}exponentialRampToValueAtTime(t,o){const l=new Se(this.context,o).toSeconds();return super.exponentialRampToValueAtTime(t,l),this}setTargetAtTime(t,o,l){const d=new Se(this.context,o).toSeconds();return super.setTargetAtTime(t,d,l),this}cancelScheduledValues(t){const o=new Se(this.context,t).toSeconds();return super.cancelScheduledValues(o),this}setValueCurveAtTime(t,o,l,d){const g=new Se(this.context,o).toSeconds();return l=this.toSeconds(l),super.setValueCurveAtTime(t,g,l,d),this}cancelAndHoldAtTime(t){const o=new Se(this.context,t).toSeconds();return super.cancelAndHoldAtTime(o),this}setRampPoint(t){const o=new Se(this.context,t).toSeconds();return super.setRampPoint(o),this}exponentialRampTo(t,o,l){const d=new Se(this.context,l).toSeconds();return super.exponentialRampTo(t,o,d),this}linearRampTo(t,o,l){const d=new Se(this.context,l).toSeconds();return super.linearRampTo(t,o,d),this}targetRampTo(t,o,l){const d=new Se(this.context,l).toSeconds();return super.targetRampTo(t,o,d),this}dispose(){return super.dispose(),this.context.transport.clear(this._synced),this.context.transport.off("start",this._syncedCallback),this.context.transport.off("pause",this._syncedCallback),this.context.transport.off("stop",this._syncedCallback),this._constantSource.dispose(),this}}class ze extends ot{constructor(){const t=tt(ze.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="Envelope",this._sig=new At({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=t.attack,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.attackCurve=t.attackCurve,this.releaseCurve=t.releaseCurve,this.decayCurve=t.decayCurve}static getDefaults(){return Object.assign(ot.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(t,o){if(Fs(t))return t;{let l;for(l in na)if(na[l][o]===t)return l;return t}}_setCurve(t,o,l){if(Fs(l)&&Reflect.has(na,l)){const d=na[l];cn(d)?t!=="_decayCurve"&&(this[t]=d[o]):this[t]=d}else{if(!Be(l)||t==="_decayCurve")throw new Error("Envelope: invalid curve: "+l);this[t]=l}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(t){this._setCurve("_attackCurve","In",t)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(t){this._setCurve("_releaseCurve","Out",t)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(t){this._setCurve("_decayCurve","Out",t)}triggerAttack(t,o=1){this.log("triggerAttack",t,o),t=this.toSeconds(t);let l=this.toSeconds(this.attack);const d=this.toSeconds(this.decay),g=this.getValueAtTime(t);if(g>0&&(l=(1-g)/(1/l)),l<this.sampleTime)this._sig.cancelScheduledValues(t),this._sig.setValueAtTime(o,t);else if(this._attackCurve==="linear")this._sig.linearRampTo(o,l,t);else if(this._attackCurve==="exponential")this._sig.targetRampTo(o,l,t);else{this._sig.cancelAndHoldAtTime(t);let b=this._attackCurve;for(let _=1;_<b.length;_++)if(b[_-1]<=g&&g<=b[_]){b=this._attackCurve.slice(_),b[0]=g;break}this._sig.setValueCurveAtTime(b,t,l,o)}if(d&&this.sustain<1){const b=o*this.sustain,_=t+l;this.log("decay",_),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(b,d+_):this._sig.exponentialApproachValueAtTime(b,_,d)}return this}triggerRelease(t){this.log("triggerRelease",t),t=this.toSeconds(t);const o=this.getValueAtTime(t);if(o>0){const l=this.toSeconds(this.release);l<this.sampleTime?this._sig.setValueAtTime(0,t):this._releaseCurve==="linear"?this._sig.linearRampTo(0,l,t):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,l,t):(wt(Be(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(t),this._sig.setValueCurveAtTime(this._releaseCurve,t,l,o))}return this}getValueAtTime(t){return this._sig.getValueAtTime(t)}triggerAttackRelease(t,o,l=1){return o=this.toSeconds(o),this.triggerAttack(o,l),this.triggerRelease(o+this.toSeconds(t)),this}cancel(t){return this._sig.cancelScheduledValues(this.toSeconds(t)),this}connect(t,o=0,l=0){return Eo(this,t,o,l),this}asArray(){return ee(this,arguments,void 0,function*(t=1024){const o=t/this.context.sampleRate,l=new Mi(1,o,this.context.sampleRate),d=this.toSeconds(this.attack)+this.toSeconds(this.decay),g=d+this.toSeconds(this.release),b=.1*g,_=g+b,C=new this.constructor(Object.assign(this.get(),{attack:o*this.toSeconds(this.attack)/_,decay:o*this.toSeconds(this.decay)/_,release:o*this.toSeconds(this.release)/_,context:l}));return C._sig.toDestination(),C.triggerAttackRelease(o*(d+b)/_,0),(yield l.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}Bs([fn(0)],ze.prototype,"attack",void 0),Bs([fn(0)],ze.prototype,"decay",void 0),Bs([Vu(0,1)],ze.prototype,"sustain",void 0),Bs([fn(0)],ze.prototype,"release",void 0);const na=(()=>{let t,o;const l=[];for(t=0;t<128;t++)l[t]=Math.sin(t/127*(Math.PI/2));const d=[];for(t=0;t<127;t++){o=t/127;const P=Math.sin(o*(2*Math.PI)*6.4-Math.PI/2)+1;d[t]=P/10+.83*o}d[127]=1;const g=[];for(t=0;t<128;t++)g[t]=Math.ceil(t/127*5)/5;const b=[];for(t=0;t<128;t++)o=t/127,b[t]=.5*(1-Math.cos(Math.PI*o));const _=[];for(t=0;t<128;t++){o=t/127;const P=4*Math.pow(o,3)+.2,k=Math.cos(P*Math.PI*2*o);_[t]=Math.abs(k*(1-o))}function C(P){const k=new Array(P.length);for(let O=0;O<P.length;O++)k[O]=1-P[O];return k}return{bounce:{In:C(_),Out:_},cosine:{In:l,Out:(T=l,T.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:d,Out:C(d)},sine:{In:b,Out:C(b)},step:{In:g,Out:C(g)}};var T})();class Es extends ot{constructor(){const t=tt(Es.getDefaults(),arguments);super(t),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=o=>this._original_triggerRelease(o),this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Ct(this,"volume")}static getDefaults(){return Object.assign(ot.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let t=!1;return this._synced||(this._synced=!0,t=!0),t}_syncMethod(t,o){const l=this["_original_"+t]=this[t];this[t]=(...d)=>{const g=d[o],b=this.context.transport.schedule(_=>{d[o]=_,l.apply(this,d)},g);this._scheduledEvents.push(b)}}unsync(){return this._scheduledEvents.forEach(t=>this.context.transport.clear(t)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(t,o,l,d){const g=this.toSeconds(l),b=this.toSeconds(o);return this.triggerAttack(t,g,d),this.triggerRelease(g+b),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class We extends Es{constructor(){const t=tt(We.getDefaults(),arguments);super(t),this.portamento=t.portamento,this.onsilence=t.onsilence}static getDefaults(){return Object.assign(Es.getDefaults(),{detune:0,onsilence:Dt,portamento:0})}triggerAttack(t,o,l=1){this.log("triggerAttack",t,o,l);const d=this.toSeconds(o);return this._triggerEnvelopeAttack(d,l),this.setNote(t,d),this}triggerRelease(t){this.log("triggerRelease",t);const o=this.toSeconds(t);return this._triggerEnvelopeRelease(o),this}setNote(t,o){const l=this.toSeconds(o),d=t instanceof Ke?t.toFrequency():t;if(this.portamento>0&&this.getLevelAtTime(l)>.05){const g=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(d,g,l)}else this.frequency.setValueAtTime(d,l);return this}}Bs([fn(0)],We.prototype,"portamento",void 0);class $i extends ze{constructor(){super(tt($i.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new bt({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Dn extends We{constructor(){const t=tt(Dn.getDefaults(),arguments);super(t),this.name="Synth",this.oscillator=new pn(Object.assign({context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)},t.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new $i(Object.assign({context:this.context},t.envelope)),this.oscillator.chain(this.envelope,this.output),Ct(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(We.getDefaults(),{envelope:Object.assign($e(ze.getDefaults(),Object.keys(ot.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign($e(pn.getDefaults(),[...Object.keys(ve.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(t,o){if(this.envelope.triggerAttack(t,o),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class Oo extends We{constructor(){const t=tt(Oo.getDefaults(),arguments);super(t),this.name="ModulationSynth",this._carrier=new Dn({context:this.context,oscillator:t.oscillator,envelope:t.envelope,onsilence:()=>this.onsilence(this),volume:-10}),this._modulator=new Dn({context:this.context,oscillator:t.modulation,envelope:t.modulationEnvelope,volume:-10}),this.oscillator=this._carrier.oscillator,this.envelope=this._carrier.envelope,this.modulation=this._modulator.oscillator,this.modulationEnvelope=this._modulator.envelope,this.frequency=new At({context:this.context,units:"frequency"}),this.detune=new At({context:this.context,value:t.detune,units:"cents"}),this.harmonicity=new de({context:this.context,value:t.harmonicity,minValue:0}),this._modulationNode=new bt({context:this.context,gain:0}),Ct(this,["frequency","harmonicity","oscillator","envelope","modulation","modulationEnvelope","detune"])}static getDefaults(){return Object.assign(We.getDefaults(),{harmonicity:3,oscillator:Object.assign($e(pn.getDefaults(),[...Object.keys(ve.getDefaults()),"frequency","detune"]),{type:"sine"}),envelope:Object.assign($e(ze.getDefaults(),Object.keys(ot.getDefaults())),{attack:.01,decay:.01,sustain:1,release:.5}),modulation:Object.assign($e(pn.getDefaults(),[...Object.keys(ve.getDefaults()),"frequency","detune"]),{type:"square"}),modulationEnvelope:Object.assign($e(ze.getDefaults(),Object.keys(ot.getDefaults())),{attack:.5,decay:0,sustain:1,release:.5})})}_triggerEnvelopeAttack(t,o){this._carrier._triggerEnvelopeAttack(t,o),this._modulator._triggerEnvelopeAttack(t,o)}_triggerEnvelopeRelease(t){return this._carrier._triggerEnvelopeRelease(t),this._modulator._triggerEnvelopeRelease(t),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this._carrier.dispose(),this._modulator.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._modulationNode.dispose(),this}}class Pl extends Oo{constructor(){super(tt(Pl.getDefaults(),arguments)),this.name="AMSynth",this._modulationScale=new Jr({context:this.context}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output)}dispose(){return super.dispose(),this._modulationScale.dispose(),this}}class No extends ot{constructor(){const t=tt(No.getDefaults(),arguments,["frequency","type"]);super(t),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new Et({context:this.context,units:"number",value:t.Q,param:this._filter.Q}),this.frequency=new Et({context:this.context,units:"frequency",value:t.frequency,param:this._filter.frequency}),this.detune=new Et({context:this.context,units:"cents",value:t.detune,param:this._filter.detune}),this.gain=new Et({context:this.context,units:"decibels",convert:!1,value:t.gain,param:this._filter.gain}),this.type=t.type}static getDefaults(){return Object.assign(ot.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(t){wt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._filter.type=t}getFrequencyResponse(t=128){const o=new Float32Array(t);for(let b=0;b<t;b++){const _=19980*Math.pow(b/t,2)+20;o[b]=_}const l=new Float32Array(t),d=new Float32Array(t),g=this.context.createBiquadFilter();return g.type=this.type,g.Q.value=this.Q.value,g.frequency.value=this.frequency.value,g.gain.value=this.gain.value,g.getFrequencyResponse(o,l,d),l}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class bs extends ot{constructor(){const t=tt(bs.getDefaults(),arguments,["frequency","type","rolloff"]);super(t),this.name="Filter",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this._filters=[],this._filters=[],this.Q=new At({context:this.context,units:"positive",value:t.Q}),this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),this.gain=new At({context:this.context,units:"decibels",convert:!1,value:t.gain}),this._type=t.type,this.rolloff=t.rolloff,Ct(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(ot.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(t){wt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._type=t,this._filters.forEach(o=>o.type=t)}get rolloff(){return this._rolloff}set rolloff(t){const o=ds(t)?t:parseInt(t,10),l=[-12,-24,-48,-96];let d=l.indexOf(o);wt(d!==-1,`rolloff can only be ${l.join(", ")}`),d+=1,this._rolloff=o,this.input.disconnect(),this._filters.forEach(g=>g.disconnect()),this._filters=new Array(d);for(let g=0;g<d;g++){const b=new No({context:this.context});b.type=this._type,this.frequency.connect(b.frequency),this.detune.connect(b.detune),this.Q.connect(b.Q),this.gain.connect(b.gain),this._filters[g]=b}this._internalChannels=this._filters,gs(this.input,...this._internalChannels,this.output)}getFrequencyResponse(t=128){const o=new No({frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),l=new Float32Array(t).map(()=>1);return this._filters.forEach(()=>{o.getFrequencyResponse(t).forEach((d,g)=>l[g]*=d)}),o.dispose(),l}dispose(){return super.dispose(),this._filters.forEach(t=>{t.dispose()}),To(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class Lo extends ze{constructor(){const t=tt(Lo.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="FrequencyEnvelope",this._octaves=t.octaves,this._baseFrequency=this.toFrequency(t.baseFrequency),this._exponent=this.input=new Ni({context:this.context,value:t.exponent}),this._scale=this.output=new mn({context:this.context,min:this._baseFrequency,max:this._baseFrequency*Math.pow(2,this._octaves)}),this._sig.chain(this._exponent,this._scale)}static getDefaults(){return Object.assign(ze.getDefaults(),{baseFrequency:200,exponent:1,octaves:4})}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){const o=this.toFrequency(t);qe(o,0),this._baseFrequency=o,this._scale.min=this._baseFrequency,this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._scale.max=this._baseFrequency*Math.pow(2,t)}get exponent(){return this._exponent.value}set exponent(t){this._exponent.value=t}dispose(){return super.dispose(),this._exponent.dispose(),this._scale.dispose(),this}}class Jn extends We{constructor(){const t=tt(Jn.getDefaults(),arguments);super(t),this.name="MonoSynth",this.oscillator=new pn(Object.assign(t.oscillator,{context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)})),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.filter=new bs(Object.assign(t.filter,{context:this.context})),this.filterEnvelope=new Lo(Object.assign(t.filterEnvelope,{context:this.context})),this.envelope=new $i(Object.assign(t.envelope,{context:this.context})),this.oscillator.chain(this.filter,this.envelope,this.output),this.filterEnvelope.connect(this.filter.frequency),Ct(this,["oscillator","frequency","detune","filter","filterEnvelope","envelope"])}static getDefaults(){return Object.assign(We.getDefaults(),{envelope:Object.assign($e(ze.getDefaults(),Object.keys(ot.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.9}),filter:Object.assign($e(bs.getDefaults(),Object.keys(ot.getDefaults())),{Q:1,rolloff:-12,type:"lowpass"}),filterEnvelope:Object.assign($e(Lo.getDefaults(),Object.keys(ot.getDefaults())),{attack:.6,baseFrequency:200,decay:.2,exponent:2,octaves:3,release:2,sustain:.5}),oscillator:Object.assign($e(pn.getDefaults(),Object.keys(ve.getDefaults())),{type:"sawtooth"})})}_triggerEnvelopeAttack(t,o=1){if(this.envelope.triggerAttack(t,o),this.filterEnvelope.triggerAttack(t),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.filterEnvelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this.filterEnvelope.dispose(),this.filter.dispose(),this}}class kl extends We{constructor(){const t=tt(kl.getDefaults(),arguments);super(t),this.name="DuoSynth",this.voice0=new Jn(Object.assign(t.voice0,{context:this.context,onsilence:()=>this.onsilence(this)})),this.voice1=new Jn(Object.assign(t.voice1,{context:this.context})),this.harmonicity=new de({context:this.context,units:"positive",value:t.harmonicity}),this._vibrato=new es({frequency:t.vibratoRate,context:this.context,min:-50,max:50}),this._vibrato.start(),this.vibratoRate=this._vibrato.frequency,this._vibratoGain=new bt({context:this.context,units:"normalRange",gain:t.vibratoAmount}),this.vibratoAmount=this._vibratoGain.gain,this.frequency=new At({context:this.context,units:"frequency",value:440}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),this.frequency.connect(this.voice0.frequency),this.frequency.chain(this.harmonicity,this.voice1.frequency),this._vibrato.connect(this._vibratoGain),this._vibratoGain.fan(this.voice0.detune,this.voice1.detune),this.detune.fan(this.voice0.detune,this.voice1.detune),this.voice0.connect(this.output),this.voice1.connect(this.output),Ct(this,["voice0","voice1","frequency","vibratoAmount","vibratoRate"])}getLevelAtTime(t){return t=this.toSeconds(t),this.voice0.envelope.getValueAtTime(t)+this.voice1.envelope.getValueAtTime(t)}static getDefaults(){return As(We.getDefaults(),{vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:As($e(Jn.getDefaults(),Object.keys(We.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}}),voice1:As($e(Jn.getDefaults(),Object.keys(We.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}})})}_triggerEnvelopeAttack(t,o){this.voice0._triggerEnvelopeAttack(t,o),this.voice1._triggerEnvelopeAttack(t,o)}_triggerEnvelopeRelease(t){return this.voice0._triggerEnvelopeRelease(t),this.voice1._triggerEnvelopeRelease(t),this}dispose(){return super.dispose(),this.voice0.dispose(),this.voice1.dispose(),this.frequency.dispose(),this.detune.dispose(),this._vibrato.dispose(),this.vibratoRate.dispose(),this._vibratoGain.dispose(),this.harmonicity.dispose(),this}}class Il extends Oo{constructor(){const t=tt(Il.getDefaults(),arguments);super(t),this.name="FMSynth",this.modulationIndex=new de({context:this.context,value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output)}static getDefaults(){return Object.assign(Oo.getDefaults(),{modulationIndex:10})}dispose(){return super.dispose(),this.modulationIndex.dispose(),this}}const ju=[1,1.483,1.932,2.546,2.63,3.897];class Rl extends We{constructor(){const t=tt(Rl.getDefaults(),arguments);super(t),this.name="MetalSynth",this._oscillators=[],this._freqMultipliers=[],this.detune=new At({context:this.context,units:"cents",value:t.detune}),this.frequency=new At({context:this.context,units:"frequency"}),this._amplitude=new bt({context:this.context,gain:0}).connect(this.output),this._highpass=new bs({Q:0,context:this.context,type:"highpass"}).connect(this._amplitude);for(let o=0;o<ju.length;o++){const l=new Fi({context:this.context,harmonicity:t.harmonicity,modulationIndex:t.modulationIndex,modulationType:"square",onstop:o===0?()=>this.onsilence(this):Dt,type:"square"});l.connect(this._highpass),this._oscillators[o]=l;const d=new de({context:this.context,value:ju[o]});this._freqMultipliers[o]=d,this.frequency.chain(d,l.frequency),this.detune.connect(l.detune)}this._filterFreqScaler=new mn({context:this.context,max:7e3,min:this.toFrequency(t.resonance)}),this.envelope=new ze({attack:t.envelope.attack,attackCurve:"linear",context:this.context,decay:t.envelope.decay,release:t.envelope.release,sustain:0}),this.envelope.chain(this._filterFreqScaler,this._highpass.frequency),this.envelope.connect(this._amplitude.gain),this._octaves=t.octaves,this.octaves=t.octaves}static getDefaults(){return As(We.getDefaults(),{envelope:Object.assign($e(ze.getDefaults(),Object.keys(ot.getDefaults())),{attack:.001,decay:1.4,release:.2}),harmonicity:5.1,modulationIndex:32,octaves:1.5,resonance:4e3})}_triggerEnvelopeAttack(t,o=1){return this.envelope.triggerAttack(t,o),this._oscillators.forEach(l=>l.start(t)),this.envelope.sustain===0&&this._oscillators.forEach(l=>{l.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay))}),this}_triggerEnvelopeRelease(t){return this.envelope.triggerRelease(t),this._oscillators.forEach(o=>o.stop(t+this.toSeconds(this.envelope.release))),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}get modulationIndex(){return this._oscillators[0].modulationIndex.value}set modulationIndex(t){this._oscillators.forEach(o=>o.modulationIndex.value=t)}get harmonicity(){return this._oscillators[0].harmonicity.value}set harmonicity(t){this._oscillators.forEach(o=>o.harmonicity.value=t)}get resonance(){return this._filterFreqScaler.min}set resonance(t){this._filterFreqScaler.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._filterFreqScaler.max=this._filterFreqScaler.min*Math.pow(2,t)}dispose(){return super.dispose(),this._oscillators.forEach(t=>t.dispose()),this._freqMultipliers.forEach(t=>t.dispose()),this.frequency.dispose(),this.detune.dispose(),this._filterFreqScaler.dispose(),this._amplitude.dispose(),this.envelope.dispose(),this._highpass.dispose(),this}}class Fo extends Dn{constructor(){const t=tt(Fo.getDefaults(),arguments);super(t),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=t.pitchDecay,this.octaves=t.octaves,Ct(this,["oscillator","envelope"])}static getDefaults(){return As(We.getDefaults(),Dn.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(t,o){const l=this.toSeconds(o),d=this.toFrequency(t instanceof Ke?t.toFrequency():t),g=d*this.octaves;return this.oscillator.frequency.setValueAtTime(g,l),this.oscillator.frequency.exponentialRampToValueAtTime(d,l+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}Bs([Vu(0)],Fo.prototype,"octaves",void 0),Bs([fn(0)],Fo.prototype,"pitchDecay",void 0);class Dl extends Es{constructor(){const t=tt(Dl.getDefaults(),arguments);super(t),this.name="NoiseSynth",this.noise=new Rn(Object.assign({context:this.context},t.noise)),this.envelope=new $i(Object.assign({context:this.context},t.envelope)),this.noise.chain(this.envelope,this.output)}static getDefaults(){return Object.assign(Es.getDefaults(),{envelope:Object.assign($e(ze.getDefaults(),Object.keys(ot.getDefaults())),{decay:.1,sustain:0}),noise:Object.assign($e(Rn.getDefaults(),Object.keys(ve.getDefaults())),{type:"white"})})}triggerAttack(t,o=1){return t=this.toSeconds(t),this.envelope.triggerAttack(t,o),this.noise.start(t),this.envelope.sustain===0&&this.noise.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay)),this}triggerRelease(t){return t=this.toSeconds(t),this.envelope.triggerRelease(t),this.noise.stop(t+this.toSeconds(this.envelope.release)),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",0),this._syncMethod("triggerRelease",0)),this}triggerAttackRelease(t,o,l=1){return o=this.toSeconds(o),t=this.toSeconds(t),this.triggerAttack(o,l),this.triggerRelease(o+t),this}dispose(){return super.dispose(),this.noise.dispose(),this.envelope.dispose(),this}}const Ol=new Set;function Nl(p){Ol.add(p)}function Xu(p,t){const o=`registerProcessor("${p}", ${t})`;Ol.add(o)}class Ll extends ot{constructor(t){super(t),this.name="ToneAudioWorklet",this.workletOptions={},this.onprocessorerror=Dt;const o=URL.createObjectURL(new Blob([Array.from(Ol).join(`
`)],{type:"text/javascript"})),l=this._audioWorkletName();this._dummyGain=this.context.createGain(),this._dummyParam=this._dummyGain.gain,this.context.addAudioWorkletModule(o).then(()=>{this.disposed||(this._worklet=this.context.createAudioWorkletNode(l,this.workletOptions),this._worklet.onprocessorerror=this.onprocessorerror.bind(this),this.onReady(this._worklet))})}dispose(){return super.dispose(),this._dummyGain.disconnect(),this._worklet&&(this._worklet.port.postMessage("dispose"),this._worklet.disconnect()),this}}Nl(`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`),Nl(`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`),Nl(`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`);const Uu="feedback-comb-filter";Xu(Uu,`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`);class Bo extends Ll{constructor(){const t=tt(Bo.getDefaults(),arguments,["delayTime","resonance"]);super(t),this.name="FeedbackCombFilter",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this.delayTime=new Et({context:this.context,value:t.delayTime,units:"time",minValue:0,maxValue:1,param:this._dummyParam,swappable:!0}),this.resonance=new Et({context:this.context,value:t.resonance,units:"normalRange",param:this._dummyParam,swappable:!0}),Ct(this,["resonance","delayTime"])}_audioWorkletName(){return Uu}static getDefaults(){return Object.assign(ot.getDefaults(),{delayTime:.1,resonance:.5})}onReady(t){gs(this.input,t,this.output);const o=t.parameters.get("delayTime");this.delayTime.setParam(o);const l=t.parameters.get("feedback");this.resonance.setParam(l)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.delayTime.dispose(),this.resonance.dispose(),this}}class qo extends ot{constructor(){const t=tt(qo.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OnePoleFilter",this._frequency=t.frequency,this._type=t.type,this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this._createFilter()}static getDefaults(){return Object.assign(ot.getDefaults(),{frequency:880,type:"lowpass"})}_createFilter(){const t=this._filter,o=this.toFrequency(this._frequency),l=1/(2*Math.PI*o);if(this._type==="lowpass"){const d=1/(l*this.context.sampleRate),g=d-1;this._filter=this.context.createIIRFilter([d,0],[1,g])}else{const d=1/(l*this.context.sampleRate)-1;this._filter=this.context.createIIRFilter([1,-1],[1,d])}this.input.chain(this._filter,this.output),t&&this.context.setTimeout(()=>{this.disposed||(this.input.disconnect(t),t.disconnect())},this.blockTime)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._createFilter()}get type(){return this._type}set type(t){this._type=t,this._createFilter()}getFrequencyResponse(t=128){const o=new Float32Array(t);for(let g=0;g<t;g++){const b=19980*Math.pow(g/t,2)+20;o[g]=b}const l=new Float32Array(t),d=new Float32Array(t);return this._filter.getFrequencyResponse(o,l,d),l}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this._filter.disconnect(),this}}class $o extends ot{constructor(){const t=tt($o.getDefaults(),arguments,["delayTime","resonance","dampening"]);super(t),this.name="LowpassCombFilter",this._combFilter=this.output=new Bo({context:this.context,delayTime:t.delayTime,resonance:t.resonance}),this.delayTime=this._combFilter.delayTime,this.resonance=this._combFilter.resonance,this._lowpass=this.input=new qo({context:this.context,frequency:t.dampening,type:"lowpass"}),this._lowpass.connect(this._combFilter)}static getDefaults(){return Object.assign(ot.getDefaults(),{dampening:3e3,delayTime:.1,resonance:.5})}get dampening(){return this._lowpass.frequency}set dampening(t){this._lowpass.frequency=t}dispose(){return super.dispose(),this._combFilter.dispose(),this._lowpass.dispose(),this}}class Fl extends Es{constructor(){const t=tt(Fl.getDefaults(),arguments);super(t),this.name="PluckSynth",this._noise=new Rn({context:this.context,type:"pink"}),this.attackNoise=t.attackNoise,this._lfcf=new $o({context:this.context,dampening:t.dampening,resonance:t.resonance}),this.resonance=t.resonance,this.release=t.release,this._noise.connect(this._lfcf),this._lfcf.connect(this.output)}static getDefaults(){return As(Es.getDefaults(),{attackNoise:1,dampening:4e3,resonance:.7,release:1})}get dampening(){return this._lfcf.dampening}set dampening(t){this._lfcf.dampening=t}triggerAttack(t,o){const l=this.toFrequency(t);o=this.toSeconds(o);const d=1/l;return this._lfcf.delayTime.setValueAtTime(d,o),this._noise.start(o),this._noise.stop(o+d*this.attackNoise),this._lfcf.resonance.cancelScheduledValues(o),this._lfcf.resonance.setValueAtTime(this.resonance,o),this}triggerRelease(t){return this._lfcf.resonance.linearRampTo(0,this.release,t),this}dispose(){return super.dispose(),this._noise.dispose(),this._lfcf.dispose(),this}}class Bl extends Es{constructor(){const t=tt(Bl.getDefaults(),arguments,["voice","options"]);super(t),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=d=>this.releaseAll(d),wt(!ds(t.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const o=t.voice.getDefaults();this.options=Object.assign(o,t.options),this.voice=t.voice,this.maxPolyphony=t.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const l=this._voices.indexOf(this._dummyVoice);this._voices.splice(l,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Es.getDefaults(),{maxPolyphony:32,options:{},voice:Dn})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(t){this._availableVoices.push(t);const o=this._activeVoices.findIndex(l=>l.voice===t);this._activeVoices.splice(o,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const t=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return wt(t instanceof We,"Voice must extend Monophonic class"),t.connect(this.output),this._voices.push(t),t}xi("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(.95*this._averageActiveVoices,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const t=this._availableVoices.shift(),o=this._voices.indexOf(t);this._voices.splice(o,1),this.context.isOffline||t.dispose()}}_triggerAttack(t,o,l){t.forEach(d=>{const g=new Oi(this.context,d).toMidi(),b=this._getNextAvailableVoice();b&&(b.triggerAttack(d,o,l),this._activeVoices.push({midi:g,voice:b,released:!1}),this.log("triggerAttack",d,o))})}_triggerRelease(t,o){t.forEach(l=>{const d=new Oi(this.context,l).toMidi(),g=this._activeVoices.find(({midi:b,released:_})=>b===d&&!_);g&&(g.voice.triggerRelease(o),g.released=!0,this.log("triggerRelease",l,o))})}_scheduleEvent(t,o,l,d){wt(!this.disposed,"Synth was already disposed"),l<=this.now()?t==="attack"?this._triggerAttack(o,l,d):this._triggerRelease(o,l):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(t,o,l,d)},l-this.now())}triggerAttack(t,o,l){Array.isArray(t)||(t=[t]);const d=this.toSeconds(o);return this._scheduleEvent("attack",t,d,l),this}triggerRelease(t,o){Array.isArray(t)||(t=[t]);const l=this.toSeconds(o);return this._scheduleEvent("release",t,l),this}triggerAttackRelease(t,o,l,d){const g=this.toSeconds(l);if(this.triggerAttack(t,g,d),Be(o)){wt(Be(t),"If the duration is an array, the notes must also be an array");for(let b=0;b<t.length;b++){const _=o[Math.min(b,o.length-1)],C=this.toSeconds(_);wt(C>0,"The duration must be greater than 0"),this.triggerRelease(t[b],g+C)}}else{const b=this.toSeconds(o);wt(b>0,"The duration must be greater than 0"),this.triggerRelease(t,g+b)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(t){const o=$e(t,["onsilence","context"]);return this.options=As(this.options,o),this._voices.forEach(l=>l.set(o)),this._dummyVoice.set(o),this}get(){return this._dummyVoice.get()}releaseAll(t){const o=this.toSeconds(t);return this._activeVoices.forEach(({voice:l})=>{l.triggerRelease(o)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(t=>t.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class zo extends Es{constructor(){const t=tt(zo.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(t),this.name="Sampler",this._activeSources=new Map;const o={};Object.keys(t.urls).forEach(l=>{const d=parseInt(l,10);if(wt(Co(l)||ds(d)&&isFinite(d),`url key is neither a note or midi pitch: ${l}`),Co(l)){const g=new Ke(this.context,l).toMidi();o[g]=t.urls[l]}else ds(d)&&isFinite(d)&&(o[d]=t.urls[d])}),this._buffers=new Di({urls:o,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.attack=t.attack,this.release=t.release,this.curve=t.curve,this._buffers.loaded&&Promise.resolve().then(t.onload)}static getDefaults(){return Object.assign(Es.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Dt,onerror:Dt,release:.1,urls:{}})}_findClosest(t){let o=0;for(;o<96;){if(this._buffers.has(t+o))return-o;if(this._buffers.has(t-o))return o;o++}throw new Error(`No available buffers for note: ${t}`)}triggerAttack(t,o,l=1){return this.log("triggerAttack",t,o,l),Array.isArray(t)||(t=[t]),t.forEach(d=>{const g=qu(new Ke(this.context,d).toFrequency()),b=Math.round(g),_=g-b,C=this._findClosest(b),T=b-C,P=this._buffers.get(T),k=Pi(C+_),O=new In({url:P,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:k}).connect(this.output);O.start(o,0,P.duration/k,l),Be(this._activeSources.get(b))||this._activeSources.set(b,[]),this._activeSources.get(b).push(O),O.onended=()=>{if(this._activeSources&&this._activeSources.has(b)){const N=this._activeSources.get(b),$=N.indexOf(O);$!==-1&&N.splice($,1)}}}),this}triggerRelease(t,o){return this.log("triggerRelease",t,o),Array.isArray(t)||(t=[t]),t.forEach(l=>{const d=new Ke(this.context,l).toMidi();if(this._activeSources.has(d)&&this._activeSources.get(d).length){const g=this._activeSources.get(d);o=this.toSeconds(o),g.forEach(b=>{b.stop(o)}),this._activeSources.set(d,[])}}),this}releaseAll(t){const o=this.toSeconds(t);return this._activeSources.forEach(l=>{for(;l.length;)l.shift().stop(o)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(t,o,l,d=1){const g=this.toSeconds(l);return this.triggerAttack(t,g,d),Be(o)?(wt(Be(t),"notes must be an array when duration is array"),t.forEach((b,_)=>{const C=o[Math.min(_,o.length-1)];this.triggerRelease(b,g+this.toSeconds(C))})):this.triggerRelease(t,g+this.toSeconds(o)),this}add(t,o,l){if(wt(Co(t)||isFinite(t),`note must be a pitch or midi: ${t}`),Co(t)){const d=new Ke(this.context,t).toMidi();this._buffers.add(d,o,l)}else this._buffers.add(t,o,l);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(t=>{t.forEach(o=>o.dispose())}),this._activeSources.clear(),this}}Bs([fn(0)],zo.prototype,"attack",void 0),Bs([fn(0)],zo.prototype,"release",void 0);class Ys extends Ne{constructor(){const t=tt(Ys.getDefaults(),arguments,["callback","value"]);super(t),this.name="ToneEvent",this._state=new ki("stopped"),this._startOffset=0,this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Ne.getDefaults(),{callback:Dt,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,o=>{let l;if(o.state==="started"){o.id!==-1&&this.context.transport.clear(o.id);const d=o.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||ds(this._loop)&&this._loop>1){l=1/0,ds(this._loop)&&(l=this._loop*this._getLoopDuration());const g=this._state.getAfter(d);g!==null&&(l=Math.min(l,g.time-d)),l!==1/0&&(l=new he(this.context,l));const b=new he(this.context,this._getLoopDuration());o.id=this.context.transport.scheduleRepeat(this._tick.bind(this),b,new he(this.context,d),l)}else o.id=this.context.transport.schedule(this._tick.bind(this),new he(this.context,d))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const o=this.toTicks(t);return this._state.getValueAtTime(o)==="stopped"&&(this._state.add({id:-1,state:"started",time:o}),this._rescheduleEvents(o)),this}stop(t){this.cancel(t);const o=this.toTicks(t);if(this._state.getValueAtTime(o)==="started"){this._state.setStateAtTime("stopped",o,{id:-1});const l=this._state.getBefore(o);let d=o;l!==null&&(d=l.time),this._rescheduleEvents(d)}return this}cancel(t){t=Ms(t,-1/0);const o=this.toTicks(t);return this._state.forEachFrom(o,l=>{this.context.transport.clear(l.id)}),this._state.cancel(o),this}_tick(t){const o=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(o)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let l=.02;ul(this.humanize)||(l=this.toSeconds(this.humanize)),t+=(2*Math.random()-1)*l}this.callback(t,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new he(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new he(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,o=this._state.get(t);if(o!==null&&o.state==="started"){const l=this._getLoopDuration();return(t-o.time)%l/l}return 0}return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class Wo extends Ne{constructor(){const t=tt(Wo.getDefaults(),arguments,["callback","interval"]);super(t),this.name="Loop",this._event=new Ys({context:this.context,callback:this._tick.bind(this),loop:!0,loopEnd:t.interval,playbackRate:t.playbackRate,probability:t.probability,humanize:t.humanize}),this.callback=t.callback,this.iterations=t.iterations}static getDefaults(){return Object.assign(Ne.getDefaults(),{interval:"4n",callback:Dt,playbackRate:1,iterations:1/0,probability:1,mute:!1,humanize:!1})}start(t){return this._event.start(t),this}stop(t){return this._event.stop(t),this}cancel(t){return this._event.cancel(t),this}_tick(t){this.callback(t)}get state(){return this._event.state}get progress(){return this._event.progress}get interval(){return this._event.loopEnd}set interval(t){this._event.loopEnd=t}get playbackRate(){return this._event.playbackRate}set playbackRate(t){this._event.playbackRate=t}get humanize(){return this._event.humanize}set humanize(t){this._event.humanize=t}get probability(){return this._event.probability}set probability(t){this._event.probability=t}get mute(){return this._event.mute}set mute(t){this._event.mute=t}get iterations(){return this._event.loop===!0?1/0:this._event.loop}set iterations(t){this._event.loop=t===1/0||t}dispose(){return super.dispose(),this._event.dispose(),this}}class Vo extends Ys{constructor(){const t=tt(Vo.getDefaults(),arguments,["callback","events"]);super(t),this.name="Part",this._state=new ki("stopped"),this._events=new Set,this._state.increasing=!0,t.events.forEach(o=>{Be(o)?this.add(o[0],o[1]):this.add(o)})}static getDefaults(){return Object.assign(Ys.getDefaults(),{events:[]})}start(t,o){const l=this.toTicks(t);if(this._state.getValueAtTime(l)!=="started"){o=Ms(o,this._loop?this._loopStart:0),o=this._loop?Ms(o,this._loopStart):Ms(o,0);const d=this.toTicks(o);this._state.add({id:-1,offset:d,state:"started",time:l}),this._forEach(g=>{this._startNote(g,l,d)})}return this}_startNote(t,o,l){o-=l,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<l&&(o+=this._getLoopDuration()),t.start(new he(this.context,o))):t.startOffset<this._loopStart&&t.startOffset>=l&&(t.loop=!1,t.start(new he(this.context,o))):t.startOffset>=l&&t.start(new he(this.context,o))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(o=>{o.startOffset+=this._startOffset})}stop(t){const o=this.toTicks(t);return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._forEach(l=>{l.stop(t)}),this}at(t,o){const l=new Se(this.context,t).toTicks(),d=new he(this.context,1).toSeconds(),g=this._events.values();let b=g.next();for(;!b.done;){const _=b.value;if(Math.abs(l-_.startOffset)<d)return It(o)&&(_.value=o),_;b=g.next()}return It(o)?(this.add(t,o),this.at(t)):null}add(t,o){t instanceof Object&&Reflect.has(t,"time")&&(t=(o=t).time);const l=this.toTicks(t);let d;return o instanceof Ys?(d=o,d.callback=this._tick.bind(this)):d=new Ys({callback:this._tick.bind(this),context:this.context,value:o}),d.startOffset=l,d.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(d),this._restartEvent(d),this}_restartEvent(t){this._state.forEach(o=>{o.state==="started"?this._startNote(t,o.time,o.offset):t.stop(new he(this.context,o.time))})}remove(t,o){return cn(t)&&t.hasOwnProperty("time")&&(t=(o=t).time),t=this.toTicks(t),this._events.forEach(l=>{l.startOffset===t&&(rs(o)||It(o)&&l.value===o)&&(this._events.delete(l),l.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(o=>o.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(o=>{o instanceof Vo?o._forEach(t):t(o)}),this}_setAll(t,o){this._forEach(l=>{l[t]=o})}_tick(t,o){this.mute||this.callback(t,o)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(o=>{o.loopStart=this.loopStart,o.loopEnd=this.loopEnd,o.loop=t,this._testLoopBoundries(o)})}get loopEnd(){return new he(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(o=>{o.loopEnd=t,this._testLoopBoundries(o)})}get loopStart(){return new he(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(o=>{o.loopStart=this.loopStart,this._testLoopBoundries(o)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}function*Fg(p){let t=0;for(;t<p;)t=Un(t,0,p-1),yield t,t++}function*Bg(p){let t=p-1;for(;t>=0;)t=Un(t,0,p-1),yield t,t--}function*Ho(p,t){for(;;)yield*t(p)}function*Yu(p,t){let o=t?0:p-1;for(;;)o=Un(o,0,p-1),yield o,t?(o++,o>=p-1&&(t=!1)):(o--,o<=0&&(t=!0))}function*qg(p){let t=0,o=0;for(;t<p;)t=Un(t,0,p-1),yield t,o++,t+=o%2?2:-1}function*$g(p){let t=p-1,o=0;for(;t>=0;)t=Un(t,0,p-1),yield t,o++,t+=o%2?-2:1}function*zg(p){const t=[];for(let o=0;o<p;o++)t.push(o);for(;t.length>0;)yield Un(t.splice(Math.floor(t.length*Math.random()),1)[0],0,p-1)}function*Zu(p,t="up",o=0){switch(wt(p>=1,"The number of values must be at least one"),t){case"up":yield*Ho(p,Fg);case"down":yield*Ho(p,Bg);case"upDown":yield*Yu(p,!0);case"downUp":yield*Yu(p,!1);case"alternateUp":yield*Ho(p,qg);case"alternateDown":yield*Ho(p,$g);case"random":yield*function*(l){for(;;)yield Math.floor(Math.random()*l)}(p);case"randomOnce":yield*Ho(p,zg);case"randomWalk":yield*function*(l){let d=Math.floor(Math.random()*l);for(;;)d===0?d++:d===l-1||Math.random()<.5?d--:d++,yield d}(p)}}class ql extends Wo{constructor(){const t=tt(ql.getDefaults(),arguments,["callback","values","pattern"]);super(t),this.name="Pattern",this.callback=t.callback,this._values=t.values,this._pattern=Zu(t.values.length,t.pattern),this._type=t.pattern}static getDefaults(){return Object.assign(Wo.getDefaults(),{pattern:"up",values:[],callback:Dt})}_tick(t){const o=this._pattern.next();this._index=o.value,this._value=this._values[o.value],this.callback(t,this._value)}get values(){return this._values}set values(t){this._values=t,this.pattern=this._type}get value(){return this._value}get index(){return this._index}get pattern(){return this._type}set pattern(t){this._type=t,this._pattern=Zu(this._values.length,this._type)}}class $l extends Ys{constructor(){const t=tt($l.getDefaults(),arguments,["callback","events","subdivision"]);super(t),this.name="Sequence",this._part=new Vo({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[],this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign($e(Ys.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,o){o===null||this.mute||this.callback(t,o)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,o){return this._part.start(t,o&&this._indexTime(o)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new he(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(o,l)=>o[l],set:(o,l,d)=>(Fs(l)&&isFinite(parseInt(l,10))&&Be(d)?o[l]=this._createSequence(d):o[l]=d,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,o,l){t.forEach((d,g)=>{const b=g*o+l;if(Be(d))this._rescheduleSequence(d,o/d.length,b);else{const _=new he(this.context,b,"i").toSeconds();this._part.add(_,d)}})}_indexTime(t){return new he(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this._part.loopEnd=t===0?this._indexTime(this._eventsArray.length):this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}class zi extends ot{constructor(){const t=tt(zi.getDefaults(),arguments,["fade"]);super(t),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new Gu({context:this.context}),this.a=new bt({context:this.context,gain:0}),this.b=new bt({context:this.context,gain:0}),this.output=new bt({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new At({context:this.context,units:"normalRange",value:t.fade}),Ct(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",ts(this._split,this.a.gain,0),ts(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(ot.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class Me extends ot{constructor(t){super(t),this.name="Effect",this._dryWet=new zi({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new bt({context:this.context}),this.effectReturn=new bt({context:this.context}),this.input=new bt({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(t.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],Ct(this,"wet")}static getDefaults(){return Object.assign(ot.getDefaults(),{wet:1})}connectEffect(t){return this._internalChannels.push(t),this.effectSend.chain(t,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class ia extends Me{constructor(t){super(t),this.name="LFOEffect",this._lfo=new es({context:this.context,frequency:t.frequency,amplitude:t.depth}),this.depth=this._lfo.amplitude,this.frequency=this._lfo.frequency,this.type=t.type,Ct(this,["frequency","depth"])}static getDefaults(){return Object.assign(Me.getDefaults(),{frequency:1,type:"sine",depth:1})}start(t){return this._lfo.start(t),this}stop(t){return this._lfo.stop(t),this}sync(){return this._lfo.sync(),this}unsync(){return this._lfo.unsync(),this}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class zl extends ia{constructor(){const t=tt(zl.getDefaults(),arguments,["frequency","baseFrequency","octaves"]);super(t),this.name="AutoFilter",this.filter=new bs(Object.assign(t.filter,{context:this.context})),this.connectEffect(this.filter),this._lfo.connect(this.filter.frequency),this.octaves=t.octaves,this.baseFrequency=t.baseFrequency}static getDefaults(){return Object.assign(ia.getDefaults(),{baseFrequency:200,octaves:2.6,filter:{type:"lowpass",rolloff:-12,Q:1}})}get baseFrequency(){return this._lfo.min}set baseFrequency(t){this._lfo.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._lfo.max=this._lfo.min*Math.pow(2,t)}dispose(){return super.dispose(),this.filter.dispose(),this}}class Go extends ot{constructor(){const t=tt(Go.getDefaults(),arguments,["pan"]);super(t),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Et({context:this.context,param:this._panner.pan,value:t.pan,minValue:-1,maxValue:1}),this._panner.channelCount=t.channelCount,this._panner.channelCountMode="explicit",Ct(this,"pan")}static getDefaults(){return Object.assign(ot.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}class Wl extends ia{constructor(){const t=tt(Wl.getDefaults(),arguments,["frequency"]);super(t),this.name="AutoPanner",this._panner=new Go({context:this.context,channelCount:t.channelCount}),this.connectEffect(this._panner),this._lfo.connect(this._panner.pan),this._lfo.min=-1,this._lfo.max=1}static getDefaults(){return Object.assign(ia.getDefaults(),{channelCount:1})}dispose(){return super.dispose(),this._panner.dispose(),this}}class jo extends ot{constructor(){const t=tt(jo.getDefaults(),arguments,["smoothing"]);super(t),this.name="Follower",this._abs=this.input=new Hu({context:this.context}),this._lowpass=this.output=new qo({context:this.context,frequency:1/this.toSeconds(t.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=t.smoothing}static getDefaults(){return Object.assign(ot.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class Vl extends Me{constructor(){const t=tt(Vl.getDefaults(),arguments,["baseFrequency","octaves","sensitivity"]);super(t),this.name="AutoWah",this._follower=new jo({context:this.context,smoothing:t.follower}),this._sweepRange=new sa({context:this.context,min:0,max:1,exponent:.5}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this._inputBoost=new bt({context:this.context}),this._bandpass=new bs({context:this.context,rolloff:-48,frequency:0,Q:t.Q}),this._peaking=new bs({context:this.context,type:"peaking"}),this._peaking.gain.value=t.gain,this.gain=this._peaking.gain,this.Q=this._bandpass.Q,this.effectSend.chain(this._inputBoost,this._follower,this._sweepRange),this._sweepRange.connect(this._bandpass.frequency),this._sweepRange.connect(this._peaking.frequency),this.effectSend.chain(this._bandpass,this._peaking,this.effectReturn),this._setSweepRange(),this.sensitivity=t.sensitivity,Ct(this,["gain","Q"])}static getDefaults(){return Object.assign(Me.getDefaults(),{baseFrequency:100,octaves:6,sensitivity:0,Q:2,gain:2,follower:.2})}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._setSweepRange()}get follower(){return this._follower.smoothing}set follower(t){this._follower.smoothing=t}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._setSweepRange()}get sensitivity(){return Mo(1/this._inputBoost.gain.value)}set sensitivity(t){this._inputBoost.gain.value=1/Ei(t)}_setSweepRange(){this._sweepRange.min=this._baseFrequency,this._sweepRange.max=Math.min(this._baseFrequency*Math.pow(2,this._octaves),this.context.sampleRate/2)}dispose(){return super.dispose(),this._follower.dispose(),this._sweepRange.dispose(),this._bandpass.dispose(),this._peaking.dispose(),this._inputBoost.dispose(),this}}const Qu="bit-crusher";Xu(Qu,`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`);class Hl extends Me{constructor(){const t=tt(Hl.getDefaults(),arguments,["bits"]);super(t),this.name="BitCrusher",this._bitCrusherWorklet=new Gl({context:this.context,bits:t.bits}),this.connectEffect(this._bitCrusherWorklet),this.bits=this._bitCrusherWorklet.bits}static getDefaults(){return Object.assign(Me.getDefaults(),{bits:4})}dispose(){return super.dispose(),this._bitCrusherWorklet.dispose(),this}}class Gl extends Ll{constructor(){const t=tt(Gl.getDefaults(),arguments);super(t),this.name="BitCrusherWorklet",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this.bits=new Et({context:this.context,value:t.bits,units:"positive",minValue:1,maxValue:16,param:this._dummyParam,swappable:!0})}static getDefaults(){return Object.assign(Ll.getDefaults(),{bits:12})}_audioWorkletName(){return Qu}onReady(t){gs(this.input,t,this.output);const o=t.parameters.get("bits");this.bits.setParam(o)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.bits.dispose(),this}}class jl extends Me{constructor(){const t=tt(jl.getDefaults(),arguments,["order"]);super(t),this.name="Chebyshev",this._shaper=new $s({context:this.context,length:4096}),this._order=t.order,this.connectEffect(this._shaper),this.order=t.order,this.oversample=t.oversample}static getDefaults(){return Object.assign(Me.getDefaults(),{order:1,oversample:"none"})}_getCoefficient(t,o,l){return l.has(o)||(o===0?l.set(o,0):o===1?l.set(o,t):l.set(o,2*t*this._getCoefficient(t,o-1,l)-this._getCoefficient(t,o-2,l))),l.get(o)}get order(){return this._order}set order(t){wt(Number.isInteger(t),"'order' must be an integer"),this._order=t,this._shaper.setMap(o=>this._getCoefficient(o,t,new Map))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Kn extends ot{constructor(){const t=tt(Kn.getDefaults(),arguments,["channels"]);super(t),this.name="Split",this._splitter=this.input=this.output=this.context.createChannelSplitter(t.channels),this._internalChannels=[this._splitter]}static getDefaults(){return Object.assign(ot.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._splitter.disconnect(),this}}class On extends ot{constructor(){const t=tt(On.getDefaults(),arguments,["channels"]);super(t),this.name="Merge",this._merger=this.output=this.input=this.context.createChannelMerger(t.channels)}static getDefaults(){return Object.assign(ot.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._merger.disconnect(),this}}class Zs extends ot{constructor(t){super(t),this.name="StereoEffect",this.input=new bt({context:this.context}),this.input.channelCount=2,this.input.channelCountMode="explicit",this._dryWet=this.output=new zi({context:this.context,fade:t.wet}),this.wet=this._dryWet.fade,this._split=new Kn({context:this.context,channels:2}),this._merge=new On({context:this.context,channels:2}),this.input.connect(this._split),this.input.connect(this._dryWet.a),this._merge.connect(this._dryWet.b),Ct(this,["wet"])}connectEffectLeft(...t){this._split.connect(t[0],0,0),gs(...t),ts(t[t.length-1],this._merge,0,0)}connectEffectRight(...t){this._split.connect(t[0],1,0),gs(...t),ts(t[t.length-1],this._merge,0,1)}static getDefaults(){return Object.assign(ot.getDefaults(),{wet:1})}dispose(){return super.dispose(),this._dryWet.dispose(),this._split.dispose(),this._merge.dispose(),this}}class Xl extends Zs{constructor(t){super(t),this.feedback=new At({context:this.context,value:t.feedback,units:"normalRange"}),this._feedbackL=new bt({context:this.context}),this._feedbackR=new bt({context:this.context}),this._feedbackSplit=new Kn({context:this.context,channels:2}),this._feedbackMerge=new On({context:this.context,channels:2}),this._merge.connect(this._feedbackSplit),this._feedbackMerge.connect(this._split),this._feedbackSplit.connect(this._feedbackL,0,0),this._feedbackL.connect(this._feedbackMerge,0,0),this._feedbackSplit.connect(this._feedbackR,1,0),this._feedbackR.connect(this._feedbackMerge,0,1),this.feedback.fan(this._feedbackL.gain,this._feedbackR.gain),Ct(this,["feedback"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{feedback:.5})}dispose(){return super.dispose(),this.feedback.dispose(),this._feedbackL.dispose(),this._feedbackR.dispose(),this._feedbackSplit.dispose(),this._feedbackMerge.dispose(),this}}class Ul extends Xl{constructor(){const t=tt(Ul.getDefaults(),arguments,["frequency","delayTime","depth"]);super(t),this.name="Chorus",this._depth=t.depth,this._delayTime=t.delayTime/1e3,this._lfoL=new es({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new es({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._delayNodeL=new vs({context:this.context}),this._delayNodeR=new vs({context:this.context}),this.frequency=this._lfoL.frequency,Ct(this,["frequency"]),this._lfoL.frequency.connect(this._lfoR.frequency),this.connectEffectLeft(this._delayNodeL),this.connectEffectRight(this._delayNodeR),this._lfoL.connect(this._delayNodeL.delayTime),this._lfoR.connect(this._delayNodeR.delayTime),this.depth=this._depth,this.type=t.type,this.spread=t.spread}static getDefaults(){return Object.assign(Xl.getDefaults(),{frequency:1.5,delayTime:3.5,depth:.7,type:"sine",spread:180,feedback:0,wet:.5})}get depth(){return this._depth}set depth(t){this._depth=t;const o=this._delayTime*t;this._lfoL.min=Math.max(this._delayTime-o,0),this._lfoL.max=this._delayTime+o,this._lfoR.min=Math.max(this._delayTime-o,0),this._lfoR.max=this._delayTime+o}get delayTime(){return 1e3*this._delayTime}set delayTime(t){this._delayTime=t/1e3,this.depth=this._depth}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._delayNodeL.dispose(),this._delayNodeR.dispose(),this.frequency.dispose(),this}}class Yl extends Me{constructor(){const t=tt(Yl.getDefaults(),arguments,["distortion"]);super(t),this.name="Distortion",this._shaper=new $s({context:this.context,length:4096}),this._distortion=t.distortion,this.connectEffect(this._shaper),this.distortion=t.distortion,this.oversample=t.oversample}static getDefaults(){return Object.assign(Me.getDefaults(),{distortion:.4,oversample:"none"})}get distortion(){return this._distortion}set distortion(t){this._distortion=t;const o=100*t,l=Math.PI/180;this._shaper.setMap(d=>Math.abs(d)<.001?0:(3+o)*d*20*l/(Math.PI+o*Math.abs(d)))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class oa extends Me{constructor(t){super(t),this.name="FeedbackEffect",this._feedbackGain=new bt({context:this.context,gain:t.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,Ct(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(Me.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class Zl extends oa{constructor(){const t=tt(Zl.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="FeedbackDelay",this._delayNode=new vs({context:this.context,delayTime:t.delayTime,maxDelay:t.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),Ct(this,"delayTime")}static getDefaults(){return Object.assign(oa.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class Wg extends ot{constructor(t){super(t),this.name="PhaseShiftAllpass",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this.offset90=new bt({context:this.context}),this._bank0=this._createAllPassFilterBank([.6923878,.9360654322959,.988229522686,.9987488452737]),this._bank1=this._createAllPassFilterBank([.4021921162426,.856171088242,.9722909545651,.9952884791278]),this._oneSampleDelay=this.context.createIIRFilter([0,1],[1,0]),gs(this.input,...this._bank0,this._oneSampleDelay,this.output),gs(this.input,...this._bank1,this.offset90)}_createAllPassFilterBank(t){return t.map(o=>{const l=[[o*o,0,-1],[1,0,-o*o]];return this.context.createIIRFilter(l[0],l[1])})}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.offset90.dispose(),this._bank0.forEach(t=>t.disconnect()),this._bank1.forEach(t=>t.disconnect()),this._oneSampleDelay.disconnect(),this}}class Ql extends Me{constructor(){const t=tt(Ql.getDefaults(),arguments,["frequency"]);super(t),this.name="FrequencyShifter",this.frequency=new At({context:this.context,units:"frequency",value:t.frequency,minValue:-this.context.sampleRate/2,maxValue:this.context.sampleRate/2}),this._sine=new ko({context:this.context,type:"sine"}),this._cosine=new ue({context:this.context,phase:-90,type:"sine"}),this._sineMultiply=new de({context:this.context}),this._cosineMultiply=new de({context:this.context}),this._negate=new El({context:this.context}),this._add=new Zn({context:this.context}),this._phaseShifter=new Wg({context:this.context}),this.effectSend.connect(this._phaseShifter),this.frequency.fan(this._sine.frequency,this._cosine.frequency),this._phaseShifter.offset90.connect(this._cosineMultiply),this._cosine.connect(this._cosineMultiply.factor),this._phaseShifter.connect(this._sineMultiply),this._sine.connect(this._sineMultiply.factor),this._sineMultiply.connect(this._negate),this._cosineMultiply.connect(this._add),this._negate.connect(this._add.addend),this._add.connect(this.effectReturn);const o=this.immediate();this._sine.start(o),this._cosine.start(o)}static getDefaults(){return Object.assign(Me.getDefaults(),{frequency:0})}dispose(){return super.dispose(),this.frequency.dispose(),this._add.dispose(),this._cosine.dispose(),this._cosineMultiply.dispose(),this._negate.dispose(),this._phaseShifter.dispose(),this._sine.dispose(),this._sineMultiply.dispose(),this}}const Ju=[1557/44100,1617/44100,1491/44100,1422/44100,1277/44100,1356/44100,1188/44100,1116/44100],Ku=[225,556,441,341];class Jl extends Zs{constructor(){const t=tt(Jl.getDefaults(),arguments,["roomSize","dampening"]);super(t),this.name="Freeverb",this._combFilters=[],this._allpassFiltersL=[],this._allpassFiltersR=[],this.roomSize=new At({context:this.context,value:t.roomSize,units:"normalRange"}),this._allpassFiltersL=Ku.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._allpassFiltersR=Ku.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._combFilters=Ju.map((o,l)=>{const d=new $o({context:this.context,dampening:t.dampening,delayTime:o});return l<Ju.length/2?this.connectEffectLeft(d,...this._allpassFiltersL):this.connectEffectRight(d,...this._allpassFiltersR),this.roomSize.connect(d.resonance),d}),Ct(this,["roomSize"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{roomSize:.7,dampening:3e3})}get dampening(){return this._combFilters[0].dampening}set dampening(t){this._combFilters.forEach(o=>o.dampening=t)}dispose(){return super.dispose(),this._allpassFiltersL.forEach(t=>t.disconnect()),this._allpassFiltersR.forEach(t=>t.disconnect()),this._combFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this}}const td=[.06748,.06404,.08212,.09004],Vg=[.773,.802,.753,.733],Hg=[347,113,37];class Kl extends Zs{constructor(){const t=tt(Kl.getDefaults(),arguments,["roomSize"]);super(t),this.name="JCReverb",this._allpassFilters=[],this._feedbackCombFilters=[],this.roomSize=new At({context:this.context,value:t.roomSize,units:"normalRange"}),this._scaleRoomSize=new mn({context:this.context,min:-.733,max:.197}),this._allpassFilters=Hg.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._feedbackCombFilters=td.map((o,l)=>{const d=new Bo({context:this.context,delayTime:o});return this._scaleRoomSize.connect(d.resonance),d.resonance.value=Vg[l],l<td.length/2?this.connectEffectLeft(...this._allpassFilters,d):this.connectEffectRight(...this._allpassFilters,d),d}),this.roomSize.connect(this._scaleRoomSize),Ct(this,["roomSize"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{roomSize:.5})}dispose(){return super.dispose(),this._allpassFilters.forEach(t=>t.disconnect()),this._feedbackCombFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this._scaleRoomSize.dispose(),this}}class ed extends Xl{constructor(t){super(t),this._feedbackL.disconnect(),this._feedbackL.connect(this._feedbackMerge,0,1),this._feedbackR.disconnect(),this._feedbackR.connect(this._feedbackMerge,0,0),Ct(this,["feedback"])}}class tc extends ed{constructor(){const t=tt(tc.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="PingPongDelay",this._leftDelay=new vs({context:this.context,maxDelay:t.maxDelay}),this._rightDelay=new vs({context:this.context,maxDelay:t.maxDelay}),this._rightPreDelay=new vs({context:this.context,maxDelay:t.maxDelay}),this.delayTime=new At({context:this.context,units:"time",value:t.delayTime}),this.connectEffectLeft(this._leftDelay),this.connectEffectRight(this._rightPreDelay,this._rightDelay),this.delayTime.fan(this._leftDelay.delayTime,this._rightDelay.delayTime,this._rightPreDelay.delayTime),this._feedbackL.disconnect(),this._feedbackL.connect(this._rightDelay),Ct(this,["delayTime"])}static getDefaults(){return Object.assign(ed.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._leftDelay.dispose(),this._rightDelay.dispose(),this._rightPreDelay.dispose(),this.delayTime.dispose(),this}}class ec extends oa{constructor(){const t=tt(ec.getDefaults(),arguments,["pitch"]);super(t),this.name="PitchShift",this._frequency=new At({context:this.context}),this._delayA=new vs({maxDelay:1,context:this.context}),this._lfoA=new es({context:this.context,min:0,max:.1,type:"sawtooth"}).connect(this._delayA.delayTime),this._delayB=new vs({maxDelay:1,context:this.context}),this._lfoB=new es({context:this.context,min:0,max:.1,type:"sawtooth",phase:180}).connect(this._delayB.delayTime),this._crossFade=new zi({context:this.context}),this._crossFadeLFO=new es({context:this.context,min:0,max:1,type:"triangle",phase:90}).connect(this._crossFade.fade),this._feedbackDelay=new vs({delayTime:t.delayTime,context:this.context}),this.delayTime=this._feedbackDelay.delayTime,Ct(this,"delayTime"),this._pitch=t.pitch,this._windowSize=t.windowSize,this._delayA.connect(this._crossFade.a),this._delayB.connect(this._crossFade.b),this._frequency.fan(this._lfoA.frequency,this._lfoB.frequency,this._crossFadeLFO.frequency),this.effectSend.fan(this._delayA,this._delayB),this._crossFade.chain(this._feedbackDelay,this.effectReturn);const o=this.now();this._lfoA.start(o),this._lfoB.start(o),this._crossFadeLFO.start(o),this.windowSize=this._windowSize}static getDefaults(){return Object.assign(oa.getDefaults(),{pitch:0,windowSize:.1,delayTime:0,feedback:0})}get pitch(){return this._pitch}set pitch(t){this._pitch=t;let o=0;t<0?(this._lfoA.min=0,this._lfoA.max=this._windowSize,this._lfoB.min=0,this._lfoB.max=this._windowSize,o=Pi(t-1)+1):(this._lfoA.min=this._windowSize,this._lfoA.max=0,this._lfoB.min=this._windowSize,this._lfoB.max=0,o=Pi(t)-1),this._frequency.value=o*(1.2/this._windowSize)}get windowSize(){return this._windowSize}set windowSize(t){this._windowSize=this.toSeconds(t),this.pitch=this._pitch}dispose(){return super.dispose(),this._frequency.dispose(),this._delayA.dispose(),this._delayB.dispose(),this._lfoA.dispose(),this._lfoB.dispose(),this._crossFade.dispose(),this._crossFadeLFO.dispose(),this._feedbackDelay.dispose(),this}}class sc extends Zs{constructor(){const t=tt(sc.getDefaults(),arguments,["frequency","octaves","baseFrequency"]);super(t),this.name="Phaser",this._lfoL=new es({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new es({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this.Q=new At({context:this.context,value:t.Q,units:"positive"}),this._filtersL=this._makeFilters(t.stages,this._lfoL),this._filtersR=this._makeFilters(t.stages,this._lfoR),this.frequency=this._lfoL.frequency,this.frequency.value=t.frequency,this.connectEffectLeft(...this._filtersL),this.connectEffectRight(...this._filtersR),this._lfoL.frequency.connect(this._lfoR.frequency),this.baseFrequency=t.baseFrequency,this.octaves=t.octaves,this._lfoL.start(),this._lfoR.start(),Ct(this,["frequency","Q"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{frequency:.5,octaves:3,stages:10,Q:10,baseFrequency:350})}_makeFilters(t,o){const l=[];for(let d=0;d<t;d++){const g=this.context.createBiquadFilter();g.type="allpass",this.Q.connect(g.Q),o.connect(g.frequency),l.push(g)}return l}get octaves(){return this._octaves}set octaves(t){this._octaves=t;const o=this._baseFrequency*Math.pow(2,t);this._lfoL.max=o,this._lfoR.max=o}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._lfoL.min=this._baseFrequency,this._lfoR.min=this._baseFrequency,this.octaves=this._octaves}dispose(){return super.dispose(),this.Q.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._filtersL.forEach(t=>t.disconnect()),this._filtersR.forEach(t=>t.disconnect()),this.frequency.dispose(),this}}class nc extends Me{constructor(){const t=tt(nc.getDefaults(),arguments,["decay"]);super(t),this.name="Reverb",this._convolver=this.context.createConvolver(),this.ready=Promise.resolve(),this._decay=t.decay,this._preDelay=t.preDelay,this.generate(),this.connectEffect(this._convolver)}static getDefaults(){return Object.assign(Me.getDefaults(),{decay:1.5,preDelay:.01})}get decay(){return this._decay}set decay(t){qe(t=this.toSeconds(t),.001),this._decay=t,this.generate()}get preDelay(){return this._preDelay}set preDelay(t){qe(t=this.toSeconds(t),0),this._preDelay=t,this.generate()}generate(){return ee(this,void 0,void 0,function*(){const t=this.ready,o=new Mi(2,this._decay+this._preDelay,this.context.sampleRate),l=new Rn({context:o}),d=new Rn({context:o}),g=new On({context:o});l.connect(g,0,0),d.connect(g,0,1);const b=new bt({context:o}).toDestination();g.connect(b),l.start(0),d.start(0),b.gain.setValueAtTime(0,0),b.gain.setValueAtTime(1,this._preDelay),b.gain.exponentialApproachValueAtTime(0,this._preDelay,this.decay);const _=o.render();return this.ready=_.then(Dt),yield t,this._convolver.buffer=(yield _).get(),this})}dispose(){return super.dispose(),this._convolver.disconnect(),this}}class Xo extends ot{constructor(){super(tt(Xo.getDefaults(),arguments)),this.name="MidSideSplit",this._split=this.input=new Kn({channels:2,context:this.context}),this._midAdd=new Zn({context:this.context}),this.mid=new de({context:this.context,value:Math.SQRT1_2}),this._sideSubtract=new Qn({context:this.context}),this.side=new de({context:this.context,value:Math.SQRT1_2}),this._split.connect(this._midAdd,0),this._split.connect(this._midAdd.addend,1),this._split.connect(this._sideSubtract,0),this._split.connect(this._sideSubtract.subtrahend,1),this._midAdd.connect(this.mid),this._sideSubtract.connect(this.side)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midAdd.dispose(),this._sideSubtract.dispose(),this._split.dispose(),this}}class Uo extends ot{constructor(){super(tt(Uo.getDefaults(),arguments)),this.name="MidSideMerge",this.mid=new bt({context:this.context}),this.side=new bt({context:this.context}),this._left=new Zn({context:this.context}),this._leftMult=new de({context:this.context,value:Math.SQRT1_2}),this._right=new Qn({context:this.context}),this._rightMult=new de({context:this.context,value:Math.SQRT1_2}),this._merge=this.output=new On({context:this.context}),this.mid.fan(this._left),this.side.connect(this._left.addend),this.mid.connect(this._right),this.side.connect(this._right.subtrahend),this._left.connect(this._leftMult),this._right.connect(this._rightMult),this._leftMult.connect(this._merge,0,0),this._rightMult.connect(this._merge,0,1)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._leftMult.dispose(),this._rightMult.dispose(),this._left.dispose(),this._right.dispose(),this}}class sd extends Me{constructor(t){super(t),this.name="MidSideEffect",this._midSideMerge=new Uo({context:this.context}),this._midSideSplit=new Xo({context:this.context}),this._midSend=this._midSideSplit.mid,this._sideSend=this._midSideSplit.side,this._midReturn=this._midSideMerge.mid,this._sideReturn=this._midSideMerge.side,this.effectSend.connect(this._midSideSplit),this._midSideMerge.connect(this.effectReturn)}connectEffectMid(...t){this._midSend.chain(...t,this._midReturn)}connectEffectSide(...t){this._sideSend.chain(...t,this._sideReturn)}dispose(){return super.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this._midSend.dispose(),this._sideSend.dispose(),this._midReturn.dispose(),this._sideReturn.dispose(),this}}class ic extends sd{constructor(){const t=tt(ic.getDefaults(),arguments,["width"]);super(t),this.name="StereoWidener",this.width=new At({context:this.context,value:t.width,units:"normalRange"}),Ct(this,["width"]),this._twoTimesWidthMid=new de({context:this.context,value:2}),this._twoTimesWidthSide=new de({context:this.context,value:2}),this._midMult=new de({context:this.context}),this._twoTimesWidthMid.connect(this._midMult.factor),this.connectEffectMid(this._midMult),this._oneMinusWidth=new Qn({context:this.context}),this._oneMinusWidth.connect(this._twoTimesWidthMid),ts(this.context.getConstant(1),this._oneMinusWidth),this.width.connect(this._oneMinusWidth.subtrahend),this._sideMult=new de({context:this.context}),this.width.connect(this._twoTimesWidthSide),this._twoTimesWidthSide.connect(this._sideMult.factor),this.connectEffectSide(this._sideMult)}static getDefaults(){return Object.assign(sd.getDefaults(),{width:.5})}dispose(){return super.dispose(),this.width.dispose(),this._midMult.dispose(),this._sideMult.dispose(),this._twoTimesWidthMid.dispose(),this._twoTimesWidthSide.dispose(),this._oneMinusWidth.dispose(),this}}class oc extends Zs{constructor(){const t=tt(oc.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Tremolo",this._lfoL=new es({context:this.context,type:t.type,min:1,max:0}),this._lfoR=new es({context:this.context,type:t.type,min:1,max:0}),this._amplitudeL=new bt({context:this.context}),this._amplitudeR=new bt({context:this.context}),this.frequency=new At({context:this.context,value:t.frequency,units:"frequency"}),this.depth=new At({context:this.context,value:t.depth,units:"normalRange"}),Ct(this,["frequency","depth"]),this.connectEffectLeft(this._amplitudeL),this.connectEffectRight(this._amplitudeR),this._lfoL.connect(this._amplitudeL.gain),this._lfoR.connect(this._amplitudeR.gain),this.frequency.fan(this._lfoL.frequency,this._lfoR.frequency),this.depth.fan(this._lfoR.amplitude,this._lfoL.amplitude),this.spread=t.spread}static getDefaults(){return Object.assign(Zs.getDefaults(),{frequency:10,type:"sine",depth:.5,spread:180})}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this.context.transport.syncSignal(this.frequency),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this.context.transport.unsyncSignal(this.frequency),this}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._amplitudeL.dispose(),this._amplitudeR.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class rc extends Me{constructor(){const t=tt(rc.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Vibrato",this._delayNode=new vs({context:this.context,delayTime:0,maxDelay:t.maxDelay}),this._lfo=new es({context:this.context,type:t.type,min:0,max:t.maxDelay,frequency:t.frequency,phase:-90}).start().connect(this._delayNode.delayTime),this.frequency=this._lfo.frequency,this.depth=this._lfo.amplitude,this.depth.value=t.depth,Ct(this,["frequency","depth"]),this.effectSend.chain(this._delayNode,this.effectReturn)}static getDefaults(){return Object.assign(Me.getDefaults(),{maxDelay:.005,frequency:5,depth:.1,type:"sine"})}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._delayNode.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Yo extends ot{constructor(){const t=tt(Yo.getDefaults(),arguments,["type","size"]);super(t),this.name="Analyser",this._analysers=[],this._buffers=[],this.input=this.output=this._gain=new bt({context:this.context}),this._split=new Kn({context:this.context,channels:t.channels}),this.input.connect(this._split),qe(t.channels,1);for(let o=0;o<t.channels;o++)this._analysers[o]=this.context.createAnalyser(),this._split.connect(this._analysers[o],o,0);this.size=t.size,this.type=t.type,this.smoothing=t.smoothing}static getDefaults(){return Object.assign(ot.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach((t,o)=>{const l=this._buffers[o];this._type==="fft"?t.getFloatFrequencyData(l):this._type==="waveform"&&t.getFloatTimeDomainData(l)}),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(t){this._analysers.forEach((o,l)=>{o.fftSize=2*t,this._buffers[l]=new Float32Array(t)})}get channels(){return this._analysers.length}get type(){return this._type}set type(t){wt(t==="waveform"||t==="fft",`Analyser: invalid type: ${t}`),this._type=t}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(t){this._analysers.forEach(o=>o.smoothingTimeConstant=t)}dispose(){return super.dispose(),this._analysers.forEach(t=>t.disconnect()),this._split.dispose(),this._gain.dispose(),this}}class Nn extends ot{constructor(){super(tt(Nn.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new Yo({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class ac extends Nn{constructor(){const t=tt(ac.getDefaults(),arguments,["smoothing"]);super(t),this.name="Meter",this.input=this.output=this._analyser=new Yo({context:this.context,size:256,type:"waveform",channels:t.channelCount}),this.smoothing=t.smoothing,this.normalRange=t.normalRange,this._rms=new Array(t.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(Nn.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return xi("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),o=(this.channels===1?[t]:t).map((l,d)=>{const g=l.reduce((_,C)=>_+C*C,0),b=Math.sqrt(g/l.length);return this._rms[d]=Math.max(b,this._rms[d]*this.smoothing),this.normalRange?this._rms[d]:Mo(this._rms[d])});return this.channels===1?o[0]:o}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class lc extends Nn{constructor(){const t=tt(lc.getDefaults(),arguments,["size"]);super(t),this.name="FFT",this.normalRange=t.normalRange,this._analyser.type="fft",this.size=t.size}static getDefaults(){return Object.assign(ot.getDefaults(),{normalRange:!1,size:1024,smoothing:.8})}getValue(){return this._analyser.getValue().map(t=>this.normalRange?Ei(t):t)}get size(){return this._analyser.size}set size(t){this._analyser.size=t}get smoothing(){return this._analyser.smoothing}set smoothing(t){this._analyser.smoothing=t}getFrequencyOfIndex(t){return wt(0<=t&&t<this.size,`index must be greater than or equal to 0 and less than ${this.size}`),t*this.context.sampleRate/(2*this.size)}}class cc extends Nn{constructor(){super(tt(cc.getDefaults(),arguments)),this.name="DCMeter",this._analyser.type="waveform",this._analyser.size=256}getValue(){return this._analyser.getValue()[0]}}class hc extends Nn{constructor(){const t=tt(hc.getDefaults(),arguments,["size"]);super(t),this.name="Waveform",this._analyser.type="waveform",this.size=t.size}static getDefaults(){return Object.assign(Nn.getDefaults(),{size:1024})}getValue(){return this._analyser.getValue()}get size(){return this._analyser.size}set size(t){this._analyser.size=t}}class we extends ot{constructor(){const t=tt(we.getDefaults(),arguments,["solo"]);super(t),this.name="Solo",this.input=this.output=new bt({context:this.context}),we._allSolos.has(this.context)||we._allSolos.set(this.context,new Set),we._allSolos.get(this.context).add(this),this.solo=t.solo}static getDefaults(){return Object.assign(ot.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(t){t?this._addSolo():this._removeSolo(),we._allSolos.get(this.context).forEach(o=>o._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){we._soloed.has(this.context)||we._soloed.set(this.context,new Set),we._soloed.get(this.context).add(this)}_removeSolo(){we._soloed.has(this.context)&&we._soloed.get(this.context).delete(this)}_isSoloed(){return we._soloed.has(this.context)&&we._soloed.get(this.context).has(this)}_noSolos(){return!we._soloed.has(this.context)||we._soloed.has(this.context)&&we._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),we._allSolos.get(this.context).delete(this),this._removeSolo(),this}}we._allSolos=new Map,we._soloed=new Map;class ra extends ot{constructor(){const t=tt(ra.getDefaults(),arguments,["pan","volume"]);super(t),this.name="PanVol",this._panner=this.input=new Go({context:this.context,pan:t.pan,channelCount:t.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=t.mute,Ct(this,["pan","volume"])}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class ti extends ot{constructor(){const t=tt(ti.getDefaults(),arguments,["volume","pan"]);super(t),this.name="Channel",this._solo=this.input=new we({solo:t.solo,context:this.context}),this._panVol=this.output=new ra({context:this.context,pan:t.pan,volume:t.volume,mute:t.mute,channelCount:t.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Ct(this,["pan","volume"])}static getDefaults(){return Object.assign(ot.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(t){this._solo.solo=t}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(t){this._panVol.mute=t}_getBus(t){return ti.buses.has(t)||ti.buses.set(t,new bt({context:this.context})),ti.buses.get(t)}send(t,o=0){const l=this._getBus(t),d=new bt({context:this.context,units:"decibels",gain:o});return this.connect(d),d.connect(l),d}receive(t){return this._getBus(t).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}ti.buses=new Map;class uc extends ot{constructor(){super(tt(uc.getDefaults(),arguments)),this.name="Mono",this.input=new bt({context:this.context}),this._merge=this.output=new On({channels:2,context:this.context}),this.input.connect(this._merge,0,0),this.input.connect(this._merge,0,1)}dispose(){return super.dispose(),this._merge.dispose(),this.input.dispose(),this}}class Zo extends ot{constructor(){const t=tt(Zo.getDefaults(),arguments,["lowFrequency","highFrequency"]);super(t),this.name="MultibandSplit",this.input=new bt({context:this.context}),this.output=void 0,this.low=new bs({context:this.context,frequency:0,type:"lowpass"}),this._lowMidFilter=new bs({context:this.context,frequency:0,type:"highpass"}),this.mid=new bs({context:this.context,frequency:0,type:"lowpass"}),this.high=new bs({context:this.context,frequency:0,type:"highpass"}),this._internalChannels=[this.low,this.mid,this.high],this.lowFrequency=new At({context:this.context,units:"frequency",value:t.lowFrequency}),this.highFrequency=new At({context:this.context,units:"frequency",value:t.highFrequency}),this.Q=new At({context:this.context,units:"positive",value:t.Q}),this.input.fan(this.low,this.high),this.input.chain(this._lowMidFilter,this.mid),this.lowFrequency.fan(this.low.frequency,this._lowMidFilter.frequency),this.highFrequency.fan(this.mid.frequency,this.high.frequency),this.Q.connect(this.low.Q),this.Q.connect(this._lowMidFilter.Q),this.Q.connect(this.mid.Q),this.Q.connect(this.high.Q),Ct(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(ot.getDefaults(),{Q:1,highFrequency:2500,lowFrequency:400})}dispose(){return super.dispose(),To(this,["high","mid","low","highFrequency","lowFrequency"]),this.low.dispose(),this._lowMidFilter.dispose(),this.mid.dispose(),this.high.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this.Q.dispose(),this}}class dc extends ot{constructor(){const t=tt(dc.getDefaults(),arguments,["positionX","positionY","positionZ"]);super(t),this.name="Panner3D",this._panner=this.input=this.output=this.context.createPanner(),this.panningModel=t.panningModel,this.maxDistance=t.maxDistance,this.distanceModel=t.distanceModel,this.coneOuterGain=t.coneOuterGain,this.coneOuterAngle=t.coneOuterAngle,this.coneInnerAngle=t.coneInnerAngle,this.refDistance=t.refDistance,this.rolloffFactor=t.rolloffFactor,this.positionX=new Et({context:this.context,param:this._panner.positionX,value:t.positionX}),this.positionY=new Et({context:this.context,param:this._panner.positionY,value:t.positionY}),this.positionZ=new Et({context:this.context,param:this._panner.positionZ,value:t.positionZ}),this.orientationX=new Et({context:this.context,param:this._panner.orientationX,value:t.orientationX}),this.orientationY=new Et({context:this.context,param:this._panner.orientationY,value:t.orientationY}),this.orientationZ=new Et({context:this.context,param:this._panner.orientationZ,value:t.orientationZ})}static getDefaults(){return Object.assign(ot.getDefaults(),{coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:0,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1})}setPosition(t,o,l){return this.positionX.value=t,this.positionY.value=o,this.positionZ.value=l,this}setOrientation(t,o,l){return this.orientationX.value=t,this.orientationY.value=o,this.orientationZ.value=l,this}get panningModel(){return this._panner.panningModel}set panningModel(t){this._panner.panningModel=t}get refDistance(){return this._panner.refDistance}set refDistance(t){this._panner.refDistance=t}get rolloffFactor(){return this._panner.rolloffFactor}set rolloffFactor(t){this._panner.rolloffFactor=t}get distanceModel(){return this._panner.distanceModel}set distanceModel(t){this._panner.distanceModel=t}get coneInnerAngle(){return this._panner.coneInnerAngle}set coneInnerAngle(t){this._panner.coneInnerAngle=t}get coneOuterAngle(){return this._panner.coneOuterAngle}set coneOuterAngle(t){this._panner.coneOuterAngle=t}get coneOuterGain(){return this._panner.coneOuterGain}set coneOuterGain(t){this._panner.coneOuterGain=t}get maxDistance(){return this._panner.maxDistance}set maxDistance(t){this._panner.maxDistance=t}dispose(){return super.dispose(),this._panner.disconnect(),this.orientationX.dispose(),this.orientationY.dispose(),this.orientationZ.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this}}class aa extends ot{constructor(){const t=tt(aa.getDefaults(),arguments);super(t),this.name="Recorder",this.input=new bt({context:this.context}),wt(aa.supported,"Media Recorder API is not available"),this._stream=this.context.createMediaStreamDestination(),this.input.connect(this._stream),this._recorder=new MediaRecorder(this._stream.stream,{mimeType:t.mimeType})}static getDefaults(){return ot.getDefaults()}get mimeType(){return this._recorder.mimeType}static get supported(){return ps!==null&&Reflect.has(ps,"MediaRecorder")}get state(){return this._recorder.state==="inactive"?"stopped":this._recorder.state==="paused"?"paused":"started"}start(){return ee(this,void 0,void 0,function*(){wt(this.state!=="started","Recorder is already started");const t=new Promise(o=>{const l=()=>{this._recorder.removeEventListener("start",l,!1),o()};this._recorder.addEventListener("start",l,!1)});return this._recorder.start(),yield t})}stop(){return ee(this,void 0,void 0,function*(){wt(this.state!=="stopped","Recorder is not started");const t=new Promise(o=>{const l=d=>{this._recorder.removeEventListener("dataavailable",l,!1),o(d.data)};this._recorder.addEventListener("dataavailable",l,!1)});return this._recorder.stop(),yield t})}pause(){return wt(this.state==="started","Recorder must be started"),this._recorder.pause(),this}dispose(){return super.dispose(),this.input.dispose(),this._stream.disconnect(),this}}class gn extends ot{constructor(){const t=tt(gn.getDefaults(),arguments,["threshold","ratio"]);super(t),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new Et({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:t.threshold}),this.attack=new Et({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:t.attack}),this.release=new Et({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:t.release}),this.knee=new Et({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:t.knee}),this.ratio=new Et({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:t.ratio}),Ct(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(ot.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class pc extends ot{constructor(){const t=tt(pc.getDefaults(),arguments,["threshold","smoothing"]);super(t),this.name="Gate",this._follower=new jo({context:this.context,smoothing:t.smoothing}),this._gt=new ea({context:this.context,value:Ei(t.threshold)}),this.input=new bt({context:this.context}),this._gate=this.output=new bt({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(ot.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return Mo(this._gt.value)}set threshold(t){this._gt.value=Ei(t)}get smoothing(){return this._follower.smoothing}set smoothing(t){this._follower.smoothing=t}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}class mc extends ot{constructor(){const t=tt(mc.getDefaults(),arguments,["threshold"]);super(t),this.name="Limiter",this._compressor=this.input=this.output=new gn({context:this.context,ratio:20,attack:.003,release:.01,threshold:t.threshold}),this.threshold=this._compressor.threshold,Ct(this,"threshold")}static getDefaults(){return Object.assign(ot.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}class fc extends ot{constructor(){const t=tt(fc.getDefaults(),arguments);super(t),this.name="MidSideCompressor",this._midSideSplit=this.input=new Xo({context:this.context}),this._midSideMerge=this.output=new Uo({context:this.context}),this.mid=new gn(Object.assign(t.mid,{context:this.context})),this.side=new gn(Object.assign(t.side,{context:this.context})),this._midSideSplit.mid.chain(this.mid,this._midSideMerge.mid),this._midSideSplit.side.chain(this.side,this._midSideMerge.side),Ct(this,["mid","side"])}static getDefaults(){return Object.assign(ot.getDefaults(),{mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},side:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10}})}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this}}class gc extends ot{constructor(){const t=tt(gc.getDefaults(),arguments);super(t),this.name="MultibandCompressor",this._splitter=this.input=new Zo({context:this.context,lowFrequency:t.lowFrequency,highFrequency:t.highFrequency}),this.lowFrequency=this._splitter.lowFrequency,this.highFrequency=this._splitter.highFrequency,this.output=new bt({context:this.context}),this.low=new gn(Object.assign(t.low,{context:this.context})),this.mid=new gn(Object.assign(t.mid,{context:this.context})),this.high=new gn(Object.assign(t.high,{context:this.context})),this._splitter.low.chain(this.low,this.output),this._splitter.mid.chain(this.mid,this.output),this._splitter.high.chain(this.high,this.output),Ct(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(ot.getDefaults(),{lowFrequency:250,highFrequency:2e3,low:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10},mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},high:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16}})}dispose(){return super.dispose(),this._splitter.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.output.dispose(),this}}class vc extends ot{constructor(){const t=tt(vc.getDefaults(),arguments,["low","mid","high"]);super(t),this.name="EQ3",this.output=new bt({context:this.context}),this._internalChannels=[],this.input=this._multibandSplit=new Zo({context:this.context,highFrequency:t.highFrequency,lowFrequency:t.lowFrequency}),this._lowGain=new bt({context:this.context,gain:t.low,units:"decibels"}),this._midGain=new bt({context:this.context,gain:t.mid,units:"decibels"}),this._highGain=new bt({context:this.context,gain:t.high,units:"decibels"}),this.low=this._lowGain.gain,this.mid=this._midGain.gain,this.high=this._highGain.gain,this.Q=this._multibandSplit.Q,this.lowFrequency=this._multibandSplit.lowFrequency,this.highFrequency=this._multibandSplit.highFrequency,this._multibandSplit.low.chain(this._lowGain,this.output),this._multibandSplit.mid.chain(this._midGain,this.output),this._multibandSplit.high.chain(this._highGain,this.output),Ct(this,["low","mid","high","lowFrequency","highFrequency"]),this._internalChannels=[this._multibandSplit]}static getDefaults(){return Object.assign(ot.getDefaults(),{high:0,highFrequency:2500,low:0,lowFrequency:400,mid:0})}dispose(){return super.dispose(),To(this,["low","mid","high","lowFrequency","highFrequency"]),this._multibandSplit.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this._lowGain.dispose(),this._midGain.dispose(),this._highGain.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.Q.dispose(),this}}class yc extends ot{constructor(){const t=tt(yc.getDefaults(),arguments,["url","onload"]);super(t),this.name="Convolver",this._convolver=this.context.createConvolver(),this._buffer=new $t(t.url,o=>{this.buffer=o,t.onload()}),this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this._buffer.loaded&&(this.buffer=this._buffer),this.normalize=t.normalize,this.input.chain(this._convolver,this.output)}static getDefaults(){return Object.assign(ot.getDefaults(),{normalize:!0,onload:Dt})}load(t){return ee(this,void 0,void 0,function*(){this.buffer=yield this._buffer.load(t)})}get buffer(){return this._buffer.length?this._buffer:null}set buffer(t){t&&this._buffer.set(t),this._convolver.buffer&&(this.input.disconnect(),this._convolver.disconnect(),this._convolver=this.context.createConvolver(),this.input.chain(this._convolver,this.output));const o=this._buffer.get();this._convolver.buffer=o||null}get normalize(){return this._convolver.normalize}set normalize(t){this._convolver.normalize=t}dispose(){return super.dispose(),this._buffer.dispose(),this._convolver.disconnect(),this}}function Gg(){return re().now()}function jg(){return re().immediate()}const Xg=re().transport;function Ug(){return re().transport}const Yg=re().destination,Zg=re().destination;function Qg(){return re().destination}const Jg=re().listener;function Kg(){return re().listener}const tv=re().draw;function ev(){return re().draw}const sv=re();function nv(){return $t.loaded()}const iv=$t,ov=Di,rv=In})(),a})())}(Sa)),Sa.exports}var U=dv();const rd=Array(19).fill(2),pv=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],Hc=Array(16).fill(2),gp=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function mv(){return{hasAnacrusis:!1,macrobeatGroupings:[...Hc],macrobeatBoundaryStyles:[...gp],baseMicrobeatPx:40,modulationMarkers:[]}}const ho=12,fv=50,gv=.52,vv=.5,ca=3,ha=1,uo=30,po=.5,ad=3,ua=8,Ca=.25,yv=1.25,bv=.8,wv=.7,_v=.9,xv=4,Sv=1.5,Cv=.15,Tv=.2,Av=1,vp=1.5,Mv="#CCCCCC",yp=1,ld=3,cd=5,Ev=7,Ta=16,Pv=0,kv=255,bp=()=>({enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass"}),Iv=()=>({speed:0,span:0}),Rv=()=>({speed:0,span:0}),Dv={"#4a90e2":{primary:"#4a90e2",light:"#63a9fd"},"#68a03f":{primary:"#68a03f",light:"#80b958"},"#d66573":{primary:"#d66573",light:"#f27e8b"},"#2d2d2d":{primary:"#2d2d2d",light:"#424242"}};function hd(){const n=e=>{const s=new Float32Array(ho).fill(0),i=new Float32Array(ho).fill(0);return s[0]=1,{name:e,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},coeffs:s,phases:i,activePresetName:"sine",gain:1,filter:bp(),vibrato:Iv(),tremelo:Rv()}};return{timbres:{"#4a90e2":n("Blue"),"#2d2d2d":n("Black"),"#d66573":n("Red"),"#68a03f":n("Green")},colorPalette:Dv}}function Ov(){return{isMicPaintActive:!1,isDetecting:!1,detectedPitch:{frequency:0,clarity:0,midi:0,pitchClass:0},paintHistory:[],paintSettings:{thickness:6,opacity:80,minClarity:.1,colorMode:"chromatic",playbackEnabled:!0}}}const ke=[{pitch:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fef1f5"},{pitch:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fbf2fa"},{pitch:"B/A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f6f3fd"},{pitch:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f1f5ff"},{pitch:"A/G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#edf7fe"},{pitch:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#ebf8fa"},{pitch:"G/F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#ecf8f5"},{pitch:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#eff8f0"},{pitch:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#f4f7ec"},{pitch:"E/D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#f9f5eb"},{pitch:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#fdf3ec"},{pitch:"D/C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fef2f0"},{pitch:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#fef1f5"},{pitch:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#f0d1ec"},{pitch:"B/A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#e1d6f9"},{pitch:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#cfdcff"},{pitch:"A/G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#bfe2fb"},{pitch:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#b7e6ef"},{pitch:"G/F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#b9e8dd"},{pitch:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#c6e6cb"},{pitch:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#d8e2bd"},{pitch:"E/D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#e9dcb7"},{pitch:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#f6d5bc"},{pitch:"D/C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#fcd1c9"},{pitch:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#facfdb"},{pitch:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e6b2e1"},{pitch:"B/A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#cebaf6"},{pitch:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#b0c4fe"},{pitch:"A/G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#92cef8"},{pitch:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#7fd5e5"},{pitch:"G/F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#84d8c8"},{pitch:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#9ed6a8"},{pitch:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#bece8f"},{pitch:"E/D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#dbc484"},{pitch:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#f0b98d"},{pitch:"D/C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#f9b1a5"},{pitch:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#f5afc3"},{pitch:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#db8fd4"},{pitch:"B/A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#ba9bf2"},{pitch:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#8fa9ff"},{pitch:"A/G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#58b8f6"},{pitch:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#16c3da"},{pitch:"G/F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#2dc8b1"},{pitch:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#6ec482"},{pitch:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#a4ba57"},{pitch:"E/D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#cdaa42"},{pitch:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#e89955"},{pitch:"D/C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#f48e7d"},{pitch:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#ef8aab"},{pitch:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#be7cb8"},{pitch:"B/A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#a286d2"},{pitch:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#7b93dd"},{pitch:"A/G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#4c9fd6"},{pitch:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#13a9bd"},{pitch:"G/F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#27ad99"},{pitch:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#5faa71"},{pitch:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#8ea14b"},{pitch:"E/D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#b29338"},{pitch:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#ca8549"},{pitch:"D/C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#d47a6c"},{pitch:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#cf7894"},{pitch:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#a46b9f"},{pitch:"B/A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#8b73b6"},{pitch:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#6a7ebf"},{pitch:"A/G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#4189b8"},{pitch:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#1092a3"},{pitch:"G/F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#219584"},{pitch:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#519360"},{pitch:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#7a8b40"},{pitch:"E/D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#997f30"},{pitch:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#ae723e"},{pitch:"D/C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#b7695d"},{pitch:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#b3677f"},{pitch:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#6f466b"},{pitch:"B/A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#5d4c7b"},{pitch:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#465482"},{pitch:"A/G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#295c7d"},{pitch:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#06626e"},{pitch:"G/F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#126458"},{pitch:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#34633f"},{pitch:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#515d28"},{pitch:"E/D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#67541d"},{pitch:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#764c27"},{pitch:"D/C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#7c453d"},{pitch:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#794455"}],wp={placedNotes:[],placedChords:[],tonicSignGroups:{},stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:hd().timbres,placedChords:[],stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[],pitchRange:{topIndex:0,bottomIndex:Math.max(0,((ke==null?void 0:ke.length)||1)-1)},...mv(),...hd(),paint:Ov(),selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},activeChordId:null,activeChordIntervals:["1P","3M","5P"],isIntervalsInverted:!1,chordPositionState:0,isChordCandidateMenuOpen:!1,chordCandidateMenuPosition:{x:0,y:0},activeMacrobeatIndex:null,chordCandidates:[],gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,focusColours:!1,snapZoomToRange:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,waveformExtendedView:!1,adsrTimeAxisScale:1,adsrComponentWidth:100,isPrintPreviewActive:!1,printOptions:{topRow:0,bottomRow:87,includeDrums:!0,orientation:"landscape",colorMode:"color"}};function ud(n){const e=JSON.parse(JSON.stringify(n));for(const s in e){const i=e[s];i.coeffs&&typeof i.coeffs=="object"&&!Array.isArray(i.coeffs)?i.coeffs=new Float32Array(Object.values(i.coeffs)):Array.isArray(i.coeffs)&&(i.coeffs=new Float32Array(i.coeffs))}return e}const Nv={recordState(){this.state.history=this.state.history.slice(0,this.state.historyIndex+1);const n=JSON.parse(JSON.stringify(this.state.timbres)),e={notes:JSON.parse(JSON.stringify(this.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(this.state.tonicSignGroups)),stampPlacements:JSON.parse(JSON.stringify(this.state.stampPlacements)),tripletPlacements:JSON.parse(JSON.stringify(this.state.tripletPlacements||[])),timbres:n,annotations:this.state.annotations?JSON.parse(JSON.stringify(this.state.annotations)):[]};this.state.history.push(e),this.state.historyIndex++,this.emit("historyChanged")},undo(){var n;if(this.state.historyIndex>0){this.state.historyIndex--;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=ud(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}},redo(){var n;if(this.state.historyIndex<this.state.history.length-1){this.state.historyIndex++;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=ud(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}}};function Sh(n){return n!==null&&typeof n=="object"&&"name"in n&&typeof n.name=="string"}function Ch(n){return n!==null&&typeof n=="object"&&"step"in n&&typeof n.step=="number"&&"alt"in n&&typeof n.alt=="number"&&!isNaN(n.step)&&!isNaN(n.alt)}var _p=[0,2,4,-1,1,3,5],xp=_p.map(n=>Math.floor(n*7/12));function Sp(n){const{step:e,alt:s,oct:i,dir:r=1}=n,a=_p[e]+7*s;if(i===void 0)return[r*a];const c=i-xp[e]-4*s;return[r*a,r*c]}var Lv=[3,0,4,1,5,2,6];function Cp(n){const[e,s,i]=n,r=Lv[Fv(e)],a=Math.floor((e+1)/7);if(s===void 0)return{step:r,alt:a,dir:i};const c=s+4*a+xp[r];return{step:r,alt:a,oct:c,dir:i}}function Fv(n){const e=(n+1)%7;return e<0?7+e:e}var dd=(n,e)=>Array(Math.abs(e)+1).join(n),Gc=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),Bv="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",qv="(AA|A|P|M|m|d|dd)([-+]?\\d+)",$v=new RegExp("^"+Bv+"|"+qv+"$");function zv(n){const e=$v.exec(`${n}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var pd={};function Ds(n){return typeof n=="string"?pd[n]||(pd[n]=Wv(n)):Ch(n)?Ds(Hv(n)):Sh(n)?Ds(n.name):Gc}var md=[0,2,4,5,7,9,11],Tp="PMMPPMM";function Wv(n){const e=zv(n);if(e[0]==="")return Gc;const s=+e[0],i=e[1],r=(Math.abs(s)-1)%7,a=Tp[r];if(a==="M"&&i==="P")return Gc;const c=a==="M"?"majorable":"perfectable",h=""+s+i,m=s<0?-1:1,f=s===8||s===-8?s:m*(r+1),v=Vv(c,i),y=Math.floor((Math.abs(s)-1)/7),w=m*(md[r]+v+12*y),x=(m*(md[r]+v)%12+12)%12,A=Sp({step:r,alt:v,oct:y,dir:m});return{empty:!1,name:h,num:s,q:i,step:r,alt:v,dir:m,type:c,simple:f,semitones:w,chroma:x,coord:A,oct:y}}function Ap(n,e){const[s,i=0]=n,r=s*7+i*12<0,a=e||r?[-s,-i,-1]:[s,i,1];return Ds(Cp(a))}function Vv(n,e){return e==="M"&&n==="majorable"||e==="P"&&n==="perfectable"?0:e==="m"&&n==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(n==="perfectable"?e.length:e.length+1):0}function Hv(n){const{step:e,alt:s,oct:i=0,dir:r}=n;if(!r)return"";const a=e+1+7*i,c=a===0?e+1:a,h=r<0?"-":"",m=Tp[e]==="M"?"majorable":"perfectable";return h+c+Gv(m,s)}function Gv(n,e){return e===0?n==="majorable"?"M":"P":e===-1&&n==="majorable"?"m":e>0?dd("A",e):dd("d",n==="perfectable"?e:e+1)}var fd=(n,e)=>Array(Math.abs(e)+1).join(n),Mp=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),gd=new Map,jv=n=>"CDEFGAB".charAt(n),Ep=n=>n<0?fd("b",-n):fd("#",n),Pp=n=>n[0]==="b"?-n.length:n.length;function Ie(n){const e=JSON.stringify(n),s=gd.get(e);if(s)return s;const i=typeof n=="string"?Zv(n):Ch(n)?Ie(Qv(n)):Sh(n)?Ie(n.name):Mp;return gd.set(e,i),i}var Xv=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function Th(n){const e=Xv.exec(n);return e?[e[1].toUpperCase(),e[2].replace(/x/g,"##"),e[3],e[4]]:["","","",""]}function Uv(n){return Ie(Cp(n))}var Yv=(n,e)=>(n%e+e)%e,Tc=[0,2,4,5,7,9,11];function Zv(n){const e=Th(n);if(e[0]===""||e[3]!=="")return Mp;const s=e[0],i=e[1],r=e[2],a=(s.charCodeAt(0)+3)%7,c=Pp(i),h=r.length?+r:void 0,m=Sp({step:a,alt:c,oct:h}),f=s+i+r,v=s+i,y=(Tc[a]+c+120)%12,w=h===void 0?Yv(Tc[a]+c,12)-12*99:Tc[a]+c+12*(h+1),x=w>=0&&w<=127?w:null,A=h===void 0?null:Math.pow(2,(w-69)/12)*440;return{empty:!1,acc:i,alt:c,chroma:y,coord:m,freq:A,height:w,letter:s,midi:x,name:f,oct:h,pc:v,step:a}}function Qv(n){const{step:e,alt:s,oct:i}=n,r=jv(e);if(!r)return"";const a=r+Ep(s);return i||i===0?a+i:a}function Ha(n,e){const s=Ie(n),i=Array.isArray(e)?e:Ds(e).coord;if(s.empty||!i||i.length<2)return"";const r=s.coord,a=r.length===1?[r[0]+i[0]]:[r[0]+i[0],r[1]+i[1]];return Uv(a).name}function La(n,e){const s=Ie(n),i=Ie(e);if(s.empty||i.empty)return"";const r=s.coord,a=i.coord,c=a[0]-r[0],h=r.length===2&&a.length===2?a[1]-r[1]:-Math.floor(c*7/12),m=i.height===s.height&&i.midi!==null&&s.oct===i.oct&&s.step>i.step;return Ap([c,h],m).name}function Ah(n,e){const s=e.length,i=(n%s+s)%s;return e.slice(i,s).concat(e.slice(0,i))}function Jv(n){return n.filter(e=>e===0||e)}var ai={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},kp=n=>Number(n).toString(2).padStart(12,"0"),vd=n=>parseInt(n,2),Kv=/^[01]{12}$/;function Ip(n){return Kv.test(n)}var ty=n=>typeof n=="number"&&n>=0&&n<=4095,ey=n=>n&&Ip(n.chroma),yd={[ai.chroma]:ai};function Mh(n){const e=Ip(n)?n:ty(n)?kp(n):Array.isArray(n)?ay(n):ey(n)?n.chroma:ai.chroma;return yd[e]=yd[e]||ry(e)}var sy=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function ny(n){const e=[];for(let s=0;s<12;s++)n.charAt(s)==="1"&&e.push(sy[s]);return e}function iy(n,e=!0){const i=Mh(n).chroma.split("");return Jv(i.map((r,a)=>{const c=Ah(a,i);return e&&c[0]==="0"?null:c.join("")}))}function oy(n){const e=n.split("");return e.map((s,i)=>Ah(i,e).join(""))}function ry(n){const e=vd(n),s=oy(n).map(vd).filter(a=>a>=2048).sort()[0],i=kp(s),r=ny(n);return{empty:!1,name:"",setNum:e,chroma:n,normalized:i,intervals:r}}function ay(n){if(n.length===0)return ai.chroma;let e;const s=[0,0,0,0,0,0,0,0,0,0,0,0];for(let i=0;i<n.length;i++)e=Ie(n[i]),e.empty&&(e=Ds(n[i])),e.empty||(s[e.chroma]=1);return s.join("")}var ly=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7  ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 #4 #11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -7 m -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim  o"],["1P 3m 5d 7d","diminished seventh","dim7 7 o7"],["1P 3m 5d 7m","half-diminished","m7b5  -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],cy=ly,hy={...ai,name:"",quality:"Unknown",intervals:[],aliases:[]},Eh=[],ar={};function uy(n){return ar[n]||hy}function dy(){return Eh.slice()}function py(n,e,s){const i=fy(n),r={...Mh(n),name:s||"",quality:i,intervals:n,aliases:e};Eh.push(r),r.name&&(ar[r.name]=r),ar[r.setNum]=r,ar[r.chroma]=r,r.aliases.forEach(a=>my(r,a))}function my(n,e){ar[e]=n}function fy(n){const e=s=>n.indexOf(s)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}cy.forEach(([n,e,s])=>py(n.split(" "),s.split(" "),e));Eh.sort((n,e)=>n.setNum-e.setNum);var gy=n=>{const e=n.reduce((s,i)=>{const r=Ie(i).chroma;return r!==void 0&&(s[r]=s[r]||Ie(i).name),s},{});return s=>e[s]};function vy(n,e={}){const s=n.map(r=>Ie(r).pc).filter(r=>r);return Ie.length===0?[]:Cy(s,1,e).filter(r=>r.weight).sort((r,a)=>a.weight-r.weight).map(r=>r.name)}var Ga={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},ja=n=>e=>!!(e&n),yy=ja(Ga.anyThirds),by=ja(Ga.perfectFifth),wy=ja(Ga.anySeventh),_y=ja(Ga.nonPerfectFifths);function xy(n){const e=parseInt(n.chroma,2);return yy(e)&&by(e)&&wy(e)}function Sy(n){const e=parseInt(n,2);return _y(e)?n:(e|16).toString(2)}function Cy(n,e,s){const i=n[0],r=Ie(i).chroma,a=gy(n),c=iy(n,!1),h=[];return c.forEach((m,f)=>{const v=s.assumePerfectFifth&&Sy(m);dy().filter(w=>s.assumePerfectFifth&&xy(w)?w.chroma===v:w.chroma===m).forEach(w=>{const x=w.aliases[0],A=a(f);f!==r?h.push({weight:.5*e,name:`${A}${x}/${i}`}):h.push({weight:1*e,name:`${A}${x}`})})}),h}var Ty=Ds;function Ay(n){const e=Ds(n);if(e.empty)return"";const s=(7-e.step)%7,i=e.type==="perfectable"?-e.alt:-(e.alt+1);return Ds({step:s,alt:i,oct:e.oct,dir:e.dir}).name}var bd=La,My=Ey((n,e)=>[n[0]-e[0],n[1]-e[1]]);function Ey(n){return(e,s)=>{const i=Ds(e).coord,r=Ds(s).coord;if(i&&r){const a=n(i,r);return Ap(a).name}}}var Py=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],ky=Py,Iy={...ai,intervals:[],aliases:[]},lr={};function Rp(n){return lr[n]||Iy}function Ry(n,e,s=[]){const i={...Mh(n),name:e,intervals:n,aliases:s};return lr[i.name]=i,lr[i.setNum]=i,lr[i.chroma]=i,i.aliases.forEach(r=>Dy(i,r)),i}function Dy(n,e){lr[e]=n}ky.forEach(([n,e,...s])=>Ry(n.split(" "),e,s));var Dp={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function Op(n){const[e,s,i,r]=Th(n);return e===""?Ac("",n):e==="A"&&r==="ug"?Ac("","aug"):Ac(e+s,i+r)}function Ac(n,e){const s=e.split("/");if(s.length===1)return[n,s[0],""];const[i,r,a,c]=Th(s[1]);return i!==""&&a===""&&c===""?[n,s[0],i+r]:[n,e,""]}function jc(n){if(Array.isArray(n))return Aa(n[1]||"",n[0],n[2]);if(n==="")return Dp;{const[e,s,i]=Op(n),r=Aa(s,e,i);return r.empty?Aa(n):r}}function Aa(n,e,s){const i=uy(n),r=Ie(e||""),a=Ie(s||"");if(i.empty||e&&r.empty||s&&a.empty)return Dp;const c=La(r.pc,a.pc),h=i.intervals.indexOf(c),m=h>=0,f=m?a:Ie(""),v=h===-1?NaN:h+1,y=a.pc&&a.pc!==r.pc,w=Array.from(i.intervals);if(m)for(let M=1;M<v;M++){const I=w[0][0],R=w[0][1],D=parseInt(I,10)+7;w.push(`${D}${R}`),w.shift()}else if(y){const M=My(La(r.pc,a.pc),"8P");M&&w.unshift(M)}const x=r.empty?[]:w.map(M=>Ha(r.pc,M));n=i.aliases.indexOf(n)!==-1?n:i.aliases[0];const A=`${r.empty?"":r.pc}${n}${m&&v>1?"/"+f.pc:y?"/"+a.pc:""}`,E=`${e?r.pc+" ":""}${i.name}${m&&v>1?" over "+f.pc:y?" over "+a.pc:""}`;return{...i,name:E,symbol:A,tonic:r.pc,type:i.name,root:f.pc,bass:y?a.pc:"",intervals:w,rootDegree:v,notes:x}}var Oy=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],Ny=Oy;Ny.forEach(([n,e,s])=>void 0);var Ly="C C# D D# E F F# G G# A A# B".split(" "),Fy="C Db D Eb E F Gb G Ab A Bb B".split(" ");function Ph(n,e={}){if(isNaN(n)||n===-1/0||n===1/0)return"";n=Math.round(n);const i=(e.sharps===!0?Ly:Fy)[n%12];if(e.pitchClass)return i;const r=Math.floor(n/12)-1;return i+r}var mo=Ie,Fa=n=>mo(n).pc,By=n=>mo(n).oct,nn=n=>mo(n).midi;function qy(n){return Ph(n)}var cr=Ha,hr=n=>{const e=mo(n);return e.empty?"":Ph(e.midi||e.chroma,{sharps:e.alt>0,pitchClass:e.midi===null})};function wn(n,e){const s=mo(n);if(s.empty)return"";const i=mo(e||Ph(s.midi||s.chroma,{sharps:s.alt<0,pitchClass:!0}));if(i.empty||i.chroma!==s.chroma)return"";if(s.oct===void 0)return i.pc;const r=s.chroma-s.alt,a=i.chroma-i.alt,c=r>11||a<0?-1:r<0||a>11?1:0,h=s.oct+c;return i.pc+h}var Np={empty:!0,name:"",chordType:""},wd={};function Sr(n){return typeof n=="string"?wd[n]||(wd[n]=Hy(n)):typeof n=="number"?Sr(kh[n]||""):Ch(n)?$y(n):Sh(n)?Sr(n.name):Np}function $y(n){return Sr(Ep(n.alt)+kh[n.step])}var zy=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function Wy(n){return zy.exec(n)||["","","",""]}var Vy="I II III IV V VI VII",kh=Vy.split(" ");function Hy(n){const[e,s,i,r]=Wy(n);if(!i)return Np;const a=i.toUpperCase(),c=kh.indexOf(a),h=Pp(s),m=1;return{empty:!1,name:e,roman:i,interval:Ds({step:c,alt:h,dir:m}).name,acc:s,chordType:r,alt:h,step:c,major:i===a,oct:0,dir:m}}var Ih=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],_d={...ai,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},Gy=Ih.map(jy),Xc={};Gy.forEach(n=>{Xc[n.name]=n,n.aliases.forEach(e=>{Xc[e]=n})});function Lp(n){return typeof n=="string"?Xc[n.toLowerCase()]||_d:n&&n.name?Lp(n.name):_d}function jy(n){const[e,s,i,r,a,c,h]=n,m=h?[h]:[],f=Number(s).toString(2);return{empty:!1,intervals:Rp(r).intervals,modeNum:e,chroma:f,normalized:f,name:r,setNum:s,alt:i,triad:a,seventh:c,aliases:m}}function Fp(n){return(e,s)=>{const i=Lp(e);if(i.empty)return[];const r=Ah(i.modeNum,n),a=i.intervals.map(c=>Ha(s,c));return r.map((c,h)=>a[h]+c)}}Fp(Ih.map(n=>n[4]));Fp(Ih.map(n=>n[5]));function Xy(n,e){return e.map(s=>{const[i,r]=Op(s),a=La(n,i);return Sr(Ds(a)).name+r})}var Uy={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function Yy(n){if(typeof n!="string")return["",""];const e=n.indexOf(" "),s=Ie(n.substring(0,e));if(s.empty){const r=Ie(n);return r.empty?["",n.toLowerCase()]:[r.name,""]}const i=n.substring(s.name.length+1).toLowerCase();return[s.name,i.length?i:""]}function Zy(n){const e=Array.isArray(n)?n:Yy(n),s=Ie(e[0]).name,i=Rp(e[1]);if(i.empty)return Uy;const r=i.name,a=s?i.intervals.map(h=>Ha(s,h)):[],c=s?s+" "+r:r;return{...i,name:c,type:r,tonic:s,notes:a}}class Qy{constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,paint:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!0)})}disable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!1)})}enableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!0}),this.setLevel("DEBUG")}disableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!1}),this.setLevel("ERROR")}isCategoryEnabled(e){return this.categories[e]===!0}setLevel(e){const i=["DEBUG","INFO","WARN","ERROR"].indexOf(e);i!==-1&&(this.enabledLevels={DEBUG:i<=0,INFO:i<=1,WARN:i<=2,ERROR:i<=3})}formatComponent(e){return`[${e}]`}moduleLoaded(e,s="general"){!this.enabledLevels.INFO||this.isCategoryEnabled(s)}initStart(e,s="initialization"){!this.enabledLevels.INFO||this.isCategoryEnabled(s)}initSuccess(e,s="initialization"){!this.enabledLevels.INFO||this.isCategoryEnabled(s)}initFailed(e,s="",i="initialization"){!this.enabledLevels.WARN||this.isCategoryEnabled(i)}section(e,s="general"){!this.enabledLevels.INFO||this.isCategoryEnabled(s)}event(e,s,i="",r="ui"){!this.enabledLevels.INFO||!this.isCategoryEnabled(r)||this.formatComponent(e)}state(e,s,i=null,r="state"){!this.enabledLevels.INFO||!this.isCategoryEnabled(r)||(this.formatComponent(e),i&&(typeof i=="object"?JSON.stringify(i):String(i)))}debug(e,s,i=null,r="debug"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r)||(this.formatComponent(e),i&&(typeof i=="object"?JSON.stringify(i):String(i)))}timing(e,s,i,r="performance"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r)||(this.formatComponent(e),Object.entries(i).map(([a,c])=>typeof c=="number"&&c%1!==0?`${a}=${c.toFixed(3)}`:`${a}=${c}`).join(", "))}warn(e,s,i=null,r="general"){!this.enabledLevels.WARN||!this.isCategoryEnabled(r)||this.formatComponent(e)}error(e,s,i=null,r="general"){this.enabledLevels.ERROR&&this.formatComponent(e)}info(e,s,i=null,r="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(r)||this.formatComponent(e)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([e,s])=>s).map(([e])=>e)}}getAvailableCategories(){return Object.keys(this.categories)}log(e,s,i=null){this.info(e,s,i,"general")}}const S=new Qy;typeof window<"u"&&(window.logger=S);function Jy(n){const{macrobeatGroupings:e}=n,s=rn(n),i=[...n.columnWidths||[]],r=[ca,ca];S.debug("Columns Layout","Starting column width calculation",null,"layout"),S.debug("Columns Layout","Placed tonic signs",s.map(m=>`col:${m.columnIndex},mb:${m.preMacrobeatIndex}`),"layout"),S.debug("Columns Layout","Old columnWidths",i,"layout"),S.debug("Columns Layout","Macrobeat groupings",e,"layout");const a=[...s].sort((m,f)=>m.preMacrobeatIndex-f.preMacrobeatIndex);let c=0;const h=m=>{var v,y;let f=(v=a[c])==null?void 0:v.uuid;for(;a[c]&&a[c].preMacrobeatIndex===m;){S.debug("Columns Layout",`Adding tonic columns for mbIndex ${m}, tonic at column ${a[c].columnIndex}`,null,"layout");const w=r.length;for(r.push(ha),r.push(ha),S.debug("Columns Layout",`Added 2 columns (width=${ha} each), total columns: ${w} -> ${r.length}`,null,"layout");a[c]&&a[c].uuid===f;)c++;f=(y=a[c])==null?void 0:y.uuid}};return h(-1),e.forEach((m,f)=>{for(let v=0;v<m;v++)r.push(ha);h(f)}),r.push(ca,ca),S.debug("Columns Layout","Final newColumnWidths",r,"layout"),S.debug("Columns Layout","Width change",`${i.length} -> ${r.length} columns`,"layout"),S.debug("Columns Layout","Old total width units",i.reduce((m,f)=>m+f,0),"layout"),S.debug("Columns Layout","New total width units",r.reduce((m,f)=>m+f,0),"layout"),r}function Ky(n,e,s){let i=0;for(let r=0;r<n;r++)i+=(e[r]||0)*s;return i}function t0(n,e){return n.reduce((s,i)=>s+i,0)*e}const so=30;let Pe=1,sn=gv,on=0,si,ur,xd,Ui,Sd,nr,Uc,Yc,ir,Zc,Hi,Cd,Ma=!1,ws=!1,Mc=0,Ec=0,dr=!1,pr=null;function Qc(){var a;const n=((a=u.state.fullRowData)==null?void 0:a.length)||0;if(n===0)return Ca;const e=document.getElementById("pitch-grid-container"),s=on||window.innerHeight||0,i=(e==null?void 0:e.clientHeight)||(s?s*.7:0);if(!i||i<=0)return Ca;const r=2*i/(n*so);return Math.max(Ca,r)}function e0(){si=document.getElementById("pitch-grid-wrapper"),ur=document.getElementById("notation-grid"),document.getElementById("drum-grid-wrapper"),Ui=document.getElementById("drum-grid"),nr=document.getElementById("drum-playhead-canvas"),Uc=document.getElementById("playhead-canvas"),Yc=document.getElementById("hover-canvas"),ir=document.getElementById("drum-hover-canvas"),Zc=document.getElementById("pitch-paint-canvas"),Hi=document.getElementById("button-grid");const n=document.getElementById("canvas-container");return!si||!ur||!n?{}:(xd=ur.getContext("2d"),Sd=Ui.getContext("2d"),{ctx:xd,drumCtx:Sd,canvasContainer:n})}function bn(){if(!si||si.clientHeight===0){requestAnimationFrame(bn);return}if(Ma)return;Ma=!0;const n=document.getElementById("pitch-grid-container");si.clientWidth;const e=window.innerHeight;(Math.abs(e-on)>3||on===0)&&(on=e);const i=Qc();Pe<i&&(Pe=i,S.debug("LayoutService",`[Zoom] Enforcing minimum zoom to maintain grid height: ${Math.round(Pe*100)}%`,null,"layout"));const r=so,a=r*vv,c=r*Pe,h=a*Pe;u.setLayoutConfig({cellHeight:c,cellWidth:h});const m=Jy(u.state);u.setLayoutConfig({columnWidths:m});const v=m.reduce((ut,_t)=>ut+_t,0)*u.state.cellWidth,y=St.getModulatedCanvasWidth(),w=y>v?y:v,x=Math.round(w),A=document.getElementById("drum-grid-wrapper");document.getElementById("grids-wrapper");const E=x+"px";n&&(n.style.width=E),si&&(si.style.width=E),A&&(A.style.width=E);const M=Math.max(uo,po*u.state.cellHeight),I=ad*M,R=`${I}px`,D=2,G=u.state.columnWidths.length-2;let X=0;for(let ut=D;ut<G;ut++)X+=(u.state.columnWidths[ut]||0)*u.state.cellWidth;if(Hi){const ut=Hi.querySelector(".button-grid-left-cell"),_t=Hi.querySelector(".button-grid-middle-cell"),xt=Hi.querySelector(".button-grid-right-cell"),Zt=u.state.columnWidths.slice(0,2).reduce((rt,at)=>rt+at*u.state.cellWidth,0),Wt=u.state.columnWidths.slice(-2).reduce((rt,at)=>rt+at*u.state.cellWidth,0);(Math.abs(Ec-I)>5||Ec===0)&&(Hi.style.height=R,Ec=I),ut&&(ut.style.width=`${Zt}px`,ut.style.height=R),_t&&(_t.style.width=`${X}px`,_t.style.height=R),xt&&(xt.style.width=`${Wt}px`,xt.style.height=R)}[ur,Uc,Yc,Zc].forEach(ut=>{ut&&Math.abs(ut.width-x)>1&&(ut.width=x)}),[Ui,nr,ir].forEach(ut=>{ut&&Math.abs(ut.width-x)>1&&(ut.width=x)});const F=Math.max(uo,po*u.state.cellHeight),H=ad*F,Q=`${H}px`,K=Math.abs(Mc-H)>5;if(A&&(K||Mc===0)&&(A.style.height=Q,Mc=H),Ui&&Math.abs(Ui.height-H)>1&&(Ui.height=H),nr&&Math.abs(nr.height-H)>1&&(nr.height=H),ir&&Math.abs(ir.height-H)>1&&(ir.height=H),setTimeout(()=>{const _t=document.getElementById("pitch-grid-container").clientHeight;[ur,Uc,Yc,Zc].forEach((xt,Zt)=>{xt&&Math.abs(xt.height-_t)>1&&(xt.height=_t)}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))}),pr!==null){const ut=u.state.fullRowData.length;if(ut<=0)sn=0;else{const _t=Math.max(0,Math.min(ut-1,pr)),xt=document.getElementById("pitch-grid-container"),Zt=(xt==null?void 0:xt.clientHeight)||on*.7,Jt=(u.state.cellHeight||so)/2,it=Math.max(0,ut*Jt-Zt);if(it<=0)sn=0;else{const rt=_t*Jt;sn=Math.max(0,Math.min(1,rt/it))}}pr=null}u.emit("layoutConfigChanged"),Ma=!1,dr&&(dr=!1,St.snapZoomToCurrentRange())}const St={init(){const{ctx:n,drumCtx:e,canvasContainer:s}=e0();requestAnimationFrame(bn),this.initScrollHandler();const i=()=>{Ma||(clearTimeout(Cd),Cd=setTimeout(()=>{bn()},fv))};return window.addEventListener("resize",i),{ctx:n,drumCtx:e}},getCurrentZoomLevel(){return Pe},setZoomLevel(n){Pe=n,bn()},initScrollHandler(){const n=document.getElementById("pitch-grid-wrapper");n&&n.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey||e.metaKey)e.deltaY<0?this.zoomIn():this.zoomOut();else{const s=e.deltaY>0?1:-1;this.scrollByUnits(s)}},{passive:!1})},zoomIn(){ws||(u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ws=!0,Pe=Math.min(ua,Pe*yv),S.debug("LayoutService",`[Zoom] Zoom level: ${Math.round(Pe*100)}%`,null,"layout"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{bn(),ws=!1})}))},zoomOut(){if(ws)return;u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ws=!0;const n=Qc(),e=Math.max(Ca,Pe*bv),s=Math.max(n,e);s!==e&&S.debug("LayoutService",`[Zoom] Minimum zoom reached; clamping to ${Math.round(s*100)}%`,null,"layout"),Pe=s,S.debug("LayoutService",`[Zoom] Zoom level: ${Math.round(Pe*100)}%`,null,"layout"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{bn(),ws=!1})})},resetZoom(){ws||(u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ws=!0,Pe=1,S.debug("LayoutService","[Zoom] Zoom level reset to 100%",null,"layout"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{bn(),ws=!1})}))},snapZoomToCurrentRange(){if(ws){dr=!0;return}const n=Qc(),e=Math.min(ua,n);if(!isFinite(e)||e<=0)return;const s=Math.abs(Pe-e)>1e-4;ws=!0,Pe=e,n>ua+1e-4?S.debug("LayoutService",`[Zoom] Snap zoom limited by MAX_ZOOM_LEVEL (${Math.round(ua*100)}%)`,null,"layout"):s&&S.debug("LayoutService",`[Zoom] Snap zoom to range: ${Math.round(Pe*100)}%`,null,"layout"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{bn(),ws=!1,dr&&(dr=!1,this.snapZoomToCurrentRange())})})},setPendingStartRow(n){typeof n=="number"&&Number.isFinite(n)?pr=Math.max(0,n):pr=null},scroll(n){const e=n/on/4;sn=Math.max(0,Math.min(1,sn+e)),u.emit("layoutConfigChanged")},scrollByUnits(n){const e=u.state.fullRowData.length,i=(u.state.cellHeight||so)/2,a=e*i,c=document.getElementById("pitch-grid-container"),h=(c==null?void 0:c.clientHeight)||on*.7,m=Math.max(0,a-h);if(m>0){const f=n*i/m;sn=Math.max(0,Math.min(1,sn+f)),u.emit("layoutConfigChanged")}},scrollByPixels(n,e=0){const s=-n,i=u.state.fullRowData.length,a=(u.state.cellHeight||so)*Pe,h=i*a,m=Math.max(0,h-on);if(m>0){const f=s/m;sn=Math.max(0,Math.min(1,sn+f))}u.emit("layoutConfigChanged")},getViewportInfo(){const n=u.state.fullRowData.length,e=document.getElementById("pitch-grid-container"),s=(e==null?void 0:e.clientHeight)||on*.7,i=u.state.cellHeight||so,r=i/2,c=n*r,m=Math.max(0,c-s)*sn,f=Math.max(0,Math.floor(m/r)),v=s/r,y=Math.min(n,Math.ceil(f+v));return{zoomLevel:Pe,viewportHeight:on,containerHeight:s,cellHeight:i,halfUnit:r,startRank:f,endRank:y,scrollOffset:m}},getMacrobeatWidthPx(n,e){return e*n.cellWidth},getColumnX(n){return Ky(n,u.state.columnWidths,u.state.cellWidth)},getCanvasWidth(){return t0(u.state.columnWidths,u.state.cellWidth)},getModulatedCanvasWidth(){const n=this.getCanvasWidth();if(!u.state.modulationMarkers||u.state.modulationMarkers.length===0)return n;try{const e=u.state.baseMicrobeatPx||u.state.cellWidth||40;let s=n;return u.state.modulationMarkers.forEach(r=>{r.ratio>1&&(s*=r.ratio)}),Math.max(n,s)}catch{return n}},recalculateLayout(){bn()},get isZooming(){return ws}},s0=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],rn=n=>n.tonicSignGroups?Object.values(n.tonicSignGroups).flat():[],us=(n,e)=>{let s=2;const{macrobeatGroupings:i}=n,r=rn(n);r.some(m=>m.preMacrobeatIndex===-1)&&(s+=2);for(let m=0;m<e;m++)s+=i[m],r.some(f=>f.preMacrobeatIndex===m)&&(s+=2);const a=s,c=i[e],h=a+(c||0)-1;return{startColumn:a,endColumn:h,grouping:c}},n0=n=>n.placedNotes.filter(e=>!e.isDrum),i0=n=>n.placedNotes.filter(e=>e.isDrum),o0=(n,e)=>{const i=rn(n).filter(h=>h.columnIndex<=e);if(i.length===0)return{keyTonic:"C",keyMode:"major"};const r=i.reduce((h,m)=>m.columnIndex>h.columnIndex?m:h),a=Fa(n.fullRowData[r.row].toneNote),c=s0[r.tonicNumber-1]||"major";return{keyTonic:a,keyMode:c}},r0=(n,e)=>{const s=[],{fullRowData:i,placedNotes:r,placedChords:a}=n;return r.forEach(c=>{var h;if(!c.isDrum&&e>=c.startColumnIndex&&e<=c.endColumnIndex){const m=(h=i[c.row])==null?void 0:h.toneNote;m&&s.push(m)}}),a.forEach(c=>{c.position.xBeat===e&&s.push(...c.notes)}),s},a0=(n,e)=>{const s=new Set,{startColumn:i,endColumn:r}=us(n,e);for(let c=i;c<=r;c++)r0(n,c).forEach(m=>{s.add(Fa(m))});return Array.from(s)};function Td(n){if(!n)return null;const e=Ty(n);if(!e||e.num===void 0)return null;let s="";const i=e.alt,r=Math.abs(e.num);return i<0?s="".repeat(Math.abs(i)):i>0&&(s="".repeat(i)),`${s}${r}`}function Ad(n){return n&&{"1":"2","2":"1","2":"3","3":"2","4":"5","5":"4","5":"6","6":"5","6":"7","7":"6"}[n]||null}function Md(n){return n&&(n.includes("")||n.includes(""))}const Jc={getEnharmonicDegree:Ad,hasAccidental:Md,getDegreeForNote(n,e){var f;if(!n||!e)return null;const{keyTonic:s,keyMode:i}=o0(e,n.startColumnIndex);if(!s)return null;const r=(f=e.fullRowData[n.row])==null?void 0:f.toneNote;if(!r)return null;const a=Fa(r);let c=s;if(e.degreeDisplayMode!=="modal"&&i!=="major"){const y=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(i);if(y>0){const x=["1P","2M","3M","4P","5P","6M","7M"][y];c=cr(s,Ay(x))}}const h=bd(c,a),m=Td(h);if(n.enharmonicPreference&&Md(m)){const v=Ad(m);if(v)return v}return m},getDegreesForNotes(n,e){return!n||n.length===0?[]:n.map(s=>{const i=bd(e,Fa(s));return Td(i)})},getRomanNumeralForNotes(n,e,s){if(!n||n.length<2)return null;const[i]=vy(n);if(!i)return null;const r=jc(i).symbol;if(!r)return null;const[a]=Xy(e,[r]);if(!a)return null;const c=Sr(a),h=c.roman;let m=c.name.replace(h,"");const f=jc(i).tonic;return m==="6"&&(m="add6"),{roman:h,ext:m,root:f}}};function Pc(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const l0={addNote(n){const e=this.state.placedNotes.find(i=>!i.isDrum&&i.row===n.row&&i.startColumnIndex===n.startColumnIndex&&i.color===n.color);if(e){if(this.state.degreeDisplayMode!=="off"){const i=Jc.getDegreeForNote(e,this.state);if(Jc.hasAccidental(i))return e.enharmonicPreference=!e.enharmonicPreference,S.debug("NoteActions","[ENHARMONIC] Toggled enharmonic preference for note",{noteUuid:e.uuid,currentDegree:i,enharmonicPreference:e.enharmonicPreference},"notes"),this.emit("notesChanged"),e}return null}const s={...n,uuid:Pc()};return this.state.placedNotes.push(s),this.emit("notesChanged"),s},updateNoteTail(n,e){n.endColumnIndex=e,this.emit("notesChanged")},updateMultipleNoteTails(n,e){n.forEach(s=>{s.endColumnIndex=e}),this.emit("notesChanged")},updateNoteRow(n,e){n.row=e,this.emit("notesChanged")},updateMultipleNoteRows(n,e){n.forEach((s,i)=>{s.row=e[i]}),this.emit("notesChanged")},eraseInPitchArea(n,e,s=1,i=!0){const r=n+s-1,a=e-1,c=e+1;let h=!1;const m=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(f=>{if(f.isDrum)return!0;if(f.shape==="circle"){const v=f.startColumnIndex+1,y=f.startColumnIndex<=r&&v>=n,w=f.row>=a&&f.row<=c;if(y&&w)return!1}else if(f.row>=a&&f.row<=c&&f.startColumnIndex<=r&&f.endColumnIndex>=n)return!1;return!0}),this.state.placedNotes.length<m&&(h=!0),h&&(this.emit("notesChanged"),i&&this.recordState()),h},eraseDrumNoteAt(n,e,s=!0){const i=this.state.placedNotes.length;this.state.placedNotes=this.state.placedNotes.filter(a=>!(a.isDrum&&a.drumTrack===e&&a.startColumnIndex===n));const r=this.state.placedNotes.length<i;return r&&(this.emit("notesChanged"),s&&this.recordState()),r},addTonicSignGroup(n){S.debug("TonicPlacement","Starting addTonicSignGroup",{tonicSignGroup:n},"state");const e=n[0],{preMacrobeatIndex:s}=e;if(S.debug("TonicPlacement","preMacrobeatIndex",{preMacrobeatIndex:s},"state"),Object.values(this.state.tonicSignGroups).flat().some(h=>h.preMacrobeatIndex===s)){S.debug("TonicPlacement","Tonic already exists at this preMacrobeatIndex, returning",null,"state");return}const i=us(this.state,s+1).startColumn;S.debug("TonicPlacement","Boundary column for shifting notes",{boundaryColumn:i},"state");const r=this.state.placedNotes.filter(h=>h.startColumnIndex>=i);S.debug("TonicPlacement","Notes that will be shifted",{noteRanges:r.map(h=>`${h.startColumnIndex}-${h.endColumnIndex}`)},"state"),this.state.placedNotes.forEach(h=>{if(h.startColumnIndex>=i){const m=h.startColumnIndex,f=h.endColumnIndex;h.startColumnIndex+=2,h.endColumnIndex+=2,S.debug("TonicPlacement",`Shifted note from ${m}-${f} to ${h.startColumnIndex}-${h.endColumnIndex}`,null,"state")}});const a=Pc(),c=n.map(h=>({...h,uuid:a}));this.state.tonicSignGroups[a]=c,S.debug("TonicPlacement","Added tonic group",{uuid:a,columns:c.map(h=>h.columnIndex)},"state"),S.debug("TonicPlacement","Emitting events: notesChanged, rhythmStructureChanged",null,"state"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(n,e=!0){const s=Object.entries(this.state.tonicSignGroups).find(([h,m])=>m.some(f=>f.columnIndex===n));if(!s)return!1;const[i,r]=s,a=r[0].preMacrobeatIndex,c=us(this.state,a+1).startColumn;return delete this.state.tonicSignGroups[i],this.state.placedNotes.forEach(h=>{h.startColumnIndex>=c&&(h.startColumnIndex-=2,h.endColumnIndex-=2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),e&&this.recordState(),!0},toggleDrumNote(n){const e=this.state.placedNotes.findIndex(s=>s.isDrum&&s.drumTrack===n.drumTrack&&s.startColumnIndex===n.startColumnIndex);e>=0?this.state.placedNotes.splice(e,1):this.state.placedNotes.push({...n,uuid:Pc()}),this.emit("notesChanged"),this.recordState()},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(n){this.state.placedNotes=n,this.emit("notesChanged"),this.recordState()}},c0={setADSR(n,e){this.state.timbres[n]&&(this.state.timbres[n].adsr=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setFilterSettings(n,e){if(this.state.timbres[n]){S.debug("TimbreActions","setFilterSettings called",{color:n,newSettings:e,activePresetName:this.state.timbres[n].activePresetName},"timbre"),S.debug("TimbreActions","setFilterSettings call stack",{stack:new Error().stack},"timbre"),Object.assign(this.state.timbres[n].filter,e);const s=this.state.timbres[n].filter.blend;s<=0?this.state.timbres[n].filter.type="highpass":s>=2?this.state.timbres[n].filter.type="lowpass":this.state.timbres[n].filter.type="bandpass",e.enabled===void 0&&(S.debug("TimbreActions","Clearing activePresetName because enabled is undefined",{color:n},"timbre"),this.state.timbres[n].activePresetName=null),this.emit("timbreChanged",n)}},setHarmonicCoefficients(n,e){this.state.timbres[n]&&(this.state.timbres[n].coeffs=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setHarmonicPhases(n,e){this.state.timbres[n]&&(S.debug("TimbreActions",`setHarmonicPhases called for ${n}`,null,"state"),S.debug("TimbreActions","Old phases",{phases:this.state.timbres[n].phases},"state"),S.debug("TimbreActions","New phases",{phases:e},"state"),S.debug("TimbreActions","Coefficients before phase change",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].phases=e,this.state.timbres[n].activePresetName=null,S.debug("TimbreActions","Coefficients after phase change",{coeffs:this.state.timbres[n].coeffs},"state"),S.debug("TimbreActions","Emitting timbreChanged for phase change",null,"state"),this.emit("timbreChanged",n))},applyPreset(n,e){!e||!this.state.timbres[n]||(S.debug("TimbreActions",`applyPreset called for ${n}`,null,"state"),S.debug("TimbreActions","Preset name",{name:e.name},"state"),S.debug("TimbreActions","Preset coeffs",{coeffs:e.coeffs},"state"),S.debug("TimbreActions","Old timbre coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].adsr=e.adsr,this.state.timbres[n].coeffs=new Float32Array(e.coeffs),e.phases?this.state.timbres[n].phases=new Float32Array(e.phases):this.state.timbres[n].phases=new Float32Array(this.state.timbres[n].coeffs.length).fill(0),this.state.timbres[n].activePresetName=e.name,this.state.timbres[n].gain=e.gain||1,e.filter?this.state.timbres[n].filter=JSON.parse(JSON.stringify(e.filter)):this.state.timbres[n].filter=bp(),S.debug("TimbreActions","Applied preset - new coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.emit("timbreChanged",n),this.recordState())}};function Gi(n,...e){}const Rs={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function h0(n,e){if(Gi("log","[MODULATION] measureIndexToCanvasX called:",{measureIndex:n,hasState:!!e,cellWidth:e?e.cellWidth:"N/A"}),!e)return n*200;const s=e.cellWidth||40;if(n===0)return 2*s;const i=n-1,r=us(e,i);return r?(r.endColumn+1)*s:n*s*4}function u0(n,e,s=null,i=null,r=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:n,ratio:e,active:!0,xPosition:s,columnIndex:i,macrobeatIndex:r}}function Bp(n){return Math.abs(n-Rs.COMPRESSION_2_3)<.001?"2:3":Math.abs(n-Rs.EXPANSION_3_2)<.001?"3:2":`${n}`}function qp(n){return Math.abs(n-Rs.COMPRESSION_2_3)<.001?"#dc3545":Math.abs(n-Rs.EXPANSION_3_2)<.001?"#007bff":"#6c757d"}function Ed(n){return{segments:[{startX:0,endX:1/0,scale:1,spacingPx:n}],microbeatToCanvasX(e){return e*n},canvasXToMicrobeat(e){return e/n},getSegmentAtX(e){return this.segments[0]},getGhostGridPositions(e,s){return[]}}}function $p(n,e,s=null){if(!n||n.length===0)return Ed(e);const i=[...n.filter(h=>h.active)].sort((h,m)=>h.measureIndex-m.measureIndex);if(i.length===0)return Ed(e);const r=i.map(h=>{let m;return h.xPosition!==null&&h.xPosition!==void 0?(m=h.xPosition,Gi("log",`[MODULATION] Marker at measure ${h.measureIndex}  using stored x=${m}`)):(m=h0(h.measureIndex,s),Gi("log",`[MODULATION] Marker at measure ${h.measureIndex}  calculated x=${m}`)),Gi("log","[MODULATION] Final marker position:",{id:h.id,measureIndex:h.measureIndex,canvasX:m,isStored:h.xPosition!==null&&h.xPosition!==void 0}),{...h,xCanvas:m}}),a=[];let c=1;(r.length===0||r[0].xCanvas>0)&&a.push({startX:0,endX:r.length>0?r[0].xCanvas:1/0,scale:1,spacingPx:e});for(let h=0;h<r.length;h++){const m=r[h],f=h+1<r.length?r[h+1].xCanvas:1/0;c*=m.ratio,a.push({startX:m.xCanvas,endX:f,scale:c,spacingPx:e*c,marker:m})}return{segments:a,microbeatToCanvasX(h){let m=0,f=0;for(const v of a){const w=(v.endX-v.startX)/v.spacingPx;if(f+w>=h){const x=h-f;return v.startX+x*v.spacingPx}f+=w,m=v.endX}return m},canvasXToMicrobeat(h){let m=0;for(const f of a){if(h>=f.startX&&h<f.endX){const w=(h-f.startX)/f.spacingPx;return m+w}const v=f.endX-f.startX;m+=v/f.spacingPx}return m},getSegmentAtX(h){return a.find(m=>h>=m.startX&&h<m.endX)||null},getGhostGridPositions(h,m){if(Gi("log","[GHOST-CALC] getGhostGridPositions called with:",{segment:h,hasMarker:!!h.marker,hasOptions:!!m}),!h.marker)return[];if(!m||!m.columnWidths)return[];const f=[],{columnWidths:v,cellWidth:y}=m;if(Gi("log","[GHOST-CALC] Options check:",{hasColumnWidths:!!v,columnCount:v?v.length:0,cellWidth:y,segmentStartX:h.startX,segmentEndX:h.endX,segmentScale:h.scale}),!v||!y||y===0)return[];let w=0;for(let x=0;x<v.length;x++){const A=w;if(h.endX===1/0?A>=h.startX:A>=h.startX&&A<h.endX){let I,R;if(h.endX===1/0){const D=v.reduce((G,X)=>G+X,0)*y;R=Math.max(D,h.startX+800),I=R-h.startX}else I=h.endX-h.startX,R=h.endX;if(I>0&&h.scale>0){const D=(A-h.startX)/I,G=I/h.scale,X=h.startX+D*G;!isNaN(X)&&isFinite(X)&&f.push(X)}}const M=v[x]||0;if(w+=M*y,h.endX!==1/0&&w>h.endX)break}return f}}}function d0(n,e,s){let i=0;for(const r of e.segments){if(n>=r.startX&&n<r.endX){const f=(n-r.startX)/r.spacingPx,v=s/r.scale;return i+f*v}const c=(r.endX-r.startX)/r.spacingPx,h=s/r.scale;i+=c*h}return i}const p0={setAnacrusis(n){var m,f,v;if(this.state.hasAnacrusis===n)return;const e=[...this.state.macrobeatGroupings],s=[...this.state.macrobeatBoundaryStyles],i=e.reduce((y,w)=>y+w,0);let r,a;if(n){const y=this._anacrusisCache,w=rd.length-Hc.length,x=rd.slice(0,w),A=pv.slice(0,w),E=(m=y==null?void 0:y.groupings)!=null&&m.length?[...y.groupings]:[...x],M=(f=y==null?void 0:y.boundaryStyles)!=null&&f.length?[...y.boundaryStyles]:[...A];if(r=[...E,...e],a=[...M,...s],!((v=y==null?void 0:y.boundaryStyles)!=null&&v.length))for(let I=0;I<M.length;I++)a[I]=I<M.length-1?"anacrusis":"solid";this._anacrusisCache=null,S.debug("rhythmActions","Enabled anacrusis",{insertedCount:E.length,insertedColumns:E.reduce((I,R)=>I+R,0)},"state")}else{const y=s.findIndex(E=>E==="solid");let w=0;if(y!==-1)w=y+1;else for(;w<s.length&&s[w]==="anacrusis";)w++;w=Math.min(w,e.length);const x=e.slice(0,w),A=s.slice(0,w);w>0?this._anacrusisCache={groupings:x,boundaryStyles:A}:this._anacrusisCache=null,r=e.slice(w),a=s.slice(w).map(E=>E==="anacrusis"?"dashed":E),r.length===0&&(r=[...Hc],a=[...gp]),S.debug("rhythmActions","Disabled anacrusis",{removalCount:w,removedColumns:x.reduce((E,M)=>E+M,0)},"state")}const h=r.reduce((y,w)=>y+w,0)-i;if(this.state.hasAnacrusis=n,this.state.macrobeatGroupings=[...r],this.state.macrobeatBoundaryStyles=[...a],h!==0){const y=[];this.state.placedNotes.forEach(A=>{if(A.startColumnIndex>=2){const M=A.startColumnIndex+h,I=A.endColumnIndex+h;M<2?y.push(A):(A.startColumnIndex=M,A.endColumnIndex=I)}}),y.forEach(A=>{const E=this.state.placedNotes.indexOf(A);E>-1&&this.state.placedNotes.splice(E,1)});const w=[];this.state.stampPlacements.forEach(A=>{if(A.startColumn>=2){const M=A.startColumn+h,I=A.endColumn+h;M<2?w.push(A):(A.startColumn=M,A.endColumn=I)}}),w.forEach(A=>{const E=this.state.stampPlacements.indexOf(A);E>-1&&this.state.stampPlacements.splice(E,1)});const x=[];this.state.tripletPlacements&&(this.state.tripletPlacements.forEach(A=>{const E=h/2,M=1;if(A.startCellIndex>=M){const I=A.startCellIndex+E;I<M?x.push(A):A.startCellIndex=I}}),x.forEach(A=>{const E=this.state.tripletPlacements.indexOf(A);E>-1&&this.state.tripletPlacements.splice(E,1)})),Object.values(this.state.tonicSignGroups).flat().forEach(A=>{A.preMacrobeatIndex>=0})}this.emit("anacrusisChanged",n),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(n){if(n===void 0||n<0||n>=this.state.macrobeatGroupings.length){S.error("rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${n}`,null,"state");return}const e=this.state.macrobeatGroupings[n],s=e===2?3:2,i=s-e;let r=2;const a=Object.values(this.state.tonicSignGroups).flat(),c=new Set(a.filter(h=>h.preMacrobeatIndex<n).map(h=>h.uuid)).size;r+=c;for(let h=0;h<=n;h++)r+=this.state.macrobeatGroupings[h];this.state.placedNotes.forEach(h=>{h.startColumnIndex>=r&&(h.startColumnIndex+=i,h.endColumnIndex+=i)}),this.state.macrobeatGroupings[n]=s,this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(n){if(n===void 0||n<0||n>=this.state.macrobeatBoundaryStyles.length){S.error("rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${n}`,null,"state");return}const e=this._isBoundaryInAnacrusis(n);let s;e?s=["dashed","solid","anacrusis"]:s=["dashed","solid"];const i=this.state.macrobeatBoundaryStyles[n],r=s.indexOf(i),a=r===-1?0:(r+1)%s.length;this.state.macrobeatBoundaryStyles[n]=s[a],this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(n){if(!this.state.hasAnacrusis)return!1;for(let e=0;e<=n;e++)if(this.state.macrobeatBoundaryStyles[e]==="solid")return e===n;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){this.state.macrobeatGroupings.length>1&&(this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),this.emit("rhythmStructureChanged"),this.recordState())},updateTimeSignature(n,e){if(!Array.isArray(e)||e.length===0){S.error("rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let s=0,i=0,r=0;for(let x=0;x<this.state.macrobeatGroupings.length;x++){if(r===n){s=x;break}const A=x===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[x]==="solid"||A)&&r++}r=0;for(let x=0;x<this.state.macrobeatGroupings.length;x++)if(r===n){const A=x===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[x]==="solid"||A){i=x;break}}else if(r<n){const A=x===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[x]==="solid"||A)&&r++}const a=i-s+1,c=e.length,h=e.reduce((x,A)=>x+A,0)-this.state.macrobeatGroupings.slice(s,i+1).reduce((x,A)=>x+A,0);let m=2;const f=Object.values(this.state.tonicSignGroups).flat(),v=new Set(f.filter(x=>x.preMacrobeatIndex<=i).map(x=>x.uuid)).size;m+=v;for(let x=0;x<=i;x++)m+=this.state.macrobeatGroupings[x];h!==0&&this.state.placedNotes.forEach(x=>{x.startColumnIndex>=m&&(x.startColumnIndex+=h,x.endColumnIndex+=h)});const y=[...e],w=new Array(c-1).fill("dashed");if(i<this.state.macrobeatBoundaryStyles.length){const x=this.state.macrobeatBoundaryStyles[i];c>0&&w.push(x)}this.state.macrobeatGroupings.splice(s,a,...y),this.state.macrobeatBoundaryStyles.splice(s,a-1,...w),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(n,e,s=null,i=null,r=null){if(!Object.values(Rs).includes(e))return S.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state"),null;const a=this.state.modulationMarkers.findIndex(h=>h.measureIndex===n||r!==null&&h.macrobeatIndex===r||i!==null&&h.columnIndex===i);if(a!==-1){const h=this.state.modulationMarkers[a];return S.info("rhythmActions",`Replacing existing modulation marker ${h.id} at measure ${n} (old ratio: ${h.ratio}, new ratio: ${e})`,null,"state"),h.ratio=e,h.xPosition=s,i!==null&&(h.columnIndex=i),r!==null&&(h.macrobeatIndex=r),this.emit("modulationMarkersChanged"),this.recordState(),h.id}const c=u0(n,e,s,i,r);return this.state.modulationMarkers.push(c),this.state.modulationMarkers.sort((h,m)=>h.measureIndex-m.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),S.info("rhythmActions",`Added modulation marker ${c.id} at measure ${n} with ratio=${e}, columnIndex=${i}`,null,"state"),c.id},removeModulationMarker(n){const e=this.state.modulationMarkers.findIndex(s=>s.id===n);if(e===-1){S.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}this.state.modulationMarkers.splice(e,1),this.emit("modulationMarkersChanged"),this.recordState(),S.info("rhythmActions",`Removed modulation marker ${n}`,null,"state")},setModulationRatio(n,e){if(!Object.values(Rs).includes(e)){S.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state");return}const s=this.state.modulationMarkers.find(i=>i.id===n);if(!s){S.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.ratio=e,this.emit("modulationMarkersChanged"),this.recordState(),S.info("rhythmActions",`Updated modulation marker ${n} ratio to ${e}`,null,"state")},moveModulationMarker(n,e){const s=this.state.modulationMarkers.find(i=>i.id===n);if(!s){S.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.measureIndex=e,this.state.modulationMarkers.sort((i,r)=>i.measureIndex-r.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),S.info("rhythmActions",`Moved modulation marker ${n} to measure ${e}`,null,"state")},toggleModulationMarker(n){const e=this.state.modulationMarkers.find(s=>s.id===n);if(!e){S.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}e.active=!e.active,this.emit("modulationMarkersChanged"),this.recordState(),S.info("rhythmActions",`Toggled modulation marker ${n} active state to ${e.active}`,null,"state")},clearModulationMarkers(){const n=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),S.info("rhythmActions",`Cleared ${n} modulation markers`,null,"state")}};function m0(n,e,s){if(!n||typeof n!="object")return!0;const i=e.topIndex,r=s.topIndex,a=s.bottomIndex,c=a-r;let h=!1,m=!1;const f=v=>{if(typeof v!="number")return v;h=!0;const y=v+i;y>=r&&y<=a&&(m=!0);const w=y-r;return Math.max(0,Math.min(c,w))};if(typeof n.row=="number"&&(n.row=f(n.row)),typeof n.startRow=="number"&&(n.startRow=f(n.startRow)),typeof n.endRow=="number"&&(n.endRow=f(n.endRow)),typeof n.mouseRow=="number"&&(n.mouseRow=f(n.mouseRow)),typeof n.baseRow=="number"&&(n.baseRow=f(n.baseRow)),Array.isArray(n.path)){let v=!1;n.path.forEach(y=>{if(y&&typeof y.row=="number"){const w=y.row+i;w>=r&&w<=a&&(v=!0),y.row=Math.max(0,Math.min(c,w-r))}}),n.path.length>0&&(h=!0,v&&(m=!0))}if(Array.isArray(n.points)){let v=!1;n.points.forEach(y=>{if(y&&typeof y.row=="number"){const w=y.row+i;w>=r&&w<=a&&(v=!0),y.row=Math.max(0,Math.min(c,w-r))}}),n.points.length>0&&(h=!0,v&&(m=!0))}return n.data&&typeof n.data=="object"&&Object.entries(n.data).forEach(([v,y])=>{if(y&&typeof y=="object"){if(Array.isArray(y))y.forEach(w=>{if(w&&typeof w.row=="number"){const x=w.row+i;x>=r&&x<=a&&(m=!0),h=!0,w.row=Math.max(0,Math.min(c,x-r))}});else if(typeof y.row=="number"){const w=y.row+i;w>=r&&w<=a&&(m=!0),h=!0,y.row=Math.max(0,Math.min(c,w-r))}}}),!h||m}const f0={toggleAccidentalMode(n){if(!this.state.accidentalMode.hasOwnProperty(n))return;const e=this.state.accidentalMode[n],s=n==="flat"?"sharp":"flat",i=this.state.accidentalMode[s];e&&!i?(this.state.accidentalMode[s]=!0,this.state.accidentalMode[n]=!1):this.state.accidentalMode[n]=!e,this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged")},toggleFrequencyLabels(){this.state.showFrequencyLabels=!this.state.showFrequencyLabels,this.emit("frequencyLabelsChanged",this.state.showFrequencyLabels),this.emit("layoutConfigChanged")},toggleFocusColours(){this.state.focusColours=!this.state.focusColours,this.emit("focusColoursChanged",this.state.focusColours),this.emit("layoutConfigChanged")},setSnapZoomToRange(n){const e=!!n;this.state.snapZoomToRange!==e&&(this.state.snapZoomToRange=e,this.emit("snapZoomSettingChanged",e))},setDegreeDisplayMode(n){this.state.degreeDisplayMode,this.state.degreeDisplayMode=this.state.degreeDisplayMode===n?"off":n;const e=this.state.degreeDisplayMode;this.emit("layoutConfigChanged"),this.emit("degreeDisplayModeChanged",e)},setSelectedTool(n,e){if(this.state.selectedTool!==n||n==="tonicization"&&this.state.selectedToolTonicNumber!==e){const i=this.state.selectedTool;this.state.previousTool=i,this.state.selectedTool=n,n==="tonicization"&&e&&(this.state.selectedToolTonicNumber=parseInt(e,10)),this.emit("toolChanged",{newTool:n,oldTool:i})}},setSelectedNote(n,e){const s={...this.state.selectedNote};this.state.selectedNote={shape:n,color:e},this.emit("noteChanged",{newNote:this.state.selectedNote,oldNote:s})},setKeySignature(n){this.state.keySignature!==n&&(this.state.keySignature=n,this.emit("keySignatureChanged",n))},setTempo(n){this.state.tempo=n,this.emit("tempoChanged",n)},setLooping(n){this.state.isLooping=n,this.emit("loopingChanged",n)},setPlaybackState(n,e=!1){this.state.isPlaying=n,this.state.isPaused=e,this.emit("playbackStateChanged",{isPlaying:n,isPaused:e})},toggleWaveformExtendedView(){this.state.waveformExtendedView=!this.state.waveformExtendedView,this.emit("waveformExtendedViewChanged",this.state.waveformExtendedView)},setAdsrTimeAxisScale(n){const e=Math.max(.1,Math.min(5,n));this.state.adsrTimeAxisScale=e,this.emit("adsrTimeAxisScaleChanged",e)},setAdsrComponentWidth(n){const e=Math.max(50,Math.min(200,n));this.state.adsrComponentWidth=e,this.emit("adsrComponentWidthChanged",e)},setLayoutConfig(n){const e={cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]};let s=!1;if(n.cellWidth!==void 0&&this.state.cellWidth!==n.cellWidth&&(this.state.cellWidth=n.cellWidth,s=!0),n.cellHeight!==void 0&&this.state.cellHeight!==n.cellHeight&&(this.state.cellHeight=n.cellHeight,s=!0),n.columnWidths!==void 0){const i=JSON.stringify(this.state.columnWidths||[]),r=JSON.stringify(n.columnWidths);i!==r&&(this.state.columnWidths=[...n.columnWidths],s=!0)}s&&this.emit("layoutConfigChanged",{oldConfig:e,newConfig:{cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]}})},setGridPosition(n){const e=this.state.fullRowData.length-this.state.viewportRows*2,s=Math.max(0,Math.min(n,e));this.state.gridPosition!==s&&(this.state.gridPosition=s,this.emit("layoutConfigChanged"))},shiftGridUp(){this.setGridPosition(this.state.gridPosition-1)},shiftGridDown(){this.setGridPosition(this.state.gridPosition+1)},setPrintOptions(n){this.state.printOptions={...this.state.printOptions,...n},this.emit("printOptionsChanged",this.state.printOptions)},setPrintPreviewActive(n){this.state.isPrintPreviewActive,this.state.isPrintPreviewActive=n,this.emit("printPreviewStateChanged",n)},setPitchRange(n,e={}){const s=ke.length,i=this.state.pitchRange||{topIndex:0,bottomIndex:s-1};if(!n||s===0)return;const r=n.topIndex??i.topIndex,a=n.bottomIndex??i.bottomIndex,c=Math.max(0,Math.min(s-1,r)),h=Math.max(c,Math.min(s-1,a));if(i.topIndex===c&&i.bottomIndex===h)return;const m=ke.slice(c,h+1),f=m.length-1;let v=0,y=0,w=0;if(this.state.placedNotes=this.state.placedNotes.filter(E=>{if(E.isDrum)return!0;const M=E.row+i.topIndex;return M<c||M>h?(v+=1,!1):(E.row=M-c,!0)}),this.state.tonicSignGroups){const E={};Object.entries(this.state.tonicSignGroups).forEach(([M,I])=>{const R=I.map(D=>{if(typeof D.row!="number")return null;const G=D.row+i.topIndex;return G<c||G>h?null:{...D,row:G-c}}).filter(Boolean);R.length>0&&(E[M]=R)}),this.state.tonicSignGroups=E}if(Array.isArray(this.state.stampPlacements)&&(this.state.stampPlacements=this.state.stampPlacements.filter(E=>{const M=E.row+i.topIndex;return M<c||M>h?(y+=1,!1):(E.row=M-c,!0)})),Array.isArray(this.state.tripletPlacements)&&(this.state.tripletPlacements=this.state.tripletPlacements.filter(E=>{const M=E.row+i.topIndex;return M<c||M>h?(w+=1,!1):(E.row=M-c,!0)})),Array.isArray(this.state.annotations)&&this.state.annotations.length>0){const E={topIndex:c,bottomIndex:h};this.state.annotations=this.state.annotations.filter(M=>m0(M,i,E))}if(this.state.printOptions){const E=this.state.printOptions.topRow??0,M=this.state.printOptions.bottomRow??f,I=i.topIndex-c,R=Math.max(0,Math.min(f,E+I)),D=Math.max(R,Math.min(f,M+I));this.state.printOptions={...this.state.printOptions,topRow:R,bottomRow:D}}this.state.pitchRange={topIndex:c,bottomIndex:h},this.state.fullRowData=m;let x=null;if(typeof e.maintainGlobalStart=="number"&&Number.isFinite(e.maintainGlobalStart)){const E=Math.round(e.maintainGlobalStart-c);x=Math.max(0,Math.min(f,E))}const A={removedNotes:v,removedStamps:y,removedTriplets:w,maintainStartRow:x};this.emit("pitchRangeChanged",{topIndex:c,bottomIndex:h,metadata:A}),this.emit("layoutConfigChanged"),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("annotationsChanged"),this.recordState()}},g0={addChord(n){},updateChord(n,e){},deleteChord(n){},setActiveChord(n){},setRegionContext(n){},rebuildAllChords(n){},setActiveChordIntervals(n){this.state.activeChordIntervals=n,this.emit("activeChordIntervalsChanged",n)},setIntervalsInversion(n){this.state.isIntervalsInverted=n,this.emit("intervalsInversionChanged",n)},setChordPosition(n){this.state.chordPositionState=n,this.emit("chordPositionChanged",n)},openChordCandidateMenu(n,e,s){this.state.isChordCandidateMenuOpen=!0,this.state.activeMacrobeatIndex=n,this.state.chordCandidates=e,this.state.chordCandidateMenuPosition=s,this.emit("chordCandidateMenuStateChanged")},closeChordCandidateMenu(){this.state.isChordCandidateMenuOpen=!1,this.state.activeMacrobeatIndex=null,this.emit("chordCandidateMenuStateChanged")},applyChordCandidate(n){if(this.state.activeMacrobeatIndex===null)return;const{startColumn:e,endColumn:s}=us(this.state,this.state.activeMacrobeatIndex);a0(this.state,this.state.activeMacrobeatIndex);let i="C8";this.state.placedNotes.forEach(v=>{if(v.startColumnIndex>=e&&v.startColumnIndex<=s){const y=this.state.fullRowData[v.row].toneNote;nn(y)<nn(i)&&(i=y)}});const r=By(i),c=`${jc(n).tonic}${r}`,h=Aa(n,c).notes.map(v=>hr(v));this.state.placedNotes=this.state.placedNotes.filter(v=>v.startColumnIndex<e||v.startColumnIndex>s);const{shape:m,color:f}=this.state.selectedNote;h.forEach(v=>{const y=this.state.fullRowData.findIndex(w=>w.toneNote===v);if(y!==-1){const w={row:y,startColumnIndex:e,endColumnIndex:e,color:f,shape:m,isDrum:!1};this.addNote(w)}}),this.closeChordCandidateMenu(),this.recordState(),this.emit("notesChanged")}};S.moduleLoaded("paintActions","state");const v0={setMicPaintActive(n){this.state.paint.isMicPaintActive=n,S.debug("paintActions",`Mic Paint Active set to: ${n}`,null,"paint"),this.emit("micPaintStateChanged",n)},setPaintDetectionState(n){this.state.paint.isDetecting,this.state.paint.isDetecting=n,S.debug("paintActions",`Paint detection state set to: ${n}`,null,"paint"),this.emit("paintDetectionStateChanged",n)},setDetectedPitch(n){this.state.paint.detectedPitch=n,this.emit("pitchDetected",n)},addPaintPoint(n){this.state.paint.paintHistory.push(n)},clearPaintHistory(){this.state.paint.paintHistory=[],S.debug("paintActions","Paint history cleared",null,"paint"),this.emit("paintHistoryChanged"),this.recordState()},setPaintSettings(n){Object.assign(this.state.paint.paintSettings,n),S.debug("paintActions","Paint settings updated",{settings:this.state.paint.paintSettings},"paint"),this.emit("paintSettingsChanged",this.state.paint.paintSettings),this.recordState()}};S.moduleLoaded("StampActions","stamps");function y0(){return`stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const b0={addStampPlacement(n,e,s,i="#4a90e2"){const r=e+1,a=this.state.stampPlacements.find(h=>h.row===s&&h.startColumn<=r&&h.endColumn>=e);a&&this.removeStampPlacement(a.id);const c={id:y0(),stampId:n,startColumn:e,endColumn:r,row:s,color:i,timestamp:Date.now()};return this.state.stampPlacements.push(c),this.emit("stampPlacementsChanged"),S.debug("StampActions",`Added stamp ${n} at ${e}-${r},${s}`,{stampId:n,startColumn:e,endColumn:r,row:s,placementId:c.id},"stamps"),c},removeStampPlacement(n){const e=this.state.stampPlacements.findIndex(i=>i.id===n);if(e===-1)return!1;const s=this.state.stampPlacements.splice(e,1)[0];return this.emit("stampPlacementsChanged"),S.debug("StampActions",`Removed stamp ${s.stampId} at ${s.startColumn}-${s.endColumn},${s.row}`,{placementId:n,stampId:s.stampId,startColumn:s.startColumn,endColumn:s.endColumn,row:s.row},"stamps"),!0},eraseStampsInArea(n,e,s,i){const r=[];for(const c of this.state.stampPlacements){const h=c.startColumn<=e&&c.endColumn>=n,m=c.row>=s&&c.row<=i;h&&m&&r.push(c.id)}let a=!1;return r.forEach(c=>{this.removeStampPlacement(c)&&(a=!0)}),a},getAllStampPlacements(){return[...this.state.stampPlacements]},getStampAt(n,e){return this.state.stampPlacements.find(s=>s.row===e&&n>=s.startColumn&&n<=s.endColumn)||null},clearAllStamps(){const n=this.state.stampPlacements.length>0;this.state.stampPlacements=[],n&&(this.emit("stampPlacementsChanged"),S.info("StampActions","Cleared all stamp placements",null,"stamps"))},getStampPlaybackData(){return this.state.stampPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{stampId:n.stampId,column:n.startColumn,startColumn:n.startColumn,endColumn:n.endColumn,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,placement:n}}).filter(n=>n.pitch)},updateStampShapeOffset(n,e,s){const i=this.state.stampPlacements.find(r=>r.id===n);if(!i){S.warn("StampActions","[STAMP SHAPE OFFSET] Placement not found",{placementId:n},"stamps");return}i.shapeOffsets||(i.shapeOffsets={}),S.debug("StampActions","[STAMP SHAPE OFFSET] Updating shape offset",{placementId:n,shapeKey:e,oldOffset:i.shapeOffsets[e]||0,newOffset:s,baseRow:i.row,targetRow:i.row+s},"stamps"),i.shapeOffsets[e]=s,this.emit("stampPlacementsChanged")},getShapeRow(n,e){var i;const s=((i=n.shapeOffsets)==null?void 0:i[e])||0;return n.row+s}};S.moduleLoaded("TripletActions","triplets");function w0(){return`triplet-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const _0={addTripletPlacement(n){this.state.tripletPlacements||(this.state.tripletPlacements=[]);const e=this.state.tripletPlacements.find(i=>i.row===n.row&&!(i.startCellIndex+i.span<=n.startCellIndex||n.startCellIndex+n.span<=i.startCellIndex));e&&this.removeTripletPlacement(e.id),this.state.stampPlacements&&this.state.stampPlacements.filter(r=>{if(r.row!==n.row)return!1;const a=Math.floor(r.startColumn/2),c=Math.floor(r.endColumn/2),h=n.startCellIndex+n.span-1;return!(c<n.startCellIndex||a>h)}).forEach(r=>this.removeStampPlacement(r.id));const s={id:w0(),...n};return this.state.tripletPlacements.push(s),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),S.debug("TripletActions",`Added triplet ${n.stampId} at cell ${n.startCellIndex}, row ${n.row}`,{stampId:n.stampId,startCellIndex:n.startCellIndex,span:n.span,row:n.row,placementId:s.id},"triplets"),s},removeTripletPlacement(n){if(!this.state.tripletPlacements)return!1;const e=this.state.tripletPlacements.findIndex(i=>i.id===n);if(e===-1)return!1;const s=this.state.tripletPlacements.splice(e,1)[0];return this.emit("tripletPlacementsChanged"),S.debug("TripletActions",`Removed triplet ${s.stampId} at cell ${s.startCellIndex}, row ${s.row}`,{placementId:n,stampId:s.stampId,startCellIndex:s.startCellIndex,span:s.span,row:s.row},"triplets"),!0},eraseTripletsInArea(n,e,s,i){if(!this.state.tripletPlacements)return!1;const r=Math.floor(n/2),a=Math.floor(e/2),c=[];for(const m of this.state.tripletPlacements)m.row>=s&&m.row<=i&&(m.startCellIndex+m.span-1<r||m.startCellIndex>a||c.push(m.id));let h=!1;return c.forEach(m=>{this.removeTripletPlacement(m)&&(h=!0)}),h},getAllTripletPlacements(){return[...this.state.tripletPlacements||[]]},getTripletAt(n,e){return this.state.tripletPlacements&&this.state.tripletPlacements.find(s=>s.row===e&&n>=s.startCellIndex&&n<s.startCellIndex+s.span)||null},clearAllTripletPlacements(){if(!this.state.tripletPlacements)return;const n=this.state.tripletPlacements.length>0;this.state.tripletPlacements=[],n&&(this.emit("tripletPlacementsChanged"),S.info("TripletActions","Cleared all triplet placements",null,"triplets"))},getTripletPlaybackData(){return this.state.tripletPlacements?this.state.tripletPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{startCellIndex:n.startCellIndex,stampId:n.stampId,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,span:n.span,placement:n}}).filter(n=>n.pitch):[]},updateTripletShapeOffset(n,e,s){const i=this.state.tripletPlacements.find(r=>r.id===n);if(!i){S.warn("TripletActions","[TRIPLET SHAPE OFFSET] Placement not found",{placementId:n},"triplets");return}i.shapeOffsets||(i.shapeOffsets={}),S.debug("TripletActions","[TRIPLET SHAPE OFFSET] Updating shape offset",{placementId:n,shapeKey:e,oldOffset:i.shapeOffsets[e]||0,newOffset:s,baseRow:i.row,targetRow:i.row+s},"triplets"),i.shapeOffsets[e]=s,this.emit("tripletPlacementsChanged")},getTripletShapeRow(n,e){var i;const s=((i=n.shapeOffsets)==null?void 0:i[e])||0;return n.row+s}};S.moduleLoaded("Store","general");const Rh="studentNotationState";function x0(){var n;try{const e=localStorage.getItem(Rh);if(e===null)return;const s=JSON.parse(e);if(s.timbres)for(const i in s.timbres){const r=s.timbres[i];if(r.coeffs&&typeof r.coeffs=="object"){const a=Array.isArray(r.coeffs)?r.coeffs:Object.values(r.coeffs);r.coeffs=new Float32Array(a)}if(r.phases&&typeof r.phases=="object"){const a=Array.isArray(r.phases)?r.phases:Object.values(r.phases);r.phases=new Float32Array(a)}}if(s.paint){const i=wp.paint||{},r=s.paint;s.paint={...i,...r,paintSettings:{...i.paintSettings,...r.paintSettings||{}}}}if(s.pitchRange){const i=(ke==null?void 0:ke.length)||((n=s.fullRowData)==null?void 0:n.length)||0,r=Math.max(0,i-1),a=Math.max(0,Math.min(r,s.pitchRange.topIndex??0)),c=Math.max(a,Math.min(r,s.pitchRange.bottomIndex??r));s.pitchRange={topIndex:a,bottomIndex:c}}return s}catch(e){S.error("Store","Could not load state from localStorage",e,"general");return}}function zp(n){try{const e=JSON.parse(JSON.stringify({placedNotes:n.placedNotes,placedChords:n.placedChords,tonicSignGroups:n.tonicSignGroups,stampPlacements:n.stampPlacements,tripletPlacements:n.tripletPlacements,timbres:n.timbres,macrobeatGroupings:n.macrobeatGroupings,macrobeatBoundaryStyles:n.macrobeatBoundaryStyles,hasAnacrusis:n.hasAnacrusis,baseMicrobeatPx:n.baseMicrobeatPx,modulationMarkers:n.modulationMarkers,tempo:n.tempo,activeChordIntervals:n.activeChordIntervals,selectedNote:n.selectedNote,annotations:n.annotations,pitchRange:n.pitchRange,snapZoomToRange:n.snapZoomToRange,paint:{paintHistory:n.paint.paintHistory,paintSettings:n.paint.paintSettings}}));if(n.timbres)for(const i in n.timbres)n.timbres[i].coeffs&&e.timbres[i]&&(e.timbres[i].coeffs=Array.from(n.timbres[i].coeffs)),n.timbres[i].phases&&e.timbres[i]&&(e.timbres[i].phases=Array.from(n.timbres[i].phases));const s=JSON.stringify(e);localStorage.setItem(Rh,s)}catch(e){S.error("Store","Could not save state to localStorage",e,"general")}}const Pd={...Nv,...l0,...c0,...p0,...f0,...g0,...v0,...b0,..._0,clearSavedState(){try{localStorage.removeItem(Rh),localStorage.removeItem("effectDialValues"),window.location.reload()}catch(n){S.error("Store","Could not clear state from localStorage",n,"general")}}},Qo={},Wp=x0(),S0={...wp,...Wp},u={state:S0,on(n,e){Qo[n]||(Qo[n]=[]),Qo[n].push(e)},emit(n,e){Qo[n]&&Qo[n].forEach(s=>{try{s(e)}catch(i){S.error("Store",`Error in listener for event "${n}"`,i,"general")}})}};for(const n in Pd)u[n]=Pd[n].bind(u);const C0=u.recordState;u.recordState=function(...n){C0.apply(this,n),zp(this.state)};Wp||zp(u.state);let kc=null,Ic=null;const Dh={setContexts({ctx:n,drumCtx:e}){kc=n,Ic=e},getPitchContext(){return kc||S.error("CanvasContextService","Pitch context requested before it was set.",null,"canvas"),kc},getDrumContext(){return Ic||S.error("CanvasContextService","Drum context requested before it was set.",null,"canvas"),Ic}};u.on("modulationMarkersChanged",()=>{M0()});u.on("scrollChanged",()=>{mr=null,fr=null});u.on("zoomChanged",()=>{mr=null,fr=null});let or=null,Kc=null,mr=null,fr=null;function Vp(n){const e=JSON.stringify({markers:n.modulationMarkers||[],baseMicrobeatPx:n.baseMicrobeatPx||n.cellWidth||40});if(or&&e===Kc)return or;const s=n.baseMicrobeatPx||n.cellWidth||40;return or=$p(n.modulationMarkers||[],s,n),Kc=e,or}function Hp(){const n=performance.now();return(!mr||!fr||n-fr>1)&&(mr=St.getViewportInfo(),fr=n),mr}function ft(n,e){let s=0;const i=Math.floor(n),r=n-i;for(let f=0;f<i;f++){const v=e.columnWidths[f]||0;s+=v*e.cellWidth}if(r>0&&i<e.columnWidths.length){const f=e.columnWidths[i]||0;s+=r*f*e.cellWidth}if(!e.modulationMarkers||e.modulationMarkers.length===0)return s;const a=Vp(e),c=e.baseMicrobeatPx||e.cellWidth||40,h=s/c;return a.microbeatToCanvasX(h)}function Rt(n,e){const s=Hp(),i=n-s.startRank,r=e.cellHeight/2;return i*r}function Ea(n){let e=(n||"").replace(/\d/g,"").trim();return e=e.replace(/b/g,"").replace(/#/g,""),e}function T0(n,e=1){switch(n){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"E/D":case"D/C":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function A0(){const n=St.getViewportInfo(),{startRank:e,endRank:s}=n;return{startRow:e,endRow:s}}function M0(){or=null,Kc=null}function E0(n,e){if(e.modulationMarkers&&e.modulationMarkers.length>0){const a=Vp(e),c=e.baseMicrobeatPx||e.cellWidth||40;return a.canvasXToMicrobeat(n)*c/e.cellWidth}let s=0;const{columnWidths:i,cellWidth:r}=e;if(r===0)return 0;for(let a=0;a<i.length;a++){const c=i[a]*r;if(n<s+c){const h=(n-s)/c;return a+h}s+=c}return i.length-1}function P0(n,e){const s=Hp(),i=e.cellHeight/2;return n/i+s.startRank}function Gp(n,e){return e.some(s=>s.columnIndex===n)}function k0(n,e){return e.some(s=>n===s.columnIndex||n===s.columnIndex+1)}function th(n,e){const s=rn(e);return!k0(n,s)}function jp(n,e){for(const s of e)if(n===s.columnIndex+1)return!1;return e.some(s=>n===s.columnIndex+2),!0}function I0(n,e,s,i){const{sharp:r,flat:a}=e.accidentalMode,c=e.showFrequencyLabels||!1,h=r||a,m=!r&&!a;function f(w){const x=[];return ke.forEach(A=>{Ea(A.pitch)===w&&(A.column==="A"||A.column==="B")&&(A.column==="A"?x.push(1,e.columnWidths.length-2):A.column==="B"&&x.push(0,e.columnWidths.length-1))}),[...new Set(x)]}function v(w){const x=[];return ke.forEach(A=>{Ea(A.pitch)===w&&(A.column==="A"||A.column==="B")&&(A.column==="A"?x.push(0,e.columnWidths.length-1):A.column==="B"&&x.push(1,e.columnWidths.length-2))}),[...new Set(x)]}function y(){return[1,e.columnWidths.length-2]}for(let w=s;w<=i;w++){const x=e.fullRowData[w];if(!x)continue;const A=Rt(w,e);if(A<-10||A>e.viewportHeight+10)continue;const E=Ea(x.pitch),M=T0(E);if(E==="C"||E==="E"){const I=f(E),R=ft(0,e),D=ft(e.columnWidths.length,e);Rc(n,R,D,A,e,I,"stroke",M)}else if(E==="G"){const I=ft(2,e),D=ft(e.columnWidths.length-2,e)-I;if(n.fillStyle=M.color,n.fillRect(I,A-e.cellHeight/2,D,e.cellHeight),!c){const G=y();m?(n.fillStyle=M.color,Jo(n,A,e,G,"fill",M)):h&&Jo(n,A,e,G,"stroke",M)}}else if(["B","A","F"].includes(E))if(m){let R=v(E).filter(D=>D!==0&&D!==e.columnWidths.length-1);E==="A"&&(R=R.filter(D=>D!==1&&D!==e.columnWidths.length-2)),R.length>0&&Jo(n,A,e,R,"stroke",M)}else{const I=v(E);Jo(n,A,e,I,"stroke",M)}else if(["E/D","D/C"].includes(E)){const I=v(E);Jo(n,A,e,I,"stroke",M)}else if(E==="B/A")if(m){const I=ft(0,e),R=ft(e.columnWidths.length,e);n.beginPath(),n.moveTo(I,A),n.lineTo(R,A),n.lineWidth=M.lineWidth,n.strokeStyle=M.color,n.setLineDash(M.dash),n.stroke(),n.setLineDash([])}else{const I=f(E),R=ft(0,e),D=ft(e.columnWidths.length,e);Rc(n,R,D,A,e,I,"stroke",M)}else{const I=f(E),R=ft(0,e),D=ft(e.columnWidths.length,e);Rc(n,R,D,A,e,I,"stroke",M)}}}function Rc(n,e,s,i,r,a,c,h){const m=a.map(v=>({start:ft(v,r),end:ft(v+1,r)})).sort((v,y)=>v.start-y.start);let f=e;m.forEach(v=>{f<v.start&&eh(n,f,v.start,i,r,c,h),f=Math.max(f,v.end)}),f<s&&eh(n,f,s,i,r,c,h)}function eh(n,e,s,i,r,a,c){a==="fill"?n.fillRect(e,i-r.cellHeight/2,s-e,r.cellHeight):(n.beginPath(),n.moveTo(e,i),n.lineTo(s,i),n.lineWidth=c.lineWidth,n.strokeStyle=c.color,n.setLineDash(c.dash),n.stroke(),n.setLineDash([]))}function Jo(n,e,s,i,r,a){i.forEach(c=>{const h=ft(c,s),m=ft(c+1,s);eh(n,h,m,e,s,r||"stroke",a)})}function R0(n,e,s,i){I0(n,e,s,i)}function D0(n,e){O0(n,e)}function O0(n,e){const{columnWidths:s,macrobeatGroupings:i,macrobeatBoundaryStyles:r,placedTonicSigns:a}=e,c=s.length;let h=[],m=2;for(let f=0;f<i.length;f++){for(;a.some(v=>v.columnIndex===m);)m+=2;m+=i[f],h.push(m)}for(let f=0;f<=c;f++){const v=ft(f,e);let y;const w=f===2||f===c-2,x=Gp(f,a),A=a.some(I=>f===I.columnIndex+2),E=h.includes(f);if(jp(f,a)){if(w||x||A)y={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(E){const I=h.indexOf(f);if(I!==-1){const R=r[I];if(R==="anacrusis")continue;y={lineWidth:1,strokeStyle:"#adb5bd",dash:R==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(v,0),n.lineTo(v,n.canvas.height),n.lineWidth=y.lineWidth,n.strokeStyle=y.strokeStyle,n.setLineDash(y.dash),n.stroke()}}n.setLineDash([])}const kd=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function N0(n){const e=rn(n);if(e.length===0)return{leftTonic:null,rightTonic:null};const s=e.reduce((r,a)=>a.columnIndex<r.columnIndex?a:r),i=e.reduce((r,a)=>a.columnIndex>r.columnIndex?a:r);return{leftTonic:s,rightTonic:e.length===1?s:i}}function Id(n,e){const s=e[n];if(!s)return null;const r=s.pitch.replace(/\d+$/,"");return(r.includes("/")?r.split("/")[0]:r).replace(//g,"b").replace(//g,"#")}function Rd(n,e){if(!n||!e)return[];const s=e-1;if(s<0||s>=kd.length)return console.warn(`Invalid tonic number: ${e}`),[];const i=kd[s];try{const r=`${n} ${i}`,a=Zy(r);return console.log(` Focus Colours: Generated ${r} scale:`,a.notes),a.notes||[]}catch(r){return console.warn(`Could not generate ${i} scale for tonic: ${n}`,r),[]}}function L0(n,e){if(!n||!e.length)return!1;const s=n.replace(/\d+$/,"");return(s.includes("/")?s.split("/"):[s]).map(a=>a.replace(//g,"b").replace(//g,"#")).some(a=>e.some(c=>{try{return wn(a)===wn(c)||a===c}catch{return a===c}}))}function F0(n,e,s,i){const{fullRowData:r,columnWidths:a,cellWidth:c,cellHeight:h,colorMode:m}=e,{sharp:f,flat:v}=u.state.accidentalMode,{focusColours:y,showFrequencyLabels:w}=u.state;let x=[],A=[];if(y){const R=N0(u.state);if(R.leftTonic){const D=Id(R.leftTonic.row,r);x=Rd(D,R.leftTonic.tonicNumber)}if(R.rightTonic){const D=Id(R.rightTonic.row,r);A=Rd(D,R.rightTonic.tonicNumber)}}const E=(R,D=[],G=null)=>{if(w)return G&&G.frequency?String(G.frequency):R;if(!R.includes("/"))return R;const X=R.slice(-1),F=R.substring(0,R.length-1),[H,Q]=F.split("/");if(y&&D.length>0){const K=H.replace(//g,"b").replace(//g,"#"),pt=Q.replace(//g,"b").replace(//g,"#"),ut=D.some(xt=>{try{return wn(xt)===wn(K)||xt===K}catch{return xt===K}}),_t=D.some(xt=>{try{return wn(xt)===wn(pt)||xt===pt}catch{return xt===pt}});if(!f&&!v){if(ut)return`${H}${X}`;if(_t)return`${Q}${X}`}else{if(f&&!v)return _t?`${Q}${X}`:null;if(!f&&v)return ut?`${H}${X}`:null;if(f&&v)return ut||_t?`${H}/${Q}${X}`:null}}return f&&v?`${H}/${Q}${X}`:f?`${Q}${X}`:v?`${H}${X}`:`${Q}${X}`},M=()=>!f&&!v;function I(R,D){const G=ft(R,e),X=a.slice(R,R+2).map(K=>K*c);let F=G;const Q=R===0?x:A;D.forEach((K,pt)=>{const ut=X[pt];for(let _t=s;_t<=i;_t++){const xt=r[_t];if(!(!xt||xt.isDummy)&&xt.column===K){const Zt=Rt(_t,e),Wt=xt.pitch.includes("/"),Jt=!w&&Wt&&M();let it=m==="bw"?"#ffffff":xt.hex||"#ffffff";const rt=E(xt.pitch,Q,xt),at=rt===null;let Tt=Jt||at;if(!w&&y&&Q.length>0&&!at&&(L0(xt.pitch,Q)||(Tt=!0)),Tt){const qt=it.match(/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if(qt){const xe=parseInt(qt[1],16),Ue=parseInt(qt[2],16),Ze=parseInt(qt[3],16);it=`rgba(${xe}, ${Ue}, ${Ze}, 0)`}}if(n.fillStyle=it,n.fillRect(F,Zt-h/2,ut,h),Ea(xt.pitch),at)continue;const dt=rt.length<=3,Nt=Math.max(10,Math.min(c*1.2,h*1.2)),jt=dt?Nt:Nt*.7;n.font=`bold ${jt}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle";const Bt=F+ut/2,ne=Zt,Xe=Tt?"00":"FF";n.strokeStyle=`#212529${Xe}`,n.lineWidth=2.5,n.lineJoin="round",n.strokeText(rt,Bt,ne),n.fillStyle=`#ffffff${Xe}`,n.fillText(rt,Bt,ne)}}F+=ut})}I(0,["B","A"]),I(a.length-2,["A","B"])}function Xp(n,e,s){const{cellWidth:i}=s,r=i*.25;if(!n.uuid)return 0;const a=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid);if(a.length===0)return 0;const c=[n,...a];return c.sort((m,f)=>{const v=parseInt(m.uuid.split("-")[1]),y=parseInt(f.uuid.split("-")[1]);return v-y}),c.findIndex(m=>m.uuid===n.uuid)*r}function Up(n,e){const{cellHeight:s}=e;return(window.animationEffectsManager?window.animationEffectsManager.shouldAnimateNote(n):!1)?(window.animationEffectsManager?window.animationEffectsManager.getVibratoYOffset(n.color):0)*s:0}function Yp(n,e,s,i,r,a){if(!window.animationEffectsManager||!window.animationEffectsManager.shouldFillNote(e))return;const h=window.animationEffectsManager.getFillLevel(e);if(h<=0)return;n.save();const m=1-h,f=n.createRadialGradient(s,i,0,s,i,Math.max(r,a));f.addColorStop(0,"transparent"),f.addColorStop(Math.max(0,m-.05),"transparent"),f.addColorStop(m,e.color+"1F"),f.addColorStop(1,e.color+"BF"),n.beginPath(),n.ellipse(s,i,r,a,0,0,2*Math.PI),n.clip(),n.fillStyle=f,n.fillRect(s-r-10,i-a-10,(r+10)*2,(a+10)*2),n.restore()}function B0(n,e,s){const{cellHeight:i}=s,r=i/2*.12;if(!n.uuid)return 0;const a=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid&&m.endColumnIndex>m.startColumnIndex);if(a.length===0)return 0;const c=[n,...a];return c.sort((m,f)=>{const v=parseInt(m.uuid.split("-")[1]),y=parseInt(f.uuid.split("-")[1]);return v-y}),c.findIndex(m=>m.uuid===n.uuid)*r}function Zp(n,e,s,i,r,a){var m;console.log(" [SCALE/MODE] drawScaleDegreeText called:",{degreeDisplayMode:s.degreeDisplayMode,noteRow:e.row,noteStartCol:e.startColumnIndex,pitch:(m=s.fullRowData[e.row])==null?void 0:m.pitch});const c=Jc.getDegreeForNote(e,s);if(console.log(" [SCALE/MODE] TonalService returned:",{degreeStr:c,degreeDisplayMode:s.degreeDisplayMode}),!c)return;const h=(e.shape==="oval"?a*wv:a*_v)*s.zoomLevel;h<xv||(n.fillStyle="#212529",n.font=`bold ${h}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(c,i,r))}function Oh(n,e,s,i){const{cellWidth:r,cellHeight:a,zoomLevel:c}=e,h=Rt(i,e),m=Up(s,e),f=h+m,v=ft(s.startColumnIndex,e);let y;e.modulationMarkers&&e.modulationMarkers.length>0?y=ft(s.startColumnIndex+1,e)-v:y=r;const w=Xp(s,u.state.placedNotes,e),x=v+y+w,A=Math.max(Sv,y*Cv);if(s.endColumnIndex>s.startColumnIndex){const R=ft(s.endColumnIndex+1,e)+w-w,D=B0(s,u.state.placedNotes,e),G=f+D;n.beginPath(),n.moveTo(x,G),n.lineTo(R,G),n.strokeStyle=s.color,n.lineWidth=Math.max(Av,y*Tv),n.stroke()}const E=y-A/2,M=a/2-A/2;n.save(),Yp(n,s,x,f,E,M),n.beginPath(),n.ellipse(x,f,E,M,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=vp,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Zp(n,s,e,x,f,a/2)}function Nh(n,e,s,i){const{columnWidths:r,cellWidth:a,cellHeight:c,zoomLevel:h}=e,m=Rt(i,e),f=Up(s,e),v=m+f,y=ft(s.startColumnIndex,e);let w;e.modulationMarkers&&e.modulationMarkers.length>0?w=ft(s.startColumnIndex+1,e)-y:w=r[s.startColumnIndex]*a;const x=Xp(s,u.state.placedNotes,e),A=Math.max(.5,w*.15),E=y+w/2+x,M=w/2-A/2,I=c/2-A/2;n.save(),Yp(n,s,E,v,M,I),n.beginPath(),n.ellipse(E,v,M,I,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=vp,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Zp(n,s,e,E,v,c/2)}function Lh(n,e,s){const{cellWidth:i,cellHeight:r}=e,a=Rt(s.row,e),c=ft(s.columnIndex,e);let h;e.modulationMarkers&&e.modulationMarkers.length>0?h=ft(s.columnIndex+1,e)-c:h=i;const m=h*2,f=c+m/2,v=Math.min(m,r)/2*.9;if(v<2||(n.beginPath(),n.arc(f,a,v,0,2*Math.PI),n.strokeStyle="#212529",n.lineWidth=Math.max(.5,h*.05),n.stroke(),!s.tonicNumber))return;const y=s.tonicNumber.toString(),w=v*1.5;w<6||(n.fillStyle="#212529",n.font=`bold ${w}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(y,f,a))}const sh=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function Xa(n){return sh.find(e=>e.id===n)}function Dd(n,e,s,i){const r=Math.sqrt(3)/2*s,a=Math.max(1,i-2*r),c=e-(a/2+r),h=c+r,m=h+a,f=m+r,v=n-s/2,y=n+s/2;return`M ${[`${n},${c}`,`${v},${h}`,`${v},${m}`,`${n},${f}`,`${y},${m}`,`${y},${h}`].join(" ")} Z`.replace(/,/g," ")}class q0{constructor(e={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...e}}renderToCanvas(e,s,i,r,a,c,h="#000",m=null,f=null){const v=Math.min(a/100,c/100)*.8,y=this.options.diamondW*v,w=this.options.diamondH*v,x=this.options.ovalRx*v,A=this.options.ovalRy*v,E=[.125,.375,.625,.875].map(I=>i+I*a),M=r+c/2;e.save(),e.strokeStyle=h,e.fillStyle=h,e.lineWidth=this.options.strokeWidth,e.lineCap="round",e.lineJoin="round",s.ovals.forEach(I=>{var G;const R=I===0?i+.25*a:i+.75*a;let D=M;if(m&&f){const X=`oval_${I}`,F=((G=m.shapeOffsets)==null?void 0:G[X])||0,H=m.row+F;D=f(H)}e.beginPath(),e.ellipse(R,D,x,A,0,0,Math.PI*2),e.stroke()}),s.diamonds.forEach(I=>{var F;const R=E[I];let D=M;if(m&&f){const H=`diamond_${I}`,Q=((F=m.shapeOffsets)==null?void 0:F[H])||0,K=m.row+Q;D=f(K)}const G=Dd(R,D,y,w),X=new Path2D(G);e.stroke(X)}),e.restore()}renderToSVG(e,s=100,i=100){const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox",`0 0 ${s} ${i}`),r.style.color="#000000";const a=Math.min(s/100,i/100)*.8,c=this.options.diamondW*a,h=this.options.diamondH*a,m=this.options.ovalRx*a,f=this.options.ovalRy*a,v=[12.5,37.5,62.5,87.5],y=i/2;return e.ovals.forEach(w=>{const x=w===0?25:75,A=document.createElementNS("http://www.w3.org/2000/svg","ellipse");A.setAttribute("cx",x),A.setAttribute("cy",y),A.setAttribute("rx",m),A.setAttribute("ry",f),A.setAttribute("fill","none"),A.setAttribute("stroke","currentColor"),A.setAttribute("stroke-width",this.options.strokeWidth*2),A.setAttribute("stroke-linecap","round"),r.appendChild(A)}),e.diamonds.forEach(w=>{const x=v[w],A=Dd(x,y,c,h),E=document.createElementNS("http://www.w3.org/2000/svg","path");E.setAttribute("d",A),E.setAttribute("fill","none"),E.setAttribute("stroke","currentColor"),E.setAttribute("stroke-width",this.options.strokeWidth*2),E.setAttribute("stroke-linejoin","round"),E.setAttribute("stroke-linecap","round"),r.appendChild(E)}),r}}const Fh=new q0;S.moduleLoaded("StampRenderer","stamps");function $0(n,e){const s=u.getAllStampPlacements();s.length!==0&&(S.debug("StampRenderer",`Rendering ${s.length} stamps`,{count:s.length},"stamps"),s.forEach(i=>{z0(n,i,e)}))}function z0(n,e,s){const i=Xa(e.stampId);if(!i)return;const{startColumn:r,endColumn:a,row:c,color:h}=e,m=ft(r,s),v=Rt(c,s)-s.cellHeight/2,y=s.cellWidth*2,w=s.cellHeight;if(m+y<0||m>n.canvas.width)return;const x=A=>Rt(A,s);Fh.renderToCanvas(n,i,m,v,y,w,h,e,x),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(m+1,v+1,y-2,w-2),n.restore(),S.debug("StampRenderer",`Rendered stamp ${i.id} at ${r}-${a},${c}`,{stampId:i.id,startColumn:r,endColumn:a,row:c,stampX:m,stampY:v,hasOffsets:!!e.shapeOffsets},"stamps")}function W0(n,e,s,i,r){if(!i)return;const a=ft(e,r),h=Rt(s,r)-r.cellHeight/2,m=r.cellWidth*2,f=r.cellHeight;n.save(),n.globalAlpha=.6,Fh.renderToCanvas(n,i,a,h,m,f,r.previewColor||"#4a90e2"),n.restore()}function Od(n,e,s){return[{id:e+0,span:n,hits:[0],label:`${s} [1]`},{id:e+1,span:n,hits:[1],label:`${s} [2]`},{id:e+2,span:n,hits:[2],label:`${s} [3]`},{id:e+3,span:n,hits:[0,1],label:`${s} [1 2]`},{id:e+4,span:n,hits:[1,2],label:`${s} [2 3]`},{id:e+5,span:n,hits:[0,2],label:`${s} [1 3]`},{id:e+6,span:n,hits:[0,1,2],label:`${s} [1 2 3]`}]}const nh=[...Od("eighth",1,"8th triplet"),...Od("quarter",8,"Quarter triplet")],V0={eighth:1,quarter:2},Qp=[16.6667,50,83.3333];function Rr(n){return nh.find(e=>e.id===n)}function H0({kind:n,cx:e,cy:s,stroke:i="currentColor",strokeWidth:r=4,scale:a=1}){const c=20*a,h=60*a,m=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return m.setAttribute("cx",e),m.setAttribute("cy",s),m.setAttribute("fill","none"),m.setAttribute("stroke",i),m.setAttribute("stroke-width",r),m.setAttribute("stroke-linecap","round"),n==="circleWide"?(m.setAttribute("rx",c*2),m.setAttribute("ry",h)):(m.setAttribute("rx",c),m.setAttribute("ry",h)),m}function G0(n,e=48,s=48){const i=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=n.span==="quarter",a=r?200:100;i.setAttribute("viewBox",`0 0 ${a} 100`),i.setAttribute("width",e),i.setAttribute("height",s),i.setAttribute("aria-label",n.label),i.style.color="#000000";const c=50,h=n.span==="eighth"?"ovalWide":"circleWide";let m;return r?m=[33.33,100,166.67]:m=[16.67,50,83.33],n.hits.forEach(f=>{const v=H0({kind:h,cx:m[f],cy:c,stroke:"currentColor",strokeWidth:3,scale:.8});i.appendChild(v)}),i}S.moduleLoaded("TripletRenderer","triplets");function j0(n,e){const s=u.getAllTripletPlacements();s.length!==0&&(S.debug("TripletRenderer",`Rendering ${s.length} triplet groups`,{count:s.length},"triplets"),s.forEach(i=>{X0(n,i,e)}))}function X0(n,e,s){const i=Rr(e.stampId);if(!i)return;const{startCellIndex:r,span:a,row:c,color:h}=e,m=r*2,f=ft(m,s),v=Rt(c,s),y=v-s.cellHeight/2,w=s.cellWidth*2*a,x=s.cellHeight;if(f+w<0||f>n.canvas.width)return;Jp(n,i,f,v,w,x,h,e,E=>Rt(E,s)),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(f+1,y+1,w-2,x-2),n.restore()}function Jp(n,e,s,i,r,a,c,h=null,m=null){const f=e.span==="eighth"?"ovalWide":"circleWide",v=Math.min(r/100,a/100)*.8,y=Math.max(1,3*v);e.hits.forEach(w=>{var M;const x=Qp[w],A=s+r*x/100;let E=i;if(h&&m){const I=`triplet_${w}`,R=((M=h.shapeOffsets)==null?void 0:M[I])||0,D=h.row+R;E=m(D),R!==0&&console.log("[TRIPLET RENDER] Drawing notehead with offset:",{slot:w,shapeKey:I,rowOffset:R,baseRow:h.row,shapeRow:D,y:E})}U0(n,f,A,E,c,y,v)})}function U0(n,e,s,i,r="currentColor",a=4,c=1){const h=20*c,m=60*c;if(n.strokeStyle=r,n.lineWidth=a,n.fillStyle="none",n.beginPath(),e==="circleWide"){const f=h*2,v=m;n.ellipse(s,i,f,v,0,0,2*Math.PI)}else{const f=h,v=m;n.ellipse(s,i,f,v,0,0,2*Math.PI)}n.stroke()}function Y0(n,e,s,i,r){if(!i)return;const a=e*2,c=i.span==="eighth"?1:2,h=ft(a,r),m=Rt(s,r),f=r.cellWidth*2*c,v=r.cellHeight;n.save(),n.globalAlpha=.6;const y=r.previewColor||"#4a90e2";Jp(n,i,h,m,f,v,y),n.restore()}function Z0(n,e){const s=e.cellWidth||40;if(n===0)return 2*s;const i=n-1,r=us(e,i);return r?(r.endColumn+1)*s:(console.warn("[MODULATION] Could not find measure info for index:",n),n*200)}function Kp(n,e){const{modulationMarkers:s}=e;if(!s||s.length===0)return;const i=s.filter(r=>r.active).map(r=>{let a;if(r.columnIndex!==null&&r.columnIndex!==void 0)a=ft(r.columnIndex+1,e);else if(r.macrobeatIndex!==null&&r.macrobeatIndex!==void 0){const c=us(e,r.macrobeatIndex);c?a=ft(c.endColumn+1,e):(console.warn(`[GRIDLINE-ALIGN] Could not find macrobeat info for index ${r.macrobeatIndex}`),a=r.xPosition||0)}else r.measureIndex!==null&&r.measureIndex!==void 0?a=Z0(r.measureIndex,e):a=r.xPosition||0;return{...r,xCanvas:a}});n.save(),i.forEach(r=>{Q0(n,r)}),n.restore()}function Q0(n,e,s){const i=e.xCanvas,r=e.ratio,a=qp(r),c=Bp(r);J0(n,i,a),K0(n,i,c,a)}function J0(n,e,s,i){const a=n.canvas.height;n.beginPath(),n.moveTo(e,0),n.lineTo(e,a),n.lineWidth=3,n.strokeStyle=s,n.setLineDash([]),n.stroke()}function K0(n,e,s,i,r){const c="Arial, sans-serif";n.font=`14px ${c}`,n.textAlign="center",n.textBaseline="middle";const y=n.measureText(s).width,w=14,x=y+6*2,A=w+6*2,E=e-x/2,M=20;tb(n,E,M,x,A,8,i),n.fillStyle="white",n.fillText(s,e,M+A/2)}function tb(n,e,s,i,r,a,c){n.beginPath(),n.moveTo(e+a,s),n.lineTo(e+i-a,s),n.quadraticCurveTo(e+i,s,e+i,s+a),n.lineTo(e+i,s+r-a),n.quadraticCurveTo(e+i,s+r,e+i-a,s+r),n.lineTo(e+a,s+r),n.quadraticCurveTo(e,s+r,e,s+r-a),n.lineTo(e,s+a),n.quadraticCurveTo(e,s,e+a,s),n.closePath(),n.fillStyle=c,n.fill(),n.strokeStyle="rgba(0, 0, 0, 0.2)",n.lineWidth=1,n.stroke()}function Cr(n,e){if(!e||e.length<3)return!1;const s=n.x!==void 0?n.x:n.col,i=n.y!==void 0?n.y:n.row;let r=!1;for(let a=0,c=e.length-1;a<e.length;c=a++){const h=e[a].x!==void 0?e[a].x:e[a].col,m=e[a].y!==void 0?e[a].y:e[a].row,f=e[c].x!==void 0?e[c].x:e[c].col,v=e[c].y!==void 0?e[c].y:e[c].row;m>i!=v>i&&s<(f-h)*(i-m)/(v-m)+h&&(r=!r)}return r}function da(n){if(!n||n.length<3)return n;const e=n.map(a=>({x:a.x!==void 0?a.x:a.col,y:a.y!==void 0?a.y:a.row}));let s=e[0];for(let a=1;a<e.length;a++)(e[a].y<s.y||e[a].y===s.y&&e[a].x<s.x)&&(s=e[a]);const i=e.filter(a=>a!==s);i.sort((a,c)=>{const h=Math.atan2(a.y-s.y,a.x-s.x),m=Math.atan2(c.y-s.y,c.x-s.x);if(h!==m)return h-m;const f=Math.hypot(a.x-s.x,a.y-s.y),v=Math.hypot(c.x-s.x,c.y-s.y);return f-v});const r=[s,i[0]];for(let a=1;a<i.length;a++){for(;r.length>1&&!eb(r[r.length-2],r[r.length-1],i[a]);)r.pop();r.push(i[a])}return r}function eb(n,e,s){return(e.x-n.x)*(s.y-n.y)-(e.y-n.y)*(s.x-n.x)>0}function sb(n,e,s,i=10){const r=n.x,a=n.y,c=e.x,h=e.y,m=s.x,f=s.y,v=m-c,y=f-h,w=v*v+y*y;if(w===0)return Math.hypot(r-c,a-h)<=i;let x=((r-c)*v+(a-h)*y)/w;x=Math.max(0,Math.min(1,x));const A=c+x*v,E=h+x*y;return Math.hypot(r-A,a-E)<=i}function Nd(n,e,s=10){if(!e||e.length<2)return!1;for(let i=0;i<e.length;i++){const r=e[i],a=e[(i+1)%e.length];if(sb(n,r,a,s))return!0}return!1}function nb(n,e){const{centerX:s,centerY:i,rx:r,ry:a}=e,c=16;for(let h=0;h<c;h++){const m=h/c*2*Math.PI,f=s+r*Math.cos(m),v=i+a*Math.sin(m);if(Cr({x:f,y:v},n))return!0}return!!Cr({x:s,y:i},n)}function Ld(n,e){const{x:s,y:i,width:r,height:a}=e,c=[{x:s,y:i},{x:s+r,y:i},{x:s+r,y:i+a},{x:s,y:i+a}];for(const h of c)if(Cr(h,n))return!0;for(const h of n){const m=h.x!==void 0?h.x:h.col,f=h.y!==void 0?h.y:h.row;if(m>=s&&m<=s+r&&f>=i&&f<=i+a)return!0}return!1}S.moduleLoaded("AnnotationService","annotation");class ib{constructor(){this.canvas=null,this.ctx=null,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null}initialize(){if(this.canvas=document.getElementById("notation-grid"),!this.canvas){S.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}this.ctx=this.canvas.getContext("2d"),this.setupEventListeners(),u.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),S.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){if(!this.selectedAnnotation)return;const s=document.activeElement,i=s.contentEditable==="true",r=s.tagName.toLowerCase();["input","textarea"].includes(r)||i||(e.key==="Delete"||e.key==="Backspace")&&(e.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const e=u.state.annotations.indexOf(this.selectedAnnotation);e>-1&&(u.state.annotations.splice(e,1),this.selectedAnnotation=null,u.recordState(),this.render(),S.log("AnnotationService","Deleted annotation","annotation"))}resize(){if(!this.canvas)return;const e=document.getElementById("notation-grid");e&&(this.canvas.width=e.width,this.canvas.height=e.height,this.render())}getRenderOptions(){return{columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth}}canvasToGrid(e,s){const i=this.getRenderOptions();return{col:E0(e,i),row:P0(s,i)}}gridToCanvas(e,s){const i=this.getRenderOptions();return{x:ft(e,i),y:Rt(s,i)}}setTool(e,s){if(this.currentTool=e,this.toolSettings=s,this.canvas)switch(e){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(e){var h,m;if(!this.currentTool||!this.toolSettings)return;const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,a=this.canvasToGrid(i,r);if(e.button===2){if(this.currentTool==="lasso"&&((h=u.state.lassoSelection)!=null&&h.isActive)){this.removeFromLassoSelection(i,r);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(i,r),this.showEraserCursor(i,r);return}if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const f=this.getResizeHandleAt(i,r,this.selectedAnnotation);if(f){this.isResizing=!0,this.resizeHandle=f,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:a.col,mouseRow:a.row};return}}if((m=u.state.lassoSelection)!=null&&m.isActive&&u.state.lassoSelection.convexHull){const f=Nd({x:i,y:r},u.state.lassoSelection.convexHull,10),v=Cr({x:i,y:r},u.state.lassoSelection.convexHull);if(f||v){this.isDraggingSelection=!0,this.selectionDragStart={canvasX:i,canvasY:r},this.selectionDragTotal={col:0,row:0};return}}const c=this.getAnnotationAt(i,r);if(c&&(c.type==="arrow"||c.type==="text")){if(this.selectedAnnotation===c){this.isDragging=!0,c.type==="arrow"?this.dragOffset={startCol:a.col-c.startCol,startRow:a.row-c.startRow,endCol:a.col-c.endCol,endRow:a.row-c.endRow}:c.type==="text"&&(this.dragOffset={col:a.col-c.col,row:a.row-c.row});return}this.selectedAnnotation=c,this.loadAnnotationSettings(c),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=a,this.currentPath=[a],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:a.col,startRow:a.row,endCol:a.col,endRow:a.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:a.col,startRow:a.row,endCol:a.col,endRow:a.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[a],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:i,y:r}]};break}}handleMouseMove(e){const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,a=this.canvasToGrid(i,r);if(this.tempEraserMode){this.eraseAtPoint(i,r),this.showEraserCursor(i,r);return}if(this.isResizing&&this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=a.col-this.resizeStartBounds.mouseCol,h=a.row-this.resizeStartBounds.mouseRow;let m=this.resizeStartBounds.col,f=this.resizeStartBounds.row,v=this.resizeStartBounds.widthCols,y=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+h,y=this.resizeStartBounds.heightRows-h),this.resizeHandle.includes("s")&&(y=this.resizeStartBounds.heightRows+h),this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+c,v=this.resizeStartBounds.widthCols-c),this.resizeHandle.includes("e")&&(v=this.resizeStartBounds.widthCols+c);const w=2,x=1;v<w&&(this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-w),v=w),y<x&&(this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-x),y=x),this.selectedAnnotation.col=m,this.selectedAnnotation.row=f,this.selectedAnnotation.widthCols=v,this.selectedAnnotation.heightRows=y,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart){const c=this.getRenderOptions(),h=i-this.selectionDragStart.canvasX,m=r-this.selectionDragStart.canvasY,f=Math.round(h/c.cellWidth),v=Math.round(m/(c.cellHeight/2)),y={col:f-this.selectionDragTotal.col,row:v-this.selectionDragTotal.row};if(y.col!==0||y.row!==0){u.state.lassoSelection.selectedItems.forEach(x=>{if(x.type==="note"){x.data.row+=y.row;const A=x.data.columnIndex!==void 0?"columnIndex":"startColumnIndex";x.data[A]+=y.col,x.data.endColumnIndex!==void 0&&(x.data.endColumnIndex+=y.col)}else x.type==="stamp"?(x.data.row+=y.row,x.data.startColumn+=y.col,x.data.endColumn+=y.col):x.type==="triplet"&&(x.data.row+=y.row,x.data.column+=y.col)}),this.selectionDragTotal.col=f,this.selectionDragTotal.row=v;const w=u.state.lassoSelection.selectedItems.map(x=>{const A=x.data.columnIndex!==void 0?x.data.columnIndex:x.data.startColumnIndex!==void 0?x.data.startColumnIndex:x.data.column,E=ft(A,c),M=Rt(x.data.row,c);return{x:E,y:M}});u.state.lassoSelection.convexHull=da(w),this.render()}return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=a.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=a.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=a.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=a.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=a.col-this.dragOffset.col,this.selectedAnnotation.row=a.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(i,r);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=a.col,this.tempAnnotation.endRow=a.row,this.render();break;case"text":this.tempAnnotation.endCol=a.col,this.tempAnnotation.endRow=a.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const c=this.tempAnnotation.path[this.tempAnnotation.path.length-1],h=this.interpolatePoints(c,a);this.tempAnnotation.path.push(...h)}else this.tempAnnotation.path.push(a);this.render();break;case"lasso":this.tempAnnotation.path.push({x:i,y:r}),this.render();break}}handleMouseUp(e){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,u.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,u.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,u.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:s,startRow:i,endCol:r,endRow:a}=this.tempAnnotation,c=Math.abs(r-s),h=Math.abs(a-i),m=Math.min(s,r),f=Math.min(i,a);c>.5&&h>.2&&this.createTextAnnotation(m,f,c,h),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection():(u.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),u.recordState()),this.tempAnnotation=null,this.render()}}}handleMouseLeave(e){this.isDrawing&&this.handleMouseUp(e)}handleDoubleClick(e){const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,a=this.getAnnotationAt(i,r);a&&a.type==="text"&&this.editTextAnnotation(a)}editTextAnnotation(e){const{col:s,row:i,widthCols:r,heightRows:a,text:c,settings:h}=e,m=u.state.annotations.indexOf(e);m>-1&&(u.state.annotations.splice(m,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(s,i,r,a,c,h)}createTextAnnotation(e,s,i,r,a=null,c=null){this.isDrawing=!1;const h=this.gridToCanvas(e,s),m=this.gridToCanvas(e+i,s+r),f=h.x,v=h.y,y=m.x-f,w=m.y-v,A=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',E=c||this.toolSettings.text,M=document.createElement("div");M.contentEditable=!0,M.className="annotation-text-input",M.textContent=a||"Type here...";const I=E.size,R=I*1.2;M.style.width=`${y}px`,M.style.height=`${w}px`,M.style.padding=E.background?"4px 8px":"4px",M.style.border="2px dashed rgba(74, 144, 226, 0.5)",M.style.backgroundColor=E.background?"#ffffff":"transparent",M.style.color=E.color,M.style.fontSize=`${I}px`,M.style.lineHeight=`${R}px`,M.style.fontWeight=E.bold?"bold":"normal",M.style.fontStyle=E.italic?"italic":"normal",M.style.textDecoration=E.underline?"underline":"none",E.superscript?(M.style.fontSize=`${I*.6}px`,M.style.verticalAlign="super"):E.subscript&&(M.style.fontSize=`${I*.6}px`,M.style.verticalAlign="sub"),M.style.outline="none",M.style.zIndex="10000",M.style.position="fixed",M.style.cursor="text",M.style.pointerEvents="auto",M.style.fontFamily=A,M.style.whiteSpace="pre-wrap",M.style.wordWrap="break-word",M.style.overflow="hidden",M.style.boxSizing="border-box";const D=this.canvas.getBoundingClientRect();M.style.left=`${D.left+f}px`,M.style.top=`${D.top+v}px`,document.body.appendChild(M),M.focus();const G=document.createRange();G.selectNodeContents(M);const X=window.getSelection();X.removeAllRanges(),X.addRange(G);let F=!1;const H=()=>{if(F)return;F=!0;const K=M.textContent.trim();if(K&&K!=="Type here..."){const pt={type:"text",col:e,row:s,widthCols:i,heightRows:r,text:K,settings:{...E}};u.state.annotations.push(pt),this.selectedAnnotation=u.state.annotations[u.state.annotations.length-1],u.recordState(),this.render()}document.body.contains(M)&&document.body.removeChild(M)};let Q=!1;M.addEventListener("input",()=>{!Q&&M.textContent==="Type here..."&&(M.textContent="",Q=!0)}),setTimeout(()=>{M.addEventListener("blur",H)},100),M.addEventListener("keydown",K=>{K.key==="Enter"&&!K.shiftKey&&(K.preventDefault(),H()),K.key==="Escape"&&(F=!0,document.body.contains(M)&&document.body.removeChild(M))})}handleLassoSelection(){if(!this.tempAnnotation||!this.tempAnnotation.path)return;const e=this.tempAnnotation.path,s=[],i=this.getRenderOptions();window.event&&window.event.shiftKey&&u.state.lassoSelection.selectedItems&&s.push(...u.state.lassoSelection.selectedItems),u.state.placedNotes.forEach((c,h)=>{if(c.isDrum)return;const m=c.columnIndex!==void 0?c.columnIndex:c.startColumnIndex,f=ft(m,i),v=Rt(c.row,i),{cellWidth:y,cellHeight:w}=i;let x=y;i.modulationMarkers&&i.modulationMarkers.length>0&&(x=ft(m+1,i)-f);const A=c.shape==="oval"?f+x:f+x/2,E=v,M=c.shape==="oval"?x:x/2,I=w/2;if(nb(e,{centerX:A,centerY:E,rx:M,ry:I})){const R=`note-${c.row}-${m}-${c.color}-${c.shape}`;s.find(D=>D.id===R)||s.push({type:"note",id:R,data:c,index:h})}}),u.state.stampPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=i,v=ft(c.startColumn,i),y=Rt(c.row,i)-f/2,w=m*2;if(Ld(e,{x:v,y,width:w,height:f})){const A=`stamp-${c.row}-${c.startColumn}-${c.stampId}`;s.find(E=>E.id===A)||s.push({type:"stamp",id:A,data:c,index:h})}}),u.state.tripletPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=i,v=ft(c.column,i),y=Rt(c.row,i)-f/2,w=m*2;if(Ld(e,{x:v,y,width:w,height:f})){const A=`triplet-${c.row}-${c.column}-${c.tripletId}`;s.find(E=>E.id===A)||s.push({type:"triplet",id:A,data:c,index:h})}});let a=null;if(s.length>0){const c=s.map(h=>{const m=h.data.columnIndex!==void 0?h.data.columnIndex:h.data.startColumnIndex!==void 0?h.data.startColumnIndex:h.data.column,f=ft(m,i),v=Rt(h.data.row,i);return{x:f,y:v}});a=da(c)}u.state.lassoSelection={selectedItems:s,convexHull:a,isActive:s.length>0},u.recordState(),S.log("AnnotationService",`Lasso selection completed: ${s.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){var i,r;if(!((i=u.state.lassoSelection)!=null&&i.isActive)||!((r=u.state.lassoSelection.selectedItems)!=null&&r.length))return;const e=this.getRenderOptions(),s=u.state.lassoSelection.selectedItems.map(a=>{const c=a.data.columnIndex!==void 0?a.data.columnIndex:a.data.startColumnIndex!==void 0?a.data.startColumnIndex:a.data.column,h=ft(c,e),m=Rt(a.data.row,e);return{x:h,y:m}});u.state.lassoSelection.convexHull=da(s)}removeFromLassoSelection(e,s){var c;if(!((c=u.state.lassoSelection)!=null&&c.isActive))return;const i=this.getRenderOptions(),r=15;let a=null;if(u.state.placedNotes.forEach(h=>{const m=ft(h.columnIndex,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=r&&(a=`note-${h.row}-${h.columnIndex}-${h.color}-${h.shape}`)}),a||u.state.stampPlacements.forEach(h=>{const m=ft(h.column,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=r&&(a=`stamp-${h.row}-${h.column}-${h.stampId}`)}),a||u.state.tripletPlacements.forEach(h=>{const m=ft(h.column,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=r&&(a=`triplet-${h.row}-${h.column}-${h.tripletId}`)}),a){const h=u.state.lassoSelection.selectedItems.filter(f=>f.id!==a);let m=null;if(h.length>0){const f=h.map(v=>{const y=ft(v.data.columnIndex||v.data.column,i),w=Rt(v.data.row,i);return{x:y,y:w}});m=da(f)}u.state.lassoSelection={selectedItems:h,convexHull:m,isActive:h.length>0},u.recordState(),this.render(),S.log("AnnotationService",`Removed item from lasso selection. ${h.length} items remain.`,"annotation")}}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(e){const{startX:s,startY:i,endX:r,endY:a}=e,c=this.ctx,h=Math.min(s,r),m=Math.min(i,a),f=Math.abs(r-s),v=Math.abs(a-i);c.save(),c.strokeStyle="rgba(74, 144, 226, 0.6)",c.lineWidth=2,c.setLineDash([5,5]),c.strokeRect(h,m,f,v),this.toolSettings.text.background&&(c.fillStyle="rgba(255, 255, 255, 0.8)",c.fillRect(h,m,f,v)),c.restore()}render(){ni.render()}drawArrow(e,s=!1,i=!1,r=!1){const{startX:a,startY:c,endX:h,endY:m,settings:f}=e,v=this.ctx;v.save(),i&&(v.strokeStyle="#4a90e2",v.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,v.globalAlpha=.3,v.setLineDash([]),v.beginPath(),v.moveTo(a,c),v.lineTo(h,m),v.stroke(),v.globalAlpha=1),r&&!i&&(v.strokeStyle="#4a90e2",v.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,v.globalAlpha=.15,v.setLineDash([]),v.beginPath(),v.moveTo(a,c),v.lineTo(h,m),v.stroke(),v.globalAlpha=1),v.strokeStyle=s?"rgba(0, 0, 0, 0.5)":"#000000",v.lineWidth=this.getStrokeWidth(f.strokeWeight),v.setLineDash(this.getLineDash(f.lineStyle));const y=Math.atan2(m-c,h-a),w=f.arrowheadSize||12;let x=a,A=c,E=h,M=m;f.startArrowhead!=="none"&&(x=a+Math.cos(y)*w,A=c+Math.sin(y)*w),f.endArrowhead!=="none"&&(E=h-Math.cos(y)*w,M=m-Math.sin(y)*w),v.beginPath(),v.moveTo(x,A),v.lineTo(E,M),v.stroke(),f.startArrowhead!=="none"&&this.drawArrowhead(v,a,c,y+Math.PI,f.startArrowhead,w),f.endArrowhead!=="none"&&this.drawArrowhead(v,h,m,y,f.endArrowhead,w),v.restore()}drawArrowhead(e,s,i,r,a,c=12){switch(e.save(),e.translate(s,i),e.rotate(r),e.setLineDash([]),a){case"filled":case"filled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.fillStyle=e.strokeStyle,e.fill();break;case"unfilled":case"unfilled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.stroke();break;case"circle":e.beginPath(),e.arc(0,0,c/3,0,Math.PI*2),e.fillStyle=e.strokeStyle,e.fill();break}e.restore()}wrapText(e,s,i){const r=s.split(`
`),a=[];return r.forEach(c=>{if(!c.trim()){a.push("");return}const h=c.split(" ");let m="";h.forEach((f,v)=>{const y=m?m+" "+f:f;e.measureText(y).width>i&&m?(a.push(m),m=f):m=y}),m&&a.push(m)}),a}drawText(e,s=!1,i=!1){const{x:r,y:a,text:c,settings:h}=e,m=this.ctx;m.save();const v=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',y=this.getSizeValue(h.size);m.font=`${h.italic?"italic ":""}${h.bold?"bold ":""}${y} ${v}`,m.textBaseline="top";const w=parseInt(y)*1.2,x=e.width||0,A=e.height||0,E=h.background?16:8,M=x-E,I=this.wrapText(m,c,M);if(h.background){m.fillStyle="#ffffff";const D=8;m.fillRect(r-D/2,a-D/2,x+D,A+D/2)}if(i&&!s){m.fillStyle="rgba(74, 144, 226, 0.1)";const D=h.background?8:2;m.fillRect(r-D/2,a-D/2,x+D,A+D/2)}if(s){m.fillStyle="rgba(74, 144, 226, 0.2)";const D=h.background?8:2;m.fillRect(r-D/2,a-D/2,x+D,A+D/2)}m.fillStyle=h.color;const R=parseInt(y);I.forEach((D,G)=>{const X=a+G*w;this.drawTextWithSuperscripts(m,D,r,X,R,h,v)}),s&&this.drawResizeHandles(r,a,x,A),m.restore()}drawTextWithSuperscripts(e,s,i,r,a,c,h){if(c.superscript||c.subscript){e.save();const y=a*.6,w=c.superscript?-a*.4:a*.3;if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${y}px ${h}`,e.fillText(s,i,r+w),c.underline){const x=e.measureText(s);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(i,r+w+y*1.2-2),e.lineTo(i+x.width,r+w+y*1.2-2),e.stroke()}e.restore();return}let m=i;const f=this.parseFormattedText(s),v=(y,w)=>{if(y){if(e.save(),w==="superscript"){const x=a*.6,A=-a*.4;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${x}px ${h}`,e.fillText(y,m,r+A),m+=e.measureText(y).width}else if(w==="subscript"){const x=a*.6,A=a*.3;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${x}px ${h}`,e.fillText(y,m,r+A),m+=e.measureText(y).width}else{if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${a}px ${h}`,e.fillText(y,m,r),c.underline){const x=e.measureText(y);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(m,r+a*1.2-2),e.lineTo(m+x.width,r+a*1.2-2),e.stroke()}m+=e.measureText(y).width}e.restore()}};f.forEach(y=>{v(y.text,y.format)})}parseFormattedText(e){const s=[];let i=0,r="",a=!1;for(;i<e.length;){if(e.substr(i,5)==="<sup>"){r&&(s.push({text:r,format:"normal"}),r="");const c=e.indexOf("</sup>",i);if(c!==-1){const h=e.substring(i+5,c);s.push({text:h,format:"superscript"}),i=c+6;continue}}if(e.substr(i,5)==="<sub>"){r&&(s.push({text:r,format:"normal"}),r="");const c=e.indexOf("</sub>",i);if(c!==-1){const h=e.substring(i+5,c);s.push({text:h,format:"subscript"}),i=c+6;continue}}if(e[i]==="^"&&!a){r&&(s.push({text:r,format:"normal"}),r=""),a=!0,i++;continue}if(a&&e[i]===" "){r&&(s.push({text:r,format:"superscript"}),r=""),a=!1,s.push({text:" ",format:"normal"}),i++;continue}r+=e[i],i++}return r&&s.push({text:r,format:a?"superscript":"normal"}),s}drawResizeHandles(e,s,i,r){const a=this.ctx,c=8,h=[{pos:"nw",x:e,y:s},{pos:"n",x:e+i/2,y:s},{pos:"ne",x:e+i,y:s},{pos:"e",x:e+i,y:s+r/2},{pos:"se",x:e+i,y:s+r},{pos:"s",x:e+i/2,y:s+r},{pos:"sw",x:e,y:s+r},{pos:"w",x:e,y:s+r/2}];a.save(),h.forEach(m=>{a.fillStyle="#4a90e2",a.strokeStyle="#ffffff",a.lineWidth=2,a.fillRect(m.x-c/2,m.y-c/2,c,c),a.strokeRect(m.x-c/2,m.y-c/2,c,c)}),a.restore()}drawPath(e,s){const{path:i,settings:r}=e,a=this.ctx;if(!(i.length<2)){a.save(),s&&(a.globalAlpha=.3),a.strokeStyle=r.color,a.lineWidth=this.getStrokeWidth(r.size),a.lineCap="round",a.lineJoin="round",a.beginPath(),a.moveTo(i[0].x,i[0].y);for(let c=1;c<i.length;c++)a.lineTo(i[c].x,i[c].y);a.stroke(),a.restore()}}drawLassoPath(e){const{path:s}=e,i=this.ctx;if(!(s.length<2)){i.save(),i.strokeStyle="rgba(0, 100, 255, 0.8)",i.lineWidth=2,i.setLineDash([5,5]),i.beginPath(),i.moveTo(s[0].x,s[0].y);for(let r=1;r<s.length;r++)i.lineTo(s[r].x,s[r].y);i.lineTo(s[0].x,s[0].y),i.stroke(),i.restore()}}getStrokeWidth(e){if(typeof e=="number")return e;switch(e){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(e){switch(e){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(e){if(typeof e=="number")return`${e}px`;switch(e){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(e,s){var a;const i=this.hoverAnnotation;if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=this.getResizeHandleAt(e,s,this.selectedAnnotation);if(c){const h={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=h[c];return}}if((a=u.state.lassoSelection)!=null&&a.isActive&&u.state.lassoSelection.convexHull){const c=Nd({x:e,y:s},u.state.lassoSelection.convexHull,10),h=Cr({x:e,y:s},u.state.lassoSelection.convexHull);if(c||h){this.canvas.style.cursor="move";return}}const r=this.getAnnotationAt(e,s);r&&(r.type==="arrow"||r.type==="text")?(this.canvas.style.cursor="move",this.hoverAnnotation=r):(this.setTool(this.currentTool,this.toolSettings),this.hoverAnnotation=null),i!==this.hoverAnnotation&&this.render()}getResizeHandleAt(e,s,i){if(!i||i.type!=="text")return null;const a=8/2+2,c=i.width||0,h=i.height||0,m=i.x,f=i.y,v=[{pos:"nw",x:m,y:f},{pos:"n",x:m+c/2,y:f},{pos:"ne",x:m+c,y:f},{pos:"e",x:m+c,y:f+h/2},{pos:"se",x:m+c,y:f+h},{pos:"s",x:m+c/2,y:f+h},{pos:"sw",x:m,y:f+h},{pos:"w",x:m,y:f+h/2}];for(const y of v)if(Math.sqrt(Math.pow(e-y.x,2)+Math.pow(s-y.y,2))<=a)return y.pos;return null}getAnnotationAt(e,s){for(let r=u.state.annotations.length-1;r>=0;r--){const a=u.state.annotations[r];if(a.type==="arrow"){if(this.distanceToLineSegment(e,s,a.startX,a.startY,a.endX,a.endY)<10)return a}else if(a.type==="text"){let c=a.width,h=a.height;if(!c||!h){const m=a.text.split(`
`),f=a.settings.size,v=f*1.2;this.ctx.font=`${f}px Arial`,c=0,m.forEach(y=>{const w=this.ctx.measureText(y);c=Math.max(c,w.width)}),h=m.length*v}if(e>=a.x&&e<=a.x+c&&s>=a.y&&s<=a.y+h)return a}}return null}showEraserCursor(e,s){this.render();const r=(u.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(e-r/2,s-r/2,r,r),this.ctx.restore()}loadAnnotationSettings(e){if(e.type==="arrow"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.arrow={...s},window.drawToolsController.renderArrowOptions()}else if(e.type==="text"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.text={...s},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){u.state.annotations=[],this.render()}eraseAtPoint(e,s){let r=!1;return u.state.annotations=u.state.annotations.filter(a=>{let c=!0;if(a.type==="arrow"){const h=this.getRenderOptions(),m=ft(a.startCol,h),f=Rt(a.startRow,h),v=ft(a.endCol,h),y=Rt(a.endRow,h);this.distanceToLineSegment(e,s,m,f,v,y)<10&&(c=!1,r=!0)}else if(a.type==="text"){const h=this.getRenderOptions(),m=ft(a.col,h),f=Rt(a.row,h),v=ft(a.col+a.widthCols,h),y=Rt(a.row+a.heightRows,h);e>=m&&e<=v&&s>=f&&s<=y&&(c=!1,r=!0)}else if(a.type==="marker"||a.type==="highlighter"){const h=this.getRenderOptions();for(let m=0;m<a.path.length;m++){const f=ft(a.path[m].col,h),v=Rt(a.path[m].row,h),y=e-f,w=s-v;if(Math.sqrt(y*y+w*w)<10){c=!1,r=!0;break}}}return c}),r&&this.render(),r}interpolatePoints(e,s){const i=[],r=s.col-e.col,a=s.row-e.row,c=Math.sqrt(r*r+a*a),h=Math.max(1,Math.floor(c/.1));for(let m=1;m<=h;m++){const f=m/h;i.push({col:e.col+f*r,row:e.row+f*a})}return i}distanceToLineSegment(e,s,i,r,a,c){const h=a-i,m=c-r,f=h*h+m*m;if(f===0){const E=e-i,M=s-r;return Math.sqrt(E*E+M*M)}let v=((e-i)*h+(s-r)*m)/f;v=Math.max(0,Math.min(1,v));const y=i+v*h,w=r+v*m,x=e-y,A=s-w;return Math.sqrt(x*x+A*A)}deleteAnnotationAt(e,s){this.eraseAtPoint(e,s)}getAnnotations(){return u.state.annotations}loadAnnotations(e){u.state.annotations=e||[],this.render()}applyInlineFormatting(e){const s=document.querySelector(".annotation-text-input");if(!s)return;const i=window.getSelection();if(!i.rangeCount)return;const r=i.getRangeAt(0),a=r.toString();if(!a)return;let c;if(e==="superscript")c=`<sup>${a}</sup>`;else if(e==="subscript")c=`<sub>${a}</sub>`;else return;r.deleteContents();const h=document.createTextNode(c);r.insertNode(h),r.setStartAfter(h),r.setEndAfter(h),i.removeAllRanges(),i.addRange(r),s.focus()}}const Ut=new ib;function ob(n,e){var c;const s=u.state.annotations,i=Ut.tempAnnotation,r=Ut.selectedAnnotation,a=Ut.hoverAnnotation;if(s&&s.length>0&&s.forEach(h=>{const m=h===r,f=h===a;switch(h.type){case"arrow":Fd(n,h,m,f,e);break;case"text":rb(n,h,m,f,e);break;case"marker":pa(n,h,!1,e);break;case"highlighter":pa(n,h,!0,e);break}}),i)switch(i.type){case"arrow":Fd(n,i,!1,!1,e);break;case"text":ub(n,i,e);break;case"marker":pa(n,i,!1,e);break;case"highlighter":pa(n,i,!0,e);break;case"lasso":pb(n,i);break}(c=u.state.lassoSelection)!=null&&c.isActive&&u.state.lassoSelection.convexHull&&(Ut.updateLassoConvexHull(),mb(n,u.state.lassoSelection.convexHull))}function Fd(n,e,s=!1,i=!1,r){const{startCol:a,startRow:c,endCol:h,endRow:m,settings:f}=e,v=ft(a,r),y=Rt(c,r),w=ft(h,r),x=Rt(m,r);n.save(),n.strokeStyle=e.color||"#000000",n.lineWidth=ih(f.strokeWeight),n.setLineDash(db(f.lineStyle));const A=Math.atan2(x-y,w-v),E=f.arrowheadSize||12;let M=v,I=y,R=w,D=x;f.startArrowhead!=="none"&&(M=v+Math.cos(A)*E,I=y+Math.sin(A)*E),f.endArrowhead!=="none"&&(R=w-Math.cos(A)*E,D=x-Math.sin(A)*E),n.beginPath(),n.moveTo(M,I),n.lineTo(R,D),n.stroke(),n.setLineDash([]),f.startArrowhead!=="none"&&Bd(n,v,y,A+Math.PI,f.startArrowhead,E),f.endArrowhead!=="none"&&Bd(n,w,x,A,f.endArrowhead,E),(s||i)&&(n.strokeStyle=s?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",n.lineWidth=ih(f.strokeWeight)+4,n.setLineDash([]),n.beginPath(),n.moveTo(v,y),n.lineTo(w,x),n.stroke()),n.restore()}function Bd(n,e,s,i,r,a){switch(n.save(),n.translate(e,s),n.rotate(i),r){case"filled":case"filled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-a,-a/2),n.lineTo(-a,a/2),n.closePath(),n.fillStyle=n.strokeStyle,n.fill();break;case"unfilled":case"unfilled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-a,-a/2),n.lineTo(-a,a/2),n.closePath(),n.stroke();break;case"circle":n.beginPath(),n.arc(0,0,a/3,0,Math.PI*2),n.fillStyle=n.strokeStyle,n.fill();break}n.restore()}function rb(n,e,s=!1,i=!1,r){const{col:a,row:c,text:h,settings:m,widthCols:f,heightRows:v}=e,y=ft(a,r),w=Rt(c,r),x=ft(a+f,r)-y,A=Rt(c+v,r)-w;n.save();const M=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',I=m.size,R=I*1.2,D=m.background?8:4,G=4,X=x-D*2,F=ab(n,h,X,I,m,M);m.background&&(n.fillStyle="#ffffff",n.fillRect(y,w,x,A)),i&&!s&&(n.fillStyle="rgba(74, 144, 226, 0.1)",n.fillRect(y,w,x,A)),s&&(n.fillStyle="rgba(74, 144, 226, 0.2)",n.fillRect(y,w,x,A)),n.fillStyle=m.color,F.forEach((H,Q)=>{const K=w+G+Q*R;lb(n,H,y+D,K,I,m,M)}),s&&hb(n,y,w,x,A),n.restore()}function ab(n,e,s,i,r,a){n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${i}px ${a}`;const c=e.split(`
`),h=[];return c.forEach(m=>{if(!m.trim()){h.push("");return}const f=m.split(" ");let v="";f.forEach(y=>{const w=v?v+" "+y:y;n.measureText(w).width>s&&v?(h.push(v),v=y):v=w}),v&&h.push(v)}),h}function lb(n,e,s,i,r,a,c){if(a.superscript||a.subscript){n.save();const f=r*.6,v=a.superscript?-r*.4:r*.3;if(n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${f}px ${c}`,n.fillText(e,s,i+v),a.underline){const y=n.measureText(e);n.beginPath(),n.strokeStyle=a.color,n.lineWidth=1,n.moveTo(s,i+v+f*1.2-2),n.lineTo(s+y.width,i+v+f*1.2-2),n.stroke()}n.restore();return}const h=cb(e);let m=s;h.forEach(f=>{if(n.save(),f.format==="superscript"){const v=r*.6,y=-r*.4;n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${v}px ${c}`,n.fillText(f.text,m,i+y),m+=n.measureText(f.text).width}else if(f.format==="subscript"){const v=r*.6,y=r*.3;n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${v}px ${c}`,n.fillText(f.text,m,i+y),m+=n.measureText(f.text).width}else{if(n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${r}px ${c}`,n.fillText(f.text,m,i),a.underline){const v=n.measureText(f.text);n.beginPath(),n.strokeStyle=a.color,n.lineWidth=1,n.moveTo(m,i+r*1.2-2),n.lineTo(m+v.width,i+r*1.2-2),n.stroke()}m+=n.measureText(f.text).width}n.restore()})}function cb(n){const e=[];let s=0,i="",r=!1;for(;s<n.length;){if(n.substr(s,5)==="<sup>"){i&&(e.push({text:i,format:"normal"}),i="");const a=n.indexOf("</sup>",s);if(a!==-1){const c=n.substring(s+5,a);e.push({text:c,format:"superscript"}),s=a+6;continue}}if(n.substr(s,5)==="<sub>"){i&&(e.push({text:i,format:"normal"}),i="");const a=n.indexOf("</sub>",s);if(a!==-1){const c=n.substring(s+5,a);e.push({text:c,format:"subscript"}),s=a+6;continue}}if(n[s]==="^"&&!r){i&&(e.push({text:i,format:"normal"}),i=""),r=!0,s++;continue}if(r&&n[s]===" "){i&&(e.push({text:i,format:"superscript"}),i=""),r=!1,e.push({text:" ",format:"normal"}),s++;continue}i+=n[s],s++}return i&&e.push({text:i,format:r?"superscript":"normal"}),e}function hb(n,e,s,i,r){const c=[{x:e,y:s},{x:e+i/2,y:s},{x:e+i,y:s},{x:e+i,y:s+r/2},{x:e+i,y:s+r},{x:e+i/2,y:s+r},{x:e,y:s+r},{x:e,y:s+r/2}];n.save(),c.forEach(h=>{n.fillStyle="#4a90e2",n.strokeStyle="#ffffff",n.lineWidth=2,n.fillRect(h.x-8/2,h.y-8/2,8,8),n.strokeRect(h.x-8/2,h.y-8/2,8,8)}),n.restore()}function ub(n,e,s){const{startCol:i,startRow:r,endCol:a,endRow:c}=e,h=ft(i,s),m=Rt(r,s),f=ft(a,s),v=Rt(c,s),y=Math.min(h,f),w=Math.min(m,v),x=Math.abs(f-h),A=Math.abs(v-m);n.save(),n.strokeStyle="rgba(74, 144, 226, 0.6)",n.lineWidth=2,n.setLineDash([5,5]),n.strokeRect(y,w,x,A),n.restore()}function pa(n,e,s,i){const{path:r,settings:a}=e;if(!r||r.length<2)return;const c=r.map(h=>({x:ft(h.col,i),y:Rt(h.row,i)}));n.save(),s&&(n.globalAlpha=.3),n.strokeStyle=a.color,n.lineWidth=typeof a.size=="number"?a.size:ih(a.size),n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(c[0].x,c[0].y);for(let h=1;h<c.length;h++)n.lineTo(c[h].x,c[h].y);n.stroke(),n.restore()}function ih(n){if(typeof n=="number")return n;switch(n){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function db(n){switch(n){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function pb(n,e){if(!(!e.path||e.path.length<2)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([5,5]),n.globalAlpha=.7,n.beginPath(),n.moveTo(e.path[0].x,e.path[0].y);for(let s=1;s<e.path.length;s++)n.lineTo(e.path[s].x,e.path[s].y);e.path.length>2&&n.lineTo(e.path[0].x,e.path[0].y),n.stroke(),n.restore()}}function mb(n,e){if(!(!e||e.length<3)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([8,4]),n.globalAlpha=.8,n.beginPath(),n.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)n.lineTo(e[s].x,e[s].y);n.closePath(),n.stroke(),n.fillStyle="rgba(74, 144, 226, 0.1)",n.fill(),n.restore()}}function tm(n,e){const s={...e,...u.state};s.modulationMarkers&&s.modulationMarkers.length>0,n.clearRect(0,0,n.canvas.width,n.canvas.height);const{startRow:i,endRow:r}=A0();F0(n,s,i,r),R0(n,s,i,r),D0(n,s);const a=e.placedNotes.filter(h=>!h.isDrum&&h.row>=i&&h.row<=r),c=e.placedTonicSigns.filter(h=>h.row>=i&&h.row<=r);a.forEach(h=>{h.shape==="oval"?Nh(n,s,h,h.row):h.shape==="circle"&&Oh(n,s,h,h.row)}),c.forEach(h=>{Lh(n,s,h)}),$0(n,s),j0(n,s),Kp(n,s),ob(n,s)}const em={getTimeSignatureSegments(){const n=[];let e=u.state.hasAnacrusis,s=us(u.state,0).startColumn,i=0,r=!1;return u.state.macrobeatGroupings.forEach((a,c)=>{i+=a,a===3&&(r=!0);const h=c===u.state.macrobeatGroupings.length-1,f=u.state.macrobeatBoundaryStyles[c]==="solid";if(f||h){const v=us(u.state,c).endColumn+1,y=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;let w,x;if(y){const E={...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth};w=ft(s,E),x=ft(v,E)}else w=St.getColumnX(s),x=St.getColumnX(v);const A=r?`${i}/8`:`${i/2}/4`;n.push({label:A,centerX:(w+x)/2,startX:w,endX:x,isAnacrusis:e}),h||(s=v,i=0,r=!1,f&&(e=!1))}}),n},getRhythmUIButtons(){const n=[],e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,s=e?{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}:null;return u.state.macrobeatGroupings.forEach((i,r)=>{const{startColumn:a,endColumn:c}=us(u.state,r),h=e?ft(a,s):St.getColumnX(a),m=e?ft(c+1,s):St.getColumnX(c+1),f=(h+m)/2,v=u.state.macrobeatBoundaryStyles[r]??null;n.push({type:"grouping",content:i,x:f,startX:h,endX:m,index:r,nextBoundaryStyle:v}),r<u.state.macrobeatGroupings.length-1&&n.push({type:"boundary",boundaryStyle:v,x:m,index:r})}),n}};function fb(){const n=document.getElementById("grouping-buttons-row"),e=document.getElementById("boundary-buttons-row");if(!n||!e)return;n.innerHTML="",e.innerHTML="";const s=document.getElementById("notation-grid");if(!s)return;const i=s.getBoundingClientRect(),r=n.getBoundingClientRect(),a=i.left-r.left,c=u.state.cellWidth*1,h=.8,m=.64,f=20,v=18,y=Math.max(f,c*h),w=Math.max(v,c*m),x=document.getElementById("time-signature-row"),A=em.getRhythmUIButtons();x&&(x.style.height=""),n.style.height="",e.style.height=`${w}px`,e.style.minHeight=`${w}px`;const E=M=>M?M==="solid"?"solid":"dashed":"";A.forEach(M=>{if(M.type==="grouping"){const F=document.createElement("button");F.type="button",F.className="grouping-segment",F.dataset.type="grouping";const H=M.startX??0,Q=M.endX??H,K=a+H,pt=Math.max(0,Q-H);F.style.left=`${K}px`,F.style.width=`${pt}px`,F.style.top="0",F.style.bottom="0",F.style.fontSize=`${y*.55}px`,F.style.zIndex="10";const ut=E(M.nextBoundaryStyle);ut?F.dataset.nextBoundaryStyle=ut:delete F.dataset.nextBoundaryStyle,F.textContent=String(M.content),F.setAttribute("aria-label",`Cycle grouping size (current: ${M.content})`),F.addEventListener("click",()=>u.toggleMacrobeatGrouping(M.index)),n.appendChild(F);return}const I=document.createElement("button");I.type="button",I.className="rhythm-ui-button",I.dataset.type=M.type,I.classList.add(`rhythm-ui-button--${M.type}`);const R=M.boundaryStyle||"dashed",D=a+M.x;I.dataset.boundaryStyle=R,I.style.position="absolute",I.style.left=`${D}px`,I.style.transform="translateX(-50%)",I.style.top="auto",I.style.bottom="0",I.style.width=`${w}px`,I.style.height=`${w}px`;const G=`Cycle boundary style (current: ${R})`;I.setAttribute("aria-label",G),I.title=G;const X=document.createElement("span");X.className="boundary-diamond",X.dataset.style=R,X.setAttribute("aria-hidden","true"),I.appendChild(X),I.addEventListener("click",()=>u.cycleMacrobeatBoundaryStyle(M.index)),e.appendChild(I)})}const gb={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const n=this.getTimeSignatureOptions();let e='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(n).forEach(([s,i])=>{e+='<div class="dropdown-category">',e+=`<div class="dropdown-category-header">${s}</div>`,i.forEach((r,a)=>{const c=`${s}-${a}`;e+=`<div class="dropdown-option" data-groupings="${JSON.stringify(r.groupings)}" data-key="${c}">`,e+=`<span class="dropdown-label">${r.label}</span>`,e+=`<span class="dropdown-description">${r.description}</span>`,e+="</div>"}),e+="</div>"}),e+="</div>",e},getTimeSignatureLabel(n){const e=n.reduce((i,r)=>i+r,0);return n.includes(3)?`${e}/8`:`${e/2}/4`}};let Yi=null;function vb(){const n=document.getElementById("beat-line-button-layer");if(!n)return;n.querySelectorAll(".time-signature-label").forEach(h=>h.remove());const s=document.getElementById("notation-grid");if(!s)return;const i=s.getBoundingClientRect(),r=n.getBoundingClientRect(),a=i.left-r.left;em.getTimeSignatureSegments().forEach((h,m)=>{const f=document.createElement("div");f.className="time-signature-label",h.isAnacrusis&&f.classList.add("anacrusis-label"),f.textContent=h.label,f.style.position="absolute",f.style.left=`${a+h.centerX}px`,f.style.transform="translateX(-50%)",f.addEventListener("click",v=>{v.stopPropagation(),bb(f,m)}),n.appendChild(f)}),yb()}function yb(){if(!document.getElementById("time-signature-dropdown")){const n=gb.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",n),document.getElementById("time-signature-dropdown").addEventListener("click",_b)}}function bb(n,e){const s=document.getElementById("time-signature-dropdown");if(!s)return;s.dataset.measureIndex=e;const i=n.getBoundingClientRect();s.style.left=`${i.left}px`,s.style.top=`${i.bottom+5}px`;const r=s.getBoundingClientRect(),a=window.innerWidth,c=window.innerHeight;i.left+r.width>a&&(s.style.left=`${a-r.width-10}px`),i.bottom+r.height>c&&(s.style.top=`${i.top-r.height-5}px`),s.classList.remove("hidden"),Yi={dropdown:s,measureIndex:e},setTimeout(()=>{document.addEventListener("click",wb,{once:!0})},0)}function wb(n){const e=document.getElementById("time-signature-dropdown");e&&!e.contains(n.target)&&(e.classList.add("hidden"),Yi=null)}function _b(n){const e=n.target.closest(".dropdown-option");if(!e)return;const s=e.dataset.groupings,i=parseInt(Yi==null?void 0:Yi.measureIndex,10);if(!(!s||Number.isNaN(i)))try{const r=JSON.parse(s);u.updateTimeSignature(i,r),document.getElementById("time-signature-dropdown").classList.add("hidden"),Yi=null}catch{}}S.moduleLoaded("PitchGridController","grid");function xb(){const n=Dh.getPitchContext();if(!n||!n.canvas){S.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const e={placedNotes:n0(u.state),placedTonicSigns:rn(u.state),fullRowData:u.state.fullRowData,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,rowHeight:u.state.cellHeight*.5,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,colorMode:"color",degreeDisplayMode:u.state.degreeDisplayMode,zoomLevel:St.getViewportInfo().zoomLevel,viewportHeight:n.canvas.height};tm(n,e)}const ni={render(){xb()},renderMacrobeatTools(){fb(),vb()}};class Sb{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.activeAnimations=new Map,this.popDuration={scaleUp:100,scaleDown:300},this.popScale=1.5}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),u.on("tempoChanged",()=>this.invalidateTimeMap()))}handlePlaybackStateChange(){u.state.isPlaying&&!u.state.isPaused?this.startRendering():this.stopRendering()}invalidateTimeMap(){this._lastTempo=0}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.isPlaying||u.state.isPaused||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.calculateXFromTime(U.Transport.seconds);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0,this.animationFrameId=requestAnimationFrame(()=>this.render())}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let i=0;i<u.state.columnWidths.length;i++)this.timeMap[i]=e,e+=u.state.columnWidths[i]*s;this.timeMap.push(e)}getColumnX(e){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const i={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return ft(e,i)}else return St.getColumnX(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const i=this.timeMap[s],r=this.timeMap[s+1]-i,a=e-i,c=this.getColumnX(s),h=this.getColumnX(s+1)-c;return c+(r>0?a/r*h:0)}return null}triggerNotePop(e,s){const i=`${e}-${s}`;this.activeAnimations.set(i,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(e,s){const i=`${e}-${s}`,r=this.activeAnimations.get(i);if(!r)return 1;const a=performance.now(),c=a-r.startTime;if(r.phase==="scaleUp"){if(c>=this.popDuration.scaleUp)return r.phase="scaleDown",r.startTime=a,this.popScale;{const h=c/this.popDuration.scaleUp;return 1+(this.popScale-1)*h}}else if(r.phase==="scaleDown"){if(c>=this.popDuration.scaleDown)return this.activeAnimations.delete(i),1;{const h=c/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*h}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const e=performance.now();for(const[s,i]of this.activeAnimations.entries()){const r=e-i.startTime,a=i.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;r>a&&this.activeAnimations.delete(s)}}}const Vn=new Sb;let ma=null;const Cb=()=>(ma||(ma=new Image,ma.src="/assets/icons/volume.svg"),ma);function Fn(n,e){return e.modulationMarkers&&e.modulationMarkers.length>0?ft(n,e):St.getColumnX(n)}function sm(n,e,s,i,r,a,c=1){const h=s+r/2,m=i+a/2,f=Math.min(r,a)*.4*c;if(n.beginPath(),e===0)n.moveTo(h,m-f),n.lineTo(h-f,m+f),n.lineTo(h+f,m+f),n.closePath();else if(e===1)n.moveTo(h,m-f),n.lineTo(h+f,m),n.lineTo(h,m+f),n.lineTo(h-f,m),n.closePath();else{for(let y=0;y<5;y++){const w=2*Math.PI/5*y-Math.PI/2,x=h+f*Math.cos(w),A=m+f*Math.sin(w);y===0?n.moveTo(x,A):n.lineTo(x,A)}n.closePath()}n.fill()}function Tb(n,e,s,i,r="normal"){const a=Cb();if(r!=="normal"){const c=i*1.3;n.beginPath(),n.arc(e,s,c/2,0,Math.PI*2),r==="hover"?n.fillStyle="rgba(74, 144, 226, 0.2)":r==="active"&&(n.fillStyle="rgba(74, 144, 226, 0.4)"),n.fill()}if(a.complete&&a.naturalWidth>0)r==="hover"?n.filter="brightness(1.2)":r==="active"&&(n.filter="brightness(0.8)"),n.drawImage(a,e-i/2,s-i/2,i,i),n.filter="none";else{let c="#6c757d",h="#6c757d";r==="hover"?(c="#4a90e2",h="#4a90e2"):r==="active"&&(c="#357abd",h="#357abd"),n.fillStyle=c,n.strokeStyle=h,n.lineWidth=1;const m=i*.4,f=i*.6,v=i*.3;n.fillRect(e-m/2,s-f/2,m,f),n.beginPath(),n.moveTo(e+m/2,s-f/3),n.lineTo(e+m/2+v,s-f/2),n.lineTo(e+m/2+v,s+f/2),n.lineTo(e+m/2,s+f/3),n.closePath(),n.fill();for(let y=1;y<=2;y++)n.beginPath(),n.arc(e+m/2+v+i*.1,s,i*.2*y,-Math.PI/4,Math.PI/4,!1),n.stroke()}}function Ab(n,e){const{columnWidths:s,macrobeatGroupings:i,macrobeatBoundaryStyles:r,placedTonicSigns:a}=e,c=s.length-2;let h=[],m=2;for(let f=0;f<i.length;f++){for(;a.some(v=>v.columnIndex===m);)m+=2;m+=i[f],h.push(m)}for(let f=0;f<=c;f++){const v=Fn(f,e);if(v<0||v>n.canvas.width)continue;let y;const w=f===2||f===c,x=Gp(f,a),A=a.some(I=>f===I.columnIndex+2),E=h.includes(f);if(jp(f,a)){if(w||x||A)y={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(E){const I=h.indexOf(f);if(I!==-1){const R=r[I];if(R==="anacrusis")continue;y={lineWidth:1,strokeStyle:"#adb5bd",dash:R==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(v,0),n.lineTo(v,n.canvas.height),n.lineWidth=y.lineWidth,n.strokeStyle=y.strokeStyle,n.setLineDash(y.dash),n.stroke()}}n.setLineDash([])}function nm(n,e){const{placedNotes:s,columnWidths:i,cellWidth:r,cellHeight:a,placedTonicSigns:c}=e;n.clearRect(0,0,n.canvas.width,n.canvas.height);const h=n.canvas;h.getBoundingClientRect(),window.getComputedStyle(h);const m=Math.max(uo,po*a),f=i.length,v=["H","M","L"];n.font=`${Math.floor(m*.7)}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#6c757d";const y=Fn(1,e)+Fn(1,e)*.3;v.forEach((M,I)=>{n.fillText(M,y,I*m+m/2)});const w=Fn(1,e)-Fn(1,e)*.3,x=3*m/2,A=e.volumeIconState||"normal";Tb(n,w,x,m*.6,A);const E=Fn(2,e);for(let M=0;M<4;M++){const I=M*m;n.beginPath(),n.moveTo(E,I),n.lineTo(n.canvas.width,I),n.strokeStyle="#ced4da",n.lineWidth=1,n.stroke()}Ab(n,e);for(let M=2;M<f-2;M++){if(c.some(D=>D.columnIndex===M))continue;const I=Fn(M,e);let R;e.modulationMarkers&&e.modulationMarkers.length>0?R=Fn(M+1,e)-I:R=i[M]*r;for(let D=0;D<3;D++){const G=D*m,X=v[D],F=s.find(H=>H.isDrum&&H.drumTrack===X&&H.startColumnIndex===M);if(F){n.fillStyle=F.color;const H=Vn.getAnimationScale(M,X);sm(n,D,I,G,R,m,H)}else n.fillStyle="#ced4da",n.beginPath(),n.arc(I+R/2,G+m/2,2,0,Math.PI*2),n.fill()}}Kp(n,e)}const Hs={getColumnIndex(n){const{columnWidths:e,cellWidth:s,modulationMarkers:i}=u.state;if(s===0)return 0;if(i&&i.length>0){const a={...u.state,modulationMarkers:i,cellWidth:s,columnWidths:e,baseMicrobeatPx:s};for(let c=0;c<e.length;c++){const h=ft(c+1,a);if(n<h)return c}}else{let a=0;for(let c=0;c<e.length;c++)if(a+=e[c]*s,n<a)return c}return e.length-1},getPitchRowIndex(n){const e=St.getViewportInfo();if(!e||!e.halfUnit||e.halfUnit===0)return-1;const s=Math.floor(n/e.halfUnit);return e.startRank+s},getDrumRowIndex(n){const e=Math.max(uo,po*u.state.cellHeight);return e===0?-1:Math.floor(n/e)}};let fe,Ba=!1,Tr=!1,Pa=1,vn=null,_n="normal",qd=0;const Mb=500;function fo(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return ft(n,s)}else return St.getColumnX(n)}function im(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s=fo(n);return fo(n+1)-s}else return u.state.columnWidths[n]*u.state.cellWidth}function oh(n,e,s){if(!fe)return;const i=fo(n),r=Math.max(uo,po*u.state.cellHeight),a=e*r,c=im(n);fe.fillStyle=s,fe.fillRect(i,a,c,r)}function Eb(n,e){if(!fe)return;const s=fo(n),i=Math.max(uo,po*u.state.cellHeight),r=e*i,a=im(n),c=["H","M","L"][e],h=Vn.getAnimationScale(n,c);fe.globalAlpha=.4,fe.fillStyle=u.state.selectedTool.color||"#212529",sm(fe,e,s,r,a,i,h),fe.globalAlpha=1}function Pb(n){const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=fo(2),a=s<r,c=_n;if(_n=a?"hover":"normal",c!==_n&&window.drumGridRenderer&&window.drumGridRenderer.render(),a){fe&&fe.clearRect(0,0,fe.canvas.width,fe.canvas.height);return}const h=document.getElementById("canvas-container").scrollLeft,m=Hs.getColumnIndex(s+h),f=Hs.getDrumRowIndex(i);if(!fe||m<2||m>=u.state.columnWidths.length-2||f<0||f>2){Bh();return}fe.clearRect(0,0,fe.canvas.width,fe.canvas.height);const v=["H","M","L"][f];Ba?(u.eraseDrumNoteAt(m,v,!1)&&(Tr=!0),oh(m,f,"rgba(220, 53, 69, 0.3)")):(oh(m,f,"rgba(74, 144, 226, 0.2)"),Eb(m,f))}function Bh(){fe&&fe.clearRect(0,0,fe.canvas.width,fe.canvas.height),_n!=="normal"&&(_n="normal",window.drumGridRenderer&&window.drumGridRenderer.render())}function kb(n){var f;n.preventDefault();const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=fo(2);if(s<r){_n="active",window.drumGridRenderer&&window.drumGridRenderer.render();const v=document.querySelector(".drum-volume-control");if(v){const y=v.style.display==="flex";v.style.display=y?"none":"flex"}return}const a=document.getElementById("canvas-container").scrollLeft,c=Hs.getColumnIndex(s+a);if(c<2||c>=u.state.columnWidths.length-2)return;const h=Hs.getDrumRowIndex(i);if(h<0||h>2)return;const m=["H","M","L"][h];if(n.button===2){Ba=!0,Tr=!1,(f=document.getElementById("eraser-tool-button"))==null||f.classList.add("erasing-active"),u.eraseDrumNoteAt(c,m,!1)&&(Tr=!0),fe.clearRect(0,0,fe.canvas.width,fe.canvas.height),oh(c,h,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const{color:v}=u.state.selectedTool,y={isDrum:!0,drumTrack:m,startColumnIndex:c,endColumnIndex:c,color:v||"#000000",shape:m==="H"?"triangle":m==="M"?"square":"pentagon"};u.toggleDrumNote(y),window.transportService&&window.transportService.drumPlayers&&(window.transportService.drumPlayers.player(m).start(),Vn.triggerNotePop(c,m))}}function Ib(){var n;Ba&&(Tr&&u.recordState(),Ba=!1,Tr=!1,(n=document.getElementById("eraser-tool-button"))==null||n.classList.remove("erasing-active")),_n==="active"&&(_n="normal",window.drumGridRenderer&&window.drumGridRenderer.render()),Bh()}function Rb(){const n=document.getElementById("drum-grid-wrapper");if(!n)return;const e=document.createElement("div");e.className="drum-volume-control",e.style.cssText=`
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        display: none;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 10;
    `,vn=document.createElement("input"),vn.type="range",vn.min="0",vn.max="100",vn.value="100",vn.className="drum-volume-slider",vn.style.cssText="width: 80px; margin: 0;",vn.addEventListener("input",r=>{if(Pa=r.target.value/100,window.drumVolumeNode){const a=Pa===0?-60:20*Math.log10(Pa);window.drumVolumeNode.volume.value=a;const c=Date.now();window.transportService&&window.transportService.drumPlayers&&c-qd>=Mb&&(window.transportService.drumPlayers.player("M").start("+0.1"),qd=c)}}),e.appendChild(vn),n.appendChild(e);const s=()=>{e.style.display="flex"},i=()=>{e.style.display="none"};n.addEventListener("mouseenter",r=>{const a=n.getBoundingClientRect();r.clientX-a.left<60&&s()}),e.addEventListener("mouseenter",s),e.addEventListener("mouseleave",i),n.addEventListener("mouseleave",i)}function Db(){return Pa}function Ob(){return _n}window.getDrumVolume=Db;function Nb(){const n=document.getElementById("drum-grid"),e=document.getElementById("drum-hover-canvas");!n||!e||(fe=e.getContext("2d"),n.addEventListener("mousedown",kb),n.addEventListener("mousemove",Pb),n.addEventListener("mouseleave",Bh),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",Ib),Rb())}function $d(){const n=Dh.getDrumContext();if(!n||!n.canvas)return;const e={placedNotes:i0(u.state),placedTonicSigns:rn(u.state),columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth,volumeIconState:Ob()};nm(n,e)}const ks={animationFrameId:null,render(){$d(),Vn.hasActiveAnimations()?ks.animationFrameId||ks.startAnimationLoop():ks.stopAnimationLoop()},startAnimationLoop(){if(ks.animationFrameId)return;const n=()=>{Vn.cleanupAnimations(),$d(),Vn.hasActiveAnimations()?ks.animationFrameId=requestAnimationFrame(n):ks.animationFrameId=null};ks.animationFrameId=requestAnimationFrame(n)},stopAnimationLoop(){ks.animationFrameId&&(cancelAnimationFrame(ks.animationFrameId),ks.animationFrameId=null)}};window.drumGridRenderer=ks;const li=ho,Ks={blend:2,cutoff:31,resonance:0,type:"lowpass"};function Dr(){return{coeffs:new Float32Array(li).fill(0),phases:new Float32Array(li).fill(0)}}function Lb(){const n=Dr();return n.coeffs[0]=1,n}function Fb(){const n=Dr();for(let e=1;e<=li;e+=2){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=0}return n}function Bb(){const n=Dr();for(let e=1;e<=li;e+=2){const s=e-1;n.coeffs[s]=1/(e*e),n.phases[s]=Math.PI/2}return n}function qb(){const n=Dr();for(let e=1;e<=li;e++){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=e&1?0:Math.PI}return n}const $b={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function fa(n){const e=Dr(),s=$b[n],i=Math.min(li,s.amps.length);for(let r=0;r<i;r++)e.coeffs[r]=s.amps[r]||0,e.phases[r]=s.phases[r]||0;return e}const Ko={attack:.1,decay:.2,sustain:.8,release:.3},zb={sine:{name:"sine",gain:1,adsr:Ko,...Lb(),filter:{...Ks}},triangle:{name:"triangle",gain:.81,adsr:Ko,...Bb(),filter:{...Ks}},square:{name:"square",gain:4/Math.PI,adsr:Ko,...Fb(),filter:{...Ks}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:Ko,...qb(),filter:{...Ks}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:Ko,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(li).fill(0),filter:{...Ks}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...Ks}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...fa("strings"),filter:{...Ks,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...fa("piano"),filter:{...Ks,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...fa("marimba"),filter:{...Ks,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...fa("woodwind"),filter:{...Ks}}};function Gs(n,e){if(!n)return`rgba(204, 204, 204, ${e})`;const s=parseInt(n.slice(yp,ld),Ta),i=parseInt(n.slice(ld,cd),Ta),r=parseInt(n.slice(cd,Ev),Ta);return`rgba(${s}, ${i}, ${r}, ${e})`}function Ua(n,e){if(!n||typeof n!="string")return Mv;const s=parseInt(n.slice(yp),Ta),i=e<0?Pv:kv,r=e<0?e*-1:e,a=s>>16,c=s>>8&255,h=s&255;return"#"+(16777216+(Math.round((i-a)*r)+a)*65536+(Math.round((i-c)*r)+c)*256+(Math.round((i-h)*r)+h)).toString(16).slice(1)}const Wb=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,Vb=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,Hb=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,Gb=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`;S.moduleLoaded("HarmonicBins with Columnar Structure");function rh(n,...e){}const ka={0:Wb,90:Vb,180:Hb,270:Gb},Os=ho;let Ge,Ee,_e=new Float32Array(Os).fill(0),Ft,is=new Float32Array(Os).fill(0);const qh=[],ah=[];let Zi=!1,Is=null;const Wi=new Array(Os).fill(null);let ga=!1;function rr(n,e){const{blend:s,cutoff:i,resonance:r}=e,a=(i-1)/30,c=20,h=n-a,m=a-n;let f=1/(1+Math.pow(Math.max(0,h*c),2)),v=1/(1+Math.pow(Math.max(0,m*c),2));const y=.01;f<y&&(f=0),v<y&&(v=0);const w=f*v;let x;s<=1?x=v*(1-s)+w*s:x=w*(2-s)+f*(s-1);const A=1-(r||0)/105,E=Math.max(.01,.2*A*A),M=Math.exp(-Math.pow((n-a)/E,2)),I=(r||0)/100*.6,R=x+M*I,D=Math.max(0,Math.min(1,R));return D<y?0:D}function jb(n,e){const s=e/100;return 1-s+s*n}let va=new Float32Array(Os).fill(1);new Float32Array(Os).fill(0);function Ar(n,e){const s=e.mix||0;if(s===0)return new Float32Array(n);const i=new Float32Array(n.length),r=s/100;for(let a=0;a<n.length;a++){const c=n[a],h=(a+.5)/Os,m=rr(h,e);if(m<c){const v=(c-m)*r;i[a]=c-v}else i[a]=c;i[a]=Math.max(0,i[a])}return i}function qa(n){const e=u.state.timbres[n];if(!e)return new Float32Array(Os);const s=e.filter;return s&&s.enabled!==!1&&(s.mix||0)>0?Ar(e.coeffs,s):new Float32Array(e.coeffs)}function lh(){var h;if((!Ge||!Ee||!Is)&&(Ge=document.getElementById("filter-overlay-canvas"),Is=document.querySelector(".harmonic-bins-grid"),Ge&&(Ee=Ge.getContext("2d"))),!Ge||!Ee||!Is)return;Is.getBoundingClientRect();const{width:n,height:e}=Ge;Ee.clearRect(0,0,n,e);const i=e*.95,r=e,a=(h=u.state.timbres[Ft])==null?void 0:h.filter,c=a&&a.enabled!==!1;if(a&&c){const m=a.mix||0;if(m===0){va.fill(1);return}const f=[];for(let A=0;A<Os;A++){const E=(A+.5)/Os,M=rr(E,a);va[A]=jb(M,m),f.push({bin:A+1,rawFilterAmp:M.toFixed(3),afterMix:va[A].toFixed(3)})}Ee.beginPath();const v=2;for(let A=0;A<=n;A+=v){const E=A/n,M=rr(E,a),I=r-M*i;A===0?Ee.moveTo(A,I):Ee.lineTo(A,I)}const w=.4+m/100*.6;Ee.strokeStyle=Gs(Ua(Ft,-.3),w),Ee.lineWidth=2.5,Ee.stroke();const x=m/100;if(x>0){Ee.beginPath(),Ee.moveTo(0,0),Ee.lineTo(n,0);const A=rr(1,a),E=r-A*i;Ee.lineTo(n,E);for(let M=n;M>=0;M-=2){const I=M/n,R=rr(I,a),D=r-R*i;Ee.lineTo(M,D)}Ee.closePath(),Ee.fillStyle=`rgba(255, 255, 255, ${x})`,Ee.fill()}}else va.fill(1)}function gr(){qh.forEach((n,e)=>{const s=n.sliderTrack.querySelector(".slider-fill"),i=n.sliderTrack.querySelector(".harmonic-label-internal"),r=_e[e];if(s.style.height=`${r*100}%`,r>0){const c=Ua(Ft,-.1);s.style.backgroundColor=Gs(c,1)}else s.style.backgroundColor="transparent";const a=s.querySelector("canvas");a&&a.remove(),r>.1?(i.style.color="rgba(255, 255, 255, 0.35)",i.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(i.style.color="rgba(51, 51, 51, 0.5)",i.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),lh()}function zd(n,e=null){var m,f,v,y;if(rh("log","[BINS DRAG] handleBinPointerEvent called",{clientX:n.clientX,clientY:n.clientY}),S.debug("HarmonicBins","handleBinPointerEvent called",{target:n.target.className},"filter"),n.target.classList.contains("phase-button")||n.target.closest(".phase-button")||n.target.tagName==="path"||n.target.tagName==="svg"){S.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(e===null){const w=Is.getBoundingClientRect(),x=n.clientX-w.left,A=w.width/Os;e=Math.floor(x/A),e=Math.max(0,Math.min(Os-1,e))}S.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:e},"filter");const i=qh[e].sliderTrack.getBoundingClientRect(),r=n.clientY-i.top,a=i.height;_e[e];const c=(a-r)/a,h=Math.max(0,Math.min(1,c));if(rh("log","[BINS DRAG] Setting bin",e+1,"value:",h.toFixed(3)),(((f=(m=u.state.timbres[Ft])==null?void 0:m.adsr)==null?void 0:f.release)||0)*1e3,h===0){S.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:e},"filter");const w=new Float32Array(u.state.timbres[Ft].coeffs);w[e]=0,_e[e]=0,u.setHarmonicCoefficients(Ft,w),Wi[e]&&(clearTimeout(Wi[e]),Wi[e]=null),Zi||(Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Zi=!0);const x=(v=u.state.timbres[Ft])==null?void 0:v.filter;x&&x.enabled!==!1&&(x.mix||0)>0&&Ar(w,x),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),S.debug("HarmonicBins",`Set coefficient H${e+1} to 0 for color ${Ft}`,null,"filter")}else{Wi[e]&&(clearTimeout(Wi[e]),Wi[e]=null),Zi||(Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Zi=!0),S.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:u.state.timbres[Ft].coeffs},"filter");const w=new Float32Array(u.state.timbres[Ft].coeffs);S.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:w},"filter"),w[e]=h,_e[e]=h,S.debug("HarmonicBins",`AFTER setting newCoeffs[${e}] = ${h}`,{newCoeffs:w},"filter"),u.setHarmonicCoefficients(Ft,w);const x=(y=u.state.timbres[Ft])==null?void 0:y.filter;x&&x.enabled!==!1&&(x.mix||0)>0&&Ar(w,x),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),S.debug("HarmonicBins",`Updated coefficient H${e+1} to ${h} for color ${Ft}`,null,"filter"),S.debug("HarmonicBins","All coefficients",{newCoeffs:w},"filter")}gr()}function ch(n,e,s,i){const r=s.coeffs,a=s.phases||new Float32Array(r.length).fill(0);let c=!0,h=!0;if(n.length!==r.length)c=!1;else for(let f=0;f<n.length;f++)if(Math.abs(n[f]-r[f])>.001){c=!1;break}if(e.length!==a.length)h=!1;else for(let f=0;f<e.length;f++)if(Math.abs(e[f]-a[f])>.001){h=!1;break}return c&&h}function Wd(n){if(!n)return;Ft=n;const e=u.state.timbres[n];e&&(e.filter?e.filter.enabled===void 0&&(e.filter.enabled=!0):e.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0},S.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:e.coeffs},"filter"),S.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:e.phases},"filter"),_e&&Array.from(_e),is&&Array.from(is),_e=new Float32Array(e.coeffs),e.phases?is=new Float32Array(e.phases):is=new Float32Array(_e.length).fill(0),ch(_e,is,e),S.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:_e},"filter"),S.debug("HarmonicBins","updateForNewColor - final phases",{phases:is},"filter"),ah.forEach(({phaseBtn:s},i)=>{if(!s)return;let a=(is[i]||0)%(2*Math.PI);a<0&&(a+=2*Math.PI);const c=.1;let h=0;Math.abs(a-Math.PI/2)<c?h=90:Math.abs(a-Math.PI)<c?h=180:Math.abs(a-3*Math.PI/2)<c&&(h=270),s.innerHTML=ka[h]}),gr())}function Xb(){var h;const n=document.querySelector(".filter-container"),e=n==null?void 0:n.querySelector(".filter-bins-wrapper"),s=n==null?void 0:n.querySelector(".filter-vertical-blend-wrapper");if(!n||!e||!s){S.error("HarmonicBins","Missing required elements - aborting init",null,"audio");return}Is=document.createElement("div"),Is.className="harmonic-bins-grid";for(let m=0;m<Os;m++){const f=document.createElement("div");f.className="slider-column";const v=document.createElement("div");v.className="slider-track";const y=document.createElement("div");y.className="slider-fill",v.appendChild(y);const w=document.createElement("div");w.className="harmonic-label-internal",w.textContent=`${m+1}`,v.appendChild(w),f.appendChild(v);const x=document.createElement("button");x.className="phase-button",x.innerHTML=ka[0],x.dataset.binIndex=m,x.addEventListener("pointerenter",A=>{var E,M,I,R;if(ga){const G=U.now();if(u.state.timbres[Ft],(I=(M=(E=Gt.synths)==null?void 0:E[Ft])==null?void 0:M.activeNotes)!=null&&I.C4){const X=Gt.synths[Ft].activeNotes.C4;(R=X.oscillators)!=null&&R[m]&&X.oscillators[m].volume.linearRampTo(-1/0,.015,G)}setTimeout(()=>{var H;const X=new Float32Array(u.state.timbres[Ft].coeffs);X[m]=0,_e[m]=0,u.setHarmonicCoefficients(Ft,X);const F=(H=u.state.timbres[Ft])==null?void 0:H.filter;F&&F.enabled!==!1&&(F.mix||0)>0&&Ar(X,F),gr()},.015*1e3)}}),x.addEventListener("click",A=>{if(ga){A.preventDefault();return}S.debug("HarmonicBins","Phase button click handler started",null,"filter"),S.debug("HarmonicBins","Current coeffs before phase change",{coeffs:_e},"filter"),A.preventDefault();const E=new Float32Array(is),M=new Float32Array(is);let R=(M[m]||0)%(2*Math.PI);R<0&&(R+=2*Math.PI);const D=.1;let G=0;Math.abs(R)<D?G=Math.PI/2:Math.abs(R-Math.PI/2)<D?G=Math.PI:Math.abs(R-Math.PI)<D?G=3*Math.PI/2:G=0,M[m]=G,is=M,window.staticWaveformVisualizer&&window.staticWaveformVisualizer.startPhaseTransition&&window.staticWaveformVisualizer.startPhaseTransition(E,M,m),u.setHarmonicPhases(Ft,M);const X=G===0?0:Math.abs(G-Math.PI/2)<D?90:Math.abs(G-Math.PI)<D?180:270;x.innerHTML=ka[X],S.debug("HarmonicBins",`Phase button clicked for H${m+1}, new phase: ${X}`,null,"filter")}),f.appendChild(x),Is.appendChild(f),qh.push({column:f,label:w,sliderTrack:v,sliderFill:y,phaseBtn:x}),ah.push({phaseBtn:x})}Is.addEventListener("pointerdown",m=>{if(rh("log","[BINS DRAG] Pointerdown event fired",{target:m.target,className:m.target.className}),m.target.classList.contains("phase-button")||m.target.closest(".phase-button")){S.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}S.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),m.preventDefault(),ga=!0,Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Zi=!0,zd(m);const f=y=>zd(y),v=()=>{var w;window.removeEventListener("pointermove",f),window.removeEventListener("pointerup",v),ga=!1;const y=!!((w=window.staticWaveformVisualizer)!=null&&w.generateWaveform);u.recordState(),Gt.triggerRelease("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!1}),Zi=!1,y?setTimeout(()=>{window.staticWaveformVisualizer.generateWaveform()},0):S.warn("HarmonicBins","Static waveform visualizer not ready when drag ended",null,"audio")};window.addEventListener("pointermove",f),window.addEventListener("pointerup",v)}),Ge=document.createElement("canvas"),Ge.id="filter-overlay-canvas",Ge.className="filter-overlay-canvas",Ge.style.pointerEvents="none",Ee=Ge.getContext("2d"),Is.appendChild(Ge);const i=document.createElement("div");i.className="vertical-blend-wrapper";const r=document.createElement("div");r.id="vertical-blend-track";const a=document.createElement("div");a.id="vertical-blend-thumb",a.textContent="M",r.appendChild(a),i.appendChild(r),e.appendChild(Is),s.appendChild(i);const c=()=>{const m=Ge.getBoundingClientRect();(Ge.width!==m.width||Ge.height!==m.height)&&(Ge.width=m.width,Ge.height=m.height,lh())};Ft=((h=u.state.selectedNote)==null?void 0:h.color)||"#4a90e2",Wd(Ft),u.on("timbreChanged",m=>{if(m===Ft){S.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const f=u.state.timbres[m],v=f.coeffs,y=f.phases;let w=!1;if(S.debug("HarmonicBins","Comparing coefficients...",null,"filter"),S.debug("HarmonicBins","Local coeffs",{coeffs:_e},"filter"),S.debug("HarmonicBins","Store coeffs",{newCoeffs:v},"filter"),!_e||_e.length!==v.length)S.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),w=!0;else for(let x=0;x<v.length;x++){const A=Math.abs(_e[x]-v[x]);if(A>.001){S.debug("HarmonicBins",`Coefficient ${x} changed: ${_e[x]} -> ${v[x]} (diff: ${A})`,null,"filter"),w=!0;break}}S.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),ch(_e||new Float32Array(12),is||new Float32Array(12),f),_e=new Float32Array(v),y?is=new Float32Array(y):is=new Float32Array(_e.length).fill(0),ch(_e,is,f),w?(S.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),gr()):(S.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),lh()),ah.forEach(({phaseBtn:x},A)=>{if(!x)return;let M=(is[A]||0)%(2*Math.PI);M<0&&(M+=2*Math.PI);const I=.1;let R=0;Math.abs(M-Math.PI/2)<I?R=90:Math.abs(M-Math.PI)<I?R=180:Math.abs(M-3*Math.PI/2)<I&&(R=270),x.innerHTML=ka[R]})}}),u.on("noteChanged",({newNote:m})=>{m.color&&m.color!==Ft&&Wd(m.color)}),u.on("filterChanged",m=>{if(m===Ft){gr();const f=u.state.timbres[Ft],v=f==null?void 0:f.filter;v&&v.enabled!==!1&&(v.mix||0)>0?Ar(f.coeffs,v):new Float32Array(f.coeffs)}}),new ResizeObserver(c).observe(Is),c(),S.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}S.moduleLoaded("SynthEngine");const vr=8,om=1/Math.sqrt(vr),Ub=200,Yb=50;let tn={},Bn,Vi,Dc,ya,Oc,ss={},Qi=0,tr=vr;function Zb(){if(!Bn)return;const n=U.now();if(Qi===0){tr=.01*vr+(1-.01)*tr;return}const e=1-Math.exp(-.016/(Ub/1e3)),s=Math.max(1,Math.min(vr,Qi));tr=e*s+(1-e)*tr;const i=Math.sqrt(vr/tr),r=om*i;Bn.gain.rampTo(r,Yb/1e3,n)}class Qb extends U.Synth{constructor(e){super(e),this.presetGain=new U.Gain(e.gain||1),this.vibratoLFO=new U.LFO(0,0),this.vibratoDepth=new U.Scale(-1,1),this.vibratoGain=new U.Gain(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new U.LFO(0,0),this.tremoloDepth=new U.Scale(0,1),this.tremoloGain=new U.Gain(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new U.Filter({type:"highpass"}),this.lpFilterForBP=new U.Filter({type:"lowpass"}),this.lpFilterSolo=new U.Filter({type:"lowpass"}),this.hpOutput=new U.Gain,this.bpOutput=new U.Gain,this.lpOutput=new U.Gain,this.hp_bp_fade=new U.CrossFade(0),this.main_fade=new U.CrossFade(0),this.wetDryFade=new U.CrossFade(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),e.filter&&this._setFilter(e.filter),e.vibrato?this._setVibrato(e.vibrato):this._setVibrato({speed:0,span:0}),e.tremelo?this._setTremolo(e.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(e){this.presetGain&&(this.presetGain.gain.value=e)}_setVibrato(e,s=U.now()){if(this.vibratoLFO&&this.vibratoGain){const i=e.speed/100*16;if(e.speed===0||e.span===0){this.vibratoLFO.stop(s),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(s),this.vibratoLFO.frequency.value=i;const a=e.span/100*50,c=a/1200,f=440*(Math.pow(2,c)-1);this.vibratoGain.gain.value=f,S.debug("SynthEngine","Audio vibrato gain set",{hzDeviation:f,centsAmplitude:a},"audio")}}_setTremolo(e,s=U.now()){if(this.tremoloLFO&&this.tremoloGain){const i=e.speed/100*16;if(e.speed===0||e.span===0){this.tremoloLFO.stop(s),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(s),this.tremoloGain.gain.value=1;return}this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(s),this.tremoloLFO.frequency.value=i;const r=e.span/100,a=Math.max(0,1-r),c=1;this.tremoloDepth.min=a,this.tremoloDepth.max=c}}_setFilter(e){this.wetDryFade.fade.value=e.enabled?1:0;const s=U.Midi(e.cutoff+35).toFrequency(),i=e.resonance/100*12+.1;this.hpFilter.set({frequency:s,Q:i}),this.lpFilterForBP.set({frequency:s,Q:i}),this.lpFilterSolo.set({frequency:s,Q:i});const r=e.blend;r<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=r):(this.main_fade.fade.value=r-1,this.hp_bp_fade.fade.value=1)}}const Gt={init(){Bn=new U.Gain(om),Vi=new U.Volume(0),Dc=new U.Compressor({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),ya=new U.Limiter(-3),Oc=new U.Meter,Bn.connect(Vi),Vi.connect(Dc),Dc.connect(ya),ya.toDestination(),ya.connect(Oc),setInterval(()=>{Oc.getValue()},500);for(const e in u.state.timbres){const s=u.state.timbres[e],i=qa(e),r=i.reduce((f,v)=>f+Math.abs(v),0),a=r>1?i.map(f=>f/r):i,c=s.gain||1,h=new U.PolySynth({polyphony:8,voice:Qb,options:{oscillator:{type:"custom",partials:Array.from(a)},envelope:s.adsr,filter:s.filter,vibrato:s.vibrato,tremelo:s.tremelo,gain:c}}).connect(Bn);window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(h,e,Bn);const m=h.triggerAttack;h.triggerAttack=function(...f){const v=m.apply(this,f);return setTimeout(()=>{const y=this._activeVoices;window.audioEffectsManager?y&&y.size>0?y.forEach((w,x)=>{w.effectsApplied||(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,x)=>{w&&!w.effectsApplied&&(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):y&&y.size>0?y.forEach((w,x)=>{w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,x)=>{w&&w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w&&w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)})},10),v},h._currentVibrato=s.vibrato,h._currentTremolo=s.tremelo,h._currentFilter=s.filter,tn[e]=h,S.debug("SynthEngine",`Created filtered synth for color: ${e}`,null,"audio")}u.on("timbreChanged",e=>{this.updateSynthForColor(e)}),u.on("filterChanged",e=>{this.updateSynthForColor(e)}),u.on("audioEffectChanged",({effectType:e,parameter:s,value:i,color:r,effectParams:a})=>{this.updateSynthForColor(r)}),u.on("volumeChanged",e=>this.setVolume(e)),setInterval(()=>{Zb()},16),S.info("SynthEngine","Initialized with multi-timbral support",null,"audio"),window.synthEngine=this},updateSynthForColor(n){const e=u.state.timbres[n],s=tn[n];if(!s||!e)return;e.vibrato||(e.vibrato={speed:0,span:0},S.debug("SynthEngine",`Initialized vibrato for color ${n}`,e.vibrato,"audio")),e.tremelo||(e.tremelo={speed:0,span:0},S.debug("SynthEngine",`Initialized tremolo for color ${n}`,e.tremelo,"audio")),S.debug("SynthEngine",`Updating timbre for color ${n}`,null,"audio");const i=qa(n),r=i.reduce((h,m)=>h+Math.abs(m),0),a=r>1?i.map(h=>h/r):i;s.set({oscillator:{partials:Array.from(a)},envelope:e.adsr}),window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(s,n,Bn),s._currentVibrato=e.vibrato,s._currentTremolo=e.tremelo,s._currentFilter=e.filter;const c=s._activeVoices;c&&c.size>0?c.forEach((h,m)=>{if(h._setFilter&&h._setFilter(e.filter),h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}}):s._voices&&Array.isArray(s._voices)&&s._voices.forEach((h,m)=>{if(h&&h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h&&h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h&&h._setFilter&&h._setFilter(e.filter),h&&h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}})},setVolume(n){Vi&&(Vi.volume.value=n)},async playNote(n,e,s=U.now()){var c;await(window.initAudio||(()=>U.start()))();const r=(c=u.state.selectedNote)==null?void 0:c.color,a=r?tn[r]:null;a&&a.triggerAttackRelease(n,e,s)},triggerAttack(n,e,s=U.now(),i=!1){const r=tn[e];if(r)if(Qi++,i&&window.getDrumVolume){const a=window.getDrumVolume(),c=r.volume.value,h=c+20*Math.log10(a);r.volume.value=h,r.triggerAttack(n,s),setTimeout(()=>{r&&r.volume&&(r.volume.value=c)},100)}else r.triggerAttack(n,s)},triggerRelease(n,e,s=U.now()){const i=tn[e];i&&(i.triggerRelease(n,s),Qi=Math.max(0,Qi-1))},releaseAll(){for(const n in tn)tn[n].releaseAll();Qi=0},createWaveformAnalyzer(n){const e=tn[n];return e?(ss[n]||(ss[n]=new U.Analyser("waveform",1024),e.connect(ss[n]),S.debug("SynthEngine",`Created waveform analyzer for color: ${n}`,null,"waveform")),ss[n]):(S.warn("SynthEngine",`No synth found for color: ${n}`,null,"audio"),null)},getWaveformAnalyzer(n){return ss[n]||null},getAllWaveformAnalyzers(){const n=new Map;for(const e in ss)ss[e]&&n.set(e,ss[e]);return n},removeWaveformAnalyzer(n){ss[n]&&(ss[n].dispose(),delete ss[n],S.debug("SynthEngine",`Removed waveform analyzer for color: ${n}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const n in ss)ss[n]&&ss[n].dispose();ss={},S.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(n){return tn[n]||null},getAllSynths(){return{...tn}},getMainVolumeNode(){return Vi||null},getMasterGainNode(){return Bn||null}};S.moduleLoaded("StampScheduler","stamps");const Vd=["0","16n","8n",{"8n":1,"16n":1}];function rm(n,e=null){const s=Xa(n);if(!s)return S.warn("StampScheduler",`Unknown stamp ID: ${n}`,{stampId:n},"stamps"),[];const i=[];return s.ovals.forEach(r=>{var h;const a=`oval_${r}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[a])||0;i.push({offset:Vd[r],duration:"8n",type:"oval",slot:r,shapeKey:a,rowOffset:c})}),s.diamonds.forEach(r=>{var h;const a=`diamond_${r}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[a])||0;i.push({offset:Vd[r],duration:"16n",type:"diamond",slot:r,shapeKey:a,rowOffset:c})}),i}S.moduleLoaded("TripletScheduler","triplets");function am(n,e=null){const s=Rr(n);if(!s)return S.warn("TripletScheduler",`Unknown triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),[];const i=[],r=s.span==="eighth"?"8t":"4t",a=r;return s.hits.forEach(c=>{var v;const h=`triplet_${c}`,m=((v=e==null?void 0:e.shapeOffsets)==null?void 0:v[h])||0;let f;if(c===0)f="0";else if(c===1)f=r;else if(c===2){const y=U.Time(r).toSeconds();f=U.Time(y*2).toNotation()}else{const y=U.Time(r).toSeconds();f=U.Time(y*c).toNotation()}i.push({offset:f,duration:a,type:s.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:c,shapeKey:h,rowOffset:m}),S.debug("TripletScheduler",`Triplet stamp ${n} ${s.span} at slot ${c} with offset "${f}", rowOffset: ${m}`,"triplets")}),S.debug("TripletScheduler",`Total events for triplet stamp ${n}:`,i.length,"triplets"),i}S.moduleLoaded("RhythmPlaybackService");class Jb{constructor(){this.scheduledEvents=[],this.isInitialized=!1}async initialize(){this.isInitialized||(await U.start(),this.isInitialized=!0,S.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(e,s,i,r="oval",a=null){if(!this.isInitialized){S.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const c=rm(e,a);if(!c||c.length===0){S.warn("RhythmPlaybackService",`No events found for stamp ${e}`);return}S.debug("RhythmPlaybackService",`Playing pattern for stamp ${e}: ${c.length} notes`,{stampId:e,basePitch:s,color:i,events:c,hasShapeOffsets:!!(a!=null&&a.shapeOffsets)});const h=U.now(),m=a==null?void 0:a.row;c.forEach((f,v)=>{try{const y=U.Time(f.offset).toSeconds(),w=h+y;let x=U.Time(f.duration).toSeconds();const A=r==="circle"?x*2:x,E=w+A;let M=s;if(m!==void 0&&f.rowOffset!==0){const I=m+f.rowOffset,R=u.state.fullRowData[I];R&&(M=R.toneNote.replace("","b").replace("","#"))}Gt.triggerAttack(M,i,w),Gt.triggerRelease(M,i,E),this.scheduledEvents.push({pitch:M,color:i,attackTime:w,releaseTime:E})}catch(y){S.warn("RhythmPlaybackService",`Error scheduling note ${v+1}`,y)}}),S.info("RhythmPlaybackService",`Scheduled ${c.length} notes for rhythm pattern ${e}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(S.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),Gt.releaseAll(),this.scheduledEvents=[])}getStampAtPosition(e,s){return u.state.stampPlacements&&u.state.stampPlacements.find(r=>{const a=r.row===s,c=e>=r.startColumn&&e<=r.endColumn;return a&&c})||null}playTripletPattern(e,s,i,r=null){if(!this.isInitialized){S.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const a=am(e,r);if(!a||a.length===0){S.warn("RhythmPlaybackService",`No events found for triplet ${e}`);return}S.debug("RhythmPlaybackService",`Playing triplet pattern ${e}: ${a.length} notes`,{tripletStampId:e,basePitch:s,color:i,events:a,hasShapeOffsets:!!(r!=null&&r.shapeOffsets)});const c=U.now(),h=r==null?void 0:r.row;a.forEach((m,f)=>{try{const v=U.Time(m.offset).toSeconds(),y=c+v,w=U.Time(m.duration).toSeconds(),x=y+w;let A=s;if(h!==void 0&&m.rowOffset!==0){const E=h+m.rowOffset,M=u.state.fullRowData[E];M&&(A=M.toneNote.replace("?T-","b").replace("?T_","#"))}Gt.triggerAttack(A,i,y),Gt.triggerRelease(A,i,x),this.scheduledEvents.push({pitch:A,color:i,attackTime:y,releaseTime:x})}catch(v){S.warn("RhythmPlaybackService",`Error scheduling triplet note ${f+1}`,v)}}),S.info("RhythmPlaybackService",`Scheduled ${a.length} notes for triplet pattern ${e}`)}getTripletAtPosition(e,s){return u.state.tripletPlacements&&u.state.tripletPlacements.find(i=>i.row===s&&e>=i.startCellIndex&&e<i.startCellIndex+i.span)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,S.info("RhythmPlaybackService","Disposed")}}const en=new Jb,Ss={adsrComponent:null};class Kb{constructor(){this.elements=new Map,this.initialized=!1}init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("pitchPaintCanvas","pitch-paint-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","frequency-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(e,s){const i=document.getElementById(s);i&&this.elements.set(e,i)}get(e){return this.initialized&&this.elements.get(e)||null}getMultiple(...e){const s={};return e.forEach(i=>{s[i]=this.get(i)}),s}has(e){return this.elements.has(e)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const e=this.elements.size,s=Array.from(this.elements.values()).filter(i=>i!==null).length;return{totalCached:e,foundElements:s,missingElements:e-s}}}const ci=new Kb;let ba=!1,ji="C4",$a=null,cs=[];function tw(n){const e=u.state.fullRowData[n.row];return e?e.toneNote:"C4"}function Hd(){const n=u.state.placedNotes.slice().reverse().find(e=>!e.isDrum);ji=n?tw(n):"C4"}function Gd(n){const{activeChordIntervals:e}=u.state;return!n||!e||!e.length?[]:e.map(s=>{const i=cr(n,s);return hr(i)})}function ew(){Hd(),u.on("notesChanged",Hd),document.addEventListener("keydown",n=>{var h,m;if(n.code!=="Space"||ba)return;const e=document.activeElement,s=e.tagName.toLowerCase(),i=e.contentEditable==="true";if(["input","textarea"].includes(s)||i)return;n.preventDefault(),ba=!0;const r=(h=u.state.selectedNote)==null?void 0:h.color;let a,c=[];if($a&&r){const f=u.state.fullRowData[$a.row];a=f?f.toneNote:ji,u.state.selectedTool==="chord"?c=Gd(a):c=[a]}else r&&ji&&(a=ji,u.state.selectedTool==="chord"?c=Gd(ji):c=[ji]);if(c.length>0){cs={pitches:[...c],rootNote:a,color:r},c.forEach(x=>{Gt.triggerAttack(x,r)});const f=u.state.fullRowData.find(x=>x.toneNote===a),v=f?f.hex:"#888888",y=u.state.timbres[r].adsr;(m=Ss.adsrComponent)==null||m.playheadManager.trigger("spacebar","attack",v,y),u.emit("spacebarPlayback",{note:a,color:r,isPlaying:!0});const w=`spacebar-${Date.now()}`;u.emit("noteAttack",{noteId:w,color:r}),cs.noteId=w}}),document.addEventListener("keyup",n=>{var e;if(!(n.code!=="Space"||!ba)&&(n.preventDefault(),ba=!1,cs.pitches&&cs.pitches.length>0)){cs.pitches.forEach(a=>{Gt.triggerRelease(a,cs.color)});const s=u.state.fullRowData.find(a=>a.toneNote===cs.rootNote),i=s?s.hex:"#888888",r=u.state.timbres[cs.color].adsr;(e=Ss.adsrComponent)==null||e.playheadManager.trigger("spacebar","release",i,r),u.emit("spacebarPlayback",{note:cs.rootNote,color:cs.color,isPlaying:!1}),cs.noteId&&u.emit("noteRelease",{noteId:cs.noteId,color:cs.color}),cs=[]}})}function sw(n,e){var i;$a={col:n,row:e};const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&u.emit("ghostNoteUpdated",{color:s})}function lm(){$a=null,u.emit("ghostNoteCleared")}S.moduleLoaded("StampPlacements","stamps");function nw(n,e,s,i="#4a90e2"){return Xa(n)?u.addStampPlacement(n,e,s,i):(S.warn("StampPlacements",`Invalid stamp ID: ${n}`,{stampId:n},"stamps"),null)}function iw(n,e,s,i){return u.eraseStampsInArea(n,e,s,i)}function ow(){u.clearAllStamps()}function cm(){return u.getStampPlaybackData()}S.moduleLoaded("TripletPlacements","triplets");function rw(n,e,s,i="#4a90e2"){const r=Rr(n);if(!r)return S.warn("TripletPlacements",`Invalid triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),null;const a=V0[r.span];if(!aw(e,a,s))return S.debug("TripletPlacements",`Cannot place triplet at cell ${e}, row ${s} - collision detected`,{tripletStampId:n,startCellIndex:e,row:s,span:a},"triplets"),null;const c={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,stampId:n,startCellIndex:e,span:a,row:s,color:i,timestamp:Date.now()};return u.addTripletPlacement(c)}function aw(n,e,s){const i=u.state;if(i.stampPlacements){for(const r of i.stampPlacements)if(r.row===s){const a=Math.floor(r.startColumn/2),c=Math.floor(r.endColumn/2);for(let h=0;h<e;h++){const m=n+h;if(m>=a&&m<=c)return!1}}}if(i.tripletPlacements){for(const r of i.tripletPlacements)if(r.row===s){const a=r.startCellIndex+r.span-1;if(!(n+e-1<r.startCellIndex||n>a))return!1}}return!0}function lw(n,e,s,i){const r=u.state;if(!r.tripletPlacements)return!1;const a=Math.floor(n/2),c=Math.floor(e/2),h=[];for(const m of r.tripletPlacements)m.row>=s&&m.row<=i&&(m.startCellIndex+m.span-1<a||m.startCellIndex>c||h.push(m.id));return h.length>0?(h.forEach(m=>u.removeTripletPlacement(m)),S.debug("TripletPlacements",`Erased ${h.length} triplet groups`,{removedIds:h,eraseArea:{eraseStartCell:a,eraseEndCell:c,eraseStartRow:s,eraseEndRow:i}},"triplets"),!0):!1}function hm(){const n=u.state;return n.tripletPlacements?n.tripletPlacements.map(e=>({startCellIndex:e.startCellIndex,stampId:e.stampId,row:e.row,color:e.color,span:e.span,placement:e})):[]}function cw(){u.clearAllTripletPlacements(),S.info("TripletPlacements","Cleared all triplet placements",null,"triplets")}S.moduleLoaded("StampsToolbar","stamps");const $h={selectedStampId:1,init(){this.render(),this.bindEvents(),S.info("StampsToolbar","Stamps toolbar initialized",null,"stamps")},render(){const n=document.getElementById("stamps-toolbar-container");if(!n){S.warn("StampsToolbar","Container not found",null,"stamps");return}n.innerHTML="";const e=document.createElement("div");e.className="stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((i,r)=>{const a=document.createElement("div");a.className=`stamps-row stamps-row-${r+1}`,i.forEach(c=>{const h=sh.find(m=>m.id===c);if(h){const m=this.createStampButton(h,c-1);a.appendChild(m)}}),e.appendChild(a)}),n.appendChild(e),this.setInitialSelection(this.selectedStampId)},createStampButton(n,e){const s=document.createElement("button");s.className="stamp-button",s.setAttribute("data-stamp-id",n.id),s.setAttribute("title",`${n.id}: ${n.label}`);const i=this.createStampPreview(n);return s.appendChild(i),s},createStampPreview(n){const e=Fh.renderToSVG(n,100,100);return e.setAttribute("width","40"),e.setAttribute("height","40"),e},bindEvents(){const n=document.getElementById("stamps-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const i=s.target.closest(".stamp-button");if(i){const r=parseInt(i.getAttribute("data-stamp-id"));this.selectStamp(r)}}),this.updateStampColors=s=>{if(!s||!n)return;const i=(f,v=50)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(y+(255-y)*(v/100))),E=Math.min(255,Math.floor(w+(255-w)*(v/100))),M=Math.min(255,Math.floor(x+(255-x)*(v/100)));return`#${A.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},r=(f,v=20)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(y*(1-v/100))),E=Math.max(0,Math.floor(w*(1-v/100))),M=Math.max(0,Math.floor(x*(1-v/100)));return`#${A.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},a=u.state.colorPalette[s]||{primary:s,light:s},c=i(a.light,60),h=a.primary,m=r(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),S.info("StampsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"stamps")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateStampColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateStampColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="stamp"&&this.clearSelection()}),u.on("tripletToolSelected",()=>{this.clearSelection()})},setInitialSelection(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),S.info("StampsToolbar",`Initial stamp selection set to ${n} (no tool change during init)`,{stampId:n},"stamps")},selectStamp(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),S.debug("StampsToolbar","Selecting stamp tool via proper action",null,"stamps"),u.setSelectedTool("stamp"),u.emit("stampSelected",n),u.emit("stampToolSelected"),S.info("StampsToolbar",`Selected stamp ${n} and switched to stamp tool`,{stampId:n},"stamps")},clearSelection(){this.selectedStampId=null;const n=document.getElementById("stamps-toolbar-container");n&&n.querySelectorAll(".stamp-button").forEach(e=>{e.classList.remove("active")})},getSelectedStamp(){return sh.find(n=>n.id===this.selectedStampId)}};S.moduleLoaded("TripletsToolbar","triplets");const Ya={selectedTripletStampId:null,init(){this.render(),this.bindEvents(),S.info("TripletsToolbar","Triplets toolbar initialized",null,"triplets")},render(){const n=document.getElementById("triplets-toolbar-container");if(!n){S.warn("TripletsToolbar","Container not found",null,"triplets");return}n.innerHTML="";const e=document.createElement("div");e.className="triplets-main-container";const s=document.createElement("div");s.className="triplets-sections";const i=this.createSection("Eighth Triplets",nh.slice(0,7));s.appendChild(i);const r=this.createQuarterTripletsSection(nh.slice(7,14));s.appendChild(r),e.appendChild(s),n.appendChild(e)},createSection(n,e){const s=document.createElement("div");s.className="triplets-section";const i=document.createElement("div");return i.className="triplets-grid",e.forEach(r=>{const a=this.createTripletButton(r);i.appendChild(a)}),s.appendChild(i),s},createQuarterTripletsSection(n){const e=document.createElement("div");e.className="triplets-section";const s=document.createElement("div");s.className="triplets-grid triplets-quarter-row",[n[0],n[1],n[2]].forEach(r=>{const a=this.createTripletButton(r);s.appendChild(a)});const i=document.createElement("div");return i.className="triplets-grid triplets-quarter-row",[n[3],n[4],n[5],n[6]].forEach(r=>{const a=this.createTripletButton(r);i.appendChild(a)}),e.appendChild(s),e.appendChild(i),e},createTripletButton(n){const e=document.createElement("button");e.className="triplet-button",e.setAttribute("data-triplet-stamp-id",n.id),e.setAttribute("title",n.label),n.span==="quarter"&&e.classList.add("triplet-button-wide");const i=n.span==="quarter"?80:40,r=G0(n,i,40);return e.appendChild(r),e},bindEvents(){const n=document.getElementById("triplets-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const i=s.target.closest(".triplet-button");if(i){const r=parseInt(i.getAttribute("data-triplet-stamp-id"));this.selectTripletStamp(r)}}),this.updateTripletColors=s=>{if(!s||!n)return;const i=(f,v=50)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(y+(255-y)*(v/100))),E=Math.min(255,Math.floor(w+(255-w)*(v/100))),M=Math.min(255,Math.floor(x+(255-x)*(v/100)));return`#${A.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},r=(f,v=20)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(y*(1-v/100))),E=Math.max(0,Math.floor(w*(1-v/100))),M=Math.max(0,Math.floor(x*(1-v/100)));return`#${A.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},a=u.state.colorPalette[s]||{primary:s,light:s},c=i(a.light,60),h=a.primary,m=r(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),S.info("TripletsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"triplets")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateTripletColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateTripletColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="triplet"&&this.clearSelection()}),u.on("stampToolSelected",()=>{this.clearSelection()})},selectTripletStamp(n){this.selectedTripletStampId=n;const e=document.getElementById("triplets-toolbar-container");e&&e.querySelectorAll(".triplet-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-triplet-stamp-id"))===n)}),u.setSelectedTool("triplet"),u.emit("tripletStampSelected",n),u.emit("tripletToolSelected"),S.info("TripletsToolbar",`Selected triplet stamp ${n} and switched to triplet tool`,{stampId:n},"triplets")},clearSelection(){this.selectedTripletStampId=null;const n=document.getElementById("triplets-toolbar-container");n&&n.querySelectorAll(".triplet-button").forEach(e=>{e.classList.remove("active")})},getSelectedTripletStamp(){return this.selectedTripletStampId?Rr(this.selectedTripletStampId):null}};function hw(n,e,s,i){var f,v;const r=Xa(s.stampId);if(!r)return null;const a=ft(s.startColumn,i);Rt(s.row,i)-i.cellHeight/2;const c=i.cellWidth*2,h=i.cellHeight,m=[.125,.375,.625,.875].map(y=>a+y*c);for(const y of r.diamonds){const w=`diamond_${y}`,x=((f=s.shapeOffsets)==null?void 0:f[w])||0,A=s.row+x,E=Rt(A,i),M=m[y],I=Math.sqrt(Math.pow(n-M,2)+Math.pow(e-E,2)),R=Math.min(c*.2,h*1);if(I<R)return{type:"diamond",slot:y,shapeKey:w,cx:M,cy:E,placement:s}}for(const y of r.ovals){const w=`oval_${y}`,x=((v=s.shapeOffsets)==null?void 0:v[w])||0,A=s.row+x,E=Rt(A,i),M=y===0?a+.25*c:a+.75*c,I=Math.sqrt(Math.pow(n-M,2)+Math.pow(e-E,2)),R=Math.min(c*.25,h*1);if(I<R)return{type:"oval",slot:y,shapeKey:w,cx:M,cy:E,placement:s}}return null}function um(n,e,s,i){for(const r of s){const a=hw(n,e,r,i);if(a)return a}return null}function uw(n,e,s,i){var f;const r=Rr(s.stampId);if(!r)return null;const a=s.startCellIndex*2,c=ft(a,i);Rt(s.row,i)-i.cellHeight/2;const h=i.cellWidth*2*s.span,m=i.cellHeight;for(const v of r.hits){const y=`triplet_${v}`,w=((f=s.shapeOffsets)==null?void 0:f[y])||0,x=s.row+w,A=Rt(x,i),E=Qp[v],M=c+h*E/100,I=Math.sqrt(Math.pow(n-M,2)+Math.pow(e-A,2)),R=Math.min(h*.15,m*1);if(I<R)return{type:"triplet",slot:v,shapeKey:y,cx:M,cy:A,placement:s}}return null}function dm(n,e,s,i){for(const r of s){const a=uw(n,e,r,i);if(a)return a}return null}let Xt,no=!1,oe=null,Vs=[],Ye=[],Mr=!1,za=!1,Ia=null,zn=null,ri=[],xs=!1,$n=null,ns=null,Er=!1,_s=null,Pr=!1;function je(n){const e=u.state.fullRowData[n];return e?e.toneNote:null}function dw(n){const{macrobeatGroupings:e,columnWidths:s,macrobeatBoundaryStyles:i}=u.state;if(n<2||n>=s.length-2)return null;let r=-1;for(let m=0;m<e.length;m++){const{startColumn:f,endColumn:v}=us(u.state,m);if(n>=f&&n<=v){r=m;break}}if(r===-1)return null;let a=0;for(let m=r-1;m>=0;m--)if(i[m]==="solid"){a=m+1;break}const c=a-1;return{drawColumn:us(u.state,a).startColumn,preMacrobeatIndex:c}}function pm(n,e){const{activeChordIntervals:s,isIntervalsInverted:i,chordPositionState:r}=u.state;if(!n||!s||s.length===0)return[];if(i&&s.length===2&&s[0]==="1P"){const h="-"+s[1],m=cr(n,h),f=hr(m),v=f.includes("#")&&wn(f).includes("b")?wn(f):f;return[n,v]}const a=s.map(c=>{const h=cr(n,c),m=hr(h);if(m.includes("#")){const f=wn(m);if(f.includes("b"))return f}return m});if(s.length>=3&&r>0){const c=[...a];for(let x=0;x<r;x++){const A=c.shift(),E=cr(A,"8P");c.push(hr(E))}const h=c[0],m=n,f=nn(h),v=nn(m);let y=0,w=f;for(;w>v;)w-=12,y-=12;for(;w+12<=v;)w+=12,y+=12;return c.map(x=>{const A=nn(x)+y;return qy(A)})}return a}function Ra(n,e,s){if(!Xt)return;const i={...u.state,zoomLevel:St.getViewportInfo().zoomLevel},r=ft(n,i),c=Rt(e,u.state)-u.state.cellHeight/2,h=u.state.selectedTool;let m;if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+1,i)-r:m=u.state.columnWidths[n]*u.state.cellWidth,h==="eraser"||Mr)u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2;else if(h==="note"&&u.state.selectedNote&&u.state.selectedNote.shape==="circle")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2;else if(h==="stamp")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2;else if(h==="triplet"){const f=Ya.getSelectedTripletStamp();if(f){const y=2*(f.span==="eighth"?1:2);u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+y,i)-r:m=u.state.cellWidth*y}else m=u.state.cellWidth*2}else h==="tonicization"&&(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2);Xt.fillStyle=s,Xt.fillRect(r,c,m,u.state.cellHeight)}function pw(n,e,s=!1){if(!Xt||!u.state.selectedNote)return;const i=u.state.selectedTool,{shape:r,color:a}=u.state.selectedNote;if(Xt.globalAlpha=s?.2:.4,i==="tonicization"){const c={row:e,columnIndex:n,tonicNumber:u.state.selectedToolTonicNumber},h={...u.state,zoomLevel:St.getViewportInfo().zoomLevel};Lh(Xt,h,c)}else if(i==="note"){const c={row:e,startColumnIndex:n,endColumnIndex:n,color:a,shape:r,isDrum:!1},h={...u.state,zoomLevel:St.getViewportInfo().zoomLevel};r==="oval"?Nh(Xt,h,c,e):Oh(Xt,h,c,e)}Xt.globalAlpha=1}function mw(n){var f,v,y,w,x,A,E;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=document.getElementById("canvas-container").scrollLeft,a=Hs.getColumnIndex(s+r),c=Hs.getPitchRowIndex(i),m=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(!(a<2||a>=m||!je(c))){if(n.button===2){n.preventDefault(),Mr=!0,xs=!1,u.state.selectedTool!=="eraser"&&(Ia=u.state.selectedTool,u.setSelectedTool("eraser")),(f=ci.get("eraserButton"))==null||f.classList.add("erasing-active"),u.eraseInPitchArea(a,c,2,!1)&&(xs=!0),u.eraseTonicSignAt(a,!1)&&(xs=!0);const M=a+2-1,I=c-1,R=c+1;u.eraseStampsInArea(a,M,I,R)&&(xs=!0),u.eraseTripletsInArea(a,M,I,R)&&(xs=!0);const D=n.target.getBoundingClientRect(),G=n.clientX-D.left,X=n.clientY-D.top;Ut.eraseAtPoint(G,X)&&(xs=!0),Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),Ra(a,c,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const M=s+r;({...u.state});for(const D of u.state.modulationMarkers||[]);const I=u.state.placedNotes.find(D=>!D.isDrum&&D.row===c&&a>=D.startColumnIndex&&a<=D.endColumnIndex);if(I&&u.state.selectedTool==="note"){const D=en.getStampAtPosition(a,c),G=je(c);if(D&&G){const X=window.staticWaveformVisualizer;X&&(X.currentColor=I.color,X.generateWaveform(),X.startSingleNoteVisualization(I.color)),en.playRhythmPattern(D.stampId,G,I.color,I.shape,D),Ye=[G],oe=I}else if(G){const X=window.staticWaveformVisualizer;X&&(X.currentColor=I.color,X.generateWaveform(),X.startSingleNoteVisualization(I.color)),Gt.triggerAttack(G,I.color);const F=((v=u.state.fullRowData[c])==null?void 0:v.hex)||"#888888";(y=Ss.adsrComponent)==null||y.playheadManager.trigger(I.uuid,"attack",F,u.state.timbres[I.color].adsr),Ye=[G],oe=I}return}const R=u.state.selectedTool;if(R==="chord"){if(!th(a,u.state))return;const D=je(c);if(!D)return;const G=pm(D),{shape:X,color:F}=u.state.selectedNote;Ye=[...G],Ye.forEach(Q=>{Gt.triggerAttack(Q,F)});const H=((w=u.state.fullRowData[c])==null?void 0:w.hex)||"#888888";(x=Ss.adsrComponent)==null||x.playheadManager.trigger("chord_preview","attack",H,u.state.timbres[F].adsr),Vs=[],G.forEach(Q=>{const K=u.state.fullRowData.findIndex(pt=>pt.toneNote===Q);if(K!==-1){const pt={row:K,startColumnIndex:a,endColumnIndex:a,color:F,shape:X,isDrum:!1},ut=u.addNote(pt);ut&&(Vs.push(ut),ut.uuid&&u.emit("noteInteractionStart",{noteId:ut.uuid,color:ut.color}))}}),no=!0,$n=c;return}if(R==="tonicization"){if(zn&&ri.length>0){const D=ri.map(G=>({row:G,tonicNumber:u.state.selectedToolTonicNumber,preMacrobeatIndex:zn.preMacrobeatIndex,columnIndex:zn.drawColumn}));u.addTonicSignGroup(D),zn=null,ri=[]}return}if(R==="eraser"){za=!0,u.eraseInPitchArea(a,c,2,!1);const D=a+2-1,G=c-1,X=c+1;iw(a,D,G,X),lw(a,D,G,X);return}if(R==="stamp"){const D=u.getAllStampPlacements(),G=s+r,X={...u.state},F=um(G,i,D,X);if(F){console.log("[STAMP INTERACTION]  Hit detected, starting shape drag:",F),ns={...F,startRow:u.getShapeRow(F.placement,F.shapeKey),startMouseY:i},Er=!0,console.log("[STAMP INTERACTION] Drag state initialized:",{shapeKey:ns.shapeKey,startRow:ns.startRow,placementId:ns.placement.id});return}const H=en.getStampAtPosition(a,c);if(H){console.log("[STAMP INTERACTION] Clicked existing stamp, replaying pattern:",H.stampId);const K=je(c);if(K){const pt=u.state.placedNotes.find(_t=>!_t.isDrum&&_t.row===c&&a>=_t.startColumnIndex&&a<=_t.endColumnIndex),ut=pt?pt.shape:"oval";en.playRhythmPattern(H.stampId,K,H.color,ut,H),Ye=[K]}return}const Q=$h.getSelectedStamp();if(Q){console.log("[STAMP INTERACTION] Placing new stamp:",{stampId:Q.id,colIndex:a,rowIndex:c});const{color:K,shape:pt}=u.state.selectedNote;nw(Q.id,a,c,K);const ut=je(c);ut&&(en.playRhythmPattern(Q.id,ut,K,pt),Ye=[ut]),u.recordState()}return}if(R==="triplet"){const D=u.getAllTripletPlacements(),G=s+r,X={...u.state};console.log("[TRIPLET INTERACTION] Checking for shape hit at:",{actualX:G,y:i,numTriplets:D.length});const F=dm(G,i,D,X);if(F){console.log("[TRIPLET INTERACTION]  Hit detected, starting shape drag:",F),_s={...F,startRow:u.getTripletShapeRow(F.placement,F.shapeKey),startMouseY:i},Pr=!0;return}const H=Math.floor(a/2),Q=en.getTripletAtPosition(H,c);if(Q){console.log("[TRIPLET INTERACTION] Clicked existing triplet, replaying pattern:",Q.stampId);const pt=je(c);pt&&(en.playTripletPattern(Q.stampId,pt,Q.color,Q),Ye=[pt]);return}const K=Ya.getSelectedTripletStamp();if(K&&u.state.selectedNote){console.log("[TRIPLET INTERACTION] Placing new triplet:",{stampId:K.id,colIndex:a,rowIndex:c});const pt=rw(K.id,H,c,u.state.selectedNote.color),ut=je(c);ut&&pt&&(en.playTripletPattern(K.id,ut,u.state.selectedNote.color,pt),Ye=[ut]),u.recordState()}return}if(R==="modulation"){const D=u.state.selectedModulationRatio;if(!D){console.warn("[MODULATION] No ratio selected - click 2:3 or 3:2 button first");return}const G=fm(M);if(!G){console.warn("[MODULATION] Click must be near a measure boundary");return}console.log("[MODULATION] Placing marker at measure boundary:",{measureIndex:G.measureIndex,ratio:D,clickX:M,boundaryX:G.xPosition});const X=u.addModulationMarker(G.measureIndex,D,G.xPosition,null,G.macrobeatIndex);console.log("[MODULATION] Marker placed successfully:",{markerId:X,measureIndex:G.measureIndex,ratio:D});return}if(R==="note"){if(!th(a,u.state)||!u.state.selectedNote)return;const{shape:D,color:G}=u.state.selectedNote,X={row:c,startColumnIndex:a,endColumnIndex:a,color:G,shape:D,isDrum:!1},F=u.addNote(X);if(!F)return;oe=F,F.uuid&&u.emit("noteInteractionStart",{noteId:F.uuid,color:F.color}),no=D==="circle",$n=c,no||u.recordState();const H=je(c);if(H){Ye=[H],Gt.triggerAttack(H,oe.color);const Q=((A=u.state.fullRowData[c])==null?void 0:A.hex)||"#888888";(E=Ss.adsrComponent)==null||E.playheadManager.trigger(oe.uuid,"attack",Q,u.state.timbres[oe.color].adsr);const K=window.staticWaveformVisualizer;K&&(K.currentColor=oe.color,K.generateWaveform(),K.startSingleNoteVisualization(oe.color))}}}}}function fw(n){var y,w,x,A;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=document.getElementById("canvas-container").scrollLeft,a=Hs.getColumnIndex(s+r),c=Hs.getPitchRowIndex(i);if(!Xt)return;if(Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),Er&&ns){const E=Hs.getPitchRowIndex(i),M=E-ns.placement.row;if(console.log("[STAMP DRAG] Mouse moved, updating shape position:",{mouseY:i,newRow:E,baseRow:ns.placement.row,rowOffset:M,shapeKey:ns.shapeKey}),u.updateStampShapeOffset(ns.placement.id,ns.shapeKey,M),E!==ns.startRow){const I=je(E);if(I){const R=ns.placement.color||((y=u.state.selectedNote)==null?void 0:y.color);Gt.triggerAttack(I,R),setTimeout(()=>Gt.triggerRelease(I,R),100)}ns.startRow=E}n.target.style.cursor="ns-resize";return}if(Pr&&_s){const E=Hs.getPitchRowIndex(i),M=E-_s.placement.row;if(console.log("[TRIPLET DRAG] Mouse moved, updating shape position:",{mouseY:i,newRow:E,baseRow:_s.placement.row,rowOffset:M,shapeKey:_s.shapeKey}),u.updateTripletShapeOffset(_s.placement.id,_s.shapeKey,M),E!==_s.startRow){const I=je(E);if(console.log("[TRIPLET DRAG] Row changed, playing audio:",{oldRow:_s.startRow,newRow:E,pitch:I,hasPitch:!!I}),I){const R=_s.placement.color||((w=u.state.selectedNote)==null?void 0:w.color);console.log("[TRIPLET DRAG] Triggering audio for pitch:",I,"color:",R),Gt.triggerAttack(I,R),setTimeout(()=>Gt.triggerRelease(I,R),100)}_s.startRow=E}n.target.style.cursor="ns-resize";return}const h=u.state.selectedTool;if(h==="stamp"&&!Er){const E=s+r,M=u.getAllStampPlacements(),I={...u.state};um(E,i,M,I)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}if(h==="triplet"&&!Pr){const E=s+r,M=u.getAllTripletPlacements(),I={...u.state};dm(E,i,M,I)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}const m=s+r;({...u.state});for(const E of u.state.modulationMarkers||[]);if(u.state.selectedTool==="modulation"){const E=fm(m);E&&vw(Xt,E.xPosition,u.state.selectedModulationRatio)}n.target;const v=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(a<2||a>=v||je(c)===null){zn=null,ri=[],lm();return}if(sw(a,c),no&&(oe||Vs.length>0)){const E=a,M=c;if(oe){if(E!==oe.endColumnIndex&&u.updateNoteTail(oe,E),M!==$n&&M!==oe.row){const I=je(M);if(I){const R=je(oe.row);R&&Gt.triggerRelease(R,oe.color),u.updateNoteRow(oe,M),Gt.triggerAttack(I,oe.color),Ye=[I];const D=((x=u.state.fullRowData[M])==null?void 0:x.hex)||"#888888";(A=Ss.adsrComponent)==null||A.playheadManager.trigger(oe.uuid,"attack",D,u.state.timbres[oe.color].adsr),$n=M}}}else if(Vs.length>0){const I=Vs.filter(R=>E!==R.endColumnIndex);if(I.length>0&&u.updateMultipleNoteTails(I,E),M!==$n){const R=M-$n;Ye.forEach(X=>{Gt.triggerRelease(X,Vs[0].color)});const D=Vs.map(X=>X.row+R);if(D.every(X=>je(X)!==null)){u.updateMultipleNoteRows(Vs,D);const X=D.map(F=>je(F)).filter(F=>F);X.forEach(F=>{Gt.triggerAttack(F,Vs[0].color)}),Ye=X,$n=M}}}return}if(u.state.selectedTool==="chord"){const E=je(c);if(E){const M=pm(E),{shape:I,color:R}=u.state.selectedNote;Xt.globalAlpha=.4,M.forEach(D=>{const G=u.state.fullRowData.findIndex(X=>X.toneNote===D);if(G>-1){const X={row:G,startColumnIndex:a,endColumnIndex:a,color:R,shape:I,isDrum:!1},F={...u.state,zoomLevel:St.getViewportInfo().zoomLevel};I==="oval"?Nh(Xt,F,X,G):Oh(Xt,F,X,G)}}),Xt.globalAlpha=1}return}if(Mr){u.eraseInPitchArea(a,c,2,!1)&&(xs=!0),u.eraseTonicSignAt(a,!1)&&(xs=!0);const E=a+2-1,M=c-1,I=c+1;u.eraseStampsInArea(a,E,M,I)&&(xs=!0),u.eraseTripletsInArea(a,E,M,I)&&(xs=!0);const R=n.target.getBoundingClientRect(),D=n.clientX-R.left,G=n.clientY-R.top;Ut.eraseAtPoint(D,G)&&(xs=!0),Ra(a,c,"rgba(220, 53, 69, 0.3)");return}if(za){u.eraseInPitchArea(a,c,2,!1);const E=a+2-1,M=c-1,I=c+1;u.eraseStampsInArea(a,E,M,I),u.eraseTripletsInArea(a,E,M,I),Ra(a,c,"rgba(220, 53, 69, 0.3)");return}if(u.state.selectedTool==="tonicization"){const E=dw(a);if(E){const M=je(c);if(M){const I=u.state.fullRowData.map((D,G)=>({...D,index:G})).filter(D=>D.toneNote&&D.toneNote.replace(/\d+$/,"")===M.replace(/\d+$/,"")).map(D=>D.index);zn=E,ri=I,Xt.globalAlpha=.5;const R={...u.state,zoomLevel:St.getViewportInfo().zoomLevel};I.forEach(D=>{const G={row:D,columnIndex:E.drawColumn,tonicNumber:u.state.selectedToolTonicNumber};Lh(Xt,R,G)}),Xt.globalAlpha=1}}else zn=null,ri=[]}else{const E=u.state.selectedTool==="note"||u.state.selectedTool==="chord"?th(a,u.state):!0,M=u.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":E?"rgba(74, 144, 226, 0.2)":"rgba(220, 53, 69, 0.15)";if(Ra(a,c,M),u.state.selectedTool==="stamp"){const R=$h.getSelectedStamp();if(R){const D={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};W0(Xt,a,c,R,D)}}else if(u.state.selectedTool==="triplet"){const R=Ya.getSelectedTripletStamp();if(R){const D=Math.floor(a/2),G={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};Y0(Xt,D,c,R,G)}}else E&&pw(a,c)}}function mm(){Xt&&Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),zn=null,ri=[],lm()}function gw(){var n,e,s,i,r;if(Er&&ns){console.log("[STAMP DRAG] Drag ended, saving state for undo/redo"),Er=!1,ns=null,u.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(Pr&&_s){console.log("[TRIPLET DRAG] Drag ended, saving state for undo/redo"),Pr=!1,_s=null,u.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(Ye.length>0){en.stopCurrentPattern();const a=(n=u.state.selectedNote)==null?void 0:n.color;if(a&&Ye.forEach(m=>{Gt.triggerRelease(m,a)}),!!oe){const m=((e=u.state.fullRowData[oe.row])==null?void 0:e.hex)||"#888888";(s=Ss.adsrComponent)==null||s.playheadManager.trigger(oe.uuid,"release",m,u.state.timbres[a].adsr)}else{const m=Ye[0],f=u.state.fullRowData.find(v=>v.toneNote===m);if(f){const v=f.hex;(i=Ss.adsrComponent)==null||i.playheadManager.trigger("chord_preview","release",v,u.state.timbres[a].adsr)}}Ye=[];const h=window.staticWaveformVisualizer;h&&h.stopLiveVisualization()}no&&u.recordState(),no=!1,$n=null,oe&&oe.uuid&&u.emit("noteInteractionEnd",{noteId:oe.uuid}),Vs.forEach(a=>{a.uuid&&u.emit("noteInteractionEnd",{noteId:a.uuid})}),oe=null,Vs=[],za&&(u.recordState(),za=!1),Mr&&(xs&&u.recordState(),Mr=!1,xs=!1,Ia&&(u.setSelectedTool(Ia),Ia=null),(r=ci.get("eraserButton"))==null||r.classList.remove("erasing-active")),mm()}function fm(n,e){const{macrobeatGroupings:s,macrobeatBoundaryStyles:i}=u.state;rn(u.state);const r=100,a=[],c=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;console.log("[MODULATION] Boundary calculation - has modulation:",c);for(let v=0;v<i.length;v++)if(i[v]==="solid"){const y=us(u.state,v);if(y){const w=c?ft(y.endColumn+1,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):St.getColumnX(y.endColumn+1);console.log(`[MODULATION] Boundary ${v}: measureInfo.endColumn=${y.endColumn}, calculatedX=${w}, method=${c?"modulated":"base"}`),a.push({measureIndex:v+1,xPosition:w,macrobeatIndex:v})}}const h=c?ft(2,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):St.getColumnX(2);console.log("[MODULATION] Start boundary: calculatedX=",h,", method=",c?"modulated":"base"),a.unshift({measureIndex:0,xPosition:h,macrobeatIndex:-1}),console.log("[MODULATION] Available measure boundaries:",a),console.log("[MODULATION] Click position:",n,"tolerance:",r);let m=null,f=1/0;return a.forEach(v=>{const y=Math.abs(n-v.xPosition);console.log(`[MODULATION] Boundary at x=${v.xPosition}, distance=${y}`),y<=r&&y<f&&(f=y,m=v)}),m?console.log("[MODULATION] Found closest boundary:",m,"distance:",f):console.log("[MODULATION] No boundary within tolerance"),m}function vw(n,e,s){if(!s)return;const i=qp(s),r=Bp(s);n.save();const a=3,c=2,h=n.canvas.height;n.strokeStyle=i,n.lineWidth=c,n.globalAlpha=.7,n.setLineDash([]);for(let m=-1;m<=1;m++){const f=e+m*a;n.beginPath(),n.moveTo(f,0),n.lineTo(f,h),n.stroke()}n.globalAlpha=.8,n.font="12px Arial, sans-serif",n.textAlign="center",n.textBaseline="top",n.fillStyle=i,n.fillText(`Preview: ${r}`,e,10),n.restore()}function yw(){const n=document.getElementById("notation-grid"),e=document.getElementById("hover-canvas");if(!n||!e){console.error("PitchGridInteractor: Could not find required canvas elements.");return}Xt=e.getContext("2d"),n.addEventListener("mousedown",mw),n.addEventListener("mousemove",fw),n.addEventListener("mouseleave",mm),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",gw)}const hh={init(){yw(),Nb(),document.addEventListener("canvasResized",n=>{this.renderPitchGrid(),this.renderDrumGrid()}),u.on("animationUpdate",n=>{n.type==="vibrato"&&n.activeColors&&n.activeColors.length>0?this.renderPitchGrid():n.type==="envelopeFill"||n.hasEnvelopeFills?this.renderPitchGrid():n.type==="combined"&&n.vibratoColors&&n.vibratoColors.length>0&&this.renderPitchGrid()})},renderPitchGrid:ni.render,renderDrumGrid:ks.render};function Nc(n){let e=0;for(let s=0;s<n;s++){const i=u.state.columnWidths[s]||0;e+=i*u.state.cellWidth}return e}const gm="",vm="",jd=1e-4;function Lc(n){const e=u.state.fullRowData[n];return e?e.toneNote.replace(gm,"b").replace(vm,"#"):"C4"}S.moduleLoaded("TransportService");let zs,yr,Yt=[],io=0,oo=0;function br(){if(oo>io){const n=Math.abs(U.Transport.loopStart-io),e=Math.abs(U.Transport.loopEnd-oo);(n>jd||e>jd)&&(U.Transport.loopStart=io,U.Transport.loopEnd=oo),U.Transport.loop!==u.state.isLooping&&(U.Transport.loop=u.state.isLooping)}}function kr(){return 60/(u.state.tempo*2)}function bw(){if(!u.state.hasAnacrusis)return Yt[2]||0;for(let n=0;n<u.state.macrobeatBoundaryStyles.length;n++)if(u.state.macrobeatBoundaryStyles[n]==="solid"){const e=us(u.state,n+1);if(e)return Yt[e.startColumn]||0}return Yt[2]||0}function uh(){var r;S.debug("transportService","calculateTimeMap",{tempo:`${u.state.tempo} BPM`}),Yt=[];const n=kr(),{columnWidths:e,modulationMarkers:s}=u.state,i=rn(u.state);s&&s.length>0,ww(n,e,i),S.timing("transportService","calculateTimeMap",{totalDuration:`${(r=Yt[Yt.length-1])==null?void 0:r.toFixed(2)}s`})}function ww(n,e,s){let i=0;for(let r=0;r<e.length;r++)Yt[r]=i,s.some(c=>c.columnIndex===r)||(i+=e[r]*n);Yt.push(i)}function _w(n,e,s){let i=0;for(let r=0;r<n;r++){const a=e[r]||0;i+=a*s}return i}function Xd(n){const{modulationMarkers:e}=u.state;if(!e||e.length===0)return Yt[n];const s=kr(),i=u.state.baseMicrobeatPx||u.state.cellWidth||40,r=$p(e,i,u.state),a=_w(n,u.state.columnWidths,i);return d0(a,r,s)}function xw(n){const e=u.state.fullRowData;return e&&e[n.row]?e[n.row].toneNote.replace(gm,"b").replace(vm,"#"):"C4"}function Fc(){var m,f,v;S.debug("transportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),U.Transport.cancel(),uh(),(m=Ss.adsrComponent)==null||m.playheadManager.clearAll();const n=Yt[2]||0,e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;u.state.placedNotes.length,(f=u.state.lassoSelection)!=null&&f.isActive;const s=(v=u.state.lassoSelection)==null?void 0:v.isActive,i=s?new Set(u.state.lassoSelection.selectedItems.filter(y=>y.type==="note").map(y=>y.id)):null;u.state.placedNotes.forEach(y=>{var I;if(s){const R=`note-${y.row}-${y.columnIndex}-${y.color}-${y.shape}`;if(!i.has(R))return}const w=Yt[y.startColumnIndex];if(e&&Xd(y.startColumnIndex),w===void 0)return;if(w<n){S.debug("transportService",`Skipping note at column ${y.startColumnIndex} (regular time ${w}) - before anacrusis offset (${n})`);return}const x=w;let A;const E=Yt[y.endColumnIndex+1];if(e&&Xd(y.endColumnIndex+1),E===void 0){S.warn("TransportService",`Skipping note with invalid endColumnIndex: ${y.endColumnIndex+1} (note ends at ${y.endColumnIndex})`,{noteId:y.uuid,startColumnIndex:y.startColumnIndex,endColumnIndex:y.endColumnIndex,lookupIndex:y.endColumnIndex+1,timeMapLength:Yt.length,maxValidIndex:Yt.length-1,noteShape:y.shape},"audio");return}const M=E-w;if(y.shape==="circle"?(A=M,kr()):A=M,y.isDrum)U.Transport.schedule(R=>{var D;u.state.isPaused||((D=yr==null?void 0:yr.player(y.drumTrack))==null||D.start(R),Vn.triggerNotePop(y.startColumnIndex,y.drumTrack))},x);else{const R=xw(y),D=y.color,G=((I=u.state.fullRowData[y.row])==null?void 0:I.hex)||"#888888",X=y.uuid,F=u.state.timbres[D];if(!F){S.warn("TransportService",`Timbre not found for color ${D}. Skipping note ${X}`,null,"audio");return}U.Transport.schedule(Q=>{var K;u.state.isPaused||(Gt.triggerAttack(R,D,Q),(K=Ss.adsrComponent)==null||K.playheadManager.trigger(X,"attack",G,F.adsr),u.emit("noteAttack",{noteId:X,color:D}))},x);const H=x+A;U.Transport.schedule(Q=>{var K;Gt.triggerRelease(R,D,Q),(K=Ss.adsrComponent)==null||K.playheadManager.trigger(X,"release",G,F.adsr),u.emit("noteRelease",{noteId:X,color:D})},H)}});const r=cm(),a=s?new Set(u.state.lassoSelection.selectedItems.filter(y=>y.type==="stamp").map(y=>y.id)):null;r.forEach(y=>{var A;if(s){const E=`stamp-${y.row}-${y.column}-${y.stampId}`;if(!a.has(E))return}const w=Yt[y.column];if(w===void 0)return;if(w<n){S.debug("TransportService",`Skipping stamp at column ${y.column} - before anacrusis offset`);return}const x=rm(y.stampId,y.placement);x.forEach(E=>{const M=U.Time(E.offset).toSeconds(),I=U.Time(E.duration).toSeconds(),R=w+M,D=R+I,G=y.row+E.rowOffset,X=Lc(G);U.Transport.schedule(F=>{u.state.isPaused||Gt.triggerAttack(X,y.color,F)},R),U.Transport.schedule(F=>{u.state.isPaused||Gt.triggerRelease(X,y.color,F)},D)}),S.debug("TransportService",`Scheduled stamp ${y.stampId} with ${x.length} events at column ${y.column}`,{stampId:y.stampId,column:y.column,basePitch:y.pitch,baseRow:y.row,startTime:w,events:x.length,hasShapeOffsets:!!((A=y.placement)!=null&&A.shapeOffsets)},"audio")});const c=hm(),h=s?new Set(u.state.lassoSelection.selectedItems.filter(y=>y.type==="triplet").map(y=>y.id)):null;c.forEach(y=>{var E,M,I;if(s){const R=`triplet-${y.row}-${y.column}-${y.tripletId}`;if(!h.has(R))return}const w=y.startCellIndex*2,x=Yt[w];if(x===void 0)return;if(x<n){S.debug("TransportService",`Skipping triplet at cell ${y.startCellIndex} - before anacrusis offset`);return}S.debug("TransportService","[TRANSPORT DEBUG] Scheduling triplet",{stampId:y.stampId,baseRow:y.row,hasPlacement:!!y.placement,hasShapeOffsets:!!((E=y.placement)!=null&&E.shapeOffsets),shapeOffsets:(M=y.placement)==null?void 0:M.shapeOffsets});const A=am(y.stampId,y.placement);A.forEach(R=>{const D=U.Time(R.offset).toSeconds(),G=U.Time(R.duration).toSeconds(),X=x+D,F=X+G,H=y.row+R.rowOffset,Q=Lc(H);S.debug("TransportService","[TRANSPORT DEBUG] Scheduling shape",{slot:R.slot,rowOffset:R.rowOffset,baseRow:y.row,shapeRow:H,shapePitch:Q}),U.Transport.schedule(K=>{u.state.isPaused||Gt.triggerAttack(Q,y.color,K)},X),U.Transport.schedule(K=>{u.state.isPaused||Gt.triggerRelease(Q,y.color,K)},F)}),S.debug("TransportService",`Scheduled triplet ${y.stampId} with ${A.length} events at cell ${y.startCellIndex}`,{stampId:y.stampId,cellIndex:y.startCellIndex,basePitch:Lc(y.row),baseRow:y.row,startTime:x,events:A.length,hasShapeOffsets:!!((I=y.placement)!=null&&I.shapeOffsets)},"audio")}),S.debug("TransportService","scheduleNotes",`Finished scheduling ${u.state.placedNotes.length} notes, ${r.length} stamps, and ${c.length} triplets`,"audio"),u.state.placedNotes.length,r.length,c.length}function Bc(){var v,y;const n=ci.get("playheadCanvas");if(!n)return;const e=n.getContext("2d"),s=Nc(u.state.columnWidths.length-2),i=u.state.tempo,r=1e-4,a=.5,c=w=>(w==null?void 0:w.xPosition)??477.5,h=typeof((y=(v=U.Transport)==null?void 0:v.bpm)==null?void 0:y.value)=="number"?U.Transport.bpm.value:i;let m=i!==0?h/i:1;function f(){if(U.Transport.state!=="started"||!n)return;const w=U.Transport.loopEnd??0,x=Yt.length>0?Yt[Yt.length-1]:0,A=u.state.isLooping,E=A&&w>0?w:x,M=U.Transport.seconds,I=M>=E-.001;if(!A&&I){S.info("TransportService","Playback reached end. Stopping playhead.",{currentTime:M,playbackEnd:E,isLooping:A},"transport"),U.Transport.loopStart,U.Transport.loopEnd,Ji.stop();return}if(u.state.isPaused){zs=requestAnimationFrame(f);return}e.clearRect(0,0,n.width,n.height);let R=M;if(A){const H=U.Transport.loopEnd-U.Transport.loopStart;H>0&&(R=(M-U.Transport.loopStart)%H+U.Transport.loopStart)}let D=0;for(let H=0;H<Yt.length-1;H++)if(Yt[H]!==void 0&&R>=Yt[H]&&R<Yt[H+1]){const Q=Yt[H],pt=Yt[H+1]-Q,ut=R-Q,_t=Nc(H),xt=Nc(H+1)-_t,Zt=pt>0?ut/pt:0;D=_t+Zt*xt;break}const G=Math.min(D,s),F=(Array.isArray(u.state.modulationMarkers)?u.state.modulationMarkers:[]).filter(H=>(H==null?void 0:H.active)&&typeof H.ratio=="number"&&H.ratio!==0).sort((H,Q)=>c(H)-c(Q));if(F.length>0){let H=1;for(const Q of F){const K=c(Q);if(G+a>=K)H*=1/Q.ratio;else break}if((!Number.isFinite(H)||H<=0)&&(H=1),Math.abs(H-m)>r){const Q=i*H;U.Transport.bpm.value=Q,br(),m=H;const K={targetMultiplier:Number(H.toFixed(6)),newTempo:Number(Q.toFixed(3)),markerCount:F.length,finalXPos:Number(G.toFixed(2))};S.debug("TransportService",`Tempo multiplier updated to ${H.toFixed(3)} (${Q.toFixed(2)} BPM)`,K,"transport")}}else if(Math.abs(m-1)>r){U.Transport.bpm.value=i,br(),m=1;const H={targetMultiplier:1,newTempo:Number(i.toFixed(3)),markerCount:F.length,finalXPos:Number(G.toFixed(2))};S.debug("TransportService",`Tempo reset to base ${i} BPM`,H,"transport")}G>0&&(e.strokeStyle="rgba(255,0,0,0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(G,0),e.lineTo(G,n.height),e.stroke()),zs=requestAnimationFrame(f)}f()}const Ji={init(){const n=new U.Volume(0);if(yr=new U.Players({H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"}).connect(n),window.synthEngine){const e=window.synthEngine.getMainVolumeNode&&window.synthEngine.getMainVolumeNode();e?n.connect(e):n.toDestination()}else n.toDestination();window.drumVolumeNode=n,window.transportService={drumPlayers:yr},U.Transport.bpm.value=u.state.tempo,u.on("rhythmStructureChanged",()=>this.handleStateChange()),u.on("notesChanged",()=>this.handleStateChange()),u.on("stampPlacementsChanged",()=>this.handleStateChange()),u.on("modulationMarkersChanged",()=>this.handleStateChange()),u.on("tempoChanged",e=>{if(S.event("TransportService",`tempoChanged triggered with new value: ${e} BPM`,null,"transport"),U.Transport.state==="started"){S.info("TransportService","Tempo changed WHILE PLAYING. Resynchronizing transport...",null,"transport");const s=U.Transport.position;S.debug("TransportService",`Saved musical position: ${s}`,null,"transport"),U.Transport.pause(),S.debug("TransportService","Transport paused",null,"transport"),zs&&(cancelAnimationFrame(zs),zs=null),U.Transport.bpm.value=e,br(),S.debug("TransportService",`New BPM set to ${U.Transport.bpm.value}`,null,"transport"),Fc(),U.Transport.start(void 0,s),S.debug("TransportService",`Transport restarted at musical position ${s}`,null,"transport"),u.state.paint.isMicPaintActive||Bc()}else S.debug("TransportService","Tempo changed while stopped/paused. Updating BPM for next run",null,"transport"),U.Transport.bpm.value=e,br(),uh()}),u.on("loopingChanged",e=>{U.Transport.loop=e,e&&U.Transport.loopEnd<=U.Transport.loopStart&&(U.Transport.loopEnd=U.Transport.loopStart+Math.max(kr(),.001)),e?(io=U.Transport.loopStart,oo=U.Transport.loopEnd):(io=0,oo=0),U.Transport.loopStart,U.Transport.loopEnd}),U.Transport.on("stop",()=>{var e;S.event("TransportService","Tone.Transport 'stop' fired. Resetting playback state",null,"transport"),u.setPlaybackState(!1,!1),(e=Ss.adsrComponent)==null||e.playheadManager.clearAll(),zs&&(cancelAnimationFrame(zs),zs=null)}),S.info("TransportService","Initialized",null,"transport")},handleStateChange(){if(U.Transport.state==="started"){S.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling",null,"transport");const e=U.Transport.position;U.Transport.pause(),Fc(),U.Transport.start(void 0,e)}else uh()},start(){S.info("TransportService","Starting playback",null,"transport"),u.state.tempo,u.state.isLooping,u.state.placedNotes.length,(window.initAudio||(()=>U.start()))().then(()=>{Fc(),u.state.placedNotes.length,cm().length,hm().length;const e=Yt.length>0?Yt[Yt.length-1]:0,s=Yt[u.state.columnWidths.length-2]||e,i=Yt[2]||0,r=bw();U.Transport.loopStart=r,U.Transport.loopEnd=s,U.Transport.loop=u.state.isLooping,U.Transport.loopEnd<=U.Transport.loopStart&&(U.Transport.loopEnd=U.Transport.loopStart+Math.max(kr(),.001)),io=U.Transport.loopStart,oo=U.Transport.loopEnd,U.Transport.bpm.value=u.state.tempo,S.debug("TransportService",`Transport configured. Loop: ${U.Transport.loop}, BPM: ${U.Transport.bpm.value}, StartOffset: ${i}, LoopStart: ${r}`,null,"transport"),U.Transport.loopStart,U.Transport.loopEnd,u.state.modulationMarkers&&u.state.modulationMarkers.length>0,U.Transport.start(U.now(),i),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive?(u.emit("playbackStateChanged",{isPlaying:!0,isPaused:!1}),S.debug("TransportService","Paint playhead is active, skipping regular playhead animation",null,"transport")):Bc(),u.emit("playbackStarted")})},resume(){S.info("TransportService","Resuming playback",null,"transport"),(window.initAudio||(()=>U.start()))().then(()=>{U.Transport.start(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive||Bc(),u.emit("playbackResumed")})},pause(){S.info("TransportService","Pausing playback",null,"transport"),U.Transport.pause(),zs&&(cancelAnimationFrame(zs),zs=null),u.emit("playbackPaused")},stop(){S.info("TransportService","Stopping playback and clearing visuals",null,"transport"),U.Transport.stop(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStop&&window.PaintPlaybackService.onTransportStop(),U.Transport.cancel(),U.Transport.bpm.value=u.state.tempo,br(),u.state.tempo,Gt.releaseAll();const n=ci.get("playheadCanvas");n&&n.getContext("2d").clearRect(0,0,n.width,n.height),u.state.paint.isMicPaintActive&&u.emit("playbackStateChanged",{isPlaying:!1,isPaused:!1}),u.emit("playbackStopped")}};let Za=!1,zh=[],Da=null;function ym(){Za=!0}function Sw(){Za=!1}function bm(n){try{return JSON.parse(JSON.stringify(n,(e,s)=>s instanceof Float32Array?{__type:"Float32Array",data:Array.from(s)}:s))}catch{return null}}function dh(n,e,s="root"){const i=[];if(!n||!e)return i;if(typeof n!=typeof e)return i.push({path:s,type:"type_change",oldValue:typeof n,newValue:typeof e,timestamp:Date.now()}),i;if(typeof n!="object")return n!==e&&i.push({path:s,type:"value_change",oldValue:n,newValue:e,timestamp:Date.now()}),i;if(Array.isArray(n)){if(!Array.isArray(e))return i.push({path:s,type:"array_to_non_array",oldLength:n.length,newType:typeof e,timestamp:Date.now()}),i;n.length!==e.length&&i.push({path:s,type:"array_length_change",oldLength:n.length,newLength:e.length,timestamp:Date.now()});const a=Math.max(n.length,e.length);for(let c=0;c<a;c++){const h=dh(n[c],e[c],`${s}[${c}]`);i.push(...h)}return i}const r=new Set([...Object.keys(n),...Object.keys(e)]);for(const a of r)if(!(a in n))i.push({path:`${s}.${a}`,type:"property_added",newValue:e[a],timestamp:Date.now()});else if(!(a in e))i.push({path:`${s}.${a}`,type:"property_removed",oldValue:n[a],timestamp:Date.now()});else{const c=dh(n[a],e[a],`${s}.${a}`);i.push(...c)}return i}function Cw(n){Za&&(Da=bm(n))}function Tw(n,e="unknown"){if(!Za||!Da)return;const s=bm(n),i=dh(Da,s);if(i.length>0){const r=i.filter(a=>!a.path.includes("paint.paintHistory")&&!a.path.includes("tempo")&&!a.path.includes("isPlaying")&&!a.path.includes("fullRowData")&&!a.path.includes("columnWidths"));r.length>0&&zh.push({action:e,mutations:r,timestamp:Date.now()})}Da=s}function Aw(){return[...zh]}function Mw(){zh=[]}window.stateGuard={enable:ym,disable:Sw,getLog:Aw,clearLog:Mw};const wm=[];function me(...n){wm.push(n)}const _m={enableModulationTool(){u.setSelectedTool("modulation"),me("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),me("[MODULATION TEST] Click marker labels to toggle 2:3  3:2"),me("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const e=this.findNearestGridLine(200),s=this.findMeasureIndexForX(e.x),i=u.addModulationMarker(s,Rs.COMPRESSION_2_3,e.x,e.columnIndex);return me("[MODULATION TEST] Added test marker at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",200,")"),i},addTestMarker2(){const e=this.findNearestGridLine(400),s=this.findMeasureIndexForX(e.x),i=u.addModulationMarker(s,Rs.EXPANSION_3_2,e.x,e.columnIndex);return me("[MODULATION TEST] Added test marker 2 at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",400,")"),i},findNearestGridLine(n){const e=u.state;let s=0,i=0,r=1/0,a=0;for(let c=0;c<e.columnWidths.length;c++){const h=Math.abs(a-n);h<r&&(r=h,i=a,s=c);const m=e.columnWidths[c]||0;a+=m*e.cellWidth}return me("[MODULATION TEST] findNearestGridLine:",{targetX:n,closestColumnIndex:s,closestX:i,minDistance:r}),{columnIndex:s,x:i}},findMeasureIndexForX(n){const e=u.state.cellWidth||40,s=5,i=Math.round(n/e);return Math.max(1,Math.round(i/s))},clearAllMarkers(){[...u.state.modulationMarkers||[]].forEach(e=>{u.removeModulationMarker(e.id)}),me("[MODULATION TEST] Cleared all markers")},testMapping(){const n=u.state.baseMicrobeatPx||u.state.cellWidth||40;if(me("[MODULATION TEST] Base microbeat pixels:",n),me("[MODULATION TEST] Modulation markers:",u.state.modulationMarkers),window.getModulationMapping){const e=window.getModulationMapping();me("[MODULATION TEST] Coordinate mapping:",e),[0,100,200,300,400,500].forEach(i=>{const r=e.canvasXToMicrobeat(i),a=e.microbeatToCanvasX(r);me(`[MODULATION TEST] x=${i}  microbeat=${r.toFixed(3)}  x=${a.toFixed(1)}`)})}},testVisualExpansion(){me("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const n=this.addTestMarker2();me("[MODULATION TEST] Added 3:2 expansion marker:",n),typeof window<"u"&&window.LayoutService&&(me("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{me("[MODULATION TEST] Grid should now show expansion after x=400"),me("[MODULATION TEST] Container should be wider to accommodate expansion"),me("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){me("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const n=this.addTestMarker();me("[MODULATION TEST] Added 2:3 compression marker:",n),typeof window<"u"&&window.LayoutService&&(me("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{me("[MODULATION TEST] Grid should now show compression after x=200"),me("[MODULATION TEST] Container should adjust to accommodate compression"),me("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){me("[MODULATION TEST] Current state:",{selectedTool:u.state.selectedTool,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.baseMicrobeatPx,cellWidth:u.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=_m,window.ModulationTestLogs=wm);function Ew(){const n=document.getElementById("anacrusis-on-btn"),e=document.getElementById("anacrusis-off-btn");!n||!e||(n.addEventListener("click",()=>u.setAnacrusis(!0)),e.addEventListener("click",()=>u.setAnacrusis(!1)),u.on("anacrusisChanged",s=>{n.classList.toggle("active",s),e.classList.toggle("active",!s)}),n.classList.toggle("active",u.state.hasAnacrusis),e.classList.toggle("active",!u.state.hasAnacrusis))}function Pw(){const n=document.getElementById("hide-drumgrid-toggle"),e=document.getElementById("drum-grid-wrapper");let s=!0;n&&e&&n.addEventListener("click",()=>{s=!s,e.style.display=s?"flex":"none",n.querySelector(".sidebar-button-text").textContent=s?"Hide Drum Grid":"Show Drum Grid",setTimeout(()=>St.recalculateLayout(),10)})}function kw(){const n=document.getElementById("settings-button"),e=document.getElementById("sidebar"),s=document.getElementById("sidebar-overlay"),i=document.getElementById("volume-icon-button"),r=document.getElementById("volume-popup"),a=document.getElementById("vertical-volume-slider"),c=()=>document.body.classList.toggle("sidebar-open");if(n&&e&&s&&(n.addEventListener("click",c),s.addEventListener("click",c)),i&&r&&a){const h="app.volumeSliderValue",m=w=>Math.min(100,Math.max(0,w)),f=()=>{try{const w=window.localStorage.getItem(h);if(w!==null){const x=Number(w);if(!Number.isNaN(x))return m(x)}}catch{}return 70},v=w=>{try{window.localStorage.setItem(h,String(m(w)))}catch{}},y=f();a.value=y,i.addEventListener("click",w=>{w.stopPropagation();const x=r.classList.toggle("visible");i.classList.toggle("active",x)}),a.addEventListener("input",function(){const w=parseInt(this.value,10),x=w===0?-1/0:w/100*37.5-50;u.emit("volumeChanged",x),v(w)}),document.addEventListener("click",w=>{!r.contains(w.target)&&w.target!==i&&(r.classList.remove("visible"),i.classList.remove("active"))}),a.dispatchEvent(new Event("input"))}Ew(),Pw()}function xm(){const n=new Date,e=n.toLocaleDateString("en-US",{month:"long"}),s=n.getDate();return`SN-score-${e}${s}.csv`}async function Iw(n){try{const e={suggestedName:xm(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},i=await(await window.showSaveFilePicker(e)).createWritable();await i.write(n),await i.close()}catch(e){e.name!=="AbortError"&&S.error("FileActionsInitializer","Error saving file with picker",e,"toolbar")}}function Rw(n){const e=document.createElement("a"),s=URL.createObjectURL(n);e.setAttribute("href",s),e.setAttribute("download",xm()),document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(s)}function Dw(){return u.state.placedNotes.map(n=>[n.row,n.startColumnIndex,n.endColumnIndex,n.color,n.shape,n.tonicNumber||"",n.isDrum,n.drumTrack||""].join(",")).join(`
`)}function Ow(){var n,e,s,i;(n=document.getElementById("save-as-button"))==null||n.addEventListener("click",async()=>{const r=Dw(),a=new Blob([r],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await Iw(a):Rw(a)}),(e=document.getElementById("import-button"))==null||e.addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.accept=".csv,.txt",r.onchange=a=>{const c=a.target.files[0];if(!c)return;const h=new FileReader;h.onload=m=>{const v=m.target.result.split(`
`).filter(y=>y.trim()).map(y=>{const w=y.split(",");return{row:parseInt(w[0]),startColumnIndex:parseInt(w[1]),endColumnIndex:parseInt(w[2]),color:w[3],shape:w[4],tonicNumber:w[5]?parseInt(w[5]):null,isDrum:w[6]==="true",drumTrack:w[7]||null}});u.loadNotes(v)},h.readAsText(c)},r.click()}),(s=document.getElementById("print-button"))==null||s.addEventListener("click",()=>{document.body.classList.remove("sidebar-open"),u.emit("printPreviewStateChanged",!0)}),(i=document.getElementById("reset-canvas-button"))==null||i.addEventListener("click",()=>{window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&u.clearSavedState()})}class Nw{constructor(){var e,s,i,r,a;this.overlay=document.getElementById("notification-overlay"),this.modal=(e=this.overlay)==null?void 0:e.querySelector(".notification-modal"),this.title=(s=this.overlay)==null?void 0:s.querySelector(".notification-title"),this.message=(i=this.overlay)==null?void 0:i.querySelector(".notification-message"),this.actionsContainer=(r=this.overlay)==null?void 0:r.querySelector(".notification-actions"),this.closeButton=(a=this.overlay)==null?void 0:a.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){var e;this.overlay&&((e=this.closeButton)==null||e.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",s=>{s.target===this.overlay&&this.hide()}),document.addEventListener("keydown",s=>{var i;s.key==="Escape"&&((i=this.overlay)!=null&&i.classList.contains("visible"))&&this.hide()}))}show(e={}){if(!this.overlay)return;const{title:s="Notice",message:i="",buttons:r=[{text:"OK",primary:!0,action:()=>this.hide()}]}=e;this.title&&(this.title.textContent=s),this.message&&(this.message.textContent=i),this.actionsContainer&&(this.actionsContainer.innerHTML="",r.forEach(a=>{const c=document.createElement("button");c.className=`notification-button ${a.primary?"":"secondary"}`,c.textContent=a.text,c.addEventListener("click",()=>{a.action?a.action():this.hide()}),this.actionsContainer.appendChild(c)})),this.overlay.classList.add("visible"),setTimeout(()=>{var c;const a=(c=this.actionsContainer)==null?void 0:c.querySelector(".notification-button");a==null||a.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(e,s="Notice"){this.show({title:s,message:e,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(e,s="Confirm"){return new Promise(i=>{this.show({title:s,message:e,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),i(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),i(!0)}}]})})}}const Ud=new Nw;function wa(n,...e){}const ph=40,Lw=ph;class Yd{constructor(e,s,i,r){this.element=e,this.viewportEl=e==null?void 0:e.querySelector(".clef-wheel-viewport"),this.optionsEl=e==null?void 0:e.querySelector(".clef-wheel-options"),this.onChange=r,this.options=s,this.selectedIndex=0,this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.silent=!1,this.optionHeight=ph,this.resizeObserver=null,this.debugLabel=(e==null?void 0:e.id)||"clef-wheel",!(!e||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(i,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){this.optionsEl.innerHTML="",this.optionNodes=this.options.map((e,s)=>{const i=document.createElement("div");return i.className="clef-wheel-option",i.dataset.index=s.toString(),i.textContent=e.label,this.optionsEl.appendChild(i),i})}attachEvents(){this.element.addEventListener("wheel",s=>{s.preventDefault(),s.stopPropagation();const i=Math.sign(s.deltaY);i!==0&&this.increment(i)},{passive:!1}),this.element.addEventListener("keydown",s=>{s.key==="ArrowUp"?(s.preventDefault(),this.increment(-1)):s.key==="ArrowDown"?(s.preventDefault(),this.increment(1)):s.key==="Home"?(s.preventDefault(),this.setIndex(0)):s.key==="End"&&(s.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",s=>{if(this.pointerActive=!0,this.pointerId=s.pointerId,this.lastPointerY=s.clientY,this.deltaBuffer=0,typeof this.element.setPointerCapture=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",s=>{if(!this.pointerActive||s.pointerId!==this.pointerId)return;const i=s.clientY-this.lastPointerY;if(this.lastPointerY=s.clientY,i===0)return;this.deltaBuffer+=i;const r=this.optionHeight||Lw;for(;Math.abs(this.deltaBuffer)>=r;){const a=-Math.sign(this.deltaBuffer);this.increment(a),this.deltaBuffer-=Math.sign(this.deltaBuffer)*r}});const e=s=>{this.pointerActive&&s.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element.hasPointerCapture(s.pointerId)&&this.element.releasePointerCapture(s.pointerId))};this.element.addEventListener("pointerup",e),this.element.addEventListener("pointercancel",e),this.element.addEventListener("pointerleave",s=>{this.pointerActive&&s.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element.hasPointerCapture(s.pointerId)&&this.element.releasePointerCapture(s.pointerId))})}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(e=>{for(const s of e)s.target===this.element&&s.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(e){if(e===0||!this.options||this.options.length===0)return;const s=this.selectedIndex+e;this.setIndex(s)}setIndex(e,{silent:s=!1}={}){if(!this.optionsEl)return;const i=Math.max(0,Math.min(this.options.length-1,e));if(i===this.selectedIndex){this.updateVisuals();return}this.selectedIndex=i,this.updateVisuals(),!s&&typeof this.onChange=="function"&&this.onChange(i,this.options[i])}updateVisuals(){var h,m;if(!this.optionsEl||!this.viewportEl)return;const e=this.viewportEl.clientHeight||0,s=(h=this.optionNodes)==null?void 0:h[this.selectedIndex],i=(m=this.optionNodes)==null?void 0:m[0],r=(s==null?void 0:s.offsetHeight)||(i==null?void 0:i.offsetHeight)||ph;if(this.optionHeight=r,this.optionNodes&&this.optionNodes.forEach((f,v)=>{const y=Math.abs(v-this.selectedIndex),w=Math.min(y,3);f.dataset.distance=String(w)}),e===0||r===0)return;const a=Math.max(0,(e-r)/2);this.optionsEl.style.paddingTop=`${a}px`,this.optionsEl.style.paddingBottom=`${a}px`;let c=0;if(s){const f=s.offsetTop+r/2;c=e/2-f}else c=e/2-(a+r/2);this.optionsEl.style.transform=`translateY(${c}px)`}}class Fw{constructor(){this.initialized=!1,this.topPicker=null,this.bottomPicker=null,this.suppressStoreSync=!1,this.snapToggle=null}init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),!this.topWheel||!this.bottomWheel){logger.warn("ClefRangeController","Clef tab elements not found; skipping initialization",null,"ui");return}this.masterOptions=ke.map((s,i)=>({index:i,label:s.pitch,toneNote:s.toneNote,frequency:s.frequency}));const e=this.normaliseRange(u.state.pitchRange,this.masterOptions.length);this.topPicker=new Yd(this.topWheel,this.masterOptions,e.topIndex,s=>this.handleTopSelection(s)),this.bottomPicker=new Yd(this.bottomWheel,this.masterOptions,e.bottomIndex,s=>this.handleBottomSelection(s)),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.setPresetRange("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.setPresetRange("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.setPresetRange("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.setPresetRange("bass")),u.on("pitchRangeChanged",s=>{this.syncFromStore(s)}),this.currentRange=e,this.lastTopIndex=e.topIndex,this.lastBottomIndex=e.bottomIndex,this.updateSummary(),this.initialized=!0,logger.moduleLoaded("ClefRangeController","ui")}normaliseRange(e,s){const i={topIndex:0,bottomIndex:s-1};if(!e)return i;const r=Math.max(0,Math.min(s-1,e.topIndex)),a=Math.max(r,Math.min(s-1,e.bottomIndex));return{topIndex:r,bottomIndex:a}}handleTopSelection(e){const s=this.bottomPicker.getIndex(),i=Math.max(e,s);i!==s&&this.bottomPicker.setIndex(i,{silent:!0}),this.commitRangeChange(e,i)}handleBottomSelection(e){const s=this.topPicker.getIndex(),i=Math.min(e,s);i!==s&&this.topPicker.setIndex(i,{silent:!0}),this.commitRangeChange(i,e)}commitRangeChange(e,s){const i=this.currentRange||u.state.pitchRange||{topIndex:0},r=Math.max(0,Math.min(this.masterOptions.length-1,e)),a=Math.max(r,Math.min(this.masterOptions.length-1,s));if(wa("log","[CommitRange] Current range:",this.currentRange),this.currentRange&&this.currentRange.topIndex===r&&this.currentRange.bottomIndex===a)return;let c=null;if(St!=null&&St.getViewportInfo){const h=St.getViewportInfo();h&&(c=(i.topIndex??0)+h.startRank)}this.currentRange={topIndex:r,bottomIndex:a},this.lastTopIndex=r,this.lastBottomIndex=a,this.updateSummary(),u.setPitchRange({topIndex:r,bottomIndex:a},{maintainGlobalStart:c}),wa("log",`[CommitRange] Snap zoom currently: ${u.state.snapZoomToRange}`),u.state.snapZoomToRange||u.setSnapZoomToRange(!0),wa("log",`[CommitRange] Snap zoom now: ${u.state.snapZoomToRange}`),St&&typeof St.snapZoomToCurrentRange=="function"&&u.state.snapZoomToRange?St.snapZoomToCurrentRange():St&&typeof St.recalculateLayout=="function"&&St.recalculateLayout()}syncFromStore(e){if(!this.initialized||!e)return;const s=this.normaliseRange(e,this.masterOptions.length);this.currentRange=s,this.topPicker&&this.topPicker.getIndex()!==s.topIndex&&this.topPicker.setIndex(s.topIndex,{silent:!0}),this.bottomPicker&&this.bottomPicker.getIndex()!==s.bottomIndex&&this.bottomPicker.setIndex(s.bottomIndex,{silent:!0}),this.updateSummary(e.metadata)}updateSummary(e){if(!this.currentRange)return;const s=this.masterOptions[this.currentRange.topIndex],i=this.masterOptions[this.currentRange.bottomIndex],r=this.currentRange.bottomIndex-this.currentRange.topIndex+1;if(this.rangeLabel&&(this.rangeLabel.textContent=`${s.label}  ${i.label}`),this.rangeCount&&(this.rangeCount.textContent=`${r} ${r===1?"pitch":"pitches"}`),e){const{removedNotes:a=0,removedStamps:c=0,removedTriplets:h=0}=e,m=a+c+h;m>0&&logger.info("ClefRangeController",`Range change removed: ${m} items`,e,"ui")}}resetRange(){this.topPicker.setIndex(0,{silent:!0}),this.bottomPicker.setIndex(this.masterOptions.length-1,{silent:!0}),this.commitRangeChange(0,this.masterOptions.length-1)}findNoteIndex(e){return this.masterOptions.findIndex(s=>s.label===e)}animateWheelToIndex(e,s,i=300){const r=e.getIndex(),a=s-r,c=performance.now(),h=m=>{const f=m-c,v=Math.min(f/i,1),y=1-Math.pow(1-v,3),w=Math.round(r+a*y);e.setIndex(w,{silent:v<1}),v<1?requestAnimationFrame(h):(e.selectedIndex=s,e.updateVisuals(),typeof e.onChange=="function"&&e.onChange(s,e.options[s]))};requestAnimationFrame(h)}setPresetRange(e){let s,i;switch(e){case"full":this.animateRangeTransition(0,this.masterOptions.length-1);return;case"treble":s="A/G5",i="C4";break;case"alto":s="B/A4",i="D3";break;case"bass":s="D/C4",i="F2";break;default:return}const r=this.findNoteIndex(s),a=this.findNoteIndex(i);if(r===-1||a===-1){logger.warn("ClefRangeController",`Preset notes not found: ${s} or ${i}`,null,"ui");return}this.animateRangeTransition(r,a)}animateRangeTransition(e,s,i=500){const r=this.topPicker.getIndex(),a=this.bottomPicker.getIndex(),c=e-r,h=s-a,m=performance.now();u.state.snapZoomToRange&&u.setSnapZoomToRange(!1);const v=St.getCurrentZoomLevel?St.getCurrentZoomLevel():1,w=this.calculateTargetZoom(e,s)-v;let x=0;const A=E=>{const M=E-m,I=Math.min(M/i,1),R=I<.5?4*I*I*I:1-Math.pow(-2*I+2,3)/2,D=Math.round(r+c*R),G=Math.round(a+h*R),X=v+w*R;x++,(x%10===0||I===1)&&wa("log",`[AnimateRange] Frame ${x}: progress=${(I*100).toFixed(1)}%, top=${D}, bottom=${G}, zoom=${Math.round(X*100)}%`),this.topPicker.setIndex(D,{silent:!0}),this.bottomPicker.setIndex(G,{silent:!0}),u.state.pitchRange={topIndex:D,bottomIndex:G},ke&&ke.length>0&&(u.state.fullRowData=ke.slice(D,G+1)),St.setZoomLevel&&St.setZoomLevel(X),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"clefRangeAnimation"}})),I<1?requestAnimationFrame(A):(this.topPicker.selectedIndex=e,this.bottomPicker.selectedIndex=s,this.topPicker.updateVisuals(),this.bottomPicker.updateVisuals(),this.currentRange={topIndex:e,bottomIndex:s},this.lastTopIndex=e,this.lastBottomIndex=s,this.updateSummary(),u.setPitchRange({topIndex:e,bottomIndex:s}),u.setSnapZoomToRange(!0))};requestAnimationFrame(A)}calculateTargetZoom(e,s){const i=s-e+1;if(i===0)return 1;const r=document.getElementById("pitch-grid-container"),a=(r==null?void 0:r.clientHeight)||window.innerHeight*.7;if(!a||a<=0)return 1;const h=2*a/(i*30);return Math.max(.1,Math.min(5,h))}}const Bw=new Fw,qw={X:["1P","3M","5P"],x:["1P","3m","5P"],"x":["1P","3m","5d"],"X+":["1P","3M","6m"],X7:["1P","3M","5P","7m"],"x":["1P","3m","5P","7m"],"Xmaj":["1P","3M","5P","7M"],"":["1P","3m","5d","7m"],"x":["1P","3m","5d","6M"],"X":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},$w={"xmaj":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x":["1P","3m","5P","7m","9M"],"x":["1P","3m","5P","6M"],"x":["1P","3m","5P","7m","9M","11P"],"Xmaj711":["1P","3M","5P","7M","11A"]},Sm={...qw,...$w},mh={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]};function Zd(){return Object.keys(u.state.tonicSignGroups).length>0}function Qd(){const n=document.getElementById("degree-mode-toggle");if(n){const e=u.state.degreeDisplayMode==="off";n.classList.toggle("disabled",e)}}function Jd(){var e;const n=document.querySelector("#chords-panel .harmony-preset-grid");if(n&&n.querySelectorAll(".harmony-preset-button").forEach(s=>s.classList.remove("selected")),u.state.selectedTool==="chord"&&n){const s=u.state.activeChordIntervals.toString();for(const i of n.querySelectorAll(".harmony-preset-button"))if(((e=Sm[i.textContent.trim()])==null?void 0:e.toString())===s){i.classList.add("selected");return}}}function Kd(){const n=document.querySelector("#intervals-panel .harmony-preset-grid");if(n&&(n.querySelectorAll(".harmony-preset-button").forEach(e=>e.classList.remove("selected")),u.state.selectedTool==="chord"&&u.state.activeChordIntervals)){const e=u.state.activeChordIntervals;n.querySelectorAll(".harmony-preset-button").forEach(s=>{const i=s.textContent.trim(),r=mh[i];r&&e.includes(r[0])&&s.classList.add("selected")})}}const _a=(n,e=50)=>{const s=parseInt(n.slice(1,3),16),i=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16),a=Math.min(255,Math.floor(s+(255-s)*(e/100))),c=Math.min(255,Math.floor(i+(255-i)*(e/100))),h=Math.min(255,Math.floor(r+(255-r)*(e/100)));return`#${a.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`};function zw(){const{noteBankContainer:n,eraserButton:e,degreeVisibilityToggle:s,degreeModeToggle:i,flatBtn:r,sharpBtn:a,frequencyBtn:c,focusColoursToggle:h}=ci.getMultiple("noteBankContainer","eraserButton","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","focusColoursToggle"),m=document.querySelector(".pitch-tabs-container");document.querySelector(".harmony-preset-grid");const f=document.getElementById("inversion-toggle"),v=document.getElementById("chord-position-toggle-6");Bw.init(),n&&n.querySelectorAll(".note").forEach(F=>{F.addEventListener("click",()=>{u.setSelectedNote(F.dataset.type,F.closest(".note-pair").dataset.color),u.setSelectedTool("note")})}),e&&e.addEventListener("click",()=>u.setSelectedTool("eraser"));const y=Array.from(document.querySelectorAll(".tonic-mode-button")),w=(F=u.state.selectedToolTonicNumber)=>{if(!y.length)return;const H=y[0]?parseInt(y[0].dataset.tonic,10):1,Q=parseInt(F,10),K=Number.isNaN(Q)?H:Q;y.forEach(pt=>{const _t=parseInt(pt.dataset.tonic,10)===K;pt.classList.toggle("selected",_t),pt.setAttribute("aria-pressed",_t?"true":"false")})};y.length&&(y.forEach(F=>{F.addEventListener("click",()=>{const H=F.getAttribute("data-tonic");H&&(u.setSelectedTool("tonicization",H),w(parseInt(H,10)))})}),w());const x=document.querySelector("#chords-panel .harmony-preset-grid");function A(F,H,Q){F&&F.querySelectorAll(".harmony-preset-button").forEach(K=>{K.addEventListener("click",()=>{const pt=H[K.textContent];pt&&pt.length>0?(u.setActiveChordIntervals(pt),u.setSelectedTool("chord")):S.error("ToolSelector",`Failed to retrieve valid intervals for ${Q} chord: "${K.textContent}"`,null,"toolbar"),K.blur()}),K.addEventListener("dblclick",()=>{K.classList.contains("selected")&&u.setSelectedTool("note"),K.blur()})})}A(x,Sm,"chords");const E=document.querySelectorAll(".pitch-tab-button"),M=document.querySelectorAll(".pitch-tab-panel");if(E.length>0&&E.forEach(F=>{F.addEventListener("click",()=>{const H=F.dataset.pitchTab;E.forEach(K=>K.classList.remove("active")),F.classList.add("active"),M.forEach(K=>K.classList.remove("active"));const Q=document.getElementById(`${H}-panel`);Q&&Q.classList.add("active"),H==="chords"&&D()})}),f){f.addEventListener("click",()=>{const H=!u.state.isIntervalsInverted;u.setIntervalsInversion(H),f.blur()});const F=H=>{f.classList.toggle("active",H)};u.on("intervalsInversionChanged",F),F(u.state.isIntervalsInverted)}if(v){v.addEventListener("click",()=>{const H=u.state.chordPositionState,Q=I(),K=(H+1)%Q;u.setChordPosition(K),v.blur()});const F=H=>{v.classList.remove("state-1","state-2","state-3","state-4","state-5"),H===1?v.classList.add("state-1"):H===2?v.classList.add("state-2"):H===3?v.classList.add("state-3"):H===4?v.classList.add("state-4"):H===5&&v.classList.add("state-5")};u.on("chordPositionChanged",H=>{F(H)}),F(u.state.chordPositionState)}function I(){const F=u.state.activeChordIntervals;return!F||F.length===0?3:F.length}function R(){const F=u.state.activeChordIntervals;return!F||F.length===0?3:F.length}function D(){if(!v)return;const F=R();for(let Q=0;Q<=5;Q++)v.classList.remove(`disabled-state-${Q}`);F<4?v.classList.add("disabled-state-3","disabled-state-4","disabled-state-5"):F===4?v.classList.add("disabled-state-4","disabled-state-5"):F===5&&v.classList.add("disabled-state-5");const H=F-1;u.state.chordPositionState>H&&u.setChordPosition(0)}const G=document.querySelector("#intervals-panel .harmony-preset-grid");if(G&&G.querySelectorAll(".harmony-preset-button").forEach(F=>{F.addEventListener("click",()=>{const H=F.textContent.trim(),Q=mh[H];if(Q&&Q.length>0){const K=["1P",Q[0]];u.setActiveChordIntervals(K),u.setSelectedTool("chord"),S.debug("ToolSelector",`Interval ${H} selected`,K,"toolbar")}else S.error("ToolSelector",`Failed to retrieve valid interval for symbol: "${H}"`,null,"toolbar"),S.error("ToolSelector","Available interval shapes",Object.keys(mh),"toolbar");F.blur()}),F.addEventListener("dblclick",()=>{F.classList.contains("selected")&&u.setSelectedTool("note"),F.blur()})}),s&&s.addEventListener("click",()=>{if(u.state.degreeDisplayMode==="off"){if(!Zd()){Ud.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}const Q=i.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(Q)}else u.setDegreeDisplayMode("off");s.blur()}),i&&i.addEventListener("click",()=>{if(i.classList.contains("disabled"))return;i.classList.toggle("active");const H=i.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(H),i.blur()}),r&&r.addEventListener("click",()=>{u.state.showFrequencyLabels&&u.toggleFrequencyLabels(),u.toggleAccidentalMode("flat"),r.blur()}),a&&a.addEventListener("click",()=>{u.state.showFrequencyLabels&&u.toggleFrequencyLabels(),u.toggleAccidentalMode("sharp"),a.blur()}),c&&c.addEventListener("click",()=>{u.toggleFrequencyLabels(),c.blur()}),h&&h.addEventListener("change",()=>{if(!u.state.focusColours&&!Zd()){Ud.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),h.checked=!1;return}u.toggleFocusColours()}),u.on("toolChanged",({newTool:F})=>{var K;const H=document.querySelector("#chords-panel .harmony-preset-grid");H&&H.querySelectorAll(".harmony-preset-button").forEach(pt=>pt.classList.remove("selected"));const Q=document.querySelector("#intervals-panel .harmony-preset-grid");if(Q&&Q.querySelectorAll(".harmony-preset-button").forEach(pt=>pt.classList.remove("selected")),e==null||e.classList.remove("selected"),m&&m.classList.remove("active-tool"),F==="eraser")e==null||e.classList.add("selected");else if(F!=="tonicization"){if(F==="chord")m==null||m.classList.add("active-tool"),Jd(),Kd(),D();else if(F==="note"){const pt=u.state.selectedNote;if(pt){const ut=document.querySelector(`.note-pair[data-color='${pt.color}']`);ut==null||ut.classList.add("selected"),(K=ut==null?void 0:ut.querySelector(`.note[data-type='${pt.shape}']`))==null||K.classList.add("selected")}}}w()}),u.on("activeChordIntervalsChanged",()=>{u.state.selectedTool==="chord"&&(Jd(),Kd(),D())}),u.on("noteChanged",({newNote:F})=>{var K;document.querySelectorAll(".note, .note-pair").forEach(pt=>pt.classList.remove("selected"));const H=document.querySelector(`.note-pair[data-color='${F.color}']`);if(H==null||H.classList.add("selected"),(K=H==null?void 0:H.querySelector(`.note[data-type='${F.shape}']`))==null||K.classList.add("selected"),m){const pt=_a(F.color,50),ut=_a(pt,60);m.style.setProperty("--c-accent",F.color),m.style.setProperty("--c-accent-light",ut)}const Q=document.querySelector(".tab-sidebar");Q&&Q.style.setProperty("--c-accent",F.color)}),u.on("degreeDisplayModeChanged",F=>{s&&s.classList.toggle("active",F!=="off"),i&&(i.classList.contains("active"),i.classList.toggle("active",F==="modal"),i.classList.contains("active")),Qd()}),u.on("accidentalModeChanged",F=>{const{sharp:H,flat:Q}=F;a==null||a.classList.toggle("active",H),r==null||r.classList.toggle("active",Q)}),u.on("frequencyLabelsChanged",F=>{c==null||c.classList.toggle("active",F),r&&(r.style.opacity=F?"0.3":""),a&&(a.style.opacity=F?"0.3":""),r&&(r.style.pointerEvents=F?"none":""),a&&(a.style.pointerEvents=F?"none":"")}),m&&u.state.selectedNote){const F=u.state.selectedNote.color,H=_a(F,50),Q=_a(H,60);m.style.setProperty("--c-accent",F),m.style.setProperty("--c-accent-light",Q)}const X=document.querySelector(".tab-sidebar");X&&u.state.selectedNote&&X.style.setProperty("--c-accent",u.state.selectedNote.color),setTimeout(()=>D(),50),Qd()}function Ww(n){return`/Student-Notation/assets/${n}`}function tp(n){return Ww(`icons/${n}`)}function Vw(){const n=document.getElementById("play-button"),e=document.getElementById("stop-button"),s=document.getElementById("clear-button"),i=document.getElementById("loop-button"),r=document.getElementById("undo-button"),a=document.getElementById("redo-button");n&&n.addEventListener("click",()=>{const{isPlaying:h,isPaused:m}=u.state;h&&m?(u.setPlaybackState(!0,!1),Ji.resume()):h&&!m?(u.setPlaybackState(!0,!0),Ji.pause()):(u.setPlaybackState(!0,!1),Ji.start()),n.blur()}),e&&e.addEventListener("click",()=>{u.setPlaybackState(!1,!1),Ji.stop(),e.blur()}),s&&s.addEventListener("click",()=>{s.classList.add("flash"),setTimeout(()=>s.classList.remove("flash"),300),u.clearAllNotes(),ow(),cw(),s.blur()}),i&&i.addEventListener("click",()=>{u.setLooping(!u.state.isLooping)}),r&&r.addEventListener("click",()=>{u.undo(),r.blur()}),a&&a.addEventListener("click",()=>{u.redo(),a.blur()}),u.on("playbackStateChanged",({isPlaying:h,isPaused:m})=>{if(n){const f=`<img src="${tp("play.svg")}" alt="Play">`,v=`<img src="${tp("pause.svg")}" alt="Pause">`;n.innerHTML=h&&!m?v:f}}),u.on("loopingChanged",h=>{i&&i.classList.toggle("active",h)});const c=()=>{r&&(r.disabled=u.state.historyIndex<=0),a&&(a.disabled=u.state.historyIndex>=u.state.history.length-1)};u.on("historyChanged",c),c()}class qc{constructor(e,s={}){if(this.parent=typeof e=="string"?document.querySelector(e):e,!this.parent)throw new Error("DraggableNumber: parent element not found");const i={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"}};this.settings={...i,...s,colors:{...i.colors,...s.colors||{}}},this._em=new Gw,this._value=new Hw(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[r,a]=this.settings.size;this._minDimension=Math.min(r,a),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${r}px`,`height:${a}px`,"background-color: var(--c-bg)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${r}px`,`height:${a}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),Xw(this.element,c=>/^-?\d*\.?\d*$/.test(c)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=ep(this._value.value,this.decimalPlaces),this._bind()}on(e,s){return this._em.on(e,s),()=>this._em.off(e,s)}emit(e,s){this._em.emit(e,s)}get value(){return this._value.value}set value(e){this._value.update(e),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(e){this._value.min=e,this._render()}get max(){return this._value.max}set max(e){this._value.max=e,this._render()}get step(){return this._value.step}set step(e){this._value.step=e,this._render()}passiveUpdate(e){this._value.update(e),this._render()}link(e){this.min=e.min,this.max=e.max,this.step=e.step,typeof e.on=="function"&&e.on("change",s=>this.passiveUpdate(s)),this.on("change",s=>{"value"in e&&(e.value=s)}),this.value=e.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-bg)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const e=parseFloat(this.element.value);!Number.isNaN(e)&&e!==this.value?this.value=e:this._render()}),this.element.addEventListener("keydown",e=>{if(e.key==="Enter"){this.element.blur();const s=parseFloat(this.element.value);Number.isNaN(s)||(this.value=s)}},!0),this.element.addEventListener("mousedown",e=>this._onMouseDown(e)),this.element.addEventListener("dragstart",e=>e.preventDefault())}_onMouseDown(e){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:e.clientY};const s=this.element.getBoundingClientRect(),i=(e.clientX-s.left)/s.width;this._changeFactor=jw(i);const r=c=>this._onMouseMove(c),a=()=>this._onMouseUp(r,a);window.addEventListener("mousemove",r),window.addEventListener("mouseup",a)}_onMouseMove(e){if(!this.clicked)return;this.hasMoved=!0;const s=e.clientY-this._start.y,r=Wh(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),a=this.actual-s*r;this._value.update(a),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(e,s){this.clicked=!1,window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",s),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=ep(this._value.value,this.decimalPlaces)}}class Hw{constructor(e,s,i,r){this.min=Number(e),this.max=Number(s),this.step=Number(i)||1,this._value=0,this.changed=!1,this.update(r)}get value(){return this._value}update(e){const s=Wh(Number(e),this.min,this.max),i=this._stepTo(s),r=this._value;this._value=i,this.changed=i!==r}_stepTo(e){if(!isFinite(this.step)||this.step<=0)return e;const s=Math.round((e-this.min)/this.step);return this.min+s*this.step}}class Gw{constructor(){this._m=new Map}on(e,s){const i=this._m.get(e)||[];i.push(s),this._m.set(e,i)}off(e,s){const i=this._m.get(e);if(!i)return;const r=i.indexOf(s);r>=0&&i.splice(r,1)}emit(e,s){const i=this._m.get(e);if(i)for(const r of i.slice())r(s)}}function Wh(n,e,s){return Math.max(e,Math.min(s,n))}function jw(n){return 1-Wh(n,0,1)}function ep(n,e=2){return isFinite(n)?Number(n).toFixed(Math.max(0,e)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function Xw(n,e){let s=n.value;n.addEventListener("input",()=>{e(n.value)?s=n.value:n.value=s})}class Uw{constructor(){this.isActive=!1,this.pulseIntervals=new Map,this.tempoElements=new Map,this.popDuration={scaleUp:40,scaleDown:80},this.popScale=1.4,this.activeAnimations=new Map,this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:s,containerId:i,bpmMultiplier:r})=>{const a=document.getElementById(i),c=a==null?void 0:a.parentElement,h=c==null?void 0:c.querySelector(".tempo-label-icon");a&&h?this.tempoElements.set(s,{container:a,icon:h,bpmMultiplier:r,originalTransform:a.style.transform||"",originalIconTransform:h.style.transform||""}):S.warn("TempoVisualizer",`Could not find elements for ${s} tempo`,{container:!!a,icon:!!h,tempoGroup:!!c},"toolbar")})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((e,s)=>{this.startPulseForType(s)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(e=>{clearInterval(e)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(e=>{e.container.style.transform=e.originalTransform,e.icon.style.transform=e.originalIconTransform}))}startPulseForType(e){const s=this.tempoElements.get(e);if(!s)return;const a=60/(u.state.tempo*s.bpmMultiplier)*1e3;this.triggerPulse(e);const c=setInterval(()=>{this.isActive&&this.triggerPulse(e)},a);this.pulseIntervals.set(e,c)}triggerPulse(e){this.activeAnimations.has(e);const i={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(e,i);const r=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),r||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const e=performance.now();this.activeAnimations.forEach((s,i)=>{const r=this.calculateScale(s,e);this.applyScale(i,r),r===1&&s.phase==="complete"&&this.activeAnimations.delete(i)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(e,s){const i=s-e.startTime;if(e.phase==="scaleUp"){if(i>=this.popDuration.scaleUp)return e.phase="scaleDown",e.startTime=s,this.popScale;{const r=Math.min(i/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*r}}else if(e.phase==="scaleDown"){if(i>=this.popDuration.scaleDown)return e.phase="complete",1;{const r=Math.min(i/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*r}}return 1}applyScale(e,s){const i=this.tempoElements.get(e);if(!i)return;const r=`scale(${s})`;i.container.style.transform=i.originalTransform+" "+r,i.icon.style.transform=i.originalIconTransform+" "+r;const a=s<this.popScale?"transform 0.08s ease-out":"none";i.container.style.transition=a,i.icon.style.transition=a}updateTempo(){this.isActive&&(this.stop(),this.start())}}const ei=new Uw;class Yw{constructor(){this.tapHistory=[],this.activeTapType=null,this.resetTimeout=null,this.resetWindowMs=2e3,this.durationMultipliers={eighth:.5,quarter:1,dottedQuarter:1.5},this.iconElements=new Map,this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo"},{type:"quarter",containerId:"quarter-note-tempo"},{type:"dottedQuarter",containerId:"dotted-quarter-tempo"}].forEach(({type:s,containerId:i})=>{const r=document.getElementById(i),a=r==null?void 0:r.parentElement,c=a==null?void 0:a.querySelector(".tempo-label-icon");c?(this.iconElements.set(s,c),c.addEventListener("click",h=>{h.preventDefault(),this.handleTap(s)}),c.style.cursor="pointer"):S.warn("TapTempo",`Could not find icon for ${s} tempo`,{type:s},"toolbar")})}handleTap(e){const s=performance.now();this.activeTapType!==null&&this.activeTapType!==e&&this.reset(),this.activeTapType=e,ei.triggerPulse(e),this.tapHistory.push(s),this.tapHistory.length>=2&&this.calculateAndApplyTempo(e),this.scheduleReset()}calculateAndApplyTempo(e){const s=[];for(let m=1;m<this.tapHistory.length;m++)s.push(this.tapHistory[m]-this.tapHistory[m-1]);const i=s.reduce((m,f)=>m+f,0)/s.length,r=this.durationMultipliers[e],c=6e4/(i/r),h=Math.max(30,Math.min(240,Math.round(c)));S.debug("TapTempo",`${e} tempo tap processed`,{intervals:s.length,averageMs:i,bpm:h},"toolbar"),u.setTempo(h)}scheduleReset(){this.resetTimeout&&clearTimeout(this.resetTimeout);let e=this.resetWindowMs;if(this.tapHistory.length>=2){const s=[];for(let r=1;r<this.tapHistory.length;r++)s.push(this.tapHistory[r]-this.tapHistory[r-1]);const i=s.reduce((r,a)=>r+a,0)/s.length;e=Math.max(2e3,i*3.5)}this.resetTimeout=setTimeout(()=>{this.reset()},e)}reset(){this.tapHistory=[],this.activeTapType=null,this.resetTimeout&&(clearTimeout(this.resetTimeout),this.resetTimeout=null)}}new Yw;function Zw(){var w;const n=document.getElementById("tempo-slider");n||S.warn("AudioControlsInitializer","Tempo slider not found during initial load - will retry when rhythm tab is accessed",null,"toolbar");const e={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0},s=new qc("#eighth-note-tempo",{...e,value:180,min:60,max:480}),i=new qc("#quarter-note-tempo",{...e,value:90,min:30,max:240}),r=new qc("#dotted-quarter-tempo",{...e,value:60,min:20,max:160});function a(x){const A=Math.round(x),E=n||document.getElementById("tempo-slider");E&&parseInt(E.value,10)!==A&&(E.value=A);const M=A*2,I=Math.round(A/1.5);s.value!==M&&s.passiveUpdate(M),i.value!==A&&i.passiveUpdate(A),r.value!==I&&r.passiveUpdate(I),u.state.tempo!==A&&(u.setTempo(A),ei.updateTempo())}let c=!1;if(n){const x=()=>{const A=document.querySelector(".tempo-content-box"),E=document.querySelector(".tempo-container"),M=document.querySelector(".tempo-column-2");S.debug("AudioControlsInitializer","[Tempo Slider Heights]",{slider:{offsetHeight:n.offsetHeight,clientHeight:n.clientHeight,scrollHeight:n.scrollHeight,computedHeight:getComputedStyle(n).height,computedMaxHeight:getComputedStyle(n).maxHeight},tempoColumn2:M?{offsetHeight:M.offsetHeight,clientHeight:M.clientHeight,computedHeight:getComputedStyle(M).height}:"not found",tempoContainer:E?{offsetHeight:E.offsetHeight,clientHeight:E.clientHeight,computedHeight:getComputedStyle(E).height,computedFlex:getComputedStyle(E).flex}:"not found",tempoContentBox:A?{offsetHeight:A.offsetHeight,clientHeight:A.clientHeight,computedHeight:getComputedStyle(A).height}:"not found"})};setTimeout(x,100),setTimeout(x,500),n.addEventListener("mousedown",()=>{c=!0,ei.start()}),n.addEventListener("touchstart",()=>{c=!0,ei.start()}),n.addEventListener("input",A=>{const E=parseInt(A.target.value,10);a(E)}),n.addEventListener("mouseup",function(){this.blur()}),a(u.state.tempo)}else S.warn("AudioControlsInitializer","Tempo slider not found - will initialize when rhythm tab is opened",null,"toolbar");s.on("change",x=>{!isNaN(x)&&x>0&&a(x/2)}),i.on("change",x=>{!isNaN(x)&&x>0&&a(x)}),r.on("change",x=>{!isNaN(x)&&x>0&&a(x*1.5)}),a(u.state.tempo),document.addEventListener("mouseup",()=>{c&&(c=!1,ei.stop())}),document.addEventListener("touchend",()=>{c&&(c=!1,ei.stop())}),document.addEventListener("touchcancel",()=>{c&&(c=!1,ei.stop())});const h=document.querySelector(".preset-effects-container");document.querySelectorAll(".preset-button").forEach(x=>{const A=x.id.replace("preset-",""),E=zb[A];E&&x.addEventListener("click",()=>{var I;const M=(I=u.state.selectedNote)==null?void 0:I.color;M&&(u.applyPreset(M,E),setTimeout(()=>{try{v(M)}catch{}},10)),x.blur()})});const m=(x,A=20)=>{const E=parseInt(x.slice(1,3),16),M=parseInt(x.slice(3,5),16),I=parseInt(x.slice(5,7),16),R=Math.max(0,Math.floor(E*(1-A/100))),D=Math.max(0,Math.floor(M*(1-A/100))),G=Math.max(0,Math.floor(I*(1-A/100)));return`#${R.toString(16).padStart(2,"0")}${D.toString(16).padStart(2,"0")}${G.toString(16).padStart(2,"0")}`},f=(x,A=50)=>{const E=parseInt(x.slice(1,3),16),M=parseInt(x.slice(3,5),16),I=parseInt(x.slice(5,7),16),R=Math.min(255,Math.floor(E+(255-E)*(A/100))),D=Math.min(255,Math.floor(M+(255-M)*(A/100))),G=Math.min(255,Math.floor(I+(255-I)*(A/100)));return`#${R.toString(16).padStart(2,"0")}${D.toString(16).padStart(2,"0")}${G.toString(16).padStart(2,"0")}`},v=x=>{if(!x||!h)return;const A=u.state.timbres[x],E=u.state.colorPalette[x]||{primary:x,light:x},M=E.light,I=E.primary;document.querySelectorAll(".preset-button").forEach(D=>{const G=D.id.replace("preset-",""),X=A&&A.activePresetName===G;D.classList.toggle("selected",X)});const R=f(M,60);h.style.setProperty("--c-accent",I),h.style.setProperty("--c-accent-light",R),h.style.setProperty("--c-accent-hover",m(I,20))};u.on("noteChanged",({newNote:x})=>{x.color?v(x.color):(document.querySelectorAll(".preset-button").forEach(A=>A.classList.remove("selected")),h&&(h.style.setProperty("--c-accent","#4A90E2"),h.style.setProperty("--c-accent-hover","#357ABD")))}),u.on("timbreChanged",x=>{var A;x===((A=u.state.selectedNote)==null?void 0:A.color)&&v(x)}),u.on("tempoChanged",x=>{a(x)});const y=(w=u.state.selectedNote)==null?void 0:w.color;y&&v(y)}function Qw(){const n=document.getElementById("grid-zoom-in"),e=document.getElementById("grid-zoom-out"),s=document.getElementById("macrobeat-increase"),i=document.getElementById("macrobeat-decrease");n&&n.addEventListener("click",()=>{u.emit("zoomIn"),n.blur()}),e&&e.addEventListener("click",()=>{u.emit("zoomOut"),e.blur()}),s&&s.addEventListener("click",()=>u.increaseMacrobeatCount()),i&&i.addEventListener("click",()=>u.decreaseMacrobeatCount())}function Jw(){document.querySelectorAll("button"),document.querySelector(".modulation-controls");const n=document.getElementById("modulation-2-3-btn"),e=document.getElementById("modulation-3-2-btn"),s=document.getElementById("modulation-clear-btn");if(!n||!e||!s){S.warn("ModulationInitializer","Modulation control buttons not found in DOM",null,"ui");return}let i=null;n.addEventListener("click",()=>{i===Rs.COMPRESSION_2_3?(i=null,n.classList.remove("active"),u.setSelectedTool("note"),S.info("ModulationInitializer","2:3 modulation tool deactivated",null,"ui")):(i=Rs.COMPRESSION_2_3,n.classList.add("active"),e.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=i,S.info("ModulationInitializer","2:3 modulation tool activated",null,"ui"))}),e.addEventListener("click",()=>{i===Rs.EXPANSION_3_2?(i=null,e.classList.remove("active"),u.setSelectedTool("note"),S.info("ModulationInitializer","3:2 modulation tool deactivated",null,"ui")):(i=Rs.EXPANSION_3_2,e.classList.add("active"),n.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=i,S.info("ModulationInitializer","3:2 modulation tool activated",null,"ui"))}),s.addEventListener("click",()=>{const a=(u.state.modulationMarkers||[]).length;if(a===0){S.info("ModulationInitializer","No modulation markers to clear",null,"ui");return}u.clearModulationMarkers(),S.info("ModulationInitializer",`Cleared ${a} modulation markers`,null,"ui")}),u.on("toolChanged",a=>{(a.newTool||a)!=="modulation"&&(i=null,n.classList.remove("active"),e.classList.remove("active"))}),u.on("modulationMarkersChanged",()=>{const a=(u.state.modulationMarkers||[]).length;a===0?(s.disabled=!0,s.style.opacity="0.5"):(s.disabled=!1,s.style.opacity="1"),s.textContent=a>0?`Clear (${a})`:"Clear"});const r=(u.state.modulationMarkers||[]).length;r===0&&(s.disabled=!0,s.style.opacity="0.5"),s.textContent=r>0?`Clear (${r})`:"Clear",S.info("ModulationInitializer","Modulation controls initialized",null,"ui")}S.moduleLoaded("ToolbarComponent","toolbar");const Kw={init(){kw(),Ow(),zw(),Vw(),Zw(),Qw(),Jw(),S.info("ToolbarComponent","All controls initialized",null,"toolbar")}};function t_(n,e,s){if(!(e.length<2)){n.globalAlpha=s.opacity;for(let i=1;i<e.length;i++){const r=e[i-1],a=e[i];if(a.timestamp-r.timestamp>200)continue;const c=n.createLinearGradient(r.x,r.y,a.x,a.y);c.addColorStop(0,`rgb(${r.color.join(",")})`),c.addColorStop(1,`rgb(${a.color.join(",")})`),n.strokeStyle=c,n.lineWidth=(r.thickness+a.thickness)/2,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(r.x,r.y),n.lineTo(a.x,a.y),n.stroke()}n.globalAlpha=1}}function e_(n,e){const s=u.state,i=rn(u.state),r=s.fullRowData.slice(n.topRow,n.bottomRow+1);let a=s.placedNotes.filter(X=>!X.isDrum&&X.row>=n.topRow&&X.row<=n.bottomRow).map(X=>({...X,row:X.row-n.topRow})),c=n.includeDrums?s.placedNotes.filter(X=>X.isDrum):[];if(n.colorMode==="bw"){const X=F=>F.map(H=>({...H,color:"#212529"}));a=X(a),c=X(c)}const h=s.columnWidths.reduce((X,F)=>X+F,0),m=50,f=m*2,v=f/2,y=h*m,w=r.length*v,x=n.includeDrums?3*.5*f:0,A=x>0?30:0,E=w+A+x,M=Math.min(e.width/y,e.height/E),I=document.createElement("canvas");I.width=y*M,I.height=E*M;const R=I.getContext("2d");R.scale(M,M),R.fillStyle="#FFF",R.fillRect(0,0,y,E);const D={placedNotes:a,placedTonicSigns:i,fullRowData:r,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles,colorMode:n.colorMode,degreeDisplayMode:"off"},G=document.createElement("canvas");if(G.width=y,G.height=w,tm(G.getContext("2d"),D),R.drawImage(G,0,0),s.paint&&s.paint.paintHistory.length>0){S.debug("PrintService",`Found ${s.paint.paintHistory.length} paint points to print.`,null,"print");const X=document.createElement("canvas");X.width=y,X.height=w;const F=X.getContext("2d"),H=document.getElementById("notation-grid"),Q=y/H.width,K=w/(H.height*(r.length/s.fullRowData.length)),pt=n.topRow*v,ut=s.paint.paintHistory.map(_t=>({..._t,x:_t.x*Q,y:_t.y*K-pt,thickness:_t.thickness*Math.min(Q,K)}));t_(F,ut,{opacity:s.paint.paintSettings.opacity/100}),R.drawImage(X,0,0),S.debug("PrintService","Paint trail rendered for printing.",null,"print")}if(n.includeDrums){const X={placedNotes:c,placedTonicSigns:i,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles},F=document.createElement("canvas");F.width=y,F.height=x,nm(F.getContext("2d"),X),R.drawImage(F,0,w+A)}return I}const sp={generateScoreCanvas:e_,generateAndPrint(){const n=u.state.printOptions,e=300,s=(n.orientation==="landscape"?10.5:8)*e,i=(n.orientation==="landscape"?8:10.5)*e,r=this.generateScoreCanvas(n,{width:s,height:i}),a=document.getElementById("print-staging-area");a.innerHTML="";const c=document.getElementById("print-style-rules");c.textContent=`@page { size: ${n.orientation}; margin: 0.25in; }`;const h=document.createElement("img");h.src=r.toDataURL("image/png"),h.style.width="100%",h.style.height="auto",a.appendChild(h),setTimeout(()=>window.print(),100)}},s_={init(){this.overlay=document.getElementById("print-preview-overlay"),this.overlay&&(this.canvas=document.getElementById("print-preview-canvas"),this.ctx=this.canvas.getContext("2d"),this.canvasWrapper=this.canvas.parentElement,this.topRowSlider=document.getElementById("print-top-row-slider"),this.bottomRowSlider=document.getElementById("print-bottom-row-slider"),this.topRowLabel=document.getElementById("print-top-row-label"),this.bottomRowLabel=document.getElementById("print-bottom-row-label"),this.orientationBtn=document.getElementById("print-orientation-toggle"),this.colorBtn=document.getElementById("print-color-mode-toggle"),this.drumsBtn=document.getElementById("print-drums-toggle"),document.getElementById("print-close-button").addEventListener("click",()=>this.hide()),document.getElementById("print-confirm-button").addEventListener("click",()=>{sp.generateAndPrint(),this.hide()}),this.topRowSlider.addEventListener("input",n=>u.setPrintOptions({topRow:parseInt(n.target.value)})),this.bottomRowSlider.addEventListener("input",n=>u.setPrintOptions({bottomRow:parseInt(n.target.value)})),this.orientationBtn.addEventListener("click",()=>this.handleToggle("orientation",["landscape","portrait"])),this.colorBtn.addEventListener("click",()=>this.handleToggle("colorMode",["color","bw"])),this.drumsBtn.addEventListener("click",()=>this.handleToggle("includeDrums",[!0,!1])),u.on("printPreviewStateChanged",n=>n?this.show():this.hide()),u.on("printOptionsChanged",()=>this.render()),u.on("notesChanged",()=>{u.state.isPrintPreviewActive&&this.render()}),new ResizeObserver(()=>{u.state.isPrintPreviewActive&&this.render()}).observe(this.canvasWrapper))},show(){u.state.isPrintPreviewActive||u.setPrintPreviewActive(!0),this.overlay.classList.remove("hidden");const n=u.state.placedNotes.filter(c=>!c.isDrum);let e=n.length>0?1/0:34,s=n.length>0?-1/0:54;n.forEach(c=>{e=Math.min(e,c.row),s=Math.max(s,c.row)});const i=2,r=Math.max(0,e-i),a=Math.min(u.state.fullRowData.length-1,s+i);this.topRowSlider.max=u.state.fullRowData.length-1,this.bottomRowSlider.max=u.state.fullRowData.length-1,u.setPrintOptions({...u.state.printOptions,topRow:r,bottomRow:a})},hide(){u.state.isPrintPreviewActive&&u.setPrintPreviewActive(!1),this.overlay.classList.add("hidden")},handleToggle(n,e){const i=u.state.printOptions[n]===e[0]?e[1]:e[0];u.setPrintOptions({[n]:i})},updateControls(){var a,c;const{topRow:n,bottomRow:e,orientation:s,colorMode:i,includeDrums:r}=u.state.printOptions;this.topRowSlider.value=n,this.bottomRowSlider.value=e,this.topRowLabel.textContent=((a=u.state.fullRowData[n])==null?void 0:a.pitch)||"N/A",this.bottomRowLabel.textContent=((c=u.state.fullRowData[e])==null?void 0:c.pitch)||"N/A",this.orientationBtn.textContent=s.charAt(0).toUpperCase()+s.slice(1),this.colorBtn.textContent=i==="color"?"Color":"B&W",this.drumsBtn.textContent=r?"Yes":"No",this.drumsBtn.classList.toggle("active",r),this.colorBtn.classList.toggle("active",i==="color")},render(){if(!u.state.isPrintPreviewActive)return;this.updateControls();const n=this.canvasWrapper.clientWidth,e=this.canvasWrapper.clientHeight;if(n===0||e===0)return;const i=u.state.printOptions.orientation==="landscape"?10.5/8:8/10.5;let r=n,a=e;n/e>i?r=e*i:a=n/i;const c=sp.generateScoreCanvas(u.state.printOptions,{width:r,height:a});c&&(this.canvas.width=c.width,this.canvas.height=c.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(c,0,0))}};async function n_(){Kw.init(),hh.init(),s_.init(),$h.init(),Ya.init()}const hs={};function i_(){return hs.container=document.querySelector("#adsr-envelope"),hs.parentContainer=hs.container.closest(".adsr-container"),hs.sustainTrack=document.getElementById("sustain-slider-track"),hs.sustainThumb=document.getElementById("sustain-slider-thumb"),hs.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),hs.thumbA=document.getElementById("thumb-a"),hs.thumbD=document.getElementById("thumb-d"),hs.thumbR=document.getElementById("thumb-r"),hs.parentContainer&&(np(),new ResizeObserver(()=>{np()}).observe(hs.parentContainer)),hs}function np(){const n=hs.parentContainer;if(!n)return;const e=n.getBoundingClientRect(),s=window.getComputedStyle(n),i=n.parentElement,r=i==null?void 0:i.parentElement,a=i?window.getComputedStyle(i):null,c=r?window.getComputedStyle(r):null;console.log("=== ADSR Layout Chain ==="),console.log("Container:",{width:e.width,classes:n.className,"max-width":s.maxWidth,"min-width":s.minWidth,flex:s.flex,display:s.display,"grid-template-columns":s.gridTemplateColumns}),console.log("Parent:",{name:i==null?void 0:i.className,width:i==null?void 0:i.getBoundingClientRect().width,display:a==null?void 0:a.display,"flex-direction":a==null?void 0:a.flexDirection,flex:a==null?void 0:a.flex}),console.log("Grandparent:",{name:r==null?void 0:r.className,width:r==null?void 0:r.getBoundingClientRect().width,display:c==null?void 0:c.display,"flex-direction":c==null?void 0:c.flexDirection}),console.log("Window width:",window.innerWidth),console.log("================================")}const o_={init:i_,get elements(){return hs}};function Cm(){return Am*u.state.adsrTimeAxisScale}function Tm(n,e){const{sustain:s}=u.state.timbres[e.currentColor].adsr,i=.01;n.d=Math.max(n.a+i,n.d),n.r=Math.max(n.d+i,n.r);const r=n.a,a=n.d-n.a,c=n.r-n.d;if(isNaN(r)||isNaN(a)||isNaN(c)){S.error("AdsrInteractions","NaN value detected before setting ADSR. Aborting update.",{newAttack:r,newDecay:a,newRelease:c},"audio");return}u.setADSR(e.currentColor,{attack:r,decay:a,release:c,sustain:s})}function r_(n,e){let s=!1;const i=c=>{var x;if(!s)return;const h=n.sustainTrack.getBoundingClientRect();let f=100-(c.clientY-h.top)/h.height*100;f=Math.max(0,Math.min(100,f));const y=(((x=window.staticWaveformVisualizer)==null?void 0:x.getNormalizedAmplitude())||1)*100;f=Math.min(f,y);const w=u.state.timbres[e.currentColor];u.setADSR(e.currentColor,{...w.adsr,sustain:f/100})},r=c=>{s=!0,i(c)},a=()=>{s=!1};n.sustainTrack.addEventListener("pointerdown",r),document.addEventListener("pointermove",i),document.addEventListener("pointerup",a)}function a_(n,e){let s=null;const i=c=>{if(!s)return;const h=n.multiSliderContainer.getBoundingClientRect();let f=(c.clientX-h.left)/h.width*100;f=Math.max(0,Math.min(100,f));const v=f/100*Cm(),{attack:y,decay:w,release:x}=u.state.timbres[e.currentColor].adsr,A={a:y,d:y+w,r:y+w+x};s.id==="thumb-a"&&(A.a=v),s.id==="thumb-d"&&(A.d=v),s.id==="thumb-r"&&(A.r=v),Tm(A,e)},r=c=>{c.target.classList.contains("time-slider-thumb")&&(s=c.target,i(c))},a=()=>{s=null};n.multiSliderContainer.addEventListener("pointerdown",r),document.addEventListener("pointermove",i),document.addEventListener("pointerup",a)}function l_(n,e){let s=null;const i=c=>{var G;if(!s)return;const h=e.svgContainer,m=h.createSVGPoint();m.x=c.clientX,m.y=c.clientY;const f=m.matrixTransform(h.getScreenCTM().inverse());let v=f.x/e.width*100,y=1-f.y/e.height;v=Math.max(0,Math.min(100,v)),y=Math.max(0,Math.min(1,y));const w=v/100*Cm(),x=u.state.timbres[e.currentColor];let{attack:A,decay:E,release:M,sustain:I}=x.adsr;const R={a:A,d:A+E,r:A+E+M};switch(s.id){case"attack-node":R.a=w;break;case"decay-sustain-node":R.d=w;const X=((G=window.staticWaveformVisualizer)==null?void 0:G.getNormalizedAmplitude())||1;I=Math.min(y,X);break;case"release-node":R.r=w;break}const D=u.state.timbres[e.currentColor].adsr.sustain;I!==D&&u.setADSR(e.currentColor,{attack:A,decay:E,release:M,sustain:I}),Tm(R,e)},r=c=>{c.target.classList.contains("adsr-node")&&(s=c.target,s.style.cursor="grabbing",i(c))},a=()=>{s&&(s.style.cursor="grab",s=null)};e.nodeLayer.addEventListener("pointerdown",r),document.addEventListener("pointermove",i),document.addEventListener("pointerup",a)}function c_(n){const e=n.ui;r_(e,n),a_(e,n),l_(e,n)}function h_(n,{width:e,height:s},i){for(;n.firstChild;)n.removeChild(n.firstChild);if(i>0){for(let h=1;h<=5;h++)if(h<=i){const m=h/i*e,f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",m),f.setAttribute("y",s-5),f.setAttribute("fill","#d0d0d0"),f.setAttribute("font-size","24"),f.setAttribute("font-weight","bold"),f.setAttribute("text-anchor","middle"),f.setAttribute("dominant-baseline","auto"),f.setAttribute("opacity","0.3"),f.textContent=`${h}s`,n.appendChild(f)}}const r=u.state.tempo;if(r<=0||i<=0)return;const a=30/r;let c=0;for(let h=a;h<i;h+=a){const m=h/i*e,f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",m),f.setAttribute("y1",0),f.setAttribute("x2",m),f.setAttribute("y2",s);const v=(c+1)%2===0;f.setAttribute("stroke",v?"#adb5bd":"#ced4da"),f.setAttribute("stroke-width",v?"1":"0.5"),f.setAttribute("stroke-dasharray","3,3"),n.appendChild(f),c++}}function u_(n,e,s,{height:i,width:r},a,c,h){for(;n.firstChild;)n.removeChild(n.firstChild);for(;e.firstChild;)e.removeChild(e.firstChild);if(s.length===0)return;const m=u.state.colorPalette[a]||{primary:a,light:a},f=m.primary,v=m.light;let y={time:0,feedback:0},w={decay:0,roomSize:0};window.effectsCoordinator&&(y=window.effectsCoordinator.getEffectParameters(a,"delay"),w=window.effectsCoordinator.getEffectParameters(a,"reverb")),h&&h.clearRect(0,0,r,i);const x=(F,H=1)=>{if(!h||w.decay===0||w.roomSize===0||!c)return;const Q=w.decay/100*5*(r/c),K=w.roomSize/100*H;h.filter="blur(30px)";const pt=parseInt(v.slice(1,3),16),ut=parseInt(v.slice(3,5),16),_t=parseInt(v.slice(5,7),16),xt=60;for(let Zt=0;Zt<xt;Zt++){const Wt=Zt/xt,Jt=(Zt+1)/xt,it=F[1].y+(F[3].y-F[1].y)*Wt,rt=F[1].y+(F[3].y-F[1].y)*Jt,at=F[1].x+(F[3].x-F[1].x)*Wt,Tt=F[1].x+(F[3].x-F[1].x)*Jt,dt=h.createLinearGradient(at,it,at+Q,it);dt.addColorStop(0,`rgba(${pt}, ${ut}, ${_t}, ${K})`),dt.addColorStop(1,`rgba(${pt}, ${ut}, ${_t}, 0)`),h.fillStyle=dt,h.beginPath(),h.moveTo(at,it),h.lineTo(at+Q,it),h.lineTo(Tt+Q,rt),h.lineTo(Tt,rt),h.closePath(),h.fill()}h.filter="none"};if(x(s,1),y.time>0&&y.feedback>0&&c){const F=Math.max(.01,y.time/100*.5),H=Math.min(.95,y.feedback/100),Q=.05;let K=H,pt=0;for(;K>Q&&pt<10;){pt++;const ut=F*pt/c*r,_t=s.map(xt=>({x:xt.x+ut,y:xt.y}));if(_t[0].x<r){x(_t,K);const xt=document.createElementNS("http://www.w3.org/2000/svg","polygon"),Zt=`${_t[0].x},${i} `+_t.map(Jt=>`${Jt.x},${Jt.y}`).join(" ")+` ${Math.min(_t[3].x,r)},${i}`;xt.setAttribute("points",Zt),xt.setAttribute("fill",Gs(v,.7*K)),xt.setAttribute("class","delay-echo"),n.appendChild(xt);const Wt=document.createElementNS("http://www.w3.org/2000/svg","polyline");Wt.setAttribute("points",_t.map(Jt=>`${Jt.x},${Jt.y}`).join(" ")),Wt.setAttribute("stroke-width",2),Wt.setAttribute("fill","none"),Wt.setAttribute("stroke",Gs(f,K)),Wt.setAttribute("class","delay-echo"),n.appendChild(Wt)}K*=H}}const A=document.createElementNS("http://www.w3.org/2000/svg","polygon"),E=`0,${i} `+s.map(F=>`${F.x},${F.y}`).join(" ")+` ${r},${i}`;A.setAttribute("points",E),A.setAttribute("fill",Gs(v,.7)),n.appendChild(A);const M=document.createElementNS("http://www.w3.org/2000/svg","line");M.setAttribute("x1",s[0].x),M.setAttribute("y1",s[0].y),M.setAttribute("x2",s[1].x),M.setAttribute("y2",s[1].y),M.setAttribute("stroke",f),M.setAttribute("stroke-width",2),n.appendChild(M);const I=document.createElementNS("http://www.w3.org/2000/svg","line");I.setAttribute("x1",s[1].x),I.setAttribute("y1",s[1].y),I.setAttribute("x2",s[2].x),I.setAttribute("y2",s[2].y),I.setAttribute("stroke",f),I.setAttribute("stroke-width",2),n.appendChild(I);const R=w.decay>0&&w.roomSize>0?Math.max(.3,1-w.decay/100*(w.roomSize/100)*.7):1,D=document.createElementNS("http://www.w3.org/2000/svg","line");D.setAttribute("x1",s[2].x),D.setAttribute("y1",s[2].y),D.setAttribute("x2",s[3].x),D.setAttribute("y2",s[3].y),D.setAttribute("stroke",Gs(f,R)),D.setAttribute("stroke-width",2),n.appendChild(D);const G=["attack-node","decay-sustain-node","release-node"];[s[1],s[2],s[3]].forEach((F,H)=>{const Q=document.createElementNS("http://www.w3.org/2000/svg","circle");Q.setAttribute("id",G[H]),Q.setAttribute("class","adsr-node"),Q.setAttribute("cx",F.x),Q.setAttribute("cy",F.y),Q.setAttribute("r",8),Q.setAttribute("fill",f),Q.setAttribute("stroke",Ua(f,-.3)),Q.setAttribute("stroke-width",2),Q.style.cursor="grab";const K=document.createElementNS("http://www.w3.org/2000/svg","title");Q.appendChild(K),e.appendChild(Q)})}function d_(n,e){const s=Ua(e,-.2);n.style.setProperty("--c-accent",e),n.style.setProperty("--c-accent-hover",s)}const Ce={};let xn=null,hi=!1;function p_(n,e){const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("data-playhead-id",n);const i=document.createElementNS("http://www.w3.org/2000/svg","line");i.setAttribute("stroke",e),i.setAttribute("stroke-width",2),i.setAttribute("stroke-dasharray","3,3"),s.appendChild(i);const r=document.createElementNS("http://www.w3.org/2000/svg","circle");return r.setAttribute("r",5),r.setAttribute("fill",e),s.appendChild(r),s}function m_(n,e,s,i=null){if(!(!xn||!i)){if(e==="attack"){Ce[n]&&(cancelAnimationFrame(Ce[n].requestId),Ce[n].group.remove());const r=p_(n,s);xn.playheadLayer.appendChild(r),Ce[n]={group:r,phase:e,color:s,adsr:i,requestId:null,startTimestamp:U.now(),elapsed:0},Vh(n)}else if(e==="release"){if(hi)return;const r=Ce[n];if(!r)return;cancelAnimationFrame(r.requestId),r.phase="release",r.adsr=i,r.startTimestamp=U.now(),r.elapsed=0,Gh(n)}}}function Vh(n){if(!Ce[n]||hi)return;const e=Ce[n];if(!e.adsr)return;const{attack:s,decay:i}=e.adsr,r=xn.calculateEnvelopePoints(e.adsr);if(r.length<4)return;const[a,c,h]=r,m=U.now()-e.startTimestamp;e.elapsed=m;const f=s+i,v=Math.min(m,f);let y,w;if(v<=s){const E=s>0?v/s:1;y=a.x+E*(c.x-a.x),w=a.y+E*(c.y-a.y)}else{const E=v-s,M=i>0?E/i:1;y=c.x+M*(h.x-c.x),w=c.y+M*(h.y-c.y)}const[x,A]=e.group.children;x.setAttribute("x1",y),x.setAttribute("y1",0),x.setAttribute("x2",y),x.setAttribute("y2",xn.height),A.setAttribute("cx",y),A.setAttribute("cy",w),v<f?e.requestId=requestAnimationFrame(()=>Vh(n)):(e.phase="sustain",Hh(n))}function Hh(n){if(!Ce[n]||hi)return;const e=Ce[n];if(!e.adsr)return;const s=xn.calculateEnvelopePoints(e.adsr);if(s.length<4)return;const[,,i]=s,[r,a]=e.group.children;r.setAttribute("x1",i.x),r.setAttribute("y1",0),r.setAttribute("x2",i.x),r.setAttribute("y2",xn.height),a.setAttribute("cx",i.x),a.setAttribute("cy",i.y),e.requestId=requestAnimationFrame(()=>Hh(n))}function Gh(n){if(!Ce[n]||hi)return;const e=Ce[n];if(!e.adsr)return;const{release:s}=e.adsr,i=xn.calculateEnvelopePoints(e.adsr);if(i.length<4)return;const[,,r,a]=i,c=U.now()-e.startTimestamp;e.elapsed=c;const h=Math.min(c,s),m=s>0?h/s:1,f=r.x+m*(a.x-r.x),v=r.y+m*(a.y-r.y),[y,w]=e.group.children;y.setAttribute("x1",f),y.setAttribute("y1",0),y.setAttribute("x2",f),y.setAttribute("y2",xn.height),w.setAttribute("cx",f),w.setAttribute("cy",v),h<s?e.requestId=requestAnimationFrame(()=>Gh(n)):(e.group.remove(),delete Ce[n])}function f_(){hi=!0;for(const n in Ce){const e=Ce[n];e.requestId&&(cancelAnimationFrame(e.requestId),e.requestId=null)}}function g_(){hi=!1;for(const n in Ce){const e=Ce[n];e.startTimestamp=U.now()-e.elapsed,e.phase==="attack"?Vh(n):e.phase==="sustain"?Hh(n):e.phase==="release"&&Gh(n)}}function v_(){hi=!1;for(const n in Ce){const e=Ce[n];cancelAnimationFrame(e.requestId),e.group.remove()}for(const n in Ce)delete Ce[n]}function y_(n){return xn=n,{trigger:m_,pause:f_,resume:g_,clearAll:v_}}const Am=2.5;class b_{constructor(){var e;this.ui=o_.init(),this.currentColor=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=y_(this),Ss.adsrComponent=this,c_(this),this.listenForStoreChanges(),this.initControls(),this.ui.container&&new ResizeObserver(()=>this.resize()).observe(this.ui.container),this.updateFromStore(),this.updateComponentWidth(u.state.adsrComponentWidth),S.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const e=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*e,this.reverbCanvas.height=this.height*e,this.reverbCtx.scale(e,e)}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const e=u.state.timbres[this.currentColor];e&&({attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release}=e.adsr,this.render(),this.updateControls())}getCurrentMaxTime(){return Am*u.state.adsrTimeAxisScale}updateComponentWidth(e){if(this.ui.parentContainer){const i=.5+u.state.adsrTimeAxisScale*.2,r=e*i;this.ui.parentContainer.style.setProperty("width",`${r}%`,"important"),this.resize()}}updateTimeScaleWidth(){const e=u.state.adsrComponentWidth;this.updateComponentWidth(e)}initControls(){const e=document.getElementById("adsr-time-scale"),s=document.getElementById("adsr-time-scale-value");e&&s&&(e.value=u.state.adsrTimeAxisScale,s.textContent=`${u.state.adsrTimeAxisScale}x`,e.addEventListener("input",a=>{const c=parseFloat(a.target.value);u.setAdsrTimeAxisScale(c),s.textContent=`${c}x`}));const i=document.getElementById("adsr-width-scale"),r=document.getElementById("adsr-width-scale-value");i&&r&&(i.value=u.state.adsrComponentWidth,r.textContent=`${u.state.adsrComponentWidth}%`,i.addEventListener("input",a=>{const c=parseInt(a.target.value);u.setAdsrComponentWidth(c),r.textContent=`${c}%`}))}listenForStoreChanges(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.updateFromStore())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.updateFromStore()}),u.on("tempoChanged",()=>this.render()),u.on("adsrTimeAxisScaleChanged",e=>{this.render(),this.updateSliders(),this.updateTimeScaleWidth()}),u.on("adsrComponentWidthChanged",e=>{this.updateComponentWidth(e)}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{e&&e.includes(this.currentColor)&&this.render()}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e?s?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),u.on("audioEffectChanged",({effectType:e,color:s})=>{s===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(e=this){var A;const{attack:s,decay:i,sustain:r,release:a}=e;if(!this.width||!this.height)return[];const c=E=>E/this.getCurrentMaxTime()*this.width;let h=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(h=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const m=((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)??1,f=m*h;S.debug("AdsrComponent","[ADSR] Amplitude calculation",{originalAmplitude:m,tremoloMultiplier:h,normalizedAmplitude:f});const v={x:0,y:this.height},y={x:c(s),y:this.height*(1-f)},w={x:c(s+i),y:this.height*(1-Math.min(r*f,f))},x={x:c(s+i+a),y:this.height};return[v,y,w,x]}render(){if(!this.ui||!this.width||!this.height)return;const e={width:this.width,height:this.height},s=this.calculateEnvelopePoints(),i=this.getCurrentMaxTime();h_(this.gridLayer,e,i),u_(this.envelopeLayer,this.nodeLayer,s,e,this.currentColor,i,this.reverbCtx),d_(this.ui.parentContainer,this.currentColor)}updateControls(){var E;if(!this.ui.sustainThumb)return;let e=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(e=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const i=(((E=window.staticWaveformVisualizer)==null?void 0:E.calculatedAmplitude)||1)*e,r=i*100;if(this.sustain>i){const M=u.state.timbres[this.currentColor];u.setADSR(this.currentColor,{...M.adsr,sustain:i}),this.sustain=i}const a=this.sustain*100;this.ui.sustainThumb.style.bottom=`${a}%`,this.ui.sustainTrack.style.setProperty("--sustain-progress",`${a}%`);const c=100-r;this.ui.sustainTrack.style.setProperty("--ineligible-height",`${c}%`);const h=this.attack/this.getCurrentMaxTime()*100,m=(this.attack+this.decay)/this.getCurrentMaxTime()*100,f=(this.attack+this.decay+this.release)/this.getCurrentMaxTime()*100;this.ui.thumbA.style.left=`${h}%`,this.ui.thumbD.style.left=`${m}%`,this.ui.thumbR.style.left=`${f}%`,this.ui.multiSliderContainer.style.setProperty("--adr-progress",`${f}%`);const v=M=>`${M.toFixed(3)}s`,y=M=>`${(M*100).toFixed(0)}%`;this.ui.thumbA.title=`Attack: ${v(this.attack)}`,this.ui.thumbD.title=`Decay: ${v(this.decay)}`,this.ui.thumbR.title=`Release: ${v(this.release)}`,this.ui.sustainThumb.title=`Sustain: ${y(this.sustain)}`;const w=this.nodeLayer.querySelector("#attack-node > title");w&&(w.textContent=`Attack: ${v(this.attack)}`);const x=this.nodeLayer.querySelector("#decay-sustain-node > title");x&&(x.textContent=`Decay: ${v(this.decay)}
Sustain: ${y(this.sustain)}`);const A=this.nodeLayer.querySelector("#release-node > title");A&&(A.textContent=`Release: ${v(this.release)}`)}}function w_(){return document.getElementById("adsr-envelope")?new b_:null}function fh(n,...e){}let Ki,ro,Wn,ao,Ws,to,ii,gh=!1,vh=!1,yh=!1,js;const Wa=1,Mm=31,Em=0,Va=2;function $c(){if(!js)return;const n=u.state.timbres[js];if(!n)return;n.filter?n.filter.enabled===void 0&&(n.filter.enabled=!0):n.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0};const{cutoff:e,blend:s,mix:i}=n.filter;if(Ki&&ro){const r=(Va-s)/(Va-Em);Ki.style.left=`${r*100}%`,ro.style.setProperty("--progress",`${r*100}%`)}if(to&&ii){const r=(i||0)/100;to.style.bottom=`${r*100}%`,ii.style.setProperty("--blend-progress",`${r*100}%`)}if(Wn&&ao){const r=(e-Wa)/(Mm-Wa);Wn.style.left=`${r*100}%`,Wn.style.top="50%",Wn.style.transform="translate(-50%, -50%)",ao.style.setProperty("--progress",`${r*100}%`)}Ws&&Ws.style.setProperty("--c-accent",js)}function __(n){if(!gh)return;const e=ao.getBoundingClientRect(),s=n.clientX-e.left,i=e.width;let r=s/i;r=Math.max(0,Math.min(1,r));const a=r*(Mm-Wa)+Wa;u.setFilterSettings(js,{cutoff:a})}function x_(n){if(!vh)return;const e=ro.getBoundingClientRect(),s=n.clientX-e.left,i=e.width;let r=s/i;r=Math.max(0,Math.min(1,r));const a=Va-r*(Va-Em);u.setFilterSettings(js,{blend:a})}function S_(n){if(!yh)return;const e=ii.getBoundingClientRect(),s=n.clientY-e.top,i=e.height;let r=1-s/i;r=Math.max(0,Math.min(1,r));const a=r*100;u.setFilterSettings(js,{mix:a})}function C_(){var e;if(Ws=document.querySelector(".filter-container"),Ki=document.getElementById("thumb-b"),ro=document.getElementById("blend-slider-container"),Wn=document.getElementById("thumb-c"),ao=document.getElementById("cutoff-slider-container"),!Ws||!Ki||!Wn){S.error("FilterControls","Missing required elements",{container:Ws,blendThumb:Ki,cutoffThumb:Wn},"filter");return}const n=Ws==null?void 0:Ws.querySelector(".blend-slider-container");n&&ro&&(n.getBoundingClientRect(),ro.getBoundingClientRect()),ao&&ao.getBoundingClientRect(),T_(),Ki.addEventListener("pointerdown",s=>{s.preventDefault(),vh=!0,document.body.style.cursor="ew-resize";const i=a=>{fh("log","[BLEND SLIDER] Moving",{clientX:a.clientX}),x_(a)},r=()=>{vh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",i),window.removeEventListener("pointerup",r),u.recordState()};window.addEventListener("pointermove",i),window.addEventListener("pointerup",r)}),Wn.addEventListener("pointerdown",s=>{s.preventDefault(),gh=!0,document.body.style.cursor="ew-resize";const i=a=>{fh("log","[CUTOFF SLIDER] Moving",{clientX:a.clientX}),__(a)},r=()=>{gh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",i),window.removeEventListener("pointerup",r),u.recordState()};window.addEventListener("pointermove",i),window.addEventListener("pointerup",r)}),u.on("noteChanged",({newNote:s})=>{s.color&&s.color!==js&&(js=s.color,$c())}),u.on("timbreChanged",s=>{s===js&&$c()}),js=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",$c(),setTimeout(()=>{const s=Ws==null?void 0:Ws.querySelector(".blend-slider-container");s&&s.getBoundingClientRect()},100)}function T_(){if(ii=document.getElementById("vertical-blend-track"),to=document.getElementById("vertical-blend-thumb"),!ii||!to){S.error("FilterControls","Vertical blend slider elements not found",null,"filter");return}to.addEventListener("pointerdown",n=>{n.preventDefault(),yh=!0,document.body.style.cursor="ns-resize";const e=i=>{fh("log","[VERTICAL BLEND] Moving",{clientY:i.clientY}),S_(i)},s=()=>{yh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",s),u.recordState()};window.addEventListener("pointermove",e),window.addEventListener("pointerup",s)}),ii.addEventListener("click",n=>{if(n.target===to)return;const e=ii.getBoundingClientRect(),s=n.clientY-e.top,i=e.height;let r=1-s/i;r=Math.max(0,Math.min(1,r));const a=r*100;u.setFilterSettings(js,{mix:a}),u.recordState()})}S.moduleLoaded("DynamicWaveformVisualizer");class A_{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.isPlaybackActive=!1,this.liveAnalysers=new Map,this.liveWaveforms=new Map,this.playbackAnimationId=null,this.animationSpeed=100,this.frameSkipCounter=0,S.info("DynamicWaveformVisualizer","Initialized for live waveform visualization",null,"waveform")}initialize(e,s){var i;return this.canvas=e,this.ctx=s,this.currentColor=((i=u.state.selectedNote)==null?void 0:i.color)||"#4a90e2",this.setupEventListeners(),S.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color)}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e&&!s?this.startLiveVisualization():this.stopLiveVisualization()}),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.startSingleNoteVisualization(e):this.stopLiveVisualization()}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{this.isPlaybackActive&&e&&e.some(s=>this.liveWaveforms.has(s))&&S.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",e,"waveform")}),S.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),S.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(e){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(e),this.updateContainerState(!0),this.animateLiveWaveforms(),S.debug("DynamicWaveformVisualizer",`Started single note visualization for ${e}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1,this.liveAnalysers.forEach((e,s)=>{window.synthEngine&&window.synthEngine.removeWaveformAnalyzer(s)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),S.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(e){var i;const s=(i=this.canvas)==null?void 0:i.parentElement;s&&(e?(s.classList.add("live-mode"),u.state.isPlaying&&!u.state.isPaused&&s.classList.add("pulsing")):s.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const e=window.synthEngine;if(!e){S.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(i=>{const r=e.createWaveformAnalyzer(i);r&&(this.liveAnalysers.set(i,r),this.liveWaveforms.set(i,new Float32Array(1024)),S.debug("DynamicWaveformVisualizer",`Created analyser for ${i}`,null,"waveform"))})}setupSingleAnalyser(e){const s=window.synthEngine;if(!s)return;const i=s.createWaveformAnalyzer(e);i&&(this.liveAnalysers.set(e,i),this.liveWaveforms.set(e,new Float32Array(1024)),S.debug("DynamicWaveformVisualizer",`Created single analyser for ${e}`,null,"waveform"))}getActivePlayingColors(){const e=new Set;u.state.isPlaying&&u.state.placedNotes.forEach(i=>{!i.isDrum&&i.color&&e.add(i.color)}),e.size===0&&this.currentColor&&e.add(this.currentColor);const s=Array.from(e);return S.debug("DynamicWaveformVisualizer","Active playing colors detected",s,"waveform"),s}animateLiveWaveforms(){if(!this.isPlaybackActive)return;this.frameSkipCounter++;const e=Math.floor(100/this.animationSpeed);if(this.frameSkipCounter%e!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((s,i)=>{const r=s.getValue();this.liveWaveforms.set(i,r)}),this.onWaveformUpdate&&this.onWaveformUpdate(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(e,s,i){const r=Array.from(this.liveWaveforms.keys());if(r.length===1){const a=r[0],c=this.liveWaveforms.get(a);this.drawSingleLiveWaveform(c,a,e,s,i)}else r.length>1&&r.forEach((a,c)=>{const h=this.liveWaveforms.get(a);this.drawLayeredLiveWaveform(h,a,e,s,i,r.length)})}drawSingleLiveWaveform(e,s,i,r,a){if(!e||e.length===0)return;let c=a,h=1;window.animationEffectsManager&&s&&(h=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s),c=c*h);let m=0;if(window.animationEffectsManager&&window.animationEffectsManager.vibratoCanvasEffect){const x=window.animationEffectsManager.vibratoCanvasEffect,A=x.animations.get(s);A&&x.shouldBeRunning()&&(m=Math.sin(A.phase)*A.amplitude*.4)}let f=0;for(let x=0;x<e.length;x++)f=Math.max(f,Math.abs(e[x]));const v=f>1?1/f:1;this.ctx.strokeStyle=s,this.ctx.lineWidth=2,this.ctx.beginPath();const w=e.length/i*(1+m);for(let x=0;x<i;x++){const A=m*i*.3,E=x+A,M=Math.floor(E*w),I=Math.max(0,Math.min(e.length-1,M)),R=(e[I]||0)*v,D=r-R*c;x===0?this.ctx.moveTo(x,D):this.ctx.lineTo(x,D)}this.ctx.stroke(),S.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${s} with tremolo and vibrato stretch`,{tremoloMultiplier:c/a,vibratoStretch:m},"waveform")}drawLayeredLiveWaveform(e,s,i,r,a,c){if(!e||e.length===0)return;let h=a;if(window.animationEffectsManager&&s){const E=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s);h=h*E}let m=0;if(window.animationEffectsManager&&window.animationEffectsManager.vibratoCanvasEffect){const E=window.animationEffectsManager.vibratoCanvasEffect,M=E.animations.get(s);M&&E.shouldBeRunning()&&(m=Math.sin(M.phase)*M.amplitude*.4)}let f=0;for(let E=0;E<e.length;E++)f=Math.max(f,Math.abs(e[E]));const v=f>1?1/f:1,y=Math.max(.4,1/c),w=Gs(s,y*2);Gs(s,y*.5),this.ctx.strokeStyle=w,this.ctx.lineWidth=1.5,this.ctx.beginPath();const A=e.length/i*(1+m);for(let E=0;E<i;E++){const M=m*i*.3,I=E+M,R=Math.floor(I*A),D=Math.max(0,Math.min(e.length-1,R)),G=(e[D]||0)*v,X=r-G*h*.7;E===0?this.ctx.moveTo(E,X):this.ctx.lineTo(E,X)}this.ctx.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),S.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}S.moduleLoaded("StaticWaveformVisualizer");class M_{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.animationFrameId=null,this.waveformData=new Float32Array(512),this.isInitialized=!1,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=300,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null,this.dynamicVisualizer=new A_,this.animationSpeed=100,this.frameSkipCounter=0,S.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){var s;if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;this.ctx=this.canvas.getContext("2d"),this.currentColor=((s=u.state.selectedNote)==null?void 0:s.color)||"#4a90e2";const e=this.canvas.parentElement;return e&&new ResizeObserver(()=>this.resize()).observe(e),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const e=this.canvas.parentElement;if(!e)return;const{clientWidth:s,clientHeight:i}=e,r=this.canvas.width,a=this.canvas.height;if((s===0||i===0)&&this.canvas.width>0&&this.canvas.height>0)return;const h=Math.abs(s-r),m=Math.abs(i-a);(h>2||m>2)&&(this.canvas.width=s,this.canvas.height=i,this.draw())}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.generateWaveform())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.generateWaveform()}),u.on("waveformExtendedViewChanged",e=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>{this.resize()},100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const e=document.querySelectorAll(".waveform-speed-btn");e.forEach(s=>{s.addEventListener("click",()=>{const i=parseInt(s.dataset.speed);s.classList.contains("active")?(s.classList.remove("active"),this.setAnimationSpeed(100)):(e.forEach(r=>r.classList.remove("active")),s.classList.add("active"),this.setAnimationSpeed(i))})})}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(e)}setupExtendToggle(){const e=document.getElementById("waveform-extend-toggle");e&&(e.addEventListener("click",()=>{u.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const e=document.getElementById("waveform-extend-toggle");if(e){const s=u.state.waveformExtendedView;e.classList.toggle("extended",s),e.textContent=s?"480 View":"360 View",e.title=s?"Switch to 360 waveform view":"Switch to 480 waveform view (shows extra 120)"}}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const e=u.state.timbres[this.currentColor];if(!e||!e.coeffs)return;const s=qa(this.currentColor),i=e.phases||[],r=this.waveformData.length,a=1,c=[];for(let m=0;m<s.length;m++)s[m]>.001&&c.push(`${m===0?"F0":"H"+(m+1)}: ${s[m].toFixed(3)}`);this.waveformData.fill(0);let h=0;for(let m=0;m<r;m++){const v=(u.state.waveformExtendedView?480:360)/360,y=m/r*v*2*Math.PI;let w=0;for(let x=0;x<ho;x++){const A=s[x]||0;if(A>.001){const E=i[x]||0,M=x+1;w+=A*Math.sin(M*y+E)}}this.waveformData[m]=w*a,h=Math.max(h,Math.abs(w*a))}if(this.calculatedAmplitude=Math.min(1,h),h>1){const m=1/h;for(let f=0;f<this.waveformData.length;f++)this.waveformData[f]*=m}this.draw()}startPhaseTransition(e,s,i){this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(s),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition()}generateTargetWaveform(e){if(!this.currentColor)return;const s=u.state.timbres[this.currentColor];if(!s||!s.coeffs)return;const i=qa(this.currentColor),r=this.waveformData.length,a=1;this.waveformData.fill(0);let c=0;for(let h=0;h<r;h++){const f=(u.state.waveformExtendedView?480:360)/360,v=h/r*f*2*Math.PI;let y=0;for(let w=0;w<ho;w++){const x=i[w]||0;if(x>.001){const A=e[w]||0,E=w+1;y+=x*Math.sin(E*v+A)}}this.waveformData[h]=y*a,c=Math.max(c,Math.abs(y*a))}if(this.calculatedAmplitude=Math.min(1,c),c>1){const h=1/c;for(let m=0;m<this.waveformData.length;m++)this.waveformData[m]*=h}}animateTransition(){if(!this.isTransitioning)return;const e=performance.now()-this.transitionStartTime,s=Math.min(e/this.transitionDuration,1),i=1-Math.pow(1-s,3);for(let r=0;r<this.waveformData.length;r++)this.waveformData[r]=this.fromWaveform[r]+(this.toWaveform[r]-this.fromWaveform[r])*i;this.draw(),s>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let e=0;for(let s=0;s<this.waveformData.length;s++)e=Math.max(e,Math.abs(this.waveformData[s]));if(e>0){const s=.9/e;for(let i=0;i<this.waveformData.length;i++)this.waveformData[i]*=s}}draw(){if(!this.ctx||!this.canvas)return;const{width:e,height:s}=this.canvas,i=s/2,r=s/2;this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,e,s),this.drawGrid(e,s,i,r),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(e,i,r):this.drawWaveform(e,i,r),e>200&&s>100&&this.drawLabels(e,s)}drawGrid(e,s,i,r){this.ctx.strokeStyle="#ced4da",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(e,i),this.ctx.stroke();const a=u.state.waveformExtendedView?480:360;if((u.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(v=>{const y=e/a*v;this.ctx.beginPath(),this.ctx.moveTo(y,0),this.ctx.lineTo(y,s),this.ctx.stroke()}),u.state.waveformExtendedView){const v=e/480*360;this.ctx.fillStyle="rgba(128, 128, 128, 0.15)",this.ctx.fillRect(v,0,e-v,s)}[.5].forEach(v=>{const y=i-r*v,w=i+r*v;this.ctx.beginPath(),this.ctx.moveTo(0,y),this.ctx.lineTo(e,y),this.ctx.moveTo(0,w),this.ctx.lineTo(e,w),this.ctx.stroke()}),this.ctx.setLineDash([]),this.ctx.strokeStyle="#999999",this.ctx.lineWidth=1;const m=i-r,f=i+r;this.ctx.beginPath(),this.ctx.moveTo(0,m),this.ctx.lineTo(e,m),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,f),this.ctx.lineTo(e,f),this.ctx.stroke()}drawWaveform(e,s,i){if(this.waveformData.length===0)return;const r=this.currentColor||"#4A90E2";this.ctx.strokeStyle=r,this.ctx.lineWidth=2,this.ctx.beginPath();const a=this.waveformData.length/e;for(let h=0;h<e;h++){const m=Math.floor(h*a),f=this.waveformData[m]||0,v=s-f*i;h===0?this.ctx.moveTo(h,v):this.ctx.lineTo(h,v)}this.ctx.stroke(),this.ctx.lineTo(e,s),this.ctx.lineTo(0,s),this.ctx.closePath();const c=this.ctx.createLinearGradient(0,s-i,0,s+i);c.addColorStop(0,Gs(r,.3)),c.addColorStop(.5,Gs(r,.1)),c.addColorStop(1,Gs(r,.3)),this.ctx.fillStyle=c,this.ctx.fill()}drawLabels(e,s){this.ctx.fillStyle="#666666",this.ctx.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.ctx.textAlign="center";const i=u.state.waveformExtendedView?480:360,r=u.state.waveformExtendedView?["0","90","180","270","360","450"]:["0","90","180","270","360"],a=u.state.waveformExtendedView?[0,90,180,270,360,450]:[0,90,180,270,360];r.forEach((c,h)=>{const m=e/i*a[h]+10;this.ctx.fillText(c,m,s/2+4)}),this.ctx.textAlign="left",this.ctx.fillText("+1.0",5,15),this.ctx.fillText("-1.0",5,s-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const e=this.calculatedAmplitude||0;if(window.animationEffectsManager&&this.currentColor){const s=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor);return e*s}return e}startSingleNoteVisualization(e){return this.dynamicVisualizer.startSingleNoteVisualization(e)}stopLiveVisualization(){return this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){return this.dynamicVisualizer.startLiveVisualization()}dispose(){this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const Pm=new M_;window.staticWaveformVisualizer=Pm;function E_(){return Pm.initialize()}class km{constructor(e){this.effectName=e,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,S.info(`${e}AnimationEffect`,"Base initialized",null,"animation")}initBase(){u.on("visualEffectChanged",({effectType:e,parameter:s,value:i,color:r,effectParams:a})=>{e===this.effectName.toLowerCase()&&this.updateAnimationParameters(r,a)}),u.on("playbackStarted",()=>{this.isPlaybackActive=!0,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteInteractionStart",({noteId:e,color:s})=>this.onNoteInteractionStart(e,s)),u.on("noteInteractionEnd",({noteId:e})=>this.onNoteInteractionEnd(e)),u.on("ghostNoteUpdated",({color:e})=>this.onGhostNoteUpdated(e)),u.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.isPlaybackActive=!0:this.isPlaybackActive=!1,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteAttack",({noteId:e,color:s})=>this.onNoteAttack(e,s)),u.on("noteRelease",({noteId:e,color:s})=>this.onNoteRelease(e,s)),u.on("effectDialInteractionStart",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionStart(s)}),u.on("effectDialInteractionEnd",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionEnd(s)}),S.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}updateAnimationParameters(e,s){throw new Error("updateAnimationParameters must be implemented by subclass")}updateAnimationPhases(e){throw new Error("updateAnimationPhases must be implemented by subclass")}shouldAnimateColor(e){return!!this.animations.get(e)}shouldAnimateNote(e){if(!this.shouldAnimateColor(e.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const i=this.activeNoteAnimations.get("dial-preview");if(e.color===i)return!0}return!!(this.isPlaybackActive&&e.uuid&&this.activeSoundingNotes.has(e.uuid)||this.hasActiveInteraction&&e.uuid&&this.activeNoteAnimations.has(e.uuid)||!e.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===e.color&&this.isPlaybackActive)}shouldBeRunning(){const e=this.animations.size>0;return e?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||e:!1}onNoteInteractionStart(e,s){this.shouldAnimateColor(s)&&(this.activeNoteAnimations.set(e,s),this.hasActiveInteraction=!0,S.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${e} (${s})`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteInteractionEnd(e){this.activeNoteAnimations.delete(e),this.hasActiveInteraction=this.activeNoteAnimations.size>0,S.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onGhostNoteUpdated(e){this.shouldAnimateColor(e)?(this.ghostNoteAnimation={color:e,active:!0},S.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${e}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,S.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(e,s){this.shouldAnimateColor(s)&&(this.activeSoundingNotes.set(e,s),S.debug(`${this.effectName}AnimationEffect`,`Note attack: ${e} (${s}) added to active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteRelease(e,s){this.activeSoundingNotes.delete(e),S.debug(`${this.effectName}AnimationEffect`,`Note release: ${e} (${s}) removed from active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onDialInteractionStart(e){this.shouldAnimateColor(e)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",e),S.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onDialInteractionEnd(e){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),S.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}getActiveColors(){const e=new Set;for(const[s,i]of this.activeSoundingNotes.entries())this.shouldAnimateColor(i)&&e.add(i);for(const[s,i]of this.activeNoteAnimations.entries())this.shouldAnimateColor(i)&&e.add(i);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&e.add(this.ghostNoteAnimation.color),Array.from(e)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,S.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}}S.moduleLoaded("VibratoCanvasEffect");class P_ extends km{constructor(){super("Vibrato"),S.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),S.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(e,s){const{speed:i,span:r}=s;if(i===0||r===0)this.animations.delete(e),S.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${e}`,null,"animation");else{const a=this.animations.get(e),c=i/100*16,h=r/100*.5,m={frequency:c,amplitude:h,phase:(a==null?void 0:a.phase)||0,lastUpdate:performance.now()};this.animations.set(e,m),S.debug("VibratoCanvasEffect",`Updated vibrato animation for ${e}`,{frequency:c,amplitude:h,preservedPhase:!!a},"animation")}}updateAnimationPhases(e){this.animations.forEach((s,i)=>{const r=(e-s.lastUpdate)/1e3;s.phase+=s.frequency*r*2*Math.PI,s.lastUpdate=e,s.phase>4*Math.PI&&(s.phase-=4*Math.PI)})}getVibratoYOffset(e){const s=this.animations.get(e);if(!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning())return 0;const i=Math.sin(s.phase),r=-i*s.amplitude;return S.debug("VibratoCanvasEffect","Visual vibrato",{sine:i.toFixed(3),offset:r.toFixed(3),phase:s.phase.toFixed(3)},"effects"),r}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.amplitude>0:!1}dispose(){this.disposeBase(),S.info("VibratoCanvasEffect","Disposed",null,"animation")}}S.moduleLoaded("TremoloWaveformEffect");class k_ extends km{constructor(){super("Tremolo"),S.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),S.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(e,s){var a;const{speed:i,span:r}=s;if(i===0||r===0)this.animations.delete(e),S.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${e}`,null,"animation");else{const c=this.animations.get(e),h=i/100*16,m=r/100,f={frequency:h,span:m,phase:(c==null?void 0:c.phase)||0,lastUpdate:(a=window.Tone)!=null&&a.now?window.Tone.now()*1e3:performance.now()};this.animations.set(e,f),S.debug("TremoloWaveformEffect",`Updated tremolo animation for ${e}`,{frequency:h,span:m,preservedPhase:!!c},"animation")}}updateAnimationPhases(e){var r,a,c;let s=0;const i=(r=window.Tone)!=null&&r.now?window.Tone.now()*1e3:e;if(this.animations.forEach((h,m)=>{const f=(i-h.lastUpdate)/1e3,v=h.phase;h.phase+=h.frequency*f*2*Math.PI,h.lastUpdate=i,s++,Math.abs(h.phase-v)<.001&&S.warn("TremoloWaveformEffect",`Phase not advancing for ${m}`,{deltaSeconds:Number(f.toFixed(4)),frequency:h.frequency},"animation"),h.phase>4*Math.PI&&(h.phase-=4*Math.PI)}),s>0&&Math.random()<.05){const h=(a=window.Tone)!=null&&a.now?"Tone.js":"performance";S.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!((c=window.Tone)!=null&&c.now),toneTime:i,currentTime:e,timingSource:h},"animation")}}getTremoloAmplitudeMultiplier(e){var A,E;const s=this.animations.get(e);if(!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const i=((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)||1,r=Math.sin(s.phase),a=s.span,c=i,h=i*(1-a),m=(c+h)/2,f=(c-h)/2,y=(m+r*f)/i,x=(((E=window.Tone)==null?void 0:E.now())*1e3||performance.now())-s.lastUpdate;if(x>100&&s.span>0){const M=s.frequency*(x/1e3)*2*Math.PI;M>.1&&S.warn("TremoloWaveformEffect",`Phase stagnation detected for ${e}`,{phase:Number(s.phase.toFixed(3)),millisecondsSinceUpdate:Number(x.toFixed(1)),expectedAdvancement:Number(M.toFixed(3))},"animation")}return Math.max(0,Math.min(1,y))}getADSRTremoloAmplitudeMultiplier(e){return this.getTremoloAmplitudeMultiplier(e)}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.span>0:!1}dispose(){this.disposeBase(),S.info("TremoloWaveformEffect","Disposed",null,"animation")}}S.moduleLoaded("EnvelopeFillEffect");class I_{constructor(){this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),S.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){u.on("noteAttack",({noteId:e,color:s})=>{const i=u.state.timbres[s];if(!i){S.warn("EnvelopeFillEffect","No timbre found for color",{color:s},"effects");return}this.activeFills.set(e,{fillLevel:0,color:s,startTime:U.now(),adsr:i.adsr,phase:"attack"}),S.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteRelease",({noteId:e,color:s})=>{const i=this.activeFills.get(e);i?(i.phase="release",i.releaseStartTime=U.now(),i.releaseStartLevel=i.fillLevel,S.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):S.warn("EnvelopeFillEffect","No fill data found for release",{noteId:e},"effects")}),u.on("playbackStopped",()=>{this.activeFills.clear(),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState(),u.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),S.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(e){const s=U.now();for(const[i,r]of this.activeFills.entries()){const{adsr:a,startTime:c,phase:h,releaseStartTime:m,releaseStartLevel:f}=r,v=s-c;if(h==="attack"){const y=a.attack||.01;v<y?r.fillLevel=v/y:(r.phase="decay",r.decayStartTime=s)}else if(h==="decay"){const y=a.decay||.1,w=s-r.decayStartTime,x=a.sustain!==void 0?a.sustain:.5;if(w<y){const A=w/y;r.fillLevel=1-A*(1-x)}else r.phase="sustain",r.fillLevel=x}else if(h==="sustain"){const y=a.sustain!==void 0?a.sustain:.5;r.fillLevel=y}else if(h==="release"){const y=a.release||.5,w=s-m;if(w<y){const x=w/y;r.fillLevel=f*(1-x)}else this.activeFills.delete(i),S.debug("EnvelopeFillEffect",`Completed fill animation for note ${i}`,null,"animation"),this.activeFills.size===0&&window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}}}getFillLevel(e){if(!e.uuid)return 0;const s=this.activeFills.get(e.uuid);return s?s.fillLevel:0}shouldFillNote(e){return e.uuid?this.activeFills.has(e.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),S.info("EnvelopeFillEffect","Disposed",null,"animation")}}S.moduleLoaded("AnimationEffectsManager");class R_{constructor(){this.vibratoEffect=new P_,this.tremoloEffect=new k_,this.envelopeFillEffect=new I_,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,S.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),u.on("visualEffectChanged",({effectType:e,parameter:s,value:i,color:r})=>{(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),S.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(e){this.isRunning&&(this.lastTime=e,this.vibratoEffect.updateAnimationPhases(e),this.tremoloEffect.updateAnimationPhases(e),this.envelopeFillEffect.updateAnimationPhases(e),this.triggerVisualUpdates(e),this.animationFrameId=requestAnimationFrame(s=>this.animate(s)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)),S.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),S.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const s=this.tremoloEffect.activeSoundingNotes.size>0,i=this.tremoloEffect.hasDialInteraction;return s||i}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const e=this.shouldVibratoBeRunning(),s=this.shouldTremoloBeRunning(),i=this.shouldEnvelopeFillBeRunning(),r=e||s||i;r&&!this.isRunning?this.start():!r&&this.isRunning&&this.stop()}triggerVisualUpdates(e){if(!this.lastRenderTrigger||e-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=e;const s=this.vibratoEffect.getActiveColors(),i=this.tremoloEffect.getActiveColors(),r=this.envelopeFillEffect.activeFills.size>0;(s.length>0||r)&&u.emit("animationUpdate",{type:s.length>0?"vibrato":"envelopeFill",activeColors:s,hasEnvelopeFills:r}),i.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:i})}}triggerFinalUpdates(){const e=Array.from(this.vibratoEffect.animations.keys());e.length>0&&u.emit("animationUpdate",{type:"vibrato",activeColors:e});const s=Array.from(this.tremoloEffect.animations.keys());s.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:s})}shouldAnimateNote(e){return this.vibratoEffect.shouldAnimateNote(e)}getVibratoYOffset(e){return this.vibratoEffect.getVibratoYOffset(e)}getTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getTremoloAmplitudeMultiplier(e)}getADSRTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(e)}getFillLevel(e){return this.envelopeFillEffect.getFillLevel(e)}shouldFillNote(e){return this.envelopeFillEffect.shouldFillNote(e)}triggerTremoloAmplitudeUpdate(){const e=this.tremoloEffect.getActiveColors();e.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:e})}getAllActiveColors(){const e=this.vibratoEffect.getActiveColors(),s=this.tremoloEffect.getActiveColors();return[...new Set([...e,...s])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),S.info("AnimationEffectsManager","Disposed",null,"animation")}}const ip=new R_;S.moduleLoaded("VibratoAudioEffect");class D_{constructor(){this.currentSettings=new Map,S.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return S.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:i,span:r}=e;this.currentSettings.set(s,{speed:i,span:r}),S.debug("VibratoAudioEffect",`Updated parameters for ${s}`,{speed:i,span:r},"audio")}applyToVoice(e,s){if(!e||!e._setVibrato)return;const i=this.currentSettings.get(s);if(!i){S.debug("VibratoAudioEffect",`No vibrato settings found for color ${s}`,null,"audio");return}try{e._setVibrato(i),e.vibratoApplied=!0,S.debug("VibratoAudioEffect",`Applied vibrato to voice for ${s}`,i,"audio")}catch(r){S.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createVibratoSettings(e,s){if(e===0||s===0)return null;const i=e/100*16,r=s/100*50;return{frequency:i,depth:r}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),S.info("VibratoAudioEffect","Disposed",null,"audio")}}S.moduleLoaded("TremoloAudioEffect");class O_{constructor(){this.currentSettings=new Map,S.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return S.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:i,span:r}=e;this.currentSettings.set(s,{speed:i,span:r}),S.debug("TremoloAudioEffect",`Updated parameters for ${s}`,{speed:i,span:r},"audio")}applyToVoice(e,s){if(!e||!e._setTremolo)return;const i=this.currentSettings.get(s);if(!i){S.debug("TremoloAudioEffect",`No tremolo settings found for color ${s}`,null,"audio");return}try{e._setTremolo(i),e.tremoloApplied=!0,S.debug("TremoloAudioEffect",`Applied tremolo to voice for ${s}`,i,"audio")}catch(r){S.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createTremoloSettings(e,s){if(e===0||s===0)return null;const i=e/100*16,r=s/100;return{frequency:i,depth:r}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),S.info("TremoloAudioEffect","Disposed",null,"audio")}}S.moduleLoaded("ReverbAudioEffect");class N_{constructor(){this.currentSettings=new Map,this.reverbInstances=new Map,S.info("ReverbAudioEffect","Initialized",null,"audio")}init(){return S.info("ReverbAudioEffect","Ready for audio processing",null,"audio"),!0}async updateParameters(e,s){const{decay:i,roomSize:r,wet:a=10}=e;this.currentSettings.set(s,{decay:i,roomSize:r,wet:a}),S.debug("ReverbAudioEffect",`Updated parameters for ${s}`,{decay:i,roomSize:r,wet:a},"audio");let c=this.reverbInstances.get(s);c?this.updateReverbInstance(c,i,r,a):(i>0||r>0)&&(c=await this.createReverbInstance(i,r,a),c&&(this.reverbInstances.set(s,c),S.debug("ReverbAudioEffect",`Created new reverb instance for ${s}`,{decay:i,roomSize:r,wet:a},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}async applyToVoice(e,s){if(!e)return;const i=this.currentSettings.get(s);if(!(!i||i.decay===0&&i.roomSize===0))try{let r=this.reverbInstances.get(s);if(r||(r=await this.createReverbInstance(i.decay,i.roomSize,i.wet),this.reverbInstances.set(s,r)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(r)}catch{e.output&&e.output.connect(r)}S.debug("ReverbAudioEffect",`Applied reverb to voice for ${s}`,i,"audio")}catch(r){S.warn("ReverbAudioEffect",`Failed to apply reverb to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{decay:0,roomSize:0}}getEffectInstance(e){return this.getCurrentSettings(e).wet>0?this.reverbInstances.get(e):null}async createReverbInstance(e,s,i=10){if(e===0&&s===0)return null;const r=Math.max(.1,e/100*8),a=1+s/100*1.5,c=r*a,h=i/100,m=new U.Reverb({decay:c,wet:h});return m._wetAmount=h,await m.ready,S.debug("ReverbAudioEffect","Created reverb instance",{decayTime:c,wetAmount:h,roomSize:s},"audio"),m}updateReverbInstance(e,s,i,r=10){if(e)try{const a=Math.max(.1,s/100*8),c=1+i/100*1.5,h=a*c,m=r/100;e.decay=h,e._crossFade&&(e._crossFade.fade.value=m),e._wetAmount=m,S.debug("ReverbAudioEffect","Updated reverb instance",{decayTime:h,wetAmount:m,roomSize:i},"audio")}catch(a){S.warn("ReverbAudioEffect","Failed to update reverb instance",a,"audio")}}createReverbSettings(e,s,i=25){if(e===0&&s===0)return null;const r=Math.max(.1,e/100*10),a=i/100;return{decay:r,roomSize:s/100,wet:a}}disableForColor(e){this.updateParameters({decay:0,roomSize:0,wet:0},e);const s=this.reverbInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.reverbInstances.delete(e))}dispose(){this.reverbInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(i){S.warn("ReverbAudioEffect",`Failed to dispose reverb for ${s}`,i,"audio")}}),this.currentSettings.clear(),this.reverbInstances.clear(),S.info("ReverbAudioEffect","Disposed",null,"audio")}}S.moduleLoaded("DelayAudioEffect");class L_{constructor(){this.currentSettings=new Map,this.delayInstances=new Map,S.info("DelayAudioEffect","Initialized",null,"audio")}init(){return S.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{time:i,feedback:r,wet:a=15}=e;this.currentSettings.set(s,{time:i,feedback:r,wet:a}),S.debug("DelayAudioEffect",`Updated parameters for ${s}`,{time:i,feedback:r,wet:a},"audio");let c=this.delayInstances.get(s);c?this.updateDelayInstance(c,i,r,a):(i>0||r>0)&&(c=this.createDelayInstance(i,r,a),c&&(this.delayInstances.set(s,c),S.debug("DelayAudioEffect",`Created new delay instance for ${s}`,{time:i,feedback:r,wet:a},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}applyToVoice(e,s){if(!e)return;const i=this.currentSettings.get(s);if(!(!i||i.time===0&&i.feedback===0))try{let r=this.delayInstances.get(s);if(r||(r=this.createDelayInstance(i.time,i.feedback,i.wet),this.delayInstances.set(s,r)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(r)}catch{e.output&&e.output.connect(r)}S.debug("DelayAudioEffect",`Applied delay to voice for ${s}`,i,"audio")}catch(r){S.warn("DelayAudioEffect",`Failed to apply delay to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{time:0,feedback:0}}getEffectInstance(e){const s=this.getCurrentSettings(e);return s.time>0&&s.wet>0?this.delayInstances.get(e):null}createDelayInstance(e,s,i=30){if(e===0&&s===0)return null;const r=Math.max(.01,e/100*.5),a=Math.min(.95,s/100),c=i/100,h=new U.FeedbackDelay({delayTime:r,feedback:a,wet:c});return h._wetAmount=c,S.debug("DelayAudioEffect","Created delay instance",{delayTime:r,feedbackAmount:a,wetAmount:c},"audio"),h}updateDelayInstance(e,s,i,r=15){if(e)try{const a=Math.max(.01,s/100*.5),c=Math.min(.95,i/100),h=r/100;e.delayTime.value=a,e.feedback.value=c,e._crossFade&&(e._crossFade.fade.value=h),e._wetAmount=h,S.debug("DelayAudioEffect","Updated delay instance",{delayTime:a,feedbackAmount:c,wetAmount:h},"audio")}catch(a){S.warn("DelayAudioEffect","Failed to update delay instance",a,"audio")}}createDelaySettings(e,s,i=30){if(e===0&&s===0)return null;const r=Math.max(.01,e/100*.5),a=Math.min(.95,s/100),c=i/100;return{delayTime:r,feedback:a,wet:c}}disableForColor(e){this.updateParameters({time:0,feedback:0,wet:0},e);const s=this.delayInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.delayInstances.delete(e))}dispose(){this.delayInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(i){S.warn("DelayAudioEffect",`Failed to dispose delay for ${s}`,i,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),S.info("DelayAudioEffect","Disposed",null,"audio")}}S.moduleLoaded("AudioEffectsManager");class F_{constructor(){this.vibratoEffect=new D_,this.tremoloEffect=new O_,this.reverbEffect=new N_,this.delayEffect=new L_,S.info("AudioEffectsManager","Initialized with audio effect handlers",null,"audio")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.reverbEffect.init(),this.delayEffect.init(),u.on("audioEffectChanged",({effectType:e,parameter:s,value:i,color:r,effectParams:a})=>{this.handleAudioEffectChange(e,s,i,r,a)}),S.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(e,s,i,r,a){switch(S.debug("AudioEffectsManager",`Processing audio effect: ${e}.${s} = ${i} for ${r}`,null,"audio"),e){case"vibrato":this.vibratoEffect.updateParameters(a,r);break;case"tremolo":this.tremoloEffect.updateParameters(a,r);break;case"reverb":this.reverbEffect.updateParameters(a,r);break;case"delay":this.delayEffect.updateParameters(a,r);break;default:S.debug("AudioEffectsManager",`Effect type ${e} not handled by audio system`,null,"audio")}}getEffectHandler(e){switch(e){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"reverb":return this.reverbEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(e,s,i){const r=this.reverbEffect.getEffectInstance(s),a=this.delayEffect.getEffectInstance(s);this.reverbEffect.getCurrentSettings(s),this.delayEffect.getCurrentSettings(s);try{e.disconnect()}catch{}let c=e;if(r)try{r.disconnect(),c.connect(r),c=r}catch{}if(a)try{a.disconnect(),c.connect(a),c=a}catch{}try{if(c.connect(i),window.synthEngine){const h=window.synthEngine.getWaveformAnalyzer(s);h&&e.connect(h)}}catch{}}applyEffectsToVoice(e,s){this.vibratoEffect.applyToVoice(e,s),this.tremoloEffect.applyToVoice(e,s)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.reverbEffect.dispose(),this.delayEffect.dispose(),S.info("AudioEffectsManager","Disposed",null,"audio")}}const op=new F_;S.moduleLoaded("EffectsCoordinator");class B_{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0},tremolo:{speed:0,span:0},reverb:{decay:0,roomSize:0},delay:{time:0,feedback:0}},S.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(u.state.timbres).forEach(e=>{this.initializeColorEffects(e)}),u.on("timbreCreated",({color:e})=>{this.initializeColorEffects(e)}),this.loadSavedValues(),S.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(e){if(!this.effectParameters.has(e)){const s={};Object.entries(this.defaultEffects).forEach(([r,a])=>{s[r]={...a}}),this.effectParameters.set(e,s);const i=u.state.timbres[e];i&&(i.vibrato&&(s.vibrato={...i.vibrato}),i.tremelo&&(s.tremolo={...i.tremelo})),S.debug("EffectsCoordinator",`Initialized effects for color ${e}`,s,"effects")}}updateParameter(e,s,i,r){if(!r){S.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:e,parameter:s,value:i},"effects");return}this.initializeColorEffects(r);const a=this.effectParameters.get(r);a[e]||(a[e]={...this.defaultEffects[e]}),a[e][s],a[e][s]=i,this.notifyAudioSystem(e,s,i,r,a[e]),this.notifyAnimationSystem(e,s,i,r,a[e]),this.updateTimbreState(e,a[e],r),this.saveValues()}notifyAudioSystem(e,s,i,r,a){u.emit("audioEffectChanged",{effectType:e,parameter:s,value:i,color:r,effectParams:{...a}}),S.debug("EffectsCoordinator",`Notified audio system: ${e}.${s} = ${i} for ${r}`,null,"effects")}notifyAnimationSystem(e,s,i,r,a){(e==="vibrato"||e==="tremolo")&&(u.emit("visualEffectChanged",{effectType:e,parameter:s,value:i,color:r,effectParams:{...a}}),S.debug("EffectsCoordinator",`Notified animation system: ${e}.${s} = ${i} for ${r}`,null,"effects"))}updateTimbreState(e,s,i){const r=u.state.timbres[i];if(!r)return;const c={vibrato:"vibrato",tremolo:"tremelo"}[e];c&&(r[c]||(r[c]={}),Object.assign(r[c],s),u.recordState())}getEffectParameters(e,s){const i=this.effectParameters.get(e);return!i||!i[s]?{...this.defaultEffects[s]}:{...i[s]}}getAllEffectParameters(e){const s=this.effectParameters.get(e);return s?{...s}:{...this.defaultEffects}}resetColorEffects(e){const s={};Object.entries(this.defaultEffects).forEach(([i,r])=>{s[i]={...r}}),this.effectParameters.set(e,s),Object.keys(s).forEach(i=>{Object.keys(s[i]).forEach(r=>{this.notifyAudioSystem(i,r,s[i][r],e,s[i]),this.notifyAnimationSystem(i,r,s[i][r],e,s[i])})}),S.info("EffectsCoordinator",`Reset all effects for color ${e}`,s,"effects")}saveValues(){const e={};Object.keys(u.state.timbres).forEach(s=>{const i=this.effectParameters.get(s);i&&(e[s]={vibrato:i.vibrato||{speed:0,span:0},tremelo:i.tremolo||{speed:0,span:0},reverb:i.reverb||{decay:0,roomSize:0},delay:i.delay||{time:0,feedback:0}})});try{localStorage.setItem("effectDialValues",JSON.stringify(e)),S.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(s){S.warn("EffectsCoordinator","Failed to save effect values to localStorage",s,"effects")}}loadSavedValues(){try{const e=localStorage.getItem("effectDialValues");if(!e){S.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const s=JSON.parse(e);S.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(s).forEach(i=>{const r=u.state.timbres[i],a=s[i];r&&a&&(a.vibrato&&Object.entries(a.vibrato).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("vibrato",c,h,i)}),a.tremelo&&Object.entries(a.tremelo).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("tremolo",c,h,i)}),a.reverb&&Object.entries(a.reverb).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("reverb",c,h,i)}),a.delay&&Object.entries(a.delay).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("delay",c,h,i)}))}),S.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(s).forEach(i=>{const r=s[i];(r.reverb&&(r.reverb.decay>0||r.reverb.roomSize>0)||r.delay&&(r.delay.time>0||r.delay.feedback>0))&&(window.synthEngine.updateSynthForColor(i),S.debug("EffectsCoordinator",`Re-applied effects to synth for ${i}`,null,"effects"))})}catch(e){S.warn("EffectsCoordinator","Failed to load saved effect values",e,"effects")}}dispose(){this.effectParameters.clear(),S.info("EffectsCoordinator","Disposed",null,"effects")}}const wr=new B_;class q_{constructor(){this.currentEffect=null,this.effectControlsContainer=null,this.effectButtons=[],this.dials=[],this.currentColor=null,this.isDialInteractionActive=!1,this.effectConfigs={reverb:{name:"Reverb",controls:{decay:{label:"Time",min:0,max:100,default:0,unit:"%"},roomSize:{label:"Size",min:0,max:100,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:10,unit:"%"}}},delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}}}init(){return S.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),!this.effectControlsContainer||this.effectButtons.length===0?(S.initFailed("Effects Controller","Required DOM elements not found"),!1):(this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),S.initSuccess("Effects Controller"),!0)}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(e=>{e.addEventListener("click",s=>{const i=s.target.dataset.effect;this.selectEffect(i)})})}selectEffect(e){if(S.debug("Effects",`Selecting effect: ${e}`,null,"ui"),!this.effectConfigs[e]){S.info("Effects",`Effect ${e} not configured`,null,"ui");return}if(this.effectButtons.forEach(s=>{s.classList.remove("active"),s.dataset.effect===e&&s.classList.add("active")}),this.currentEffect===e){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=e,this.showEffectControls(e)}showEffectControls(e){const s=this.effectConfigs[e];if(!s){S.warn("Effects",`No configuration found for effect: ${e}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const i=this.effectControlsContainer.querySelector(".effect-controls");Object.entries(s.controls).forEach(([r,a])=>{const c=this.currentColor?wr.getEffectParameters(this.currentColor,e):null,h=(c==null?void 0:c[r])||0,m=document.createElement("div");m.className="effect-slider-group",m.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",i.appendChild(m);const f=document.createElement("label");f.className="effect-slider-label",f.textContent=a.label,f.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",m.appendChild(f);const v=document.createElement("input");v.type="range",v.min=a.min,v.max=a.max,v.value=h,v.className="effect-slider",v.style.cssText="width: 100%; margin: 5px 0;",m.appendChild(v);const y=document.createElement("div");y.className="effect-slider-value";const w=a.unit?`${Math.round(h)}${a.unit}`:Math.round(h);y.textContent=w,y.style.cssText="text-align: center; font-size: 12px; color: #666;",m.appendChild(y),this.dials.push({dial:{element:v,value:h,destroy:()=>{}},control:r,effectType:e,valueDisplay:y,controlConfig:a});const x=A=>{const E=parseFloat(A.target.value),M=a.unit?`${Math.round(E)}${a.unit}`:Math.round(E);y.textContent=M,S.debug("Effects",`${e} ${r}: ${E}`,null,"audio"),this.onEffectParameterChange(e,r,E)};v.addEventListener("mousedown",A=>{this.onDialInteractionStart(e)}),v.addEventListener("mouseup",A=>{this.onDialInteractionEnd(e)}),v.addEventListener("mouseleave",A=>{A.buttons}),v.addEventListener("touchstart",A=>{this.onDialInteractionStart(e)}),v.addEventListener("touchend",A=>{this.onDialInteractionEnd(e)}),v.addEventListener("input",x),v.addEventListener("change",x)}),this.effectControlsContainer.classList.add("active")}hideEffectControls(){this.clearControls(),this.effectControlsContainer.classList.remove("active"),this.effectControlsContainer.innerHTML="",this.effectButtons.forEach(e=>e.classList.remove("active"))}clearControls(){this.dials.forEach(({dial:e})=>{e.destroy&&e.destroy()}),this.dials=[]}onEffectParameterChange(e,s,i){var a;S.debug("Effects",`Effect parameter changed: ${e}.${s} = ${i}`,null,"audio");const r=(a=u.state.selectedNote)==null?void 0:a.color;if(!r){S.warn("Effects","Cannot update effect parameter: no color selected",{effectType:e,parameter:s,value:i},"audio");return}wr.updateParameter(e,s,i,r),u.emit("effectParameterChanged",{effectType:e,parameter:s,value:i,color:r})}onDialInteractionStart(e){var i;if(this.isDialInteractionActive||e!=="vibrato"&&e!=="tremolo")return;this.isDialInteractionActive=!0;const s=(i=u.state.selectedNote)==null?void 0:i.color;if(!s){S.debug("Effects","Dial interaction started but no color selected",null,"ui");return}u.emit("effectDialInteractionStart",{effectType:e,color:s}),S.debug("Effects",`Dial interaction started for ${e} on ${s}`,null,"ui")}onDialInteractionEnd(e){var i;if(!this.isDialInteractionActive)return;this.isDialInteractionActive=!1;const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&(u.emit("effectDialInteractionEnd",{effectType:e,color:s}),S.debug("Effects",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}getCurrentEffect(){return this.currentEffect}getEffectParameters(e){var r;if(!this.effectConfigs[e])return null;const s=(r=u.state.selectedNote)==null?void 0:r.color;if(!s)return null;if(window.effectsCoordinator)return window.effectsCoordinator.getEffectParameters(s,e);const i={};return this.dials.forEach(({dial:a,control:c,effectType:h})=>{h===e&&(i[c]=parseFloat(a.element.value))}),i}initializeSelectedColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("selectedNoteChanged",()=>{var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s!==this.currentColor&&(this.currentColor=s,this.updateEffectButtonIndicators())}),u.on("audioEffectChanged",()=>{this.updateEffectButtonIndicators()}),this.updateEffectButtonIndicators()}updateEffectButtonIndicators(){!this.effectButtons||!this.currentColor||this.effectButtons.forEach(e=>{const s=e.getAttribute("data-effect");let i=!1;const r=wr.getEffectParameters(this.currentColor,s);switch(s){case"vibrato":i=r.speed>0&&r.span>0;break;case"tremolo":i=r.speed>0&&r.span>0;break;case"reverb":i=r.roomSize>0||r.decay>0||r.wet>0&&(r.roomSize>0||r.decay>0);break;case"delay":i=r.time>0||r.feedback>0||r.wet>0&&(r.time>0||r.feedback>0);break}i?(e.style.backgroundColor=this.currentColor,e.style.color="white",e.classList.add("effect-active")):(e.style.backgroundColor="",e.style.color="",e.classList.remove("effect-active"))})}}const qn=new q_;class $_{constructor(e,s={}){if(this._root=typeof e=="string"?document.querySelector(e):e,!this._root)throw new Error("Position: target not found");const{size:i=[200,200],mode:r="absolute",x:a=.5,minX:c=0,maxX:h=1,stepX:m=0,y:f=.5,minY:v=0,maxY:y=1,stepY:w=0}=s;this._events=new Map,this._emit=(I,R)=>{const D=this._events.get(I);if(D)for(const G of D)G(R)};class x{constructor(R,D,G,X){this.min=R,this.max=D,this.step=G,this.value=0,this.update(X)}update(R){const D=Math.min(this.max,Math.max(this.min,R));if(!this.step||this.step<=0)return this.value=D,this.value;const G=Math.round((D-this.min)/this.step)*this.step+this.min;return this.value=Math.min(this.max,Math.max(this.min,parseFloat(G.toFixed(12)))),this.value}updateNormal(R){const D=this.max-this.min||1;return this.update(this.min+D*Math.min(1,Math.max(0,R)))}get normalized(){const R=this.max-this.min||1;return(this.value-this.min)/R}}class A{constructor(R,D,G,X){this.mode=R,this.orient=D,this._xr=G.slice(),this._yr=X.slice(),this.value=.5,this._anchorN=.5}resize(R,D){this._xr=R.slice(),this._yr=D.slice()}set anchor(R){this._anchorN=this._posToNorm(R)}update(R){if(this.mode==="absolute")this.value=this._posToNorm(R);else{const D=this._posToNorm(R),G=D-this._anchorN;this.value=E(this.value+G),this._anchorN=D}this.value=E(this.value)}_posToNorm(R){if(this.orient==="horizontal"){const D=this._xr[1]-this._xr[0]||1;return E((R.x-this._xr[0])/D)}else{const D=this._yr[1]-this._yr[0]||1;return E(1-(R.y-this._yr[0])/D)}}}const E=I=>Math.min(1,Math.max(0,I));this._x=new x(c,h,m,a),this._y=new x(v,y,w,f),this._w=Math.max(10,Math.floor(i[0])),this._h=Math.max(10,Math.floor(i[1])),this._mode=r==="relative"?"relative":"absolute",this._hX=new A(this._mode,"horizontal",[0,this._w],[0,this._h]),this._hY=new A(this._mode,"vertical",[0,this._w],[0,this._h]),this._hX.value=this._x.normalized,this._hY.value=this._y.normalized,this._style={bg:"rgba(74, 144, 226, 0.1)",grid:"#dee2e6",cross:"#6c757d",handle:"#4A90E2",text:"#212529"},this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._svg.style.display="block",this._svg.style.touchAction="none",this._root.innerHTML="",this._root.appendChild(this._svg),this._bg=document.createElementNS(this._svg.namespaceURI,"rect"),this._bg.setAttribute("x",0),this._bg.setAttribute("y",0),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h),this._bg.setAttribute("fill",this._style.bg),this._svg.appendChild(this._bg),this._grid=document.createElementNS(this._svg.namespaceURI,"g"),this._grid.setAttribute("stroke",this._style.grid),this._grid.setAttribute("stroke-width","1");const M=[.25,.5,.75];for(const I of M){const R=document.createElementNS(this._svg.namespaceURI,"line");R.setAttribute("x1",this._w*I),R.setAttribute("y1",0),R.setAttribute("x2",this._w*I),R.setAttribute("y2",this._h),this._grid.appendChild(R);const D=document.createElementNS(this._svg.namespaceURI,"line");D.setAttribute("x1",0),D.setAttribute("y1",this._h*I),D.setAttribute("x2",this._w),D.setAttribute("y2",this._h*I),this._grid.appendChild(D)}this._svg.appendChild(this._grid),this._xh=document.createElementNS(this._svg.namespaceURI,"line"),this._yh=document.createElementNS(this._svg.namespaceURI,"line");for(const I of[this._xh,this._yh])I.setAttribute("stroke",this._style.cross),I.setAttribute("stroke-width","2"),this._svg.appendChild(I);this._knob=document.createElementNS(this._svg.namespaceURI,"circle"),this._knob.setAttribute("r",Math.max(4,Math.min(this._w,this._h)*.04)),this._knob.setAttribute("fill",this._style.handle),this._svg.appendChild(this._knob),this._clicked=!1,this._onDown=this._onDown.bind(this),this._onMove=this._onMove.bind(this),this._onUp=this._onUp.bind(this),this._svg.addEventListener("pointerdown",this._onDown),window.addEventListener("pointerup",this._onUp),window.addEventListener("pointercancel",this._onUp),this._draw()}on(e,s){return this._events.has(e)||this._events.set(e,new Set),this._events.get(e).add(s),()=>this.off(e,s)}off(e,s){const i=this._events.get(e);i&&i.delete(s)}get x(){return this._x.value}set x(e){const s=this._x.value;this._x.update(e),this._hX.value=this._x.normalized,this._x.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get y(){return this._y.value}set y(e){const s=this._y.value;this._y.update(e),this._hY.value=this._y.normalized,this._y.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get minX(){return this._x.min}set minX(e){this._x.min=e,this.x=this._x.value}get maxX(){return this._x.max}set maxX(e){this._x.max=e,this.x=this._x.value}get stepX(){return this._x.step}set stepX(e){this._x.step=e,this.x=this._x.value}get minY(){return this._y.min}set minY(e){this._y.min=e,this.y=this._y.value}get maxY(){return this._y.max}set maxY(e){this._y.max=e,this.y=this._y.value}get stepY(){return this._y.step}set stepY(e){this._y.step=e,this.y=this._y.value}get mode(){return this._mode}set mode(e){this._mode=e==="relative"?"relative":"absolute",this._hX.mode=this._mode,this._hY.mode=this._mode}get normalized(){return{x:this._x.normalized,y:this._y.normalized}}resize(e,s){for(this._w=Math.max(10,Math.floor(e)),this._h=Math.max(10,Math.floor(s)),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._hX.resize([0,this._w],[0,this._h]),this._hY.resize([0,this._w],[0,this._h]),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h);this._grid.firstChild;)this._grid.removeChild(this._grid.firstChild);const i=[.25,.5,.75];for(const r of i){const a=document.createElementNS(this._svg.namespaceURI,"line");a.setAttribute("x1",this._w*r),a.setAttribute("y1",0),a.setAttribute("x2",this._w*r),a.setAttribute("y2",this._h),this._grid.appendChild(a);const c=document.createElementNS(this._svg.namespaceURI,"line");c.setAttribute("x1",0),c.setAttribute("y1",this._h*r),c.setAttribute("x2",this._w),c.setAttribute("y2",this._h*r),this._grid.appendChild(c)}this._draw()}destroy(){this._svg.removeEventListener("pointerdown",this._onDown),window.removeEventListener("pointerup",this._onUp),window.removeEventListener("pointercancel",this._onUp),window.removeEventListener("pointermove",this._onMove),this._root&&this._root.contains(this._svg)&&this._root.removeChild(this._svg),this._events.clear()}colorize(e){Object.assign(this._style,e||{}),this._bg.setAttribute("fill",this._style.bg),this._xh.setAttribute("stroke",this._style.cross),this._yh.setAttribute("stroke",this._style.cross),this._knob.setAttribute("fill",this._style.handle),this._label&&this._label.setAttribute("fill",this._style.text),this._grid.setAttribute("stroke",this._style.grid),this._draw()}_localPoint(e){const s=this._svg.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}}_onDown(e){var i,r;(r=(i=this._svg).setPointerCapture)==null||r.call(i,e.pointerId),this._clicked=!0;const s=this._localPoint(e);this._mode==="absolute"?(this._hX.update(s),this._hY.update(s),this._batchSetFromHandles()):(this._hX.anchor=s,this._hY.anchor=s),window.addEventListener("pointermove",this._onMove,{passive:!1}),this._emit("down",{x:this._x.value,y:this._y.value}),e.preventDefault()}_onMove(e){if(!this._clicked)return;const s=this._localPoint(e);this._hX.update(s),this._hY.update(s),this._batchSetFromHandles(),e.preventDefault()}_onUp(){this._clicked&&(this._clicked=!1,window.removeEventListener("pointermove",this._onMove),this._emit("up",{x:this._x.value,y:this._y.value}))}_batchSetFromHandles(){const e=this._hX.value,s=this._hY.value,i=this._x.updateNormal(e),r=this._y.updateNormal(s);(i!==void 0||r!==void 0)&&this._emit("change",{x:this._x.value,y:this._y.value}),this._draw()}_draw(){const e=(this._w-1)*this._x.normalized,s=(this._h-1)*(1-this._y.normalized);this._xh.setAttribute("x1",e),this._xh.setAttribute("y1",0),this._xh.setAttribute("x2",e),this._xh.setAttribute("y2",this._h),this._yh.setAttribute("x1",0),this._yh.setAttribute("y1",s),this._yh.setAttribute("x2",this._w),this._yh.setAttribute("y2",s),this._knob.setAttribute("cx",e),this._knob.setAttribute("cy",s)}}S.moduleLoaded("PositionEffectsController");class z_{constructor(){this.positions={},this.currentColor=null,this.resizeObservers=[],this.effectConfigs={reverb:{containerId:"reverb-position",xParam:"decay",yParam:"roomSize",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1}},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}}},this.colorMappings={"#4a90e2":{bg:"rgba(74, 144, 226, 0.1)",handle:"#4a90e2",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#2d2d2d":{bg:"rgba(45, 45, 45, 0.1)",handle:"#2d2d2d",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#d66573":{bg:"rgba(214, 101, 115, 0.1)",handle:"#d66573",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#68a03f":{bg:"rgba(104, 160, 63, 0.1)",handle:"#68a03f",grid:"#dee2e6",cross:"#6c757d",text:"#212529"}},S.info("PositionEffectsController","Initialized",null,"ui")}init(){return S.initStart("Position Effects Controller"),Object.entries(this.effectConfigs).forEach(([e,s])=>{this.createPositionComponent(e,s)}),this.initializeColorTracking(),this.updateColorsForCurrentSelection(),S.initSuccess("Position Effects Controller"),!0}createPositionComponent(e,s){const i=document.getElementById(s.containerId);if(!i){S.warn("PositionEffectsController",`Container not found for ${e}`,{containerId:s.containerId},"ui");return}try{const[r,a]=this.getPositionComponentSize(i),c=new $_(i,{size:[r,a],mode:"absolute",x:s.xRange.min,minX:s.xRange.min,maxX:s.xRange.max,stepX:s.xRange.step,y:s.yRange.min,minY:s.yRange.min,maxY:s.yRange.max,stepY:s.yRange.step});this.positions[e]=c,this.observePositionResize(i,c,r,a),c.on("change",({x:h,y:m})=>{this.onPositionChange(e,s.xParam,h,s.yParam,m)}),c.on("down",()=>{this.onDialInteractionStart(e)}),c.on("up",()=>{this.onDialInteractionEnd(e)}),this.loadInitialValues(e,s,c),S.debug("PositionEffectsController",`Created Position component for ${e}`,null,"ui")}catch(r){S.error("PositionEffectsController",`Failed to create Position component for ${e}`,r,"ui")}}getPositionComponentSize(e){const i=e.getBoundingClientRect();let r=(i==null?void 0:i.width)||e.clientWidth||e.offsetWidth||120,a=(i==null?void 0:i.height)||e.clientHeight||e.offsetHeight||r;return(!r||r<10)&&(r=120),(!a||a<10)&&(a=r),[Math.round(r),Math.round(a)]}observePositionResize(e,s,i,r){if(typeof ResizeObserver>"u")return;const a={currentWidth:Math.round(i)||0,currentHeight:Math.round(r)||0},c=new ResizeObserver(h=>{for(const m of h){const{width:f,height:v}=m.contentRect,y=Math.round(f),w=Math.round(v||f);!y||!w||y===a.currentWidth&&w===a.currentHeight||(a.currentWidth=y,a.currentHeight=w,s.resize(y,w))}});c.observe(e),this.resizeObservers.push(c)}loadInitialValues(e,s,i){var c;const r=(c=u.state.selectedNote)==null?void 0:c.color;if(!r){const h=s.xRange.min,m=s.yRange.min;i.x=h,i.y=m,S.debug("PositionEffectsController",`Set default values for ${e} (no color selected)`,{x:h,y:m},"ui");return}const a=qn.getEffectParameters?qn.getEffectParameters(e):null;if(a){const h=a[s.xParam]!==void 0?a[s.xParam]:s.xRange.min,m=a[s.yParam]!==void 0?a[s.yParam]:s.yRange.min;i.x=h,i.y=m,S.debug("PositionEffectsController",`Loaded values for ${e} color ${r}`,{x:h,y:m},"ui")}else{const h=s.xRange.min,m=s.yRange.min;i.x=h,i.y=m,S.debug("PositionEffectsController",`Set default values for ${e} (no effect params)`,{x:h,y:m},"ui")}}transformValue(e){return e<=1,e}isInOffZone(e,s){return e<=1&&s<=1}transformPositionValues(e,s){if(this.isInOffZone(e,s))return{x:e,y:s};const i=e<=1?Math.max(1,e):e,r=s<=1?Math.max(1,s):s;return{x:i,y:r}}onPositionChange(e,s,i,r,a){var m;if(!((m=u.state.selectedNote)==null?void 0:m.color)){S.warn("PositionEffectsController","No color selected for position change",{effectType:e,xParam:s,xValue:i,yParam:r,yValue:a},"ui");return}const h=this.transformPositionValues(i,a);S.debug("PositionEffectsController",`Position changed: ${e} ${s}=${i}->${h.x}, ${r}=${a}->${h.y}`,null,"ui"),qn.onEffectParameterChange(e,s,h.x),qn.onEffectParameterChange(e,r,h.y)}initializeColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("noteChanged",()=>{var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s!==this.currentColor&&(this.currentColor=s,this.updateColorsForCurrentSelection(),this.updatePositionValuesForColor())}),u.on("effectParameterChanged",({effectType:s,parameter:i,value:r,color:a})=>{S.debug("PositionEffectsController",`Effect parameter changed: ${s}.${i} = ${r} for ${a}`,null,"ui"),a===this.currentColor&&this.syncPositionFromEffects(s,i,r)}),u.on("audioEffectChanged",({effectType:s,parameter:i,value:r,color:a})=>{S.debug("PositionEffectsController",`Audio effect changed: ${s}.${i} = ${r} for ${a}`,null,"ui"),a===this.currentColor&&this.syncPositionFromEffects(s,i,r)})}updateColorsForCurrentSelection(){if(!this.currentColor||!this.colorMappings[this.currentColor])return;const e=this.colorMappings[this.currentColor];Object.values(this.positions).forEach(s=>{s&&s.colorize&&s.colorize(e)}),S.debug("PositionEffectsController",`Applied color theme for ${this.currentColor}`,e,"ui")}updatePositionValuesForColor(){this.currentColor&&Object.entries(this.effectConfigs).forEach(([e,s])=>{const i=this.positions[e];if(!i)return;const r=qn.getEffectParameters?qn.getEffectParameters(e):null;if(r){const a=r[s.xParam]!==void 0?r[s.xParam]:s.xRange.min,c=r[s.yParam]!==void 0?r[s.yParam]:s.yRange.min;i.x=a,i.y=c}})}syncPositionFromEffects(e,s,i){const r=this.positions[e],a=this.effectConfigs[e];!r||!a||(s===a.xParam?r.x=i:s===a.yParam&&(r.y=i),S.debug("PositionEffectsController",`Synced ${e}.${s} = ${i} from effects`,null,"ui"))}getPositionValues(e){const s=this.positions[e];return s?{x:s.x,y:s.y,normalized:s.normalized}:null}testPositionComponents(){S.info("PositionEffectsController","Testing Position components...",null,"ui"),Object.entries(this.positions).forEach(([e,s])=>{s?S.info("PositionEffectsController",`${e} Position component:`,{x:s.x,y:s.y,normalized:s.normalized},"ui"):S.warn("PositionEffectsController",`${e} Position component not found`,null,"ui")}),S.info("PositionEffectsController",`Current color: ${this.currentColor}`,null,"ui"),this.positions.vibrato&&(S.info("PositionEffectsController","Testing vibrato position change...",null,"ui"),this.positions.vibrato.x=75,this.positions.vibrato.y=50)}testDeadZoneElimination(){S.info("PositionEffectsController","Testing dead zone elimination...",null,"ui"),[{x:0,y:0,description:"Origin (should stay 0,0 - effect off)"},{x:.5,y:.5,description:"Inside off zone (should stay 0.5,0.5 - effect off)"},{x:1,y:1,description:"Edge of off zone (should stay 1,1 - effect off)"},{x:0,y:50,description:"X in dead zone (should become 1,50 - effect on)"},{x:50,y:0,description:"Y in dead zone (should become 50,1 - effect on)"},{x:.5,y:75,description:"X in dead zone (should become 1,75 - effect on)"},{x:25,y:.8,description:"Y in dead zone (should become 25,1 - effect on)"},{x:50,y:75,description:"Both normal (should stay 50,75 - effect on)"}].forEach(s=>{const i=this.transformPositionValues(s.x,s.y),r=this.isInOffZone(s.x,s.y);S.info("PositionEffectsController",`Test: ${s.description}`,{input:{x:s.x,y:s.y},output:i,inOffZone:r},"ui")})}onDialInteractionStart(e){var i;if(e!=="vibrato"&&e!=="tremolo")return;const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&(u.emit("effectDialInteractionStart",{effectType:e,color:s}),S.debug("PositionEffectsController",`Dial interaction started for ${e} on ${s}`,null,"ui"))}onDialInteractionEnd(e){var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&(u.emit("effectDialInteractionEnd",{effectType:e,color:s}),S.debug("PositionEffectsController",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}destroy(){Object.values(this.positions).forEach(e=>{e&&e.destroy&&e.destroy()}),this.positions={},this.resizeObservers.forEach(e=>e.disconnect()),this.resizeObservers=[],S.info("PositionEffectsController","Destroyed",null,"ui")}}const rp=new z_;async function W_(){w_(),Xb(),C_(),S.initStart("Static Waveform Visualizer"),E_()?S.initSuccess("Static Waveform Visualizer"):S.initFailed("Static Waveform Visualizer"),S.initStart("Effects Managers"),ip.init(),op.init(),wr.init(),qn.init(),rp.init(),window.effectsCoordinator=wr,window.animationEffectsManager=ip,window.audioEffectsManager=op,window.effectsController=qn,window.positionEffectsController=rp,S.initSuccess("Effects Managers")}function V_(){H_(),G_()}function H_(){const n=document.querySelectorAll(".rhythm-tab-button"),e=document.querySelectorAll(".rhythm-tab-panel");!n.length||!e.length||n.forEach(s=>{s.addEventListener("click",()=>{const i=s.getAttribute("data-rhythm-tab");n.forEach(a=>a.classList.remove("active")),e.forEach(a=>a.classList.remove("active")),s.classList.add("active");const r=document.getElementById(`${i}-panel`);r&&r.classList.add("active")})})}function G_(){const n=document.getElementById("flat-toggle-btn"),e=document.getElementById("sharp-toggle-btn"),s=document.getElementById("hz-toggle-btn");if(!n||!e||!s)return;let i=n.classList.contains("active"),r=e.classList.contains("active");s.addEventListener("click",()=>{s.classList.contains("active")?(s.classList.remove("active"),s.setAttribute("aria-pressed","false"),n.classList.toggle("active",i),n.setAttribute("aria-pressed",i),e.classList.toggle("active",r),e.setAttribute("aria-pressed",r),u.state.showFrequencyLabels=!1):(i=n.classList.contains("active"),r=e.classList.contains("active"),s.classList.add("active"),s.setAttribute("aria-pressed","true"),n.classList.remove("active"),n.setAttribute("aria-pressed","false"),e.classList.remove("active"),e.setAttribute("aria-pressed","false"),u.state.showFrequencyLabels=!0),u.emit("layoutConfigChanged")}),n.addEventListener("click",()=>{s.classList.contains("active")&&(s.classList.remove("active"),s.setAttribute("aria-pressed","false"),u.state.showFrequencyLabels=!1);const c=!n.classList.contains("active");n.classList.toggle("active",c),n.setAttribute("aria-pressed",c),i=c,u.emit("layoutConfigChanged")}),e.addEventListener("click",()=>{s.classList.contains("active")&&(s.classList.remove("active"),s.setAttribute("aria-pressed","false"),u.state.showFrequencyLabels=!1);const c=!e.classList.contains("active");e.classList.toggle("active",c),e.setAttribute("aria-pressed",c),r=c,u.emit("layoutConfigChanged")})}class j_{constructor(){this.gridsWrapper=null,this.pitchGridWrapper=null,this.drumGridWrapper=null,this.isInitialized=!1,this.isScrolling=!1,this.lastScrollTime=0,this.pendingSync=null}init(){if(this.gridsWrapper=document.getElementById("grids-wrapper"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),!this.gridsWrapper||!this.pitchGridWrapper||!this.drumGridWrapper){S.error("ScrollSyncService","Required elements not found for scroll sync",null,"scroll");return}this.setupScrollSynchronization(),this.isInitialized=!0,S.info("ScrollSyncService","Initialized with unified grids-wrapper structure",null,"scroll")}setupScrollSynchronization(){this.gridsWrapper.addEventListener("scroll",e=>{const s=Date.now();s-this.lastScrollTime<10||(this.lastScrollTime=s,S.debug("ScrollSyncService",`Unified scroll: ${e.target.scrollLeft}px`,null,"scroll"))})}syncScrollTo(e){!this.isInitialized||!this.gridsWrapper||(this.isScrolling=!0,this.gridsWrapper.scrollLeft=e,setTimeout(()=>{this.isScrolling=!1},10))}}const X_=new j_;async function U_(){const n=St.init();return Dh.setContexts(n),X_.init(),n}const bh=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function Y_(n){if(n===0||!n)return"#888888";const e=Math.round(n)%12;return bh[e]}function Z_(n){if(n===0||!n)return lo("#888888");const e=Math.floor(n),s=n-e;if(s<0||s>=1)return Y_(n);const i=e%12,r=(i+1)%12,a=lo(bh[i]),c=lo(bh[r]);return Q_(a,c,s)}function lo(n){const e=parseInt(n.slice(1),16);return[e>>16&255,e>>8&255,e&255]}function Q_(n,e,s){return n.map((i,r)=>Math.round(i+s*(e[r]-i)))}function Oa(n,e,s){return n===0||!n?lo("#888888"):e==="shapenote"?lo(s||"#4A90E2"):Z_(n)}class J_{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.lastValidPitch=null,this.lastValidPitchTime=0,this.fadeOutDurationMs=100,this.isFading=!1}initialize(){this.canvas=document.getElementById("playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("micPaintStateChanged",e=>this.handlePaintStateChange(e)),u.on("pitchDetected",e=>this.handlePitchDetection(e)),u.on("playbackStateChanged",()=>{u.state.paint.isMicPaintActive}))}handlePaintStateChange(e){const s=document.getElementById("hover-canvas");s&&(s.style.display=e?"none":"block"),e?this.startRendering():this.stopRendering()}handlePitchDetection(e){u.state.paint.isMicPaintActive&&u.state.isPlaying&&!u.state.isPaused&&this.addPaintAtPlayhead(e)}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.paint.isMicPaintActive||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),u.state.isPlaying,u.state.isPaused,u.state.isPlaying&&u.state.isPaused,u.state.isPlaying&&!u.state.isPaused?this.renderMovingPlayhead():this.renderStationaryPlayhead(),this.animationFrameId=requestAnimationFrame(()=>this.render())}renderStationaryPlayhead(){var h,m;const{detectedPitch:e}=u.state.paint,s=performance.now();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.midiToY(e.midi),r=i!==null,a=St.getColumnX(2),c=St.getCanvasWidth();if(r){this.lastValidPitch=e,this.lastValidPitchTime=s,this.isFading=!1;const{colorMode:f}=u.state.paint.paintSettings,v=(h=u.state.selectedNote)==null?void 0:h.color,y=Oa(e.midi,f,v),w=`rgb(${y[0]}, ${y[1]}, ${y[2]})`;this.ctx.strokeStyle=w,this.ctx.globalAlpha=Math.min(e.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=w,this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(a,i),this.ctx.lineTo(c,i),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}else if(this.lastValidPitch&&s-this.lastValidPitchTime<this.fadeOutDurationMs){this.isFading=!0;const f=(s-this.lastValidPitchTime)/this.fadeOutDurationMs,v=this.easeOutCubic(1-f),y=this.midiToY(this.lastValidPitch.midi);if(y!==null){const{colorMode:w}=u.state.paint.paintSettings,x=(m=u.state.selectedNote)==null?void 0:m.color,A=Oa(this.lastValidPitch.midi,w,x),E=`rgb(${A[0]}, ${A[1]}, ${A[2]})`;this.ctx.strokeStyle=E,this.ctx.globalAlpha=v*Math.min(this.lastValidPitch.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=E,this.ctx.shadowBlur=6*v,this.ctx.beginPath(),this.ctx.moveTo(a,y),this.ctx.lineTo(c,y),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}}else this.isFading=!1,this.lastValidPitch=null}easeOutCubic(e){return 1-Math.pow(1-e,3)}renderMovingPlayhead(){var r;const e=this.calculateXFromTime(U.Transport.seconds);if(e===null)return;this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0;const{detectedPitch:s}=u.state.paint,i=this.midiToY(s.midi);if(i!==null){const{colorMode:a}=u.state.paint.paintSettings,c=(r=u.state.selectedNote)==null?void 0:r.color,h=Oa(s.midi,a,c),m=`rgb(${h[0]}, ${h[1]}, ${h[2]})`;this.ctx.fillStyle=m,this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.shadowColor=m,this.ctx.shadowBlur=4,this.ctx.beginPath(),this.ctx.arc(e,i,8,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowBlur=0}}addPaintAtPlayhead(e){if(e.midi===0)return;const s=U.Transport.seconds;jh.addPaintPoint(s,e.midi)}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let i=0;i<u.state.columnWidths.length;i++)this.timeMap[i]=e,e+=u.state.columnWidths[i]*s;this.timeMap.push(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const i=this.timeMap[s],r=this.timeMap[s+1]-i,a=e-i,c=St.getColumnX(s),h=St.getColumnX(s+1)-c;return c+(r>0?a/r*h:0)}return null}midiToY(e){if(e===0)return null;const{fullRowData:s}=u.state;if(!s||s.length===0)return null;const i=Math.min(...s.map(w=>nn(w.toneNote))),r=Math.max(...s.map(w=>nn(w.toneNote)));if(e<24||e>96||e<i||e>r)return null;let a=-1,c=-1,h=-999,m=999;for(let w=0;w<s.length;w++){const x=nn(s[w].toneNote);x<=e&&x>h&&(a=w,h=x),x>=e&&x<m&&(c=w,m=x)}if(h===e){const w=Rt(a,u.state);return Math.max(0,Math.min(w,this.canvas.height))}if(a>=0&&c>=0&&h!==m){const w=Rt(a,u.state),x=Rt(c,u.state),A=(e-h)/(m-h),E=w+(x-w)*A;return Math.max(0,Math.min(E,this.canvas.height))}let f=0,v=Math.abs(nn(s[0].toneNote)-e);for(let w=1;w<s.length;w++){const x=nn(s[w].toneNote),A=Math.abs(x-e);A<v&&(v=A,f=w)}const y=Rt(f,u.state);return Math.max(0,Math.min(y,this.canvas.height))}canvasYToViewportY(e){const s=St.getViewportInfo();return Hs.canvasToViewportY(e,s)}isCanvasYVisible(e){const s=this.canvasYToViewportY(e),i=St.getViewportInfo();return s>=0&&s<=i.viewportHeight}}const wh=new J_;class K_{constructor(){this.canvas=null,this.ctx=null,this.isInitialized=!1,this.animationFrameId=null,this.lastHistoryLength=0}initialize(){if(this.canvas=document.getElementById("pitch-paint-canvas"),!this.canvas){S.error("PaintCanvas","Could not find #pitch-paint-canvas element",null,"paint");return}if(this.ctx=this.canvas.getContext("2d"),!document.getElementById("pitch-canvas-wrapper")){S.error("PaintCanvas","Could not find #pitch-canvas-wrapper element",null,"paint");return}u.on("paintHistoryChanged",()=>this.render()),u.on("layoutConfigChanged",()=>this.resize()),u.on("micPaintStateChanged",s=>{s?this.startRendering():this.stopRendering()}),this.resize(),this.isInitialized=!0}startRendering(){this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>this.animationLoop()))}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animationLoop(){u.state.paint.paintHistory.length!==this.lastHistoryLength&&(this.render(),this.lastHistoryLength=u.state.paint.paintHistory.length),this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}resize(){if(!this.canvas)return;const e=document.getElementById("pitch-canvas-wrapper");setTimeout(()=>{document.getElementById("pitch-grid-container");const s=68,i=u.state.cellHeight||18.35,a=s*(i/2);(this.canvas.width!==e.clientWidth||this.canvas.height!==a)&&(S.debug("PaintCanvas",`Setting pitch-paint-canvas height (DEFERRED): ${this.canvas.height}  ${a}`,null,"paint"),this.canvas.width=e.clientWidth,this.canvas.height=a,this.render())},30)}render(){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=u.state.paint.paintHistory;e.length!==0&&this.renderPaintTrail(e)}renderPaintTrail(e){if(e.length<2)return;const s=e.map(r=>{const a=wh.calculateXFromTime(r.musicalTime),c=wh.midiToY(r.midi);return a===null||c===null?null:{...r,x:a,y:c}}).filter(r=>r!==null);if(s.length<2)return;const i=u.state.paint.paintSettings.opacity/100;this.ctx.globalAlpha=i,this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let r=1;r<s.length;r++){const a=s[r-1],c=s[r];c.timestamp-a.timestamp>200||this.drawPaintSegment(a,c)}this.ctx.globalAlpha=1}drawPaintSegment(e,s){const i=this.ctx.createLinearGradient(e.x,e.y,s.x,s.y);i.addColorStop(0,`rgb(${e.color.join(",")})`),i.addColorStop(1,`rgb(${s.color.join(",")})`),this.ctx.strokeStyle=i,this.ctx.lineWidth=(e.thickness+s.thickness)/2,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}addPaintPoint(e,s){var h;const{colorMode:i}=u.state.paint.paintSettings,r=(h=u.state.selectedNote)==null?void 0:h.color,a=Oa(s,i,r),c={musicalTime:e,midi:s,color:a,timestamp:performance.now(),thickness:u.state.paint.paintSettings.thickness};u.addPaintPoint(c)}clear(){u.clearPaintHistory()}}const jh=new K_;var zc,ap;function tx(){if(ap)return zc;ap=1;function n(e){if(this.size=e|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=e<<1;for(var s=new Array(this.size*2),i=0;i<s.length;i+=2){const f=Math.PI*i/this.size;s[i]=Math.cos(f),s[i+1]=-Math.sin(f)}this.table=s;for(var r=0,a=1;this.size>a;a<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var c=0;c<this._bitrev.length;c++){this._bitrev[c]=0;for(var h=0;h<this._width;h+=2){var m=this._width-h-2;this._bitrev[c]|=(c>>>h&3)<<m}}this._out=null,this._data=null,this._inv=0}return zc=n,n.prototype.fromComplexArray=function(s,i){for(var r=i||new Array(s.length>>>1),a=0;a<s.length;a+=2)r[a>>>1]=s[a];return r},n.prototype.createComplexArray=function(){const s=new Array(this._csize);for(var i=0;i<s.length;i++)s[i]=0;return s},n.prototype.toComplexArray=function(s,i){for(var r=i||this.createComplexArray(),a=0;a<r.length;a+=2)r[a]=s[a>>>1],r[a+1]=0;return r},n.prototype.completeSpectrum=function(s){for(var i=this._csize,r=i>>>1,a=2;a<r;a+=2)s[i-a]=s[a],s[i-a+1]=-s[a+1]},n.prototype.transform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._transform4(),this._out=null,this._data=null},n.prototype.realTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._realTransform4(),this._out=null,this._data=null},n.prototype.inverseTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=1,this._transform4();for(var r=0;r<s.length;r++)s[r]/=this.size;this._out=null,this._data=null},n.prototype._transform4=function(){var s=this._out,i=this._csize,r=this._width,a=1<<r,c=i/a<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<i;h+=c,m++){const M=f[m];this._singleTransform2(h,M,a)}else for(h=0,m=0;h<i;h+=c,m++){const M=f[m];this._singleTransform4(h,M,a)}var v=this._inv?-1:1,y=this.table;for(a>>=2;a>=2;a>>=2){c=i/a<<1;var w=c>>>2;for(h=0;h<i;h+=c)for(var x=h+w,A=h,E=0;A<x;A+=2,E+=a){const M=A,I=M+w,R=I+w,D=R+w,G=s[M],X=s[M+1],F=s[I],H=s[I+1],Q=s[R],K=s[R+1],pt=s[D],ut=s[D+1],_t=G,xt=X,Zt=y[E],Wt=v*y[E+1],Jt=F*Zt-H*Wt,it=F*Wt+H*Zt,rt=y[2*E],at=v*y[2*E+1],Tt=Q*rt-K*at,dt=Q*at+K*rt,Nt=y[3*E],jt=v*y[3*E+1],Bt=pt*Nt-ut*jt,ne=pt*jt+ut*Nt,Xe=_t+Tt,qt=xt+dt,xe=_t-Tt,Ue=xt-dt,Ze=Jt+Bt,Re=it+ne,Qe=v*(Jt-Bt),Te=v*(it-ne),Cs=Xe+Ze,an=qt+Re,Le=Xe-Ze,Sn=qt-Re,ui=xe+Te,di=Ue-Qe,pi=xe-Te,Cn=Ue+Qe;s[M]=Cs,s[M+1]=an,s[I]=ui,s[I+1]=di,s[R]=Le,s[R+1]=Sn,s[D]=pi,s[D+1]=Cn}}},n.prototype._singleTransform2=function(s,i,r){const a=this._out,c=this._data,h=c[i],m=c[i+1],f=c[i+r],v=c[i+r+1],y=h+f,w=m+v,x=h-f,A=m-v;a[s]=y,a[s+1]=w,a[s+2]=x,a[s+3]=A},n.prototype._singleTransform4=function(s,i,r){const a=this._out,c=this._data,h=this._inv?-1:1,m=r*2,f=r*3,v=c[i],y=c[i+1],w=c[i+r],x=c[i+r+1],A=c[i+m],E=c[i+m+1],M=c[i+f],I=c[i+f+1],R=v+A,D=y+E,G=v-A,X=y-E,F=w+M,H=x+I,Q=h*(w-M),K=h*(x-I),pt=R+F,ut=D+H,_t=G+K,xt=X-Q,Zt=R-F,Wt=D-H,Jt=G-K,it=X+Q;a[s]=pt,a[s+1]=ut,a[s+2]=_t,a[s+3]=xt,a[s+4]=Zt,a[s+5]=Wt,a[s+6]=Jt,a[s+7]=it},n.prototype._realTransform4=function(){var s=this._out,i=this._csize,r=this._width,a=1<<r,c=i/a<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<i;h+=c,m++){const gi=f[m];this._singleRealTransform2(h,gi>>>1,a>>>1)}else for(h=0,m=0;h<i;h+=c,m++){const gi=f[m];this._singleRealTransform4(h,gi>>>1,a>>>1)}var v=this._inv?-1:1,y=this.table;for(a>>=2;a>=2;a>>=2){c=i/a<<1;var w=c>>>1,x=w>>>1,A=x>>>1;for(h=0;h<i;h+=c)for(var E=0,M=0;E<=A;E+=2,M+=a){var I=h+E,R=I+x,D=R+x,G=D+x,X=s[I],F=s[I+1],H=s[R],Q=s[R+1],K=s[D],pt=s[D+1],ut=s[G],_t=s[G+1],xt=X,Zt=F,Wt=y[M],Jt=v*y[M+1],it=H*Wt-Q*Jt,rt=H*Jt+Q*Wt,at=y[2*M],Tt=v*y[2*M+1],dt=K*at-pt*Tt,Nt=K*Tt+pt*at,jt=y[3*M],Bt=v*y[3*M+1],ne=ut*jt-_t*Bt,Xe=ut*Bt+_t*jt,qt=xt+dt,xe=Zt+Nt,Ue=xt-dt,Ze=Zt-Nt,Re=it+ne,Qe=rt+Xe,Te=v*(it-ne),Cs=v*(rt-Xe),an=qt+Re,Le=xe+Qe,Sn=Ue+Cs,ui=Ze-Te;if(s[I]=an,s[I+1]=Le,s[R]=Sn,s[R+1]=ui,E===0){var di=qt-Re,pi=xe-Qe;s[D]=di,s[D+1]=pi;continue}if(E!==A){var Cn=Ue,te=-Ze,Hn=qt,ln=-xe,mi=-v*Cs,Or=-v*Te,go=-v*Qe,fi=-v*Re,Qa=Cn+mi,vo=te+Or,yo=Hn+fi,Nr=ln-go,Lr=h+x-E,Gn=h+w-E;s[Lr]=Qa,s[Lr+1]=vo,s[Gn]=yo,s[Gn+1]=Nr}}}},n.prototype._singleRealTransform2=function(s,i,r){const a=this._out,c=this._data,h=c[i],m=c[i+r],f=h+m,v=h-m;a[s]=f,a[s+1]=0,a[s+2]=v,a[s+3]=0},n.prototype._singleRealTransform4=function(s,i,r){const a=this._out,c=this._data,h=this._inv?-1:1,m=r*2,f=r*3,v=c[i],y=c[i+r],w=c[i+m],x=c[i+f],A=v+w,E=v-w,M=y+x,I=h*(y-x),R=A+M,D=E,G=-I,X=A-M,F=E,H=I;a[s]=R,a[s+1]=0,a[s+2]=D,a[s+3]=G,a[s+4]=X,a[s+5]=0,a[s+6]=F,a[s+7]=H},zc}var ex=tx();const sx=hv(ex);class _r{constructor(e,s){Ps(this,"_inputLength");Ps(this,"_fft");Ps(this,"_bufferSupplier");Ps(this,"_paddedInputBuffer");Ps(this,"_transformBuffer");Ps(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new sx(ox(2*e)),this._bufferSupplier=s,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new _r(e,s=>new Float32Array(s))}static forFloat64Array(e){return new _r(e,s=>new Float64Array(s))}static forNumberArray(e){return new _r(e,s=>Array(s))}get inputLength(){return this._inputLength}autocorrelate(e,s=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let r=0;r<e.length;r++)this._paddedInputBuffer[r]=e[r];for(let r=e.length;r<this._paddedInputBuffer.length;r++)this._paddedInputBuffer[r]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const i=this._transformBuffer;for(let r=0;r<i.length;r+=2)i[r]=i[r]*i[r]+i[r+1]*i[r+1],i[r+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let r=0;r<e.length;r++)s[r]=this._inverseBuffer[2*r];return s}}function nx(n){const e=[];let s=!1,i=-1/0,r=-1;for(let a=1;a<n.length-1;a++)n[a-1]<=0&&n[a]>0?(s=!0,r=a,i=n[a]):n[a-1]>0&&n[a]<=0?(s=!1,r!==-1&&e.push(r)):s&&n[a]>i&&(i=n[a],r=a);return e}function ix(n,e){const[s,i,r]=[n-1,n,n+1],[a,c,h]=[e[s],e[i],e[r]],m=a/2-c+h/2,f=-(a/2)*(i+r)+c*(s+r)-h/2*(s+i),v=a*i*r/2-c*s*r+h*s*i/2,y=-f/(2*m),w=m*y*y+f*y+v;return[y,w]}class xr{constructor(e,s){Ps(this,"_autocorrelator");Ps(this,"_nsdfBuffer");Ps(this,"_clarityThreshold",.9);Ps(this,"_minVolumeAbsolute",0);Ps(this,"_maxInputAmplitude",1);this._autocorrelator=new _r(e,s),this._nsdfBuffer=s(e)}static forFloat32Array(e){return new xr(e,s=>new Float32Array(s))}static forFloat64Array(e){return new xr(e,s=>new Float64Array(s))}static forNumberArray(e){return new xr(e,s=>Array(s))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,s){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const i=nx(this._nsdfBuffer);if(i.length===0)return[0,0];const r=Math.max(...i.map(m=>this._nsdfBuffer[m])),a=i.find(m=>this._nsdfBuffer[m]>=this._clarityThreshold*r),[c,h]=ix(a,this._nsdfBuffer);return[s/c,Math.min(h,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let s=0;for(let i=0;i<e.length;i++)s+=e[i]**2;return Math.sqrt(s/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let s=2*this._nsdfBuffer[0],i;for(i=0;i<this._nsdfBuffer.length&&s>0;i++)this._nsdfBuffer[i]=2*this._nsdfBuffer[i]/s,s-=e[i]**2+e[e.length-i-1]**2;for(;i<this._nsdfBuffer.length;i++)this._nsdfBuffer[i]=0}}function ox(n){return n--,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,n++,n}class rx{constructor(){this.mic=null,this.analyser=null,this.detector=null,this.animationFrameId=null,this.isInitialized=!1,this.lastLogTime=0,this.logThrottleMs=5e3,this.pitchHistory=[],this.maxHistoryLength=3,this.maxPitchJumpSemitones=24,this.maxJumpTimeMs=20,this.config={FFT_SIZE:2048,MIN_PITCH_HZ:75,MAX_PITCH_HZ:1300,MIN_VOLUME_DB:-50}}async initialize(){if(!this.isInitialized)try{await(window.initAudio||(()=>U.start()))(),this.mic=new U.UserMedia,this.analyser=new U.Analyser("waveform",this.config.FFT_SIZE),this.micGain=new U.Gain(2),this.detector=xr.forFloat32Array(this.analyser.size),this.micSplitter=new U.Gain(1),await this.mic.open(),this.mic.connect(this.micGain),this.micGain.connect(this.micSplitter),this.micSplitter.connect(this.analyser),this.isInitialized=!0}catch(e){throw S.error("PitchPaintService","Failed to initialize microphone",e,"paint"),u.setMicPaintActive(!1),e}}startDetection(){!this.isInitialized||u.state.paint.isDetecting||(u.setPaintDetectionState(!0),this.animationLoop())}stopDetection(){u.state.paint.isDetecting&&(u.setPaintDetectionState(!1),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}animationLoop(){if(!u.state.paint.isDetecting){this.animationFrameId=null;return}const e=this.analyser.getValue(),s=Math.sqrt(e.reduce((m,f)=>m+f*f,0)/e.length),i=performance.now();let r=null,a=0;if(s>1e-5)try{[r,a]=this.detector.findPitch(e,U.context.sampleRate),r==null&&(r=null),a==null&&(a=0),r&&a>.1&&i-this.lastLogTime>this.logThrottleMs&&(this.lastLogTime=i)}catch{r=null,a=0}const c=u.state.paint.paintSettings.minClarity;if(r&&a>c&&r>this.config.MIN_PITCH_HZ&&r<this.config.MAX_PITCH_HZ){const m=this.frequencyToMidi(r);if(this.isPitchJumpValid(m,i)){this.addPitchToHistory(m,i);const f=this.getSmoothedPitch(),v={frequency:r,clarity:a,midi:f,pitchClass:Math.round(f)%12,timestamp:i};u.setDetectedPitch(v)}else{const f=this.getSmoothedPitch();if(f!==null){const v={frequency:r,clarity:a,midi:f,pitchClass:Math.round(f)%12,timestamp:i};u.setDetectedPitch(v)}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i})}}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i});this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}frequencyToMidi(e){return 12*Math.log2(e/440)+69}addPitchToHistory(e,s){this.pitchHistory.push({midi:e,timestamp:s}),this.pitchHistory.length>this.maxHistoryLength&&this.pitchHistory.shift()}isPitchJumpValid(e,s){if(this.pitchHistory.length===0)return!0;const i=this.pitchHistory[this.pitchHistory.length-1],r=s-i.timestamp,a=Math.abs(e-i.midi);return r>this.maxJumpTimeMs?!0:a>this.maxPitchJumpSemitones?(S.debug("PitchPaintService","Pitch jump rejected",{semitoneDiff:a.toFixed(1),timeDiff:r.toFixed(0)},"paint"),!1):!0}getSmoothedPitch(){return this.pitchHistory.length<3?this.pitchHistory.length>0?this.pitchHistory[this.pitchHistory.length-1].midi:null:this.pitchHistory.slice(-3).map(s=>s.midi).sort((s,i)=>s-i)[1]}testMicrophoneInput(){if(!this.isInitialized)return!1;const e=this.analyser.getValue();return Math.sqrt(e.reduce((i,r)=>i+r*r,0)/e.length)>1e-4}async dispose(){this.stopDetection(),this.mic&&(this.mic.close(),this.mic=null),this.micGain&&(this.micGain.dispose(),this.micGain=null),this.micSplitter&&(this.micSplitter.dispose(),this.micSplitter=null),this.analyser=null,this.detector=null,this.isInitialized=!1}}const oi=new rx;class ax{constructor(){this.elements={}}initialize(){this.cacheDOMElements(),this.elements.toggleBtn&&(this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",()=>this.updateUI()),u.on("paintHistoryChanged",()=>this.updateUI()),u.on("paintSettingsChanged",()=>this.updateUI()))}cacheDOMElements(){this.elements.toggleBtn=document.getElementById("mic-paint-toggle"),this.elements.clearBtn=document.getElementById("paint-clear-btn"),this.elements.thicknessSelect=document.getElementById("sidebar-trail-thickness"),this.elements.opacitySelect=document.getElementById("sidebar-trail-opacity"),this.elements.colorToggle=document.getElementById("paint-color-toggle"),this.elements.playbackToggle=document.getElementById("paint-playback-toggle")}setupEventListeners(){this.elements.toggleBtn.addEventListener("click",()=>this.handleMicPaintToggle()),this.elements.clearBtn.addEventListener("click",()=>this.handleClearPaint()),this.elements.thicknessSelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({thickness:s})}),this.elements.opacitySelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({opacity:s})}),this.elements.colorToggle.addEventListener("click",()=>this.handleColorToggle()),this.elements.playbackToggle.addEventListener("click",()=>this.handlePlaybackToggle())}async handleMicPaintToggle(){const e=u.state.paint.isMicPaintActive;if(this.elements.toggleBtn.disabled=!0,e)oi.stopDetection(),u.setMicPaintActive(!1);else try{await oi.initialize(),u.setMicPaintActive(!0),oi.startDetection()}catch{alert("Microphone access is required for Pitch Painting. Please check your browser permissions and try again."),u.setMicPaintActive(!1)}this.elements.toggleBtn.disabled=!1}handleClearPaint(){confirm("Are you sure you want to clear the painted pitch trail? This cannot be undone.")&&jh.clear()}handleColorToggle(){const s=u.state.paint.paintSettings.colorMode==="chromatic"?"shapenote":"chromatic";u.setPaintSettings({colorMode:s})}handlePlaybackToggle(){const e=u.state.paint.paintSettings.playbackEnabled;u.setPaintSettings({playbackEnabled:!e})}updateUI(){const{isMicPaintActive:e,paintHistory:s,paintSettings:i}=u.state.paint;if(this.elements.toggleBtn.textContent=e?"Mic Paint (ON)":"Mic Paint (OFF)",this.elements.toggleBtn.classList.toggle("active",e),this.elements.clearBtn.disabled=s.length===0,this.elements.thicknessSelect&&this.elements.thicknessSelect.value!==i.thickness.toString()&&(this.elements.thicknessSelect.value=i.thickness.toString()),this.elements.opacitySelect&&this.elements.opacitySelect.value!==i.opacity.toString()&&(this.elements.opacitySelect.value=i.opacity.toString()),this.elements.colorToggle){const r=i.colorMode==="shapenote";this.elements.colorToggle.classList.toggle("active",r)}this.elements.playbackToggle&&this.elements.playbackToggle.classList.toggle("active",i.playbackEnabled)}}const lx=new ax;S.moduleLoaded("PaintPlaybackService");class cx{constructor(){this.paintSynth=null,this.scheduledEvents=[],this.isInitialized=!1}async initialize(){if(!this.isInitialized)try{if(this.paintSynth=new U.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:0,release:.1}}),this.paintGain=new U.Gain(.3),this.paintSynth.connect(this.paintGain),window.synthEngine&&window.synthEngine.getMainVolumeNode){const e=window.synthEngine.getMainVolumeNode();e?(this.paintGain.connect(e),S.info("PaintPlaybackService","Connected to SynthEngine master chain (with limiter)")):(this.paintGain.toDestination(),S.warn("PaintPlaybackService","SynthEngine main volume node not found, connecting directly to destination"))}else this.paintGain.toDestination(),S.warn("PaintPlaybackService","SynthEngine not available, connecting directly to destination");this.isInitialized=!0,S.info("PaintPlaybackService","Initialized with sine wave synthesis")}catch(e){throw S.error("PaintPlaybackService","Failed to initialize",e),e}}midiToFrequency(e){return 440*Math.pow(2,(e-69)/12)}schedulePaintPlayback(){if(!this.isInitialized||!u.state.paint.paintSettings.playbackEnabled)return;this.clearScheduledEvents();const e=u.state.paint.paintHistory;if(!e||e.length===0){S.debug("PaintPlaybackService","No paint history to schedule");return}S.info("PaintPlaybackService",`Scheduling ${e.length} paint points for playback`),e.forEach((s,i)=>{const r=this.midiToFrequency(s.midi),a=.2,c=U.Transport.schedule(h=>{this.paintSynth&&u.state.paint.paintSettings.playbackEnabled&&(this.paintSynth.triggerAttackRelease(r,a,h),S.debug("PaintPlaybackService",`Playing paint point ${i}: ${s.midi.toFixed(2)} MIDI (${r.toFixed(1)}Hz) at time ${s.musicalTime.toFixed(2)}s`))},s.musicalTime);this.scheduledEvents.push(c)}),S.info("PaintPlaybackService",`Scheduled ${this.scheduledEvents.length} paint events`)}clearScheduledEvents(){this.scheduledEvents.forEach(e=>{U.Transport.clear(e)}),this.scheduledEvents=[],S.debug("PaintPlaybackService","Cleared all scheduled paint events")}onTransportStart(){u.state.paint.paintSettings.playbackEnabled&&this.schedulePaintPlayback()}onTransportStop(){this.clearScheduledEvents()}setPaintVolume(e){this.paintGain&&(this.paintGain.gain.value=Math.max(0,Math.min(1,e)))}getPaintVolume(){return this.paintGain?this.paintGain.gain.value:.3}async dispose(){this.clearScheduledEvents(),this.paintSynth&&(this.paintSynth.dispose(),this.paintSynth=null),this.paintGain&&(this.paintGain.dispose(),this.paintGain=null),this.isInitialized=!1,S.info("PaintPlaybackService","Disposed")}}const lp=new cx,hx="modulepreload",ux=function(n){return"/Student-Notation/"+n},cp={},dx=function(e,s,i){let r=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),h=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=Promise.allSettled(s.map(m=>{if(m=ux(m),m in cp)return;cp[m]=!0;const f=m.endsWith(".css"),v=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${v}`))return;const y=document.createElement("link");if(y.rel=f?"stylesheet":hx,f||(y.as="script"),y.crossOrigin="",y.href=m,h&&y.setAttribute("nonce",h),document.head.appendChild(y),f)return new Promise((w,x)=>{y.addEventListener("load",w),y.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${m}`)))})}))}function a(c){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=c,window.dispatchEvent(h),!h.defaultPrevented)throw c}return r.then(c=>{for(const h of c||[])h.status==="rejected"&&a(h.reason);return e().catch(a)})};class px{constructor(){this.meter=null,this.isInitialized=!1,this.meterWrapper=null,this.meterPlaceholder=null,this.meterSource=null,this.settingsPanel=null,this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.permissionState="unknown",this.errorMessage=null}initialize(){this.isInitialized||(this.cacheDOMElements(),this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",e=>this.handlePitchPaintingToggle(e)),this.isInitialized=!0)}cacheDOMElements(){this.meterWrapper=document.getElementById("mic-meter-wrapper"),this.meterPlaceholder=document.getElementById("meter-placeholder"),this.settingsPanel=document.getElementById("meter-settings-panel"),this.settingsBtn=document.getElementById("meter-settings-btn"),this.sizeSelect=document.getElementById("meter-size-select"),this.fpsSelect=document.getElementById("meter-fps-select"),this.batterySaverCheckbox=document.getElementById("meter-battery-saver"),this.calibrateBtn=document.getElementById("meter-calibrate-btn"),this.resetBtn=document.getElementById("meter-reset-btn"),this.meterWrapper}setupEventListeners(){this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>this.toggleSettingsPanel()),this.sizeSelect&&this.sizeSelect.addEventListener("change",e=>this.handleSizeChange(e.target.value)),this.fpsSelect&&this.fpsSelect.addEventListener("change",e=>this.handleFpsChange(parseInt(e.target.value))),this.batterySaverCheckbox&&this.batterySaverCheckbox.addEventListener("change",e=>this.handleBatterySaverChange(e.target.checked)),this.calibrateBtn&&this.calibrateBtn.addEventListener("click",()=>this.handleAutoCalibrate()),this.resetBtn&&this.resetBtn.addEventListener("click",()=>this.handleReset())}async handlePitchPaintingToggle(e){e?await this.startMeter():this.stopMeter()}async startMeter(){if(!this.meter)try{await this.ensureMicrophoneAccess();const e=U.context;if(!e||e.state==="suspended")throw new Error("Audio context not available or suspended");await this.createMeterFromExistingMic(),this.updateUI()}catch(e){this.handleMeterError(e)}}async ensureMicrophoneAccess(){this.permissionState="pending",this.updateUI();try{this.permissionState="granted"}catch{throw this.permissionState="denied",new Error("Microphone access denied. Please check your browser permissions.")}}async createMeterFromExistingMic(){if(!this.meterWrapper)throw new Error("Meter wrapper not found - cannot create meter");this.meterWrapper.innerHTML="";const e=this.getMeterDimensions(),s=(await dx(async()=>{const{default:i}=await import("./meter-C4sYlEIi.js");return{default:i}},[])).default;if(!oi||!oi.micSplitter)throw new Error("PitchPaintService microphone splitter not available");try{this.meter=new s({target:this.meterWrapper,size:e,fps:this.settings.fps,colors:{fill:"#1a1a1a",accent:"#00ff88"},floorDb:this.settings.noiseFloor,ceilingDb:5})}catch(i){throw i}try{this.meter.connect(oi.micSplitter),this.meterSource=oi.micSplitter}catch(i){throw i}this.meterWrapper.classList.add("active"),this.meterWrapper.classList.remove("error")}stopMeter(){this.meter&&(this.meter.disconnect(),this.meter.destroy(),this.meter=null),this.meterSource&&(this.meterSource=null),this.meterWrapper.innerHTML=`
      <div class="meter-placeholder" id="meter-placeholder">
      </div>
    `,this.meterPlaceholder=document.getElementById("meter-placeholder"),this.meterWrapper.classList.remove("active"),this.updateUI()}getMeterDimensions(){const e=this.meterWrapper.clientWidth||200,s=this.meterWrapper.clientHeight||100;if(this.meterWrapper.classList.contains("mic-meter-wrapper-inline"))return[e,36];if(this.meterWrapper.classList.contains("mic-meter-wrapper-vertical"))return[e,s];const a=this.settings.size==="compact"?48:72;return[e,a]}updateUI(){if(this.meterWrapper){if(this.meterWrapper.classList.remove("compact","wide"),this.meterWrapper.classList.add(this.settings.size),this.updateAccessibilityAttributes(),this.meterPlaceholder){let e="",s="";const i=this.meterWrapper.classList.contains("mic-meter-wrapper-inline");this.permissionState==="denied"?(e=i?"Mic access denied":"Microphone access denied. Click to retry.",s="error"):this.permissionState==="pending"?(e=i?"Requesting access...":"Requesting microphone access...",s="pending"):u.state.paint.isMicPaintActive?this.meter?(e="",s="active"):(e=i?"Starting...":"Starting meter...",s="pending"):(e="",s="disabled");const r=this.meterPlaceholder.querySelector(".meter-status-text");r&&(r.textContent=e),this.meterWrapper.classList.remove("error","pending","disabled"),s&&this.meterWrapper.classList.add(s)}this.updateSettingsUI()}}updateAccessibilityAttributes(){this.meterWrapper&&(this.meterWrapper.setAttribute("role","meter"),this.meterWrapper.setAttribute("aria-label","Microphone Level Meter"),this.meter&&this.meter.active?(this.meterWrapper.setAttribute("aria-valuenow","0"),this.meterWrapper.setAttribute("aria-valuemin",this.settings.noiseFloor.toString()),this.meterWrapper.setAttribute("aria-valuemax","5"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level active")):(this.meterWrapper.removeAttribute("aria-valuenow"),this.meterWrapper.removeAttribute("aria-valuemin"),this.meterWrapper.removeAttribute("aria-valuemax"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level inactive")),window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches&&this.meterWrapper.setAttribute("data-reduced-motion","true"))}updateSettingsUI(){this.sizeSelect&&(this.sizeSelect.value=this.settings.size),this.fpsSelect&&(this.fpsSelect.value=this.settings.fps),this.batterySaverCheckbox&&(this.batterySaverCheckbox.checked=this.settings.batterySaver)}toggleSettingsPanel(){this.settingsPanel&&this.settingsPanel.classList.toggle("hidden")}handleSizeChange(e){if(this.settings.size=e,this.meter){const s=this.getMeterDimensions();this.meter.resize(s[0],s[1])}this.updateUI()}handleFpsChange(e){this.settings.fps=e}handleBatterySaverChange(e){this.settings.batterySaver=e}async handleAutoCalibrate(){if(this.meter){this.calibrateBtn.disabled=!0,this.calibrateBtn.textContent="Stay quiet...";try{await new Promise(e=>setTimeout(e,2e3)),this.settings.noiseFloor=-65,this.settings.autoCalibrated=!0,this.calibrateBtn.textContent="Calibrated ",setTimeout(()=>{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1},1500)}catch{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1}}}handleReset(){if(this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.updateSettingsUI(),this.meter){const e=this.getMeterDimensions();this.meter.resize(e[0],e[1])}}handleMeterError(e){this.errorMessage=e.message,this.meterWrapper.classList.add("error"),(e.message.includes("denied")||e.message.includes("permission"))&&this.showPermissionRetryPrompt(),this.updateUI()}showPermissionRetryPrompt(){let e=this.meterWrapper.querySelector(".meter-permission-prompt");if(!e){e=document.createElement("div"),e.className="meter-permission-prompt",e.innerHTML=`
        <p>Microphone access is required for the level meter.</p>
        <button class="meter-retry-btn">Grant Permission</button>
        <button class="meter-help-btn">Help</button>
      `,this.meterWrapper.appendChild(e);const s=e.querySelector(".meter-retry-btn"),i=e.querySelector(".meter-help-btn");s.addEventListener("click",()=>this.retryPermission()),i.addEventListener("click",()=>this.showPermissionHelp())}}async retryPermission(){try{const e=this.meterWrapper.querySelector(".meter-permission-prompt");e&&e.remove(),this.permissionState="unknown",this.meterWrapper.classList.remove("error"),u.state.paint.isMicPaintActive&&await this.startMeter()}catch(e){this.handleMeterError(e)}}showPermissionHelp(){alert(`
To enable the microphone level meter:

1. Look for a microphone icon in your browser's address bar
2. Click it and select "Allow"
3. If you don't see the icon, go to your browser settings:
   - Chrome: Settings > Privacy and security > Site Settings > Microphone
   - Firefox: Settings > Privacy & Security > Permissions > Microphone
   - Safari: Settings > Websites > Microphone

4. Find this website and set it to "Allow"
5. Refresh the page if needed
    `)}dispose(){this.stopMeter(),this.isInitialized=!1}}const mx=new px;async function fx(){S.initStart("Paint components"),jh.initialize(),wh.initialize(),lx.initialize(),await lp.initialize(),window.PaintPlaybackService=lp,mx.initialize(),S.initSuccess("Paint components")}class gx{constructor(){this.currentTool=null,this.toolButtons=null,this.optionsContainer=null,this.lastSelectedNote=null,this.settings={arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}}}initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.optionsContainer=document.getElementById("draw-tool-options"),!this.toolButtons.length||!this.optionsContainer){S.warn("DrawToolsController","Could not find draw tool elements",null,"draw");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),u.on("noteChanged",({newNote:e})=>{this.lastSelectedNote=e,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.drawTool;this.selectTool(s)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(u.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),u.setSelectedTool("note")):u.state.selectedNote&&(u.setSelectedNote(u.state.selectedNote.shape,u.state.selectedNote.color),u.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(e=>e.classList.remove("active")),this.currentTool=null,this.optionsContainer.innerHTML="",Ut.setTool(null,null)}selectTool(e){this.toolButtons.forEach(i=>i.classList.remove("active"));const s=Array.from(this.toolButtons).find(i=>i.dataset.drawTool===e);s&&s.classList.add("active"),this.currentTool=e,this.renderToolOptions(e),Ut.setTool(e,this.settings),u.state.selectedNote=null}renderToolOptions(e){switch(e){case"arrow":this.renderArrowOptions();break;case"text":this.renderTextOptions();break;case"marker":this.renderMarkerOptions();break;case"highlighter":this.renderHighlighterOptions();break;case"lasso":this.renderLassoOptions();break;default:this.optionsContainer.innerHTML=""}}renderArrowOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="stroke-weight" title="Stroke Weight">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${Math.min(this.settings.arrow.strokeWeight,5)}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="line-style" title="Line Style">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="${this.getLineDashArray()}">
                        <line x1="4" y1="12" x2="20" y2="12"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="start-arrowhead" title="Start Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.startArrowhead,"left")}
                </button>
                <button class="draw-toolbar-button draw-swap-button" data-action="swap-endpoints" title="Swap endpoints">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17,1 21,5 17,9"></polyline>
                        <path d="M3,11V9A4,4 0 0,1 7,5H21"></path>
                        <polyline points="7,23 3,19 7,15"></polyline>
                        <path d="M21,13v2a4,4 0 0,1 -4,4H3"></path>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="end-arrowhead" title="End Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.endArrowhead,"right")}
                </button>
            </div>
        `,this.attachArrowToolbarListeners()}getLineDashArray(){switch(this.settings.arrow.lineStyle){case"solid":return"0";case"dashed-big":return"8,4";case"dashed-small":return"4,2";case"dotted":return"1,2";default:return"0"}}getArrowheadIcon(e,s){const i=s==="left";switch(e){case"none":return`<svg width="20" height="20" viewBox="0 0 24 24"><line x1="${i?20:4}" y1="12" x2="${i?4:20}" y2="12" stroke="currentColor" stroke-width="2"/></svg>`;case"unfilled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?4:20}" y2="12"/>
                    <polyline points="${i?"10,6 4,12 10,18":"14,6 20,12 14,18"}"/>
                </svg>`;case"filled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?8:16}" y2="12"/>
                    <polygon points="${i?"4,12 10,6 10,18":"20,12 14,6 14,18"}"/>
                </svg>`;case"circle":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?8:16}" y2="12"/>
                    <circle cx="${i?4:20}" cy="12" r="3"/>
                </svg>`;default:return""}}attachArrowToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(i=>{i.addEventListener("click",r=>{const a=i.dataset.popup;this.showPopupMenu(a,i)})});const s=this.optionsContainer.querySelector('[data-action="swap-endpoints"]');s&&s.addEventListener("click",()=>{const i=this.settings.arrow.startArrowhead;this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=i,this.renderArrowOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()})}showPopupMenu(e,s){const i=document.querySelector(".draw-popup-menu");i&&i.remove();const r=document.createElement("div");r.className="draw-popup-menu";let a="";switch(e){case"stroke-weight":const f=this.settings.arrow.strokeWeight,v=2,y=4,w=7;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-stroke-slider"
                            min="1"
                            max="10"
                            value="${f}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${f===v?"active":""}" data-value="${v}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===y?"active":""}" data-value="${y}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="4"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===w?"active":""}" data-value="${w}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="6"/></svg>
                            </button>
                        </div>
                    </div>
                `;break;case"line-style":a=`
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="solid"?"active":""}" data-value="solid">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-big"?"active":""}" data-value="dashed-big">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="6,3"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-small"?"active":""}" data-value="dashed-small">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="3,2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dotted"?"active":""}" data-value="dotted">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="1,2"/></svg>
                    </button>
                `;break;case"start-arrowhead":case"end-arrowhead":const x=e==="start-arrowhead",A=x?this.settings.arrow.startArrowhead:this.settings.arrow.endArrowhead;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <div style="margin-bottom: 8px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Size
                        </div>
                        <input type="range"
                            class="draw-arrowhead-size-slider"
                            min="8"
                            max="24"
                            value="${this.settings.arrow.arrowheadSize}"
                            style="width: 100%; margin-bottom: 12px;">
                        <div style="margin-bottom: 6px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Style
                        </div>
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${A==="none"?"active":""}" data-value="none">
                                <svg width="30" height="20" viewBox="0 0 30 20"><line x1="5" y1="10" x2="25" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${A==="unfilled-arrow"?"active":""}" data-value="unfilled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?10:20}" y2="10"/>
                                    <polyline points="${x?"10,5 5,10 10,15":"20,5 25,10 20,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="filled-arrow"?"active":""}" data-value="filled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="currentColor" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?12:18}" y2="10"/>
                                    <polygon points="${x?"5,10 12,5 12,15":"25,10 18,5 18,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="circle"?"active":""}" data-value="circle">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?10:20}" y2="10"/>
                                    <circle cx="${x?5:25}" cy="10" r="4"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;break}r.innerHTML=a,document.body.appendChild(r);const c=s.getBoundingClientRect();r.style.position="absolute",r.style.top=`${c.bottom+5}px`,r.style.left=`${c.left}px`;const h=r.querySelector(".draw-stroke-slider");h&&h.addEventListener("input",f=>{const v=Number(f.target.value);this.settings.arrow.strokeWeight=v,this.renderArrowOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()});const m=r.querySelector(".draw-arrowhead-size-slider");m&&m.addEventListener("input",f=>{const v=Number(f.target.value);this.settings.arrow.arrowheadSize=v,Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()}),r.querySelectorAll(".draw-popup-option").forEach(f=>{f.addEventListener("click",()=>{const v=f.dataset.value;e==="stroke-weight"?(this.settings.arrow.strokeWeight=Number(v),h&&(h.value=v)):e==="line-style"?this.settings.arrow.lineStyle=v:e==="start-arrowhead"?this.settings.arrow.startArrowhead=v:e==="end-arrowhead"&&(this.settings.arrow.endArrowhead=v),this.renderArrowOptions(),r.remove(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()})}),setTimeout(()=>{const f=v=>{!r.contains(v.target)&&!s.contains(v.target)&&(r.remove(),document.removeEventListener("click",f))};document.addEventListener("click",f)},0)}renderTextOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="text-color" title="Text Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.text.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-action="decrease-size" title="Decrease Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;"></span>
                </button>
                <div style="min-width: 35px; text-align: center; font-size: 0.85em; color: var(--c-text);">
                    ${this.settings.text.size}px
                </div>
                <button class="draw-toolbar-button" data-action="increase-size" title="Increase Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;">+</span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.background?"active":""}" data-action="toggle-background" title="Background Fill">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="${this.settings.text.background?"currentColor":"none"}" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.superscript?"active":""}" data-action="toggle-superscript" title="Superscript">
                    <span style="font-size: 0.85em;">x<sup style="font-size: 0.7em;">2</sup></span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.subscript?"active":""}" data-action="toggle-subscript" title="Subscript">
                    <span style="font-size: 0.85em;">x<sub style="font-size: 0.7em;">2</sub></span>
                </button>
            </div>
        `,this.attachCommonToolbarListeners();const e=this.optionsContainer.querySelector('[data-action="decrease-size"]');e&&e.addEventListener("click",()=>{const c=Math.max(8,this.settings.text.size-2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected())});const s=this.optionsContainer.querySelector('[data-action="increase-size"]');s&&s.addEventListener("click",()=>{const c=Math.min(72,this.settings.text.size+2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected())});const i=this.optionsContainer.querySelector('[data-action="toggle-background"]');i&&i.addEventListener("click",()=>{this.settings.text.background=!this.settings.text.background,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()});const r=this.optionsContainer.querySelector('[data-action="toggle-superscript"]');r&&(r.addEventListener("mousedown",c=>{c.preventDefault()}),r.addEventListener("click",()=>{Ut.applyInlineFormatting("superscript")}));const a=this.optionsContainer.querySelector('[data-action="toggle-subscript"]');a&&(a.addEventListener("mousedown",c=>{c.preventDefault()}),a.addEventListener("click",()=>{Ut.applyInlineFormatting("subscript")}))}renderMarkerOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="marker-color" title="Marker Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.marker.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="marker-size" title="Marker Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.marker.size==="small"?"1":this.settings.marker.size==="medium"?"3":"5"}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderHighlighterOptions(){const e=(s,i)=>{const r=parseInt(s.slice(1,3),16),a=parseInt(s.slice(3,5),16),c=parseInt(s.slice(5,7),16);return`rgba(${r}, ${a}, ${c}, ${i})`};this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="highlighter-color" title="Highlighter Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${e(this.settings.highlighter.color,.4)}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="highlighter-size" title="Highlighter Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.highlighter.size==="small"?"2":this.settings.highlighter.size==="medium"?"4":"6"}">
                        <rect x="6" y="8" width="12" height="8" rx="1"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderLassoOptions(){this.optionsContainer.innerHTML=`
            <div style="padding: var(--space-2); text-align: center;">
                <p style="color: var(--c-text-muted); font-size: var(--font-size-sm); margin: 0;">
                    Draw around notes to select and drag them as a group.
                </p>
            </div>
        `}attachCommonToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(s=>{s.addEventListener("click",()=>{const i=s.dataset.popup;this.showCommonPopupMenu(i,s)})})}showCommonPopupMenu(e,s){const i=document.querySelector(".draw-popup-menu");i&&i.remove();const r=document.createElement("div");r.className="draw-popup-menu";let a="",c="",h="";if(e.startsWith("text-")?(c="text",h=e.replace("text-","")):e.startsWith("marker-")?(c="marker",h=e.replace("marker-","")):e.startsWith("highlighter-")&&(c="highlighter",h=e.replace("highlighter-","")),h==="color"){const v=c==="text"?["#4a90e2","#2d2d2d","#d66573","#68a03f"]:["#4a90e2","#2d2d2d","#d66573","#68a03f","#ffc107"],y=c==="highlighter";a=v.map(w=>{const x=y?this.hexToRgba(w,.4):w;return`
                    <button class="draw-popup-option ${this.settings[c].color===w?"active":""}" data-value="${w}">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background-color: ${x};"></div>
                    </button>
                `}).join("")}else if(h==="size")if(c==="text")a=`
                    <button class="draw-popup-option ${this.settings.text.size===12?"active":""}" data-value="12">
                        <span style="font-size: 0.8em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===16?"active":""}" data-value="16">
                        <span style="font-size: 1em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===20?"active":""}" data-value="20">
                        <span style="font-size: 1.2em; font-weight: bold;">A</span>
                    </button>
                `;else{const v=c==="marker"?1:5,y=c==="marker"?15:30,w=this.settings[c].size,x=c==="marker"?3:8,A=c==="marker"?6:15,E=c==="marker"?10:22;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-size-slider"
                            min="${v}"
                            max="${y}"
                            value="${w}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${w===x?"active":""}" data-value="${x}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===A?"active":""}" data-value="${A}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="4"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===E?"active":""}" data-value="${E}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `}r.innerHTML=a,document.body.appendChild(r);const m=s.getBoundingClientRect();r.style.position="absolute",r.style.top=`${m.bottom+5}px`,r.style.left=`${m.left}px`;const f=r.querySelector(".draw-size-slider");f&&f.addEventListener("input",v=>{const y=Number(v.target.value);this.settings[c].size=y,c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()}),r.querySelectorAll(".draw-popup-option").forEach(v=>{v.addEventListener("click",()=>{const y=v.dataset.value;h==="color"?this.settings[c].color=y:h==="size"&&(this.settings[c].size=Number(y),f&&(f.value=y)),c==="text"?this.renderTextOptions():c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected(),r.remove()})}),setTimeout(()=>{const v=y=>{!r.contains(y.target)&&!s.contains(y.target)&&(r.remove(),document.removeEventListener("click",v))};document.addEventListener("click",v)},0)}hexToRgba(e,s){const i=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return`rgba(${i}, ${r}, ${a}, ${s})`}getCurrentTool(){return this.currentTool}getCurrentSettings(){return this.currentTool?this.settings[this.currentTool]:null}}const hp=new gx;function vx(){S.initStart("Draw Tools"),Ut.initialize(),hp.initialize(),window.drawToolsController=hp,window.annotationService=Ut,S.initSuccess("Draw Tools"),S.initStart("Drum components"),Vn.initialize(),S.initSuccess("Drum components")}S.moduleLoaded("KeyboardHandler","keyboard");function yx(){document.addEventListener("keydown",n=>{var a,c,h;const e=document.activeElement,s=e.tagName.toLowerCase(),i=e.contentEditable==="true";if(["input","textarea"].includes(s)||i)return;if(n.ctrlKey&&n.key.toLowerCase()==="p"){n.preventDefault(),S.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),u.emit("printPreviewStateChanged",!0);return}if(n.ctrlKey&&n.key.toLowerCase()==="z"){n.preventDefault(),u.undo();return}if(n.ctrlKey&&n.key.toLowerCase()==="y"){n.preventDefault(),u.redo();return}let r=!1;switch(n.key){case"Escape":(a=u.state.lassoSelection)!=null&&a.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),r=!0,S.debug("KeyboardHandler","Lasso selection cleared (Escape)",null,"keyboard"));break;case"Enter":(c=u.state.lassoSelection)!=null&&c.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),r=!0,S.debug("KeyboardHandler","Lasso selection cleared (Enter)",null,"keyboard"));break;case"Backspace":case"Delete":if((h=u.state.lassoSelection)!=null&&h.isActive){const m=u.state.lassoSelection.selectedItems;m.filter(f=>f.type==="note").forEach(f=>{const v=u.state.placedNotes.findIndex(y=>y.row===f.data.row&&y.columnIndex===f.data.columnIndex&&y.color===f.data.color&&y.shape===f.data.shape);v!==-1&&u.state.placedNotes.splice(v,1)}),m.filter(f=>f.type==="stamp").forEach(f=>{const v=u.state.stampPlacements.findIndex(y=>y.row===f.data.row&&y.column===f.data.column&&y.stampId===f.data.stampId);v!==-1&&u.state.stampPlacements.splice(v,1)}),m.filter(f=>f.type==="triplet").forEach(f=>{const v=u.state.tripletPlacements.findIndex(y=>y.row===f.data.row&&y.column===f.data.column&&y.tripletId===f.data.tripletId);v!==-1&&u.state.tripletPlacements.splice(v,1)}),u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.recordState(),u.emit("render"),r=!0,S.info("KeyboardHandler",`Deleted ${m.length} items from lasso selection`,null,"keyboard")}break;case"ArrowUp":u.shiftGridUp(),r=!0;break;case"ArrowDown":u.shiftGridDown(),r=!0;break;case"ArrowLeft":S.debug("KeyboardHandler","Emitting 'zoomOut' event",null,"keyboard"),u.emit("zoomOut"),r=!0;break;case"ArrowRight":S.debug("KeyboardHandler","Emitting 'zoomIn' event",null,"keyboard"),u.emit("zoomIn"),r=!0;break}r&&n.preventDefault()}),S.info("KeyboardHandler","Initialized",null,"keyboard")}const bx=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Echo Card",selector:"#timbre-panel #reverb-delay-panel .effects-content-box, #timbre-panel #echo-panel .effects-content-box"},{label:"Shake Card",selector:"#timbre-panel #vibrato-tremolo-panel .effects-content-box, #timbre-panel #shake-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],_h=new Map;let xh,Wc,Vc=null,er="",eo=!1;function xa(n){return Number.isFinite(n)?Number(n.toFixed(1)):n}function wx(n){const e=n.getBoundingClientRect(),s=window.getComputedStyle(n);return{tag:n.tagName.toLowerCase(),id:n.id||null,class:n.className||null,top:xa(e.top),left:xa(e.left),width:xa(e.width),height:xa(e.height),offsetWidth:n.offsetWidth,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,scrollHeight:n.scrollHeight,clientWidth:n.clientWidth,clientHeight:n.clientHeight,display:s.display,position:s.position,overflowX:s.overflowX,overflowY:s.overflowY,transform:s.transform!=="none"?s.transform:void 0}}function Im(n="manual"){const e=window.__uiDiagnosticsTrackedElements;if(!e)return[];if(!eo&&n!=="manual")return[];Na();const s=[];return e.forEach(i=>{const r=Array.from(document.querySelectorAll(i.selector));if(!r.length){s.push({label:i.label,selector:i.selector,missing:!0});return}r.forEach((a,c)=>{const h=r.length>1?`${i.label} [${c}]`:i.label,m=wx(a);s.push({label:h,selector:i.selector,info:m})})}),window.__uiDiagnosticsLastSnapshot=s,s}function Xi(n){eo&&(er=er?`${er}; ${n}`:n,Vc===null&&(Vc=requestAnimationFrame(()=>{const e=er||"auto";Vc=null,er="",Im(e)})))}function Na(){const n=window.__uiDiagnosticsTrackedElements;!n||!xh||n.forEach(e=>{document.querySelectorAll(e.selector).forEach(i=>{_h.has(i)||(_h.set(i,e.label),xh.observe(i),i.addEventListener("scroll",()=>Xi(`${e.label} scroll`),{passive:!0}))})})}function _x(n={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:e,autoLog:s=!1}=n;eo=!!s,window.__uiDiagnosticsAutoLog=eo;const i=e||bx;window.__uiDiagnosticsTrackedElements=i,xh=new ResizeObserver(r=>{const a=r.map(c=>_h.get(c.target)||c.target.id||c.target.tagName.toLowerCase()).filter(Boolean);a.length&&Xi(`Resize: ${a.join(", ")}`)}),Wc=new MutationObserver(()=>Na()),document.body?Wc.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{Wc.observe(document.body,{childList:!0,subtree:!0}),Na(),Xi("init")},{once:!0}),window.addEventListener("resize",()=>Xi("window resize")),Na(),Xi("init"),window.logUIState=(r="manual")=>Im(r),window.enableUIDiagnosticsAutoLog=()=>{eo=!0,window.__uiDiagnosticsAutoLog=!0,Xi("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{eo=!1,window.__uiDiagnosticsAutoLog=!1}}class xx{constructor(){this.element=null,this.isVisible=!1,this.hideTimeout=null}initialize(){this.element=document.createElement("div"),this.element.className="zoom-indicator",this.element.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        `,document.body.appendChild(this.element),u.on("zoomIn",()=>this.show()),u.on("zoomOut",()=>this.show())}show(){if(!this.element)return;let e=100,s="";if(St.getViewportInfo){const i=St.getViewportInfo();if(e=Math.round(i.zoomLevel*100),i.canSeeFullRange)s=" (Full Range)";else{const r=i.startRank||i.startRow,a=i.endRank||i.endRow;s=` (~${Math.floor(a-r+1)} semitones)`}}this.element.textContent=`Zoom: ${e}%${s}`,this.element.style.opacity="1",this.isVisible=!0,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>this.hide(),2e3)}hide(){!this.element||!this.isVisible||(this.element.style.opacity="0",this.isVisible=!1,clearTimeout(this.hideTimeout))}dispose(){this.element&&(document.body.removeChild(this.element),this.element=null),clearTimeout(this.hideTimeout)}}const Sx=new xx;function Cx(){ew(),yx(),Tx(),Ax(),_x()}function Tx(){Sx.initialize(),document.addEventListener("keydown",n=>{const e=document.activeElement.tagName.toLowerCase();["input","textarea"].includes(e)||((n.ctrlKey||n.metaKey)&&(n.key==="+"||n.key==="=")&&(n.preventDefault(),u.emit("zoomIn")),(n.ctrlKey||n.metaKey)&&n.key==="-"&&(n.preventDefault(),u.emit("zoomOut")),(n.ctrlKey||n.metaKey)&&n.key==="0"&&(n.preventDefault(),St.resetZoom&&St.resetZoom()))})}function Ax(){window.debugZoom={info:()=>St.getViewportInfo?St.getViewportInfo():"Viewport info not available",zoomTo:n=>{S.debug("Debug Tools",`Setting zoom to ${n}`,null,"zoom")},scrollTo:n=>{if(S.debug("Debug Tools",`Scrolling to position ${n}`,null,"scroll"),St.scroll){const s=St.getViewportInfo().scrollPosition*(u.state.fullRowData.length*u.state.cellHeight*.5),i=n*(u.state.fullRowData.length*u.state.cellHeight*.5);St.scroll(i-s)}},scrollToNote:n=>{S.debug("Debug Tools",`Scrolling to note ${n}`,null,"scroll"),St.scrollToNote&&St.scrollToNote(n)}}}function Mx(n,e){const s=()=>{e.uiComponents&&(hh.renderPitchGrid(),hh.renderDrumGrid())};return n.on("notesChanged",s),n.on("stampPlacementsChanged",s),n.on("tripletPlacementsChanged",s),n.on("modulationMarkersChanged",()=>{St.recalculateLayout(),s(),ni.renderMacrobeatTools()}),n.on("rhythmStructureChanged",()=>{St.recalculateLayout(),s(),ni.renderMacrobeatTools()}),n.on("layoutConfigChanged",()=>{s(),ni.renderMacrobeatTools()}),n.on("zoomIn",()=>St.zoomIn()),n.on("zoomOut",()=>St.zoomOut()),s(),ni.renderMacrobeatTools(),{renderAll:s}}let up=!1,sr=null;window.initAudio=async()=>up?!0:sr||(sr=(async()=>{try{return U.context.state!=="running"&&(await U.start(),S.info("Main.js","AudioContext started successfully")),up=!0,!0}catch(n){return S.error("Main.js","Could not start AudioContext",n),sr=null,!1}})(),sr);let dp=!1;const co=()=>{dp||(dp=!0,window.initAudio().catch(n=>console.warn("Failed to initialize audio:",n)),document.removeEventListener("click",co,!0),document.removeEventListener("keydown",co,!0),document.removeEventListener("touchstart",co,!0))};document.addEventListener("click",co,!0);document.addEventListener("keydown",co,!0);document.addEventListener("touchstart",co,!0);const Ir={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,initialized:!1};function yn(n){Ir[n]=!0}function pp(n,e=5e3){return new Promise((s,i)=>{if(Ir[n]){s();return}const r=Date.now(),a=()=>{Ir[n]?s():Date.now()-r>e?i(new Error(`Component ${n} not ready within ${e}ms`)):setTimeout(a,50)};a()})}document.addEventListener("DOMContentLoaded",async()=>{window.initStartTime=Date.now(),S.info("Main.js","DOMContentLoaded event fired"),S.section("STARTING INITIALIZATION");try{(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&ym(),ci.init(),yn("domCache"),(()=>{const a=ci.get("appContainer")||document.getElementById("app-container");a&&["click","keydown","touchstart"].forEach(h=>{a.addEventListener(h,window.initAudio,{once:!0})})})(),Cw(u.state);const e=u.state.pitchRange||{topIndex:0,bottomIndex:ke.length-1},s=Math.max(0,Math.min(ke.length-1,e.topIndex??0)),i=Math.max(s,Math.min(ke.length-1,e.bottomIndex??ke.length-1));u.state.pitchRange={topIndex:s,bottomIndex:i},u.state.fullRowData=ke.slice(s,i+1),await U_(),yn("layoutService"),yn("canvasContextService"),Gt.init(),yn("synthEngine"),en.initialize().catch(a=>{console.warn("[INIT] RhythmPlaybackService initialization deferred (needs user interaction):",a)}),yn("rhythmPlaybackService"),Ji.init(),yn("transportService"),Cx(),await n_(),yn("uiComponents"),await pp("uiComponents"),await W_(),yn("audioComponents"),Tw(u.state,"audio-components-initialization"),V_(),await fx(),vx(),await pp("audioComponents"),S.section("SETTING UP STATE SUBSCRIPTIONS");const{renderAll:r}=Mx(u,Ir);S.section("PERFORMING INITIAL RENDER"),u.setSelectedTool("note"),u.setSelectedNote("circle","#4a90e2"),r(),ni.renderMacrobeatTools(),yn("initialized"),S.section("INITIALIZATION COMPLETE"),window.ModulationTest=_m,setTimeout(()=>{St.getViewportInfo},1e3)}catch(n){console.error("[INIT]  INITIALIZATION FAILED:",n),console.error("[INIT] Error stack:",n.stack),console.error("[INIT] Component readiness at failure:",Ir),S.error("Main.js","Initialization failed",n);const e=document.createElement("div");e.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,e.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${n.message}</pre>
                <pre>Stack: ${n.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(e)}});
