var y=Object.defineProperty;var g=(n,t,e)=>t in n?y(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var s=(n,t,e)=>g(n,typeof t!="symbol"?t+"":t,e);const f={normalize(n,t,e){return(n-t)/(e-t||1)},scale(n,t,e,i,r){return t===e?i:(n-t)*(r-i)/(e-t)+i}};class b{constructor(t,e){s(this,"element");s(this,"context");s(this,"scale");s(this,"lastRefreshTime",0);s(this,"millisecondsPerFrame",0);const i=typeof t=="string"?document.querySelector(t):t;if(!i)throw new Error("Meter: parent element not found.");this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.scale=window.devicePixelRatio||1,i.appendChild(this.element),this.setFramerate(e)}resize(t,e){const i=Math.max(1,Math.floor(t*this.scale)),r=Math.max(1,Math.floor(e*this.scale));this.element.width=i,this.element.height=r,this.element.style.width=`${t}px`,this.element.style.height=`${e}px`}setFramerate(t){this.millisecondsPerFrame=t?1e3/t:0}refreshIntervalReached(t){return this.millisecondsPerFrame?t-this.lastRefreshTime>=this.millisecondsPerFrame?(this.lastRefreshTime=t,!0):!1:!0}}class v{constructor(t={}){s(this,"width");s(this,"height");s(this,"colors");s(this,"floorDb");s(this,"ceilingDb");s(this,"channels",2);s(this,"splitter",null);s(this,"analysers",[]);s(this,"bufferLength",0);s(this,"dataArray",null);s(this,"active",!1);s(this,"source",null);s(this,"dbs",[]);s(this,"diagnostics",[]);s(this,"canvas");s(this,"element");s(this,"barPadding",2);s(this,"barWidth",0);s(this,"timestamp",0);const{target:e=document.body,size:i=[30,100],fps:r=void 0,colors:h={},floorDb:a=-70,ceilingDb:l=5}=t;this.width=i[0],this.height=i[1],this.colors={fill:"#eee",accent:"#2bb",...h},this.floorDb=a,this.ceilingDb=l;const c=typeof e=="string"?document.querySelector(e):e;this.canvas=new b(c||document.body,r),this.element=this.canvas.element,this.canvas.resize(this.width,this.height),this._updateBarGeometry(),this._renderOnce(),this.element.style.cursor="pointer",this.element.addEventListener("click",()=>{this.source&&(this.active=!this.active,this.render())})}setFramerate(t){this.canvas.setFramerate(t)}connect(t,e){var r;if(!t||!t.context)throw new Error("Meter.connect: expected a Web Audio AudioNode.");this.source&&this.disconnect(),this.channels=Math.max(1,e||t.channelCount||2);const i=t.context;this.splitter=i.createChannelSplitter(this.channels),this.analysers=[];for(let h=0;h<this.channels;h++){const a=i.createAnalyser();a.fftSize=1024,a.smoothingTimeConstant=1,this.splitter.connect(a,h),this.analysers.push(a)}this.bufferLength=((r=this.analysers[0])==null?void 0:r.frequencyBinCount)||0,this.dataArray=new Float32Array(this.bufferLength||1),this.dbs=new Array(this.channels).fill(-1/0),this.source=t,this.source.connect(this.splitter),this._updateBarGeometry(),this.active=!0,this.render()}disconnect(){if(this.source&&this.splitter)try{this.source.disconnect(this.splitter)}catch{}this.active=!1,this.source=null,this.splitter=null}render(){if(!this.active)return;const t=e=>{this.timestamp=e,this._renderOnce(),this.active&&window.requestAnimationFrame(t)};window.requestAnimationFrame(t)}_updateBarGeometry(){this.barWidth=(this.width-this.barPadding*(this.channels+1))/this.channels}_renderOnce(){if(!this.canvas.context||!this.dataArray)return;const t=this.canvas.context;t.clearRect(0,0,this.canvas.element.width,this.canvas.element.height);for(let e=0;e<this.channels;e++){const i=this.analysers[e];if(!i)continue;i.getFloatTimeDomainData(this.dataArray);let r=0;for(let o=0;o<this.bufferLength;o++){const m=this.dataArray[o]??0;r+=m*m}const h=Math.sqrt(r/this.bufferLength)||0,a=20*Math.log10(h||1e-8);this.dbs[e]=a;const l=f.normalize(a,this.floorDb,this.ceilingDb),c=f.scale(l,0,1,0,this.canvas.element.height),d=this.barPadding+e*(this.barWidth+this.barPadding),u=this.canvas.element.height-c;t.fillStyle=this.colors.fill,t.fillRect(d,0,this.barWidth,this.canvas.element.height),t.fillStyle=this.colors.accent,t.fillRect(d,u,this.barWidth,c)}}}export{v as default};
