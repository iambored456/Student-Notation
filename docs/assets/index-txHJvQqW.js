var kg=Object.defineProperty;var Ig=(n,e,s)=>e in n?kg(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var Ts=(n,e,s)=>Ig(n,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();const Dg="modulepreload",Rg=function(n){return"/Student-Notation/"+n},Bu={},lr=function(e,s,o){let r=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),h=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=Promise.allSettled(s.map(m=>{if(m=Rg(m),m in Bu)return;Bu[m]=!0;const f=m.endsWith(".css"),g=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${g}`))return;const b=document.createElement("link");if(b.rel=f?"stylesheet":Dg,f||(b.as="script"),b.crossOrigin="",b.href=m,h&&b.setAttribute("nonce",h),document.head.appendChild(b),f)return new Promise((w,x)=>{b.addEventListener("load",w),b.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${m}`)))})}))}function a(c){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=c,window.dispatchEvent(h),!h.defaultPrevented)throw c}return r.then(c=>{for(const h of c||[])h.status==="rejected"&&a(h.reason);return e().catch(a)})};function Og(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var sa={exports:{}};/*! For license information please see Tone.js.LICENSE.txt */var Ng=sa.exports,qu;function Lg(){return qu||(qu=1,function(n,e){(function(s,o){n.exports=o()})(typeof self<"u"?self:Ng,()=>(()=>{var s={871:function(c,h,m){(function(f,g,b,w){var x=function(Z,ot,pt){return{endTime:ot,insertTime:pt,type:"exponentialRampToValue",value:Z}},A=function(Z,ot,pt){return{endTime:ot,insertTime:pt,type:"linearRampToValue",value:Z}},I=function(Z,ot){return{startTime:ot,type:"setValue",value:Z}},k=function(Z,ot,pt){return{duration:pt,startTime:ot,type:"setValueCurve",values:Z}},P=function(Z,ot,pt){var At=pt.startTime,lt=pt.target,Rt=pt.timeConstant;return lt+(ot-lt)*Math.exp((At-Z)/Rt)},O=function(Z){return Z.type==="exponentialRampToValue"},N=function(Z){return Z.type==="linearRampToValue"},H=function(Z){return O(Z)||N(Z)},G=function(Z){return Z.type==="setValue"},Y=function(Z){return Z.type==="setValueCurve"},ut=function Z(ot,pt,At,lt){var Rt=ot[pt];return Rt===void 0?lt:H(Rt)||G(Rt)?Rt.value:Y(Rt)?Rt.values[Rt.values.length-1]:P(At,Z(ot,pt-1,Rt.startTime,lt),Rt)},dt=function(Z,ot,pt,At,lt){return pt===void 0?[At.insertTime,lt]:H(pt)?[pt.endTime,pt.value]:G(pt)?[pt.startTime,pt.value]:Y(pt)?[pt.startTime+pt.duration,pt.values[pt.values.length-1]]:[pt.startTime,ut(Z,ot-1,pt.startTime,lt)]},it=function(Z){return Z.type==="cancelAndHold"},Ct=function(Z){return Z.type==="cancelScheduledValues"},xt=function(Z){return it(Z)||Ct(Z)?Z.cancelTime:O(Z)||N(Z)?Z.endTime:Z.startTime},tt=function(Z,ot,pt,At){var lt=At.endTime,Rt=At.value;return pt===Rt?Rt:0<pt&&0<Rt||pt<0&&Rt<0?pt*Math.pow(Rt/pt,(Z-ot)/(lt-ot)):0},et=function(Z,ot,pt,At){return pt+(Z-ot)/(At.endTime-ot)*(At.value-pt)},vt=function(Z,ot){var pt=ot.duration,At=ot.startTime,lt=ot.values;return function(Rt,Bt){var zt=Math.floor(Bt),se=Math.ceil(Bt);return zt===se?Rt[zt]:(1-(Bt-zt))*Rt[zt]+(1-(se-Bt))*Rt[se]}(lt,(Z-At)/pt*(lt.length-1))},St=function(Z){return Z.type==="setTarget"},Dt=function(){return w(function Z(ot){b(this,Z),this._automationEvents=[],this._currenTime=0,this._defaultValue=ot},[{key:Symbol.iterator,value:function(){return this._automationEvents[Symbol.iterator]()}},{key:"add",value:function(Z){var ot=xt(Z);if(it(Z)||Ct(Z)){var pt=this._automationEvents.findIndex(function(Oe){return Ct(Z)&&Y(Oe)?Oe.startTime+Oe.duration>=ot:xt(Oe)>=ot}),At=this._automationEvents[pt];if(pt!==-1&&(this._automationEvents=this._automationEvents.slice(0,pt)),it(Z)){var lt=this._automationEvents[this._automationEvents.length-1];if(At!==void 0&&H(At)){if(lt!==void 0&&St(lt))throw new Error("The internal list is malformed.");var Rt=lt===void 0?At.insertTime:Y(lt)?lt.startTime+lt.duration:xt(lt),Bt=lt===void 0?this._defaultValue:Y(lt)?lt.values[lt.values.length-1]:lt.value,zt=O(At)?tt(ot,Rt,Bt,At):et(ot,Rt,Bt,At),se=O(At)?x(zt,ot,this._currenTime):A(zt,ot,this._currenTime);this._automationEvents.push(se)}if(lt!==void 0&&St(lt)&&this._automationEvents.push(I(this.getValue(ot),ot)),lt!==void 0&&Y(lt)&&lt.startTime+lt.duration>ot){var Se=ot-lt.startTime,Xt=(lt.values.length-1)/lt.duration,be=Math.max(2,1+Math.ceil(Se*Xt)),He=Se/(be-1)*Xt,os=lt.values.slice(0,be);if(He<1)for(var ke=1;ke<be;ke+=1){var Ge=He*ke%1;os[ke]=lt.values[ke-1]*(1-Ge)+lt.values[ke]*Ge}this._automationEvents[this._automationEvents.length-1]=k(os,lt.startTime,Se)}}}else{var Ce=this._automationEvents.findIndex(function(Oe){return xt(Oe)>ot}),_s=Ce===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[Ce-1];if(_s!==void 0&&Y(_s)&&xt(_s)+_s.duration>ot)return!1;var nn=O(Z)?x(Z.value,Z.endTime,this._currenTime):N(Z)?A(Z.value,ot,this._currenTime):Z;if(Ce===-1)this._automationEvents.push(nn);else{if(Y(Z)&&ot+Z.duration>xt(this._automationEvents[Ce]))return!1;this._automationEvents.splice(Ce,0,nn)}}return!0}},{key:"flush",value:function(Z){var ot=this._automationEvents.findIndex(function(lt){return xt(lt)>Z});if(ot>1){var pt=this._automationEvents.slice(ot-1),At=pt[0];St(At)&&pt.unshift(I(ut(this._automationEvents,ot-2,At.startTime,this._defaultValue),At.startTime)),this._automationEvents=pt}}},{key:"getValue",value:function(Z){if(this._automationEvents.length===0)return this._defaultValue;var ot=this._automationEvents.findIndex(function(os){return xt(os)>Z}),pt=this._automationEvents[ot],At=(ot===-1?this._automationEvents.length:ot)-1,lt=this._automationEvents[At];if(lt!==void 0&&St(lt)&&(pt===void 0||!H(pt)||pt.insertTime>Z))return P(Z,ut(this._automationEvents,At-1,lt.startTime,this._defaultValue),lt);if(lt!==void 0&&G(lt)&&(pt===void 0||!H(pt)))return lt.value;if(lt!==void 0&&Y(lt)&&(pt===void 0||!H(pt)||lt.startTime+lt.duration>Z))return Z<lt.startTime+lt.duration?vt(Z,lt):lt.values[lt.values.length-1];if(lt!==void 0&&H(lt)&&(pt===void 0||!H(pt)))return lt.value;if(pt!==void 0&&O(pt)){var Rt=dt(this._automationEvents,At,lt,pt,this._defaultValue),Bt=g(Rt,2),zt=Bt[0],se=Bt[1];return tt(Z,zt,se,pt)}if(pt!==void 0&&N(pt)){var Se=dt(this._automationEvents,At,lt,pt,this._defaultValue),Xt=g(Se,2),be=Xt[0],He=Xt[1];return et(Z,be,He,pt)}return this._defaultValue}}])}();f.AutomationEventList=Dt,f.createCancelAndHoldAutomationEvent=function(Z){return{cancelTime:Z,type:"cancelAndHold"}},f.createCancelScheduledValuesAutomationEvent=function(Z){return{cancelTime:Z,type:"cancelScheduledValues"}},f.createExponentialRampToValueAutomationEvent=function(Z,ot){return{endTime:ot,type:"exponentialRampToValue",value:Z}},f.createLinearRampToValueAutomationEvent=function(Z,ot){return{endTime:ot,type:"linearRampToValue",value:Z}},f.createSetTargetAutomationEvent=function(Z,ot,pt){return{startTime:ot,target:Z,timeConstant:pt,type:"setTarget"}},f.createSetValueAutomationEvent=I,f.createSetValueCurveAutomationEvent=k})(h,m(821),m(805),m(989))},113:c=>{c.exports=function(h,m){(m==null||m>h.length)&&(m=h.length);for(var f=0,g=new Array(m);f<m;f++)g[f]=h[f];return g},c.exports.__esModule=!0,c.exports.default=c.exports},569:c=>{c.exports=function(h){if(Array.isArray(h))return h},c.exports.__esModule=!0,c.exports.default=c.exports},805:c=>{c.exports=function(h,m){if(!(h instanceof m))throw new TypeError("Cannot call a class as a function")},c.exports.__esModule=!0,c.exports.default=c.exports},989:(c,h,m)=>{var f=m(498);function g(b,w){for(var x=0;x<w.length;x++){var A=w[x];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(b,f(A.key),A)}}c.exports=function(b,w,x){return w&&g(b.prototype,w),x&&g(b,x),Object.defineProperty(b,"prototype",{writable:!1}),b},c.exports.__esModule=!0,c.exports.default=c.exports},474:c=>{c.exports=function(h,m){var f=h==null?null:typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(f!=null){var g,b,w,x,A=[],I=!0,k=!1;try{if(w=(f=f.call(h)).next,m===0){if(Object(f)!==f)return;I=!1}else for(;!(I=(g=w.call(f)).done)&&(A.push(g.value),A.length!==m);I=!0);}catch(P){k=!0,b=P}finally{try{if(!I&&f.return!=null&&(x=f.return(),Object(x)!==x))return}finally{if(k)throw b}}return A}},c.exports.__esModule=!0,c.exports.default=c.exports},18:c=>{c.exports=function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)},c.exports.__esModule=!0,c.exports.default=c.exports},821:(c,h,m)=>{var f=m(569),g=m(474),b=m(744),w=m(18);c.exports=function(x,A){return f(x)||g(x,A)||b(x,A)||w()},c.exports.__esModule=!0,c.exports.default=c.exports},327:(c,h,m)=>{var f=m(564).default;c.exports=function(g,b){if(f(g)!="object"||!g)return g;var w=g[Symbol.toPrimitive];if(w!==void 0){var x=w.call(g,b||"default");if(f(x)!="object")return x;throw new TypeError("@@toPrimitive must return a primitive value.")}return(b==="string"?String:Number)(g)},c.exports.__esModule=!0,c.exports.default=c.exports},498:(c,h,m)=>{var f=m(564).default,g=m(327);c.exports=function(b){var w=g(b,"string");return f(w)=="symbol"?w:w+""},c.exports.__esModule=!0,c.exports.default=c.exports},564:c=>{function h(m){return c.exports=h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(f){return typeof f}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},c.exports.__esModule=!0,c.exports.default=c.exports,h(m)}c.exports=h,c.exports.__esModule=!0,c.exports.default=c.exports},744:(c,h,m)=>{var f=m(113);c.exports=function(g,b){if(g){if(typeof g=="string")return f(g,b);var w=Object.prototype.toString.call(g).slice(8,-1);return w==="Object"&&g.constructor&&(w=g.constructor.name),w==="Map"||w==="Set"?Array.from(g):w==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(w)?f(g,b):void 0}},c.exports.__esModule=!0,c.exports.default=c.exports}},o={};function r(c){var h=o[c];if(h!==void 0)return h.exports;var m=o[c]={exports:{}};return s[c].call(m.exports,m,m.exports,r),m.exports}r.d=(c,h)=>{for(var m in h)r.o(h,m)&&!r.o(c,m)&&Object.defineProperty(c,m,{enumerable:!0,get:h[m]})},r.o=(c,h)=>Object.prototype.hasOwnProperty.call(c,h),r.r=c=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(c,"__esModule",{value:!0})};var a={};return(()=>{r.r(a),r.d(a,{AMOscillator:()=>bo,AMSynth:()=>ul,Abs:()=>Cu,Add:()=>Gn,AmplitudeEnvelope:()=>Li,Analyser:()=>Fo,AudioToGain:()=>Lr,AutoFilter:()=>Sl,AutoPanner:()=>Cl,AutoWah:()=>Tl,BaseContext:()=>Ka,BiquadFilter:()=>So,BitCrusher:()=>Al,Buffer:()=>Ag,BufferSource:()=>Eg,Buffers:()=>Mg,Channel:()=>Yn,Chebyshev:()=>El,Chorus:()=>kl,Clock:()=>Ei,Compressor:()=>pn,Context:()=>xi,Convolver:()=>tc,CrossFade:()=>Fi,DCMeter:()=>Gl,Delay:()=>us,Destination:()=>vg,Distortion:()=>Il,Draw:()=>xg,DuoSynth:()=>dl,EQ3:()=>Kl,Emitter:()=>wi,Envelope:()=>Be,FFT:()=>Hl,FMOscillator:()=>Ri,FMSynth:()=>pl,FatOscillator:()=>_o,FeedbackCombFilter:()=>Ao,FeedbackDelay:()=>Dl,Filter:()=>ps,Follower:()=>Oo,Freeverb:()=>Ol,Frequency:()=>Xf,FrequencyClass:()=>Ue,FrequencyEnvelope:()=>Co,FrequencyShifter:()=>Rl,Gain:()=>_t,GainToAudio:()=>Tu,Gate:()=>Yl,GrainPlayer:()=>cl,GreaterThan:()=>Br,GreaterThanZero:()=>$r,IntervalTimeline:()=>_u,JCReverb:()=>Nl,LFO:()=>Ye,Limiter:()=>Zl,Listener:()=>_g,Loop:()=>ko,LowpassCombFilter:()=>Eo,Master:()=>yg,MembraneSynth:()=>To,Merge:()=>kn,MetalSynth:()=>ml,Meter:()=>Vl,MidSideCompressor:()=>Ql,MidSideMerge:()=>Lo,MidSideSplit:()=>No,Midi:()=>Kf,MidiClass:()=>ki,Mono:()=>Ul,MonoSynth:()=>Un,MultibandCompressor:()=>Jl,MultibandSplit:()=>$o,Multiply:()=>ue,Negate:()=>hl,Noise:()=>En,NoiseSynth:()=>fl,Offline:()=>Jf,OfflineContext:()=>Si,OmniOscillator:()=>hn,OnePoleFilter:()=>Mo,Oscillator:()=>he,PWMOscillator:()=>wo,PanVol:()=>Hr,Panner:()=>Ro,Panner3D:()=>Xl,Param:()=>Pt,Part:()=>Io,Pattern:()=>wl,Phaser:()=>$l,PingPongDelay:()=>Ll,PitchShift:()=>Fl,Player:()=>Ni,Players:()=>ll,PluckSynth:()=>bl,PolySynth:()=>_l,Pow:()=>Ii,PulseOscillator:()=>Oi,Recorder:()=>Gr,Reverb:()=>Bl,Sampler:()=>Po,Scale:()=>un,ScaleExp:()=>qr,Sequence:()=>xl,Signal:()=>Mt,Solo:()=>ye,Split:()=>Xn,StateTimeline:()=>Ai,StereoWidener:()=>ql,Subtract:()=>jn,SyncedSignal:()=>ig,Synth:()=>Pn,Ticks:()=>tg,TicksClass:()=>ce,Time:()=>Gf,TimeClass:()=>cs,Timeline:()=>ls,ToneAudioBuffer:()=>Wt,ToneAudioBuffers:()=>Pi,ToneAudioNode:()=>rt,ToneBufferSource:()=>Mn,ToneEvent:()=>Gs,ToneOscillatorNode:()=>yo,Transport:()=>fg,TransportTime:()=>Yf,TransportTimeClass:()=>_e,Tremolo:()=>zl,Unit:()=>h,UserMedia:()=>vo,Vibrato:()=>Wl,Volume:()=>ln,WaveShaper:()=>Fs,Waveform:()=>jl,Zero:()=>Fr,connect:()=>Xe,connectSeries:()=>hs,connectSignal:()=>go,context:()=>Cg,dbToGain:()=>Ci,debug:()=>c,defaultArg:()=>Ss,disconnect:()=>sl,fanIn:()=>Zf,ftom:()=>Tn,gainToDb:()=>fo,getContext:()=>ie,getDestination:()=>bg,getDraw:()=>Sg,getListener:()=>wg,getTransport:()=>gg,immediate:()=>mg,intervalToFrequencyRatio:()=>Ti,isArray:()=>Le,isBoolean:()=>Ua,isDefined:()=>Ot,isFunction:()=>uu,isNote:()=>uo,isNumber:()=>rs,isObject:()=>rn,isString:()=>Os,isUndef:()=>ts,loaded:()=>Tg,mtof:()=>tl,now:()=>pg,optionsFromArguments:()=>Q,setContext:()=>Dr,start:()=>Hf,supported:()=>Bf,version:()=>m});var c={};r.r(c),r.d(c,{assert:()=>wt,assertContextRunning:()=>Xa,assertRange:()=>Fe,assertUsedScheduleTime:()=>mu,enterScheduledCallback:()=>Ya,log:()=>fu,setLogger:()=>qf,warn:()=>yi});var h={};r.r(h);const m="15.0.4";var f=r(871);const g=new WeakSet,b=new WeakMap,w=new WeakMap,x=new WeakMap,A=new WeakMap,I=new WeakMap,k=new WeakMap,P=new WeakMap,O=new WeakMap,N=new WeakMap,H={construct:()=>H},G=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,Y=(p,t)=>{const i=[];let l=p.replace(/^[\s]+/,""),d=l.match(G);for(;d!==null;){const v=d[1].slice(1,-1),y=d[0].replace(/([\s]+)?;?$/,"").replace(v,new URL(v,t).toString());i.push(y),l=l.slice(d[0].length).replace(/^[\s]+/,""),d=l.match(G)}return[i.join(";"),l]},ut=p=>{if(p!==void 0&&!Array.isArray(p))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},dt=p=>{if(!(t=>{try{new new Proxy(t,H)}catch{return!1}return!0})(p))throw new TypeError("The given value for processorCtor should be a constructor.");if(p.prototype===null||typeof p.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},it=(p,t)=>{const i=p.get(t);if(i===void 0)throw new Error("A value with the given key could not be found.");return i},Ct=(p,t)=>{const i=Array.from(p).filter(t);if(i.length>1)throw Error("More than one element was found.");if(i.length===0)throw Error("No element was found.");const[l]=i;return p.delete(l),l},xt=(p,t,i,l)=>{const d=it(p,t),v=Ct(d,y=>y[0]===i&&y[1]===l);return d.size===0&&p.delete(t),v},tt=p=>it(k,p),et=p=>{if(g.has(p))throw new Error("The AudioNode is already stored.");g.add(p),tt(p).forEach(t=>t(!0))},vt=p=>"port"in p,St=p=>{if(!g.has(p))throw new Error("The AudioNode is not stored.");g.delete(p),tt(p).forEach(t=>t(!1))},Dt=(p,t)=>{!vt(p)&&t.every(i=>i.size===0)&&St(p)},Z={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},ot=(p,t)=>p.context===t,pt=p=>{try{p.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},At=()=>new DOMException("","IndexSizeError"),lt=p=>{var t;p.getChannelData=(t=p.getChannelData,i=>{try{return t.call(p,i)}catch(l){throw l.code===12?At():l}})},Rt={numberOfChannels:1},Bt=-34028234663852886e22,zt=34028234663852886e22,se=p=>g.has(p),Se={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},Xt=p=>it(b,p),be=p=>it(x,p),He=(p,t)=>{const{activeInputs:i}=Xt(p);i.forEach(d=>d.forEach(([v])=>{t.includes(p)||He(v,[...t,p])}));const l=(d=>"playbackRate"in d)(p)?[p.playbackRate]:vt(p)?Array.from(p.parameters.values()):(d=>"frequency"in d&&"gain"in d)(p)?[p.Q,p.detune,p.frequency,p.gain]:(d=>"offset"in d)(p)?[p.offset]:(d=>!("frequency"in d)&&"gain"in d)(p)?[p.gain]:(d=>"detune"in d&&"frequency"in d)(p)?[p.detune,p.frequency]:(d=>"pan"in d)(p)?[p.pan]:[];for(const d of l){const v=be(d);v!==void 0&&v.activeInputs.forEach(([y])=>He(y,t))}se(p)&&St(p)},os=p=>{He(p.destination,[])},ke=p=>"context"in p,Ge=p=>ke(p[0]),Ce=(p,t,i,l)=>{for(const d of p)if(i(d)){if(l)return!1;throw Error("The set contains at least one similar element.")}return p.add(t),!0},_s=(p,t,[i,l],d)=>{Ce(p,[t,i,l],v=>v[0]===t&&v[1]===i,d)},nn=(p,[t,i,l],d)=>{const v=p.get(t);v===void 0?p.set(t,new Set([[i,l]])):Ce(v,[i,l],y=>y[0]===i,d)},Oe=p=>"inputs"in p,bn=(p,t,i,l)=>{if(Oe(t)){const d=t.inputs[l];return p.connect(d,i,0),[d,i,0]}return p.connect(t,i,l),[t,i,l]},ai=(p,t,i)=>{for(const l of p)if(l[0]===t&&l[1]===i)return p.delete(l),l;return null},li=(p,t)=>{if(!tt(p).delete(t))throw new Error("Missing the expected event listener.")},ci=(p,t,i)=>{const l=it(p,t),d=Ct(l,v=>v[0]===i);return l.size===0&&p.delete(t),d},_n=(p,t,i,l)=>{Oe(t)?p.disconnect(t.inputs[l],i,0):p.disconnect(t,i,l)},Jt=p=>it(w,p),Bn=p=>it(A,p),on=p=>P.has(p),hi=p=>!g.has(p),yr=(p,t)=>new Promise(i=>{if(t!==null)i(!0);else{const l=p.createScriptProcessor(256,1,1),d=p.createGain(),v=p.createBuffer(1,2,44100),y=v.getChannelData(0);y[0]=1,y[1]=1;const _=p.createBufferSource();_.buffer=v,_.loop=!0,_.connect(l).connect(p.destination),_.connect(d),_.disconnect(d),l.onaudioprocess=S=>{const C=S.inputBuffer.getChannelData(0);Array.prototype.some.call(C,M=>M===1)?i(!0):i(!1),_.stop(),l.onaudioprocess=null,_.disconnect(l),l.disconnect(p.destination)},_.start()}}),no=(p,t)=>{const i=new Map;for(const l of p)for(const d of l){const v=i.get(d);i.set(d,v===void 0?1:v+1)}i.forEach((l,d)=>t(d,l))},ui=p=>"context"in p,Ra=p=>{const t=new Map;p.connect=(i=>(l,d=0,v=0)=>{const y=ui(l)?i(l,d,v):i(l,d),_=t.get(l);return _===void 0?t.set(l,[{input:v,output:d}]):_.every(S=>S.input!==v||S.output!==d)&&_.push({input:v,output:d}),y})(p.connect.bind(p)),p.disconnect=(i=>(l,d,v)=>{if(i.apply(p),l===void 0)t.clear();else if(typeof l=="number")for(const[y,_]of t){const S=_.filter(C=>C.output!==l);S.length===0?t.delete(y):t.set(y,S)}else if(t.has(l))if(d===void 0)t.delete(l);else{const y=t.get(l);if(y!==void 0){const _=y.filter(S=>S.output!==d&&(S.input!==v||v===void 0));_.length===0?t.delete(l):t.set(l,_)}}for(const[y,_]of t)_.forEach(S=>{ui(y)?p.connect(y,S.output,S.input):p.connect(y,S.output)})})(p.disconnect)},io=(p,t,i,l,d)=>{const[v,y]=((_,S,C,M)=>{const{activeInputs:E,passiveInputs:D}=Xt(S),R=ai(E[M],_,C);return R===null?[xt(D,_,C,M)[2],!1]:[R[2],!0]})(p,i,l,d);if(v!==null&&(li(p,v),!y||t||on(p)||_n(Jt(p),Jt(i),l,d)),se(i)){const{activeInputs:_}=Xt(i);Dt(i,_)}},oo=(p,t,i,l)=>{const[d,v]=((y,_,S)=>{const{activeInputs:C,passiveInputs:M}=be(_),E=ai(C,y,S);return E===null?[ci(M,y,S)[1],!1]:[E[2],!0]})(p,i,l);d!==null&&(li(p,d),!v||t||on(p)||Jt(p).disconnect(Bn(i),l))};class br{constructor(t){this._map=new Map(t)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(t,i=null){return this._map.forEach((l,d)=>t.call(i,l,d,this))}get(t){return this._map.get(t)}has(t){return this._map.has(t)}keys(){return this._map.keys()}values(){return this._map.values()}}const _r={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function qn(p,t,i,l,d){if(typeof p.copyFromChannel=="function")t[i].byteLength===0&&(t[i]=new Float32Array(128)),p.copyFromChannel(t[i],l,d);else{const v=p.getChannelData(l);if(t[i].byteLength===0)t[i]=v.slice(d,d+128);else{const y=new Float32Array(v.buffer,d*Float32Array.BYTES_PER_ELEMENT,128);t[i].set(y)}}}const di=(p,t,i,l,d)=>{typeof p.copyToChannel=="function"?t[i].byteLength!==0&&p.copyToChannel(t[i],l,d):t[i].byteLength!==0&&p.getChannelData(l).set(t[i],d)},wr=(p,t)=>{const i=[];for(let l=0;l<p;l+=1){const d=[],v=typeof t=="number"?t:t[l];for(let y=0;y<v;y+=1)d.push(new Float32Array(128));i.push(d)}return i},tm=async(p,t,i,l,d,v,y)=>{const _=t===null?128*Math.ceil(p.context.length/128):t.length,S=l.channelCount*l.numberOfInputs,C=d.reduce((L,z)=>L+z,0),M=C===0?null:i.createBuffer(C,_,i.sampleRate);if(v===void 0)throw new Error("Missing the processor constructor.");const E=Xt(p),D=await((L,z)=>{const q=it(N,L),F=Jt(z);return it(q,F)})(i,p),R=wr(l.numberOfInputs,l.channelCount),B=wr(l.numberOfOutputs,d),$=Array.from(p.parameters.keys()).reduce((L,z)=>({...L,[z]:new Float32Array(128)}),{});for(let L=0;L<_;L+=128){if(l.numberOfInputs>0&&t!==null)for(let z=0;z<l.numberOfInputs;z+=1)for(let q=0;q<l.channelCount;q+=1)qn(t,R[z],q,q,L);v.parameterDescriptors!==void 0&&t!==null&&v.parameterDescriptors.forEach(({name:z},q)=>{qn(t,$,z,S+q,L)});for(let z=0;z<l.numberOfInputs;z+=1)for(let q=0;q<d[z];q+=1)B[z][q].byteLength===0&&(B[z][q]=new Float32Array(128));try{const z=R.map((F,X)=>E.activeInputs[X].size===0?[]:F),q=y(L/i.sampleRate,i.sampleRate,()=>D.process(z,B,$));if(M!==null)for(let F=0,X=0;F<l.numberOfOutputs;F+=1){for(let st=0;st<d[F];st+=1)di(M,B[F],st,X+st,L);X+=d[F]}if(!q)break}catch(z){p.dispatchEvent(new ErrorEvent("processorerror",{colno:z.colno,filename:z.filename,lineno:z.lineno,message:z.message}));break}}return M},em={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},sm={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},nm={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},im={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},om={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Mh=p=>{const{port1:t,port2:i}=new MessageChannel;return new Promise(l=>{const d=()=>{i.onmessage=null,t.close(),i.close(),l()};i.onmessage=()=>d();try{t.postMessage(p,[p])}catch{}finally{d()}})},rm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},xr=(p,t,i)=>{const l=t[i];if(l===void 0)throw p();return l},am={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},lm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Ie=()=>new DOMException("","InvalidStateError"),Sr=()=>new DOMException("","InvalidAccessError"),cm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Eh=(p,t,i,l,d,v,y,_,S,C,M)=>{const E=C.length;let D=_;for(let R=0;R<E;R+=1){let B=i[0]*C[R];for(let $=1;$<d;$+=1){const L=D-$&S-1;B+=i[$]*v[L],B-=p[$]*y[L]}for(let $=d;$<l;$+=1)B+=i[$]*v[D-$&S-1];for(let $=d;$<t;$+=1)B-=p[$]*y[D-$&S-1];v[D]=C[R],y[D]=B,D=D+1&S-1,M[R]=B}return D},hm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},ro=p=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const i=p.decodeAudioData(t.buffer,()=>{});return i!==void 0&&(i.catch(()=>{}),!0)}catch{}return!1},le=(p,t,i)=>{const l=t[i];l!==void 0&&l!==p[i]&&(p[i]=l)},Te=(p,t)=>{le(p,t,"channelCount"),le(p,t,"channelCountMode"),le(p,t,"channelInterpretation")},Ph=p=>typeof p.getFloatTimeDomainData=="function",me=(p,t,i)=>{const l=t[i];l!==void 0&&l!==p[i].value&&(p[i].value=l)},Oa=p=>{p.start=(t=>(i=0,l=0,d)=>{if(typeof d=="number"&&d<0||l<0||i<0)throw new RangeError("The parameters can't be negative.");t.call(p,i,l,d)})(p.start)},Na=p=>{var t;p.stop=(t=p.stop,(i=0)=>{if(i<0)throw new RangeError("The parameter can't be negative.");t.call(p,i)})},kh=(p,t)=>p===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(p*t))))),Ih=(p,t)=>{const i=p.createBiquadFilter();return Te(i,t),me(i,t,"Q"),me(i,t,"detune"),me(i,t,"frequency"),me(i,t,"gain"),le(i,t,"type"),i},ao=(p,t)=>{const i=p.createChannelSplitter(t.numberOfOutputs);return Te(i,t),(l=>{const d=l.numberOfOutputs;Object.defineProperty(l,"channelCount",{get:()=>d,set:v=>{if(v!==d)throw Ie()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:v=>{if(v!=="explicit")throw Ie()}}),Object.defineProperty(l,"channelInterpretation",{get:()=>"discrete",set:v=>{if(v!=="discrete")throw Ie()}})})(i),i},pi=(p,t)=>(p.connect=t.connect.bind(t),p.disconnect=t.disconnect.bind(t),p),Dh=(p,t)=>{const i=p.createDelay(t.maxDelayTime);return Te(i,t),me(i,t,"delayTime"),i},Ke=(p,t)=>{const i=p.createGain();return Te(i,t),me(i,t,"gain"),i};function um(p,t){const i=t[0]*t[0]+t[1]*t[1];return[(p[0]*t[0]+p[1]*t[1])/i,(p[1]*t[0]-p[0]*t[1])/i]}function Rh(p,t){let i=[0,0];for(let v=p.length-1;v>=0;v-=1)d=t,i=[(l=i)[0]*d[0]-l[1]*d[1],l[0]*d[1]+l[1]*d[0]],i[0]+=p[v];var l,d;return i}const lo=(p,t,i,l)=>p.createScriptProcessor(t,i,l),je=()=>new DOMException("","NotSupportedError"),dm={numberOfChannels:1},pm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},mm={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},fm={disableNormalization:!1},gm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},vm=()=>new DOMException("","UnknownError"),ym={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Oh=(p,t,i)=>p.copyFromChannel===void 0?p.getChannelData(i)[0]:(p.copyFromChannel(t,i),t[0]),Nh=p=>{if(p===null)return!1;const t=p.length;return t%2!=0?p[Math.floor(t/2)]!==0:p[t/2-1]+p[t/2]!==0},co=(p,t,i,l)=>{let d=p;for(;!d.hasOwnProperty(t);)d=Object.getPrototypeOf(d);const{get:v,set:y}=Object.getOwnPropertyDescriptor(d,t);Object.defineProperty(p,t,{get:i(v),set:l(y)})},Lh=(p,t,i)=>{try{p.setValueAtTime(t,i)}catch(l){if(l.code!==9)throw l;Lh(p,t,i+1e-7)}},La=p=>{const t=p.createOscillator();try{t.start(-1)}catch(i){return i instanceof RangeError}return!1},Fh=p=>{const t=p.createBuffer(1,1,44100),i=p.createBufferSource();i.buffer=t,i.start(),i.stop();try{return i.stop(),!0}catch{return!1}},Fa=p=>{const t=p.createOscillator();try{t.stop(-1)}catch(i){return i instanceof RangeError}return!1},bm=()=>{try{new DOMException}catch{return!1}return!0},_m=()=>new Promise(p=>{const t=new ArrayBuffer(0),{port1:i,port2:l}=new MessageChannel;i.onmessage=({data:d})=>p(d!==null),l.postMessage(t,[t])}),$h=(p,t)=>{const i=t.createGain();p.connect(i);const l=(d=>()=>{d.call(p,i),p.removeEventListener("ended",l)})(p.disconnect);p.addEventListener("ended",l),pi(p,i),p.stop=(d=>{let v=!1;return(y=0)=>{if(v)try{d.call(p,y)}catch{i.gain.setValueAtTime(0,y)}else d.call(p,y),v=!0}})(p.stop)},mi=(p,t)=>i=>{const l={value:p};return Object.defineProperties(i,{currentTarget:l,target:l}),typeof t=="function"?t.call(p,i):t.handleEvent.call(p,i)},wm=(p=>(t,i,[l,d,v],y)=>{p(t[d],[i,l,v],_=>_[0]===i&&_[1]===l,y)})(Ce),xm=(p=>(t,i,[l,d,v],y)=>{const _=t.get(l);_===void 0?t.set(l,new Set([[d,i,v]])):p(_,[d,i,v],S=>S[0]===d&&S[1]===i,y)})(Ce),Sm=(p=>(t,i,l,d)=>p(t[d],v=>v[0]===i&&v[1]===l))(Ct),Bh=new WeakMap,Cm=(p=>t=>{var i;return(i=p.get(t))!==null&&i!==void 0?i:0})(Bh),ws=(Cr=new Map,ho=new WeakMap,(p,t)=>{const i=ho.get(p);if(i!==void 0)return i;const l=Cr.get(p);if(l!==void 0)return l;try{const d=t();return d instanceof Promise?(Cr.set(p,d),d.catch(()=>!1).then(v=>(Cr.delete(p),ho.set(p,v),v))):(ho.set(p,d),d)}catch{return ho.set(p,!1),!1}});var Cr,ho;const Ds=typeof window>"u"?null:window,qh=((p,t)=>(i,l)=>{const d=i.createAnalyser();if(Te(d,l),!(l.maxDecibels>l.minDecibels))throw t();return le(d,l,"fftSize"),le(d,l,"maxDecibels"),le(d,l,"minDecibels"),le(d,l,"smoothingTimeConstant"),p(Ph,()=>Ph(d))||(v=>{v.getFloatTimeDomainData=y=>{const _=new Uint8Array(y.length);v.getByteTimeDomainData(_);const S=Math.max(_.length,v.fftSize);for(let C=0;C<S;C+=1)y[C]=.0078125*(_[C]-128);return y}})(d),d})(ws,At),$a=(p=>t=>{const i=p(t);if(i.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return i.renderer})(Xt),Ne=((p,t,i)=>async(l,d,v)=>{const y=p(l);await Promise.all(y.activeInputs.map((_,S)=>Array.from(_).map(async([C,M])=>{const E=t(C),D=await E.render(C,d),R=l.context.destination;i(C)||l===R&&i(l)||D.connect(v,M,S)})).reduce((_,S)=>[..._,...S],[]))})(Xt,$a,on),Tm=((p,t,i)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ot(C,S)){const M={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,fftSize:C.fftSize,maxDecibels:C.maxDecibels,minDecibels:C.minDecibels,smoothingTimeConstant:C.smoothingTimeConstant};C=p(S,M)}return l.set(S,C),await i(_,S,C),C})(d,v)}}})(qh,Jt,Ne),ne=(zh=I,p=>{const t=zh.get(p);if(t===void 0)throw Ie();return t});var zh;const De=(p=>p===null?null:p.hasOwnProperty("OfflineAudioContext")?p.OfflineAudioContext:p.hasOwnProperty("webkitOfflineAudioContext")?p.webkitOfflineAudioContext:null)(Ds),Qt=(p=>t=>p!==null&&t instanceof p)(De),Wh=new WeakMap,Vh=(p=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,i,l){if(i!==null){let d=this._listeners.get(i);d===void 0&&(d=p(this,i),typeof i=="function"&&this._listeners.set(i,d)),this._nativeEventTarget.addEventListener(t,d,l)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,i,l){const d=i===null?void 0:this._listeners.get(i);this._nativeEventTarget.removeEventListener(t,d===void 0?null:d,l)}})(mi),wn=(p=>p===null?null:p.hasOwnProperty("AudioContext")?p.AudioContext:p.hasOwnProperty("webkitAudioContext")?p.webkitAudioContext:null)(Ds),Ba=(p=>t=>p!==null&&t instanceof p)(wn),qa=(p=>t=>p!==null&&typeof p.AudioNode=="function"&&t instanceof p.AudioNode)(Ds),Hh=(p=>t=>p!==null&&typeof p.AudioParam=="function"&&t instanceof p.AudioParam)(Ds),fi=(p=>p===null?null:p.hasOwnProperty("AudioWorkletNode")?p.AudioWorkletNode:null)(Ds),ve=((p,t,i,l,d,v,y,_,S,C,M,E,D,R,B,$)=>class extends C{constructor(L,z,q,F){super(q),this._context=L,this._nativeAudioNode=q;const X=M(L);E(X)&&i(yr,()=>yr(X,$))!==!0&&Ra(q),w.set(this,q),k.set(this,new Set),L.state!=="closed"&&z&&et(this),p(this,F,q)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(L){this._nativeAudioNode.channelCount=L}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(L){this._nativeAudioNode.channelCountMode=L}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(L){this._nativeAudioNode.channelInterpretation=L}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(L,z=0,q=0){if(z<0||z>=this._nativeAudioNode.numberOfOutputs)throw d();const F=M(this._context),X=B(F);if(D(L)||R(L))throw v();if(ke(L)){const V=Jt(L);try{const U=bn(this._nativeAudioNode,V,z,q),W=hi(this);(X||W)&&this._nativeAudioNode.disconnect(...U),this.context.state!=="closed"&&!W&&hi(L)&&et(L)}catch(U){throw U.code===12?v():U}if(t(this,L,z,q,X)){const U=S([this],L);no(U,l(X))}return L}const st=Bn(L);if(st.name==="playbackRate"&&st.maxValue===1024)throw y();try{this._nativeAudioNode.connect(st,z),(X||hi(this))&&this._nativeAudioNode.disconnect(st,z)}catch(V){throw V.code===12?v():V}if(((V,U,W,nt)=>{const{activeInputs:j,passiveInputs:K}=be(U),{outputs:ct}=Xt(V),ht=tt(V),Et=bt=>{const yt=Jt(V),kt=Bn(U);if(bt){const gt=ci(K,V,W);_s(j,V,gt,!1),nt||on(V)||yt.connect(kt,W)}else{const gt=((It,qt,Ht)=>Ct(It,oe=>oe[0]===qt&&oe[1]===Ht))(j,V,W);nn(K,gt,!1),nt||on(V)||yt.disconnect(kt,W)}};return!!Ce(ct,[U,W],bt=>bt[0]===U&&bt[1]===W,!0)&&(ht.add(Et),se(V)?_s(j,V,[W,Et],!0):nn(K,[V,W,Et],!0),!0)})(this,L,z,X)){const V=S([this],L);no(V,l(X))}}disconnect(L,z,q){let F;const X=M(this._context),st=B(X);if(L===void 0)F=((V,U)=>{const W=Xt(V),nt=[];for(const j of W.outputs)Ge(j)?io(V,U,...j):oo(V,U,...j),nt.push(j[0]);return W.outputs.clear(),nt})(this,st);else if(typeof L=="number"){if(L<0||L>=this.numberOfOutputs)throw d();F=((V,U,W)=>{const nt=Xt(V),j=[];for(const K of nt.outputs)K[1]===W&&(Ge(K)?io(V,U,...K):oo(V,U,...K),j.push(K[0]),nt.outputs.delete(K));return j})(this,st,L)}else{if(z!==void 0&&(z<0||z>=this.numberOfOutputs)||ke(L)&&q!==void 0&&(q<0||q>=L.numberOfInputs))throw d();if(F=((V,U,W,nt,j)=>{const K=Xt(V);return Array.from(K.outputs).filter(ct=>!(ct[0]!==W||nt!==void 0&&ct[1]!==nt||j!==void 0&&ct[2]!==j)).map(ct=>(Ge(ct)?io(V,U,...ct):oo(V,U,...ct),K.outputs.delete(ct),ct[0]))})(this,st,L,z,q),F.length===0)throw v()}for(const V of F){const U=S([this],V);no(U,_)}}})((Gh=b,(p,t,i)=>{const l=[];for(let d=0;d<i.numberOfInputs;d+=1)l.push(new Set);Gh.set(p,{activeInputs:l,outputs:new Set,passiveInputs:new WeakMap,renderer:t})}),((p,t,i,l,d,v,y,_,S,C,M,E,D)=>{const R=new WeakMap;return(B,$,L,z,q)=>{const{activeInputs:F,passiveInputs:X}=v($),{outputs:st}=v(B),V=_(B),U=W=>{const nt=S($),j=S(B);if(W){const K=xt(X,B,L,z);p(F,B,K,!1),q||E(B)||i(j,nt,L,z),D($)&&et($)}else{const K=l(F,B,L,z);t(X,z,K,!1),q||E(B)||d(j,nt,L,z);const ct=y($);if(ct===0)M($)&&Dt($,F);else{const ht=R.get($);ht!==void 0&&clearTimeout(ht),R.set($,setTimeout(()=>{M($)&&Dt($,F)},1e3*ct))}}};return!!C(st,[$,L,z],W=>W[0]===$&&W[1]===L&&W[2]===z,!0)&&(V.add(U),M(B)?p(F,B,[L,z,U],!0):t(X,z,[B,L,U],!0),!0)}})(wm,xm,bn,Sm,_n,Xt,Cm,tt,Jt,Ce,se,on,hi),ws,((p,t,i,l,d,v)=>y=>(_,S)=>{const C=p.get(_);if(C===void 0){if(!y&&v(_)){const M=l(_),{outputs:E}=i(_);for(const D of E)if(Ge(D)){const R=l(D[0]);t(M,R,D[1],D[2])}else{const R=d(D[0]);M.disconnect(R,D[1])}}p.set(_,S)}else p.set(_,C+S)})(P,_n,Xt,Jt,Bn,se),At,Sr,je,((p,t,i,l,d,v,y,_)=>(S,C)=>{const M=t.get(S);if(M===void 0)throw new Error("Missing the expected cycle count.");const E=v(S.context),D=_(E);if(M===C){if(t.delete(S),!D&&y(S)){const R=l(S),{outputs:B}=i(S);for(const $ of B)if(Ge($)){const L=l($[0]);p(R,L,$[1],$[2])}else{const L=d($[0]);R.connect(L,$[1])}}}else t.set(S,M-C)})(bn,P,Xt,Jt,Bn,ne,se,Qt),((p,t,i)=>function l(d,v){const y=ke(v)?v:i(p,v);if((S=>"delayTime"in S)(y))return[];if(d[0]===y)return[d];if(d.includes(y))return[];const{outputs:_}=t(y);return Array.from(_).map(S=>l([...d,y],S[0])).reduce((S,C)=>S.concat(C),[])})(Wh,Xt,it),Vh,ne,Ba,qa,Hh,Qt,fi);var Gh;const Am=((p,t,i,l,d,v)=>class extends p{constructor(y,_){const S=d(y),C={...Z,..._},M=l(S,C);super(y,!1,M,v(S)?t():null),this._nativeAnalyserNode=M}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(y){this._nativeAnalyserNode.fftSize=y}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(y){const _=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=y,!(y>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=_,i()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(y){const _=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=y,!(this._nativeAnalyserNode.maxDecibels>y))throw this._nativeAnalyserNode.minDecibels=_,i()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(y){this._nativeAnalyserNode.smoothingTimeConstant=y}getByteFrequencyData(y){this._nativeAnalyserNode.getByteFrequencyData(y)}getByteTimeDomainData(y){this._nativeAnalyserNode.getByteTimeDomainData(y)}getFloatFrequencyData(y){this._nativeAnalyserNode.getFloatFrequencyData(y)}getFloatTimeDomainData(y){this._nativeAnalyserNode.getFloatTimeDomainData(y)}})(ve,Tm,At,qh,ne,Qt),za=new WeakSet,jh=(p=>p===null?null:p.hasOwnProperty("AudioBuffer")?p.AudioBuffer:null)(Ds),Uh=(Wa=new Uint32Array(1),p=>(Wa[0]=p,Wa[0]));var Wa;const Va=((p,t)=>i=>{i.copyFromChannel=(l,d,v=0)=>{const y=p(v),_=p(d);if(_>=i.numberOfChannels)throw t();const S=i.length,C=i.getChannelData(_),M=l.length;for(let E=y<0?-y:0;E+y<S&&E<M;E+=1)l[E]=C[E+y]},i.copyToChannel=(l,d,v=0)=>{const y=p(v),_=p(d);if(_>=i.numberOfChannels)throw t();const S=i.length,C=i.getChannelData(_),M=l.length;for(let E=y<0?-y:0;E+y<S&&E<M;E+=1)C[E+y]=l[E]}})(Uh,At),Ha=(p=>t=>{t.copyFromChannel=(i=>(l,d,v=0)=>{const y=p(v),_=p(d);if(y<t.length)return i.call(t,l,_,y)})(t.copyFromChannel),t.copyToChannel=(i=>(l,d,v=0)=>{const y=p(v),_=p(d);if(y<t.length)return i.call(t,l,_,y)})(t.copyToChannel)})(Uh),Xh=((p,t,i,l,d,v,y,_)=>{let S=null;return class qd{constructor(M){if(d===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:E,numberOfChannels:D,sampleRate:R}={...Rt,...M};S===null&&(S=new d(1,1,44100));const B=l!==null&&t(v,v)?new l({length:E,numberOfChannels:D,sampleRate:R}):S.createBuffer(D,E,R);if(B.numberOfChannels===0)throw i();return typeof B.copyFromChannel!="function"?(y(B),lt(B)):t(pt,()=>pt(B))||_(B),p.add(B),B}static[Symbol.hasInstance](M){return M!==null&&typeof M=="object"&&Object.getPrototypeOf(M)===qd.prototype||p.has(M)}}})(za,ws,je,jh,De,(p=>()=>{if(p===null)return!1;try{new p({length:1,sampleRate:44100})}catch{return!1}return!0})(jh),Va,Ha),Tr=(p=>(t,i)=>{const l=p(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});i.connect(l).connect(t.destination);const d=()=>{i.removeEventListener("ended",d),i.disconnect(l),l.disconnect()};i.addEventListener("ended",d)})(Ke),Yh=((p,t,i)=>async(l,d,v)=>{const y=t(l);await Promise.all(Array.from(y.activeInputs).map(async([_,S])=>{const C=p(_),M=await C.render(_,d);i(_)||M.connect(v,S)}))})($a,be,on),Vs=(p=>(t,i,l)=>p(i,t,l))(Yh),gi=((p,t,i,l,d,v,y,_,S,C,M)=>(E,D)=>{const R=E.createBufferSource();return Te(R,D),me(R,D,"playbackRate"),le(R,D,"buffer"),le(R,D,"loop"),le(R,D,"loopEnd"),le(R,D,"loopStart"),t(i,()=>i(E))||(B=>{B.start=($=>{let L=!1;return(z=0,q=0,F)=>{if(L)throw Ie();$.call(B,z,q,F),L=!0}})(B.start)})(R),t(l,()=>l(E))||(B=>{B.start=($=>(L=0,z=0,q)=>{const F=B.buffer,X=F===null?z:Math.min(F.duration,z);F!==null&&X>F.duration-.5/B.context.sampleRate?$.call(B,L,0,0):$.call(B,L,X,q)})(B.start)})(R),t(d,()=>d(E))||C(R,E),t(v,()=>v(E))||Oa(R),t(y,()=>y(E))||M(R,E),t(_,()=>_(E))||Na(R),p(E,R),R})(Tr,ws,p=>{const t=p.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},p=>{const t=p.createBufferSource(),i=p.createBuffer(1,1,44100);t.buffer=i;try{t.start(0,1)}catch{return!1}return!0},p=>{const t=p.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},La,Fh,Fa,0,(p=>(t,i)=>{const l=i.createBuffer(1,1,44100);t.buffer===null&&(t.buffer=l),p(t,"buffer",d=>()=>{const v=d.call(t);return v===l?null:v},d=>v=>d.call(t,v===null?l:v))})(co),$h),Hs=((p,t)=>(i,l,d)=>(p(l).replay(d),t(l,i,d)))((p=>t=>{const i=p(t);if(i.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return i.renderer})(be),Yh),Mm=((p,t,i,l,d)=>()=>{const v=new WeakMap;let y=null,_=null;return{set start(S){y=S},set stop(S){_=S},render(S,C){const M=v.get(C);return M!==void 0?Promise.resolve(M):(async(E,D)=>{let R=i(E);const B=ot(R,D);if(!B){const $={buffer:R.buffer,channelCount:R.channelCount,channelCountMode:R.channelCountMode,channelInterpretation:R.channelInterpretation,loop:R.loop,loopEnd:R.loopEnd,loopStart:R.loopStart,playbackRate:R.playbackRate.value};R=t(D,$),y!==null&&R.start(...y),_!==null&&R.stop(_)}return v.set(D,R),B?await p(D,E.playbackRate,R.playbackRate):await l(D,E.playbackRate,R.playbackRate),await d(E,D,R),R})(S,C)}}})(Vs,gi,Jt,Hs,Ne),Rs=((p,t,i,l,d,v,y,_,S,C,M,E,D)=>(R,B,$,L=null,z=null)=>{const q=$.value,F=new f.AutomationEventList(q),X=B?(V=>({replay(U){for(const W of V)if(W.type==="exponentialRampToValue"){const{endTime:nt,value:j}=W;U.exponentialRampToValueAtTime(j,nt)}else if(W.type==="linearRampToValue"){const{endTime:nt,value:j}=W;U.linearRampToValueAtTime(j,nt)}else if(W.type==="setTarget"){const{startTime:nt,target:j,timeConstant:K}=W;U.setTargetAtTime(j,nt,K)}else if(W.type==="setValue"){const{startTime:nt,value:j}=W;U.setValueAtTime(j,nt)}else{if(W.type!=="setValueCurve")throw new Error("Can't apply an unknown automation.");{const{duration:nt,startTime:j,values:K}=W;U.setValueCurveAtTime(K,j,nt)}}}}))(F):null,st={get defaultValue(){return q},get maxValue(){return L===null?$.maxValue:L},get minValue(){return z===null?$.minValue:z},get value(){return $.value},set value(V){$.value=V,st.setValueAtTime(V,R.context.currentTime)},cancelAndHoldAtTime(V){if(typeof $.cancelAndHoldAtTime=="function")X===null&&F.flush(R.context.currentTime),F.add(d(V)),$.cancelAndHoldAtTime(V);else{const U=Array.from(F).pop();X===null&&F.flush(R.context.currentTime),F.add(d(V));const W=Array.from(F).pop();$.cancelScheduledValues(V),U!==W&&W!==void 0&&(W.type==="exponentialRampToValue"?$.exponentialRampToValueAtTime(W.value,W.endTime):W.type==="linearRampToValue"?$.linearRampToValueAtTime(W.value,W.endTime):W.type==="setValue"?$.setValueAtTime(W.value,W.startTime):W.type==="setValueCurve"&&$.setValueCurveAtTime(W.values,W.startTime,W.duration))}return st},cancelScheduledValues:V=>(X===null&&F.flush(R.context.currentTime),F.add(v(V)),$.cancelScheduledValues(V),st),exponentialRampToValueAtTime(V,U){if(V===0)throw new RangeError;if(!Number.isFinite(U)||U<0)throw new RangeError;const W=R.context.currentTime;return X===null&&F.flush(W),Array.from(F).length===0&&(F.add(C(q,W)),$.setValueAtTime(q,W)),F.add(y(V,U)),$.exponentialRampToValueAtTime(V,U),st},linearRampToValueAtTime(V,U){const W=R.context.currentTime;return X===null&&F.flush(W),Array.from(F).length===0&&(F.add(C(q,W)),$.setValueAtTime(q,W)),F.add(_(V,U)),$.linearRampToValueAtTime(V,U),st},setTargetAtTime:(V,U,W)=>(X===null&&F.flush(R.context.currentTime),F.add(S(V,U,W)),$.setTargetAtTime(V,U,W),st),setValueAtTime:(V,U)=>(X===null&&F.flush(R.context.currentTime),F.add(C(V,U)),$.setValueAtTime(V,U),st),setValueCurveAtTime(V,U,W){const nt=V instanceof Float32Array?V:new Float32Array(V);if(E!==null&&E.name==="webkitAudioContext"){const j=U+W,K=R.context.sampleRate,ct=Math.ceil(U*K),ht=Math.floor(j*K),Et=ht-ct,bt=new Float32Array(Et);for(let kt=0;kt<Et;kt+=1){const gt=(nt.length-1)/W*((ct+kt)/K-U),It=Math.floor(gt),qt=Math.ceil(gt);bt[kt]=It===qt?nt[It]:(1-(gt-It))*nt[It]+(1-(qt-gt))*nt[qt]}X===null&&F.flush(R.context.currentTime),F.add(M(bt,U,W)),$.setValueCurveAtTime(bt,U,W);const yt=ht/K;yt<j&&D(st,bt[bt.length-1],yt),D(st,nt[nt.length-1],j)}else X===null&&F.flush(R.context.currentTime),F.add(M(nt,U,W)),$.setValueCurveAtTime(nt,U,W);return st}};return i.set(st,$),t.set(st,R),p(st,X),st})((Zh=x,(p,t)=>{Zh.set(p,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})}),Wh,A,0,f.createCancelAndHoldAutomationEvent,f.createCancelScheduledValuesAutomationEvent,f.createExponentialRampToValueAutomationEvent,f.createLinearRampToValueAutomationEvent,f.createSetTargetAutomationEvent,f.createSetValueAutomationEvent,f.createSetValueCurveAutomationEvent,wn,Lh);var Zh;const Em=((p,t,i,l,d,v,y,_)=>class extends p{constructor(S,C){const M=v(S),E={...Se,...C},D=d(M,E),R=y(M),B=R?t():null;super(S,!1,D,B),this._audioBufferSourceNodeRenderer=B,this._isBufferNullified=!1,this._isBufferSet=E.buffer!==null,this._nativeAudioBufferSourceNode=D,this._onended=null,this._playbackRate=i(this,R,D.playbackRate,zt,Bt)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(S){if(this._nativeAudioBufferSourceNode.buffer=S,S!==null){if(this._isBufferSet)throw l();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(S){this._nativeAudioBufferSourceNode.loop=S}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(S){this._nativeAudioBufferSourceNode.loopEnd=S}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(S){this._nativeAudioBufferSourceNode.loopStart=S}get onended(){return this._onended}set onended(S){const C=typeof S=="function"?_(this,S):null;this._nativeAudioBufferSourceNode.onended=C;const M=this._nativeAudioBufferSourceNode.onended;this._onended=M!==null&&M===C?S:M}get playbackRate(){return this._playbackRate}start(S=0,C=0,M){if(this._nativeAudioBufferSourceNode.start(S,C,M),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=M===void 0?[S,C]:[S,C,M]),this.context.state!=="closed"){et(this);const E=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",E),se(this)&&St(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",E)}}stop(S=0){this._nativeAudioBufferSourceNode.stop(S),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=S)}})(ve,Mm,Rs,Ie,gi,ne,Qt,mi),Pm=((p,t,i,l,d,v,y,_)=>class extends p{constructor(S,C){const M=v(S),E=y(M),D=d(M,C,E);super(S,!1,D,E?(R=>{const B=new WeakMap;return{render($,L){const z=B.get(L);return z!==void 0?Promise.resolve(z):(async(q,F)=>{const X=F.destination;return B.set(F,X),await R(q,F,X),X})($,L)}}})(_):null),this._isNodeOfNativeOfflineAudioContext=E,this._nativeAudioDestinationNode=D}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(S){if(this._isNodeOfNativeOfflineAudioContext)throw l();if(S>this._nativeAudioDestinationNode.maxChannelCount)throw i();this._nativeAudioDestinationNode.channelCount=S}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(S){if(this._isNodeOfNativeOfflineAudioContext)throw l();this._nativeAudioDestinationNode.channelCountMode=S}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(ve,0,At,Ie,((p,t)=>(i,l,d)=>{const v=i.destination;if(v.channelCount!==l)try{v.channelCount=l}catch{}d&&v.channelCountMode!=="explicit"&&(v.channelCountMode="explicit"),v.maxChannelCount===0&&Object.defineProperty(v,"maxChannelCount",{value:l});const y=p(i,{channelCount:l,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1});return t(y,"channelCount",_=>()=>_.call(y),_=>S=>{_.call(y,S);try{v.channelCount=S}catch(C){if(S>v.maxChannelCount)throw C}}),t(y,"channelCountMode",_=>()=>_.call(y),_=>S=>{_.call(y,S),v.channelCountMode=S}),t(y,"channelInterpretation",_=>()=>_.call(y),_=>S=>{_.call(y,S),v.channelInterpretation=S}),Object.defineProperty(y,"maxChannelCount",{get:()=>v.maxChannelCount}),y.connect(v),y})(Ke,co),ne,Qt,Ne),km=((p,t,i,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,M)=>{let E=i(C);const D=ot(E,M);if(!D){const R={Q:E.Q.value,channelCount:E.channelCount,channelCountMode:E.channelCountMode,channelInterpretation:E.channelInterpretation,detune:E.detune.value,frequency:E.frequency.value,gain:E.gain.value,type:E.type};E=t(M,R)}return v.set(M,E),D?(await p(M,C.Q,E.Q),await p(M,C.detune,E.detune),await p(M,C.frequency,E.frequency),await p(M,C.gain,E.gain)):(await l(M,C.Q,E.Q),await l(M,C.detune,E.detune),await l(M,C.frequency,E.frequency),await l(M,C.gain,E.gain)),await d(C,M,E),E})(y,_)}}})(Vs,Ih,Jt,Hs,Ne),zn=(p=>(t,i)=>p.set(t,i))(Bh),Im=((p,t,i,l,d,v,y,_)=>class extends p{constructor(S,C){const M=v(S),E={...em,...C},D=d(M,E),R=y(M);super(S,!1,D,R?i():null),this._Q=t(this,R,D.Q,zt,Bt),this._detune=t(this,R,D.detune,1200*Math.log2(zt),-1200*Math.log2(zt)),this._frequency=t(this,R,D.frequency,S.sampleRate/2,0),this._gain=t(this,R,D.gain,40*Math.log10(zt),Bt),this._nativeBiquadFilterNode=D,_(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(S){this._nativeBiquadFilterNode.type=S}getFrequencyResponse(S,C,M){try{this._nativeBiquadFilterNode.getFrequencyResponse(S,C,M)}catch(E){throw E.code===11?l():E}if(S.length!==C.length||C.length!==M.length)throw l()}})(ve,Rs,km,Sr,Ih,ne,Qt,zn),xn=((p,t)=>(i,l,d)=>{const v=new Set;return i.connect=(y=>(_,S=0,C=0)=>{const M=v.size===0;if(t(_))return y.call(i,_,S,C),p(v,[_,S,C],E=>E[0]===_&&E[1]===S&&E[2]===C,!0),M&&l(),_;y.call(i,_,S),p(v,[_,S],E=>E[0]===_&&E[1]===S,!0),M&&l()})(i.connect),i.disconnect=(y=>(_,S,C)=>{const M=v.size>0;if(_===void 0)y.apply(i),v.clear();else if(typeof _=="number"){y.call(i,_);for(const D of v)D[1]===_&&v.delete(D)}else{t(_)?y.call(i,_,S,C):y.call(i,_,S);for(const D of v)D[0]!==_||S!==void 0&&D[1]!==S||C!==void 0&&D[2]!==C||v.delete(D)}const E=v.size===0;M&&E&&d()})(i.disconnect),i})(Ce,qa),Dm=((p,t)=>(i,l)=>{l.channelCount=1,l.channelCountMode="explicit",Object.defineProperty(l,"channelCount",{get:()=>1,set:()=>{throw p()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:()=>{throw p()}});const d=i.createBufferSource();t(l,()=>{const v=l.numberOfInputs;for(let y=0;y<v;y+=1)d.connect(l,0,y)},()=>d.disconnect(l))})(Ie,xn),Sn=((p,t)=>(i,l)=>{const d=i.createChannelMerger(l.numberOfInputs);return p!==null&&p.name==="webkitAudioContext"&&t(i,d),Te(d,l),d})(wn,Dm),Rm=((p,t,i)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ot(C,S)){const M={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,numberOfInputs:C.numberOfInputs};C=p(S,M)}return l.set(S,C),await i(_,S,C),C})(d,v)}}})(Sn,Jt,Ne),Om=((p,t,i,l,d)=>class extends p{constructor(v,y){const _=l(v),S={...sm,...y};super(v,!1,i(_,S),d(_)?t():null)}})(ve,Rm,Sn,ne,Qt),Nm=((p,t,i)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ot(C,S)){const M={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,numberOfOutputs:C.numberOfOutputs};C=p(S,M)}return l.set(S,C),await i(_,S,C),C})(d,v)}}})(ao,Jt,Ne),Lm=((p,t,i,l,d,v)=>class extends p{constructor(y,_){const S=l(y),C=(M=>({...M,channelCount:M.numberOfOutputs}))({...nm,..._});super(y,!1,i(S,C),d(S)?t():null)}})(ve,Nm,ao,ne,Qt),Fm=((p,t,i,l)=>(d,{offset:v,...y})=>{const _=d.createBuffer(1,2,44100),S=t(d,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),C=i(d,{...y,gain:v}),M=_.getChannelData(0);M[0]=1,M[1]=1,S.buffer=_,S.loop=!0;const E={get bufferSize(){},get channelCount(){return C.channelCount},set channelCount(D){C.channelCount=D},get channelCountMode(){return C.channelCountMode},set channelCountMode(D){C.channelCountMode=D},get channelInterpretation(){return C.channelInterpretation},set channelInterpretation(D){C.channelInterpretation=D},get context(){return C.context},get inputs(){return[]},get numberOfInputs(){return S.numberOfInputs},get numberOfOutputs(){return C.numberOfOutputs},get offset(){return C.gain},get onended(){return S.onended},set onended(D){S.onended=D},addEventListener:(...D)=>S.addEventListener(D[0],D[1],D[2]),dispatchEvent:(...D)=>S.dispatchEvent(D[0]),removeEventListener:(...D)=>S.removeEventListener(D[0],D[1],D[2]),start(D=0){S.start.call(S,D)},stop(D=0){S.stop.call(S,D)}};return p(d,S),l(pi(E,C),()=>S.connect(C),()=>S.disconnect(C))})(Tr,gi,Ke,xn),vi=((p,t,i,l,d)=>(v,y)=>{if(v.createConstantSource===void 0)return i(v,y);const _=v.createConstantSource();return Te(_,y),me(_,y,"offset"),t(l,()=>l(v))||Oa(_),t(d,()=>d(v))||Na(_),p(v,_),_})(Tr,ws,Fm,La,Fa),$m=((p,t,i,l,d)=>()=>{const v=new WeakMap;let y=null,_=null;return{set start(S){y=S},set stop(S){_=S},render(S,C){const M=v.get(C);return M!==void 0?Promise.resolve(M):(async(E,D)=>{let R=i(E);const B=ot(R,D);if(!B){const $={channelCount:R.channelCount,channelCountMode:R.channelCountMode,channelInterpretation:R.channelInterpretation,offset:R.offset.value};R=t(D,$),y!==null&&R.start(y),_!==null&&R.stop(_)}return v.set(D,R),B?await p(D,E.offset,R.offset):await l(D,E.offset,R.offset),await d(E,D,R),R})(S,C)}}})(Vs,vi,Jt,Hs,Ne),Bm=((p,t,i,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),M={...im,...S},E=l(C,M),D=v(C),R=D?i():null;super(_,!1,E,R),this._constantSourceNodeRenderer=R,this._nativeConstantSourceNode=E,this._offset=t(this,D,E.offset,zt,Bt),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(_){const S=typeof _=="function"?y(this,_):null;this._nativeConstantSourceNode.onended=S;const C=this._nativeConstantSourceNode.onended;this._onended=C!==null&&C===S?_:C}start(_=0){if(this._nativeConstantSourceNode.start(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=_),this.context.state!=="closed"){et(this);const S=()=>{this._nativeConstantSourceNode.removeEventListener("ended",S),se(this)&&St(this)};this._nativeConstantSourceNode.addEventListener("ended",S)}}stop(_=0){this._nativeConstantSourceNode.stop(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=_)}})(ve,Rs,$m,vi,ne,Qt,mi),Qh=((p,t)=>(i,l)=>{const d=i.createConvolver();if(Te(d,l),l.disableNormalization===d.normalize&&(d.normalize=!l.disableNormalization),le(d,l,"buffer"),l.channelCount>2||(t(d,"channelCount",v=>()=>v.call(d),v=>y=>{if(y>2)throw p();return v.call(d,y)}),l.channelCountMode==="max"))throw p();return t(d,"channelCountMode",v=>()=>v.call(d),v=>y=>{if(y==="max")throw p();return v.call(d,y)}),d})(je,co),qm=((p,t,i)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ot(C,S)){const M={buffer:C.buffer,channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,disableNormalization:!C.normalize};C=p(S,M)}return l.set(S,C),Oe(C)?await i(_,S,C.inputs[0]):await i(_,S,C),C})(d,v)}}})(Qh,Jt,Ne),zm=((p,t,i,l,d,v)=>class extends p{constructor(y,_){const S=l(y),C={...om,..._},M=i(S,C);super(y,!1,M,d(S)?t():null),this._isBufferNullified=!1,this._nativeConvolverNode=M,C.buffer!==null&&v(this,C.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(y){if(this._nativeConvolverNode.buffer=y,y===null&&this._nativeConvolverNode.buffer!==null){const _=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=_.createBuffer(1,1,_.sampleRate),this._isBufferNullified=!0,v(this,0)}else this._isBufferNullified=!1,v(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(y){this._nativeConvolverNode.normalize=y}})(ve,qm,Qh,ne,Qt,zn),Wm=((p,t,i,l,d)=>v=>{const y=new WeakMap;return{render(_,S){const C=y.get(S);return C!==void 0?Promise.resolve(C):(async(M,E)=>{let D=i(M);const R=ot(D,E);if(!R){const B={channelCount:D.channelCount,channelCountMode:D.channelCountMode,channelInterpretation:D.channelInterpretation,delayTime:D.delayTime.value,maxDelayTime:v};D=t(E,B)}return y.set(E,D),R?await p(E,M.delayTime,D.delayTime):await l(E,M.delayTime,D.delayTime),await d(M,E,D),D})(_,S)}}})(Vs,Dh,Jt,Hs,Ne),Vm=((p,t,i,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),M={...rm,...S},E=l(C,M),D=v(C);super(_,!1,E,D?i(M.maxDelayTime):null),this._delayTime=t(this,D,E.delayTime),y(this,M.maxDelayTime)}get delayTime(){return this._delayTime}})(ve,Rs,Wm,Dh,ne,Qt,zn),Jh=(p=>(t,i)=>{const l=t.createDynamicsCompressor();if(Te(l,i),i.channelCount>2||i.channelCountMode==="max")throw p();return me(l,i,"attack"),me(l,i,"knee"),me(l,i,"ratio"),me(l,i,"release"),me(l,i,"threshold"),l})(je),Hm=((p,t,i,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,M)=>{let E=i(C);const D=ot(E,M);if(!D){const R={attack:E.attack.value,channelCount:E.channelCount,channelCountMode:E.channelCountMode,channelInterpretation:E.channelInterpretation,knee:E.knee.value,ratio:E.ratio.value,release:E.release.value,threshold:E.threshold.value};E=t(M,R)}return v.set(M,E),D?(await p(M,C.attack,E.attack),await p(M,C.knee,E.knee),await p(M,C.ratio,E.ratio),await p(M,C.release,E.release),await p(M,C.threshold,E.threshold)):(await l(M,C.attack,E.attack),await l(M,C.knee,E.knee),await l(M,C.ratio,E.ratio),await l(M,C.release,E.release),await l(M,C.threshold,E.threshold)),await d(C,M,E),E})(y,_)}}})(Vs,Jh,Jt,Hs,Ne),Gm=((p,t,i,l,d,v,y,_)=>class extends p{constructor(S,C){const M=v(S),E={...am,...C},D=l(M,E),R=y(M);super(S,!1,D,R?i():null),this._attack=t(this,R,D.attack),this._knee=t(this,R,D.knee),this._nativeDynamicsCompressorNode=D,this._ratio=t(this,R,D.ratio),this._release=t(this,R,D.release),this._threshold=t(this,R,D.threshold),_(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(S){const C=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=S,S>2)throw this._nativeDynamicsCompressorNode.channelCount=C,d()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(S){const C=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=S,S==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=C,d()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(ve,Rs,Hm,Jh,je,ne,Qt,zn),jm=((p,t,i,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,M)=>{let E=i(C);const D=ot(E,M);if(!D){const R={channelCount:E.channelCount,channelCountMode:E.channelCountMode,channelInterpretation:E.channelInterpretation,gain:E.gain.value};E=t(M,R)}return v.set(M,E),D?await p(M,C.gain,E.gain):await l(M,C.gain,E.gain),await d(C,M,E),E})(y,_)}}})(Vs,Ke,Jt,Hs,Ne),Um=((p,t,i,l,d,v)=>class extends p{constructor(y,_){const S=d(y),C={...lm,..._},M=l(S,C),E=v(S);super(y,!1,M,E?i():null),this._gain=t(this,E,M.gain,zt,Bt)}get gain(){return this._gain}})(ve,Rs,jm,Ke,ne,Qt),Xm=((p,t,i,l)=>(d,v,{channelCount:y,channelCountMode:_,channelInterpretation:S,feedback:C,feedforward:M})=>{const E=kh(v,d.sampleRate),D=C instanceof Float64Array?C:new Float64Array(C),R=M instanceof Float64Array?M:new Float64Array(M),B=D.length,$=R.length,L=Math.min(B,$);if(B===0||B>20)throw l();if(D[0]===0)throw t();if($===0||$>20)throw l();if(R[0]===0)throw t();if(D[0]!==1){for(let V=0;V<$;V+=1)R[V]/=D[0];for(let V=1;V<B;V+=1)D[V]/=D[0]}const z=i(d,E,y,y);z.channelCount=y,z.channelCountMode=_,z.channelInterpretation=S;const q=[],F=[],X=[];for(let V=0;V<y;V+=1){q.push(0);const U=new Float32Array(32),W=new Float32Array(32);U.fill(0),W.fill(0),F.push(U),X.push(W)}z.onaudioprocess=V=>{const U=V.inputBuffer,W=V.outputBuffer,nt=U.numberOfChannels;for(let j=0;j<nt;j+=1){const K=U.getChannelData(j),ct=W.getChannelData(j);q[j]=Eh(D,B,R,$,L,F[j],X[j],q[j],32,K,ct)}};const st=d.sampleRate/2;return pi({get bufferSize(){return E},get channelCount(){return z.channelCount},set channelCount(V){z.channelCount=V},get channelCountMode(){return z.channelCountMode},set channelCountMode(V){z.channelCountMode=V},get channelInterpretation(){return z.channelInterpretation},set channelInterpretation(V){z.channelInterpretation=V},get context(){return z.context},get inputs(){return[z]},get numberOfInputs(){return z.numberOfInputs},get numberOfOutputs(){return z.numberOfOutputs},addEventListener:(...V)=>z.addEventListener(V[0],V[1],V[2]),dispatchEvent:(...V)=>z.dispatchEvent(V[0]),getFrequencyResponse(V,U,W){if(V.length!==U.length||U.length!==W.length)throw p();const nt=V.length;for(let j=0;j<nt;j+=1){const K=-Math.PI*(V[j]/st),ct=[Math.cos(K),Math.sin(K)],ht=um(Rh(R,ct),Rh(D,ct));U[j]=Math.sqrt(ht[0]*ht[0]+ht[1]*ht[1]),W[j]=Math.atan2(ht[1],ht[0])}},removeEventListener:(...V)=>z.removeEventListener(V[0],V[1],V[2])},z)})(Sr,Ie,lo,je),Ar=((p,t,i,l)=>d=>p(ro,()=>ro(d))?Promise.resolve(p(l,l)).then(v=>{if(!v){const y=i(d,512,0,1);d.oncomplete=()=>{y.onaudioprocess=null,y.disconnect()},y.onaudioprocess=()=>d.currentTime,y.connect(d.destination)}return d.startRendering()}):new Promise(v=>{const y=t(d,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});d.oncomplete=_=>{y.disconnect(),v(_.renderedBuffer)},y.connect(d.destination),d.startRendering()}))(ws,Ke,lo,((p,t)=>()=>{if(t===null)return Promise.resolve(!1);const i=new t(1,1,44100),l=p(i,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(d=>{i.oncomplete=()=>{l.disconnect(),d(i.currentTime!==0)},i.startRendering()})})(Ke,De)),Ym=((p,t,i,l,d)=>(v,y)=>{const _=new WeakMap;let S=null;return{render(C,M){const E=_.get(M);return E!==void 0?Promise.resolve(E):(async(D,R)=>{let B=null,$=t(D);const L=ot($,R);if(R.createIIRFilter===void 0?B=p(R,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):L||($=R.createIIRFilter(y,v)),_.set(R,B===null?$:B),B!==null){if(S===null){if(i===null)throw new Error("Missing the native OfflineAudioContext constructor.");const q=new i(D.context.destination.channelCount,D.context.length,R.sampleRate);S=(async()=>(await l(D,q,q.destination),((F,X,st,V)=>{const U=st instanceof Float64Array?st:new Float64Array(st),W=V instanceof Float64Array?V:new Float64Array(V),nt=U.length,j=W.length,K=Math.min(nt,j);if(U[0]!==1){for(let yt=0;yt<nt;yt+=1)W[yt]/=U[0];for(let yt=1;yt<j;yt+=1)U[yt]/=U[0]}const ct=new Float32Array(32),ht=new Float32Array(32),Et=X.createBuffer(F.numberOfChannels,F.length,F.sampleRate),bt=F.numberOfChannels;for(let yt=0;yt<bt;yt+=1){const kt=F.getChannelData(yt),gt=Et.getChannelData(yt);ct.fill(0),ht.fill(0),Eh(U,nt,W,j,K,ct,ht,0,32,kt,gt)}return Et})(await d(q),R,v,y)))()}const z=await S;return B.buffer=z,B.start(0),B}return await l(D,R,$),$})(C,M)}}})(gi,Jt,De,Ne,Ar),Zm=(p=>(t,i,l)=>{if(t.createIIRFilter===void 0)return p(t,i,l);const d=t.createIIRFilter(l.feedforward,l.feedback);return Te(d,l),d})(Xm),Qm=((p,t,i,l,d,v)=>class extends p{constructor(y,_){const S=l(y),C=d(S),M={...cm,..._},E=t(S,C?null:y.baseLatency,M);super(y,!1,E,C?i(M.feedback,M.feedforward):null),(D=>{var R;D.getFrequencyResponse=(R=D.getFrequencyResponse,(B,$,L)=>{if(B.length!==$.length||$.length!==L.length)throw Sr();return R.call(D,B,$,L)})})(E),this._nativeIIRFilterNode=E,v(this,1)}getFrequencyResponse(y,_,S){return this._nativeIIRFilterNode.getFrequencyResponse(y,_,S)}})(ve,Zm,Ym,ne,Qt,zn),Jm=((p,t,i,l,d,v,y,_)=>(S,C)=>{const M=C.listener,{forwardX:E,forwardY:D,forwardZ:R,positionX:B,positionY:$,positionZ:L,upX:z,upY:q,upZ:F}=M.forwardX===void 0?(()=>{const X=new Float32Array(1),st=t(C,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),V=y(C);let U=!1,W=[0,0,-1,0,1,0],nt=[0,0,0];const j=()=>{if(U)return;U=!0;const Et=l(C,256,9,0);Et.onaudioprocess=({inputBuffer:bt})=>{const yt=[v(bt,X,0),v(bt,X,1),v(bt,X,2),v(bt,X,3),v(bt,X,4),v(bt,X,5)];yt.some((gt,It)=>gt!==W[It])&&(M.setOrientation(...yt),W=yt);const kt=[v(bt,X,6),v(bt,X,7),v(bt,X,8)];kt.some((gt,It)=>gt!==nt[It])&&(M.setPosition(...kt),nt=kt)},st.connect(Et)},K=Et=>bt=>{bt!==W[Et]&&(W[Et]=bt,M.setOrientation(...W))},ct=Et=>bt=>{bt!==nt[Et]&&(nt[Et]=bt,M.setPosition(...nt))},ht=(Et,bt,yt)=>{const kt=i(C,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:bt});kt.connect(st,0,Et),kt.start(),Object.defineProperty(kt.offset,"defaultValue",{get:()=>bt});const gt=p({context:S},V,kt.offset,zt,Bt);var It,qt,Ht,oe,ge,es,$t;return _(gt,"value",mt=>()=>mt.call(gt),mt=>te=>{try{mt.call(gt,te)}catch(Yt){if(Yt.code!==9)throw Yt}j(),V&&yt(te)}),gt.cancelAndHoldAtTime=(It=gt.cancelAndHoldAtTime,V?()=>{throw d()}:(...mt)=>{const te=It.apply(gt,mt);return j(),te}),gt.cancelScheduledValues=(qt=gt.cancelScheduledValues,V?()=>{throw d()}:(...mt)=>{const te=qt.apply(gt,mt);return j(),te}),gt.exponentialRampToValueAtTime=(Ht=gt.exponentialRampToValueAtTime,V?()=>{throw d()}:(...mt)=>{const te=Ht.apply(gt,mt);return j(),te}),gt.linearRampToValueAtTime=(oe=gt.linearRampToValueAtTime,V?()=>{throw d()}:(...mt)=>{const te=oe.apply(gt,mt);return j(),te}),gt.setTargetAtTime=(ge=gt.setTargetAtTime,V?()=>{throw d()}:(...mt)=>{const te=ge.apply(gt,mt);return j(),te}),gt.setValueAtTime=(es=gt.setValueAtTime,V?()=>{throw d()}:(...mt)=>{const te=es.apply(gt,mt);return j(),te}),gt.setValueCurveAtTime=($t=gt.setValueCurveAtTime,V?()=>{throw d()}:(...mt)=>{const te=$t.apply(gt,mt);return j(),te}),gt};return{forwardX:ht(0,0,K(0)),forwardY:ht(1,0,K(1)),forwardZ:ht(2,-1,K(2)),positionX:ht(6,0,ct(0)),positionY:ht(7,0,ct(1)),positionZ:ht(8,0,ct(2)),upX:ht(3,0,K(3)),upY:ht(4,1,K(4)),upZ:ht(5,0,K(5))}})():M;return{get forwardX(){return E},get forwardY(){return D},get forwardZ(){return R},get positionX(){return B},get positionY(){return $},get positionZ(){return L},get upX(){return z},get upY(){return q},get upZ(){return F}}})(Rs,Sn,vi,lo,je,Oh,Qt,co),Kh=new WeakMap,Km=((p,t,i,l,d,v)=>class extends i{constructor(y,_){super(y),this._nativeContext=y,I.set(this,y),l(y)&&d.set(y,new Set),this._destination=new p(this,_),this._listener=t(this,y),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(y){const _=typeof y=="function"?v(this,y):null;this._nativeContext.onstatechange=_;const S=this._nativeContext.onstatechange;this._onstatechange=S!==null&&S===_?y:S}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(Pm,Jm,Vh,Qt,Kh,mi),tu=((p,t,i,l,d,v)=>(y,_)=>{const S=y.createOscillator();return Te(S,_),me(S,_,"detune"),me(S,_,"frequency"),_.periodicWave!==void 0?S.setPeriodicWave(_.periodicWave):le(S,_,"type"),t(i,()=>i(y))||Oa(S),t(l,()=>l(y))||v(S,y),t(d,()=>d(y))||Na(S),p(y,S),S})(Tr,ws,La,Fh,Fa,$h),tf=((p,t,i,l,d)=>()=>{const v=new WeakMap;let y=null,_=null,S=null;return{set periodicWave(C){y=C},set start(C){_=C},set stop(C){S=C},render(C,M){const E=v.get(M);return E!==void 0?Promise.resolve(E):(async(D,R)=>{let B=i(D);const $=ot(B,R);if(!$){const L={channelCount:B.channelCount,channelCountMode:B.channelCountMode,channelInterpretation:B.channelInterpretation,detune:B.detune.value,frequency:B.frequency.value,periodicWave:y===null?void 0:y,type:B.type};B=t(R,L),_!==null&&B.start(_),S!==null&&B.stop(S)}return v.set(R,B),$?(await p(R,D.detune,B.detune),await p(R,D.frequency,B.frequency)):(await l(R,D.detune,B.detune),await l(R,D.frequency,B.frequency)),await d(D,R,B),B})(C,M)}}})(Vs,tu,Jt,Hs,Ne),ef=((p,t,i,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),M={...pm,...S},E=i(C,M),D=v(C),R=D?l():null,B=_.sampleRate/2;super(_,!1,E,R),this._detune=t(this,D,E.detune,153600,-153600),this._frequency=t(this,D,E.frequency,B,-B),this._nativeOscillatorNode=E,this._onended=null,this._oscillatorNodeRenderer=R,this._oscillatorNodeRenderer!==null&&M.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=M.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(_){const S=typeof _=="function"?y(this,_):null;this._nativeOscillatorNode.onended=S;const C=this._nativeOscillatorNode.onended;this._onended=C!==null&&C===S?_:C}get type(){return this._nativeOscillatorNode.type}set type(_){this._nativeOscillatorNode.type=_,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(_){this._nativeOscillatorNode.setPeriodicWave(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=_)}start(_=0){if(this._nativeOscillatorNode.start(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=_),this.context.state!=="closed"){et(this);const S=()=>{this._nativeOscillatorNode.removeEventListener("ended",S),se(this)&&St(this)};this._nativeOscillatorNode.addEventListener("ended",S)}}stop(_=0){this._nativeOscillatorNode.stop(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=_)}})(ve,Rs,tu,tf,ne,Qt,mi),eu=(p=>(t,i)=>{const l=p(t,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),d=t.createBuffer(1,2,44100);return l.buffer=d,l.loop=!0,l.connect(i),l.start(),()=>{l.stop(),l.disconnect(i)}})(gi),sf=((p,t,i,l,d)=>(v,{curve:y,oversample:_,...S})=>{const C=v.createWaveShaper(),M=v.createWaveShaper();Te(C,S),Te(M,S);const E=i(v,{...S,gain:1}),D=i(v,{...S,gain:-1}),R=i(v,{...S,gain:1}),B=i(v,{...S,gain:-1});let $=null,L=!1,z=null;const q={get bufferSize(){},get channelCount(){return C.channelCount},set channelCount(F){E.channelCount=F,D.channelCount=F,C.channelCount=F,R.channelCount=F,M.channelCount=F,B.channelCount=F},get channelCountMode(){return C.channelCountMode},set channelCountMode(F){E.channelCountMode=F,D.channelCountMode=F,C.channelCountMode=F,R.channelCountMode=F,M.channelCountMode=F,B.channelCountMode=F},get channelInterpretation(){return C.channelInterpretation},set channelInterpretation(F){E.channelInterpretation=F,D.channelInterpretation=F,C.channelInterpretation=F,R.channelInterpretation=F,M.channelInterpretation=F,B.channelInterpretation=F},get context(){return C.context},get curve(){return z},set curve(F){if(F!==null&&F.length<2)throw t();if(F===null)C.curve=F,M.curve=F;else{const X=F.length,st=new Float32Array(X+2-X%2),V=new Float32Array(X+2-X%2);st[0]=F[0],V[0]=-F[X-1];const U=Math.ceil((X+1)/2),W=(X+1)/2-1;for(let nt=1;nt<U;nt+=1){const j=nt/U*W,K=Math.floor(j),ct=Math.ceil(j);st[nt]=K===ct?F[K]:(1-(j-K))*F[K]+(1-(ct-j))*F[ct],V[nt]=K===ct?-F[X-1-K]:-(1-(j-K))*F[X-1-K]-(1-(ct-j))*F[X-1-ct]}st[U]=X%2==1?F[U-1]:(F[U-2]+F[U-1])/2,C.curve=st,M.curve=V}z=F,L&&(l(z)&&$===null?$=p(v,E):$!==null&&($(),$=null))},get inputs(){return[E]},get numberOfInputs(){return C.numberOfInputs},get numberOfOutputs(){return C.numberOfOutputs},get oversample(){return C.oversample},set oversample(F){C.oversample=F,M.oversample=F},addEventListener:(...F)=>E.addEventListener(F[0],F[1],F[2]),dispatchEvent:(...F)=>E.dispatchEvent(F[0]),removeEventListener:(...F)=>E.removeEventListener(F[0],F[1],F[2])};return y!==null&&(q.curve=y instanceof Float32Array?y:new Float32Array(y)),_!==q.oversample&&(q.oversample=_),d(pi(q,R),()=>{E.connect(C).connect(R),E.connect(D).connect(M).connect(B).connect(R),L=!0,l(z)&&($=p(v,E))},()=>{E.disconnect(C),C.disconnect(R),E.disconnect(D),D.disconnect(M),M.disconnect(B),B.disconnect(R),L=!1,$!==null&&($(),$=null)})})(eu,Ie,Ke,Nh,xn),Mr=((p,t,i,l,d,v,y)=>(_,S)=>{const C=_.createWaveShaper();if(v!==null&&v.name==="webkitAudioContext"&&_.createGain().gain.automationRate===void 0)return i(_,S);Te(C,S);const M=S.curve===null||S.curve instanceof Float32Array?S.curve:new Float32Array(S.curve);if(M!==null&&M.length<2)throw t();le(C,{curve:M},"curve"),le(C,S,"oversample");let E=null,D=!1;return y(C,"curve",R=>()=>R.call(C),R=>B=>(R.call(C,B),D&&(l(B)&&E===null?E=p(_,C):l(B)||E===null||(E(),E=null)),B)),d(C,()=>{D=!0,l(C.curve)&&(E=p(_,C))},()=>{D=!1,E!==null&&(E(),E=null)})})(eu,Ie,sf,Nh,xn,wn,co),nf=((p,t,i,l,d,v,y,_,S,C)=>(M,{coneInnerAngle:E,coneOuterAngle:D,coneOuterGain:R,distanceModel:B,maxDistance:$,orientationX:L,orientationY:z,orientationZ:q,panningModel:F,positionX:X,positionY:st,positionZ:V,refDistance:U,rolloffFactor:W,...nt})=>{const j=M.createPanner();if(nt.channelCount>2||nt.channelCountMode==="max")throw y();Te(j,nt);const K={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},ct=i(M,{...K,channelInterpretation:"speakers",numberOfInputs:6}),ht=l(M,{...nt,gain:1}),Et=l(M,{...K,gain:1}),bt=l(M,{...K,gain:0}),yt=l(M,{...K,gain:0}),kt=l(M,{...K,gain:0}),gt=l(M,{...K,gain:0}),It=l(M,{...K,gain:0}),qt=d(M,256,6,1),Ht=v(M,{...K,curve:new Float32Array([1,1]),oversample:"none"});let oe=[L,z,q],ge=[X,st,V];const es=new Float32Array(1);qt.onaudioprocess=({inputBuffer:mt})=>{const te=[S(mt,es,0),S(mt,es,1),S(mt,es,2)];te.some((ze,Dn)=>ze!==oe[Dn])&&(j.setOrientation(...te),oe=te);const Yt=[S(mt,es,3),S(mt,es,4),S(mt,es,5)];Yt.some((ze,Dn)=>ze!==ge[Dn])&&(j.setPosition(...Yt),ge=Yt)},Object.defineProperty(bt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(yt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(kt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(gt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(It.gain,"defaultValue",{get:()=>0});const $t={get bufferSize(){},get channelCount(){return j.channelCount},set channelCount(mt){if(mt>2)throw y();ht.channelCount=mt,j.channelCount=mt},get channelCountMode(){return j.channelCountMode},set channelCountMode(mt){if(mt==="max")throw y();ht.channelCountMode=mt,j.channelCountMode=mt},get channelInterpretation(){return j.channelInterpretation},set channelInterpretation(mt){ht.channelInterpretation=mt,j.channelInterpretation=mt},get coneInnerAngle(){return j.coneInnerAngle},set coneInnerAngle(mt){j.coneInnerAngle=mt},get coneOuterAngle(){return j.coneOuterAngle},set coneOuterAngle(mt){j.coneOuterAngle=mt},get coneOuterGain(){return j.coneOuterGain},set coneOuterGain(mt){if(mt<0||mt>1)throw t();j.coneOuterGain=mt},get context(){return j.context},get distanceModel(){return j.distanceModel},set distanceModel(mt){j.distanceModel=mt},get inputs(){return[ht]},get maxDistance(){return j.maxDistance},set maxDistance(mt){if(mt<0)throw new RangeError;j.maxDistance=mt},get numberOfInputs(){return j.numberOfInputs},get numberOfOutputs(){return j.numberOfOutputs},get orientationX(){return Et.gain},get orientationY(){return bt.gain},get orientationZ(){return yt.gain},get panningModel(){return j.panningModel},set panningModel(mt){j.panningModel=mt},get positionX(){return kt.gain},get positionY(){return gt.gain},get positionZ(){return It.gain},get refDistance(){return j.refDistance},set refDistance(mt){if(mt<0)throw new RangeError;j.refDistance=mt},get rolloffFactor(){return j.rolloffFactor},set rolloffFactor(mt){if(mt<0)throw new RangeError;j.rolloffFactor=mt},addEventListener:(...mt)=>ht.addEventListener(mt[0],mt[1],mt[2]),dispatchEvent:(...mt)=>ht.dispatchEvent(mt[0]),removeEventListener:(...mt)=>ht.removeEventListener(mt[0],mt[1],mt[2])};return E!==$t.coneInnerAngle&&($t.coneInnerAngle=E),D!==$t.coneOuterAngle&&($t.coneOuterAngle=D),R!==$t.coneOuterGain&&($t.coneOuterGain=R),B!==$t.distanceModel&&($t.distanceModel=B),$!==$t.maxDistance&&($t.maxDistance=$),L!==$t.orientationX.value&&($t.orientationX.value=L),z!==$t.orientationY.value&&($t.orientationY.value=z),q!==$t.orientationZ.value&&($t.orientationZ.value=q),F!==$t.panningModel&&($t.panningModel=F),X!==$t.positionX.value&&($t.positionX.value=X),st!==$t.positionY.value&&($t.positionY.value=st),V!==$t.positionZ.value&&($t.positionZ.value=V),U!==$t.refDistance&&($t.refDistance=U),W!==$t.rolloffFactor&&($t.rolloffFactor=W),oe[0]===1&&oe[1]===0&&oe[2]===0||j.setOrientation(...oe),ge[0]===0&&ge[1]===0&&ge[2]===0||j.setPosition(...ge),C(pi($t,j),()=>{ht.connect(j),p(ht,Ht,0,0),Ht.connect(Et).connect(ct,0,0),Ht.connect(bt).connect(ct,0,1),Ht.connect(yt).connect(ct,0,2),Ht.connect(kt).connect(ct,0,3),Ht.connect(gt).connect(ct,0,4),Ht.connect(It).connect(ct,0,5),ct.connect(qt).connect(M.destination)},()=>{ht.disconnect(j),_(ht,Ht,0,0),Ht.disconnect(Et),Et.disconnect(ct),Ht.disconnect(bt),bt.disconnect(ct),Ht.disconnect(yt),yt.disconnect(ct),Ht.disconnect(kt),kt.disconnect(ct),Ht.disconnect(gt),gt.disconnect(ct),Ht.disconnect(It),It.disconnect(ct),ct.disconnect(qt),qt.disconnect(M.destination)})})(bn,Ie,Sn,Ke,lo,Mr,je,_n,Oh,xn),su=(p=>(t,i)=>{const l=t.createPanner();return l.orientationX===void 0?p(t,i):(Te(l,i),me(l,i,"orientationX"),me(l,i,"orientationY"),me(l,i,"orientationZ"),me(l,i,"positionX"),me(l,i,"positionY"),me(l,i,"positionZ"),le(l,i,"coneInnerAngle"),le(l,i,"coneOuterAngle"),le(l,i,"coneOuterGain"),le(l,i,"distanceModel"),le(l,i,"maxDistance"),le(l,i,"panningModel"),le(l,i,"refDistance"),le(l,i,"rolloffFactor"),l)})(nf),of=((p,t,i,l,d,v,y,_,S,C)=>()=>{const M=new WeakMap;let E=null;return{render(D,R){const B=M.get(R);return B!==void 0?Promise.resolve(B):(async($,L)=>{let z=null,q=v($);const F={channelCount:q.channelCount,channelCountMode:q.channelCountMode,channelInterpretation:q.channelInterpretation},X={...F,coneInnerAngle:q.coneInnerAngle,coneOuterAngle:q.coneOuterAngle,coneOuterGain:q.coneOuterGain,distanceModel:q.distanceModel,maxDistance:q.maxDistance,panningModel:q.panningModel,refDistance:q.refDistance,rolloffFactor:q.rolloffFactor},st=ot(q,L);if("bufferSize"in q)z=l(L,{...F,gain:1});else if(!st){const V={...X,orientationX:q.orientationX.value,orientationY:q.orientationY.value,orientationZ:q.orientationZ.value,positionX:q.positionX.value,positionY:q.positionY.value,positionZ:q.positionZ.value};q=d(L,V)}if(M.set(L,z===null?q:z),z!==null){if(E===null){if(y===null)throw new Error("Missing the native OfflineAudioContext constructor.");const ht=new y(6,$.context.length,L.sampleRate),Et=t(ht,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});Et.connect(ht.destination),E=(async()=>{const bt=await Promise.all([$.orientationX,$.orientationY,$.orientationZ,$.positionX,$.positionY,$.positionZ].map(async(yt,kt)=>{const gt=i(ht,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:kt===0?1:0});return await _(ht,yt,gt.offset),gt}));for(let yt=0;yt<6;yt+=1)bt[yt].connect(Et,0,yt),bt[yt].start(0);return C(ht)})()}const V=await E,U=l(L,{...F,gain:1});await S($,L,U);const W=[];for(let ht=0;ht<V.numberOfChannels;ht+=1)W.push(V.getChannelData(ht));let nt=[W[0][0],W[1][0],W[2][0]],j=[W[3][0],W[4][0],W[5][0]],K=l(L,{...F,gain:1}),ct=d(L,{...X,orientationX:nt[0],orientationY:nt[1],orientationZ:nt[2],positionX:j[0],positionY:j[1],positionZ:j[2]});U.connect(K).connect(ct.inputs[0]),ct.connect(z);for(let ht=128;ht<V.length;ht+=128){const Et=[W[0][ht],W[1][ht],W[2][ht]],bt=[W[3][ht],W[4][ht],W[5][ht]];if(Et.some((yt,kt)=>yt!==nt[kt])||bt.some((yt,kt)=>yt!==j[kt])){nt=Et,j=bt;const yt=ht/L.sampleRate;K.gain.setValueAtTime(0,yt),K=l(L,{...F,gain:0}),ct=d(L,{...X,orientationX:nt[0],orientationY:nt[1],orientationZ:nt[2],positionX:j[0],positionY:j[1],positionZ:j[2]}),K.gain.setValueAtTime(1,yt),U.connect(K).connect(ct.inputs[0]),ct.connect(z)}}return z}return st?(await p(L,$.orientationX,q.orientationX),await p(L,$.orientationY,q.orientationY),await p(L,$.orientationZ,q.orientationZ),await p(L,$.positionX,q.positionX),await p(L,$.positionY,q.positionY),await p(L,$.positionZ,q.positionZ)):(await _(L,$.orientationX,q.orientationX),await _(L,$.orientationY,q.orientationY),await _(L,$.orientationZ,q.orientationZ),await _(L,$.positionX,q.positionX),await _(L,$.positionY,q.positionY),await _(L,$.positionZ,q.positionZ)),Oe(q)?await S($,L,q.inputs[0]):await S($,L,q),q})(D,R)}}})(Vs,Sn,vi,Ke,su,Jt,De,Hs,Ne,Ar),rf=((p,t,i,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),M={...mm,...S},E=i(C,M),D=v(C);super(_,!1,E,D?l():null),this._nativePannerNode=E,this._orientationX=t(this,D,E.orientationX,zt,Bt),this._orientationY=t(this,D,E.orientationY,zt,Bt),this._orientationZ=t(this,D,E.orientationZ,zt,Bt),this._positionX=t(this,D,E.positionX,zt,Bt),this._positionY=t(this,D,E.positionY,zt,Bt),this._positionZ=t(this,D,E.positionZ,zt,Bt),y(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(_){this._nativePannerNode.coneInnerAngle=_}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(_){this._nativePannerNode.coneOuterAngle=_}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(_){this._nativePannerNode.coneOuterGain=_}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(_){this._nativePannerNode.distanceModel=_}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(_){this._nativePannerNode.maxDistance=_}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(_){this._nativePannerNode.panningModel=_}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(_){this._nativePannerNode.refDistance=_}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(_){this._nativePannerNode.rolloffFactor=_}})(ve,Rs,su,of,ne,Qt,zn),af=(p=>(t,{disableNormalization:i,imag:l,real:d})=>{const v=l instanceof Float32Array?l:new Float32Array(l),y=d instanceof Float32Array?d:new Float32Array(d),_=t.createPeriodicWave(y,v,{disableNormalization:i});if(Array.from(l).length<2)throw p();return _})(At),lf=((p,t,i,l)=>class zd{constructor(v,y){const _=t(v),S=(M=>{const{imag:E,real:D}=M;return E===void 0?D===void 0?{...M,imag:[0,0],real:[0,0]}:{...M,imag:Array.from(D,()=>0),real:D}:D===void 0?{...M,imag:E,real:Array.from(E,()=>0)}:{...M,imag:E,real:D}})({...fm,...y}),C=p(_,S);return i.add(C),C}static[Symbol.hasInstance](v){return v!==null&&typeof v=="object"&&Object.getPrototypeOf(v)===zd.prototype||i.has(v)}})(af,ne,new WeakSet),cf=((p,t,i,l,d,v)=>{const _=new Float32Array([1,1]),S=Math.PI/2,C={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},M={...C,oversample:"none"},E=(D,R,B,$,L)=>{if(R===1)return((z,q,F,X)=>{const st=new Float32Array(16385),V=new Float32Array(16385);for(let ct=0;ct<16385;ct+=1){const ht=ct/16384*S;st[ct]=Math.cos(ht),V[ct]=Math.sin(ht)}const U=i(z,{...C,gain:0}),W=l(z,{...M,curve:st}),nt=l(z,{...M,curve:_}),j=i(z,{...C,gain:0}),K=l(z,{...M,curve:V});return{connectGraph(){q.connect(U),q.connect(nt.inputs===void 0?nt:nt.inputs[0]),q.connect(j),nt.connect(F),F.connect(W.inputs===void 0?W:W.inputs[0]),F.connect(K.inputs===void 0?K:K.inputs[0]),W.connect(U.gain),K.connect(j.gain),U.connect(X,0,0),j.connect(X,0,1)},disconnectGraph(){q.disconnect(U),q.disconnect(nt.inputs===void 0?nt:nt.inputs[0]),q.disconnect(j),nt.disconnect(F),F.disconnect(W.inputs===void 0?W:W.inputs[0]),F.disconnect(K.inputs===void 0?K:K.inputs[0]),W.disconnect(U.gain),K.disconnect(j.gain),U.disconnect(X,0,0),j.disconnect(X,0,1)}}})(D,B,$,L);if(R===2)return((z,q,F,X)=>{const st=new Float32Array(16385),V=new Float32Array(16385),U=new Float32Array(16385),W=new Float32Array(16385),nt=Math.floor(8192.5);for(let qt=0;qt<16385;qt+=1)if(qt>nt){const Ht=(qt-nt)/(16384-nt)*S;st[qt]=Math.cos(Ht),V[qt]=Math.sin(Ht),U[qt]=0,W[qt]=1}else{const Ht=qt/(16384-nt)*S;st[qt]=1,V[qt]=0,U[qt]=Math.cos(Ht),W[qt]=Math.sin(Ht)}const j=t(z,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),K=i(z,{...C,gain:0}),ct=l(z,{...M,curve:st}),ht=i(z,{...C,gain:0}),Et=l(z,{...M,curve:V}),bt=l(z,{...M,curve:_}),yt=i(z,{...C,gain:0}),kt=l(z,{...M,curve:U}),gt=i(z,{...C,gain:0}),It=l(z,{...M,curve:W});return{connectGraph(){q.connect(j),q.connect(bt.inputs===void 0?bt:bt.inputs[0]),j.connect(K,0),j.connect(ht,0),j.connect(yt,1),j.connect(gt,1),bt.connect(F),F.connect(ct.inputs===void 0?ct:ct.inputs[0]),F.connect(Et.inputs===void 0?Et:Et.inputs[0]),F.connect(kt.inputs===void 0?kt:kt.inputs[0]),F.connect(It.inputs===void 0?It:It.inputs[0]),ct.connect(K.gain),Et.connect(ht.gain),kt.connect(yt.gain),It.connect(gt.gain),K.connect(X,0,0),yt.connect(X,0,0),ht.connect(X,0,1),gt.connect(X,0,1)},disconnectGraph(){q.disconnect(j),q.disconnect(bt.inputs===void 0?bt:bt.inputs[0]),j.disconnect(K,0),j.disconnect(ht,0),j.disconnect(yt,1),j.disconnect(gt,1),bt.disconnect(F),F.disconnect(ct.inputs===void 0?ct:ct.inputs[0]),F.disconnect(Et.inputs===void 0?Et:Et.inputs[0]),F.disconnect(kt.inputs===void 0?kt:kt.inputs[0]),F.disconnect(It.inputs===void 0?It:It.inputs[0]),ct.disconnect(K.gain),Et.disconnect(ht.gain),kt.disconnect(yt.gain),It.disconnect(gt.gain),K.disconnect(X,0,0),yt.disconnect(X,0,0),ht.disconnect(X,0,1),gt.disconnect(X,0,1)}}})(D,B,$,L);throw d()};return(D,{channelCount:R,channelCountMode:B,pan:$,...L})=>{if(B==="max")throw d();const z=p(D,{...L,channelCount:1,channelCountMode:B,numberOfInputs:2}),q=i(D,{...L,channelCount:R,channelCountMode:B,gain:1}),F=i(D,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:$});let{connectGraph:X,disconnectGraph:st}=E(D,R,q,F,z);Object.defineProperty(F.gain,"defaultValue",{get:()=>0}),Object.defineProperty(F.gain,"maxValue",{get:()=>1}),Object.defineProperty(F.gain,"minValue",{get:()=>-1});const V={get bufferSize(){},get channelCount(){return q.channelCount},set channelCount(W){q.channelCount!==W&&(U&&st(),{connectGraph:X,disconnectGraph:st}=E(D,W,q,F,z),U&&X()),q.channelCount=W},get channelCountMode(){return q.channelCountMode},set channelCountMode(W){if(W==="clamped-max"||W==="max")throw d();q.channelCountMode=W},get channelInterpretation(){return q.channelInterpretation},set channelInterpretation(W){q.channelInterpretation=W},get context(){return q.context},get inputs(){return[q]},get numberOfInputs(){return q.numberOfInputs},get numberOfOutputs(){return q.numberOfOutputs},get pan(){return F.gain},addEventListener:(...W)=>q.addEventListener(W[0],W[1],W[2]),dispatchEvent:(...W)=>q.dispatchEvent(W[0]),removeEventListener:(...W)=>q.removeEventListener(W[0],W[1],W[2])};let U=!1;return v(pi(V,z),()=>{X(),U=!0},()=>{st(),U=!1})}})(Sn,ao,Ke,Mr,je,xn),nu=((p,t)=>(i,l)=>{const d=l.channelCountMode;if(d==="clamped-max")throw t();if(i.createStereoPanner===void 0)return p(i,l);const v=i.createStereoPanner();return Te(v,l),me(v,l,"pan"),Object.defineProperty(v,"channelCountMode",{get:()=>d,set:y=>{if(y!==d)throw t()}}),v})(cf,je),hf=((p,t,i,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,M)=>{let E=i(C);const D=ot(E,M);if(!D){const R={channelCount:E.channelCount,channelCountMode:E.channelCountMode,channelInterpretation:E.channelInterpretation,pan:E.pan.value};E=t(M,R)}return v.set(M,E),D?await p(M,C.pan,E.pan):await l(M,C.pan,E.pan),Oe(E)?await d(C,M,E.inputs[0]):await d(C,M,E),E})(y,_)}}})(Vs,nu,Jt,Hs,Ne),uf=((p,t,i,l,d,v)=>class extends p{constructor(y,_){const S=d(y),C={...gm,..._},M=i(S,C),E=v(S);super(y,!1,M,E?l():null),this._pan=t(this,E,M.pan)}get pan(){return this._pan}})(ve,Rs,nu,hf,ne,Qt),df=((p,t,i)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ot(C,S)){const M={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,curve:C.curve,oversample:C.oversample};C=p(S,M)}return l.set(S,C),Oe(C)?await i(_,S,C.inputs[0]):await i(_,S,C),C})(d,v)}}})(Mr,Jt,Ne),pf=((p,t,i,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),M={...ym,...S},E=i(C,M);super(_,!0,E,v(C)?l():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=E,y(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(_){if(_===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(_.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=_}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(_){this._nativeWaveShaperNode.oversample=_}})(ve,Ie,Mr,df,ne,Qt,zn),iu=(p=>p!==null&&p.isSecureContext)(Ds),Ga=(p=>(t,i,l)=>{Object.defineProperties(p,{currentFrame:{configurable:!0,get:()=>Math.round(t*i)},currentTime:{configurable:!0,get:()=>t}});try{return l()}finally{p!==null&&(delete p.currentFrame,delete p.currentTime)}})(Ds),ou=new WeakMap,mf=((p,t)=>i=>{let l=p.get(i);if(l!==void 0)return l;if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");return l=new t(1,1,44100),p.set(i,l),l})(ou,De),ff=iu?((p,t,i,l,d,v,y,_,S,C,M,E,D)=>{let R=0;return(B,$,L={credentials:"omit"})=>{const z=M.get(B);if(z!==void 0&&z.has($))return Promise.resolve();const q=C.get(B);if(q!==void 0){const st=q.get($);if(st!==void 0)return st}const F=v(B),X=F.audioWorklet===void 0?d($).then(([st,V])=>{const[U,W]=Y(st,V);return i(`${U};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${W}
})})(window,'_AWGS')`)}).then(()=>{const st=D._AWGS.pop();if(st===void 0)throw new SyntaxError;l(F.currentTime,F.sampleRate,()=>st(class{},void 0,(V,U)=>{if(V.trim()==="")throw t();const W=O.get(F);if(W!==void 0){if(W.has(V))throw t();dt(U),ut(U.parameterDescriptors),W.set(V,U)}else dt(U),ut(U.parameterDescriptors),O.set(F,new Map([[V,U]]))},F.sampleRate,void 0,void 0))}):Promise.all([d($),Promise.resolve(p(E,E))]).then(([[st,V],U])=>{const W=R+1;R=W;const[nt,j]=Y(st,V),K=new Blob([`${nt};((AudioWorkletProcessor,registerProcessor)=>{${j}
})(${U?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${U?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${U?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${W}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),ct=URL.createObjectURL(K);return F.audioWorklet.addModule(ct,L).then(()=>{if(_(F))return F;const ht=y(F);return ht.audioWorklet.addModule(ct,L).then(()=>ht)}).then(ht=>{if(S===null)throw new SyntaxError;try{new S(ht,`__sac${W}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(ct))});return q===void 0?C.set(B,new Map([[$,X]])):q.set($,X),X.then(()=>{const st=M.get(B);st===void 0?M.set(B,new Set([$])):st.add($)}).finally(()=>{const st=C.get(B);st!==void 0&&st.delete($)}),X}})(ws,je,(p=>t=>new Promise((i,l)=>{if(p===null)return void l(new SyntaxError);const d=p.document.head;if(d===null)l(new SyntaxError);else{const v=p.document.createElement("script"),y=new Blob([t],{type:"application/javascript"}),_=URL.createObjectURL(y),S=p.onerror,C=()=>{p.onerror=S,URL.revokeObjectURL(_)};p.onerror=(M,E,D,R,B)=>E===_||E===p.location.href&&D===1&&R===1?(C(),l(B),!1):S!==null?S(M,E,D,R,B):void 0,v.onerror=()=>{C(),l(new SyntaxError)},v.onload=()=>{C(),i()},v.src=_,v.type="module",d.appendChild(v)}}))(Ds),Ga,async p=>{try{const t=await fetch(p);if(t.ok)return[await t.text(),t.url]}catch{}throw new DOMException("","AbortError")},ne,mf,Qt,fi,new WeakMap,new WeakMap,((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const i=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new t(1,128,44100),d=URL.createObjectURL(i);let v=!1,y=!1;try{await l.audioWorklet.addModule(d);const _=new p(l,"a",{numberOfOutputs:0}),S=l.createOscillator();_.port.onmessage=()=>v=!0,_.onprocessorerror=()=>y=!0,S.connect(_),S.start(0),await l.startRendering(),await new Promise(C=>setTimeout(C))}catch{}finally{URL.revokeObjectURL(d)}return v&&!y})(fi,De),Ds):void 0,gf=((p,t)=>i=>p(i)||t(i))(Ba,Qt),vf=((p,t,i,l,d,v,y,_,S,C,M)=>(E,D)=>{const R=y(E)?E:v(E);if(d.has(D)){const B=new DOMException("","DataCloneError");return Promise.reject(B)}try{d.add(D)}catch{}return t(S,()=>S(R))?R.decodeAudioData(D).then(B=>(Mh(D).catch(()=>{}),t(_,()=>_(B))||M(B),p.add(B),B)):new Promise((B,$)=>{const L=async()=>{try{await Mh(D)}catch{}},z=q=>{$(q),L()};try{R.decodeAudioData(D,q=>{typeof q.copyFromChannel!="function"&&(C(q),lt(q)),p.add(q),L().then(()=>B(q))},q=>{z(q===null?new DOMException("","EncodingError"):q)})}catch(q){z(q)}})})(za,ws,0,0,new WeakSet,ne,gf,pt,ro,Va,Ha),ru=((p,t,i,l,d,v,y,_,S,C,M,E,D,R,B,$,L,z,q,F)=>class extends B{constructor(X,st){super(X,st),this._nativeContext=X,this._audioWorklet=p===void 0?void 0:{addModule:(V,U)=>p(this,V,U)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new t(this)}createBiquadFilter(){return new d(this)}createBuffer(X,st,V){return new i({length:st,numberOfChannels:X,sampleRate:V})}createBufferSource(){return new l(this)}createChannelMerger(X=6){return new v(this,{numberOfInputs:X})}createChannelSplitter(X=6){return new y(this,{numberOfOutputs:X})}createConstantSource(){return new _(this)}createConvolver(){return new S(this)}createDelay(X=1){return new M(this,{maxDelayTime:X})}createDynamicsCompressor(){return new E(this)}createGain(){return new D(this)}createIIRFilter(X,st){return new R(this,{feedback:st,feedforward:X})}createOscillator(){return new $(this)}createPanner(){return new L(this)}createPeriodicWave(X,st,V={disableNormalization:!1}){return new z(this,{...V,imag:st,real:X})}createStereoPanner(){return new q(this)}createWaveShaper(){return new F(this)}decodeAudioData(X,st,V){return C(this._nativeContext,X).then(U=>(typeof st=="function"&&st(U),U),U=>{throw typeof V=="function"&&V(U),U})}})(ff,Am,Xh,Em,Im,Om,Lm,Bm,zm,vf,Vm,Gm,Um,Qm,Km,ef,rf,lf,uf,pf),yf=((p,t,i,l)=>class extends p{constructor(d,v){const y=i(d),_=((S,C)=>S.createMediaElementSource(C.mediaElement))(y,v);if(l(y))throw TypeError();super(d,!0,_,null),this._nativeMediaElementAudioSourceNode=_}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(ve,0,ne,Qt),bf=((p,t,i,l)=>class extends p{constructor(d,v){const y=i(d);if(l(y))throw new TypeError;const _=((S,C)=>{const M=S.createMediaStreamDestination();return Te(M,C),M.numberOfOutputs===1&&Object.defineProperty(M,"numberOfOutputs",{get:()=>0}),M})(y,{...hm,...v});super(d,!1,_,null),this._nativeMediaStreamAudioDestinationNode=_}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(ve,0,ne,Qt),_f=((p,t,i,l)=>class extends p{constructor(d,v){const y=i(d),_=((S,{mediaStream:C})=>{const M=C.getAudioTracks();M.sort((R,B)=>R.id<B.id?-1:R.id>B.id?1:0);const E=M.slice(0,1),D=S.createMediaStreamSource(new MediaStream(E));return Object.defineProperty(D,"mediaStream",{value:C}),D})(y,v);if(l(y))throw new TypeError;super(d,!0,_,null),this._nativeMediaStreamAudioSourceNode=_}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(ve,0,ne,Qt),wf=((p,t)=>(i,{mediaStreamTrack:l})=>{if(typeof i.createMediaStreamTrackSource=="function")return i.createMediaStreamTrackSource(l);const d=new MediaStream([l]),v=i.createMediaStreamSource(d);if(l.kind!=="audio")throw p();if(t(i))throw new TypeError;return v})(Ie,Qt),xf=((p,t,i)=>class extends p{constructor(l,d){const v=i(l);super(l,!0,t(v,d),null)}})(ve,wf,ne),Sf=((p,t,i,l,d,v,y,_,S)=>class extends p{constructor(C={}){if(S===null)throw new Error("Missing the native AudioContext constructor.");let M;try{M=new S(C)}catch(R){throw R.code===12&&R.message==="sampleRate is not in range"?i():R}if(M===null)throw l();if(!(R=>R===void 0||typeof R=="number"||typeof R=="string"&&(R==="balanced"||R==="interactive"||R==="playback"))(C.latencyHint))throw new TypeError(`The provided value '${C.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(C.sampleRate!==void 0&&M.sampleRate!==C.sampleRate)throw i();super(M,2);const{latencyHint:E}=C,{sampleRate:D}=M;if(this._baseLatency=typeof M.baseLatency=="number"?M.baseLatency:E==="balanced"?512/D:E==="interactive"||E===void 0?256/D:E==="playback"?1024/D:128*Math.max(2,Math.min(128,Math.round(E*D/128)))/D,this._nativeAudioContext=M,S.name==="webkitAudioContext"?(this._nativeGainNode=M.createGain(),this._nativeOscillatorNode=M.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(M.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,M.state==="running"){this._state="suspended";const R=()=>{this._state==="suspended"&&(this._state=null),M.removeEventListener("statechange",R)};M.addEventListener("statechange",R)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw t()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),os(this)}))}createMediaElementSource(C){return new d(this,{mediaElement:C})}createMediaStreamDestination(){return new v(this)}createMediaStreamSource(C){return new y(this,{mediaStream:C})}createMediaStreamTrackSource(C){return new _(this,{mediaStreamTrack:C})}resume(){return this._state==="suspended"?new Promise((C,M)=>{const E=()=>{this._nativeAudioContext.removeEventListener("statechange",E),this._nativeAudioContext.state==="running"?C():this.resume().then(C,M)};this._nativeAudioContext.addEventListener("statechange",E)}):this._nativeAudioContext.resume().catch(C=>{throw C===void 0||C.code===15?t():C})}suspend(){return this._nativeAudioContext.suspend().catch(C=>{throw C===void 0?t():C})}})(ru,Ie,je,vm,yf,bf,_f,xf,wn),ja=(p=>t=>{const i=p.get(t);if(i===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return i})(Kh),Cf=(p=>(t,i)=>{p(t).add(i)})(ja),au=(p=>(t,i,l=0,d=0)=>{const v=t[l];if(v===void 0)throw p();return ui(i)?v.connect(i,0,d):v.connect(i,0)})(At),Tf=(p=>(t,i)=>{p(t).delete(i)})(ja),lu=(p=>(t,i=void 0,l=void 0,d=0)=>i===void 0?t.forEach(v=>v.disconnect()):typeof i=="number"?xr(p,t,i).disconnect():ui(i)?l===void 0?t.forEach(v=>v.disconnect(i)):d===void 0?xr(p,t,l).disconnect(i,0):xr(p,t,l).disconnect(i,0,d):l===void 0?t.forEach(v=>v.disconnect(i)):xr(p,t,l).disconnect(i,0))(At),cu=new WeakMap,Af=((p,t)=>i=>t(p,i))(cu,it),Mf=((p,t,i,l,d,v,y,_,S,C,M,E,D)=>(R,B,$,L)=>{if(L.numberOfInputs===0&&L.numberOfOutputs===0)throw S();const z=Array.isArray(L.outputChannelCount)?L.outputChannelCount:Array.from(L.outputChannelCount);if(z.some(at=>at<1))throw S();if(z.length!==L.numberOfOutputs)throw t();if(L.channelCountMode!=="explicit")throw S();const q=L.channelCount*L.numberOfInputs,F=z.reduce((at,Gt)=>at+Gt,0),X=$.parameterDescriptors===void 0?0:$.parameterDescriptors.length;if(q+X>6||F>6)throw S();const st=new MessageChannel,V=[],U=[];for(let at=0;at<L.numberOfInputs;at+=1)V.push(y(R,{channelCount:L.channelCount,channelCountMode:L.channelCountMode,channelInterpretation:L.channelInterpretation,gain:1})),U.push(d(R,{channelCount:L.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:L.channelCount}));const W=[];if($.parameterDescriptors!==void 0)for(const{defaultValue:at,maxValue:Gt,minValue:We,name:de}of $.parameterDescriptors){const Vt=v(R,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:L.parameterData[de]!==void 0?L.parameterData[de]:at===void 0?0:at});Object.defineProperties(Vt.offset,{defaultValue:{get:()=>at===void 0?0:at},maxValue:{get:()=>Gt===void 0?zt:Gt},minValue:{get:()=>We===void 0?Bt:We}}),W.push(Vt)}const nt=l(R,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,q+X)}),j=kh(B,R.sampleRate),K=_(R,j,q+X,Math.max(1,F)),ct=d(R,{channelCount:Math.max(1,F),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,F)}),ht=[];for(let at=0;at<L.numberOfOutputs;at+=1)ht.push(l(R,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:z[at]}));for(let at=0;at<L.numberOfInputs;at+=1){V[at].connect(U[at]);for(let Gt=0;Gt<L.channelCount;Gt+=1)U[at].connect(nt,Gt,at*L.channelCount+Gt)}const Et=new br($.parameterDescriptors===void 0?[]:$.parameterDescriptors.map(({name:at},Gt)=>{const We=W[Gt];return We.connect(nt,0,q+Gt),We.start(0),[at,We.offset]}));nt.connect(K);let bt=L.channelInterpretation,yt=null;const kt=L.numberOfOutputs===0?[K]:ht,gt={get bufferSize(){return j},get channelCount(){return L.channelCount},set channelCount(at){throw i()},get channelCountMode(){return L.channelCountMode},set channelCountMode(at){throw i()},get channelInterpretation(){return bt},set channelInterpretation(at){for(const Gt of V)Gt.channelInterpretation=at;bt=at},get context(){return K.context},get inputs(){return V},get numberOfInputs(){return L.numberOfInputs},get numberOfOutputs(){return L.numberOfOutputs},get onprocessorerror(){return yt},set onprocessorerror(at){typeof yt=="function"&&gt.removeEventListener("processorerror",yt),yt=typeof at=="function"?at:null,typeof yt=="function"&&gt.addEventListener("processorerror",yt)},get parameters(){return Et},get port(){return st.port2},addEventListener:(...at)=>K.addEventListener(at[0],at[1],at[2]),connect:p.bind(null,kt),disconnect:C.bind(null,kt),dispatchEvent:(...at)=>K.dispatchEvent(at[0]),removeEventListener:(...at)=>K.removeEventListener(at[0],at[1],at[2])},It=new Map;var qt,Ht;st.port1.addEventListener=(qt=st.port1.addEventListener,(...at)=>{if(at[0]==="message"){const Gt=typeof at[1]=="function"?at[1]:typeof at[1]=="object"&&at[1]!==null&&typeof at[1].handleEvent=="function"?at[1].handleEvent:null;if(Gt!==null){const We=It.get(at[1]);We!==void 0?at[1]=We:(at[1]=de=>{M(R.currentTime,R.sampleRate,()=>Gt(de))},It.set(Gt,at[1]))}}return qt.call(st.port1,at[0],at[1],at[2])}),st.port1.removeEventListener=(Ht=st.port1.removeEventListener,(...at)=>{if(at[0]==="message"){const Gt=It.get(at[1]);Gt!==void 0&&(It.delete(at[1]),at[1]=Gt)}return Ht.call(st.port1,at[0],at[1],at[2])});let oe=null;Object.defineProperty(st.port1,"onmessage",{get:()=>oe,set:at=>{typeof oe=="function"&&st.port1.removeEventListener("message",oe),oe=typeof at=="function"?at:null,typeof oe=="function"&&(st.port1.addEventListener("message",oe),st.port1.start())}}),$.prototype.port=st.port1;let ge=null;((at,Gt,We,de)=>{let Vt=N.get(at);Vt===void 0&&(Vt=new WeakMap,N.set(at,Vt));const re=(async(ss,Us)=>{const Xs=await(nc=>new Promise((ic,Pg)=>{const{port1:jr,port2:oc}=new MessageChannel;jr.onmessage=({data:rc})=>{jr.close(),oc.close(),ic(rc)},jr.onmessageerror=({data:rc})=>{jr.close(),oc.close(),Pg(rc)},oc.postMessage(nc)}))(Us);return new ss(Xs)})(We,de);return Vt.set(Gt,re),re})(R,gt,$,L).then(at=>ge=at);const $t=wr(L.numberOfInputs,L.channelCount),mt=wr(L.numberOfOutputs,z),te=$.parameterDescriptors===void 0?[]:$.parameterDescriptors.reduce((at,{name:Gt})=>({...at,[Gt]:new Float32Array(128)}),{});let Yt=!0;const ze=()=>{L.numberOfOutputs>0&&K.disconnect(ct);for(let at=0,Gt=0;at<L.numberOfOutputs;at+=1){const We=ht[at];for(let de=0;de<z[at];de+=1)ct.disconnect(We,Gt+de,de);Gt+=z[at]}},Dn=new Map;K.onaudioprocess=({inputBuffer:at,outputBuffer:Gt})=>{if(ge!==null){const We=E(gt);for(let de=0;de<j;de+=128){for(let Vt=0;Vt<L.numberOfInputs;Vt+=1)for(let re=0;re<L.channelCount;re+=1)qn(at,$t[Vt],re,re,de);$.parameterDescriptors!==void 0&&$.parameterDescriptors.forEach(({name:Vt},re)=>{qn(at,te,Vt,q+re,de)});for(let Vt=0;Vt<L.numberOfInputs;Vt+=1)for(let re=0;re<z[Vt];re+=1)mt[Vt][re].byteLength===0&&(mt[Vt][re]=new Float32Array(128));try{const Vt=$t.map((ss,Us)=>{if(We[Us].size>0)return Dn.set(Us,j/128),ss;const Xs=Dn.get(Us);return Xs===void 0?[]:(ss.every(nc=>nc.every(ic=>ic===0))&&(Xs===1?Dn.delete(Us):Dn.set(Us,Xs-1)),ss)});Yt=M(R.currentTime+de/R.sampleRate,R.sampleRate,()=>ge.process(Vt,mt,te));for(let ss=0,Us=0;ss<L.numberOfOutputs;ss+=1){for(let Xs=0;Xs<z[ss];Xs+=1)di(Gt,mt[ss],Xs,Us+Xs,de);Us+=z[ss]}}catch(Vt){Yt=!1,gt.dispatchEvent(new ErrorEvent("processorerror",{colno:Vt.colno,filename:Vt.filename,lineno:Vt.lineno,message:Vt.message}))}if(!Yt){for(let Vt=0;Vt<L.numberOfInputs;Vt+=1){V[Vt].disconnect(U[Vt]);for(let re=0;re<L.channelCount;re+=1)U[de].disconnect(nt,re,Vt*L.channelCount+re)}if($.parameterDescriptors!==void 0){const Vt=$.parameterDescriptors.length;for(let re=0;re<Vt;re+=1){const ss=W[re];ss.disconnect(nt,0,q+re),ss.stop()}}nt.disconnect(K),K.onaudioprocess=null,ec?ze():$u();break}}}};let ec=!1;const sc=y(R,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Fu=()=>K.connect(sc).connect(R.destination),$u=()=>{K.disconnect(sc),sc.disconnect()};return Fu(),D(gt,()=>{if(Yt){$u(),L.numberOfOutputs>0&&K.connect(ct);for(let at=0,Gt=0;at<L.numberOfOutputs;at+=1){const We=ht[at];for(let de=0;de<z[at];de+=1)ct.connect(We,Gt+de,de);Gt+=z[at]}}ec=!0},()=>{Yt&&(Fu(),ze()),ec=!1})})(au,At,Ie,Sn,ao,vi,Ke,lo,je,lu,Ga,Af,xn),Ef=((p,t,i,l,d)=>(v,y,_,S,C,M)=>{if(_!==null)try{const R=new _(v,S,M),B=new Map;let $=null;if(Object.defineProperties(R,{channelCount:{get:()=>M.channelCount,set:()=>{throw p()}},channelCountMode:{get:()=>"explicit",set:()=>{throw p()}},onprocessorerror:{get:()=>$,set:L=>{typeof $=="function"&&R.removeEventListener("processorerror",$),$=typeof L=="function"?L:null,typeof $=="function"&&R.addEventListener("processorerror",$)}}}),R.addEventListener=(D=R.addEventListener,(...L)=>{if(L[0]==="processorerror"){const z=typeof L[1]=="function"?L[1]:typeof L[1]=="object"&&L[1]!==null&&typeof L[1].handleEvent=="function"?L[1].handleEvent:null;if(z!==null){const q=B.get(L[1]);q!==void 0?L[1]=q:(L[1]=F=>{F.type==="error"?(Object.defineProperties(F,{type:{value:"processorerror"}}),z(F)):z(new ErrorEvent(L[0],{...F}))},B.set(z,L[1]))}}return D.call(R,"error",L[1],L[2]),D.call(R,...L)}),R.removeEventListener=(E=R.removeEventListener,(...L)=>{if(L[0]==="processorerror"){const z=B.get(L[1]);z!==void 0&&(B.delete(L[1]),L[1]=z)}return E.call(R,"error",L[1],L[2]),E.call(R,L[0],L[1],L[2])}),M.numberOfOutputs!==0){const L=i(v,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return R.connect(L).connect(v.destination),d(R,()=>L.disconnect(),()=>L.connect(v.destination))}return R}catch(R){throw R.code===11?l():R}var E,D;if(C===void 0)throw l();return(R=>{const{port1:B}=new MessageChannel;try{B.postMessage(R)}finally{B.close()}})(M),t(v,y,C,M)})(Ie,Mf,Ke,je,xn),Pf=((p,t,i,l,d,v,y,_,S,C,M,E,D,R,B,$)=>(L,z,q)=>{const F=new WeakMap;let X=null;return{render(st,V){_(V,st);const U=F.get(V);return U!==void 0?Promise.resolve(U):(async(W,nt)=>{let j=M(W),K=null;const ct=ot(j,nt),ht=Array.isArray(z.outputChannelCount)?z.outputChannelCount:Array.from(z.outputChannelCount);if(E===null){const Et=ht.reduce((gt,It)=>gt+It,0),bt=d(nt,{channelCount:Math.max(1,Et),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,Et)}),yt=[];for(let gt=0;gt<W.numberOfOutputs;gt+=1)yt.push(l(nt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:ht[gt]}));const kt=y(nt,{channelCount:z.channelCount,channelCountMode:z.channelCountMode,channelInterpretation:z.channelInterpretation,gain:1});kt.connect=t.bind(null,yt),kt.disconnect=S.bind(null,yt),K=[bt,yt,kt]}else ct||(j=new E(nt,L));if(F.set(nt,K===null?j:K[2]),K!==null){if(X===null){if(q===void 0)throw new Error("Missing the processor constructor.");if(D===null)throw new Error("Missing the native OfflineAudioContext constructor.");const It=W.channelCount*W.numberOfInputs,qt=q.parameterDescriptors===void 0?0:q.parameterDescriptors.length,Ht=It+qt;X=tm(W,Ht===0?null:await(async()=>{const ge=new D(Ht,128*Math.ceil(W.context.length/128),nt.sampleRate),es=[],$t=[];for(let Yt=0;Yt<z.numberOfInputs;Yt+=1)es.push(y(ge,{channelCount:z.channelCount,channelCountMode:z.channelCountMode,channelInterpretation:z.channelInterpretation,gain:1})),$t.push(d(ge,{channelCount:z.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:z.channelCount}));const mt=await Promise.all(Array.from(W.parameters.values()).map(async Yt=>{const ze=v(ge,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Yt.value});return await R(ge,Yt,ze.offset),ze})),te=l(ge,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,It+qt)});for(let Yt=0;Yt<z.numberOfInputs;Yt+=1){es[Yt].connect($t[Yt]);for(let ze=0;ze<z.channelCount;ze+=1)$t[Yt].connect(te,ze,Yt*z.channelCount+ze)}for(const[Yt,ze]of mt.entries())ze.connect(te,0,It+Yt),ze.start(0);return te.connect(ge.destination),await Promise.all(es.map(Yt=>B(W,ge,Yt))),$(ge)})(),nt,z,ht,q,C)}const Et=await X,bt=i(nt,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[yt,kt,gt]=K;Et!==null&&(bt.buffer=Et,bt.start(0)),bt.connect(yt);for(let It=0,qt=0;It<W.numberOfOutputs;It+=1){const Ht=kt[It];for(let oe=0;oe<ht[It];oe+=1)yt.connect(Ht,qt+oe,oe);qt+=ht[It]}return gt}if(ct)for(const[Et,bt]of W.parameters.entries())await p(nt,bt,j.parameters.get(Et));else for(const[Et,bt]of W.parameters.entries())await R(nt,bt,j.parameters.get(Et));return await B(W,nt,j),j})(st,V)}}})(Vs,au,gi,Sn,ao,vi,Ke,Tf,lu,Ga,Jt,fi,De,Hs,Ne,Ar),kf=(p=>t=>p.get(t))(ou),If=(p=>(t,i)=>{p.set(t,i)})(cu),hu=iu?((p,t,i,l,d,v,y,_,S,C,M,E,D,R)=>class extends t{constructor(B,$,L){var z;const q=_(B),F=S(q),X=(K=>({...K,outputChannelCount:K.outputChannelCount!==void 0?K.outputChannelCount:K.numberOfInputs===1&&K.numberOfOutputs===1?[K.channelCount]:Array.from({length:K.numberOfOutputs},()=>1)}))({..._r,...L});(K=>{const{port1:ct,port2:ht}=new MessageChannel;try{ct.postMessage(K)}finally{ct.close(),ht.close()}})(X);const st=O.get(q),V=st==null?void 0:st.get($),U=F||q.state!=="closed"?q:(z=y(q))!==null&&z!==void 0?z:q,W=d(U,F?null:B.baseLatency,C,$,V,X);super(B,!0,W,F?l($,X,V):null);const nt=[];W.parameters.forEach((K,ct)=>{const ht=i(this,F,K);nt.push([ct,ht])}),this._nativeAudioWorkletNode=W,this._onprocessorerror=null,this._parameters=new br(nt),F&&p(q,this);const{activeInputs:j}=v(this);E(W,j)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(B){const $=typeof B=="function"?R(this,B):null;this._nativeAudioWorkletNode.onprocessorerror=$;const L=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=L!==null&&L===$?B:L}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(Cf,ve,Rs,Pf,Ef,Xt,kf,ne,Qt,fi,0,If,0,mi):void 0,Df=((p,t)=>(i,l,d)=>{if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(i,l,d)}catch(v){throw v.name==="SyntaxError"?p():v}})(je,De),Rf=((p,t,i,l,d,v,y,_)=>(S,C)=>i(S).render(S,C).then(()=>Promise.all(Array.from(l(C)).map(M=>i(M).render(M,C)))).then(()=>d(C)).then(M=>(typeof M.copyFromChannel!="function"?(y(M),lt(M)):t(v,()=>v(M))||_(M),p.add(M),M)))(za,ws,$a,ja,Ar,pt,Va,Ha),Of=((p,t,i,l,d)=>class extends p{constructor(v,y,_){let S;if(typeof v=="number"&&y!==void 0&&_!==void 0)S={length:y,numberOfChannels:v,sampleRate:_};else{if(typeof v!="object")throw new Error("The given parameters are not valid.");S=v}const{length:C,numberOfChannels:M,sampleRate:E}={...dm,...S},D=l(M,C,E);t(ro,()=>ro(D))||D.addEventListener("statechange",(()=>{let R=0;const B=$=>{this._state==="running"&&(R>0?(D.removeEventListener("statechange",B),$.stopImmediatePropagation(),this._waitForThePromiseToSettle($)):R+=1)};return B})()),super(D,M),this._length=C,this._nativeOfflineAudioContext=D,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(i()):(this._state="running",d(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,os(this)}))}_waitForThePromiseToSettle(v){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(v):setTimeout(()=>this._waitForThePromiseToSettle(v))}})(ru,ws,Ie,Df,Rf),Nf=((p,t)=>i=>{const l=p.get(i);return t(l)||t(i)})(I,Ba),Lf=((p,t)=>i=>p.has(i)||t(i))(w,qa),Ff=((p,t)=>i=>p.has(i)||t(i))(A,Hh),$f=((p,t)=>i=>{const l=p.get(i);return t(l)||t(i)})(I,Qt),Bf=()=>(async(p,t,i,l,d,v,y,_,S,C,M,E,D,R,B,$)=>!!(p(t,t)&&p(i,i)&&p(d,d)&&p(v,v)&&p(_,_)&&p(S,S)&&p(C,C)&&p(M,M)&&p(E,E)&&p(D,D)&&p(R,R))&&(await Promise.all([p(l,l),p(y,y),p(B,B),p($,$)])).every(L=>L))(ws,(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createBuffer(1,1,44100);if(t.copyToChannel===void 0)return!0;const i=new Float32Array(2);try{t.copyFromChannel(i,0,0)}catch{return!1}return!0})(De),(p=>()=>{if(p===null)return!1;if(p.prototype!==void 0&&p.prototype.close!==void 0)return!0;const t=new p,i=t.close!==void 0;try{t.close()}catch{}return i})(wn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);return new Promise(i=>{let l=!0;const d=y=>{l&&(l=!1,t.startRendering(),i(y instanceof TypeError))};let v;try{v=t.decodeAudioData(null,()=>{},d)}catch(y){d(y)}v!==void 0&&v.catch(d)})})(De),(p=>()=>{if(p===null)return!1;let t;try{t=new p({latencyHint:"balanced"})}catch{return!1}return t.close(),!0})(wn),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createGain(),i=t.connect(t)===t;return t.disconnect(t),i})(De),((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const i=new Blob(['let c,p;class A extends AudioWorkletProcessor{constructor(){super();this.port.onmessage=(e)=>{p=e.data;p.onmessage=()=>{p.postMessage(c);p.close()};this.port.postMessage(0)}}process(){c=1}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new MessageChannel,d=new t(1,128,44100),v=URL.createObjectURL(i);let y=!1;try{await d.audioWorklet.addModule(v);const _=new p(d,"a",{numberOfOutputs:0}),S=d.createOscillator();await new Promise(C=>{_.port.onmessage=()=>C(),_.port.postMessage(l.port2,[l.port2])}),_.port.onmessage=()=>y=!0,S.connect(_),S.start(0),await d.startRendering(),y=await new Promise(C=>{l.port1.onmessage=({data:M})=>C(M===1),l.port1.postMessage(0)})}catch{}finally{l.port1.close(),URL.revokeObjectURL(v)}return y})(fi,De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createChannelMerger();if(t.channelCountMode==="max")return!0;try{t.channelCount=2}catch{return!0}return!1})(De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100);return t.createConstantSource===void 0||t.createConstantSource().offset.maxValue!==Number.POSITIVE_INFINITY})(De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100),i=t.createConvolver();i.buffer=t.createBuffer(1,1,t.sampleRate);try{i.buffer=t.createBuffer(1,1,t.sampleRate)}catch{return!1}return!0})(De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createConvolver();try{t.channelCount=1}catch{return!1}return!0})(De),bm,(p=>()=>p!==null&&p.hasOwnProperty("isSecureContext"))(Ds),(p=>()=>{if(p===null)return!1;const t=new p;try{return t.createMediaStreamSource(new MediaStream),!1}catch{return!0}finally{t.close()}})(wn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);if(t.createStereoPanner===void 0||t.createConstantSource===void 0)return Promise.resolve(!0);const i=t.createConstantSource(),l=t.createStereoPanner();return i.channelCount=1,i.offset.value=1,l.channelCount=1,i.start(),i.connect(l).connect(t.destination),t.startRendering().then(d=>d.getChannelData(0)[0]!==1)})(De),_m);function ts(p){return p===void 0}function Ot(p){return p!==void 0}function uu(p){return typeof p=="function"}function rs(p){return typeof p=="number"}function rn(p){return Object.prototype.toString.call(p)==="[object Object]"&&p.constructor===Object}function Ua(p){return typeof p=="boolean"}function Le(p){return Array.isArray(p)}function Os(p){return typeof p=="string"}function uo(p){return Os(p)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(p)}function wt(p,t){if(!p)throw new Error(t)}function Fe(p,t,i=1/0){if(!(t<=p&&p<=i))throw new RangeError(`Value must be within [${t}, ${i}], got: ${p}`)}function Xa(p){p.isOffline||p.state==="running"||yi('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let du=!1,pu=!1;function Ya(p){du=p}function mu(p){ts(p)&&du&&!pu&&(pu=!0,yi("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let Za=console;function qf(p){Za=p}function fu(...p){Za.log(...p)}function yi(...p){Za.warn(...p)}const as=typeof self=="object"?self:null,zf=as&&(as.hasOwnProperty("AudioContext")||as.hasOwnProperty("webkitAudioContext"));function Ns(p,t,i,l){var d,v=arguments.length,y=v<3?t:l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")y=Reflect.decorate(p,t,i,l);else for(var _=p.length-1;_>=0;_--)(d=p[_])&&(y=(v<3?d(y):v>3?d(t,i,y):d(t,i))||y);return v>3&&y&&Object.defineProperty(t,i,y),y}function Kt(p,t,i,l){return new(i||(i=Promise))(function(d,v){function y(C){try{S(l.next(C))}catch(M){v(M)}}function _(C){try{S(l.throw(C))}catch(M){v(M)}}function S(C){var M;C.done?d(C.value):(M=C.value,M instanceof i?M:new i(function(E){E(M)})).then(y,_)}S((l=l.apply(p,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;class Wf{constructor(t,i,l,d){this._callback=t,this._type=i,this._minimumUpdateInterval=Math.max(128/(d||44100),.001),this.updateInterval=l,this._createClock()}_createWorker(){const t=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),i=URL.createObjectURL(t),l=new Worker(i);l.onmessage=this._callback.bind(this),this._worker=l}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},1e3*this._updateInterval)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(t){var i;this._updateInterval=Math.max(t,this._minimumUpdateInterval),this._type==="worker"&&((i=this._worker)===null||i===void 0||i.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(t){this._disposeClock(),this._type=t,this._createClock()}dispose(){this._disposeClock()}}function Wn(p){return Ff(p)}function Cn(p){return Lf(p)}function Er(p){return $f(p)}function bi(p){return Nf(p)}function Vf(p,t){return p==="value"||Wn(t)||Cn(t)||function(i){return i instanceof Xh}(t)}function xs(p,...t){if(!t.length)return p;const i=t.shift();if(rn(p)&&rn(i))for(const l in i)Vf(l,i[l])?p[l]=i[l]:rn(i[l])?(p[l]||Object.assign(p,{[l]:{}}),xs(p[l],i[l])):Object.assign(p,{[l]:i[l]});return xs(p,...t)}function Q(p,t,i=[],l){const d={},v=Array.from(t);if(rn(v[0])&&l&&!Reflect.has(v[0],l)&&(Object.keys(v[0]).some(y=>Reflect.has(p,y))||(xs(d,{[l]:v[0]}),i.splice(i.indexOf(l),1),v.shift())),v.length===1&&rn(v[0]))xs(d,v[0]);else for(let y=0;y<i.length;y++)Ot(v[y])&&(d[i[y]]=v[y]);return xs(p,d)}function Ss(p,t){return ts(p)?t:p}function $e(p,t){return t.forEach(i=>{Reflect.has(p,i)&&delete p[i]}),p}class an{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...t){(this.debug||as&&this.toString()===as.TONE_DEBUG_CLASS)&&fu(this,...t)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}an.version=m;const Qa=1e-6;function _i(p,t){return p>t+Qa}function Ja(p,t){return _i(p,t)||Ls(p,t)}function Pr(p,t){return p+Qa<t}function Ls(p,t){return Math.abs(p-t)<Qa}function Vn(p,t,i){return Math.max(Math.min(p,i),t)}class ls extends an{constructor(){super(),this.name="Timeline",this._timeline=[];const t=Q(ls.getDefaults(),arguments,["memory"]);this.memory=t.memory,this.increasing=t.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(t){if(wt(Reflect.has(t,"time"),"Timeline: events must have a time attribute"),t.time=t.time.valueOf(),this.increasing&&this.length){const i=this._timeline[this.length-1];wt(Ja(t.time,i.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(t)}else{const i=this._search(t.time);this._timeline.splice(i+1,0,t)}if(this.length>this.memory){const i=this.length-this.memory;this._timeline.splice(0,i)}return this}remove(t){const i=this._timeline.indexOf(t);return i!==-1&&this._timeline.splice(i,1),this}get(t,i="time"){const l=this._search(t,i);return l!==-1?this._timeline[l]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(t,i="time"){const l=this._search(t,i);return l+1<this._timeline.length?this._timeline[l+1]:null}getBefore(t){const i=this._timeline.length;if(i>0&&this._timeline[i-1].time<t)return this._timeline[i-1];const l=this._search(t);return l-1>=0?this._timeline[l-1]:null}cancel(t){if(this._timeline.length>1){let i=this._search(t);if(i>=0)if(Ls(this._timeline[i].time,t)){for(let l=i;l>=0&&Ls(this._timeline[l].time,t);l--)i=l;this._timeline=this._timeline.slice(0,i)}else this._timeline=this._timeline.slice(0,i+1);else this._timeline=[]}else this._timeline.length===1&&Ja(this._timeline[0].time,t)&&(this._timeline=[]);return this}cancelBefore(t){const i=this._search(t);return i>=0&&(this._timeline=this._timeline.slice(i+1)),this}previousEvent(t){const i=this._timeline.indexOf(t);return i>0?this._timeline[i-1]:null}_search(t,i="time"){if(this._timeline.length===0)return-1;let l=0;const d=this._timeline.length;let v=d;if(d>0&&this._timeline[d-1][i]<=t)return d-1;for(;l<v;){let y=Math.floor(l+(v-l)/2);const _=this._timeline[y],S=this._timeline[y+1];if(Ls(_[i],t)){for(let C=y;C<this._timeline.length&&Ls(this._timeline[C][i],t);C++)y=C;return y}if(Pr(_[i],t)&&_i(S[i],t))return y;_i(_[i],t)?v=y:l=y+1}return-1}_iterate(t,i=0,l=this._timeline.length-1){this._timeline.slice(i,l+1).forEach(t)}forEach(t){return this._iterate(t),this}forEachBefore(t,i){const l=this._search(t);return l!==-1&&this._iterate(i,0,l),this}forEachAfter(t,i){const l=this._search(t);return this._iterate(i,l+1),this}forEachBetween(t,i,l){let d=this._search(t),v=this._search(i);return d!==-1&&v!==-1?(this._timeline[d].time!==t&&(d+=1),this._timeline[v].time===i&&(v-=1),this._iterate(l,d,v)):d===-1&&this._iterate(l,0,v),this}forEachFrom(t,i){let l=this._search(t);for(;l>=0&&this._timeline[l].time>=t;)l--;return this._iterate(i,l+1),this}forEachAtTime(t,i){const l=this._search(t);if(l!==-1&&Ls(this._timeline[l].time,t)){let d=l;for(let v=l;v>=0&&Ls(this._timeline[v].time,t);v--)d=v;this._iterate(v=>{i(v)},d,l)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const gu=[];function kr(p){gu.push(p)}const vu=[];function Ir(p){vu.push(p)}class wi extends an{constructor(){super(...arguments),this.name="Emitter"}on(t,i){return t.split(/\W+/).forEach(l=>{ts(this._events)&&(this._events={}),this._events.hasOwnProperty(l)||(this._events[l]=[]),this._events[l].push(i)}),this}once(t,i){const l=(...d)=>{i(...d),this.off(t,l)};return this.on(t,l),this}off(t,i){return t.split(/\W+/).forEach(l=>{if(ts(this._events)&&(this._events={}),this._events.hasOwnProperty(l))if(ts(i))this._events[l]=[];else{const d=this._events[l];for(let v=d.length-1;v>=0;v--)d[v]===i&&d.splice(v,1)}}),this}emit(t,...i){if(this._events&&this._events.hasOwnProperty(t)){const l=this._events[t].slice(0);for(let d=0,v=l.length;d<v;d++)l[d].apply(this,i)}return this}static mixin(t){["on","once","off","emit"].forEach(i=>{const l=Object.getOwnPropertyDescriptor(wi.prototype,i);Object.defineProperty(t.prototype,i,l)})}dispose(){return super.dispose(),this._events=void 0,this}}class Ka extends wi{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class xi extends Ka{constructor(){var t,i;super(),this.name="Context",this._constants=new Map,this._timeouts=new ls,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const l=Q(xi.getDefaults(),arguments,["context"]);l.context?(this._context=l.context,this._latencyHint=((t=arguments[0])===null||t===void 0?void 0:t.latencyHint)||""):(this._context=function(d){return new Sf(d)}({latencyHint:l.latencyHint}),this._latencyHint=l.latencyHint),this._ticker=new Wf(this.emit.bind(this,"tick"),l.clockSource,l.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((i=arguments[0])===null||i===void 0)&&i.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=l.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var t;return this._initialized||(t=this,gu.forEach(i=>i(t)),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(t,i,l){return this._context.createBuffer(t,i,l)}createChannelMerger(t){return this._context.createChannelMerger(t)}createChannelSplitter(t){return this._context.createChannelSplitter(t)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(t){return this._context.createDelay(t)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(t,i){return this._context.createIIRFilter(t,i)}createPanner(){return this._context.createPanner()}createPeriodicWave(t,i,l){return this._context.createPeriodicWave(t,i,l)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(t){return wt(bi(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(t)}createMediaElementSource(t){return wt(bi(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(t)}createMediaStreamDestination(){return wt(bi(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(t){return this._context.decodeAudioData(t)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(t){wt(!this._initialized,"The listener cannot be set after initialization."),this._listener=t}get transport(){return this.initialize(),this._transport}set transport(t){wt(!this._initialized,"The transport cannot be set after initialization."),this._transport=t}get draw(){return this.initialize(),this._draw}set draw(t){wt(!this._initialized,"Draw cannot be set after initialization."),this._draw=t}get destination(){return this.initialize(),this._destination}set destination(t){wt(!this._initialized,"The destination cannot be set after initialization."),this._destination=t}createAudioWorkletNode(t,i){return function(l,d,v){return wt(Ot(hu),"AudioWorkletNode only works in a secure context (https or localhost)"),new(l instanceof(as==null?void 0:as.BaseAudioContext)?as==null?void 0:as.AudioWorkletNode:hu)(l,d,v)}(this.rawContext,t,i)}addAudioWorkletModule(t){return Kt(this,void 0,void 0,function*(){wt(Ot(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(t)),yield this._workletPromise})}workletsAreReady(){return Kt(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(t){this._ticker.updateInterval=t}get clockSource(){return this._ticker.type}set clockSource(t){this._ticker.type=t}get lookAhead(){return this._lookAhead}set lookAhead(t){this._lookAhead=t,this.updateInterval=t?t/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return bi(this._context)?this._context.resume():Promise.resolve()}close(){return Kt(this,void 0,void 0,function*(){var t;bi(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(t=this,vu.forEach(i=>i(t)))})}getConstant(t){if(this._constants.has(t))return this._constants.get(t);{const i=this._context.createBuffer(1,128,this._context.sampleRate),l=i.getChannelData(0);for(let v=0;v<l.length;v++)l[v]=t;const d=this._context.createBufferSource();return d.channelCount=1,d.channelCountMode="explicit",d.buffer=i,d.loop=!0,d.start(0),this._constants.set(t,d),d}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(t=>this._constants[t].disconnect()),this.close(),this}_timeoutLoop(){const t=this.now();let i=this._timeouts.peek();for(;this._timeouts.length&&i&&i.time<=t;)i.callback(),this._timeouts.shift(),i=this._timeouts.peek()}setTimeout(t,i){this._timeoutIds++;const l=this.now();return this._timeouts.add({callback:t,id:this._timeoutIds,time:l+i}),this._timeoutIds}clearTimeout(t){return this._timeouts.forEach(i=>{i.id===t&&this._timeouts.remove(i)}),this}clearInterval(t){return this.clearTimeout(t)}setInterval(t,i){const l=++this._timeoutIds,d=()=>{const v=this.now();this._timeouts.add({callback:()=>{t(),d()},id:l,time:v+i})};return d(),l}}function Tt(p,t){Le(t)?t.forEach(i=>Tt(p,i)):Object.defineProperty(p,t,{enumerable:!0,writable:!1})}function po(p,t){Le(t)?t.forEach(i=>po(p,i)):Object.defineProperty(p,t,{writable:!0})}const Ft=()=>{};class Wt extends an{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Ft;const t=Q(Wt.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=t.reverse,this.onload=t.onload,Os(t.url)?this.load(t.url).catch(t.onerror):t.url&&this.set(t.url)}static getDefaults(){return{onerror:Ft,onload:Ft,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:ie().sampleRate}set(t){return t instanceof Wt?t.loaded?this._buffer=t.get():t.onload=()=>{this.set(t),this.onload(this)}:this._buffer=t,this._reversed&&this._reverse(),this}get(){return this._buffer}load(t){return Kt(this,void 0,void 0,function*(){const i=Wt.load(t).then(l=>{this.set(l),this.onload(this)});Wt.downloads.push(i);try{yield i}finally{const l=Wt.downloads.indexOf(i);Wt.downloads.splice(l,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(t){const i=Le(t)&&t[0].length>0,l=i?t.length:1,d=i?t[0].length:t.length,v=ie(),y=v.createBuffer(l,d,v.sampleRate),_=i||l!==1?t:[t];for(let S=0;S<l;S++)y.copyToChannel(_[S],S);return this._buffer=y,this}toMono(t){if(rs(t))this.fromArray(this.toArray(t));else{let i=new Float32Array(this.length);const l=this.numberOfChannels;for(let d=0;d<l;d++){const v=this.toArray(d);for(let y=0;y<v.length;y++)i[y]+=v[y]}i=i.map(d=>d/l),this.fromArray(i)}return this}toArray(t){if(rs(t))return this.getChannelData(t);if(this.numberOfChannels===1)return this.toArray(0);{const i=[];for(let l=0;l<this.numberOfChannels;l++)i[l]=this.getChannelData(l);return i}}getChannelData(t){return this._buffer?this._buffer.getChannelData(t):new Float32Array(0)}slice(t,i=this.duration){wt(this.loaded,"Buffer is not loaded");const l=Math.floor(t*this.sampleRate),d=Math.floor(i*this.sampleRate);wt(l<d,"The start time must be less than the end time");const v=d-l,y=ie().createBuffer(this.numberOfChannels,v,this.sampleRate);for(let _=0;_<this.numberOfChannels;_++)y.copyToChannel(this.getChannelData(_).subarray(l,d),_);return new Wt(y)}_reverse(){if(this.loaded)for(let t=0;t<this.numberOfChannels;t++)this.getChannelData(t).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(t){this._reversed!==t&&(this._reversed=t,this._reverse())}static fromArray(t){return new Wt().fromArray(t)}static fromUrl(t){return Kt(this,void 0,void 0,function*(){return yield new Wt().load(t)})}static load(t){return Kt(this,void 0,void 0,function*(){const i=t.match(/\[([^\]\[]+\|.+)\]$/);if(i){const _=i[1].split("|");let S=_[0];for(const C of _)if(Wt.supportsType(C)){S=C;break}t=t.replace(i[0],S)}const l=Wt.baseUrl===""||Wt.baseUrl.endsWith("/")?Wt.baseUrl:Wt.baseUrl+"/",d=document.createElement("a");d.href=l+t,d.pathname=(d.pathname+d.hash).split("/").map(encodeURIComponent).join("/");const v=yield fetch(d.href);if(!v.ok)throw new Error(`could not load url: ${t}`);const y=yield v.arrayBuffer();return yield ie().decodeAudioData(y)})}static supportsType(t){const i=t.split("."),l=i[i.length-1];return document.createElement("audio").canPlayType("audio/"+l)!==""}static loaded(){return Kt(this,void 0,void 0,function*(){for(yield Promise.resolve();Wt.downloads.length;)yield Wt.downloads[0]})}}Wt.baseUrl="",Wt.downloads=[];class Si extends xi{constructor(){var t,i,l;super({clockSource:"offline",context:Er(arguments[0])?arguments[0]:(t=arguments[0],i=arguments[1]*arguments[2],l=arguments[2],new Of(t,i,l)),lookAhead:0,updateInterval:Er(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Er(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(t){return Kt(this,void 0,void 0,function*(){let i=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,i++;const l=Math.floor(this.sampleRate/128);t&&i%l==0&&(yield new Promise(d=>setTimeout(d,1)))}})}render(){return Kt(this,arguments,void 0,function*(t=!0){yield this.workletsAreReady(),yield this._renderClock(t);const i=yield this._context.startRendering();return new Wt(i)})}close(){return Promise.resolve()}}const yu=new class extends Ka{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(p,t,i){return{}}createChannelMerger(p){return{}}createChannelSplitter(p){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(p){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(p,t){return{}}createPanner(){return{}}createPeriodicWave(p,t,i){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(p){return{}}createMediaElementSource(p){return{}}createMediaStreamDestination(){return{}}decodeAudioData(p){return Promise.resolve({})}createAudioWorkletNode(p,t){return{}}get rawContext(){return{}}addAudioWorkletModule(p){return Kt(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(p,t){return 0}clearTimeout(p){return this}setInterval(p,t){return 0}clearInterval(p){return this}getConstant(p){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(p){}get destination(){return{}}set destination(p){}now(){return 0}immediate(){return 0}};let mo=yu;function ie(){return mo===yu&&zf&&Dr(new xi),mo}function Dr(p,t=!1){t&&mo.dispose(),mo=bi(p)?new xi(p):Er(p)?new Si(p):p}function Hf(){return mo.resume()}if(as&&!as.TONE_SILENCE_LOGGING){const t=` * Tone.js v${m} * `;console.log(`%c${t}`,"background: #000; color: #fff")}function Ci(p){return Math.pow(10,p/20)}function fo(p){return Math.log(p)/Math.LN10*20}function Ti(p){return Math.pow(2,p/12)}let Rr=440;function Tn(p){return Math.round(bu(p))}function bu(p){return 69+12*Math.log2(p/Rr)}function tl(p){return Rr*Math.pow(2,(p-69)/12)}class el extends an{constructor(t,i,l){super(),this.defaultUnits="s",this._val=i,this._units=l,this.context=t,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:t=>this._frequencyToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:t=>this._ticksToUnits(parseInt(t,10)),regexp:/^(\d+)i$/i},m:{method:t=>this._beatsToUnits(parseInt(t,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(t,i)=>{const l=parseInt(t,10),d=i==="."?1.5:1;return l===1?this._beatsToUnits(this._getTimeSignature())*d:this._beatsToUnits(4/l)*d},regexp:/^(\d+)n(\.?)$/i},number:{method:t=>this._expressions[this.defaultUnits].method.call(this,t),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:t=>this._secondsToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:t=>parseInt(t,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:t=>{const i=parseInt(t,10);return this._beatsToUnits(8/(3*Math.floor(i)))},regexp:/^(\d+)t$/i},tr:{method:(t,i,l)=>{let d=0;return t&&t!=="0"&&(d+=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),i&&i!=="0"&&(d+=this._beatsToUnits(parseFloat(i))),l&&l!=="0"&&(d+=this._beatsToUnits(parseFloat(l)/4)),d},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof el&&this.fromType(this._val),ts(this._val))return this._noArg();if(Os(this._val)&&ts(this._units)){for(const t in this._expressions)if(this._expressions[t].regexp.test(this._val.trim())){this._units=t;break}}else if(rn(this._val)){let t=0;for(const i in this._val)if(Ot(this._val[i])){const l=this._val[i];t+=new this.constructor(this.context,i).valueOf()*l}return t}if(Ot(this._units)){const t=this._expressions[this._units],i=this._val.toString().trim().match(t.regexp);return i?t.method.apply(this,i.slice(1)):t.method.call(this,this._val)}return Os(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(t){return 1/t}_beatsToUnits(t){return 60/this._getBpm()*t}_secondsToUnits(t){return t}_ticksToUnits(t){return t*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(t){switch(this._units=void 0,this.defaultUnits){case"s":this._val=t.toSeconds();break;case"i":this._val=t.toTicks();break;case"hz":this._val=t.toFrequency();break;case"midi":this._val=t.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class cs extends el{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:t=>this._now()+new this.constructor(this.context,t).valueOf(),regexp:/^\+(.+)/},quantize:{method:t=>{const i=new cs(this.context,t).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(i))},regexp:/^@(.+)/}})}quantize(t,i=1){const l=new this.constructor(this.context,t).valueOf(),d=this.valueOf();return d+(Math.round(d/l)*l-d)*i}toNotation(){const t=this.toSeconds(),i=["1m"];for(let v=1;v<9;v++){const y=Math.pow(2,v);i.push(y+"n."),i.push(y+"n"),i.push(y+"t")}i.push("0");let l=i[0],d=new cs(this.context,i[0]).toSeconds();return i.forEach(v=>{const y=new cs(this.context,v).toSeconds();Math.abs(y-t)<Math.abs(d-t)&&(l=v,d=y)}),l}toBarsBeatsSixteenths(){const t=this._beatsToUnits(1);let i=this.valueOf()/t;i=parseFloat(i.toFixed(4));const l=Math.floor(i/this._getTimeSignature());let d=i%1*4;i=Math.floor(i)%this._getTimeSignature();const v=d.toString();return v.length>3&&(d=parseFloat(parseFloat(v).toFixed(3))),[l,i,d].join(":")}toTicks(){const t=this._beatsToUnits(1);return this.valueOf()/t*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return Tn(this.toFrequency())}_now(){return this.context.now()}}function Gf(p,t){return new cs(ie(),p,t)}class Ue extends cs{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Rr}static set A4(t){(function(i){Rr=i})(t)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(t){return this.defaultUnits==="midi"?t:Ue.mtof(t)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(t,i){const l=jf[t.toLowerCase()]+12*(parseInt(i,10)+1);return this.defaultUnits==="midi"?l:Ue.mtof(l)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(t,i,l){let d=1;return t&&t!=="0"&&(d*=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),i&&i!=="0"&&(d*=this._beatsToUnits(parseFloat(i))),l&&l!=="0"&&(d*=this._beatsToUnits(parseFloat(l)/4)),d}}})}transpose(t){return new Ue(this.context,this.valueOf()*Ti(t))}harmonize(t){return t.map(i=>this.transpose(i))}toMidi(){return Tn(this.valueOf())}toNote(){const t=this.toFrequency(),i=Math.log2(t/Ue.A4);let l=Math.round(12*i)+57;const d=Math.floor(l/12);return d<0&&(l+=-12*d),Uf[l%12]+d.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const t=this._beatsToUnits(1),i=this.valueOf()/t;return Math.floor(i*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(t){return t}_ticksToUnits(t){return 1/(60*t/(this._getBpm()*this._getPPQ()))}_beatsToUnits(t){return 1/super._beatsToUnits(t)}_secondsToUnits(t){return 1/t}static mtof(t){return tl(t)}static ftom(t){return Tn(t)}}const jf={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},Uf=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function Xf(p,t){return new Ue(ie(),p,t)}class _e extends cs{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}function Yf(p,t){return new _e(ie(),p,t)}class Re extends an{constructor(){super();const t=Q(Re.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=t.context}static getDefaults(){return{context:ie()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(t){return mu(t),new cs(this.context,t).toSeconds()}toFrequency(t){return new Ue(this.context,t).toFrequency()}toTicks(t){return new _e(this.context,t).toTicks()}_getPartialProperties(t){const i=this.get();return Object.keys(i).forEach(l=>{ts(t[l])&&delete i[l]}),i}get(){const t=this.constructor.getDefaults();return Object.keys(t).forEach(i=>{if(Reflect.has(this,i)){const l=this[i];Ot(l)&&Ot(l.value)&&Ot(l.setValueAtTime)?t[i]=l.value:l instanceof Re?t[i]=l._getPartialProperties(t[i]):Le(l)||rs(l)||Os(l)||Ua(l)?t[i]=l:delete t[i]}}),t}set(t){return Object.keys(t).forEach(i=>{Reflect.has(this,i)&&Ot(this[i])&&(this[i]&&Ot(this[i].value)&&Ot(this[i].setValueAtTime)?this[i].value!==t[i]&&(this[i].value=t[i]):this[i]instanceof Re?this[i].set(t[i]):this[i]=t[i])}),this}}class Ai extends ls{constructor(t="stopped"){super(),this.name="StateTimeline",this._initial=t,this.setStateAtTime(this._initial,0)}getValueAtTime(t){const i=this.get(t);return i!==null?i.state:this._initial}setStateAtTime(t,i,l){return Fe(i,0),this.add(Object.assign({},l,{state:t,time:i})),this}getLastState(t,i){for(let l=this._search(i);l>=0;l--){const d=this._timeline[l];if(d.state===t)return d}}getNextState(t,i){const l=this._search(i);if(l!==-1)for(let d=l;d<this._timeline.length;d++){const v=this._timeline[d];if(v.state===t)return v}}}class Pt extends Re{constructor(){const t=Q(Pt.getDefaults(),arguments,["param","units","convert"]);for(super(t),this.name="Param",this.overridden=!1,this._minOutput=1e-7,wt(Ot(t.param)&&(Wn(t.param)||t.param instanceof Pt),"param must be an AudioParam");!Wn(t.param);)t.param=t.param._param;this._swappable=!!Ot(t.swappable)&&t.swappable,this._swappable?(this.input=this.context.createGain(),this._param=t.param,this.input.connect(this._param)):this._param=this.input=t.param,this._events=new ls(1e3),this._initialValue=this._param.defaultValue,this.units=t.units,this.convert=t.convert,this._minValue=t.minValue,this._maxValue=t.maxValue,Ot(t.value)&&t.value!==this._toType(this._initialValue)&&this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Re.getDefaults(),{convert:!0,units:"number"})}get value(){const t=this.now();return this.getValueAtTime(t)}set value(t){this.cancelScheduledValues(this.now()),this.setValueAtTime(t,this.now())}get minValue(){return Ot(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return Ot(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(t,i){return this.units===i}_assertRange(t){return Ot(this.maxValue)&&Ot(this.minValue)&&Fe(t,this._fromType(this.minValue),this._fromType(this.maxValue)),t}_fromType(t){return this.convert&&!this.overridden?this._is(t,"time")?this.toSeconds(t):this._is(t,"decibels")?Ci(t):this._is(t,"frequency")?this.toFrequency(t):t:this.overridden?0:t}_toType(t){return this.convert&&this.units==="decibels"?fo(t):t}setValueAtTime(t,i){const l=this.toSeconds(i),d=this._fromType(t);return wt(isFinite(d)&&isFinite(l),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(i)}`),this._assertRange(d),this.log(this.units,"setValueAtTime",t,l),this._events.add({time:l,type:"setValueAtTime",value:d}),this._param.setValueAtTime(d,l),this}getValueAtTime(t){const i=Math.max(this.toSeconds(t),0),l=this._events.getAfter(i),d=this._events.get(i);let v=this._initialValue;if(d===null)v=this._initialValue;else if(d.type!=="setTargetAtTime"||l!==null&&l.type!=="setValueAtTime")if(l===null)v=d.value;else if(l.type==="linearRampToValueAtTime"||l.type==="exponentialRampToValueAtTime"){let y=d.value;if(d.type==="setTargetAtTime"){const _=this._events.getBefore(d.time);y=_===null?this._initialValue:_.value}v=l.type==="linearRampToValueAtTime"?this._linearInterpolate(d.time,y,l.time,l.value,i):this._exponentialInterpolate(d.time,y,l.time,l.value,i)}else v=d.value;else{const y=this._events.getBefore(d.time);let _;_=y===null?this._initialValue:y.value,d.type==="setTargetAtTime"&&(v=this._exponentialApproach(d.time,_,d.value,d.constant,i))}return this._toType(v)}setRampPoint(t){t=this.toSeconds(t);let i=this.getValueAtTime(t);return this.cancelAndHoldAtTime(t),this._fromType(i)===0&&(i=this._toType(this._minOutput)),this.setValueAtTime(i,t),this}linearRampToValueAtTime(t,i){const l=this._fromType(t),d=this.toSeconds(i);return wt(isFinite(l)&&isFinite(d),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(i)}`),this._assertRange(l),this._events.add({time:d,type:"linearRampToValueAtTime",value:l}),this.log(this.units,"linearRampToValueAtTime",t,d),this._param.linearRampToValueAtTime(l,d),this}exponentialRampToValueAtTime(t,i){let l=this._fromType(t);l=Ls(l,0)?this._minOutput:l,this._assertRange(l);const d=this.toSeconds(i);return wt(isFinite(l)&&isFinite(d),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(i)}`),this._events.add({time:d,type:"exponentialRampToValueAtTime",value:l}),this.log(this.units,"exponentialRampToValueAtTime",t,d),this._param.exponentialRampToValueAtTime(l,d),this}exponentialRampTo(t,i,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialRampToValueAtTime(t,l+this.toSeconds(i)),this}linearRampTo(t,i,l){return l=this.toSeconds(l),this.setRampPoint(l),this.linearRampToValueAtTime(t,l+this.toSeconds(i)),this}targetRampTo(t,i,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialApproachValueAtTime(t,l,i),this}exponentialApproachValueAtTime(t,i,l){i=this.toSeconds(i),l=this.toSeconds(l);const d=Math.log(l+1)/Math.log(200);return this.setTargetAtTime(t,i,d),this.cancelAndHoldAtTime(i+.9*l),this.linearRampToValueAtTime(t,i+l),this}setTargetAtTime(t,i,l){const d=this._fromType(t);wt(isFinite(l)&&l>0,"timeConstant must be a number greater than 0");const v=this.toSeconds(i);return this._assertRange(d),wt(isFinite(d)&&isFinite(v),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(t)}, ${JSON.stringify(i)}`),this._events.add({constant:l,time:v,type:"setTargetAtTime",value:d}),this.log(this.units,"setTargetAtTime",t,v,l),this._param.setTargetAtTime(d,v,l),this}setValueCurveAtTime(t,i,l,d=1){l=this.toSeconds(l),i=this.toSeconds(i);const v=this._fromType(t[0])*d;this.setValueAtTime(this._toType(v),i);const y=l/(t.length-1);for(let _=1;_<t.length;_++){const S=this._fromType(t[_])*d;this.linearRampToValueAtTime(this._toType(S),i+_*y)}return this}cancelScheduledValues(t){const i=this.toSeconds(t);return wt(isFinite(i),`Invalid argument to cancelScheduledValues: ${JSON.stringify(t)}`),this._events.cancel(i),this._param.cancelScheduledValues(i),this.log(this.units,"cancelScheduledValues",i),this}cancelAndHoldAtTime(t){const i=this.toSeconds(t),l=this._fromType(this.getValueAtTime(i));wt(isFinite(i),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(t)}`),this.log(this.units,"cancelAndHoldAtTime",i,"value="+l);const d=this._events.get(i),v=this._events.getAfter(i);return d&&Ls(d.time,i)?v?(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time)):(this._param.cancelAndHoldAtTime(i),this._events.cancel(i+this.sampleTime)):v&&(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time),v.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(l),i):v.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(l),i)),this._events.add({time:i,type:"setValueAtTime",value:l}),this._param.setValueAtTime(l,i),this}rampTo(t,i=.1,l){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(t,i,l):this.linearRampTo(t,i,l),this}apply(t){const i=this.context.currentTime;t.setValueAtTime(this.getValueAtTime(i),i);const l=this._events.get(i);if(l&&l.type==="setTargetAtTime"){const d=this._events.getAfter(l.time),v=d?d.time:i+2,y=(v-i)/10;for(let _=i;_<v;_+=y)t.linearRampToValueAtTime(this.getValueAtTime(_),_)}return this._events.forEachAfter(this.context.currentTime,d=>{d.type==="cancelScheduledValues"?t.cancelScheduledValues(d.time):d.type==="setTargetAtTime"?t.setTargetAtTime(d.value,d.time,d.constant):t[d.type](d.value,d.time)}),this}setParam(t){wt(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const i=this.input;return i.disconnect(this._param),this.apply(t),this._param=t,i.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(t,i,l,d,v){return l+(i-l)*Math.exp(-(v-t)/d)}_linearInterpolate(t,i,l,d,v){return i+(v-t)/(l-t)*(d-i)}_exponentialInterpolate(t,i,l,d,v){return i*Math.pow(d/i,(v-t)/(l-t))}}class rt extends Re{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return Ot(this.input)?Wn(this.input)||this.input instanceof Pt?1:this.input.numberOfInputs:0}get numberOfOutputs(){return Ot(this.output)?this.output.numberOfOutputs:0}_isAudioNode(t){return Ot(t)&&(t instanceof rt||Cn(t))}_getInternalNodes(){const t=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&t.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&t.push(this.output),t}_setChannelProperties(t){this._getInternalNodes().forEach(i=>{i.channelCount=t.channelCount,i.channelCountMode=t.channelCountMode,i.channelInterpretation=t.channelInterpretation})}_getChannelProperties(){const t=this._getInternalNodes();wt(t.length>0,"ToneAudioNode does not have any internal nodes");const i=t[0];return{channelCount:i.channelCount,channelCountMode:i.channelCountMode,channelInterpretation:i.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(t){const i=this._getChannelProperties();this._setChannelProperties(Object.assign(i,{channelCount:t}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(t){const i=this._getChannelProperties();this._setChannelProperties(Object.assign(i,{channelCountMode:t}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(t){const i=this._getChannelProperties();this._setChannelProperties(Object.assign(i,{channelInterpretation:t}))}connect(t,i=0,l=0){return Xe(this,t,i,l),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return yi("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(t,i=0,l=0){return sl(this,t,i,l),this}chain(...t){return hs(this,...t),this}fan(...t){return t.forEach(i=>this.connect(i)),this}dispose(){return super.dispose(),Ot(this.input)&&(this.input instanceof rt?this.input.dispose():Cn(this.input)&&this.input.disconnect()),Ot(this.output)&&(this.output instanceof rt?this.output.dispose():Cn(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function hs(...p){const t=p.shift();p.reduce((i,l)=>(i instanceof rt?i.connect(l):Cn(i)&&Xe(i,l),l),t)}function Xe(p,t,i=0,l=0){for(wt(Ot(p),"Cannot connect from undefined node"),wt(Ot(t),"Cannot connect to undefined node"),(t instanceof rt||Cn(t))&&wt(t.numberOfInputs>0,"Cannot connect to node with no inputs"),wt(p.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof rt||t instanceof Pt;)Ot(t.input)&&(t=t.input);for(;p instanceof rt;)Ot(p.output)&&(p=p.output);Wn(t)?p.connect(t,i):p.connect(t,i,l)}function sl(p,t,i=0,l=0){if(Ot(t))for(;t instanceof rt;)t=t.input;for(;!Cn(p);)Ot(p.output)&&(p=p.output);Wn(t)?p.disconnect(t,i):Cn(t)?p.disconnect(t,i,l):p.disconnect()}function Zf(...p){const t=p.pop();Ot(t)&&p.forEach(i=>Xe(i,t))}class _t extends rt{constructor(){const t=Q(_t.getDefaults(),arguments,["gain","units"]);super(t),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Pt({context:this.context,convert:t.convert,param:this._gainNode.gain,units:t.units,value:t.gain,minValue:t.minValue,maxValue:t.maxValue}),Tt(this,"gain")}static getDefaults(){return Object.assign(rt.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Mi extends rt{constructor(t){super(t),this.onended=Ft,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new _t({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(i){const l=this.toSeconds(i);return this._startTime!==-1&&l>=this._startTime&&(this._stopTime===-1||l<=this._stopTime)?"started":"stopped"},this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut,this._curve=t.curve,this.onended=t.onended}static getDefaults(){return Object.assign(rt.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Ft})}_startGain(t,i=1){wt(this._startTime===-1,"Source cannot be started more than once");const l=this.toSeconds(this._fadeIn);return this._startTime=t+l,this._startTime=Math.max(this._startTime,this.context.currentTime),l>0?(this._gainNode.gain.setValueAtTime(0,t),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(i,t+l):this._gainNode.gain.exponentialApproachValueAtTime(i,t,l)):this._gainNode.gain.setValueAtTime(i,t),this}stop(t){return this.log("stop",t),this._stopGain(this.toSeconds(t)),this}_stopGain(t){wt(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const i=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(t)+i,this._stopTime=Math.max(this._stopTime,this.now()),i>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,i,t):this._gainNode.gain.targetRampTo(0,i,t):(this._gainNode.gain.cancelAndHoldAtTime(t),this._gainNode.gain.setValueAtTime(0,t)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const l=this._curve==="exponential"?2*i:0;this._stopSource(this.now()+l),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Ft&&(this.onended(this),this.onended=Ft,!this.context.isOffline)){const t=()=>this.dispose();window.requestIdleCallback!==void 0?window.requestIdleCallback(t):setTimeout(t,1e3)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),wt(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Ft,this}}class Or extends Mi{constructor(){const t=Q(Or.getDefaults(),arguments,["offset"]);super(t),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Xe(this._source,this._gainNode),this.offset=new Pt({context:this.context,convert:t.convert,param:this._source.offset,units:t.units,value:t.offset,minValue:t.minValue,maxValue:t.maxValue})}static getDefaults(){return Object.assign(Mi.getDefaults(),{convert:!0,offset:1,units:"number"})}start(t){const i=this.toSeconds(t);return this.log("start",i),this._startGain(i),this._source.start(i),this}_stopSource(t){this._source.stop(t)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Mt extends rt{constructor(){const t=Q(Mt.getDefaults(),arguments,["value","units"]);super(t),this.name="Signal",this.override=!0,this.output=this._constantSource=new Or({context:this.context,convert:t.convert,offset:t.value,units:t.units,minValue:t.minValue,maxValue:t.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(rt.getDefaults(),{convert:!0,units:"number",value:0})}connect(t,i=0,l=0){return go(this,t,i,l),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(t,i){return this._param.setValueAtTime(t,i),this}getValueAtTime(t){return this._param.getValueAtTime(t)}setRampPoint(t){return this._param.setRampPoint(t),this}linearRampToValueAtTime(t,i){return this._param.linearRampToValueAtTime(t,i),this}exponentialRampToValueAtTime(t,i){return this._param.exponentialRampToValueAtTime(t,i),this}exponentialRampTo(t,i,l){return this._param.exponentialRampTo(t,i,l),this}linearRampTo(t,i,l){return this._param.linearRampTo(t,i,l),this}targetRampTo(t,i,l){return this._param.targetRampTo(t,i,l),this}exponentialApproachValueAtTime(t,i,l){return this._param.exponentialApproachValueAtTime(t,i,l),this}setTargetAtTime(t,i,l){return this._param.setTargetAtTime(t,i,l),this}setValueCurveAtTime(t,i,l,d){return this._param.setValueCurveAtTime(t,i,l,d),this}cancelScheduledValues(t){return this._param.cancelScheduledValues(t),this}cancelAndHoldAtTime(t){return this._param.cancelAndHoldAtTime(t),this}rampTo(t,i,l){return this._param.rampTo(t,i,l),this}get value(){return this._param.value}set value(t){this._param.value=t}get convert(){return this._param.convert}set convert(t){this._param.convert=t}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(t){this._param.overridden=t}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(t){return this._param.apply(t),this}}function go(p,t,i,l){(t instanceof Pt||Wn(t)||t instanceof Mt&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof Mt&&(t.overridden=!0)),Xe(p,t,i,l)}class nl extends Pt{constructor(){const t=Q(nl.getDefaults(),arguments,["value"]);super(t),this.name="TickParam",this._events=new ls(1/0),this._multiplier=1,this._multiplier=t.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(t.value)}),this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Pt.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(t,i,l){i=this.toSeconds(i),this.setRampPoint(i);const d=this._fromType(t),v=this._events.get(i),y=Math.round(Math.max(1/l,1));for(let _=0;_<=y;_++){const S=l*_+i,C=this._exponentialApproach(v.time,v.value,d,l,S);this.linearRampToValueAtTime(this._toType(C),S)}return this}setValueAtTime(t,i){const l=this.toSeconds(i);super.setValueAtTime(t,i);const d=this._events.get(l),v=this._events.previousEvent(d),y=this._getTicksUntilEvent(v,l);return d.ticks=Math.max(y,0),this}linearRampToValueAtTime(t,i){const l=this.toSeconds(i);super.linearRampToValueAtTime(t,i);const d=this._events.get(l),v=this._events.previousEvent(d),y=this._getTicksUntilEvent(v,l);return d.ticks=Math.max(y,0),this}exponentialRampToValueAtTime(t,i){i=this.toSeconds(i);const l=this._fromType(t),d=this._events.get(i),v=Math.round(Math.max(10*(i-d.time),1)),y=(i-d.time)/v;for(let _=0;_<=v;_++){const S=y*_+d.time,C=this._exponentialInterpolate(d.time,d.value,i,l,S);this.linearRampToValueAtTime(this._toType(C),S)}return this}_getTicksUntilEvent(t,i){if(t===null)t={ticks:0,time:0,type:"setValueAtTime",value:0};else if(ts(t.ticks)){const y=this._events.previousEvent(t);t.ticks=this._getTicksUntilEvent(y,t.time)}const l=this._fromType(this.getValueAtTime(t.time));let d=this._fromType(this.getValueAtTime(i));const v=this._events.get(i);return v&&v.time===i&&v.type==="setValueAtTime"&&(d=this._fromType(this.getValueAtTime(i-this.sampleTime))),.5*(i-t.time)*(l+d)+t.ticks}getTicksAtTime(t){const i=this.toSeconds(t),l=this._events.get(i);return Math.max(this._getTicksUntilEvent(l,i),0)}getDurationOfTicks(t,i){const l=this.toSeconds(i),d=this.getTicksAtTime(i);return this.getTimeOfTick(d+t)-l}getTimeOfTick(t){const i=this._events.get(t,"ticks"),l=this._events.getAfter(t,"ticks");if(i&&i.ticks===t)return i.time;if(i&&l&&l.type==="linearRampToValueAtTime"&&i.value!==l.value){const d=this._fromType(this.getValueAtTime(i.time)),v=(this._fromType(this.getValueAtTime(l.time))-d)/(l.time-i.time),y=Math.sqrt(Math.pow(d,2)-2*v*(i.ticks-t)),_=(-d+y)/v;return(_>0?_:(-d-y)/v)+i.time}return i?i.value===0?1/0:i.time+(t-i.ticks)/i.value:t/this._initialValue}ticksToTime(t,i){return this.getDurationOfTicks(t,i)}timeToTicks(t,i){const l=this.toSeconds(i),d=this.toSeconds(t),v=this.getTicksAtTime(l);return this.getTicksAtTime(l+d)-v}_fromType(t){return this.units==="bpm"&&this.multiplier?1/(60/t/this.multiplier):super._fromType(t)}_toType(t){return this.units==="bpm"&&this.multiplier?t/this.multiplier*60:super._toType(t)}get multiplier(){return this._multiplier}set multiplier(t){const i=this.value;this._multiplier=t,this.cancelScheduledValues(0),this.setValueAtTime(i,0)}}class il extends Mt{constructor(){const t=Q(il.getDefaults(),arguments,["value"]);super(t),this.name="TickSignal",this.input=this._param=new nl({context:this.context,convert:t.convert,multiplier:t.multiplier,param:this._constantSource.offset,units:t.units,value:t.value})}static getDefaults(){return Object.assign(Mt.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(t,i){return this._param.ticksToTime(t,i)}timeToTicks(t,i){return this._param.timeToTicks(t,i)}getTimeOfTick(t){return this._param.getTimeOfTick(t)}getDurationOfTicks(t,i){return this._param.getDurationOfTicks(t,i)}getTicksAtTime(t){return this._param.getTicksAtTime(t)}get multiplier(){return this._param.multiplier}set multiplier(t){this._param.multiplier=t}dispose(){return super.dispose(),this._param.dispose(),this}}class ol extends Re{constructor(){const t=Q(ol.getDefaults(),arguments,["frequency"]);super(t),this.name="TickSource",this._state=new Ai,this._tickOffset=new ls,this._ticksAtTime=new ls,this._secondsAtTime=new ls,this.frequency=new il({context:this.context,units:t.units,value:t.frequency}),Tt(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Re.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(t,i){const l=this.toSeconds(t);return this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),Ot(i)&&this.setTicksAtTime(i,l),this._ticksAtTime.cancel(l),this._secondsAtTime.cancel(l)),this}stop(t){const i=this.toSeconds(t);if(this._state.getValueAtTime(i)==="stopped"){const l=this._state.get(i);l&&l.time>0&&(this._tickOffset.cancel(l.time),this._state.cancel(l.time))}return this._state.cancel(i),this._state.setStateAtTime("stopped",i),this.setTicksAtTime(0,i),this._ticksAtTime.cancel(i),this._secondsAtTime.cancel(i),this}pause(t){const i=this.toSeconds(t);return this._state.getValueAtTime(i)==="started"&&(this._state.setStateAtTime("paused",i),this._ticksAtTime.cancel(i),this._secondsAtTime.cancel(i)),this}cancel(t){return t=this.toSeconds(t),this._state.cancel(t),this._tickOffset.cancel(t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getTicksAtTime(t){const i=this.toSeconds(t),l=this._state.getLastState("stopped",i),d=this._ticksAtTime.get(i),v={state:"paused",time:i};this._state.add(v);let y=d||l,_=d?d.ticks:0,S=null;return this._state.forEachBetween(y.time,i+this.sampleTime,C=>{let M=y.time;const E=this._tickOffset.get(C.time);E&&E.time>=y.time&&(_=E.ticks,M=E.time),y.state==="started"&&C.state!=="started"&&(_+=this.frequency.getTicksAtTime(C.time)-this.frequency.getTicksAtTime(M),C.time!==v.time&&(S={state:C.state,time:C.time,ticks:_})),y=C}),this._state.remove(v),S&&this._ticksAtTime.add(S),_}get ticks(){return this.getTicksAtTime(this.now())}set ticks(t){this.setTicksAtTime(t,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(t){const i=this.now(),l=this.frequency.timeToTicks(t,i);this.setTicksAtTime(l,i)}getSecondsAtTime(t){t=this.toSeconds(t);const i=this._state.getLastState("stopped",t),l={state:"paused",time:t};this._state.add(l);const d=this._secondsAtTime.get(t);let v=d||i,y=d?d.seconds:0,_=null;return this._state.forEachBetween(v.time,t+this.sampleTime,S=>{let C=v.time;const M=this._tickOffset.get(S.time);M&&M.time>=v.time&&(y=M.seconds,C=M.time),v.state==="started"&&S.state!=="started"&&(y+=S.time-C,S.time!==l.time&&(_={state:S.state,time:S.time,seconds:y})),v=S}),this._state.remove(l),_&&this._secondsAtTime.add(_),y}setTicksAtTime(t,i){return i=this.toSeconds(i),this._tickOffset.cancel(i),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(t,i),ticks:t,time:i}),this._ticksAtTime.cancel(i),this._secondsAtTime.cancel(i),this}getStateAtTime(t){return t=this.toSeconds(t),this._state.getValueAtTime(t)}getTimeOfTick(t,i=this.now()){const l=this._tickOffset.get(i),d=this._state.get(i),v=Math.max(l.time,d.time),y=this.frequency.getTicksAtTime(v)+t-l.ticks;return this.frequency.getTimeOfTick(y)}forEachTickBetween(t,i,l){let d=this._state.get(t);this._state.forEachBetween(t,i,y=>{d&&d.state==="started"&&y.state!=="started"&&this.forEachTickBetween(Math.max(d.time,t),y.time-this.sampleTime,l),d=y});let v=null;if(d&&d.state==="started"){const y=Math.max(d.time,t),_=this.frequency.getTicksAtTime(y),S=_-this.frequency.getTicksAtTime(d.time);let C=Math.ceil(S)-S;C=Ls(C,1)?0:C;let M=this.frequency.getTimeOfTick(_+C);for(;M<i;){try{l(M,Math.round(this.getTicksAtTime(M)))}catch(E){v=E;break}M+=this.frequency.getDurationOfTicks(1,M)}}if(v)throw v;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class Ei extends Re{constructor(){const t=Q(Ei.getDefaults(),arguments,["callback","frequency"]);super(t),this.name="Clock",this.callback=Ft,this._lastUpdate=0,this._state=new Ai("stopped"),this._boundLoop=this._loop.bind(this),this.callback=t.callback,this._tickSource=new ol({context:this.context,frequency:t.frequency,units:t.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Tt(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Re.getDefaults(),{callback:Ft,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(t,i){Xa(this.context);const l=this.toSeconds(t);return this.log("start",l),this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),this._tickSource.start(l,i),l<this._lastUpdate&&this.emit("start",l,i)),this}stop(t){const i=this.toSeconds(t);return this.log("stop",i),this._state.cancel(i),this._state.setStateAtTime("stopped",i),this._tickSource.stop(i),i<this._lastUpdate&&this.emit("stop",i),this}pause(t){const i=this.toSeconds(t);return this._state.getValueAtTime(i)==="started"&&(this._state.setStateAtTime("paused",i),this._tickSource.pause(i),i<this._lastUpdate&&this.emit("pause",i)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(t){this._tickSource.ticks=t}get seconds(){return this._tickSource.seconds}set seconds(t){this._tickSource.seconds=t}getSecondsAtTime(t){return this._tickSource.getSecondsAtTime(t)}setTicksAtTime(t,i){return this._tickSource.setTicksAtTime(t,i),this}getTimeOfTick(t,i=this.now()){return this._tickSource.getTimeOfTick(t,i)}getTicksAtTime(t){return this._tickSource.getTicksAtTime(t)}nextTickTime(t,i){const l=this.toSeconds(i),d=this.getTicksAtTime(l);return this._tickSource.getTimeOfTick(d+t,l)}_loop(){const t=this._lastUpdate,i=this.now();this._lastUpdate=i,this.log("loop",t,i),t!==i&&(this._state.forEachBetween(t,i,l=>{switch(l.state){case"started":const d=this._tickSource.getTicksAtTime(l.time);this.emit("start",l.time,d);break;case"stopped":l.time!==0&&this.emit("stop",l.time);break;case"paused":this.emit("pause",l.time)}}),this._tickSource.forEachTickBetween(t,i,(l,d)=>{this.callback(l,d)}))}getStateAtTime(t){const i=this.toSeconds(t);return this._state.getValueAtTime(i)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}wi.mixin(Ei);class us extends rt{constructor(){const t=Q(us.getDefaults(),arguments,["delayTime","maxDelay"]);super(t),this.name="Delay";const i=this.toSeconds(t.maxDelay);this._maxDelay=Math.max(i,this.toSeconds(t.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(i),this.delayTime=new Pt({context:this.context,param:this._delayNode.delayTime,units:"time",value:t.delayTime,minValue:0,maxValue:this.maxDelay}),Tt(this,"delayTime")}static getDefaults(){return Object.assign(rt.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class ln extends rt{constructor(){const t=Q(ln.getDefaults(),arguments,["volume"]);super(t),this.name="Volume",this.input=this.output=new _t({context:this.context,gain:t.volume,units:"decibels"}),this.volume=this.output.gain,Tt(this,"volume"),this._unmutedVolume=t.volume,this.mute=t.mute}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(t){!this.mute&&t?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!t&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class rl extends rt{constructor(){const t=Q(rl.getDefaults(),arguments);super(t),this.name="Destination",this.input=new ln({context:this.context}),this.output=new _t({context:this.context}),this.volume=this.input.volume,hs(this.input,this.output,this.context.rawContext.destination),this.mute=t.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(t){this.input.mute=t}chain(...t){return this.input.disconnect(),t.unshift(this.input),t.push(this.output),hs(...t),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}kr(p=>{p.destination=new rl({context:p})}),Ir(p=>{p.destination.dispose()});class Qf extends rt{constructor(){super(...arguments),this.name="Listener",this.positionX=new Pt({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Pt({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Pt({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Pt({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Pt({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Pt({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Pt({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Pt({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Pt({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(rt.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}function Jf(p,t){return Kt(this,arguments,void 0,function*(i,l,d=2,v=ie().sampleRate){const y=ie(),_=new Si(d,l,v);Dr(_),yield i(_);const S=_.render();Dr(y);const C=yield S;return new Wt(C)})}kr(p=>{p.listener=new Qf({context:p})}),Ir(p=>{p.listener.dispose()});class Pi extends an{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const t=Q(Pi.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=t.baseUrl,Object.keys(t.urls).forEach(i=>{this._loadingCount++;const l=t.urls[i];this.add(i,l,this._bufferLoaded.bind(this,t.onload),t.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Ft,onload:Ft,urls:{}}}has(t){return this._buffers.has(t.toString())}get(t){return wt(this.has(t),`ToneAudioBuffers has no buffer named: ${t}`),this._buffers.get(t.toString())}_bufferLoaded(t){this._loadingCount--,this._loadingCount===0&&t&&t()}get loaded(){return Array.from(this._buffers).every(([t,i])=>i.loaded)}add(t,i,l=Ft,d=Ft){return Os(i)?(this.baseUrl&&i.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(t.toString(),new Wt(this.baseUrl+i,l,d))):this._buffers.set(t.toString(),new Wt(i,l,d)),this}dispose(){return super.dispose(),this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this}}class ki extends Ue{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(t){return Tn(super._frequencyToUnits(t))}_ticksToUnits(t){return Tn(super._ticksToUnits(t))}_beatsToUnits(t){return Tn(super._beatsToUnits(t))}_secondsToUnits(t){return Tn(super._secondsToUnits(t))}toMidi(){return this.valueOf()}toFrequency(){return tl(this.toMidi())}transpose(t){return new ki(this.context,this.toMidi()+t)}}function Kf(p,t){return new ki(ie(),p,t)}class ce extends _e{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(t){return this._getPPQ()*t}_secondsToUnits(t){return Math.floor(t/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(t){return t}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}function tg(p,t){return new ce(ie(),p,t)}class eg extends Re{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new ls,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(t,i){return this._events.add({callback:t,time:this.toSeconds(i)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(t){return this._events.cancel(this.toSeconds(t)),this}_drawLoop(){const t=this.context.currentTime;for(;this._events.length&&this._events.peek().time-this.anticipation<=t;){const i=this._events.shift();i&&t-i.time<=this.expiration&&i.callback()}this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}kr(p=>{p.draw=new eg({context:p})}),Ir(p=>{p.draw.dispose()});class _u extends an{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(t){wt(Ot(t.time),"Events must have a time property"),wt(Ot(t.duration),"Events must have a duration parameter"),t.time=t.time.valueOf();let i=new sg(t.time,t.time+t.duration,t);for(this._root===null?this._root=i:this._root.insert(i),this._length++;i!==null;)i.updateHeight(),i.updateMax(),this._rebalance(i),i=i.parent;return this}remove(t){if(this._root!==null){const i=[];this._root.search(t.time,i);for(const l of i)if(l.event===t){this._removeNode(l),this._length--;break}}return this}get length(){return this._length}cancel(t){return this.forEachFrom(t,i=>this.remove(i)),this}_setRoot(t){this._root=t,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(t,i){t.parent!==null?(t.isLeftChild()?t.parent.left=i:t.parent.right=i,this._rebalance(t.parent)):this._setRoot(i)}_removeNode(t){if(t.left===null&&t.right===null)this._replaceNodeInParent(t,null);else if(t.right===null)this._replaceNodeInParent(t,t.left);else if(t.left===null)this._replaceNodeInParent(t,t.right);else{let i,l=null;if(t.getBalance()>0)if(t.left.right===null)i=t.left,i.right=t.right,l=i;else{for(i=t.left.right;i.right!==null;)i=i.right;i.parent&&(i.parent.right=i.left,l=i.parent,i.left=t.left,i.right=t.right)}else if(t.right.left===null)i=t.right,i.left=t.left,l=i;else{for(i=t.right.left;i.left!==null;)i=i.left;i.parent&&(i.parent.left=i.right,l=i.parent,i.left=t.left,i.right=t.right)}t.parent!==null?t.isLeftChild()?t.parent.left=i:t.parent.right=i:this._setRoot(i),l&&this._rebalance(l)}t.dispose()}_rotateLeft(t){const i=t.parent,l=t.isLeftChild(),d=t.right;d&&(t.right=d.left,d.left=t),i!==null?l?i.left=d:i.right=d:this._setRoot(d)}_rotateRight(t){const i=t.parent,l=t.isLeftChild(),d=t.left;d&&(t.left=d.right,d.right=t),i!==null?l?i.left=d:i.right=d:this._setRoot(d)}_rebalance(t){const i=t.getBalance();i>1&&t.left?t.left.getBalance()<0?this._rotateLeft(t.left):this._rotateRight(t):i<-1&&t.right&&(t.right.getBalance()>0?this._rotateRight(t.right):this._rotateLeft(t))}get(t){if(this._root!==null){const i=[];if(this._root.search(t,i),i.length>0){let l=i[0];for(let d=1;d<i.length;d++)i[d].low>l.low&&(l=i[d]);return l.event}}return null}forEach(t){if(this._root!==null){const i=[];this._root.traverse(l=>i.push(l)),i.forEach(l=>{l.event&&t(l.event)})}return this}forEachAtTime(t,i){if(this._root!==null){const l=[];this._root.search(t,l),l.forEach(d=>{d.event&&i(d.event)})}return this}forEachFrom(t,i){if(this._root!==null){const l=[];this._root.searchAfter(t,l),l.forEach(d=>{d.event&&i(d.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(t=>t.dispose()),this._root=null,this}}class sg{constructor(t,i,l){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=l,this.low=t,this.high=i,this.max=this.high}insert(t){t.low<=this.low?this.left===null?this.left=t:this.left.insert(t):this.right===null?this.right=t:this.right.insert(t)}search(t,i){t>this.max||(this.left!==null&&this.left.search(t,i),this.low<=t&&this.high>t&&i.push(this),this.low>t||this.right!==null&&this.right.search(t,i))}searchAfter(t,i){this.low>=t&&(i.push(this),this.left!==null&&this.left.searchAfter(t,i)),this.right!==null&&this.right.searchAfter(t,i)}traverse(t){t(this),this.left!==null&&this.left.traverse(t),this.right!==null&&this.right.traverse(t)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let t=0;return this.left!==null&&this.right!==null?t=this.left.height-this.right.height:this.left!==null?t=this.left.height+1:this.right!==null&&(t=-(this.right.height+1)),t}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(t){this._left=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(t){this._right=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class ng extends an{constructor(t){super(),this.name="TimelineValue",this._timeline=new ls({memory:10}),this._initialValue=t}set(t,i){return this._timeline.add({value:t,time:i}),this}get(t){const i=this._timeline.get(t);return i?i.value:this._initialValue}}class ds extends rt{constructor(){super(Q(ds.getDefaults(),arguments,["context"]))}connect(t,i=0,l=0){return go(this,t,i,l),this}}class Fs extends ds{constructor(){const t=Q(Fs.getDefaults(),arguments,["mapping","length"]);super(t),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Le(t.mapping)||t.mapping instanceof Float32Array?this.curve=Float32Array.from(t.mapping):uu(t.mapping)&&this.setMap(t.mapping,t.length)}static getDefaults(){return Object.assign(Mt.getDefaults(),{length:1024})}setMap(t,i=1024){const l=new Float32Array(i);for(let d=0,v=i;d<v;d++){const y=d/(v-1)*2-1;l[d]=t(y,d)}return this.curve=l,this}get curve(){return this._shaper.curve}set curve(t){this._shaper.curve=t}get oversample(){return this._shaper.oversample}set oversample(t){wt(["none","2x","4x"].some(i=>i.includes(t)),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Ii extends ds{constructor(){const t=Q(Ii.getDefaults(),arguments,["value"]);super(t),this.name="Pow",this._exponentScaler=this.input=this.output=new Fs({context:this.context,mapping:this._expFunc(t.value),length:8192}),this._exponent=t.value}static getDefaults(){return Object.assign(ds.getDefaults(),{value:1})}_expFunc(t){return i=>Math.pow(Math.abs(i),t)}get value(){return this._exponent}set value(t){this._exponent=t,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class An{constructor(t,i){this.id=An._eventId++,this._remainderTime=0;const l=Object.assign(An.getDefaults(),i);this.transport=t,this.callback=l.callback,this._once=l.once,this.time=Math.floor(l.time),this._remainderTime=l.time-this.time}static getDefaults(){return{callback:Ft,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(t){if(this.callback){const i=this.transport.bpm.getDurationOfTicks(1,t);this.callback(t+this._remainderTime*i),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}An._eventId=0;class al extends An{constructor(t,i){super(t,i),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const l=Object.assign(al.getDefaults(),i);this.duration=l.duration,this._interval=l.interval,this._nextTick=l.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},An.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(t){this._createEvents(t),super.invoke(t)}_createEvent(){return Pr(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new ce(this.context,this._nextTick).toSeconds()):-1}_createEvents(t){Pr(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new ce(this.context,this._nextTick).toSeconds()))}_restart(t){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const i=this.transport.getTicksAtTime(t);_i(i,this.time)&&(this._nextTick=this.floatTime+Math.ceil((i-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Nr extends Re{constructor(){const t=Q(Nr.getDefaults(),arguments);super(t),this.name="Transport",this._loop=new ng(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new ls,this._repeatedEvents=new _u,this._syncedSignals=[],this._swingAmount=0,this._ppq=t.ppq,this._clock=new Ei({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=t.ppq,this.bpm.setValueAtTime(t.bpm,0),Tt(this,"bpm"),this._timeSignature=t.timeSignature,this._swingTicks=t.ppq/2}static getDefaults(){return Object.assign(Re.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(t,i){if(this._loop.get(t)&&i>=this._loopEnd&&(this.emit("loopEnd",t),this._clock.setTicksAtTime(this._loopStart,t),i=this._loopStart,this.emit("loopStart",t,this._clock.getSecondsAtTime(t)),this.emit("loop",t)),this._swingAmount>0&&i%this._ppq!=0&&i%(2*this._swingTicks)!=0){const l=i%(2*this._swingTicks)/(2*this._swingTicks),d=Math.sin(l*Math.PI)*this._swingAmount;t+=new ce(this.context,2*this._swingTicks/3).toSeconds()*d}Ya(!0),this._timeline.forEachAtTime(i,l=>l.invoke(t)),Ya(!1)}schedule(t,i){const l=new An(this,{callback:t,time:new _e(this.context,i).toTicks()});return this._addEvent(l,this._timeline)}scheduleRepeat(t,i,l,d=1/0){const v=new al(this,{callback:t,duration:new cs(this.context,d).toTicks(),interval:new cs(this.context,i).toTicks(),time:new _e(this.context,l).toTicks()});return this._addEvent(v,this._repeatedEvents)}scheduleOnce(t,i){const l=new An(this,{callback:t,once:!0,time:new _e(this.context,i).toTicks()});return this._addEvent(l,this._timeline)}clear(t){if(this._scheduledEvents.hasOwnProperty(t)){const i=this._scheduledEvents[t.toString()];i.timeline.remove(i.event),i.event.dispose(),delete this._scheduledEvents[t.toString()]}return this}_addEvent(t,i){return this._scheduledEvents[t.id.toString()]={event:t,timeline:i},i.add(t),t.id}cancel(t=0){const i=this.toTicks(t);return this._timeline.forEachFrom(i,l=>this.clear(l.id)),this._repeatedEvents.forEachFrom(i,l=>this.clear(l.id)),this}_bindClockEvents(){this._clock.on("start",(t,i)=>{i=new ce(this.context,i).toSeconds(),this.emit("start",t,i)}),this._clock.on("stop",t=>{this.emit("stop",t)}),this._clock.on("pause",t=>{this.emit("pause",t)})}get state(){return this._clock.getStateAtTime(this.now())}start(t,i){let l;return this.context.resume(),Ot(i)&&(l=this.toTicks(i)),this._clock.start(t,l),this}stop(t){return this._clock.stop(t),this}pause(t){return this._clock.pause(t),this}toggle(t){return t=this.toSeconds(t),this._clock.getStateAtTime(t)!=="started"?this.start(t):this.stop(t),this}get timeSignature(){return this._timeSignature}set timeSignature(t){Le(t)&&(t=t[0]/t[1]*4),this._timeSignature=t}get loopStart(){return new cs(this.context,this._loopStart,"i").toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t)}get loopEnd(){return new cs(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t)}get loop(){return this._loop.get(this.now())}set loop(t){this._loop.set(t,this.now())}setLoopPoints(t,i){return this.loopStart=t,this.loopEnd=i,this}get swing(){return this._swingAmount}set swing(t){this._swingAmount=t}get swingSubdivision(){return new ce(this.context,this._swingTicks).toNotation()}set swingSubdivision(t){this._swingTicks=this.toTicks(t)}get position(){const t=this.now(),i=this._clock.getTicksAtTime(t);return new ce(this.context,i).toBarsBeatsSixteenths()}set position(t){const i=this.toTicks(t);this.ticks=i}get seconds(){return this._clock.seconds}set seconds(t){const i=this.now(),l=this._clock.frequency.timeToTicks(t,i);this.ticks=l}get progress(){if(this.loop){const t=this.now();return(this._clock.getTicksAtTime(t)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(t){if(this._clock.ticks!==t){const i=this.now();if(this.state==="started"){const l=this._clock.getTicksAtTime(i),d=i+this._clock.frequency.getDurationOfTicks(Math.ceil(l)-l,i);this.emit("stop",d),this._clock.setTicksAtTime(t,d),this.emit("start",d,this._clock.getSecondsAtTime(d))}else this.emit("ticks",i),this._clock.setTicksAtTime(t,i)}}getTicksAtTime(t){return this._clock.getTicksAtTime(t)}getSecondsAtTime(t){return this._clock.getSecondsAtTime(t)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(t){this._clock.frequency.multiplier=t}nextSubdivision(t){if(t=this.toTicks(t),this.state!=="started")return 0;{const i=this.now(),l=t-this.getTicksAtTime(i)%t;return this._clock.nextTickTime(l,i)}}syncSignal(t,i){const l=this.now();let d=this.bpm,v=1/(60/d.getValueAtTime(l)/this.PPQ),y=[];if(t.units==="time"){const S=.015625/v,C=new _t(S),M=new Ii(-1),E=new _t(S);d.chain(C,M,E),d=E,v=1/v,y=[C,M,E]}i||(i=t.getValueAtTime(l)!==0?t.getValueAtTime(l)/v:0);const _=new _t(i);return d.connect(_),_.connect(t._param),y.push(_),this._syncedSignals.push({initial:t.value,nodes:y,signal:t}),t.value=0,this}unsyncSignal(t){for(let i=this._syncedSignals.length-1;i>=0;i--){const l=this._syncedSignals[i];l.signal===t&&(l.nodes.forEach(d=>d.dispose()),l.signal.value=l.initial,this._syncedSignals.splice(i,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),po(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}wi.mixin(Nr),kr(p=>{p.transport=new Nr({context:p})}),Ir(p=>{p.transport.dispose()});class fe extends rt{constructor(t){super(t),this.input=void 0,this._state=new Ai("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Ft,this._syncedStop=Ft,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new ln({context:this.context,mute:t.mute,volume:t.volume}),this.volume=this._volume.volume,Tt(this,"volume"),this.onstop=t.onstop}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,onstop:Ft,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}_clampToCurrentTime(t){return this._synced?t:Math.max(t,this.context.currentTime)}start(t,i,l){let d=ts(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(d=this._clampToCurrentTime(d),this._synced||this._state.getValueAtTime(d)!=="started")if(this.log("start",d),this._state.setStateAtTime("started",d),this._synced){const v=this._state.get(d);v&&(v.offset=this.toSeconds(Ss(i,0)),v.duration=l?this.toSeconds(l):void 0);const y=this.context.transport.schedule(_=>{this._start(_,i,l)},d);this._scheduled.push(y),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>d&&this._syncedStart(this.now(),this.context.transport.seconds)}else Xa(this.context),this._start(d,i,l);else wt(_i(d,this._state.get(d).time),"Start time must be strictly greater than previous start time"),this._state.cancel(d),this._state.setStateAtTime("started",d),this.log("restart",d),this.restart(d,i,l);return this}stop(t){let i=ts(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(i=this._clampToCurrentTime(i),this._state.getValueAtTime(i)==="started"||Ot(this._state.getNextState("started",i))){if(this.log("stop",i),this._synced){const l=this.context.transport.schedule(this._stop.bind(this),i);this._scheduled.push(l)}else this._stop(i);this._state.cancel(i),this._state.setStateAtTime("stopped",i)}return this}restart(t,i,l){return t=this.toSeconds(t),this._state.getValueAtTime(t)==="started"&&(this._state.cancel(t),this._restart(t,i,l)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(t,i)=>{if(_i(i,0)){const l=this._state.get(i);if(l&&l.state==="started"&&l.time!==i){const d=i-this.toSeconds(l.time);let v;l.duration&&(v=this.toSeconds(l.duration)-d),this._start(t,this.toSeconds(l.offset)+d,v)}}},this._syncedStop=t=>{const i=this.context.transport.getSecondsAtTime(Math.max(t-this.sampleTime,0));this._state.getValueAtTime(i)==="started"&&this._stop(t)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(t=>this.context.transport.clear(t)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Ft,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class Mn extends Mi{constructor(){const t=Q(Mn.getDefaults(),arguments,["url","onload"]);super(t),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Xe(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Pt({context:this.context,param:this._source.playbackRate,units:"positive",value:t.playbackRate}),this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this._buffer=new Wt(t.url,t.onload,t.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Mi.getDefaults(),{url:new Wt,loop:!1,loopEnd:0,loopStart:0,onload:Ft,onerror:Ft,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t}get curve(){return this._curve}set curve(t){this._curve=t}start(t,i,l,d=1){wt(this.buffer.loaded,"buffer is either not set or not loaded");const v=this.toSeconds(t);this._startGain(v,d),i=this.loop?Ss(i,this.loopStart):Ss(i,0);let y=Math.max(this.toSeconds(i),0);if(this.loop){const _=this.toSeconds(this.loopEnd)||this.buffer.duration,S=this.toSeconds(this.loopStart),C=_-S;Ja(y,_)&&(y=(y-S)%C+S),Ls(y,this.buffer.duration)&&(y=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Pr(y,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(v,y)),Ot(l)){let _=this.toSeconds(l);_=Math.max(_,0),this.stop(v+_)}return this}_stopSource(t){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(t)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(t){this._source.loopStart=this.toSeconds(t)}get loopEnd(){return this._source.loopEnd}set loopEnd(t){this._source.loopEnd=this.toSeconds(t)}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._source.loop}set loop(t){this._source.loop=t,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}class En extends fe{constructor(){const t=Q(En.getDefaults(),arguments,["type"]);super(t),this.name="Noise",this._source=null,this._playbackRate=t.playbackRate,this.type=t.type,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(fe.getDefaults(),{fadeIn:0,fadeOut:0,playbackRate:1,type:"white"})}get type(){return this._type}set type(t){if(wt(t in wu,"Noise: invalid type: "+t),this._type!==t&&(this._type=t,this.state==="started")){const i=this.now();this._stop(i),this._start(i)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._source&&(this._source.playbackRate.value=t)}_start(t){const i=wu[this._type];this._source=new Mn({url:i,context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,loop:!0,onended:()=>this.onstop(this),playbackRate:this._playbackRate}).connect(this.output),this._source.start(this.toSeconds(t),Math.random()*(i.duration-.001))}_stop(t){this._source&&(this._source.stop(this.toSeconds(t)),this._source=null)}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._source&&(this._source.fadeIn=this._fadeIn)}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._source&&(this._source.fadeOut=this._fadeOut)}_restart(t){this._stop(t),this._start(t)}dispose(){return super.dispose(),this._source&&this._source.disconnect(),this}}const Di=220500,cn={brown:null,pink:null,white:null},wu={get brown(){if(!cn.brown){const p=[];for(let t=0;t<2;t++){const i=new Float32Array(Di);p[t]=i;let l=0;for(let d=0;d<Di;d++){const v=2*Math.random()-1;i[d]=(l+.02*v)/1.02,l=i[d],i[d]*=3.5}}cn.brown=new Wt().fromArray(p)}return cn.brown},get pink(){if(!cn.pink){const p=[];for(let t=0;t<2;t++){const i=new Float32Array(Di);let l,d,v,y,_,S,C;p[t]=i,l=d=v=y=_=S=C=0;for(let M=0;M<Di;M++){const E=2*Math.random()-1;l=.99886*l+.0555179*E,d=.99332*d+.0750759*E,v=.969*v+.153852*E,y=.8665*y+.3104856*E,_=.55*_+.5329522*E,S=-.7616*S-.016898*E,i[M]=l+d+v+y+_+S+C+.5362*E,i[M]*=.11,C=.115926*E}}cn.pink=new Wt().fromArray(p)}return cn.pink},get white(){if(!cn.white){const p=[];for(let t=0;t<2;t++){const i=new Float32Array(Di);p[t]=i;for(let l=0;l<Di;l++)i[l]=2*Math.random()-1}cn.white=new Wt().fromArray(p)}return cn.white}};class vo extends rt{constructor(){const t=Q(vo.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new ln({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Tt(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,volume:0})}open(t){return Kt(this,void 0,void 0,function*(){wt(vo.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const i=yield vo.enumerateDevices();rs(t)?this._device=i[t]:(this._device=i.find(v=>v.label===t||v.deviceId===t),!this._device&&i.length>0&&(this._device=i[0]),wt(Ot(this._device),`No matching device ${t}`));const l={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(l.audio.deviceId=this._device.deviceId);const d=yield navigator.mediaDevices.getUserMedia(l);if(!this._stream){this._stream=d;const v=this.context.createMediaStreamSource(d);Xe(v,this.output),this._mediaStream=v}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return Kt(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){return this._device?this._device.deviceId:void 0}get groupId(){return this._device?this._device.groupId:void 0}get label(){return this._device?this._device.label:void 0}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return Ot(navigator.mediaDevices)&&Ot(navigator.mediaDevices.getUserMedia)}}function Hn(p,t){return Kt(this,void 0,void 0,function*(){const i=t/p.context.sampleRate,l=new Si(1,i,p.context.sampleRate);return new p.constructor(Object.assign(p.get(),{frequency:2/i,detune:0,context:l})).toDestination().start(0),(yield l.render()).getChannelData(0)})}class yo extends Mi{constructor(){const t=Q(yo.getDefaults(),arguments,["frequency","type"]);super(t),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Xe(this._oscillator,this._gainNode),this.type=t.type,this.frequency=new Pt({context:this.context,param:this._oscillator.frequency,units:"frequency",value:t.frequency}),this.detune=new Pt({context:this.context,param:this._oscillator.detune,units:"cents",value:t.detune}),Tt(this,["frequency","detune"])}static getDefaults(){return Object.assign(Mi.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(t){const i=this.toSeconds(t);return this.log("start",i),this._startGain(i),this._oscillator.start(i),this}_stopSource(t){this._oscillator.stop(t)}setPeriodicWave(t){return this._oscillator.setPeriodicWave(t),this}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class he extends fe{constructor(){const t=Q(he.getDefaults(),arguments,["frequency","type"]);super(t),this.name="Oscillator",this._oscillator=null,this.frequency=new Mt({context:this.context,units:"frequency",value:t.frequency}),Tt(this,"frequency"),this.detune=new Mt({context:this.context,units:"cents",value:t.detune}),Tt(this,"detune"),this._partials=t.partials,this._partialCount=t.partialCount,this._type=t.type,t.partialCount&&t.type!=="custom"&&(this._type=this.baseType+t.partialCount.toString()),this.phase=t.phase}static getDefaults(){return Object.assign(fe.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(t){const i=this.toSeconds(t),l=new yo({context:this.context,onended:()=>this.onstop(this)});this._oscillator=l,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(i)}_stop(t){const i=this.toSeconds(t);this._oscillator&&this._oscillator.stop(i)}_restart(t){const i=this.toSeconds(t);return this.log("restart",i),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(i),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return he._periodicWaveCache.find(t=>{return t.phase===this._phase&&(i=t.partials,l=this._partials,i.length===l.length&&i.every((d,v)=>l[v]===d));var i,l});{const t=he._periodicWaveCache.find(i=>i.type===this._type&&i.phase===this._phase);return this._partialCount=t?t.partialCount:this._partialCount,t}}get type(){return this._type}set type(t){this._type=t;const i=["sine","square","sawtooth","triangle"].indexOf(t)!==-1;if(this._phase===0&&i)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=t);else{const l=this._getCachedPeriodicWave();if(Ot(l)){const{partials:d,wave:v}=l;this._wave=v,this._partials=d,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[d,v]=this._getRealImaginary(t,this._phase),y=this.context.createPeriodicWave(d,v);this._wave=y,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),he._periodicWaveCache.push({imag:v,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:d,type:this._type,wave:this._wave}),he._periodicWaveCache.length>100&&he._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(t){this.partialCount&&this._type!=="custom"&&t!=="custom"?this.type=t+this.partialCount:this.type=t}get partialCount(){return this._partialCount}set partialCount(t){Fe(t,0);let i=this._type;const l=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(l&&(i=l[1]),this._type!=="custom")this.type=t===0?i:i+t.toString();else{const d=new Float32Array(t);this._partials.forEach((v,y)=>d[y]=v),this._partials=Array.from(d),this.type=this._type}}_getRealImaginary(t,i){let l=2048;const d=new Float32Array(l),v=new Float32Array(l);let y=1;if(t==="custom"){if(y=this._partials.length+1,this._partialCount=this._partials.length,l=y,this._partials.length===0)return[d,v]}else{const _=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(t);_?(y=parseInt(_[2],10)+1,this._partialCount=parseInt(_[2],10),t=_[1],y=Math.max(y,2),l=y):this._partialCount=0,this._partials=[]}for(let _=1;_<l;++_){const S=2/(_*Math.PI);let C;switch(t){case"sine":C=_<=y?1:0,this._partials[_-1]=C;break;case"square":C=1&_?2*S:0,this._partials[_-1]=C;break;case"sawtooth":C=S*(1&_?1:-1),this._partials[_-1]=C;break;case"triangle":C=1&_?S*S*2*(_-1>>1&1?-1:1):0,this._partials[_-1]=C;break;case"custom":C=this._partials[_-1];break;default:throw new TypeError("Oscillator: invalid type: "+t)}C!==0?(d[_]=-C*Math.sin(i*_),v[_]=C*Math.cos(i*_)):(d[_]=0,v[_]=0)}return[d,v]}_inverseFFT(t,i,l){let d=0;const v=t.length;for(let y=0;y<v;y++)d+=t[y]*Math.cos(y*l)+i[y]*Math.sin(y*l);return d}getInitialValue(){const[t,i]=this._getRealImaginary(this._type,0);let l=0;const d=2*Math.PI;for(let v=0;v<32;v++)l=Math.max(this._inverseFFT(t,i,v/32*d),l);return Vn(-this._inverseFFT(t,i,this._phase)/l,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(t){this._phase=t*Math.PI/180,this.type=this._type}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Hn(this,t)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}he._periodicWaveCache=[];class Lr extends ds{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Fs({context:this.context,mapping:t=>(t+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class ue extends Mt{constructor(){const t=Q(ue.getDefaults(),arguments,["value"]);super(t),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new _t({context:this.context,minValue:t.minValue,maxValue:t.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Mt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class bo extends fe{constructor(){const t=Q(bo.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="AMOscillator",this._modulationScale=new Lr({context:this.context}),this._modulationNode=new _t({context:this.context}),this._carrier=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new he({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Tt(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(he.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){this._modulator.restart(t),this._carrier.restart(t)}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Hn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class Ri extends fe{constructor(){const t=Q(Ri.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="FMOscillator",this._modulationNode=new _t({context:this.context,gain:0}),this._carrier=new he({context:this.context,detune:t.detune,frequency:0,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.detune=this._carrier.detune,this.frequency=new Mt({context:this.context,units:"frequency",value:t.frequency}),this._modulator=new he({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this.modulationIndex=new ue({context:this.context,units:"positive",value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Tt(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(he.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){return this._modulator.restart(t),this._carrier.restart(t),this}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Hn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Oi extends fe{constructor(){const t=Q(Oi.getDefaults(),arguments,["frequency","width"]);super(t),this.name="PulseOscillator",this._widthGate=new _t({context:this.context,gain:0}),this._thresh=new Fs({context:this.context,mapping:i=>i<=0?-1:1}),this.width=new Mt({context:this.context,units:"audioRange",value:t.width}),this._triangle=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Tt(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(fe.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(t){t=this.toSeconds(t),this._triangle.start(t),this._widthGate.gain.setValueAtTime(1,t)}_stop(t){t=this.toSeconds(t),this._triangle.stop(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(0,t)}_restart(t){this._triangle.restart(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(1,t)}get phase(){return this._triangle.phase}set phase(t){this._triangle.phase=t}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(t){this._triangle.type=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Hn(this,t)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class _o extends fe{constructor(){const t=Q(_o.getDefaults(),arguments,["frequency","type","spread"]);super(t),this.name="FatOscillator",this._oscillators=[],this.frequency=new Mt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Mt({context:this.context,units:"cents",value:t.detune}),this._spread=t.spread,this._type=t.type,this._phase=t.phase,this._partials=t.partials,this._partialCount=t.partialCount,this.count=t.count,Tt(this,["frequency","detune"])}static getDefaults(){return Object.assign(he.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(t){t=this.toSeconds(t),this._forEach(i=>i.start(t))}_stop(t){t=this.toSeconds(t),this._forEach(i=>i.stop(t))}_restart(t){this._forEach(i=>i.restart(t))}_forEach(t){for(let i=0;i<this._oscillators.length;i++)t(this._oscillators[i],i)}get type(){return this._type}set type(t){this._type=t,this._forEach(i=>i.type=t)}get spread(){return this._spread}set spread(t){if(this._spread=t,this._oscillators.length>1){const i=-t/2,l=t/(this._oscillators.length-1);this._forEach((d,v)=>d.detune.value=i+l*v)}}get count(){return this._oscillators.length}set count(t){if(Fe(t,1),this._oscillators.length!==t){this._forEach(i=>i.dispose()),this._oscillators=[];for(let i=0;i<t;i++){const l=new he({context:this.context,volume:-6-1.1*t,type:this._type,phase:this._phase+i/t*360,partialCount:this._partialCount,onstop:i===0?()=>this.onstop(this):Ft});this.type==="custom"&&(l.partials=this._partials),this.frequency.connect(l.frequency),this.detune.connect(l.detune),l.detune.overridden=!1,l.connect(this.output),this._oscillators[i]=l}this.spread=this._spread,this.state==="started"&&this._forEach(i=>i.start())}}get phase(){return this._phase}set phase(t){this._phase=t,this._forEach((i,l)=>i.phase=this._phase+l/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(t){this._forEach(i=>i.baseType=t),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this._type="custom",this._forEach(i=>i.partials=t))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(t){this._partialCount=t,this._forEach(i=>i.partialCount=t),this._type=this._oscillators[0].type}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Hn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(t=>t.dispose()),this}}class wo extends fe{constructor(){const t=Q(wo.getDefaults(),arguments,["frequency","modulationFrequency"]);super(t),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new ue({context:this.context,value:2}),this._pulse=new Oi({context:this.context,frequency:t.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Tt(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(fe.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(t){t=this.toSeconds(t),this._modulator.start(t),this._pulse.start(t)}_stop(t){t=this.toSeconds(t),this._modulator.stop(t),this._pulse.stop(t)}_restart(t){this._modulator.restart(t),this._pulse.restart(t)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(t){this._modulator.phase=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Hn(this,t)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const xu={am:bo,fat:_o,fm:Ri,oscillator:he,pulse:Oi,pwm:wo};class hn extends fe{constructor(){const t=Q(hn.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OmniOscillator",this.frequency=new Mt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Mt({context:this.context,units:"cents",value:t.detune}),Tt(this,["frequency","detune"]),this.set(t)}static getDefaults(){return Object.assign(he.getDefaults(),Ri.getDefaults(),bo.getDefaults(),_o.getDefaults(),Oi.getDefaults(),wo.getDefaults())}_start(t){this._oscillator.start(t)}_stop(t){this._oscillator.stop(t)}_restart(t){return this._oscillator.restart(t),this}get type(){let t="";return["am","fm","fat"].some(i=>this._sourceType===i)&&(t=this._sourceType),t+this._oscillator.type}set type(t){t.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(3)):t==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):t==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=t)}get partials(){return this._oscillator.partials}set partials(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=t)}get partialCount(){return this._oscillator.partialCount}set partialCount(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=t)}set(t){return Reflect.has(t,"type")&&t.type&&(this.type=t.type),super.set(t),this}_createNewOscillator(t){if(t!==this._sourceType){this._sourceType=t;const i=xu[t],l=this.now();if(this._oscillator){const d=this._oscillator;d.stop(l),this.context.setTimeout(()=>d.dispose(),this.blockTime)}this._oscillator=new i({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(l)}}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t}get sourceType(){return this._sourceType}set sourceType(t){let i="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(i=this._oscillator.type),t==="fm"?this.type="fm"+i:t==="am"?this.type="am"+i:t==="fat"?this.type="fat"+i:t==="oscillator"?this.type=i:t==="pulse"?this.type="pulse":t==="pwm"&&(this.type="pwm")}_getOscType(t,i){return t instanceof xu[i]}get baseType(){return this._oscillator.baseType}set baseType(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||t==="pulse"||t==="pwm"||(this._oscillator.baseType=t)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(t){this._getOscType(this._oscillator,"fat")&&rs(t)&&(this._oscillator.count=t)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(t){this._getOscType(this._oscillator,"fat")&&rs(t)&&(this._oscillator.spread=t)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(t){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Os(t)&&(this._oscillator.modulationType=t)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Hn(this,t)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}class Gn extends Mt{constructor(){super(Q(Gn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new _t({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,hs(this._constantSource,this._sum)}static getDefaults(){return Object.assign(Mt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class un extends ds{constructor(){const t=Q(un.getDefaults(),arguments,["min","max"]);super(t),this.name="Scale",this._mult=this.input=new ue({context:this.context,value:t.max-t.min}),this._add=this.output=new Gn({context:this.context,value:t.min}),this._min=t.min,this._max=t.max,this.input.connect(this.output)}static getDefaults(){return Object.assign(ds.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(t){this._min=t,this._setRange()}get max(){return this._max}set max(t){this._max=t,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class Fr extends ds{constructor(){super(Q(Fr.getDefaults(),arguments)),this.name="Zero",this._gain=new _t({context:this.context}),this.output=this._gain,this.input=void 0,Xe(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),sl(this.context.getConstant(0),this._gain),this}}class Ye extends rt{constructor(){const t=Q(Ye.getDefaults(),arguments,["frequency","min","max"]);super(t),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=Pt.prototype._fromType,this._toType=Pt.prototype._toType,this._is=Pt.prototype._is,this._clampValue=Pt.prototype._clampValue,this._oscillator=new he(t),this.frequency=this._oscillator.frequency,this._amplitudeGain=new _t({context:this.context,gain:t.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new Mt({context:this.context,units:"audioRange",value:0}),this._zeros=new Fr({context:this.context}),this._a2g=new Lr({context:this.context}),this._scaler=this.output=new un({context:this.context,max:t.max,min:t.min}),this.units=t.units,this.min=t.min,this.max=t.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),Tt(this,["amplitude","frequency"]),this.phase=t.phase}static getDefaults(){return Object.assign(he.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(0,t),this._oscillator.start(t),this}stop(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(this._stoppedValue,t),this._oscillator.stop(t),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(t){t=this._fromType(t),this._scaler.min=t}get max(){return this._toType(this._scaler.max)}set max(t){t=this._fromType(t),this._scaler.max=t}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(t){this._oscillator.partials=t,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t,this._setStoppedValue()}get units(){return this._units}set units(t){const i=this.min,l=this.max;this._units=t,this.min=i,this.max=l}get state(){return this._oscillator.state}connect(t,i,l){return(t instanceof Pt||t instanceof Mt)&&(this.convert=t.convert,this.units=t.units),go(this,t,i,l),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}function Su(p,t=1/0){const i=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return i.get(this)},set:function(v){Fe(v,p,t),i.set(this,v)}})}}function dn(p,t=1/0){const i=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return i.get(this)},set:function(v){Fe(this.toSeconds(v),p,t),i.set(this,v)}})}}class Ni extends fe{constructor(){const t=Q(Ni.getDefaults(),arguments,["url","onload"]);super(t),this.name="Player",this._activeSources=new Set,this._buffer=new Wt({onload:this._onload.bind(this,t.onload),onerror:t.onerror,reverse:t.reverse,url:t.url}),this.autostart=t.autostart,this._loop=t.loop,this._loopStart=t.loopStart,this._loopEnd=t.loopEnd,this._playbackRate=t.playbackRate,this.fadeIn=t.fadeIn,this.fadeOut=t.fadeOut}static getDefaults(){return Object.assign(fe.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Ft,onerror:Ft,playbackRate:1,reverse:!1})}load(t){return Kt(this,void 0,void 0,function*(){return yield this._buffer.load(t),this._onload(),this})}_onload(t=Ft){t(),this.autostart&&this.start()}_onSourceEnd(t){this.onstop(this),this._activeSources.delete(t),this._activeSources.size!==0||this._synced||this._state.getValueAtTime(this.now())!=="started"||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(t,i,l){return super.start(t,i,l),this}_start(t,i,l){i=this._loop?Ss(i,this._loopStart):Ss(i,0);const d=this.toSeconds(i),v=l;l=Ss(l,Math.max(this._buffer.duration-d,0));let y=this.toSeconds(l);y/=this._playbackRate,t=this.toSeconds(t);const _=new Mn({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(t+y),this._state.setStateAtTime("stopped",t+y,{implicitEnd:!0})),this._activeSources.add(_),this._loop&&ts(v)?_.start(t,d):_.start(t,d,y-this.toSeconds(this.fadeOut))}_stop(t){const i=this.toSeconds(t);this._activeSources.forEach(l=>l.stop(i))}restart(t,i,l){return super.restart(t,i,l),this}_restart(t,i,l){var d;(d=[...this._activeSources].pop())===null||d===void 0||d.stop(t),this._start(t,i,l)}seek(t,i){const l=this.toSeconds(i);if(this._state.getValueAtTime(l)==="started"){const d=this.toSeconds(t);this._stop(l),this._start(l,d)}return this}setLoopPoints(t,i){return this.loopStart=t,this.loopEnd=i,this}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this.buffer.loaded&&Fe(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(i=>{i.loopStart=t})}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this.buffer.loaded&&Fe(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(i=>{i.loopEnd=t})}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._loop}set loop(t){if(this._loop!==t&&(this._loop=t,this._activeSources.forEach(i=>{i.loop=t}),t)){const i=this._state.getNextState("stopped",this.now());i&&this._state.cancel(i.time)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t;const i=this.now(),l=this._state.getNextState("stopped",i);l&&l.implicitEnd&&(this._state.cancel(l.time),this._activeSources.forEach(d=>d.cancelStop())),this._activeSources.forEach(d=>{d.playbackRate.setValueAtTime(t,i)})}get reverse(){return this._buffer.reverse}set reverse(t){this._buffer.reverse=t}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(t=>t.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}Ns([dn(0)],Ni.prototype,"fadeIn",void 0),Ns([dn(0)],Ni.prototype,"fadeOut",void 0);class ll extends rt{constructor(){const t=Q(ll.getDefaults(),arguments,["urls","onload"],"urls");super(t),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new ln({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Tt(this,"volume"),this._buffers=new Pi({urls:t.urls,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.mute=t.mute,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(fe.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:Ft,onerror:Ft,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._players.forEach(i=>{i.fadeIn=t})}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._players.forEach(i=>{i.fadeOut=t})}get state(){return Array.from(this._players).some(([t,i])=>i.state==="started")?"started":"stopped"}has(t){return this._buffers.has(t)}player(t){if(wt(this.has(t),`No Player with the name ${t} exists on this object`),!this._players.has(t)){const i=new Ni({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(t)}).connect(this.output);this._players.set(t,i)}return this._players.get(t)}get loaded(){return this._buffers.loaded}add(t,i,l){return wt(!this._buffers.has(t),"A buffer with that name already exists on this object"),this._buffers.add(t,i,l),this}stopAll(t){return this._players.forEach(i=>i.stop(t)),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach(t=>t.dispose()),this._buffers.dispose(),this}}class cl extends fe{constructor(){const t=Q(cl.getDefaults(),arguments,["url","onload"]);super(t),this.name="GrainPlayer",this._loopStart=0,this._loopEnd=0,this._activeSources=[],this.buffer=new Wt({onload:t.onload,onerror:t.onerror,reverse:t.reverse,url:t.url}),this._clock=new Ei({context:this.context,callback:this._tick.bind(this),frequency:1/t.grainSize}),this._playbackRate=t.playbackRate,this._grainSize=t.grainSize,this._overlap=t.overlap,this.detune=t.detune,this.overlap=t.overlap,this.loop=t.loop,this.playbackRate=t.playbackRate,this.grainSize=t.grainSize,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.reverse=t.reverse,this._clock.on("stop",this._onstop.bind(this))}static getDefaults(){return Object.assign(fe.getDefaults(),{onload:Ft,onerror:Ft,overlap:.1,grainSize:.2,playbackRate:1,detune:0,loop:!1,loopStart:0,loopEnd:0,reverse:!1})}_start(t,i,l){i=Ss(i,0),i=this.toSeconds(i),t=this.toSeconds(t);const d=1/this._clock.frequency.getValueAtTime(t);this._clock.start(t,i/d),l&&this.stop(t+this.toSeconds(l))}restart(t,i,l){return super.restart(t,i,l),this}_restart(t,i,l){this._stop(t),this._start(t,i,l)}_stop(t){this._clock.stop(t)}_onstop(t){this._activeSources.forEach(i=>{i.fadeOut=0,i.stop(t)}),this.onstop(this)}_tick(t){const i=this._clock.getTicksAtTime(t),l=i*this._grainSize;if(this.log("offset",l),!this.loop&&l>this.buffer.duration)return void this.stop(t);const d=l<this._overlap?0:this._overlap,v=new Mn({context:this.context,url:this.buffer,fadeIn:d,fadeOut:this._overlap,loop:this.loop,loopStart:this._loopStart,loopEnd:this._loopEnd,playbackRate:Ti(this.detune/100)}).connect(this.output);v.start(t,this._grainSize*i),v.stop(t+this._grainSize/this.playbackRate),this._activeSources.push(v),v.onended=()=>{const y=this._activeSources.indexOf(v);y!==-1&&this._activeSources.splice(y,1)}}get playbackRate(){return this._playbackRate}set playbackRate(t){Fe(t,.001),this._playbackRate=t,this.grainSize=this._grainSize}get loopStart(){return this._loopStart}set loopStart(t){this.buffer.loaded&&Fe(this.toSeconds(t),0,this.buffer.duration),this._loopStart=this.toSeconds(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this.buffer.loaded&&Fe(this.toSeconds(t),0,this.buffer.duration),this._loopEnd=this.toSeconds(t)}get reverse(){return this.buffer.reverse}set reverse(t){this.buffer.reverse=t}get grainSize(){return this._grainSize}set grainSize(t){this._grainSize=this.toSeconds(t),this._clock.frequency.setValueAtTime(this._playbackRate/this._grainSize,this.now())}get overlap(){return this._overlap}set overlap(t){const i=this.toSeconds(t);Fe(i,0),this._overlap=i}get loaded(){return this.buffer.loaded}dispose(){return super.dispose(),this.buffer.dispose(),this._clock.dispose(),this._activeSources.forEach(t=>t.dispose()),this}}class Cu extends ds{constructor(){super(...arguments),this.name="Abs",this._abs=new Fs({context:this.context,mapping:t=>Math.abs(t)<.001?0:Math.abs(t)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class Tu extends ds{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new Fs({context:this.context,mapping:t=>2*Math.abs(t)-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class hl extends ds{constructor(){super(...arguments),this.name="Negate",this._multiply=new ue({context:this.context,value:-1}),this.input=this._multiply,this.output=this._multiply}dispose(){return super.dispose(),this._multiply.dispose(),this}}class jn extends Mt{constructor(){super(Q(jn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Subtract",this._sum=new _t({context:this.context}),this.input=this._sum,this.output=this._sum,this._neg=new hl({context:this.context}),this.subtrahend=this._param,hs(this._constantSource,this._neg,this._sum)}static getDefaults(){return Object.assign(Mt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._neg.dispose(),this._sum.dispose(),this}}class $r extends ds{constructor(){super(Q($r.getDefaults(),arguments)),this.name="GreaterThanZero",this._thresh=this.output=new Fs({context:this.context,length:127,mapping:t=>t<=0?0:1}),this._scale=this.input=new ue({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class Br extends Mt{constructor(){const t=Q(Br.getDefaults(),arguments,["value"]);super(t),this.name="GreaterThan",this.override=!1,this._subtract=this.input=new jn({context:this.context,value:t.value}),this._gtz=this.output=new $r({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,Tt(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(Mt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class qr extends un{constructor(){const t=Q(qr.getDefaults(),arguments,["min","max","exponent"]);super(t),this.name="ScaleExp",this.input=this._exp=new Ii({context:this.context,value:t.exponent}),this._exp.connect(this._mult)}static getDefaults(){return Object.assign(un.getDefaults(),{exponent:1})}get exponent(){return this._exp.value}set exponent(t){this._exp.value=t}dispose(){return super.dispose(),this._exp.dispose(),this}}class ig extends Mt{constructor(){const t=Q(Mt.getDefaults(),arguments,["value","units"]);super(t),this.name="SyncedSignal",this.override=!1,this._lastVal=t.value,this._synced=this.context.transport.scheduleRepeat(this._onTick.bind(this),"1i"),this._syncedCallback=this._anchorValue.bind(this),this.context.transport.on("start",this._syncedCallback),this.context.transport.on("pause",this._syncedCallback),this.context.transport.on("stop",this._syncedCallback),this._constantSource.disconnect(),this._constantSource.stop(0),this._constantSource=this.output=new Or({context:this.context,offset:t.value,units:t.units}).start(0),this.setValueAtTime(t.value,0)}_onTick(t){const i=super.getValueAtTime(this.context.transport.seconds);this._lastVal!==i&&(this._lastVal=i,this._constantSource.offset.setValueAtTime(i,t))}_anchorValue(t){const i=super.getValueAtTime(this.context.transport.seconds);this._lastVal=i,this._constantSource.offset.cancelAndHoldAtTime(t),this._constantSource.offset.setValueAtTime(i,t)}getValueAtTime(t){const i=new _e(this.context,t).toSeconds();return super.getValueAtTime(i)}setValueAtTime(t,i){const l=new _e(this.context,i).toSeconds();return super.setValueAtTime(t,l),this}linearRampToValueAtTime(t,i){const l=new _e(this.context,i).toSeconds();return super.linearRampToValueAtTime(t,l),this}exponentialRampToValueAtTime(t,i){const l=new _e(this.context,i).toSeconds();return super.exponentialRampToValueAtTime(t,l),this}setTargetAtTime(t,i,l){const d=new _e(this.context,i).toSeconds();return super.setTargetAtTime(t,d,l),this}cancelScheduledValues(t){const i=new _e(this.context,t).toSeconds();return super.cancelScheduledValues(i),this}setValueCurveAtTime(t,i,l,d){const v=new _e(this.context,i).toSeconds();return l=this.toSeconds(l),super.setValueCurveAtTime(t,v,l,d),this}cancelAndHoldAtTime(t){const i=new _e(this.context,t).toSeconds();return super.cancelAndHoldAtTime(i),this}setRampPoint(t){const i=new _e(this.context,t).toSeconds();return super.setRampPoint(i),this}exponentialRampTo(t,i,l){const d=new _e(this.context,l).toSeconds();return super.exponentialRampTo(t,i,d),this}linearRampTo(t,i,l){const d=new _e(this.context,l).toSeconds();return super.linearRampTo(t,i,d),this}targetRampTo(t,i,l){const d=new _e(this.context,l).toSeconds();return super.targetRampTo(t,i,d),this}dispose(){return super.dispose(),this.context.transport.clear(this._synced),this.context.transport.off("start",this._syncedCallback),this.context.transport.off("pause",this._syncedCallback),this.context.transport.off("stop",this._syncedCallback),this._constantSource.dispose(),this}}class Be extends rt{constructor(){const t=Q(Be.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="Envelope",this._sig=new Mt({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=t.attack,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.attackCurve=t.attackCurve,this.releaseCurve=t.releaseCurve,this.decayCurve=t.decayCurve}static getDefaults(){return Object.assign(rt.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(t,i){if(Os(t))return t;{let l;for(l in zr)if(zr[l][i]===t)return l;return t}}_setCurve(t,i,l){if(Os(l)&&Reflect.has(zr,l)){const d=zr[l];rn(d)?t!=="_decayCurve"&&(this[t]=d[i]):this[t]=d}else{if(!Le(l)||t==="_decayCurve")throw new Error("Envelope: invalid curve: "+l);this[t]=l}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(t){this._setCurve("_attackCurve","In",t)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(t){this._setCurve("_releaseCurve","Out",t)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(t){this._setCurve("_decayCurve","Out",t)}triggerAttack(t,i=1){this.log("triggerAttack",t,i),t=this.toSeconds(t);let l=this.toSeconds(this.attack);const d=this.toSeconds(this.decay),v=this.getValueAtTime(t);if(v>0&&(l=(1-v)/(1/l)),l<this.sampleTime)this._sig.cancelScheduledValues(t),this._sig.setValueAtTime(i,t);else if(this._attackCurve==="linear")this._sig.linearRampTo(i,l,t);else if(this._attackCurve==="exponential")this._sig.targetRampTo(i,l,t);else{this._sig.cancelAndHoldAtTime(t);let y=this._attackCurve;for(let _=1;_<y.length;_++)if(y[_-1]<=v&&v<=y[_]){y=this._attackCurve.slice(_),y[0]=v;break}this._sig.setValueCurveAtTime(y,t,l,i)}if(d&&this.sustain<1){const y=i*this.sustain,_=t+l;this.log("decay",_),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(y,d+_):this._sig.exponentialApproachValueAtTime(y,_,d)}return this}triggerRelease(t){this.log("triggerRelease",t),t=this.toSeconds(t);const i=this.getValueAtTime(t);if(i>0){const l=this.toSeconds(this.release);l<this.sampleTime?this._sig.setValueAtTime(0,t):this._releaseCurve==="linear"?this._sig.linearRampTo(0,l,t):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,l,t):(wt(Le(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(t),this._sig.setValueCurveAtTime(this._releaseCurve,t,l,i))}return this}getValueAtTime(t){return this._sig.getValueAtTime(t)}triggerAttackRelease(t,i,l=1){return i=this.toSeconds(i),this.triggerAttack(i,l),this.triggerRelease(i+this.toSeconds(t)),this}cancel(t){return this._sig.cancelScheduledValues(this.toSeconds(t)),this}connect(t,i=0,l=0){return go(this,t,i,l),this}asArray(){return Kt(this,arguments,void 0,function*(t=1024){const i=t/this.context.sampleRate,l=new Si(1,i,this.context.sampleRate),d=this.toSeconds(this.attack)+this.toSeconds(this.decay),v=d+this.toSeconds(this.release),y=.1*v,_=v+y,S=new this.constructor(Object.assign(this.get(),{attack:i*this.toSeconds(this.attack)/_,decay:i*this.toSeconds(this.decay)/_,release:i*this.toSeconds(this.release)/_,context:l}));return S._sig.toDestination(),S.triggerAttackRelease(i*(d+y)/_,0),(yield l.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}Ns([dn(0)],Be.prototype,"attack",void 0),Ns([dn(0)],Be.prototype,"decay",void 0),Ns([Su(0,1)],Be.prototype,"sustain",void 0),Ns([dn(0)],Be.prototype,"release",void 0);const zr=(()=>{let t,i;const l=[];for(t=0;t<128;t++)l[t]=Math.sin(t/127*(Math.PI/2));const d=[];for(t=0;t<127;t++){i=t/127;const M=Math.sin(i*(2*Math.PI)*6.4-Math.PI/2)+1;d[t]=M/10+.83*i}d[127]=1;const v=[];for(t=0;t<128;t++)v[t]=Math.ceil(t/127*5)/5;const y=[];for(t=0;t<128;t++)i=t/127,y[t]=.5*(1-Math.cos(Math.PI*i));const _=[];for(t=0;t<128;t++){i=t/127;const M=4*Math.pow(i,3)+.2,E=Math.cos(M*Math.PI*2*i);_[t]=Math.abs(E*(1-i))}function S(M){const E=new Array(M.length);for(let D=0;D<M.length;D++)E[D]=1-M[D];return E}return{bounce:{In:S(_),Out:_},cosine:{In:l,Out:(C=l,C.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:d,Out:S(d)},sine:{In:y,Out:S(y)},step:{In:v,Out:S(v)}};var C})();class Cs extends rt{constructor(){const t=Q(Cs.getDefaults(),arguments);super(t),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=i=>this._original_triggerRelease(i),this._volume=this.output=new ln({context:this.context,volume:t.volume}),this.volume=this._volume.volume,Tt(this,"volume")}static getDefaults(){return Object.assign(rt.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let t=!1;return this._synced||(this._synced=!0,t=!0),t}_syncMethod(t,i){const l=this["_original_"+t]=this[t];this[t]=(...d)=>{const v=d[i],y=this.context.transport.schedule(_=>{d[i]=_,l.apply(this,d)},v);this._scheduledEvents.push(y)}}unsync(){return this._scheduledEvents.forEach(t=>this.context.transport.clear(t)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(t,i,l,d){const v=this.toSeconds(l),y=this.toSeconds(i);return this.triggerAttack(t,v,d),this.triggerRelease(v+y),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class qe extends Cs{constructor(){const t=Q(qe.getDefaults(),arguments);super(t),this.portamento=t.portamento,this.onsilence=t.onsilence}static getDefaults(){return Object.assign(Cs.getDefaults(),{detune:0,onsilence:Ft,portamento:0})}triggerAttack(t,i,l=1){this.log("triggerAttack",t,i,l);const d=this.toSeconds(i);return this._triggerEnvelopeAttack(d,l),this.setNote(t,d),this}triggerRelease(t){this.log("triggerRelease",t);const i=this.toSeconds(t);return this._triggerEnvelopeRelease(i),this}setNote(t,i){const l=this.toSeconds(i),d=t instanceof Ue?t.toFrequency():t;if(this.portamento>0&&this.getLevelAtTime(l)>.05){const v=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(d,v,l)}else this.frequency.setValueAtTime(d,l);return this}}Ns([dn(0)],qe.prototype,"portamento",void 0);class Li extends Be{constructor(){super(Q(Li.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new _t({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Pn extends qe{constructor(){const t=Q(Pn.getDefaults(),arguments);super(t),this.name="Synth",this.oscillator=new hn(Object.assign({context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)},t.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Li(Object.assign({context:this.context},t.envelope)),this.oscillator.chain(this.envelope,this.output),Tt(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(qe.getDefaults(),{envelope:Object.assign($e(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign($e(hn.getDefaults(),[...Object.keys(fe.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(t,i){if(this.envelope.triggerAttack(t,i),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class xo extends qe{constructor(){const t=Q(xo.getDefaults(),arguments);super(t),this.name="ModulationSynth",this._carrier=new Pn({context:this.context,oscillator:t.oscillator,envelope:t.envelope,onsilence:()=>this.onsilence(this),volume:-10}),this._modulator=new Pn({context:this.context,oscillator:t.modulation,envelope:t.modulationEnvelope,volume:-10}),this.oscillator=this._carrier.oscillator,this.envelope=this._carrier.envelope,this.modulation=this._modulator.oscillator,this.modulationEnvelope=this._modulator.envelope,this.frequency=new Mt({context:this.context,units:"frequency"}),this.detune=new Mt({context:this.context,value:t.detune,units:"cents"}),this.harmonicity=new ue({context:this.context,value:t.harmonicity,minValue:0}),this._modulationNode=new _t({context:this.context,gain:0}),Tt(this,["frequency","harmonicity","oscillator","envelope","modulation","modulationEnvelope","detune"])}static getDefaults(){return Object.assign(qe.getDefaults(),{harmonicity:3,oscillator:Object.assign($e(hn.getDefaults(),[...Object.keys(fe.getDefaults()),"frequency","detune"]),{type:"sine"}),envelope:Object.assign($e(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.01,decay:.01,sustain:1,release:.5}),modulation:Object.assign($e(hn.getDefaults(),[...Object.keys(fe.getDefaults()),"frequency","detune"]),{type:"square"}),modulationEnvelope:Object.assign($e(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.5,decay:0,sustain:1,release:.5})})}_triggerEnvelopeAttack(t,i){this._carrier._triggerEnvelopeAttack(t,i),this._modulator._triggerEnvelopeAttack(t,i)}_triggerEnvelopeRelease(t){return this._carrier._triggerEnvelopeRelease(t),this._modulator._triggerEnvelopeRelease(t),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this._carrier.dispose(),this._modulator.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._modulationNode.dispose(),this}}class ul extends xo{constructor(){super(Q(ul.getDefaults(),arguments)),this.name="AMSynth",this._modulationScale=new Lr({context:this.context}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output)}dispose(){return super.dispose(),this._modulationScale.dispose(),this}}class So extends rt{constructor(){const t=Q(So.getDefaults(),arguments,["frequency","type"]);super(t),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new Pt({context:this.context,units:"number",value:t.Q,param:this._filter.Q}),this.frequency=new Pt({context:this.context,units:"frequency",value:t.frequency,param:this._filter.frequency}),this.detune=new Pt({context:this.context,units:"cents",value:t.detune,param:this._filter.detune}),this.gain=new Pt({context:this.context,units:"decibels",convert:!1,value:t.gain,param:this._filter.gain}),this.type=t.type}static getDefaults(){return Object.assign(rt.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(t){wt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._filter.type=t}getFrequencyResponse(t=128){const i=new Float32Array(t);for(let y=0;y<t;y++){const _=19980*Math.pow(y/t,2)+20;i[y]=_}const l=new Float32Array(t),d=new Float32Array(t),v=this.context.createBiquadFilter();return v.type=this.type,v.Q.value=this.Q.value,v.frequency.value=this.frequency.value,v.gain.value=this.gain.value,v.getFrequencyResponse(i,l,d),l}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class ps extends rt{constructor(){const t=Q(ps.getDefaults(),arguments,["frequency","type","rolloff"]);super(t),this.name="Filter",this.input=new _t({context:this.context}),this.output=new _t({context:this.context}),this._filters=[],this._filters=[],this.Q=new Mt({context:this.context,units:"positive",value:t.Q}),this.frequency=new Mt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Mt({context:this.context,units:"cents",value:t.detune}),this.gain=new Mt({context:this.context,units:"decibels",convert:!1,value:t.gain}),this._type=t.type,this.rolloff=t.rolloff,Tt(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(rt.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(t){wt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._type=t,this._filters.forEach(i=>i.type=t)}get rolloff(){return this._rolloff}set rolloff(t){const i=rs(t)?t:parseInt(t,10),l=[-12,-24,-48,-96];let d=l.indexOf(i);wt(d!==-1,`rolloff can only be ${l.join(", ")}`),d+=1,this._rolloff=i,this.input.disconnect(),this._filters.forEach(v=>v.disconnect()),this._filters=new Array(d);for(let v=0;v<d;v++){const y=new So({context:this.context});y.type=this._type,this.frequency.connect(y.frequency),this.detune.connect(y.detune),this.Q.connect(y.Q),this.gain.connect(y.gain),this._filters[v]=y}this._internalChannels=this._filters,hs(this.input,...this._internalChannels,this.output)}getFrequencyResponse(t=128){const i=new So({frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),l=new Float32Array(t).map(()=>1);return this._filters.forEach(()=>{i.getFrequencyResponse(t).forEach((d,v)=>l[v]*=d)}),i.dispose(),l}dispose(){return super.dispose(),this._filters.forEach(t=>{t.dispose()}),po(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class Co extends Be{constructor(){const t=Q(Co.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="FrequencyEnvelope",this._octaves=t.octaves,this._baseFrequency=this.toFrequency(t.baseFrequency),this._exponent=this.input=new Ii({context:this.context,value:t.exponent}),this._scale=this.output=new un({context:this.context,min:this._baseFrequency,max:this._baseFrequency*Math.pow(2,this._octaves)}),this._sig.chain(this._exponent,this._scale)}static getDefaults(){return Object.assign(Be.getDefaults(),{baseFrequency:200,exponent:1,octaves:4})}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){const i=this.toFrequency(t);Fe(i,0),this._baseFrequency=i,this._scale.min=this._baseFrequency,this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._scale.max=this._baseFrequency*Math.pow(2,t)}get exponent(){return this._exponent.value}set exponent(t){this._exponent.value=t}dispose(){return super.dispose(),this._exponent.dispose(),this._scale.dispose(),this}}class Un extends qe{constructor(){const t=Q(Un.getDefaults(),arguments);super(t),this.name="MonoSynth",this.oscillator=new hn(Object.assign(t.oscillator,{context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)})),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.filter=new ps(Object.assign(t.filter,{context:this.context})),this.filterEnvelope=new Co(Object.assign(t.filterEnvelope,{context:this.context})),this.envelope=new Li(Object.assign(t.envelope,{context:this.context})),this.oscillator.chain(this.filter,this.envelope,this.output),this.filterEnvelope.connect(this.filter.frequency),Tt(this,["oscillator","frequency","detune","filter","filterEnvelope","envelope"])}static getDefaults(){return Object.assign(qe.getDefaults(),{envelope:Object.assign($e(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.9}),filter:Object.assign($e(ps.getDefaults(),Object.keys(rt.getDefaults())),{Q:1,rolloff:-12,type:"lowpass"}),filterEnvelope:Object.assign($e(Co.getDefaults(),Object.keys(rt.getDefaults())),{attack:.6,baseFrequency:200,decay:.2,exponent:2,octaves:3,release:2,sustain:.5}),oscillator:Object.assign($e(hn.getDefaults(),Object.keys(fe.getDefaults())),{type:"sawtooth"})})}_triggerEnvelopeAttack(t,i=1){if(this.envelope.triggerAttack(t,i),this.filterEnvelope.triggerAttack(t),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.filterEnvelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this.filterEnvelope.dispose(),this.filter.dispose(),this}}class dl extends qe{constructor(){const t=Q(dl.getDefaults(),arguments);super(t),this.name="DuoSynth",this.voice0=new Un(Object.assign(t.voice0,{context:this.context,onsilence:()=>this.onsilence(this)})),this.voice1=new Un(Object.assign(t.voice1,{context:this.context})),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this._vibrato=new Ye({frequency:t.vibratoRate,context:this.context,min:-50,max:50}),this._vibrato.start(),this.vibratoRate=this._vibrato.frequency,this._vibratoGain=new _t({context:this.context,units:"normalRange",gain:t.vibratoAmount}),this.vibratoAmount=this._vibratoGain.gain,this.frequency=new Mt({context:this.context,units:"frequency",value:440}),this.detune=new Mt({context:this.context,units:"cents",value:t.detune}),this.frequency.connect(this.voice0.frequency),this.frequency.chain(this.harmonicity,this.voice1.frequency),this._vibrato.connect(this._vibratoGain),this._vibratoGain.fan(this.voice0.detune,this.voice1.detune),this.detune.fan(this.voice0.detune,this.voice1.detune),this.voice0.connect(this.output),this.voice1.connect(this.output),Tt(this,["voice0","voice1","frequency","vibratoAmount","vibratoRate"])}getLevelAtTime(t){return t=this.toSeconds(t),this.voice0.envelope.getValueAtTime(t)+this.voice1.envelope.getValueAtTime(t)}static getDefaults(){return xs(qe.getDefaults(),{vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:xs($e(Un.getDefaults(),Object.keys(qe.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}}),voice1:xs($e(Un.getDefaults(),Object.keys(qe.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}})})}_triggerEnvelopeAttack(t,i){this.voice0._triggerEnvelopeAttack(t,i),this.voice1._triggerEnvelopeAttack(t,i)}_triggerEnvelopeRelease(t){return this.voice0._triggerEnvelopeRelease(t),this.voice1._triggerEnvelopeRelease(t),this}dispose(){return super.dispose(),this.voice0.dispose(),this.voice1.dispose(),this.frequency.dispose(),this.detune.dispose(),this._vibrato.dispose(),this.vibratoRate.dispose(),this._vibratoGain.dispose(),this.harmonicity.dispose(),this}}class pl extends xo{constructor(){const t=Q(pl.getDefaults(),arguments);super(t),this.name="FMSynth",this.modulationIndex=new ue({context:this.context,value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output)}static getDefaults(){return Object.assign(xo.getDefaults(),{modulationIndex:10})}dispose(){return super.dispose(),this.modulationIndex.dispose(),this}}const Au=[1,1.483,1.932,2.546,2.63,3.897];class ml extends qe{constructor(){const t=Q(ml.getDefaults(),arguments);super(t),this.name="MetalSynth",this._oscillators=[],this._freqMultipliers=[],this.detune=new Mt({context:this.context,units:"cents",value:t.detune}),this.frequency=new Mt({context:this.context,units:"frequency"}),this._amplitude=new _t({context:this.context,gain:0}).connect(this.output),this._highpass=new ps({Q:0,context:this.context,type:"highpass"}).connect(this._amplitude);for(let i=0;i<Au.length;i++){const l=new Ri({context:this.context,harmonicity:t.harmonicity,modulationIndex:t.modulationIndex,modulationType:"square",onstop:i===0?()=>this.onsilence(this):Ft,type:"square"});l.connect(this._highpass),this._oscillators[i]=l;const d=new ue({context:this.context,value:Au[i]});this._freqMultipliers[i]=d,this.frequency.chain(d,l.frequency),this.detune.connect(l.detune)}this._filterFreqScaler=new un({context:this.context,max:7e3,min:this.toFrequency(t.resonance)}),this.envelope=new Be({attack:t.envelope.attack,attackCurve:"linear",context:this.context,decay:t.envelope.decay,release:t.envelope.release,sustain:0}),this.envelope.chain(this._filterFreqScaler,this._highpass.frequency),this.envelope.connect(this._amplitude.gain),this._octaves=t.octaves,this.octaves=t.octaves}static getDefaults(){return xs(qe.getDefaults(),{envelope:Object.assign($e(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.001,decay:1.4,release:.2}),harmonicity:5.1,modulationIndex:32,octaves:1.5,resonance:4e3})}_triggerEnvelopeAttack(t,i=1){return this.envelope.triggerAttack(t,i),this._oscillators.forEach(l=>l.start(t)),this.envelope.sustain===0&&this._oscillators.forEach(l=>{l.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay))}),this}_triggerEnvelopeRelease(t){return this.envelope.triggerRelease(t),this._oscillators.forEach(i=>i.stop(t+this.toSeconds(this.envelope.release))),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}get modulationIndex(){return this._oscillators[0].modulationIndex.value}set modulationIndex(t){this._oscillators.forEach(i=>i.modulationIndex.value=t)}get harmonicity(){return this._oscillators[0].harmonicity.value}set harmonicity(t){this._oscillators.forEach(i=>i.harmonicity.value=t)}get resonance(){return this._filterFreqScaler.min}set resonance(t){this._filterFreqScaler.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._filterFreqScaler.max=this._filterFreqScaler.min*Math.pow(2,t)}dispose(){return super.dispose(),this._oscillators.forEach(t=>t.dispose()),this._freqMultipliers.forEach(t=>t.dispose()),this.frequency.dispose(),this.detune.dispose(),this._filterFreqScaler.dispose(),this._amplitude.dispose(),this.envelope.dispose(),this._highpass.dispose(),this}}class To extends Pn{constructor(){const t=Q(To.getDefaults(),arguments);super(t),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=t.pitchDecay,this.octaves=t.octaves,Tt(this,["oscillator","envelope"])}static getDefaults(){return xs(qe.getDefaults(),Pn.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(t,i){const l=this.toSeconds(i),d=this.toFrequency(t instanceof Ue?t.toFrequency():t),v=d*this.octaves;return this.oscillator.frequency.setValueAtTime(v,l),this.oscillator.frequency.exponentialRampToValueAtTime(d,l+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}Ns([Su(0)],To.prototype,"octaves",void 0),Ns([dn(0)],To.prototype,"pitchDecay",void 0);class fl extends Cs{constructor(){const t=Q(fl.getDefaults(),arguments);super(t),this.name="NoiseSynth",this.noise=new En(Object.assign({context:this.context},t.noise)),this.envelope=new Li(Object.assign({context:this.context},t.envelope)),this.noise.chain(this.envelope,this.output)}static getDefaults(){return Object.assign(Cs.getDefaults(),{envelope:Object.assign($e(Be.getDefaults(),Object.keys(rt.getDefaults())),{decay:.1,sustain:0}),noise:Object.assign($e(En.getDefaults(),Object.keys(fe.getDefaults())),{type:"white"})})}triggerAttack(t,i=1){return t=this.toSeconds(t),this.envelope.triggerAttack(t,i),this.noise.start(t),this.envelope.sustain===0&&this.noise.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay)),this}triggerRelease(t){return t=this.toSeconds(t),this.envelope.triggerRelease(t),this.noise.stop(t+this.toSeconds(this.envelope.release)),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",0),this._syncMethod("triggerRelease",0)),this}triggerAttackRelease(t,i,l=1){return i=this.toSeconds(i),t=this.toSeconds(t),this.triggerAttack(i,l),this.triggerRelease(i+t),this}dispose(){return super.dispose(),this.noise.dispose(),this.envelope.dispose(),this}}const gl=new Set;function vl(p){gl.add(p)}function Mu(p,t){const i=`registerProcessor("${p}", ${t})`;gl.add(i)}class yl extends rt{constructor(t){super(t),this.name="ToneAudioWorklet",this.workletOptions={},this.onprocessorerror=Ft;const i=URL.createObjectURL(new Blob([Array.from(gl).join(`
`)],{type:"text/javascript"})),l=this._audioWorkletName();this._dummyGain=this.context.createGain(),this._dummyParam=this._dummyGain.gain,this.context.addAudioWorkletModule(i).then(()=>{this.disposed||(this._worklet=this.context.createAudioWorkletNode(l,this.workletOptions),this._worklet.onprocessorerror=this.onprocessorerror.bind(this),this.onReady(this._worklet))})}dispose(){return super.dispose(),this._dummyGain.disconnect(),this._worklet&&(this._worklet.port.postMessage("dispose"),this._worklet.disconnect()),this}}vl(`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`),vl(`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`),vl(`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`);const Eu="feedback-comb-filter";Mu(Eu,`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`);class Ao extends yl{constructor(){const t=Q(Ao.getDefaults(),arguments,["delayTime","resonance"]);super(t),this.name="FeedbackCombFilter",this.input=new _t({context:this.context}),this.output=new _t({context:this.context}),this.delayTime=new Pt({context:this.context,value:t.delayTime,units:"time",minValue:0,maxValue:1,param:this._dummyParam,swappable:!0}),this.resonance=new Pt({context:this.context,value:t.resonance,units:"normalRange",param:this._dummyParam,swappable:!0}),Tt(this,["resonance","delayTime"])}_audioWorkletName(){return Eu}static getDefaults(){return Object.assign(rt.getDefaults(),{delayTime:.1,resonance:.5})}onReady(t){hs(this.input,t,this.output);const i=t.parameters.get("delayTime");this.delayTime.setParam(i);const l=t.parameters.get("feedback");this.resonance.setParam(l)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.delayTime.dispose(),this.resonance.dispose(),this}}class Mo extends rt{constructor(){const t=Q(Mo.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OnePoleFilter",this._frequency=t.frequency,this._type=t.type,this.input=new _t({context:this.context}),this.output=new _t({context:this.context}),this._createFilter()}static getDefaults(){return Object.assign(rt.getDefaults(),{frequency:880,type:"lowpass"})}_createFilter(){const t=this._filter,i=this.toFrequency(this._frequency),l=1/(2*Math.PI*i);if(this._type==="lowpass"){const d=1/(l*this.context.sampleRate),v=d-1;this._filter=this.context.createIIRFilter([d,0],[1,v])}else{const d=1/(l*this.context.sampleRate)-1;this._filter=this.context.createIIRFilter([1,-1],[1,d])}this.input.chain(this._filter,this.output),t&&this.context.setTimeout(()=>{this.disposed||(this.input.disconnect(t),t.disconnect())},this.blockTime)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._createFilter()}get type(){return this._type}set type(t){this._type=t,this._createFilter()}getFrequencyResponse(t=128){const i=new Float32Array(t);for(let v=0;v<t;v++){const y=19980*Math.pow(v/t,2)+20;i[v]=y}const l=new Float32Array(t),d=new Float32Array(t);return this._filter.getFrequencyResponse(i,l,d),l}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this._filter.disconnect(),this}}class Eo extends rt{constructor(){const t=Q(Eo.getDefaults(),arguments,["delayTime","resonance","dampening"]);super(t),this.name="LowpassCombFilter",this._combFilter=this.output=new Ao({context:this.context,delayTime:t.delayTime,resonance:t.resonance}),this.delayTime=this._combFilter.delayTime,this.resonance=this._combFilter.resonance,this._lowpass=this.input=new Mo({context:this.context,frequency:t.dampening,type:"lowpass"}),this._lowpass.connect(this._combFilter)}static getDefaults(){return Object.assign(rt.getDefaults(),{dampening:3e3,delayTime:.1,resonance:.5})}get dampening(){return this._lowpass.frequency}set dampening(t){this._lowpass.frequency=t}dispose(){return super.dispose(),this._combFilter.dispose(),this._lowpass.dispose(),this}}class bl extends Cs{constructor(){const t=Q(bl.getDefaults(),arguments);super(t),this.name="PluckSynth",this._noise=new En({context:this.context,type:"pink"}),this.attackNoise=t.attackNoise,this._lfcf=new Eo({context:this.context,dampening:t.dampening,resonance:t.resonance}),this.resonance=t.resonance,this.release=t.release,this._noise.connect(this._lfcf),this._lfcf.connect(this.output)}static getDefaults(){return xs(Cs.getDefaults(),{attackNoise:1,dampening:4e3,resonance:.7,release:1})}get dampening(){return this._lfcf.dampening}set dampening(t){this._lfcf.dampening=t}triggerAttack(t,i){const l=this.toFrequency(t);i=this.toSeconds(i);const d=1/l;return this._lfcf.delayTime.setValueAtTime(d,i),this._noise.start(i),this._noise.stop(i+d*this.attackNoise),this._lfcf.resonance.cancelScheduledValues(i),this._lfcf.resonance.setValueAtTime(this.resonance,i),this}triggerRelease(t){return this._lfcf.resonance.linearRampTo(0,this.release,t),this}dispose(){return super.dispose(),this._noise.dispose(),this._lfcf.dispose(),this}}class _l extends Cs{constructor(){const t=Q(_l.getDefaults(),arguments,["voice","options"]);super(t),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=d=>this.releaseAll(d),wt(!rs(t.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const i=t.voice.getDefaults();this.options=Object.assign(i,t.options),this.voice=t.voice,this.maxPolyphony=t.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const l=this._voices.indexOf(this._dummyVoice);this._voices.splice(l,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Cs.getDefaults(),{maxPolyphony:32,options:{},voice:Pn})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(t){this._availableVoices.push(t);const i=this._activeVoices.findIndex(l=>l.voice===t);this._activeVoices.splice(i,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const t=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return wt(t instanceof qe,"Voice must extend Monophonic class"),t.connect(this.output),this._voices.push(t),t}yi("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(.95*this._averageActiveVoices,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const t=this._availableVoices.shift(),i=this._voices.indexOf(t);this._voices.splice(i,1),this.context.isOffline||t.dispose()}}_triggerAttack(t,i,l){t.forEach(d=>{const v=new ki(this.context,d).toMidi(),y=this._getNextAvailableVoice();y&&(y.triggerAttack(d,i,l),this._activeVoices.push({midi:v,voice:y,released:!1}),this.log("triggerAttack",d,i))})}_triggerRelease(t,i){t.forEach(l=>{const d=new ki(this.context,l).toMidi(),v=this._activeVoices.find(({midi:y,released:_})=>y===d&&!_);v&&(v.voice.triggerRelease(i),v.released=!0,this.log("triggerRelease",l,i))})}_scheduleEvent(t,i,l,d){wt(!this.disposed,"Synth was already disposed"),l<=this.now()?t==="attack"?this._triggerAttack(i,l,d):this._triggerRelease(i,l):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(t,i,l,d)},l-this.now())}triggerAttack(t,i,l){Array.isArray(t)||(t=[t]);const d=this.toSeconds(i);return this._scheduleEvent("attack",t,d,l),this}triggerRelease(t,i){Array.isArray(t)||(t=[t]);const l=this.toSeconds(i);return this._scheduleEvent("release",t,l),this}triggerAttackRelease(t,i,l,d){const v=this.toSeconds(l);if(this.triggerAttack(t,v,d),Le(i)){wt(Le(t),"If the duration is an array, the notes must also be an array");for(let y=0;y<t.length;y++){const _=i[Math.min(y,i.length-1)],S=this.toSeconds(_);wt(S>0,"The duration must be greater than 0"),this.triggerRelease(t[y],v+S)}}else{const y=this.toSeconds(i);wt(y>0,"The duration must be greater than 0"),this.triggerRelease(t,v+y)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(t){const i=$e(t,["onsilence","context"]);return this.options=xs(this.options,i),this._voices.forEach(l=>l.set(i)),this._dummyVoice.set(i),this}get(){return this._dummyVoice.get()}releaseAll(t){const i=this.toSeconds(t);return this._activeVoices.forEach(({voice:l})=>{l.triggerRelease(i)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(t=>t.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class Po extends Cs{constructor(){const t=Q(Po.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(t),this.name="Sampler",this._activeSources=new Map;const i={};Object.keys(t.urls).forEach(l=>{const d=parseInt(l,10);if(wt(uo(l)||rs(d)&&isFinite(d),`url key is neither a note or midi pitch: ${l}`),uo(l)){const v=new Ue(this.context,l).toMidi();i[v]=t.urls[l]}else rs(d)&&isFinite(d)&&(i[d]=t.urls[d])}),this._buffers=new Pi({urls:i,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.attack=t.attack,this.release=t.release,this.curve=t.curve,this._buffers.loaded&&Promise.resolve().then(t.onload)}static getDefaults(){return Object.assign(Cs.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Ft,onerror:Ft,release:.1,urls:{}})}_findClosest(t){let i=0;for(;i<96;){if(this._buffers.has(t+i))return-i;if(this._buffers.has(t-i))return i;i++}throw new Error(`No available buffers for note: ${t}`)}triggerAttack(t,i,l=1){return this.log("triggerAttack",t,i,l),Array.isArray(t)||(t=[t]),t.forEach(d=>{const v=bu(new Ue(this.context,d).toFrequency()),y=Math.round(v),_=v-y,S=this._findClosest(y),C=y-S,M=this._buffers.get(C),E=Ti(S+_),D=new Mn({url:M,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:E}).connect(this.output);D.start(i,0,M.duration/E,l),Le(this._activeSources.get(y))||this._activeSources.set(y,[]),this._activeSources.get(y).push(D),D.onended=()=>{if(this._activeSources&&this._activeSources.has(y)){const R=this._activeSources.get(y),B=R.indexOf(D);B!==-1&&R.splice(B,1)}}}),this}triggerRelease(t,i){return this.log("triggerRelease",t,i),Array.isArray(t)||(t=[t]),t.forEach(l=>{const d=new Ue(this.context,l).toMidi();if(this._activeSources.has(d)&&this._activeSources.get(d).length){const v=this._activeSources.get(d);i=this.toSeconds(i),v.forEach(y=>{y.stop(i)}),this._activeSources.set(d,[])}}),this}releaseAll(t){const i=this.toSeconds(t);return this._activeSources.forEach(l=>{for(;l.length;)l.shift().stop(i)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(t,i,l,d=1){const v=this.toSeconds(l);return this.triggerAttack(t,v,d),Le(i)?(wt(Le(t),"notes must be an array when duration is array"),t.forEach((y,_)=>{const S=i[Math.min(_,i.length-1)];this.triggerRelease(y,v+this.toSeconds(S))})):this.triggerRelease(t,v+this.toSeconds(i)),this}add(t,i,l){if(wt(uo(t)||isFinite(t),`note must be a pitch or midi: ${t}`),uo(t)){const d=new Ue(this.context,t).toMidi();this._buffers.add(d,i,l)}else this._buffers.add(t,i,l);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(t=>{t.forEach(i=>i.dispose())}),this._activeSources.clear(),this}}Ns([dn(0)],Po.prototype,"attack",void 0),Ns([dn(0)],Po.prototype,"release",void 0);class Gs extends Re{constructor(){const t=Q(Gs.getDefaults(),arguments,["callback","value"]);super(t),this.name="ToneEvent",this._state=new Ai("stopped"),this._startOffset=0,this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Re.getDefaults(),{callback:Ft,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,i=>{let l;if(i.state==="started"){i.id!==-1&&this.context.transport.clear(i.id);const d=i.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||rs(this._loop)&&this._loop>1){l=1/0,rs(this._loop)&&(l=this._loop*this._getLoopDuration());const v=this._state.getAfter(d);v!==null&&(l=Math.min(l,v.time-d)),l!==1/0&&(l=new ce(this.context,l));const y=new ce(this.context,this._getLoopDuration());i.id=this.context.transport.scheduleRepeat(this._tick.bind(this),y,new ce(this.context,d),l)}else i.id=this.context.transport.schedule(this._tick.bind(this),new ce(this.context,d))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const i=this.toTicks(t);return this._state.getValueAtTime(i)==="stopped"&&(this._state.add({id:-1,state:"started",time:i}),this._rescheduleEvents(i)),this}stop(t){this.cancel(t);const i=this.toTicks(t);if(this._state.getValueAtTime(i)==="started"){this._state.setStateAtTime("stopped",i,{id:-1});const l=this._state.getBefore(i);let d=i;l!==null&&(d=l.time),this._rescheduleEvents(d)}return this}cancel(t){t=Ss(t,-1/0);const i=this.toTicks(t);return this._state.forEachFrom(i,l=>{this.context.transport.clear(l.id)}),this._state.cancel(i),this}_tick(t){const i=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(i)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let l=.02;Ua(this.humanize)||(l=this.toSeconds(this.humanize)),t+=(2*Math.random()-1)*l}this.callback(t,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new ce(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new ce(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,i=this._state.get(t);if(i!==null&&i.state==="started"){const l=this._getLoopDuration();return(t-i.time)%l/l}return 0}return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class ko extends Re{constructor(){const t=Q(ko.getDefaults(),arguments,["callback","interval"]);super(t),this.name="Loop",this._event=new Gs({context:this.context,callback:this._tick.bind(this),loop:!0,loopEnd:t.interval,playbackRate:t.playbackRate,probability:t.probability,humanize:t.humanize}),this.callback=t.callback,this.iterations=t.iterations}static getDefaults(){return Object.assign(Re.getDefaults(),{interval:"4n",callback:Ft,playbackRate:1,iterations:1/0,probability:1,mute:!1,humanize:!1})}start(t){return this._event.start(t),this}stop(t){return this._event.stop(t),this}cancel(t){return this._event.cancel(t),this}_tick(t){this.callback(t)}get state(){return this._event.state}get progress(){return this._event.progress}get interval(){return this._event.loopEnd}set interval(t){this._event.loopEnd=t}get playbackRate(){return this._event.playbackRate}set playbackRate(t){this._event.playbackRate=t}get humanize(){return this._event.humanize}set humanize(t){this._event.humanize=t}get probability(){return this._event.probability}set probability(t){this._event.probability=t}get mute(){return this._event.mute}set mute(t){this._event.mute=t}get iterations(){return this._event.loop===!0?1/0:this._event.loop}set iterations(t){this._event.loop=t===1/0||t}dispose(){return super.dispose(),this._event.dispose(),this}}class Io extends Gs{constructor(){const t=Q(Io.getDefaults(),arguments,["callback","events"]);super(t),this.name="Part",this._state=new Ai("stopped"),this._events=new Set,this._state.increasing=!0,t.events.forEach(i=>{Le(i)?this.add(i[0],i[1]):this.add(i)})}static getDefaults(){return Object.assign(Gs.getDefaults(),{events:[]})}start(t,i){const l=this.toTicks(t);if(this._state.getValueAtTime(l)!=="started"){i=Ss(i,this._loop?this._loopStart:0),i=this._loop?Ss(i,this._loopStart):Ss(i,0);const d=this.toTicks(i);this._state.add({id:-1,offset:d,state:"started",time:l}),this._forEach(v=>{this._startNote(v,l,d)})}return this}_startNote(t,i,l){i-=l,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<l&&(i+=this._getLoopDuration()),t.start(new ce(this.context,i))):t.startOffset<this._loopStart&&t.startOffset>=l&&(t.loop=!1,t.start(new ce(this.context,i))):t.startOffset>=l&&t.start(new ce(this.context,i))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(i=>{i.startOffset+=this._startOffset})}stop(t){const i=this.toTicks(t);return this._state.cancel(i),this._state.setStateAtTime("stopped",i),this._forEach(l=>{l.stop(t)}),this}at(t,i){const l=new _e(this.context,t).toTicks(),d=new ce(this.context,1).toSeconds(),v=this._events.values();let y=v.next();for(;!y.done;){const _=y.value;if(Math.abs(l-_.startOffset)<d)return Ot(i)&&(_.value=i),_;y=v.next()}return Ot(i)?(this.add(t,i),this.at(t)):null}add(t,i){t instanceof Object&&Reflect.has(t,"time")&&(t=(i=t).time);const l=this.toTicks(t);let d;return i instanceof Gs?(d=i,d.callback=this._tick.bind(this)):d=new Gs({callback:this._tick.bind(this),context:this.context,value:i}),d.startOffset=l,d.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(d),this._restartEvent(d),this}_restartEvent(t){this._state.forEach(i=>{i.state==="started"?this._startNote(t,i.time,i.offset):t.stop(new ce(this.context,i.time))})}remove(t,i){return rn(t)&&t.hasOwnProperty("time")&&(t=(i=t).time),t=this.toTicks(t),this._events.forEach(l=>{l.startOffset===t&&(ts(i)||Ot(i)&&l.value===i)&&(this._events.delete(l),l.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(i=>i.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(i=>{i instanceof Io?i._forEach(t):t(i)}),this}_setAll(t,i){this._forEach(l=>{l[t]=i})}_tick(t,i){this.mute||this.callback(t,i)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(i=>{i.loopStart=this.loopStart,i.loopEnd=this.loopEnd,i.loop=t,this._testLoopBoundries(i)})}get loopEnd(){return new ce(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(i=>{i.loopEnd=t,this._testLoopBoundries(i)})}get loopStart(){return new ce(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(i=>{i.loopStart=this.loopStart,this._testLoopBoundries(i)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}function*og(p){let t=0;for(;t<p;)t=Vn(t,0,p-1),yield t,t++}function*rg(p){let t=p-1;for(;t>=0;)t=Vn(t,0,p-1),yield t,t--}function*Do(p,t){for(;;)yield*t(p)}function*Pu(p,t){let i=t?0:p-1;for(;;)i=Vn(i,0,p-1),yield i,t?(i++,i>=p-1&&(t=!1)):(i--,i<=0&&(t=!0))}function*ag(p){let t=0,i=0;for(;t<p;)t=Vn(t,0,p-1),yield t,i++,t+=i%2?2:-1}function*lg(p){let t=p-1,i=0;for(;t>=0;)t=Vn(t,0,p-1),yield t,i++,t+=i%2?-2:1}function*cg(p){const t=[];for(let i=0;i<p;i++)t.push(i);for(;t.length>0;)yield Vn(t.splice(Math.floor(t.length*Math.random()),1)[0],0,p-1)}function*ku(p,t="up",i=0){switch(wt(p>=1,"The number of values must be at least one"),t){case"up":yield*Do(p,og);case"down":yield*Do(p,rg);case"upDown":yield*Pu(p,!0);case"downUp":yield*Pu(p,!1);case"alternateUp":yield*Do(p,ag);case"alternateDown":yield*Do(p,lg);case"random":yield*function*(l){for(;;)yield Math.floor(Math.random()*l)}(p);case"randomOnce":yield*Do(p,cg);case"randomWalk":yield*function*(l){let d=Math.floor(Math.random()*l);for(;;)d===0?d++:d===l-1||Math.random()<.5?d--:d++,yield d}(p)}}class wl extends ko{constructor(){const t=Q(wl.getDefaults(),arguments,["callback","values","pattern"]);super(t),this.name="Pattern",this.callback=t.callback,this._values=t.values,this._pattern=ku(t.values.length,t.pattern),this._type=t.pattern}static getDefaults(){return Object.assign(ko.getDefaults(),{pattern:"up",values:[],callback:Ft})}_tick(t){const i=this._pattern.next();this._index=i.value,this._value=this._values[i.value],this.callback(t,this._value)}get values(){return this._values}set values(t){this._values=t,this.pattern=this._type}get value(){return this._value}get index(){return this._index}get pattern(){return this._type}set pattern(t){this._type=t,this._pattern=ku(this._values.length,this._type)}}class xl extends Gs{constructor(){const t=Q(xl.getDefaults(),arguments,["callback","events","subdivision"]);super(t),this.name="Sequence",this._part=new Io({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[],this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign($e(Gs.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,i){i===null||this.mute||this.callback(t,i)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,i){return this._part.start(t,i&&this._indexTime(i)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new ce(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(i,l)=>i[l],set:(i,l,d)=>(Os(l)&&isFinite(parseInt(l,10))&&Le(d)?i[l]=this._createSequence(d):i[l]=d,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,i,l){t.forEach((d,v)=>{const y=v*i+l;if(Le(d))this._rescheduleSequence(d,i/d.length,y);else{const _=new ce(this.context,y,"i").toSeconds();this._part.add(_,d)}})}_indexTime(t){return new ce(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this._part.loopEnd=t===0?this._indexTime(this._eventsArray.length):this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}class Fi extends rt{constructor(){const t=Q(Fi.getDefaults(),arguments,["fade"]);super(t),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new Tu({context:this.context}),this.a=new _t({context:this.context,gain:0}),this.b=new _t({context:this.context,gain:0}),this.output=new _t({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new Mt({context:this.context,units:"normalRange",value:t.fade}),Tt(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",Xe(this._split,this.a.gain,0),Xe(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(rt.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class Ae extends rt{constructor(t){super(t),this.name="Effect",this._dryWet=new Fi({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new _t({context:this.context}),this.effectReturn=new _t({context:this.context}),this.input=new _t({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(t.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],Tt(this,"wet")}static getDefaults(){return Object.assign(rt.getDefaults(),{wet:1})}connectEffect(t){return this._internalChannels.push(t),this.effectSend.chain(t,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class Wr extends Ae{constructor(t){super(t),this.name="LFOEffect",this._lfo=new Ye({context:this.context,frequency:t.frequency,amplitude:t.depth}),this.depth=this._lfo.amplitude,this.frequency=this._lfo.frequency,this.type=t.type,Tt(this,["frequency","depth"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{frequency:1,type:"sine",depth:1})}start(t){return this._lfo.start(t),this}stop(t){return this._lfo.stop(t),this}sync(){return this._lfo.sync(),this}unsync(){return this._lfo.unsync(),this}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Sl extends Wr{constructor(){const t=Q(Sl.getDefaults(),arguments,["frequency","baseFrequency","octaves"]);super(t),this.name="AutoFilter",this.filter=new ps(Object.assign(t.filter,{context:this.context})),this.connectEffect(this.filter),this._lfo.connect(this.filter.frequency),this.octaves=t.octaves,this.baseFrequency=t.baseFrequency}static getDefaults(){return Object.assign(Wr.getDefaults(),{baseFrequency:200,octaves:2.6,filter:{type:"lowpass",rolloff:-12,Q:1}})}get baseFrequency(){return this._lfo.min}set baseFrequency(t){this._lfo.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._lfo.max=this._lfo.min*Math.pow(2,t)}dispose(){return super.dispose(),this.filter.dispose(),this}}class Ro extends rt{constructor(){const t=Q(Ro.getDefaults(),arguments,["pan"]);super(t),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Pt({context:this.context,param:this._panner.pan,value:t.pan,minValue:-1,maxValue:1}),this._panner.channelCount=t.channelCount,this._panner.channelCountMode="explicit",Tt(this,"pan")}static getDefaults(){return Object.assign(rt.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}class Cl extends Wr{constructor(){const t=Q(Cl.getDefaults(),arguments,["frequency"]);super(t),this.name="AutoPanner",this._panner=new Ro({context:this.context,channelCount:t.channelCount}),this.connectEffect(this._panner),this._lfo.connect(this._panner.pan),this._lfo.min=-1,this._lfo.max=1}static getDefaults(){return Object.assign(Wr.getDefaults(),{channelCount:1})}dispose(){return super.dispose(),this._panner.dispose(),this}}class Oo extends rt{constructor(){const t=Q(Oo.getDefaults(),arguments,["smoothing"]);super(t),this.name="Follower",this._abs=this.input=new Cu({context:this.context}),this._lowpass=this.output=new Mo({context:this.context,frequency:1/this.toSeconds(t.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=t.smoothing}static getDefaults(){return Object.assign(rt.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class Tl extends Ae{constructor(){const t=Q(Tl.getDefaults(),arguments,["baseFrequency","octaves","sensitivity"]);super(t),this.name="AutoWah",this._follower=new Oo({context:this.context,smoothing:t.follower}),this._sweepRange=new qr({context:this.context,min:0,max:1,exponent:.5}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this._inputBoost=new _t({context:this.context}),this._bandpass=new ps({context:this.context,rolloff:-48,frequency:0,Q:t.Q}),this._peaking=new ps({context:this.context,type:"peaking"}),this._peaking.gain.value=t.gain,this.gain=this._peaking.gain,this.Q=this._bandpass.Q,this.effectSend.chain(this._inputBoost,this._follower,this._sweepRange),this._sweepRange.connect(this._bandpass.frequency),this._sweepRange.connect(this._peaking.frequency),this.effectSend.chain(this._bandpass,this._peaking,this.effectReturn),this._setSweepRange(),this.sensitivity=t.sensitivity,Tt(this,["gain","Q"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{baseFrequency:100,octaves:6,sensitivity:0,Q:2,gain:2,follower:.2})}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._setSweepRange()}get follower(){return this._follower.smoothing}set follower(t){this._follower.smoothing=t}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._setSweepRange()}get sensitivity(){return fo(1/this._inputBoost.gain.value)}set sensitivity(t){this._inputBoost.gain.value=1/Ci(t)}_setSweepRange(){this._sweepRange.min=this._baseFrequency,this._sweepRange.max=Math.min(this._baseFrequency*Math.pow(2,this._octaves),this.context.sampleRate/2)}dispose(){return super.dispose(),this._follower.dispose(),this._sweepRange.dispose(),this._bandpass.dispose(),this._peaking.dispose(),this._inputBoost.dispose(),this}}const Iu="bit-crusher";Mu(Iu,`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`);class Al extends Ae{constructor(){const t=Q(Al.getDefaults(),arguments,["bits"]);super(t),this.name="BitCrusher",this._bitCrusherWorklet=new Ml({context:this.context,bits:t.bits}),this.connectEffect(this._bitCrusherWorklet),this.bits=this._bitCrusherWorklet.bits}static getDefaults(){return Object.assign(Ae.getDefaults(),{bits:4})}dispose(){return super.dispose(),this._bitCrusherWorklet.dispose(),this}}class Ml extends yl{constructor(){const t=Q(Ml.getDefaults(),arguments);super(t),this.name="BitCrusherWorklet",this.input=new _t({context:this.context}),this.output=new _t({context:this.context}),this.bits=new Pt({context:this.context,value:t.bits,units:"positive",minValue:1,maxValue:16,param:this._dummyParam,swappable:!0})}static getDefaults(){return Object.assign(yl.getDefaults(),{bits:12})}_audioWorkletName(){return Iu}onReady(t){hs(this.input,t,this.output);const i=t.parameters.get("bits");this.bits.setParam(i)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.bits.dispose(),this}}class El extends Ae{constructor(){const t=Q(El.getDefaults(),arguments,["order"]);super(t),this.name="Chebyshev",this._shaper=new Fs({context:this.context,length:4096}),this._order=t.order,this.connectEffect(this._shaper),this.order=t.order,this.oversample=t.oversample}static getDefaults(){return Object.assign(Ae.getDefaults(),{order:1,oversample:"none"})}_getCoefficient(t,i,l){return l.has(i)||(i===0?l.set(i,0):i===1?l.set(i,t):l.set(i,2*t*this._getCoefficient(t,i-1,l)-this._getCoefficient(t,i-2,l))),l.get(i)}get order(){return this._order}set order(t){wt(Number.isInteger(t),"'order' must be an integer"),this._order=t,this._shaper.setMap(i=>this._getCoefficient(i,t,new Map))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Xn extends rt{constructor(){const t=Q(Xn.getDefaults(),arguments,["channels"]);super(t),this.name="Split",this._splitter=this.input=this.output=this.context.createChannelSplitter(t.channels),this._internalChannels=[this._splitter]}static getDefaults(){return Object.assign(rt.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._splitter.disconnect(),this}}class kn extends rt{constructor(){const t=Q(kn.getDefaults(),arguments,["channels"]);super(t),this.name="Merge",this._merger=this.output=this.input=this.context.createChannelMerger(t.channels)}static getDefaults(){return Object.assign(rt.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._merger.disconnect(),this}}class js extends rt{constructor(t){super(t),this.name="StereoEffect",this.input=new _t({context:this.context}),this.input.channelCount=2,this.input.channelCountMode="explicit",this._dryWet=this.output=new Fi({context:this.context,fade:t.wet}),this.wet=this._dryWet.fade,this._split=new Xn({context:this.context,channels:2}),this._merge=new kn({context:this.context,channels:2}),this.input.connect(this._split),this.input.connect(this._dryWet.a),this._merge.connect(this._dryWet.b),Tt(this,["wet"])}connectEffectLeft(...t){this._split.connect(t[0],0,0),hs(...t),Xe(t[t.length-1],this._merge,0,0)}connectEffectRight(...t){this._split.connect(t[0],1,0),hs(...t),Xe(t[t.length-1],this._merge,0,1)}static getDefaults(){return Object.assign(rt.getDefaults(),{wet:1})}dispose(){return super.dispose(),this._dryWet.dispose(),this._split.dispose(),this._merge.dispose(),this}}class Pl extends js{constructor(t){super(t),this.feedback=new Mt({context:this.context,value:t.feedback,units:"normalRange"}),this._feedbackL=new _t({context:this.context}),this._feedbackR=new _t({context:this.context}),this._feedbackSplit=new Xn({context:this.context,channels:2}),this._feedbackMerge=new kn({context:this.context,channels:2}),this._merge.connect(this._feedbackSplit),this._feedbackMerge.connect(this._split),this._feedbackSplit.connect(this._feedbackL,0,0),this._feedbackL.connect(this._feedbackMerge,0,0),this._feedbackSplit.connect(this._feedbackR,1,0),this._feedbackR.connect(this._feedbackMerge,0,1),this.feedback.fan(this._feedbackL.gain,this._feedbackR.gain),Tt(this,["feedback"])}static getDefaults(){return Object.assign(js.getDefaults(),{feedback:.5})}dispose(){return super.dispose(),this.feedback.dispose(),this._feedbackL.dispose(),this._feedbackR.dispose(),this._feedbackSplit.dispose(),this._feedbackMerge.dispose(),this}}class kl extends Pl{constructor(){const t=Q(kl.getDefaults(),arguments,["frequency","delayTime","depth"]);super(t),this.name="Chorus",this._depth=t.depth,this._delayTime=t.delayTime/1e3,this._lfoL=new Ye({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new Ye({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._delayNodeL=new us({context:this.context}),this._delayNodeR=new us({context:this.context}),this.frequency=this._lfoL.frequency,Tt(this,["frequency"]),this._lfoL.frequency.connect(this._lfoR.frequency),this.connectEffectLeft(this._delayNodeL),this.connectEffectRight(this._delayNodeR),this._lfoL.connect(this._delayNodeL.delayTime),this._lfoR.connect(this._delayNodeR.delayTime),this.depth=this._depth,this.type=t.type,this.spread=t.spread}static getDefaults(){return Object.assign(Pl.getDefaults(),{frequency:1.5,delayTime:3.5,depth:.7,type:"sine",spread:180,feedback:0,wet:.5})}get depth(){return this._depth}set depth(t){this._depth=t;const i=this._delayTime*t;this._lfoL.min=Math.max(this._delayTime-i,0),this._lfoL.max=this._delayTime+i,this._lfoR.min=Math.max(this._delayTime-i,0),this._lfoR.max=this._delayTime+i}get delayTime(){return 1e3*this._delayTime}set delayTime(t){this._delayTime=t/1e3,this.depth=this._depth}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._delayNodeL.dispose(),this._delayNodeR.dispose(),this.frequency.dispose(),this}}class Il extends Ae{constructor(){const t=Q(Il.getDefaults(),arguments,["distortion"]);super(t),this.name="Distortion",this._shaper=new Fs({context:this.context,length:4096}),this._distortion=t.distortion,this.connectEffect(this._shaper),this.distortion=t.distortion,this.oversample=t.oversample}static getDefaults(){return Object.assign(Ae.getDefaults(),{distortion:.4,oversample:"none"})}get distortion(){return this._distortion}set distortion(t){this._distortion=t;const i=100*t,l=Math.PI/180;this._shaper.setMap(d=>Math.abs(d)<.001?0:(3+i)*d*20*l/(Math.PI+i*Math.abs(d)))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Vr extends Ae{constructor(t){super(t),this.name="FeedbackEffect",this._feedbackGain=new _t({context:this.context,gain:t.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,Tt(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(Ae.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class Dl extends Vr{constructor(){const t=Q(Dl.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="FeedbackDelay",this._delayNode=new us({context:this.context,delayTime:t.delayTime,maxDelay:t.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),Tt(this,"delayTime")}static getDefaults(){return Object.assign(Vr.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class hg extends rt{constructor(t){super(t),this.name="PhaseShiftAllpass",this.input=new _t({context:this.context}),this.output=new _t({context:this.context}),this.offset90=new _t({context:this.context}),this._bank0=this._createAllPassFilterBank([.6923878,.9360654322959,.988229522686,.9987488452737]),this._bank1=this._createAllPassFilterBank([.4021921162426,.856171088242,.9722909545651,.9952884791278]),this._oneSampleDelay=this.context.createIIRFilter([0,1],[1,0]),hs(this.input,...this._bank0,this._oneSampleDelay,this.output),hs(this.input,...this._bank1,this.offset90)}_createAllPassFilterBank(t){return t.map(i=>{const l=[[i*i,0,-1],[1,0,-i*i]];return this.context.createIIRFilter(l[0],l[1])})}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.offset90.dispose(),this._bank0.forEach(t=>t.disconnect()),this._bank1.forEach(t=>t.disconnect()),this._oneSampleDelay.disconnect(),this}}class Rl extends Ae{constructor(){const t=Q(Rl.getDefaults(),arguments,["frequency"]);super(t),this.name="FrequencyShifter",this.frequency=new Mt({context:this.context,units:"frequency",value:t.frequency,minValue:-this.context.sampleRate/2,maxValue:this.context.sampleRate/2}),this._sine=new yo({context:this.context,type:"sine"}),this._cosine=new he({context:this.context,phase:-90,type:"sine"}),this._sineMultiply=new ue({context:this.context}),this._cosineMultiply=new ue({context:this.context}),this._negate=new hl({context:this.context}),this._add=new Gn({context:this.context}),this._phaseShifter=new hg({context:this.context}),this.effectSend.connect(this._phaseShifter),this.frequency.fan(this._sine.frequency,this._cosine.frequency),this._phaseShifter.offset90.connect(this._cosineMultiply),this._cosine.connect(this._cosineMultiply.factor),this._phaseShifter.connect(this._sineMultiply),this._sine.connect(this._sineMultiply.factor),this._sineMultiply.connect(this._negate),this._cosineMultiply.connect(this._add),this._negate.connect(this._add.addend),this._add.connect(this.effectReturn);const i=this.immediate();this._sine.start(i),this._cosine.start(i)}static getDefaults(){return Object.assign(Ae.getDefaults(),{frequency:0})}dispose(){return super.dispose(),this.frequency.dispose(),this._add.dispose(),this._cosine.dispose(),this._cosineMultiply.dispose(),this._negate.dispose(),this._phaseShifter.dispose(),this._sine.dispose(),this._sineMultiply.dispose(),this}}const Du=[1557/44100,1617/44100,1491/44100,1422/44100,1277/44100,1356/44100,1188/44100,1116/44100],Ru=[225,556,441,341];class Ol extends js{constructor(){const t=Q(Ol.getDefaults(),arguments,["roomSize","dampening"]);super(t),this.name="Freeverb",this._combFilters=[],this._allpassFiltersL=[],this._allpassFiltersR=[],this.roomSize=new Mt({context:this.context,value:t.roomSize,units:"normalRange"}),this._allpassFiltersL=Ru.map(i=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=i,l}),this._allpassFiltersR=Ru.map(i=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=i,l}),this._combFilters=Du.map((i,l)=>{const d=new Eo({context:this.context,dampening:t.dampening,delayTime:i});return l<Du.length/2?this.connectEffectLeft(d,...this._allpassFiltersL):this.connectEffectRight(d,...this._allpassFiltersR),this.roomSize.connect(d.resonance),d}),Tt(this,["roomSize"])}static getDefaults(){return Object.assign(js.getDefaults(),{roomSize:.7,dampening:3e3})}get dampening(){return this._combFilters[0].dampening}set dampening(t){this._combFilters.forEach(i=>i.dampening=t)}dispose(){return super.dispose(),this._allpassFiltersL.forEach(t=>t.disconnect()),this._allpassFiltersR.forEach(t=>t.disconnect()),this._combFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this}}const Ou=[.06748,.06404,.08212,.09004],ug=[.773,.802,.753,.733],dg=[347,113,37];class Nl extends js{constructor(){const t=Q(Nl.getDefaults(),arguments,["roomSize"]);super(t),this.name="JCReverb",this._allpassFilters=[],this._feedbackCombFilters=[],this.roomSize=new Mt({context:this.context,value:t.roomSize,units:"normalRange"}),this._scaleRoomSize=new un({context:this.context,min:-.733,max:.197}),this._allpassFilters=dg.map(i=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=i,l}),this._feedbackCombFilters=Ou.map((i,l)=>{const d=new Ao({context:this.context,delayTime:i});return this._scaleRoomSize.connect(d.resonance),d.resonance.value=ug[l],l<Ou.length/2?this.connectEffectLeft(...this._allpassFilters,d):this.connectEffectRight(...this._allpassFilters,d),d}),this.roomSize.connect(this._scaleRoomSize),Tt(this,["roomSize"])}static getDefaults(){return Object.assign(js.getDefaults(),{roomSize:.5})}dispose(){return super.dispose(),this._allpassFilters.forEach(t=>t.disconnect()),this._feedbackCombFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this._scaleRoomSize.dispose(),this}}class Nu extends Pl{constructor(t){super(t),this._feedbackL.disconnect(),this._feedbackL.connect(this._feedbackMerge,0,1),this._feedbackR.disconnect(),this._feedbackR.connect(this._feedbackMerge,0,0),Tt(this,["feedback"])}}class Ll extends Nu{constructor(){const t=Q(Ll.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="PingPongDelay",this._leftDelay=new us({context:this.context,maxDelay:t.maxDelay}),this._rightDelay=new us({context:this.context,maxDelay:t.maxDelay}),this._rightPreDelay=new us({context:this.context,maxDelay:t.maxDelay}),this.delayTime=new Mt({context:this.context,units:"time",value:t.delayTime}),this.connectEffectLeft(this._leftDelay),this.connectEffectRight(this._rightPreDelay,this._rightDelay),this.delayTime.fan(this._leftDelay.delayTime,this._rightDelay.delayTime,this._rightPreDelay.delayTime),this._feedbackL.disconnect(),this._feedbackL.connect(this._rightDelay),Tt(this,["delayTime"])}static getDefaults(){return Object.assign(Nu.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._leftDelay.dispose(),this._rightDelay.dispose(),this._rightPreDelay.dispose(),this.delayTime.dispose(),this}}class Fl extends Vr{constructor(){const t=Q(Fl.getDefaults(),arguments,["pitch"]);super(t),this.name="PitchShift",this._frequency=new Mt({context:this.context}),this._delayA=new us({maxDelay:1,context:this.context}),this._lfoA=new Ye({context:this.context,min:0,max:.1,type:"sawtooth"}).connect(this._delayA.delayTime),this._delayB=new us({maxDelay:1,context:this.context}),this._lfoB=new Ye({context:this.context,min:0,max:.1,type:"sawtooth",phase:180}).connect(this._delayB.delayTime),this._crossFade=new Fi({context:this.context}),this._crossFadeLFO=new Ye({context:this.context,min:0,max:1,type:"triangle",phase:90}).connect(this._crossFade.fade),this._feedbackDelay=new us({delayTime:t.delayTime,context:this.context}),this.delayTime=this._feedbackDelay.delayTime,Tt(this,"delayTime"),this._pitch=t.pitch,this._windowSize=t.windowSize,this._delayA.connect(this._crossFade.a),this._delayB.connect(this._crossFade.b),this._frequency.fan(this._lfoA.frequency,this._lfoB.frequency,this._crossFadeLFO.frequency),this.effectSend.fan(this._delayA,this._delayB),this._crossFade.chain(this._feedbackDelay,this.effectReturn);const i=this.now();this._lfoA.start(i),this._lfoB.start(i),this._crossFadeLFO.start(i),this.windowSize=this._windowSize}static getDefaults(){return Object.assign(Vr.getDefaults(),{pitch:0,windowSize:.1,delayTime:0,feedback:0})}get pitch(){return this._pitch}set pitch(t){this._pitch=t;let i=0;t<0?(this._lfoA.min=0,this._lfoA.max=this._windowSize,this._lfoB.min=0,this._lfoB.max=this._windowSize,i=Ti(t-1)+1):(this._lfoA.min=this._windowSize,this._lfoA.max=0,this._lfoB.min=this._windowSize,this._lfoB.max=0,i=Ti(t)-1),this._frequency.value=i*(1.2/this._windowSize)}get windowSize(){return this._windowSize}set windowSize(t){this._windowSize=this.toSeconds(t),this.pitch=this._pitch}dispose(){return super.dispose(),this._frequency.dispose(),this._delayA.dispose(),this._delayB.dispose(),this._lfoA.dispose(),this._lfoB.dispose(),this._crossFade.dispose(),this._crossFadeLFO.dispose(),this._feedbackDelay.dispose(),this}}class $l extends js{constructor(){const t=Q($l.getDefaults(),arguments,["frequency","octaves","baseFrequency"]);super(t),this.name="Phaser",this._lfoL=new Ye({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new Ye({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this.Q=new Mt({context:this.context,value:t.Q,units:"positive"}),this._filtersL=this._makeFilters(t.stages,this._lfoL),this._filtersR=this._makeFilters(t.stages,this._lfoR),this.frequency=this._lfoL.frequency,this.frequency.value=t.frequency,this.connectEffectLeft(...this._filtersL),this.connectEffectRight(...this._filtersR),this._lfoL.frequency.connect(this._lfoR.frequency),this.baseFrequency=t.baseFrequency,this.octaves=t.octaves,this._lfoL.start(),this._lfoR.start(),Tt(this,["frequency","Q"])}static getDefaults(){return Object.assign(js.getDefaults(),{frequency:.5,octaves:3,stages:10,Q:10,baseFrequency:350})}_makeFilters(t,i){const l=[];for(let d=0;d<t;d++){const v=this.context.createBiquadFilter();v.type="allpass",this.Q.connect(v.Q),i.connect(v.frequency),l.push(v)}return l}get octaves(){return this._octaves}set octaves(t){this._octaves=t;const i=this._baseFrequency*Math.pow(2,t);this._lfoL.max=i,this._lfoR.max=i}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._lfoL.min=this._baseFrequency,this._lfoR.min=this._baseFrequency,this.octaves=this._octaves}dispose(){return super.dispose(),this.Q.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._filtersL.forEach(t=>t.disconnect()),this._filtersR.forEach(t=>t.disconnect()),this.frequency.dispose(),this}}class Bl extends Ae{constructor(){const t=Q(Bl.getDefaults(),arguments,["decay"]);super(t),this.name="Reverb",this._convolver=this.context.createConvolver(),this.ready=Promise.resolve(),this._decay=t.decay,this._preDelay=t.preDelay,this.generate(),this.connectEffect(this._convolver)}static getDefaults(){return Object.assign(Ae.getDefaults(),{decay:1.5,preDelay:.01})}get decay(){return this._decay}set decay(t){Fe(t=this.toSeconds(t),.001),this._decay=t,this.generate()}get preDelay(){return this._preDelay}set preDelay(t){Fe(t=this.toSeconds(t),0),this._preDelay=t,this.generate()}generate(){return Kt(this,void 0,void 0,function*(){const t=this.ready,i=new Si(2,this._decay+this._preDelay,this.context.sampleRate),l=new En({context:i}),d=new En({context:i}),v=new kn({context:i});l.connect(v,0,0),d.connect(v,0,1);const y=new _t({context:i}).toDestination();v.connect(y),l.start(0),d.start(0),y.gain.setValueAtTime(0,0),y.gain.setValueAtTime(1,this._preDelay),y.gain.exponentialApproachValueAtTime(0,this._preDelay,this.decay);const _=i.render();return this.ready=_.then(Ft),yield t,this._convolver.buffer=(yield _).get(),this})}dispose(){return super.dispose(),this._convolver.disconnect(),this}}class No extends rt{constructor(){super(Q(No.getDefaults(),arguments)),this.name="MidSideSplit",this._split=this.input=new Xn({channels:2,context:this.context}),this._midAdd=new Gn({context:this.context}),this.mid=new ue({context:this.context,value:Math.SQRT1_2}),this._sideSubtract=new jn({context:this.context}),this.side=new ue({context:this.context,value:Math.SQRT1_2}),this._split.connect(this._midAdd,0),this._split.connect(this._midAdd.addend,1),this._split.connect(this._sideSubtract,0),this._split.connect(this._sideSubtract.subtrahend,1),this._midAdd.connect(this.mid),this._sideSubtract.connect(this.side)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midAdd.dispose(),this._sideSubtract.dispose(),this._split.dispose(),this}}class Lo extends rt{constructor(){super(Q(Lo.getDefaults(),arguments)),this.name="MidSideMerge",this.mid=new _t({context:this.context}),this.side=new _t({context:this.context}),this._left=new Gn({context:this.context}),this._leftMult=new ue({context:this.context,value:Math.SQRT1_2}),this._right=new jn({context:this.context}),this._rightMult=new ue({context:this.context,value:Math.SQRT1_2}),this._merge=this.output=new kn({context:this.context}),this.mid.fan(this._left),this.side.connect(this._left.addend),this.mid.connect(this._right),this.side.connect(this._right.subtrahend),this._left.connect(this._leftMult),this._right.connect(this._rightMult),this._leftMult.connect(this._merge,0,0),this._rightMult.connect(this._merge,0,1)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._leftMult.dispose(),this._rightMult.dispose(),this._left.dispose(),this._right.dispose(),this}}class Lu extends Ae{constructor(t){super(t),this.name="MidSideEffect",this._midSideMerge=new Lo({context:this.context}),this._midSideSplit=new No({context:this.context}),this._midSend=this._midSideSplit.mid,this._sideSend=this._midSideSplit.side,this._midReturn=this._midSideMerge.mid,this._sideReturn=this._midSideMerge.side,this.effectSend.connect(this._midSideSplit),this._midSideMerge.connect(this.effectReturn)}connectEffectMid(...t){this._midSend.chain(...t,this._midReturn)}connectEffectSide(...t){this._sideSend.chain(...t,this._sideReturn)}dispose(){return super.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this._midSend.dispose(),this._sideSend.dispose(),this._midReturn.dispose(),this._sideReturn.dispose(),this}}class ql extends Lu{constructor(){const t=Q(ql.getDefaults(),arguments,["width"]);super(t),this.name="StereoWidener",this.width=new Mt({context:this.context,value:t.width,units:"normalRange"}),Tt(this,["width"]),this._twoTimesWidthMid=new ue({context:this.context,value:2}),this._twoTimesWidthSide=new ue({context:this.context,value:2}),this._midMult=new ue({context:this.context}),this._twoTimesWidthMid.connect(this._midMult.factor),this.connectEffectMid(this._midMult),this._oneMinusWidth=new jn({context:this.context}),this._oneMinusWidth.connect(this._twoTimesWidthMid),Xe(this.context.getConstant(1),this._oneMinusWidth),this.width.connect(this._oneMinusWidth.subtrahend),this._sideMult=new ue({context:this.context}),this.width.connect(this._twoTimesWidthSide),this._twoTimesWidthSide.connect(this._sideMult.factor),this.connectEffectSide(this._sideMult)}static getDefaults(){return Object.assign(Lu.getDefaults(),{width:.5})}dispose(){return super.dispose(),this.width.dispose(),this._midMult.dispose(),this._sideMult.dispose(),this._twoTimesWidthMid.dispose(),this._twoTimesWidthSide.dispose(),this._oneMinusWidth.dispose(),this}}class zl extends js{constructor(){const t=Q(zl.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Tremolo",this._lfoL=new Ye({context:this.context,type:t.type,min:1,max:0}),this._lfoR=new Ye({context:this.context,type:t.type,min:1,max:0}),this._amplitudeL=new _t({context:this.context}),this._amplitudeR=new _t({context:this.context}),this.frequency=new Mt({context:this.context,value:t.frequency,units:"frequency"}),this.depth=new Mt({context:this.context,value:t.depth,units:"normalRange"}),Tt(this,["frequency","depth"]),this.connectEffectLeft(this._amplitudeL),this.connectEffectRight(this._amplitudeR),this._lfoL.connect(this._amplitudeL.gain),this._lfoR.connect(this._amplitudeR.gain),this.frequency.fan(this._lfoL.frequency,this._lfoR.frequency),this.depth.fan(this._lfoR.amplitude,this._lfoL.amplitude),this.spread=t.spread}static getDefaults(){return Object.assign(js.getDefaults(),{frequency:10,type:"sine",depth:.5,spread:180})}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this.context.transport.syncSignal(this.frequency),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this.context.transport.unsyncSignal(this.frequency),this}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._amplitudeL.dispose(),this._amplitudeR.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Wl extends Ae{constructor(){const t=Q(Wl.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Vibrato",this._delayNode=new us({context:this.context,delayTime:0,maxDelay:t.maxDelay}),this._lfo=new Ye({context:this.context,type:t.type,min:0,max:t.maxDelay,frequency:t.frequency,phase:-90}).start().connect(this._delayNode.delayTime),this.frequency=this._lfo.frequency,this.depth=this._lfo.amplitude,this.depth.value=t.depth,Tt(this,["frequency","depth"]),this.effectSend.chain(this._delayNode,this.effectReturn)}static getDefaults(){return Object.assign(Ae.getDefaults(),{maxDelay:.005,frequency:5,depth:.1,type:"sine"})}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._delayNode.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Fo extends rt{constructor(){const t=Q(Fo.getDefaults(),arguments,["type","size"]);super(t),this.name="Analyser",this._analysers=[],this._buffers=[],this.input=this.output=this._gain=new _t({context:this.context}),this._split=new Xn({context:this.context,channels:t.channels}),this.input.connect(this._split),Fe(t.channels,1);for(let i=0;i<t.channels;i++)this._analysers[i]=this.context.createAnalyser(),this._split.connect(this._analysers[i],i,0);this.size=t.size,this.type=t.type,this.smoothing=t.smoothing}static getDefaults(){return Object.assign(rt.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach((t,i)=>{const l=this._buffers[i];this._type==="fft"?t.getFloatFrequencyData(l):this._type==="waveform"&&t.getFloatTimeDomainData(l)}),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(t){this._analysers.forEach((i,l)=>{i.fftSize=2*t,this._buffers[l]=new Float32Array(t)})}get channels(){return this._analysers.length}get type(){return this._type}set type(t){wt(t==="waveform"||t==="fft",`Analyser: invalid type: ${t}`),this._type=t}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(t){this._analysers.forEach(i=>i.smoothingTimeConstant=t)}dispose(){return super.dispose(),this._analysers.forEach(t=>t.disconnect()),this._split.dispose(),this._gain.dispose(),this}}class In extends rt{constructor(){super(Q(In.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new Fo({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class Vl extends In{constructor(){const t=Q(Vl.getDefaults(),arguments,["smoothing"]);super(t),this.name="Meter",this.input=this.output=this._analyser=new Fo({context:this.context,size:256,type:"waveform",channels:t.channelCount}),this.smoothing=t.smoothing,this.normalRange=t.normalRange,this._rms=new Array(t.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(In.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return yi("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),i=(this.channels===1?[t]:t).map((l,d)=>{const v=l.reduce((_,S)=>_+S*S,0),y=Math.sqrt(v/l.length);return this._rms[d]=Math.max(y,this._rms[d]*this.smoothing),this.normalRange?this._rms[d]:fo(this._rms[d])});return this.channels===1?i[0]:i}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class Hl extends In{constructor(){const t=Q(Hl.getDefaults(),arguments,["size"]);super(t),this.name="FFT",this.normalRange=t.normalRange,this._analyser.type="fft",this.size=t.size}static getDefaults(){return Object.assign(rt.getDefaults(),{normalRange:!1,size:1024,smoothing:.8})}getValue(){return this._analyser.getValue().map(t=>this.normalRange?Ci(t):t)}get size(){return this._analyser.size}set size(t){this._analyser.size=t}get smoothing(){return this._analyser.smoothing}set smoothing(t){this._analyser.smoothing=t}getFrequencyOfIndex(t){return wt(0<=t&&t<this.size,`index must be greater than or equal to 0 and less than ${this.size}`),t*this.context.sampleRate/(2*this.size)}}class Gl extends In{constructor(){super(Q(Gl.getDefaults(),arguments)),this.name="DCMeter",this._analyser.type="waveform",this._analyser.size=256}getValue(){return this._analyser.getValue()[0]}}class jl extends In{constructor(){const t=Q(jl.getDefaults(),arguments,["size"]);super(t),this.name="Waveform",this._analyser.type="waveform",this.size=t.size}static getDefaults(){return Object.assign(In.getDefaults(),{size:1024})}getValue(){return this._analyser.getValue()}get size(){return this._analyser.size}set size(t){this._analyser.size=t}}class ye extends rt{constructor(){const t=Q(ye.getDefaults(),arguments,["solo"]);super(t),this.name="Solo",this.input=this.output=new _t({context:this.context}),ye._allSolos.has(this.context)||ye._allSolos.set(this.context,new Set),ye._allSolos.get(this.context).add(this),this.solo=t.solo}static getDefaults(){return Object.assign(rt.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(t){t?this._addSolo():this._removeSolo(),ye._allSolos.get(this.context).forEach(i=>i._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){ye._soloed.has(this.context)||ye._soloed.set(this.context,new Set),ye._soloed.get(this.context).add(this)}_removeSolo(){ye._soloed.has(this.context)&&ye._soloed.get(this.context).delete(this)}_isSoloed(){return ye._soloed.has(this.context)&&ye._soloed.get(this.context).has(this)}_noSolos(){return!ye._soloed.has(this.context)||ye._soloed.has(this.context)&&ye._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),ye._allSolos.get(this.context).delete(this),this._removeSolo(),this}}ye._allSolos=new Map,ye._soloed=new Map;class Hr extends rt{constructor(){const t=Q(Hr.getDefaults(),arguments,["pan","volume"]);super(t),this.name="PanVol",this._panner=this.input=new Ro({context:this.context,pan:t.pan,channelCount:t.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new ln({context:this.context,volume:t.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=t.mute,Tt(this,["pan","volume"])}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class Yn extends rt{constructor(){const t=Q(Yn.getDefaults(),arguments,["volume","pan"]);super(t),this.name="Channel",this._solo=this.input=new ye({solo:t.solo,context:this.context}),this._panVol=this.output=new Hr({context:this.context,pan:t.pan,volume:t.volume,mute:t.mute,channelCount:t.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Tt(this,["pan","volume"])}static getDefaults(){return Object.assign(rt.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(t){this._solo.solo=t}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(t){this._panVol.mute=t}_getBus(t){return Yn.buses.has(t)||Yn.buses.set(t,new _t({context:this.context})),Yn.buses.get(t)}send(t,i=0){const l=this._getBus(t),d=new _t({context:this.context,units:"decibels",gain:i});return this.connect(d),d.connect(l),d}receive(t){return this._getBus(t).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}Yn.buses=new Map;class Ul extends rt{constructor(){super(Q(Ul.getDefaults(),arguments)),this.name="Mono",this.input=new _t({context:this.context}),this._merge=this.output=new kn({channels:2,context:this.context}),this.input.connect(this._merge,0,0),this.input.connect(this._merge,0,1)}dispose(){return super.dispose(),this._merge.dispose(),this.input.dispose(),this}}class $o extends rt{constructor(){const t=Q($o.getDefaults(),arguments,["lowFrequency","highFrequency"]);super(t),this.name="MultibandSplit",this.input=new _t({context:this.context}),this.output=void 0,this.low=new ps({context:this.context,frequency:0,type:"lowpass"}),this._lowMidFilter=new ps({context:this.context,frequency:0,type:"highpass"}),this.mid=new ps({context:this.context,frequency:0,type:"lowpass"}),this.high=new ps({context:this.context,frequency:0,type:"highpass"}),this._internalChannels=[this.low,this.mid,this.high],this.lowFrequency=new Mt({context:this.context,units:"frequency",value:t.lowFrequency}),this.highFrequency=new Mt({context:this.context,units:"frequency",value:t.highFrequency}),this.Q=new Mt({context:this.context,units:"positive",value:t.Q}),this.input.fan(this.low,this.high),this.input.chain(this._lowMidFilter,this.mid),this.lowFrequency.fan(this.low.frequency,this._lowMidFilter.frequency),this.highFrequency.fan(this.mid.frequency,this.high.frequency),this.Q.connect(this.low.Q),this.Q.connect(this._lowMidFilter.Q),this.Q.connect(this.mid.Q),this.Q.connect(this.high.Q),Tt(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(rt.getDefaults(),{Q:1,highFrequency:2500,lowFrequency:400})}dispose(){return super.dispose(),po(this,["high","mid","low","highFrequency","lowFrequency"]),this.low.dispose(),this._lowMidFilter.dispose(),this.mid.dispose(),this.high.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this.Q.dispose(),this}}class Xl extends rt{constructor(){const t=Q(Xl.getDefaults(),arguments,["positionX","positionY","positionZ"]);super(t),this.name="Panner3D",this._panner=this.input=this.output=this.context.createPanner(),this.panningModel=t.panningModel,this.maxDistance=t.maxDistance,this.distanceModel=t.distanceModel,this.coneOuterGain=t.coneOuterGain,this.coneOuterAngle=t.coneOuterAngle,this.coneInnerAngle=t.coneInnerAngle,this.refDistance=t.refDistance,this.rolloffFactor=t.rolloffFactor,this.positionX=new Pt({context:this.context,param:this._panner.positionX,value:t.positionX}),this.positionY=new Pt({context:this.context,param:this._panner.positionY,value:t.positionY}),this.positionZ=new Pt({context:this.context,param:this._panner.positionZ,value:t.positionZ}),this.orientationX=new Pt({context:this.context,param:this._panner.orientationX,value:t.orientationX}),this.orientationY=new Pt({context:this.context,param:this._panner.orientationY,value:t.orientationY}),this.orientationZ=new Pt({context:this.context,param:this._panner.orientationZ,value:t.orientationZ})}static getDefaults(){return Object.assign(rt.getDefaults(),{coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:0,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1})}setPosition(t,i,l){return this.positionX.value=t,this.positionY.value=i,this.positionZ.value=l,this}setOrientation(t,i,l){return this.orientationX.value=t,this.orientationY.value=i,this.orientationZ.value=l,this}get panningModel(){return this._panner.panningModel}set panningModel(t){this._panner.panningModel=t}get refDistance(){return this._panner.refDistance}set refDistance(t){this._panner.refDistance=t}get rolloffFactor(){return this._panner.rolloffFactor}set rolloffFactor(t){this._panner.rolloffFactor=t}get distanceModel(){return this._panner.distanceModel}set distanceModel(t){this._panner.distanceModel=t}get coneInnerAngle(){return this._panner.coneInnerAngle}set coneInnerAngle(t){this._panner.coneInnerAngle=t}get coneOuterAngle(){return this._panner.coneOuterAngle}set coneOuterAngle(t){this._panner.coneOuterAngle=t}get coneOuterGain(){return this._panner.coneOuterGain}set coneOuterGain(t){this._panner.coneOuterGain=t}get maxDistance(){return this._panner.maxDistance}set maxDistance(t){this._panner.maxDistance=t}dispose(){return super.dispose(),this._panner.disconnect(),this.orientationX.dispose(),this.orientationY.dispose(),this.orientationZ.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this}}class Gr extends rt{constructor(){const t=Q(Gr.getDefaults(),arguments);super(t),this.name="Recorder",this.input=new _t({context:this.context}),wt(Gr.supported,"Media Recorder API is not available"),this._stream=this.context.createMediaStreamDestination(),this.input.connect(this._stream),this._recorder=new MediaRecorder(this._stream.stream,{mimeType:t.mimeType})}static getDefaults(){return rt.getDefaults()}get mimeType(){return this._recorder.mimeType}static get supported(){return as!==null&&Reflect.has(as,"MediaRecorder")}get state(){return this._recorder.state==="inactive"?"stopped":this._recorder.state==="paused"?"paused":"started"}start(){return Kt(this,void 0,void 0,function*(){wt(this.state!=="started","Recorder is already started");const t=new Promise(i=>{const l=()=>{this._recorder.removeEventListener("start",l,!1),i()};this._recorder.addEventListener("start",l,!1)});return this._recorder.start(),yield t})}stop(){return Kt(this,void 0,void 0,function*(){wt(this.state!=="stopped","Recorder is not started");const t=new Promise(i=>{const l=d=>{this._recorder.removeEventListener("dataavailable",l,!1),i(d.data)};this._recorder.addEventListener("dataavailable",l,!1)});return this._recorder.stop(),yield t})}pause(){return wt(this.state==="started","Recorder must be started"),this._recorder.pause(),this}dispose(){return super.dispose(),this.input.dispose(),this._stream.disconnect(),this}}class pn extends rt{constructor(){const t=Q(pn.getDefaults(),arguments,["threshold","ratio"]);super(t),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new Pt({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:t.threshold}),this.attack=new Pt({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:t.attack}),this.release=new Pt({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:t.release}),this.knee=new Pt({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:t.knee}),this.ratio=new Pt({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:t.ratio}),Tt(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(rt.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class Yl extends rt{constructor(){const t=Q(Yl.getDefaults(),arguments,["threshold","smoothing"]);super(t),this.name="Gate",this._follower=new Oo({context:this.context,smoothing:t.smoothing}),this._gt=new Br({context:this.context,value:Ci(t.threshold)}),this.input=new _t({context:this.context}),this._gate=this.output=new _t({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(rt.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return fo(this._gt.value)}set threshold(t){this._gt.value=Ci(t)}get smoothing(){return this._follower.smoothing}set smoothing(t){this._follower.smoothing=t}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}class Zl extends rt{constructor(){const t=Q(Zl.getDefaults(),arguments,["threshold"]);super(t),this.name="Limiter",this._compressor=this.input=this.output=new pn({context:this.context,ratio:20,attack:.003,release:.01,threshold:t.threshold}),this.threshold=this._compressor.threshold,Tt(this,"threshold")}static getDefaults(){return Object.assign(rt.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}class Ql extends rt{constructor(){const t=Q(Ql.getDefaults(),arguments);super(t),this.name="MidSideCompressor",this._midSideSplit=this.input=new No({context:this.context}),this._midSideMerge=this.output=new Lo({context:this.context}),this.mid=new pn(Object.assign(t.mid,{context:this.context})),this.side=new pn(Object.assign(t.side,{context:this.context})),this._midSideSplit.mid.chain(this.mid,this._midSideMerge.mid),this._midSideSplit.side.chain(this.side,this._midSideMerge.side),Tt(this,["mid","side"])}static getDefaults(){return Object.assign(rt.getDefaults(),{mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},side:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10}})}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this}}class Jl extends rt{constructor(){const t=Q(Jl.getDefaults(),arguments);super(t),this.name="MultibandCompressor",this._splitter=this.input=new $o({context:this.context,lowFrequency:t.lowFrequency,highFrequency:t.highFrequency}),this.lowFrequency=this._splitter.lowFrequency,this.highFrequency=this._splitter.highFrequency,this.output=new _t({context:this.context}),this.low=new pn(Object.assign(t.low,{context:this.context})),this.mid=new pn(Object.assign(t.mid,{context:this.context})),this.high=new pn(Object.assign(t.high,{context:this.context})),this._splitter.low.chain(this.low,this.output),this._splitter.mid.chain(this.mid,this.output),this._splitter.high.chain(this.high,this.output),Tt(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(rt.getDefaults(),{lowFrequency:250,highFrequency:2e3,low:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10},mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},high:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16}})}dispose(){return super.dispose(),this._splitter.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.output.dispose(),this}}class Kl extends rt{constructor(){const t=Q(Kl.getDefaults(),arguments,["low","mid","high"]);super(t),this.name="EQ3",this.output=new _t({context:this.context}),this._internalChannels=[],this.input=this._multibandSplit=new $o({context:this.context,highFrequency:t.highFrequency,lowFrequency:t.lowFrequency}),this._lowGain=new _t({context:this.context,gain:t.low,units:"decibels"}),this._midGain=new _t({context:this.context,gain:t.mid,units:"decibels"}),this._highGain=new _t({context:this.context,gain:t.high,units:"decibels"}),this.low=this._lowGain.gain,this.mid=this._midGain.gain,this.high=this._highGain.gain,this.Q=this._multibandSplit.Q,this.lowFrequency=this._multibandSplit.lowFrequency,this.highFrequency=this._multibandSplit.highFrequency,this._multibandSplit.low.chain(this._lowGain,this.output),this._multibandSplit.mid.chain(this._midGain,this.output),this._multibandSplit.high.chain(this._highGain,this.output),Tt(this,["low","mid","high","lowFrequency","highFrequency"]),this._internalChannels=[this._multibandSplit]}static getDefaults(){return Object.assign(rt.getDefaults(),{high:0,highFrequency:2500,low:0,lowFrequency:400,mid:0})}dispose(){return super.dispose(),po(this,["low","mid","high","lowFrequency","highFrequency"]),this._multibandSplit.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this._lowGain.dispose(),this._midGain.dispose(),this._highGain.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.Q.dispose(),this}}class tc extends rt{constructor(){const t=Q(tc.getDefaults(),arguments,["url","onload"]);super(t),this.name="Convolver",this._convolver=this.context.createConvolver(),this._buffer=new Wt(t.url,i=>{this.buffer=i,t.onload()}),this.input=new _t({context:this.context}),this.output=new _t({context:this.context}),this._buffer.loaded&&(this.buffer=this._buffer),this.normalize=t.normalize,this.input.chain(this._convolver,this.output)}static getDefaults(){return Object.assign(rt.getDefaults(),{normalize:!0,onload:Ft})}load(t){return Kt(this,void 0,void 0,function*(){this.buffer=yield this._buffer.load(t)})}get buffer(){return this._buffer.length?this._buffer:null}set buffer(t){t&&this._buffer.set(t),this._convolver.buffer&&(this.input.disconnect(),this._convolver.disconnect(),this._convolver=this.context.createConvolver(),this.input.chain(this._convolver,this.output));const i=this._buffer.get();this._convolver.buffer=i||null}get normalize(){return this._convolver.normalize}set normalize(t){this._convolver.normalize=t}dispose(){return super.dispose(),this._buffer.dispose(),this._convolver.disconnect(),this}}function pg(){return ie().now()}function mg(){return ie().immediate()}const fg=ie().transport;function gg(){return ie().transport}const vg=ie().destination,yg=ie().destination;function bg(){return ie().destination}const _g=ie().listener;function wg(){return ie().listener}const xg=ie().draw;function Sg(){return ie().draw}const Cg=ie();function Tg(){return Wt.loaded()}const Ag=Wt,Mg=Pi,Eg=Mn})(),a})())}(sa)),sa.exports}var J=Lg();const Wd=Array(19).fill(2),Vd=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],Fg=Array(16).fill(2),$g=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function Bg(){return{hasAnacrusis:!0,macrobeatGroupings:[...Wd],macrobeatBoundaryStyles:[...Vd],baseMicrobeatPx:40,modulationMarkers:[]}}const Ki=12,qg=50,zg=.52,Wg=.5,Ur=3,Xr=1,fr=30,gr=.5,Vg=3,Hg=8,Gg=.25,jg=1.25,Ug=.8,Xg=.7,Yg=.9,Zg=4,Qg=1.5,Jg=.15,Kg=.2,tv=1,Hd=1.5,ev="#CCCCCC",Gd=1,zu=3,Wu=5,sv=7,na=16,nv=0,iv=255,jd=()=>({enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass"}),ov=()=>({speed:0,span:0}),rv=()=>({speed:0,span:0}),av={"#4a90e2":{primary:"#4a90e2",light:"#63a9fd"},"#68a03f":{primary:"#68a03f",light:"#80b958"},"#d66573":{primary:"#d66573",light:"#f27e8b"},"#2d2d2d":{primary:"#2d2d2d",light:"#424242"}};function Vu(){const n=e=>{const s=new Float32Array(Ki).fill(0),o=new Float32Array(Ki).fill(0);return s[0]=1,{name:e,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},coeffs:s,phases:o,activePresetName:"sine",gain:1,filter:jd(),vibrato:ov(),tremelo:rv()}};return{timbres:{"#4a90e2":n("Blue"),"#2d2d2d":n("Black"),"#d66573":n("Red"),"#68a03f":n("Green")},colorPalette:av}}function lv(){return{isMicPaintActive:!1,isDetecting:!1,detectedPitch:{frequency:0,clarity:0,midi:0,pitchClass:0},paintHistory:[],paintSettings:{thickness:6,opacity:80,minClarity:.1,colorMode:"chromatic",playbackEnabled:!0}}}const Ud={placedNotes:[],placedChords:[],tonicSignGroups:{},stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:Vu().timbres,placedChords:[],stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[],...Bg(),...Vu(),paint:lv(),selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},activeChordId:null,activeChordIntervals:["1P","3M","5P"],isIntervalsInverted:!1,chordPositionState:0,isChordCandidateMenuOpen:!1,chordCandidateMenuPosition:{x:0,y:0},activeMacrobeatIndex:null,chordCandidates:[],gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},focusColours:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,waveformExtendedView:!1,adsrTimeAxisScale:1,adsrComponentWidth:100,isPrintPreviewActive:!1,printOptions:{topRow:0,bottomRow:87,includeDrums:!0,orientation:"landscape",colorMode:"color"}};function Hu(n){const e=JSON.parse(JSON.stringify(n));for(const s in e){const o=e[s];o.coeffs&&typeof o.coeffs=="object"&&!Array.isArray(o.coeffs)?o.coeffs=new Float32Array(Object.values(o.coeffs)):Array.isArray(o.coeffs)&&(o.coeffs=new Float32Array(o.coeffs))}return e}const cv={recordState(){this.state.history=this.state.history.slice(0,this.state.historyIndex+1);const n=JSON.parse(JSON.stringify(this.state.timbres)),e={notes:JSON.parse(JSON.stringify(this.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(this.state.tonicSignGroups)),stampPlacements:JSON.parse(JSON.stringify(this.state.stampPlacements)),tripletPlacements:JSON.parse(JSON.stringify(this.state.tripletPlacements||[])),timbres:n,annotations:this.state.annotations?JSON.parse(JSON.stringify(this.state.annotations)):[]};this.state.history.push(e),this.state.historyIndex++,this.emit("historyChanged")},undo(){var n;if(this.state.historyIndex>0){this.state.historyIndex--;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=Hu(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}},redo(){var n;if(this.state.historyIndex<this.state.history.length-1){this.state.historyIndex++;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=Hu(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}}};function th(n){return n!==null&&typeof n=="object"&&"name"in n&&typeof n.name=="string"}function eh(n){return n!==null&&typeof n=="object"&&"step"in n&&typeof n.step=="number"&&"alt"in n&&typeof n.alt=="number"&&!isNaN(n.step)&&!isNaN(n.alt)}var Xd=[0,2,4,-1,1,3,5],Yd=Xd.map(n=>Math.floor(n*7/12));function Zd(n){const{step:e,alt:s,oct:o,dir:r=1}=n,a=Xd[e]+7*s;if(o===void 0)return[r*a];const c=o-Yd[e]-4*s;return[r*a,r*c]}var hv=[3,0,4,1,5,2,6];function Qd(n){const[e,s,o]=n,r=hv[uv(e)],a=Math.floor((e+1)/7);if(s===void 0)return{step:r,alt:a,dir:o};const c=s+4*a+Yd[r];return{step:r,alt:a,oct:c,dir:o}}function uv(n){const e=(n+1)%7;return e<0?7+e:e}var Gu=(n,e)=>Array(Math.abs(e)+1).join(n),Mc=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),dv="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",pv="(AA|A|P|M|m|d|dd)([-+]?\\d+)",mv=new RegExp("^"+dv+"|"+pv+"$");function fv(n){const e=mv.exec(`${n}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var ju={};function ks(n){return typeof n=="string"?ju[n]||(ju[n]=gv(n)):eh(n)?ks(yv(n)):th(n)?ks(n.name):Mc}var Uu=[0,2,4,5,7,9,11],Jd="PMMPPMM";function gv(n){const e=fv(n);if(e[0]==="")return Mc;const s=+e[0],o=e[1],r=(Math.abs(s)-1)%7,a=Jd[r];if(a==="M"&&o==="P")return Mc;const c=a==="M"?"majorable":"perfectable",h=""+s+o,m=s<0?-1:1,f=s===8||s===-8?s:m*(r+1),g=vv(c,o),b=Math.floor((Math.abs(s)-1)/7),w=m*(Uu[r]+g+12*b),x=(m*(Uu[r]+g)%12+12)%12,A=Zd({step:r,alt:g,oct:b,dir:m});return{empty:!1,name:h,num:s,q:o,step:r,alt:g,dir:m,type:c,simple:f,semitones:w,chroma:x,coord:A,oct:b}}function Kd(n,e){const[s,o=0]=n,r=s*7+o*12<0,a=e||r?[-s,-o,-1]:[s,o,1];return ks(Qd(a))}function vv(n,e){return e==="M"&&n==="majorable"||e==="P"&&n==="perfectable"?0:e==="m"&&n==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(n==="perfectable"?e.length:e.length+1):0}function yv(n){const{step:e,alt:s,oct:o=0,dir:r}=n;if(!r)return"";const a=e+1+7*o,c=a===0?e+1:a,h=r<0?"-":"",m=Jd[e]==="M"?"majorable":"perfectable";return h+c+bv(m,s)}function bv(n,e){return e===0?n==="majorable"?"M":"P":e===-1&&n==="majorable"?"m":e>0?Gu("A",e):Gu("d",n==="perfectable"?e:e+1)}var Xu=(n,e)=>Array(Math.abs(e)+1).join(n),tp=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),Yu=new Map,_v=n=>"CDEFGAB".charAt(n),ep=n=>n<0?Xu("b",-n):Xu("#",n),sp=n=>n[0]==="b"?-n.length:n.length;function Pe(n){const e=JSON.stringify(n),s=Yu.get(e);if(s)return s;const o=typeof n=="string"?Cv(n):eh(n)?Pe(Tv(n)):th(n)?Pe(n.name):tp;return Yu.set(e,o),o}var wv=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function sh(n){const e=wv.exec(n);return e?[e[1].toUpperCase(),e[2].replace(/x/g,"##"),e[3],e[4]]:["","","",""]}function xv(n){return Pe(Qd(n))}var Sv=(n,e)=>(n%e+e)%e,ac=[0,2,4,5,7,9,11];function Cv(n){const e=sh(n);if(e[0]===""||e[3]!=="")return tp;const s=e[0],o=e[1],r=e[2],a=(s.charCodeAt(0)+3)%7,c=sp(o),h=r.length?+r:void 0,m=Zd({step:a,alt:c,oct:h}),f=s+o+r,g=s+o,b=(ac[a]+c+120)%12,w=h===void 0?Sv(ac[a]+c,12)-12*99:ac[a]+c+12*(h+1),x=w>=0&&w<=127?w:null,A=h===void 0?null:Math.pow(2,(w-69)/12)*440;return{empty:!1,acc:o,alt:c,chroma:b,coord:m,freq:A,height:w,letter:s,midi:x,name:f,oct:h,pc:g,step:a}}function Tv(n){const{step:e,alt:s,oct:o}=n,r=_v(e);if(!r)return"";const a=r+ep(s);return o||o===0?a+o:a}function Aa(n,e){const s=Pe(n),o=Array.isArray(e)?e:ks(e).coord;if(s.empty||!o||o.length<2)return"";const r=s.coord,a=r.length===1?[r[0]+o[0]]:[r[0]+o[0],r[1]+o[1]];return xv(a).name}function ga(n,e){const s=Pe(n),o=Pe(e);if(s.empty||o.empty)return"";const r=s.coord,a=o.coord,c=a[0]-r[0],h=r.length===2&&a.length===2?a[1]-r[1]:-Math.floor(c*7/12),m=o.height===s.height&&o.midi!==null&&s.oct===o.oct&&s.step>o.step;return Kd([c,h],m).name}function nh(n,e){const s=e.length,o=(n%s+s)%s;return e.slice(o,s).concat(e.slice(0,o))}function Av(n){return n.filter(e=>e===0||e)}var si={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},np=n=>Number(n).toString(2).padStart(12,"0"),Zu=n=>parseInt(n,2),Mv=/^[01]{12}$/;function ip(n){return Mv.test(n)}var Ev=n=>typeof n=="number"&&n>=0&&n<=4095,Pv=n=>n&&ip(n.chroma),Qu={[si.chroma]:si};function ih(n){const e=ip(n)?n:Ev(n)?np(n):Array.isArray(n)?Nv(n):Pv(n)?n.chroma:si.chroma;return Qu[e]=Qu[e]||Ov(e)}var kv=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function Iv(n){const e=[];for(let s=0;s<12;s++)n.charAt(s)==="1"&&e.push(kv[s]);return e}function Dv(n,e=!0){const o=ih(n).chroma.split("");return Av(o.map((r,a)=>{const c=nh(a,o);return e&&c[0]==="0"?null:c.join("")}))}function Rv(n){const e=n.split("");return e.map((s,o)=>nh(o,e).join(""))}function Ov(n){const e=Zu(n),s=Rv(n).map(Zu).filter(a=>a>=2048).sort()[0],o=np(s),r=Iv(n);return{empty:!1,name:"",setNum:e,chroma:n,normalized:o,intervals:r}}function Nv(n){if(n.length===0)return si.chroma;let e;const s=[0,0,0,0,0,0,0,0,0,0,0,0];for(let o=0;o<n.length;o++)e=Pe(n[o]),e.empty&&(e=ks(n[o])),e.empty||(s[e.chroma]=1);return s.join("")}var Lv=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],Fv=Lv,$v={...si,name:"",quality:"Unknown",intervals:[],aliases:[]},oh=[],Zo={};function Bv(n){return Zo[n]||$v}function qv(){return oh.slice()}function zv(n,e,s){const o=Vv(n),r={...ih(n),name:s||"",quality:o,intervals:n,aliases:e};oh.push(r),r.name&&(Zo[r.name]=r),Zo[r.setNum]=r,Zo[r.chroma]=r,r.aliases.forEach(a=>Wv(r,a))}function Wv(n,e){Zo[e]=n}function Vv(n){const e=s=>n.indexOf(s)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}Fv.forEach(([n,e,s])=>zv(n.split(" "),s.split(" "),e));oh.sort((n,e)=>n.setNum-e.setNum);var Hv=n=>{const e=n.reduce((s,o)=>{const r=Pe(o).chroma;return r!==void 0&&(s[r]=s[r]||Pe(o).name),s},{});return s=>e[s]};function Gv(n,e={}){const s=n.map(r=>Pe(r).pc).filter(r=>r);return Pe.length===0?[]:Jv(s,1,e).filter(r=>r.weight).sort((r,a)=>a.weight-r.weight).map(r=>r.name)}var Ma={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},Ea=n=>e=>!!(e&n),jv=Ea(Ma.anyThirds),Uv=Ea(Ma.perfectFifth),Xv=Ea(Ma.anySeventh),Yv=Ea(Ma.nonPerfectFifths);function Zv(n){const e=parseInt(n.chroma,2);return jv(e)&&Uv(e)&&Xv(e)}function Qv(n){const e=parseInt(n,2);return Yv(e)?n:(e|16).toString(2)}function Jv(n,e,s){const o=n[0],r=Pe(o).chroma,a=Hv(n),c=Dv(n,!1),h=[];return c.forEach((m,f)=>{const g=s.assumePerfectFifth&&Qv(m);qv().filter(w=>s.assumePerfectFifth&&Zv(w)?w.chroma===g:w.chroma===m).forEach(w=>{const x=w.aliases[0],A=a(f);f!==r?h.push({weight:.5*e,name:`${A}${x}/${o}`}):h.push({weight:1*e,name:`${A}${x}`})})}),h}var Kv=ks;function ty(n){const e=ks(n);if(e.empty)return"";const s=(7-e.step)%7,o=e.type==="perfectable"?-e.alt:-(e.alt+1);return ks({step:s,alt:o,oct:e.oct,dir:e.dir}).name}var lc=ga,ey=sy((n,e)=>[n[0]-e[0],n[1]-e[1]]);function sy(n){return(e,s)=>{const o=ks(e).coord,r=ks(s).coord;if(o&&r){const a=n(o,r);return Kd(a).name}}}var ny=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],iy=ny,oy={...si,intervals:[],aliases:[]},Qo={};function op(n){return Qo[n]||oy}function ry(n,e,s=[]){const o={...ih(n),name:e,intervals:n,aliases:s};return Qo[o.name]=o,Qo[o.setNum]=o,Qo[o.chroma]=o,o.aliases.forEach(r=>ay(o,r)),o}function ay(n,e){Qo[e]=n}iy.forEach(([n,e,...s])=>ry(n.split(" "),e,s));var rp={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function ap(n){const[e,s,o,r]=sh(n);return e===""?cc("",n):e==="A"&&r==="ug"?cc("","aug"):cc(e+s,o+r)}function cc(n,e){const s=e.split("/");if(s.length===1)return[n,s[0],""];const[o,r,a,c]=sh(s[1]);return o!==""&&a===""&&c===""?[n,s[0],o+r]:[n,e,""]}function Ec(n){if(Array.isArray(n))return ia(n[1]||"",n[0],n[2]);if(n==="")return rp;{const[e,s,o]=ap(n),r=ia(s,e,o);return r.empty?ia(n):r}}function ia(n,e,s){const o=Bv(n),r=Pe(e||""),a=Pe(s||"");if(o.empty||e&&r.empty||s&&a.empty)return rp;const c=ga(r.pc,a.pc),h=o.intervals.indexOf(c),m=h>=0,f=m?a:Pe(""),g=h===-1?NaN:h+1,b=a.pc&&a.pc!==r.pc,w=Array.from(o.intervals);if(m)for(let k=1;k<g;k++){const P=w[0][0],O=w[0][1],N=parseInt(P,10)+7;w.push(`${N}${O}`),w.shift()}else if(b){const k=ey(ga(r.pc,a.pc),"8P");k&&w.unshift(k)}const x=r.empty?[]:w.map(k=>Aa(r.pc,k));n=o.aliases.indexOf(n)!==-1?n:o.aliases[0];const A=`${r.empty?"":r.pc}${n}${m&&g>1?"/"+f.pc:b?"/"+a.pc:""}`,I=`${e?r.pc+" ":""}${o.name}${m&&g>1?" over "+f.pc:b?" over "+a.pc:""}`;return{...o,name:I,symbol:A,tonic:r.pc,type:o.name,root:f.pc,bass:b?a.pc:"",intervals:w,rootDegree:g,notes:x}}var ly=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],cy=ly;cy.forEach(([n,e,s])=>void 0);var hy="C C# D D# E F F# G G# A A# B".split(" "),uy="C Db D Eb E F Gb G Ab A Bb B".split(" ");function rh(n,e={}){if(isNaN(n)||n===-1/0||n===1/0)return"";n=Math.round(n);const o=(e.sharps===!0?hy:uy)[n%12];if(e.pitchClass)return o;const r=Math.floor(n/12)-1;return o+r}var to=Pe,eo=n=>to(n).pc,dy=n=>to(n).oct,ys=n=>to(n).midi;function Ju(n){return rh(n)}var Jo=Aa,Ko=n=>{const e=to(n);return e.empty?"":rh(e.midi||e.chroma,{sharps:e.alt>0,pitchClass:e.midi===null})};function gn(n,e){const s=to(n);if(s.empty)return"";const o=to(e||rh(s.midi||s.chroma,{sharps:s.alt<0,pitchClass:!0}));if(o.empty||o.chroma!==s.chroma)return"";if(s.oct===void 0)return o.pc;const r=s.chroma-s.alt,a=o.chroma-o.alt,c=r>11||a<0?-1:r<0||a>11?1:0,h=s.oct+c;return o.pc+h}var lp={empty:!0,name:"",chordType:""},Ku={};function cr(n){return typeof n=="string"?Ku[n]||(Ku[n]=vy(n)):typeof n=="number"?cr(ah[n]||""):eh(n)?py(n):th(n)?cr(n.name):lp}function py(n){return cr(ep(n.alt)+ah[n.step])}var my=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function fy(n){return my.exec(n)||["","","",""]}var gy="I II III IV V VI VII",ah=gy.split(" ");function vy(n){const[e,s,o,r]=fy(n);if(!o)return lp;const a=o.toUpperCase(),c=ah.indexOf(a),h=sp(s),m=1;return{empty:!1,name:e,roman:o,interval:ks({step:c,alt:h,dir:m}).name,acc:s,chordType:r,alt:h,step:c,major:o===a,oct:0,dir:m}}var lh=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],td={...si,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},yy=lh.map(by),Pc={};yy.forEach(n=>{Pc[n.name]=n,n.aliases.forEach(e=>{Pc[e]=n})});function cp(n){return typeof n=="string"?Pc[n.toLowerCase()]||td:n&&n.name?cp(n.name):td}function by(n){const[e,s,o,r,a,c,h]=n,m=h?[h]:[],f=Number(s).toString(2);return{empty:!1,intervals:op(r).intervals,modeNum:e,chroma:f,normalized:f,name:r,setNum:s,alt:o,triad:a,seventh:c,aliases:m}}function hp(n){return(e,s)=>{const o=cp(e);if(o.empty)return[];const r=nh(o.modeNum,n),a=o.intervals.map(c=>Aa(s,c));return r.map((c,h)=>a[h]+c)}}hp(lh.map(n=>n[4]));hp(lh.map(n=>n[5]));function _y(n,e){return e.map(s=>{const[o,r]=ap(s),a=ga(n,o);return cr(ks(a)).name+r})}var wy={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function xy(n){if(typeof n!="string")return["",""];const e=n.indexOf(" "),s=Pe(n.substring(0,e));if(s.empty){const r=Pe(n);return r.empty?["",n.toLowerCase()]:[r.name,""]}const o=n.substring(s.name.length+1).toLowerCase();return[s.name,o.length?o:""]}function Sy(n){const e=Array.isArray(n)?n:xy(n),s=Pe(e[0]).name,o=op(e[1]);if(o.empty)return wy;const r=o.name,a=s?o.intervals.map(h=>Aa(s,h)):[],c=s?s+" "+r:r;return{...o,name:c,type:r,tonic:s,notes:a}}class Cy{constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,paint:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!0,console.log(`[Logger] Enabled category: ${s}`))})}disable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!1,console.log(`[Logger] Disabled category: ${s}`))})}enableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!0}),this.setLevel("DEBUG"),console.log("[Logger] All categories enabled")}disableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!1}),this.setLevel("ERROR"),console.log("[Logger] All categories disabled")}isCategoryEnabled(e){return this.categories[e]===!0}setLevel(e){const o=["DEBUG","INFO","WARN","ERROR"].indexOf(e);o!==-1&&(this.enabledLevels={DEBUG:o<=0,INFO:o<=1,WARN:o<=2,ERROR:o<=3})}formatComponent(e){return`[${e}]`}moduleLoaded(e,s="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`${e}: Module loaded.`)}initStart(e,s="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`Main.js: Initializing ${e}...`)}initSuccess(e,s="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`Main.js: ${e} initialized successfully.`)}initFailed(e,s="",o="initialization"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(o))return;const r=s?` (${s})`:"";console.warn(`Main.js: ${e} failed to initialize${r}.`)}section(e,s="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||(console.log("========================================"),console.log(e),console.log("========================================"))}event(e,s,o="",r="ui"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e),c=o?`${s}. ${o}`:s;console.log(`${a} ${c}`)}state(e,s,o=null,r="state"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);if(o){const c=typeof o=="object"?JSON.stringify(o):String(o);console.log(`${a} ${s}: ${c}`)}else console.log(`${a} ${s}`)}debug(e,s,o=null,r="debug"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);if(o){const c=typeof o=="object"?JSON.stringify(o):String(o);console.log(`${a} ${s}: ${c}`)}else console.log(`${a} ${s}`)}timing(e,s,o,r="performance"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e),c=Object.entries(o).map(([h,m])=>typeof m=="number"&&m%1!==0?`${h}=${m.toFixed(3)}`:`${h}=${m}`).join(", ");console.log(`${a} ${s}: ${c}`)}warn(e,s,o=null,r="general"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);o?console.warn(`${a} ${s}`,o):console.warn(`${a} ${s}`)}error(e,s,o=null,r="general"){if(!this.enabledLevels.ERROR)return;const a=this.formatComponent(e);o?console.error(`${a} ${s}`,o):console.error(`${a} ${s}`)}info(e,s,o=null,r="general"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);o?console.log(`${a} ${s}`,o):console.log(`${a} ${s}`)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([e,s])=>s).map(([e])=>e)}}getAvailableCategories(){return Object.keys(this.categories)}log(e,s,o=null){this.info(e,s,o,"general")}}const T=new Cy;typeof window<"u"&&(window.logger=T);function Ty(n){const{macrobeatGroupings:e}=n,s=sn(n),o=[...n.columnWidths||[]],r=[Ur,Ur];T.debug("Columns Layout","Starting column width calculation",null,"layout"),T.debug("Columns Layout","Placed tonic signs",s.map(m=>`col:${m.columnIndex},mb:${m.preMacrobeatIndex}`),"layout"),T.debug("Columns Layout","Old columnWidths",o,"layout"),T.debug("Columns Layout","Macrobeat groupings",e,"layout");const a=[...s].sort((m,f)=>m.preMacrobeatIndex-f.preMacrobeatIndex);let c=0;const h=m=>{var g,b;let f=(g=a[c])==null?void 0:g.uuid;for(;a[c]&&a[c].preMacrobeatIndex===m;){T.debug("Columns Layout",`Adding tonic columns for mbIndex ${m}, tonic at column ${a[c].columnIndex}`,null,"layout");const w=r.length;for(r.push(Xr),r.push(Xr),T.debug("Columns Layout",`Added 2 columns (width=${Xr} each), total columns: ${w} -> ${r.length}`,null,"layout");a[c]&&a[c].uuid===f;)c++;f=(b=a[c])==null?void 0:b.uuid}};return h(-1),e.forEach((m,f)=>{for(let g=0;g<m;g++)r.push(Xr);h(f)}),r.push(Ur,Ur),T.debug("Columns Layout","Final newColumnWidths",r,"layout"),T.debug("Columns Layout","Width change",`${o.length} -> ${r.length} columns`,"layout"),T.debug("Columns Layout","Old total width units",o.reduce((m,f)=>m+f,0),"layout"),T.debug("Columns Layout","New total width units",r.reduce((m,f)=>m+f,0),"layout"),r}function Ay(n,e,s){let o=0;for(let r=0;r<n;r++)o+=(e[r]||0)*s;return o}function My(n,e){return n.reduce((s,o)=>s+o,0)*e}const oa=30;let fn=1,Zn=zg,Ln=0,Jn,tr,ed,zi,sd,Go,kc,Ic,jo,Dc,ra,nd,aa=!1,Ys=!1,hc=0;function Ey(){Jn=document.getElementById("pitch-grid-wrapper"),tr=document.getElementById("notation-grid"),document.getElementById("drum-grid-wrapper"),zi=document.getElementById("drum-grid"),Go=document.getElementById("drum-playhead-canvas"),kc=document.getElementById("playhead-canvas"),Ic=document.getElementById("hover-canvas"),jo=document.getElementById("drum-hover-canvas"),Dc=document.getElementById("pitch-paint-canvas"),ra=document.getElementById("canvas-macrobeat-tools");const n=document.getElementById("canvas-container");return!Jn||!tr||!n?{}:(ed=tr.getContext("2d"),sd=zi.getContext("2d"),{ctx:ed,drumCtx:sd,canvasContainer:n})}function Qn(){if(!Jn||Jn.clientHeight===0){requestAnimationFrame(Qn);return}if(aa)return;aa=!0;const n=document.getElementById("pitch-grid-container");Jn.clientWidth;const e=window.innerHeight;(Math.abs(e-Ln)>3||Ln===0)&&(Ln=e);const o=oa,r=o*Wg,a=o*fn,c=r*fn;u.setLayoutConfig({cellHeight:a,cellWidth:c});const h=Ty(u.state);u.setLayoutConfig({columnWidths:h});const f=h.reduce((it,Ct)=>it+Ct,0)*u.state.cellWidth,g=Lt.getModulatedCanvasWidth(),b=g>f?g:f,w=Math.round(b),x=document.getElementById("drum-grid-wrapper"),A=w+"px";n&&(n.style.width=A),Jn&&(Jn.style.width=A);const I=u.state.columnWidths.length-2;let k=0;for(let it=0;it<I;it++)k+=(u.state.columnWidths[it]||0)*u.state.cellWidth;const P=2,O=u.state.columnWidths.length-2;let N=0;for(let it=P;it<O;it++)N+=(u.state.columnWidths[it]||0)*u.state.cellWidth;if(x&&(x.style.width=`${k}px`),ra){ra.style.width=`${N}px`;const it=u.state.columnWidths.slice(0,P).reduce((Ct,xt)=>Ct+xt*u.state.cellWidth,0);ra.style.marginLeft=`${it}px`}[tr,kc,Ic,Dc].forEach(it=>{it&&Math.abs(it.width-w)>1&&(it.width=w)}),[zi,Go,jo].forEach(it=>{it&&Math.abs(it.width-k)>1&&(it.width=k)});const H=Math.max(fr,gr*u.state.cellHeight),G=Vg*H,Y=`${G}px`,ut=Math.abs(hc-G)>5;x&&(ut||hc===0)&&(x.style.height=Y,hc=G),zi&&Math.abs(zi.height-G)>1&&(zi.height=G),Go&&Math.abs(Go.height-G)>1&&(Go.height=G),jo&&Math.abs(jo.height-G)>1&&(jo.height=G),setTimeout(()=>{const Ct=document.getElementById("pitch-grid-container").clientHeight;[tr,kc,Ic,Dc].forEach((xt,tt)=>{xt&&Math.abs(xt.height-Ct)>1&&(xt.height=Ct)}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))}),u.emit("layoutConfigChanged"),aa=!1}const Lt={init(){const{ctx:n,drumCtx:e,canvasContainer:s}=Ey();requestAnimationFrame(Qn),this.initScrollHandler();const o=()=>{aa||(clearTimeout(nd),nd=setTimeout(()=>{Qn()},qg))};return window.addEventListener("resize",o),{ctx:n,drumCtx:e}},initScrollHandler(){const n=document.getElementById("pitch-grid-wrapper");n&&n.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey||e.metaKey)e.deltaY<0?this.zoomIn():this.zoomOut();else{const s=e.deltaY>0?1:-1;this.scrollByUnits(s)}},{passive:!1})},zoomIn(){Ys||(Ys=!0,fn=Math.min(Hg,fn*jg),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Qn(),Ys=!1})}))},zoomOut(){Ys||(Ys=!0,fn=Math.max(Gg,fn*Ug),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Qn(),Ys=!1})}))},resetZoom(){Ys||(Ys=!0,fn=1,requestAnimationFrame(()=>{requestAnimationFrame(()=>{Qn(),Ys=!1})}))},scroll(n){const e=n/Ln/4;Zn=Math.max(0,Math.min(1,Zn+e)),u.emit("layoutConfigChanged")},scrollByUnits(n){const e=u.state.fullRowData.length,o=(u.state.cellHeight||oa)/2,a=e*o,c=document.getElementById("pitch-grid-container"),h=(c==null?void 0:c.clientHeight)||Ln*.7,m=Math.max(0,a-h);if(m>0){const f=n*o/m;Zn=Math.max(0,Math.min(1,Zn+f)),u.emit("layoutConfigChanged")}},scrollByPixels(n,e=0){const s=-n,o=u.state.fullRowData.length,a=(u.state.cellHeight||oa)*fn,h=o*a,m=Math.max(0,h-Ln);if(m>0){const f=s/m;Zn=Math.max(0,Math.min(1,Zn+f))}u.emit("layoutConfigChanged")},getViewportInfo(){const n=u.state.fullRowData.length,e=document.getElementById("pitch-grid-container"),s=(e==null?void 0:e.clientHeight)||Ln*.7,o=u.state.cellHeight||oa,r=o/2,c=n*r,m=Math.max(0,c-s)*Zn,f=Math.max(0,Math.floor(m/r)),g=s/r,b=Math.min(n,Math.ceil(f+g));return{zoomLevel:fn,viewportHeight:Ln,containerHeight:s,cellHeight:o,halfUnit:r,startRank:f,endRank:b,scrollOffset:m}},getMacrobeatWidthPx(n,e){return e*n.cellWidth},getColumnX(n){return Ay(n,u.state.columnWidths,u.state.cellWidth)},getCanvasWidth(){return My(u.state.columnWidths,u.state.cellWidth)},getModulatedCanvasWidth(){const n=this.getCanvasWidth();if(!u.state.modulationMarkers||u.state.modulationMarkers.length===0)return n;try{const e=u.state.baseMicrobeatPx||u.state.cellWidth||40;let s=n;return u.state.modulationMarkers.forEach(r=>{r.ratio>1&&(s*=r.ratio)}),Math.max(n,s)}catch{return n}},recalculateLayout(){Qn()},get isZooming(){return Ys}},Py=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],sn=n=>Object.values(n.tonicSignGroups).flat(),is=(n,e)=>{let s=2;const{macrobeatGroupings:o}=n,r=sn(n);r.some(m=>m.preMacrobeatIndex===-1)&&(s+=2);for(let m=0;m<e;m++)s+=o[m],r.some(f=>f.preMacrobeatIndex===m)&&(s+=2);const a=s,c=o[e],h=a+(c||0)-1;return{startColumn:a,endColumn:h,grouping:c}},ky=n=>n.placedNotes.filter(e=>!e.isDrum),Iy=n=>n.placedNotes.filter(e=>e.isDrum),Dy=(n,e)=>{const o=sn(n).filter(h=>h.columnIndex<=e);if(o.length===0)return{keyTonic:"C",keyMode:"major"};const r=o.reduce((h,m)=>m.columnIndex>h.columnIndex?m:h),a=eo(n.fullRowData[r.row].toneNote),c=Py[r.tonicNumber-1]||"major";return{keyTonic:a,keyMode:c}},Ry=(n,e)=>{const s=[],{fullRowData:o,placedNotes:r,placedChords:a}=n;return r.forEach(c=>{var h;if(!c.isDrum&&e>=c.startColumnIndex&&e<=c.endColumnIndex){const m=(h=o[c.row])==null?void 0:h.toneNote;m&&s.push(m)}}),a.forEach(c=>{c.position.xBeat===e&&s.push(...c.notes)}),s},Oy=(n,e)=>{const s=new Set,{startColumn:o,endColumn:r}=is(n,e);for(let c=o;c<=r;c++)Ry(n,c).forEach(m=>{s.add(eo(m))});return Array.from(s)};function uc(n){if(!n)return null;const e=Kv(n);if(!e||e.num===void 0)return null;let s="";const o=e.alt,r=Math.abs(e.num);return o<0?s="♭".repeat(Math.abs(o)):o>0&&(s="♯".repeat(o)),`${s}${r}`}function id(n){return n&&{"♯1":"♭2","♭2":"♯1","♯2":"♭3","♭3":"♯2","♯4":"♭5","♭5":"♯4","♯5":"♭6","♭6":"♯5","♯6":"♭7","♭7":"♯6"}[n]||null}function od(n){return n&&(n.includes("♯")||n.includes("♭"))}const Rc={getEnharmonicDegree:id,hasAccidental:od,getDegreeForNote(n,e){var f;console.log("🎵 [TONAL] getDegreeForNote called:",{degreeDisplayMode:e.degreeDisplayMode,noteRow:n.row,noteStartCol:n.startColumnIndex});const{keyTonic:s,keyMode:o}=Dy(e,n.startColumnIndex);if(console.log("🎵 [TONAL] Key context:",{keyTonic:s,keyMode:o}),!s)return null;const r=(f=e.fullRowData[n.row])==null?void 0:f.toneNote;if(console.log("🎵 [TONAL] Note pitch:",{notePitch:r}),!r)return null;const a=eo(r);let c,h,m;if(e.degreeDisplayMode==="modal")c=s,h=lc(c,a),m=uc(h);else{if(o==="major")c=s;else{const g=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(o);if(g>0){const w=["1P","2M","3M","4P","5P","6M","7M"][g];c=Jo(s,ty(w))}else c=s}h=lc(c,a),m=uc(h)}if(console.log("🎵 [TONAL] Calculation:",{keyTonic:s,keyMode:o,referenceTonic:c,notePitchClass:a,rawInterval:h,formattedInterval:m,degreeDisplayMode:e.degreeDisplayMode,enharmonicPreference:n.enharmonicPreference}),n.enharmonicPreference&&od(m)){const g=id(m);if(g)return console.log(`🎵 [TONAL] Using enharmonic preference: ${m} → ${g}`),g}return m},getDegreesForNotes(n,e){return!n||n.length===0?[]:n.map(s=>{const o=lc(e,eo(s));return uc(o)})},getRomanNumeralForNotes(n,e,s){if(!n||n.length<2)return null;const[o]=Gv(n);if(!o)return null;const r=Ec(o).symbol;if(!r)return null;const[a]=_y(e,[r]);if(!a)return null;const c=cr(a),h=c.roman;let m=c.name.replace(h,"");const f=Ec(o).tonic;return m==="6"&&(m="add6"),{roman:h,ext:m,root:f}}};function dc(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const Ny={addNote(n){const e=this.state.placedNotes.find(o=>!o.isDrum&&o.row===n.row&&o.startColumnIndex===n.startColumnIndex&&o.color===n.color);if(e){if(this.state.degreeDisplayMode!=="off"){const o=Rc.getDegreeForNote(e,this.state);if(Rc.hasAccidental(o))return e.enharmonicPreference=!e.enharmonicPreference,console.log("🎵 [ENHARMONIC] Toggled enharmonic preference for note:",{noteUuid:e.uuid,currentDegree:o,enharmonicPreference:e.enharmonicPreference}),this.emit("notesChanged"),e}return null}const s={...n,uuid:dc()};return this.state.placedNotes.push(s),this.emit("notesChanged"),s},updateNoteTail(n,e){n.endColumnIndex=e,this.emit("notesChanged")},updateMultipleNoteTails(n,e){n.forEach(s=>{s.endColumnIndex=e}),this.emit("notesChanged")},eraseInPitchArea(n,e,s=1,o=!0){const r=n+s-1,a=e-1,c=e+1;let h=!1;const m=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(f=>{if(f.isDrum)return!0;if(f.shape==="circle"){const g=f.startColumnIndex+1,b=f.startColumnIndex<=r&&g>=n,w=f.row>=a&&f.row<=c;if(b&&w)return!1}else if(f.row>=a&&f.row<=c&&f.startColumnIndex<=r&&f.endColumnIndex>=n)return!1;return!0}),this.state.placedNotes.length<m&&(h=!0),h&&(this.emit("notesChanged"),o&&this.recordState()),h},eraseDrumNoteAt(n,e,s=!0){const o=this.state.placedNotes.length;this.state.placedNotes=this.state.placedNotes.filter(a=>!(a.isDrum&&a.drumTrack===e&&a.startColumnIndex===n));const r=this.state.placedNotes.length<o;return r&&(this.emit("notesChanged"),s&&this.recordState()),r},addTonicSignGroup(n){T.debug("TonicPlacement","Starting addTonicSignGroup",{tonicSignGroup:n},"state");const e=n[0],{preMacrobeatIndex:s}=e;if(T.debug("TonicPlacement","preMacrobeatIndex",{preMacrobeatIndex:s},"state"),Object.values(this.state.tonicSignGroups).flat().some(h=>h.preMacrobeatIndex===s)){T.debug("TonicPlacement","Tonic already exists at this preMacrobeatIndex, returning",null,"state");return}const o=is(this.state,s+1).startColumn;T.debug("TonicPlacement","Boundary column for shifting notes",{boundaryColumn:o},"state");const r=this.state.placedNotes.filter(h=>h.startColumnIndex>=o);T.debug("TonicPlacement","Notes that will be shifted",{noteRanges:r.map(h=>`${h.startColumnIndex}-${h.endColumnIndex}`)},"state"),this.state.placedNotes.forEach(h=>{if(h.startColumnIndex>=o){const m=h.startColumnIndex,f=h.endColumnIndex;h.startColumnIndex+=2,h.endColumnIndex+=2,T.debug("TonicPlacement",`Shifted note from ${m}-${f} to ${h.startColumnIndex}-${h.endColumnIndex}`,null,"state")}});const a=dc(),c=n.map(h=>({...h,uuid:a}));this.state.tonicSignGroups[a]=c,T.debug("TonicPlacement","Added tonic group",{uuid:a,columns:c.map(h=>h.columnIndex)},"state"),T.debug("TonicPlacement","Emitting events: notesChanged, rhythmStructureChanged",null,"state"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(n,e=!0){const s=Object.entries(this.state.tonicSignGroups).find(([h,m])=>m.some(f=>f.columnIndex===n));if(!s)return!1;const[o,r]=s,a=r[0].preMacrobeatIndex,c=is(this.state,a+1).startColumn;return delete this.state.tonicSignGroups[o],this.state.placedNotes.forEach(h=>{h.startColumnIndex>=c&&(h.startColumnIndex-=2,h.endColumnIndex-=2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),e&&this.recordState(),!0},toggleDrumNote(n){const e=this.state.placedNotes.findIndex(s=>s.isDrum&&s.drumTrack===n.drumTrack&&s.startColumnIndex===n.startColumnIndex);e>=0?this.state.placedNotes.splice(e,1):this.state.placedNotes.push({...n,uuid:dc()}),this.emit("notesChanged"),this.recordState()},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(n){this.state.placedNotes=n,this.emit("notesChanged"),this.recordState()}},Ly={setADSR(n,e){this.state.timbres[n]&&(this.state.timbres[n].adsr=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setFilterSettings(n,e){if(this.state.timbres[n]){console.log("setFilterSettings called:",{color:n,newSettings:e,activePresetName:this.state.timbres[n].activePresetName}),console.trace("setFilterSettings call stack"),Object.assign(this.state.timbres[n].filter,e);const s=this.state.timbres[n].filter.blend;s<=0?this.state.timbres[n].filter.type="highpass":s>=2?this.state.timbres[n].filter.type="lowpass":this.state.timbres[n].filter.type="bandpass",e.enabled===void 0&&(console.log("Clearing activePresetName because enabled is undefined"),this.state.timbres[n].activePresetName=null),this.emit("timbreChanged",n)}},setHarmonicCoefficients(n,e){this.state.timbres[n]&&(this.state.timbres[n].coeffs=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setHarmonicPhases(n,e){this.state.timbres[n]&&(T.debug("TimbreActions",`setHarmonicPhases called for ${n}`,null,"state"),T.debug("TimbreActions","Old phases",{phases:this.state.timbres[n].phases},"state"),T.debug("TimbreActions","New phases",{phases:e},"state"),T.debug("TimbreActions","Coefficients before phase change",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].phases=e,this.state.timbres[n].activePresetName=null,T.debug("TimbreActions","Coefficients after phase change",{coeffs:this.state.timbres[n].coeffs},"state"),T.debug("TimbreActions","Emitting timbreChanged for phase change",null,"state"),this.emit("timbreChanged",n))},applyPreset(n,e){!e||!this.state.timbres[n]||(T.debug("TimbreActions",`applyPreset called for ${n}`,null,"state"),T.debug("TimbreActions","Preset name",{name:e.name},"state"),T.debug("TimbreActions","Preset coeffs",{coeffs:e.coeffs},"state"),T.debug("TimbreActions","Old timbre coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].adsr=e.adsr,this.state.timbres[n].coeffs=new Float32Array(e.coeffs),e.phases?this.state.timbres[n].phases=new Float32Array(e.phases):this.state.timbres[n].phases=new Float32Array(this.state.timbres[n].coeffs.length).fill(0),this.state.timbres[n].activePresetName=e.name,this.state.timbres[n].gain=e.gain||1,e.filter?this.state.timbres[n].filter=JSON.parse(JSON.stringify(e.filter)):this.state.timbres[n].filter=jd(),T.debug("TimbreActions","Applied preset - new coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.emit("timbreChanged",n),this.recordState())}},Es={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function Fy(n,e){if(console.log("[MODULATION] measureIndexToCanvasX called:",{measureIndex:n,hasState:!!e,cellWidth:e?e.cellWidth:"N/A"}),!e){console.warn("[MODULATION] No state provided for measure conversion");const c=n*200;return console.log("[MODULATION] Using fallback calculation:",c),c}const s=e.cellWidth||40;if(console.log("[MODULATION] Using cellWidth:",s),n===0){const c=2*s;return console.log("[MODULATION] Measure 0 → column 2 →",c),c}const o=n-1;console.log("[MODULATION] Looking for macrobeat index:",o);const r=is(e,o);if(console.log("[MODULATION] getMacrobeatInfo result:",r),r){const c=(r.endColumn+1)*s;return console.log("[MODULATION] Found measure info, calculated position:",c),c}console.warn("[MODULATION] Could not find measure info for index:",n);const a=n*s*4;return console.log("[MODULATION] Using improved fallback calculation:",a),a}function $y(n,e,s=null,o=null,r=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:n,ratio:e,active:!0,xPosition:s,columnIndex:o,macrobeatIndex:r}}function up(n){return Math.abs(n-Es.COMPRESSION_2_3)<.001?"2:3":Math.abs(n-Es.EXPANSION_3_2)<.001?"3:2":`${n}`}function dp(n){return Math.abs(n-Es.COMPRESSION_2_3)<.001?"#dc3545":Math.abs(n-Es.EXPANSION_3_2)<.001?"#007bff":"#6c757d"}function rd(n){return{segments:[{startX:0,endX:1/0,scale:1,spacingPx:n}],microbeatToCanvasX(e){return e*n},canvasXToMicrobeat(e){return e/n},getSegmentAtX(e){return this.segments[0]},getGhostGridPositions(e,s){return[]}}}function pp(n,e,s=null){if(!n||n.length===0)return rd(e);const o=[...n.filter(h=>h.active)].sort((h,m)=>h.measureIndex-m.measureIndex);if(o.length===0)return rd(e);console.log("[MODULATION] Creating coordinate mapping for markers:",o);const r=o.map(h=>{let m;return h.xPosition!==null&&h.xPosition!==void 0?(m=h.xPosition,console.log(`[MODULATION] Marker at measure ${h.measureIndex} → using stored x=${m}`)):(m=Fy(h.measureIndex,s),console.log(`[MODULATION] Marker at measure ${h.measureIndex} → calculated x=${m}`)),console.log("[MODULATION] Final marker position:",{id:h.id,measureIndex:h.measureIndex,canvasX:m,isStored:h.xPosition!==null&&h.xPosition!==void 0}),{...h,xCanvas:m}}),a=[];let c=1;(r.length===0||r[0].xCanvas>0)&&a.push({startX:0,endX:r.length>0?r[0].xCanvas:1/0,scale:1,spacingPx:e});for(let h=0;h<r.length;h++){const m=r[h],f=h+1<r.length?r[h+1].xCanvas:1/0;c*=m.ratio,a.push({startX:m.xCanvas,endX:f,scale:c,spacingPx:e*c,marker:m})}return{segments:a,microbeatToCanvasX(h){let m=0,f=0;for(const g of a){const w=(g.endX-g.startX)/g.spacingPx;if(f+w>=h){const x=h-f;return g.startX+x*g.spacingPx}f+=w,m=g.endX}return m},canvasXToMicrobeat(h){let m=0;for(const f of a){if(h>=f.startX&&h<f.endX){const w=(h-f.startX)/f.spacingPx;return m+w}const g=f.endX-f.startX;m+=g/f.spacingPx}return m},getSegmentAtX(h){return a.find(m=>h>=m.startX&&h<m.endX)||null},getGhostGridPositions(h,m){if(console.log("[GHOST-CALC] getGhostGridPositions called with:",{segment:h,hasMarker:!!h.marker,hasOptions:!!m}),!h.marker)return console.log("[GHOST-CALC] No marker on segment, returning empty array"),[];if(!m||!m.columnWidths)return console.warn("[GHOST-CALC] No grid options provided"),[];const f=[],{columnWidths:g,cellWidth:b}=m;if(console.log("[GHOST-CALC] Options check:",{hasColumnWidths:!!g,columnCount:g?g.length:0,cellWidth:b,segmentStartX:h.startX,segmentEndX:h.endX,segmentScale:h.scale}),!g||!b||b===0)return console.warn("[GHOST-CALC] Missing grid data"),[];let w=0;for(let x=0;x<g.length;x++){const A=w;if(h.endX===1/0?A>=h.startX:A>=h.startX&&A<h.endX){let P,O;if(h.endX===1/0){const N=g.reduce((H,G)=>H+G,0)*b;O=Math.max(N,h.startX+800),P=O-h.startX}else P=h.endX-h.startX,O=h.endX;if(P>0&&h.scale>0){const N=(A-h.startX)/P,H=P/h.scale,G=h.startX+N*H;!isNaN(G)&&isFinite(G)&&f.push(G)}}const k=g[x]||0;if(w+=k*b,h.endX!==1/0&&w>h.endX)break}return f}}}function By(n,e,s){let o=0;for(const r of e.segments){if(n>=r.startX&&n<r.endX){const f=(n-r.startX)/r.spacingPx,g=s/r.scale;return o+f*g}const c=(r.endX-r.startX)/r.spacingPx,h=s/r.scale;o+=c*h}return o}const qy={setAnacrusis(n){if(this.state.hasAnacrusis===n)return;const e=this.state.macrobeatGroupings,s=n?Wd:Fg,o=e.reduce((c,h)=>c+h,0),a=s.reduce((c,h)=>c+h,0)-o;if(this.state.hasAnacrusis=n,this.state.macrobeatGroupings=[...s],this.state.macrobeatBoundaryStyles=n?[...Vd]:[...$g],a!==0){const c=[];this.state.placedNotes.forEach(f=>{if(f.startColumnIndex>=2){const b=f.startColumnIndex+a,w=f.endColumnIndex+a;b<2?c.push(f):(f.startColumnIndex=b,f.endColumnIndex=w)}}),c.forEach(f=>{const g=this.state.placedNotes.indexOf(f);g>-1&&this.state.placedNotes.splice(g,1)});const h=[];this.state.stampPlacements.forEach(f=>{if(f.startColumn>=2){const b=f.startColumn+a,w=f.endColumn+a;b<2?h.push(f):(f.startColumn=b,f.endColumn=w)}}),h.forEach(f=>{const g=this.state.stampPlacements.indexOf(f);g>-1&&this.state.stampPlacements.splice(g,1)});const m=[];this.state.tripletPlacements&&(this.state.tripletPlacements.forEach(f=>{const g=a/2,b=1;if(f.startCellIndex>=b){const w=f.startCellIndex+g;w<b?m.push(f):f.startCellIndex=w}}),m.forEach(f=>{const g=this.state.tripletPlacements.indexOf(f);g>-1&&this.state.tripletPlacements.splice(g,1)})),Object.values(this.state.tonicSignGroups).flat().forEach(f=>{f.preMacrobeatIndex>=0})}this.emit("anacrusisChanged",n),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(n){if(n===void 0||n<0||n>=this.state.macrobeatGroupings.length){T.error("rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${n}`,null,"state");return}const e=this.state.macrobeatGroupings[n],s=e===2?3:2,o=s-e;let r=2;const a=Object.values(this.state.tonicSignGroups).flat(),c=new Set(a.filter(h=>h.preMacrobeatIndex<n).map(h=>h.uuid)).size;r+=c;for(let h=0;h<=n;h++)r+=this.state.macrobeatGroupings[h];this.state.placedNotes.forEach(h=>{h.startColumnIndex>=r&&(h.startColumnIndex+=o,h.endColumnIndex+=o)}),this.state.macrobeatGroupings[n]=s,this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(n){if(n===void 0||n<0||n>=this.state.macrobeatBoundaryStyles.length){T.error("rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${n}`,null,"state");return}const e=this._isBoundaryInAnacrusis(n);let s;e?s=["dashed","solid","anacrusis"]:s=["dashed","solid"];const o=this.state.macrobeatBoundaryStyles[n],r=s.indexOf(o),a=r===-1?0:(r+1)%s.length;this.state.macrobeatBoundaryStyles[n]=s[a],this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(n){if(!this.state.hasAnacrusis)return!1;for(let e=0;e<=n;e++)if(this.state.macrobeatBoundaryStyles[e]==="solid")return e===n;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){this.state.macrobeatGroupings.length>1&&(this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),this.emit("rhythmStructureChanged"),this.recordState())},updateTimeSignature(n,e){if(!Array.isArray(e)||e.length===0){T.error("rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let s=0,o=0,r=0;for(let x=0;x<this.state.macrobeatGroupings.length;x++){if(r===n){s=x;break}const A=x===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[x]==="solid"||A)&&r++}r=0;for(let x=0;x<this.state.macrobeatGroupings.length;x++)if(r===n){const A=x===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[x]==="solid"||A){o=x;break}}else if(r<n){const A=x===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[x]==="solid"||A)&&r++}const a=o-s+1,c=e.length,h=e.reduce((x,A)=>x+A,0)-this.state.macrobeatGroupings.slice(s,o+1).reduce((x,A)=>x+A,0);let m=2;const f=Object.values(this.state.tonicSignGroups).flat(),g=new Set(f.filter(x=>x.preMacrobeatIndex<=o).map(x=>x.uuid)).size;m+=g;for(let x=0;x<=o;x++)m+=this.state.macrobeatGroupings[x];h!==0&&this.state.placedNotes.forEach(x=>{x.startColumnIndex>=m&&(x.startColumnIndex+=h,x.endColumnIndex+=h)});const b=[...e],w=new Array(c-1).fill("dashed");if(o<this.state.macrobeatBoundaryStyles.length){const x=this.state.macrobeatBoundaryStyles[o];c>0&&w.push(x)}this.state.macrobeatGroupings.splice(s,a,...b),this.state.macrobeatBoundaryStyles.splice(s,a-1,...w),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(n,e,s=null,o=null,r=null){if(!Object.values(Es).includes(e))return T.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state"),null;const a=this.state.modulationMarkers.findIndex(h=>h.measureIndex===n||r!==null&&h.macrobeatIndex===r||o!==null&&h.columnIndex===o);if(a!==-1){const h=this.state.modulationMarkers[a];return T.info("rhythmActions",`Replacing existing modulation marker ${h.id} at measure ${n} (old ratio: ${h.ratio}, new ratio: ${e})`,null,"state"),h.ratio=e,h.xPosition=s,o!==null&&(h.columnIndex=o),r!==null&&(h.macrobeatIndex=r),this.emit("modulationMarkersChanged"),this.recordState(),h.id}const c=$y(n,e,s,o,r);return this.state.modulationMarkers.push(c),this.state.modulationMarkers.sort((h,m)=>h.measureIndex-m.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Added modulation marker ${c.id} at measure ${n} with ratio=${e}, columnIndex=${o}`,null,"state"),console.log("[MODULATION] State after adding marker:",{markerCount:this.state.modulationMarkers.length,markers:this.state.modulationMarkers}),c.id},removeModulationMarker(n){const e=this.state.modulationMarkers.findIndex(s=>s.id===n);if(e===-1){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}this.state.modulationMarkers.splice(e,1),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Removed modulation marker ${n}`,null,"state")},setModulationRatio(n,e){if(!Object.values(Es).includes(e)){T.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state");return}const s=this.state.modulationMarkers.find(o=>o.id===n);if(!s){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.ratio=e,this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Updated modulation marker ${n} ratio to ${e}`,null,"state")},moveModulationMarker(n,e){const s=this.state.modulationMarkers.find(o=>o.id===n);if(!s){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.measureIndex=e,this.state.modulationMarkers.sort((o,r)=>o.measureIndex-r.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Moved modulation marker ${n} to measure ${e}`,null,"state")},toggleModulationMarker(n){const e=this.state.modulationMarkers.find(s=>s.id===n);if(!e){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}e.active=!e.active,this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Toggled modulation marker ${n} active state to ${e.active}`,null,"state")},clearModulationMarkers(){const n=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Cleared ${n} modulation markers`,null,"state"),console.log("[MODULATION] All markers cleared")}},zy={toggleAccidentalMode(n){this.state.accidentalMode.hasOwnProperty(n)&&(this.state.accidentalMode[n]=!this.state.accidentalMode[n],this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged"))},toggleFocusColours(){this.state.focusColours=!this.state.focusColours,this.emit("focusColoursChanged",this.state.focusColours),this.emit("layoutConfigChanged")},setDegreeDisplayMode(n){this.state.degreeDisplayMode,this.state.degreeDisplayMode=this.state.degreeDisplayMode===n?"off":n;const e=this.state.degreeDisplayMode;this.emit("layoutConfigChanged"),this.emit("degreeDisplayModeChanged",e)},setSelectedTool(n,e){if(this.state.selectedTool!==n||n==="tonicization"&&this.state.selectedToolTonicNumber!==e){const o=this.state.selectedTool;this.state.previousTool=o,this.state.selectedTool=n,n==="tonicization"&&e&&(this.state.selectedToolTonicNumber=parseInt(e,10)),this.emit("toolChanged",{newTool:n,oldTool:o})}},setSelectedNote(n,e){const s={...this.state.selectedNote};this.state.selectedNote={shape:n,color:e},this.emit("noteChanged",{newNote:this.state.selectedNote,oldNote:s})},setKeySignature(n){this.state.keySignature!==n&&(this.state.keySignature=n,this.emit("keySignatureChanged",n))},setTempo(n){this.state.tempo=n,this.emit("tempoChanged",n)},setLooping(n){this.state.isLooping=n,this.emit("loopingChanged",n)},setPlaybackState(n,e=!1){this.state.isPlaying=n,this.state.isPaused=e,this.emit("playbackStateChanged",{isPlaying:n,isPaused:e})},toggleWaveformExtendedView(){this.state.waveformExtendedView=!this.state.waveformExtendedView,this.emit("waveformExtendedViewChanged",this.state.waveformExtendedView)},setAdsrTimeAxisScale(n){const e=Math.max(.1,Math.min(5,n));this.state.adsrTimeAxisScale=e,this.emit("adsrTimeAxisScaleChanged",e)},setAdsrComponentWidth(n){const e=Math.max(50,Math.min(200,n));this.state.adsrComponentWidth=e,this.emit("adsrComponentWidthChanged",e)},setLayoutConfig(n){const e={cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]};let s=!1;if(n.cellWidth!==void 0&&this.state.cellWidth!==n.cellWidth&&(this.state.cellWidth=n.cellWidth,s=!0),n.cellHeight!==void 0&&this.state.cellHeight!==n.cellHeight&&(this.state.cellHeight=n.cellHeight,s=!0),n.columnWidths!==void 0){const o=JSON.stringify(this.state.columnWidths||[]),r=JSON.stringify(n.columnWidths);o!==r&&(this.state.columnWidths=[...n.columnWidths],s=!0)}s&&this.emit("layoutConfigChanged",{oldConfig:e,newConfig:{cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]}})},setGridPosition(n){const e=this.state.fullRowData.length-this.state.viewportRows*2,s=Math.max(0,Math.min(n,e));this.state.gridPosition!==s&&(this.state.gridPosition=s,this.emit("layoutConfigChanged"))},shiftGridUp(){this.setGridPosition(this.state.gridPosition-1)},shiftGridDown(){this.setGridPosition(this.state.gridPosition+1)},setPrintOptions(n){this.state.printOptions={...this.state.printOptions,...n},this.emit("printOptionsChanged",this.state.printOptions)},setPrintPreviewActive(n){this.state.isPrintPreviewActive,this.state.isPrintPreviewActive=n,this.emit("printPreviewStateChanged",n)}},Wy={addChord(n){},updateChord(n,e){},deleteChord(n){},setActiveChord(n){},setRegionContext(n){},rebuildAllChords(n){},setActiveChordIntervals(n){this.state.activeChordIntervals=n,this.emit("activeChordIntervalsChanged",n)},setIntervalsInversion(n){this.state.isIntervalsInverted=n,this.emit("intervalsInversionChanged",n)},setChordPosition(n){this.state.chordPositionState=n,this.emit("chordPositionChanged",n)},openChordCandidateMenu(n,e,s){this.state.isChordCandidateMenuOpen=!0,this.state.activeMacrobeatIndex=n,this.state.chordCandidates=e,this.state.chordCandidateMenuPosition=s,this.emit("chordCandidateMenuStateChanged")},closeChordCandidateMenu(){this.state.isChordCandidateMenuOpen=!1,this.state.activeMacrobeatIndex=null,this.emit("chordCandidateMenuStateChanged")},applyChordCandidate(n){if(this.state.activeMacrobeatIndex===null)return;const{startColumn:e,endColumn:s}=is(this.state,this.state.activeMacrobeatIndex);Oy(this.state,this.state.activeMacrobeatIndex);let o="C8";this.state.placedNotes.forEach(g=>{if(g.startColumnIndex>=e&&g.startColumnIndex<=s){const b=this.state.fullRowData[g.row].toneNote;ys(b)<ys(o)&&(o=b)}});const r=dy(o),c=`${Ec(n).tonic}${r}`,h=ia(n,c).notes.map(g=>Ko(g));this.state.placedNotes=this.state.placedNotes.filter(g=>g.startColumnIndex<e||g.startColumnIndex>s);const{shape:m,color:f}=this.state.selectedNote;h.forEach(g=>{const b=this.state.fullRowData.findIndex(w=>w.toneNote===g);if(b!==-1){const w={row:b,startColumnIndex:e,endColumnIndex:e,color:f,shape:m,isDrum:!1};this.addNote(w)}}),this.closeChordCandidateMenu(),this.recordState(),this.emit("notesChanged")}};T.moduleLoaded("paintActions","state");const Vy={setMicPaintActive(n){this.state.paint.isMicPaintActive=n,T.debug("paintActions",`Mic Paint Active set to: ${n}`,null,"paint"),this.emit("micPaintStateChanged",n)},setPaintDetectionState(n){this.state.paint.isDetecting,this.state.paint.isDetecting=n,T.debug("paintActions",`Paint detection state set to: ${n}`,null,"paint"),this.emit("paintDetectionStateChanged",n)},setDetectedPitch(n){this.state.paint.detectedPitch=n,this.emit("pitchDetected",n)},addPaintPoint(n){this.state.paint.paintHistory.push(n)},clearPaintHistory(){this.state.paint.paintHistory=[],T.debug("paintActions","Paint history cleared",null,"paint"),this.emit("paintHistoryChanged"),this.recordState()},setPaintSettings(n){Object.assign(this.state.paint.paintSettings,n),T.debug("paintActions","Paint settings updated",{settings:this.state.paint.paintSettings},"paint"),this.emit("paintSettingsChanged",this.state.paint.paintSettings),this.recordState()}};T.moduleLoaded("StampActions","stamps");function Hy(){return`stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const Gy={addStampPlacement(n,e,s,o="#4a90e2"){const r=e+1,a=this.state.stampPlacements.find(h=>h.row===s&&h.startColumn<=r&&h.endColumn>=e);a&&this.removeStampPlacement(a.id);const c={id:Hy(),stampId:n,startColumn:e,endColumn:r,row:s,color:o,timestamp:Date.now()};return this.state.stampPlacements.push(c),this.emit("stampPlacementsChanged"),T.debug("StampActions",`Added stamp ${n} at ${e}-${r},${s}`,{stampId:n,startColumn:e,endColumn:r,row:s,placementId:c.id},"stamps"),c},removeStampPlacement(n){const e=this.state.stampPlacements.findIndex(o=>o.id===n);if(e===-1)return!1;const s=this.state.stampPlacements.splice(e,1)[0];return this.emit("stampPlacementsChanged"),T.debug("StampActions",`Removed stamp ${s.stampId} at ${s.startColumn}-${s.endColumn},${s.row}`,{placementId:n,stampId:s.stampId,startColumn:s.startColumn,endColumn:s.endColumn,row:s.row},"stamps"),!0},eraseStampsInArea(n,e,s,o){const r=[];for(const c of this.state.stampPlacements){const h=c.startColumn<=e&&c.endColumn>=n,m=c.row>=s&&c.row<=o;h&&m&&r.push(c.id)}let a=!1;return r.forEach(c=>{this.removeStampPlacement(c)&&(a=!0)}),a},getAllStampPlacements(){return[...this.state.stampPlacements]},getStampAt(n,e){return this.state.stampPlacements.find(s=>s.row===e&&n>=s.startColumn&&n<=s.endColumn)||null},clearAllStamps(){const n=this.state.stampPlacements.length>0;this.state.stampPlacements=[],n&&(this.emit("stampPlacementsChanged"),T.info("StampActions","Cleared all stamp placements",null,"stamps"))},getStampPlaybackData(){return this.state.stampPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{stampId:n.stampId,column:n.startColumn,startColumn:n.startColumn,endColumn:n.endColumn,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,placement:n}}).filter(n=>n.pitch)},updateStampShapeOffset(n,e,s){const o=this.state.stampPlacements.find(r=>r.id===n);if(!o){console.warn("[STAMP SHAPE OFFSET] Placement not found:",n);return}o.shapeOffsets||(o.shapeOffsets={}),console.log("[STAMP SHAPE OFFSET] Updating shape offset:",{placementId:n,shapeKey:e,oldOffset:o.shapeOffsets[e]||0,newOffset:s,baseRow:o.row,targetRow:o.row+s}),o.shapeOffsets[e]=s,this.emit("stampPlacementsChanged")},getShapeRow(n,e){var o;const s=((o=n.shapeOffsets)==null?void 0:o[e])||0;return n.row+s}};T.moduleLoaded("TripletActions","triplets");function jy(){return`triplet-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const Uy={addTripletPlacement(n){this.state.tripletPlacements||(this.state.tripletPlacements=[]);const e=this.state.tripletPlacements.find(o=>o.row===n.row&&!(o.startCellIndex+o.span<=n.startCellIndex||n.startCellIndex+n.span<=o.startCellIndex));e&&this.removeTripletPlacement(e.id),this.state.stampPlacements&&this.state.stampPlacements.filter(r=>{if(r.row!==n.row)return!1;const a=Math.floor(r.startColumn/2),c=Math.floor(r.endColumn/2),h=n.startCellIndex+n.span-1;return!(c<n.startCellIndex||a>h)}).forEach(r=>this.removeStampPlacement(r.id));const s={id:jy(),...n};return this.state.tripletPlacements.push(s),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),T.debug("TripletActions",`Added triplet ${n.stampId} at cell ${n.startCellIndex}, row ${n.row}`,{stampId:n.stampId,startCellIndex:n.startCellIndex,span:n.span,row:n.row,placementId:s.id},"triplets"),s},removeTripletPlacement(n){if(!this.state.tripletPlacements)return!1;const e=this.state.tripletPlacements.findIndex(o=>o.id===n);if(e===-1)return!1;const s=this.state.tripletPlacements.splice(e,1)[0];return this.emit("tripletPlacementsChanged"),T.debug("TripletActions",`Removed triplet ${s.stampId} at cell ${s.startCellIndex}, row ${s.row}`,{placementId:n,stampId:s.stampId,startCellIndex:s.startCellIndex,span:s.span,row:s.row},"triplets"),!0},eraseTripletsInArea(n,e,s,o){if(!this.state.tripletPlacements)return!1;const r=Math.floor(n/2),a=Math.floor(e/2),c=[];for(const m of this.state.tripletPlacements)m.row>=s&&m.row<=o&&(m.startCellIndex+m.span-1<r||m.startCellIndex>a||c.push(m.id));let h=!1;return c.forEach(m=>{this.removeTripletPlacement(m)&&(h=!0)}),h},getAllTripletPlacements(){return[...this.state.tripletPlacements||[]]},getTripletAt(n,e){return this.state.tripletPlacements&&this.state.tripletPlacements.find(s=>s.row===e&&n>=s.startCellIndex&&n<s.startCellIndex+s.span)||null},clearAllTripletPlacements(){if(!this.state.tripletPlacements)return;const n=this.state.tripletPlacements.length>0;this.state.tripletPlacements=[],n&&(this.emit("tripletPlacementsChanged"),T.info("TripletActions","Cleared all triplet placements",null,"triplets"))},getTripletPlaybackData(){return this.state.tripletPlacements?this.state.tripletPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{startCellIndex:n.startCellIndex,stampId:n.stampId,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,span:n.span,placement:n}}).filter(n=>n.pitch):[]},updateTripletShapeOffset(n,e,s){const o=this.state.tripletPlacements.find(r=>r.id===n);if(!o){console.warn("[TRIPLET SHAPE OFFSET] Placement not found:",n);return}o.shapeOffsets||(o.shapeOffsets={}),console.log("[TRIPLET SHAPE OFFSET] Updating shape offset:",{placementId:n,shapeKey:e,oldOffset:o.shapeOffsets[e]||0,newOffset:s,baseRow:o.row,targetRow:o.row+s}),o.shapeOffsets[e]=s,this.emit("tripletPlacementsChanged")},getTripletShapeRow(n,e){var o;const s=((o=n.shapeOffsets)==null?void 0:o[e])||0;return n.row+s}};T.moduleLoaded("Store","general");const ch="studentNotationState";function Xy(){try{const n=localStorage.getItem(ch);if(n===null)return;const e=JSON.parse(n);if(e.timbres)for(const s in e.timbres){const o=e.timbres[s];if(o.coeffs&&typeof o.coeffs=="object"){const r=Array.isArray(o.coeffs)?o.coeffs:Object.values(o.coeffs);o.coeffs=new Float32Array(r)}if(o.phases&&typeof o.phases=="object"){const r=Array.isArray(o.phases)?o.phases:Object.values(o.phases);o.phases=new Float32Array(r)}}if(e.paint){const s=Ud.paint||{},o=e.paint;e.paint={...s,...o,paintSettings:{...s.paintSettings,...o.paintSettings||{}}}}return e}catch(n){T.error("Store","Could not load state from localStorage",n,"general");return}}function mp(n){try{const e=JSON.parse(JSON.stringify({placedNotes:n.placedNotes,placedChords:n.placedChords,tonicSignGroups:n.tonicSignGroups,stampPlacements:n.stampPlacements,tripletPlacements:n.tripletPlacements,timbres:n.timbres,macrobeatGroupings:n.macrobeatGroupings,macrobeatBoundaryStyles:n.macrobeatBoundaryStyles,hasAnacrusis:n.hasAnacrusis,baseMicrobeatPx:n.baseMicrobeatPx,modulationMarkers:n.modulationMarkers,tempo:n.tempo,activeChordIntervals:n.activeChordIntervals,selectedNote:n.selectedNote,annotations:n.annotations,paint:{paintHistory:n.paint.paintHistory,paintSettings:n.paint.paintSettings}}));if(n.timbres)for(const o in n.timbres)n.timbres[o].coeffs&&e.timbres[o]&&(e.timbres[o].coeffs=Array.from(n.timbres[o].coeffs)),n.timbres[o].phases&&e.timbres[o]&&(e.timbres[o].phases=Array.from(n.timbres[o].phases));const s=JSON.stringify(e);localStorage.setItem(ch,s)}catch(e){T.error("Store","Could not save state to localStorage",e,"general")}}const ad={...cv,...Ny,...Ly,...qy,...zy,...Wy,...Vy,...Gy,...Uy,clearSavedState(){try{localStorage.removeItem(ch),localStorage.removeItem("effectDialValues"),window.location.reload()}catch(n){T.error("Store","Could not clear state from localStorage",n,"general")}}},Bo={},fp=Xy(),Yy={...Ud,...fp},u={state:Yy,on(n,e){Bo[n]||(Bo[n]=[]),Bo[n].push(e)},emit(n,e){Bo[n]&&Bo[n].forEach(s=>{try{s(e)}catch(o){T.error("Store",`Error in listener for event "${n}"`,o,"general")}})}};for(const n in ad)u[n]=ad[n].bind(u);const Zy=u.recordState;u.recordState=function(...n){Zy.apply(this,n),mp(this.state)};fp||mp(u.state);const Qy=Object.freeze(Object.defineProperty({__proto__:null,default:u},Symbol.toStringTag,{value:"Module"})),Oc=[{pitch:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fef1f5"},{pitch:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fbf2fa"},{pitch:"B♭/A♯7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f6f3fd"},{pitch:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f1f5ff"},{pitch:"A♭/G♯7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#edf7fe"},{pitch:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#ebf8fa"},{pitch:"G♭/F♯7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#ecf8f5"},{pitch:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#eff8f0"},{pitch:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#f4f7ec"},{pitch:"E♭/D♯7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#f9f5eb"},{pitch:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#fdf3ec"},{pitch:"D♭/C♯7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fef2f0"},{pitch:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#fef1f5"},{pitch:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#f0d1ec"},{pitch:"B♭/A♯6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#e1d6f9"},{pitch:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#cfdcff"},{pitch:"A♭/G♯6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#bfe2fb"},{pitch:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#b7e6ef"},{pitch:"G♭/F♯6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#b9e8dd"},{pitch:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#c6e6cb"},{pitch:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#d8e2bd"},{pitch:"E♭/D♯6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#e9dcb7"},{pitch:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#f6d5bc"},{pitch:"D♭/C♯6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#fcd1c9"},{pitch:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#facfdb"},{pitch:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e6b2e1"},{pitch:"B♭/A♯5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#cebaf6"},{pitch:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#b0c4fe"},{pitch:"A♭/G♯5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#92cef8"},{pitch:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#7fd5e5"},{pitch:"G♭/F♯5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#84d8c8"},{pitch:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#9ed6a8"},{pitch:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#bece8f"},{pitch:"E♭/D♯5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#dbc484"},{pitch:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#f0b98d"},{pitch:"D♭/C♯5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#f9b1a5"},{pitch:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#f5afc3"},{pitch:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#db8fd4"},{pitch:"B♭/A♯4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#ba9bf2"},{pitch:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#8fa9ff"},{pitch:"A♭/G♯4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#58b8f6"},{pitch:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#16c3da"},{pitch:"G♭/F♯4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#2dc8b1"},{pitch:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#6ec482"},{pitch:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#a4ba57"},{pitch:"E♭/D♯4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#cdaa42"},{pitch:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#e89955"},{pitch:"D♭/C♯4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#f48e7d"},{pitch:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#ef8aab"},{pitch:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#be7cb8"},{pitch:"B♭/A♯3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#a286d2"},{pitch:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#7b93dd"},{pitch:"A♭/G♯3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#4c9fd6"},{pitch:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#13a9bd"},{pitch:"G♭/F♯3",toneNote:"Gb3",frequency:185,column:"A",hex:"#27ad99"},{pitch:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#5faa71"},{pitch:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#8ea14b"},{pitch:"E♭/D♯3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#b29338"},{pitch:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#ca8549"},{pitch:"D♭/C♯3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#d47a6c"},{pitch:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#cf7894"},{pitch:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#a46b9f"},{pitch:"B♭/A♯2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#8b73b6"},{pitch:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#6a7ebf"},{pitch:"A♭/G♯2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#4189b8"},{pitch:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#1092a3"},{pitch:"G♭/F♯2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#219584"},{pitch:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#519360"},{pitch:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#7a8b40"},{pitch:"E♭/D♯2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#997f30"},{pitch:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#ae723e"},{pitch:"D♭/C♯2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#b7695d"},{pitch:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#b3677f"},{pitch:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#6f466b"},{pitch:"B♭/A♯1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#5d4c7b"},{pitch:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#465482"},{pitch:"A♭/G♯1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#295c7d"},{pitch:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#06626e"},{pitch:"G♭/F♯1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#126458"},{pitch:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#34633f"},{pitch:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#515d28"},{pitch:"E♭/D♯1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#67541d"},{pitch:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#764c27"},{pitch:"D♭/C♯1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#7c453d"},{pitch:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#794455"}];let pc=null,mc=null;const hh={setContexts({ctx:n,drumCtx:e}){pc=n,mc=e},getPitchContext(){return pc||console.error("CanvasContextService: Pitch context requested before it was set."),pc},getDrumContext(){return mc||console.error("CanvasContextService: Drum context requested before it was set."),mc}},ni=Ki,Zs={blend:2,cutoff:31,resonance:0,type:"lowpass"};function vr(){return{coeffs:new Float32Array(ni).fill(0),phases:new Float32Array(ni).fill(0)}}function Jy(){const n=vr();return n.coeffs[0]=1,n}function Ky(){const n=vr();for(let e=1;e<=ni;e+=2){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=0}return n}function t0(){const n=vr();for(let e=1;e<=ni;e+=2){const s=e-1;n.coeffs[s]=1/(e*e),n.phases[s]=Math.PI/2}return n}function e0(){const n=vr();for(let e=1;e<=ni;e++){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=e&1?0:Math.PI}return n}const s0={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function Yr(n){const e=vr(),s=s0[n],o=Math.min(ni,s.amps.length);for(let r=0;r<o;r++)e.coeffs[r]=s.amps[r]||0,e.phases[r]=s.phases[r]||0;return e}const qo={attack:.1,decay:.2,sustain:.8,release:.3},n0={sine:{name:"sine",gain:1,adsr:qo,...Jy(),filter:{...Zs}},triangle:{name:"triangle",gain:.81,adsr:qo,...t0(),filter:{...Zs}},square:{name:"square",gain:4/Math.PI,adsr:qo,...Ky(),filter:{...Zs}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:qo,...e0(),filter:{...Zs}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:qo,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(ni).fill(0),filter:{...Zs}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...Zs}},strings:{name:"strings",gain:.49,adsr:{attack:.03,decay:.4,sustain:.7,release:.5},...Yr("strings"),filter:{...Zs,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:.8,sustain:.1,release:1},...Yr("piano"),filter:{...Zs,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.8},...Yr("marimba"),filter:{...Zs,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...Yr("woodwind"),filter:{...Zs}}};function qs(n,e){if(!n)return`rgba(204, 204, 204, ${e})`;const s=parseInt(n.slice(Gd,zu),na),o=parseInt(n.slice(zu,Wu),na),r=parseInt(n.slice(Wu,sv),na);return`rgba(${s}, ${o}, ${r}, ${e})`}function Pa(n,e){if(!n||typeof n!="string")return ev;const s=parseInt(n.slice(Gd),na),o=e<0?nv:iv,r=e<0?e*-1:e,a=s>>16,c=s>>8&255,h=s&255;return"#"+(16777216+(Math.round((o-a)*r)+a)*65536+(Math.round((o-c)*r)+c)*256+(Math.round((o-h)*r)+h)).toString(16).slice(1)}const i0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,o0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,r0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,a0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`;T.moduleLoaded("HarmonicBins with Columnar Structure");const la={0:i0,90:o0,180:r0,270:a0},Is=Ki;let Ve,Me,we=new Float32Array(Is).fill(0),Zt,Je=new Float32Array(Is).fill(0);const uh=[],Nc=[];let Wi=!1,Ms=null;const $i=new Array(Is).fill(null);function Uo(n,e){const{blend:s,cutoff:o,resonance:r}=e,a=(o-1)/30,c=8,h=n-a,m=a-n,f=1/(1+Math.pow(Math.max(0,h*c),2)),g=1/(1+Math.pow(Math.max(0,m*c),2)),b=f*g;let w;s<=1?w=g*(1-s)+b*s:w=b*(2-s)+f*(s-1);const x=1-(r||0)/105,A=Math.max(.01,.2*x*x),I=Math.exp(-Math.pow((n-a)/A,2)),k=(r||0)/100*.6,P=w+I*k;return Math.max(0,Math.min(1,P))}function l0(n,e){const s=e/100;return 1-s+s*n}let fc=new Float32Array(Is).fill(1);new Float32Array(Is).fill(0);function va(n,e){const s=e.mix||0;if(s===0)return new Float32Array(n);const o=new Float32Array(n.length),r=s/100;for(let a=0;a<n.length;a++){const c=n[a],h=(a+.5)/Is,m=Uo(h,e);if(m<c){const g=(c-m)*r;o[a]=c-g}else o[a]=c;o[a]=Math.max(0,o[a])}return o}function ya(n){const e=u.state.timbres[n];if(!e)return new Float32Array(Is);const s=e.filter;return s&&s.enabled!==!1&&(s.mix||0)>0?va(e.coeffs,s):new Float32Array(e.coeffs)}function Lc(){var h;if((!Ve||!Me||!Ms)&&(Ve=document.getElementById("filter-overlay-canvas"),Ms=document.querySelector(".harmonic-bins-grid"),Ve&&(Me=Ve.getContext("2d"))),!Ve||!Me||!Ms)return;Ms.getBoundingClientRect();const{width:n,height:e}=Ve;Me.clearRect(0,0,n,e);const o=e*.95,r=e,a=(h=u.state.timbres[Zt])==null?void 0:h.filter,c=a&&a.enabled!==!1;if(a&&c){const m=a.mix||0;if(m===0){fc.fill(1);return}for(let x=0;x<Is;x++){const A=(x+.5)/Is,I=Uo(A,a);fc[x]=l0(I,m)}Me.beginPath();const f=2;for(let x=0;x<=n;x+=f){const A=x/n,I=Uo(A,a),k=r-I*o;x===0?Me.moveTo(x,k):Me.lineTo(x,k)}const b=.4+m/100*.6;Me.strokeStyle=qs(Pa(Zt,-.3),b),Me.lineWidth=2.5,Me.stroke();const w=m/100;if(w>0){Me.beginPath(),Me.moveTo(0,0),Me.lineTo(n,0);const x=Uo(1,a),A=r-x*o;Me.lineTo(n,A);for(let I=n;I>=0;I-=2){const k=I/n,P=Uo(k,a),O=r-P*o;Me.lineTo(I,O)}Me.closePath(),Me.fillStyle=`rgba(255, 255, 255, ${w})`,Me.fill()}}else fc.fill(1)}function ba(){uh.forEach((n,e)=>{const s=n.sliderTrack.querySelector(".slider-fill"),o=n.sliderTrack.querySelector(".harmonic-label-internal"),r=we[e];if(s.style.height=`${r*100}%`,r>0){const c=Pa(Zt,-.1);s.style.backgroundColor=qs(c,1)}else s.style.backgroundColor="transparent";const a=s.querySelector("canvas");a&&a.remove(),r>.1?(o.style.color="#ffffff",o.style.textShadow="0 0 2px rgba(0,0,0,0.5)"):(o.style.color="#333333",o.style.textShadow="0 0 1px rgba(255,255,255,0.5)")}),Lc()}function ld(n,e=null){var f,g,b,w;if(T.debug("HarmonicBins","handleBinPointerEvent called",{target:n.target.className},"filter"),n.target.classList.contains("phase-button")||n.target.closest(".phase-button")||n.target.tagName==="path"||n.target.tagName==="svg"){T.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(e===null){const x=Ms.getBoundingClientRect(),A=n.clientX-x.left,I=x.width/Is;e=Math.floor(A/I),e=Math.max(0,Math.min(Is-1,e))}T.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:e},"filter");const o=uh[e].sliderTrack.getBoundingClientRect(),r=n.clientY-o.top,c=o.height;we[e];const h=(c-r)/c;let m=Math.max(0,Math.min(1,h));if((((g=(f=u.state.timbres[Zt])==null?void 0:f.adsr)==null?void 0:g.release)||0)*1e3,m===0){T.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:e},"filter");const x=new Float32Array(u.state.timbres[Zt].coeffs);x[e]=0,we[e]=0,u.setHarmonicCoefficients(Zt,x),$i[e]&&(clearTimeout($i[e]),$i[e]=null),Wi||(ee.triggerAttack("C4",Zt),u.emit("spacebarPlayback",{color:Zt,isPlaying:!0}),Wi=!0);const A=(b=u.state.timbres[Zt])==null?void 0:b.filter;A&&A.enabled!==!1&&(A.mix||0)>0&&va(x,A),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),T.debug("HarmonicBins",`Set coefficient H${e+1} to 0 for color ${Zt}`,null,"filter")}else{$i[e]&&(clearTimeout($i[e]),$i[e]=null),Wi||(ee.triggerAttack("C4",Zt),u.emit("spacebarPlayback",{color:Zt,isPlaying:!0}),Wi=!0),T.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:u.state.timbres[Zt].coeffs},"filter");const x=new Float32Array(u.state.timbres[Zt].coeffs);T.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:x},"filter"),x[e]=m,we[e]=m,T.debug("HarmonicBins",`AFTER setting newCoeffs[${e}] = ${m}`,{newCoeffs:x},"filter"),u.setHarmonicCoefficients(Zt,x);const A=(w=u.state.timbres[Zt])==null?void 0:w.filter;A&&A.enabled!==!1&&(A.mix||0)>0&&va(x,A),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),T.debug("HarmonicBins",`Updated coefficient H${e+1} to ${m} for color ${Zt}`,null,"filter"),T.debug("HarmonicBins","All coefficients",{newCoeffs:x},"filter")}ba()}function Fc(n,e,s,o){const r=s.coeffs,a=s.phases||new Float32Array(r.length).fill(0);let c=!0,h=!0;if(n.length!==r.length)c=!1;else for(let f=0;f<n.length;f++)if(Math.abs(n[f]-r[f])>.001){c=!1;break}if(e.length!==a.length)h=!1;else for(let f=0;f<e.length;f++)if(Math.abs(e[f]-a[f])>.001){h=!1;break}return c&&h}function cd(n){if(!n)return;Zt=n;const e=u.state.timbres[n];e&&(e.filter?e.filter.enabled===void 0&&(e.filter.enabled=!0):e.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0},T.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:e.coeffs},"filter"),T.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:e.phases},"filter"),we&&Array.from(we),Je&&Array.from(Je),we=new Float32Array(e.coeffs),e.phases?Je=new Float32Array(e.phases):Je=new Float32Array(we.length).fill(0),Fc(we,Je,e),T.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:we},"filter"),T.debug("HarmonicBins","updateForNewColor - final phases",{phases:Je},"filter"),Nc.forEach(({phaseBtn:s},o)=>{if(!s)return;let a=(Je[o]||0)%(2*Math.PI);a<0&&(a+=2*Math.PI);const c=.1;let h=0;Math.abs(a-Math.PI/2)<c?h=90:Math.abs(a-Math.PI)<c?h=180:Math.abs(a-3*Math.PI/2)<c&&(h=270),s.innerHTML=la[h]}),ba())}function c0(){var o;const n=document.querySelector(".harmonic-bins-container"),e=n==null?void 0:n.querySelector(".filter-main-panel");if(!n||!e)return;Ms=document.createElement("div"),Ms.className="harmonic-bins-grid";for(let r=0;r<Is;r++){const a=document.createElement("div");a.className="slider-column";const c=document.createElement("div");c.className="slider-track";const h=document.createElement("div");h.className="slider-fill",c.appendChild(h);const m=document.createElement("div");m.className="harmonic-label-internal",m.textContent=`${r+1}`,c.appendChild(m),a.appendChild(c);const f=document.createElement("button");f.className="phase-button",f.innerHTML=la[0],f.addEventListener("click",g=>{T.debug("HarmonicBins","Phase button click handler started",null,"filter"),T.debug("HarmonicBins","Current coeffs before phase change",{coeffs:we},"filter"),g.preventDefault(),g.stopPropagation();const b=new Float32Array(Je),w=new Float32Array(Je);let A=(w[r]||0)%(2*Math.PI);A<0&&(A+=2*Math.PI);const I=.1;let k=0;Math.abs(A)<I?k=Math.PI/2:Math.abs(A-Math.PI/2)<I?k=Math.PI:Math.abs(A-Math.PI)<I?k=3*Math.PI/2:k=0,w[r]=k,Je=w,window.staticWaveformVisualizer&&window.staticWaveformVisualizer.startPhaseTransition&&window.staticWaveformVisualizer.startPhaseTransition(b,w,r),u.setHarmonicPhases(Zt,w);const P=k===0?0:Math.abs(k-Math.PI/2)<I?90:Math.abs(k-Math.PI)<I?180:270;f.innerHTML=la[P],T.debug("HarmonicBins",`Phase button clicked for H${r+1}, new phase: ${P}°`,null,"filter")}),a.appendChild(f),Ms.appendChild(a),uh.push({column:a,label:m,sliderTrack:c,sliderFill:h,phaseBtn:f}),Nc.push({phaseBtn:f})}Ms.addEventListener("pointerdown",r=>{if(r.target.classList.contains("phase-button")||r.target.closest(".phase-button")){T.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}T.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),r.preventDefault(),ee.triggerAttack("C4",Zt),u.emit("spacebarPlayback",{color:Zt,isPlaying:!0}),Wi=!0,ld(r);const a=h=>ld(h),c=()=>{window.removeEventListener("pointermove",a),window.removeEventListener("pointerup",c),u.recordState(),ee.triggerRelease("C4",Zt),u.emit("spacebarPlayback",{color:Zt,isPlaying:!1}),Wi=!1};window.addEventListener("pointermove",a),window.addEventListener("pointerup",c)}),Ve=document.createElement("canvas"),Ve.id="filter-overlay-canvas",Ve.className="filter-overlay-canvas",Ve.style.pointerEvents="none",Me=Ve.getContext("2d"),Ms.appendChild(Ve),e.prepend(Ms);const s=()=>{const r=Ve.getBoundingClientRect();(Ve.width!==r.width||Ve.height!==r.height)&&(Ve.width=r.width,Ve.height=r.height,Lc())};Zt=((o=u.state.selectedNote)==null?void 0:o.color)||"#4a90e2",cd(Zt),u.on("timbreChanged",r=>{if(r===Zt){T.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const a=u.state.timbres[r],c=a.coeffs,h=a.phases;let m=!1;if(T.debug("HarmonicBins","Comparing coefficients...",null,"filter"),T.debug("HarmonicBins","Local coeffs",{coeffs:we},"filter"),T.debug("HarmonicBins","Store coeffs",{newCoeffs:c},"filter"),!we||we.length!==c.length)T.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),m=!0;else for(let f=0;f<c.length;f++){const g=Math.abs(we[f]-c[f]);if(g>.001){T.debug("HarmonicBins",`Coefficient ${f} changed: ${we[f]} -> ${c[f]} (diff: ${g})`,null,"filter"),m=!0;break}}T.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),Fc(we||new Float32Array(12),Je||new Float32Array(12),a),we=new Float32Array(c),h?Je=new Float32Array(h):Je=new Float32Array(we.length).fill(0),Fc(we,Je,a),m?(T.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),ba()):(T.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),Lc()),Nc.forEach(({phaseBtn:f},g)=>{if(!f)return;let w=(Je[g]||0)%(2*Math.PI);w<0&&(w+=2*Math.PI);const x=.1;let A=0;Math.abs(w-Math.PI/2)<x?A=90:Math.abs(w-Math.PI)<x?A=180:Math.abs(w-3*Math.PI/2)<x&&(A=270),f.innerHTML=la[A]})}}),u.on("noteChanged",({newNote:r})=>{r.color&&r.color!==Zt&&cd(r.color)}),u.on("filterChanged",r=>{if(r===Zt){ba();const a=u.state.timbres[Zt],c=a==null?void 0:a.filter;c&&c.enabled!==!1&&(c.mix||0)>0?va(a.coeffs,c):new Float32Array(a.coeffs)}}),new ResizeObserver(s).observe(Ms),s(),T.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}T.moduleLoaded("SynthEngine");const er=8,gp=1/Math.sqrt(er),h0=200,u0=50;let Qs={},On,Bi,gc,Zr,vc,Ze={},Vi=0,zo=er;function d0(){if(!On)return;const n=J.now();if(Vi===0){zo=.01*er+(1-.01)*zo;return}const e=1-Math.exp(-.016/(h0/1e3)),s=Math.max(1,Math.min(er,Vi));zo=e*s+(1-e)*zo;const o=Math.sqrt(er/zo),r=gp*o;On.gain.rampTo(r,u0/1e3,n)}class p0 extends J.Synth{constructor(e){super(e),this.presetGain=new J.Gain(e.gain||1),this.vibratoLFO=new J.LFO(0,0),this.vibratoDepth=new J.Scale(-1,1),this.vibratoGain=new J.Gain(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new J.LFO(0,0),this.tremoloDepth=new J.Scale(0,1),this.tremoloGain=new J.Gain(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new J.Filter({type:"highpass"}),this.lpFilterForBP=new J.Filter({type:"lowpass"}),this.lpFilterSolo=new J.Filter({type:"lowpass"}),this.hpOutput=new J.Gain,this.bpOutput=new J.Gain,this.lpOutput=new J.Gain,this.hp_bp_fade=new J.CrossFade(0),this.main_fade=new J.CrossFade(0),this.wetDryFade=new J.CrossFade(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),e.filter&&this._setFilter(e.filter),e.vibrato?this._setVibrato(e.vibrato):this._setVibrato({speed:0,span:0}),e.tremelo?this._setTremolo(e.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(e){this.presetGain&&(this.presetGain.gain.value=e)}_setVibrato(e,s=J.now()){if(this.vibratoLFO&&this.vibratoGain){const o=e.speed/100*16;if(e.speed===0||e.span===0){this.vibratoLFO.stop(s),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(s),this.vibratoLFO.frequency.value=o;const c=e.span/100*50/1200,f=440*(Math.pow(2,c)-1);this.vibratoGain.gain.value=f}}_setTremolo(e,s=J.now()){if(this.tremoloLFO&&this.tremoloGain){const o=e.speed/100*16;if(e.speed===0||e.span===0){this.tremoloLFO.stop(s),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(s),this.tremoloGain.gain.value=1;return}this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(s),this.tremoloLFO.frequency.value=o;const r=e.span/100,a=Math.max(0,1-r),c=1;this.tremoloDepth.min=a,this.tremoloDepth.max=c}}_setFilter(e){this.wetDryFade.fade.value=e.enabled?1:0;const s=J.Midi(e.cutoff+35).toFrequency(),o=e.resonance/100*12+.1;this.hpFilter.set({frequency:s,Q:o}),this.lpFilterForBP.set({frequency:s,Q:o}),this.lpFilterSolo.set({frequency:s,Q:o});const r=e.blend;r<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=r):(this.main_fade.fade.value=r-1,this.hp_bp_fade.fade.value=1)}}const ee={init(){On=new J.Gain(gp),Bi=new J.Volume(0),gc=new J.Compressor({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),Zr=new J.Limiter(-3),vc=new J.Meter,On.connect(Bi),Bi.connect(gc),gc.connect(Zr),Zr.toDestination(),Zr.connect(vc),setInterval(()=>{vc.getValue()},500);for(const e in u.state.timbres){const s=u.state.timbres[e],o=ya(e),r=o.reduce((f,g)=>f+Math.abs(g),0),a=r>1?o.map(f=>f/r):o,c=s.gain||1,h=new J.PolySynth({polyphony:8,voice:p0,options:{oscillator:{type:"custom",partials:Array.from(a)},envelope:s.adsr,filter:s.filter,vibrato:s.vibrato,tremelo:s.tremelo,gain:c}}).connect(On);window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(h,e,On);const m=h.triggerAttack;h.triggerAttack=function(...f){const g=m.apply(this,f);return setTimeout(()=>{const b=this._activeVoices;window.audioEffectsManager?b&&b.size>0?b.forEach((w,x)=>{w.effectsApplied||(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,x)=>{w&&!w.effectsApplied&&(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):b&&b.size>0?b.forEach((w,x)=>{w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,x)=>{w&&w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w&&w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)})},10),g},h._currentVibrato=s.vibrato,h._currentTremolo=s.tremelo,h._currentFilter=s.filter,Qs[e]=h,T.debug("SynthEngine",`Created filtered synth for color: ${e}`,null,"audio")}u.on("timbreChanged",e=>{this.updateSynthForColor(e)}),u.on("filterChanged",e=>{this.updateSynthForColor(e)}),u.on("audioEffectChanged",({effectType:e,parameter:s,value:o,color:r,effectParams:a})=>{this.updateSynthForColor(r)}),u.on("volumeChanged",e=>this.setVolume(e)),setInterval(()=>{d0()},16),T.info("SynthEngine","Initialized with multi-timbral support",null,"audio"),window.synthEngine=this},updateSynthForColor(n){const e=u.state.timbres[n],s=Qs[n];if(!s||!e)return;e.vibrato||(e.vibrato={speed:0,span:0},T.debug("SynthEngine",`Initialized vibrato for color ${n}`,e.vibrato,"audio")),e.tremelo||(e.tremelo={speed:0,span:0},T.debug("SynthEngine",`Initialized tremolo for color ${n}`,e.tremelo,"audio")),T.debug("SynthEngine",`Updating timbre for color ${n}`,null,"audio");const o=ya(n),r=o.reduce((h,m)=>h+Math.abs(m),0),a=r>1?o.map(h=>h/r):o;s.set({oscillator:{partials:Array.from(a)},envelope:e.adsr}),window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(s,n,On),s._currentVibrato=e.vibrato,s._currentTremolo=e.tremelo,s._currentFilter=e.filter;const c=s._activeVoices;c&&c.size>0?c.forEach((h,m)=>{if(h._setFilter&&h._setFilter(e.filter),h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}}):s._voices&&Array.isArray(s._voices)&&s._voices.forEach((h,m)=>{if(h&&h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h&&h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h&&h._setFilter&&h._setFilter(e.filter),h&&h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}})},setVolume(n){Bi&&(Bi.volume.value=n)},async playNote(n,e,s=J.now()){var c;await(window.initAudio||(()=>J.start()))();const r=(c=u.state.selectedNote)==null?void 0:c.color,a=r?Qs[r]:null;a&&a.triggerAttackRelease(n,e,s)},triggerAttack(n,e,s=J.now(),o=!1){const r=Qs[e];if(r)if(Vi++,o&&window.getDrumVolume){const a=window.getDrumVolume(),c=r.volume.value,h=c+20*Math.log10(a);r.volume.value=h,r.triggerAttack(n,s),setTimeout(()=>{r&&r.volume&&(r.volume.value=c)},100)}else r.triggerAttack(n,s)},triggerRelease(n,e,s=J.now()){const o=Qs[e];o&&(o.triggerRelease(n,s),Vi=Math.max(0,Vi-1))},releaseAll(){for(const n in Qs)Qs[n].releaseAll();Vi=0},createWaveformAnalyzer(n){const e=Qs[n];return e?(Ze[n]||(Ze[n]=new J.Analyser("waveform",1024),e.connect(Ze[n]),T.debug("SynthEngine",`Created waveform analyzer for color: ${n}`,null,"waveform")),Ze[n]):(T.warn("SynthEngine",`No synth found for color: ${n}`,null,"audio"),null)},getWaveformAnalyzer(n){return Ze[n]||null},getAllWaveformAnalyzers(){const n=new Map;for(const e in Ze)Ze[e]&&n.set(e,Ze[e]);return n},removeWaveformAnalyzer(n){Ze[n]&&(Ze[n].dispose(),delete Ze[n],T.debug("SynthEngine",`Removed waveform analyzer for color: ${n}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const n in Ze)Ze[n]&&Ze[n].dispose();Ze={},T.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(n){return Qs[n]||null},getAllSynths(){return{...Qs}},getMainVolumeNode(){return Bi||null},getMasterGainNode(){return On||null}},Ps={adsrComponent:null};class m0{constructor(){this.elements=new Map,this.initialized=!1}init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("pitchPaintCanvas","pitch-paint-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("gridContainer","grid-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicDropdownContainer","tonic-dropdown-container"),this.cacheElement("tonicDropdownButton","tonic-dropdown-button"),this.cacheElement("tonicDropdownLabel","tonic-dropdown-label"),this.cacheElement("tonicDropdownMenu","tonic-dropdown-menu"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(e,s){const o=document.getElementById(s);o&&this.elements.set(e,o)}get(e){return this.initialized&&this.elements.get(e)||null}getMultiple(...e){const s={};return e.forEach(o=>{s[o]=this.get(o)}),s}has(e){return this.elements.has(e)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const e=this.elements.size,s=Array.from(this.elements.values()).filter(o=>o!==null).length;return{totalCached:e,foundElements:s,missingElements:e-s}}}const ii=new m0;u.on("modulationMarkersChanged",()=>{v0()});u.on("scrollChanged",()=>{sr=null,nr=null});u.on("zoomChanged",()=>{sr=null,nr=null});let Xo=null,$c=null,sr=null,nr=null;function vp(n){const e=JSON.stringify({markers:n.modulationMarkers||[],baseMicrobeatPx:n.baseMicrobeatPx||n.cellWidth||40});if(Xo&&e===$c)return Xo;const s=n.baseMicrobeatPx||n.cellWidth||40;return Xo=pp(n.modulationMarkers||[],s,n),$c=e,Xo}function yp(){const n=performance.now();return(!sr||!nr||n-nr>1)&&(sr=Lt.getViewportInfo(),nr=n),sr}function ft(n,e){let s=0;const o=Math.floor(n),r=n-o;for(let f=0;f<o;f++){const g=e.columnWidths[f]||0;s+=g*e.cellWidth}if(r>0&&o<e.columnWidths.length){const f=e.columnWidths[o]||0;s+=r*f*e.cellWidth}if(!e.modulationMarkers||e.modulationMarkers.length===0)return s;const a=vp(e),c=e.baseMicrobeatPx||e.cellWidth||40,h=s/c;return a.microbeatToCanvasX(h)}function Nt(n,e){const s=yp(),o=n-s.startRank,r=e.cellHeight/2;return o*r}function ca(n){let e=(n||"").replace(/\d/g,"").trim();return e=e.replace(/b/g,"♭").replace(/#/g,"♯"),e}function f0(n,e=1){switch(n){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"E♭/D♯":case"D♭/C♯":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function g0(){const n=Lt.getViewportInfo(),{startRank:e,endRank:s}=n;return{startRow:e,endRow:s}}function v0(){Xo=null,$c=null}function y0(n,e){if(e.modulationMarkers&&e.modulationMarkers.length>0){const a=vp(e),c=e.baseMicrobeatPx||e.cellWidth||40;return a.canvasXToMicrobeat(n)*c/e.cellWidth}let s=0;const{columnWidths:o,cellWidth:r}=e;if(r===0)return 0;for(let a=0;a<o.length;a++){const c=o[a]*r;if(n<s+c){const h=(n-s)/c;return a+h}s+=c}return o.length-1}function b0(n,e){const s=yp(),o=e.cellHeight/2;return n/o+s.startRank}class _0{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.activeAnimations=new Map,this.popDuration={scaleUp:100,scaleDown:300},this.popScale=1.5}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),u.on("tempoChanged",()=>this.invalidateTimeMap()))}handlePlaybackStateChange(){u.state.isPlaying&&!u.state.isPaused?this.startRendering():this.stopRendering()}invalidateTimeMap(){this._lastTempo=0}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.isPlaying||u.state.isPaused||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.calculateXFromTime(J.Transport.seconds);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0,this.animationFrameId=requestAnimationFrame(()=>this.render())}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let o=0;o<u.state.columnWidths.length;o++)this.timeMap[o]=e,e+=u.state.columnWidths[o]*s;this.timeMap.push(e)}getColumnX(e){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const o={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return ft(e,o)}else return Lt.getColumnX(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const o=this.timeMap[s],r=this.timeMap[s+1]-o,a=e-o,c=this.getColumnX(s),h=this.getColumnX(s+1)-c;return c+(r>0?a/r*h:0)}return null}triggerNotePop(e,s){const o=`${e}-${s}`;this.activeAnimations.set(o,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(e,s){const o=`${e}-${s}`,r=this.activeAnimations.get(o);if(!r)return 1;const a=performance.now(),c=a-r.startTime;if(r.phase==="scaleUp"){if(c>=this.popDuration.scaleUp)return r.phase="scaleDown",r.startTime=a,this.popScale;{const h=c/this.popDuration.scaleUp;return 1+(this.popScale-1)*h}}else if(r.phase==="scaleDown"){if(c>=this.popDuration.scaleDown)return this.activeAnimations.delete(o),1;{const h=c/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*h}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const e=performance.now();for(const[s,o]of this.activeAnimations.entries()){const r=e-o.startTime,a=o.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;r>a&&this.activeAnimations.delete(s)}}}const $n=new _0,Bc=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function ka(n){return Bc.find(e=>e.id===n)}T.moduleLoaded("StampPlacements","stamps");function w0(n,e,s,o="#4a90e2"){return ka(n)?u.addStampPlacement(n,e,s,o):(T.warn("StampPlacements",`Invalid stamp ID: ${n}`,{stampId:n},"stamps"),null)}function x0(n,e,s,o){return console.log("[STAMP ERASE] Function called with:",{eraseStartCol:n,eraseEndCol:e,eraseStartRow:s,eraseEndRow:o,totalStamps:u.state.stampPlacements.length,allStampPlacements:u.state.stampPlacements.map(r=>({id:r.id,startCol:r.startColumn,endCol:r.endColumn,row:r.row}))}),u.eraseStampsInArea(n,e,s,o)}function S0(){u.clearAllStamps()}function C0(){return u.getStampPlaybackData()}T.moduleLoaded("StampScheduler","stamps");const Qr=["0","16n","8n",{"8n":1,"16n":1}];function bp(n,e=null){const s=ka(n);if(!s)return T.warn("StampScheduler",`Unknown stamp ID: ${n}`,{stampId:n},"stamps"),[];const o=[];return s.ovals.forEach(r=>{var h;const a=`oval_${r}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[a])||0;o.push({offset:Qr[r],duration:"8n",type:"oval",slot:r,shapeKey:a,rowOffset:c}),console.log(`[STAMP DEBUG] Stamp ${n} oval at slot ${r} with offset "${Qr[r]}", rowOffset: ${c}`)}),s.diamonds.forEach(r=>{var h;const a=`diamond_${r}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[a])||0;o.push({offset:Qr[r],duration:"16n",type:"diamond",slot:r,shapeKey:a,rowOffset:c}),console.log(`[STAMP DEBUG] Stamp ${n} diamond at slot ${r} with offset "${Qr[r]}", rowOffset: ${c}`)}),console.log(`[STAMP DEBUG] Total events for stamp ${n}:`,o.length,o),o}function hd(n,e,s){return[{id:e+0,span:n,hits:[0],label:`${s} [1]`},{id:e+1,span:n,hits:[1],label:`${s} [2]`},{id:e+2,span:n,hits:[2],label:`${s} [3]`},{id:e+3,span:n,hits:[0,1],label:`${s} [1 2]`},{id:e+4,span:n,hits:[1,2],label:`${s} [2 3]`},{id:e+5,span:n,hits:[0,2],label:`${s} [1 3]`},{id:e+6,span:n,hits:[0,1,2],label:`${s} [1 2 3]`}]}const qc=[...hd("eighth",1,"8th triplet"),...hd("quarter",8,"Quarter triplet")],_p={eighth:1,quarter:2},wp=[16.6667,50,83.3333];function oi(n){return qc.find(e=>e.id===n)}T.moduleLoaded("TripletPlacements","triplets");function T0(n,e,s,o="#4a90e2"){const r=oi(n);if(!r)return T.warn("TripletPlacements",`Invalid triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),null;const a=_p[r.span];if(!A0(e,a,s))return T.debug("TripletPlacements",`Cannot place triplet at cell ${e}, row ${s} - collision detected`,{tripletStampId:n,startCellIndex:e,row:s,span:a},"triplets"),null;const c={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,stampId:n,startCellIndex:e,span:a,row:s,color:o,timestamp:Date.now()};return u.addTripletPlacement(c)}function A0(n,e,s){const o=u.state;if(o.stampPlacements){for(const r of o.stampPlacements)if(r.row===s){const a=Math.floor(r.startColumn/2),c=Math.floor(r.endColumn/2);for(let h=0;h<e;h++){const m=n+h;if(m>=a&&m<=c)return!1}}}if(o.tripletPlacements){for(const r of o.tripletPlacements)if(r.row===s){const a=r.startCellIndex+r.span-1;if(!(n+e-1<r.startCellIndex||n>a))return!1}}return!0}function M0(n,e,s,o){const r=u.state;if(!r.tripletPlacements)return!1;const a=Math.floor(n/2),c=Math.floor(e/2),h=[];for(const m of r.tripletPlacements)m.row>=s&&m.row<=o&&(m.startCellIndex+m.span-1<a||m.startCellIndex>c||h.push(m.id));return h.length>0?(h.forEach(m=>u.removeTripletPlacement(m)),T.debug("TripletPlacements",`Erased ${h.length} triplet groups`,{removedIds:h,eraseArea:{eraseStartCell:a,eraseEndCell:c,eraseStartRow:s,eraseEndRow:o}},"triplets"),!0):!1}function E0(){const n=u.state;return n.tripletPlacements?n.tripletPlacements.map(e=>({startCellIndex:e.startCellIndex,stampId:e.stampId,row:e.row,color:e.color,span:e.span,placement:e})):[]}function P0(){u.clearAllTripletPlacements(),T.info("TripletPlacements","Cleared all triplet placements",null,"triplets")}T.moduleLoaded("TripletScheduler","triplets");function k0(n){return J.Time(`${n} * 4n`).toSeconds()}function xp(n,e=null){const s=oi(n);if(!s)return T.warn("TripletScheduler",`Unknown triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),[];const o=[],r=s.span==="eighth"?"8t":"4t",a=r;return s.hits.forEach(c=>{var g;const h=`triplet_${c}`,m=((g=e==null?void 0:e.shapeOffsets)==null?void 0:g[h])||0;let f;if(c===0)f="0";else if(c===1)f=r;else if(c===2){const b=J.Time(r).toSeconds();f=J.Time(b*2).toNotation()}else{const b=J.Time(r).toSeconds();f=J.Time(b*c).toNotation()}o.push({offset:f,duration:a,type:s.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:c,shapeKey:h,rowOffset:m}),T.debug("TripletScheduler",`Triplet stamp ${n} ${s.span} at slot ${c} with offset "${f}", rowOffset: ${m}`,"triplets")}),T.debug("TripletScheduler",`Total events for triplet stamp ${n}:`,o.length,"triplets"),o}function Sp(n,e){const{startCellIndex:s,stampId:o,pitch:r}=n,a=oi(o);if(!a){T.warn("TripletScheduler",`Cannot schedule unknown triplet stamp ID: ${o}`,{stampId:o},"triplets");return}const c=k0(s),h=a.span==="eighth"?"8t":"4t",m=J.Time(h).toSeconds();T.debug("TripletScheduler","Scheduling triplet group",{startCellIndex:s,stampId:o,pitch:r,groupStart:c,stepStr:h,stepSec:m,hits:a.hits},"triplets"),a.hits.forEach(f=>{const g=c+f*m;e.triggerAttackRelease(r,m,g),T.debug("TripletScheduler","Scheduled triplet note",{slot:f,triggerTime:g,duration:m,pitch:r},"triplets")})}function I0(n){n.forEach(e=>{Sp({startCellIndex:e.startCellIndex,stampId:e.stampId,pitch:e.pitch},e.synth)})}function zc(n){const e=oi(n);return e?_p[e.span]:1}function D0(n,e,s=[]){const o=zc(e);for(let r=0;r<o;r++){const a=n+r;if(s.some(h=>h.cellIndex===a||h.tripletGroup&&h.tripletGroup.startCellIndex<=a&&a<h.tripletGroup.startCellIndex+zc(h.tripletGroup.stampId)))return T.debug("TripletScheduler",`Triplet placement conflict at cell ${a}`,{startCellIndex:n,tripletStampId:e,span:o},"triplets"),!1}return!0}const R0=Object.freeze(Object.defineProperty({__proto__:null,canPlaceTripletGroup:D0,getTripletGroupSpan:zc,getTripletScheduleEvents:xp,scheduleTripletGroup:Sp,scheduleTripletGroups:I0},Symbol.toStringTag,{value:"Module"}));function Cp(n,e,s){const{cellWidth:o}=s,r=o*.25;if(!n.uuid)return 0;const a=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid);if(a.length===0)return 0;const c=[n,...a];return c.sort((m,f)=>{const g=parseInt(m.uuid.split("-")[1]),b=parseInt(f.uuid.split("-")[1]);return g-b}),c.findIndex(m=>m.uuid===n.uuid)*r}function Tp(n,e){const{cellHeight:s}=e;return(window.animationEffectsManager?window.animationEffectsManager.shouldAnimateNote(n):!1)?(window.animationEffectsManager?window.animationEffectsManager.getVibratoYOffset(n.color):0)*s:0}function O0(n,e,s){const{cellHeight:o}=s,r=o/2*.12;if(!n.uuid)return 0;const a=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid&&m.endColumnIndex>m.startColumnIndex);if(a.length===0)return 0;const c=[n,...a];return c.sort((m,f)=>{const g=parseInt(m.uuid.split("-")[1]),b=parseInt(f.uuid.split("-")[1]);return g-b}),c.findIndex(m=>m.uuid===n.uuid)*r}function Ap(n,e,s,o,r,a){var m;console.log("🎵 [SCALE/MODE] drawScaleDegreeText called:",{degreeDisplayMode:s.degreeDisplayMode,noteRow:e.row,noteStartCol:e.startColumnIndex,pitch:(m=s.fullRowData[e.row])==null?void 0:m.pitch});const c=Rc.getDegreeForNote(e,s);if(console.log("🎵 [SCALE/MODE] TonalService returned:",{degreeStr:c,degreeDisplayMode:s.degreeDisplayMode}),!c)return;const h=(e.shape==="oval"?a*Xg:a*Yg)*s.zoomLevel;h<Zg||(n.fillStyle="#212529",n.font=`bold ${h}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(c,o,r))}function dh(n,e,s,o){const{cellWidth:r,cellHeight:a,zoomLevel:c}=e,h=Nt(o,e),m=Tp(s,e),f=h+m,g=ft(s.startColumnIndex,e);let b;e.modulationMarkers&&e.modulationMarkers.length>0?b=ft(s.startColumnIndex+1,e)-g:b=r;const w=Cp(s,u.state.placedNotes,e),x=g+b+w,A=Math.max(Qg,b*Jg);if(s.endColumnIndex>s.startColumnIndex){const O=ft(s.endColumnIndex+1,e)+w-w,N=O0(s,u.state.placedNotes,e),H=f+N;n.beginPath(),n.moveTo(x,H),n.lineTo(O,H),n.strokeStyle=s.color,n.lineWidth=Math.max(tv,b*Kg),n.stroke()}const I=b-A/2,k=a/2-A/2;n.save(),n.beginPath(),n.ellipse(x,f,I,k,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=Hd,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Ap(n,s,e,x,f,a/2)}function ph(n,e,s,o){const{columnWidths:r,cellWidth:a,cellHeight:c,zoomLevel:h}=e,m=Nt(o,e),f=Tp(s,e),g=m+f,b=ft(s.startColumnIndex,e);let w;e.modulationMarkers&&e.modulationMarkers.length>0?w=ft(s.startColumnIndex+1,e)-b:w=r[s.startColumnIndex]*a;const x=Cp(s,u.state.placedNotes,e),A=Math.max(.5,w*.15),I=b+w/2+x,k=w/2-A/2,P=c/2-A/2;n.save(),n.beginPath(),n.ellipse(I,g,k,P,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=Hd,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Ap(n,s,e,I,g,c/2)}function mh(n,e,s){const{cellWidth:o,cellHeight:r}=e,a=Nt(s.row,e),c=ft(s.columnIndex,e);let h;e.modulationMarkers&&e.modulationMarkers.length>0?h=ft(s.columnIndex+1,e)-c:h=o;const m=h*2,f=c+m/2,g=Math.min(m,r)/2*.9;if(g<2||(n.beginPath(),n.arc(f,a,g,0,2*Math.PI),n.strokeStyle="#212529",n.lineWidth=Math.max(.5,h*.05),n.stroke(),!s.tonicNumber))return;const b=s.tonicNumber.toString(),w=g*1.5;w<6||(n.fillStyle="#212529",n.font=`bold ${w}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(b,f,a))}function yc(n){let e=0;for(let s=0;s<n;s++){const o=u.state.columnWidths[s]||0;e+=o*u.state.cellWidth}return e}function bc(n){const e=u.state.fullRowData[n];return e?e.toneNote.replace("♭","b").replace("♯","#"):"C4"}T.moduleLoaded("TransportService");let Bs,ir,ae=[];function fh(){return 60/(u.state.tempo*2)}function N0(){if(!u.state.hasAnacrusis)return ae[2]||0;for(let n=0;n<u.state.macrobeatBoundaryStyles.length;n++)if(u.state.macrobeatBoundaryStyles[n]==="solid"){const e=is(u.state,n+1);if(e)return ae[e.startColumn]||0}return ae[2]||0}function Wc(){var r;T.debug("transportService","calculateTimeMap",{tempo:`${u.state.tempo} BPM`}),ae=[];const n=fh(),{columnWidths:e,modulationMarkers:s}=u.state,o=sn(u.state);s&&s.length>0,L0(n,e,o),T.timing("transportService","calculateTimeMap",{totalDuration:`${(r=ae[ae.length-1])==null?void 0:r.toFixed(2)}s`})}function L0(n,e,s){let o=0;for(let r=0;r<e.length;r++)ae[r]=o,s.some(c=>c.columnIndex===r)||(o+=e[r]*n);ae.push(o)}function F0(n,e,s){let o=0;for(let r=0;r<n;r++){const a=e[r]||0;o+=a*s}return o}function ud(n){const{modulationMarkers:e}=u.state;if(!e||e.length===0)return ae[n];const s=fh(),o=u.state.baseMicrobeatPx||u.state.cellWidth||40,r=pp(e,o,u.state),a=F0(n,u.state.columnWidths,o);return By(a,r,s)}function $0(n){const e=u.state.fullRowData;return e&&e[n.row]?e[n.row].toneNote.replace("♭","b").replace("♯","#"):"C4"}function _c(){var m,f;T.debug("transportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),J.Transport.cancel(),Wc(),(m=Ps.adsrComponent)==null||m.playheadManager.clearAll();const n=ae[2]||0,e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,s=(f=u.state.lassoSelection)==null?void 0:f.isActive,o=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="note").map(g=>g.id)):null;u.state.placedNotes.forEach(g=>{var k;if(s){const P=`note-${g.row}-${g.columnIndex}-${g.color}-${g.shape}`;if(!o.has(P))return}const b=ae[g.startColumnIndex];if(e&&ud(g.startColumnIndex),b===void 0)return;if(b<n){T.debug("transportService",`Skipping note at column ${g.startColumnIndex} (regular time ${b}) - before anacrusis offset (${n})`);return}const w=b;let x;const A=ae[g.endColumnIndex+1];if(e&&ud(g.endColumnIndex+1),A===void 0){T.warn("TransportService",`Skipping note with invalid endColumnIndex: ${g.endColumnIndex+1} (note ends at ${g.endColumnIndex})`,{noteId:g.uuid,startColumnIndex:g.startColumnIndex,endColumnIndex:g.endColumnIndex,lookupIndex:g.endColumnIndex+1,timeMapLength:ae.length,maxValidIndex:ae.length-1,noteShape:g.shape},"audio");return}const I=A-b;if(g.shape==="circle"?(x=I,fh()):x=I,g.isDrum)J.Transport.schedule(P=>{var O;u.state.isPaused||((O=ir==null?void 0:ir.player(g.drumTrack))==null||O.start(P),$n.triggerNotePop(g.startColumnIndex,g.drumTrack))},w);else{const P=$0(g),O=g.color,N=((k=u.state.fullRowData[g.row])==null?void 0:k.hex)||"#888888",H=g.uuid,G=u.state.timbres[O];if(!G){T.warn("TransportService",`Timbre not found for color ${O}. Skipping note ${H}`,null,"audio");return}J.Transport.schedule(ut=>{var dt;u.state.isPaused||(ee.triggerAttack(P,O,ut),(dt=Ps.adsrComponent)==null||dt.playheadManager.trigger(H,"attack",N,G.adsr),u.emit("noteAttack",{noteId:H,color:O}))},w);const Y=w+x;J.Transport.schedule(ut=>{var dt;ee.triggerRelease(P,O,ut),(dt=Ps.adsrComponent)==null||dt.playheadManager.trigger(H,"release",N,G.adsr),u.emit("noteRelease",{noteId:H,color:O})},Y)}});const r=C0(),a=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="stamp").map(g=>g.id)):null;r.forEach(g=>{var x;if(s){const A=`stamp-${g.row}-${g.column}-${g.stampId}`;if(!a.has(A))return}const b=ae[g.column];if(b===void 0)return;if(b<n){T.debug("TransportService",`Skipping stamp at column ${g.column} - before anacrusis offset`);return}const w=bp(g.stampId,g.placement);w.forEach(A=>{const I=J.Time(A.offset).toSeconds(),k=J.Time(A.duration).toSeconds(),P=b+I,O=P+k,N=g.row+A.rowOffset,H=bc(N);J.Transport.schedule(G=>{u.state.isPaused||ee.triggerAttack(H,g.color,G)},P),J.Transport.schedule(G=>{u.state.isPaused||ee.triggerRelease(H,g.color,G)},O)}),T.debug("TransportService",`Scheduled stamp ${g.stampId} with ${w.length} events at column ${g.column}`,{stampId:g.stampId,column:g.column,basePitch:g.pitch,baseRow:g.row,startTime:b,events:w.length,hasShapeOffsets:!!((x=g.placement)!=null&&x.shapeOffsets)},"audio")});const c=E0(),h=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="triplet").map(g=>g.id)):null;c.forEach(g=>{var A,I,k;if(s){const P=`triplet-${g.row}-${g.column}-${g.tripletId}`;if(!h.has(P))return}const b=g.startCellIndex*2,w=ae[b];if(w===void 0)return;if(w<n){T.debug("TransportService",`Skipping triplet at cell ${g.startCellIndex} - before anacrusis offset`);return}console.log("[TRANSPORT DEBUG] Scheduling triplet:",{stampId:g.stampId,baseRow:g.row,hasPlacement:!!g.placement,hasShapeOffsets:!!((A=g.placement)!=null&&A.shapeOffsets),shapeOffsets:(I=g.placement)==null?void 0:I.shapeOffsets});const x=xp(g.stampId,g.placement);x.forEach(P=>{const O=J.Time(P.offset).toSeconds(),N=J.Time(P.duration).toSeconds(),H=w+O,G=H+N,Y=g.row+P.rowOffset,ut=bc(Y);console.log("[TRANSPORT DEBUG] Scheduling shape:",{slot:P.slot,rowOffset:P.rowOffset,baseRow:g.row,shapeRow:Y,shapePitch:ut}),J.Transport.schedule(dt=>{u.state.isPaused||ee.triggerAttack(ut,g.color,dt)},H),J.Transport.schedule(dt=>{u.state.isPaused||ee.triggerRelease(ut,g.color,dt)},G)}),T.debug("TransportService",`Scheduled triplet ${g.stampId} with ${x.length} events at cell ${g.startCellIndex}`,{stampId:g.stampId,cellIndex:g.startCellIndex,basePitch:bc(g.row),baseRow:g.row,startTime:w,events:x.length,hasShapeOffsets:!!((k=g.placement)!=null&&k.shapeOffsets)},"audio")}),T.debug("TransportService","scheduleNotes",`Finished scheduling ${u.state.placedNotes.length} notes, ${r.length} stamps, and ${c.length} triplets`,"audio")}function wc(){const n=ii.get("playheadCanvas");if(!n)return;const e=n.getContext("2d"),s=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,o=yc(u.state.columnWidths.length-2),r=ae[u.state.columnWidths.length-2]||0;let a=new Set;const c=u.state.tempo;let h=1;function m(){if(J.Transport.state!=="started"||!n)return;const f=u.state.isLooping,g=J.Transport.seconds;if(g>=r){T.info("TransportService","Playback reached end. Stopping playhead.",{currentTime:g,musicalDuration:r,isLooping:f},"transport"),Hi.stop();return}if(u.state.isPaused){Bs=requestAnimationFrame(m);return}e.clearRect(0,0,n.width,n.height);let b=g;if(f){const A=J.Transport.loopEnd-J.Transport.loopStart;A>0&&(b=(g-J.Transport.loopStart)%A+J.Transport.loopStart)}let w=0;for(let A=0;A<ae.length-1;A++)if(ae[A]!==void 0&&b>=ae[A]&&b<ae[A+1]){const I=ae[A],P=ae[A+1]-I,O=b-I,N=yc(A),H=yc(A+1)-N,G=P>0?O/P:0;w=N+G*H;break}const x=Math.min(w,o);if(s&&u.state.modulationMarkers)for(const A of u.state.modulationMarkers){if(!A.active)continue;const I=A.xPosition||477.5;if(x>=I&&!a.has(A.id)){a.add(A.id);let k;Math.abs(A.ratio-2/3)<.001||Math.abs(A.ratio-3/2)<.001,k=1/A.ratio,h*=k;const P=c*h;J.Transport.bpm.value=P}}x>0&&(e.strokeStyle="rgba(255,0,0,0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(x,0),e.lineTo(x,n.height),e.stroke()),Bs=requestAnimationFrame(m)}m()}const Hi={init(){const n=new J.Volume(0);if(ir=new J.Players({H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"}).connect(n),window.synthEngine){const e=window.synthEngine.getMainVolumeNode&&window.synthEngine.getMainVolumeNode();e?n.connect(e):n.toDestination()}else n.toDestination();window.drumVolumeNode=n,window.transportService={drumPlayers:ir},J.Transport.bpm.value=u.state.tempo,u.on("rhythmStructureChanged",()=>this.handleStateChange()),u.on("notesChanged",()=>this.handleStateChange()),u.on("stampPlacementsChanged",()=>this.handleStateChange()),u.on("modulationMarkersChanged",()=>this.handleStateChange()),u.on("tempoChanged",e=>{if(T.event("TransportService",`tempoChanged triggered with new value: ${e} BPM`,null,"transport"),J.Transport.state==="started"){T.info("TransportService","Tempo changed WHILE PLAYING. Resynchronizing transport...",null,"transport");const s=J.Transport.position;T.debug("TransportService",`Saved musical position: ${s}`,null,"transport"),J.Transport.pause(),T.debug("TransportService","Transport paused",null,"transport"),Bs&&(cancelAnimationFrame(Bs),Bs=null),J.Transport.bpm.value=e,T.debug("TransportService",`New BPM set to ${J.Transport.bpm.value}`,null,"transport"),_c(),J.Transport.start(void 0,s),T.debug("TransportService",`Transport restarted at musical position ${s}`,null,"transport"),u.state.paint.isMicPaintActive||wc()}else T.debug("TransportService","Tempo changed while stopped/paused. Updating BPM for next run",null,"transport"),J.Transport.bpm.value=e,Wc()}),u.on("loopingChanged",e=>J.Transport.loop=e),J.Transport.on("stop",()=>{var e;T.event("TransportService","Tone.Transport 'stop' fired. Resetting playback state",null,"transport"),u.setPlaybackState(!1,!1),(e=Ps.adsrComponent)==null||e.playheadManager.clearAll(),Bs&&(cancelAnimationFrame(Bs),Bs=null)}),T.info("TransportService","Initialized",null,"transport")},handleStateChange(){if(J.Transport.state==="started"){T.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling",null,"transport");const n=J.Transport.position;J.Transport.pause(),_c(),J.Transport.start(void 0,n)}else Wc()},start(){T.info("TransportService","Starting playback",null,"transport"),(window.initAudio||(()=>J.start()))().then(()=>{_c();const e=ae[u.state.columnWidths.length-2]||0,s=ae[2]||0,o=N0();J.Transport.loopStart=o,J.Transport.loopEnd=e,J.Transport.loop=u.state.isLooping,J.Transport.bpm.value=u.state.tempo,T.debug("TransportService",`Transport configured. Loop: ${J.Transport.loop}, BPM: ${J.Transport.bpm.value}, StartOffset: ${s}, LoopStart: ${o}`,null,"transport"),u.state.modulationMarkers&&u.state.modulationMarkers.length>0,J.Transport.start(J.now(),s),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive?(u.emit("playbackStateChanged",{isPlaying:!0,isPaused:!1}),T.debug("TransportService","Paint playhead is active, skipping regular playhead animation",null,"transport")):wc(),u.emit("playbackStarted")})},resume(){T.info("TransportService","Resuming playback",null,"transport"),(window.initAudio||(()=>J.start()))().then(()=>{J.Transport.start(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive||wc(),u.emit("playbackResumed")})},pause(){T.info("TransportService","Pausing playback",null,"transport"),J.Transport.pause(),Bs&&(cancelAnimationFrame(Bs),Bs=null),u.emit("playbackPaused")},stop(){T.info("TransportService","Stopping playback and clearing visuals",null,"transport"),J.Transport.stop(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStop&&window.PaintPlaybackService.onTransportStop(),J.Transport.cancel(),ee.releaseAll();const n=ii.get("playheadCanvas");n&&n.getContext("2d").clearRect(0,0,n.width,n.height),u.state.paint.isMicPaintActive&&u.emit("playbackStateChanged",{isPlaying:!1,isPaused:!1}),u.emit("playbackStopped")}};let Jr=!1,qi="C4",_a=null,ns=[];function B0(n){const e=u.state.fullRowData[n.row];return e?e.toneNote:"C4"}function dd(){const n=u.state.placedNotes.slice().reverse().find(e=>!e.isDrum);qi=n?B0(n):"C4"}function pd(n){const{activeChordIntervals:e}=u.state;return!n||!e||!e.length?[]:e.map(s=>{const o=Jo(n,s);return Ko(o)})}function q0(){dd(),u.on("notesChanged",dd),document.addEventListener("keydown",n=>{var h,m;if(n.code!=="Space"||Jr)return;const e=document.activeElement,s=e.tagName.toLowerCase(),o=e.contentEditable==="true";if(["input","textarea"].includes(s)||o)return;n.preventDefault(),Jr=!0;const r=(h=u.state.selectedNote)==null?void 0:h.color;let a,c=[];if(_a&&r){const f=u.state.fullRowData[_a.row];a=f?f.toneNote:qi,u.state.selectedTool==="chord"?c=pd(a):c=[a]}else r&&qi&&(a=qi,u.state.selectedTool==="chord"?c=pd(qi):c=[qi]);if(c.length>0){ns={pitches:[...c],rootNote:a,color:r},c.forEach(x=>{ee.triggerAttack(x,r)});const f=u.state.fullRowData.find(x=>x.toneNote===a),g=f?f.hex:"#888888",b=u.state.timbres[r].adsr;(m=Ps.adsrComponent)==null||m.playheadManager.trigger("spacebar","attack",g,b),u.emit("spacebarPlayback",{note:a,color:r,isPlaying:!0});const w=`spacebar-${Date.now()}`;u.emit("noteAttack",{noteId:w,color:r}),ns.noteId=w}}),document.addEventListener("keyup",n=>{var e;if(!(n.code!=="Space"||!Jr)&&(n.preventDefault(),Jr=!1,ns.pitches&&ns.pitches.length>0)){ns.pitches.forEach(a=>{ee.triggerRelease(a,ns.color)});const s=u.state.fullRowData.find(a=>a.toneNote===ns.rootNote),o=s?s.hex:"#888888",r=u.state.timbres[ns.color].adsr;(e=Ps.adsrComponent)==null||e.playheadManager.trigger("spacebar","release",o,r),u.emit("spacebarPlayback",{note:ns.rootNote,color:ns.color,isPlaying:!1}),ns.noteId&&u.emit("noteRelease",{noteId:ns.noteId,color:ns.color}),ns=[]}})}function z0(n,e){var o;_a={col:n,row:e};const s=(o=u.state.selectedNote)==null?void 0:o.color;s&&u.emit("ghostNoteUpdated",{color:s})}function Mp(){_a=null,u.emit("ghostNoteCleared")}let Ia=!1,gh=[],ha=null;function Ep(){Ia=!0}function W0(){Ia=!1}function Pp(n){try{return JSON.parse(JSON.stringify(n,(e,s)=>s instanceof Float32Array?{__type:"Float32Array",data:Array.from(s)}:s))}catch{return null}}function Vc(n,e,s="root"){const o=[];if(!n||!e)return o;if(typeof n!=typeof e)return o.push({path:s,type:"type_change",oldValue:typeof n,newValue:typeof e,timestamp:Date.now()}),o;if(typeof n!="object")return n!==e&&o.push({path:s,type:"value_change",oldValue:n,newValue:e,timestamp:Date.now()}),o;if(Array.isArray(n)){if(!Array.isArray(e))return o.push({path:s,type:"array_to_non_array",oldLength:n.length,newType:typeof e,timestamp:Date.now()}),o;n.length!==e.length&&o.push({path:s,type:"array_length_change",oldLength:n.length,newLength:e.length,timestamp:Date.now()});const a=Math.max(n.length,e.length);for(let c=0;c<a;c++){const h=Vc(n[c],e[c],`${s}[${c}]`);o.push(...h)}return o}const r=new Set([...Object.keys(n),...Object.keys(e)]);for(const a of r)if(!(a in n))o.push({path:`${s}.${a}`,type:"property_added",newValue:e[a],timestamp:Date.now()});else if(!(a in e))o.push({path:`${s}.${a}`,type:"property_removed",oldValue:n[a],timestamp:Date.now()});else{const c=Vc(n[a],e[a],`${s}.${a}`);o.push(...c)}return o}function V0(n){Ia&&(ha=Pp(n))}function md(n,e="unknown"){if(!Ia||!ha)return;const s=Pp(n),o=Vc(ha,s);if(o.length>0){const r=o.filter(a=>!a.path.includes("paint.paintHistory")&&!a.path.includes("tempo")&&!a.path.includes("isPlaying")&&!a.path.includes("fullRowData")&&!a.path.includes("columnWidths"));r.length>0&&(console.error("[STATE GUARD] Unauthorized state mutations detected!",{action:e,mutations:r,totalMutations:o.length,criticalMutations:r.length}),r.forEach(a=>{console.error("[STATE MUTATION]",{path:a.path,type:a.type,oldValue:a.oldValue,newValue:a.newValue,action:e})}),gh.push({action:e,mutations:r,timestamp:Date.now()}))}ha=s}function H0(){return[...gh]}function G0(){gh=[]}window.stateGuard={enable:Ep,disable:W0,getLog:H0,clearLog:G0};T.moduleLoaded("KeyboardHandler","keyboard");function j0(){document.addEventListener("keydown",n=>{var a,c,h;const e=document.activeElement,s=e.tagName.toLowerCase(),o=e.contentEditable==="true";if(["input","textarea"].includes(s)||o)return;if(n.ctrlKey&&n.key.toLowerCase()==="p"){n.preventDefault(),T.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),u.emit("printPreviewStateChanged",!0);return}if(n.ctrlKey&&n.key.toLowerCase()==="z"){n.preventDefault(),u.undo();return}if(n.ctrlKey&&n.key.toLowerCase()==="y"){n.preventDefault(),u.redo();return}let r=!1;switch(n.key){case"Escape":(a=u.state.lassoSelection)!=null&&a.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),r=!0,T.debug("KeyboardHandler","Lasso selection cleared (Escape)",null,"keyboard"));break;case"Enter":(c=u.state.lassoSelection)!=null&&c.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),r=!0,T.debug("KeyboardHandler","Lasso selection cleared (Enter)",null,"keyboard"));break;case"Backspace":case"Delete":if((h=u.state.lassoSelection)!=null&&h.isActive){const m=u.state.lassoSelection.selectedItems;m.filter(f=>f.type==="note").forEach(f=>{const g=u.state.placedNotes.findIndex(b=>b.row===f.data.row&&b.columnIndex===f.data.columnIndex&&b.color===f.data.color&&b.shape===f.data.shape);g!==-1&&u.state.placedNotes.splice(g,1)}),m.filter(f=>f.type==="stamp").forEach(f=>{const g=u.state.stampPlacements.findIndex(b=>b.row===f.data.row&&b.column===f.data.column&&b.stampId===f.data.stampId);g!==-1&&u.state.stampPlacements.splice(g,1)}),m.filter(f=>f.type==="triplet").forEach(f=>{const g=u.state.tripletPlacements.findIndex(b=>b.row===f.data.row&&b.column===f.data.column&&b.tripletId===f.data.tripletId);g!==-1&&u.state.tripletPlacements.splice(g,1)}),u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.recordState(),u.emit("render"),r=!0,T.info("KeyboardHandler",`Deleted ${m.length} items from lasso selection`,null,"keyboard")}break;case"ArrowUp":u.shiftGridUp(),r=!0;break;case"ArrowDown":u.shiftGridDown(),r=!0;break;case"ArrowLeft":T.debug("KeyboardHandler","Emitting 'zoomOut' event",null,"keyboard"),u.emit("zoomOut"),r=!0;break;case"ArrowRight":T.debug("KeyboardHandler","Emitting 'zoomIn' event",null,"keyboard"),u.emit("zoomIn"),r=!0;break}r&&n.preventDefault()}),T.info("KeyboardHandler","Initialized",null,"keyboard")}class U0{constructor(){this.canvasContainer=null,this.pitchGridWrapper=null,this.drumGridWrapper=null,this.isInitialized=!1,this.isScrolling=!1,this.lastScrollTime=0,this.pendingSync=null}init(){if(this.canvasContainer=document.getElementById("canvas-container"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),!this.canvasContainer||!this.pitchGridWrapper||!this.drumGridWrapper){console.error("ScrollSyncService: Required elements not found");return}this.setupScrollSynchronization(),this.isInitialized=!0}setupScrollSynchronization(){const e=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container")].filter(o=>o!==null),s=[...e,this.drumGridWrapper].filter(o=>o!==null);e.forEach(o=>{o.addEventListener("scroll",r=>{const a=Date.now();if(a-this.lastScrollTime<10)return;if(this.lastScrollTime=a,this.isScrolling){console.log("📜 ScrollSync: Ignoring scroll event - sync in progress");return}this.isScrolling=!0;const c=r.target.scrollLeft;console.log(`📜 ScrollSync: ${r.target.id||r.target.className} scrolled to ${c}px`),this.pendingSync&&cancelAnimationFrame(this.pendingSync),this.syncAllTargets(r.target,c,s),this.isScrolling=!1})})}syncAllTargets(e,s,o){o.forEach(r=>{r!==e&&Math.abs(r.scrollLeft-s)>2&&(r.scrollLeft=s)})}syncScrollTo(e){if(!this.isInitialized)return;this.isScrolling=!0;const s=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container"),this.drumGridWrapper].filter(o=>o!==null);this.syncAllTargets(null,e,s),setTimeout(()=>{this.isScrolling=!1},10)}}const X0=new U0;function Y0(){const n=document.getElementById("anacrusis-on-btn"),e=document.getElementById("anacrusis-off-btn");!n||!e||(n.addEventListener("click",()=>u.setAnacrusis(!0)),e.addEventListener("click",()=>u.setAnacrusis(!1)),u.on("anacrusisChanged",s=>{n.classList.toggle("active",s),e.classList.toggle("active",!s)}),n.classList.toggle("active",u.state.hasAnacrusis),e.classList.toggle("active",!u.state.hasAnacrusis))}function Z0(){const n=document.getElementById("hide-drumgrid-toggle"),e=document.getElementById("drum-grid-wrapper");let s=!0;n&&e&&n.addEventListener("click",()=>{s=!s,e.style.display=s?"flex":"none",n.querySelector(".sidebar-button-text").textContent=s?"Hide Drum Grid":"Show Drum Grid",setTimeout(()=>Lt.recalculateLayout(),10)})}function Q0(){const n=document.getElementById("settings-button"),e=document.getElementById("sidebar"),s=document.getElementById("sidebar-overlay"),o=document.getElementById("volume-icon-button"),r=document.getElementById("volume-popup"),a=document.getElementById("vertical-volume-slider"),c=()=>document.body.classList.toggle("sidebar-open");n&&e&&s&&(n.addEventListener("click",c),s.addEventListener("click",c)),o&&r&&a&&(o.addEventListener("click",h=>{h.stopPropagation();const m=r.classList.toggle("visible");o.classList.toggle("active",m)}),a.addEventListener("input",function(){const h=parseInt(this.value,10),m=h===0?-1/0:h/100*37.5-50;u.emit("volumeChanged",m)}),document.addEventListener("click",h=>{!r.contains(h.target)&&h.target!==o&&(r.classList.remove("visible"),o.classList.remove("active"))}),a.dispatchEvent(new Event("input"))),Y0(),Z0()}function kp(){const n=new Date,e=n.toLocaleDateString("en-US",{month:"long"}),s=n.getDate();return`SN-score-${e}${s}.csv`}async function J0(n){try{const e={suggestedName:kp(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},o=await(await window.showSaveFilePicker(e)).createWritable();await o.write(n),await o.close()}catch(e){e.name!=="AbortError"&&console.error("Error saving file with picker:",e)}}function K0(n){const e=document.createElement("a"),s=URL.createObjectURL(n);e.setAttribute("href",s),e.setAttribute("download",kp()),document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(s)}function tb(){return u.state.placedNotes.map(n=>[n.row,n.startColumnIndex,n.endColumnIndex,n.color,n.shape,n.tonicNumber||"",n.isDrum,n.drumTrack||""].join(",")).join(`
`)}function eb(){var n,e,s,o;(n=document.getElementById("save-as-button"))==null||n.addEventListener("click",async()=>{const r=tb(),a=new Blob([r],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await J0(a):K0(a)}),(e=document.getElementById("import-button"))==null||e.addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.accept=".csv,.txt",r.onchange=a=>{const c=a.target.files[0];if(!c)return;const h=new FileReader;h.onload=m=>{const g=m.target.result.split(`
`).filter(b=>b.trim()).map(b=>{const w=b.split(",");return{row:parseInt(w[0]),startColumnIndex:parseInt(w[1]),endColumnIndex:parseInt(w[2]),color:w[3],shape:w[4],tonicNumber:w[5]?parseInt(w[5]):null,isDrum:w[6]==="true",drumTrack:w[7]||null}});u.loadNotes(g)},h.readAsText(c)},r.click()}),(s=document.getElementById("print-button"))==null||s.addEventListener("click",()=>{document.body.classList.remove("sidebar-open"),u.emit("printPreviewStateChanged",!0)}),(o=document.getElementById("reset-canvas-button"))==null||o.addEventListener("click",()=>{window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&u.clearSavedState()})}function Ip(n){return`/Student-Notation/assets/${n}`}function fd(n){return Ip(`icons/${n}`)}function sb(n){return Ip(`tabicons/${n}`)}class nb{constructor(){var e,s,o,r,a;this.overlay=document.getElementById("notification-overlay"),this.modal=(e=this.overlay)==null?void 0:e.querySelector(".notification-modal"),this.title=(s=this.overlay)==null?void 0:s.querySelector(".notification-title"),this.message=(o=this.overlay)==null?void 0:o.querySelector(".notification-message"),this.actionsContainer=(r=this.overlay)==null?void 0:r.querySelector(".notification-actions"),this.closeButton=(a=this.overlay)==null?void 0:a.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){var e;this.overlay&&((e=this.closeButton)==null||e.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",s=>{s.target===this.overlay&&this.hide()}),document.addEventListener("keydown",s=>{var o;s.key==="Escape"&&((o=this.overlay)!=null&&o.classList.contains("visible"))&&this.hide()}))}show(e={}){if(!this.overlay)return;const{title:s="Notice",message:o="",buttons:r=[{text:"OK",primary:!0,action:()=>this.hide()}]}=e;this.title&&(this.title.textContent=s),this.message&&(this.message.textContent=o),this.actionsContainer&&(this.actionsContainer.innerHTML="",r.forEach(a=>{const c=document.createElement("button");c.className=`notification-button ${a.primary?"":"secondary"}`,c.textContent=a.text,c.addEventListener("click",()=>{a.action?a.action():this.hide()}),this.actionsContainer.appendChild(c)})),this.overlay.classList.add("visible"),setTimeout(()=>{var c;const a=(c=this.actionsContainer)==null?void 0:c.querySelector(".notification-button");a==null||a.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(e,s="Notice"){this.show({title:s,message:e,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(e,s="Confirm"){return new Promise(o=>{this.show({title:s,message:e,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),o(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),o(!0)}}]})})}}const gd=new nb,vh={X:["1P","3M","5P"],x:["1P","3m","5P"],"x°":["1P","3m","5d"],"X+":["1P","3M","6m"],X7:["1P","3M","5P","7m"],"x⁷":["1P","3m","5P","7m"],"Xmaj⁷":["1P","3M","5P","7M"],"ø⁷":["1P","3m","5d","7m"],"x°⁷":["1P","3m","5d","6M"],"X⁶":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},yh={"xmaj⁷":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x⁹":["1P","3m","5P","7m","9M"],"x⁶":["1P","3m","5P","6M"],"x¹¹":["1P","3m","5P","7m","9M","11P"],"Xmaj7♯11":["1P","3M","5P","7M","11A"]},ib={...vh,...yh},Hc={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]};function vd(){return Object.keys(u.state.tonicSignGroups).length>0}function yd(){const n=document.getElementById("degree-mode-toggle");if(n){const e=u.state.degreeDisplayMode==="off";n.classList.toggle("disabled",e)}}function bd(){var s,o;const n=document.querySelector("#basic-chords-panel .harmony-preset-grid"),e=document.querySelector("#advanced-chords-panel .harmony-preset-grid");if([n,e].forEach(r=>{r&&r.querySelectorAll(".harmony-preset-button").forEach(a=>a.classList.remove("selected"))}),u.state.selectedTool==="chord"){const r=u.state.activeChordIntervals.toString();if(n){for(const a of n.children)if(((s=vh[a.textContent])==null?void 0:s.toString())===r){a.classList.add("selected");return}}if(e){for(const a of e.children)if(((o=yh[a.textContent])==null?void 0:o.toString())===r){a.classList.add("selected");return}}}}function _d(){const n=document.querySelector("#intervals-panel .harmony-preset-grid");if(n&&(n.querySelectorAll(".harmony-preset-button").forEach(e=>e.classList.remove("selected")),u.state.selectedTool==="chord"&&u.state.activeChordIntervals)){const e=u.state.activeChordIntervals;n.querySelectorAll(".harmony-preset-button").forEach(s=>{const o=s.textContent.trim(),r=Hc[o];r&&e.includes(r[0])&&s.classList.add("selected")})}}function ob(){const{noteBankContainer:n,eraserButton:e,tonicDropdownContainer:s,tonicDropdownButton:o,tonicDropdownLabel:r,tonicDropdownMenu:a,degreeVisibilityToggle:c,degreeModeToggle:h,flatBtn:m,sharpBtn:f,focusColoursToggle:g,harmonyContainerMain:b}=ii.getMultiple("noteBankContainer","eraserButton","tonicDropdownContainer","tonicDropdownButton","tonicDropdownLabel","tonicDropdownMenu","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","focusColoursToggle","harmonyContainerMain");document.querySelector(".harmony-preset-grid");const w=document.getElementById("inversion-toggle"),x=document.getElementById("chord-position-toggle"),A=document.getElementById("chord-position-toggle-4"),I=document.getElementById("chord-position-toggle-adv"),k=document.getElementById("chord-position-toggle-4-adv"),P=document.getElementById("chord-position-toggle-5-adv"),O=document.getElementById("chord-position-toggle-6-adv");n&&n.querySelectorAll(".note").forEach(tt=>{tt.addEventListener("click",()=>{u.setSelectedNote(tt.dataset.type,tt.closest(".note-pair").dataset.color),u.setSelectedTool("note")})}),e&&e.addEventListener("click",()=>u.setSelectedTool("eraser"));const N=document.querySelector("#basic-chords-panel .harmony-preset-grid"),H=document.querySelector("#advanced-chords-panel .harmony-preset-grid");function G(tt,et,vt){tt&&tt.querySelectorAll(".harmony-preset-button").forEach(St=>{St.addEventListener("click",()=>{const Dt=et[St.textContent];Dt&&Dt.length>0?(u.setActiveChordIntervals(Dt),u.setSelectedTool("chord"),setTimeout(()=>it(),10)):console.error(`Failed to retrieve valid intervals for ${vt} chord: "${St.textContent}"`),St.blur()}),St.addEventListener("dblclick",()=>{St.classList.contains("selected")&&u.setSelectedTool("note"),St.blur()})})}G(N,vh,"basic"),G(H,yh,"advanced");const Y=document.querySelectorAll(".chord-tab-button"),ut=document.querySelectorAll(".chord-tab-panel");if(Y.length>0&&Y.forEach(tt=>{tt.addEventListener("click",()=>{const et=tt.dataset.chordTab;Y.forEach(St=>St.classList.remove("active")),tt.classList.add("active"),ut.forEach(St=>St.classList.remove("active"));const vt=document.getElementById(`${et}-panel`);vt&&vt.classList.add("active"),(et==="basic-chords"||et==="advanced-chords")&&setTimeout(()=>it(),10)})}),w){w.addEventListener("click",()=>{const et=!u.state.isIntervalsInverted;u.setIntervalsInversion(et),w.blur()});const tt=et=>{w.classList.toggle("active",et)};u.on("intervalsInversionChanged",tt),tt(u.state.isIntervalsInverted)}if(x){x.addEventListener("click",()=>{const vt=(u.state.chordPositionState+1)%3;u.setChordPosition(vt),x.blur()});const tt=et=>{x.classList.remove("state-1","state-2"),et===1?x.classList.add("state-1"):et===2&&x.classList.add("state-2")};u.on("chordPositionChanged",tt),tt(u.state.chordPositionState)}if(A){A.addEventListener("click",()=>{const vt=(u.state.chordPositionState+1)%4;u.setChordPosition(vt),A.blur()});const tt=et=>{A.classList.remove("state-1","state-2","state-3"),et===1?A.classList.add("state-1"):et===2?A.classList.add("state-2"):et===3&&A.classList.add("state-3")};u.on("chordPositionChanged",tt),tt(u.state.chordPositionState)}if(I){I.addEventListener("click",()=>{const vt=(u.state.chordPositionState+1)%3;u.setChordPosition(vt),I.blur()});const tt=et=>{I.classList.remove("state-1","state-2"),et===1?I.classList.add("state-1"):et===2&&I.classList.add("state-2")};u.on("chordPositionChanged",tt),tt(u.state.chordPositionState)}if(k){k.addEventListener("click",()=>{const vt=(u.state.chordPositionState+1)%4;u.setChordPosition(vt),k.blur()});const tt=et=>{k.classList.remove("state-1","state-2","state-3"),et===1?k.classList.add("state-1"):et===2?k.classList.add("state-2"):et===3&&k.classList.add("state-3")};u.on("chordPositionChanged",tt),tt(u.state.chordPositionState)}if(P){P.addEventListener("click",()=>{const vt=(u.state.chordPositionState+1)%5;u.setChordPosition(vt),P.blur()});const tt=et=>{P.classList.remove("state-1","state-2","state-3","state-4"),et===1?P.classList.add("state-1"):et===2?P.classList.add("state-2"):et===3?P.classList.add("state-3"):et===4&&P.classList.add("state-4")};u.on("chordPositionChanged",tt),tt(u.state.chordPositionState)}if(O){O.addEventListener("click",()=>{const vt=(u.state.chordPositionState+1)%6;u.setChordPosition(vt),O.blur()});const tt=et=>{O.classList.remove("state-1","state-2","state-3","state-4","state-5"),et===1?O.classList.add("state-1"):et===2?O.classList.add("state-2"):et===3?O.classList.add("state-3"):et===4?O.classList.add("state-4"):et===5&&O.classList.add("state-5")};u.on("chordPositionChanged",et=>{tt(et)}),tt(u.state.chordPositionState)}function dt(){const tt=document.querySelector("#basic-chords-panel .harmony-preset-grid"),et=document.querySelector("#advanced-chords-panel .harmony-preset-grid");let vt=null;if(tt&&(vt=tt.querySelector(".harmony-preset-button.selected")),!vt&&et&&(vt=et.querySelector(".harmony-preset-button.selected")),!vt)return{noteCount:3,isAdvanced:!1};const St=vt.textContent,Dt=ib[St],Z=Dt?Dt.length:3,ot=(et==null?void 0:et.contains(vt))||!1;return{noteCount:Z,isAdvanced:ot,chordSymbol:St}}function it(){const tt=x,et=A,vt=document.getElementById("chord-position-toggle-adv"),St=document.getElementById("chord-position-toggle-4-adv"),Dt=document.getElementById("chord-position-toggle-5-adv"),Z=document.getElementById("chord-position-toggle-6-adv"),{noteCount:ot,isAdvanced:pt,chordSymbol:At}=dt();w&&w.classList.remove("hidden"),[tt,et,vt,St,Dt,Z].forEach(Bt=>{Bt&&Bt.classList.add("hidden")});let lt=null,Rt=0;pt?ot>=6?(lt=Z,Rt=5):ot===5?(lt=Dt,Rt=4):ot>=4?(lt=St,Rt=3):(lt=vt,Rt=2):ot>=4?(lt=et,Rt=3):(lt=tt,Rt=2),lt&&(lt.classList.remove("hidden"),u.state.chordPositionState>Rt&&u.setChordPosition(0))}const Ct=document.querySelector("#intervals-panel .harmony-preset-grid");Ct&&Ct.querySelectorAll(".harmony-preset-button").forEach(tt=>{tt.addEventListener("click",()=>{const et=tt.textContent.trim(),vt=Hc[et];if(vt&&vt.length>0){const St=["1P",vt[0]];u.setActiveChordIntervals(St),u.setSelectedTool("chord"),console.log(`Interval ${et} selected:`,St)}else console.error(`Failed to retrieve valid interval for symbol: "${et}"`),console.error("Available interval shapes:",Object.keys(Hc));tt.blur()}),tt.addEventListener("dblclick",()=>{tt.classList.contains("selected")&&u.setSelectedTool("note"),tt.blur()})}),o&&a&&(o.addEventListener("click",tt=>{tt.stopPropagation(),s.classList.toggle("open");const et=document.querySelector(".tab-content"),vt=document.getElementById("container-3"),St=s.classList.contains("open");et&&et.classList.toggle("dropdown-open",St),vt&&vt.classList.toggle("dropdown-open",St),o.blur()}),a.querySelectorAll(".tonic-sign-button").forEach(tt=>{tt.addEventListener("click",et=>{et.stopPropagation();const vt=tt.getAttribute("data-tonic"),St=tt.querySelector(".mode-label").textContent;u.setSelectedTool("tonicization",vt),r&&(r.innerHTML=`<img src="${sb(`tonicShape_${vt}.svg`)}" alt="Tonic ${vt}" class="tonic-shape-icon"> ${St}`),s.classList.remove("open");const Dt=document.querySelector(".tab-content"),Z=document.getElementById("container-3");Dt&&Dt.classList.remove("dropdown-open"),Z&&Z.classList.remove("dropdown-open")})})),c&&c.addEventListener("click",()=>{if(u.state.degreeDisplayMode==="off"){if(!vd()){gd.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}const vt=h.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(vt)}else u.setDegreeDisplayMode("off");c.blur()}),h&&h.addEventListener("click",()=>{if(h.classList.contains("disabled"))return;h.classList.toggle("active");const et=h.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(et),h.blur()}),m&&m.addEventListener("click",()=>{u.toggleAccidentalMode("flat"),m.blur()}),f&&f.addEventListener("click",()=>{u.toggleAccidentalMode("sharp"),f.blur()}),g&&g.addEventListener("change",()=>{if(!u.state.focusColours&&!vd()){gd.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),g.checked=!1;return}u.toggleFocusColours()}),document.addEventListener("click",tt=>{if(s&&!s.contains(tt.target)){s.classList.remove("open");const et=document.querySelector(".tab-content"),vt=document.getElementById("container-3");et&&et.classList.remove("dropdown-open"),vt&&vt.classList.remove("dropdown-open")}}),u.on("toolChanged",({newTool:tt})=>{var Dt;const et=document.querySelector("#basic-chords-panel .harmony-preset-grid"),vt=document.querySelector("#advanced-chords-panel .harmony-preset-grid");[et,vt].forEach(Z=>{Z&&Z.querySelectorAll(".harmony-preset-button").forEach(ot=>ot.classList.remove("selected"))});const St=document.querySelector("#intervals-panel .harmony-preset-grid");if(St&&St.querySelectorAll(".harmony-preset-button").forEach(Z=>Z.classList.remove("selected")),document.querySelectorAll("#tonic-dropdown-button, #eraser-tool-button").forEach(Z=>Z.classList.remove("selected")),b&&b.classList.remove("active-tool"),tt==="eraser")e==null||e.classList.add("selected");else if(tt==="tonicization")o==null||o.classList.add("selected");else if(tt==="chord")b==null||b.classList.add("active-tool"),bd(),_d(),setTimeout(()=>it(),10);else if(tt==="note"){const Z=u.state.selectedNote;if(Z){const ot=document.querySelector(`.note-pair[data-color='${Z.color}']`);ot==null||ot.classList.add("selected"),(Dt=ot==null?void 0:ot.querySelector(`.note[data-type='${Z.shape}']`))==null||Dt.classList.add("selected")}}}),u.on("activeChordIntervalsChanged",()=>{u.state.selectedTool==="chord"&&(bd(),_d())}),u.on("noteChanged",({newNote:tt})=>{var St;document.querySelectorAll(".note, .note-pair").forEach(Dt=>Dt.classList.remove("selected"));const et=document.querySelector(`.note-pair[data-color='${tt.color}']`);et==null||et.classList.add("selected"),(St=et==null?void 0:et.querySelector(`.note[data-type='${tt.shape}']`))==null||St.classList.add("selected"),b&&b.style.setProperty("--c-accent",tt.color);const vt=document.querySelector(".tab-sidebar");vt&&vt.style.setProperty("--c-accent",tt.color)}),u.on("degreeDisplayModeChanged",tt=>{c&&c.classList.toggle("active",tt!=="off"),h&&(h.classList.contains("active"),h.classList.toggle("active",tt==="modal"),h.classList.contains("active")),yd()}),u.on("accidentalModeChanged",({sharp:tt,flat:et})=>{f==null||f.classList.toggle("active",tt),m==null||m.classList.toggle("active",et)}),b&&u.state.selectedNote&&b.style.setProperty("--c-accent",u.state.selectedNote.color);const xt=document.querySelector(".tab-sidebar");xt&&u.state.selectedNote&&xt.style.setProperty("--c-accent",u.state.selectedNote.color),setTimeout(()=>it(),50),yd()}function rb(){const n=document.getElementById("play-button"),e=document.getElementById("stop-button"),s=document.getElementById("clear-button"),o=document.getElementById("loop-button"),r=document.getElementById("undo-button"),a=document.getElementById("redo-button");n&&n.addEventListener("click",()=>{const{isPlaying:h,isPaused:m}=u.state;h&&m?(u.setPlaybackState(!0,!1),Hi.resume()):h&&!m?(u.setPlaybackState(!0,!0),Hi.pause()):(u.setPlaybackState(!0,!1),Hi.start()),n.blur()}),e&&e.addEventListener("click",()=>{u.setPlaybackState(!1,!1),Hi.stop(),e.blur()}),s&&s.addEventListener("click",()=>{s.classList.add("flash"),setTimeout(()=>s.classList.remove("flash"),300),u.clearAllNotes(),S0(),P0(),s.blur()}),o&&o.addEventListener("click",()=>{u.setLooping(!u.state.isLooping)}),r&&r.addEventListener("click",()=>{u.undo(),r.blur()}),a&&a.addEventListener("click",()=>{u.redo(),a.blur()}),u.on("playbackStateChanged",({isPlaying:h,isPaused:m})=>{if(n){const f=`<img src="${fd("Play.svg")}" alt="Play">`,g=`<img src="${fd("Pause.svg")}" alt="Pause">`;n.innerHTML=h&&!m?g:f}}),u.on("loopingChanged",h=>{o&&o.classList.toggle("active",h)});const c=()=>{r&&(r.disabled=u.state.historyIndex<=0),a&&(a.disabled=u.state.historyIndex>=u.state.history.length-1)};u.on("historyChanged",c),c()}class xc{constructor(e,s={}){if(this.parent=typeof e=="string"?document.querySelector(e):e,!this.parent)throw new Error("DraggableNumber: parent element not found");const o={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"}};this.settings={...o,...s,colors:{...o.colors,...s.colors||{}}},this._em=new lb,this._value=new ab(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[r,a]=this.settings.size;this._minDimension=Math.min(r,a),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${r}px`,`height:${a}px`,"background-color: var(--c-bg)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${r}px`,`height:${a}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),hb(this.element,c=>/^-?\d*\.?\d*$/.test(c)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=wd(this._value.value,this.decimalPlaces),this._bind()}on(e,s){return this._em.on(e,s),()=>this._em.off(e,s)}emit(e,s){this._em.emit(e,s)}get value(){return this._value.value}set value(e){this._value.update(e),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(e){this._value.min=e,this._render()}get max(){return this._value.max}set max(e){this._value.max=e,this._render()}get step(){return this._value.step}set step(e){this._value.step=e,this._render()}passiveUpdate(e){this._value.update(e),this._render()}link(e){this.min=e.min,this.max=e.max,this.step=e.step,typeof e.on=="function"&&e.on("change",s=>this.passiveUpdate(s)),this.on("change",s=>{"value"in e&&(e.value=s)}),this.value=e.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-bg)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const e=parseFloat(this.element.value);!Number.isNaN(e)&&e!==this.value?this.value=e:this._render()}),this.element.addEventListener("keydown",e=>{if(e.key==="Enter"){this.element.blur();const s=parseFloat(this.element.value);Number.isNaN(s)||(this.value=s)}},!0),this.element.addEventListener("mousedown",e=>this._onMouseDown(e)),this.element.addEventListener("dragstart",e=>e.preventDefault())}_onMouseDown(e){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:e.clientY};const s=this.element.getBoundingClientRect(),o=(e.clientX-s.left)/s.width;this._changeFactor=cb(o);const r=c=>this._onMouseMove(c),a=()=>this._onMouseUp(r,a);window.addEventListener("mousemove",r),window.addEventListener("mouseup",a)}_onMouseMove(e){if(!this.clicked)return;this.hasMoved=!0;const s=e.clientY-this._start.y,r=bh(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),a=this.actual-s*r;this._value.update(a),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(e,s){this.clicked=!1,window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",s),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=wd(this._value.value,this.decimalPlaces)}}class ab{constructor(e,s,o,r){this.min=Number(e),this.max=Number(s),this.step=Number(o)||1,this._value=0,this.changed=!1,this.update(r)}get value(){return this._value}update(e){const s=bh(Number(e),this.min,this.max),o=this._stepTo(s),r=this._value;this._value=o,this.changed=o!==r}_stepTo(e){if(!isFinite(this.step)||this.step<=0)return e;const s=Math.round((e-this.min)/this.step);return this.min+s*this.step}}class lb{constructor(){this._m=new Map}on(e,s){const o=this._m.get(e)||[];o.push(s),this._m.set(e,o)}off(e,s){const o=this._m.get(e);if(!o)return;const r=o.indexOf(s);r>=0&&o.splice(r,1)}emit(e,s){const o=this._m.get(e);if(o)for(const r of o.slice())r(s)}}function bh(n,e,s){return Math.max(e,Math.min(s,n))}function cb(n){return 1-bh(n,0,1)}function wd(n,e=2){return isFinite(n)?Number(n).toFixed(Math.max(0,e)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function hb(n,e){let s=n.value;n.addEventListener("input",()=>{e(n.value)?s=n.value:n.value=s})}class ub{constructor(){this.isActive=!1,this.pulseIntervals=new Map,this.tempoElements=new Map,this.popDuration={scaleUp:40,scaleDown:80},this.popScale=1.4,this.activeAnimations=new Map,this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:s,containerId:o,bpmMultiplier:r})=>{const a=document.getElementById(o),c=a==null?void 0:a.parentElement,h=c==null?void 0:c.querySelector(".tempo-label-icon");a&&h?this.tempoElements.set(s,{container:a,icon:h,bpmMultiplier:r,originalTransform:a.style.transform||"",originalIconTransform:h.style.transform||""}):console.warn(`TempoVisualizer: Could not find elements for ${s} tempo`,{container:!!a,icon:!!h,tempoGroup:!!c})})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((e,s)=>{this.startPulseForType(s)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(e=>{clearInterval(e)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(e=>{e.container.style.transform=e.originalTransform,e.icon.style.transform=e.originalIconTransform}))}startPulseForType(e){const s=this.tempoElements.get(e);if(!s)return;const a=60/(u.state.tempo*s.bpmMultiplier)*1e3;this.triggerPulse(e);const c=setInterval(()=>{this.isActive&&this.triggerPulse(e)},a);this.pulseIntervals.set(e,c)}triggerPulse(e){this.activeAnimations.has(e);const o={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(e,o),this.activeAnimations.size===1&&this.animationLoop()}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const e=performance.now();this.activeAnimations.forEach((s,o)=>{const r=this.calculateScale(s,e);this.applyScale(o,r),r===1&&s.phase==="complete"&&this.activeAnimations.delete(o)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(e,s){const o=s-e.startTime;if(e.phase==="scaleUp"){if(o>=this.popDuration.scaleUp)return e.phase="scaleDown",e.startTime=s,this.popScale;{const r=Math.min(o/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*r}}else if(e.phase==="scaleDown"){if(o>=this.popDuration.scaleDown)return e.phase="complete",1;{const r=Math.min(o/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*r}}return 1}applyScale(e,s){const o=this.tempoElements.get(e);if(!o)return;const r=`scale(${s})`;o.container.style.transform=o.originalTransform+" "+r,o.icon.style.transform=o.originalIconTransform+" "+r;const a=s<this.popScale?"transform 0.08s ease-out":"none";o.container.style.transition=a,o.icon.style.transition=a}updateTempo(){this.isActive&&(this.stop(),this.start())}}const ms=new ub;function db(){var k;const n=document.getElementById("tempo-slider");n||console.warn("⚠️ [AudioControls] Tempo slider not found during initial load - will retry when rhythm tab is accessed");const e={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0},s=new xc("#eighth-note-tempo",{...e,value:180,min:60,max:480}),o=new xc("#quarter-note-tempo",{...e,value:90,min:30,max:240}),r=new xc("#dotted-quarter-tempo",{...e,value:60,min:20,max:160});function a(P){const O=Math.round(P),N=n||document.getElementById("tempo-slider");N&&parseInt(N.value,10)!==O&&(N.value=O);const H=O*2,G=Math.round(O/1.5);s.value!==H&&s.passiveUpdate(H),o.value!==O&&o.passiveUpdate(O),r.value!==G&&r.passiveUpdate(G),u.state.tempo!==O&&(u.setTempo(O),ms.updateTempo())}let c=!1,h=0,m=!1,f=150;function g(){const P=document.getElementById("tempo-slider");if(!P)return console.warn("⚠️ [AudioControls] Tempo slider still not found during deferred initialization"),!1;P.addEventListener("mousedown",N=>{console.log("🎵 Tempo slider mousedown - starting pulse visualization",{button:N.button,target:N.target.id,isSliderPressed:c}),c=!0,h=Date.now(),m=!1,setTimeout(()=>{c&&(console.log("🎵 Starting pulse after delay - slider still pressed"),ms.start())},100)}),P.addEventListener("mousemove",N=>{c&&!m&&(m=!0,console.log("🎵 Detected dragging - ensuring pulse is active"),ms.isActive||ms.start())}),P.addEventListener("touchstart",N=>{console.log("🎵 Tempo slider touchstart - starting pulse visualization"),c=!0,ms.start()}),P.addEventListener("focus",()=>{console.log("🎵 Tempo slider focused")}),P.addEventListener("input",N=>a(parseInt(N.target.value,10))),P.addEventListener("mouseup",function(){this.blur()});const O=u.state.tempo;return P.value!==O.toString()&&(P.value=O),!0}if(n)n.addEventListener("mousedown",P=>{console.log("🎵 Tempo slider mousedown - starting pulse visualization",{button:P.button,target:P.target.id,isSliderPressed:c}),c=!0,h=Date.now(),m=!1,setTimeout(()=>{c&&(console.log("🎵 Starting pulse after delay - slider still pressed"),ms.start())},100)}),n.addEventListener("mousemove",P=>{c&&!m&&(m=!0,console.log("🎵 Detected dragging - ensuring pulse is active"),ms.isActive||ms.start())}),n.addEventListener("touchstart",P=>{console.log("🎵 Tempo slider touchstart - starting pulse visualization"),c=!0,ms.start()}),n.addEventListener("input",P=>a(parseInt(P.target.value,10))),n.addEventListener("mouseup",function(){this.blur()}),a(u.state.tempo);else{console.log("🔄 [AudioControls] Setting up deferred tempo slider initialization..."),setTimeout(()=>{g()},100);const P=document.getElementById("rhythm-panel");if(P){const O=new MutationObserver(N=>{N.forEach(H=>{if(H.type==="attributes"&&H.attributeName==="class"){const G=H.target;(G.classList.contains("active")||G.style.display!=="none")&&(console.log("🎵 [AudioControls] Rhythm tab became visible, trying to initialize tempo slider"),g()&&O.disconnect())}})});O.observe(P,{attributes:!0,attributeFilter:["class","style"]})}}s.on("change",P=>{!isNaN(P)&&P>0&&a(P/2)}),o.on("change",P=>{!isNaN(P)&&P>0&&a(P)}),r.on("change",P=>{!isNaN(P)&&P>0&&a(P*1.5)}),a(u.state.tempo),window.initTempoSliderIfNeeded=g,document.addEventListener("mouseup",P=>{if(c){const O=Date.now()-h;console.log("🎵 Global mouseup - stopping pulse visualization",{target:P.target.tagName,id:P.target.id,isSliderPressed:c,holdTime:O,isDragging:m,wasLongEnough:O>f}),m||O>f?(c=!1,ms.stop()):(console.log("🎵 Click too short, not stopping pulse yet"),setTimeout(()=>{c&&(c=!1,ms.stop(),console.log("🎵 Delayed stop after quick click"))},50)),m=!1}}),document.addEventListener("touchend",P=>{c&&(console.log("🎵 Global touchend - stopping pulse visualization",{target:P.target.tagName,id:P.target.id,isSliderPressed:c}),c=!1,ms.stop())}),document.addEventListener("touchcancel",P=>{c&&(console.log("🎵 Touch cancelled - stopping pulse visualization",{target:P.target.tagName,id:P.target.id,isSliderPressed:c}),c=!1,ms.stop())});const b=document.querySelector(".preset-effects-container");document.querySelectorAll(".preset-button").forEach(P=>{const O=P.id.replace("preset-",""),N=n0[O];N&&P.addEventListener("click",()=>{var G;const H=(G=u.state.selectedNote)==null?void 0:G.color;H&&(u.applyPreset(H,N),setTimeout(()=>{try{A(H)}catch{}},10)),P.blur()})});const w=(P,O=20)=>{const N=parseInt(P.slice(1,3),16),H=parseInt(P.slice(3,5),16),G=parseInt(P.slice(5,7),16),Y=Math.max(0,Math.floor(N*(1-O/100))),ut=Math.max(0,Math.floor(H*(1-O/100))),dt=Math.max(0,Math.floor(G*(1-O/100)));return`#${Y.toString(16).padStart(2,"0")}${ut.toString(16).padStart(2,"0")}${dt.toString(16).padStart(2,"0")}`},x=(P,O=50)=>{const N=parseInt(P.slice(1,3),16),H=parseInt(P.slice(3,5),16),G=parseInt(P.slice(5,7),16),Y=Math.min(255,Math.floor(N+(255-N)*(O/100))),ut=Math.min(255,Math.floor(H+(255-H)*(O/100))),dt=Math.min(255,Math.floor(G+(255-G)*(O/100)));return`#${Y.toString(16).padStart(2,"0")}${ut.toString(16).padStart(2,"0")}${dt.toString(16).padStart(2,"0")}`},A=P=>{if(!P||!b)return;const O=u.state.timbres[P],N=u.state.colorPalette[P]||{primary:P,light:P},H=N.light,G=N.primary;document.querySelectorAll(".preset-button").forEach(ut=>{const dt=ut.id.replace("preset-",""),it=O&&O.activePresetName===dt;ut.classList.toggle("selected",it)});const Y=x(H,60);b.style.setProperty("--c-accent",G),b.style.setProperty("--c-accent-light",Y),b.style.setProperty("--c-accent-hover",w(G,20))};u.on("noteChanged",({newNote:P})=>{P.color?A(P.color):(document.querySelectorAll(".preset-button").forEach(O=>O.classList.remove("selected")),b&&(b.style.setProperty("--c-accent","#4A90E2"),b.style.setProperty("--c-accent-hover","#357ABD")))}),u.on("timbreChanged",P=>{var O;P===((O=u.state.selectedNote)==null?void 0:O.color)&&A(P)});const I=(k=u.state.selectedNote)==null?void 0:k.color;I&&A(I)}function pb(){const n=document.getElementById("grid-zoom-in"),e=document.getElementById("grid-zoom-out"),s=document.getElementById("macrobeat-increase"),o=document.getElementById("macrobeat-decrease");n&&n.addEventListener("click",()=>{u.emit("zoomIn"),n.blur()}),e&&e.addEventListener("click",()=>{u.emit("zoomOut"),e.blur()}),s&&s.addEventListener("click",()=>u.increaseMacrobeatCount()),o&&o.addEventListener("click",()=>u.decreaseMacrobeatCount())}function mb(){document.querySelectorAll("button"),document.querySelector(".modulation-controls");const n=document.getElementById("modulation-2-3-btn"),e=document.getElementById("modulation-3-2-btn"),s=document.getElementById("modulation-clear-btn");if(!n||!e||!s){T.warn("ModulationInitializer","Modulation control buttons not found in DOM",null,"ui");return}let o=null;n.addEventListener("click",()=>{o===Es.COMPRESSION_2_3?(o=null,n.classList.remove("active"),u.setSelectedTool("note"),T.info("ModulationInitializer","2:3 modulation tool deactivated",null,"ui")):(o=Es.COMPRESSION_2_3,n.classList.add("active"),e.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=o,T.info("ModulationInitializer","2:3 modulation tool activated",null,"ui"))}),e.addEventListener("click",()=>{o===Es.EXPANSION_3_2?(o=null,e.classList.remove("active"),u.setSelectedTool("note"),T.info("ModulationInitializer","3:2 modulation tool deactivated",null,"ui")):(o=Es.EXPANSION_3_2,e.classList.add("active"),n.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=o,T.info("ModulationInitializer","3:2 modulation tool activated",null,"ui"))}),s.addEventListener("click",()=>{const a=(u.state.modulationMarkers||[]).length;if(a===0){T.info("ModulationInitializer","No modulation markers to clear",null,"ui");return}u.clearModulationMarkers(),T.info("ModulationInitializer",`Cleared ${a} modulation markers`,null,"ui")}),u.on("toolChanged",a=>{(a.newTool||a)!=="modulation"&&(o=null,n.classList.remove("active"),e.classList.remove("active"))}),u.on("modulationMarkersChanged",()=>{const a=(u.state.modulationMarkers||[]).length;a===0?(s.disabled=!0,s.style.opacity="0.5"):(s.disabled=!1,s.style.opacity="1"),s.textContent=a>0?`Clear (${a})`:"Clear"});const r=(u.state.modulationMarkers||[]).length;r===0&&(s.disabled=!0,s.style.opacity="0.5"),s.textContent=r>0?`Clear (${r})`:"Clear",T.info("ModulationInitializer","Modulation controls initialized",null,"ui")}T.moduleLoaded("ToolbarComponent","toolbar");const fb={init(){Q0(),eb(),ob(),rb(),db(),pb(),mb(),T.info("ToolbarComponent","All controls initialized",null,"toolbar")}};function Dp(n,e){return e.some(s=>s.columnIndex===n)}function gb(n,e){return e.some(s=>n===s.columnIndex||n===s.columnIndex+1)}function Gc(n,e){const s=sn(e);return!gb(n,s)}function Rp(n,e){for(const s of e)if(n===s.columnIndex+1)return!1;return e.some(s=>n===s.columnIndex+2),!0}function vb(n,e,s,o){const{sharp:r,flat:a}=e.accidentalMode,c=r||a,h=!r&&!a;function m(b){const w=[];return Oc.forEach(x=>{ca(x.pitch)===b&&(x.column==="A"||x.column==="B")&&(x.column==="A"?w.push(1,e.columnWidths.length-2):x.column==="B"&&w.push(0,e.columnWidths.length-1))}),[...new Set(w)]}function f(b){const w=[];return Oc.forEach(x=>{ca(x.pitch)===b&&(x.column==="A"||x.column==="B")&&(x.column==="A"?w.push(0,e.columnWidths.length-1):x.column==="B"&&w.push(1,e.columnWidths.length-2))}),[...new Set(w)]}function g(){return[1,e.columnWidths.length-2]}for(let b=s;b<=o;b++){const w=e.fullRowData[b];if(!w)continue;const x=Nt(b,e);if(x<-10||x>e.viewportHeight+10)continue;const A=ca(w.pitch),I=f0(A);if(A==="C"||A==="E"){const k=m(A),P=ft(0,e),O=ft(e.columnWidths.length,e);Sc(n,P,O,x,e,k,"stroke",I)}else if(A==="G"){const k=ft(2,e),P=ft(e.columnWidths.length-2,e);n.fillStyle=I.color,n.fillRect(k,x-e.cellHeight/2,P-k,e.cellHeight);const O=g();h?(n.fillStyle=I.color,Wo(n,x,e,O,"fill",I)):c&&Wo(n,x,e,O,"stroke",I)}else if(["B","A","F"].includes(A))if(h){let P=f(A).filter(O=>O!==0&&O!==e.columnWidths.length-1);A==="A"&&(P=P.filter(O=>O!==1&&O!==e.columnWidths.length-2)),P.length>0&&Wo(n,x,e,P,"stroke",I)}else{const k=f(A);Wo(n,x,e,k,"stroke",I)}else if(["E♭/D♯","D♭/C♯"].includes(A)){const k=f(A);Wo(n,x,e,k,"stroke",I)}else if(A==="B♭/A♯")if(h){const k=ft(0,e),P=ft(e.columnWidths.length,e);n.beginPath(),n.moveTo(k,x),n.lineTo(P,x),n.lineWidth=I.lineWidth,n.strokeStyle=I.color,n.setLineDash(I.dash),n.stroke(),n.setLineDash([])}else{const k=m(A),P=ft(0,e),O=ft(e.columnWidths.length,e);Sc(n,P,O,x,e,k,"stroke",I)}else{const k=m(A),P=ft(0,e),O=ft(e.columnWidths.length,e);Sc(n,P,O,x,e,k,"stroke",I)}}}function Sc(n,e,s,o,r,a,c,h){const m=a.map(g=>({start:ft(g,r),end:ft(g+1,r)})).sort((g,b)=>g.start-b.start);let f=e;m.forEach(g=>{f<g.start&&jc(n,f,g.start,o,r,c,h),f=Math.max(f,g.end)}),f<s&&jc(n,f,s,o,r,c,h)}function jc(n,e,s,o,r,a,c){a==="fill"?n.fillRect(e,o-r.cellHeight/2,s-e,r.cellHeight):(n.beginPath(),n.moveTo(e,o),n.lineTo(s,o),n.lineWidth=c.lineWidth,n.strokeStyle=c.color,n.setLineDash(c.dash),n.stroke(),n.setLineDash([]))}function Wo(n,e,s,o,r,a){o.forEach(c=>{const h=ft(c,s),m=ft(c+1,s);jc(n,h,m,e,s,r||"stroke",a)})}function yb(n,e,s,o){vb(n,e,s,o)}function bb(n,e){_b(n,e)}function _b(n,e){const{columnWidths:s,macrobeatGroupings:o,macrobeatBoundaryStyles:r,placedTonicSigns:a}=e,c=s.length;let h=[],m=2;for(let f=0;f<o.length;f++){for(;a.some(g=>g.columnIndex===m);)m+=2;m+=o[f],h.push(m)}for(let f=0;f<=c;f++){const g=ft(f,e);let b;const w=f===2||f===c-2,x=Dp(f,a),A=a.some(P=>f===P.columnIndex+2),I=h.includes(f);if(Rp(f,a)){if(w||x||A)b={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(I){const P=h.indexOf(f);if(P!==-1){const O=r[P];if(O==="anacrusis")continue;b={lineWidth:1,strokeStyle:"#adb5bd",dash:O==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(g,0),n.lineTo(g,n.canvas.height),n.lineWidth=b.lineWidth,n.strokeStyle=b.strokeStyle,n.setLineDash(b.dash),n.stroke()}}n.setLineDash([])}const xd=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function wb(n){const e=sn(n);if(e.length===0)return{leftTonic:null,rightTonic:null};const s=e.reduce((r,a)=>a.columnIndex<r.columnIndex?a:r),o=e.reduce((r,a)=>a.columnIndex>r.columnIndex?a:r);return{leftTonic:s,rightTonic:e.length===1?s:o}}function Sd(n,e){const s=e[n];if(!s)return null;const r=s.pitch.replace(/\d+$/,"");return(r.includes("/")?r.split("/")[0]:r).replace(/♭/g,"b").replace(/♯/g,"#")}function Cd(n,e){if(!n||!e)return[];const s=e-1;if(s<0||s>=xd.length)return console.warn(`Invalid tonic number: ${e}`),[];const o=xd[s];try{const r=`${n} ${o}`,a=Sy(r);return console.log(`🎵 Focus Colours: Generated ${r} scale:`,a.notes),a.notes||[]}catch(r){return console.warn(`Could not generate ${o} scale for tonic: ${n}`,r),[]}}function xb(n,e){if(!n||!e.length)return!1;const s=n.replace(/\d+$/,"");return(s.includes("/")?s.split("/"):[s]).map(a=>a.replace(/♭/g,"b").replace(/♯/g,"#")).some(a=>e.some(c=>{try{return gn(a)===gn(c)||a===c}catch{return a===c}}))}function Sb(n,e,s,o){const{fullRowData:r,columnWidths:a,cellWidth:c,cellHeight:h,colorMode:m}=e,{sharp:f,flat:g}=u.state.accidentalMode,{focusColours:b}=u.state;let w=[],x=[];if(b){const P=wb(u.state);if(P.leftTonic){const O=Sd(P.leftTonic.row,r);w=Cd(O,P.leftTonic.tonicNumber)}if(P.rightTonic){const O=Sd(P.rightTonic.row,r);x=Cd(O,P.rightTonic.tonicNumber)}}const A=(P,O=[])=>{if(!P.includes("/"))return P;const N=P.slice(-1),H=P.substring(0,P.length-1),[G,Y]=H.split("/");if(b&&O.length>0){const ut=G.replace(/♭/g,"b").replace(/♯/g,"#"),dt=Y.replace(/♭/g,"b").replace(/♯/g,"#"),it=O.some(xt=>{try{return gn(xt)===gn(ut)||xt===ut}catch{return xt===ut}}),Ct=O.some(xt=>{try{return gn(xt)===gn(dt)||xt===dt}catch{return xt===dt}});if(!f&&!g){if(it)return`${G}${N}`;if(Ct)return`${Y}${N}`}else{if(f&&!g)return Ct?`${Y}${N}`:null;if(!f&&g)return it?`${G}${N}`:null;if(f&&g)return it||Ct?`${G}/${Y}${N}`:null}}return f&&g?`${G}/${Y}${N}`:f?`${Y}${N}`:g?`${G}${N}`:`${Y}${N}`},I=()=>!f&&!g;function k(P,O){const N=ft(P,e),H=a.slice(P,P+2).map(dt=>dt*c);let G=N;const ut=P===0?w:x;O.forEach((dt,it)=>{const Ct=H[it];for(let xt=s;xt<=o;xt++){const tt=r[xt];if(!(!tt||tt.isDummy)&&tt.column===dt){const et=Nt(xt,e),St=tt.pitch.includes("/")&&I();let Dt=m==="bw"?"#ffffff":tt.hex||"#ffffff";const Z=A(tt.pitch,ut),ot=Z===null;let pt=St||ot;if(b&&ut.length>0&&!ot&&(xb(tt.pitch,ut)||(pt=!0)),pt){const Se=Dt.match(/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if(Se){const Xt=parseInt(Se[1],16),be=parseInt(Se[2],16),He=parseInt(Se[3],16);Dt=`rgba(${Xt}, ${be}, ${He}, 0)`}}if(n.fillStyle=Dt,n.fillRect(G,et-h/2,Ct,h),ca(tt.pitch),ot)continue;const At=Z.length<=3,lt=Math.max(10,Math.min(c*1.2,h*1.2)),Rt=At?lt:lt*.7;n.font=`bold ${Rt}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle";const Bt=G+Ct/2,zt=et,se=pt?"00":"FF";n.strokeStyle=`#212529${se}`,n.lineWidth=2.5,n.lineJoin="round",n.strokeText(Z,Bt,zt),n.fillStyle=`#ffffff${se}`,n.fillText(Z,Bt,zt)}}G+=Ct})}k(0,["B","A"]),k(a.length-2,["A","B"])}function Td(n,e,s,o){const r=Math.sqrt(3)/2*s,a=Math.max(1,o-2*r),c=e-(a/2+r),h=c+r,m=h+a,f=m+r,g=n-s/2,b=n+s/2;return`M ${[`${n},${c}`,`${g},${h}`,`${g},${m}`,`${n},${f}`,`${b},${m}`,`${b},${h}`].join(" ")} Z`.replace(/,/g," ")}class Cb{constructor(e={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...e}}renderToCanvas(e,s,o,r,a,c,h="#000",m=null,f=null){const g=Math.min(a/100,c/100)*.8,b=this.options.diamondW*g,w=this.options.diamondH*g,x=this.options.ovalRx*g,A=this.options.ovalRy*g,I=[.125,.375,.625,.875].map(P=>o+P*a),k=r+c/2;e.save(),e.strokeStyle=h,e.fillStyle=h,e.lineWidth=this.options.strokeWidth,e.lineCap="round",e.lineJoin="round",s.ovals.forEach(P=>{var H;const O=P===0?o+.25*a:o+.75*a;let N=k;if(m&&f){const G=`oval_${P}`,Y=((H=m.shapeOffsets)==null?void 0:H[G])||0,ut=m.row+Y;N=f(ut),Y!==0&&console.log("[STAMP RENDER] Drawing oval with offset:",{shapeKey:G,rowOffset:Y,baseRow:m.row,shapeRow:ut,y:N})}e.beginPath(),e.ellipse(O,N,x,A,0,0,Math.PI*2),e.stroke()}),s.diamonds.forEach(P=>{var Y;const O=I[P];let N=k;if(m&&f){const ut=`diamond_${P}`,dt=((Y=m.shapeOffsets)==null?void 0:Y[ut])||0,it=m.row+dt;N=f(it),dt!==0&&console.log("[STAMP RENDER] Drawing diamond with offset:",{slot:P,shapeKey:ut,rowOffset:dt,baseRow:m.row,shapeRow:it,y:N})}const H=Td(O,N,b,w),G=new Path2D(H);e.stroke(G)}),e.restore()}renderToSVG(e,s=100,o=100){const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox",`0 0 ${s} ${o}`),r.style.color="#000000";const a=Math.min(s/100,o/100)*.8,c=this.options.diamondW*a,h=this.options.diamondH*a,m=this.options.ovalRx*a,f=this.options.ovalRy*a,g=[12.5,37.5,62.5,87.5],b=o/2;return e.ovals.forEach(w=>{const x=w===0?25:75,A=document.createElementNS("http://www.w3.org/2000/svg","ellipse");A.setAttribute("cx",x),A.setAttribute("cy",b),A.setAttribute("rx",m),A.setAttribute("ry",f),A.setAttribute("fill","none"),A.setAttribute("stroke","currentColor"),A.setAttribute("stroke-width",this.options.strokeWidth*2),A.setAttribute("stroke-linecap","round"),r.appendChild(A)}),e.diamonds.forEach(w=>{const x=g[w],A=Td(x,b,c,h),I=document.createElementNS("http://www.w3.org/2000/svg","path");I.setAttribute("d",A),I.setAttribute("fill","none"),I.setAttribute("stroke","currentColor"),I.setAttribute("stroke-width",this.options.strokeWidth*2),I.setAttribute("stroke-linejoin","round"),I.setAttribute("stroke-linecap","round"),r.appendChild(I)}),r}}const _h=new Cb;T.moduleLoaded("StampRenderer","stamps");function Tb(n,e){const s=u.getAllStampPlacements();s.length!==0&&(T.debug("StampRenderer",`Rendering ${s.length} stamps`,{count:s.length},"stamps"),s.forEach(o=>{Ab(n,o,e)}))}function Ab(n,e,s){const o=ka(e.stampId);if(!o)return;const{startColumn:r,endColumn:a,row:c,color:h}=e,m=ft(r,s),g=Nt(c,s)-s.cellHeight/2,b=s.cellWidth*2,w=s.cellHeight;if(m+b<0||m>n.canvas.width)return;const x=A=>Nt(A,s);_h.renderToCanvas(n,o,m,g,b,w,h,e,x),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(m+1,g+1,b-2,w-2),n.restore(),T.debug("StampRenderer",`Rendered stamp ${o.id} at ${r}-${a},${c}`,{stampId:o.id,startColumn:r,endColumn:a,row:c,stampX:m,stampY:g,hasOffsets:!!e.shapeOffsets},"stamps")}function Mb(n,e,s,o,r){if(!o)return;const a=ft(e,r),h=Nt(s,r)-r.cellHeight/2,m=r.cellWidth*2,f=r.cellHeight;n.save(),n.globalAlpha=.6,_h.renderToCanvas(n,o,a,h,m,f,r.previewColor||"#4a90e2"),n.restore()}function Eb({kind:n,cx:e,cy:s,stroke:o="currentColor",strokeWidth:r=4,scale:a=1}){const c=20*a,h=60*a,m=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return m.setAttribute("cx",e),m.setAttribute("cy",s),m.setAttribute("fill","none"),m.setAttribute("stroke",o),m.setAttribute("stroke-width",r),m.setAttribute("stroke-linecap","round"),n==="circleWide"?(m.setAttribute("rx",c*2),m.setAttribute("ry",h)):(m.setAttribute("rx",c),m.setAttribute("ry",h)),m}function Pb(n,e=48,s=48){const o=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=n.span==="quarter",a=r?200:100;o.setAttribute("viewBox",`0 0 ${a} 100`),o.setAttribute("width",e),o.setAttribute("height",s),o.setAttribute("aria-label",n.label),o.style.color="#000000";const c=50,h=n.span==="eighth"?"ovalWide":"circleWide";let m;return r?m=[33.33,100,166.67]:m=[16.67,50,83.33],n.hits.forEach(f=>{const g=Eb({kind:h,cx:m[f],cy:c,stroke:"currentColor",strokeWidth:3,scale:.8});o.appendChild(g)}),o}T.moduleLoaded("TripletRenderer","triplets");function kb(n,e){const s=u.getAllTripletPlacements();s.length!==0&&(T.debug("TripletRenderer",`Rendering ${s.length} triplet groups`,{count:s.length},"triplets"),s.forEach(o=>{Ib(n,o,e)}))}function Ib(n,e,s){const o=oi(e.stampId);if(!o)return;const{startCellIndex:r,span:a,row:c,color:h}=e,m=r*2,f=ft(m,s),g=Nt(c,s),b=g-s.cellHeight/2,w=s.cellWidth*2*a,x=s.cellHeight;if(f+w<0||f>n.canvas.width)return;Op(n,o,f,g,w,x,h,e,I=>Nt(I,s)),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(f+1,b+1,w-2,x-2),n.restore()}function Op(n,e,s,o,r,a,c,h=null,m=null){const f=e.span==="eighth"?"ovalWide":"circleWide",g=Math.min(r/100,a/100)*.8,b=Math.max(1,3*g);e.hits.forEach(w=>{var k;const x=wp[w],A=s+r*x/100;let I=o;if(h&&m){const P=`triplet_${w}`,O=((k=h.shapeOffsets)==null?void 0:k[P])||0,N=h.row+O;I=m(N),O!==0&&console.log("[TRIPLET RENDER] Drawing notehead with offset:",{slot:w,shapeKey:P,rowOffset:O,baseRow:h.row,shapeRow:N,y:I})}Db(n,f,A,I,c,b,g)})}function Db(n,e,s,o,r="currentColor",a=4,c=1){const h=20*c,m=60*c;if(n.strokeStyle=r,n.lineWidth=a,n.fillStyle="none",n.beginPath(),e==="circleWide"){const f=h*2,g=m;n.ellipse(s,o,f,g,0,0,2*Math.PI)}else{const f=h,g=m;n.ellipse(s,o,f,g,0,0,2*Math.PI)}n.stroke()}function Rb(n,e,s,o,r){if(!o)return;const a=e*2,c=o.span==="eighth"?1:2,h=ft(a,r),m=Nt(s,r),f=r.cellWidth*2*c,g=r.cellHeight;n.save(),n.globalAlpha=.6;const b=r.previewColor||"#4a90e2";Op(n,o,h,m,f,g,b),n.restore()}function Ob(n,e){const s=e.cellWidth||40;if(n===0)return 2*s;const o=n-1,r=is(e,o);return r?(r.endColumn+1)*s:(console.warn("[MODULATION] Could not find measure info for index:",n),n*200)}function Np(n,e){const{modulationMarkers:s}=e;if(!s||s.length===0)return;const o=s.filter(r=>r.active).map(r=>{let a;if(r.columnIndex!==null&&r.columnIndex!==void 0)a=ft(r.columnIndex+1,e);else if(r.macrobeatIndex!==null&&r.macrobeatIndex!==void 0){const c=is(e,r.macrobeatIndex);c?a=ft(c.endColumn+1,e):(console.warn(`[GRIDLINE-ALIGN] Could not find macrobeat info for index ${r.macrobeatIndex}`),a=r.xPosition||0)}else r.measureIndex!==null&&r.measureIndex!==void 0?a=Ob(r.measureIndex,e):a=r.xPosition||0;return{...r,xCanvas:a}});n.save(),o.forEach(r=>{Nb(n,r)}),n.restore()}function Nb(n,e,s){const o=e.xCanvas,r=e.ratio,a=dp(r),c=up(r);Lb(n,o,a),Fb(n,o,c,a)}function Lb(n,e,s,o){const a=n.canvas.height;n.beginPath(),n.moveTo(e,0),n.lineTo(e,a),n.lineWidth=3,n.strokeStyle=s,n.setLineDash([]),n.stroke()}function Fb(n,e,s,o,r){const c="Arial, sans-serif";n.font=`14px ${c}`,n.textAlign="center",n.textBaseline="middle";const b=n.measureText(s).width,w=14,x=b+6*2,A=w+6*2,I=e-x/2,k=20;$b(n,I,k,x,A,8,o),n.fillStyle="white",n.fillText(s,e,k+A/2)}function $b(n,e,s,o,r,a,c){n.beginPath(),n.moveTo(e+a,s),n.lineTo(e+o-a,s),n.quadraticCurveTo(e+o,s,e+o,s+a),n.lineTo(e+o,s+r-a),n.quadraticCurveTo(e+o,s+r,e+o-a,s+r),n.lineTo(e+a,s+r),n.quadraticCurveTo(e,s+r,e,s+r-a),n.lineTo(e,s+a),n.quadraticCurveTo(e,s,e+a,s),n.closePath(),n.fillStyle=c,n.fill(),n.strokeStyle="rgba(0, 0, 0, 0.2)",n.lineWidth=1,n.stroke()}function hr(n,e){if(!e||e.length<3)return!1;const s=n.x!==void 0?n.x:n.col,o=n.y!==void 0?n.y:n.row;let r=!1;for(let a=0,c=e.length-1;a<e.length;c=a++){const h=e[a].x!==void 0?e[a].x:e[a].col,m=e[a].y!==void 0?e[a].y:e[a].row,f=e[c].x!==void 0?e[c].x:e[c].col,g=e[c].y!==void 0?e[c].y:e[c].row;m>o!=g>o&&s<(f-h)*(o-m)/(g-m)+h&&(r=!r)}return r}function Kr(n){if(!n||n.length<3)return n;const e=n.map(a=>({x:a.x!==void 0?a.x:a.col,y:a.y!==void 0?a.y:a.row}));let s=e[0];for(let a=1;a<e.length;a++)(e[a].y<s.y||e[a].y===s.y&&e[a].x<s.x)&&(s=e[a]);const o=e.filter(a=>a!==s);o.sort((a,c)=>{const h=Math.atan2(a.y-s.y,a.x-s.x),m=Math.atan2(c.y-s.y,c.x-s.x);if(h!==m)return h-m;const f=Math.hypot(a.x-s.x,a.y-s.y),g=Math.hypot(c.x-s.x,c.y-s.y);return f-g});const r=[s,o[0]];for(let a=1;a<o.length;a++){for(;r.length>1&&!Bb(r[r.length-2],r[r.length-1],o[a]);)r.pop();r.push(o[a])}return r}function Bb(n,e,s){return(e.x-n.x)*(s.y-n.y)-(e.y-n.y)*(s.x-n.x)>0}function qb(n,e,s,o=10){const r=n.x,a=n.y,c=e.x,h=e.y,m=s.x,f=s.y,g=m-c,b=f-h,w=g*g+b*b;if(w===0)return Math.hypot(r-c,a-h)<=o;let x=((r-c)*g+(a-h)*b)/w;x=Math.max(0,Math.min(1,x));const A=c+x*g,I=h+x*b;return Math.hypot(r-A,a-I)<=o}function Ad(n,e,s=10){if(!e||e.length<2)return!1;for(let o=0;o<e.length;o++){const r=e[o],a=e[(o+1)%e.length];if(qb(n,r,a,s))return!0}return!1}function zb(n,e){const{centerX:s,centerY:o,rx:r,ry:a}=e,c=16;for(let h=0;h<c;h++){const m=h/c*2*Math.PI,f=s+r*Math.cos(m),g=o+a*Math.sin(m);if(hr({x:f,y:g},n))return!0}return!!hr({x:s,y:o},n)}function Md(n,e){const{x:s,y:o,width:r,height:a}=e,c=[{x:s,y:o},{x:s+r,y:o},{x:s+r,y:o+a},{x:s,y:o+a}];for(const h of c)if(hr(h,n))return!0;for(const h of n){const m=h.x!==void 0?h.x:h.col,f=h.y!==void 0?h.y:h.row;if(m>=s&&m<=s+r&&f>=o&&f<=o+a)return!0}return!1}T.moduleLoaded("AnnotationService","annotation");class Wb{constructor(){this.canvas=null,this.ctx=null,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null}initialize(){if(this.canvas=document.getElementById("notation-grid"),!this.canvas){T.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}this.ctx=this.canvas.getContext("2d"),this.setupEventListeners(),u.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),T.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){if(!this.selectedAnnotation)return;const s=document.activeElement,o=s.contentEditable==="true",r=s.tagName.toLowerCase();["input","textarea"].includes(r)||o||(e.key==="Delete"||e.key==="Backspace")&&(e.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const e=u.state.annotations.indexOf(this.selectedAnnotation);e>-1&&(u.state.annotations.splice(e,1),this.selectedAnnotation=null,u.recordState(),this.render(),T.log("AnnotationService","Deleted annotation","annotation"))}resize(){if(!this.canvas)return;const e=document.getElementById("notation-grid");e&&(this.canvas.width=e.width,this.canvas.height=e.height,this.render())}getRenderOptions(){return{columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth}}canvasToGrid(e,s){const o=this.getRenderOptions();return{col:y0(e,o),row:b0(s,o)}}gridToCanvas(e,s){const o=this.getRenderOptions();return{x:ft(e,o),y:Nt(s,o)}}setTool(e,s){if(this.currentTool=e,this.toolSettings=s,this.canvas)switch(e){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(e){var h,m;if(!this.currentTool||!this.toolSettings)return;const s=this.canvas.getBoundingClientRect(),o=e.clientX-s.left,r=e.clientY-s.top,a=this.canvasToGrid(o,r);if(e.button===2){if(this.currentTool==="lasso"&&((h=u.state.lassoSelection)!=null&&h.isActive)){this.removeFromLassoSelection(o,r);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(o,r),this.showEraserCursor(o,r);return}if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const f=this.getResizeHandleAt(o,r,this.selectedAnnotation);if(f){this.isResizing=!0,this.resizeHandle=f,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:a.col,mouseRow:a.row};return}}if((m=u.state.lassoSelection)!=null&&m.isActive&&u.state.lassoSelection.convexHull){const f=Ad({x:o,y:r},u.state.lassoSelection.convexHull,10),g=hr({x:o,y:r},u.state.lassoSelection.convexHull);if(f||g){this.isDraggingSelection=!0,this.selectionDragStart={canvasX:o,canvasY:r},this.selectionDragTotal={col:0,row:0};return}}const c=this.getAnnotationAt(o,r);if(c&&(c.type==="arrow"||c.type==="text")){if(this.selectedAnnotation===c){this.isDragging=!0,c.type==="arrow"?this.dragOffset={startCol:a.col-c.startCol,startRow:a.row-c.startRow,endCol:a.col-c.endCol,endRow:a.row-c.endRow}:c.type==="text"&&(this.dragOffset={col:a.col-c.col,row:a.row-c.row});return}this.selectedAnnotation=c,this.loadAnnotationSettings(c),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=a,this.currentPath=[a],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:a.col,startRow:a.row,endCol:a.col,endRow:a.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:a.col,startRow:a.row,endCol:a.col,endRow:a.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[a],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:o,y:r}]};break}}handleMouseMove(e){const s=this.canvas.getBoundingClientRect(),o=e.clientX-s.left,r=e.clientY-s.top,a=this.canvasToGrid(o,r);if(this.tempEraserMode){this.eraseAtPoint(o,r),this.showEraserCursor(o,r);return}if(this.isResizing&&this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=a.col-this.resizeStartBounds.mouseCol,h=a.row-this.resizeStartBounds.mouseRow;let m=this.resizeStartBounds.col,f=this.resizeStartBounds.row,g=this.resizeStartBounds.widthCols,b=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+h,b=this.resizeStartBounds.heightRows-h),this.resizeHandle.includes("s")&&(b=this.resizeStartBounds.heightRows+h),this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+c,g=this.resizeStartBounds.widthCols-c),this.resizeHandle.includes("e")&&(g=this.resizeStartBounds.widthCols+c);const w=2,x=1;g<w&&(this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-w),g=w),b<x&&(this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-x),b=x),this.selectedAnnotation.col=m,this.selectedAnnotation.row=f,this.selectedAnnotation.widthCols=g,this.selectedAnnotation.heightRows=b,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart){const c=this.getRenderOptions(),h=o-this.selectionDragStart.canvasX,m=r-this.selectionDragStart.canvasY,f=Math.round(h/c.cellWidth),g=Math.round(m/(c.cellHeight/2)),b={col:f-this.selectionDragTotal.col,row:g-this.selectionDragTotal.row};if(b.col!==0||b.row!==0){u.state.lassoSelection.selectedItems.forEach(x=>{if(x.type==="note"){x.data.row+=b.row;const A=x.data.columnIndex!==void 0?"columnIndex":"startColumnIndex";x.data[A]+=b.col,x.data.endColumnIndex!==void 0&&(x.data.endColumnIndex+=b.col)}else x.type==="stamp"?(x.data.row+=b.row,x.data.startColumn+=b.col,x.data.endColumn+=b.col):x.type==="triplet"&&(x.data.row+=b.row,x.data.column+=b.col)}),this.selectionDragTotal.col=f,this.selectionDragTotal.row=g;const w=u.state.lassoSelection.selectedItems.map(x=>{const A=x.data.columnIndex!==void 0?x.data.columnIndex:x.data.startColumnIndex!==void 0?x.data.startColumnIndex:x.data.column,I=ft(A,c),k=Nt(x.data.row,c);return{x:I,y:k}});u.state.lassoSelection.convexHull=Kr(w),this.render()}return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=a.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=a.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=a.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=a.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=a.col-this.dragOffset.col,this.selectedAnnotation.row=a.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(o,r);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=a.col,this.tempAnnotation.endRow=a.row,this.render();break;case"text":this.tempAnnotation.endCol=a.col,this.tempAnnotation.endRow=a.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const c=this.tempAnnotation.path[this.tempAnnotation.path.length-1],h=this.interpolatePoints(c,a);this.tempAnnotation.path.push(...h)}else this.tempAnnotation.path.push(a);this.render();break;case"lasso":this.tempAnnotation.path.push({x:o,y:r}),this.render();break}}handleMouseUp(e){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,u.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,u.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,u.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:s,startRow:o,endCol:r,endRow:a}=this.tempAnnotation,c=Math.abs(r-s),h=Math.abs(a-o),m=Math.min(s,r),f=Math.min(o,a);c>.5&&h>.2&&this.createTextAnnotation(m,f,c,h),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection():(u.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),u.recordState()),this.tempAnnotation=null,this.render()}}}handleMouseLeave(e){this.isDrawing&&this.handleMouseUp(e)}handleDoubleClick(e){const s=this.canvas.getBoundingClientRect(),o=e.clientX-s.left,r=e.clientY-s.top,a=this.getAnnotationAt(o,r);a&&a.type==="text"&&this.editTextAnnotation(a)}editTextAnnotation(e){const{col:s,row:o,widthCols:r,heightRows:a,text:c,settings:h}=e,m=u.state.annotations.indexOf(e);m>-1&&(u.state.annotations.splice(m,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(s,o,r,a,c,h)}createTextAnnotation(e,s,o,r,a=null,c=null){this.isDrawing=!1;const h=this.gridToCanvas(e,s),m=this.gridToCanvas(e+o,s+r),f=h.x,g=h.y,b=m.x-f,w=m.y-g,A=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',I=c||this.toolSettings.text,k=document.createElement("div");k.contentEditable=!0,k.className="annotation-text-input",k.textContent=a||"Type here...";const P=I.size,O=P*1.2;k.style.width=`${b}px`,k.style.height=`${w}px`,k.style.padding=I.background?"4px 8px":"4px",k.style.border="2px dashed rgba(74, 144, 226, 0.5)",k.style.backgroundColor=I.background?"#ffffff":"transparent",k.style.color=I.color,k.style.fontSize=`${P}px`,k.style.lineHeight=`${O}px`,k.style.fontWeight=I.bold?"bold":"normal",k.style.fontStyle=I.italic?"italic":"normal",k.style.textDecoration=I.underline?"underline":"none",I.superscript?(k.style.fontSize=`${P*.6}px`,k.style.verticalAlign="super"):I.subscript&&(k.style.fontSize=`${P*.6}px`,k.style.verticalAlign="sub"),k.style.outline="none",k.style.zIndex="10000",k.style.position="fixed",k.style.cursor="text",k.style.pointerEvents="auto",k.style.fontFamily=A,k.style.whiteSpace="pre-wrap",k.style.wordWrap="break-word",k.style.overflow="hidden",k.style.boxSizing="border-box";const N=this.canvas.getBoundingClientRect();k.style.left=`${N.left+f}px`,k.style.top=`${N.top+g}px`,document.body.appendChild(k),k.focus();const H=document.createRange();H.selectNodeContents(k);const G=window.getSelection();G.removeAllRanges(),G.addRange(H);let Y=!1;const ut=()=>{if(Y)return;Y=!0;const it=k.textContent.trim();if(it&&it!=="Type here..."){const Ct={type:"text",col:e,row:s,widthCols:o,heightRows:r,text:it,settings:{...I}};u.state.annotations.push(Ct),this.selectedAnnotation=u.state.annotations[u.state.annotations.length-1],u.recordState(),this.render()}document.body.contains(k)&&document.body.removeChild(k)};let dt=!1;k.addEventListener("input",()=>{!dt&&k.textContent==="Type here..."&&(k.textContent="",dt=!0)}),setTimeout(()=>{k.addEventListener("blur",ut)},100),k.addEventListener("keydown",it=>{it.key==="Enter"&&!it.shiftKey&&(it.preventDefault(),ut()),it.key==="Escape"&&(Y=!0,document.body.contains(k)&&document.body.removeChild(k))})}handleLassoSelection(){if(!this.tempAnnotation||!this.tempAnnotation.path)return;const e=this.tempAnnotation.path,s=[],o=this.getRenderOptions();window.event&&window.event.shiftKey&&u.state.lassoSelection.selectedItems&&s.push(...u.state.lassoSelection.selectedItems),u.state.placedNotes.forEach((c,h)=>{if(c.isDrum)return;const m=c.columnIndex!==void 0?c.columnIndex:c.startColumnIndex,f=ft(m,o),g=Nt(c.row,o),{cellWidth:b,cellHeight:w}=o;let x=b;o.modulationMarkers&&o.modulationMarkers.length>0&&(x=ft(m+1,o)-f);const A=c.shape==="oval"?f+x:f+x/2,I=g,k=c.shape==="oval"?x:x/2,P=w/2;if(zb(e,{centerX:A,centerY:I,rx:k,ry:P})){const O=`note-${c.row}-${m}-${c.color}-${c.shape}`;s.find(N=>N.id===O)||s.push({type:"note",id:O,data:c,index:h})}}),u.state.stampPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=o,g=ft(c.startColumn,o),b=Nt(c.row,o)-f/2,w=m*2;if(Md(e,{x:g,y:b,width:w,height:f})){const A=`stamp-${c.row}-${c.startColumn}-${c.stampId}`;s.find(I=>I.id===A)||s.push({type:"stamp",id:A,data:c,index:h})}}),u.state.tripletPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=o,g=ft(c.column,o),b=Nt(c.row,o)-f/2,w=m*2;if(Md(e,{x:g,y:b,width:w,height:f})){const A=`triplet-${c.row}-${c.column}-${c.tripletId}`;s.find(I=>I.id===A)||s.push({type:"triplet",id:A,data:c,index:h})}});let a=null;if(s.length>0){const c=s.map(h=>{const m=h.data.columnIndex!==void 0?h.data.columnIndex:h.data.startColumnIndex!==void 0?h.data.startColumnIndex:h.data.column,f=ft(m,o),g=Nt(h.data.row,o);return{x:f,y:g}});a=Kr(c)}u.state.lassoSelection={selectedItems:s,convexHull:a,isActive:s.length>0},u.recordState(),T.log("AnnotationService",`Lasso selection completed: ${s.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){var o,r;if(!((o=u.state.lassoSelection)!=null&&o.isActive)||!((r=u.state.lassoSelection.selectedItems)!=null&&r.length))return;const e=this.getRenderOptions(),s=u.state.lassoSelection.selectedItems.map(a=>{const c=a.data.columnIndex!==void 0?a.data.columnIndex:a.data.startColumnIndex!==void 0?a.data.startColumnIndex:a.data.column,h=ft(c,e),m=Nt(a.data.row,e);return{x:h,y:m}});u.state.lassoSelection.convexHull=Kr(s)}removeFromLassoSelection(e,s){var c;if(!((c=u.state.lassoSelection)!=null&&c.isActive))return;const o=this.getRenderOptions(),r=15;let a=null;if(u.state.placedNotes.forEach(h=>{const m=ft(h.columnIndex,o),f=Nt(h.row,o);Math.hypot(e-m,s-f)<=r&&(a=`note-${h.row}-${h.columnIndex}-${h.color}-${h.shape}`)}),a||u.state.stampPlacements.forEach(h=>{const m=ft(h.column,o),f=Nt(h.row,o);Math.hypot(e-m,s-f)<=r&&(a=`stamp-${h.row}-${h.column}-${h.stampId}`)}),a||u.state.tripletPlacements.forEach(h=>{const m=ft(h.column,o),f=Nt(h.row,o);Math.hypot(e-m,s-f)<=r&&(a=`triplet-${h.row}-${h.column}-${h.tripletId}`)}),a){const h=u.state.lassoSelection.selectedItems.filter(f=>f.id!==a);let m=null;if(h.length>0){const f=h.map(g=>{const b=ft(g.data.columnIndex||g.data.column,o),w=Nt(g.data.row,o);return{x:b,y:w}});m=Kr(f)}u.state.lassoSelection={selectedItems:h,convexHull:m,isActive:h.length>0},u.recordState(),this.render(),T.log("AnnotationService",`Removed item from lasso selection. ${h.length} items remain.`,"annotation")}}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(e){const{startX:s,startY:o,endX:r,endY:a}=e,c=this.ctx,h=Math.min(s,r),m=Math.min(o,a),f=Math.abs(r-s),g=Math.abs(a-o);c.save(),c.strokeStyle="rgba(74, 144, 226, 0.6)",c.lineWidth=2,c.setLineDash([5,5]),c.strokeRect(h,m,f,g),this.toolSettings.text.background&&(c.fillStyle="rgba(255, 255, 255, 0.8)",c.fillRect(h,m,f,g)),c.restore()}render(){ji.render()}drawArrow(e,s=!1,o=!1,r=!1){const{startX:a,startY:c,endX:h,endY:m,settings:f}=e,g=this.ctx;g.save(),o&&(g.strokeStyle="#4a90e2",g.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,g.globalAlpha=.3,g.setLineDash([]),g.beginPath(),g.moveTo(a,c),g.lineTo(h,m),g.stroke(),g.globalAlpha=1),r&&!o&&(g.strokeStyle="#4a90e2",g.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,g.globalAlpha=.15,g.setLineDash([]),g.beginPath(),g.moveTo(a,c),g.lineTo(h,m),g.stroke(),g.globalAlpha=1),g.strokeStyle=s?"rgba(0, 0, 0, 0.5)":"#000000",g.lineWidth=this.getStrokeWidth(f.strokeWeight),g.setLineDash(this.getLineDash(f.lineStyle));const b=Math.atan2(m-c,h-a),w=f.arrowheadSize||12;let x=a,A=c,I=h,k=m;f.startArrowhead!=="none"&&(x=a+Math.cos(b)*w,A=c+Math.sin(b)*w),f.endArrowhead!=="none"&&(I=h-Math.cos(b)*w,k=m-Math.sin(b)*w),g.beginPath(),g.moveTo(x,A),g.lineTo(I,k),g.stroke(),f.startArrowhead!=="none"&&this.drawArrowhead(g,a,c,b+Math.PI,f.startArrowhead,w),f.endArrowhead!=="none"&&this.drawArrowhead(g,h,m,b,f.endArrowhead,w),g.restore()}drawArrowhead(e,s,o,r,a,c=12){switch(e.save(),e.translate(s,o),e.rotate(r),e.setLineDash([]),a){case"filled":case"filled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.fillStyle=e.strokeStyle,e.fill();break;case"unfilled":case"unfilled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.stroke();break;case"circle":e.beginPath(),e.arc(0,0,c/3,0,Math.PI*2),e.fillStyle=e.strokeStyle,e.fill();break}e.restore()}wrapText(e,s,o){const r=s.split(`
`),a=[];return r.forEach(c=>{if(!c.trim()){a.push("");return}const h=c.split(" ");let m="";h.forEach((f,g)=>{const b=m?m+" "+f:f;e.measureText(b).width>o&&m?(a.push(m),m=f):m=b}),m&&a.push(m)}),a}drawText(e,s=!1,o=!1){const{x:r,y:a,text:c,settings:h}=e,m=this.ctx;m.save();const g=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',b=this.getSizeValue(h.size);m.font=`${h.italic?"italic ":""}${h.bold?"bold ":""}${b} ${g}`,m.textBaseline="top";const w=parseInt(b)*1.2,x=e.width||0,A=e.height||0,I=h.background?16:8,k=x-I,P=this.wrapText(m,c,k);if(h.background){m.fillStyle="#ffffff";const N=8;m.fillRect(r-N/2,a-N/2,x+N,A+N/2)}if(o&&!s){m.fillStyle="rgba(74, 144, 226, 0.1)";const N=h.background?8:2;m.fillRect(r-N/2,a-N/2,x+N,A+N/2)}if(s){m.fillStyle="rgba(74, 144, 226, 0.2)";const N=h.background?8:2;m.fillRect(r-N/2,a-N/2,x+N,A+N/2)}m.fillStyle=h.color;const O=parseInt(b);P.forEach((N,H)=>{const G=a+H*w;this.drawTextWithSuperscripts(m,N,r,G,O,h,g)}),s&&this.drawResizeHandles(r,a,x,A),m.restore()}drawTextWithSuperscripts(e,s,o,r,a,c,h){if(c.superscript||c.subscript){e.save();const b=a*.6,w=c.superscript?-a*.4:a*.3;if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${b}px ${h}`,e.fillText(s,o,r+w),c.underline){const x=e.measureText(s);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(o,r+w+b*1.2-2),e.lineTo(o+x.width,r+w+b*1.2-2),e.stroke()}e.restore();return}let m=o;const f=this.parseFormattedText(s),g=(b,w)=>{if(b){if(e.save(),w==="superscript"){const x=a*.6,A=-a*.4;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${x}px ${h}`,e.fillText(b,m,r+A),m+=e.measureText(b).width}else if(w==="subscript"){const x=a*.6,A=a*.3;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${x}px ${h}`,e.fillText(b,m,r+A),m+=e.measureText(b).width}else{if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${a}px ${h}`,e.fillText(b,m,r),c.underline){const x=e.measureText(b);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(m,r+a*1.2-2),e.lineTo(m+x.width,r+a*1.2-2),e.stroke()}m+=e.measureText(b).width}e.restore()}};f.forEach(b=>{g(b.text,b.format)})}parseFormattedText(e){const s=[];let o=0,r="",a=!1;for(;o<e.length;){if(e.substr(o,5)==="<sup>"){r&&(s.push({text:r,format:"normal"}),r="");const c=e.indexOf("</sup>",o);if(c!==-1){const h=e.substring(o+5,c);s.push({text:h,format:"superscript"}),o=c+6;continue}}if(e.substr(o,5)==="<sub>"){r&&(s.push({text:r,format:"normal"}),r="");const c=e.indexOf("</sub>",o);if(c!==-1){const h=e.substring(o+5,c);s.push({text:h,format:"subscript"}),o=c+6;continue}}if(e[o]==="^"&&!a){r&&(s.push({text:r,format:"normal"}),r=""),a=!0,o++;continue}if(a&&e[o]===" "){r&&(s.push({text:r,format:"superscript"}),r=""),a=!1,s.push({text:" ",format:"normal"}),o++;continue}r+=e[o],o++}return r&&s.push({text:r,format:a?"superscript":"normal"}),s}drawResizeHandles(e,s,o,r){const a=this.ctx,c=8,h=[{pos:"nw",x:e,y:s},{pos:"n",x:e+o/2,y:s},{pos:"ne",x:e+o,y:s},{pos:"e",x:e+o,y:s+r/2},{pos:"se",x:e+o,y:s+r},{pos:"s",x:e+o/2,y:s+r},{pos:"sw",x:e,y:s+r},{pos:"w",x:e,y:s+r/2}];a.save(),h.forEach(m=>{a.fillStyle="#4a90e2",a.strokeStyle="#ffffff",a.lineWidth=2,a.fillRect(m.x-c/2,m.y-c/2,c,c),a.strokeRect(m.x-c/2,m.y-c/2,c,c)}),a.restore()}drawPath(e,s){const{path:o,settings:r}=e,a=this.ctx;if(!(o.length<2)){a.save(),s&&(a.globalAlpha=.3),a.strokeStyle=r.color,a.lineWidth=this.getStrokeWidth(r.size),a.lineCap="round",a.lineJoin="round",a.beginPath(),a.moveTo(o[0].x,o[0].y);for(let c=1;c<o.length;c++)a.lineTo(o[c].x,o[c].y);a.stroke(),a.restore()}}drawLassoPath(e){const{path:s}=e,o=this.ctx;if(!(s.length<2)){o.save(),o.strokeStyle="rgba(0, 100, 255, 0.8)",o.lineWidth=2,o.setLineDash([5,5]),o.beginPath(),o.moveTo(s[0].x,s[0].y);for(let r=1;r<s.length;r++)o.lineTo(s[r].x,s[r].y);o.lineTo(s[0].x,s[0].y),o.stroke(),o.restore()}}getStrokeWidth(e){if(typeof e=="number")return e;switch(e){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(e){switch(e){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(e){if(typeof e=="number")return`${e}px`;switch(e){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(e,s){var a;const o=this.hoverAnnotation;if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=this.getResizeHandleAt(e,s,this.selectedAnnotation);if(c){const h={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=h[c];return}}if((a=u.state.lassoSelection)!=null&&a.isActive&&u.state.lassoSelection.convexHull){const c=Ad({x:e,y:s},u.state.lassoSelection.convexHull,10),h=hr({x:e,y:s},u.state.lassoSelection.convexHull);if(c||h){this.canvas.style.cursor="move";return}}const r=this.getAnnotationAt(e,s);r&&(r.type==="arrow"||r.type==="text")?(this.canvas.style.cursor="move",this.hoverAnnotation=r):(this.setTool(this.currentTool,this.toolSettings),this.hoverAnnotation=null),o!==this.hoverAnnotation&&this.render()}getResizeHandleAt(e,s,o){if(!o||o.type!=="text")return null;const a=8/2+2,c=o.width||0,h=o.height||0,m=o.x,f=o.y,g=[{pos:"nw",x:m,y:f},{pos:"n",x:m+c/2,y:f},{pos:"ne",x:m+c,y:f},{pos:"e",x:m+c,y:f+h/2},{pos:"se",x:m+c,y:f+h},{pos:"s",x:m+c/2,y:f+h},{pos:"sw",x:m,y:f+h},{pos:"w",x:m,y:f+h/2}];for(const b of g)if(Math.sqrt(Math.pow(e-b.x,2)+Math.pow(s-b.y,2))<=a)return b.pos;return null}getAnnotationAt(e,s){for(let r=u.state.annotations.length-1;r>=0;r--){const a=u.state.annotations[r];if(a.type==="arrow"){if(this.distanceToLineSegment(e,s,a.startX,a.startY,a.endX,a.endY)<10)return a}else if(a.type==="text"){let c=a.width,h=a.height;if(!c||!h){const m=a.text.split(`
`),f=a.settings.size,g=f*1.2;this.ctx.font=`${f}px Arial`,c=0,m.forEach(b=>{const w=this.ctx.measureText(b);c=Math.max(c,w.width)}),h=m.length*g}if(e>=a.x&&e<=a.x+c&&s>=a.y&&s<=a.y+h)return a}}return null}showEraserCursor(e,s){this.render();const r=(u.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(e-r/2,s-r/2,r,r),this.ctx.restore()}loadAnnotationSettings(e){if(e.type==="arrow"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.arrow={...s},window.drawToolsController.renderArrowOptions()}else if(e.type==="text"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.text={...s},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){u.state.annotations=[],this.render()}eraseAtPoint(e,s){let r=!1;return u.state.annotations=u.state.annotations.filter(a=>{let c=!0;if(a.type==="arrow"){const h=this.getRenderOptions(),m=ft(a.startCol,h),f=Nt(a.startRow,h),g=ft(a.endCol,h),b=Nt(a.endRow,h);this.distanceToLineSegment(e,s,m,f,g,b)<10&&(c=!1,r=!0)}else if(a.type==="text"){const h=this.getRenderOptions(),m=ft(a.col,h),f=Nt(a.row,h),g=ft(a.col+a.widthCols,h),b=Nt(a.row+a.heightRows,h);e>=m&&e<=g&&s>=f&&s<=b&&(c=!1,r=!0)}else if(a.type==="marker"||a.type==="highlighter"){const h=this.getRenderOptions();for(let m=0;m<a.path.length;m++){const f=ft(a.path[m].col,h),g=Nt(a.path[m].row,h),b=e-f,w=s-g;if(Math.sqrt(b*b+w*w)<10){c=!1,r=!0;break}}}return c}),r&&this.render(),r}interpolatePoints(e,s){const o=[],r=s.col-e.col,a=s.row-e.row,c=Math.sqrt(r*r+a*a),h=Math.max(1,Math.floor(c/.1));for(let m=1;m<=h;m++){const f=m/h;o.push({col:e.col+f*r,row:e.row+f*a})}return o}distanceToLineSegment(e,s,o,r,a,c){const h=a-o,m=c-r,f=h*h+m*m;if(f===0){const I=e-o,k=s-r;return Math.sqrt(I*I+k*k)}let g=((e-o)*h+(s-r)*m)/f;g=Math.max(0,Math.min(1,g));const b=o+g*h,w=r+g*m,x=e-b,A=s-w;return Math.sqrt(x*x+A*A)}deleteAnnotationAt(e,s){this.eraseAtPoint(e,s)}getAnnotations(){return u.state.annotations}loadAnnotations(e){u.state.annotations=e||[],this.render()}applyInlineFormatting(e){const s=document.querySelector(".annotation-text-input");if(!s)return;const o=window.getSelection();if(!o.rangeCount)return;const r=o.getRangeAt(0),a=r.toString();if(!a)return;let c;if(e==="superscript")c=`<sup>${a}</sup>`;else if(e==="subscript")c=`<sub>${a}</sub>`;else return;r.deleteContents();const h=document.createTextNode(c);r.insertNode(h),r.setStartAfter(h),r.setEndAfter(h),o.removeAllRanges(),o.addRange(r),s.focus()}}const jt=new Wb;function Vb(n,e){var c;const s=u.state.annotations,o=jt.tempAnnotation,r=jt.selectedAnnotation,a=jt.hoverAnnotation;if(s&&s.length>0&&s.forEach(h=>{const m=h===r,f=h===a;switch(h.type){case"arrow":Ed(n,h,m,f,e);break;case"text":Hb(n,h,m,f,e);break;case"marker":ta(n,h,!1,e);break;case"highlighter":ta(n,h,!0,e);break}}),o)switch(o.type){case"arrow":Ed(n,o,!1,!1,e);break;case"text":Yb(n,o,e);break;case"marker":ta(n,o,!1,e);break;case"highlighter":ta(n,o,!0,e);break;case"lasso":Qb(n,o);break}(c=u.state.lassoSelection)!=null&&c.isActive&&u.state.lassoSelection.convexHull&&(jt.updateLassoConvexHull(),Jb(n,u.state.lassoSelection.convexHull))}function Ed(n,e,s=!1,o=!1,r){const{startCol:a,startRow:c,endCol:h,endRow:m,settings:f}=e,g=ft(a,r),b=Nt(c,r),w=ft(h,r),x=Nt(m,r);n.save(),n.strokeStyle=e.color||"#000000",n.lineWidth=Uc(f.strokeWeight),n.setLineDash(Zb(f.lineStyle));const A=Math.atan2(x-b,w-g),I=f.arrowheadSize||12;let k=g,P=b,O=w,N=x;f.startArrowhead!=="none"&&(k=g+Math.cos(A)*I,P=b+Math.sin(A)*I),f.endArrowhead!=="none"&&(O=w-Math.cos(A)*I,N=x-Math.sin(A)*I),n.beginPath(),n.moveTo(k,P),n.lineTo(O,N),n.stroke(),n.setLineDash([]),f.startArrowhead!=="none"&&Pd(n,g,b,A+Math.PI,f.startArrowhead,I),f.endArrowhead!=="none"&&Pd(n,w,x,A,f.endArrowhead,I),(s||o)&&(n.strokeStyle=s?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",n.lineWidth=Uc(f.strokeWeight)+4,n.setLineDash([]),n.beginPath(),n.moveTo(g,b),n.lineTo(w,x),n.stroke()),n.restore()}function Pd(n,e,s,o,r,a){switch(n.save(),n.translate(e,s),n.rotate(o),r){case"filled":case"filled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-a,-a/2),n.lineTo(-a,a/2),n.closePath(),n.fillStyle=n.strokeStyle,n.fill();break;case"unfilled":case"unfilled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-a,-a/2),n.lineTo(-a,a/2),n.closePath(),n.stroke();break;case"circle":n.beginPath(),n.arc(0,0,a/3,0,Math.PI*2),n.fillStyle=n.strokeStyle,n.fill();break}n.restore()}function Hb(n,e,s=!1,o=!1,r){const{col:a,row:c,text:h,settings:m,widthCols:f,heightRows:g}=e,b=ft(a,r),w=Nt(c,r),x=ft(a+f,r)-b,A=Nt(c+g,r)-w;n.save();const k=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',P=m.size,O=P*1.2,N=m.background?8:4,H=4,G=x-N*2,Y=Gb(n,h,G,P,m,k);m.background&&(n.fillStyle="#ffffff",n.fillRect(b,w,x,A)),o&&!s&&(n.fillStyle="rgba(74, 144, 226, 0.1)",n.fillRect(b,w,x,A)),s&&(n.fillStyle="rgba(74, 144, 226, 0.2)",n.fillRect(b,w,x,A)),n.fillStyle=m.color,Y.forEach((ut,dt)=>{const it=w+H+dt*O;jb(n,ut,b+N,it,P,m,k)}),s&&Xb(n,b,w,x,A),n.restore()}function Gb(n,e,s,o,r,a){n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${o}px ${a}`;const c=e.split(`
`),h=[];return c.forEach(m=>{if(!m.trim()){h.push("");return}const f=m.split(" ");let g="";f.forEach(b=>{const w=g?g+" "+b:b;n.measureText(w).width>s&&g?(h.push(g),g=b):g=w}),g&&h.push(g)}),h}function jb(n,e,s,o,r,a,c){if(a.superscript||a.subscript){n.save();const f=r*.6,g=a.superscript?-r*.4:r*.3;if(n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${f}px ${c}`,n.fillText(e,s,o+g),a.underline){const b=n.measureText(e);n.beginPath(),n.strokeStyle=a.color,n.lineWidth=1,n.moveTo(s,o+g+f*1.2-2),n.lineTo(s+b.width,o+g+f*1.2-2),n.stroke()}n.restore();return}const h=Ub(e);let m=s;h.forEach(f=>{if(n.save(),f.format==="superscript"){const g=r*.6,b=-r*.4;n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${g}px ${c}`,n.fillText(f.text,m,o+b),m+=n.measureText(f.text).width}else if(f.format==="subscript"){const g=r*.6,b=r*.3;n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${g}px ${c}`,n.fillText(f.text,m,o+b),m+=n.measureText(f.text).width}else{if(n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${r}px ${c}`,n.fillText(f.text,m,o),a.underline){const g=n.measureText(f.text);n.beginPath(),n.strokeStyle=a.color,n.lineWidth=1,n.moveTo(m,o+r*1.2-2),n.lineTo(m+g.width,o+r*1.2-2),n.stroke()}m+=n.measureText(f.text).width}n.restore()})}function Ub(n){const e=[];let s=0,o="",r=!1;for(;s<n.length;){if(n.substr(s,5)==="<sup>"){o&&(e.push({text:o,format:"normal"}),o="");const a=n.indexOf("</sup>",s);if(a!==-1){const c=n.substring(s+5,a);e.push({text:c,format:"superscript"}),s=a+6;continue}}if(n.substr(s,5)==="<sub>"){o&&(e.push({text:o,format:"normal"}),o="");const a=n.indexOf("</sub>",s);if(a!==-1){const c=n.substring(s+5,a);e.push({text:c,format:"subscript"}),s=a+6;continue}}if(n[s]==="^"&&!r){o&&(e.push({text:o,format:"normal"}),o=""),r=!0,s++;continue}if(r&&n[s]===" "){o&&(e.push({text:o,format:"superscript"}),o=""),r=!1,e.push({text:" ",format:"normal"}),s++;continue}o+=n[s],s++}return o&&e.push({text:o,format:r?"superscript":"normal"}),e}function Xb(n,e,s,o,r){const c=[{x:e,y:s},{x:e+o/2,y:s},{x:e+o,y:s},{x:e+o,y:s+r/2},{x:e+o,y:s+r},{x:e+o/2,y:s+r},{x:e,y:s+r},{x:e,y:s+r/2}];n.save(),c.forEach(h=>{n.fillStyle="#4a90e2",n.strokeStyle="#ffffff",n.lineWidth=2,n.fillRect(h.x-8/2,h.y-8/2,8,8),n.strokeRect(h.x-8/2,h.y-8/2,8,8)}),n.restore()}function Yb(n,e,s){const{startCol:o,startRow:r,endCol:a,endRow:c}=e,h=ft(o,s),m=Nt(r,s),f=ft(a,s),g=Nt(c,s),b=Math.min(h,f),w=Math.min(m,g),x=Math.abs(f-h),A=Math.abs(g-m);n.save(),n.strokeStyle="rgba(74, 144, 226, 0.6)",n.lineWidth=2,n.setLineDash([5,5]),n.strokeRect(b,w,x,A),n.restore()}function ta(n,e,s,o){const{path:r,settings:a}=e;if(!r||r.length<2)return;const c=r.map(h=>({x:ft(h.col,o),y:Nt(h.row,o)}));n.save(),s&&(n.globalAlpha=.3),n.strokeStyle=a.color,n.lineWidth=typeof a.size=="number"?a.size:Uc(a.size),n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(c[0].x,c[0].y);for(let h=1;h<c.length;h++)n.lineTo(c[h].x,c[h].y);n.stroke(),n.restore()}function Uc(n){if(typeof n=="number")return n;switch(n){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function Zb(n){switch(n){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function Qb(n,e){if(!(!e.path||e.path.length<2)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([5,5]),n.globalAlpha=.7,n.beginPath(),n.moveTo(e.path[0].x,e.path[0].y);for(let s=1;s<e.path.length;s++)n.lineTo(e.path[s].x,e.path[s].y);e.path.length>2&&n.lineTo(e.path[0].x,e.path[0].y),n.stroke(),n.restore()}}function Jb(n,e){if(!(!e||e.length<3)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([8,4]),n.globalAlpha=.8,n.beginPath(),n.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)n.lineTo(e[s].x,e[s].y);n.closePath(),n.stroke(),n.fillStyle="rgba(74, 144, 226, 0.1)",n.fill(),n.restore()}}function Lp(n,e){const s={...e,...u.state};s.modulationMarkers&&s.modulationMarkers.length>0,n.clearRect(0,0,n.canvas.width,n.canvas.height);const{startRow:o,endRow:r}=g0();Sb(n,s,o,r),yb(n,s,o,r),bb(n,s);const a=e.placedNotes.filter(h=>!h.isDrum&&h.row>=o&&h.row<=r),c=e.placedTonicSigns.filter(h=>h.row>=o&&h.row<=r);a.forEach(h=>{h.shape==="oval"?ph(n,s,h,h.row):h.shape==="circle"&&dh(n,s,h,h.row)}),c.forEach(h=>{mh(n,s,h)}),Tb(n,s),kb(n,s),Np(n,s),Vb(n,s)}const Fp={getTimeSignatureSegments(){const n=[];let e=u.state.hasAnacrusis,s=is(u.state,0).startColumn,o=0,r=!1;return u.state.macrobeatGroupings.forEach((a,c)=>{o+=a,a===3&&(r=!0);const h=c===u.state.macrobeatGroupings.length-1,f=u.state.macrobeatBoundaryStyles[c]==="solid";if(f||h){const g=is(u.state,c).endColumn+1,b=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;let w,x;if(b){const I={...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth};w=ft(s,I),x=ft(g,I)}else w=Lt.getColumnX(s),x=Lt.getColumnX(g);const A=r?`${o}/8`:`${o/2}/4`;n.push({label:A,centerX:(w+x)/2,isAnacrusis:e}),h||(s=g,o=0,r=!1,f&&(e=!1))}}),n},getRhythmUIButtons(){const n=[],e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,s=e?{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}:null;return u.state.macrobeatGroupings.forEach((o,r)=>{const{startColumn:a,endColumn:c}=is(u.state,r),h=e?ft(a,s):Lt.getColumnX(a),m=e?ft(c+1,s):Lt.getColumnX(c+1),f=(h+m)/2;if(n.push({type:"grouping",content:o,x:f,y:20,index:r}),r<u.state.macrobeatGroupings.length-1){const g=u.state.macrobeatBoundaryStyles[r];let b;switch(g){case"solid":b="●";break;case"anacrusis":b="x";break;default:b="○";break}n.push({type:"boundary",content:b,x:m,y:35,index:r})}}),n}};function Kb(){const n=document.getElementById("beat-line-controls");if(!n)return;n.innerHTML="";const e=document.getElementById("notation-grid");if(!e)return;const s=e.getBoundingClientRect(),o=n.getBoundingClientRect(),r=s.left-o.left;Fp.getRhythmUIButtons().forEach((c,h)=>{const m=document.createElement("button");m.textContent=c.content,m.className="rhythm-ui-button",m.style.position="absolute";const f=r+c.x;m.style.left=`${f}px`,m.style.top=`${c.y}px`,m.style.transform="translateX(-50%)",c.type==="grouping"?m.addEventListener("click",()=>u.toggleMacrobeatGrouping(c.index)):m.addEventListener("click",()=>u.cycleMacrobeatBoundaryStyle(c.index)),n.appendChild(m)})}const t_={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const n=this.getTimeSignatureOptions();let e='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(n).forEach(([s,o])=>{e+='<div class="dropdown-category">',e+=`<div class="dropdown-category-header">${s}</div>`,o.forEach((r,a)=>{const c=`${s}-${a}`;e+=`<div class="dropdown-option" data-groupings="${JSON.stringify(r.groupings)}" data-key="${c}">`,e+=`<span class="dropdown-label">${r.label}</span>`,e+=`<span class="dropdown-description">${r.description}</span>`,e+="</div>"}),e+="</div>"}),e+="</div>",e},getTimeSignatureLabel(n){const e=n.reduce((o,r)=>o+r,0);return n.includes(3)?`${e}/8`:`${e/2}/4`}};let Gi=null;function e_(){const n=document.getElementById("time-signature-display");if(!n)return;n.innerHTML="";const e=document.getElementById("notation-grid");if(!e)return;const s=e.getBoundingClientRect(),o=n.getBoundingClientRect(),r=s.left-o.left;Fp.getTimeSignatureSegments().forEach((c,h)=>{const m=document.createElement("div");m.className="time-signature-label",c.isAnacrusis&&m.classList.add("anacrusis-label"),m.textContent=c.label,m.style.position="absolute",m.style.left=`${r+c.centerX}px`,m.style.transform="translateX(-50%)",m.addEventListener("click",f=>{f.stopPropagation(),n_(f.target,h)}),n.appendChild(m)}),s_()}function s_(){if(!document.getElementById("time-signature-dropdown")){const n=t_.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",n),document.getElementById("time-signature-dropdown").addEventListener("click",o_)}}function n_(n,e){const s=document.getElementById("time-signature-dropdown");if(!s)return;s.dataset.measureIndex=e;const o=n.getBoundingClientRect();s.style.left=`${o.left}px`,s.style.top=`${o.bottom+5}px`;const r=s.getBoundingClientRect(),a=window.innerWidth,c=window.innerHeight;o.left+r.width>a&&(s.style.left=`${a-r.width-10}px`),o.bottom+r.height>c&&(s.style.top=`${o.top-r.height-5}px`),s.classList.remove("hidden"),Gi={dropdown:s,measureIndex:e},setTimeout(()=>{document.addEventListener("click",i_,{once:!0})},0)}function i_(n){const e=document.getElementById("time-signature-dropdown");e&&!e.contains(n.target)&&(e.classList.add("hidden"),Gi=null)}function o_(n){const e=n.target.closest(".dropdown-option");if(!e)return;const s=e.dataset.groupings,o=parseInt(Gi==null?void 0:Gi.measureIndex);if(!(!s||isNaN(o)))try{const r=JSON.parse(s);u.updateTimeSignature(o,r),document.getElementById("time-signature-dropdown").classList.add("hidden"),Gi=null}catch(r){console.error("Error parsing time signature groupings:",r)}}T.moduleLoaded("PitchGridController","grid");function r_(){const n=hh.getPitchContext();if(!n||!n.canvas){T.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const e={placedNotes:ky(u.state),placedTonicSigns:sn(u.state),fullRowData:u.state.fullRowData,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,rowHeight:u.state.cellHeight*.5,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,colorMode:"color",degreeDisplayMode:u.state.degreeDisplayMode,zoomLevel:Lt.getViewportInfo().zoomLevel,viewportHeight:n.canvas.height};Lp(n,e)}const ji={render(){r_()},renderMacrobeatTools(){Kb(),e_()}};let ea=null;const a_=()=>(ea||(ea=new Image,ea.src="/assets/icons/Volume.svg"),ea);function Rn(n,e){return e.modulationMarkers&&e.modulationMarkers.length>0?ft(n,e):Lt.getColumnX(n)}function $p(n,e,s,o,r,a,c=1){const h=s+r/2,m=o+a/2,f=Math.min(r,a)*.4*c;if(n.beginPath(),e===0)n.moveTo(h,m-f),n.lineTo(h-f,m+f),n.lineTo(h+f,m+f),n.closePath();else if(e===1)n.moveTo(h,m-f),n.lineTo(h+f,m),n.lineTo(h,m+f),n.lineTo(h-f,m),n.closePath();else{for(let b=0;b<5;b++){const w=2*Math.PI/5*b-Math.PI/2,x=h+f*Math.cos(w),A=m+f*Math.sin(w);b===0?n.moveTo(x,A):n.lineTo(x,A)}n.closePath()}n.fill()}function l_(n,e,s,o,r="normal"){const a=a_();if(r!=="normal"){const c=o*1.3;n.beginPath(),n.arc(e,s,c/2,0,Math.PI*2),r==="hover"?n.fillStyle="rgba(74, 144, 226, 0.2)":r==="active"&&(n.fillStyle="rgba(74, 144, 226, 0.4)"),n.fill()}if(a.complete&&a.naturalWidth>0)r==="hover"?n.filter="brightness(1.2)":r==="active"&&(n.filter="brightness(0.8)"),n.drawImage(a,e-o/2,s-o/2,o,o),n.filter="none";else{let c="#6c757d",h="#6c757d";r==="hover"?(c="#4a90e2",h="#4a90e2"):r==="active"&&(c="#357abd",h="#357abd"),n.fillStyle=c,n.strokeStyle=h,n.lineWidth=1;const m=o*.4,f=o*.6,g=o*.3;n.fillRect(e-m/2,s-f/2,m,f),n.beginPath(),n.moveTo(e+m/2,s-f/3),n.lineTo(e+m/2+g,s-f/2),n.lineTo(e+m/2+g,s+f/2),n.lineTo(e+m/2,s+f/3),n.closePath(),n.fill();for(let b=1;b<=2;b++)n.beginPath(),n.arc(e+m/2+g+o*.1,s,o*.2*b,-Math.PI/4,Math.PI/4,!1),n.stroke()}}function c_(n,e){const{columnWidths:s,macrobeatGroupings:o,macrobeatBoundaryStyles:r,placedTonicSigns:a}=e,c=s.length-2;let h=[],m=2;for(let f=0;f<o.length;f++){for(;a.some(g=>g.columnIndex===m);)m+=2;m+=o[f],h.push(m)}for(let f=0;f<=c;f++){const g=Rn(f,e);if(g<0||g>n.canvas.width)continue;let b;const w=f===2||f===c,x=Dp(f,a),A=a.some(P=>f===P.columnIndex+2),I=h.includes(f);if(Rp(f,a)){if(w||x||A)b={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(I){const P=h.indexOf(f);if(P!==-1){const O=r[P];if(O==="anacrusis")continue;b={lineWidth:1,strokeStyle:"#adb5bd",dash:O==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(g,0),n.lineTo(g,n.canvas.height),n.lineWidth=b.lineWidth,n.strokeStyle=b.strokeStyle,n.setLineDash(b.dash),n.stroke()}}n.setLineDash([])}function Bp(n,e){const{placedNotes:s,columnWidths:o,cellWidth:r,cellHeight:a,placedTonicSigns:c}=e;n.clearRect(0,0,n.canvas.width,n.canvas.height);const h=n.canvas;h.getBoundingClientRect(),window.getComputedStyle(h);const m=Math.max(fr,gr*a),f=o.length,g=["H","M","L"];n.font=`${Math.floor(m*.7)}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#6c757d";const b=Rn(1,e)+Rn(1,e)*.3;g.forEach((k,P)=>{n.fillText(k,b,P*m+m/2)});const w=Rn(1,e)-Rn(1,e)*.3,x=3*m/2,A=e.volumeIconState||"normal";l_(n,w,x,m*.6,A);const I=Rn(2,e);for(let k=0;k<4;k++){const P=k*m;n.beginPath(),n.moveTo(I,P),n.lineTo(n.canvas.width,P),n.strokeStyle="#ced4da",n.lineWidth=1,n.stroke()}c_(n,e);for(let k=2;k<f-2;k++){if(c.some(N=>N.columnIndex===k))continue;const P=Rn(k,e);let O;e.modulationMarkers&&e.modulationMarkers.length>0?O=Rn(k+1,e)-P:O=o[k]*r;for(let N=0;N<3;N++){const H=N*m,G=g[N],Y=s.find(ut=>ut.isDrum&&ut.drumTrack===G&&ut.startColumnIndex===k);if(Y){n.fillStyle=Y.color;const ut=$n.getAnimationScale(k,G);$p(n,N,P,H,O,m,ut)}else n.fillStyle="#ced4da",n.beginPath(),n.arc(P+O/2,H+m/2,2,0,Math.PI*2),n.fill()}}Np(n,e)}const zs={getColumnIndex(n){const{columnWidths:e,cellWidth:s,modulationMarkers:o}=u.state;if(s===0)return 0;if(o&&o.length>0){const a={...u.state,modulationMarkers:o,cellWidth:s,columnWidths:e,baseMicrobeatPx:s};for(let c=0;c<e.length;c++){const h=ft(c+1,a);if(n<h)return c}}else{let a=0;for(let c=0;c<e.length;c++)if(a+=e[c]*s,n<a)return c}return e.length-1},getPitchRowIndex(n){const e=Lt.getViewportInfo();if(!e||!e.halfUnit||e.halfUnit===0)return-1;const s=Math.floor(n/e.halfUnit);return e.startRank+s},getDrumRowIndex(n){const e=Math.max(fr,gr*u.state.cellHeight);return e===0?-1:Math.floor(n/e)}};let pe,wa=!1,ur=!1,Yo=1,mn=null,vn="normal";function so(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return ft(n,s)}else return Lt.getColumnX(n)}function qp(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s=so(n);return so(n+1)-s}else return u.state.columnWidths[n]*u.state.cellWidth}function Xc(n,e,s){if(!pe)return;const o=so(n),r=Math.max(fr,gr*u.state.cellHeight),a=e*r,c=qp(n);pe.fillStyle=s,pe.fillRect(o,a,c,r)}function h_(n,e){if(!pe)return;const s=so(n),o=Math.max(fr,gr*u.state.cellHeight),r=e*o,a=qp(n),c=["H","M","L"][e],h=$n.getAnimationScale(n,c);pe.globalAlpha=.4,pe.fillStyle=u.state.selectedTool.color||"#212529",$p(pe,e,s,r,a,o,h),pe.globalAlpha=1}function u_(n){const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,o=n.clientY-e.top,r=so(2),a=s<r,c=vn;if(vn=a?"hover":"normal",c!==vn&&window.drumGridRenderer&&window.drumGridRenderer.render(),a){pe&&pe.clearRect(0,0,pe.canvas.width,pe.canvas.height);return}const h=document.getElementById("canvas-container").scrollLeft,m=zs.getColumnIndex(s+h),f=zs.getDrumRowIndex(o);if(!pe||m<2||m>=u.state.columnWidths.length-2||f<0||f>2){wh();return}pe.clearRect(0,0,pe.canvas.width,pe.canvas.height);const g=["H","M","L"][f];wa?(u.eraseDrumNoteAt(m,g,!1)&&(ur=!0),Xc(m,f,"rgba(220, 53, 69, 0.3)")):(Xc(m,f,"rgba(74, 144, 226, 0.2)"),h_(m,f))}function wh(){pe&&pe.clearRect(0,0,pe.canvas.width,pe.canvas.height),vn!=="normal"&&(vn="normal",window.drumGridRenderer&&window.drumGridRenderer.render())}function d_(n){var f;n.preventDefault();const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,o=n.clientY-e.top,r=so(2);if(s<r){vn="active",window.drumGridRenderer&&window.drumGridRenderer.render();const g=document.querySelector(".drum-volume-control");if(g){const b=g.style.display==="flex";g.style.display=b?"none":"flex"}return}const a=document.getElementById("canvas-container").scrollLeft,c=zs.getColumnIndex(s+a);if(c<2||c>=u.state.columnWidths.length-2)return;const h=zs.getDrumRowIndex(o);if(h<0||h>2)return;const m=["H","M","L"][h];if(n.button===2){wa=!0,ur=!1,(f=document.getElementById("eraser-tool-button"))==null||f.classList.add("erasing-active"),u.eraseDrumNoteAt(c,m,!1)&&(ur=!0),pe.clearRect(0,0,pe.canvas.width,pe.canvas.height),Xc(c,h,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const{color:g}=u.state.selectedTool,b={isDrum:!0,drumTrack:m,startColumnIndex:c,endColumnIndex:c,color:g||"#000000",shape:m==="H"?"triangle":m==="M"?"square":"pentagon"};u.toggleDrumNote(b),window.transportService&&window.transportService.drumPlayers&&(window.transportService.drumPlayers.player(m).start(),$n.triggerNotePop(c,m))}}function p_(){var n;wa&&(ur&&u.recordState(),wa=!1,ur=!1,(n=document.getElementById("eraser-tool-button"))==null||n.classList.remove("erasing-active")),vn==="active"&&(vn="normal",window.drumGridRenderer&&window.drumGridRenderer.render()),wh()}function m_(){const n=document.getElementById("drum-grid-wrapper");if(!n)return;const e=document.createElement("div");e.className="drum-volume-control",e.style.cssText=`
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        display: none;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 10;
    `,mn=document.createElement("input"),mn.type="range",mn.min="0",mn.max="100",mn.value="100",mn.className="drum-volume-slider",mn.style.cssText="width: 80px; margin: 0;",mn.addEventListener("input",r=>{if(Yo=r.target.value/100,console.log(`[DRUM VOLUME] Slider changed to ${r.target.value}% (linear: ${Yo})`),window.drumVolumeNode){const a=Yo===0?-60:20*Math.log10(Yo);console.log(`[DRUM VOLUME] Setting drumVolumeNode to ${a} dB`),window.drumVolumeNode.volume.value=a,console.log(`[DRUM VOLUME] Actual drumVolumeNode volume: ${window.drumVolumeNode.volume.value} dB`),console.log("[DRUM VOLUME] drumVolumeNode connected to:",window.drumVolumeNode.output),console.log("[DRUM VOLUME] drumVolumeNode input connected:",window.drumVolumeNode.input.numberOfInputs),window.transportService&&window.transportService.drumPlayers&&(console.log("[DRUM VOLUME] Testing drum sound at new volume..."),window.transportService.drumPlayers.player("M").start("+0.1"))}else console.log("[DRUM VOLUME] ERROR: drumVolumeNode not found!")}),e.appendChild(mn),n.appendChild(e);const s=()=>{e.style.display="flex"},o=()=>{e.style.display="none"};n.addEventListener("mouseenter",r=>{const a=n.getBoundingClientRect();r.clientX-a.left<60&&s()}),e.addEventListener("mouseenter",s),e.addEventListener("mouseleave",o),n.addEventListener("mouseleave",o)}function f_(){return Yo}function g_(){return vn}window.getDrumVolume=f_;function v_(){const n=document.getElementById("drum-grid"),e=document.getElementById("drum-hover-canvas");!n||!e||(pe=e.getContext("2d"),n.addEventListener("mousedown",d_),n.addEventListener("mousemove",u_),n.addEventListener("mouseleave",wh),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",p_),m_())}function kd(){const n=hh.getDrumContext();if(!n||!n.canvas)return;const e={placedNotes:Iy(u.state),placedTonicSigns:sn(u.state),columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth,volumeIconState:g_()};Bp(n,e)}const As={animationFrameId:null,render(){kd(),$n.hasActiveAnimations()?As.animationFrameId||As.startAnimationLoop():As.stopAnimationLoop()},startAnimationLoop(){if(As.animationFrameId)return;const n=()=>{$n.cleanupAnimations(),kd(),$n.hasActiveAnimations()?As.animationFrameId=requestAnimationFrame(n):As.animationFrameId=null};As.animationFrameId=requestAnimationFrame(n)},stopAnimationLoop(){As.animationFrameId&&(cancelAnimationFrame(As.animationFrameId),As.animationFrameId=null)}};window.drumGridRenderer=As;T.moduleLoaded("RhythmPlaybackService");class y_{constructor(){this.scheduledEvents=[],this.isInitialized=!1}async initialize(){this.isInitialized||(await J.start(),this.isInitialized=!0,T.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(e,s,o,r="oval",a=null){if(!this.isInitialized){T.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const c=bp(e,a);if(!c||c.length===0){T.warn("RhythmPlaybackService",`No events found for stamp ${e}`);return}T.debug("RhythmPlaybackService",`Playing pattern for stamp ${e}: ${c.length} notes`,{stampId:e,basePitch:s,color:o,events:c,hasShapeOffsets:!!(a!=null&&a.shapeOffsets)});const h=J.now(),m=a==null?void 0:a.row;c.forEach((f,g)=>{try{const b=J.Time(f.offset).toSeconds(),w=h+b;let x=J.Time(f.duration).toSeconds();const A=r==="circle"?x*2:x,I=w+A;let k=s;if(m!==void 0&&f.rowOffset!==0){const P=m+f.rowOffset,O=u.state.fullRowData[P];O&&(k=O.toneNote.replace("♭","b").replace("♯","#"))}ee.triggerAttack(k,o,w),ee.triggerRelease(k,o,I),this.scheduledEvents.push({pitch:k,color:o,attackTime:w,releaseTime:I})}catch(b){T.warn("RhythmPlaybackService",`Error scheduling note ${g+1}`,b)}}),T.info("RhythmPlaybackService",`Scheduled ${c.length} notes for rhythm pattern ${e}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(T.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),ee.releaseAll(),this.scheduledEvents=[])}getStampAtPosition(e,s){return u.state.stampPlacements&&u.state.stampPlacements.find(r=>{const a=r.row===s,c=e>=r.startColumn&&e<=r.endColumn;return a&&c})||null}playTripletPattern(e,s,o,r=null){if(!this.isInitialized){T.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}lr(()=>Promise.resolve().then(()=>R0),void 0).then(a=>{const{getTripletScheduleEvents:c}=a;this.stopCurrentPattern();const h=c(e,r);if(!h||h.length===0){T.warn("RhythmPlaybackService",`No events found for triplet ${e}`);return}T.debug("RhythmPlaybackService",`Playing triplet pattern ${e}: ${h.length} notes`,{tripletStampId:e,basePitch:s,color:o,events:h,hasShapeOffsets:!!(r!=null&&r.shapeOffsets)});const m=J.now(),f=r==null?void 0:r.row;h.forEach((g,b)=>{try{const w=J.Time(g.offset).toSeconds(),x=m+w,A=J.Time(g.duration).toSeconds(),I=x+A;let k=s;if(f!==void 0&&g.rowOffset!==0){const P=f+g.rowOffset,O=u.state.fullRowData[P];O&&(k=O.toneNote.replace("♭","b").replace("♯","#"))}ee.triggerAttack(k,o,x),ee.triggerRelease(k,o,I),this.scheduledEvents.push({pitch:k,color:o,attackTime:x,releaseTime:I})}catch(w){T.warn("RhythmPlaybackService",`Error scheduling triplet note ${b+1}`,w)}}),T.info("RhythmPlaybackService",`Scheduled ${h.length} notes for triplet pattern ${e}`)})}getTripletAtPosition(e,s){return u.state.tripletPlacements&&u.state.tripletPlacements.find(o=>o.row===s&&e>=o.startCellIndex&&e<o.startCellIndex+o.span)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,T.info("RhythmPlaybackService","Disposed")}}const Ks=new y_;T.moduleLoaded("StampsToolbar","stamps");const xh={selectedStampId:1,init(){this.render(),this.bindEvents(),T.info("StampsToolbar","Stamps toolbar initialized",null,"stamps")},render(){const n=document.getElementById("stamps-toolbar-container");if(!n){T.warn("StampsToolbar","Container not found",null,"stamps");return}n.innerHTML="";const e=document.createElement("div");e.className="stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((o,r)=>{const a=document.createElement("div");a.className=`stamps-row stamps-row-${r+1}`,o.forEach(c=>{const h=Bc.find(m=>m.id===c);if(h){const m=this.createStampButton(h,c-1);a.appendChild(m)}}),e.appendChild(a)}),n.appendChild(e),this.setInitialSelection(this.selectedStampId)},createStampButton(n,e){const s=document.createElement("button");s.className="stamp-button",s.setAttribute("data-stamp-id",n.id),s.setAttribute("title",`${n.id}: ${n.label}`);const o=this.createStampPreview(n);return s.appendChild(o),s},createStampPreview(n){const e=_h.renderToSVG(n,100,100);return e.setAttribute("width","48"),e.setAttribute("height","48"),e},bindEvents(){const n=document.getElementById("stamps-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const o=s.target.closest(".stamp-button");if(o){const r=parseInt(o.getAttribute("data-stamp-id"));this.selectStamp(r)}}),this.updateStampColors=s=>{if(!s||!n)return;const o=(f,g=50)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(b+(255-b)*(g/100))),I=Math.min(255,Math.floor(w+(255-w)*(g/100))),k=Math.min(255,Math.floor(x+(255-x)*(g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${k.toString(16).padStart(2,"0")}`},r=(f,g=20)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(b*(1-g/100))),I=Math.max(0,Math.floor(w*(1-g/100))),k=Math.max(0,Math.floor(x*(1-g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${k.toString(16).padStart(2,"0")}`},a=u.state.colorPalette[s]||{primary:s,light:s},c=o(a.light,60),h=a.primary,m=r(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),T.info("StampsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"stamps")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateStampColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateStampColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="stamp"&&this.clearSelection()}),u.on("tripletToolSelected",()=>{this.clearSelection()})},setInitialSelection(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),T.info("StampsToolbar",`Initial stamp selection set to ${n} (no tool change during init)`,{stampId:n},"stamps")},selectStamp(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),console.log("🛠️ [STAMPS] Selecting stamp tool via proper action"),u.setSelectedTool("stamp"),u.emit("stampSelected",n),u.emit("stampToolSelected"),T.info("StampsToolbar",`Selected stamp ${n} and switched to stamp tool`,{stampId:n},"stamps")},clearSelection(){this.selectedStampId=null;const n=document.getElementById("stamps-toolbar-container");n&&n.querySelectorAll(".stamp-button").forEach(e=>{e.classList.remove("active")})},getSelectedStamp(){return Bc.find(n=>n.id===this.selectedStampId)}};T.moduleLoaded("TripletsToolbar","triplets");const Da={selectedTripletStampId:null,init(){this.render(),this.bindEvents(),T.info("TripletsToolbar","Triplets toolbar initialized",null,"triplets")},render(){const n=document.getElementById("triplets-toolbar-container");if(!n){T.warn("TripletsToolbar","Container not found",null,"triplets");return}n.innerHTML="";const e=document.createElement("div");e.className="triplets-main-container";const s=document.createElement("div");s.className="triplets-sections";const o=this.createSection("Eighth Triplets",qc.slice(0,7));s.appendChild(o);const r=this.createQuarterTripletsSection(qc.slice(7,14));s.appendChild(r),e.appendChild(s),n.appendChild(e)},createSection(n,e){const s=document.createElement("div");s.className="triplets-section";const o=document.createElement("div");return o.className="triplets-grid",e.forEach(r=>{const a=this.createTripletButton(r);o.appendChild(a)}),s.appendChild(o),s},createQuarterTripletsSection(n){const e=document.createElement("div");e.className="triplets-section";const s=document.createElement("div");s.className="triplets-grid triplets-quarter-row",[n[0],n[1],n[2]].forEach(r=>{const a=this.createTripletButton(r);s.appendChild(a)});const o=document.createElement("div");return o.className="triplets-grid triplets-quarter-row",[n[3],n[4],n[5],n[6]].forEach(r=>{const a=this.createTripletButton(r);o.appendChild(a)}),e.appendChild(s),e.appendChild(o),e},createTripletButton(n){const e=document.createElement("button");e.className="triplet-button",e.setAttribute("data-triplet-stamp-id",n.id),e.setAttribute("title",n.label),n.span==="quarter"&&e.classList.add("triplet-button-wide");const o=n.span==="quarter"?96:48,r=Pb(n,o,48);return e.appendChild(r),e},bindEvents(){const n=document.getElementById("triplets-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const o=s.target.closest(".triplet-button");if(o){const r=parseInt(o.getAttribute("data-triplet-stamp-id"));this.selectTripletStamp(r)}}),this.updateTripletColors=s=>{if(!s||!n)return;const o=(f,g=50)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(b+(255-b)*(g/100))),I=Math.min(255,Math.floor(w+(255-w)*(g/100))),k=Math.min(255,Math.floor(x+(255-x)*(g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${k.toString(16).padStart(2,"0")}`},r=(f,g=20)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(b*(1-g/100))),I=Math.max(0,Math.floor(w*(1-g/100))),k=Math.max(0,Math.floor(x*(1-g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${k.toString(16).padStart(2,"0")}`},a=u.state.colorPalette[s]||{primary:s,light:s},c=o(a.light,60),h=a.primary,m=r(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),T.info("TripletsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"triplets")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateTripletColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateTripletColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="triplet"&&this.clearSelection()}),u.on("stampToolSelected",()=>{this.clearSelection()})},selectTripletStamp(n){this.selectedTripletStampId=n;const e=document.getElementById("triplets-toolbar-container");e&&e.querySelectorAll(".triplet-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-triplet-stamp-id"))===n)}),u.setSelectedTool("triplet"),u.emit("tripletStampSelected",n),u.emit("tripletToolSelected"),T.info("TripletsToolbar",`Selected triplet stamp ${n} and switched to triplet tool`,{stampId:n},"triplets")},clearSelection(){this.selectedTripletStampId=null;const n=document.getElementById("triplets-toolbar-container");n&&n.querySelectorAll(".triplet-button").forEach(e=>{e.classList.remove("active")})},getSelectedTripletStamp(){return this.selectedTripletStampId?oi(this.selectedTripletStampId):null}};function b_(n,e,s,o){var g,b;const r=ka(s.stampId);if(!r)return console.log("[STAMP HIT TEST] No stamp found for stampId:",s.stampId),null;const a=ft(s.startColumn,o),c=Nt(s.row,o)-o.cellHeight/2,h=o.cellWidth*2,m=o.cellHeight;console.log("[STAMP HIT TEST] Testing position:",{mouseX:n,mouseY:e,stampBounds:{x:a,y:c,width:h,height:m},stampId:s.stampId});const f=[.125,.375,.625,.875].map(w=>a+w*h);for(const w of r.diamonds){const x=`diamond_${w}`,A=((g=s.shapeOffsets)==null?void 0:g[x])||0,I=s.row+A,k=Nt(I,o),P=f[w],O=Math.sqrt(Math.pow(n-P,2)+Math.pow(e-k,2)),N=Math.min(h*.2,m*1);if(console.log(`[STAMP HIT TEST] Testing diamond slot ${w}:`,{cx:P,cy:k,distance:O,hitRadius:N,isHit:O<N}),O<N)return console.log("[STAMP HIT TEST] ✓ Hit diamond:",{slot:w,shapeKey:x,rowOffset:A}),{type:"diamond",slot:w,shapeKey:x,cx:P,cy:k,placement:s}}for(const w of r.ovals){const x=`oval_${w}`,A=((b=s.shapeOffsets)==null?void 0:b[x])||0,I=s.row+A,k=Nt(I,o),P=w===0?a+.25*h:a+.75*h,O=Math.sqrt(Math.pow(n-P,2)+Math.pow(e-k,2)),N=Math.min(h*.25,m*1);if(console.log(`[STAMP HIT TEST] Testing oval slot ${w}:`,{cx:P,cy:k,distance:O,hitRadius:N,isHit:O<N}),O<N)return console.log("[STAMP HIT TEST] ✓ Hit oval:",{slot:w,shapeKey:x,rowOffset:A}),{type:"oval",slot:w,shapeKey:x,cx:P,cy:k,placement:s}}return console.log("[STAMP HIT TEST] No shape hit"),null}function zp(n,e,s,o){console.log("[STAMP HIT TEST] Testing against",s.length,"stamp placements");for(const r of s){const a=b_(n,e,r,o);if(a)return a}return null}function __(n,e,s,o){var g;const r=oi(s.stampId);if(!r)return console.log("[TRIPLET HIT TEST] No stamp found for stampId:",s.stampId),null;const a=s.startCellIndex*2,c=ft(a,o),h=Nt(s.row,o)-o.cellHeight/2,m=o.cellWidth*2*s.span,f=o.cellHeight;console.log("[TRIPLET HIT TEST] Testing position:",{mouseX:n,mouseY:e,groupBounds:{x:c,y:h,width:m,height:f},stampId:s.stampId});for(const b of r.hits){const w=`triplet_${b}`,x=((g=s.shapeOffsets)==null?void 0:g[w])||0,A=s.row+x,I=Nt(A,o),k=wp[b],P=c+m*k/100,O=Math.sqrt(Math.pow(n-P,2)+Math.pow(e-I,2)),N=Math.min(m*.15,f*1);if(console.log(`[TRIPLET HIT TEST] Testing slot ${b}:`,{cx:P,cy:I,distance:O,hitRadius:N,isHit:O<N}),O<N)return console.log("[TRIPLET HIT TEST] ✓ Hit triplet notehead:",{slot:b,shapeKey:w,rowOffset:x}),{type:"triplet",slot:b,shapeKey:w,cx:P,cy:I,placement:s}}return console.log("[TRIPLET HIT TEST] No shape hit"),null}function Wp(n,e,s,o){console.log("[TRIPLET HIT TEST] Testing against",s.length,"triplet placements");for(const r of s){const a=__(n,e,r,o);if(a)return a}return null}let Ut,Ui=!1,Ee=null,ti=[],gs=[],dr=!1,xa=!1,ua=null,Fn=null,ei=[],bs=!1,Qe=null,pr=!1,fs=null,mr=!1;function vs(n){const e=u.state.fullRowData[n];return e?e.toneNote:null}function w_(n){const{macrobeatGroupings:e,columnWidths:s,macrobeatBoundaryStyles:o}=u.state;if(n<2||n>=s.length-2)return null;let r=-1;for(let m=0;m<e.length;m++){const{startColumn:f,endColumn:g}=is(u.state,m);if(n>=f&&n<=g){r=m;break}}if(r===-1)return null;let a=0;for(let m=r-1;m>=0;m--)if(o[m]==="solid"){a=m+1;break}const c=a-1;return{drawColumn:is(u.state,a).startColumn,preMacrobeatIndex:c}}function Vp(n,e){const{activeChordIntervals:s,isIntervalsInverted:o,chordPositionState:r}=u.state;if(!n||!s||s.length===0)return[];if(o&&s.length===2&&s[0]==="1P"){const h="-"+s[1],m=Jo(n,h),f=Ko(m),g=f.includes("#")&&gn(f).includes("b")?gn(f):f;return[n,g]}const a=s.map(c=>{const h=Jo(n,c),m=Ko(h);if(m.includes("#")){const f=gn(m);if(f.includes("b"))return f}return m});if(s.length>=3&&r>0){const c=[...a];for(let I=0;I<r;I++){const k=c.shift(),P=Jo(k,"8P");c.push(Ko(P))}const h=eo(n),m=c.findIndex(I=>eo(I)===h);if(m===-1){console.warn("Root note not found in inverted chord, using bass note positioning");const I=c[0],k=n,P=ys(I),O=ys(k);let N=0,H=P;for(;H>O;)H-=12,N-=12;for(;H+12<=O;)H+=12,N+=12;return c.map(G=>{const Y=ys(G)+N;return Ju(Y)})}const f=c[m],g=n,b=ys(f),w=ys(g);let x=0,A=b;for(;A>w;)A-=12,x-=12;for(;A+12<=w;)A+=12,x+=12;return c.map(I=>{const k=ys(I)+x;return Ju(k)})}return a}function da(n,e,s){if(!Ut)return;const o={...u.state,zoomLevel:Lt.getViewportInfo().zoomLevel},r=ft(n,o),c=Nt(e,u.state)-u.state.cellHeight/2,h=u.state.selectedTool;let m;if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+1,o)-r:m=u.state.columnWidths[n]*u.state.cellWidth,h==="eraser"||dr)u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,o)-r:m=u.state.cellWidth*2;else if(h==="note"&&u.state.selectedNote&&u.state.selectedNote.shape==="circle")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,o)-r:m=u.state.cellWidth*2;else if(h==="stamp")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,o)-r:m=u.state.cellWidth*2;else if(h==="triplet"){const f=Da.getSelectedTripletStamp();if(f){const b=2*(f.span==="eighth"?1:2);u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+b,o)-r:m=u.state.cellWidth*b}else m=u.state.cellWidth*2}else h==="tonicization"&&(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,o)-r:m=u.state.cellWidth*2);Ut.fillStyle=s,Ut.fillRect(r,c,m,u.state.cellHeight)}function x_(n,e,s=!1){if(!Ut||!u.state.selectedNote)return;const o=u.state.selectedTool,{shape:r,color:a}=u.state.selectedNote;if(Ut.globalAlpha=s?.2:.4,o==="tonicization"){const c={row:e,columnIndex:n,tonicNumber:u.state.selectedToolTonicNumber},h={...u.state,zoomLevel:Lt.getViewportInfo().zoomLevel};mh(Ut,h,c)}else if(o==="note"){const c={row:e,startColumnIndex:n,endColumnIndex:n,color:a,shape:r,isDrum:!1},h={...u.state,zoomLevel:Lt.getViewportInfo().zoomLevel};r==="oval"?ph(Ut,h,c,e):dh(Ut,h,c,e)}Ut.globalAlpha=1}function S_(n){var f,g,b,w,x,A,I;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,o=n.clientY-e.top,r=document.getElementById("canvas-container").scrollLeft,a=zs.getColumnIndex(s+r),c=zs.getPitchRowIndex(o),m=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(!(a<2||a>=m||!vs(c))){if(n.button===2){n.preventDefault(),dr=!0,bs=!1,u.state.selectedTool!=="eraser"&&(ua=u.state.selectedTool,u.setSelectedTool("eraser")),(f=ii.get("eraserButton"))==null||f.classList.add("erasing-active"),u.eraseInPitchArea(a,c,2,!1)&&(bs=!0),u.eraseTonicSignAt(a,!1)&&(bs=!0);const k=a+2-1,P=c-1,O=c+1;u.eraseStampsInArea(a,k,P,O)&&(bs=!0),u.eraseTripletsInArea(a,k,P,O)&&(bs=!0);const N=n.target.getBoundingClientRect(),H=n.clientX-N.left,G=n.clientY-N.top;jt.eraseAtPoint(H,G)&&(bs=!0),Ut.clearRect(0,0,Ut.canvas.width,Ut.canvas.height),da(a,c,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const k=s+r;({...u.state});for(const N of u.state.modulationMarkers||[]);const P=u.state.placedNotes.find(N=>!N.isDrum&&N.row===c&&a>=N.startColumnIndex&&a<=N.endColumnIndex);if(P&&u.state.selectedTool==="note"){const N=Ks.getStampAtPosition(a,c),H=vs(c);if(N&&H){const G=window.staticWaveformVisualizer;G&&(G.currentColor=P.color,G.generateWaveform(),G.startSingleNoteVisualization(P.color)),Ks.playRhythmPattern(N.stampId,H,P.color,P.shape,N),gs=[H],Ee=P}else if(H){const G=window.staticWaveformVisualizer;G&&(G.currentColor=P.color,G.generateWaveform(),G.startSingleNoteVisualization(P.color)),ee.triggerAttack(H,P.color);const Y=((g=u.state.fullRowData[c])==null?void 0:g.hex)||"#888888";(b=Ps.adsrComponent)==null||b.playheadManager.trigger(P.uuid,"attack",Y,u.state.timbres[P.color].adsr),gs=[H],Ee=P}return}const O=u.state.selectedTool;if(O==="chord"){if(!Gc(a,u.state))return;const N=vs(c);if(!N)return;const H=Vp(N),{shape:G,color:Y}=u.state.selectedNote;gs=[...H],gs.forEach(dt=>{ee.triggerAttack(dt,Y)});const ut=((w=u.state.fullRowData[c])==null?void 0:w.hex)||"#888888";(x=Ps.adsrComponent)==null||x.playheadManager.trigger("chord_preview","attack",ut,u.state.timbres[Y].adsr),ti=[],H.forEach(dt=>{const it=u.state.fullRowData.findIndex(Ct=>Ct.toneNote===dt);if(it!==-1){const Ct={row:it,startColumnIndex:a,endColumnIndex:a,color:Y,shape:G,isDrum:!1},xt=u.addNote(Ct);xt&&(ti.push(xt),xt.uuid&&u.emit("noteInteractionStart",{noteId:xt.uuid,color:xt.color}))}}),Ui=!0;return}if(O==="tonicization"){if(Fn&&ei.length>0){const N=ei.map(H=>({row:H,tonicNumber:u.state.selectedToolTonicNumber,preMacrobeatIndex:Fn.preMacrobeatIndex,columnIndex:Fn.drawColumn}));u.addTonicSignGroup(N),Fn=null,ei=[]}return}if(O==="eraser"){xa=!0,u.eraseInPitchArea(a,c,2,!1);const N=a+2-1,H=c-1,G=c+1;x0(a,N,H,G),M0(a,N,H,G);return}if(O==="stamp"){const N=u.getAllStampPlacements(),H=s+r,G={...u.state};console.log("[STAMP INTERACTION] Checking for shape hit at:",{actualX:H,y:o,numStamps:N.length});const Y=zp(H,o,N,G);if(Y){console.log("[STAMP INTERACTION] ✓ Hit detected, starting shape drag:",Y),Qe={...Y,startRow:u.getShapeRow(Y.placement,Y.shapeKey),startMouseY:o},pr=!0,console.log("[STAMP INTERACTION] Drag state initialized:",{shapeKey:Qe.shapeKey,startRow:Qe.startRow,placementId:Qe.placement.id});return}const ut=Ks.getStampAtPosition(a,c);if(ut){console.log("[STAMP INTERACTION] Clicked existing stamp, replaying pattern:",ut.stampId);const it=vs(c);if(it){const{shape:Ct}=u.state.selectedNote;Ks.playRhythmPattern(ut.stampId,it,ut.color,Ct,ut),gs=[it]}return}const dt=xh.getSelectedStamp();if(dt){console.log("[STAMP INTERACTION] Placing new stamp:",{stampId:dt.id,colIndex:a,rowIndex:c});const{color:it,shape:Ct}=u.state.selectedNote;w0(dt.id,a,c,it);const xt=vs(c);xt&&(Ks.playRhythmPattern(dt.id,xt,it,Ct),gs=[xt]),u.recordState()}return}if(O==="triplet"){const N=u.getAllTripletPlacements(),H=s+r,G={...u.state};console.log("[TRIPLET INTERACTION] Checking for shape hit at:",{actualX:H,y:o,numTriplets:N.length});const Y=Wp(H,o,N,G);if(Y){console.log("[TRIPLET INTERACTION] ✓ Hit detected, starting shape drag:",Y),fs={...Y,startRow:u.getTripletShapeRow(Y.placement,Y.shapeKey),startMouseY:o},mr=!0;return}const ut=Math.floor(a/2),dt=Ks.getTripletAtPosition(ut,c);if(dt){console.log("[TRIPLET INTERACTION] Clicked existing triplet, replaying pattern:",dt.stampId);const Ct=vs(c);Ct&&(Ks.playTripletPattern(dt.stampId,Ct,dt.color,dt),gs=[Ct]);return}const it=Da.getSelectedTripletStamp();if(it&&u.state.selectedNote){console.log("[TRIPLET INTERACTION] Placing new triplet:",{stampId:it.id,colIndex:a,rowIndex:c});const Ct=T0(it.id,ut,c,u.state.selectedNote.color),xt=vs(c);xt&&Ct&&(Ks.playTripletPattern(it.id,xt,u.state.selectedNote.color,Ct),gs=[xt]),u.recordState()}return}if(O==="modulation"){const N=u.state.selectedModulationRatio;if(!N){console.warn("[MODULATION] No ratio selected - click 2:3 or 3:2 button first");return}const H=Gp(k);if(!H){console.warn("[MODULATION] Click must be near a measure boundary");return}console.log("[MODULATION] Placing marker at measure boundary:",{measureIndex:H.measureIndex,ratio:N,clickX:k,boundaryX:H.xPosition});const G=u.addModulationMarker(H.measureIndex,N,H.xPosition,null,H.macrobeatIndex);console.log("[MODULATION] Marker placed successfully:",{markerId:G,measureIndex:H.measureIndex,ratio:N});return}if(O==="note"){if(!Gc(a,u.state)||!u.state.selectedNote)return;const{shape:N,color:H}=u.state.selectedNote,G={row:c,startColumnIndex:a,endColumnIndex:a,color:H,shape:N,isDrum:!1},Y=u.addNote(G);if(!Y)return;Ee=Y,Y.uuid&&u.emit("noteInteractionStart",{noteId:Y.uuid,color:Y.color}),Ui=N==="circle",Ui||u.recordState();const ut=vs(c);if(ut){gs=[ut],ee.triggerAttack(ut,Ee.color);const dt=((A=u.state.fullRowData[c])==null?void 0:A.hex)||"#888888";(I=Ps.adsrComponent)==null||I.playheadManager.trigger(Ee.uuid,"attack",dt,u.state.timbres[Ee.color].adsr);const it=window.staticWaveformVisualizer;it&&(it.currentColor=Ee.color,it.generateWaveform(),it.startSingleNoteVisualization(Ee.color))}}}}}function C_(n){var b,w;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,o=n.clientY-e.top,r=document.getElementById("canvas-container").scrollLeft,a=zs.getColumnIndex(s+r),c=zs.getPitchRowIndex(o);if(!Ut)return;if(Ut.clearRect(0,0,Ut.canvas.width,Ut.canvas.height),pr&&Qe){const x=zs.getPitchRowIndex(o),A=x-Qe.placement.row;if(console.log("[STAMP DRAG] Mouse moved, updating shape position:",{mouseY:o,newRow:x,baseRow:Qe.placement.row,rowOffset:A,shapeKey:Qe.shapeKey}),u.updateStampShapeOffset(Qe.placement.id,Qe.shapeKey,A),x!==Qe.startRow){const I=vs(x);if(I){const k=Qe.placement.color||((b=u.state.selectedNote)==null?void 0:b.color);ee.triggerAttack(I,k),setTimeout(()=>ee.triggerRelease(I,k),100)}Qe.startRow=x}n.target.style.cursor="ns-resize";return}if(mr&&fs){const x=zs.getPitchRowIndex(o),A=x-fs.placement.row;if(console.log("[TRIPLET DRAG] Mouse moved, updating shape position:",{mouseY:o,newRow:x,baseRow:fs.placement.row,rowOffset:A,shapeKey:fs.shapeKey}),u.updateTripletShapeOffset(fs.placement.id,fs.shapeKey,A),x!==fs.startRow){const I=vs(x);if(console.log("[TRIPLET DRAG] Row changed, playing audio:",{oldRow:fs.startRow,newRow:x,pitch:I,hasPitch:!!I}),I){const k=fs.placement.color||((w=u.state.selectedNote)==null?void 0:w.color);console.log("[TRIPLET DRAG] Triggering audio for pitch:",I,"color:",k),ee.triggerAttack(I,k),setTimeout(()=>ee.triggerRelease(I,k),100)}fs.startRow=x}n.target.style.cursor="ns-resize";return}const h=u.state.selectedTool;if(h==="stamp"&&!pr){const x=s+r,A=u.getAllStampPlacements(),I={...u.state};zp(x,o,A,I)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}if(h==="triplet"&&!mr){const x=s+r,A=u.getAllTripletPlacements(),I={...u.state};Wp(x,o,A,I)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}const m=s+r;({...u.state});for(const x of u.state.modulationMarkers||[]);if(u.state.selectedTool==="modulation"){const x=Gp(m);x&&A_(Ut,x.xPosition,u.state.selectedModulationRatio)}n.target;const g=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(a<2||a>=g||vs(c)===null){Fn=null,ei=[],Mp();return}if(z0(a,c),Ui&&(Ee||ti.length>0)){const x=a;if(Ee)x!==Ee.endColumnIndex&&u.updateNoteTail(Ee,x);else if(ti.length>0){const A=ti.filter(I=>x!==I.endColumnIndex);A.length>0&&u.updateMultipleNoteTails(A,x)}return}if(u.state.selectedTool==="chord"){const x=vs(c);if(x){const A=Vp(x),{shape:I,color:k}=u.state.selectedNote;Ut.globalAlpha=.4,A.forEach(P=>{const O=u.state.fullRowData.findIndex(N=>N.toneNote===P);if(O>-1){const N={row:O,startColumnIndex:a,endColumnIndex:a,color:k,shape:I,isDrum:!1},H={...u.state,zoomLevel:Lt.getViewportInfo().zoomLevel};I==="oval"?ph(Ut,H,N,O):dh(Ut,H,N,O)}}),Ut.globalAlpha=1}return}if(dr){u.eraseInPitchArea(a,c,2,!1)&&(bs=!0),u.eraseTonicSignAt(a,!1)&&(bs=!0);const x=a+2-1,A=c-1,I=c+1;u.eraseStampsInArea(a,x,A,I)&&(bs=!0),u.eraseTripletsInArea(a,x,A,I)&&(bs=!0);const k=n.target.getBoundingClientRect(),P=n.clientX-k.left,O=n.clientY-k.top;jt.eraseAtPoint(P,O)&&(bs=!0),da(a,c,"rgba(220, 53, 69, 0.3)");return}if(xa){u.eraseInPitchArea(a,c,2,!1);const x=a+2-1,A=c-1,I=c+1;u.eraseStampsInArea(a,x,A,I),u.eraseTripletsInArea(a,x,A,I),da(a,c,"rgba(220, 53, 69, 0.3)");return}if(u.state.selectedTool==="tonicization"){const x=w_(a);if(x){const A=vs(c);if(A){const I=u.state.fullRowData.map((P,O)=>({...P,index:O})).filter(P=>P.toneNote&&P.toneNote.replace(/\d+$/,"")===A.replace(/\d+$/,"")).map(P=>P.index);Fn=x,ei=I,Ut.globalAlpha=.5;const k={...u.state,zoomLevel:Lt.getViewportInfo().zoomLevel};I.forEach(P=>{const O={row:P,columnIndex:x.drawColumn,tonicNumber:u.state.selectedToolTonicNumber};mh(Ut,k,O)}),Ut.globalAlpha=1}}else Fn=null,ei=[]}else{const x=u.state.selectedTool==="note"||u.state.selectedTool==="chord"?Gc(a,u.state):!0,A=u.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":x?"rgba(74, 144, 226, 0.2)":"rgba(220, 53, 69, 0.15)";if(da(a,c,A),u.state.selectedTool==="stamp"){const k=xh.getSelectedStamp();if(k){const P={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};Mb(Ut,a,c,k,P)}}else if(u.state.selectedTool==="triplet"){const k=Da.getSelectedTripletStamp();if(k){const P=Math.floor(a/2),O={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};Rb(Ut,P,c,k,O)}}else x&&x_(a,c)}}function Hp(){Ut&&Ut.clearRect(0,0,Ut.canvas.width,Ut.canvas.height),Fn=null,ei=[],Mp()}function T_(){var n,e,s,o,r;if(pr&&Qe){console.log("[STAMP DRAG] Drag ended, saving state for undo/redo"),pr=!1,Qe=null,u.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(mr&&fs){console.log("[TRIPLET DRAG] Drag ended, saving state for undo/redo"),mr=!1,fs=null,u.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(gs.length>0){Ks.stopCurrentPattern();const a=(n=u.state.selectedNote)==null?void 0:n.color;if(a&&gs.forEach(m=>{ee.triggerRelease(m,a)}),!!Ee){const m=((e=u.state.fullRowData[Ee.row])==null?void 0:e.hex)||"#888888";(s=Ps.adsrComponent)==null||s.playheadManager.trigger(Ee.uuid,"release",m,u.state.timbres[a].adsr)}else{const m=gs[0],f=u.state.fullRowData.find(g=>g.toneNote===m);if(f){const g=f.hex;(o=Ps.adsrComponent)==null||o.playheadManager.trigger("chord_preview","release",g,u.state.timbres[a].adsr)}}gs=[];const h=window.staticWaveformVisualizer;h&&h.stopLiveVisualization()}Ui&&u.recordState(),Ui=!1,Ee&&Ee.uuid&&u.emit("noteInteractionEnd",{noteId:Ee.uuid}),ti.forEach(a=>{a.uuid&&u.emit("noteInteractionEnd",{noteId:a.uuid})}),Ee=null,ti=[],xa&&(u.recordState(),xa=!1),dr&&(bs&&u.recordState(),dr=!1,bs=!1,ua&&(u.setSelectedTool(ua),ua=null),(r=ii.get("eraserButton"))==null||r.classList.remove("erasing-active")),Hp()}function Gp(n,e){const{macrobeatGroupings:s,macrobeatBoundaryStyles:o}=u.state;sn(u.state);const r=100,a=[],c=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;console.log("[MODULATION] Boundary calculation - has modulation:",c);for(let g=0;g<o.length;g++)if(o[g]==="solid"){const b=is(u.state,g);if(b){const w=c?ft(b.endColumn+1,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):Lt.getColumnX(b.endColumn+1);console.log(`[MODULATION] Boundary ${g}: measureInfo.endColumn=${b.endColumn}, calculatedX=${w}, method=${c?"modulated":"base"}`),a.push({measureIndex:g+1,xPosition:w,macrobeatIndex:g})}}const h=c?ft(2,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):Lt.getColumnX(2);console.log("[MODULATION] Start boundary: calculatedX=",h,", method=",c?"modulated":"base"),a.unshift({measureIndex:0,xPosition:h,macrobeatIndex:-1}),console.log("[MODULATION] Available measure boundaries:",a),console.log("[MODULATION] Click position:",n,"tolerance:",r);let m=null,f=1/0;return a.forEach(g=>{const b=Math.abs(n-g.xPosition);console.log(`[MODULATION] Boundary at x=${g.xPosition}, distance=${b}`),b<=r&&b<f&&(f=b,m=g)}),m?console.log("[MODULATION] Found closest boundary:",m,"distance:",f):console.log("[MODULATION] No boundary within tolerance"),m}function A_(n,e,s){if(!s)return;const o=dp(s),r=up(s);n.save();const a=3,c=2,h=n.canvas.height;n.strokeStyle=o,n.lineWidth=c,n.globalAlpha=.7,n.setLineDash([]);for(let m=-1;m<=1;m++){const f=e+m*a;n.beginPath(),n.moveTo(f,0),n.lineTo(f,h),n.stroke()}n.globalAlpha=.8,n.font="12px Arial, sans-serif",n.textAlign="center",n.textBaseline="top",n.fillStyle=o,n.fillText(`Preview: ${r}`,e,10),n.restore()}function M_(){const n=document.getElementById("notation-grid"),e=document.getElementById("hover-canvas");if(!n||!e){console.error("PitchGridInteractor: Could not find required canvas elements.");return}Ut=e.getContext("2d"),n.addEventListener("mousedown",S_),n.addEventListener("mousemove",C_),n.addEventListener("mouseleave",Hp),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",T_)}const Cc={init(){M_(),v_(),document.addEventListener("canvasResized",n=>{this.renderPitchGrid(),this.renderDrumGrid()}),lr(async()=>{const{default:n}=await Promise.resolve().then(()=>Qy);return{default:n}},void 0).then(({default:n})=>{n.on("animationUpdate",e=>{e.type==="vibrato"&&e.activeColors&&e.activeColors.length>0?this.renderPitchGrid():e.type==="combined"&&e.vibratoColors&&e.vibratoColors.length>0&&this.renderPitchGrid()})})},renderPitchGrid:ji.render,renderDrumGrid:As.render},$s={};function E_(){return $s.container=document.querySelector("#adsr-envelope"),$s.parentContainer=$s.container.closest(".adsr-container"),$s.sustainTrack=document.getElementById("sustain-slider-track"),$s.sustainThumb=document.getElementById("sustain-slider-thumb"),$s.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),$s.thumbA=document.getElementById("thumb-a"),$s.thumbD=document.getElementById("thumb-d"),$s.thumbR=document.getElementById("thumb-r"),$s}const P_={init:E_,get elements(){return $s}};function jp(){return Xp*u.state.adsrTimeAxisScale}function Up(n,e){const{sustain:s}=u.state.timbres[e.currentColor].adsr,o=.01;n.d=Math.max(n.a+o,n.d),n.r=Math.max(n.d+o,n.r);const r=n.a,a=n.d-n.a,c=n.r-n.d;if(isNaN(r)||isNaN(a)||isNaN(c)){console.error("NaN value detected before setting ADSR. Aborting update.",{newAttack:r,newDecay:a,newRelease:c});return}u.setADSR(e.currentColor,{attack:r,decay:a,release:c,sustain:s})}function k_(n,e){let s=!1;const o=c=>{var x;if(!s)return;const h=n.sustainTrack.getBoundingClientRect();let f=100-(c.clientY-h.top)/h.height*100;f=Math.max(0,Math.min(100,f));const b=(((x=window.staticWaveformVisualizer)==null?void 0:x.getNormalizedAmplitude())||1)*100;f=Math.min(f,b);const w=u.state.timbres[e.currentColor];u.setADSR(e.currentColor,{...w.adsr,sustain:f/100})},r=c=>{s=!0,o(c)},a=()=>{s=!1};n.sustainTrack.addEventListener("pointerdown",r),document.addEventListener("pointermove",o),document.addEventListener("pointerup",a)}function I_(n,e){let s=null;const o=c=>{if(!s)return;const h=n.multiSliderContainer.getBoundingClientRect();let f=(c.clientX-h.left)/h.width*100;f=Math.max(0,Math.min(100,f));const g=f/100*jp(),{attack:b,decay:w,release:x}=u.state.timbres[e.currentColor].adsr,A={a:b,d:b+w,r:b+w+x};s.id==="thumb-a"&&(A.a=g),s.id==="thumb-d"&&(A.d=g),s.id==="thumb-r"&&(A.r=g),Up(A,e)},r=c=>{c.target.classList.contains("time-slider-thumb")&&(s=c.target,o(c))},a=()=>{s=null};n.multiSliderContainer.addEventListener("pointerdown",r),document.addEventListener("pointermove",o),document.addEventListener("pointerup",a)}function D_(n,e){let s=null;const o=c=>{var H;if(!s)return;const h=e.svgContainer,m=h.createSVGPoint();m.x=c.clientX,m.y=c.clientY;const f=m.matrixTransform(h.getScreenCTM().inverse());let g=f.x/e.width*100,b=1-f.y/e.height;g=Math.max(0,Math.min(100,g)),b=Math.max(0,Math.min(1,b));const w=g/100*jp(),x=u.state.timbres[e.currentColor];let{attack:A,decay:I,release:k,sustain:P}=x.adsr;const O={a:A,d:A+I,r:A+I+k};switch(s.id){case"attack-node":O.a=w;break;case"decay-sustain-node":O.d=w;const G=((H=window.staticWaveformVisualizer)==null?void 0:H.getNormalizedAmplitude())||1;P=Math.min(b,G);break;case"release-node":O.r=w;break}const N=u.state.timbres[e.currentColor].adsr.sustain;P!==N&&u.setADSR(e.currentColor,{attack:A,decay:I,release:k,sustain:P}),Up(O,e)},r=c=>{c.target.classList.contains("adsr-node")&&(s=c.target,s.style.cursor="grabbing",o(c))},a=()=>{s&&(s.style.cursor="grab",s=null)};e.nodeLayer.addEventListener("pointerdown",r),document.addEventListener("pointermove",o),document.addEventListener("pointerup",a)}function R_(n){const e=n.ui;k_(e,n),I_(e,n),D_(e,n)}function O_(n,{width:e,height:s},o){for(;n.firstChild;)n.removeChild(n.firstChild);if(o>0){for(let h=1;h<=5;h++)if(h<=o){const m=h/o*e,f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",m),f.setAttribute("y",s-5),f.setAttribute("fill","#d0d0d0"),f.setAttribute("font-size","24"),f.setAttribute("font-weight","bold"),f.setAttribute("text-anchor","middle"),f.setAttribute("dominant-baseline","auto"),f.setAttribute("opacity","0.3"),f.textContent=`${h}s`,n.appendChild(f)}}const r=u.state.tempo;if(r<=0||o<=0)return;const a=30/r;let c=0;for(let h=a;h<o;h+=a){const m=h/o*e,f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",m),f.setAttribute("y1",0),f.setAttribute("x2",m),f.setAttribute("y2",s);const g=(c+1)%2===0;f.setAttribute("stroke",g?"#adb5bd":"#ced4da"),f.setAttribute("stroke-width",g?"1":"0.5"),f.setAttribute("stroke-dasharray","3,3"),n.appendChild(f),c++}}function N_(n,e,s,{height:o,width:r},a,c,h){for(;n.firstChild;)n.removeChild(n.firstChild);for(;e.firstChild;)e.removeChild(e.firstChild);if(s.length===0)return;const m=u.state.colorPalette[a]||{primary:a,light:a},f=m.primary,g=m.light;let b={time:0,feedback:0},w={decay:0,roomSize:0};window.effectsCoordinator&&(b=window.effectsCoordinator.getEffectParameters(a,"delay"),w=window.effectsCoordinator.getEffectParameters(a,"reverb")),h&&h.clearRect(0,0,r,o);const x=(Y,ut=1)=>{if(!h||w.decay===0||w.roomSize===0||!c)return;const dt=w.decay/100*5*(r/c),it=w.roomSize/100*ut;h.filter="blur(30px)";const Ct=parseInt(g.slice(1,3),16),xt=parseInt(g.slice(3,5),16),tt=parseInt(g.slice(5,7),16),et=60;for(let vt=0;vt<et;vt++){const St=vt/et,Dt=(vt+1)/et,Z=Y[1].y+(Y[3].y-Y[1].y)*St,ot=Y[1].y+(Y[3].y-Y[1].y)*Dt,pt=Y[1].x+(Y[3].x-Y[1].x)*St,At=Y[1].x+(Y[3].x-Y[1].x)*Dt,lt=h.createLinearGradient(pt,Z,pt+dt,Z);lt.addColorStop(0,`rgba(${Ct}, ${xt}, ${tt}, ${it})`),lt.addColorStop(1,`rgba(${Ct}, ${xt}, ${tt}, 0)`),h.fillStyle=lt,h.beginPath(),h.moveTo(pt,Z),h.lineTo(pt+dt,Z),h.lineTo(At+dt,ot),h.lineTo(At,ot),h.closePath(),h.fill()}h.filter="none"};if(x(s,1),b.time>0&&b.feedback>0&&c){const Y=Math.max(.01,b.time/100*.5),ut=Math.min(.95,b.feedback/100),dt=.05;let it=ut,Ct=0;for(;it>dt&&Ct<10;){Ct++;const xt=Y*Ct/c*r,tt=s.map(et=>({x:et.x+xt,y:et.y}));if(tt[0].x<r){x(tt,it);const et=document.createElementNS("http://www.w3.org/2000/svg","polygon"),vt=`${tt[0].x},${o} `+tt.map(Dt=>`${Dt.x},${Dt.y}`).join(" ")+` ${Math.min(tt[3].x,r)},${o}`;et.setAttribute("points",vt),et.setAttribute("fill",qs(g,.7*it)),et.setAttribute("class","delay-echo"),n.appendChild(et);const St=document.createElementNS("http://www.w3.org/2000/svg","polyline");St.setAttribute("points",tt.map(Dt=>`${Dt.x},${Dt.y}`).join(" ")),St.setAttribute("stroke-width",2),St.setAttribute("fill","none"),St.setAttribute("stroke",qs(f,it)),St.setAttribute("class","delay-echo"),n.appendChild(St)}it*=ut}}const A=document.createElementNS("http://www.w3.org/2000/svg","polygon"),I=`0,${o} `+s.map(Y=>`${Y.x},${Y.y}`).join(" ")+` ${r},${o}`;A.setAttribute("points",I),A.setAttribute("fill",qs(g,.7)),n.appendChild(A);const k=document.createElementNS("http://www.w3.org/2000/svg","line");k.setAttribute("x1",s[0].x),k.setAttribute("y1",s[0].y),k.setAttribute("x2",s[1].x),k.setAttribute("y2",s[1].y),k.setAttribute("stroke",f),k.setAttribute("stroke-width",2),n.appendChild(k);const P=document.createElementNS("http://www.w3.org/2000/svg","line");P.setAttribute("x1",s[1].x),P.setAttribute("y1",s[1].y),P.setAttribute("x2",s[2].x),P.setAttribute("y2",s[2].y),P.setAttribute("stroke",f),P.setAttribute("stroke-width",2),n.appendChild(P);const O=w.decay>0&&w.roomSize>0?Math.max(.3,1-w.decay/100*(w.roomSize/100)*.7):1,N=document.createElementNS("http://www.w3.org/2000/svg","line");N.setAttribute("x1",s[2].x),N.setAttribute("y1",s[2].y),N.setAttribute("x2",s[3].x),N.setAttribute("y2",s[3].y),N.setAttribute("stroke",qs(f,O)),N.setAttribute("stroke-width",2),n.appendChild(N);const H=["attack-node","decay-sustain-node","release-node"];[s[1],s[2],s[3]].forEach((Y,ut)=>{const dt=document.createElementNS("http://www.w3.org/2000/svg","circle");dt.setAttribute("id",H[ut]),dt.setAttribute("class","adsr-node"),dt.setAttribute("cx",Y.x),dt.setAttribute("cy",Y.y),dt.setAttribute("r",8),dt.setAttribute("fill",f),dt.setAttribute("stroke",Pa(f,-.3)),dt.setAttribute("stroke-width",2),dt.style.cursor="grab";const it=document.createElementNS("http://www.w3.org/2000/svg","title");dt.appendChild(it),e.appendChild(dt)})}function L_(n,e){const s=Pa(e,-.2);n.style.setProperty("--c-accent",e),n.style.setProperty("--c-accent-hover",s)}const xe={};let yn=null,ri=!1;function F_(n,e){const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("data-playhead-id",n);const o=document.createElementNS("http://www.w3.org/2000/svg","line");o.setAttribute("stroke",e),o.setAttribute("stroke-width",2),o.setAttribute("stroke-dasharray","3,3"),s.appendChild(o);const r=document.createElementNS("http://www.w3.org/2000/svg","circle");return r.setAttribute("r",5),r.setAttribute("fill",e),s.appendChild(r),s}function $_(n,e,s,o=null){if(!(!yn||!o)){if(e==="attack"){xe[n]&&(cancelAnimationFrame(xe[n].requestId),xe[n].group.remove());const r=F_(n,s);yn.playheadLayer.appendChild(r),xe[n]={group:r,phase:e,color:s,adsr:o,requestId:null,startTimestamp:J.now(),elapsed:0},Sh(n)}else if(e==="release"){if(ri)return;const r=xe[n];if(!r)return;cancelAnimationFrame(r.requestId),r.phase="release",r.adsr=o,r.startTimestamp=J.now(),r.elapsed=0,Th(n)}}}function Sh(n){if(!xe[n]||ri)return;const e=xe[n];if(!e.adsr)return;const{attack:s,decay:o}=e.adsr,r=yn.calculateEnvelopePoints(e.adsr);if(r.length<4)return;const[a,c,h]=r,m=J.now()-e.startTimestamp;e.elapsed=m;const f=s+o,g=Math.min(m,f);let b,w;if(g<=s){const I=s>0?g/s:1;b=a.x+I*(c.x-a.x),w=a.y+I*(c.y-a.y)}else{const I=g-s,k=o>0?I/o:1;b=c.x+k*(h.x-c.x),w=c.y+k*(h.y-c.y)}const[x,A]=e.group.children;x.setAttribute("x1",b),x.setAttribute("y1",0),x.setAttribute("x2",b),x.setAttribute("y2",yn.height),A.setAttribute("cx",b),A.setAttribute("cy",w),g<f?e.requestId=requestAnimationFrame(()=>Sh(n)):(e.phase="sustain",Ch(n))}function Ch(n){if(!xe[n]||ri)return;const e=xe[n];if(!e.adsr)return;const s=yn.calculateEnvelopePoints(e.adsr);if(s.length<4)return;const[,,o]=s,[r,a]=e.group.children;r.setAttribute("x1",o.x),r.setAttribute("y1",0),r.setAttribute("x2",o.x),r.setAttribute("y2",yn.height),a.setAttribute("cx",o.x),a.setAttribute("cy",o.y),e.requestId=requestAnimationFrame(()=>Ch(n))}function Th(n){if(!xe[n]||ri)return;const e=xe[n];if(!e.adsr)return;const{release:s}=e.adsr,o=yn.calculateEnvelopePoints(e.adsr);if(o.length<4)return;const[,,r,a]=o,c=J.now()-e.startTimestamp;e.elapsed=c;const h=Math.min(c,s),m=s>0?h/s:1,f=r.x+m*(a.x-r.x),g=r.y+m*(a.y-r.y),[b,w]=e.group.children;b.setAttribute("x1",f),b.setAttribute("y1",0),b.setAttribute("x2",f),b.setAttribute("y2",yn.height),w.setAttribute("cx",f),w.setAttribute("cy",g),h<s?e.requestId=requestAnimationFrame(()=>Th(n)):(e.group.remove(),delete xe[n])}function B_(){ri=!0;for(const n in xe){const e=xe[n];e.requestId&&(cancelAnimationFrame(e.requestId),e.requestId=null)}}function q_(){ri=!1;for(const n in xe){const e=xe[n];e.startTimestamp=J.now()-e.elapsed,e.phase==="attack"?Sh(n):e.phase==="sustain"?Ch(n):e.phase==="release"&&Th(n)}}function z_(){ri=!1;for(const n in xe){const e=xe[n];cancelAnimationFrame(e.requestId),e.group.remove()}for(const n in xe)delete xe[n]}function W_(n){return yn=n,{trigger:$_,pause:B_,resume:q_,clearAll:z_}}const Xp=2.5;class V_{constructor(){var e;this.ui=P_.init(),this.currentColor=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=W_(this),Ps.adsrComponent=this,R_(this),this.listenForStoreChanges(),this.initControls(),this.ui.container&&new ResizeObserver(()=>this.resize()).observe(this.ui.container),this.updateFromStore(),this.updateComponentWidth(u.state.adsrComponentWidth),T.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const e=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*e,this.reverbCanvas.height=this.height*e,this.reverbCtx.scale(e,e)}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const e=u.state.timbres[this.currentColor];e&&({attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release}=e.adsr,this.render(),this.updateControls())}getCurrentMaxTime(){return Xp*u.state.adsrTimeAxisScale}updateComponentWidth(e){if(this.ui.parentContainer){const o=.5+u.state.adsrTimeAxisScale*.2,r=e*o;this.ui.parentContainer.style.setProperty("width",`${r}%`,"important"),this.resize()}}updateTimeScaleWidth(){const e=u.state.adsrComponentWidth;this.updateComponentWidth(e)}initControls(){const e=document.getElementById("adsr-time-scale"),s=document.getElementById("adsr-time-scale-value");e&&s&&(e.value=u.state.adsrTimeAxisScale,s.textContent=`${u.state.adsrTimeAxisScale}x`,e.addEventListener("input",a=>{const c=parseFloat(a.target.value);u.setAdsrTimeAxisScale(c),s.textContent=`${c}x`}));const o=document.getElementById("adsr-width-scale"),r=document.getElementById("adsr-width-scale-value");o&&r&&(o.value=u.state.adsrComponentWidth,r.textContent=`${u.state.adsrComponentWidth}%`,o.addEventListener("input",a=>{const c=parseInt(a.target.value);u.setAdsrComponentWidth(c),r.textContent=`${c}%`}))}listenForStoreChanges(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.updateFromStore())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.updateFromStore()}),u.on("tempoChanged",()=>this.render()),u.on("adsrTimeAxisScaleChanged",e=>{this.render(),this.updateSliders(),this.updateTimeScaleWidth()}),u.on("adsrComponentWidthChanged",e=>{this.updateComponentWidth(e)}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{e&&e.includes(this.currentColor)&&this.render()}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e?s?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),u.on("audioEffectChanged",({effectType:e,color:s})=>{s===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(e=this){var A;const{attack:s,decay:o,sustain:r,release:a}=e;if(!this.width||!this.height)return[];const c=I=>I/this.getCurrentMaxTime()*this.width;let h=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(h=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const f=(((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)||1)*h,g={x:0,y:this.height},b={x:c(s),y:this.height*(1-f)},w={x:c(s+o),y:this.height*(1-Math.min(r*f,f))},x={x:c(s+o+a),y:this.height};return[g,b,w,x]}render(){if(!this.ui||!this.width||!this.height)return;const e={width:this.width,height:this.height},s=this.calculateEnvelopePoints(),o=this.getCurrentMaxTime();O_(this.gridLayer,e,o),N_(this.envelopeLayer,this.nodeLayer,s,e,this.currentColor,o,this.reverbCtx),L_(this.ui.parentContainer,this.currentColor)}updateControls(){var I;if(!this.ui.sustainThumb)return;let e=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(e=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const o=(((I=window.staticWaveformVisualizer)==null?void 0:I.calculatedAmplitude)||1)*e,r=o*100;if(this.sustain>o){const k=u.state.timbres[this.currentColor];u.setADSR(this.currentColor,{...k.adsr,sustain:o}),this.sustain=o}const a=this.sustain*100;this.ui.sustainThumb.style.bottom=`${a}%`,this.ui.sustainTrack.style.setProperty("--sustain-progress",`${a}%`);const c=100-r;this.ui.sustainTrack.style.setProperty("--ineligible-height",`${c}%`);const h=this.attack/this.getCurrentMaxTime()*100,m=(this.attack+this.decay)/this.getCurrentMaxTime()*100,f=(this.attack+this.decay+this.release)/this.getCurrentMaxTime()*100;this.ui.thumbA.style.left=`${h}%`,this.ui.thumbD.style.left=`${m}%`,this.ui.thumbR.style.left=`${f}%`,this.ui.multiSliderContainer.style.setProperty("--adr-progress",`${f}%`);const g=k=>`${k.toFixed(3)}s`,b=k=>`${(k*100).toFixed(0)}%`;this.ui.thumbA.title=`Attack: ${g(this.attack)}`,this.ui.thumbD.title=`Decay: ${g(this.decay)}`,this.ui.thumbR.title=`Release: ${g(this.release)}`,this.ui.sustainThumb.title=`Sustain: ${b(this.sustain)}`;const w=this.nodeLayer.querySelector("#attack-node > title");w&&(w.textContent=`Attack: ${g(this.attack)}`);const x=this.nodeLayer.querySelector("#decay-sustain-node > title");x&&(x.textContent=`Decay: ${g(this.decay)}
Sustain: ${b(this.sustain)}`);const A=this.nodeLayer.querySelector("#release-node > title");A&&(A.textContent=`Release: ${g(this.release)}`)}}function H_(){return document.getElementById("adsr-envelope")?new V_:null}let or,Xi,Kn,Yi,Sa,tn,en,Yc=!1,Zc=!1,Qc=!1,Ws;const Ca=1,Yp=31,Zp=0,Ta=2;function Tc(){if(!Ws)return;const n=u.state.timbres[Ws];if(!n)return;n.filter?n.filter.enabled===void 0&&(n.filter.enabled=!0):n.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0};const{cutoff:e,blend:s,mix:o}=n.filter;if(or&&Xi){const r=(Ta-s)/(Ta-Zp);or.style.left=`${r*100}%`,Xi.style.setProperty("--progress",`${r*100}%`)}if(tn&&en){const r=(o||0)/100;tn.style.bottom=`${r*100}%`,en.style.setProperty("--blend-progress",`${r*100}%`)}if(Kn&&Yi){const r=(e-Ca)/(Yp-Ca);Kn.style.left=`${r*100}%`,Kn.style.top="50%",Kn.style.transform="translate(-50%, -50%)",Yi.style.setProperty("--progress",`${r*100}%`)}Sa&&Sa.style.setProperty("--c-accent",Ws)}function G_(n){if(!Yc)return;const e=Yi.getBoundingClientRect(),s=n.clientX-e.left,o=e.width;let r=s/o;r=Math.max(0,Math.min(1,r));const a=r*(Yp-Ca)+Ca;u.setFilterSettings(Ws,{cutoff:a})}function j_(n){if(!Zc)return;const e=Xi.getBoundingClientRect(),s=n.clientX-e.left,o=e.width;let r=s/o;r=Math.max(0,Math.min(1,r));const a=Ta-r*(Ta-Zp);u.setFilterSettings(Ws,{blend:a})}function U_(n){if(!Qc)return;const e=en.getBoundingClientRect(),s=n.clientY-e.top,o=e.height;let r=1-s/o;r=Math.max(0,Math.min(1,r));const a=r*100;u.setFilterSettings(Ws,{mix:a})}function X_(){var e;if(Sa=document.querySelector(".harmonic-bins-container"),or=document.getElementById("thumb-b"),Xi=document.getElementById("blend-slider-container"),Kn=document.getElementById("thumb-c"),Yi=document.getElementById("cutoff-slider-container"),!Sa||!or||!Kn)return;const n=document.querySelector(".blend-slider-container");n&&Xi&&(n.getBoundingClientRect(),Xi.getBoundingClientRect()),Yi&&Yi.getBoundingClientRect(),Y_(),or.addEventListener("mousedown",s=>{s.preventDefault(),Zc=!0,document.body.style.cursor="ew-resize";const o=a=>j_(a),r=()=>{Zc=!1,document.body.style.cursor="default",window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",r),u.recordState()};window.addEventListener("mousemove",o),window.addEventListener("mouseup",r)}),Kn.addEventListener("mousedown",s=>{s.preventDefault(),Yc=!0,document.body.style.cursor="ew-resize";const o=a=>G_(a),r=()=>{Yc=!1,document.body.style.cursor="default",window.removeEventListener("mousemove",o),window.removeEventListener("mouseup",r),u.recordState()};window.addEventListener("mousemove",o),window.addEventListener("mouseup",r)}),u.on("noteChanged",({newNote:s})=>{s.color&&s.color!==Ws&&(Ws=s.color,Tc())}),u.on("timbreChanged",s=>{s===Ws&&Tc()}),Ws=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",Tc(),setTimeout(()=>{const s=document.querySelector(".blend-slider-container");s&&s.getBoundingClientRect()},100)}function Y_(){const n=document.querySelector(".filter-button-wrapper");n&&(n.innerHTML="",n.className="vertical-blend-wrapper",en=document.createElement("div"),en.id="vertical-blend-track",en.className="vertical-slider-track",tn=document.createElement("div"),tn.id="vertical-blend-thumb",tn.className="vertical-slider-thumb",tn.textContent="M",tn.title="Filter Mix: 0% to 100%",en.appendChild(tn),n.appendChild(en),tn.addEventListener("mousedown",e=>{e.preventDefault(),Qc=!0,document.body.style.cursor="ns-resize";const s=r=>U_(r),o=()=>{Qc=!1,document.body.style.cursor="default",window.removeEventListener("mousemove",s),window.removeEventListener("mouseup",o),u.recordState()};window.addEventListener("mousemove",s),window.addEventListener("mouseup",o)}),en.addEventListener("click",e=>{if(e.target===tn)return;const s=en.getBoundingClientRect(),o=e.clientY-s.top,r=s.height;let a=1-o/r;a=Math.max(0,Math.min(1,a));const c=a*100;u.setFilterSettings(Ws,{mix:c}),u.recordState()}))}function Z_(n,e,s){if(!(e.length<2)){n.globalAlpha=s.opacity;for(let o=1;o<e.length;o++){const r=e[o-1],a=e[o];if(a.timestamp-r.timestamp>200)continue;const c=n.createLinearGradient(r.x,r.y,a.x,a.y);c.addColorStop(0,`rgb(${r.color.join(",")})`),c.addColorStop(1,`rgb(${a.color.join(",")})`),n.strokeStyle=c,n.lineWidth=(r.thickness+a.thickness)/2,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(r.x,r.y),n.lineTo(a.x,a.y),n.stroke()}n.globalAlpha=1}}function Q_(n,e){const s=u.state,o=sn(u.state),r=s.fullRowData.slice(n.topRow,n.bottomRow+1);let a=s.placedNotes.filter(G=>!G.isDrum&&G.row>=n.topRow&&G.row<=n.bottomRow).map(G=>({...G,row:G.row-n.topRow})),c=n.includeDrums?s.placedNotes.filter(G=>G.isDrum):[];if(n.colorMode==="bw"){const G=Y=>Y.map(ut=>({...ut,color:"#212529"}));a=G(a),c=G(c)}const h=s.columnWidths.reduce((G,Y)=>G+Y,0),m=50,f=m*2,g=f/2,b=h*m,w=r.length*g,x=n.includeDrums?3*.5*f:0,A=x>0?30:0,I=w+A+x,k=Math.min(e.width/b,e.height/I),P=document.createElement("canvas");P.width=b*k,P.height=I*k;const O=P.getContext("2d");O.scale(k,k),O.fillStyle="#FFF",O.fillRect(0,0,b,I);const N={placedNotes:a,placedTonicSigns:o,fullRowData:r,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles,colorMode:n.colorMode,degreeDisplayMode:"off"},H=document.createElement("canvas");if(H.width=b,H.height=w,Lp(H.getContext("2d"),N),O.drawImage(H,0,0),s.paint&&s.paint.paintHistory.length>0){console.log(`[PrintService] Found ${s.paint.paintHistory.length} paint points to print.`);const G=document.createElement("canvas");G.width=b,G.height=w;const Y=G.getContext("2d"),ut=document.getElementById("notation-grid"),dt=b/ut.width,it=w/(ut.height*(r.length/s.fullRowData.length)),Ct=n.topRow*g,xt=s.paint.paintHistory.map(tt=>({...tt,x:tt.x*dt,y:tt.y*it-Ct,thickness:tt.thickness*Math.min(dt,it)}));Z_(Y,xt,{opacity:s.paint.paintSettings.opacity/100}),O.drawImage(G,0,0),console.log("[PrintService] Paint trail has been rendered for printing.")}if(n.includeDrums){const G={placedNotes:c,placedTonicSigns:o,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles},Y=document.createElement("canvas");Y.width=b,Y.height=x,Bp(Y.getContext("2d"),G),O.drawImage(Y,0,w+A)}return P}const Id={generateScoreCanvas:Q_,generateAndPrint(){const n=u.state.printOptions,e=300,s=(n.orientation==="landscape"?10.5:8)*e,o=(n.orientation==="landscape"?8:10.5)*e,r=this.generateScoreCanvas(n,{width:s,height:o}),a=document.getElementById("print-staging-area");a.innerHTML="";const c=document.getElementById("print-style-rules");c.textContent=`@page { size: ${n.orientation}; margin: 0.25in; }`;const h=document.createElement("img");h.src=r.toDataURL("image/png"),h.style.width="100%",h.style.height="auto",a.appendChild(h),setTimeout(()=>window.print(),100)}},J_={init(){this.overlay=document.getElementById("print-preview-overlay"),this.overlay&&(this.canvas=document.getElementById("print-preview-canvas"),this.ctx=this.canvas.getContext("2d"),this.canvasWrapper=this.canvas.parentElement,this.topRowSlider=document.getElementById("print-top-row-slider"),this.bottomRowSlider=document.getElementById("print-bottom-row-slider"),this.topRowLabel=document.getElementById("print-top-row-label"),this.bottomRowLabel=document.getElementById("print-bottom-row-label"),this.orientationBtn=document.getElementById("print-orientation-toggle"),this.colorBtn=document.getElementById("print-color-mode-toggle"),this.drumsBtn=document.getElementById("print-drums-toggle"),document.getElementById("print-close-button").addEventListener("click",()=>this.hide()),document.getElementById("print-confirm-button").addEventListener("click",()=>{Id.generateAndPrint(),this.hide()}),this.topRowSlider.addEventListener("input",n=>u.setPrintOptions({topRow:parseInt(n.target.value)})),this.bottomRowSlider.addEventListener("input",n=>u.setPrintOptions({bottomRow:parseInt(n.target.value)})),this.orientationBtn.addEventListener("click",()=>this.handleToggle("orientation",["landscape","portrait"])),this.colorBtn.addEventListener("click",()=>this.handleToggle("colorMode",["color","bw"])),this.drumsBtn.addEventListener("click",()=>this.handleToggle("includeDrums",[!0,!1])),u.on("printPreviewStateChanged",n=>n?this.show():this.hide()),u.on("printOptionsChanged",()=>this.render()),u.on("notesChanged",()=>{u.state.isPrintPreviewActive&&this.render()}),new ResizeObserver(()=>{u.state.isPrintPreviewActive&&this.render()}).observe(this.canvasWrapper))},show(){console.log("🖨️ [PRINT PREVIEW] Showing preview"),u.state.isPrintPreviewActive||u.setPrintPreviewActive(!0),this.overlay.classList.remove("hidden");const n=u.state.placedNotes.filter(c=>!c.isDrum);let e=n.length>0?1/0:34,s=n.length>0?-1/0:54;n.forEach(c=>{e=Math.min(e,c.row),s=Math.max(s,c.row)});const o=2,r=Math.max(0,e-o),a=Math.min(u.state.fullRowData.length-1,s+o);this.topRowSlider.max=u.state.fullRowData.length-1,this.bottomRowSlider.max=u.state.fullRowData.length-1,u.setPrintOptions({...u.state.printOptions,topRow:r,bottomRow:a})},hide(){console.log("🖨️ [PRINT PREVIEW] Hiding preview"),u.state.isPrintPreviewActive&&u.setPrintPreviewActive(!1),this.overlay.classList.add("hidden")},handleToggle(n,e){const o=u.state.printOptions[n]===e[0]?e[1]:e[0];u.setPrintOptions({[n]:o})},updateControls(){var a,c;const{topRow:n,bottomRow:e,orientation:s,colorMode:o,includeDrums:r}=u.state.printOptions;this.topRowSlider.value=n,this.bottomRowSlider.value=e,this.topRowLabel.textContent=((a=u.state.fullRowData[n])==null?void 0:a.pitch)||"N/A",this.bottomRowLabel.textContent=((c=u.state.fullRowData[e])==null?void 0:c.pitch)||"N/A",this.orientationBtn.textContent=s.charAt(0).toUpperCase()+s.slice(1),this.colorBtn.textContent=o==="color"?"Color":"B&W",this.drumsBtn.textContent=r?"Yes":"No",this.drumsBtn.classList.toggle("active",r),this.colorBtn.classList.toggle("active",o==="color")},render(){if(!u.state.isPrintPreviewActive)return;this.updateControls();const n=this.canvasWrapper.clientWidth,e=this.canvasWrapper.clientHeight;if(n===0||e===0)return;const s=Id.generateScoreCanvas(u.state.printOptions,{width:n,height:e});s&&(this.canvas.width=s.width,this.canvas.height=s.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(s,0,0))}};T.moduleLoaded("DynamicWaveformVisualizer");class K_{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.isPlaybackActive=!1,this.liveAnalysers=new Map,this.liveWaveforms=new Map,this.playbackAnimationId=null,this.animationSpeed=100,this.frameSkipCounter=0,T.info("DynamicWaveformVisualizer","Initialized for live waveform visualization",null,"waveform")}initialize(e,s){var o;return this.canvas=e,this.ctx=s,this.currentColor=((o=u.state.selectedNote)==null?void 0:o.color)||"#4a90e2",this.setupEventListeners(),T.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color)}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e&&!s?this.startLiveVisualization():this.stopLiveVisualization()}),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.startSingleNoteVisualization(e):this.stopLiveVisualization()}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{this.isPlaybackActive&&e&&e.some(s=>this.liveWaveforms.has(s))&&T.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",e,"waveform")}),T.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),T.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(e){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(e),this.updateContainerState(!0),this.animateLiveWaveforms(),T.debug("DynamicWaveformVisualizer",`Started single note visualization for ${e}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1,this.liveAnalysers.forEach((e,s)=>{window.synthEngine&&window.synthEngine.removeWaveformAnalyzer(s)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),T.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(e){var o;const s=(o=this.canvas)==null?void 0:o.parentElement;s&&(e?(s.classList.add("live-mode"),u.state.isPlaying&&!u.state.isPaused&&s.classList.add("pulsing")):s.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const e=window.synthEngine;if(!e){T.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(o=>{const r=e.createWaveformAnalyzer(o);r&&(this.liveAnalysers.set(o,r),this.liveWaveforms.set(o,new Float32Array(1024)),T.debug("DynamicWaveformVisualizer",`Created analyser for ${o}`,null,"waveform"))})}setupSingleAnalyser(e){const s=window.synthEngine;if(!s)return;const o=s.createWaveformAnalyzer(e);o&&(this.liveAnalysers.set(e,o),this.liveWaveforms.set(e,new Float32Array(1024)),T.debug("DynamicWaveformVisualizer",`Created single analyser for ${e}`,null,"waveform"))}getActivePlayingColors(){const e=new Set;u.state.isPlaying&&u.state.placedNotes.forEach(o=>{!o.isDrum&&o.color&&e.add(o.color)}),e.size===0&&this.currentColor&&e.add(this.currentColor);const s=Array.from(e);return T.debug("DynamicWaveformVisualizer","Active playing colors detected",s,"waveform"),s}animateLiveWaveforms(){if(!this.isPlaybackActive)return;this.frameSkipCounter++;const e=Math.floor(100/this.animationSpeed);if(this.frameSkipCounter%e!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((s,o)=>{const r=s.getValue();this.liveWaveforms.set(o,r)}),this.onWaveformUpdate&&this.onWaveformUpdate(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(e,s,o){const r=Array.from(this.liveWaveforms.keys());if(r.length===1){const a=r[0],c=this.liveWaveforms.get(a);this.drawSingleLiveWaveform(c,a,e,s,o)}else r.length>1&&r.forEach((a,c)=>{const h=this.liveWaveforms.get(a);this.drawLayeredLiveWaveform(h,a,e,s,o,r.length)})}drawSingleLiveWaveform(e,s,o,r,a){if(!e||e.length===0)return;let c=a,h=1;window.animationEffectsManager&&s&&(h=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s),c=c*h);let m=0;for(let b=0;b<e.length;b++)m=Math.max(m,Math.abs(e[b]));const f=m>1?1/m:1;this.ctx.strokeStyle=s,this.ctx.lineWidth=2,this.ctx.beginPath();const g=e.length/o;for(let b=0;b<o;b++){const w=Math.floor(b*g),x=(e[w]||0)*f,A=r-x*c;b===0?this.ctx.moveTo(b,A):this.ctx.lineTo(b,A)}this.ctx.stroke(),T.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${s} with tremolo`,{tremoloMultiplier:c/a},"waveform")}drawLayeredLiveWaveform(e,s,o,r,a,c){if(!e||e.length===0)return;let h=a;if(window.animationEffectsManager&&s){const x=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s);h=h*x}let m=0;for(let x=0;x<e.length;x++)m=Math.max(m,Math.abs(e[x]));const f=m>1?1/m:1,g=Math.max(.4,1/c),b=qs(s,g*2);qs(s,g*.5),this.ctx.strokeStyle=b,this.ctx.lineWidth=1.5,this.ctx.beginPath();const w=e.length/o;for(let x=0;x<o;x++){const A=Math.floor(x*w),I=(e[A]||0)*f,k=r-I*h*.7;x===0?this.ctx.moveTo(x,k):this.ctx.lineTo(x,k)}this.ctx.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),T.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}T.moduleLoaded("StaticWaveformVisualizer");class tw{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.animationFrameId=null,this.waveformData=new Float32Array(512),this.isInitialized=!1,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=300,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null,this.dynamicVisualizer=new K_,this.animationSpeed=100,this.frameSkipCounter=0,T.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){var s;if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;this.ctx=this.canvas.getContext("2d"),this.currentColor=((s=u.state.selectedNote)==null?void 0:s.color)||"#4a90e2";const e=this.canvas.parentElement;return e&&new ResizeObserver(()=>this.resize()).observe(e),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const e=this.canvas.parentElement;if(!e)return;const{clientWidth:s,clientHeight:o}=e,r=this.canvas.width,a=this.canvas.height;if((s===0||o===0)&&this.canvas.width>0&&this.canvas.height>0)return;const h=Math.abs(s-r),m=Math.abs(o-a);(h>2||m>2)&&(this.canvas.width=s,this.canvas.height=o,this.draw())}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.generateWaveform())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.generateWaveform()}),u.on("waveformExtendedViewChanged",e=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>{this.resize()},100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const e=document.querySelectorAll(".waveform-speed-btn");e.forEach(s=>{s.addEventListener("click",()=>{const o=parseInt(s.dataset.speed);s.classList.contains("active")?(s.classList.remove("active"),this.setAnimationSpeed(100)):(e.forEach(r=>r.classList.remove("active")),s.classList.add("active"),this.setAnimationSpeed(o))})})}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(e)}setupExtendToggle(){const e=document.getElementById("waveform-extend-toggle");e&&(e.addEventListener("click",()=>{u.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const e=document.getElementById("waveform-extend-toggle");if(e){const s=u.state.waveformExtendedView;e.classList.toggle("extended",s),e.textContent=s?"480° View":"360° View",e.title=s?"Switch to 360° waveform view":"Switch to 480° waveform view (shows extra 120°)"}}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const e=u.state.timbres[this.currentColor];if(!e||!e.coeffs)return;const s=ya(this.currentColor),o=e.phases||[],r=this.waveformData.length,a=1,c=[];for(let m=0;m<s.length;m++)s[m]>.001&&c.push(`${m===0?"F0":"H"+(m+1)}: ${s[m].toFixed(3)}`);this.waveformData.fill(0);let h=0;for(let m=0;m<r;m++){const g=(u.state.waveformExtendedView?480:360)/360,b=m/r*g*2*Math.PI;let w=0;for(let x=0;x<Ki;x++){const A=s[x]||0;if(A>.001){const I=o[x]||0,k=x+1;w+=A*Math.sin(k*b+I)}}this.waveformData[m]=w*a,h=Math.max(h,Math.abs(w*a))}if(this.calculatedAmplitude=Math.min(1,h),h>1){const m=1/h;for(let f=0;f<this.waveformData.length;f++)this.waveformData[f]*=m}this.draw()}startPhaseTransition(e,s,o){this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(s),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition()}generateTargetWaveform(e){if(!this.currentColor)return;const s=u.state.timbres[this.currentColor];if(!s||!s.coeffs)return;const o=ya(this.currentColor),r=this.waveformData.length,a=1;this.waveformData.fill(0);let c=0;for(let h=0;h<r;h++){const f=(u.state.waveformExtendedView?480:360)/360,g=h/r*f*2*Math.PI;let b=0;for(let w=0;w<Ki;w++){const x=o[w]||0;if(x>.001){const A=e[w]||0,I=w+1;b+=x*Math.sin(I*g+A)}}this.waveformData[h]=b*a,c=Math.max(c,Math.abs(b*a))}if(this.calculatedAmplitude=Math.min(1,c),c>1){const h=1/c;for(let m=0;m<this.waveformData.length;m++)this.waveformData[m]*=h}}animateTransition(){if(!this.isTransitioning)return;const e=performance.now()-this.transitionStartTime,s=Math.min(e/this.transitionDuration,1),o=1-Math.pow(1-s,3);for(let r=0;r<this.waveformData.length;r++)this.waveformData[r]=this.fromWaveform[r]+(this.toWaveform[r]-this.fromWaveform[r])*o;this.draw(),s>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let e=0;for(let s=0;s<this.waveformData.length;s++)e=Math.max(e,Math.abs(this.waveformData[s]));if(e>0){const s=.9/e;for(let o=0;o<this.waveformData.length;o++)this.waveformData[o]*=s}}draw(){if(!this.ctx||!this.canvas)return;const{width:e,height:s}=this.canvas,o=s/2,r=s/2;this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,e,s),this.drawGrid(e,s,o,r),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(e,o,r):this.drawWaveform(e,o,r),e>200&&s>100&&this.drawLabels(e,s)}drawGrid(e,s,o,r){this.ctx.strokeStyle="#ced4da",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,o),this.ctx.lineTo(e,o),this.ctx.stroke();const a=u.state.waveformExtendedView?480:360;if((u.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(g=>{const b=e/a*g;this.ctx.beginPath(),this.ctx.moveTo(b,0),this.ctx.lineTo(b,s),this.ctx.stroke()}),u.state.waveformExtendedView){const g=e/480*360;this.ctx.fillStyle="rgba(128, 128, 128, 0.15)",this.ctx.fillRect(g,0,e-g,s)}[.5].forEach(g=>{const b=o-r*g,w=o+r*g;this.ctx.beginPath(),this.ctx.moveTo(0,b),this.ctx.lineTo(e,b),this.ctx.moveTo(0,w),this.ctx.lineTo(e,w),this.ctx.stroke()}),this.ctx.setLineDash([]),this.ctx.strokeStyle="#999999",this.ctx.lineWidth=1;const m=o-r,f=o+r;this.ctx.beginPath(),this.ctx.moveTo(0,m),this.ctx.lineTo(e,m),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,f),this.ctx.lineTo(e,f),this.ctx.stroke()}drawWaveform(e,s,o){if(this.waveformData.length===0)return;const r=this.currentColor||"#4A90E2";this.ctx.strokeStyle=r,this.ctx.lineWidth=2,this.ctx.beginPath();const a=this.waveformData.length/e;for(let h=0;h<e;h++){const m=Math.floor(h*a),f=this.waveformData[m]||0,g=s-f*o;h===0?this.ctx.moveTo(h,g):this.ctx.lineTo(h,g)}this.ctx.stroke(),this.ctx.lineTo(e,s),this.ctx.lineTo(0,s),this.ctx.closePath();const c=this.ctx.createLinearGradient(0,s-o,0,s+o);c.addColorStop(0,qs(r,.3)),c.addColorStop(.5,qs(r,.1)),c.addColorStop(1,qs(r,.3)),this.ctx.fillStyle=c,this.ctx.fill()}drawLabels(e,s){this.ctx.fillStyle="#666666",this.ctx.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.ctx.textAlign="center";const o=u.state.waveformExtendedView?480:360,r=u.state.waveformExtendedView?["0°","90°","180°","270°","360°","450°"]:["0°","90°","180°","270°","360°"],a=u.state.waveformExtendedView?[0,90,180,270,360,450]:[0,90,180,270,360];r.forEach((c,h)=>{const m=e/o*a[h]+10;this.ctx.fillText(c,m,s/2+4)}),this.ctx.textAlign="left",this.ctx.fillText("+1.0",5,15),this.ctx.fillText("-1.0",5,s-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const e=this.calculatedAmplitude||0;if(window.animationEffectsManager&&this.currentColor){const s=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor);return e*s}return e}startSingleNoteVisualization(e){return this.dynamicVisualizer.startSingleNoteVisualization(e)}stopLiveVisualization(){return this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){return this.dynamicVisualizer.startLiveVisualization()}dispose(){this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const Qp=new tw;window.staticWaveformVisualizer=Qp;function ew(){return Qp.initialize()}class Jp{constructor(e){this.effectName=e,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,T.info(`${e}AnimationEffect`,"Base initialized",null,"animation")}initBase(){u.on("visualEffectChanged",({effectType:e,parameter:s,value:o,color:r,effectParams:a})=>{e===this.effectName.toLowerCase()&&this.updateAnimationParameters(r,a)}),u.on("playbackStarted",()=>{this.isPlaybackActive=!0,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteInteractionStart",({noteId:e,color:s})=>this.onNoteInteractionStart(e,s)),u.on("noteInteractionEnd",({noteId:e})=>this.onNoteInteractionEnd(e)),u.on("ghostNoteUpdated",({color:e})=>this.onGhostNoteUpdated(e)),u.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.isPlaybackActive=!0:this.isPlaybackActive=!1,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteAttack",({noteId:e,color:s})=>this.onNoteAttack(e,s)),u.on("noteRelease",({noteId:e,color:s})=>this.onNoteRelease(e,s)),u.on("effectDialInteractionStart",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionStart(s)}),u.on("effectDialInteractionEnd",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionEnd(s)}),T.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}updateAnimationParameters(e,s){throw new Error("updateAnimationParameters must be implemented by subclass")}updateAnimationPhases(e){throw new Error("updateAnimationPhases must be implemented by subclass")}shouldAnimateColor(e){return!!this.animations.get(e)}shouldAnimateNote(e){if(!this.shouldAnimateColor(e.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const o=this.activeNoteAnimations.get("dial-preview");if(e.color===o)return!0}return!!(this.isPlaybackActive&&e.uuid&&this.activeSoundingNotes.has(e.uuid)||this.hasActiveInteraction&&e.uuid&&this.activeNoteAnimations.has(e.uuid)||!e.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===e.color&&this.isPlaybackActive)}shouldBeRunning(){const e=this.animations.size>0;return e?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||e:!1}onNoteInteractionStart(e,s){this.shouldAnimateColor(s)&&(this.activeNoteAnimations.set(e,s),this.hasActiveInteraction=!0,T.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${e} (${s})`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteInteractionEnd(e){this.activeNoteAnimations.delete(e),this.hasActiveInteraction=this.activeNoteAnimations.size>0,T.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onGhostNoteUpdated(e){this.shouldAnimateColor(e)?(this.ghostNoteAnimation={color:e,active:!0},T.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${e}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,T.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(e,s){this.shouldAnimateColor(s)&&(this.activeSoundingNotes.set(e,s),T.debug(`${this.effectName}AnimationEffect`,`Note attack: ${e} (${s}) added to active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteRelease(e,s){this.activeSoundingNotes.delete(e),T.debug(`${this.effectName}AnimationEffect`,`Note release: ${e} (${s}) removed from active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onDialInteractionStart(e){this.shouldAnimateColor(e)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",e),T.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onDialInteractionEnd(e){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),T.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}getActiveColors(){const e=new Set;for(const[s,o]of this.activeSoundingNotes.entries())this.shouldAnimateColor(o)&&e.add(o);for(const[s,o]of this.activeNoteAnimations.entries())this.shouldAnimateColor(o)&&e.add(o);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&e.add(this.ghostNoteAnimation.color),Array.from(e)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,T.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}}T.moduleLoaded("VibratoCanvasEffect");class sw extends Jp{constructor(){super("Vibrato"),T.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),T.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(e,s){const{speed:o,span:r}=s;if(o===0||r===0)this.animations.delete(e),T.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${e}`,null,"animation");else{const a=this.animations.get(e),c=o/100*16,h=r/100*.5,m={frequency:c,amplitude:h,phase:(a==null?void 0:a.phase)||Math.PI/2,lastUpdate:performance.now()};this.animations.set(e,m),T.debug("VibratoCanvasEffect",`Updated vibrato animation for ${e}`,{frequency:c,amplitude:h,preservedPhase:!!a},"animation")}}updateAnimationPhases(e){this.animations.forEach((s,o)=>{const r=(e-s.lastUpdate)/1e3;s.phase+=s.frequency*r*2*Math.PI,s.lastUpdate=e,s.phase>4*Math.PI&&(s.phase-=4*Math.PI)})}getVibratoYOffset(e){const s=this.animations.get(e);return!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning()?0:Math.sin(s.phase)*s.amplitude}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.amplitude>0:!1}dispose(){this.disposeBase(),T.info("VibratoCanvasEffect","Disposed",null,"animation")}}T.moduleLoaded("TremoloWaveformEffect");class nw extends Jp{constructor(){super("Tremolo"),T.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),T.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(e,s){var a;const{speed:o,span:r}=s;if(o===0||r===0)this.animations.delete(e),T.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${e}`,null,"animation");else{const c=this.animations.get(e),h=o/100*16,m=r/100,f={frequency:h,span:m,phase:(c==null?void 0:c.phase)||0,lastUpdate:(a=window.Tone)!=null&&a.now?window.Tone.now()*1e3:performance.now()};this.animations.set(e,f),T.debug("TremoloWaveformEffect",`Updated tremolo animation for ${e}`,{frequency:h,span:m,preservedPhase:!!c},"animation")}}updateAnimationPhases(e){var r,a,c;let s=0;const o=(r=window.Tone)!=null&&r.now?window.Tone.now()*1e3:e;if(this.animations.forEach((h,m)=>{const f=(o-h.lastUpdate)/1e3,g=h.phase;h.phase+=h.frequency*f*2*Math.PI,h.lastUpdate=o,s++,Math.abs(h.phase-g)<.001&&T.warn("TremoloWaveformEffect",`Phase not advancing for ${m}`,{deltaSeconds:Number(f.toFixed(4)),frequency:h.frequency},"animation"),h.phase>4*Math.PI&&(h.phase-=4*Math.PI)}),s>0&&Math.random()<.05){const h=(a=window.Tone)!=null&&a.now?"Tone.js":"performance";T.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!((c=window.Tone)!=null&&c.now),toneTime:o,currentTime:e,timingSource:h},"animation")}}getTremoloAmplitudeMultiplier(e){var A,I;const s=this.animations.get(e);if(!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const o=((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)||1,r=Math.sin(s.phase),a=s.span,c=o,h=o*(1-a),m=(c+h)/2,f=(c-h)/2,b=(m+r*f)/o,x=(((I=window.Tone)==null?void 0:I.now())*1e3||performance.now())-s.lastUpdate;if(x>100&&s.span>0){const k=s.frequency*(x/1e3)*2*Math.PI;k>.1&&T.warn("TremoloWaveformEffect",`Phase stagnation detected for ${e}`,{phase:Number(s.phase.toFixed(3)),millisecondsSinceUpdate:Number(x.toFixed(1)),expectedAdvancement:Number(k.toFixed(3))},"animation")}return Math.max(0,Math.min(1,b))}getADSRTremoloAmplitudeMultiplier(e){return this.getTremoloAmplitudeMultiplier(e)}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.span>0:!1}dispose(){this.disposeBase(),T.info("TremoloWaveformEffect","Disposed",null,"animation")}}T.moduleLoaded("AnimationEffectsManager");class iw{constructor(){this.vibratoEffect=new sw,this.tremoloEffect=new nw,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,T.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),u.on("visualEffectChanged",({effectType:e,parameter:s,value:o,color:r})=>{(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),T.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(e){this.isRunning&&(this.lastTime=e,this.vibratoEffect.updateAnimationPhases(e),this.tremoloEffect.updateAnimationPhases(e),this.triggerVisualUpdates(e),this.animationFrameId=requestAnimationFrame(s=>this.animate(s)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)),T.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),T.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const s=this.tremoloEffect.activeSoundingNotes.size>0,o=this.tremoloEffect.hasDialInteraction;return s||o}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}updateAnimationState(){const e=this.shouldVibratoBeRunning(),s=this.shouldTremoloBeRunning(),o=e||s;o&&!this.isRunning?this.start():!o&&this.isRunning&&this.stop()}triggerVisualUpdates(e){if(!this.lastRenderTrigger||e-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=e;const s=this.vibratoEffect.getActiveColors(),o=this.tremoloEffect.getActiveColors();s.length>0&&u.emit("animationUpdate",{type:"vibrato",activeColors:s}),o.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:o})}}triggerFinalUpdates(){const e=Array.from(this.vibratoEffect.animations.keys());e.length>0&&u.emit("animationUpdate",{type:"vibrato",activeColors:e});const s=Array.from(this.tremoloEffect.animations.keys());s.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:s})}shouldAnimateNote(e){return this.vibratoEffect.shouldAnimateNote(e)}getVibratoYOffset(e){return this.vibratoEffect.getVibratoYOffset(e)}getTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getTremoloAmplitudeMultiplier(e)}getADSRTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(e)}triggerTremoloAmplitudeUpdate(){const e=this.tremoloEffect.getActiveColors();e.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:e})}getAllActiveColors(){const e=this.vibratoEffect.getActiveColors(),s=this.tremoloEffect.getActiveColors();return[...new Set([...e,...s])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),T.info("AnimationEffectsManager","Disposed",null,"animation")}}const Dd=new iw;T.moduleLoaded("VibratoAudioEffect");class ow{constructor(){this.currentSettings=new Map,T.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return T.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:o,span:r}=e;this.currentSettings.set(s,{speed:o,span:r}),T.debug("VibratoAudioEffect",`Updated parameters for ${s}`,{speed:o,span:r},"audio")}applyToVoice(e,s){if(!e||!e._setVibrato)return;const o=this.currentSettings.get(s);if(!o){T.debug("VibratoAudioEffect",`No vibrato settings found for color ${s}`,null,"audio");return}try{e._setVibrato(o),e.vibratoApplied=!0,T.debug("VibratoAudioEffect",`Applied vibrato to voice for ${s}`,o,"audio")}catch(r){T.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createVibratoSettings(e,s){if(e===0||s===0)return null;const o=e/100*16,r=s/100*50;return{frequency:o,depth:r}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),T.info("VibratoAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("TremoloAudioEffect");class rw{constructor(){this.currentSettings=new Map,T.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return T.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:o,span:r}=e;this.currentSettings.set(s,{speed:o,span:r}),T.debug("TremoloAudioEffect",`Updated parameters for ${s}`,{speed:o,span:r},"audio")}applyToVoice(e,s){if(!e||!e._setTremolo)return;const o=this.currentSettings.get(s);if(!o){T.debug("TremoloAudioEffect",`No tremolo settings found for color ${s}`,null,"audio");return}try{e._setTremolo(o),e.tremoloApplied=!0,T.debug("TremoloAudioEffect",`Applied tremolo to voice for ${s}`,o,"audio")}catch(r){T.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createTremoloSettings(e,s){if(e===0||s===0)return null;const o=e/100*16,r=s/100;return{frequency:o,depth:r}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),T.info("TremoloAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("ReverbAudioEffect");class aw{constructor(){this.currentSettings=new Map,this.reverbInstances=new Map,T.info("ReverbAudioEffect","Initialized",null,"audio")}init(){return T.info("ReverbAudioEffect","Ready for audio processing",null,"audio"),!0}async updateParameters(e,s){const{decay:o,roomSize:r,wet:a=10}=e;this.currentSettings.set(s,{decay:o,roomSize:r,wet:a}),T.debug("ReverbAudioEffect",`Updated parameters for ${s}`,{decay:o,roomSize:r,wet:a},"audio");let c=this.reverbInstances.get(s);c?this.updateReverbInstance(c,o,r,a):(o>0||r>0)&&(c=await this.createReverbInstance(o,r,a),c&&(this.reverbInstances.set(s,c),T.debug("ReverbAudioEffect",`Created new reverb instance for ${s}`,{decay:o,roomSize:r,wet:a},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}async applyToVoice(e,s){if(!e)return;const o=this.currentSettings.get(s);if(!(!o||o.decay===0&&o.roomSize===0))try{let r=this.reverbInstances.get(s);if(r||(r=await this.createReverbInstance(o.decay,o.roomSize,o.wet),this.reverbInstances.set(s,r)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(r)}catch{e.output&&e.output.connect(r)}T.debug("ReverbAudioEffect",`Applied reverb to voice for ${s}`,o,"audio")}catch(r){T.warn("ReverbAudioEffect",`Failed to apply reverb to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{decay:0,roomSize:0}}getEffectInstance(e){return this.getCurrentSettings(e).wet>0?this.reverbInstances.get(e):null}async createReverbInstance(e,s,o=10){if(e===0&&s===0)return null;const r=Math.max(.1,e/100*8),a=1+s/100*1.5,c=r*a,h=o/100,m=new J.Reverb({decay:c,wet:h});return m._wetAmount=h,await m.ready,T.debug("ReverbAudioEffect","Created reverb instance",{decayTime:c,wetAmount:h,roomSize:s},"audio"),m}updateReverbInstance(e,s,o,r=10){if(e)try{const a=Math.max(.1,s/100*8),c=1+o/100*1.5,h=a*c,m=r/100;e.decay=h,e._crossFade&&(e._crossFade.fade.value=m),e._wetAmount=m,T.debug("ReverbAudioEffect","Updated reverb instance",{decayTime:h,wetAmount:m,roomSize:o},"audio")}catch(a){T.warn("ReverbAudioEffect","Failed to update reverb instance",a,"audio")}}createReverbSettings(e,s,o=25){if(e===0&&s===0)return null;const r=Math.max(.1,e/100*10),a=o/100;return{decay:r,roomSize:s/100,wet:a}}disableForColor(e){this.updateParameters({decay:0,roomSize:0,wet:0},e);const s=this.reverbInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.reverbInstances.delete(e))}dispose(){this.reverbInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(o){T.warn("ReverbAudioEffect",`Failed to dispose reverb for ${s}`,o,"audio")}}),this.currentSettings.clear(),this.reverbInstances.clear(),T.info("ReverbAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("DelayAudioEffect");class lw{constructor(){this.currentSettings=new Map,this.delayInstances=new Map,T.info("DelayAudioEffect","Initialized",null,"audio")}init(){return T.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{time:o,feedback:r,wet:a=15}=e;this.currentSettings.set(s,{time:o,feedback:r,wet:a}),T.debug("DelayAudioEffect",`Updated parameters for ${s}`,{time:o,feedback:r,wet:a},"audio");let c=this.delayInstances.get(s);c?this.updateDelayInstance(c,o,r,a):(o>0||r>0)&&(c=this.createDelayInstance(o,r,a),c&&(this.delayInstances.set(s,c),T.debug("DelayAudioEffect",`Created new delay instance for ${s}`,{time:o,feedback:r,wet:a},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}applyToVoice(e,s){if(!e)return;const o=this.currentSettings.get(s);if(!(!o||o.time===0&&o.feedback===0))try{let r=this.delayInstances.get(s);if(r||(r=this.createDelayInstance(o.time,o.feedback,o.wet),this.delayInstances.set(s,r)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(r)}catch{e.output&&e.output.connect(r)}T.debug("DelayAudioEffect",`Applied delay to voice for ${s}`,o,"audio")}catch(r){T.warn("DelayAudioEffect",`Failed to apply delay to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{time:0,feedback:0}}getEffectInstance(e){const s=this.getCurrentSettings(e);return s.time>0&&s.wet>0?this.delayInstances.get(e):null}createDelayInstance(e,s,o=30){if(e===0&&s===0)return null;const r=Math.max(.01,e/100*.5),a=Math.min(.95,s/100),c=o/100,h=new J.FeedbackDelay({delayTime:r,feedback:a,wet:c});return h._wetAmount=c,T.debug("DelayAudioEffect","Created delay instance",{delayTime:r,feedbackAmount:a,wetAmount:c},"audio"),h}updateDelayInstance(e,s,o,r=15){if(e)try{const a=Math.max(.01,s/100*.5),c=Math.min(.95,o/100),h=r/100;e.delayTime.value=a,e.feedback.value=c,e._crossFade&&(e._crossFade.fade.value=h),e._wetAmount=h,T.debug("DelayAudioEffect","Updated delay instance",{delayTime:a,feedbackAmount:c,wetAmount:h},"audio")}catch(a){T.warn("DelayAudioEffect","Failed to update delay instance",a,"audio")}}createDelaySettings(e,s,o=30){if(e===0&&s===0)return null;const r=Math.max(.01,e/100*.5),a=Math.min(.95,s/100),c=o/100;return{delayTime:r,feedback:a,wet:c}}disableForColor(e){this.updateParameters({time:0,feedback:0,wet:0},e);const s=this.delayInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.delayInstances.delete(e))}dispose(){this.delayInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(o){T.warn("DelayAudioEffect",`Failed to dispose delay for ${s}`,o,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),T.info("DelayAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("AudioEffectsManager");class cw{constructor(){this.vibratoEffect=new ow,this.tremoloEffect=new rw,this.reverbEffect=new aw,this.delayEffect=new lw,T.info("AudioEffectsManager","Initialized with audio effect handlers",null,"audio")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.reverbEffect.init(),this.delayEffect.init(),u.on("audioEffectChanged",({effectType:e,parameter:s,value:o,color:r,effectParams:a})=>{this.handleAudioEffectChange(e,s,o,r,a)}),T.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(e,s,o,r,a){switch(T.debug("AudioEffectsManager",`Processing audio effect: ${e}.${s} = ${o} for ${r}`,null,"audio"),e){case"vibrato":this.vibratoEffect.updateParameters(a,r);break;case"tremolo":this.tremoloEffect.updateParameters(a,r);break;case"reverb":this.reverbEffect.updateParameters(a,r);break;case"delay":this.delayEffect.updateParameters(a,r);break;default:T.debug("AudioEffectsManager",`Effect type ${e} not handled by audio system`,null,"audio")}}getEffectHandler(e){switch(e){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"reverb":return this.reverbEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(e,s,o){const r=this.reverbEffect.getEffectInstance(s),a=this.delayEffect.getEffectInstance(s);this.reverbEffect.getCurrentSettings(s),this.delayEffect.getCurrentSettings(s);try{e.disconnect()}catch{}let c=e;if(r)try{r.disconnect(),c.connect(r),c=r}catch{}if(a)try{a.disconnect(),c.connect(a),c=a}catch{}try{if(c.connect(o),window.synthEngine){const h=window.synthEngine.getWaveformAnalyzer(s);h&&e.connect(h)}}catch{}}applyEffectsToVoice(e,s){this.vibratoEffect.applyToVoice(e,s),this.tremoloEffect.applyToVoice(e,s)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.reverbEffect.dispose(),this.delayEffect.dispose(),T.info("AudioEffectsManager","Disposed",null,"audio")}}const Rd=new cw;T.moduleLoaded("EffectsCoordinator");class hw{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0},tremolo:{speed:0,span:0},reverb:{decay:0,roomSize:0},delay:{time:0,feedback:0}},T.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(u.state.timbres).forEach(e=>{this.initializeColorEffects(e)}),u.on("timbreCreated",({color:e})=>{this.initializeColorEffects(e)}),this.loadSavedValues(),T.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(e){if(!this.effectParameters.has(e)){const s={};Object.entries(this.defaultEffects).forEach(([r,a])=>{s[r]={...a}}),this.effectParameters.set(e,s);const o=u.state.timbres[e];o&&(o.vibrato&&(s.vibrato={...o.vibrato}),o.tremelo&&(s.tremolo={...o.tremelo})),T.debug("EffectsCoordinator",`Initialized effects for color ${e}`,s,"effects")}}updateParameter(e,s,o,r){if(!r){T.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:e,parameter:s,value:o},"effects");return}this.initializeColorEffects(r);const a=this.effectParameters.get(r);a[e]||(a[e]={...this.defaultEffects[e]}),a[e][s],a[e][s]=o,this.notifyAudioSystem(e,s,o,r,a[e]),this.notifyAnimationSystem(e,s,o,r,a[e]),this.updateTimbreState(e,a[e],r),this.saveValues()}notifyAudioSystem(e,s,o,r,a){u.emit("audioEffectChanged",{effectType:e,parameter:s,value:o,color:r,effectParams:{...a}}),T.debug("EffectsCoordinator",`Notified audio system: ${e}.${s} = ${o} for ${r}`,null,"effects")}notifyAnimationSystem(e,s,o,r,a){(e==="vibrato"||e==="tremolo")&&(u.emit("visualEffectChanged",{effectType:e,parameter:s,value:o,color:r,effectParams:{...a}}),T.debug("EffectsCoordinator",`Notified animation system: ${e}.${s} = ${o} for ${r}`,null,"effects"))}updateTimbreState(e,s,o){const r=u.state.timbres[o];if(!r)return;const c={vibrato:"vibrato",tremolo:"tremelo"}[e];c&&(r[c]||(r[c]={}),Object.assign(r[c],s),u.recordState())}getEffectParameters(e,s){const o=this.effectParameters.get(e);return!o||!o[s]?{...this.defaultEffects[s]}:{...o[s]}}getAllEffectParameters(e){const s=this.effectParameters.get(e);return s?{...s}:{...this.defaultEffects}}resetColorEffects(e){const s={};Object.entries(this.defaultEffects).forEach(([o,r])=>{s[o]={...r}}),this.effectParameters.set(e,s),Object.keys(s).forEach(o=>{Object.keys(s[o]).forEach(r=>{this.notifyAudioSystem(o,r,s[o][r],e,s[o]),this.notifyAnimationSystem(o,r,s[o][r],e,s[o])})}),T.info("EffectsCoordinator",`Reset all effects for color ${e}`,s,"effects")}saveValues(){const e={};Object.keys(u.state.timbres).forEach(s=>{const o=this.effectParameters.get(s);o&&(e[s]={vibrato:o.vibrato||{speed:0,span:0},tremelo:o.tremolo||{speed:0,span:0},reverb:o.reverb||{decay:0,roomSize:0},delay:o.delay||{time:0,feedback:0}})});try{localStorage.setItem("effectDialValues",JSON.stringify(e)),T.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(s){T.warn("EffectsCoordinator","Failed to save effect values to localStorage",s,"effects")}}loadSavedValues(){try{const e=localStorage.getItem("effectDialValues");if(!e){T.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const s=JSON.parse(e);T.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(s).forEach(o=>{const r=u.state.timbres[o],a=s[o];r&&a&&(a.vibrato&&Object.entries(a.vibrato).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("vibrato",c,h,o)}),a.tremelo&&Object.entries(a.tremelo).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("tremolo",c,h,o)}),a.reverb&&Object.entries(a.reverb).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("reverb",c,h,o)}),a.delay&&Object.entries(a.delay).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("delay",c,h,o)}))}),T.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(s).forEach(o=>{const r=s[o];(r.reverb&&(r.reverb.decay>0||r.reverb.roomSize>0)||r.delay&&(r.delay.time>0||r.delay.feedback>0))&&(window.synthEngine.updateSynthForColor(o),T.debug("EffectsCoordinator",`Re-applied effects to synth for ${o}`,null,"effects"))})}catch(e){T.warn("EffectsCoordinator","Failed to load saved effect values",e,"effects")}}dispose(){this.effectParameters.clear(),T.info("EffectsCoordinator","Disposed",null,"effects")}}const pa=new hw,uw=Object.freeze(Object.defineProperty({__proto__:null,default:pa},Symbol.toStringTag,{value:"Module"}));class dw{constructor(){this.currentEffect=null,this.effectControlsContainer=null,this.effectButtons=[],this.dials=[],this.currentColor=null,this.isDialInteractionActive=!1,this.effectConfigs={reverb:{name:"Reverb",controls:{decay:{label:"Time",min:0,max:100,default:0,unit:"%"},roomSize:{label:"Size",min:0,max:100,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:10,unit:"%"}}},delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}}}init(){return T.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),!this.effectControlsContainer||this.effectButtons.length===0?(T.initFailed("Effects Controller","Required DOM elements not found"),!1):(this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),T.initSuccess("Effects Controller"),!0)}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(e=>{e.addEventListener("click",s=>{const o=s.target.dataset.effect;this.selectEffect(o)})})}selectEffect(e){if(T.debug("Effects",`Selecting effect: ${e}`,null,"ui"),!this.effectConfigs[e]){T.info("Effects",`Effect ${e} not configured`,null,"ui");return}if(this.effectButtons.forEach(s=>{s.classList.remove("active"),s.dataset.effect===e&&s.classList.add("active")}),this.currentEffect===e){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=e,this.showEffectControls(e)}showEffectControls(e){console.log(`📋 showEffectControls called for: ${e}`);const s=this.effectConfigs[e];if(!s){T.warn("Effects",`No configuration found for effect: ${e}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const o=this.effectControlsContainer.querySelector(".effect-controls");console.log("📋 Controls container created:",o),Object.entries(s.controls).forEach(([r,a])=>{console.log(`📋 Creating slider for ${e}.${r}`);const c=this.currentColor?pa.getEffectParameters(this.currentColor,e):null,h=(c==null?void 0:c[r])||0,m=document.createElement("div");m.className="effect-slider-group",m.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",o.appendChild(m);const f=document.createElement("label");f.className="effect-slider-label",f.textContent=a.label,f.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",m.appendChild(f);const g=document.createElement("input");g.type="range",g.min=a.min,g.max=a.max,g.value=h,g.className="effect-slider",g.style.cssText="width: 100%; margin: 5px 0;",m.appendChild(g),console.log(`📋 Slider created for ${e}.${r}:`,g);const b=document.createElement("div");b.className="effect-slider-value";const w=a.unit?`${Math.round(h)}${a.unit}`:Math.round(h);b.textContent=w,b.style.cssText="text-align: center; font-size: 12px; color: #666;",m.appendChild(b),this.dials.push({dial:{element:g,value:h,destroy:()=>{}},control:r,effectType:e,valueDisplay:b,controlConfig:a});const x=A=>{const I=parseFloat(A.target.value),k=a.unit?`${Math.round(I)}${a.unit}`:Math.round(I);b.textContent=k,T.debug("Effects",`${e} ${r}: ${I}`,null,"audio"),this.onEffectParameterChange(e,r,I)};g.addEventListener("mousedown",A=>{console.log(`🖱️ MOUSEDOWN on ${e} slider`),this.onDialInteractionStart(e)}),g.addEventListener("mouseup",A=>{console.log(`🖱️ MOUSEUP on ${e} slider`),this.onDialInteractionEnd(e)}),g.addEventListener("mouseleave",A=>{A.buttons===1&&console.log(`🖱️ MOUSELEAVE while dragging ${e} slider`)}),g.addEventListener("touchstart",A=>{console.log(`👆 TOUCHSTART on ${e} slider`),this.onDialInteractionStart(e)}),g.addEventListener("touchend",A=>{console.log(`👆 TOUCHEND on ${e} slider`),this.onDialInteractionEnd(e)}),g.addEventListener("input",x),g.addEventListener("change",x)}),this.effectControlsContainer.classList.add("active")}hideEffectControls(){this.clearControls(),this.effectControlsContainer.classList.remove("active"),this.effectControlsContainer.innerHTML="",this.effectButtons.forEach(e=>e.classList.remove("active"))}clearControls(){this.dials.forEach(({dial:e})=>{e.destroy&&e.destroy()}),this.dials=[]}onEffectParameterChange(e,s,o){var a;T.debug("Effects",`Effect parameter changed: ${e}.${s} = ${o}`,null,"audio");const r=(a=u.state.selectedNote)==null?void 0:a.color;if(!r){T.warn("Effects","Cannot update effect parameter: no color selected",{effectType:e,parameter:s,value:o},"audio");return}pa.updateParameter(e,s,o,r),u.emit("effectParameterChanged",{effectType:e,parameter:s,value:o,color:r})}onDialInteractionStart(e){var o;if(this.isDialInteractionActive||e!=="vibrato"&&e!=="tremolo")return;this.isDialInteractionActive=!0;const s=(o=u.state.selectedNote)==null?void 0:o.color;if(!s){console.warn("⚠️ Dial interaction started but no color selected"),T.debug("Effects","Dial interaction started but no color selected",null,"ui");return}console.log(`🎛️ Dial interaction START: ${e} on ${s}`),u.emit("effectDialInteractionStart",{effectType:e,color:s}),T.debug("Effects",`Dial interaction started for ${e} on ${s}`,null,"ui")}onDialInteractionEnd(e){var o;if(!this.isDialInteractionActive)return;this.isDialInteractionActive=!1;const s=(o=u.state.selectedNote)==null?void 0:o.color;s&&(u.emit("effectDialInteractionEnd",{effectType:e,color:s}),T.debug("Effects",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}getCurrentEffect(){return this.currentEffect}getEffectParameters(e){var r;if(!this.effectConfigs[e])return null;const s=(r=u.state.selectedNote)==null?void 0:r.color;if(!s)return null;if(window.effectsCoordinator)return window.effectsCoordinator.getEffectParameters(s,e);const o={};return this.dials.forEach(({dial:a,control:c,effectType:h})=>{h===e&&(o[c]=parseFloat(a.element.value))}),o}initializeSelectedColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("selectedNoteChanged",()=>{var o;const s=(o=u.state.selectedNote)==null?void 0:o.color;s!==this.currentColor&&(this.currentColor=s,this.updateEffectButtonIndicators())}),u.on("audioEffectChanged",()=>{this.updateEffectButtonIndicators()}),this.updateEffectButtonIndicators()}updateEffectButtonIndicators(){!this.effectButtons||!this.currentColor||this.effectButtons.forEach(e=>{const s=e.getAttribute("data-effect");let o=!1;const r=pa.getEffectParameters(this.currentColor,s);switch(s){case"vibrato":o=r.speed>0&&r.span>0;break;case"tremolo":o=r.speed>0&&r.span>0;break;case"reverb":o=r.roomSize>0||r.decay>0||r.wet>0&&(r.roomSize>0||r.decay>0);break;case"delay":o=r.time>0||r.feedback>0||r.wet>0&&(r.time>0||r.feedback>0);break}o?(e.style.backgroundColor=this.currentColor,e.style.color="white",e.classList.add("effect-active")):(e.style.backgroundColor="",e.style.color="",e.classList.remove("effect-active"))})}}const Nn=new dw;class pw{constructor(e,s={}){if(this._root=typeof e=="string"?document.querySelector(e):e,!this._root)throw new Error("Position: target not found");const{size:o=[200,200],mode:r="absolute",x:a=.5,minX:c=0,maxX:h=1,stepX:m=0,y:f=.5,minY:g=0,maxY:b=1,stepY:w=0}=s;this._events=new Map,this._emit=(P,O)=>{const N=this._events.get(P);if(N)for(const H of N)H(O)};class x{constructor(O,N,H,G){this.min=O,this.max=N,this.step=H,this.value=0,this.update(G)}update(O){const N=Math.min(this.max,Math.max(this.min,O));if(!this.step||this.step<=0)return this.value=N,this.value;const H=Math.round((N-this.min)/this.step)*this.step+this.min;return this.value=Math.min(this.max,Math.max(this.min,parseFloat(H.toFixed(12)))),this.value}updateNormal(O){const N=this.max-this.min||1;return this.update(this.min+N*Math.min(1,Math.max(0,O)))}get normalized(){const O=this.max-this.min||1;return(this.value-this.min)/O}}class A{constructor(O,N,H,G){this.mode=O,this.orient=N,this._xr=H.slice(),this._yr=G.slice(),this.value=.5,this._anchorN=.5}resize(O,N){this._xr=O.slice(),this._yr=N.slice()}set anchor(O){this._anchorN=this._posToNorm(O)}update(O){if(this.mode==="absolute")this.value=this._posToNorm(O);else{const N=this._posToNorm(O),H=N-this._anchorN;this.value=I(this.value+H),this._anchorN=N}this.value=I(this.value)}_posToNorm(O){if(this.orient==="horizontal"){const N=this._xr[1]-this._xr[0]||1;return I((O.x-this._xr[0])/N)}else{const N=this._yr[1]-this._yr[0]||1;return I(1-(O.y-this._yr[0])/N)}}}const I=P=>Math.min(1,Math.max(0,P));this._x=new x(c,h,m,a),this._y=new x(g,b,w,f),this._w=Math.max(10,Math.floor(o[0])),this._h=Math.max(10,Math.floor(o[1])),this._mode=r==="relative"?"relative":"absolute",this._hX=new A(this._mode,"horizontal",[0,this._w],[0,this._h]),this._hY=new A(this._mode,"vertical",[0,this._w],[0,this._h]),this._hX.value=this._x.normalized,this._hY.value=this._y.normalized,this._style={bg:"rgba(74, 144, 226, 0.1)",grid:"#dee2e6",cross:"#6c757d",handle:"#4A90E2",text:"#212529"},this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._svg.style.display="block",this._svg.style.touchAction="none",this._root.innerHTML="",this._root.appendChild(this._svg),this._bg=document.createElementNS(this._svg.namespaceURI,"rect"),this._bg.setAttribute("x",0),this._bg.setAttribute("y",0),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h),this._bg.setAttribute("fill",this._style.bg),this._svg.appendChild(this._bg),this._grid=document.createElementNS(this._svg.namespaceURI,"g"),this._grid.setAttribute("stroke",this._style.grid),this._grid.setAttribute("stroke-width","1");const k=[.25,.5,.75];for(const P of k){const O=document.createElementNS(this._svg.namespaceURI,"line");O.setAttribute("x1",this._w*P),O.setAttribute("y1",0),O.setAttribute("x2",this._w*P),O.setAttribute("y2",this._h),this._grid.appendChild(O);const N=document.createElementNS(this._svg.namespaceURI,"line");N.setAttribute("x1",0),N.setAttribute("y1",this._h*P),N.setAttribute("x2",this._w),N.setAttribute("y2",this._h*P),this._grid.appendChild(N)}this._svg.appendChild(this._grid),this._xh=document.createElementNS(this._svg.namespaceURI,"line"),this._yh=document.createElementNS(this._svg.namespaceURI,"line");for(const P of[this._xh,this._yh])P.setAttribute("stroke",this._style.cross),P.setAttribute("stroke-width","2"),this._svg.appendChild(P);this._knob=document.createElementNS(this._svg.namespaceURI,"circle"),this._knob.setAttribute("r",Math.max(4,Math.min(this._w,this._h)*.04)),this._knob.setAttribute("fill",this._style.handle),this._svg.appendChild(this._knob),this._clicked=!1,this._onDown=this._onDown.bind(this),this._onMove=this._onMove.bind(this),this._onUp=this._onUp.bind(this),this._svg.addEventListener("pointerdown",this._onDown),window.addEventListener("pointerup",this._onUp),window.addEventListener("pointercancel",this._onUp),this._draw()}on(e,s){return this._events.has(e)||this._events.set(e,new Set),this._events.get(e).add(s),()=>this.off(e,s)}off(e,s){const o=this._events.get(e);o&&o.delete(s)}get x(){return this._x.value}set x(e){const s=this._x.value;this._x.update(e),this._hX.value=this._x.normalized,this._x.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get y(){return this._y.value}set y(e){const s=this._y.value;this._y.update(e),this._hY.value=this._y.normalized,this._y.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get minX(){return this._x.min}set minX(e){this._x.min=e,this.x=this._x.value}get maxX(){return this._x.max}set maxX(e){this._x.max=e,this.x=this._x.value}get stepX(){return this._x.step}set stepX(e){this._x.step=e,this.x=this._x.value}get minY(){return this._y.min}set minY(e){this._y.min=e,this.y=this._y.value}get maxY(){return this._y.max}set maxY(e){this._y.max=e,this.y=this._y.value}get stepY(){return this._y.step}set stepY(e){this._y.step=e,this.y=this._y.value}get mode(){return this._mode}set mode(e){this._mode=e==="relative"?"relative":"absolute",this._hX.mode=this._mode,this._hY.mode=this._mode}get normalized(){return{x:this._x.normalized,y:this._y.normalized}}resize(e,s){for(this._w=Math.max(10,Math.floor(e)),this._h=Math.max(10,Math.floor(s)),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._hX.resize([0,this._w],[0,this._h]),this._hY.resize([0,this._w],[0,this._h]),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h);this._grid.firstChild;)this._grid.removeChild(this._grid.firstChild);const o=[.25,.5,.75];for(const r of o){const a=document.createElementNS(this._svg.namespaceURI,"line");a.setAttribute("x1",this._w*r),a.setAttribute("y1",0),a.setAttribute("x2",this._w*r),a.setAttribute("y2",this._h),this._grid.appendChild(a);const c=document.createElementNS(this._svg.namespaceURI,"line");c.setAttribute("x1",0),c.setAttribute("y1",this._h*r),c.setAttribute("x2",this._w),c.setAttribute("y2",this._h*r),this._grid.appendChild(c)}this._draw()}destroy(){this._svg.removeEventListener("pointerdown",this._onDown),window.removeEventListener("pointerup",this._onUp),window.removeEventListener("pointercancel",this._onUp),window.removeEventListener("pointermove",this._onMove),this._root&&this._root.contains(this._svg)&&this._root.removeChild(this._svg),this._events.clear()}colorize(e){Object.assign(this._style,e||{}),this._bg.setAttribute("fill",this._style.bg),this._xh.setAttribute("stroke",this._style.cross),this._yh.setAttribute("stroke",this._style.cross),this._knob.setAttribute("fill",this._style.handle),this._label&&this._label.setAttribute("fill",this._style.text),this._grid.setAttribute("stroke",this._style.grid),this._draw()}_localPoint(e){const s=this._svg.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}}_onDown(e){var o,r;(r=(o=this._svg).setPointerCapture)==null||r.call(o,e.pointerId),this._clicked=!0;const s=this._localPoint(e);this._mode==="absolute"?(this._hX.update(s),this._hY.update(s),this._batchSetFromHandles()):(this._hX.anchor=s,this._hY.anchor=s),window.addEventListener("pointermove",this._onMove,{passive:!1}),this._emit("down",{x:this._x.value,y:this._y.value}),e.preventDefault()}_onMove(e){if(!this._clicked)return;const s=this._localPoint(e);this._hX.update(s),this._hY.update(s),this._batchSetFromHandles(),e.preventDefault()}_onUp(){this._clicked&&(this._clicked=!1,window.removeEventListener("pointermove",this._onMove),this._emit("up",{x:this._x.value,y:this._y.value}))}_batchSetFromHandles(){const e=this._hX.value,s=this._hY.value,o=this._x.updateNormal(e),r=this._y.updateNormal(s);(o!==void 0||r!==void 0)&&this._emit("change",{x:this._x.value,y:this._y.value}),this._draw()}_draw(){const e=(this._w-1)*this._x.normalized,s=(this._h-1)*(1-this._y.normalized);this._xh.setAttribute("x1",e),this._xh.setAttribute("y1",0),this._xh.setAttribute("x2",e),this._xh.setAttribute("y2",this._h),this._yh.setAttribute("x1",0),this._yh.setAttribute("y1",s),this._yh.setAttribute("x2",this._w),this._yh.setAttribute("y2",s),this._knob.setAttribute("cx",e),this._knob.setAttribute("cy",s)}}T.moduleLoaded("PositionEffectsController");class mw{constructor(){this.positions={},this.currentColor=null,this.resizeObservers=[],this.effectConfigs={reverb:{containerId:"reverb-position",xParam:"decay",yParam:"roomSize",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1}},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}}},this.colorMappings={"#4a90e2":{bg:"rgba(74, 144, 226, 0.1)",handle:"#4a90e2",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#2d2d2d":{bg:"rgba(45, 45, 45, 0.1)",handle:"#2d2d2d",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#d66573":{bg:"rgba(214, 101, 115, 0.1)",handle:"#d66573",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#68a03f":{bg:"rgba(104, 160, 63, 0.1)",handle:"#68a03f",grid:"#dee2e6",cross:"#6c757d",text:"#212529"}},T.info("PositionEffectsController","Initialized",null,"ui")}init(){return T.initStart("Position Effects Controller"),Object.entries(this.effectConfigs).forEach(([e,s])=>{this.createPositionComponent(e,s)}),this.initializeColorTracking(),this.updateColorsForCurrentSelection(),T.initSuccess("Position Effects Controller"),!0}createPositionComponent(e,s){const o=document.getElementById(s.containerId);if(!o){T.warn("PositionEffectsController",`Container not found for ${e}`,{containerId:s.containerId},"ui");return}try{const[r,a]=this.getPositionComponentSize(o),c=new pw(o,{size:[r,a],mode:"absolute",x:s.xRange.min,minX:s.xRange.min,maxX:s.xRange.max,stepX:s.xRange.step,y:s.yRange.min,minY:s.yRange.min,maxY:s.yRange.max,stepY:s.yRange.step});this.positions[e]=c,this.observePositionResize(o,c,r,a),c.on("change",({x:h,y:m})=>{this.onPositionChange(e,s.xParam,h,s.yParam,m)}),c.on("down",()=>{this.onDialInteractionStart(e)}),c.on("up",()=>{this.onDialInteractionEnd(e)}),this.loadInitialValues(e,s,c),T.debug("PositionEffectsController",`Created Position component for ${e}`,null,"ui")}catch(r){T.error("PositionEffectsController",`Failed to create Position component for ${e}`,r,"ui")}}getPositionComponentSize(e){const o=e.getBoundingClientRect();let r=(o==null?void 0:o.width)||e.clientWidth||e.offsetWidth||120,a=(o==null?void 0:o.height)||e.clientHeight||e.offsetHeight||r;return(!r||r<10)&&(r=120),(!a||a<10)&&(a=r),[Math.round(r),Math.round(a)]}observePositionResize(e,s,o,r){if(typeof ResizeObserver>"u")return;const a={currentWidth:Math.round(o)||0,currentHeight:Math.round(r)||0},c=new ResizeObserver(h=>{for(const m of h){const{width:f,height:g}=m.contentRect,b=Math.round(f),w=Math.round(g||f);!b||!w||b===a.currentWidth&&w===a.currentHeight||(a.currentWidth=b,a.currentHeight=w,s.resize(b,w))}});c.observe(e),this.resizeObservers.push(c)}loadInitialValues(e,s,o){var c;const r=(c=u.state.selectedNote)==null?void 0:c.color;if(!r){const h=s.xRange.min,m=s.yRange.min;o.x=h,o.y=m,T.debug("PositionEffectsController",`Set default values for ${e} (no color selected)`,{x:h,y:m},"ui");return}const a=Nn.getEffectParameters?Nn.getEffectParameters(e):null;if(a){const h=a[s.xParam]!==void 0?a[s.xParam]:s.xRange.min,m=a[s.yParam]!==void 0?a[s.yParam]:s.yRange.min;o.x=h,o.y=m,T.debug("PositionEffectsController",`Loaded values for ${e} color ${r}`,{x:h,y:m},"ui")}else{const h=s.xRange.min,m=s.yRange.min;o.x=h,o.y=m,T.debug("PositionEffectsController",`Set default values for ${e} (no effect params)`,{x:h,y:m},"ui")}}transformValue(e){return e<=1,e}isInOffZone(e,s){return e<=1&&s<=1}transformPositionValues(e,s){if(this.isInOffZone(e,s))return{x:e,y:s};const o=e<=1?Math.max(1,e):e,r=s<=1?Math.max(1,s):s;return{x:o,y:r}}onPositionChange(e,s,o,r,a){var m;if(!((m=u.state.selectedNote)==null?void 0:m.color)){T.warn("PositionEffectsController","No color selected for position change",{effectType:e,xParam:s,xValue:o,yParam:r,yValue:a},"ui");return}const h=this.transformPositionValues(o,a);T.debug("PositionEffectsController",`Position changed: ${e} ${s}=${o}->${h.x}, ${r}=${a}->${h.y}`,null,"ui"),Nn.onEffectParameterChange(e,s,h.x),Nn.onEffectParameterChange(e,r,h.y)}initializeColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("noteChanged",()=>{var o;const s=(o=u.state.selectedNote)==null?void 0:o.color;s!==this.currentColor&&(this.currentColor=s,this.updateColorsForCurrentSelection(),this.updatePositionValuesForColor())}),u.on("effectParameterChanged",({effectType:s,parameter:o,value:r,color:a})=>{T.debug("PositionEffectsController",`Effect parameter changed: ${s}.${o} = ${r} for ${a}`,null,"ui"),a===this.currentColor&&this.syncPositionFromEffects(s,o,r)}),u.on("audioEffectChanged",({effectType:s,parameter:o,value:r,color:a})=>{T.debug("PositionEffectsController",`Audio effect changed: ${s}.${o} = ${r} for ${a}`,null,"ui"),a===this.currentColor&&this.syncPositionFromEffects(s,o,r)})}updateColorsForCurrentSelection(){if(!this.currentColor||!this.colorMappings[this.currentColor])return;const e=this.colorMappings[this.currentColor];Object.values(this.positions).forEach(s=>{s&&s.colorize&&s.colorize(e)}),T.debug("PositionEffectsController",`Applied color theme for ${this.currentColor}`,e,"ui")}updatePositionValuesForColor(){this.currentColor&&Object.entries(this.effectConfigs).forEach(([e,s])=>{const o=this.positions[e];if(!o)return;const r=Nn.getEffectParameters?Nn.getEffectParameters(e):null;if(r){const a=r[s.xParam]!==void 0?r[s.xParam]:s.xRange.min,c=r[s.yParam]!==void 0?r[s.yParam]:s.yRange.min;o.x=a,o.y=c}})}syncPositionFromEffects(e,s,o){const r=this.positions[e],a=this.effectConfigs[e];!r||!a||(s===a.xParam?r.x=o:s===a.yParam&&(r.y=o),T.debug("PositionEffectsController",`Synced ${e}.${s} = ${o} from effects`,null,"ui"))}getPositionValues(e){const s=this.positions[e];return s?{x:s.x,y:s.y,normalized:s.normalized}:null}testPositionComponents(){T.info("PositionEffectsController","Testing Position components...",null,"ui"),Object.entries(this.positions).forEach(([e,s])=>{s?T.info("PositionEffectsController",`${e} Position component:`,{x:s.x,y:s.y,normalized:s.normalized},"ui"):T.warn("PositionEffectsController",`${e} Position component not found`,null,"ui")}),T.info("PositionEffectsController",`Current color: ${this.currentColor}`,null,"ui"),this.positions.vibrato&&(T.info("PositionEffectsController","Testing vibrato position change...",null,"ui"),this.positions.vibrato.x=75,this.positions.vibrato.y=50)}testDeadZoneElimination(){T.info("PositionEffectsController","Testing dead zone elimination...",null,"ui"),[{x:0,y:0,description:"Origin (should stay 0,0 - effect off)"},{x:.5,y:.5,description:"Inside off zone (should stay 0.5,0.5 - effect off)"},{x:1,y:1,description:"Edge of off zone (should stay 1,1 - effect off)"},{x:0,y:50,description:"X in dead zone (should become 1,50 - effect on)"},{x:50,y:0,description:"Y in dead zone (should become 50,1 - effect on)"},{x:.5,y:75,description:"X in dead zone (should become 1,75 - effect on)"},{x:25,y:.8,description:"Y in dead zone (should become 25,1 - effect on)"},{x:50,y:75,description:"Both normal (should stay 50,75 - effect on)"}].forEach(s=>{const o=this.transformPositionValues(s.x,s.y),r=this.isInOffZone(s.x,s.y);T.info("PositionEffectsController",`Test: ${s.description}`,{input:{x:s.x,y:s.y},output:o,inOffZone:r},"ui")})}onDialInteractionStart(e){var o;if(e!=="vibrato"&&e!=="tremolo")return;const s=(o=u.state.selectedNote)==null?void 0:o.color;if(!s){console.warn("⚠️ Position dial interaction started but no color selected");return}console.log(`🎛️ Position dial interaction START: ${e} on ${s}`),u.emit("effectDialInteractionStart",{effectType:e,color:s}),T.debug("PositionEffectsController",`Dial interaction started for ${e} on ${s}`,null,"ui")}onDialInteractionEnd(e){var o;const s=(o=u.state.selectedNote)==null?void 0:o.color;s&&(console.log(`🎛️ Position dial interaction END: ${e} on ${s}`),u.emit("effectDialInteractionEnd",{effectType:e,color:s}),T.debug("PositionEffectsController",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}destroy(){Object.values(this.positions).forEach(e=>{e&&e.destroy&&e.destroy()}),this.positions={},this.resizeObservers.forEach(e=>e.disconnect()),this.resizeObservers=[],T.info("PositionEffectsController","Destroyed",null,"ui")}}const Od=new mw,Jc=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function fw(n){if(n===0||!n)return"#888888";const e=Math.round(n)%12;return Jc[e]}function gw(n){if(n===0||!n)return Zi("#888888");const e=Math.floor(n),s=n-e;if(s<0||s>=1)return fw(n);const o=e%12,r=(o+1)%12,a=Zi(Jc[o]),c=Zi(Jc[r]);return vw(a,c,s)}function Zi(n){const e=parseInt(n.slice(1),16);return[e>>16&255,e>>8&255,e&255]}function vw(n,e,s){return n.map((o,r)=>Math.round(o+s*(e[r]-o)))}function ma(n,e,s){return n===0||!n?Zi("#888888"):e==="shapenote"?Zi(s||"#4A90E2"):gw(n)}class yw{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.lastValidPitch=null,this.lastValidPitchTime=0,this.fadeOutDurationMs=100,this.isFading=!1}initialize(){this.canvas=document.getElementById("playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("micPaintStateChanged",e=>this.handlePaintStateChange(e)),u.on("pitchDetected",e=>this.handlePitchDetection(e)),u.on("playbackStateChanged",()=>{u.state.paint.isMicPaintActive}))}handlePaintStateChange(e){const s=document.getElementById("hover-canvas");s&&(s.style.display=e?"none":"block"),e?this.startRendering():this.stopRendering()}handlePitchDetection(e){u.state.paint.isMicPaintActive&&u.state.isPlaying&&!u.state.isPaused&&this.addPaintAtPlayhead(e)}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.paint.isMicPaintActive||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),u.state.isPlaying,u.state.isPaused,u.state.isPlaying&&u.state.isPaused,u.state.isPlaying&&!u.state.isPaused?this.renderMovingPlayhead():this.renderStationaryPlayhead(),this.animationFrameId=requestAnimationFrame(()=>this.render())}renderStationaryPlayhead(){var h,m;const{detectedPitch:e}=u.state.paint,s=performance.now();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const o=this.midiToY(e.midi),r=o!==null,a=Lt.getColumnX(2),c=Lt.getCanvasWidth();if(r){this.lastValidPitch=e,this.lastValidPitchTime=s,this.isFading=!1;const{colorMode:f}=u.state.paint.paintSettings,g=(h=u.state.selectedNote)==null?void 0:h.color,b=ma(e.midi,f,g),w=`rgb(${b[0]}, ${b[1]}, ${b[2]})`;this.ctx.strokeStyle=w,this.ctx.globalAlpha=Math.min(e.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=w,this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(a,o),this.ctx.lineTo(c,o),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}else if(this.lastValidPitch&&s-this.lastValidPitchTime<this.fadeOutDurationMs){this.isFading=!0;const f=(s-this.lastValidPitchTime)/this.fadeOutDurationMs,g=this.easeOutCubic(1-f),b=this.midiToY(this.lastValidPitch.midi);if(b!==null){const{colorMode:w}=u.state.paint.paintSettings,x=(m=u.state.selectedNote)==null?void 0:m.color,A=ma(this.lastValidPitch.midi,w,x),I=`rgb(${A[0]}, ${A[1]}, ${A[2]})`;this.ctx.strokeStyle=I,this.ctx.globalAlpha=g*Math.min(this.lastValidPitch.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=I,this.ctx.shadowBlur=6*g,this.ctx.beginPath(),this.ctx.moveTo(a,b),this.ctx.lineTo(c,b),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}}else this.isFading=!1,this.lastValidPitch=null}easeOutCubic(e){return 1-Math.pow(1-e,3)}renderMovingPlayhead(){var r;const e=this.calculateXFromTime(J.Transport.seconds);if(e===null)return;this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0;const{detectedPitch:s}=u.state.paint,o=this.midiToY(s.midi);if(o!==null){const{colorMode:a}=u.state.paint.paintSettings,c=(r=u.state.selectedNote)==null?void 0:r.color,h=ma(s.midi,a,c),m=`rgb(${h[0]}, ${h[1]}, ${h[2]})`;this.ctx.fillStyle=m,this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.shadowColor=m,this.ctx.shadowBlur=4,this.ctx.beginPath(),this.ctx.arc(e,o,8,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowBlur=0}}addPaintAtPlayhead(e){if(e.midi===0)return;const s=J.Transport.seconds;Ah.addPaintPoint(s,e.midi)}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let o=0;o<u.state.columnWidths.length;o++)this.timeMap[o]=e,e+=u.state.columnWidths[o]*s;this.timeMap.push(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const o=this.timeMap[s],r=this.timeMap[s+1]-o,a=e-o,c=Lt.getColumnX(s),h=Lt.getColumnX(s+1)-c;return c+(r>0?a/r*h:0)}return null}midiToY(e){if(e===0)return null;const{fullRowData:s}=u.state;if(!s||s.length===0)return null;const o=Math.min(...s.map(w=>ys(w.toneNote))),r=Math.max(...s.map(w=>ys(w.toneNote)));if(e<24||e>96||e<o||e>r)return null;let a=-1,c=-1,h=-999,m=999;for(let w=0;w<s.length;w++){const x=ys(s[w].toneNote);x<=e&&x>h&&(a=w,h=x),x>=e&&x<m&&(c=w,m=x)}if(h===e){const w=Nt(a,u.state);return Math.max(0,Math.min(w,this.canvas.height))}if(a>=0&&c>=0&&h!==m){const w=Nt(a,u.state),x=Nt(c,u.state),A=(e-h)/(m-h),I=w+(x-w)*A;return Math.max(0,Math.min(I,this.canvas.height))}let f=0,g=Math.abs(ys(s[0].toneNote)-e);for(let w=1;w<s.length;w++){const x=ys(s[w].toneNote),A=Math.abs(x-e);A<g&&(g=A,f=w)}const b=Nt(f,u.state);return Math.max(0,Math.min(b,this.canvas.height))}canvasYToViewportY(e){const s=Lt.getViewportInfo();return zs.canvasToViewportY(e,s)}isCanvasYVisible(e){const s=this.canvasYToViewportY(e),o=Lt.getViewportInfo();return s>=0&&s<=o.viewportHeight}}const Kc=new yw;class bw{constructor(){this.canvas=null,this.ctx=null,this.isInitialized=!1,this.animationFrameId=null,this.lastHistoryLength=0}initialize(){if(this.canvas=document.getElementById("pitch-paint-canvas"),!this.canvas){T.error("PaintCanvas","Could not find #pitch-paint-canvas element",null,"paint");return}if(this.ctx=this.canvas.getContext("2d"),!document.getElementById("pitch-canvas-wrapper")){T.error("PaintCanvas","Could not find #pitch-canvas-wrapper element",null,"paint");return}u.on("paintHistoryChanged",()=>this.render()),u.on("layoutConfigChanged",()=>this.resize()),u.on("micPaintStateChanged",s=>{s?this.startRendering():this.stopRendering()}),this.resize(),this.isInitialized=!0}startRendering(){this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>this.animationLoop()))}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animationLoop(){u.state.paint.paintHistory.length!==this.lastHistoryLength&&(this.render(),this.lastHistoryLength=u.state.paint.paintHistory.length),this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}resize(){if(!this.canvas)return;const e=document.getElementById("pitch-canvas-wrapper");setTimeout(()=>{document.getElementById("pitch-grid-container");const s=68,o=u.state.cellHeight||18.35,a=s*(o/2);(this.canvas.width!==e.clientWidth||this.canvas.height!==a)&&(T.debug("PaintCanvas",`Setting pitch-paint-canvas height (DEFERRED): ${this.canvas.height} → ${a}`,null,"paint"),this.canvas.width=e.clientWidth,this.canvas.height=a,this.render())},30)}render(){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=u.state.paint.paintHistory;e.length!==0&&this.renderPaintTrail(e)}renderPaintTrail(e){if(e.length<2)return;const s=e.map(r=>{const a=Kc.calculateXFromTime(r.musicalTime),c=Kc.midiToY(r.midi);return a===null||c===null?null:{...r,x:a,y:c}}).filter(r=>r!==null);if(s.length<2)return;const o=u.state.paint.paintSettings.opacity/100;this.ctx.globalAlpha=o,this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let r=1;r<s.length;r++){const a=s[r-1],c=s[r];c.timestamp-a.timestamp>200||this.drawPaintSegment(a,c)}this.ctx.globalAlpha=1}drawPaintSegment(e,s){const o=this.ctx.createLinearGradient(e.x,e.y,s.x,s.y);o.addColorStop(0,`rgb(${e.color.join(",")})`),o.addColorStop(1,`rgb(${s.color.join(",")})`),this.ctx.strokeStyle=o,this.ctx.lineWidth=(e.thickness+s.thickness)/2,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}addPaintPoint(e,s){var h;const{colorMode:o}=u.state.paint.paintSettings,r=(h=u.state.selectedNote)==null?void 0:h.color,a=ma(s,o,r),c={musicalTime:e,midi:s,color:a,timestamp:performance.now(),thickness:u.state.paint.paintSettings.thickness};u.addPaintPoint(c)}clear(){u.clearPaintHistory()}}const Ah=new bw;var Ac,Nd;function _w(){if(Nd)return Ac;Nd=1;function n(e){if(this.size=e|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=e<<1;for(var s=new Array(this.size*2),o=0;o<s.length;o+=2){const f=Math.PI*o/this.size;s[o]=Math.cos(f),s[o+1]=-Math.sin(f)}this.table=s;for(var r=0,a=1;this.size>a;a<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var c=0;c<this._bitrev.length;c++){this._bitrev[c]=0;for(var h=0;h<this._width;h+=2){var m=this._width-h-2;this._bitrev[c]|=(c>>>h&3)<<m}}this._out=null,this._data=null,this._inv=0}return Ac=n,n.prototype.fromComplexArray=function(s,o){for(var r=o||new Array(s.length>>>1),a=0;a<s.length;a+=2)r[a>>>1]=s[a];return r},n.prototype.createComplexArray=function(){const s=new Array(this._csize);for(var o=0;o<s.length;o++)s[o]=0;return s},n.prototype.toComplexArray=function(s,o){for(var r=o||this.createComplexArray(),a=0;a<r.length;a+=2)r[a]=s[a>>>1],r[a+1]=0;return r},n.prototype.completeSpectrum=function(s){for(var o=this._csize,r=o>>>1,a=2;a<r;a+=2)s[o-a]=s[a],s[o-a+1]=-s[a+1]},n.prototype.transform=function(s,o){if(s===o)throw new Error("Input and output buffers must be different");this._out=s,this._data=o,this._inv=0,this._transform4(),this._out=null,this._data=null},n.prototype.realTransform=function(s,o){if(s===o)throw new Error("Input and output buffers must be different");this._out=s,this._data=o,this._inv=0,this._realTransform4(),this._out=null,this._data=null},n.prototype.inverseTransform=function(s,o){if(s===o)throw new Error("Input and output buffers must be different");this._out=s,this._data=o,this._inv=1,this._transform4();for(var r=0;r<s.length;r++)s[r]/=this.size;this._out=null,this._data=null},n.prototype._transform4=function(){var s=this._out,o=this._csize,r=this._width,a=1<<r,c=o/a<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<o;h+=c,m++){const k=f[m];this._singleTransform2(h,k,a)}else for(h=0,m=0;h<o;h+=c,m++){const k=f[m];this._singleTransform4(h,k,a)}var g=this._inv?-1:1,b=this.table;for(a>>=2;a>=2;a>>=2){c=o/a<<1;var w=c>>>2;for(h=0;h<o;h+=c)for(var x=h+w,A=h,I=0;A<x;A+=2,I+=a){const k=A,P=k+w,O=P+w,N=O+w,H=s[k],G=s[k+1],Y=s[P],ut=s[P+1],dt=s[O],it=s[O+1],Ct=s[N],xt=s[N+1],tt=H,et=G,vt=b[I],St=g*b[I+1],Dt=Y*vt-ut*St,Z=Y*St+ut*vt,ot=b[2*I],pt=g*b[2*I+1],At=dt*ot-it*pt,lt=dt*pt+it*ot,Rt=b[3*I],Bt=g*b[3*I+1],zt=Ct*Rt-xt*Bt,se=Ct*Bt+xt*Rt,Se=tt+At,Xt=et+lt,be=tt-At,He=et-lt,os=Dt+zt,ke=Z+se,Ge=g*(Dt-zt),Ce=g*(Z-se),_s=Se+os,nn=Xt+ke,Oe=Se-os,bn=Xt-ke,ai=be+Ce,li=He-Ge,ci=be-Ce,_n=He+Ge;s[k]=_s,s[k+1]=nn,s[P]=ai,s[P+1]=li,s[O]=Oe,s[O+1]=bn,s[N]=ci,s[N+1]=_n}}},n.prototype._singleTransform2=function(s,o,r){const a=this._out,c=this._data,h=c[o],m=c[o+1],f=c[o+r],g=c[o+r+1],b=h+f,w=m+g,x=h-f,A=m-g;a[s]=b,a[s+1]=w,a[s+2]=x,a[s+3]=A},n.prototype._singleTransform4=function(s,o,r){const a=this._out,c=this._data,h=this._inv?-1:1,m=r*2,f=r*3,g=c[o],b=c[o+1],w=c[o+r],x=c[o+r+1],A=c[o+m],I=c[o+m+1],k=c[o+f],P=c[o+f+1],O=g+A,N=b+I,H=g-A,G=b-I,Y=w+k,ut=x+P,dt=h*(w-k),it=h*(x-P),Ct=O+Y,xt=N+ut,tt=H+it,et=G-dt,vt=O-Y,St=N-ut,Dt=H-it,Z=G+dt;a[s]=Ct,a[s+1]=xt,a[s+2]=tt,a[s+3]=et,a[s+4]=vt,a[s+5]=St,a[s+6]=Dt,a[s+7]=Z},n.prototype._realTransform4=function(){var s=this._out,o=this._csize,r=this._width,a=1<<r,c=o/a<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<o;h+=c,m++){const di=f[m];this._singleRealTransform2(h,di>>>1,a>>>1)}else for(h=0,m=0;h<o;h+=c,m++){const di=f[m];this._singleRealTransform4(h,di>>>1,a>>>1)}var g=this._inv?-1:1,b=this.table;for(a>>=2;a>=2;a>>=2){c=o/a<<1;var w=c>>>1,x=w>>>1,A=x>>>1;for(h=0;h<o;h+=c)for(var I=0,k=0;I<=A;I+=2,k+=a){var P=h+I,O=P+x,N=O+x,H=N+x,G=s[P],Y=s[P+1],ut=s[O],dt=s[O+1],it=s[N],Ct=s[N+1],xt=s[H],tt=s[H+1],et=G,vt=Y,St=b[k],Dt=g*b[k+1],Z=ut*St-dt*Dt,ot=ut*Dt+dt*St,pt=b[2*k],At=g*b[2*k+1],lt=it*pt-Ct*At,Rt=it*At+Ct*pt,Bt=b[3*k],zt=g*b[3*k+1],se=xt*Bt-tt*zt,Se=xt*zt+tt*Bt,Xt=et+lt,be=vt+Rt,He=et-lt,os=vt-Rt,ke=Z+se,Ge=ot+Se,Ce=g*(Z-se),_s=g*(ot-Se),nn=Xt+ke,Oe=be+Ge,bn=He+_s,ai=os-Ce;if(s[P]=nn,s[P+1]=Oe,s[O]=bn,s[O+1]=ai,I===0){var li=Xt-ke,ci=be-Ge;s[N]=li,s[N+1]=ci;continue}if(I!==A){var _n=He,Jt=-os,Bn=Xt,on=-be,hi=-g*_s,yr=-g*Ce,no=-g*Ge,ui=-g*ke,Ra=_n+hi,io=Jt+yr,oo=Bn+ui,br=on-no,_r=h+x-I,qn=h+w-I;s[_r]=Ra,s[_r+1]=io,s[qn]=oo,s[qn+1]=br}}}},n.prototype._singleRealTransform2=function(s,o,r){const a=this._out,c=this._data,h=c[o],m=c[o+r],f=h+m,g=h-m;a[s]=f,a[s+1]=0,a[s+2]=g,a[s+3]=0},n.prototype._singleRealTransform4=function(s,o,r){const a=this._out,c=this._data,h=this._inv?-1:1,m=r*2,f=r*3,g=c[o],b=c[o+r],w=c[o+m],x=c[o+f],A=g+w,I=g-w,k=b+x,P=h*(b-x),O=A+k,N=I,H=-P,G=A-k,Y=I,ut=P;a[s]=O,a[s+1]=0,a[s+2]=N,a[s+3]=H,a[s+4]=G,a[s+5]=0,a[s+6]=Y,a[s+7]=ut},Ac}var ww=_w();const xw=Og(ww);class rr{constructor(e,s){Ts(this,"_inputLength");Ts(this,"_fft");Ts(this,"_bufferSupplier");Ts(this,"_paddedInputBuffer");Ts(this,"_transformBuffer");Ts(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new xw(Tw(2*e)),this._bufferSupplier=s,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new rr(e,s=>new Float32Array(s))}static forFloat64Array(e){return new rr(e,s=>new Float64Array(s))}static forNumberArray(e){return new rr(e,s=>Array(s))}get inputLength(){return this._inputLength}autocorrelate(e,s=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let r=0;r<e.length;r++)this._paddedInputBuffer[r]=e[r];for(let r=e.length;r<this._paddedInputBuffer.length;r++)this._paddedInputBuffer[r]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const o=this._transformBuffer;for(let r=0;r<o.length;r+=2)o[r]=o[r]*o[r]+o[r+1]*o[r+1],o[r+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let r=0;r<e.length;r++)s[r]=this._inverseBuffer[2*r];return s}}function Sw(n){const e=[];let s=!1,o=-1/0,r=-1;for(let a=1;a<n.length-1;a++)n[a-1]<=0&&n[a]>0?(s=!0,r=a,o=n[a]):n[a-1]>0&&n[a]<=0?(s=!1,r!==-1&&e.push(r)):s&&n[a]>o&&(o=n[a],r=a);return e}function Cw(n,e){const[s,o,r]=[n-1,n,n+1],[a,c,h]=[e[s],e[o],e[r]],m=a/2-c+h/2,f=-(a/2)*(o+r)+c*(s+r)-h/2*(s+o),g=a*o*r/2-c*s*r+h*s*o/2,b=-f/(2*m),w=m*b*b+f*b+g;return[b,w]}class ar{constructor(e,s){Ts(this,"_autocorrelator");Ts(this,"_nsdfBuffer");Ts(this,"_clarityThreshold",.9);Ts(this,"_minVolumeAbsolute",0);Ts(this,"_maxInputAmplitude",1);this._autocorrelator=new rr(e,s),this._nsdfBuffer=s(e)}static forFloat32Array(e){return new ar(e,s=>new Float32Array(s))}static forFloat64Array(e){return new ar(e,s=>new Float64Array(s))}static forNumberArray(e){return new ar(e,s=>Array(s))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,s){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const o=Sw(this._nsdfBuffer);if(o.length===0)return[0,0];const r=Math.max(...o.map(m=>this._nsdfBuffer[m])),a=o.find(m=>this._nsdfBuffer[m]>=this._clarityThreshold*r),[c,h]=Cw(a,this._nsdfBuffer);return[s/c,Math.min(h,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let s=0;for(let o=0;o<e.length;o++)s+=e[o]**2;return Math.sqrt(s/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let s=2*this._nsdfBuffer[0],o;for(o=0;o<this._nsdfBuffer.length&&s>0;o++)this._nsdfBuffer[o]=2*this._nsdfBuffer[o]/s,s-=e[o]**2+e[e.length-o-1]**2;for(;o<this._nsdfBuffer.length;o++)this._nsdfBuffer[o]=0}}function Tw(n){return n--,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,n++,n}class Aw{constructor(){this.mic=null,this.analyser=null,this.detector=null,this.animationFrameId=null,this.isInitialized=!1,this.lastLogTime=0,this.logThrottleMs=5e3,this.pitchHistory=[],this.maxHistoryLength=3,this.maxPitchJumpSemitones=24,this.maxJumpTimeMs=20,this.config={FFT_SIZE:2048,MIN_PITCH_HZ:75,MAX_PITCH_HZ:1300,MIN_VOLUME_DB:-50}}async initialize(){if(!this.isInitialized)try{await(window.initAudio||(()=>J.start()))(),this.mic=new J.UserMedia,this.analyser=new J.Analyser("waveform",this.config.FFT_SIZE),this.micGain=new J.Gain(2),this.detector=ar.forFloat32Array(this.analyser.size),this.micSplitter=new J.Gain(1),await this.mic.open(),this.mic.connect(this.micGain),this.micGain.connect(this.micSplitter),this.micSplitter.connect(this.analyser),this.isInitialized=!0}catch(e){throw console.error("PitchPaintService: Failed to initialize microphone:",e),u.setMicPaintActive(!1),e}}startDetection(){!this.isInitialized||u.state.paint.isDetecting||(u.setPaintDetectionState(!0),this.animationLoop())}stopDetection(){u.state.paint.isDetecting&&(u.setPaintDetectionState(!1),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}animationLoop(){if(!u.state.paint.isDetecting){this.animationFrameId=null;return}const e=this.analyser.getValue(),s=Math.sqrt(e.reduce((m,f)=>m+f*f,0)/e.length),o=performance.now();let r=null,a=0;if(s>1e-5)try{[r,a]=this.detector.findPitch(e,J.context.sampleRate),r==null&&(r=null),a==null&&(a=0),r&&a>.1&&o-this.lastLogTime>this.logThrottleMs&&(this.lastLogTime=o)}catch{r=null,a=0}const c=u.state.paint.paintSettings.minClarity;if(r&&a>c&&r>this.config.MIN_PITCH_HZ&&r<this.config.MAX_PITCH_HZ){const m=this.frequencyToMidi(r);if(this.isPitchJumpValid(m,o)){this.addPitchToHistory(m,o);const f=this.getSmoothedPitch(),g={frequency:r,clarity:a,midi:f,pitchClass:Math.round(f)%12,timestamp:o};u.setDetectedPitch(g)}else{const f=this.getSmoothedPitch();if(f!==null){const g={frequency:r,clarity:a,midi:f,pitchClass:Math.round(f)%12,timestamp:o};u.setDetectedPitch(g)}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:o})}}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:o});this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}frequencyToMidi(e){return 12*Math.log2(e/440)+69}addPitchToHistory(e,s){this.pitchHistory.push({midi:e,timestamp:s}),this.pitchHistory.length>this.maxHistoryLength&&this.pitchHistory.shift()}isPitchJumpValid(e,s){if(this.pitchHistory.length===0)return!0;const o=this.pitchHistory[this.pitchHistory.length-1],r=s-o.timestamp,a=Math.abs(e-o.midi);return r>this.maxJumpTimeMs?!0:a>this.maxPitchJumpSemitones?(console.log("🚫 [Filter] Pitch jump rejected:",a.toFixed(1),"semitones in",r.toFixed(0)+"ms"),!1):!0}getSmoothedPitch(){return this.pitchHistory.length<3?this.pitchHistory.length>0?this.pitchHistory[this.pitchHistory.length-1].midi:null:this.pitchHistory.slice(-3).map(s=>s.midi).sort((s,o)=>s-o)[1]}testMicrophoneInput(){if(!this.isInitialized)return!1;const e=this.analyser.getValue();return Math.sqrt(e.reduce((o,r)=>o+r*r,0)/e.length)>1e-4}async dispose(){this.stopDetection(),this.mic&&(this.mic.close(),this.mic=null),this.micGain&&(this.micGain.dispose(),this.micGain=null),this.micSplitter&&(this.micSplitter.dispose(),this.micSplitter=null),this.analyser=null,this.detector=null,this.isInitialized=!1}}const fa=new Aw,Mw=Object.freeze(Object.defineProperty({__proto__:null,default:fa},Symbol.toStringTag,{value:"Module"}));class Ew{constructor(){this.elements={}}initialize(){this.cacheDOMElements(),this.elements.toggleBtn&&(this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",()=>this.updateUI()),u.on("paintHistoryChanged",()=>this.updateUI()),u.on("paintSettingsChanged",()=>this.updateUI()))}cacheDOMElements(){this.elements.toggleBtn=document.getElementById("mic-paint-toggle"),this.elements.clearBtn=document.getElementById("paint-clear-btn"),this.elements.thicknessSelect=document.getElementById("sidebar-trail-thickness"),this.elements.opacitySelect=document.getElementById("sidebar-trail-opacity"),this.elements.colorToggle=document.getElementById("paint-color-toggle"),this.elements.playbackToggle=document.getElementById("paint-playback-toggle")}setupEventListeners(){this.elements.toggleBtn.addEventListener("click",()=>this.handleMicPaintToggle()),this.elements.clearBtn.addEventListener("click",()=>this.handleClearPaint()),this.elements.thicknessSelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({thickness:s})}),this.elements.opacitySelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({opacity:s})}),this.elements.colorToggle.addEventListener("click",()=>this.handleColorToggle()),this.elements.playbackToggle.addEventListener("click",()=>this.handlePlaybackToggle())}async handleMicPaintToggle(){const e=u.state.paint.isMicPaintActive;if(this.elements.toggleBtn.disabled=!0,e)fa.stopDetection(),u.setMicPaintActive(!1);else try{await fa.initialize(),u.setMicPaintActive(!0),fa.startDetection()}catch{alert("Microphone access is required for Pitch Painting. Please check your browser permissions and try again."),u.setMicPaintActive(!1)}this.elements.toggleBtn.disabled=!1}handleClearPaint(){confirm("Are you sure you want to clear the painted pitch trail? This cannot be undone.")&&Ah.clear()}handleColorToggle(){const s=u.state.paint.paintSettings.colorMode==="chromatic"?"shapenote":"chromatic";u.setPaintSettings({colorMode:s})}handlePlaybackToggle(){const e=u.state.paint.paintSettings.playbackEnabled;u.setPaintSettings({playbackEnabled:!e})}updateUI(){const{isMicPaintActive:e,paintHistory:s,paintSettings:o}=u.state.paint;if(this.elements.toggleBtn.textContent=e?"Mic Paint (ON)":"Mic Paint (OFF)",this.elements.toggleBtn.classList.toggle("active",e),this.elements.clearBtn.disabled=s.length===0,this.elements.thicknessSelect&&this.elements.thicknessSelect.value!==o.thickness.toString()&&(this.elements.thicknessSelect.value=o.thickness.toString()),this.elements.opacitySelect&&this.elements.opacitySelect.value!==o.opacity.toString()&&(this.elements.opacitySelect.value=o.opacity.toString()),this.elements.colorToggle){const r=o.colorMode==="shapenote";this.elements.colorToggle.classList.toggle("active",r)}this.elements.playbackToggle&&this.elements.playbackToggle.classList.toggle("active",o.playbackEnabled)}}const Pw=new Ew;T.moduleLoaded("PaintPlaybackService");class kw{constructor(){this.paintSynth=null,this.scheduledEvents=[],this.isInitialized=!1}async initialize(){if(!this.isInitialized)try{if(this.paintSynth=new J.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:0,release:.1}}),this.paintGain=new J.Gain(.3),this.paintSynth.connect(this.paintGain),window.synthEngine&&window.synthEngine.getMainVolumeNode){const e=window.synthEngine.getMainVolumeNode();e?(this.paintGain.connect(e),T.info("PaintPlaybackService","Connected to SynthEngine master chain (with limiter)")):(this.paintGain.toDestination(),T.warn("PaintPlaybackService","SynthEngine main volume node not found, connecting directly to destination"))}else this.paintGain.toDestination(),T.warn("PaintPlaybackService","SynthEngine not available, connecting directly to destination");this.isInitialized=!0,T.info("PaintPlaybackService","Initialized with sine wave synthesis")}catch(e){throw T.error("PaintPlaybackService","Failed to initialize",e),e}}midiToFrequency(e){return 440*Math.pow(2,(e-69)/12)}schedulePaintPlayback(){if(!this.isInitialized||!u.state.paint.paintSettings.playbackEnabled)return;this.clearScheduledEvents();const e=u.state.paint.paintHistory;if(!e||e.length===0){T.debug("PaintPlaybackService","No paint history to schedule");return}T.info("PaintPlaybackService",`Scheduling ${e.length} paint points for playback`),e.forEach((s,o)=>{const r=this.midiToFrequency(s.midi),a=.2,c=J.Transport.schedule(h=>{this.paintSynth&&u.state.paint.paintSettings.playbackEnabled&&(this.paintSynth.triggerAttackRelease(r,a,h),T.debug("PaintPlaybackService",`Playing paint point ${o}: ${s.midi.toFixed(2)} MIDI (${r.toFixed(1)}Hz) at time ${s.musicalTime.toFixed(2)}s`))},s.musicalTime);this.scheduledEvents.push(c)}),T.info("PaintPlaybackService",`Scheduled ${this.scheduledEvents.length} paint events`)}clearScheduledEvents(){this.scheduledEvents.forEach(e=>{J.Transport.clear(e)}),this.scheduledEvents=[],T.debug("PaintPlaybackService","Cleared all scheduled paint events")}onTransportStart(){u.state.paint.paintSettings.playbackEnabled&&this.schedulePaintPlayback()}onTransportStop(){this.clearScheduledEvents()}setPaintVolume(e){this.paintGain&&(this.paintGain.gain.value=Math.max(0,Math.min(1,e)))}getPaintVolume(){return this.paintGain?this.paintGain.gain.value:.3}async dispose(){this.clearScheduledEvents(),this.paintSynth&&(this.paintSynth.dispose(),this.paintSynth=null),this.paintGain&&(this.paintGain.dispose(),this.paintGain=null),this.isInitialized=!1,T.info("PaintPlaybackService","Disposed")}}const Ld=new kw;class Iw{constructor(){this.currentTool=null,this.toolButtons=null,this.optionsContainer=null,this.lastSelectedNote=null,this.settings={arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}}}initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.optionsContainer=document.getElementById("draw-tool-options"),!this.toolButtons.length||!this.optionsContainer){console.warn("[DrawTools] Could not find draw tool elements");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),u.on("noteChanged",({newNote:e})=>{this.lastSelectedNote=e,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.drawTool;this.selectTool(s)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".chord-tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.chordTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(u.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),u.setSelectedTool("note")):u.state.selectedNote&&(u.setSelectedNote(u.state.selectedNote.shape,u.state.selectedNote.color),u.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(e=>e.classList.remove("active")),this.currentTool=null,this.optionsContainer.innerHTML="",jt.setTool(null,null)}selectTool(e){this.toolButtons.forEach(o=>o.classList.remove("active"));const s=Array.from(this.toolButtons).find(o=>o.dataset.drawTool===e);s&&s.classList.add("active"),this.currentTool=e,this.renderToolOptions(e),jt.setTool(e,this.settings),u.state.selectedNote=null}renderToolOptions(e){switch(e){case"arrow":this.renderArrowOptions();break;case"text":this.renderTextOptions();break;case"marker":this.renderMarkerOptions();break;case"highlighter":this.renderHighlighterOptions();break;case"lasso":this.renderLassoOptions();break;default:this.optionsContainer.innerHTML=""}}renderArrowOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="stroke-weight" title="Stroke Weight">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${Math.min(this.settings.arrow.strokeWeight,5)}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="line-style" title="Line Style">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="${this.getLineDashArray()}">
                        <line x1="4" y1="12" x2="20" y2="12"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="start-arrowhead" title="Start Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.startArrowhead,"left")}
                </button>
                <button class="draw-toolbar-button draw-swap-button" data-action="swap-endpoints" title="Swap endpoints">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17,1 21,5 17,9"></polyline>
                        <path d="M3,11V9A4,4 0 0,1 7,5H21"></path>
                        <polyline points="7,23 3,19 7,15"></polyline>
                        <path d="M21,13v2a4,4 0 0,1 -4,4H3"></path>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="end-arrowhead" title="End Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.endArrowhead,"right")}
                </button>
            </div>
        `,this.attachArrowToolbarListeners()}getLineDashArray(){switch(this.settings.arrow.lineStyle){case"solid":return"0";case"dashed-big":return"8,4";case"dashed-small":return"4,2";case"dotted":return"1,2";default:return"0"}}getArrowheadIcon(e,s){const o=s==="left";switch(e){case"none":return`<svg width="20" height="20" viewBox="0 0 24 24"><line x1="${o?20:4}" y1="12" x2="${o?4:20}" y2="12" stroke="currentColor" stroke-width="2"/></svg>`;case"unfilled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${o?20:4}" y1="12" x2="${o?4:20}" y2="12"/>
                    <polyline points="${o?"10,6 4,12 10,18":"14,6 20,12 14,18"}"/>
                </svg>`;case"filled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <line x1="${o?20:4}" y1="12" x2="${o?8:16}" y2="12"/>
                    <polygon points="${o?"4,12 10,6 10,18":"20,12 14,6 14,18"}"/>
                </svg>`;case"circle":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${o?20:4}" y1="12" x2="${o?8:16}" y2="12"/>
                    <circle cx="${o?4:20}" cy="12" r="3"/>
                </svg>`;default:return""}}attachArrowToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(o=>{o.addEventListener("click",r=>{const a=o.dataset.popup;this.showPopupMenu(a,o)})});const s=this.optionsContainer.querySelector('[data-action="swap-endpoints"]');s&&s.addEventListener("click",()=>{const o=this.settings.arrow.startArrowhead;this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=o,this.renderArrowOptions(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected()})}showPopupMenu(e,s){const o=document.querySelector(".draw-popup-menu");o&&o.remove();const r=document.createElement("div");r.className="draw-popup-menu";let a="";switch(e){case"stroke-weight":const f=this.settings.arrow.strokeWeight,g=2,b=4,w=7;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-stroke-slider"
                            min="1"
                            max="10"
                            value="${f}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${f===g?"active":""}" data-value="${g}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===b?"active":""}" data-value="${b}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="4"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===w?"active":""}" data-value="${w}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="6"/></svg>
                            </button>
                        </div>
                    </div>
                `;break;case"line-style":a=`
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="solid"?"active":""}" data-value="solid">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-big"?"active":""}" data-value="dashed-big">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="6,3"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-small"?"active":""}" data-value="dashed-small">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="3,2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dotted"?"active":""}" data-value="dotted">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="1,2"/></svg>
                    </button>
                `;break;case"start-arrowhead":case"end-arrowhead":const x=e==="start-arrowhead",A=x?this.settings.arrow.startArrowhead:this.settings.arrow.endArrowhead;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <div style="margin-bottom: 8px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Size
                        </div>
                        <input type="range"
                            class="draw-arrowhead-size-slider"
                            min="8"
                            max="24"
                            value="${this.settings.arrow.arrowheadSize}"
                            style="width: 100%; margin-bottom: 12px;">
                        <div style="margin-bottom: 6px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Style
                        </div>
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${A==="none"?"active":""}" data-value="none">
                                <svg width="30" height="20" viewBox="0 0 30 20"><line x1="5" y1="10" x2="25" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${A==="unfilled-arrow"?"active":""}" data-value="unfilled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?10:20}" y2="10"/>
                                    <polyline points="${x?"10,5 5,10 10,15":"20,5 25,10 20,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="filled-arrow"?"active":""}" data-value="filled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="currentColor" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?12:18}" y2="10"/>
                                    <polygon points="${x?"5,10 12,5 12,15":"25,10 18,5 18,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="circle"?"active":""}" data-value="circle">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?10:20}" y2="10"/>
                                    <circle cx="${x?5:25}" cy="10" r="4"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;break}r.innerHTML=a,document.body.appendChild(r);const c=s.getBoundingClientRect();r.style.position="absolute",r.style.top=`${c.bottom+5}px`,r.style.left=`${c.left}px`;const h=r.querySelector(".draw-stroke-slider");h&&h.addEventListener("input",f=>{const g=Number(f.target.value);this.settings.arrow.strokeWeight=g,this.renderArrowOptions(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected()});const m=r.querySelector(".draw-arrowhead-size-slider");m&&m.addEventListener("input",f=>{const g=Number(f.target.value);this.settings.arrow.arrowheadSize=g,jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected()}),r.querySelectorAll(".draw-popup-option").forEach(f=>{f.addEventListener("click",()=>{const g=f.dataset.value;e==="stroke-weight"?(this.settings.arrow.strokeWeight=Number(g),h&&(h.value=g)):e==="line-style"?this.settings.arrow.lineStyle=g:e==="start-arrowhead"?this.settings.arrow.startArrowhead=g:e==="end-arrowhead"&&(this.settings.arrow.endArrowhead=g),this.renderArrowOptions(),r.remove(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected()})}),setTimeout(()=>{const f=g=>{!r.contains(g.target)&&!s.contains(g.target)&&(r.remove(),document.removeEventListener("click",f))};document.addEventListener("click",f)},0)}renderTextOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="text-color" title="Text Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.text.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-action="decrease-size" title="Decrease Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;">−</span>
                </button>
                <div style="min-width: 35px; text-align: center; font-size: 0.85em; color: var(--c-text);">
                    ${this.settings.text.size}px
                </div>
                <button class="draw-toolbar-button" data-action="increase-size" title="Increase Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;">+</span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.background?"active":""}" data-action="toggle-background" title="Background Fill">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="${this.settings.text.background?"currentColor":"none"}" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.superscript?"active":""}" data-action="toggle-superscript" title="Superscript">
                    <span style="font-size: 0.85em;">x<sup style="font-size: 0.7em;">2</sup></span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.subscript?"active":""}" data-action="toggle-subscript" title="Subscript">
                    <span style="font-size: 0.85em;">x<sub style="font-size: 0.7em;">2</sub></span>
                </button>
            </div>
        `,this.attachCommonToolbarListeners();const e=this.optionsContainer.querySelector('[data-action="decrease-size"]');e&&e.addEventListener("click",()=>{const c=Math.max(8,this.settings.text.size-2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected())});const s=this.optionsContainer.querySelector('[data-action="increase-size"]');s&&s.addEventListener("click",()=>{const c=Math.min(72,this.settings.text.size+2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected())});const o=this.optionsContainer.querySelector('[data-action="toggle-background"]');o&&o.addEventListener("click",()=>{this.settings.text.background=!this.settings.text.background,this.renderTextOptions(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected()});const r=this.optionsContainer.querySelector('[data-action="toggle-superscript"]');r&&(r.addEventListener("mousedown",c=>{c.preventDefault()}),r.addEventListener("click",()=>{jt.applyInlineFormatting("superscript")}));const a=this.optionsContainer.querySelector('[data-action="toggle-subscript"]');a&&(a.addEventListener("mousedown",c=>{c.preventDefault()}),a.addEventListener("click",()=>{jt.applyInlineFormatting("subscript")}))}renderMarkerOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="marker-color" title="Marker Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.marker.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="marker-size" title="Marker Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.marker.size==="small"?"1":this.settings.marker.size==="medium"?"3":"5"}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderHighlighterOptions(){const e=(s,o)=>{const r=parseInt(s.slice(1,3),16),a=parseInt(s.slice(3,5),16),c=parseInt(s.slice(5,7),16);return`rgba(${r}, ${a}, ${c}, ${o})`};this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="highlighter-color" title="Highlighter Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${e(this.settings.highlighter.color,.4)}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="highlighter-size" title="Highlighter Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.highlighter.size==="small"?"2":this.settings.highlighter.size==="medium"?"4":"6"}">
                        <rect x="6" y="8" width="12" height="8" rx="1"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderLassoOptions(){this.optionsContainer.innerHTML=`
            <div style="padding: var(--space-2); text-align: center;">
                <p style="color: var(--c-text-muted); font-size: var(--font-size-sm); margin: 0;">
                    Draw around notes to select and drag them as a group.
                </p>
            </div>
        `}attachCommonToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(s=>{s.addEventListener("click",()=>{const o=s.dataset.popup;this.showCommonPopupMenu(o,s)})})}showCommonPopupMenu(e,s){const o=document.querySelector(".draw-popup-menu");o&&o.remove();const r=document.createElement("div");r.className="draw-popup-menu";let a="",c="",h="";if(e.startsWith("text-")?(c="text",h=e.replace("text-","")):e.startsWith("marker-")?(c="marker",h=e.replace("marker-","")):e.startsWith("highlighter-")&&(c="highlighter",h=e.replace("highlighter-","")),h==="color"){const g=c==="text"?["#4a90e2","#2d2d2d","#d66573","#68a03f"]:["#4a90e2","#2d2d2d","#d66573","#68a03f","#ffc107"],b=c==="highlighter";a=g.map(w=>{const x=b?this.hexToRgba(w,.4):w;return`
                    <button class="draw-popup-option ${this.settings[c].color===w?"active":""}" data-value="${w}">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background-color: ${x};"></div>
                    </button>
                `}).join("")}else if(h==="size")if(c==="text")a=`
                    <button class="draw-popup-option ${this.settings.text.size===12?"active":""}" data-value="12">
                        <span style="font-size: 0.8em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===16?"active":""}" data-value="16">
                        <span style="font-size: 1em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===20?"active":""}" data-value="20">
                        <span style="font-size: 1.2em; font-weight: bold;">A</span>
                    </button>
                `;else{const g=c==="marker"?1:5,b=c==="marker"?15:30,w=this.settings[c].size,x=c==="marker"?3:8,A=c==="marker"?6:15,I=c==="marker"?10:22;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-size-slider"
                            min="${g}"
                            max="${b}"
                            value="${w}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${w===x?"active":""}" data-value="${x}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===A?"active":""}" data-value="${A}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="4"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===I?"active":""}" data-value="${I}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `}r.innerHTML=a,document.body.appendChild(r);const m=s.getBoundingClientRect();r.style.position="absolute",r.style.top=`${m.bottom+5}px`,r.style.left=`${m.left}px`;const f=r.querySelector(".draw-size-slider");f&&f.addEventListener("input",g=>{const b=Number(g.target.value);this.settings[c].size=b,c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected()}),r.querySelectorAll(".draw-popup-option").forEach(g=>{g.addEventListener("click",()=>{const b=g.dataset.value;h==="color"?this.settings[c].color=b:h==="size"&&(this.settings[c].size=Number(b),f&&(f.value=b)),c==="text"?this.renderTextOptions():c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),jt.setTool(this.currentTool,this.settings),jt.applyCurrentSettingsToSelected(),r.remove()})}),setTimeout(()=>{const g=b=>{!r.contains(b.target)&&!s.contains(b.target)&&(r.remove(),document.removeEventListener("click",g))};document.addEventListener("click",g)},0)}hexToRgba(e,s){const o=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return`rgba(${o}, ${r}, ${a}, ${s})`}getCurrentTool(){return this.currentTool}getCurrentSettings(){return this.currentTool?this.settings[this.currentTool]:null}}const Fd=new Iw;class Dw{constructor(){this.meter=null,this.isInitialized=!1,this.meterWrapper=null,this.meterPlaceholder=null,this.meterSource=null,this.settingsPanel=null,this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.permissionState="unknown",this.errorMessage=null}initialize(){this.isInitialized||(this.cacheDOMElements(),this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",e=>this.handlePitchPaintingToggle(e)),this.isInitialized=!0)}cacheDOMElements(){this.meterWrapper=document.getElementById("mic-meter-wrapper"),this.meterPlaceholder=document.getElementById("meter-placeholder"),this.settingsPanel=document.getElementById("meter-settings-panel"),this.settingsBtn=document.getElementById("meter-settings-btn"),this.sizeSelect=document.getElementById("meter-size-select"),this.fpsSelect=document.getElementById("meter-fps-select"),this.batterySaverCheckbox=document.getElementById("meter-battery-saver"),this.calibrateBtn=document.getElementById("meter-calibrate-btn"),this.resetBtn=document.getElementById("meter-reset-btn"),this.meterWrapper}setupEventListeners(){this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>this.toggleSettingsPanel()),this.sizeSelect&&this.sizeSelect.addEventListener("change",e=>this.handleSizeChange(e.target.value)),this.fpsSelect&&this.fpsSelect.addEventListener("change",e=>this.handleFpsChange(parseInt(e.target.value))),this.batterySaverCheckbox&&this.batterySaverCheckbox.addEventListener("change",e=>this.handleBatterySaverChange(e.target.checked)),this.calibrateBtn&&this.calibrateBtn.addEventListener("click",()=>this.handleAutoCalibrate()),this.resetBtn&&this.resetBtn.addEventListener("click",()=>this.handleReset())}async handlePitchPaintingToggle(e){e?await this.startMeter():this.stopMeter()}async startMeter(){if(!this.meter)try{await this.ensureMicrophoneAccess();const e=J.context;if(!e||e.state==="suspended")throw new Error("Audio context not available or suspended");await this.createMeterFromExistingMic(),this.updateUI()}catch(e){this.handleMeterError(e)}}async ensureMicrophoneAccess(){this.permissionState="pending",this.updateUI();try{this.permissionState="granted"}catch{throw this.permissionState="denied",new Error("Microphone access denied. Please check your browser permissions.")}}async createMeterFromExistingMic(){if(!this.meterWrapper)throw new Error("Meter wrapper not found - cannot create meter");this.meterWrapper.innerHTML="";const e=this.getMeterDimensions(),s=(await lr(async()=>{const{default:r}=await import("./Meter-Ccaw6VeE.js");return{default:r}},[])).default,o=(await lr(async()=>{const{default:r}=await Promise.resolve().then(()=>Mw);return{default:r}},void 0)).default;if(!o||!o.micSplitter)throw new Error("PitchPaintService microphone splitter not available");try{this.meter=new s({target:this.meterWrapper,size:e,fps:this.settings.fps,colors:{fill:"#1a1a1a",accent:"#00ff88"},floorDb:this.settings.noiseFloor,ceilingDb:5})}catch(r){throw r}try{this.meter.connect(o.micSplitter),this.meterSource=o.micSplitter}catch(r){throw r}this.meterWrapper.classList.add("active"),this.meterWrapper.classList.remove("error")}stopMeter(){this.meter&&(this.meter.disconnect(),this.meter.destroy(),this.meter=null),this.meterSource&&(this.meterSource=null),this.meterWrapper.innerHTML=`
      <div class="meter-placeholder" id="meter-placeholder">
      </div>
    `,this.meterPlaceholder=document.getElementById("meter-placeholder"),this.meterWrapper.classList.remove("active"),this.updateUI()}getMeterDimensions(){const e=this.meterWrapper.clientWidth||200,s=this.meterWrapper.clientHeight||100;if(this.meterWrapper.classList.contains("mic-meter-wrapper-inline"))return[e,36];if(this.meterWrapper.classList.contains("mic-meter-wrapper-vertical"))return[e,s];const a=this.settings.size==="compact"?48:72;return[e,a]}updateUI(){if(this.meterWrapper){if(this.meterWrapper.classList.remove("compact","wide"),this.meterWrapper.classList.add(this.settings.size),this.updateAccessibilityAttributes(),this.meterPlaceholder){let e="",s="";const o=this.meterWrapper.classList.contains("mic-meter-wrapper-inline");this.permissionState==="denied"?(e=o?"Mic access denied":"Microphone access denied. Click to retry.",s="error"):this.permissionState==="pending"?(e=o?"Requesting access...":"Requesting microphone access...",s="pending"):u.state.paint.isMicPaintActive?this.meter?(e="",s="active"):(e=o?"Starting...":"Starting meter...",s="pending"):(e="",s="disabled");const r=this.meterPlaceholder.querySelector(".meter-status-text");r&&(r.textContent=e),this.meterWrapper.classList.remove("error","pending","disabled"),s&&this.meterWrapper.classList.add(s)}this.updateSettingsUI()}}updateAccessibilityAttributes(){this.meterWrapper&&(this.meterWrapper.setAttribute("role","meter"),this.meterWrapper.setAttribute("aria-label","Microphone Level Meter"),this.meter&&this.meter.active?(this.meterWrapper.setAttribute("aria-valuenow","0"),this.meterWrapper.setAttribute("aria-valuemin",this.settings.noiseFloor.toString()),this.meterWrapper.setAttribute("aria-valuemax","5"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level active")):(this.meterWrapper.removeAttribute("aria-valuenow"),this.meterWrapper.removeAttribute("aria-valuemin"),this.meterWrapper.removeAttribute("aria-valuemax"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level inactive")),window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches&&this.meterWrapper.setAttribute("data-reduced-motion","true"))}updateSettingsUI(){this.sizeSelect&&(this.sizeSelect.value=this.settings.size),this.fpsSelect&&(this.fpsSelect.value=this.settings.fps),this.batterySaverCheckbox&&(this.batterySaverCheckbox.checked=this.settings.batterySaver)}toggleSettingsPanel(){this.settingsPanel&&this.settingsPanel.classList.toggle("hidden")}handleSizeChange(e){if(this.settings.size=e,this.meter){const s=this.getMeterDimensions();this.meter.resize(s[0],s[1])}this.updateUI()}handleFpsChange(e){this.settings.fps=e}handleBatterySaverChange(e){this.settings.batterySaver=e}async handleAutoCalibrate(){if(this.meter){this.calibrateBtn.disabled=!0,this.calibrateBtn.textContent="Stay quiet...";try{await new Promise(e=>setTimeout(e,2e3)),this.settings.noiseFloor=-65,this.settings.autoCalibrated=!0,this.calibrateBtn.textContent="Calibrated ✓",setTimeout(()=>{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1},1500)}catch{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1}}}handleReset(){if(this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.updateSettingsUI(),this.meter){const e=this.getMeterDimensions();this.meter.resize(e[0],e[1])}}handleMeterError(e){this.errorMessage=e.message,this.meterWrapper.classList.add("error"),(e.message.includes("denied")||e.message.includes("permission"))&&this.showPermissionRetryPrompt(),this.updateUI()}showPermissionRetryPrompt(){let e=this.meterWrapper.querySelector(".meter-permission-prompt");if(!e){e=document.createElement("div"),e.className="meter-permission-prompt",e.innerHTML=`
        <p>Microphone access is required for the level meter.</p>
        <button class="meter-retry-btn">Grant Permission</button>
        <button class="meter-help-btn">Help</button>
      `,this.meterWrapper.appendChild(e);const s=e.querySelector(".meter-retry-btn"),o=e.querySelector(".meter-help-btn");s.addEventListener("click",()=>this.retryPermission()),o.addEventListener("click",()=>this.showPermissionHelp())}}async retryPermission(){try{const e=this.meterWrapper.querySelector(".meter-permission-prompt");e&&e.remove(),this.permissionState="unknown",this.meterWrapper.classList.remove("error"),u.state.paint.isMicPaintActive&&await this.startMeter()}catch(e){this.handleMeterError(e)}}showPermissionHelp(){alert(`
To enable the microphone level meter:

1. Look for a microphone icon in your browser's address bar
2. Click it and select "Allow"
3. If you don't see the icon, go to your browser settings:
   - Chrome: Settings > Privacy and security > Site Settings > Microphone
   - Firefox: Settings > Privacy & Security > Permissions > Microphone
   - Safari: Settings > Websites > Microphone

4. Find this website and set it to "Allow"
5. Refresh the page if needed
    `)}dispose(){this.stopMeter(),this.isInitialized=!1}}const Rw=new Dw;class Ow{constructor(){this.element=null,this.isVisible=!1,this.hideTimeout=null}initialize(){this.element=document.createElement("div"),this.element.className="zoom-indicator",this.element.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        `,document.body.appendChild(this.element),u.on("zoomIn",()=>this.show()),u.on("zoomOut",()=>this.show())}show(){if(!this.element)return;let e=100,s="";if(Lt.getViewportInfo){const o=Lt.getViewportInfo();if(e=Math.round(o.zoomLevel*100),o.canSeeFullRange)s=" (Full Range)";else{const r=o.startRank||o.startRow,a=o.endRank||o.endRow;s=` (~${Math.floor(a-r+1)} semitones)`}}this.element.textContent=`Zoom: ${e}%${s}`,this.element.style.opacity="1",this.isVisible=!0,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>this.hide(),2e3)}hide(){!this.element||!this.isVisible||(this.element.style.opacity="0",this.isVisible=!1,clearTimeout(this.hideTimeout))}dispose(){this.element&&(document.body.removeChild(this.element),this.element=null),clearTimeout(this.hideTimeout)}}const Nw=new Ow,Kp={enableModulationTool(){u.setSelectedTool("modulation"),console.log("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),console.log("[MODULATION TEST] Click marker labels to toggle 2:3 ↔ 3:2"),console.log("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const e=this.findNearestGridLine(200),s=this.findMeasureIndexForX(e.x),o=u.addModulationMarker(s,Es.COMPRESSION_2_3,e.x,e.columnIndex);return console.log("[MODULATION TEST] Added test marker at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",200,")"),o},addTestMarker2(){const e=this.findNearestGridLine(400),s=this.findMeasureIndexForX(e.x),o=u.addModulationMarker(s,Es.EXPANSION_3_2,e.x,e.columnIndex);return console.log("[MODULATION TEST] Added test marker 2 at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",400,")"),o},findNearestGridLine(n){const e=u.state;let s=0,o=0,r=1/0,a=0;for(let c=0;c<e.columnWidths.length;c++){const h=Math.abs(a-n);h<r&&(r=h,o=a,s=c);const m=e.columnWidths[c]||0;a+=m*e.cellWidth}return console.log("[MODULATION TEST] findNearestGridLine:",{targetX:n,closestColumnIndex:s,closestX:o,minDistance:r}),{columnIndex:s,x:o}},findMeasureIndexForX(n){const e=u.state.cellWidth||40,s=5,o=Math.round(n/e);return Math.max(1,Math.round(o/s))},clearAllMarkers(){[...u.state.modulationMarkers||[]].forEach(e=>{u.removeModulationMarker(e.id)}),console.log("[MODULATION TEST] Cleared all markers")},testMapping(){const n=u.state.baseMicrobeatPx||u.state.cellWidth||40;if(console.log("[MODULATION TEST] Base microbeat pixels:",n),console.log("[MODULATION TEST] Modulation markers:",u.state.modulationMarkers),window.getModulationMapping){const e=window.getModulationMapping();console.log("[MODULATION TEST] Coordinate mapping:",e),[0,100,200,300,400,500].forEach(o=>{const r=e.canvasXToMicrobeat(o),a=e.microbeatToCanvasX(r);console.log(`[MODULATION TEST] x=${o} → microbeat=${r.toFixed(3)} → x=${a.toFixed(1)}`)})}},testVisualExpansion(){console.log("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const n=this.addTestMarker2();console.log("[MODULATION TEST] Added 3:2 expansion marker:",n),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show expansion after x=400"),console.log("[MODULATION TEST] Container should be wider to accommodate expansion"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){console.log("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const n=this.addTestMarker();console.log("[MODULATION TEST] Added 2:3 compression marker:",n),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show compression after x=200"),console.log("[MODULATION TEST] Container should adjust to accommodate compression"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){console.log("[MODULATION TEST] Current state:",{selectedTool:u.state.selectedTool,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.baseMicrobeatPx,cellWidth:u.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=Kp);function Lw(){Nw.initialize(),document.addEventListener("keydown",n=>{const e=document.activeElement.tagName.toLowerCase();["input","textarea"].includes(e)||((n.ctrlKey||n.metaKey)&&(n.key==="+"||n.key==="=")&&(n.preventDefault(),u.emit("zoomIn")),(n.ctrlKey||n.metaKey)&&n.key==="-"&&(n.preventDefault(),u.emit("zoomOut")),(n.ctrlKey||n.metaKey)&&n.key==="0"&&(n.preventDefault(),Lt.resetZoom&&Lt.resetZoom()))})}function Fw(){window.debugZoom={info:()=>Lt.getViewportInfo?Lt.getViewportInfo():"Viewport info not available",zoomTo:n=>{T.debug("Debug Tools",`Setting zoom to ${n}`,null,"zoom")},scrollTo:n=>{if(T.debug("Debug Tools",`Scrolling to position ${n}`,null,"scroll"),Lt.scroll){const s=Lt.getViewportInfo().scrollPosition*(u.state.fullRowData.length*u.state.cellHeight*.5),o=n*(u.state.fullRowData.length*u.state.cellHeight*.5);Lt.scroll(o-s)}},goToNote:n=>{Lt.scrollToNote?Lt.scrollToNote(n):T.warn("Debug Tools",`scrollToNote not available. Requested: ${n}`,null,"debug")}}}let $d=!1,Vo=null;window.initAudio=async()=>$d?!0:Vo||(Vo=(async()=>{try{return J.context.state!=="running"&&(await J.start(),T.info("Main.js","AudioContext started successfully")),$d=!0,!0}catch(n){return T.error("Main.js","Could not start AudioContext",n),Vo=null,!1}})(),Vo);let Bd=!1;const Qi=()=>{Bd||(Bd=!0,window.initAudio().catch(n=>console.warn("Failed to initialize audio:",n)),document.removeEventListener("click",Qi,!0),document.removeEventListener("keydown",Qi,!0),document.removeEventListener("touchstart",Qi,!0))};document.addEventListener("click",Qi,!0);document.addEventListener("keydown",Qi,!0);document.addEventListener("touchstart",Qi,!0);const Ji={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,initialized:!1};function Js(n){Ji[n]=!0}function Ho(n,e=5e3){return new Promise((s,o)=>{if(Ji[n]){s();return}const r=Date.now(),a=()=>{Ji[n]?s():Date.now()-r>e?o(new Error(`Component ${n} not ready within ${e}ms`)):setTimeout(a,50)};a()})}document.addEventListener("DOMContentLoaded",async()=>{window.initStartTime=Date.now(),T.info("Main.js","DOMContentLoaded event fired"),T.section("STARTING INITIALIZATION");try{(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&Ep(),ii.init(),Js("domCache"),(()=>{const r=ii.get("appContainer")||document.getElementById("app-container");r&&["click","keydown","touchstart"].forEach(c=>{r.addEventListener(c,window.initAudio,{once:!0})})})(),V0(u.state),u.state.fullRowData=Oc;const e=Lt.init();Js("layoutService"),hh.setContexts(e),Js("canvasContextService"),ee.init(),Js("synthEngine"),Ks.initialize().catch(r=>{console.warn("[INIT] RhythmPlaybackService initialization deferred (needs user interaction):",r)}),Js("rhythmPlaybackService"),Hi.init(),Js("transportService"),q0(),j0(),await Ho("layoutService"),await Ho("canvasContextService"),X0.init(),Js("scrollSync"),md(u.state,"core-services-initialization"),await Ho("scrollSync"),fb.init(),Cc.init(),J_.init(),xh.init(),Da.init(),Js("uiComponents"),await Ho("uiComponents"),H_(),c0(),X_(),Js("audioComponents"),md(u.state,"audio-components-initialization"),$w(),T.initStart("Static Waveform Visualizer"),ew()?T.initSuccess("Static Waveform Visualizer"):T.initFailed("Static Waveform Visualizer");const{default:s}=await lr(async()=>{const{default:r}=await Promise.resolve().then(()=>uw);return{default:r}},void 0);window.effectsCoordinator=s,T.initStart("Effects Managers"),Dd.init(),Rd.init(),s.init(),Nn.init(),Od.init(),window.animationEffectsManager=Dd,window.audioEffectsManager=Rd,window.effectsController=Nn,window.positionEffectsController=Od,T.initSuccess("Effects Managers"),T.initStart("Paint components"),Ah.initialize(),Kc.initialize(),Pw.initialize(),await Ld.initialize(),window.PaintPlaybackService=Ld,Rw.initialize(),T.initSuccess("Paint components"),T.initStart("Draw Tools"),jt.initialize(),Fd.initialize(),window.drawToolsController=Fd,window.annotationService=jt,T.initSuccess("Draw Tools"),T.initStart("Drum components"),$n.initialize(),T.initSuccess("Drum components"),Lw(),Fw(),await Ho("audioComponents"),T.section("SETTING UP STATE SUBSCRIPTIONS");const o=()=>{Ji.uiComponents&&(Cc.renderPitchGrid(),Cc.renderDrumGrid(),jt.resize())};u.on("notesChanged",()=>{o()}),u.on("stampPlacementsChanged",()=>{o()}),u.on("tripletPlacementsChanged",()=>{o()}),u.on("modulationMarkersChanged",()=>{if(T.event("Main","modulationMarkersChanged event received, recalculating layout",null,"state"),!Ji.layoutService){T.warn("Main","LayoutService not ready, skipping layout recalculation");return}Lt.recalculateLayout(),T.debug("Main","Layout recalculated for modulation, calling renderAll()",null,"state"),o(),T.debug("Main","renderAll() completed, calling renderMacrobeatTools() for modulation",null,"state"),ji.renderMacrobeatTools(),T.debug("Main","modulationMarkersChanged handling complete",null,"state")}),u.on("rhythmStructureChanged",()=>{T.event("Main","rhythmStructureChanged event received, recalculating layout",null,"state"),Lt.recalculateLayout(),T.debug("Main","Layout recalculated, calling renderAll()",null,"state"),o(),T.debug("Main","renderAll() completed, calling renderMacrobeatTools()",null,"state"),ji.renderMacrobeatTools(),T.debug("Main","rhythmStructureChanged handling complete",null,"state")}),u.on("layoutConfigChanged",()=>{o(),ji.renderMacrobeatTools()}),u.on("zoomIn",()=>{T.event("Main","Zoom in event received",null,"zoom"),Lt.zoomIn()}),u.on("zoomOut",()=>{T.event("Main","Zoom out event received",null,"zoom"),Lt.zoomOut()}),T.section("PERFORMING INITIAL RENDER"),u.setSelectedTool("note"),u.setSelectedNote("circle","#4a90e2"),o(),ji.renderMacrobeatTools(),Js("initialized"),T.section("INITIALIZATION COMPLETE"),window.ModulationTest=Kp,setTimeout(()=>{Lt.getViewportInfo},1e3)}catch(n){console.error("[INIT] ❌ INITIALIZATION FAILED:",n),console.error("[INIT] Error stack:",n.stack),console.error("[INIT] Component readiness at failure:",Ji),T.error("Main.js","Initialization failed",n);const e=document.createElement("div");e.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,e.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${n.message}</pre>
                <pre>Stack: ${n.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(e)}});function $w(){const n=document.querySelector(".rhythm-stamps-container"),e=document.querySelector(".rhythm-tab-sidebar");document.querySelector(".rhythm-tab-content");const s=document.querySelectorAll(".rhythm-tab-button"),o=document.querySelectorAll(".rhythm-tab-panel");n&&window.getComputedStyle(n),e&&window.getComputedStyle(e),!(!s.length||!o.length)&&s.forEach((r,a)=>{r.addEventListener("click",c=>{const h=r.getAttribute("data-rhythm-tab");s.forEach(f=>f.classList.remove("active")),o.forEach(f=>f.classList.remove("active")),r.classList.add("active");const m=document.getElementById(`${h}-panel`);m&&m.classList.add("active")})})}
