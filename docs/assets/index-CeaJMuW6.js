var om=Object.defineProperty;var rm=(s,n,i)=>n in s?om(s,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):s[n]=i;var ms=(s,n,i)=>rm(s,typeof n!="symbol"?n+"":n,i);(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))a(r);new MutationObserver(r=>{for(const l of r)if(l.type==="childList")for(const u of l.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&a(u)}).observe(document,{childList:!0,subtree:!0});function i(r){const l={};return r.integrity&&(l.integrity=r.integrity),r.referrerPolicy&&(l.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?l.credentials="include":r.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function a(r){if(r.ep)return;r.ep=!0;const l=i(r);fetch(r.href,l)}})();function am(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var br={exports:{}};/*! For license information please see Tone.js.LICENSE.txt */var lm=br.exports,qh;function cm(){return qh||(qh=1,function(s,n){(function(i,a){s.exports=a()})(typeof self<"u"?self:lm,()=>(()=>{var i={871:function(u,d,v){(function(p,y,x,_){var m=function(nt,ht,ut){return{endTime:ht,insertTime:ut,type:"exponentialRampToValue",value:nt}},f=function(nt,ht,ut){return{endTime:ht,insertTime:ut,type:"linearRampToValue",value:nt}},b=function(nt,ht){return{startTime:ht,type:"setValue",value:nt}},g=function(nt,ht,ut){return{duration:ut,startTime:ht,type:"setValueCurve",values:nt}},S=function(nt,ht,ut){var kt=ut.startTime,dt=ut.target,Lt=ut.timeConstant;return dt+(ht-dt)*Math.exp((kt-nt)/Lt)},A=function(nt){return nt.type==="exponentialRampToValue"},E=function(nt){return nt.type==="linearRampToValue"},O=function(nt){return A(nt)||E(nt)},L=function(nt){return nt.type==="setValue"},F=function(nt){return nt.type==="setValueCurve"},U=function nt(ht,ut,kt,dt){var Lt=ht[ut];return Lt===void 0?dt:O(Lt)||L(Lt)?Lt.value:F(Lt)?Lt.values[Lt.values.length-1]:S(kt,nt(ht,ut-1,Lt.startTime,dt),Lt)},X=function(nt,ht,ut,kt,dt){return ut===void 0?[kt.insertTime,dt]:O(ut)?[ut.endTime,ut.value]:L(ut)?[ut.startTime,ut.value]:F(ut)?[ut.startTime+ut.duration,ut.values[ut.values.length-1]]:[ut.startTime,U(nt,ht-1,ut.startTime,dt)]},Q=function(nt){return nt.type==="cancelAndHold"},ct=function(nt){return nt.type==="cancelScheduledValues"},gt=function(nt){return Q(nt)||ct(nt)?nt.cancelTime:A(nt)||E(nt)?nt.endTime:nt.startTime},_t=function(nt,ht,ut,kt){var dt=kt.endTime,Lt=kt.value;return ut===Lt?Lt:0<ut&&0<Lt||ut<0&&Lt<0?ut*Math.pow(Lt/ut,(nt-ht)/(dt-ht)):0},wt=function(nt,ht,ut,kt){return ut+(nt-ht)/(kt.endTime-ht)*(kt.value-ut)},Mt=function(nt,ht){var ut=ht.duration,kt=ht.startTime,dt=ht.values;return function(Lt,jt){var Vt=Math.floor(jt),ce=Math.ceil(jt);return Vt===ce?Lt[Vt]:(1-(jt-Vt))*Lt[Vt]+(1-(ce-jt))*Lt[ce]}(dt,(nt-kt)/ut*(dt.length-1))},Rt=function(nt){return nt.type==="setTarget"},Xt=function(){return _(function nt(ht){x(this,nt),this._automationEvents=[],this._currenTime=0,this._defaultValue=ht},[{key:Symbol.iterator,value:function(){return this._automationEvents[Symbol.iterator]()}},{key:"add",value:function(nt){var ht=gt(nt);if(Q(nt)||ct(nt)){var ut=this._automationEvents.findIndex(function(Ae){return ct(nt)&&F(Ae)?Ae.startTime+Ae.duration>=ht:gt(Ae)>=ht}),kt=this._automationEvents[ut];if(ut!==-1&&(this._automationEvents=this._automationEvents.slice(0,ut)),Q(nt)){var dt=this._automationEvents[this._automationEvents.length-1];if(kt!==void 0&&O(kt)){if(dt!==void 0&&Rt(dt))throw new Error("The internal list is malformed.");var Lt=dt===void 0?kt.insertTime:F(dt)?dt.startTime+dt.duration:gt(dt),jt=dt===void 0?this._defaultValue:F(dt)?dt.values[dt.values.length-1]:dt.value,Vt=A(kt)?_t(ht,Lt,jt,kt):wt(ht,Lt,jt,kt),ce=A(kt)?m(Vt,ht,this._currenTime):f(Vt,ht,this._currenTime);this._automationEvents.push(ce)}if(dt!==void 0&&Rt(dt)&&this._automationEvents.push(b(this.getValue(ht),ht)),dt!==void 0&&F(dt)&&dt.startTime+dt.duration>ht){var Ke=ht-dt.startTime,Ht=(dt.values.length-1)/dt.duration,we=Math.max(2,1+Math.ceil(Ke*Ht)),Ue=Ke/(we-1)*Ht,ts=dt.values.slice(0,we);if(Ue<1)for(var xe=1;xe<we;xe+=1){var ze=Ue*xe%1;ts[xe]=dt.values[xe-1]*(1-ze)+dt.values[xe]*ze}this._automationEvents[this._automationEvents.length-1]=g(ts,dt.startTime,Ke)}}}else{var ve=this._automationEvents.findIndex(function(Ae){return gt(Ae)>ht}),hs=ve===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[ve-1];if(hs!==void 0&&F(hs)&&gt(hs)+hs.duration>ht)return!1;var Xs=A(nt)?m(nt.value,nt.endTime,this._currenTime):E(nt)?f(nt.value,ht,this._currenTime):nt;if(ve===-1)this._automationEvents.push(Xs);else{if(F(nt)&&ht+nt.duration>gt(this._automationEvents[ve]))return!1;this._automationEvents.splice(ve,0,Xs)}}return!0}},{key:"flush",value:function(nt){var ht=this._automationEvents.findIndex(function(dt){return gt(dt)>nt});if(ht>1){var ut=this._automationEvents.slice(ht-1),kt=ut[0];Rt(kt)&&ut.unshift(b(U(this._automationEvents,ht-2,kt.startTime,this._defaultValue),kt.startTime)),this._automationEvents=ut}}},{key:"getValue",value:function(nt){if(this._automationEvents.length===0)return this._defaultValue;var ht=this._automationEvents.findIndex(function(ts){return gt(ts)>nt}),ut=this._automationEvents[ht],kt=(ht===-1?this._automationEvents.length:ht)-1,dt=this._automationEvents[kt];if(dt!==void 0&&Rt(dt)&&(ut===void 0||!O(ut)||ut.insertTime>nt))return S(nt,U(this._automationEvents,kt-1,dt.startTime,this._defaultValue),dt);if(dt!==void 0&&L(dt)&&(ut===void 0||!O(ut)))return dt.value;if(dt!==void 0&&F(dt)&&(ut===void 0||!O(ut)||dt.startTime+dt.duration>nt))return nt<dt.startTime+dt.duration?Mt(nt,dt):dt.values[dt.values.length-1];if(dt!==void 0&&O(dt)&&(ut===void 0||!O(ut)))return dt.value;if(ut!==void 0&&A(ut)){var Lt=X(this._automationEvents,kt,dt,ut,this._defaultValue),jt=y(Lt,2),Vt=jt[0],ce=jt[1];return _t(nt,Vt,ce,ut)}if(ut!==void 0&&E(ut)){var Ke=X(this._automationEvents,kt,dt,ut,this._defaultValue),Ht=y(Ke,2),we=Ht[0],Ue=Ht[1];return wt(nt,we,Ue,ut)}return this._defaultValue}}])}();p.AutomationEventList=Xt,p.createCancelAndHoldAutomationEvent=function(nt){return{cancelTime:nt,type:"cancelAndHold"}},p.createCancelScheduledValuesAutomationEvent=function(nt){return{cancelTime:nt,type:"cancelScheduledValues"}},p.createExponentialRampToValueAutomationEvent=function(nt,ht){return{endTime:ht,type:"exponentialRampToValue",value:nt}},p.createLinearRampToValueAutomationEvent=function(nt,ht){return{endTime:ht,type:"linearRampToValue",value:nt}},p.createSetTargetAutomationEvent=function(nt,ht,ut){return{startTime:ht,target:nt,timeConstant:ut,type:"setTarget"}},p.createSetValueAutomationEvent=b,p.createSetValueCurveAutomationEvent=g})(d,v(821),v(805),v(989))},113:u=>{u.exports=function(d,v){(v==null||v>d.length)&&(v=d.length);for(var p=0,y=new Array(v);p<v;p++)y[p]=d[p];return y},u.exports.__esModule=!0,u.exports.default=u.exports},569:u=>{u.exports=function(d){if(Array.isArray(d))return d},u.exports.__esModule=!0,u.exports.default=u.exports},805:u=>{u.exports=function(d,v){if(!(d instanceof v))throw new TypeError("Cannot call a class as a function")},u.exports.__esModule=!0,u.exports.default=u.exports},989:(u,d,v)=>{var p=v(498);function y(x,_){for(var m=0;m<_.length;m++){var f=_[m];f.enumerable=f.enumerable||!1,f.configurable=!0,"value"in f&&(f.writable=!0),Object.defineProperty(x,p(f.key),f)}}u.exports=function(x,_,m){return _&&y(x.prototype,_),m&&y(x,m),Object.defineProperty(x,"prototype",{writable:!1}),x},u.exports.__esModule=!0,u.exports.default=u.exports},474:u=>{u.exports=function(d,v){var p=d==null?null:typeof Symbol<"u"&&d[Symbol.iterator]||d["@@iterator"];if(p!=null){var y,x,_,m,f=[],b=!0,g=!1;try{if(_=(p=p.call(d)).next,v===0){if(Object(p)!==p)return;b=!1}else for(;!(b=(y=_.call(p)).done)&&(f.push(y.value),f.length!==v);b=!0);}catch(S){g=!0,x=S}finally{try{if(!b&&p.return!=null&&(m=p.return(),Object(m)!==m))return}finally{if(g)throw x}}return f}},u.exports.__esModule=!0,u.exports.default=u.exports},18:u=>{u.exports=function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)},u.exports.__esModule=!0,u.exports.default=u.exports},821:(u,d,v)=>{var p=v(569),y=v(474),x=v(744),_=v(18);u.exports=function(m,f){return p(m)||y(m,f)||x(m,f)||_()},u.exports.__esModule=!0,u.exports.default=u.exports},327:(u,d,v)=>{var p=v(564).default;u.exports=function(y,x){if(p(y)!="object"||!y)return y;var _=y[Symbol.toPrimitive];if(_!==void 0){var m=_.call(y,x||"default");if(p(m)!="object")return m;throw new TypeError("@@toPrimitive must return a primitive value.")}return(x==="string"?String:Number)(y)},u.exports.__esModule=!0,u.exports.default=u.exports},498:(u,d,v)=>{var p=v(564).default,y=v(327);u.exports=function(x){var _=y(x,"string");return p(_)=="symbol"?_:_+""},u.exports.__esModule=!0,u.exports.default=u.exports},564:u=>{function d(v){return u.exports=d=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(p){return typeof p}:function(p){return p&&typeof Symbol=="function"&&p.constructor===Symbol&&p!==Symbol.prototype?"symbol":typeof p},u.exports.__esModule=!0,u.exports.default=u.exports,d(v)}u.exports=d,u.exports.__esModule=!0,u.exports.default=u.exports},744:(u,d,v)=>{var p=v(113);u.exports=function(y,x){if(y){if(typeof y=="string")return p(y,x);var _=Object.prototype.toString.call(y).slice(8,-1);return _==="Object"&&y.constructor&&(_=y.constructor.name),_==="Map"||_==="Set"?Array.from(y):_==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(_)?p(y,x):void 0}},u.exports.__esModule=!0,u.exports.default=u.exports}},a={};function r(u){var d=a[u];if(d!==void 0)return d.exports;var v=a[u]={exports:{}};return i[u].call(v.exports,v,v.exports,r),v.exports}r.d=(u,d)=>{for(var v in d)r.o(d,v)&&!r.o(u,v)&&Object.defineProperty(u,v,{enumerable:!0,get:d[v]})},r.o=(u,d)=>Object.prototype.hasOwnProperty.call(u,d),r.r=u=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(u,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(u,"__esModule",{value:!0})};var l={};return(()=>{r.r(l),r.d(l,{AMOscillator:()=>Ji,AMSynth:()=>Sa,Abs:()=>Th,Add:()=>Pn,AmplitudeEnvelope:()=>wi,Analyser:()=>vo,AudioToGain:()=>tr,AutoFilter:()=>Na,AutoPanner:()=>La,AutoWah:()=>Fa,BaseContext:()=>ua,BiquadFilter:()=>so,BitCrusher:()=>Ba,Buffer:()=>em,BufferSource:()=>nm,Buffers:()=>sm,Channel:()=>Dn,Chebyshev:()=>za,Chorus:()=>Va,Clock:()=>fi,Compressor:()=>nn,Context:()=>ai,Convolver:()=>dl,CrossFade:()=>xi,DCMeter:()=>nl,Delay:()=>rs,Destination:()=>Hp,Distortion:()=>$a,Draw:()=>Qp,DuoSynth:()=>Ta,EQ3:()=>ul,Emitter:()=>ri,Envelope:()=>Oe,FFT:()=>sl,FMOscillator:()=>yi,FMSynth:()=>Ma,FatOscillator:()=>Ki,FeedbackCombFilter:()=>oo,FeedbackDelay:()=>ja,Filter:()=>ls,Follower:()=>po,Freeverb:()=>Ha,Frequency:()=>Sp,FrequencyClass:()=>Ve,FrequencyEnvelope:()=>no,FrequencyShifter:()=>Ga,Gain:()=>yt,GainToAudio:()=>Mh,Gate:()=>al,GrainPlayer:()=>wa,GreaterThan:()=>nr,GreaterThanZero:()=>sr,IntervalTimeline:()=>_h,JCReverb:()=>Ua,LFO:()=>je,Limiter:()=>ll,Listener:()=>Yp,Loop:()=>co,LowpassCombFilter:()=>ao,Master:()=>Up,MembraneSynth:()=>io,Merge:()=>bn,MetalSynth:()=>Ca,Meter:()=>el,MidSideCompressor:()=>cl,MidSideMerge:()=>go,MidSideSplit:()=>mo,Midi:()=>kp,MidiClass:()=>mi,Mono:()=>ol,MonoSynth:()=>In,MultibandCompressor:()=>hl,MultibandSplit:()=>yo,Multiply:()=>ae,Negate:()=>xa,Noise:()=>vn,NoiseSynth:()=>Aa,Offline:()=>Ap,OfflineContext:()=>li,OmniOscillator:()=>tn,OnePoleFilter:()=>ro,Oscillator:()=>re,PWMOscillator:()=>to,PanVol:()=>lr,Panner:()=>fo,Panner3D:()=>rl,Param:()=>Ct,Part:()=>ho,Pattern:()=>Da,Phaser:()=>Za,PingPongDelay:()=>Xa,PitchShift:()=>Ya,Player:()=>_i,Players:()=>_a,PluckSynth:()=>Ia,PolySynth:()=>Oa,Pow:()=>gi,PulseOscillator:()=>bi,Recorder:()=>cr,Reverb:()=>Qa,Sampler:()=>lo,Scale:()=>en,ScaleExp:()=>ir,Sequence:()=>Ra,Signal:()=>St,Solo:()=>pe,Split:()=>On,StateTimeline:()=>ui,StereoWidener:()=>Ja,Subtract:()=>En,SyncedSignal:()=>Dp,Synth:()=>yn,Ticks:()=>Pp,TicksClass:()=>oe,Time:()=>_p,TimeClass:()=>is,Timeline:()=>ns,ToneAudioBuffer:()=>Ft,ToneAudioBuffers:()=>pi,ToneAudioNode:()=>it,ToneBufferSource:()=>gn,ToneEvent:()=>Ls,ToneOscillatorNode:()=>Qi,Transport:()=>jp,TransportTime:()=>Tp,TransportTimeClass:()=>me,Tremolo:()=>Ka,Unit:()=>d,UserMedia:()=>Zi,Vibrato:()=>tl,Volume:()=>Js,WaveShaper:()=>Cs,Waveform:()=>il,Zero:()=>er,connect:()=>$e,connectSeries:()=>os,connectSignal:()=>Yi,context:()=>Kp,dbToGain:()=>ci,debug:()=>u,defaultArg:()=>fs,disconnect:()=>pa,fanIn:()=>Mp,ftom:()=>pn,gainToDb:()=>Xi,getContext:()=>ee,getDestination:()=>Xp,getDraw:()=>Jp,getListener:()=>Zp,getTransport:()=>Gp,immediate:()=>$p,intervalToFrequencyRatio:()=>hi,isArray:()=>Pe,isBoolean:()=>oa,isDefined:()=>Et,isFunction:()=>uh,isNote:()=>Gi,isNumber:()=>es,isObject:()=>Zs,isString:()=>Ss,isUndef:()=>Ye,loaded:()=>tm,mtof:()=>da,now:()=>Vp,optionsFromArguments:()=>K,setContext:()=>Zo,start:()=>bp,supported:()=>pp,version:()=>v});var u={};r.r(u),r.d(u,{assert:()=>bt,assertContextRunning:()=>ra,assertRange:()=>Ee,assertUsedScheduleTime:()=>ph,enterScheduledCallback:()=>aa,log:()=>mh,setLogger:()=>mp,warn:()=>ni});var d={};r.r(d);const v="15.0.4";var p=r(871);const y=new WeakSet,x=new WeakMap,_=new WeakMap,m=new WeakMap,f=new WeakMap,b=new WeakMap,g=new WeakMap,S=new WeakMap,A=new WeakMap,E=new WeakMap,O={construct:()=>O},L=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,F=(h,t)=>{const e=[];let o=h.replace(/^[\s]+/,""),c=o.match(L);for(;c!==null;){const w=c[1].slice(1,-1),M=c[0].replace(/([\s]+)?;?$/,"").replace(w,new URL(w,t).toString());e.push(M),o=o.slice(c[0].length).replace(/^[\s]+/,""),c=o.match(L)}return[e.join(";"),o]},U=h=>{if(h!==void 0&&!Array.isArray(h))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},X=h=>{if(!(t=>{try{new new Proxy(t,O)}catch{return!1}return!0})(h))throw new TypeError("The given value for processorCtor should be a constructor.");if(h.prototype===null||typeof h.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},Q=(h,t)=>{const e=h.get(t);if(e===void 0)throw new Error("A value with the given key could not be found.");return e},ct=(h,t)=>{const e=Array.from(h).filter(t);if(e.length>1)throw Error("More than one element was found.");if(e.length===0)throw Error("No element was found.");const[o]=e;return h.delete(o),o},gt=(h,t,e,o)=>{const c=Q(h,t),w=ct(c,M=>M[0]===e&&M[1]===o);return c.size===0&&h.delete(t),w},_t=h=>Q(g,h),wt=h=>{if(y.has(h))throw new Error("The AudioNode is already stored.");y.add(h),_t(h).forEach(t=>t(!0))},Mt=h=>"port"in h,Rt=h=>{if(!y.has(h))throw new Error("The AudioNode is not stored.");y.delete(h),_t(h).forEach(t=>t(!1))},Xt=(h,t)=>{!Mt(h)&&t.every(e=>e.size===0)&&Rt(h)},nt={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},ht=(h,t)=>h.context===t,ut=h=>{try{h.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},kt=()=>new DOMException("","IndexSizeError"),dt=h=>{var t;h.getChannelData=(t=h.getChannelData,e=>{try{return t.call(h,e)}catch(o){throw o.code===12?kt():o}})},Lt={numberOfChannels:1},jt=-34028234663852886e22,Vt=34028234663852886e22,ce=h=>y.has(h),Ke={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},Ht=h=>Q(x,h),we=h=>Q(m,h),Ue=(h,t)=>{const{activeInputs:e}=Ht(h);e.forEach(c=>c.forEach(([w])=>{t.includes(h)||Ue(w,[...t,h])}));const o=(c=>"playbackRate"in c)(h)?[h.playbackRate]:Mt(h)?Array.from(h.parameters.values()):(c=>"frequency"in c&&"gain"in c)(h)?[h.Q,h.detune,h.frequency,h.gain]:(c=>"offset"in c)(h)?[h.offset]:(c=>!("frequency"in c)&&"gain"in c)(h)?[h.gain]:(c=>"detune"in c&&"frequency"in c)(h)?[h.detune,h.frequency]:(c=>"pan"in c)(h)?[h.pan]:[];for(const c of o){const w=we(c);w!==void 0&&w.activeInputs.forEach(([M])=>Ue(M,t))}ce(h)&&Rt(h)},ts=h=>{Ue(h.destination,[])},xe=h=>"context"in h,ze=h=>xe(h[0]),ve=(h,t,e,o)=>{for(const c of h)if(e(c)){if(o)return!1;throw Error("The set contains at least one similar element.")}return h.add(t),!0},hs=(h,t,[e,o],c)=>{ve(h,[t,e,o],w=>w[0]===t&&w[1]===e,c)},Xs=(h,[t,e,o],c)=>{const w=h.get(t);w===void 0?h.set(t,new Set([[e,o]])):ve(w,[e,o],M=>M[0]===e,c)},Ae=h=>"inputs"in h,ln=(h,t,e,o)=>{if(Ae(t)){const c=t.inputs[o];return h.connect(c,e,0),[c,e,0]}return h.connect(t,e,o),[t,e,o]},Hn=(h,t,e)=>{for(const o of h)if(o[0]===t&&o[1]===e)return h.delete(o),o;return null},Un=(h,t)=>{if(!_t(h).delete(t))throw new Error("Missing the expected event listener.")},Xn=(h,t,e)=>{const o=Q(h,t),c=ct(o,w=>w[0]===e);return o.size===0&&h.delete(t),c},cn=(h,t,e,o)=>{Ae(t)?h.disconnect(t.inputs[o],e,0):h.disconnect(t,e,o)},Yt=h=>Q(_,h),Sn=h=>Q(f,h),Ys=h=>S.has(h),Yn=h=>!y.has(h),Lo=(h,t)=>new Promise(e=>{if(t!==null)e(!0);else{const o=h.createScriptProcessor(256,1,1),c=h.createGain(),w=h.createBuffer(1,2,44100),M=w.getChannelData(0);M[0]=1,M[1]=1;const C=h.createBufferSource();C.buffer=w,C.loop=!0,C.connect(o).connect(h.destination),C.connect(c),C.disconnect(c),o.onaudioprocess=k=>{const P=k.inputBuffer.getChannelData(0);Array.prototype.some.call(P,I=>I===1)?e(!0):e(!1),C.stop(),o.onaudioprocess=null,C.disconnect(o),o.disconnect(h.destination)},C.start()}}),Fi=(h,t)=>{const e=new Map;for(const o of h)for(const c of o){const w=e.get(c);e.set(c,w===void 0?1:w+1)}e.forEach((o,c)=>t(c,o))},Zn=h=>"context"in h,Gr=h=>{const t=new Map;h.connect=(e=>(o,c=0,w=0)=>{const M=Zn(o)?e(o,c,w):e(o,c),C=t.get(o);return C===void 0?t.set(o,[{input:w,output:c}]):C.every(k=>k.input!==w||k.output!==c)&&C.push({input:w,output:c}),M})(h.connect.bind(h)),h.disconnect=(e=>(o,c,w)=>{if(e.apply(h),o===void 0)t.clear();else if(typeof o=="number")for(const[M,C]of t){const k=C.filter(P=>P.output!==o);k.length===0?t.delete(M):t.set(M,k)}else if(t.has(o))if(c===void 0)t.delete(o);else{const M=t.get(o);if(M!==void 0){const C=M.filter(k=>k.output!==c&&(k.input!==w||w===void 0));C.length===0?t.delete(o):t.set(o,C)}}for(const[M,C]of t)C.forEach(k=>{Zn(M)?h.connect(M,k.output,k.input):h.connect(M,k.output)})})(h.disconnect)},Bi=(h,t,e,o,c)=>{const[w,M]=((C,k,P,I)=>{const{activeInputs:D,passiveInputs:R}=Ht(k),N=Hn(D[I],C,P);return N===null?[gt(R,C,P,I)[2],!1]:[N[2],!0]})(h,e,o,c);if(w!==null&&(Un(h,w),!M||t||Ys(h)||cn(Yt(h),Yt(e),o,c)),ce(e)){const{activeInputs:C}=Ht(e);Xt(e,C)}},qi=(h,t,e,o)=>{const[c,w]=((M,C,k)=>{const{activeInputs:P,passiveInputs:I}=we(C),D=Hn(P,M,k);return D===null?[Xn(I,M,k)[1],!1]:[D[2],!0]})(h,e,o);c!==null&&(Un(h,c),!w||t||Ys(h)||Yt(h).disconnect(Sn(e),o))};class Fo{constructor(t){this._map=new Map(t)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(t,e=null){return this._map.forEach((o,c)=>t.call(e,o,c,this))}get(t){return this._map.get(t)}has(t){return this._map.has(t)}keys(){return this._map.keys()}values(){return this._map.values()}}const Bo={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function Tn(h,t,e,o,c){if(typeof h.copyFromChannel=="function")t[e].byteLength===0&&(t[e]=new Float32Array(128)),h.copyFromChannel(t[e],o,c);else{const w=h.getChannelData(o);if(t[e].byteLength===0)t[e]=w.slice(c,c+128);else{const M=new Float32Array(w.buffer,c*Float32Array.BYTES_PER_ELEMENT,128);t[e].set(M)}}}const Qn=(h,t,e,o,c)=>{typeof h.copyToChannel=="function"?t[e].byteLength!==0&&h.copyToChannel(t[e],o,c):t[e].byteLength!==0&&h.getChannelData(o).set(t[e],c)},qo=(h,t)=>{const e=[];for(let o=0;o<h;o+=1){const c=[],w=typeof t=="number"?t:t[o];for(let M=0;M<w;M+=1)c.push(new Float32Array(128));e.push(c)}return e},Pd=async(h,t,e,o,c,w,M)=>{const C=t===null?128*Math.ceil(h.context.length/128):t.length,k=o.channelCount*o.numberOfInputs,P=c.reduce((q,j)=>q+j,0),I=P===0?null:e.createBuffer(P,C,e.sampleRate);if(w===void 0)throw new Error("Missing the processor constructor.");const D=Ht(h),R=await((q,j)=>{const $=Q(E,q),z=Yt(j);return Q($,z)})(e,h),N=qo(o.numberOfInputs,o.channelCount),V=qo(o.numberOfOutputs,c),W=Array.from(h.parameters.keys()).reduce((q,j)=>({...q,[j]:new Float32Array(128)}),{});for(let q=0;q<C;q+=128){if(o.numberOfInputs>0&&t!==null)for(let j=0;j<o.numberOfInputs;j+=1)for(let $=0;$<o.channelCount;$+=1)Tn(t,N[j],$,$,q);w.parameterDescriptors!==void 0&&t!==null&&w.parameterDescriptors.forEach(({name:j},$)=>{Tn(t,W,j,k+$,q)});for(let j=0;j<o.numberOfInputs;j+=1)for(let $=0;$<c[j];$+=1)V[j][$].byteLength===0&&(V[j][$]=new Float32Array(128));try{const j=N.map((z,J)=>D.activeInputs[J].size===0?[]:z),$=M(q/e.sampleRate,e.sampleRate,()=>R.process(j,V,W));if(I!==null)for(let z=0,J=0;z<o.numberOfOutputs;z+=1){for(let et=0;et<c[z];et+=1)Qn(I,V[z],et,J+et,q);J+=c[z]}if(!$)break}catch(j){h.dispatchEvent(new ErrorEvent("processorerror",{colno:j.colno,filename:j.filename,lineno:j.lineno,message:j.message}));break}}return I},Ed={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},Id={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Od={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Dd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Rd={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Ac=h=>{const{port1:t,port2:e}=new MessageChannel;return new Promise(o=>{const c=()=>{e.onmessage=null,t.close(),e.close(),o()};e.onmessage=()=>c();try{t.postMessage(h,[h])}catch{}finally{c()}})},Nd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},zo=(h,t,e)=>{const o=t[e];if(o===void 0)throw h();return o},Ld={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Fd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Se=()=>new DOMException("","InvalidStateError"),Wo=()=>new DOMException("","InvalidAccessError"),Bd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},kc=(h,t,e,o,c,w,M,C,k,P,I)=>{const D=P.length;let R=C;for(let N=0;N<D;N+=1){let V=e[0]*P[N];for(let W=1;W<c;W+=1){const q=R-W&k-1;V+=e[W]*w[q],V-=h[W]*M[q]}for(let W=c;W<o;W+=1)V+=e[W]*w[R-W&k-1];for(let W=c;W<t;W+=1)V-=h[W]*M[R-W&k-1];w[R]=P[N],M[R]=V,R=R+1&k-1,I[N]=V}return R},qd={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},zi=h=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const e=h.decodeAudioData(t.buffer,()=>{});return e!==void 0&&(e.catch(()=>{}),!0)}catch{}return!1},ie=(h,t,e)=>{const o=t[e];o!==void 0&&o!==h[e]&&(h[e]=o)},ye=(h,t)=>{ie(h,t,"channelCount"),ie(h,t,"channelCountMode"),ie(h,t,"channelInterpretation")},Pc=h=>typeof h.getFloatTimeDomainData=="function",he=(h,t,e)=>{const o=t[e];o!==void 0&&o!==h[e].value&&(h[e].value=o)},Hr=h=>{h.start=(t=>(e=0,o=0,c)=>{if(typeof c=="number"&&c<0||o<0||e<0)throw new RangeError("The parameters can't be negative.");t.call(h,e,o,c)})(h.start)},Ur=h=>{var t;h.stop=(t=h.stop,(e=0)=>{if(e<0)throw new RangeError("The parameter can't be negative.");t.call(h,e)})},Ec=(h,t)=>h===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(h*t))))),Ic=(h,t)=>{const e=h.createBiquadFilter();return ye(e,t),he(e,t,"Q"),he(e,t,"detune"),he(e,t,"frequency"),he(e,t,"gain"),ie(e,t,"type"),e},Wi=(h,t)=>{const e=h.createChannelSplitter(t.numberOfOutputs);return ye(e,t),(o=>{const c=o.numberOfOutputs;Object.defineProperty(o,"channelCount",{get:()=>c,set:w=>{if(w!==c)throw Se()}}),Object.defineProperty(o,"channelCountMode",{get:()=>"explicit",set:w=>{if(w!=="explicit")throw Se()}}),Object.defineProperty(o,"channelInterpretation",{get:()=>"discrete",set:w=>{if(w!=="discrete")throw Se()}})})(e),e},Jn=(h,t)=>(h.connect=t.connect.bind(t),h.disconnect=t.disconnect.bind(t),h),Oc=(h,t)=>{const e=h.createDelay(t.maxDelayTime);return ye(e,t),he(e,t,"delayTime"),e},Xe=(h,t)=>{const e=h.createGain();return ye(e,t),he(e,t,"gain"),e};function zd(h,t){const e=t[0]*t[0]+t[1]*t[1];return[(h[0]*t[0]+h[1]*t[1])/e,(h[1]*t[0]-h[0]*t[1])/e]}function Dc(h,t){let e=[0,0];for(let w=h.length-1;w>=0;w-=1)c=t,e=[(o=e)[0]*c[0]-o[1]*c[1],o[0]*c[1]+o[1]*c[0]],e[0]+=h[w];var o,c;return e}const Vi=(h,t,e,o)=>h.createScriptProcessor(t,e,o),We=()=>new DOMException("","NotSupportedError"),Wd={numberOfChannels:1},Vd={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},$d={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},jd={disableNormalization:!1},Gd={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Hd=()=>new DOMException("","UnknownError"),Ud={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Rc=(h,t,e)=>h.copyFromChannel===void 0?h.getChannelData(e)[0]:(h.copyFromChannel(t,e),t[0]),Nc=h=>{if(h===null)return!1;const t=h.length;return t%2!=0?h[Math.floor(t/2)]!==0:h[t/2-1]+h[t/2]!==0},$i=(h,t,e,o)=>{let c=h;for(;!c.hasOwnProperty(t);)c=Object.getPrototypeOf(c);const{get:w,set:M}=Object.getOwnPropertyDescriptor(c,t);Object.defineProperty(h,t,{get:e(w),set:o(M)})},Lc=(h,t,e)=>{try{h.setValueAtTime(t,e)}catch(o){if(o.code!==9)throw o;Lc(h,t,e+1e-7)}},Xr=h=>{const t=h.createOscillator();try{t.start(-1)}catch(e){return e instanceof RangeError}return!1},Fc=h=>{const t=h.createBuffer(1,1,44100),e=h.createBufferSource();e.buffer=t,e.start(),e.stop();try{return e.stop(),!0}catch{return!1}},Yr=h=>{const t=h.createOscillator();try{t.stop(-1)}catch(e){return e instanceof RangeError}return!1},Xd=()=>{try{new DOMException}catch{return!1}return!0},Yd=()=>new Promise(h=>{const t=new ArrayBuffer(0),{port1:e,port2:o}=new MessageChannel;e.onmessage=({data:c})=>h(c!==null),o.postMessage(t,[t])}),Bc=(h,t)=>{const e=t.createGain();h.connect(e);const o=(c=>()=>{c.call(h,e),h.removeEventListener("ended",o)})(h.disconnect);h.addEventListener("ended",o),Jn(h,e),h.stop=(c=>{let w=!1;return(M=0)=>{if(w)try{c.call(h,M)}catch{e.gain.setValueAtTime(0,M)}else c.call(h,M),w=!0}})(h.stop)},Kn=(h,t)=>e=>{const o={value:h};return Object.defineProperties(e,{currentTarget:o,target:o}),typeof t=="function"?t.call(h,e):t.handleEvent.call(h,e)},Zd=(h=>(t,e,[o,c,w],M)=>{h(t[c],[e,o,w],C=>C[0]===e&&C[1]===o,M)})(ve),Qd=(h=>(t,e,[o,c,w],M)=>{const C=t.get(o);C===void 0?t.set(o,new Set([[c,e,w]])):h(C,[c,e,w],k=>k[0]===c&&k[1]===e,M)})(ve),Jd=(h=>(t,e,o,c)=>h(t[c],w=>w[0]===e&&w[1]===o))(ct),qc=new WeakMap,Kd=(h=>t=>{var e;return(e=h.get(t))!==null&&e!==void 0?e:0})(qc),us=(Vo=new Map,ji=new WeakMap,(h,t)=>{const e=ji.get(h);if(e!==void 0)return e;const o=Vo.get(h);if(o!==void 0)return o;try{const c=t();return c instanceof Promise?(Vo.set(h,c),c.catch(()=>!1).then(w=>(Vo.delete(h),ji.set(h,w),w))):(ji.set(h,c),c)}catch{return ji.set(h,!1),!1}});var Vo,ji;const ws=typeof window>"u"?null:window,zc=((h,t)=>(e,o)=>{const c=e.createAnalyser();if(ye(c,o),!(o.maxDecibels>o.minDecibels))throw t();return ie(c,o,"fftSize"),ie(c,o,"maxDecibels"),ie(c,o,"minDecibels"),ie(c,o,"smoothingTimeConstant"),h(Pc,()=>Pc(c))||(w=>{w.getFloatTimeDomainData=M=>{const C=new Uint8Array(M.length);w.getByteTimeDomainData(C);const k=Math.max(C.length,w.fftSize);for(let P=0;P<k;P+=1)M[P]=.0078125*(C[P]-128);return M}})(c),c})(us,kt),Zr=(h=>t=>{const e=h(t);if(e.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return e.renderer})(Ht),ke=((h,t,e)=>async(o,c,w)=>{const M=h(o);await Promise.all(M.activeInputs.map((C,k)=>Array.from(C).map(async([P,I])=>{const D=t(P),R=await D.render(P,c),N=o.context.destination;e(P)||o===N&&e(o)||R.connect(w,I,k)})).reduce((C,k)=>[...C,...k],[]))})(Ht,Zr,Ys),tf=((h,t,e)=>()=>{const o=new WeakMap;return{render(c,w){const M=o.get(w);return M!==void 0?Promise.resolve(M):(async(C,k)=>{let P=t(C);if(!ht(P,k)){const I={channelCount:P.channelCount,channelCountMode:P.channelCountMode,channelInterpretation:P.channelInterpretation,fftSize:P.fftSize,maxDecibels:P.maxDecibels,minDecibels:P.minDecibels,smoothingTimeConstant:P.smoothingTimeConstant};P=h(k,I)}return o.set(k,P),await e(C,k,P),P})(c,w)}}})(zc,Yt,ke),Kt=(Wc=b,h=>{const t=Wc.get(h);if(t===void 0)throw Se();return t});var Wc;const Te=(h=>h===null?null:h.hasOwnProperty("OfflineAudioContext")?h.OfflineAudioContext:h.hasOwnProperty("webkitOfflineAudioContext")?h.webkitOfflineAudioContext:null)(ws),Ut=(h=>t=>h!==null&&t instanceof h)(Te),Vc=new WeakMap,$c=(h=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,e,o){if(e!==null){let c=this._listeners.get(e);c===void 0&&(c=h(this,e),typeof e=="function"&&this._listeners.set(e,c)),this._nativeEventTarget.addEventListener(t,c,o)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,e,o){const c=e===null?void 0:this._listeners.get(e);this._nativeEventTarget.removeEventListener(t,c===void 0?null:c,o)}})(Kn),hn=(h=>h===null?null:h.hasOwnProperty("AudioContext")?h.AudioContext:h.hasOwnProperty("webkitAudioContext")?h.webkitAudioContext:null)(ws),Qr=(h=>t=>h!==null&&t instanceof h)(hn),Jr=(h=>t=>h!==null&&typeof h.AudioNode=="function"&&t instanceof h.AudioNode)(ws),jc=(h=>t=>h!==null&&typeof h.AudioParam=="function"&&t instanceof h.AudioParam)(ws),ti=(h=>h===null?null:h.hasOwnProperty("AudioWorkletNode")?h.AudioWorkletNode:null)(ws),fe=((h,t,e,o,c,w,M,C,k,P,I,D,R,N,V,W)=>class extends P{constructor(q,j,$,z){super($),this._context=q,this._nativeAudioNode=$;const J=I(q);D(J)&&e(Lo,()=>Lo(J,W))!==!0&&Gr($),_.set(this,$),g.set(this,new Set),q.state!=="closed"&&j&&wt(this),h(this,z,$)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(q){this._nativeAudioNode.channelCount=q}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(q){this._nativeAudioNode.channelCountMode=q}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(q){this._nativeAudioNode.channelInterpretation=q}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(q,j=0,$=0){if(j<0||j>=this._nativeAudioNode.numberOfOutputs)throw c();const z=I(this._context),J=V(z);if(R(q)||N(q))throw w();if(xe(q)){const H=Yt(q);try{const Z=ln(this._nativeAudioNode,H,j,$),G=Yn(this);(J||G)&&this._nativeAudioNode.disconnect(...Z),this.context.state!=="closed"&&!G&&Yn(q)&&wt(q)}catch(Z){throw Z.code===12?w():Z}if(t(this,q,j,$,J)){const Z=k([this],q);Fi(Z,o(J))}return q}const et=Sn(q);if(et.name==="playbackRate"&&et.maxValue===1024)throw M();try{this._nativeAudioNode.connect(et,j),(J||Yn(this))&&this._nativeAudioNode.disconnect(et,j)}catch(H){throw H.code===12?w():H}if(((H,Z,G,st)=>{const{activeInputs:Y,passiveInputs:tt}=we(Z),{outputs:at}=Ht(H),lt=_t(H),Tt=vt=>{const mt=Yt(H),At=Sn(Z);if(vt){const pt=Xn(tt,H,G);hs(Y,H,pt,!1),st||Ys(H)||mt.connect(At,G)}else{const pt=((Pt,Nt,qt)=>ct(Pt,se=>se[0]===Nt&&se[1]===qt))(Y,H,G);Xs(tt,pt,!1),st||Ys(H)||mt.disconnect(At,G)}};return!!ve(at,[Z,G],vt=>vt[0]===Z&&vt[1]===G,!0)&&(lt.add(Tt),ce(H)?hs(Y,H,[G,Tt],!0):Xs(tt,[H,G,Tt],!0),!0)})(this,q,j,J)){const H=k([this],q);Fi(H,o(J))}}disconnect(q,j,$){let z;const J=I(this._context),et=V(J);if(q===void 0)z=((H,Z)=>{const G=Ht(H),st=[];for(const Y of G.outputs)ze(Y)?Bi(H,Z,...Y):qi(H,Z,...Y),st.push(Y[0]);return G.outputs.clear(),st})(this,et);else if(typeof q=="number"){if(q<0||q>=this.numberOfOutputs)throw c();z=((H,Z,G)=>{const st=Ht(H),Y=[];for(const tt of st.outputs)tt[1]===G&&(ze(tt)?Bi(H,Z,...tt):qi(H,Z,...tt),Y.push(tt[0]),st.outputs.delete(tt));return Y})(this,et,q)}else{if(j!==void 0&&(j<0||j>=this.numberOfOutputs)||xe(q)&&$!==void 0&&($<0||$>=q.numberOfInputs))throw c();if(z=((H,Z,G,st,Y)=>{const tt=Ht(H);return Array.from(tt.outputs).filter(at=>!(at[0]!==G||st!==void 0&&at[1]!==st||Y!==void 0&&at[2]!==Y)).map(at=>(ze(at)?Bi(H,Z,...at):qi(H,Z,...at),tt.outputs.delete(at),at[0]))})(this,et,q,j,$),z.length===0)throw w()}for(const H of z){const Z=k([this],H);Fi(Z,C)}}})((Gc=x,(h,t,e)=>{const o=[];for(let c=0;c<e.numberOfInputs;c+=1)o.push(new Set);Gc.set(h,{activeInputs:o,outputs:new Set,passiveInputs:new WeakMap,renderer:t})}),((h,t,e,o,c,w,M,C,k,P,I,D,R)=>{const N=new WeakMap;return(V,W,q,j,$)=>{const{activeInputs:z,passiveInputs:J}=w(W),{outputs:et}=w(V),H=C(V),Z=G=>{const st=k(W),Y=k(V);if(G){const tt=gt(J,V,q,j);h(z,V,tt,!1),$||D(V)||e(Y,st,q,j),R(W)&&wt(W)}else{const tt=o(z,V,q,j);t(J,j,tt,!1),$||D(V)||c(Y,st,q,j);const at=M(W);if(at===0)I(W)&&Xt(W,z);else{const lt=N.get(W);lt!==void 0&&clearTimeout(lt),N.set(W,setTimeout(()=>{I(W)&&Xt(W,z)},1e3*at))}}};return!!P(et,[W,q,j],G=>G[0]===W&&G[1]===q&&G[2]===j,!0)&&(H.add(Z),I(V)?h(z,V,[q,j,Z],!0):t(J,j,[V,q,Z],!0),!0)}})(Zd,Qd,ln,Jd,cn,Ht,Kd,_t,Yt,ve,ce,Ys,Yn),us,((h,t,e,o,c,w)=>M=>(C,k)=>{const P=h.get(C);if(P===void 0){if(!M&&w(C)){const I=o(C),{outputs:D}=e(C);for(const R of D)if(ze(R)){const N=o(R[0]);t(I,N,R[1],R[2])}else{const N=c(R[0]);I.disconnect(N,R[1])}}h.set(C,k)}else h.set(C,P+k)})(S,cn,Ht,Yt,Sn,ce),kt,Wo,We,((h,t,e,o,c,w,M,C)=>(k,P)=>{const I=t.get(k);if(I===void 0)throw new Error("Missing the expected cycle count.");const D=w(k.context),R=C(D);if(I===P){if(t.delete(k),!R&&M(k)){const N=o(k),{outputs:V}=e(k);for(const W of V)if(ze(W)){const q=o(W[0]);h(N,q,W[1],W[2])}else{const q=c(W[0]);N.connect(q,W[1])}}}else t.set(k,I-P)})(ln,S,Ht,Yt,Sn,Kt,ce,Ut),((h,t,e)=>function o(c,w){const M=xe(w)?w:e(h,w);if((k=>"delayTime"in k)(M))return[];if(c[0]===M)return[c];if(c.includes(M))return[];const{outputs:C}=t(M);return Array.from(C).map(k=>o([...c,M],k[0])).reduce((k,P)=>k.concat(P),[])})(Vc,Ht,Q),$c,Kt,Qr,Jr,jc,Ut,ti);var Gc;const ef=((h,t,e,o,c,w)=>class extends h{constructor(M,C){const k=c(M),P={...nt,...C},I=o(k,P);super(M,!1,I,w(k)?t():null),this._nativeAnalyserNode=I}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(M){this._nativeAnalyserNode.fftSize=M}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(M){const C=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=M,!(M>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=C,e()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(M){const C=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=M,!(this._nativeAnalyserNode.maxDecibels>M))throw this._nativeAnalyserNode.minDecibels=C,e()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(M){this._nativeAnalyserNode.smoothingTimeConstant=M}getByteFrequencyData(M){this._nativeAnalyserNode.getByteFrequencyData(M)}getByteTimeDomainData(M){this._nativeAnalyserNode.getByteTimeDomainData(M)}getFloatFrequencyData(M){this._nativeAnalyserNode.getFloatFrequencyData(M)}getFloatTimeDomainData(M){this._nativeAnalyserNode.getFloatTimeDomainData(M)}})(fe,tf,kt,zc,Kt,Ut),Kr=new WeakSet,Hc=(h=>h===null?null:h.hasOwnProperty("AudioBuffer")?h.AudioBuffer:null)(ws),Uc=(ta=new Uint32Array(1),h=>(ta[0]=h,ta[0]));var ta;const ea=((h,t)=>e=>{e.copyFromChannel=(o,c,w=0)=>{const M=h(w),C=h(c);if(C>=e.numberOfChannels)throw t();const k=e.length,P=e.getChannelData(C),I=o.length;for(let D=M<0?-M:0;D+M<k&&D<I;D+=1)o[D]=P[D+M]},e.copyToChannel=(o,c,w=0)=>{const M=h(w),C=h(c);if(C>=e.numberOfChannels)throw t();const k=e.length,P=e.getChannelData(C),I=o.length;for(let D=M<0?-M:0;D+M<k&&D<I;D+=1)P[D+M]=o[D]}})(Uc,kt),sa=(h=>t=>{t.copyFromChannel=(e=>(o,c,w=0)=>{const M=h(w),C=h(c);if(M<t.length)return e.call(t,o,C,M)})(t.copyFromChannel),t.copyToChannel=(e=>(o,c,w=0)=>{const M=h(w),C=h(c);if(M<t.length)return e.call(t,o,C,M)})(t.copyToChannel)})(Uc),Xc=((h,t,e,o,c,w,M,C)=>{let k=null;return class Cu{constructor(I){if(c===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:D,numberOfChannels:R,sampleRate:N}={...Lt,...I};k===null&&(k=new c(1,1,44100));const V=o!==null&&t(w,w)?new o({length:D,numberOfChannels:R,sampleRate:N}):k.createBuffer(R,D,N);if(V.numberOfChannels===0)throw e();return typeof V.copyFromChannel!="function"?(M(V),dt(V)):t(ut,()=>ut(V))||C(V),h.add(V),V}static[Symbol.hasInstance](I){return I!==null&&typeof I=="object"&&Object.getPrototypeOf(I)===Cu.prototype||h.has(I)}}})(Kr,us,We,Hc,Te,(h=>()=>{if(h===null)return!1;try{new h({length:1,sampleRate:44100})}catch{return!1}return!0})(Hc),ea,sa),$o=(h=>(t,e)=>{const o=h(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});e.connect(o).connect(t.destination);const c=()=>{e.removeEventListener("ended",c),e.disconnect(o),o.disconnect()};e.addEventListener("ended",c)})(Xe),Yc=((h,t,e)=>async(o,c,w)=>{const M=t(o);await Promise.all(Array.from(M.activeInputs).map(async([C,k])=>{const P=h(C),I=await P.render(C,c);e(C)||I.connect(w,k)}))})(Zr,we,Ys),Rs=(h=>(t,e,o)=>h(e,t,o))(Yc),ei=((h,t,e,o,c,w,M,C,k,P,I)=>(D,R)=>{const N=D.createBufferSource();return ye(N,R),he(N,R,"playbackRate"),ie(N,R,"buffer"),ie(N,R,"loop"),ie(N,R,"loopEnd"),ie(N,R,"loopStart"),t(e,()=>e(D))||(V=>{V.start=(W=>{let q=!1;return(j=0,$=0,z)=>{if(q)throw Se();W.call(V,j,$,z),q=!0}})(V.start)})(N),t(o,()=>o(D))||(V=>{V.start=(W=>(q=0,j=0,$)=>{const z=V.buffer,J=z===null?j:Math.min(z.duration,j);z!==null&&J>z.duration-.5/V.context.sampleRate?W.call(V,q,0,0):W.call(V,q,J,$)})(V.start)})(N),t(c,()=>c(D))||P(N,D),t(w,()=>w(D))||Hr(N),t(M,()=>M(D))||I(N,D),t(C,()=>C(D))||Ur(N),h(D,N),N})($o,us,h=>{const t=h.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},h=>{const t=h.createBufferSource(),e=h.createBuffer(1,1,44100);t.buffer=e;try{t.start(0,1)}catch{return!1}return!0},h=>{const t=h.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},Xr,Fc,Yr,0,(h=>(t,e)=>{const o=e.createBuffer(1,1,44100);t.buffer===null&&(t.buffer=o),h(t,"buffer",c=>()=>{const w=c.call(t);return w===o?null:w},c=>w=>c.call(t,w===null?o:w))})($i),Bc),Ns=((h,t)=>(e,o,c)=>(h(o).replay(c),t(o,e,c)))((h=>t=>{const e=h(t);if(e.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return e.renderer})(we),Yc),sf=((h,t,e,o,c)=>()=>{const w=new WeakMap;let M=null,C=null;return{set start(k){M=k},set stop(k){C=k},render(k,P){const I=w.get(P);return I!==void 0?Promise.resolve(I):(async(D,R)=>{let N=e(D);const V=ht(N,R);if(!V){const W={buffer:N.buffer,channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,loop:N.loop,loopEnd:N.loopEnd,loopStart:N.loopStart,playbackRate:N.playbackRate.value};N=t(R,W),M!==null&&N.start(...M),C!==null&&N.stop(C)}return w.set(R,N),V?await h(R,D.playbackRate,N.playbackRate):await o(R,D.playbackRate,N.playbackRate),await c(D,R,N),N})(k,P)}}})(Rs,ei,Yt,Ns,ke),xs=((h,t,e,o,c,w,M,C,k,P,I,D,R)=>(N,V,W,q=null,j=null)=>{const $=W.value,z=new p.AutomationEventList($),J=V?(H=>({replay(Z){for(const G of H)if(G.type==="exponentialRampToValue"){const{endTime:st,value:Y}=G;Z.exponentialRampToValueAtTime(Y,st)}else if(G.type==="linearRampToValue"){const{endTime:st,value:Y}=G;Z.linearRampToValueAtTime(Y,st)}else if(G.type==="setTarget"){const{startTime:st,target:Y,timeConstant:tt}=G;Z.setTargetAtTime(Y,st,tt)}else if(G.type==="setValue"){const{startTime:st,value:Y}=G;Z.setValueAtTime(Y,st)}else{if(G.type!=="setValueCurve")throw new Error("Can't apply an unknown automation.");{const{duration:st,startTime:Y,values:tt}=G;Z.setValueCurveAtTime(tt,Y,st)}}}}))(z):null,et={get defaultValue(){return $},get maxValue(){return q===null?W.maxValue:q},get minValue(){return j===null?W.minValue:j},get value(){return W.value},set value(H){W.value=H,et.setValueAtTime(H,N.context.currentTime)},cancelAndHoldAtTime(H){if(typeof W.cancelAndHoldAtTime=="function")J===null&&z.flush(N.context.currentTime),z.add(c(H)),W.cancelAndHoldAtTime(H);else{const Z=Array.from(z).pop();J===null&&z.flush(N.context.currentTime),z.add(c(H));const G=Array.from(z).pop();W.cancelScheduledValues(H),Z!==G&&G!==void 0&&(G.type==="exponentialRampToValue"?W.exponentialRampToValueAtTime(G.value,G.endTime):G.type==="linearRampToValue"?W.linearRampToValueAtTime(G.value,G.endTime):G.type==="setValue"?W.setValueAtTime(G.value,G.startTime):G.type==="setValueCurve"&&W.setValueCurveAtTime(G.values,G.startTime,G.duration))}return et},cancelScheduledValues:H=>(J===null&&z.flush(N.context.currentTime),z.add(w(H)),W.cancelScheduledValues(H),et),exponentialRampToValueAtTime(H,Z){if(H===0)throw new RangeError;if(!Number.isFinite(Z)||Z<0)throw new RangeError;const G=N.context.currentTime;return J===null&&z.flush(G),Array.from(z).length===0&&(z.add(P($,G)),W.setValueAtTime($,G)),z.add(M(H,Z)),W.exponentialRampToValueAtTime(H,Z),et},linearRampToValueAtTime(H,Z){const G=N.context.currentTime;return J===null&&z.flush(G),Array.from(z).length===0&&(z.add(P($,G)),W.setValueAtTime($,G)),z.add(C(H,Z)),W.linearRampToValueAtTime(H,Z),et},setTargetAtTime:(H,Z,G)=>(J===null&&z.flush(N.context.currentTime),z.add(k(H,Z,G)),W.setTargetAtTime(H,Z,G),et),setValueAtTime:(H,Z)=>(J===null&&z.flush(N.context.currentTime),z.add(P(H,Z)),W.setValueAtTime(H,Z),et),setValueCurveAtTime(H,Z,G){const st=H instanceof Float32Array?H:new Float32Array(H);if(D!==null&&D.name==="webkitAudioContext"){const Y=Z+G,tt=N.context.sampleRate,at=Math.ceil(Z*tt),lt=Math.floor(Y*tt),Tt=lt-at,vt=new Float32Array(Tt);for(let At=0;At<Tt;At+=1){const pt=(st.length-1)/G*((at+At)/tt-Z),Pt=Math.floor(pt),Nt=Math.ceil(pt);vt[At]=Pt===Nt?st[Pt]:(1-(pt-Pt))*st[Pt]+(1-(Nt-pt))*st[Nt]}J===null&&z.flush(N.context.currentTime),z.add(I(vt,Z,G)),W.setValueCurveAtTime(vt,Z,G);const mt=lt/tt;mt<Y&&R(et,vt[vt.length-1],mt),R(et,st[st.length-1],Y)}else J===null&&z.flush(N.context.currentTime),z.add(I(st,Z,G)),W.setValueCurveAtTime(st,Z,G);return et}};return e.set(et,W),t.set(et,N),h(et,J),et})((Zc=m,(h,t)=>{Zc.set(h,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})}),Vc,f,0,p.createCancelAndHoldAutomationEvent,p.createCancelScheduledValuesAutomationEvent,p.createExponentialRampToValueAutomationEvent,p.createLinearRampToValueAutomationEvent,p.createSetTargetAutomationEvent,p.createSetValueAutomationEvent,p.createSetValueCurveAutomationEvent,hn,Lc);var Zc;const nf=((h,t,e,o,c,w,M,C)=>class extends h{constructor(k,P){const I=w(k),D={...Ke,...P},R=c(I,D),N=M(I),V=N?t():null;super(k,!1,R,V),this._audioBufferSourceNodeRenderer=V,this._isBufferNullified=!1,this._isBufferSet=D.buffer!==null,this._nativeAudioBufferSourceNode=R,this._onended=null,this._playbackRate=e(this,N,R.playbackRate,Vt,jt)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(k){if(this._nativeAudioBufferSourceNode.buffer=k,k!==null){if(this._isBufferSet)throw o();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(k){this._nativeAudioBufferSourceNode.loop=k}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(k){this._nativeAudioBufferSourceNode.loopEnd=k}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(k){this._nativeAudioBufferSourceNode.loopStart=k}get onended(){return this._onended}set onended(k){const P=typeof k=="function"?C(this,k):null;this._nativeAudioBufferSourceNode.onended=P;const I=this._nativeAudioBufferSourceNode.onended;this._onended=I!==null&&I===P?k:I}get playbackRate(){return this._playbackRate}start(k=0,P=0,I){if(this._nativeAudioBufferSourceNode.start(k,P,I),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=I===void 0?[k,P]:[k,P,I]),this.context.state!=="closed"){wt(this);const D=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",D),ce(this)&&Rt(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",D)}}stop(k=0){this._nativeAudioBufferSourceNode.stop(k),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=k)}})(fe,sf,xs,Se,ei,Kt,Ut,Kn),of=((h,t,e,o,c,w,M,C)=>class extends h{constructor(k,P){const I=w(k),D=M(I),R=c(I,P,D);super(k,!1,R,D?(N=>{const V=new WeakMap;return{render(W,q){const j=V.get(q);return j!==void 0?Promise.resolve(j):(async($,z)=>{const J=z.destination;return V.set(z,J),await N($,z,J),J})(W,q)}}})(C):null),this._isNodeOfNativeOfflineAudioContext=D,this._nativeAudioDestinationNode=R}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(k){if(this._isNodeOfNativeOfflineAudioContext)throw o();if(k>this._nativeAudioDestinationNode.maxChannelCount)throw e();this._nativeAudioDestinationNode.channelCount=k}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(k){if(this._isNodeOfNativeOfflineAudioContext)throw o();this._nativeAudioDestinationNode.channelCountMode=k}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(fe,0,kt,Se,((h,t)=>(e,o,c)=>{const w=e.destination;if(w.channelCount!==o)try{w.channelCount=o}catch{}c&&w.channelCountMode!=="explicit"&&(w.channelCountMode="explicit"),w.maxChannelCount===0&&Object.defineProperty(w,"maxChannelCount",{value:o});const M=h(e,{channelCount:o,channelCountMode:w.channelCountMode,channelInterpretation:w.channelInterpretation,gain:1});return t(M,"channelCount",C=>()=>C.call(M),C=>k=>{C.call(M,k);try{w.channelCount=k}catch(P){if(k>w.maxChannelCount)throw P}}),t(M,"channelCountMode",C=>()=>C.call(M),C=>k=>{C.call(M,k),w.channelCountMode=k}),t(M,"channelInterpretation",C=>()=>C.call(M),C=>k=>{C.call(M,k),w.channelInterpretation=k}),Object.defineProperty(M,"maxChannelCount",{get:()=>w.maxChannelCount}),M.connect(w),M})(Xe,$i),Kt,Ut,ke),rf=((h,t,e,o,c)=>()=>{const w=new WeakMap;return{render(M,C){const k=w.get(C);return k!==void 0?Promise.resolve(k):(async(P,I)=>{let D=e(P);const R=ht(D,I);if(!R){const N={Q:D.Q.value,channelCount:D.channelCount,channelCountMode:D.channelCountMode,channelInterpretation:D.channelInterpretation,detune:D.detune.value,frequency:D.frequency.value,gain:D.gain.value,type:D.type};D=t(I,N)}return w.set(I,D),R?(await h(I,P.Q,D.Q),await h(I,P.detune,D.detune),await h(I,P.frequency,D.frequency),await h(I,P.gain,D.gain)):(await o(I,P.Q,D.Q),await o(I,P.detune,D.detune),await o(I,P.frequency,D.frequency),await o(I,P.gain,D.gain)),await c(P,I,D),D})(M,C)}}})(Rs,Ic,Yt,Ns,ke),Mn=(h=>(t,e)=>h.set(t,e))(qc),af=((h,t,e,o,c,w,M,C)=>class extends h{constructor(k,P){const I=w(k),D={...Ed,...P},R=c(I,D),N=M(I);super(k,!1,R,N?e():null),this._Q=t(this,N,R.Q,Vt,jt),this._detune=t(this,N,R.detune,1200*Math.log2(Vt),-1200*Math.log2(Vt)),this._frequency=t(this,N,R.frequency,k.sampleRate/2,0),this._gain=t(this,N,R.gain,40*Math.log10(Vt),jt),this._nativeBiquadFilterNode=R,C(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(k){this._nativeBiquadFilterNode.type=k}getFrequencyResponse(k,P,I){try{this._nativeBiquadFilterNode.getFrequencyResponse(k,P,I)}catch(D){throw D.code===11?o():D}if(k.length!==P.length||P.length!==I.length)throw o()}})(fe,xs,rf,Wo,Ic,Kt,Ut,Mn),un=((h,t)=>(e,o,c)=>{const w=new Set;return e.connect=(M=>(C,k=0,P=0)=>{const I=w.size===0;if(t(C))return M.call(e,C,k,P),h(w,[C,k,P],D=>D[0]===C&&D[1]===k&&D[2]===P,!0),I&&o(),C;M.call(e,C,k),h(w,[C,k],D=>D[0]===C&&D[1]===k,!0),I&&o()})(e.connect),e.disconnect=(M=>(C,k,P)=>{const I=w.size>0;if(C===void 0)M.apply(e),w.clear();else if(typeof C=="number"){M.call(e,C);for(const R of w)R[1]===C&&w.delete(R)}else{t(C)?M.call(e,C,k,P):M.call(e,C,k);for(const R of w)R[0]!==C||k!==void 0&&R[1]!==k||P!==void 0&&R[2]!==P||w.delete(R)}const D=w.size===0;I&&D&&c()})(e.disconnect),e})(ve,Jr),lf=((h,t)=>(e,o)=>{o.channelCount=1,o.channelCountMode="explicit",Object.defineProperty(o,"channelCount",{get:()=>1,set:()=>{throw h()}}),Object.defineProperty(o,"channelCountMode",{get:()=>"explicit",set:()=>{throw h()}});const c=e.createBufferSource();t(o,()=>{const w=o.numberOfInputs;for(let M=0;M<w;M+=1)c.connect(o,0,M)},()=>c.disconnect(o))})(Se,un),dn=((h,t)=>(e,o)=>{const c=e.createChannelMerger(o.numberOfInputs);return h!==null&&h.name==="webkitAudioContext"&&t(e,c),ye(c,o),c})(hn,lf),cf=((h,t,e)=>()=>{const o=new WeakMap;return{render(c,w){const M=o.get(w);return M!==void 0?Promise.resolve(M):(async(C,k)=>{let P=t(C);if(!ht(P,k)){const I={channelCount:P.channelCount,channelCountMode:P.channelCountMode,channelInterpretation:P.channelInterpretation,numberOfInputs:P.numberOfInputs};P=h(k,I)}return o.set(k,P),await e(C,k,P),P})(c,w)}}})(dn,Yt,ke),hf=((h,t,e,o,c)=>class extends h{constructor(w,M){const C=o(w),k={...Id,...M};super(w,!1,e(C,k),c(C)?t():null)}})(fe,cf,dn,Kt,Ut),uf=((h,t,e)=>()=>{const o=new WeakMap;return{render(c,w){const M=o.get(w);return M!==void 0?Promise.resolve(M):(async(C,k)=>{let P=t(C);if(!ht(P,k)){const I={channelCount:P.channelCount,channelCountMode:P.channelCountMode,channelInterpretation:P.channelInterpretation,numberOfOutputs:P.numberOfOutputs};P=h(k,I)}return o.set(k,P),await e(C,k,P),P})(c,w)}}})(Wi,Yt,ke),df=((h,t,e,o,c,w)=>class extends h{constructor(M,C){const k=o(M),P=(I=>({...I,channelCount:I.numberOfOutputs}))({...Od,...C});super(M,!1,e(k,P),c(k)?t():null)}})(fe,uf,Wi,Kt,Ut),ff=((h,t,e,o)=>(c,{offset:w,...M})=>{const C=c.createBuffer(1,2,44100),k=t(c,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),P=e(c,{...M,gain:w}),I=C.getChannelData(0);I[0]=1,I[1]=1,k.buffer=C,k.loop=!0;const D={get bufferSize(){},get channelCount(){return P.channelCount},set channelCount(R){P.channelCount=R},get channelCountMode(){return P.channelCountMode},set channelCountMode(R){P.channelCountMode=R},get channelInterpretation(){return P.channelInterpretation},set channelInterpretation(R){P.channelInterpretation=R},get context(){return P.context},get inputs(){return[]},get numberOfInputs(){return k.numberOfInputs},get numberOfOutputs(){return P.numberOfOutputs},get offset(){return P.gain},get onended(){return k.onended},set onended(R){k.onended=R},addEventListener:(...R)=>k.addEventListener(R[0],R[1],R[2]),dispatchEvent:(...R)=>k.dispatchEvent(R[0]),removeEventListener:(...R)=>k.removeEventListener(R[0],R[1],R[2]),start(R=0){k.start.call(k,R)},stop(R=0){k.stop.call(k,R)}};return h(c,k),o(Jn(D,P),()=>k.connect(P),()=>k.disconnect(P))})($o,ei,Xe,un),si=((h,t,e,o,c)=>(w,M)=>{if(w.createConstantSource===void 0)return e(w,M);const C=w.createConstantSource();return ye(C,M),he(C,M,"offset"),t(o,()=>o(w))||Hr(C),t(c,()=>c(w))||Ur(C),h(w,C),C})($o,us,ff,Xr,Yr),pf=((h,t,e,o,c)=>()=>{const w=new WeakMap;let M=null,C=null;return{set start(k){M=k},set stop(k){C=k},render(k,P){const I=w.get(P);return I!==void 0?Promise.resolve(I):(async(D,R)=>{let N=e(D);const V=ht(N,R);if(!V){const W={channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,offset:N.offset.value};N=t(R,W),M!==null&&N.start(M),C!==null&&N.stop(C)}return w.set(R,N),V?await h(R,D.offset,N.offset):await o(R,D.offset,N.offset),await c(D,R,N),N})(k,P)}}})(Rs,si,Yt,Ns,ke),mf=((h,t,e,o,c,w,M)=>class extends h{constructor(C,k){const P=c(C),I={...Dd,...k},D=o(P,I),R=w(P),N=R?e():null;super(C,!1,D,N),this._constantSourceNodeRenderer=N,this._nativeConstantSourceNode=D,this._offset=t(this,R,D.offset,Vt,jt),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(C){const k=typeof C=="function"?M(this,C):null;this._nativeConstantSourceNode.onended=k;const P=this._nativeConstantSourceNode.onended;this._onended=P!==null&&P===k?C:P}start(C=0){if(this._nativeConstantSourceNode.start(C),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=C),this.context.state!=="closed"){wt(this);const k=()=>{this._nativeConstantSourceNode.removeEventListener("ended",k),ce(this)&&Rt(this)};this._nativeConstantSourceNode.addEventListener("ended",k)}}stop(C=0){this._nativeConstantSourceNode.stop(C),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=C)}})(fe,xs,pf,si,Kt,Ut,Kn),Qc=((h,t)=>(e,o)=>{const c=e.createConvolver();if(ye(c,o),o.disableNormalization===c.normalize&&(c.normalize=!o.disableNormalization),ie(c,o,"buffer"),o.channelCount>2||(t(c,"channelCount",w=>()=>w.call(c),w=>M=>{if(M>2)throw h();return w.call(c,M)}),o.channelCountMode==="max"))throw h();return t(c,"channelCountMode",w=>()=>w.call(c),w=>M=>{if(M==="max")throw h();return w.call(c,M)}),c})(We,$i),gf=((h,t,e)=>()=>{const o=new WeakMap;return{render(c,w){const M=o.get(w);return M!==void 0?Promise.resolve(M):(async(C,k)=>{let P=t(C);if(!ht(P,k)){const I={buffer:P.buffer,channelCount:P.channelCount,channelCountMode:P.channelCountMode,channelInterpretation:P.channelInterpretation,disableNormalization:!P.normalize};P=h(k,I)}return o.set(k,P),Ae(P)?await e(C,k,P.inputs[0]):await e(C,k,P),P})(c,w)}}})(Qc,Yt,ke),vf=((h,t,e,o,c,w)=>class extends h{constructor(M,C){const k=o(M),P={...Rd,...C},I=e(k,P);super(M,!1,I,c(k)?t():null),this._isBufferNullified=!1,this._nativeConvolverNode=I,P.buffer!==null&&w(this,P.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(M){if(this._nativeConvolverNode.buffer=M,M===null&&this._nativeConvolverNode.buffer!==null){const C=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=C.createBuffer(1,1,C.sampleRate),this._isBufferNullified=!0,w(this,0)}else this._isBufferNullified=!1,w(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(M){this._nativeConvolverNode.normalize=M}})(fe,gf,Qc,Kt,Ut,Mn),yf=((h,t,e,o,c)=>w=>{const M=new WeakMap;return{render(C,k){const P=M.get(k);return P!==void 0?Promise.resolve(P):(async(I,D)=>{let R=e(I);const N=ht(R,D);if(!N){const V={channelCount:R.channelCount,channelCountMode:R.channelCountMode,channelInterpretation:R.channelInterpretation,delayTime:R.delayTime.value,maxDelayTime:w};R=t(D,V)}return M.set(D,R),N?await h(D,I.delayTime,R.delayTime):await o(D,I.delayTime,R.delayTime),await c(I,D,R),R})(C,k)}}})(Rs,Oc,Yt,Ns,ke),bf=((h,t,e,o,c,w,M)=>class extends h{constructor(C,k){const P=c(C),I={...Nd,...k},D=o(P,I),R=w(P);super(C,!1,D,R?e(I.maxDelayTime):null),this._delayTime=t(this,R,D.delayTime),M(this,I.maxDelayTime)}get delayTime(){return this._delayTime}})(fe,xs,yf,Oc,Kt,Ut,Mn),Jc=(h=>(t,e)=>{const o=t.createDynamicsCompressor();if(ye(o,e),e.channelCount>2||e.channelCountMode==="max")throw h();return he(o,e,"attack"),he(o,e,"knee"),he(o,e,"ratio"),he(o,e,"release"),he(o,e,"threshold"),o})(We),_f=((h,t,e,o,c)=>()=>{const w=new WeakMap;return{render(M,C){const k=w.get(C);return k!==void 0?Promise.resolve(k):(async(P,I)=>{let D=e(P);const R=ht(D,I);if(!R){const N={attack:D.attack.value,channelCount:D.channelCount,channelCountMode:D.channelCountMode,channelInterpretation:D.channelInterpretation,knee:D.knee.value,ratio:D.ratio.value,release:D.release.value,threshold:D.threshold.value};D=t(I,N)}return w.set(I,D),R?(await h(I,P.attack,D.attack),await h(I,P.knee,D.knee),await h(I,P.ratio,D.ratio),await h(I,P.release,D.release),await h(I,P.threshold,D.threshold)):(await o(I,P.attack,D.attack),await o(I,P.knee,D.knee),await o(I,P.ratio,D.ratio),await o(I,P.release,D.release),await o(I,P.threshold,D.threshold)),await c(P,I,D),D})(M,C)}}})(Rs,Jc,Yt,Ns,ke),wf=((h,t,e,o,c,w,M,C)=>class extends h{constructor(k,P){const I=w(k),D={...Ld,...P},R=o(I,D),N=M(I);super(k,!1,R,N?e():null),this._attack=t(this,N,R.attack),this._knee=t(this,N,R.knee),this._nativeDynamicsCompressorNode=R,this._ratio=t(this,N,R.ratio),this._release=t(this,N,R.release),this._threshold=t(this,N,R.threshold),C(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(k){const P=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=k,k>2)throw this._nativeDynamicsCompressorNode.channelCount=P,c()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(k){const P=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=k,k==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=P,c()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(fe,xs,_f,Jc,We,Kt,Ut,Mn),xf=((h,t,e,o,c)=>()=>{const w=new WeakMap;return{render(M,C){const k=w.get(C);return k!==void 0?Promise.resolve(k):(async(P,I)=>{let D=e(P);const R=ht(D,I);if(!R){const N={channelCount:D.channelCount,channelCountMode:D.channelCountMode,channelInterpretation:D.channelInterpretation,gain:D.gain.value};D=t(I,N)}return w.set(I,D),R?await h(I,P.gain,D.gain):await o(I,P.gain,D.gain),await c(P,I,D),D})(M,C)}}})(Rs,Xe,Yt,Ns,ke),Sf=((h,t,e,o,c,w)=>class extends h{constructor(M,C){const k=c(M),P={...Fd,...C},I=o(k,P),D=w(k);super(M,!1,I,D?e():null),this._gain=t(this,D,I.gain,Vt,jt)}get gain(){return this._gain}})(fe,xs,xf,Xe,Kt,Ut),Tf=((h,t,e,o)=>(c,w,{channelCount:M,channelCountMode:C,channelInterpretation:k,feedback:P,feedforward:I})=>{const D=Ec(w,c.sampleRate),R=P instanceof Float64Array?P:new Float64Array(P),N=I instanceof Float64Array?I:new Float64Array(I),V=R.length,W=N.length,q=Math.min(V,W);if(V===0||V>20)throw o();if(R[0]===0)throw t();if(W===0||W>20)throw o();if(N[0]===0)throw t();if(R[0]!==1){for(let H=0;H<W;H+=1)N[H]/=R[0];for(let H=1;H<V;H+=1)R[H]/=R[0]}const j=e(c,D,M,M);j.channelCount=M,j.channelCountMode=C,j.channelInterpretation=k;const $=[],z=[],J=[];for(let H=0;H<M;H+=1){$.push(0);const Z=new Float32Array(32),G=new Float32Array(32);Z.fill(0),G.fill(0),z.push(Z),J.push(G)}j.onaudioprocess=H=>{const Z=H.inputBuffer,G=H.outputBuffer,st=Z.numberOfChannels;for(let Y=0;Y<st;Y+=1){const tt=Z.getChannelData(Y),at=G.getChannelData(Y);$[Y]=kc(R,V,N,W,q,z[Y],J[Y],$[Y],32,tt,at)}};const et=c.sampleRate/2;return Jn({get bufferSize(){return D},get channelCount(){return j.channelCount},set channelCount(H){j.channelCount=H},get channelCountMode(){return j.channelCountMode},set channelCountMode(H){j.channelCountMode=H},get channelInterpretation(){return j.channelInterpretation},set channelInterpretation(H){j.channelInterpretation=H},get context(){return j.context},get inputs(){return[j]},get numberOfInputs(){return j.numberOfInputs},get numberOfOutputs(){return j.numberOfOutputs},addEventListener:(...H)=>j.addEventListener(H[0],H[1],H[2]),dispatchEvent:(...H)=>j.dispatchEvent(H[0]),getFrequencyResponse(H,Z,G){if(H.length!==Z.length||Z.length!==G.length)throw h();const st=H.length;for(let Y=0;Y<st;Y+=1){const tt=-Math.PI*(H[Y]/et),at=[Math.cos(tt),Math.sin(tt)],lt=zd(Dc(N,at),Dc(R,at));Z[Y]=Math.sqrt(lt[0]*lt[0]+lt[1]*lt[1]),G[Y]=Math.atan2(lt[1],lt[0])}},removeEventListener:(...H)=>j.removeEventListener(H[0],H[1],H[2])},j)})(Wo,Se,Vi,We),jo=((h,t,e,o)=>c=>h(zi,()=>zi(c))?Promise.resolve(h(o,o)).then(w=>{if(!w){const M=e(c,512,0,1);c.oncomplete=()=>{M.onaudioprocess=null,M.disconnect()},M.onaudioprocess=()=>c.currentTime,M.connect(c.destination)}return c.startRendering()}):new Promise(w=>{const M=t(c,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});c.oncomplete=C=>{M.disconnect(),w(C.renderedBuffer)},M.connect(c.destination),c.startRendering()}))(us,Xe,Vi,((h,t)=>()=>{if(t===null)return Promise.resolve(!1);const e=new t(1,1,44100),o=h(e,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(c=>{e.oncomplete=()=>{o.disconnect(),c(e.currentTime!==0)},e.startRendering()})})(Xe,Te)),Mf=((h,t,e,o,c)=>(w,M)=>{const C=new WeakMap;let k=null;return{render(P,I){const D=C.get(I);return D!==void 0?Promise.resolve(D):(async(R,N)=>{let V=null,W=t(R);const q=ht(W,N);if(N.createIIRFilter===void 0?V=h(N,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):q||(W=N.createIIRFilter(M,w)),C.set(N,V===null?W:V),V!==null){if(k===null){if(e===null)throw new Error("Missing the native OfflineAudioContext constructor.");const $=new e(R.context.destination.channelCount,R.context.length,N.sampleRate);k=(async()=>(await o(R,$,$.destination),((z,J,et,H)=>{const Z=et instanceof Float64Array?et:new Float64Array(et),G=H instanceof Float64Array?H:new Float64Array(H),st=Z.length,Y=G.length,tt=Math.min(st,Y);if(Z[0]!==1){for(let mt=0;mt<st;mt+=1)G[mt]/=Z[0];for(let mt=1;mt<Y;mt+=1)Z[mt]/=Z[0]}const at=new Float32Array(32),lt=new Float32Array(32),Tt=J.createBuffer(z.numberOfChannels,z.length,z.sampleRate),vt=z.numberOfChannels;for(let mt=0;mt<vt;mt+=1){const At=z.getChannelData(mt),pt=Tt.getChannelData(mt);at.fill(0),lt.fill(0),kc(Z,st,G,Y,tt,at,lt,0,32,At,pt)}return Tt})(await c($),N,w,M)))()}const j=await k;return V.buffer=j,V.start(0),V}return await o(R,N,W),W})(P,I)}}})(ei,Yt,Te,ke,jo),Cf=(h=>(t,e,o)=>{if(t.createIIRFilter===void 0)return h(t,e,o);const c=t.createIIRFilter(o.feedforward,o.feedback);return ye(c,o),c})(Tf),Af=((h,t,e,o,c,w)=>class extends h{constructor(M,C){const k=o(M),P=c(k),I={...Bd,...C},D=t(k,P?null:M.baseLatency,I);super(M,!1,D,P?e(I.feedback,I.feedforward):null),(R=>{var N;R.getFrequencyResponse=(N=R.getFrequencyResponse,(V,W,q)=>{if(V.length!==W.length||W.length!==q.length)throw Wo();return N.call(R,V,W,q)})})(D),this._nativeIIRFilterNode=D,w(this,1)}getFrequencyResponse(M,C,k){return this._nativeIIRFilterNode.getFrequencyResponse(M,C,k)}})(fe,Cf,Mf,Kt,Ut,Mn),kf=((h,t,e,o,c,w,M,C)=>(k,P)=>{const I=P.listener,{forwardX:D,forwardY:R,forwardZ:N,positionX:V,positionY:W,positionZ:q,upX:j,upY:$,upZ:z}=I.forwardX===void 0?(()=>{const J=new Float32Array(1),et=t(P,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),H=M(P);let Z=!1,G=[0,0,-1,0,1,0],st=[0,0,0];const Y=()=>{if(Z)return;Z=!0;const Tt=o(P,256,9,0);Tt.onaudioprocess=({inputBuffer:vt})=>{const mt=[w(vt,J,0),w(vt,J,1),w(vt,J,2),w(vt,J,3),w(vt,J,4),w(vt,J,5)];mt.some((pt,Pt)=>pt!==G[Pt])&&(I.setOrientation(...mt),G=mt);const At=[w(vt,J,6),w(vt,J,7),w(vt,J,8)];At.some((pt,Pt)=>pt!==st[Pt])&&(I.setPosition(...At),st=At)},et.connect(Tt)},tt=Tt=>vt=>{vt!==G[Tt]&&(G[Tt]=vt,I.setOrientation(...G))},at=Tt=>vt=>{vt!==st[Tt]&&(st[Tt]=vt,I.setPosition(...st))},lt=(Tt,vt,mt)=>{const At=e(P,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:vt});At.connect(et,0,Tt),At.start(),Object.defineProperty(At.offset,"defaultValue",{get:()=>vt});const pt=h({context:k},H,At.offset,Vt,jt);var Pt,Nt,qt,se,de,Ze,Dt;return C(pt,"value",ft=>()=>ft.call(pt),ft=>Qt=>{try{ft.call(pt,Qt)}catch(Gt){if(Gt.code!==9)throw Gt}Y(),H&&mt(Qt)}),pt.cancelAndHoldAtTime=(Pt=pt.cancelAndHoldAtTime,H?()=>{throw c()}:(...ft)=>{const Qt=Pt.apply(pt,ft);return Y(),Qt}),pt.cancelScheduledValues=(Nt=pt.cancelScheduledValues,H?()=>{throw c()}:(...ft)=>{const Qt=Nt.apply(pt,ft);return Y(),Qt}),pt.exponentialRampToValueAtTime=(qt=pt.exponentialRampToValueAtTime,H?()=>{throw c()}:(...ft)=>{const Qt=qt.apply(pt,ft);return Y(),Qt}),pt.linearRampToValueAtTime=(se=pt.linearRampToValueAtTime,H?()=>{throw c()}:(...ft)=>{const Qt=se.apply(pt,ft);return Y(),Qt}),pt.setTargetAtTime=(de=pt.setTargetAtTime,H?()=>{throw c()}:(...ft)=>{const Qt=de.apply(pt,ft);return Y(),Qt}),pt.setValueAtTime=(Ze=pt.setValueAtTime,H?()=>{throw c()}:(...ft)=>{const Qt=Ze.apply(pt,ft);return Y(),Qt}),pt.setValueCurveAtTime=(Dt=pt.setValueCurveAtTime,H?()=>{throw c()}:(...ft)=>{const Qt=Dt.apply(pt,ft);return Y(),Qt}),pt};return{forwardX:lt(0,0,tt(0)),forwardY:lt(1,0,tt(1)),forwardZ:lt(2,-1,tt(2)),positionX:lt(6,0,at(0)),positionY:lt(7,0,at(1)),positionZ:lt(8,0,at(2)),upX:lt(3,0,tt(3)),upY:lt(4,1,tt(4)),upZ:lt(5,0,tt(5))}})():I;return{get forwardX(){return D},get forwardY(){return R},get forwardZ(){return N},get positionX(){return V},get positionY(){return W},get positionZ(){return q},get upX(){return j},get upY(){return $},get upZ(){return z}}})(xs,dn,si,Vi,We,Rc,Ut,$i),Kc=new WeakMap,Pf=((h,t,e,o,c,w)=>class extends e{constructor(M,C){super(M),this._nativeContext=M,b.set(this,M),o(M)&&c.set(M,new Set),this._destination=new h(this,C),this._listener=t(this,M),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(M){const C=typeof M=="function"?w(this,M):null;this._nativeContext.onstatechange=C;const k=this._nativeContext.onstatechange;this._onstatechange=k!==null&&k===C?M:k}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(of,kf,$c,Ut,Kc,Kn),th=((h,t,e,o,c,w)=>(M,C)=>{const k=M.createOscillator();return ye(k,C),he(k,C,"detune"),he(k,C,"frequency"),C.periodicWave!==void 0?k.setPeriodicWave(C.periodicWave):ie(k,C,"type"),t(e,()=>e(M))||Hr(k),t(o,()=>o(M))||w(k,M),t(c,()=>c(M))||Ur(k),h(M,k),k})($o,us,Xr,Fc,Yr,Bc),Ef=((h,t,e,o,c)=>()=>{const w=new WeakMap;let M=null,C=null,k=null;return{set periodicWave(P){M=P},set start(P){C=P},set stop(P){k=P},render(P,I){const D=w.get(I);return D!==void 0?Promise.resolve(D):(async(R,N)=>{let V=e(R);const W=ht(V,N);if(!W){const q={channelCount:V.channelCount,channelCountMode:V.channelCountMode,channelInterpretation:V.channelInterpretation,detune:V.detune.value,frequency:V.frequency.value,periodicWave:M===null?void 0:M,type:V.type};V=t(N,q),C!==null&&V.start(C),k!==null&&V.stop(k)}return w.set(N,V),W?(await h(N,R.detune,V.detune),await h(N,R.frequency,V.frequency)):(await o(N,R.detune,V.detune),await o(N,R.frequency,V.frequency)),await c(R,N,V),V})(P,I)}}})(Rs,th,Yt,Ns,ke),If=((h,t,e,o,c,w,M)=>class extends h{constructor(C,k){const P=c(C),I={...Vd,...k},D=e(P,I),R=w(P),N=R?o():null,V=C.sampleRate/2;super(C,!1,D,N),this._detune=t(this,R,D.detune,153600,-153600),this._frequency=t(this,R,D.frequency,V,-V),this._nativeOscillatorNode=D,this._onended=null,this._oscillatorNodeRenderer=N,this._oscillatorNodeRenderer!==null&&I.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=I.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(C){const k=typeof C=="function"?M(this,C):null;this._nativeOscillatorNode.onended=k;const P=this._nativeOscillatorNode.onended;this._onended=P!==null&&P===k?C:P}get type(){return this._nativeOscillatorNode.type}set type(C){this._nativeOscillatorNode.type=C,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(C){this._nativeOscillatorNode.setPeriodicWave(C),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=C)}start(C=0){if(this._nativeOscillatorNode.start(C),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=C),this.context.state!=="closed"){wt(this);const k=()=>{this._nativeOscillatorNode.removeEventListener("ended",k),ce(this)&&Rt(this)};this._nativeOscillatorNode.addEventListener("ended",k)}}stop(C=0){this._nativeOscillatorNode.stop(C),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=C)}})(fe,xs,th,Ef,Kt,Ut,Kn),eh=(h=>(t,e)=>{const o=h(t,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),c=t.createBuffer(1,2,44100);return o.buffer=c,o.loop=!0,o.connect(e),o.start(),()=>{o.stop(),o.disconnect(e)}})(ei),Of=((h,t,e,o,c)=>(w,{curve:M,oversample:C,...k})=>{const P=w.createWaveShaper(),I=w.createWaveShaper();ye(P,k),ye(I,k);const D=e(w,{...k,gain:1}),R=e(w,{...k,gain:-1}),N=e(w,{...k,gain:1}),V=e(w,{...k,gain:-1});let W=null,q=!1,j=null;const $={get bufferSize(){},get channelCount(){return P.channelCount},set channelCount(z){D.channelCount=z,R.channelCount=z,P.channelCount=z,N.channelCount=z,I.channelCount=z,V.channelCount=z},get channelCountMode(){return P.channelCountMode},set channelCountMode(z){D.channelCountMode=z,R.channelCountMode=z,P.channelCountMode=z,N.channelCountMode=z,I.channelCountMode=z,V.channelCountMode=z},get channelInterpretation(){return P.channelInterpretation},set channelInterpretation(z){D.channelInterpretation=z,R.channelInterpretation=z,P.channelInterpretation=z,N.channelInterpretation=z,I.channelInterpretation=z,V.channelInterpretation=z},get context(){return P.context},get curve(){return j},set curve(z){if(z!==null&&z.length<2)throw t();if(z===null)P.curve=z,I.curve=z;else{const J=z.length,et=new Float32Array(J+2-J%2),H=new Float32Array(J+2-J%2);et[0]=z[0],H[0]=-z[J-1];const Z=Math.ceil((J+1)/2),G=(J+1)/2-1;for(let st=1;st<Z;st+=1){const Y=st/Z*G,tt=Math.floor(Y),at=Math.ceil(Y);et[st]=tt===at?z[tt]:(1-(Y-tt))*z[tt]+(1-(at-Y))*z[at],H[st]=tt===at?-z[J-1-tt]:-(1-(Y-tt))*z[J-1-tt]-(1-(at-Y))*z[J-1-at]}et[Z]=J%2==1?z[Z-1]:(z[Z-2]+z[Z-1])/2,P.curve=et,I.curve=H}j=z,q&&(o(j)&&W===null?W=h(w,D):W!==null&&(W(),W=null))},get inputs(){return[D]},get numberOfInputs(){return P.numberOfInputs},get numberOfOutputs(){return P.numberOfOutputs},get oversample(){return P.oversample},set oversample(z){P.oversample=z,I.oversample=z},addEventListener:(...z)=>D.addEventListener(z[0],z[1],z[2]),dispatchEvent:(...z)=>D.dispatchEvent(z[0]),removeEventListener:(...z)=>D.removeEventListener(z[0],z[1],z[2])};return M!==null&&($.curve=M instanceof Float32Array?M:new Float32Array(M)),C!==$.oversample&&($.oversample=C),c(Jn($,N),()=>{D.connect(P).connect(N),D.connect(R).connect(I).connect(V).connect(N),q=!0,o(j)&&(W=h(w,D))},()=>{D.disconnect(P),P.disconnect(N),D.disconnect(R),R.disconnect(I),I.disconnect(V),V.disconnect(N),q=!1,W!==null&&(W(),W=null)})})(eh,Se,Xe,Nc,un),Go=((h,t,e,o,c,w,M)=>(C,k)=>{const P=C.createWaveShaper();if(w!==null&&w.name==="webkitAudioContext"&&C.createGain().gain.automationRate===void 0)return e(C,k);ye(P,k);const I=k.curve===null||k.curve instanceof Float32Array?k.curve:new Float32Array(k.curve);if(I!==null&&I.length<2)throw t();ie(P,{curve:I},"curve"),ie(P,k,"oversample");let D=null,R=!1;return M(P,"curve",N=>()=>N.call(P),N=>V=>(N.call(P,V),R&&(o(V)&&D===null?D=h(C,P):o(V)||D===null||(D(),D=null)),V)),c(P,()=>{R=!0,o(P.curve)&&(D=h(C,P))},()=>{R=!1,D!==null&&(D(),D=null)})})(eh,Se,Of,Nc,un,hn,$i),Df=((h,t,e,o,c,w,M,C,k,P)=>(I,{coneInnerAngle:D,coneOuterAngle:R,coneOuterGain:N,distanceModel:V,maxDistance:W,orientationX:q,orientationY:j,orientationZ:$,panningModel:z,positionX:J,positionY:et,positionZ:H,refDistance:Z,rolloffFactor:G,...st})=>{const Y=I.createPanner();if(st.channelCount>2||st.channelCountMode==="max")throw M();ye(Y,st);const tt={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},at=e(I,{...tt,channelInterpretation:"speakers",numberOfInputs:6}),lt=o(I,{...st,gain:1}),Tt=o(I,{...tt,gain:1}),vt=o(I,{...tt,gain:0}),mt=o(I,{...tt,gain:0}),At=o(I,{...tt,gain:0}),pt=o(I,{...tt,gain:0}),Pt=o(I,{...tt,gain:0}),Nt=c(I,256,6,1),qt=w(I,{...tt,curve:new Float32Array([1,1]),oversample:"none"});let se=[q,j,$],de=[J,et,H];const Ze=new Float32Array(1);Nt.onaudioprocess=({inputBuffer:ft})=>{const Qt=[k(ft,Ze,0),k(ft,Ze,1),k(ft,Ze,2)];Qt.some((Re,wn)=>Re!==se[wn])&&(Y.setOrientation(...Qt),se=Qt);const Gt=[k(ft,Ze,3),k(ft,Ze,4),k(ft,Ze,5)];Gt.some((Re,wn)=>Re!==de[wn])&&(Y.setPosition(...Gt),de=Gt)},Object.defineProperty(vt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(mt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(At.gain,"defaultValue",{get:()=>0}),Object.defineProperty(pt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Pt.gain,"defaultValue",{get:()=>0});const Dt={get bufferSize(){},get channelCount(){return Y.channelCount},set channelCount(ft){if(ft>2)throw M();lt.channelCount=ft,Y.channelCount=ft},get channelCountMode(){return Y.channelCountMode},set channelCountMode(ft){if(ft==="max")throw M();lt.channelCountMode=ft,Y.channelCountMode=ft},get channelInterpretation(){return Y.channelInterpretation},set channelInterpretation(ft){lt.channelInterpretation=ft,Y.channelInterpretation=ft},get coneInnerAngle(){return Y.coneInnerAngle},set coneInnerAngle(ft){Y.coneInnerAngle=ft},get coneOuterAngle(){return Y.coneOuterAngle},set coneOuterAngle(ft){Y.coneOuterAngle=ft},get coneOuterGain(){return Y.coneOuterGain},set coneOuterGain(ft){if(ft<0||ft>1)throw t();Y.coneOuterGain=ft},get context(){return Y.context},get distanceModel(){return Y.distanceModel},set distanceModel(ft){Y.distanceModel=ft},get inputs(){return[lt]},get maxDistance(){return Y.maxDistance},set maxDistance(ft){if(ft<0)throw new RangeError;Y.maxDistance=ft},get numberOfInputs(){return Y.numberOfInputs},get numberOfOutputs(){return Y.numberOfOutputs},get orientationX(){return Tt.gain},get orientationY(){return vt.gain},get orientationZ(){return mt.gain},get panningModel(){return Y.panningModel},set panningModel(ft){Y.panningModel=ft},get positionX(){return At.gain},get positionY(){return pt.gain},get positionZ(){return Pt.gain},get refDistance(){return Y.refDistance},set refDistance(ft){if(ft<0)throw new RangeError;Y.refDistance=ft},get rolloffFactor(){return Y.rolloffFactor},set rolloffFactor(ft){if(ft<0)throw new RangeError;Y.rolloffFactor=ft},addEventListener:(...ft)=>lt.addEventListener(ft[0],ft[1],ft[2]),dispatchEvent:(...ft)=>lt.dispatchEvent(ft[0]),removeEventListener:(...ft)=>lt.removeEventListener(ft[0],ft[1],ft[2])};return D!==Dt.coneInnerAngle&&(Dt.coneInnerAngle=D),R!==Dt.coneOuterAngle&&(Dt.coneOuterAngle=R),N!==Dt.coneOuterGain&&(Dt.coneOuterGain=N),V!==Dt.distanceModel&&(Dt.distanceModel=V),W!==Dt.maxDistance&&(Dt.maxDistance=W),q!==Dt.orientationX.value&&(Dt.orientationX.value=q),j!==Dt.orientationY.value&&(Dt.orientationY.value=j),$!==Dt.orientationZ.value&&(Dt.orientationZ.value=$),z!==Dt.panningModel&&(Dt.panningModel=z),J!==Dt.positionX.value&&(Dt.positionX.value=J),et!==Dt.positionY.value&&(Dt.positionY.value=et),H!==Dt.positionZ.value&&(Dt.positionZ.value=H),Z!==Dt.refDistance&&(Dt.refDistance=Z),G!==Dt.rolloffFactor&&(Dt.rolloffFactor=G),se[0]===1&&se[1]===0&&se[2]===0||Y.setOrientation(...se),de[0]===0&&de[1]===0&&de[2]===0||Y.setPosition(...de),P(Jn(Dt,Y),()=>{lt.connect(Y),h(lt,qt,0,0),qt.connect(Tt).connect(at,0,0),qt.connect(vt).connect(at,0,1),qt.connect(mt).connect(at,0,2),qt.connect(At).connect(at,0,3),qt.connect(pt).connect(at,0,4),qt.connect(Pt).connect(at,0,5),at.connect(Nt).connect(I.destination)},()=>{lt.disconnect(Y),C(lt,qt,0,0),qt.disconnect(Tt),Tt.disconnect(at),qt.disconnect(vt),vt.disconnect(at),qt.disconnect(mt),mt.disconnect(at),qt.disconnect(At),At.disconnect(at),qt.disconnect(pt),pt.disconnect(at),qt.disconnect(Pt),Pt.disconnect(at),at.disconnect(Nt),Nt.disconnect(I.destination)})})(ln,Se,dn,Xe,Vi,Go,We,cn,Rc,un),sh=(h=>(t,e)=>{const o=t.createPanner();return o.orientationX===void 0?h(t,e):(ye(o,e),he(o,e,"orientationX"),he(o,e,"orientationY"),he(o,e,"orientationZ"),he(o,e,"positionX"),he(o,e,"positionY"),he(o,e,"positionZ"),ie(o,e,"coneInnerAngle"),ie(o,e,"coneOuterAngle"),ie(o,e,"coneOuterGain"),ie(o,e,"distanceModel"),ie(o,e,"maxDistance"),ie(o,e,"panningModel"),ie(o,e,"refDistance"),ie(o,e,"rolloffFactor"),o)})(Df),Rf=((h,t,e,o,c,w,M,C,k,P)=>()=>{const I=new WeakMap;let D=null;return{render(R,N){const V=I.get(N);return V!==void 0?Promise.resolve(V):(async(W,q)=>{let j=null,$=w(W);const z={channelCount:$.channelCount,channelCountMode:$.channelCountMode,channelInterpretation:$.channelInterpretation},J={...z,coneInnerAngle:$.coneInnerAngle,coneOuterAngle:$.coneOuterAngle,coneOuterGain:$.coneOuterGain,distanceModel:$.distanceModel,maxDistance:$.maxDistance,panningModel:$.panningModel,refDistance:$.refDistance,rolloffFactor:$.rolloffFactor},et=ht($,q);if("bufferSize"in $)j=o(q,{...z,gain:1});else if(!et){const H={...J,orientationX:$.orientationX.value,orientationY:$.orientationY.value,orientationZ:$.orientationZ.value,positionX:$.positionX.value,positionY:$.positionY.value,positionZ:$.positionZ.value};$=c(q,H)}if(I.set(q,j===null?$:j),j!==null){if(D===null){if(M===null)throw new Error("Missing the native OfflineAudioContext constructor.");const lt=new M(6,W.context.length,q.sampleRate),Tt=t(lt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});Tt.connect(lt.destination),D=(async()=>{const vt=await Promise.all([W.orientationX,W.orientationY,W.orientationZ,W.positionX,W.positionY,W.positionZ].map(async(mt,At)=>{const pt=e(lt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:At===0?1:0});return await C(lt,mt,pt.offset),pt}));for(let mt=0;mt<6;mt+=1)vt[mt].connect(Tt,0,mt),vt[mt].start(0);return P(lt)})()}const H=await D,Z=o(q,{...z,gain:1});await k(W,q,Z);const G=[];for(let lt=0;lt<H.numberOfChannels;lt+=1)G.push(H.getChannelData(lt));let st=[G[0][0],G[1][0],G[2][0]],Y=[G[3][0],G[4][0],G[5][0]],tt=o(q,{...z,gain:1}),at=c(q,{...J,orientationX:st[0],orientationY:st[1],orientationZ:st[2],positionX:Y[0],positionY:Y[1],positionZ:Y[2]});Z.connect(tt).connect(at.inputs[0]),at.connect(j);for(let lt=128;lt<H.length;lt+=128){const Tt=[G[0][lt],G[1][lt],G[2][lt]],vt=[G[3][lt],G[4][lt],G[5][lt]];if(Tt.some((mt,At)=>mt!==st[At])||vt.some((mt,At)=>mt!==Y[At])){st=Tt,Y=vt;const mt=lt/q.sampleRate;tt.gain.setValueAtTime(0,mt),tt=o(q,{...z,gain:0}),at=c(q,{...J,orientationX:st[0],orientationY:st[1],orientationZ:st[2],positionX:Y[0],positionY:Y[1],positionZ:Y[2]}),tt.gain.setValueAtTime(1,mt),Z.connect(tt).connect(at.inputs[0]),at.connect(j)}}return j}return et?(await h(q,W.orientationX,$.orientationX),await h(q,W.orientationY,$.orientationY),await h(q,W.orientationZ,$.orientationZ),await h(q,W.positionX,$.positionX),await h(q,W.positionY,$.positionY),await h(q,W.positionZ,$.positionZ)):(await C(q,W.orientationX,$.orientationX),await C(q,W.orientationY,$.orientationY),await C(q,W.orientationZ,$.orientationZ),await C(q,W.positionX,$.positionX),await C(q,W.positionY,$.positionY),await C(q,W.positionZ,$.positionZ)),Ae($)?await k(W,q,$.inputs[0]):await k(W,q,$),$})(R,N)}}})(Rs,dn,si,Xe,sh,Yt,Te,Ns,ke,jo),Nf=((h,t,e,o,c,w,M)=>class extends h{constructor(C,k){const P=c(C),I={...$d,...k},D=e(P,I),R=w(P);super(C,!1,D,R?o():null),this._nativePannerNode=D,this._orientationX=t(this,R,D.orientationX,Vt,jt),this._orientationY=t(this,R,D.orientationY,Vt,jt),this._orientationZ=t(this,R,D.orientationZ,Vt,jt),this._positionX=t(this,R,D.positionX,Vt,jt),this._positionY=t(this,R,D.positionY,Vt,jt),this._positionZ=t(this,R,D.positionZ,Vt,jt),M(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(C){this._nativePannerNode.coneInnerAngle=C}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(C){this._nativePannerNode.coneOuterAngle=C}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(C){this._nativePannerNode.coneOuterGain=C}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(C){this._nativePannerNode.distanceModel=C}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(C){this._nativePannerNode.maxDistance=C}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(C){this._nativePannerNode.panningModel=C}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(C){this._nativePannerNode.refDistance=C}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(C){this._nativePannerNode.rolloffFactor=C}})(fe,xs,sh,Rf,Kt,Ut,Mn),Lf=(h=>(t,{disableNormalization:e,imag:o,real:c})=>{const w=o instanceof Float32Array?o:new Float32Array(o),M=c instanceof Float32Array?c:new Float32Array(c),C=t.createPeriodicWave(M,w,{disableNormalization:e});if(Array.from(o).length<2)throw h();return C})(kt),Ff=((h,t,e,o)=>class Au{constructor(w,M){const C=t(w),k=(I=>{const{imag:D,real:R}=I;return D===void 0?R===void 0?{...I,imag:[0,0],real:[0,0]}:{...I,imag:Array.from(R,()=>0),real:R}:R===void 0?{...I,imag:D,real:Array.from(D,()=>0)}:{...I,imag:D,real:R}})({...jd,...M}),P=h(C,k);return e.add(P),P}static[Symbol.hasInstance](w){return w!==null&&typeof w=="object"&&Object.getPrototypeOf(w)===Au.prototype||e.has(w)}})(Lf,Kt,new WeakSet),Bf=((h,t,e,o,c,w)=>{const C=new Float32Array([1,1]),k=Math.PI/2,P={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},I={...P,oversample:"none"},D=(R,N,V,W,q)=>{if(N===1)return((j,$,z,J)=>{const et=new Float32Array(16385),H=new Float32Array(16385);for(let at=0;at<16385;at+=1){const lt=at/16384*k;et[at]=Math.cos(lt),H[at]=Math.sin(lt)}const Z=e(j,{...P,gain:0}),G=o(j,{...I,curve:et}),st=o(j,{...I,curve:C}),Y=e(j,{...P,gain:0}),tt=o(j,{...I,curve:H});return{connectGraph(){$.connect(Z),$.connect(st.inputs===void 0?st:st.inputs[0]),$.connect(Y),st.connect(z),z.connect(G.inputs===void 0?G:G.inputs[0]),z.connect(tt.inputs===void 0?tt:tt.inputs[0]),G.connect(Z.gain),tt.connect(Y.gain),Z.connect(J,0,0),Y.connect(J,0,1)},disconnectGraph(){$.disconnect(Z),$.disconnect(st.inputs===void 0?st:st.inputs[0]),$.disconnect(Y),st.disconnect(z),z.disconnect(G.inputs===void 0?G:G.inputs[0]),z.disconnect(tt.inputs===void 0?tt:tt.inputs[0]),G.disconnect(Z.gain),tt.disconnect(Y.gain),Z.disconnect(J,0,0),Y.disconnect(J,0,1)}}})(R,V,W,q);if(N===2)return((j,$,z,J)=>{const et=new Float32Array(16385),H=new Float32Array(16385),Z=new Float32Array(16385),G=new Float32Array(16385),st=Math.floor(8192.5);for(let Nt=0;Nt<16385;Nt+=1)if(Nt>st){const qt=(Nt-st)/(16384-st)*k;et[Nt]=Math.cos(qt),H[Nt]=Math.sin(qt),Z[Nt]=0,G[Nt]=1}else{const qt=Nt/(16384-st)*k;et[Nt]=1,H[Nt]=0,Z[Nt]=Math.cos(qt),G[Nt]=Math.sin(qt)}const Y=t(j,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),tt=e(j,{...P,gain:0}),at=o(j,{...I,curve:et}),lt=e(j,{...P,gain:0}),Tt=o(j,{...I,curve:H}),vt=o(j,{...I,curve:C}),mt=e(j,{...P,gain:0}),At=o(j,{...I,curve:Z}),pt=e(j,{...P,gain:0}),Pt=o(j,{...I,curve:G});return{connectGraph(){$.connect(Y),$.connect(vt.inputs===void 0?vt:vt.inputs[0]),Y.connect(tt,0),Y.connect(lt,0),Y.connect(mt,1),Y.connect(pt,1),vt.connect(z),z.connect(at.inputs===void 0?at:at.inputs[0]),z.connect(Tt.inputs===void 0?Tt:Tt.inputs[0]),z.connect(At.inputs===void 0?At:At.inputs[0]),z.connect(Pt.inputs===void 0?Pt:Pt.inputs[0]),at.connect(tt.gain),Tt.connect(lt.gain),At.connect(mt.gain),Pt.connect(pt.gain),tt.connect(J,0,0),mt.connect(J,0,0),lt.connect(J,0,1),pt.connect(J,0,1)},disconnectGraph(){$.disconnect(Y),$.disconnect(vt.inputs===void 0?vt:vt.inputs[0]),Y.disconnect(tt,0),Y.disconnect(lt,0),Y.disconnect(mt,1),Y.disconnect(pt,1),vt.disconnect(z),z.disconnect(at.inputs===void 0?at:at.inputs[0]),z.disconnect(Tt.inputs===void 0?Tt:Tt.inputs[0]),z.disconnect(At.inputs===void 0?At:At.inputs[0]),z.disconnect(Pt.inputs===void 0?Pt:Pt.inputs[0]),at.disconnect(tt.gain),Tt.disconnect(lt.gain),At.disconnect(mt.gain),Pt.disconnect(pt.gain),tt.disconnect(J,0,0),mt.disconnect(J,0,0),lt.disconnect(J,0,1),pt.disconnect(J,0,1)}}})(R,V,W,q);throw c()};return(R,{channelCount:N,channelCountMode:V,pan:W,...q})=>{if(V==="max")throw c();const j=h(R,{...q,channelCount:1,channelCountMode:V,numberOfInputs:2}),$=e(R,{...q,channelCount:N,channelCountMode:V,gain:1}),z=e(R,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:W});let{connectGraph:J,disconnectGraph:et}=D(R,N,$,z,j);Object.defineProperty(z.gain,"defaultValue",{get:()=>0}),Object.defineProperty(z.gain,"maxValue",{get:()=>1}),Object.defineProperty(z.gain,"minValue",{get:()=>-1});const H={get bufferSize(){},get channelCount(){return $.channelCount},set channelCount(G){$.channelCount!==G&&(Z&&et(),{connectGraph:J,disconnectGraph:et}=D(R,G,$,z,j),Z&&J()),$.channelCount=G},get channelCountMode(){return $.channelCountMode},set channelCountMode(G){if(G==="clamped-max"||G==="max")throw c();$.channelCountMode=G},get channelInterpretation(){return $.channelInterpretation},set channelInterpretation(G){$.channelInterpretation=G},get context(){return $.context},get inputs(){return[$]},get numberOfInputs(){return $.numberOfInputs},get numberOfOutputs(){return $.numberOfOutputs},get pan(){return z.gain},addEventListener:(...G)=>$.addEventListener(G[0],G[1],G[2]),dispatchEvent:(...G)=>$.dispatchEvent(G[0]),removeEventListener:(...G)=>$.removeEventListener(G[0],G[1],G[2])};let Z=!1;return w(Jn(H,j),()=>{J(),Z=!0},()=>{et(),Z=!1})}})(dn,Wi,Xe,Go,We,un),nh=((h,t)=>(e,o)=>{const c=o.channelCountMode;if(c==="clamped-max")throw t();if(e.createStereoPanner===void 0)return h(e,o);const w=e.createStereoPanner();return ye(w,o),he(w,o,"pan"),Object.defineProperty(w,"channelCountMode",{get:()=>c,set:M=>{if(M!==c)throw t()}}),w})(Bf,We),qf=((h,t,e,o,c)=>()=>{const w=new WeakMap;return{render(M,C){const k=w.get(C);return k!==void 0?Promise.resolve(k):(async(P,I)=>{let D=e(P);const R=ht(D,I);if(!R){const N={channelCount:D.channelCount,channelCountMode:D.channelCountMode,channelInterpretation:D.channelInterpretation,pan:D.pan.value};D=t(I,N)}return w.set(I,D),R?await h(I,P.pan,D.pan):await o(I,P.pan,D.pan),Ae(D)?await c(P,I,D.inputs[0]):await c(P,I,D),D})(M,C)}}})(Rs,nh,Yt,Ns,ke),zf=((h,t,e,o,c,w)=>class extends h{constructor(M,C){const k=c(M),P={...Gd,...C},I=e(k,P),D=w(k);super(M,!1,I,D?o():null),this._pan=t(this,D,I.pan)}get pan(){return this._pan}})(fe,xs,nh,qf,Kt,Ut),Wf=((h,t,e)=>()=>{const o=new WeakMap;return{render(c,w){const M=o.get(w);return M!==void 0?Promise.resolve(M):(async(C,k)=>{let P=t(C);if(!ht(P,k)){const I={channelCount:P.channelCount,channelCountMode:P.channelCountMode,channelInterpretation:P.channelInterpretation,curve:P.curve,oversample:P.oversample};P=h(k,I)}return o.set(k,P),Ae(P)?await e(C,k,P.inputs[0]):await e(C,k,P),P})(c,w)}}})(Go,Yt,ke),Vf=((h,t,e,o,c,w,M)=>class extends h{constructor(C,k){const P=c(C),I={...Ud,...k},D=e(P,I);super(C,!0,D,w(P)?o():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=D,M(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(C){if(C===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(C.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=C}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(C){this._nativeWaveShaperNode.oversample=C}})(fe,Se,Go,Wf,Kt,Ut,Mn),ih=(h=>h!==null&&h.isSecureContext)(ws),na=(h=>(t,e,o)=>{Object.defineProperties(h,{currentFrame:{configurable:!0,get:()=>Math.round(t*e)},currentTime:{configurable:!0,get:()=>t}});try{return o()}finally{h!==null&&(delete h.currentFrame,delete h.currentTime)}})(ws),oh=new WeakMap,$f=((h,t)=>e=>{let o=h.get(e);if(o!==void 0)return o;if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");return o=new t(1,1,44100),h.set(e,o),o})(oh,Te),jf=ih?((h,t,e,o,c,w,M,C,k,P,I,D,R)=>{let N=0;return(V,W,q={credentials:"omit"})=>{const j=I.get(V);if(j!==void 0&&j.has(W))return Promise.resolve();const $=P.get(V);if($!==void 0){const et=$.get(W);if(et!==void 0)return et}const z=w(V),J=z.audioWorklet===void 0?c(W).then(([et,H])=>{const[Z,G]=F(et,H);return e(`${Z};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${G}
})})(window,'_AWGS')`)}).then(()=>{const et=R._AWGS.pop();if(et===void 0)throw new SyntaxError;o(z.currentTime,z.sampleRate,()=>et(class{},void 0,(H,Z)=>{if(H.trim()==="")throw t();const G=A.get(z);if(G!==void 0){if(G.has(H))throw t();X(Z),U(Z.parameterDescriptors),G.set(H,Z)}else X(Z),U(Z.parameterDescriptors),A.set(z,new Map([[H,Z]]))},z.sampleRate,void 0,void 0))}):Promise.all([c(W),Promise.resolve(h(D,D))]).then(([[et,H],Z])=>{const G=N+1;N=G;const[st,Y]=F(et,H),tt=new Blob([`${st};((AudioWorkletProcessor,registerProcessor)=>{${Y}
})(${Z?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${Z?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${Z?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${G}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),at=URL.createObjectURL(tt);return z.audioWorklet.addModule(at,q).then(()=>{if(C(z))return z;const lt=M(z);return lt.audioWorklet.addModule(at,q).then(()=>lt)}).then(lt=>{if(k===null)throw new SyntaxError;try{new k(lt,`__sac${G}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(at))});return $===void 0?P.set(V,new Map([[W,J]])):$.set(W,J),J.then(()=>{const et=I.get(V);et===void 0?I.set(V,new Set([W])):et.add(W)}).finally(()=>{const et=P.get(V);et!==void 0&&et.delete(W)}),J}})(us,We,(h=>t=>new Promise((e,o)=>{if(h===null)return void o(new SyntaxError);const c=h.document.head;if(c===null)o(new SyntaxError);else{const w=h.document.createElement("script"),M=new Blob([t],{type:"application/javascript"}),C=URL.createObjectURL(M),k=h.onerror,P=()=>{h.onerror=k,URL.revokeObjectURL(C)};h.onerror=(I,D,R,N,V)=>D===C||D===h.location.href&&R===1&&N===1?(P(),o(V),!1):k!==null?k(I,D,R,N,V):void 0,w.onerror=()=>{P(),o(new SyntaxError)},w.onload=()=>{P(),e()},w.src=C,w.type="module",c.appendChild(w)}}))(ws),na,async h=>{try{const t=await fetch(h);if(t.ok)return[await t.text(),t.url]}catch{}throw new DOMException("","AbortError")},Kt,$f,Ut,ti,new WeakMap,new WeakMap,((h,t)=>async()=>{if(h===null)return!0;if(t===null)return!1;const e=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),o=new t(1,128,44100),c=URL.createObjectURL(e);let w=!1,M=!1;try{await o.audioWorklet.addModule(c);const C=new h(o,"a",{numberOfOutputs:0}),k=o.createOscillator();C.port.onmessage=()=>w=!0,C.onprocessorerror=()=>M=!0,k.connect(C),k.start(0),await o.startRendering(),await new Promise(P=>setTimeout(P))}catch{}finally{URL.revokeObjectURL(c)}return w&&!M})(ti,Te),ws):void 0,Gf=((h,t)=>e=>h(e)||t(e))(Qr,Ut),Hf=((h,t,e,o,c,w,M,C,k,P,I)=>(D,R)=>{const N=M(D)?D:w(D);if(c.has(R)){const V=new DOMException("","DataCloneError");return Promise.reject(V)}try{c.add(R)}catch{}return t(k,()=>k(N))?N.decodeAudioData(R).then(V=>(Ac(R).catch(()=>{}),t(C,()=>C(V))||I(V),h.add(V),V)):new Promise((V,W)=>{const q=async()=>{try{await Ac(R)}catch{}},j=$=>{W($),q()};try{N.decodeAudioData(R,$=>{typeof $.copyFromChannel!="function"&&(P($),dt($)),h.add($),q().then(()=>V($))},$=>{j($===null?new DOMException("","EncodingError"):$)})}catch($){j($)}})})(Kr,us,0,0,new WeakSet,Kt,Gf,ut,zi,ea,sa),rh=((h,t,e,o,c,w,M,C,k,P,I,D,R,N,V,W,q,j,$,z)=>class extends V{constructor(J,et){super(J,et),this._nativeContext=J,this._audioWorklet=h===void 0?void 0:{addModule:(H,Z)=>h(this,H,Z)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new t(this)}createBiquadFilter(){return new c(this)}createBuffer(J,et,H){return new e({length:et,numberOfChannels:J,sampleRate:H})}createBufferSource(){return new o(this)}createChannelMerger(J=6){return new w(this,{numberOfInputs:J})}createChannelSplitter(J=6){return new M(this,{numberOfOutputs:J})}createConstantSource(){return new C(this)}createConvolver(){return new k(this)}createDelay(J=1){return new I(this,{maxDelayTime:J})}createDynamicsCompressor(){return new D(this)}createGain(){return new R(this)}createIIRFilter(J,et){return new N(this,{feedback:et,feedforward:J})}createOscillator(){return new W(this)}createPanner(){return new q(this)}createPeriodicWave(J,et,H={disableNormalization:!1}){return new j(this,{...H,imag:et,real:J})}createStereoPanner(){return new $(this)}createWaveShaper(){return new z(this)}decodeAudioData(J,et,H){return P(this._nativeContext,J).then(Z=>(typeof et=="function"&&et(Z),Z),Z=>{throw typeof H=="function"&&H(Z),Z})}})(jf,ef,Xc,nf,af,hf,df,mf,vf,Hf,bf,wf,Sf,Af,Pf,If,Nf,Ff,zf,Vf),Uf=((h,t,e,o)=>class extends h{constructor(c,w){const M=e(c),C=((k,P)=>k.createMediaElementSource(P.mediaElement))(M,w);if(o(M))throw TypeError();super(c,!0,C,null),this._nativeMediaElementAudioSourceNode=C}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(fe,0,Kt,Ut),Xf=((h,t,e,o)=>class extends h{constructor(c,w){const M=e(c);if(o(M))throw new TypeError;const C=((k,P)=>{const I=k.createMediaStreamDestination();return ye(I,P),I.numberOfOutputs===1&&Object.defineProperty(I,"numberOfOutputs",{get:()=>0}),I})(M,{...qd,...w});super(c,!1,C,null),this._nativeMediaStreamAudioDestinationNode=C}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(fe,0,Kt,Ut),Yf=((h,t,e,o)=>class extends h{constructor(c,w){const M=e(c),C=((k,{mediaStream:P})=>{const I=P.getAudioTracks();I.sort((N,V)=>N.id<V.id?-1:N.id>V.id?1:0);const D=I.slice(0,1),R=k.createMediaStreamSource(new MediaStream(D));return Object.defineProperty(R,"mediaStream",{value:P}),R})(M,w);if(o(M))throw new TypeError;super(c,!0,C,null),this._nativeMediaStreamAudioSourceNode=C}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(fe,0,Kt,Ut),Zf=((h,t)=>(e,{mediaStreamTrack:o})=>{if(typeof e.createMediaStreamTrackSource=="function")return e.createMediaStreamTrackSource(o);const c=new MediaStream([o]),w=e.createMediaStreamSource(c);if(o.kind!=="audio")throw h();if(t(e))throw new TypeError;return w})(Se,Ut),Qf=((h,t,e)=>class extends h{constructor(o,c){const w=e(o);super(o,!0,t(w,c),null)}})(fe,Zf,Kt),Jf=((h,t,e,o,c,w,M,C,k)=>class extends h{constructor(P={}){if(k===null)throw new Error("Missing the native AudioContext constructor.");let I;try{I=new k(P)}catch(N){throw N.code===12&&N.message==="sampleRate is not in range"?e():N}if(I===null)throw o();if(!(N=>N===void 0||typeof N=="number"||typeof N=="string"&&(N==="balanced"||N==="interactive"||N==="playback"))(P.latencyHint))throw new TypeError(`The provided value '${P.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(P.sampleRate!==void 0&&I.sampleRate!==P.sampleRate)throw e();super(I,2);const{latencyHint:D}=P,{sampleRate:R}=I;if(this._baseLatency=typeof I.baseLatency=="number"?I.baseLatency:D==="balanced"?512/R:D==="interactive"||D===void 0?256/R:D==="playback"?1024/R:128*Math.max(2,Math.min(128,Math.round(D*R/128)))/R,this._nativeAudioContext=I,k.name==="webkitAudioContext"?(this._nativeGainNode=I.createGain(),this._nativeOscillatorNode=I.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(I.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,I.state==="running"){this._state="suspended";const N=()=>{this._state==="suspended"&&(this._state=null),I.removeEventListener("statechange",N)};I.addEventListener("statechange",N)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw t()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),ts(this)}))}createMediaElementSource(P){return new c(this,{mediaElement:P})}createMediaStreamDestination(){return new w(this)}createMediaStreamSource(P){return new M(this,{mediaStream:P})}createMediaStreamTrackSource(P){return new C(this,{mediaStreamTrack:P})}resume(){return this._state==="suspended"?new Promise((P,I)=>{const D=()=>{this._nativeAudioContext.removeEventListener("statechange",D),this._nativeAudioContext.state==="running"?P():this.resume().then(P,I)};this._nativeAudioContext.addEventListener("statechange",D)}):this._nativeAudioContext.resume().catch(P=>{throw P===void 0||P.code===15?t():P})}suspend(){return this._nativeAudioContext.suspend().catch(P=>{throw P===void 0?t():P})}})(rh,Se,We,Hd,Uf,Xf,Yf,Qf,hn),ia=(h=>t=>{const e=h.get(t);if(e===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return e})(Kc),Kf=(h=>(t,e)=>{h(t).add(e)})(ia),ah=(h=>(t,e,o=0,c=0)=>{const w=t[o];if(w===void 0)throw h();return Zn(e)?w.connect(e,0,c):w.connect(e,0)})(kt),tp=(h=>(t,e)=>{h(t).delete(e)})(ia),lh=(h=>(t,e=void 0,o=void 0,c=0)=>e===void 0?t.forEach(w=>w.disconnect()):typeof e=="number"?zo(h,t,e).disconnect():Zn(e)?o===void 0?t.forEach(w=>w.disconnect(e)):c===void 0?zo(h,t,o).disconnect(e,0):zo(h,t,o).disconnect(e,0,c):o===void 0?t.forEach(w=>w.disconnect(e)):zo(h,t,o).disconnect(e,0))(kt),ch=new WeakMap,ep=((h,t)=>e=>t(h,e))(ch,Q),sp=((h,t,e,o,c,w,M,C,k,P,I,D,R)=>(N,V,W,q)=>{if(q.numberOfInputs===0&&q.numberOfOutputs===0)throw k();const j=Array.isArray(q.outputChannelCount)?q.outputChannelCount:Array.from(q.outputChannelCount);if(j.some(ot=>ot<1))throw k();if(j.length!==q.numberOfOutputs)throw t();if(q.channelCountMode!=="explicit")throw k();const $=q.channelCount*q.numberOfInputs,z=j.reduce((ot,zt)=>ot+zt,0),J=W.parameterDescriptors===void 0?0:W.parameterDescriptors.length;if($+J>6||z>6)throw k();const et=new MessageChannel,H=[],Z=[];for(let ot=0;ot<q.numberOfInputs;ot+=1)H.push(M(N,{channelCount:q.channelCount,channelCountMode:q.channelCountMode,channelInterpretation:q.channelInterpretation,gain:1})),Z.push(c(N,{channelCount:q.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:q.channelCount}));const G=[];if(W.parameterDescriptors!==void 0)for(const{defaultValue:ot,maxValue:zt,minValue:Ne,name:le}of W.parameterDescriptors){const Bt=w(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:q.parameterData[le]!==void 0?q.parameterData[le]:ot===void 0?0:ot});Object.defineProperties(Bt.offset,{defaultValue:{get:()=>ot===void 0?0:ot},maxValue:{get:()=>zt===void 0?Vt:zt},minValue:{get:()=>Ne===void 0?jt:Ne}}),G.push(Bt)}const st=o(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,$+J)}),Y=Ec(V,N.sampleRate),tt=C(N,Y,$+J,Math.max(1,z)),at=c(N,{channelCount:Math.max(1,z),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,z)}),lt=[];for(let ot=0;ot<q.numberOfOutputs;ot+=1)lt.push(o(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:j[ot]}));for(let ot=0;ot<q.numberOfInputs;ot+=1){H[ot].connect(Z[ot]);for(let zt=0;zt<q.channelCount;zt+=1)Z[ot].connect(st,zt,ot*q.channelCount+zt)}const Tt=new Fo(W.parameterDescriptors===void 0?[]:W.parameterDescriptors.map(({name:ot},zt)=>{const Ne=G[zt];return Ne.connect(st,0,$+zt),Ne.start(0),[ot,Ne.offset]}));st.connect(tt);let vt=q.channelInterpretation,mt=null;const At=q.numberOfOutputs===0?[tt]:lt,pt={get bufferSize(){return Y},get channelCount(){return q.channelCount},set channelCount(ot){throw e()},get channelCountMode(){return q.channelCountMode},set channelCountMode(ot){throw e()},get channelInterpretation(){return vt},set channelInterpretation(ot){for(const zt of H)zt.channelInterpretation=ot;vt=ot},get context(){return tt.context},get inputs(){return H},get numberOfInputs(){return q.numberOfInputs},get numberOfOutputs(){return q.numberOfOutputs},get onprocessorerror(){return mt},set onprocessorerror(ot){typeof mt=="function"&&pt.removeEventListener("processorerror",mt),mt=typeof ot=="function"?ot:null,typeof mt=="function"&&pt.addEventListener("processorerror",mt)},get parameters(){return Tt},get port(){return et.port2},addEventListener:(...ot)=>tt.addEventListener(ot[0],ot[1],ot[2]),connect:h.bind(null,At),disconnect:P.bind(null,At),dispatchEvent:(...ot)=>tt.dispatchEvent(ot[0]),removeEventListener:(...ot)=>tt.removeEventListener(ot[0],ot[1],ot[2])},Pt=new Map;var Nt,qt;et.port1.addEventListener=(Nt=et.port1.addEventListener,(...ot)=>{if(ot[0]==="message"){const zt=typeof ot[1]=="function"?ot[1]:typeof ot[1]=="object"&&ot[1]!==null&&typeof ot[1].handleEvent=="function"?ot[1].handleEvent:null;if(zt!==null){const Ne=Pt.get(ot[1]);Ne!==void 0?ot[1]=Ne:(ot[1]=le=>{I(N.currentTime,N.sampleRate,()=>zt(le))},Pt.set(zt,ot[1]))}}return Nt.call(et.port1,ot[0],ot[1],ot[2])}),et.port1.removeEventListener=(qt=et.port1.removeEventListener,(...ot)=>{if(ot[0]==="message"){const zt=Pt.get(ot[1]);zt!==void 0&&(Pt.delete(ot[1]),ot[1]=zt)}return qt.call(et.port1,ot[0],ot[1],ot[2])});let se=null;Object.defineProperty(et.port1,"onmessage",{get:()=>se,set:ot=>{typeof se=="function"&&et.port1.removeEventListener("message",se),se=typeof ot=="function"?ot:null,typeof se=="function"&&(et.port1.addEventListener("message",se),et.port1.start())}}),W.prototype.port=et.port1;let de=null;((ot,zt,Ne,le)=>{let Bt=E.get(ot);Bt===void 0&&(Bt=new WeakMap,E.set(ot,Bt));const ne=(async(Qe,Bs)=>{const qs=await(ml=>new Promise((gl,im)=>{const{port1:hr,port2:vl}=new MessageChannel;hr.onmessage=({data:yl})=>{hr.close(),vl.close(),gl(yl)},hr.onmessageerror=({data:yl})=>{hr.close(),vl.close(),im(yl)},vl.postMessage(ml)}))(Bs);return new Qe(qs)})(Ne,le);return Bt.set(zt,ne),ne})(N,pt,W,q).then(ot=>de=ot);const Dt=qo(q.numberOfInputs,q.channelCount),ft=qo(q.numberOfOutputs,j),Qt=W.parameterDescriptors===void 0?[]:W.parameterDescriptors.reduce((ot,{name:zt})=>({...ot,[zt]:new Float32Array(128)}),{});let Gt=!0;const Re=()=>{q.numberOfOutputs>0&&tt.disconnect(at);for(let ot=0,zt=0;ot<q.numberOfOutputs;ot+=1){const Ne=lt[ot];for(let le=0;le<j[ot];le+=1)at.disconnect(Ne,zt+le,le);zt+=j[ot]}},wn=new Map;tt.onaudioprocess=({inputBuffer:ot,outputBuffer:zt})=>{if(de!==null){const Ne=D(pt);for(let le=0;le<Y;le+=128){for(let Bt=0;Bt<q.numberOfInputs;Bt+=1)for(let ne=0;ne<q.channelCount;ne+=1)Tn(ot,Dt[Bt],ne,ne,le);W.parameterDescriptors!==void 0&&W.parameterDescriptors.forEach(({name:Bt},ne)=>{Tn(ot,Qt,Bt,$+ne,le)});for(let Bt=0;Bt<q.numberOfInputs;Bt+=1)for(let ne=0;ne<j[Bt];ne+=1)ft[Bt][ne].byteLength===0&&(ft[Bt][ne]=new Float32Array(128));try{const Bt=Dt.map((Qe,Bs)=>{if(Ne[Bs].size>0)return wn.set(Bs,Y/128),Qe;const qs=wn.get(Bs);return qs===void 0?[]:(Qe.every(ml=>ml.every(gl=>gl===0))&&(qs===1?wn.delete(Bs):wn.set(Bs,qs-1)),Qe)});Gt=I(N.currentTime+le/N.sampleRate,N.sampleRate,()=>de.process(Bt,ft,Qt));for(let Qe=0,Bs=0;Qe<q.numberOfOutputs;Qe+=1){for(let qs=0;qs<j[Qe];qs+=1)Qn(zt,ft[Qe],qs,Bs+qs,le);Bs+=j[Qe]}}catch(Bt){Gt=!1,pt.dispatchEvent(new ErrorEvent("processorerror",{colno:Bt.colno,filename:Bt.filename,lineno:Bt.lineno,message:Bt.message}))}if(!Gt){for(let Bt=0;Bt<q.numberOfInputs;Bt+=1){H[Bt].disconnect(Z[Bt]);for(let ne=0;ne<q.channelCount;ne+=1)Z[le].disconnect(st,ne,Bt*q.channelCount+ne)}if(W.parameterDescriptors!==void 0){const Bt=W.parameterDescriptors.length;for(let ne=0;ne<Bt;ne+=1){const Qe=G[ne];Qe.disconnect(st,0,$+ne),Qe.stop()}}st.disconnect(tt),tt.onaudioprocess=null,fl?Re():Bh();break}}}};let fl=!1;const pl=M(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Fh=()=>tt.connect(pl).connect(N.destination),Bh=()=>{tt.disconnect(pl),pl.disconnect()};return Fh(),R(pt,()=>{if(Gt){Bh(),q.numberOfOutputs>0&&tt.connect(at);for(let ot=0,zt=0;ot<q.numberOfOutputs;ot+=1){const Ne=lt[ot];for(let le=0;le<j[ot];le+=1)at.connect(Ne,zt+le,le);zt+=j[ot]}}fl=!0},()=>{Gt&&(Fh(),Re()),fl=!1})})(ah,kt,Se,dn,Wi,si,Xe,Vi,We,lh,na,ep,un),np=((h,t,e,o,c)=>(w,M,C,k,P,I)=>{if(C!==null)try{const N=new C(w,k,I),V=new Map;let W=null;if(Object.defineProperties(N,{channelCount:{get:()=>I.channelCount,set:()=>{throw h()}},channelCountMode:{get:()=>"explicit",set:()=>{throw h()}},onprocessorerror:{get:()=>W,set:q=>{typeof W=="function"&&N.removeEventListener("processorerror",W),W=typeof q=="function"?q:null,typeof W=="function"&&N.addEventListener("processorerror",W)}}}),N.addEventListener=(R=N.addEventListener,(...q)=>{if(q[0]==="processorerror"){const j=typeof q[1]=="function"?q[1]:typeof q[1]=="object"&&q[1]!==null&&typeof q[1].handleEvent=="function"?q[1].handleEvent:null;if(j!==null){const $=V.get(q[1]);$!==void 0?q[1]=$:(q[1]=z=>{z.type==="error"?(Object.defineProperties(z,{type:{value:"processorerror"}}),j(z)):j(new ErrorEvent(q[0],{...z}))},V.set(j,q[1]))}}return R.call(N,"error",q[1],q[2]),R.call(N,...q)}),N.removeEventListener=(D=N.removeEventListener,(...q)=>{if(q[0]==="processorerror"){const j=V.get(q[1]);j!==void 0&&(V.delete(q[1]),q[1]=j)}return D.call(N,"error",q[1],q[2]),D.call(N,q[0],q[1],q[2])}),I.numberOfOutputs!==0){const q=e(w,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return N.connect(q).connect(w.destination),c(N,()=>q.disconnect(),()=>q.connect(w.destination))}return N}catch(N){throw N.code===11?o():N}var D,R;if(P===void 0)throw o();return(N=>{const{port1:V}=new MessageChannel;try{V.postMessage(N)}finally{V.close()}})(I),t(w,M,P,I)})(Se,sp,Xe,We,un),ip=((h,t,e,o,c,w,M,C,k,P,I,D,R,N,V,W)=>(q,j,$)=>{const z=new WeakMap;let J=null;return{render(et,H){C(H,et);const Z=z.get(H);return Z!==void 0?Promise.resolve(Z):(async(G,st)=>{let Y=I(G),tt=null;const at=ht(Y,st),lt=Array.isArray(j.outputChannelCount)?j.outputChannelCount:Array.from(j.outputChannelCount);if(D===null){const Tt=lt.reduce((pt,Pt)=>pt+Pt,0),vt=c(st,{channelCount:Math.max(1,Tt),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,Tt)}),mt=[];for(let pt=0;pt<G.numberOfOutputs;pt+=1)mt.push(o(st,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:lt[pt]}));const At=M(st,{channelCount:j.channelCount,channelCountMode:j.channelCountMode,channelInterpretation:j.channelInterpretation,gain:1});At.connect=t.bind(null,mt),At.disconnect=k.bind(null,mt),tt=[vt,mt,At]}else at||(Y=new D(st,q));if(z.set(st,tt===null?Y:tt[2]),tt!==null){if(J===null){if($===void 0)throw new Error("Missing the processor constructor.");if(R===null)throw new Error("Missing the native OfflineAudioContext constructor.");const Pt=G.channelCount*G.numberOfInputs,Nt=$.parameterDescriptors===void 0?0:$.parameterDescriptors.length,qt=Pt+Nt;J=Pd(G,qt===0?null:await(async()=>{const de=new R(qt,128*Math.ceil(G.context.length/128),st.sampleRate),Ze=[],Dt=[];for(let Gt=0;Gt<j.numberOfInputs;Gt+=1)Ze.push(M(de,{channelCount:j.channelCount,channelCountMode:j.channelCountMode,channelInterpretation:j.channelInterpretation,gain:1})),Dt.push(c(de,{channelCount:j.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:j.channelCount}));const ft=await Promise.all(Array.from(G.parameters.values()).map(async Gt=>{const Re=w(de,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Gt.value});return await N(de,Gt,Re.offset),Re})),Qt=o(de,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,Pt+Nt)});for(let Gt=0;Gt<j.numberOfInputs;Gt+=1){Ze[Gt].connect(Dt[Gt]);for(let Re=0;Re<j.channelCount;Re+=1)Dt[Gt].connect(Qt,Re,Gt*j.channelCount+Re)}for(const[Gt,Re]of ft.entries())Re.connect(Qt,0,Pt+Gt),Re.start(0);return Qt.connect(de.destination),await Promise.all(Ze.map(Gt=>V(G,de,Gt))),W(de)})(),st,j,lt,$,P)}const Tt=await J,vt=e(st,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[mt,At,pt]=tt;Tt!==null&&(vt.buffer=Tt,vt.start(0)),vt.connect(mt);for(let Pt=0,Nt=0;Pt<G.numberOfOutputs;Pt+=1){const qt=At[Pt];for(let se=0;se<lt[Pt];se+=1)mt.connect(qt,Nt+se,se);Nt+=lt[Pt]}return pt}if(at)for(const[Tt,vt]of G.parameters.entries())await h(st,vt,Y.parameters.get(Tt));else for(const[Tt,vt]of G.parameters.entries())await N(st,vt,Y.parameters.get(Tt));return await V(G,st,Y),Y})(et,H)}}})(Rs,ah,ei,dn,Wi,si,Xe,tp,lh,na,Yt,ti,Te,Ns,ke,jo),op=(h=>t=>h.get(t))(oh),rp=(h=>(t,e)=>{h.set(t,e)})(ch),hh=ih?((h,t,e,o,c,w,M,C,k,P,I,D,R,N)=>class extends t{constructor(V,W,q){var j;const $=C(V),z=k($),J=(tt=>({...tt,outputChannelCount:tt.outputChannelCount!==void 0?tt.outputChannelCount:tt.numberOfInputs===1&&tt.numberOfOutputs===1?[tt.channelCount]:Array.from({length:tt.numberOfOutputs},()=>1)}))({...Bo,...q});(tt=>{const{port1:at,port2:lt}=new MessageChannel;try{at.postMessage(tt)}finally{at.close(),lt.close()}})(J);const et=A.get($),H=et==null?void 0:et.get(W),Z=z||$.state!=="closed"?$:(j=M($))!==null&&j!==void 0?j:$,G=c(Z,z?null:V.baseLatency,P,W,H,J);super(V,!0,G,z?o(W,J,H):null);const st=[];G.parameters.forEach((tt,at)=>{const lt=e(this,z,tt);st.push([at,lt])}),this._nativeAudioWorkletNode=G,this._onprocessorerror=null,this._parameters=new Fo(st),z&&h($,this);const{activeInputs:Y}=w(this);D(G,Y)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(V){const W=typeof V=="function"?N(this,V):null;this._nativeAudioWorkletNode.onprocessorerror=W;const q=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=q!==null&&q===W?V:q}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(Kf,fe,xs,ip,np,Ht,op,Kt,Ut,ti,0,rp,0,Kn):void 0,ap=((h,t)=>(e,o,c)=>{if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(e,o,c)}catch(w){throw w.name==="SyntaxError"?h():w}})(We,Te),lp=((h,t,e,o,c,w,M,C)=>(k,P)=>e(k).render(k,P).then(()=>Promise.all(Array.from(o(P)).map(I=>e(I).render(I,P)))).then(()=>c(P)).then(I=>(typeof I.copyFromChannel!="function"?(M(I),dt(I)):t(w,()=>w(I))||C(I),h.add(I),I)))(Kr,us,Zr,ia,jo,ut,ea,sa),cp=((h,t,e,o,c)=>class extends h{constructor(w,M,C){let k;if(typeof w=="number"&&M!==void 0&&C!==void 0)k={length:M,numberOfChannels:w,sampleRate:C};else{if(typeof w!="object")throw new Error("The given parameters are not valid.");k=w}const{length:P,numberOfChannels:I,sampleRate:D}={...Wd,...k},R=o(I,P,D);t(zi,()=>zi(R))||R.addEventListener("statechange",(()=>{let N=0;const V=W=>{this._state==="running"&&(N>0?(R.removeEventListener("statechange",V),W.stopImmediatePropagation(),this._waitForThePromiseToSettle(W)):N+=1)};return V})()),super(R,I),this._length=P,this._nativeOfflineAudioContext=R,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(e()):(this._state="running",c(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,ts(this)}))}_waitForThePromiseToSettle(w){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(w):setTimeout(()=>this._waitForThePromiseToSettle(w))}})(rh,us,Se,ap,lp),hp=((h,t)=>e=>{const o=h.get(e);return t(o)||t(e)})(b,Qr),up=((h,t)=>e=>h.has(e)||t(e))(_,Jr),dp=((h,t)=>e=>h.has(e)||t(e))(f,jc),fp=((h,t)=>e=>{const o=h.get(e);return t(o)||t(e)})(b,Ut),pp=()=>(async(h,t,e,o,c,w,M,C,k,P,I,D,R,N,V,W)=>!!(h(t,t)&&h(e,e)&&h(c,c)&&h(w,w)&&h(C,C)&&h(k,k)&&h(P,P)&&h(I,I)&&h(D,D)&&h(R,R)&&h(N,N))&&(await Promise.all([h(o,o),h(M,M),h(V,V),h(W,W)])).every(q=>q))(us,(h=>()=>{if(h===null)return!1;const t=new h(1,1,44100).createBuffer(1,1,44100);if(t.copyToChannel===void 0)return!0;const e=new Float32Array(2);try{t.copyFromChannel(e,0,0)}catch{return!1}return!0})(Te),(h=>()=>{if(h===null)return!1;if(h.prototype!==void 0&&h.prototype.close!==void 0)return!0;const t=new h,e=t.close!==void 0;try{t.close()}catch{}return e})(hn),(h=>()=>{if(h===null)return Promise.resolve(!1);const t=new h(1,1,44100);return new Promise(e=>{let o=!0;const c=M=>{o&&(o=!1,t.startRendering(),e(M instanceof TypeError))};let w;try{w=t.decodeAudioData(null,()=>{},c)}catch(M){c(M)}w!==void 0&&w.catch(c)})})(Te),(h=>()=>{if(h===null)return!1;let t;try{t=new h({latencyHint:"balanced"})}catch{return!1}return t.close(),!0})(hn),(h=>()=>{if(h===null)return!1;const t=new h(1,1,44100).createGain(),e=t.connect(t)===t;return t.disconnect(t),e})(Te),((h,t)=>async()=>{if(h===null)return!0;if(t===null)return!1;const e=new Blob(['let c,p;class A extends AudioWorkletProcessor{constructor(){super();this.port.onmessage=(e)=>{p=e.data;p.onmessage=()=>{p.postMessage(c);p.close()};this.port.postMessage(0)}}process(){c=1}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),o=new MessageChannel,c=new t(1,128,44100),w=URL.createObjectURL(e);let M=!1;try{await c.audioWorklet.addModule(w);const C=new h(c,"a",{numberOfOutputs:0}),k=c.createOscillator();await new Promise(P=>{C.port.onmessage=()=>P(),C.port.postMessage(o.port2,[o.port2])}),C.port.onmessage=()=>M=!0,k.connect(C),k.start(0),await c.startRendering(),M=await new Promise(P=>{o.port1.onmessage=({data:I})=>P(I===1),o.port1.postMessage(0)})}catch{}finally{o.port1.close(),URL.revokeObjectURL(w)}return M})(ti,Te),(h=>()=>{if(h===null)return!1;const t=new h(1,1,44100).createChannelMerger();if(t.channelCountMode==="max")return!0;try{t.channelCount=2}catch{return!0}return!1})(Te),(h=>()=>{if(h===null)return!1;const t=new h(1,1,44100);return t.createConstantSource===void 0||t.createConstantSource().offset.maxValue!==Number.POSITIVE_INFINITY})(Te),(h=>()=>{if(h===null)return!1;const t=new h(1,1,44100),e=t.createConvolver();e.buffer=t.createBuffer(1,1,t.sampleRate);try{e.buffer=t.createBuffer(1,1,t.sampleRate)}catch{return!1}return!0})(Te),(h=>()=>{if(h===null)return!1;const t=new h(1,1,44100).createConvolver();try{t.channelCount=1}catch{return!1}return!0})(Te),Xd,(h=>()=>h!==null&&h.hasOwnProperty("isSecureContext"))(ws),(h=>()=>{if(h===null)return!1;const t=new h;try{return t.createMediaStreamSource(new MediaStream),!1}catch{return!0}finally{t.close()}})(hn),(h=>()=>{if(h===null)return Promise.resolve(!1);const t=new h(1,1,44100);if(t.createStereoPanner===void 0||t.createConstantSource===void 0)return Promise.resolve(!0);const e=t.createConstantSource(),o=t.createStereoPanner();return e.channelCount=1,e.offset.value=1,o.channelCount=1,e.start(),e.connect(o).connect(t.destination),t.startRendering().then(c=>c.getChannelData(0)[0]!==1)})(Te),Yd);function Ye(h){return h===void 0}function Et(h){return h!==void 0}function uh(h){return typeof h=="function"}function es(h){return typeof h=="number"}function Zs(h){return Object.prototype.toString.call(h)==="[object Object]"&&h.constructor===Object}function oa(h){return typeof h=="boolean"}function Pe(h){return Array.isArray(h)}function Ss(h){return typeof h=="string"}function Gi(h){return Ss(h)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(h)}function bt(h,t){if(!h)throw new Error(t)}function Ee(h,t,e=1/0){if(!(t<=h&&h<=e))throw new RangeError(`Value must be within [${t}, ${e}], got: ${h}`)}function ra(h){h.isOffline||h.state==="running"||ni('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let dh=!1,fh=!1;function aa(h){dh=h}function ph(h){Ye(h)&&dh&&!fh&&(fh=!0,ni("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let la=console;function mp(h){la=h}function mh(...h){la.log(...h)}function ni(...h){la.warn(...h)}const ss=typeof self=="object"?self:null,gp=ss&&(ss.hasOwnProperty("AudioContext")||ss.hasOwnProperty("webkitAudioContext"));function Ts(h,t,e,o){var c,w=arguments.length,M=w<3?t:o;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")M=Reflect.decorate(h,t,e,o);else for(var C=h.length-1;C>=0;C--)(c=h[C])&&(M=(w<3?c(M):w>3?c(t,e,M):c(t,e))||M);return w>3&&M&&Object.defineProperty(t,e,M),M}function Zt(h,t,e,o){return new(e||(e=Promise))(function(c,w){function M(P){try{k(o.next(P))}catch(I){w(I)}}function C(P){try{k(o.throw(P))}catch(I){w(I)}}function k(P){var I;P.done?c(P.value):(I=P.value,I instanceof e?I:new e(function(D){D(I)})).then(M,C)}k((o=o.apply(h,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;class vp{constructor(t,e,o,c){this._callback=t,this._type=e,this._minimumUpdateInterval=Math.max(128/(c||44100),.001),this.updateInterval=o,this._createClock()}_createWorker(){const t=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),e=URL.createObjectURL(t),o=new Worker(e);o.onmessage=this._callback.bind(this),this._worker=o}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},1e3*this._updateInterval)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(t){var e;this._updateInterval=Math.max(t,this._minimumUpdateInterval),this._type==="worker"&&((e=this._worker)===null||e===void 0||e.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(t){this._disposeClock(),this._type=t,this._createClock()}dispose(){this._disposeClock()}}function Cn(h){return dp(h)}function fn(h){return up(h)}function Ho(h){return fp(h)}function ii(h){return hp(h)}function yp(h,t){return h==="value"||Cn(t)||fn(t)||function(e){return e instanceof Xc}(t)}function ds(h,...t){if(!t.length)return h;const e=t.shift();if(Zs(h)&&Zs(e))for(const o in e)yp(o,e[o])?h[o]=e[o]:Zs(e[o])?(h[o]||Object.assign(h,{[o]:{}}),ds(h[o],e[o])):Object.assign(h,{[o]:e[o]});return ds(h,...t)}function K(h,t,e=[],o){const c={},w=Array.from(t);if(Zs(w[0])&&o&&!Reflect.has(w[0],o)&&(Object.keys(w[0]).some(M=>Reflect.has(h,M))||(ds(c,{[o]:w[0]}),e.splice(e.indexOf(o),1),w.shift())),w.length===1&&Zs(w[0]))ds(c,w[0]);else for(let M=0;M<e.length;M++)Et(w[M])&&(c[e[M]]=w[M]);return ds(h,c)}function fs(h,t){return Ye(h)?t:h}function Ie(h,t){return t.forEach(e=>{Reflect.has(h,e)&&delete h[e]}),h}class Qs{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...t){(this.debug||ss&&this.toString()===ss.TONE_DEBUG_CLASS)&&mh(this,...t)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}Qs.version=v;const ca=1e-6;function oi(h,t){return h>t+ca}function ha(h,t){return oi(h,t)||Ms(h,t)}function Uo(h,t){return h+ca<t}function Ms(h,t){return Math.abs(h-t)<ca}function An(h,t,e){return Math.max(Math.min(h,e),t)}class ns extends Qs{constructor(){super(),this.name="Timeline",this._timeline=[];const t=K(ns.getDefaults(),arguments,["memory"]);this.memory=t.memory,this.increasing=t.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(t){if(bt(Reflect.has(t,"time"),"Timeline: events must have a time attribute"),t.time=t.time.valueOf(),this.increasing&&this.length){const e=this._timeline[this.length-1];bt(ha(t.time,e.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(t)}else{const e=this._search(t.time);this._timeline.splice(e+1,0,t)}if(this.length>this.memory){const e=this.length-this.memory;this._timeline.splice(0,e)}return this}remove(t){const e=this._timeline.indexOf(t);return e!==-1&&this._timeline.splice(e,1),this}get(t,e="time"){const o=this._search(t,e);return o!==-1?this._timeline[o]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(t,e="time"){const o=this._search(t,e);return o+1<this._timeline.length?this._timeline[o+1]:null}getBefore(t){const e=this._timeline.length;if(e>0&&this._timeline[e-1].time<t)return this._timeline[e-1];const o=this._search(t);return o-1>=0?this._timeline[o-1]:null}cancel(t){if(this._timeline.length>1){let e=this._search(t);if(e>=0)if(Ms(this._timeline[e].time,t)){for(let o=e;o>=0&&Ms(this._timeline[o].time,t);o--)e=o;this._timeline=this._timeline.slice(0,e)}else this._timeline=this._timeline.slice(0,e+1);else this._timeline=[]}else this._timeline.length===1&&ha(this._timeline[0].time,t)&&(this._timeline=[]);return this}cancelBefore(t){const e=this._search(t);return e>=0&&(this._timeline=this._timeline.slice(e+1)),this}previousEvent(t){const e=this._timeline.indexOf(t);return e>0?this._timeline[e-1]:null}_search(t,e="time"){if(this._timeline.length===0)return-1;let o=0;const c=this._timeline.length;let w=c;if(c>0&&this._timeline[c-1][e]<=t)return c-1;for(;o<w;){let M=Math.floor(o+(w-o)/2);const C=this._timeline[M],k=this._timeline[M+1];if(Ms(C[e],t)){for(let P=M;P<this._timeline.length&&Ms(this._timeline[P][e],t);P++)M=P;return M}if(Uo(C[e],t)&&oi(k[e],t))return M;oi(C[e],t)?w=M:o=M+1}return-1}_iterate(t,e=0,o=this._timeline.length-1){this._timeline.slice(e,o+1).forEach(t)}forEach(t){return this._iterate(t),this}forEachBefore(t,e){const o=this._search(t);return o!==-1&&this._iterate(e,0,o),this}forEachAfter(t,e){const o=this._search(t);return this._iterate(e,o+1),this}forEachBetween(t,e,o){let c=this._search(t),w=this._search(e);return c!==-1&&w!==-1?(this._timeline[c].time!==t&&(c+=1),this._timeline[w].time===e&&(w-=1),this._iterate(o,c,w)):c===-1&&this._iterate(o,0,w),this}forEachFrom(t,e){let o=this._search(t);for(;o>=0&&this._timeline[o].time>=t;)o--;return this._iterate(e,o+1),this}forEachAtTime(t,e){const o=this._search(t);if(o!==-1&&Ms(this._timeline[o].time,t)){let c=o;for(let w=o;w>=0&&Ms(this._timeline[w].time,t);w--)c=w;this._iterate(w=>{e(w)},c,o)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const gh=[];function Xo(h){gh.push(h)}const vh=[];function Yo(h){vh.push(h)}class ri extends Qs{constructor(){super(...arguments),this.name="Emitter"}on(t,e){return t.split(/\W+/).forEach(o=>{Ye(this._events)&&(this._events={}),this._events.hasOwnProperty(o)||(this._events[o]=[]),this._events[o].push(e)}),this}once(t,e){const o=(...c)=>{e(...c),this.off(t,o)};return this.on(t,o),this}off(t,e){return t.split(/\W+/).forEach(o=>{if(Ye(this._events)&&(this._events={}),this._events.hasOwnProperty(o))if(Ye(e))this._events[o]=[];else{const c=this._events[o];for(let w=c.length-1;w>=0;w--)c[w]===e&&c.splice(w,1)}}),this}emit(t,...e){if(this._events&&this._events.hasOwnProperty(t)){const o=this._events[t].slice(0);for(let c=0,w=o.length;c<w;c++)o[c].apply(this,e)}return this}static mixin(t){["on","once","off","emit"].forEach(e=>{const o=Object.getOwnPropertyDescriptor(ri.prototype,e);Object.defineProperty(t.prototype,e,o)})}dispose(){return super.dispose(),this._events=void 0,this}}class ua extends ri{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class ai extends ua{constructor(){var t,e;super(),this.name="Context",this._constants=new Map,this._timeouts=new ns,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const o=K(ai.getDefaults(),arguments,["context"]);o.context?(this._context=o.context,this._latencyHint=((t=arguments[0])===null||t===void 0?void 0:t.latencyHint)||""):(this._context=function(c){return new Jf(c)}({latencyHint:o.latencyHint}),this._latencyHint=o.latencyHint),this._ticker=new vp(this.emit.bind(this,"tick"),o.clockSource,o.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((e=arguments[0])===null||e===void 0)&&e.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=o.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var t;return this._initialized||(t=this,gh.forEach(e=>e(t)),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(t,e,o){return this._context.createBuffer(t,e,o)}createChannelMerger(t){return this._context.createChannelMerger(t)}createChannelSplitter(t){return this._context.createChannelSplitter(t)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(t){return this._context.createDelay(t)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(t,e){return this._context.createIIRFilter(t,e)}createPanner(){return this._context.createPanner()}createPeriodicWave(t,e,o){return this._context.createPeriodicWave(t,e,o)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(t){return bt(ii(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(t)}createMediaElementSource(t){return bt(ii(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(t)}createMediaStreamDestination(){return bt(ii(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(t){return this._context.decodeAudioData(t)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(t){bt(!this._initialized,"The listener cannot be set after initialization."),this._listener=t}get transport(){return this.initialize(),this._transport}set transport(t){bt(!this._initialized,"The transport cannot be set after initialization."),this._transport=t}get draw(){return this.initialize(),this._draw}set draw(t){bt(!this._initialized,"Draw cannot be set after initialization."),this._draw=t}get destination(){return this.initialize(),this._destination}set destination(t){bt(!this._initialized,"The destination cannot be set after initialization."),this._destination=t}createAudioWorkletNode(t,e){return function(o,c,w){return bt(Et(hh),"AudioWorkletNode only works in a secure context (https or localhost)"),new(o instanceof(ss==null?void 0:ss.BaseAudioContext)?ss==null?void 0:ss.AudioWorkletNode:hh)(o,c,w)}(this.rawContext,t,e)}addAudioWorkletModule(t){return Zt(this,void 0,void 0,function*(){bt(Et(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(t)),yield this._workletPromise})}workletsAreReady(){return Zt(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(t){this._ticker.updateInterval=t}get clockSource(){return this._ticker.type}set clockSource(t){this._ticker.type=t}get lookAhead(){return this._lookAhead}set lookAhead(t){this._lookAhead=t,this.updateInterval=t?t/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return ii(this._context)?this._context.resume():Promise.resolve()}close(){return Zt(this,void 0,void 0,function*(){var t;ii(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(t=this,vh.forEach(e=>e(t)))})}getConstant(t){if(this._constants.has(t))return this._constants.get(t);{const e=this._context.createBuffer(1,128,this._context.sampleRate),o=e.getChannelData(0);for(let w=0;w<o.length;w++)o[w]=t;const c=this._context.createBufferSource();return c.channelCount=1,c.channelCountMode="explicit",c.buffer=e,c.loop=!0,c.start(0),this._constants.set(t,c),c}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(t=>this._constants[t].disconnect()),this.close(),this}_timeoutLoop(){const t=this.now();let e=this._timeouts.peek();for(;this._timeouts.length&&e&&e.time<=t;)e.callback(),this._timeouts.shift(),e=this._timeouts.peek()}setTimeout(t,e){this._timeoutIds++;const o=this.now();return this._timeouts.add({callback:t,id:this._timeoutIds,time:o+e}),this._timeoutIds}clearTimeout(t){return this._timeouts.forEach(e=>{e.id===t&&this._timeouts.remove(e)}),this}clearInterval(t){return this.clearTimeout(t)}setInterval(t,e){const o=++this._timeoutIds,c=()=>{const w=this.now();this._timeouts.add({callback:()=>{t(),c()},id:o,time:w+e})};return c(),o}}function xt(h,t){Pe(t)?t.forEach(e=>xt(h,e)):Object.defineProperty(h,t,{enumerable:!0,writable:!1})}function Hi(h,t){Pe(t)?t.forEach(e=>Hi(h,e)):Object.defineProperty(h,t,{writable:!0})}const Ot=()=>{};class Ft extends Qs{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Ot;const t=K(Ft.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=t.reverse,this.onload=t.onload,Ss(t.url)?this.load(t.url).catch(t.onerror):t.url&&this.set(t.url)}static getDefaults(){return{onerror:Ot,onload:Ot,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:ee().sampleRate}set(t){return t instanceof Ft?t.loaded?this._buffer=t.get():t.onload=()=>{this.set(t),this.onload(this)}:this._buffer=t,this._reversed&&this._reverse(),this}get(){return this._buffer}load(t){return Zt(this,void 0,void 0,function*(){const e=Ft.load(t).then(o=>{this.set(o),this.onload(this)});Ft.downloads.push(e);try{yield e}finally{const o=Ft.downloads.indexOf(e);Ft.downloads.splice(o,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(t){const e=Pe(t)&&t[0].length>0,o=e?t.length:1,c=e?t[0].length:t.length,w=ee(),M=w.createBuffer(o,c,w.sampleRate),C=e||o!==1?t:[t];for(let k=0;k<o;k++)M.copyToChannel(C[k],k);return this._buffer=M,this}toMono(t){if(es(t))this.fromArray(this.toArray(t));else{let e=new Float32Array(this.length);const o=this.numberOfChannels;for(let c=0;c<o;c++){const w=this.toArray(c);for(let M=0;M<w.length;M++)e[M]+=w[M]}e=e.map(c=>c/o),this.fromArray(e)}return this}toArray(t){if(es(t))return this.getChannelData(t);if(this.numberOfChannels===1)return this.toArray(0);{const e=[];for(let o=0;o<this.numberOfChannels;o++)e[o]=this.getChannelData(o);return e}}getChannelData(t){return this._buffer?this._buffer.getChannelData(t):new Float32Array(0)}slice(t,e=this.duration){bt(this.loaded,"Buffer is not loaded");const o=Math.floor(t*this.sampleRate),c=Math.floor(e*this.sampleRate);bt(o<c,"The start time must be less than the end time");const w=c-o,M=ee().createBuffer(this.numberOfChannels,w,this.sampleRate);for(let C=0;C<this.numberOfChannels;C++)M.copyToChannel(this.getChannelData(C).subarray(o,c),C);return new Ft(M)}_reverse(){if(this.loaded)for(let t=0;t<this.numberOfChannels;t++)this.getChannelData(t).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(t){this._reversed!==t&&(this._reversed=t,this._reverse())}static fromArray(t){return new Ft().fromArray(t)}static fromUrl(t){return Zt(this,void 0,void 0,function*(){return yield new Ft().load(t)})}static load(t){return Zt(this,void 0,void 0,function*(){const e=t.match(/\[([^\]\[]+\|.+)\]$/);if(e){const C=e[1].split("|");let k=C[0];for(const P of C)if(Ft.supportsType(P)){k=P;break}t=t.replace(e[0],k)}const o=Ft.baseUrl===""||Ft.baseUrl.endsWith("/")?Ft.baseUrl:Ft.baseUrl+"/",c=document.createElement("a");c.href=o+t,c.pathname=(c.pathname+c.hash).split("/").map(encodeURIComponent).join("/");const w=yield fetch(c.href);if(!w.ok)throw new Error(`could not load url: ${t}`);const M=yield w.arrayBuffer();return yield ee().decodeAudioData(M)})}static supportsType(t){const e=t.split("."),o=e[e.length-1];return document.createElement("audio").canPlayType("audio/"+o)!==""}static loaded(){return Zt(this,void 0,void 0,function*(){for(yield Promise.resolve();Ft.downloads.length;)yield Ft.downloads[0]})}}Ft.baseUrl="",Ft.downloads=[];class li extends ai{constructor(){var t,e,o;super({clockSource:"offline",context:Ho(arguments[0])?arguments[0]:(t=arguments[0],e=arguments[1]*arguments[2],o=arguments[2],new cp(t,e,o)),lookAhead:0,updateInterval:Ho(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Ho(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(t){return Zt(this,void 0,void 0,function*(){let e=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,e++;const o=Math.floor(this.sampleRate/128);t&&e%o==0&&(yield new Promise(c=>setTimeout(c,1)))}})}render(){return Zt(this,arguments,void 0,function*(t=!0){yield this.workletsAreReady(),yield this._renderClock(t);const e=yield this._context.startRendering();return new Ft(e)})}close(){return Promise.resolve()}}const yh=new class extends ua{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(h,t,e){return{}}createChannelMerger(h){return{}}createChannelSplitter(h){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(h){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(h,t){return{}}createPanner(){return{}}createPeriodicWave(h,t,e){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(h){return{}}createMediaElementSource(h){return{}}createMediaStreamDestination(){return{}}decodeAudioData(h){return Promise.resolve({})}createAudioWorkletNode(h,t){return{}}get rawContext(){return{}}addAudioWorkletModule(h){return Zt(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(h,t){return 0}clearTimeout(h){return this}setInterval(h,t){return 0}clearInterval(h){return this}getConstant(h){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(h){}get destination(){return{}}set destination(h){}now(){return 0}immediate(){return 0}};let Ui=yh;function ee(){return Ui===yh&&gp&&Zo(new ai),Ui}function Zo(h,t=!1){t&&Ui.dispose(),Ui=ii(h)?new ai(h):Ho(h)?new li(h):h}function bp(){return Ui.resume()}if(ss&&!ss.TONE_SILENCE_LOGGING){const t=` * Tone.js v${v} * `;console.log(`%c${t}`,"background: #000; color: #fff")}function ci(h){return Math.pow(10,h/20)}function Xi(h){return Math.log(h)/Math.LN10*20}function hi(h){return Math.pow(2,h/12)}let Qo=440;function pn(h){return Math.round(bh(h))}function bh(h){return 69+12*Math.log2(h/Qo)}function da(h){return Qo*Math.pow(2,(h-69)/12)}class fa extends Qs{constructor(t,e,o){super(),this.defaultUnits="s",this._val=e,this._units=o,this.context=t,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:t=>this._frequencyToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:t=>this._ticksToUnits(parseInt(t,10)),regexp:/^(\d+)i$/i},m:{method:t=>this._beatsToUnits(parseInt(t,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(t,e)=>{const o=parseInt(t,10),c=e==="."?1.5:1;return o===1?this._beatsToUnits(this._getTimeSignature())*c:this._beatsToUnits(4/o)*c},regexp:/^(\d+)n(\.?)$/i},number:{method:t=>this._expressions[this.defaultUnits].method.call(this,t),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:t=>this._secondsToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:t=>parseInt(t,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:t=>{const e=parseInt(t,10);return this._beatsToUnits(8/(3*Math.floor(e)))},regexp:/^(\d+)t$/i},tr:{method:(t,e,o)=>{let c=0;return t&&t!=="0"&&(c+=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),e&&e!=="0"&&(c+=this._beatsToUnits(parseFloat(e))),o&&o!=="0"&&(c+=this._beatsToUnits(parseFloat(o)/4)),c},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof fa&&this.fromType(this._val),Ye(this._val))return this._noArg();if(Ss(this._val)&&Ye(this._units)){for(const t in this._expressions)if(this._expressions[t].regexp.test(this._val.trim())){this._units=t;break}}else if(Zs(this._val)){let t=0;for(const e in this._val)if(Et(this._val[e])){const o=this._val[e];t+=new this.constructor(this.context,e).valueOf()*o}return t}if(Et(this._units)){const t=this._expressions[this._units],e=this._val.toString().trim().match(t.regexp);return e?t.method.apply(this,e.slice(1)):t.method.call(this,this._val)}return Ss(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(t){return 1/t}_beatsToUnits(t){return 60/this._getBpm()*t}_secondsToUnits(t){return t}_ticksToUnits(t){return t*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(t){switch(this._units=void 0,this.defaultUnits){case"s":this._val=t.toSeconds();break;case"i":this._val=t.toTicks();break;case"hz":this._val=t.toFrequency();break;case"midi":this._val=t.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class is extends fa{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:t=>this._now()+new this.constructor(this.context,t).valueOf(),regexp:/^\+(.+)/},quantize:{method:t=>{const e=new is(this.context,t).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(e))},regexp:/^@(.+)/}})}quantize(t,e=1){const o=new this.constructor(this.context,t).valueOf(),c=this.valueOf();return c+(Math.round(c/o)*o-c)*e}toNotation(){const t=this.toSeconds(),e=["1m"];for(let w=1;w<9;w++){const M=Math.pow(2,w);e.push(M+"n."),e.push(M+"n"),e.push(M+"t")}e.push("0");let o=e[0],c=new is(this.context,e[0]).toSeconds();return e.forEach(w=>{const M=new is(this.context,w).toSeconds();Math.abs(M-t)<Math.abs(c-t)&&(o=w,c=M)}),o}toBarsBeatsSixteenths(){const t=this._beatsToUnits(1);let e=this.valueOf()/t;e=parseFloat(e.toFixed(4));const o=Math.floor(e/this._getTimeSignature());let c=e%1*4;e=Math.floor(e)%this._getTimeSignature();const w=c.toString();return w.length>3&&(c=parseFloat(parseFloat(w).toFixed(3))),[o,e,c].join(":")}toTicks(){const t=this._beatsToUnits(1);return this.valueOf()/t*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return pn(this.toFrequency())}_now(){return this.context.now()}}function _p(h,t){return new is(ee(),h,t)}class Ve extends is{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Qo}static set A4(t){(function(e){Qo=e})(t)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(t){return this.defaultUnits==="midi"?t:Ve.mtof(t)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(t,e){const o=wp[t.toLowerCase()]+12*(parseInt(e,10)+1);return this.defaultUnits==="midi"?o:Ve.mtof(o)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(t,e,o){let c=1;return t&&t!=="0"&&(c*=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),e&&e!=="0"&&(c*=this._beatsToUnits(parseFloat(e))),o&&o!=="0"&&(c*=this._beatsToUnits(parseFloat(o)/4)),c}}})}transpose(t){return new Ve(this.context,this.valueOf()*hi(t))}harmonize(t){return t.map(e=>this.transpose(e))}toMidi(){return pn(this.valueOf())}toNote(){const t=this.toFrequency(),e=Math.log2(t/Ve.A4);let o=Math.round(12*e)+57;const c=Math.floor(o/12);return c<0&&(o+=-12*c),xp[o%12]+c.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const t=this._beatsToUnits(1),e=this.valueOf()/t;return Math.floor(e*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(t){return t}_ticksToUnits(t){return 1/(60*t/(this._getBpm()*this._getPPQ()))}_beatsToUnits(t){return 1/super._beatsToUnits(t)}_secondsToUnits(t){return 1/t}static mtof(t){return da(t)}static ftom(t){return pn(t)}}const wp={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},xp=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function Sp(h,t){return new Ve(ee(),h,t)}class me extends is{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}function Tp(h,t){return new me(ee(),h,t)}class Me extends Qs{constructor(){super();const t=K(Me.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=t.context}static getDefaults(){return{context:ee()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(t){return ph(t),new is(this.context,t).toSeconds()}toFrequency(t){return new Ve(this.context,t).toFrequency()}toTicks(t){return new me(this.context,t).toTicks()}_getPartialProperties(t){const e=this.get();return Object.keys(e).forEach(o=>{Ye(t[o])&&delete e[o]}),e}get(){const t=this.constructor.getDefaults();return Object.keys(t).forEach(e=>{if(Reflect.has(this,e)){const o=this[e];Et(o)&&Et(o.value)&&Et(o.setValueAtTime)?t[e]=o.value:o instanceof Me?t[e]=o._getPartialProperties(t[e]):Pe(o)||es(o)||Ss(o)||oa(o)?t[e]=o:delete t[e]}}),t}set(t){return Object.keys(t).forEach(e=>{Reflect.has(this,e)&&Et(this[e])&&(this[e]&&Et(this[e].value)&&Et(this[e].setValueAtTime)?this[e].value!==t[e]&&(this[e].value=t[e]):this[e]instanceof Me?this[e].set(t[e]):this[e]=t[e])}),this}}class ui extends ns{constructor(t="stopped"){super(),this.name="StateTimeline",this._initial=t,this.setStateAtTime(this._initial,0)}getValueAtTime(t){const e=this.get(t);return e!==null?e.state:this._initial}setStateAtTime(t,e,o){return Ee(e,0),this.add(Object.assign({},o,{state:t,time:e})),this}getLastState(t,e){for(let o=this._search(e);o>=0;o--){const c=this._timeline[o];if(c.state===t)return c}}getNextState(t,e){const o=this._search(e);if(o!==-1)for(let c=o;c<this._timeline.length;c++){const w=this._timeline[c];if(w.state===t)return w}}}class Ct extends Me{constructor(){const t=K(Ct.getDefaults(),arguments,["param","units","convert"]);for(super(t),this.name="Param",this.overridden=!1,this._minOutput=1e-7,bt(Et(t.param)&&(Cn(t.param)||t.param instanceof Ct),"param must be an AudioParam");!Cn(t.param);)t.param=t.param._param;this._swappable=!!Et(t.swappable)&&t.swappable,this._swappable?(this.input=this.context.createGain(),this._param=t.param,this.input.connect(this._param)):this._param=this.input=t.param,this._events=new ns(1e3),this._initialValue=this._param.defaultValue,this.units=t.units,this.convert=t.convert,this._minValue=t.minValue,this._maxValue=t.maxValue,Et(t.value)&&t.value!==this._toType(this._initialValue)&&this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Me.getDefaults(),{convert:!0,units:"number"})}get value(){const t=this.now();return this.getValueAtTime(t)}set value(t){this.cancelScheduledValues(this.now()),this.setValueAtTime(t,this.now())}get minValue(){return Et(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return Et(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(t,e){return this.units===e}_assertRange(t){return Et(this.maxValue)&&Et(this.minValue)&&Ee(t,this._fromType(this.minValue),this._fromType(this.maxValue)),t}_fromType(t){return this.convert&&!this.overridden?this._is(t,"time")?this.toSeconds(t):this._is(t,"decibels")?ci(t):this._is(t,"frequency")?this.toFrequency(t):t:this.overridden?0:t}_toType(t){return this.convert&&this.units==="decibels"?Xi(t):t}setValueAtTime(t,e){const o=this.toSeconds(e),c=this._fromType(t);return bt(isFinite(c)&&isFinite(o),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._assertRange(c),this.log(this.units,"setValueAtTime",t,o),this._events.add({time:o,type:"setValueAtTime",value:c}),this._param.setValueAtTime(c,o),this}getValueAtTime(t){const e=Math.max(this.toSeconds(t),0),o=this._events.getAfter(e),c=this._events.get(e);let w=this._initialValue;if(c===null)w=this._initialValue;else if(c.type!=="setTargetAtTime"||o!==null&&o.type!=="setValueAtTime")if(o===null)w=c.value;else if(o.type==="linearRampToValueAtTime"||o.type==="exponentialRampToValueAtTime"){let M=c.value;if(c.type==="setTargetAtTime"){const C=this._events.getBefore(c.time);M=C===null?this._initialValue:C.value}w=o.type==="linearRampToValueAtTime"?this._linearInterpolate(c.time,M,o.time,o.value,e):this._exponentialInterpolate(c.time,M,o.time,o.value,e)}else w=c.value;else{const M=this._events.getBefore(c.time);let C;C=M===null?this._initialValue:M.value,c.type==="setTargetAtTime"&&(w=this._exponentialApproach(c.time,C,c.value,c.constant,e))}return this._toType(w)}setRampPoint(t){t=this.toSeconds(t);let e=this.getValueAtTime(t);return this.cancelAndHoldAtTime(t),this._fromType(e)===0&&(e=this._toType(this._minOutput)),this.setValueAtTime(e,t),this}linearRampToValueAtTime(t,e){const o=this._fromType(t),c=this.toSeconds(e);return bt(isFinite(o)&&isFinite(c),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._assertRange(o),this._events.add({time:c,type:"linearRampToValueAtTime",value:o}),this.log(this.units,"linearRampToValueAtTime",t,c),this._param.linearRampToValueAtTime(o,c),this}exponentialRampToValueAtTime(t,e){let o=this._fromType(t);o=Ms(o,0)?this._minOutput:o,this._assertRange(o);const c=this.toSeconds(e);return bt(isFinite(o)&&isFinite(c),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._events.add({time:c,type:"exponentialRampToValueAtTime",value:o}),this.log(this.units,"exponentialRampToValueAtTime",t,c),this._param.exponentialRampToValueAtTime(o,c),this}exponentialRampTo(t,e,o){return o=this.toSeconds(o),this.setRampPoint(o),this.exponentialRampToValueAtTime(t,o+this.toSeconds(e)),this}linearRampTo(t,e,o){return o=this.toSeconds(o),this.setRampPoint(o),this.linearRampToValueAtTime(t,o+this.toSeconds(e)),this}targetRampTo(t,e,o){return o=this.toSeconds(o),this.setRampPoint(o),this.exponentialApproachValueAtTime(t,o,e),this}exponentialApproachValueAtTime(t,e,o){e=this.toSeconds(e),o=this.toSeconds(o);const c=Math.log(o+1)/Math.log(200);return this.setTargetAtTime(t,e,c),this.cancelAndHoldAtTime(e+.9*o),this.linearRampToValueAtTime(t,e+o),this}setTargetAtTime(t,e,o){const c=this._fromType(t);bt(isFinite(o)&&o>0,"timeConstant must be a number greater than 0");const w=this.toSeconds(e);return this._assertRange(c),bt(isFinite(c)&&isFinite(w),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(t)}, ${JSON.stringify(e)}`),this._events.add({constant:o,time:w,type:"setTargetAtTime",value:c}),this.log(this.units,"setTargetAtTime",t,w,o),this._param.setTargetAtTime(c,w,o),this}setValueCurveAtTime(t,e,o,c=1){o=this.toSeconds(o),e=this.toSeconds(e);const w=this._fromType(t[0])*c;this.setValueAtTime(this._toType(w),e);const M=o/(t.length-1);for(let C=1;C<t.length;C++){const k=this._fromType(t[C])*c;this.linearRampToValueAtTime(this._toType(k),e+C*M)}return this}cancelScheduledValues(t){const e=this.toSeconds(t);return bt(isFinite(e),`Invalid argument to cancelScheduledValues: ${JSON.stringify(t)}`),this._events.cancel(e),this._param.cancelScheduledValues(e),this.log(this.units,"cancelScheduledValues",e),this}cancelAndHoldAtTime(t){const e=this.toSeconds(t),o=this._fromType(this.getValueAtTime(e));bt(isFinite(e),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(t)}`),this.log(this.units,"cancelAndHoldAtTime",e,"value="+o);const c=this._events.get(e),w=this._events.getAfter(e);return c&&Ms(c.time,e)?w?(this._param.cancelScheduledValues(w.time),this._events.cancel(w.time)):(this._param.cancelAndHoldAtTime(e),this._events.cancel(e+this.sampleTime)):w&&(this._param.cancelScheduledValues(w.time),this._events.cancel(w.time),w.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(o),e):w.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(o),e)),this._events.add({time:e,type:"setValueAtTime",value:o}),this._param.setValueAtTime(o,e),this}rampTo(t,e=.1,o){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(t,e,o):this.linearRampTo(t,e,o),this}apply(t){const e=this.context.currentTime;t.setValueAtTime(this.getValueAtTime(e),e);const o=this._events.get(e);if(o&&o.type==="setTargetAtTime"){const c=this._events.getAfter(o.time),w=c?c.time:e+2,M=(w-e)/10;for(let C=e;C<w;C+=M)t.linearRampToValueAtTime(this.getValueAtTime(C),C)}return this._events.forEachAfter(this.context.currentTime,c=>{c.type==="cancelScheduledValues"?t.cancelScheduledValues(c.time):c.type==="setTargetAtTime"?t.setTargetAtTime(c.value,c.time,c.constant):t[c.type](c.value,c.time)}),this}setParam(t){bt(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const e=this.input;return e.disconnect(this._param),this.apply(t),this._param=t,e.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(t,e,o,c,w){return o+(e-o)*Math.exp(-(w-t)/c)}_linearInterpolate(t,e,o,c,w){return e+(w-t)/(o-t)*(c-e)}_exponentialInterpolate(t,e,o,c,w){return e*Math.pow(c/e,(w-t)/(o-t))}}class it extends Me{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return Et(this.input)?Cn(this.input)||this.input instanceof Ct?1:this.input.numberOfInputs:0}get numberOfOutputs(){return Et(this.output)?this.output.numberOfOutputs:0}_isAudioNode(t){return Et(t)&&(t instanceof it||fn(t))}_getInternalNodes(){const t=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&t.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&t.push(this.output),t}_setChannelProperties(t){this._getInternalNodes().forEach(e=>{e.channelCount=t.channelCount,e.channelCountMode=t.channelCountMode,e.channelInterpretation=t.channelInterpretation})}_getChannelProperties(){const t=this._getInternalNodes();bt(t.length>0,"ToneAudioNode does not have any internal nodes");const e=t[0];return{channelCount:e.channelCount,channelCountMode:e.channelCountMode,channelInterpretation:e.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelCount:t}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelCountMode:t}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(t){const e=this._getChannelProperties();this._setChannelProperties(Object.assign(e,{channelInterpretation:t}))}connect(t,e=0,o=0){return $e(this,t,e,o),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return ni("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(t,e=0,o=0){return pa(this,t,e,o),this}chain(...t){return os(this,...t),this}fan(...t){return t.forEach(e=>this.connect(e)),this}dispose(){return super.dispose(),Et(this.input)&&(this.input instanceof it?this.input.dispose():fn(this.input)&&this.input.disconnect()),Et(this.output)&&(this.output instanceof it?this.output.dispose():fn(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function os(...h){const t=h.shift();h.reduce((e,o)=>(e instanceof it?e.connect(o):fn(e)&&$e(e,o),o),t)}function $e(h,t,e=0,o=0){for(bt(Et(h),"Cannot connect from undefined node"),bt(Et(t),"Cannot connect to undefined node"),(t instanceof it||fn(t))&&bt(t.numberOfInputs>0,"Cannot connect to node with no inputs"),bt(h.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof it||t instanceof Ct;)Et(t.input)&&(t=t.input);for(;h instanceof it;)Et(h.output)&&(h=h.output);Cn(t)?h.connect(t,e):h.connect(t,e,o)}function pa(h,t,e=0,o=0){if(Et(t))for(;t instanceof it;)t=t.input;for(;!fn(h);)Et(h.output)&&(h=h.output);Cn(t)?h.disconnect(t,e):fn(t)?h.disconnect(t,e,o):h.disconnect()}function Mp(...h){const t=h.pop();Et(t)&&h.forEach(e=>$e(e,t))}class yt extends it{constructor(){const t=K(yt.getDefaults(),arguments,["gain","units"]);super(t),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Ct({context:this.context,convert:t.convert,param:this._gainNode.gain,units:t.units,value:t.gain,minValue:t.minValue,maxValue:t.maxValue}),xt(this,"gain")}static getDefaults(){return Object.assign(it.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class di extends it{constructor(t){super(t),this.onended=Ot,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new yt({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(e){const o=this.toSeconds(e);return this._startTime!==-1&&o>=this._startTime&&(this._stopTime===-1||o<=this._stopTime)?"started":"stopped"},this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut,this._curve=t.curve,this.onended=t.onended}static getDefaults(){return Object.assign(it.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Ot})}_startGain(t,e=1){bt(this._startTime===-1,"Source cannot be started more than once");const o=this.toSeconds(this._fadeIn);return this._startTime=t+o,this._startTime=Math.max(this._startTime,this.context.currentTime),o>0?(this._gainNode.gain.setValueAtTime(0,t),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(e,t+o):this._gainNode.gain.exponentialApproachValueAtTime(e,t,o)):this._gainNode.gain.setValueAtTime(e,t),this}stop(t){return this.log("stop",t),this._stopGain(this.toSeconds(t)),this}_stopGain(t){bt(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const e=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(t)+e,this._stopTime=Math.max(this._stopTime,this.now()),e>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,e,t):this._gainNode.gain.targetRampTo(0,e,t):(this._gainNode.gain.cancelAndHoldAtTime(t),this._gainNode.gain.setValueAtTime(0,t)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const o=this._curve==="exponential"?2*e:0;this._stopSource(this.now()+o),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Ot&&(this.onended(this),this.onended=Ot,!this.context.isOffline)){const t=()=>this.dispose();window.requestIdleCallback!==void 0?window.requestIdleCallback(t):setTimeout(t,1e3)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),bt(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Ot,this}}class Jo extends di{constructor(){const t=K(Jo.getDefaults(),arguments,["offset"]);super(t),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),$e(this._source,this._gainNode),this.offset=new Ct({context:this.context,convert:t.convert,param:this._source.offset,units:t.units,value:t.offset,minValue:t.minValue,maxValue:t.maxValue})}static getDefaults(){return Object.assign(di.getDefaults(),{convert:!0,offset:1,units:"number"})}start(t){const e=this.toSeconds(t);return this.log("start",e),this._startGain(e),this._source.start(e),this}_stopSource(t){this._source.stop(t)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class St extends it{constructor(){const t=K(St.getDefaults(),arguments,["value","units"]);super(t),this.name="Signal",this.override=!0,this.output=this._constantSource=new Jo({context:this.context,convert:t.convert,offset:t.value,units:t.units,minValue:t.minValue,maxValue:t.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(it.getDefaults(),{convert:!0,units:"number",value:0})}connect(t,e=0,o=0){return Yi(this,t,e,o),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(t,e){return this._param.setValueAtTime(t,e),this}getValueAtTime(t){return this._param.getValueAtTime(t)}setRampPoint(t){return this._param.setRampPoint(t),this}linearRampToValueAtTime(t,e){return this._param.linearRampToValueAtTime(t,e),this}exponentialRampToValueAtTime(t,e){return this._param.exponentialRampToValueAtTime(t,e),this}exponentialRampTo(t,e,o){return this._param.exponentialRampTo(t,e,o),this}linearRampTo(t,e,o){return this._param.linearRampTo(t,e,o),this}targetRampTo(t,e,o){return this._param.targetRampTo(t,e,o),this}exponentialApproachValueAtTime(t,e,o){return this._param.exponentialApproachValueAtTime(t,e,o),this}setTargetAtTime(t,e,o){return this._param.setTargetAtTime(t,e,o),this}setValueCurveAtTime(t,e,o,c){return this._param.setValueCurveAtTime(t,e,o,c),this}cancelScheduledValues(t){return this._param.cancelScheduledValues(t),this}cancelAndHoldAtTime(t){return this._param.cancelAndHoldAtTime(t),this}rampTo(t,e,o){return this._param.rampTo(t,e,o),this}get value(){return this._param.value}set value(t){this._param.value=t}get convert(){return this._param.convert}set convert(t){this._param.convert=t}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(t){this._param.overridden=t}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(t){return this._param.apply(t),this}}function Yi(h,t,e,o){(t instanceof Ct||Cn(t)||t instanceof St&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof St&&(t.overridden=!0)),$e(h,t,e,o)}class ma extends Ct{constructor(){const t=K(ma.getDefaults(),arguments,["value"]);super(t),this.name="TickParam",this._events=new ns(1/0),this._multiplier=1,this._multiplier=t.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(t.value)}),this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Ct.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(t,e,o){e=this.toSeconds(e),this.setRampPoint(e);const c=this._fromType(t),w=this._events.get(e),M=Math.round(Math.max(1/o,1));for(let C=0;C<=M;C++){const k=o*C+e,P=this._exponentialApproach(w.time,w.value,c,o,k);this.linearRampToValueAtTime(this._toType(P),k)}return this}setValueAtTime(t,e){const o=this.toSeconds(e);super.setValueAtTime(t,e);const c=this._events.get(o),w=this._events.previousEvent(c),M=this._getTicksUntilEvent(w,o);return c.ticks=Math.max(M,0),this}linearRampToValueAtTime(t,e){const o=this.toSeconds(e);super.linearRampToValueAtTime(t,e);const c=this._events.get(o),w=this._events.previousEvent(c),M=this._getTicksUntilEvent(w,o);return c.ticks=Math.max(M,0),this}exponentialRampToValueAtTime(t,e){e=this.toSeconds(e);const o=this._fromType(t),c=this._events.get(e),w=Math.round(Math.max(10*(e-c.time),1)),M=(e-c.time)/w;for(let C=0;C<=w;C++){const k=M*C+c.time,P=this._exponentialInterpolate(c.time,c.value,e,o,k);this.linearRampToValueAtTime(this._toType(P),k)}return this}_getTicksUntilEvent(t,e){if(t===null)t={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Ye(t.ticks)){const M=this._events.previousEvent(t);t.ticks=this._getTicksUntilEvent(M,t.time)}const o=this._fromType(this.getValueAtTime(t.time));let c=this._fromType(this.getValueAtTime(e));const w=this._events.get(e);return w&&w.time===e&&w.type==="setValueAtTime"&&(c=this._fromType(this.getValueAtTime(e-this.sampleTime))),.5*(e-t.time)*(o+c)+t.ticks}getTicksAtTime(t){const e=this.toSeconds(t),o=this._events.get(e);return Math.max(this._getTicksUntilEvent(o,e),0)}getDurationOfTicks(t,e){const o=this.toSeconds(e),c=this.getTicksAtTime(e);return this.getTimeOfTick(c+t)-o}getTimeOfTick(t){const e=this._events.get(t,"ticks"),o=this._events.getAfter(t,"ticks");if(e&&e.ticks===t)return e.time;if(e&&o&&o.type==="linearRampToValueAtTime"&&e.value!==o.value){const c=this._fromType(this.getValueAtTime(e.time)),w=(this._fromType(this.getValueAtTime(o.time))-c)/(o.time-e.time),M=Math.sqrt(Math.pow(c,2)-2*w*(e.ticks-t)),C=(-c+M)/w;return(C>0?C:(-c-M)/w)+e.time}return e?e.value===0?1/0:e.time+(t-e.ticks)/e.value:t/this._initialValue}ticksToTime(t,e){return this.getDurationOfTicks(t,e)}timeToTicks(t,e){const o=this.toSeconds(e),c=this.toSeconds(t),w=this.getTicksAtTime(o);return this.getTicksAtTime(o+c)-w}_fromType(t){return this.units==="bpm"&&this.multiplier?1/(60/t/this.multiplier):super._fromType(t)}_toType(t){return this.units==="bpm"&&this.multiplier?t/this.multiplier*60:super._toType(t)}get multiplier(){return this._multiplier}set multiplier(t){const e=this.value;this._multiplier=t,this.cancelScheduledValues(0),this.setValueAtTime(e,0)}}class ga extends St{constructor(){const t=K(ga.getDefaults(),arguments,["value"]);super(t),this.name="TickSignal",this.input=this._param=new ma({context:this.context,convert:t.convert,multiplier:t.multiplier,param:this._constantSource.offset,units:t.units,value:t.value})}static getDefaults(){return Object.assign(St.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(t,e){return this._param.ticksToTime(t,e)}timeToTicks(t,e){return this._param.timeToTicks(t,e)}getTimeOfTick(t){return this._param.getTimeOfTick(t)}getDurationOfTicks(t,e){return this._param.getDurationOfTicks(t,e)}getTicksAtTime(t){return this._param.getTicksAtTime(t)}get multiplier(){return this._param.multiplier}set multiplier(t){this._param.multiplier=t}dispose(){return super.dispose(),this._param.dispose(),this}}class va extends Me{constructor(){const t=K(va.getDefaults(),arguments,["frequency"]);super(t),this.name="TickSource",this._state=new ui,this._tickOffset=new ns,this._ticksAtTime=new ns,this._secondsAtTime=new ns,this.frequency=new ga({context:this.context,units:t.units,value:t.frequency}),xt(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Me.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(t,e){const o=this.toSeconds(t);return this._state.getValueAtTime(o)!=="started"&&(this._state.setStateAtTime("started",o),Et(e)&&this.setTicksAtTime(e,o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o)),this}stop(t){const e=this.toSeconds(t);if(this._state.getValueAtTime(e)==="stopped"){const o=this._state.get(e);o&&o.time>0&&(this._tickOffset.cancel(o.time),this._state.cancel(o.time))}return this._state.cancel(e),this._state.setStateAtTime("stopped",e),this.setTicksAtTime(0,e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}pause(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)==="started"&&(this._state.setStateAtTime("paused",e),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e)),this}cancel(t){return t=this.toSeconds(t),this._state.cancel(t),this._tickOffset.cancel(t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getTicksAtTime(t){const e=this.toSeconds(t),o=this._state.getLastState("stopped",e),c=this._ticksAtTime.get(e),w={state:"paused",time:e};this._state.add(w);let M=c||o,C=c?c.ticks:0,k=null;return this._state.forEachBetween(M.time,e+this.sampleTime,P=>{let I=M.time;const D=this._tickOffset.get(P.time);D&&D.time>=M.time&&(C=D.ticks,I=D.time),M.state==="started"&&P.state!=="started"&&(C+=this.frequency.getTicksAtTime(P.time)-this.frequency.getTicksAtTime(I),P.time!==w.time&&(k={state:P.state,time:P.time,ticks:C})),M=P}),this._state.remove(w),k&&this._ticksAtTime.add(k),C}get ticks(){return this.getTicksAtTime(this.now())}set ticks(t){this.setTicksAtTime(t,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(t){const e=this.now(),o=this.frequency.timeToTicks(t,e);this.setTicksAtTime(o,e)}getSecondsAtTime(t){t=this.toSeconds(t);const e=this._state.getLastState("stopped",t),o={state:"paused",time:t};this._state.add(o);const c=this._secondsAtTime.get(t);let w=c||e,M=c?c.seconds:0,C=null;return this._state.forEachBetween(w.time,t+this.sampleTime,k=>{let P=w.time;const I=this._tickOffset.get(k.time);I&&I.time>=w.time&&(M=I.seconds,P=I.time),w.state==="started"&&k.state!=="started"&&(M+=k.time-P,k.time!==o.time&&(C={state:k.state,time:k.time,seconds:M})),w=k}),this._state.remove(o),C&&this._secondsAtTime.add(C),M}setTicksAtTime(t,e){return e=this.toSeconds(e),this._tickOffset.cancel(e),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(t,e),ticks:t,time:e}),this._ticksAtTime.cancel(e),this._secondsAtTime.cancel(e),this}getStateAtTime(t){return t=this.toSeconds(t),this._state.getValueAtTime(t)}getTimeOfTick(t,e=this.now()){const o=this._tickOffset.get(e),c=this._state.get(e),w=Math.max(o.time,c.time),M=this.frequency.getTicksAtTime(w)+t-o.ticks;return this.frequency.getTimeOfTick(M)}forEachTickBetween(t,e,o){let c=this._state.get(t);this._state.forEachBetween(t,e,M=>{c&&c.state==="started"&&M.state!=="started"&&this.forEachTickBetween(Math.max(c.time,t),M.time-this.sampleTime,o),c=M});let w=null;if(c&&c.state==="started"){const M=Math.max(c.time,t),C=this.frequency.getTicksAtTime(M),k=C-this.frequency.getTicksAtTime(c.time);let P=Math.ceil(k)-k;P=Ms(P,1)?0:P;let I=this.frequency.getTimeOfTick(C+P);for(;I<e;){try{o(I,Math.round(this.getTicksAtTime(I)))}catch(D){w=D;break}I+=this.frequency.getDurationOfTicks(1,I)}}if(w)throw w;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class fi extends Me{constructor(){const t=K(fi.getDefaults(),arguments,["callback","frequency"]);super(t),this.name="Clock",this.callback=Ot,this._lastUpdate=0,this._state=new ui("stopped"),this._boundLoop=this._loop.bind(this),this.callback=t.callback,this._tickSource=new va({context:this.context,frequency:t.frequency,units:t.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,xt(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Me.getDefaults(),{callback:Ot,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(t,e){ra(this.context);const o=this.toSeconds(t);return this.log("start",o),this._state.getValueAtTime(o)!=="started"&&(this._state.setStateAtTime("started",o),this._tickSource.start(o,e),o<this._lastUpdate&&this.emit("start",o,e)),this}stop(t){const e=this.toSeconds(t);return this.log("stop",e),this._state.cancel(e),this._state.setStateAtTime("stopped",e),this._tickSource.stop(e),e<this._lastUpdate&&this.emit("stop",e),this}pause(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)==="started"&&(this._state.setStateAtTime("paused",e),this._tickSource.pause(e),e<this._lastUpdate&&this.emit("pause",e)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(t){this._tickSource.ticks=t}get seconds(){return this._tickSource.seconds}set seconds(t){this._tickSource.seconds=t}getSecondsAtTime(t){return this._tickSource.getSecondsAtTime(t)}setTicksAtTime(t,e){return this._tickSource.setTicksAtTime(t,e),this}getTimeOfTick(t,e=this.now()){return this._tickSource.getTimeOfTick(t,e)}getTicksAtTime(t){return this._tickSource.getTicksAtTime(t)}nextTickTime(t,e){const o=this.toSeconds(e),c=this.getTicksAtTime(o);return this._tickSource.getTimeOfTick(c+t,o)}_loop(){const t=this._lastUpdate,e=this.now();this._lastUpdate=e,this.log("loop",t,e),t!==e&&(this._state.forEachBetween(t,e,o=>{switch(o.state){case"started":const c=this._tickSource.getTicksAtTime(o.time);this.emit("start",o.time,c);break;case"stopped":o.time!==0&&this.emit("stop",o.time);break;case"paused":this.emit("pause",o.time)}}),this._tickSource.forEachTickBetween(t,e,(o,c)=>{this.callback(o,c)}))}getStateAtTime(t){const e=this.toSeconds(t);return this._state.getValueAtTime(e)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}ri.mixin(fi);class rs extends it{constructor(){const t=K(rs.getDefaults(),arguments,["delayTime","maxDelay"]);super(t),this.name="Delay";const e=this.toSeconds(t.maxDelay);this._maxDelay=Math.max(e,this.toSeconds(t.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(e),this.delayTime=new Ct({context:this.context,param:this._delayNode.delayTime,units:"time",value:t.delayTime,minValue:0,maxValue:this.maxDelay}),xt(this,"delayTime")}static getDefaults(){return Object.assign(it.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class Js extends it{constructor(){const t=K(Js.getDefaults(),arguments,["volume"]);super(t),this.name="Volume",this.input=this.output=new yt({context:this.context,gain:t.volume,units:"decibels"}),this.volume=this.output.gain,xt(this,"volume"),this._unmutedVolume=t.volume,this.mute=t.mute}static getDefaults(){return Object.assign(it.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(t){!this.mute&&t?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!t&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class ya extends it{constructor(){const t=K(ya.getDefaults(),arguments);super(t),this.name="Destination",this.input=new Js({context:this.context}),this.output=new yt({context:this.context}),this.volume=this.input.volume,os(this.input,this.output,this.context.rawContext.destination),this.mute=t.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(it.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(t){this.input.mute=t}chain(...t){return this.input.disconnect(),t.unshift(this.input),t.push(this.output),os(...t),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}Xo(h=>{h.destination=new ya({context:h})}),Yo(h=>{h.destination.dispose()});class Cp extends it{constructor(){super(...arguments),this.name="Listener",this.positionX=new Ct({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Ct({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Ct({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Ct({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Ct({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Ct({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Ct({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Ct({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Ct({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(it.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}function Ap(h,t){return Zt(this,arguments,void 0,function*(e,o,c=2,w=ee().sampleRate){const M=ee(),C=new li(c,o,w);Zo(C),yield e(C);const k=C.render();Zo(M);const P=yield k;return new Ft(P)})}Xo(h=>{h.listener=new Cp({context:h})}),Yo(h=>{h.listener.dispose()});class pi extends Qs{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const t=K(pi.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=t.baseUrl,Object.keys(t.urls).forEach(e=>{this._loadingCount++;const o=t.urls[e];this.add(e,o,this._bufferLoaded.bind(this,t.onload),t.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Ot,onload:Ot,urls:{}}}has(t){return this._buffers.has(t.toString())}get(t){return bt(this.has(t),`ToneAudioBuffers has no buffer named: ${t}`),this._buffers.get(t.toString())}_bufferLoaded(t){this._loadingCount--,this._loadingCount===0&&t&&t()}get loaded(){return Array.from(this._buffers).every(([t,e])=>e.loaded)}add(t,e,o=Ot,c=Ot){return Ss(e)?(this.baseUrl&&e.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(t.toString(),new Ft(this.baseUrl+e,o,c))):this._buffers.set(t.toString(),new Ft(e,o,c)),this}dispose(){return super.dispose(),this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this}}class mi extends Ve{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(t){return pn(super._frequencyToUnits(t))}_ticksToUnits(t){return pn(super._ticksToUnits(t))}_beatsToUnits(t){return pn(super._beatsToUnits(t))}_secondsToUnits(t){return pn(super._secondsToUnits(t))}toMidi(){return this.valueOf()}toFrequency(){return da(this.toMidi())}transpose(t){return new mi(this.context,this.toMidi()+t)}}function kp(h,t){return new mi(ee(),h,t)}class oe extends me{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(t){return this._getPPQ()*t}_secondsToUnits(t){return Math.floor(t/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(t){return t}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}function Pp(h,t){return new oe(ee(),h,t)}class Ep extends Me{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new ns,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(t,e){return this._events.add({callback:t,time:this.toSeconds(e)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(t){return this._events.cancel(this.toSeconds(t)),this}_drawLoop(){const t=this.context.currentTime;for(;this._events.length&&this._events.peek().time-this.anticipation<=t;){const e=this._events.shift();e&&t-e.time<=this.expiration&&e.callback()}this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}Xo(h=>{h.draw=new Ep({context:h})}),Yo(h=>{h.draw.dispose()});class _h extends Qs{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(t){bt(Et(t.time),"Events must have a time property"),bt(Et(t.duration),"Events must have a duration parameter"),t.time=t.time.valueOf();let e=new Ip(t.time,t.time+t.duration,t);for(this._root===null?this._root=e:this._root.insert(e),this._length++;e!==null;)e.updateHeight(),e.updateMax(),this._rebalance(e),e=e.parent;return this}remove(t){if(this._root!==null){const e=[];this._root.search(t.time,e);for(const o of e)if(o.event===t){this._removeNode(o),this._length--;break}}return this}get length(){return this._length}cancel(t){return this.forEachFrom(t,e=>this.remove(e)),this}_setRoot(t){this._root=t,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(t,e){t.parent!==null?(t.isLeftChild()?t.parent.left=e:t.parent.right=e,this._rebalance(t.parent)):this._setRoot(e)}_removeNode(t){if(t.left===null&&t.right===null)this._replaceNodeInParent(t,null);else if(t.right===null)this._replaceNodeInParent(t,t.left);else if(t.left===null)this._replaceNodeInParent(t,t.right);else{let e,o=null;if(t.getBalance()>0)if(t.left.right===null)e=t.left,e.right=t.right,o=e;else{for(e=t.left.right;e.right!==null;)e=e.right;e.parent&&(e.parent.right=e.left,o=e.parent,e.left=t.left,e.right=t.right)}else if(t.right.left===null)e=t.right,e.left=t.left,o=e;else{for(e=t.right.left;e.left!==null;)e=e.left;e.parent&&(e.parent.left=e.right,o=e.parent,e.left=t.left,e.right=t.right)}t.parent!==null?t.isLeftChild()?t.parent.left=e:t.parent.right=e:this._setRoot(e),o&&this._rebalance(o)}t.dispose()}_rotateLeft(t){const e=t.parent,o=t.isLeftChild(),c=t.right;c&&(t.right=c.left,c.left=t),e!==null?o?e.left=c:e.right=c:this._setRoot(c)}_rotateRight(t){const e=t.parent,o=t.isLeftChild(),c=t.left;c&&(t.left=c.right,c.right=t),e!==null?o?e.left=c:e.right=c:this._setRoot(c)}_rebalance(t){const e=t.getBalance();e>1&&t.left?t.left.getBalance()<0?this._rotateLeft(t.left):this._rotateRight(t):e<-1&&t.right&&(t.right.getBalance()>0?this._rotateRight(t.right):this._rotateLeft(t))}get(t){if(this._root!==null){const e=[];if(this._root.search(t,e),e.length>0){let o=e[0];for(let c=1;c<e.length;c++)e[c].low>o.low&&(o=e[c]);return o.event}}return null}forEach(t){if(this._root!==null){const e=[];this._root.traverse(o=>e.push(o)),e.forEach(o=>{o.event&&t(o.event)})}return this}forEachAtTime(t,e){if(this._root!==null){const o=[];this._root.search(t,o),o.forEach(c=>{c.event&&e(c.event)})}return this}forEachFrom(t,e){if(this._root!==null){const o=[];this._root.searchAfter(t,o),o.forEach(c=>{c.event&&e(c.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(t=>t.dispose()),this._root=null,this}}class Ip{constructor(t,e,o){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=o,this.low=t,this.high=e,this.max=this.high}insert(t){t.low<=this.low?this.left===null?this.left=t:this.left.insert(t):this.right===null?this.right=t:this.right.insert(t)}search(t,e){t>this.max||(this.left!==null&&this.left.search(t,e),this.low<=t&&this.high>t&&e.push(this),this.low>t||this.right!==null&&this.right.search(t,e))}searchAfter(t,e){this.low>=t&&(e.push(this),this.left!==null&&this.left.searchAfter(t,e)),this.right!==null&&this.right.searchAfter(t,e)}traverse(t){t(this),this.left!==null&&this.left.traverse(t),this.right!==null&&this.right.traverse(t)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let t=0;return this.left!==null&&this.right!==null?t=this.left.height-this.right.height:this.left!==null?t=this.left.height+1:this.right!==null&&(t=-(this.right.height+1)),t}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(t){this._left=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(t){this._right=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class Op extends Qs{constructor(t){super(),this.name="TimelineValue",this._timeline=new ns({memory:10}),this._initialValue=t}set(t,e){return this._timeline.add({value:t,time:e}),this}get(t){const e=this._timeline.get(t);return e?e.value:this._initialValue}}class as extends it{constructor(){super(K(as.getDefaults(),arguments,["context"]))}connect(t,e=0,o=0){return Yi(this,t,e,o),this}}class Cs extends as{constructor(){const t=K(Cs.getDefaults(),arguments,["mapping","length"]);super(t),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Pe(t.mapping)||t.mapping instanceof Float32Array?this.curve=Float32Array.from(t.mapping):uh(t.mapping)&&this.setMap(t.mapping,t.length)}static getDefaults(){return Object.assign(St.getDefaults(),{length:1024})}setMap(t,e=1024){const o=new Float32Array(e);for(let c=0,w=e;c<w;c++){const M=c/(w-1)*2-1;o[c]=t(M,c)}return this.curve=o,this}get curve(){return this._shaper.curve}set curve(t){this._shaper.curve=t}get oversample(){return this._shaper.oversample}set oversample(t){bt(["none","2x","4x"].some(e=>e.includes(t)),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class gi extends as{constructor(){const t=K(gi.getDefaults(),arguments,["value"]);super(t),this.name="Pow",this._exponentScaler=this.input=this.output=new Cs({context:this.context,mapping:this._expFunc(t.value),length:8192}),this._exponent=t.value}static getDefaults(){return Object.assign(as.getDefaults(),{value:1})}_expFunc(t){return e=>Math.pow(Math.abs(e),t)}get value(){return this._exponent}set value(t){this._exponent=t,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class mn{constructor(t,e){this.id=mn._eventId++,this._remainderTime=0;const o=Object.assign(mn.getDefaults(),e);this.transport=t,this.callback=o.callback,this._once=o.once,this.time=Math.floor(o.time),this._remainderTime=o.time-this.time}static getDefaults(){return{callback:Ot,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(t){if(this.callback){const e=this.transport.bpm.getDurationOfTicks(1,t);this.callback(t+this._remainderTime*e),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}mn._eventId=0;class ba extends mn{constructor(t,e){super(t,e),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const o=Object.assign(ba.getDefaults(),e);this.duration=o.duration,this._interval=o.interval,this._nextTick=o.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},mn.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(t){this._createEvents(t),super.invoke(t)}_createEvent(){return Uo(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new oe(this.context,this._nextTick).toSeconds()):-1}_createEvents(t){Uo(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new oe(this.context,this._nextTick).toSeconds()))}_restart(t){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const e=this.transport.getTicksAtTime(t);oi(e,this.time)&&(this._nextTick=this.floatTime+Math.ceil((e-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Ko extends Me{constructor(){const t=K(Ko.getDefaults(),arguments);super(t),this.name="Transport",this._loop=new Op(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new ns,this._repeatedEvents=new _h,this._syncedSignals=[],this._swingAmount=0,this._ppq=t.ppq,this._clock=new fi({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=t.ppq,this.bpm.setValueAtTime(t.bpm,0),xt(this,"bpm"),this._timeSignature=t.timeSignature,this._swingTicks=t.ppq/2}static getDefaults(){return Object.assign(Me.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(t,e){if(this._loop.get(t)&&e>=this._loopEnd&&(this.emit("loopEnd",t),this._clock.setTicksAtTime(this._loopStart,t),e=this._loopStart,this.emit("loopStart",t,this._clock.getSecondsAtTime(t)),this.emit("loop",t)),this._swingAmount>0&&e%this._ppq!=0&&e%(2*this._swingTicks)!=0){const o=e%(2*this._swingTicks)/(2*this._swingTicks),c=Math.sin(o*Math.PI)*this._swingAmount;t+=new oe(this.context,2*this._swingTicks/3).toSeconds()*c}aa(!0),this._timeline.forEachAtTime(e,o=>o.invoke(t)),aa(!1)}schedule(t,e){const o=new mn(this,{callback:t,time:new me(this.context,e).toTicks()});return this._addEvent(o,this._timeline)}scheduleRepeat(t,e,o,c=1/0){const w=new ba(this,{callback:t,duration:new is(this.context,c).toTicks(),interval:new is(this.context,e).toTicks(),time:new me(this.context,o).toTicks()});return this._addEvent(w,this._repeatedEvents)}scheduleOnce(t,e){const o=new mn(this,{callback:t,once:!0,time:new me(this.context,e).toTicks()});return this._addEvent(o,this._timeline)}clear(t){if(this._scheduledEvents.hasOwnProperty(t)){const e=this._scheduledEvents[t.toString()];e.timeline.remove(e.event),e.event.dispose(),delete this._scheduledEvents[t.toString()]}return this}_addEvent(t,e){return this._scheduledEvents[t.id.toString()]={event:t,timeline:e},e.add(t),t.id}cancel(t=0){const e=this.toTicks(t);return this._timeline.forEachFrom(e,o=>this.clear(o.id)),this._repeatedEvents.forEachFrom(e,o=>this.clear(o.id)),this}_bindClockEvents(){this._clock.on("start",(t,e)=>{e=new oe(this.context,e).toSeconds(),this.emit("start",t,e)}),this._clock.on("stop",t=>{this.emit("stop",t)}),this._clock.on("pause",t=>{this.emit("pause",t)})}get state(){return this._clock.getStateAtTime(this.now())}start(t,e){let o;return this.context.resume(),Et(e)&&(o=this.toTicks(e)),this._clock.start(t,o),this}stop(t){return this._clock.stop(t),this}pause(t){return this._clock.pause(t),this}toggle(t){return t=this.toSeconds(t),this._clock.getStateAtTime(t)!=="started"?this.start(t):this.stop(t),this}get timeSignature(){return this._timeSignature}set timeSignature(t){Pe(t)&&(t=t[0]/t[1]*4),this._timeSignature=t}get loopStart(){return new is(this.context,this._loopStart,"i").toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t)}get loopEnd(){return new is(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t)}get loop(){return this._loop.get(this.now())}set loop(t){this._loop.set(t,this.now())}setLoopPoints(t,e){return this.loopStart=t,this.loopEnd=e,this}get swing(){return this._swingAmount}set swing(t){this._swingAmount=t}get swingSubdivision(){return new oe(this.context,this._swingTicks).toNotation()}set swingSubdivision(t){this._swingTicks=this.toTicks(t)}get position(){const t=this.now(),e=this._clock.getTicksAtTime(t);return new oe(this.context,e).toBarsBeatsSixteenths()}set position(t){const e=this.toTicks(t);this.ticks=e}get seconds(){return this._clock.seconds}set seconds(t){const e=this.now(),o=this._clock.frequency.timeToTicks(t,e);this.ticks=o}get progress(){if(this.loop){const t=this.now();return(this._clock.getTicksAtTime(t)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(t){if(this._clock.ticks!==t){const e=this.now();if(this.state==="started"){const o=this._clock.getTicksAtTime(e),c=e+this._clock.frequency.getDurationOfTicks(Math.ceil(o)-o,e);this.emit("stop",c),this._clock.setTicksAtTime(t,c),this.emit("start",c,this._clock.getSecondsAtTime(c))}else this.emit("ticks",e),this._clock.setTicksAtTime(t,e)}}getTicksAtTime(t){return this._clock.getTicksAtTime(t)}getSecondsAtTime(t){return this._clock.getSecondsAtTime(t)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(t){this._clock.frequency.multiplier=t}nextSubdivision(t){if(t=this.toTicks(t),this.state!=="started")return 0;{const e=this.now(),o=t-this.getTicksAtTime(e)%t;return this._clock.nextTickTime(o,e)}}syncSignal(t,e){const o=this.now();let c=this.bpm,w=1/(60/c.getValueAtTime(o)/this.PPQ),M=[];if(t.units==="time"){const k=.015625/w,P=new yt(k),I=new gi(-1),D=new yt(k);c.chain(P,I,D),c=D,w=1/w,M=[P,I,D]}e||(e=t.getValueAtTime(o)!==0?t.getValueAtTime(o)/w:0);const C=new yt(e);return c.connect(C),C.connect(t._param),M.push(C),this._syncedSignals.push({initial:t.value,nodes:M,signal:t}),t.value=0,this}unsyncSignal(t){for(let e=this._syncedSignals.length-1;e>=0;e--){const o=this._syncedSignals[e];o.signal===t&&(o.nodes.forEach(c=>c.dispose()),o.signal.value=o.initial,this._syncedSignals.splice(e,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),Hi(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}ri.mixin(Ko),Xo(h=>{h.transport=new Ko({context:h})}),Yo(h=>{h.transport.dispose()});class ue extends it{constructor(t){super(t),this.input=void 0,this._state=new ui("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Ot,this._syncedStop=Ot,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new Js({context:this.context,mute:t.mute,volume:t.volume}),this.volume=this._volume.volume,xt(this,"volume"),this.onstop=t.onstop}static getDefaults(){return Object.assign(it.getDefaults(),{mute:!1,onstop:Ot,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}_clampToCurrentTime(t){return this._synced?t:Math.max(t,this.context.currentTime)}start(t,e,o){let c=Ye(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(c=this._clampToCurrentTime(c),this._synced||this._state.getValueAtTime(c)!=="started")if(this.log("start",c),this._state.setStateAtTime("started",c),this._synced){const w=this._state.get(c);w&&(w.offset=this.toSeconds(fs(e,0)),w.duration=o?this.toSeconds(o):void 0);const M=this.context.transport.schedule(C=>{this._start(C,e,o)},c);this._scheduled.push(M),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>c&&this._syncedStart(this.now(),this.context.transport.seconds)}else ra(this.context),this._start(c,e,o);else bt(oi(c,this._state.get(c).time),"Start time must be strictly greater than previous start time"),this._state.cancel(c),this._state.setStateAtTime("started",c),this.log("restart",c),this.restart(c,e,o);return this}stop(t){let e=Ye(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(e=this._clampToCurrentTime(e),this._state.getValueAtTime(e)==="started"||Et(this._state.getNextState("started",e))){if(this.log("stop",e),this._synced){const o=this.context.transport.schedule(this._stop.bind(this),e);this._scheduled.push(o)}else this._stop(e);this._state.cancel(e),this._state.setStateAtTime("stopped",e)}return this}restart(t,e,o){return t=this.toSeconds(t),this._state.getValueAtTime(t)==="started"&&(this._state.cancel(t),this._restart(t,e,o)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(t,e)=>{if(oi(e,0)){const o=this._state.get(e);if(o&&o.state==="started"&&o.time!==e){const c=e-this.toSeconds(o.time);let w;o.duration&&(w=this.toSeconds(o.duration)-c),this._start(t,this.toSeconds(o.offset)+c,w)}}},this._syncedStop=t=>{const e=this.context.transport.getSecondsAtTime(Math.max(t-this.sampleTime,0));this._state.getValueAtTime(e)==="started"&&this._stop(t)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(t=>this.context.transport.clear(t)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Ot,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class gn extends di{constructor(){const t=K(gn.getDefaults(),arguments,["url","onload"]);super(t),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,$e(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Ct({context:this.context,param:this._source.playbackRate,units:"positive",value:t.playbackRate}),this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this._buffer=new Ft(t.url,t.onload,t.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(di.getDefaults(),{url:new Ft,loop:!1,loopEnd:0,loopStart:0,onload:Ot,onerror:Ot,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t}get curve(){return this._curve}set curve(t){this._curve=t}start(t,e,o,c=1){bt(this.buffer.loaded,"buffer is either not set or not loaded");const w=this.toSeconds(t);this._startGain(w,c),e=this.loop?fs(e,this.loopStart):fs(e,0);let M=Math.max(this.toSeconds(e),0);if(this.loop){const C=this.toSeconds(this.loopEnd)||this.buffer.duration,k=this.toSeconds(this.loopStart),P=C-k;ha(M,C)&&(M=(M-k)%P+k),Ms(M,this.buffer.duration)&&(M=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Uo(M,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(w,M)),Et(o)){let C=this.toSeconds(o);C=Math.max(C,0),this.stop(w+C)}return this}_stopSource(t){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(t)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(t){this._source.loopStart=this.toSeconds(t)}get loopEnd(){return this._source.loopEnd}set loopEnd(t){this._source.loopEnd=this.toSeconds(t)}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._source.loop}set loop(t){this._source.loop=t,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}class vn extends ue{constructor(){const t=K(vn.getDefaults(),arguments,["type"]);super(t),this.name="Noise",this._source=null,this._playbackRate=t.playbackRate,this.type=t.type,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ue.getDefaults(),{fadeIn:0,fadeOut:0,playbackRate:1,type:"white"})}get type(){return this._type}set type(t){if(bt(t in wh,"Noise: invalid type: "+t),this._type!==t&&(this._type=t,this.state==="started")){const e=this.now();this._stop(e),this._start(e)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._source&&(this._source.playbackRate.value=t)}_start(t){const e=wh[this._type];this._source=new gn({url:e,context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,loop:!0,onended:()=>this.onstop(this),playbackRate:this._playbackRate}).connect(this.output),this._source.start(this.toSeconds(t),Math.random()*(e.duration-.001))}_stop(t){this._source&&(this._source.stop(this.toSeconds(t)),this._source=null)}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._source&&(this._source.fadeIn=this._fadeIn)}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._source&&(this._source.fadeOut=this._fadeOut)}_restart(t){this._stop(t),this._start(t)}dispose(){return super.dispose(),this._source&&this._source.disconnect(),this}}const vi=220500,Ks={brown:null,pink:null,white:null},wh={get brown(){if(!Ks.brown){const h=[];for(let t=0;t<2;t++){const e=new Float32Array(vi);h[t]=e;let o=0;for(let c=0;c<vi;c++){const w=2*Math.random()-1;e[c]=(o+.02*w)/1.02,o=e[c],e[c]*=3.5}}Ks.brown=new Ft().fromArray(h)}return Ks.brown},get pink(){if(!Ks.pink){const h=[];for(let t=0;t<2;t++){const e=new Float32Array(vi);let o,c,w,M,C,k,P;h[t]=e,o=c=w=M=C=k=P=0;for(let I=0;I<vi;I++){const D=2*Math.random()-1;o=.99886*o+.0555179*D,c=.99332*c+.0750759*D,w=.969*w+.153852*D,M=.8665*M+.3104856*D,C=.55*C+.5329522*D,k=-.7616*k-.016898*D,e[I]=o+c+w+M+C+k+P+.5362*D,e[I]*=.11,P=.115926*D}}Ks.pink=new Ft().fromArray(h)}return Ks.pink},get white(){if(!Ks.white){const h=[];for(let t=0;t<2;t++){const e=new Float32Array(vi);h[t]=e;for(let o=0;o<vi;o++)e[o]=2*Math.random()-1}Ks.white=new Ft().fromArray(h)}return Ks.white}};class Zi extends it{constructor(){const t=K(Zi.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new Js({context:this.context,volume:t.volume}),this.volume=this._volume.volume,xt(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(it.getDefaults(),{mute:!1,volume:0})}open(t){return Zt(this,void 0,void 0,function*(){bt(Zi.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const e=yield Zi.enumerateDevices();es(t)?this._device=e[t]:(this._device=e.find(w=>w.label===t||w.deviceId===t),!this._device&&e.length>0&&(this._device=e[0]),bt(Et(this._device),`No matching device ${t}`));const o={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(o.audio.deviceId=this._device.deviceId);const c=yield navigator.mediaDevices.getUserMedia(o);if(!this._stream){this._stream=c;const w=this.context.createMediaStreamSource(c);$e(w,this.output),this._mediaStream=w}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return Zt(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){return this._device?this._device.deviceId:void 0}get groupId(){return this._device?this._device.groupId:void 0}get label(){return this._device?this._device.label:void 0}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return Et(navigator.mediaDevices)&&Et(navigator.mediaDevices.getUserMedia)}}function kn(h,t){return Zt(this,void 0,void 0,function*(){const e=t/h.context.sampleRate,o=new li(1,e,h.context.sampleRate);return new h.constructor(Object.assign(h.get(),{frequency:2/e,detune:0,context:o})).toDestination().start(0),(yield o.render()).getChannelData(0)})}class Qi extends di{constructor(){const t=K(Qi.getDefaults(),arguments,["frequency","type"]);super(t),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],$e(this._oscillator,this._gainNode),this.type=t.type,this.frequency=new Ct({context:this.context,param:this._oscillator.frequency,units:"frequency",value:t.frequency}),this.detune=new Ct({context:this.context,param:this._oscillator.detune,units:"cents",value:t.detune}),xt(this,["frequency","detune"])}static getDefaults(){return Object.assign(di.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(t){const e=this.toSeconds(t);return this.log("start",e),this._startGain(e),this._oscillator.start(e),this}_stopSource(t){this._oscillator.stop(t)}setPeriodicWave(t){return this._oscillator.setPeriodicWave(t),this}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class re extends ue{constructor(){const t=K(re.getDefaults(),arguments,["frequency","type"]);super(t),this.name="Oscillator",this._oscillator=null,this.frequency=new St({context:this.context,units:"frequency",value:t.frequency}),xt(this,"frequency"),this.detune=new St({context:this.context,units:"cents",value:t.detune}),xt(this,"detune"),this._partials=t.partials,this._partialCount=t.partialCount,this._type=t.type,t.partialCount&&t.type!=="custom"&&(this._type=this.baseType+t.partialCount.toString()),this.phase=t.phase}static getDefaults(){return Object.assign(ue.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(t){const e=this.toSeconds(t),o=new Qi({context:this.context,onended:()=>this.onstop(this)});this._oscillator=o,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(e)}_stop(t){const e=this.toSeconds(t);this._oscillator&&this._oscillator.stop(e)}_restart(t){const e=this.toSeconds(t);return this.log("restart",e),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(e),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return re._periodicWaveCache.find(t=>{return t.phase===this._phase&&(e=t.partials,o=this._partials,e.length===o.length&&e.every((c,w)=>o[w]===c));var e,o});{const t=re._periodicWaveCache.find(e=>e.type===this._type&&e.phase===this._phase);return this._partialCount=t?t.partialCount:this._partialCount,t}}get type(){return this._type}set type(t){this._type=t;const e=["sine","square","sawtooth","triangle"].indexOf(t)!==-1;if(this._phase===0&&e)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=t);else{const o=this._getCachedPeriodicWave();if(Et(o)){const{partials:c,wave:w}=o;this._wave=w,this._partials=c,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[c,w]=this._getRealImaginary(t,this._phase),M=this.context.createPeriodicWave(c,w);this._wave=M,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),re._periodicWaveCache.push({imag:w,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:c,type:this._type,wave:this._wave}),re._periodicWaveCache.length>100&&re._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(t){this.partialCount&&this._type!=="custom"&&t!=="custom"?this.type=t+this.partialCount:this.type=t}get partialCount(){return this._partialCount}set partialCount(t){Ee(t,0);let e=this._type;const o=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(o&&(e=o[1]),this._type!=="custom")this.type=t===0?e:e+t.toString();else{const c=new Float32Array(t);this._partials.forEach((w,M)=>c[M]=w),this._partials=Array.from(c),this.type=this._type}}_getRealImaginary(t,e){let o=2048;const c=new Float32Array(o),w=new Float32Array(o);let M=1;if(t==="custom"){if(M=this._partials.length+1,this._partialCount=this._partials.length,o=M,this._partials.length===0)return[c,w]}else{const C=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(t);C?(M=parseInt(C[2],10)+1,this._partialCount=parseInt(C[2],10),t=C[1],M=Math.max(M,2),o=M):this._partialCount=0,this._partials=[]}for(let C=1;C<o;++C){const k=2/(C*Math.PI);let P;switch(t){case"sine":P=C<=M?1:0,this._partials[C-1]=P;break;case"square":P=1&C?2*k:0,this._partials[C-1]=P;break;case"sawtooth":P=k*(1&C?1:-1),this._partials[C-1]=P;break;case"triangle":P=1&C?k*k*2*(C-1>>1&1?-1:1):0,this._partials[C-1]=P;break;case"custom":P=this._partials[C-1];break;default:throw new TypeError("Oscillator: invalid type: "+t)}P!==0?(c[C]=-P*Math.sin(e*C),w[C]=P*Math.cos(e*C)):(c[C]=0,w[C]=0)}return[c,w]}_inverseFFT(t,e,o){let c=0;const w=t.length;for(let M=0;M<w;M++)c+=t[M]*Math.cos(M*o)+e[M]*Math.sin(M*o);return c}getInitialValue(){const[t,e]=this._getRealImaginary(this._type,0);let o=0;const c=2*Math.PI;for(let w=0;w<32;w++)o=Math.max(this._inverseFFT(t,e,w/32*c),o);return An(-this._inverseFFT(t,e,this._phase)/o,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(t){this._phase=t*Math.PI/180,this.type=this._type}asArray(){return Zt(this,arguments,void 0,function*(t=1024){return kn(this,t)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}re._periodicWaveCache=[];class tr extends as{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Cs({context:this.context,mapping:t=>(t+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class ae extends St{constructor(){const t=K(ae.getDefaults(),arguments,["value"]);super(t),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new yt({context:this.context,minValue:t.minValue,maxValue:t.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(St.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class Ji extends ue{constructor(){const t=K(Ji.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="AMOscillator",this._modulationScale=new tr({context:this.context}),this._modulationNode=new yt({context:this.context}),this._carrier=new re({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new re({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ae({context:this.context,units:"positive",value:t.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),xt(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(re.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){this._modulator.restart(t),this._carrier.restart(t)}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Zt(this,arguments,void 0,function*(t=1024){return kn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class yi extends ue{constructor(){const t=K(yi.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="FMOscillator",this._modulationNode=new yt({context:this.context,gain:0}),this._carrier=new re({context:this.context,detune:t.detune,frequency:0,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.detune=this._carrier.detune,this.frequency=new St({context:this.context,units:"frequency",value:t.frequency}),this._modulator=new re({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ae({context:this.context,units:"positive",value:t.harmonicity}),this.modulationIndex=new ae({context:this.context,units:"positive",value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),xt(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(re.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){return this._modulator.restart(t),this._carrier.restart(t),this}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Zt(this,arguments,void 0,function*(t=1024){return kn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class bi extends ue{constructor(){const t=K(bi.getDefaults(),arguments,["frequency","width"]);super(t),this.name="PulseOscillator",this._widthGate=new yt({context:this.context,gain:0}),this._thresh=new Cs({context:this.context,mapping:e=>e<=0?-1:1}),this.width=new St({context:this.context,units:"audioRange",value:t.width}),this._triangle=new re({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),xt(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(ue.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(t){t=this.toSeconds(t),this._triangle.start(t),this._widthGate.gain.setValueAtTime(1,t)}_stop(t){t=this.toSeconds(t),this._triangle.stop(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(0,t)}_restart(t){this._triangle.restart(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(1,t)}get phase(){return this._triangle.phase}set phase(t){this._triangle.phase=t}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(t){this._triangle.type=t}asArray(){return Zt(this,arguments,void 0,function*(t=1024){return kn(this,t)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Ki extends ue{constructor(){const t=K(Ki.getDefaults(),arguments,["frequency","type","spread"]);super(t),this.name="FatOscillator",this._oscillators=[],this.frequency=new St({context:this.context,units:"frequency",value:t.frequency}),this.detune=new St({context:this.context,units:"cents",value:t.detune}),this._spread=t.spread,this._type=t.type,this._phase=t.phase,this._partials=t.partials,this._partialCount=t.partialCount,this.count=t.count,xt(this,["frequency","detune"])}static getDefaults(){return Object.assign(re.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(t){t=this.toSeconds(t),this._forEach(e=>e.start(t))}_stop(t){t=this.toSeconds(t),this._forEach(e=>e.stop(t))}_restart(t){this._forEach(e=>e.restart(t))}_forEach(t){for(let e=0;e<this._oscillators.length;e++)t(this._oscillators[e],e)}get type(){return this._type}set type(t){this._type=t,this._forEach(e=>e.type=t)}get spread(){return this._spread}set spread(t){if(this._spread=t,this._oscillators.length>1){const e=-t/2,o=t/(this._oscillators.length-1);this._forEach((c,w)=>c.detune.value=e+o*w)}}get count(){return this._oscillators.length}set count(t){if(Ee(t,1),this._oscillators.length!==t){this._forEach(e=>e.dispose()),this._oscillators=[];for(let e=0;e<t;e++){const o=new re({context:this.context,volume:-6-1.1*t,type:this._type,phase:this._phase+e/t*360,partialCount:this._partialCount,onstop:e===0?()=>this.onstop(this):Ot});this.type==="custom"&&(o.partials=this._partials),this.frequency.connect(o.frequency),this.detune.connect(o.detune),o.detune.overridden=!1,o.connect(this.output),this._oscillators[e]=o}this.spread=this._spread,this.state==="started"&&this._forEach(e=>e.start())}}get phase(){return this._phase}set phase(t){this._phase=t,this._forEach((e,o)=>e.phase=this._phase+o/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(t){this._forEach(e=>e.baseType=t),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this._type="custom",this._forEach(e=>e.partials=t))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(t){this._partialCount=t,this._forEach(e=>e.partialCount=t),this._type=this._oscillators[0].type}asArray(){return Zt(this,arguments,void 0,function*(t=1024){return kn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(t=>t.dispose()),this}}class to extends ue{constructor(){const t=K(to.getDefaults(),arguments,["frequency","modulationFrequency"]);super(t),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new ae({context:this.context,value:2}),this._pulse=new bi({context:this.context,frequency:t.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new re({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),xt(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(ue.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(t){t=this.toSeconds(t),this._modulator.start(t),this._pulse.start(t)}_stop(t){t=this.toSeconds(t),this._modulator.stop(t),this._pulse.stop(t)}_restart(t){this._modulator.restart(t),this._pulse.restart(t)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(t){this._modulator.phase=t}asArray(){return Zt(this,arguments,void 0,function*(t=1024){return kn(this,t)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const xh={am:Ji,fat:Ki,fm:yi,oscillator:re,pulse:bi,pwm:to};class tn extends ue{constructor(){const t=K(tn.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OmniOscillator",this.frequency=new St({context:this.context,units:"frequency",value:t.frequency}),this.detune=new St({context:this.context,units:"cents",value:t.detune}),xt(this,["frequency","detune"]),this.set(t)}static getDefaults(){return Object.assign(re.getDefaults(),yi.getDefaults(),Ji.getDefaults(),Ki.getDefaults(),bi.getDefaults(),to.getDefaults())}_start(t){this._oscillator.start(t)}_stop(t){this._oscillator.stop(t)}_restart(t){return this._oscillator.restart(t),this}get type(){let t="";return["am","fm","fat"].some(e=>this._sourceType===e)&&(t=this._sourceType),t+this._oscillator.type}set type(t){t.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(3)):t==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):t==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=t)}get partials(){return this._oscillator.partials}set partials(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=t)}get partialCount(){return this._oscillator.partialCount}set partialCount(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=t)}set(t){return Reflect.has(t,"type")&&t.type&&(this.type=t.type),super.set(t),this}_createNewOscillator(t){if(t!==this._sourceType){this._sourceType=t;const e=xh[t],o=this.now();if(this._oscillator){const c=this._oscillator;c.stop(o),this.context.setTimeout(()=>c.dispose(),this.blockTime)}this._oscillator=new e({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(o)}}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t}get sourceType(){return this._sourceType}set sourceType(t){let e="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(e=this._oscillator.type),t==="fm"?this.type="fm"+e:t==="am"?this.type="am"+e:t==="fat"?this.type="fat"+e:t==="oscillator"?this.type=e:t==="pulse"?this.type="pulse":t==="pwm"&&(this.type="pwm")}_getOscType(t,e){return t instanceof xh[e]}get baseType(){return this._oscillator.baseType}set baseType(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||t==="pulse"||t==="pwm"||(this._oscillator.baseType=t)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(t){this._getOscType(this._oscillator,"fat")&&es(t)&&(this._oscillator.count=t)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(t){this._getOscType(this._oscillator,"fat")&&es(t)&&(this._oscillator.spread=t)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(t){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Ss(t)&&(this._oscillator.modulationType=t)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return Zt(this,arguments,void 0,function*(t=1024){return kn(this,t)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}class Pn extends St{constructor(){super(K(Pn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new yt({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,os(this._constantSource,this._sum)}static getDefaults(){return Object.assign(St.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class en extends as{constructor(){const t=K(en.getDefaults(),arguments,["min","max"]);super(t),this.name="Scale",this._mult=this.input=new ae({context:this.context,value:t.max-t.min}),this._add=this.output=new Pn({context:this.context,value:t.min}),this._min=t.min,this._max=t.max,this.input.connect(this.output)}static getDefaults(){return Object.assign(as.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(t){this._min=t,this._setRange()}get max(){return this._max}set max(t){this._max=t,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class er extends as{constructor(){super(K(er.getDefaults(),arguments)),this.name="Zero",this._gain=new yt({context:this.context}),this.output=this._gain,this.input=void 0,$e(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),pa(this.context.getConstant(0),this._gain),this}}class je extends it{constructor(){const t=K(je.getDefaults(),arguments,["frequency","min","max"]);super(t),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=Ct.prototype._fromType,this._toType=Ct.prototype._toType,this._is=Ct.prototype._is,this._clampValue=Ct.prototype._clampValue,this._oscillator=new re(t),this.frequency=this._oscillator.frequency,this._amplitudeGain=new yt({context:this.context,gain:t.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new St({context:this.context,units:"audioRange",value:0}),this._zeros=new er({context:this.context}),this._a2g=new tr({context:this.context}),this._scaler=this.output=new en({context:this.context,max:t.max,min:t.min}),this.units=t.units,this.min=t.min,this.max=t.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),xt(this,["amplitude","frequency"]),this.phase=t.phase}static getDefaults(){return Object.assign(re.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(0,t),this._oscillator.start(t),this}stop(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(this._stoppedValue,t),this._oscillator.stop(t),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(t){t=this._fromType(t),this._scaler.min=t}get max(){return this._toType(this._scaler.max)}set max(t){t=this._fromType(t),this._scaler.max=t}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(t){this._oscillator.partials=t,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t,this._setStoppedValue()}get units(){return this._units}set units(t){const e=this.min,o=this.max;this._units=t,this.min=e,this.max=o}get state(){return this._oscillator.state}connect(t,e,o){return(t instanceof Ct||t instanceof St)&&(this.convert=t.convert,this.units=t.units),Yi(this,t,e,o),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}function Sh(h,t=1/0){const e=new WeakMap;return function(o,c){Reflect.defineProperty(o,c,{configurable:!0,enumerable:!0,get:function(){return e.get(this)},set:function(w){Ee(w,h,t),e.set(this,w)}})}}function sn(h,t=1/0){const e=new WeakMap;return function(o,c){Reflect.defineProperty(o,c,{configurable:!0,enumerable:!0,get:function(){return e.get(this)},set:function(w){Ee(this.toSeconds(w),h,t),e.set(this,w)}})}}class _i extends ue{constructor(){const t=K(_i.getDefaults(),arguments,["url","onload"]);super(t),this.name="Player",this._activeSources=new Set,this._buffer=new Ft({onload:this._onload.bind(this,t.onload),onerror:t.onerror,reverse:t.reverse,url:t.url}),this.autostart=t.autostart,this._loop=t.loop,this._loopStart=t.loopStart,this._loopEnd=t.loopEnd,this._playbackRate=t.playbackRate,this.fadeIn=t.fadeIn,this.fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ue.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Ot,onerror:Ot,playbackRate:1,reverse:!1})}load(t){return Zt(this,void 0,void 0,function*(){return yield this._buffer.load(t),this._onload(),this})}_onload(t=Ot){t(),this.autostart&&this.start()}_onSourceEnd(t){this.onstop(this),this._activeSources.delete(t),this._activeSources.size!==0||this._synced||this._state.getValueAtTime(this.now())!=="started"||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(t,e,o){return super.start(t,e,o),this}_start(t,e,o){e=this._loop?fs(e,this._loopStart):fs(e,0);const c=this.toSeconds(e),w=o;o=fs(o,Math.max(this._buffer.duration-c,0));let M=this.toSeconds(o);M/=this._playbackRate,t=this.toSeconds(t);const C=new gn({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(t+M),this._state.setStateAtTime("stopped",t+M,{implicitEnd:!0})),this._activeSources.add(C),this._loop&&Ye(w)?C.start(t,c):C.start(t,c,M-this.toSeconds(this.fadeOut))}_stop(t){const e=this.toSeconds(t);this._activeSources.forEach(o=>o.stop(e))}restart(t,e,o){return super.restart(t,e,o),this}_restart(t,e,o){var c;(c=[...this._activeSources].pop())===null||c===void 0||c.stop(t),this._start(t,e,o)}seek(t,e){const o=this.toSeconds(e);if(this._state.getValueAtTime(o)==="started"){const c=this.toSeconds(t);this._stop(o),this._start(o,c)}return this}setLoopPoints(t,e){return this.loopStart=t,this.loopEnd=e,this}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this.buffer.loaded&&Ee(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(e=>{e.loopStart=t})}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this.buffer.loaded&&Ee(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(e=>{e.loopEnd=t})}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._loop}set loop(t){if(this._loop!==t&&(this._loop=t,this._activeSources.forEach(e=>{e.loop=t}),t)){const e=this._state.getNextState("stopped",this.now());e&&this._state.cancel(e.time)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t;const e=this.now(),o=this._state.getNextState("stopped",e);o&&o.implicitEnd&&(this._state.cancel(o.time),this._activeSources.forEach(c=>c.cancelStop())),this._activeSources.forEach(c=>{c.playbackRate.setValueAtTime(t,e)})}get reverse(){return this._buffer.reverse}set reverse(t){this._buffer.reverse=t}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(t=>t.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}Ts([sn(0)],_i.prototype,"fadeIn",void 0),Ts([sn(0)],_i.prototype,"fadeOut",void 0);class _a extends it{constructor(){const t=K(_a.getDefaults(),arguments,["urls","onload"],"urls");super(t),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new Js({context:this.context,volume:t.volume}),this.volume=this._volume.volume,xt(this,"volume"),this._buffers=new pi({urls:t.urls,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.mute=t.mute,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ue.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:Ot,onerror:Ot,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._players.forEach(e=>{e.fadeIn=t})}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._players.forEach(e=>{e.fadeOut=t})}get state(){return Array.from(this._players).some(([t,e])=>e.state==="started")?"started":"stopped"}has(t){return this._buffers.has(t)}player(t){if(bt(this.has(t),`No Player with the name ${t} exists on this object`),!this._players.has(t)){const e=new _i({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(t)}).connect(this.output);this._players.set(t,e)}return this._players.get(t)}get loaded(){return this._buffers.loaded}add(t,e,o){return bt(!this._buffers.has(t),"A buffer with that name already exists on this object"),this._buffers.add(t,e,o),this}stopAll(t){return this._players.forEach(e=>e.stop(t)),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach(t=>t.dispose()),this._buffers.dispose(),this}}class wa extends ue{constructor(){const t=K(wa.getDefaults(),arguments,["url","onload"]);super(t),this.name="GrainPlayer",this._loopStart=0,this._loopEnd=0,this._activeSources=[],this.buffer=new Ft({onload:t.onload,onerror:t.onerror,reverse:t.reverse,url:t.url}),this._clock=new fi({context:this.context,callback:this._tick.bind(this),frequency:1/t.grainSize}),this._playbackRate=t.playbackRate,this._grainSize=t.grainSize,this._overlap=t.overlap,this.detune=t.detune,this.overlap=t.overlap,this.loop=t.loop,this.playbackRate=t.playbackRate,this.grainSize=t.grainSize,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.reverse=t.reverse,this._clock.on("stop",this._onstop.bind(this))}static getDefaults(){return Object.assign(ue.getDefaults(),{onload:Ot,onerror:Ot,overlap:.1,grainSize:.2,playbackRate:1,detune:0,loop:!1,loopStart:0,loopEnd:0,reverse:!1})}_start(t,e,o){e=fs(e,0),e=this.toSeconds(e),t=this.toSeconds(t);const c=1/this._clock.frequency.getValueAtTime(t);this._clock.start(t,e/c),o&&this.stop(t+this.toSeconds(o))}restart(t,e,o){return super.restart(t,e,o),this}_restart(t,e,o){this._stop(t),this._start(t,e,o)}_stop(t){this._clock.stop(t)}_onstop(t){this._activeSources.forEach(e=>{e.fadeOut=0,e.stop(t)}),this.onstop(this)}_tick(t){const e=this._clock.getTicksAtTime(t),o=e*this._grainSize;if(this.log("offset",o),!this.loop&&o>this.buffer.duration)return void this.stop(t);const c=o<this._overlap?0:this._overlap,w=new gn({context:this.context,url:this.buffer,fadeIn:c,fadeOut:this._overlap,loop:this.loop,loopStart:this._loopStart,loopEnd:this._loopEnd,playbackRate:hi(this.detune/100)}).connect(this.output);w.start(t,this._grainSize*e),w.stop(t+this._grainSize/this.playbackRate),this._activeSources.push(w),w.onended=()=>{const M=this._activeSources.indexOf(w);M!==-1&&this._activeSources.splice(M,1)}}get playbackRate(){return this._playbackRate}set playbackRate(t){Ee(t,.001),this._playbackRate=t,this.grainSize=this._grainSize}get loopStart(){return this._loopStart}set loopStart(t){this.buffer.loaded&&Ee(this.toSeconds(t),0,this.buffer.duration),this._loopStart=this.toSeconds(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this.buffer.loaded&&Ee(this.toSeconds(t),0,this.buffer.duration),this._loopEnd=this.toSeconds(t)}get reverse(){return this.buffer.reverse}set reverse(t){this.buffer.reverse=t}get grainSize(){return this._grainSize}set grainSize(t){this._grainSize=this.toSeconds(t),this._clock.frequency.setValueAtTime(this._playbackRate/this._grainSize,this.now())}get overlap(){return this._overlap}set overlap(t){const e=this.toSeconds(t);Ee(e,0),this._overlap=e}get loaded(){return this.buffer.loaded}dispose(){return super.dispose(),this.buffer.dispose(),this._clock.dispose(),this._activeSources.forEach(t=>t.dispose()),this}}class Th extends as{constructor(){super(...arguments),this.name="Abs",this._abs=new Cs({context:this.context,mapping:t=>Math.abs(t)<.001?0:Math.abs(t)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class Mh extends as{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new Cs({context:this.context,mapping:t=>2*Math.abs(t)-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class xa extends as{constructor(){super(...arguments),this.name="Negate",this._multiply=new ae({context:this.context,value:-1}),this.input=this._multiply,this.output=this._multiply}dispose(){return super.dispose(),this._multiply.dispose(),this}}class En extends St{constructor(){super(K(En.getDefaults(),arguments,["value"])),this.override=!1,this.name="Subtract",this._sum=new yt({context:this.context}),this.input=this._sum,this.output=this._sum,this._neg=new xa({context:this.context}),this.subtrahend=this._param,os(this._constantSource,this._neg,this._sum)}static getDefaults(){return Object.assign(St.getDefaults(),{value:0})}dispose(){return super.dispose(),this._neg.dispose(),this._sum.dispose(),this}}class sr extends as{constructor(){super(K(sr.getDefaults(),arguments)),this.name="GreaterThanZero",this._thresh=this.output=new Cs({context:this.context,length:127,mapping:t=>t<=0?0:1}),this._scale=this.input=new ae({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class nr extends St{constructor(){const t=K(nr.getDefaults(),arguments,["value"]);super(t),this.name="GreaterThan",this.override=!1,this._subtract=this.input=new En({context:this.context,value:t.value}),this._gtz=this.output=new sr({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,xt(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(St.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class ir extends en{constructor(){const t=K(ir.getDefaults(),arguments,["min","max","exponent"]);super(t),this.name="ScaleExp",this.input=this._exp=new gi({context:this.context,value:t.exponent}),this._exp.connect(this._mult)}static getDefaults(){return Object.assign(en.getDefaults(),{exponent:1})}get exponent(){return this._exp.value}set exponent(t){this._exp.value=t}dispose(){return super.dispose(),this._exp.dispose(),this}}class Dp extends St{constructor(){const t=K(St.getDefaults(),arguments,["value","units"]);super(t),this.name="SyncedSignal",this.override=!1,this._lastVal=t.value,this._synced=this.context.transport.scheduleRepeat(this._onTick.bind(this),"1i"),this._syncedCallback=this._anchorValue.bind(this),this.context.transport.on("start",this._syncedCallback),this.context.transport.on("pause",this._syncedCallback),this.context.transport.on("stop",this._syncedCallback),this._constantSource.disconnect(),this._constantSource.stop(0),this._constantSource=this.output=new Jo({context:this.context,offset:t.value,units:t.units}).start(0),this.setValueAtTime(t.value,0)}_onTick(t){const e=super.getValueAtTime(this.context.transport.seconds);this._lastVal!==e&&(this._lastVal=e,this._constantSource.offset.setValueAtTime(e,t))}_anchorValue(t){const e=super.getValueAtTime(this.context.transport.seconds);this._lastVal=e,this._constantSource.offset.cancelAndHoldAtTime(t),this._constantSource.offset.setValueAtTime(e,t)}getValueAtTime(t){const e=new me(this.context,t).toSeconds();return super.getValueAtTime(e)}setValueAtTime(t,e){const o=new me(this.context,e).toSeconds();return super.setValueAtTime(t,o),this}linearRampToValueAtTime(t,e){const o=new me(this.context,e).toSeconds();return super.linearRampToValueAtTime(t,o),this}exponentialRampToValueAtTime(t,e){const o=new me(this.context,e).toSeconds();return super.exponentialRampToValueAtTime(t,o),this}setTargetAtTime(t,e,o){const c=new me(this.context,e).toSeconds();return super.setTargetAtTime(t,c,o),this}cancelScheduledValues(t){const e=new me(this.context,t).toSeconds();return super.cancelScheduledValues(e),this}setValueCurveAtTime(t,e,o,c){const w=new me(this.context,e).toSeconds();return o=this.toSeconds(o),super.setValueCurveAtTime(t,w,o,c),this}cancelAndHoldAtTime(t){const e=new me(this.context,t).toSeconds();return super.cancelAndHoldAtTime(e),this}setRampPoint(t){const e=new me(this.context,t).toSeconds();return super.setRampPoint(e),this}exponentialRampTo(t,e,o){const c=new me(this.context,o).toSeconds();return super.exponentialRampTo(t,e,c),this}linearRampTo(t,e,o){const c=new me(this.context,o).toSeconds();return super.linearRampTo(t,e,c),this}targetRampTo(t,e,o){const c=new me(this.context,o).toSeconds();return super.targetRampTo(t,e,c),this}dispose(){return super.dispose(),this.context.transport.clear(this._synced),this.context.transport.off("start",this._syncedCallback),this.context.transport.off("pause",this._syncedCallback),this.context.transport.off("stop",this._syncedCallback),this._constantSource.dispose(),this}}class Oe extends it{constructor(){const t=K(Oe.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="Envelope",this._sig=new St({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=t.attack,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.attackCurve=t.attackCurve,this.releaseCurve=t.releaseCurve,this.decayCurve=t.decayCurve}static getDefaults(){return Object.assign(it.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(t,e){if(Ss(t))return t;{let o;for(o in or)if(or[o][e]===t)return o;return t}}_setCurve(t,e,o){if(Ss(o)&&Reflect.has(or,o)){const c=or[o];Zs(c)?t!=="_decayCurve"&&(this[t]=c[e]):this[t]=c}else{if(!Pe(o)||t==="_decayCurve")throw new Error("Envelope: invalid curve: "+o);this[t]=o}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(t){this._setCurve("_attackCurve","In",t)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(t){this._setCurve("_releaseCurve","Out",t)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(t){this._setCurve("_decayCurve","Out",t)}triggerAttack(t,e=1){this.log("triggerAttack",t,e),t=this.toSeconds(t);let o=this.toSeconds(this.attack);const c=this.toSeconds(this.decay),w=this.getValueAtTime(t);if(w>0&&(o=(1-w)/(1/o)),o<this.sampleTime)this._sig.cancelScheduledValues(t),this._sig.setValueAtTime(e,t);else if(this._attackCurve==="linear")this._sig.linearRampTo(e,o,t);else if(this._attackCurve==="exponential")this._sig.targetRampTo(e,o,t);else{this._sig.cancelAndHoldAtTime(t);let M=this._attackCurve;for(let C=1;C<M.length;C++)if(M[C-1]<=w&&w<=M[C]){M=this._attackCurve.slice(C),M[0]=w;break}this._sig.setValueCurveAtTime(M,t,o,e)}if(c&&this.sustain<1){const M=e*this.sustain,C=t+o;this.log("decay",C),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(M,c+C):this._sig.exponentialApproachValueAtTime(M,C,c)}return this}triggerRelease(t){this.log("triggerRelease",t),t=this.toSeconds(t);const e=this.getValueAtTime(t);if(e>0){const o=this.toSeconds(this.release);o<this.sampleTime?this._sig.setValueAtTime(0,t):this._releaseCurve==="linear"?this._sig.linearRampTo(0,o,t):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,o,t):(bt(Pe(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(t),this._sig.setValueCurveAtTime(this._releaseCurve,t,o,e))}return this}getValueAtTime(t){return this._sig.getValueAtTime(t)}triggerAttackRelease(t,e,o=1){return e=this.toSeconds(e),this.triggerAttack(e,o),this.triggerRelease(e+this.toSeconds(t)),this}cancel(t){return this._sig.cancelScheduledValues(this.toSeconds(t)),this}connect(t,e=0,o=0){return Yi(this,t,e,o),this}asArray(){return Zt(this,arguments,void 0,function*(t=1024){const e=t/this.context.sampleRate,o=new li(1,e,this.context.sampleRate),c=this.toSeconds(this.attack)+this.toSeconds(this.decay),w=c+this.toSeconds(this.release),M=.1*w,C=w+M,k=new this.constructor(Object.assign(this.get(),{attack:e*this.toSeconds(this.attack)/C,decay:e*this.toSeconds(this.decay)/C,release:e*this.toSeconds(this.release)/C,context:o}));return k._sig.toDestination(),k.triggerAttackRelease(e*(c+M)/C,0),(yield o.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}Ts([sn(0)],Oe.prototype,"attack",void 0),Ts([sn(0)],Oe.prototype,"decay",void 0),Ts([Sh(0,1)],Oe.prototype,"sustain",void 0),Ts([sn(0)],Oe.prototype,"release",void 0);const or=(()=>{let t,e;const o=[];for(t=0;t<128;t++)o[t]=Math.sin(t/127*(Math.PI/2));const c=[];for(t=0;t<127;t++){e=t/127;const I=Math.sin(e*(2*Math.PI)*6.4-Math.PI/2)+1;c[t]=I/10+.83*e}c[127]=1;const w=[];for(t=0;t<128;t++)w[t]=Math.ceil(t/127*5)/5;const M=[];for(t=0;t<128;t++)e=t/127,M[t]=.5*(1-Math.cos(Math.PI*e));const C=[];for(t=0;t<128;t++){e=t/127;const I=4*Math.pow(e,3)+.2,D=Math.cos(I*Math.PI*2*e);C[t]=Math.abs(D*(1-e))}function k(I){const D=new Array(I.length);for(let R=0;R<I.length;R++)D[R]=1-I[R];return D}return{bounce:{In:k(C),Out:C},cosine:{In:o,Out:(P=o,P.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:c,Out:k(c)},sine:{In:M,Out:k(M)},step:{In:w,Out:k(w)}};var P})();class ps extends it{constructor(){const t=K(ps.getDefaults(),arguments);super(t),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=e=>this._original_triggerRelease(e),this._volume=this.output=new Js({context:this.context,volume:t.volume}),this.volume=this._volume.volume,xt(this,"volume")}static getDefaults(){return Object.assign(it.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let t=!1;return this._synced||(this._synced=!0,t=!0),t}_syncMethod(t,e){const o=this["_original_"+t]=this[t];this[t]=(...c)=>{const w=c[e],M=this.context.transport.schedule(C=>{c[e]=C,o.apply(this,c)},w);this._scheduledEvents.push(M)}}unsync(){return this._scheduledEvents.forEach(t=>this.context.transport.clear(t)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(t,e,o,c){const w=this.toSeconds(o),M=this.toSeconds(e);return this.triggerAttack(t,w,c),this.triggerRelease(w+M),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class De extends ps{constructor(){const t=K(De.getDefaults(),arguments);super(t),this.portamento=t.portamento,this.onsilence=t.onsilence}static getDefaults(){return Object.assign(ps.getDefaults(),{detune:0,onsilence:Ot,portamento:0})}triggerAttack(t,e,o=1){this.log("triggerAttack",t,e,o);const c=this.toSeconds(e);return this._triggerEnvelopeAttack(c,o),this.setNote(t,c),this}triggerRelease(t){this.log("triggerRelease",t);const e=this.toSeconds(t);return this._triggerEnvelopeRelease(e),this}setNote(t,e){const o=this.toSeconds(e),c=t instanceof Ve?t.toFrequency():t;if(this.portamento>0&&this.getLevelAtTime(o)>.05){const w=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(c,w,o)}else this.frequency.setValueAtTime(c,o);return this}}Ts([sn(0)],De.prototype,"portamento",void 0);class wi extends Oe{constructor(){super(K(wi.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new yt({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class yn extends De{constructor(){const t=K(yn.getDefaults(),arguments);super(t),this.name="Synth",this.oscillator=new tn(Object.assign({context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)},t.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new wi(Object.assign({context:this.context},t.envelope)),this.oscillator.chain(this.envelope,this.output),xt(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(De.getDefaults(),{envelope:Object.assign(Ie(Oe.getDefaults(),Object.keys(it.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(Ie(tn.getDefaults(),[...Object.keys(ue.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(t,e){if(this.envelope.triggerAttack(t,e),this.oscillator.start(t),this.envelope.sustain===0){const o=this.toSeconds(this.envelope.attack),c=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+o+c)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class eo extends De{constructor(){const t=K(eo.getDefaults(),arguments);super(t),this.name="ModulationSynth",this._carrier=new yn({context:this.context,oscillator:t.oscillator,envelope:t.envelope,onsilence:()=>this.onsilence(this),volume:-10}),this._modulator=new yn({context:this.context,oscillator:t.modulation,envelope:t.modulationEnvelope,volume:-10}),this.oscillator=this._carrier.oscillator,this.envelope=this._carrier.envelope,this.modulation=this._modulator.oscillator,this.modulationEnvelope=this._modulator.envelope,this.frequency=new St({context:this.context,units:"frequency"}),this.detune=new St({context:this.context,value:t.detune,units:"cents"}),this.harmonicity=new ae({context:this.context,value:t.harmonicity,minValue:0}),this._modulationNode=new yt({context:this.context,gain:0}),xt(this,["frequency","harmonicity","oscillator","envelope","modulation","modulationEnvelope","detune"])}static getDefaults(){return Object.assign(De.getDefaults(),{harmonicity:3,oscillator:Object.assign(Ie(tn.getDefaults(),[...Object.keys(ue.getDefaults()),"frequency","detune"]),{type:"sine"}),envelope:Object.assign(Ie(Oe.getDefaults(),Object.keys(it.getDefaults())),{attack:.01,decay:.01,sustain:1,release:.5}),modulation:Object.assign(Ie(tn.getDefaults(),[...Object.keys(ue.getDefaults()),"frequency","detune"]),{type:"square"}),modulationEnvelope:Object.assign(Ie(Oe.getDefaults(),Object.keys(it.getDefaults())),{attack:.5,decay:0,sustain:1,release:.5})})}_triggerEnvelopeAttack(t,e){this._carrier._triggerEnvelopeAttack(t,e),this._modulator._triggerEnvelopeAttack(t,e)}_triggerEnvelopeRelease(t){return this._carrier._triggerEnvelopeRelease(t),this._modulator._triggerEnvelopeRelease(t),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this._carrier.dispose(),this._modulator.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._modulationNode.dispose(),this}}class Sa extends eo{constructor(){super(K(Sa.getDefaults(),arguments)),this.name="AMSynth",this._modulationScale=new tr({context:this.context}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output)}dispose(){return super.dispose(),this._modulationScale.dispose(),this}}class so extends it{constructor(){const t=K(so.getDefaults(),arguments,["frequency","type"]);super(t),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new Ct({context:this.context,units:"number",value:t.Q,param:this._filter.Q}),this.frequency=new Ct({context:this.context,units:"frequency",value:t.frequency,param:this._filter.frequency}),this.detune=new Ct({context:this.context,units:"cents",value:t.detune,param:this._filter.detune}),this.gain=new Ct({context:this.context,units:"decibels",convert:!1,value:t.gain,param:this._filter.gain}),this.type=t.type}static getDefaults(){return Object.assign(it.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(t){bt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._filter.type=t}getFrequencyResponse(t=128){const e=new Float32Array(t);for(let M=0;M<t;M++){const C=19980*Math.pow(M/t,2)+20;e[M]=C}const o=new Float32Array(t),c=new Float32Array(t),w=this.context.createBiquadFilter();return w.type=this.type,w.Q.value=this.Q.value,w.frequency.value=this.frequency.value,w.gain.value=this.gain.value,w.getFrequencyResponse(e,o,c),o}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class ls extends it{constructor(){const t=K(ls.getDefaults(),arguments,["frequency","type","rolloff"]);super(t),this.name="Filter",this.input=new yt({context:this.context}),this.output=new yt({context:this.context}),this._filters=[],this._filters=[],this.Q=new St({context:this.context,units:"positive",value:t.Q}),this.frequency=new St({context:this.context,units:"frequency",value:t.frequency}),this.detune=new St({context:this.context,units:"cents",value:t.detune}),this.gain=new St({context:this.context,units:"decibels",convert:!1,value:t.gain}),this._type=t.type,this.rolloff=t.rolloff,xt(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(it.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(t){bt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._type=t,this._filters.forEach(e=>e.type=t)}get rolloff(){return this._rolloff}set rolloff(t){const e=es(t)?t:parseInt(t,10),o=[-12,-24,-48,-96];let c=o.indexOf(e);bt(c!==-1,`rolloff can only be ${o.join(", ")}`),c+=1,this._rolloff=e,this.input.disconnect(),this._filters.forEach(w=>w.disconnect()),this._filters=new Array(c);for(let w=0;w<c;w++){const M=new so({context:this.context});M.type=this._type,this.frequency.connect(M.frequency),this.detune.connect(M.detune),this.Q.connect(M.Q),this.gain.connect(M.gain),this._filters[w]=M}this._internalChannels=this._filters,os(this.input,...this._internalChannels,this.output)}getFrequencyResponse(t=128){const e=new so({frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),o=new Float32Array(t).map(()=>1);return this._filters.forEach(()=>{e.getFrequencyResponse(t).forEach((c,w)=>o[w]*=c)}),e.dispose(),o}dispose(){return super.dispose(),this._filters.forEach(t=>{t.dispose()}),Hi(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class no extends Oe{constructor(){const t=K(no.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="FrequencyEnvelope",this._octaves=t.octaves,this._baseFrequency=this.toFrequency(t.baseFrequency),this._exponent=this.input=new gi({context:this.context,value:t.exponent}),this._scale=this.output=new en({context:this.context,min:this._baseFrequency,max:this._baseFrequency*Math.pow(2,this._octaves)}),this._sig.chain(this._exponent,this._scale)}static getDefaults(){return Object.assign(Oe.getDefaults(),{baseFrequency:200,exponent:1,octaves:4})}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){const e=this.toFrequency(t);Ee(e,0),this._baseFrequency=e,this._scale.min=this._baseFrequency,this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._scale.max=this._baseFrequency*Math.pow(2,t)}get exponent(){return this._exponent.value}set exponent(t){this._exponent.value=t}dispose(){return super.dispose(),this._exponent.dispose(),this._scale.dispose(),this}}class In extends De{constructor(){const t=K(In.getDefaults(),arguments);super(t),this.name="MonoSynth",this.oscillator=new tn(Object.assign(t.oscillator,{context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)})),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.filter=new ls(Object.assign(t.filter,{context:this.context})),this.filterEnvelope=new no(Object.assign(t.filterEnvelope,{context:this.context})),this.envelope=new wi(Object.assign(t.envelope,{context:this.context})),this.oscillator.chain(this.filter,this.envelope,this.output),this.filterEnvelope.connect(this.filter.frequency),xt(this,["oscillator","frequency","detune","filter","filterEnvelope","envelope"])}static getDefaults(){return Object.assign(De.getDefaults(),{envelope:Object.assign(Ie(Oe.getDefaults(),Object.keys(it.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.9}),filter:Object.assign(Ie(ls.getDefaults(),Object.keys(it.getDefaults())),{Q:1,rolloff:-12,type:"lowpass"}),filterEnvelope:Object.assign(Ie(no.getDefaults(),Object.keys(it.getDefaults())),{attack:.6,baseFrequency:200,decay:.2,exponent:2,octaves:3,release:2,sustain:.5}),oscillator:Object.assign(Ie(tn.getDefaults(),Object.keys(ue.getDefaults())),{type:"sawtooth"})})}_triggerEnvelopeAttack(t,e=1){if(this.envelope.triggerAttack(t,e),this.filterEnvelope.triggerAttack(t),this.oscillator.start(t),this.envelope.sustain===0){const o=this.toSeconds(this.envelope.attack),c=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+o+c)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.filterEnvelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this.filterEnvelope.dispose(),this.filter.dispose(),this}}class Ta extends De{constructor(){const t=K(Ta.getDefaults(),arguments);super(t),this.name="DuoSynth",this.voice0=new In(Object.assign(t.voice0,{context:this.context,onsilence:()=>this.onsilence(this)})),this.voice1=new In(Object.assign(t.voice1,{context:this.context})),this.harmonicity=new ae({context:this.context,units:"positive",value:t.harmonicity}),this._vibrato=new je({frequency:t.vibratoRate,context:this.context,min:-50,max:50}),this._vibrato.start(),this.vibratoRate=this._vibrato.frequency,this._vibratoGain=new yt({context:this.context,units:"normalRange",gain:t.vibratoAmount}),this.vibratoAmount=this._vibratoGain.gain,this.frequency=new St({context:this.context,units:"frequency",value:440}),this.detune=new St({context:this.context,units:"cents",value:t.detune}),this.frequency.connect(this.voice0.frequency),this.frequency.chain(this.harmonicity,this.voice1.frequency),this._vibrato.connect(this._vibratoGain),this._vibratoGain.fan(this.voice0.detune,this.voice1.detune),this.detune.fan(this.voice0.detune,this.voice1.detune),this.voice0.connect(this.output),this.voice1.connect(this.output),xt(this,["voice0","voice1","frequency","vibratoAmount","vibratoRate"])}getLevelAtTime(t){return t=this.toSeconds(t),this.voice0.envelope.getValueAtTime(t)+this.voice1.envelope.getValueAtTime(t)}static getDefaults(){return ds(De.getDefaults(),{vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:ds(Ie(In.getDefaults(),Object.keys(De.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}}),voice1:ds(Ie(In.getDefaults(),Object.keys(De.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}})})}_triggerEnvelopeAttack(t,e){this.voice0._triggerEnvelopeAttack(t,e),this.voice1._triggerEnvelopeAttack(t,e)}_triggerEnvelopeRelease(t){return this.voice0._triggerEnvelopeRelease(t),this.voice1._triggerEnvelopeRelease(t),this}dispose(){return super.dispose(),this.voice0.dispose(),this.voice1.dispose(),this.frequency.dispose(),this.detune.dispose(),this._vibrato.dispose(),this.vibratoRate.dispose(),this._vibratoGain.dispose(),this.harmonicity.dispose(),this}}class Ma extends eo{constructor(){const t=K(Ma.getDefaults(),arguments);super(t),this.name="FMSynth",this.modulationIndex=new ae({context:this.context,value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output)}static getDefaults(){return Object.assign(eo.getDefaults(),{modulationIndex:10})}dispose(){return super.dispose(),this.modulationIndex.dispose(),this}}const Ch=[1,1.483,1.932,2.546,2.63,3.897];class Ca extends De{constructor(){const t=K(Ca.getDefaults(),arguments);super(t),this.name="MetalSynth",this._oscillators=[],this._freqMultipliers=[],this.detune=new St({context:this.context,units:"cents",value:t.detune}),this.frequency=new St({context:this.context,units:"frequency"}),this._amplitude=new yt({context:this.context,gain:0}).connect(this.output),this._highpass=new ls({Q:0,context:this.context,type:"highpass"}).connect(this._amplitude);for(let e=0;e<Ch.length;e++){const o=new yi({context:this.context,harmonicity:t.harmonicity,modulationIndex:t.modulationIndex,modulationType:"square",onstop:e===0?()=>this.onsilence(this):Ot,type:"square"});o.connect(this._highpass),this._oscillators[e]=o;const c=new ae({context:this.context,value:Ch[e]});this._freqMultipliers[e]=c,this.frequency.chain(c,o.frequency),this.detune.connect(o.detune)}this._filterFreqScaler=new en({context:this.context,max:7e3,min:this.toFrequency(t.resonance)}),this.envelope=new Oe({attack:t.envelope.attack,attackCurve:"linear",context:this.context,decay:t.envelope.decay,release:t.envelope.release,sustain:0}),this.envelope.chain(this._filterFreqScaler,this._highpass.frequency),this.envelope.connect(this._amplitude.gain),this._octaves=t.octaves,this.octaves=t.octaves}static getDefaults(){return ds(De.getDefaults(),{envelope:Object.assign(Ie(Oe.getDefaults(),Object.keys(it.getDefaults())),{attack:.001,decay:1.4,release:.2}),harmonicity:5.1,modulationIndex:32,octaves:1.5,resonance:4e3})}_triggerEnvelopeAttack(t,e=1){return this.envelope.triggerAttack(t,e),this._oscillators.forEach(o=>o.start(t)),this.envelope.sustain===0&&this._oscillators.forEach(o=>{o.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay))}),this}_triggerEnvelopeRelease(t){return this.envelope.triggerRelease(t),this._oscillators.forEach(e=>e.stop(t+this.toSeconds(this.envelope.release))),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}get modulationIndex(){return this._oscillators[0].modulationIndex.value}set modulationIndex(t){this._oscillators.forEach(e=>e.modulationIndex.value=t)}get harmonicity(){return this._oscillators[0].harmonicity.value}set harmonicity(t){this._oscillators.forEach(e=>e.harmonicity.value=t)}get resonance(){return this._filterFreqScaler.min}set resonance(t){this._filterFreqScaler.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._filterFreqScaler.max=this._filterFreqScaler.min*Math.pow(2,t)}dispose(){return super.dispose(),this._oscillators.forEach(t=>t.dispose()),this._freqMultipliers.forEach(t=>t.dispose()),this.frequency.dispose(),this.detune.dispose(),this._filterFreqScaler.dispose(),this._amplitude.dispose(),this.envelope.dispose(),this._highpass.dispose(),this}}class io extends yn{constructor(){const t=K(io.getDefaults(),arguments);super(t),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=t.pitchDecay,this.octaves=t.octaves,xt(this,["oscillator","envelope"])}static getDefaults(){return ds(De.getDefaults(),yn.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(t,e){const o=this.toSeconds(e),c=this.toFrequency(t instanceof Ve?t.toFrequency():t),w=c*this.octaves;return this.oscillator.frequency.setValueAtTime(w,o),this.oscillator.frequency.exponentialRampToValueAtTime(c,o+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}Ts([Sh(0)],io.prototype,"octaves",void 0),Ts([sn(0)],io.prototype,"pitchDecay",void 0);class Aa extends ps{constructor(){const t=K(Aa.getDefaults(),arguments);super(t),this.name="NoiseSynth",this.noise=new vn(Object.assign({context:this.context},t.noise)),this.envelope=new wi(Object.assign({context:this.context},t.envelope)),this.noise.chain(this.envelope,this.output)}static getDefaults(){return Object.assign(ps.getDefaults(),{envelope:Object.assign(Ie(Oe.getDefaults(),Object.keys(it.getDefaults())),{decay:.1,sustain:0}),noise:Object.assign(Ie(vn.getDefaults(),Object.keys(ue.getDefaults())),{type:"white"})})}triggerAttack(t,e=1){return t=this.toSeconds(t),this.envelope.triggerAttack(t,e),this.noise.start(t),this.envelope.sustain===0&&this.noise.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay)),this}triggerRelease(t){return t=this.toSeconds(t),this.envelope.triggerRelease(t),this.noise.stop(t+this.toSeconds(this.envelope.release)),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",0),this._syncMethod("triggerRelease",0)),this}triggerAttackRelease(t,e,o=1){return e=this.toSeconds(e),t=this.toSeconds(t),this.triggerAttack(e,o),this.triggerRelease(e+t),this}dispose(){return super.dispose(),this.noise.dispose(),this.envelope.dispose(),this}}const ka=new Set;function Pa(h){ka.add(h)}function Ah(h,t){const e=`registerProcessor("${h}", ${t})`;ka.add(e)}class Ea extends it{constructor(t){super(t),this.name="ToneAudioWorklet",this.workletOptions={},this.onprocessorerror=Ot;const e=URL.createObjectURL(new Blob([Array.from(ka).join(`
`)],{type:"text/javascript"})),o=this._audioWorkletName();this._dummyGain=this.context.createGain(),this._dummyParam=this._dummyGain.gain,this.context.addAudioWorkletModule(e).then(()=>{this.disposed||(this._worklet=this.context.createAudioWorkletNode(o,this.workletOptions),this._worklet.onprocessorerror=this.onprocessorerror.bind(this),this.onReady(this._worklet))})}dispose(){return super.dispose(),this._dummyGain.disconnect(),this._worklet&&(this._worklet.port.postMessage("dispose"),this._worklet.disconnect()),this}}Pa(`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`),Pa(`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`),Pa(`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`);const kh="feedback-comb-filter";Ah(kh,`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`);class oo extends Ea{constructor(){const t=K(oo.getDefaults(),arguments,["delayTime","resonance"]);super(t),this.name="FeedbackCombFilter",this.input=new yt({context:this.context}),this.output=new yt({context:this.context}),this.delayTime=new Ct({context:this.context,value:t.delayTime,units:"time",minValue:0,maxValue:1,param:this._dummyParam,swappable:!0}),this.resonance=new Ct({context:this.context,value:t.resonance,units:"normalRange",param:this._dummyParam,swappable:!0}),xt(this,["resonance","delayTime"])}_audioWorkletName(){return kh}static getDefaults(){return Object.assign(it.getDefaults(),{delayTime:.1,resonance:.5})}onReady(t){os(this.input,t,this.output);const e=t.parameters.get("delayTime");this.delayTime.setParam(e);const o=t.parameters.get("feedback");this.resonance.setParam(o)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.delayTime.dispose(),this.resonance.dispose(),this}}class ro extends it{constructor(){const t=K(ro.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OnePoleFilter",this._frequency=t.frequency,this._type=t.type,this.input=new yt({context:this.context}),this.output=new yt({context:this.context}),this._createFilter()}static getDefaults(){return Object.assign(it.getDefaults(),{frequency:880,type:"lowpass"})}_createFilter(){const t=this._filter,e=this.toFrequency(this._frequency),o=1/(2*Math.PI*e);if(this._type==="lowpass"){const c=1/(o*this.context.sampleRate),w=c-1;this._filter=this.context.createIIRFilter([c,0],[1,w])}else{const c=1/(o*this.context.sampleRate)-1;this._filter=this.context.createIIRFilter([1,-1],[1,c])}this.input.chain(this._filter,this.output),t&&this.context.setTimeout(()=>{this.disposed||(this.input.disconnect(t),t.disconnect())},this.blockTime)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._createFilter()}get type(){return this._type}set type(t){this._type=t,this._createFilter()}getFrequencyResponse(t=128){const e=new Float32Array(t);for(let w=0;w<t;w++){const M=19980*Math.pow(w/t,2)+20;e[w]=M}const o=new Float32Array(t),c=new Float32Array(t);return this._filter.getFrequencyResponse(e,o,c),o}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this._filter.disconnect(),this}}class ao extends it{constructor(){const t=K(ao.getDefaults(),arguments,["delayTime","resonance","dampening"]);super(t),this.name="LowpassCombFilter",this._combFilter=this.output=new oo({context:this.context,delayTime:t.delayTime,resonance:t.resonance}),this.delayTime=this._combFilter.delayTime,this.resonance=this._combFilter.resonance,this._lowpass=this.input=new ro({context:this.context,frequency:t.dampening,type:"lowpass"}),this._lowpass.connect(this._combFilter)}static getDefaults(){return Object.assign(it.getDefaults(),{dampening:3e3,delayTime:.1,resonance:.5})}get dampening(){return this._lowpass.frequency}set dampening(t){this._lowpass.frequency=t}dispose(){return super.dispose(),this._combFilter.dispose(),this._lowpass.dispose(),this}}class Ia extends ps{constructor(){const t=K(Ia.getDefaults(),arguments);super(t),this.name="PluckSynth",this._noise=new vn({context:this.context,type:"pink"}),this.attackNoise=t.attackNoise,this._lfcf=new ao({context:this.context,dampening:t.dampening,resonance:t.resonance}),this.resonance=t.resonance,this.release=t.release,this._noise.connect(this._lfcf),this._lfcf.connect(this.output)}static getDefaults(){return ds(ps.getDefaults(),{attackNoise:1,dampening:4e3,resonance:.7,release:1})}get dampening(){return this._lfcf.dampening}set dampening(t){this._lfcf.dampening=t}triggerAttack(t,e){const o=this.toFrequency(t);e=this.toSeconds(e);const c=1/o;return this._lfcf.delayTime.setValueAtTime(c,e),this._noise.start(e),this._noise.stop(e+c*this.attackNoise),this._lfcf.resonance.cancelScheduledValues(e),this._lfcf.resonance.setValueAtTime(this.resonance,e),this}triggerRelease(t){return this._lfcf.resonance.linearRampTo(0,this.release,t),this}dispose(){return super.dispose(),this._noise.dispose(),this._lfcf.dispose(),this}}class Oa extends ps{constructor(){const t=K(Oa.getDefaults(),arguments,["voice","options"]);super(t),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=c=>this.releaseAll(c),bt(!es(t.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const e=t.voice.getDefaults();this.options=Object.assign(e,t.options),this.voice=t.voice,this.maxPolyphony=t.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const o=this._voices.indexOf(this._dummyVoice);this._voices.splice(o,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(ps.getDefaults(),{maxPolyphony:32,options:{},voice:yn})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(t){this._availableVoices.push(t);const e=this._activeVoices.findIndex(o=>o.voice===t);this._activeVoices.splice(e,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const t=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return bt(t instanceof De,"Voice must extend Monophonic class"),t.connect(this.output),this._voices.push(t),t}ni("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(.95*this._averageActiveVoices,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const t=this._availableVoices.shift(),e=this._voices.indexOf(t);this._voices.splice(e,1),this.context.isOffline||t.dispose()}}_triggerAttack(t,e,o){t.forEach(c=>{const w=new mi(this.context,c).toMidi(),M=this._getNextAvailableVoice();M&&(M.triggerAttack(c,e,o),this._activeVoices.push({midi:w,voice:M,released:!1}),this.log("triggerAttack",c,e))})}_triggerRelease(t,e){t.forEach(o=>{const c=new mi(this.context,o).toMidi(),w=this._activeVoices.find(({midi:M,released:C})=>M===c&&!C);w&&(w.voice.triggerRelease(e),w.released=!0,this.log("triggerRelease",o,e))})}_scheduleEvent(t,e,o,c){bt(!this.disposed,"Synth was already disposed"),o<=this.now()?t==="attack"?this._triggerAttack(e,o,c):this._triggerRelease(e,o):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(t,e,o,c)},o-this.now())}triggerAttack(t,e,o){Array.isArray(t)||(t=[t]);const c=this.toSeconds(e);return this._scheduleEvent("attack",t,c,o),this}triggerRelease(t,e){Array.isArray(t)||(t=[t]);const o=this.toSeconds(e);return this._scheduleEvent("release",t,o),this}triggerAttackRelease(t,e,o,c){const w=this.toSeconds(o);if(this.triggerAttack(t,w,c),Pe(e)){bt(Pe(t),"If the duration is an array, the notes must also be an array");for(let M=0;M<t.length;M++){const C=e[Math.min(M,e.length-1)],k=this.toSeconds(C);bt(k>0,"The duration must be greater than 0"),this.triggerRelease(t[M],w+k)}}else{const M=this.toSeconds(e);bt(M>0,"The duration must be greater than 0"),this.triggerRelease(t,w+M)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(t){const e=Ie(t,["onsilence","context"]);return this.options=ds(this.options,e),this._voices.forEach(o=>o.set(e)),this._dummyVoice.set(e),this}get(){return this._dummyVoice.get()}releaseAll(t){const e=this.toSeconds(t);return this._activeVoices.forEach(({voice:o})=>{o.triggerRelease(e)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(t=>t.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class lo extends ps{constructor(){const t=K(lo.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(t),this.name="Sampler",this._activeSources=new Map;const e={};Object.keys(t.urls).forEach(o=>{const c=parseInt(o,10);if(bt(Gi(o)||es(c)&&isFinite(c),`url key is neither a note or midi pitch: ${o}`),Gi(o)){const w=new Ve(this.context,o).toMidi();e[w]=t.urls[o]}else es(c)&&isFinite(c)&&(e[c]=t.urls[c])}),this._buffers=new pi({urls:e,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.attack=t.attack,this.release=t.release,this.curve=t.curve,this._buffers.loaded&&Promise.resolve().then(t.onload)}static getDefaults(){return Object.assign(ps.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Ot,onerror:Ot,release:.1,urls:{}})}_findClosest(t){let e=0;for(;e<96;){if(this._buffers.has(t+e))return-e;if(this._buffers.has(t-e))return e;e++}throw new Error(`No available buffers for note: ${t}`)}triggerAttack(t,e,o=1){return this.log("triggerAttack",t,e,o),Array.isArray(t)||(t=[t]),t.forEach(c=>{const w=bh(new Ve(this.context,c).toFrequency()),M=Math.round(w),C=w-M,k=this._findClosest(M),P=M-k,I=this._buffers.get(P),D=hi(k+C),R=new gn({url:I,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:D}).connect(this.output);R.start(e,0,I.duration/D,o),Pe(this._activeSources.get(M))||this._activeSources.set(M,[]),this._activeSources.get(M).push(R),R.onended=()=>{if(this._activeSources&&this._activeSources.has(M)){const N=this._activeSources.get(M),V=N.indexOf(R);V!==-1&&N.splice(V,1)}}}),this}triggerRelease(t,e){return this.log("triggerRelease",t,e),Array.isArray(t)||(t=[t]),t.forEach(o=>{const c=new Ve(this.context,o).toMidi();if(this._activeSources.has(c)&&this._activeSources.get(c).length){const w=this._activeSources.get(c);e=this.toSeconds(e),w.forEach(M=>{M.stop(e)}),this._activeSources.set(c,[])}}),this}releaseAll(t){const e=this.toSeconds(t);return this._activeSources.forEach(o=>{for(;o.length;)o.shift().stop(e)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(t,e,o,c=1){const w=this.toSeconds(o);return this.triggerAttack(t,w,c),Pe(e)?(bt(Pe(t),"notes must be an array when duration is array"),t.forEach((M,C)=>{const k=e[Math.min(C,e.length-1)];this.triggerRelease(M,w+this.toSeconds(k))})):this.triggerRelease(t,w+this.toSeconds(e)),this}add(t,e,o){if(bt(Gi(t)||isFinite(t),`note must be a pitch or midi: ${t}`),Gi(t)){const c=new Ve(this.context,t).toMidi();this._buffers.add(c,e,o)}else this._buffers.add(t,e,o);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(t=>{t.forEach(e=>e.dispose())}),this._activeSources.clear(),this}}Ts([sn(0)],lo.prototype,"attack",void 0),Ts([sn(0)],lo.prototype,"release",void 0);class Ls extends Me{constructor(){const t=K(Ls.getDefaults(),arguments,["callback","value"]);super(t),this.name="ToneEvent",this._state=new ui("stopped"),this._startOffset=0,this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Me.getDefaults(),{callback:Ot,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,e=>{let o;if(e.state==="started"){e.id!==-1&&this.context.transport.clear(e.id);const c=e.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||es(this._loop)&&this._loop>1){o=1/0,es(this._loop)&&(o=this._loop*this._getLoopDuration());const w=this._state.getAfter(c);w!==null&&(o=Math.min(o,w.time-c)),o!==1/0&&(o=new oe(this.context,o));const M=new oe(this.context,this._getLoopDuration());e.id=this.context.transport.scheduleRepeat(this._tick.bind(this),M,new oe(this.context,c),o)}else e.id=this.context.transport.schedule(this._tick.bind(this),new oe(this.context,c))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const e=this.toTicks(t);return this._state.getValueAtTime(e)==="stopped"&&(this._state.add({id:-1,state:"started",time:e}),this._rescheduleEvents(e)),this}stop(t){this.cancel(t);const e=this.toTicks(t);if(this._state.getValueAtTime(e)==="started"){this._state.setStateAtTime("stopped",e,{id:-1});const o=this._state.getBefore(e);let c=e;o!==null&&(c=o.time),this._rescheduleEvents(c)}return this}cancel(t){t=fs(t,-1/0);const e=this.toTicks(t);return this._state.forEachFrom(e,o=>{this.context.transport.clear(o.id)}),this._state.cancel(e),this}_tick(t){const e=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(e)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let o=.02;oa(this.humanize)||(o=this.toSeconds(this.humanize)),t+=(2*Math.random()-1)*o}this.callback(t,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new oe(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new oe(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,e=this._state.get(t);if(e!==null&&e.state==="started"){const o=this._getLoopDuration();return(t-e.time)%o/o}return 0}return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class co extends Me{constructor(){const t=K(co.getDefaults(),arguments,["callback","interval"]);super(t),this.name="Loop",this._event=new Ls({context:this.context,callback:this._tick.bind(this),loop:!0,loopEnd:t.interval,playbackRate:t.playbackRate,probability:t.probability,humanize:t.humanize}),this.callback=t.callback,this.iterations=t.iterations}static getDefaults(){return Object.assign(Me.getDefaults(),{interval:"4n",callback:Ot,playbackRate:1,iterations:1/0,probability:1,mute:!1,humanize:!1})}start(t){return this._event.start(t),this}stop(t){return this._event.stop(t),this}cancel(t){return this._event.cancel(t),this}_tick(t){this.callback(t)}get state(){return this._event.state}get progress(){return this._event.progress}get interval(){return this._event.loopEnd}set interval(t){this._event.loopEnd=t}get playbackRate(){return this._event.playbackRate}set playbackRate(t){this._event.playbackRate=t}get humanize(){return this._event.humanize}set humanize(t){this._event.humanize=t}get probability(){return this._event.probability}set probability(t){this._event.probability=t}get mute(){return this._event.mute}set mute(t){this._event.mute=t}get iterations(){return this._event.loop===!0?1/0:this._event.loop}set iterations(t){this._event.loop=t===1/0||t}dispose(){return super.dispose(),this._event.dispose(),this}}class ho extends Ls{constructor(){const t=K(ho.getDefaults(),arguments,["callback","events"]);super(t),this.name="Part",this._state=new ui("stopped"),this._events=new Set,this._state.increasing=!0,t.events.forEach(e=>{Pe(e)?this.add(e[0],e[1]):this.add(e)})}static getDefaults(){return Object.assign(Ls.getDefaults(),{events:[]})}start(t,e){const o=this.toTicks(t);if(this._state.getValueAtTime(o)!=="started"){e=fs(e,this._loop?this._loopStart:0),e=this._loop?fs(e,this._loopStart):fs(e,0);const c=this.toTicks(e);this._state.add({id:-1,offset:c,state:"started",time:o}),this._forEach(w=>{this._startNote(w,o,c)})}return this}_startNote(t,e,o){e-=o,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<o&&(e+=this._getLoopDuration()),t.start(new oe(this.context,e))):t.startOffset<this._loopStart&&t.startOffset>=o&&(t.loop=!1,t.start(new oe(this.context,e))):t.startOffset>=o&&t.start(new oe(this.context,e))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(e=>{e.startOffset+=this._startOffset})}stop(t){const e=this.toTicks(t);return this._state.cancel(e),this._state.setStateAtTime("stopped",e),this._forEach(o=>{o.stop(t)}),this}at(t,e){const o=new me(this.context,t).toTicks(),c=new oe(this.context,1).toSeconds(),w=this._events.values();let M=w.next();for(;!M.done;){const C=M.value;if(Math.abs(o-C.startOffset)<c)return Et(e)&&(C.value=e),C;M=w.next()}return Et(e)?(this.add(t,e),this.at(t)):null}add(t,e){t instanceof Object&&Reflect.has(t,"time")&&(t=(e=t).time);const o=this.toTicks(t);let c;return e instanceof Ls?(c=e,c.callback=this._tick.bind(this)):c=new Ls({callback:this._tick.bind(this),context:this.context,value:e}),c.startOffset=o,c.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(c),this._restartEvent(c),this}_restartEvent(t){this._state.forEach(e=>{e.state==="started"?this._startNote(t,e.time,e.offset):t.stop(new oe(this.context,e.time))})}remove(t,e){return Zs(t)&&t.hasOwnProperty("time")&&(t=(e=t).time),t=this.toTicks(t),this._events.forEach(o=>{o.startOffset===t&&(Ye(e)||Et(e)&&o.value===e)&&(this._events.delete(o),o.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(e=>e.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(e=>{e instanceof ho?e._forEach(t):t(e)}),this}_setAll(t,e){this._forEach(o=>{o[t]=e})}_tick(t,e){this.mute||this.callback(t,e)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(e=>{e.loopStart=this.loopStart,e.loopEnd=this.loopEnd,e.loop=t,this._testLoopBoundries(e)})}get loopEnd(){return new oe(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(e=>{e.loopEnd=t,this._testLoopBoundries(e)})}get loopStart(){return new oe(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(e=>{e.loopStart=this.loopStart,this._testLoopBoundries(e)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}function*Rp(h){let t=0;for(;t<h;)t=An(t,0,h-1),yield t,t++}function*Np(h){let t=h-1;for(;t>=0;)t=An(t,0,h-1),yield t,t--}function*uo(h,t){for(;;)yield*t(h)}function*Ph(h,t){let e=t?0:h-1;for(;;)e=An(e,0,h-1),yield e,t?(e++,e>=h-1&&(t=!1)):(e--,e<=0&&(t=!0))}function*Lp(h){let t=0,e=0;for(;t<h;)t=An(t,0,h-1),yield t,e++,t+=e%2?2:-1}function*Fp(h){let t=h-1,e=0;for(;t>=0;)t=An(t,0,h-1),yield t,e++,t+=e%2?-2:1}function*Bp(h){const t=[];for(let e=0;e<h;e++)t.push(e);for(;t.length>0;)yield An(t.splice(Math.floor(t.length*Math.random()),1)[0],0,h-1)}function*Eh(h,t="up",e=0){switch(bt(h>=1,"The number of values must be at least one"),t){case"up":yield*uo(h,Rp);case"down":yield*uo(h,Np);case"upDown":yield*Ph(h,!0);case"downUp":yield*Ph(h,!1);case"alternateUp":yield*uo(h,Lp);case"alternateDown":yield*uo(h,Fp);case"random":yield*function*(o){for(;;)yield Math.floor(Math.random()*o)}(h);case"randomOnce":yield*uo(h,Bp);case"randomWalk":yield*function*(o){let c=Math.floor(Math.random()*o);for(;;)c===0?c++:c===o-1||Math.random()<.5?c--:c++,yield c}(h)}}class Da extends co{constructor(){const t=K(Da.getDefaults(),arguments,["callback","values","pattern"]);super(t),this.name="Pattern",this.callback=t.callback,this._values=t.values,this._pattern=Eh(t.values.length,t.pattern),this._type=t.pattern}static getDefaults(){return Object.assign(co.getDefaults(),{pattern:"up",values:[],callback:Ot})}_tick(t){const e=this._pattern.next();this._index=e.value,this._value=this._values[e.value],this.callback(t,this._value)}get values(){return this._values}set values(t){this._values=t,this.pattern=this._type}get value(){return this._value}get index(){return this._index}get pattern(){return this._type}set pattern(t){this._type=t,this._pattern=Eh(this._values.length,this._type)}}class Ra extends Ls{constructor(){const t=K(Ra.getDefaults(),arguments,["callback","events","subdivision"]);super(t),this.name="Sequence",this._part=new ho({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[],this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign(Ie(Ls.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,e){e===null||this.mute||this.callback(t,e)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,e){return this._part.start(t,e&&this._indexTime(e)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new oe(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(e,o)=>e[o],set:(e,o,c)=>(Ss(o)&&isFinite(parseInt(o,10))&&Pe(c)?e[o]=this._createSequence(c):e[o]=c,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,e,o){t.forEach((c,w)=>{const M=w*e+o;if(Pe(c))this._rescheduleSequence(c,e/c.length,M);else{const C=new oe(this.context,M,"i").toSeconds();this._part.add(C,c)}})}_indexTime(t){return new oe(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this._part.loopEnd=t===0?this._indexTime(this._eventsArray.length):this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}class xi extends it{constructor(){const t=K(xi.getDefaults(),arguments,["fade"]);super(t),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new Mh({context:this.context}),this.a=new yt({context:this.context,gain:0}),this.b=new yt({context:this.context,gain:0}),this.output=new yt({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new St({context:this.context,units:"normalRange",value:t.fade}),xt(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",$e(this._split,this.a.gain,0),$e(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(it.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class be extends it{constructor(t){super(t),this.name="Effect",this._dryWet=new xi({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new yt({context:this.context}),this.effectReturn=new yt({context:this.context}),this.input=new yt({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(t.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],xt(this,"wet")}static getDefaults(){return Object.assign(it.getDefaults(),{wet:1})}connectEffect(t){return this._internalChannels.push(t),this.effectSend.chain(t,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class rr extends be{constructor(t){super(t),this.name="LFOEffect",this._lfo=new je({context:this.context,frequency:t.frequency,amplitude:t.depth}),this.depth=this._lfo.amplitude,this.frequency=this._lfo.frequency,this.type=t.type,xt(this,["frequency","depth"])}static getDefaults(){return Object.assign(be.getDefaults(),{frequency:1,type:"sine",depth:1})}start(t){return this._lfo.start(t),this}stop(t){return this._lfo.stop(t),this}sync(){return this._lfo.sync(),this}unsync(){return this._lfo.unsync(),this}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Na extends rr{constructor(){const t=K(Na.getDefaults(),arguments,["frequency","baseFrequency","octaves"]);super(t),this.name="AutoFilter",this.filter=new ls(Object.assign(t.filter,{context:this.context})),this.connectEffect(this.filter),this._lfo.connect(this.filter.frequency),this.octaves=t.octaves,this.baseFrequency=t.baseFrequency}static getDefaults(){return Object.assign(rr.getDefaults(),{baseFrequency:200,octaves:2.6,filter:{type:"lowpass",rolloff:-12,Q:1}})}get baseFrequency(){return this._lfo.min}set baseFrequency(t){this._lfo.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._lfo.max=this._lfo.min*Math.pow(2,t)}dispose(){return super.dispose(),this.filter.dispose(),this}}class fo extends it{constructor(){const t=K(fo.getDefaults(),arguments,["pan"]);super(t),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Ct({context:this.context,param:this._panner.pan,value:t.pan,minValue:-1,maxValue:1}),this._panner.channelCount=t.channelCount,this._panner.channelCountMode="explicit",xt(this,"pan")}static getDefaults(){return Object.assign(it.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}class La extends rr{constructor(){const t=K(La.getDefaults(),arguments,["frequency"]);super(t),this.name="AutoPanner",this._panner=new fo({context:this.context,channelCount:t.channelCount}),this.connectEffect(this._panner),this._lfo.connect(this._panner.pan),this._lfo.min=-1,this._lfo.max=1}static getDefaults(){return Object.assign(rr.getDefaults(),{channelCount:1})}dispose(){return super.dispose(),this._panner.dispose(),this}}class po extends it{constructor(){const t=K(po.getDefaults(),arguments,["smoothing"]);super(t),this.name="Follower",this._abs=this.input=new Th({context:this.context}),this._lowpass=this.output=new ro({context:this.context,frequency:1/this.toSeconds(t.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=t.smoothing}static getDefaults(){return Object.assign(it.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class Fa extends be{constructor(){const t=K(Fa.getDefaults(),arguments,["baseFrequency","octaves","sensitivity"]);super(t),this.name="AutoWah",this._follower=new po({context:this.context,smoothing:t.follower}),this._sweepRange=new ir({context:this.context,min:0,max:1,exponent:.5}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this._inputBoost=new yt({context:this.context}),this._bandpass=new ls({context:this.context,rolloff:-48,frequency:0,Q:t.Q}),this._peaking=new ls({context:this.context,type:"peaking"}),this._peaking.gain.value=t.gain,this.gain=this._peaking.gain,this.Q=this._bandpass.Q,this.effectSend.chain(this._inputBoost,this._follower,this._sweepRange),this._sweepRange.connect(this._bandpass.frequency),this._sweepRange.connect(this._peaking.frequency),this.effectSend.chain(this._bandpass,this._peaking,this.effectReturn),this._setSweepRange(),this.sensitivity=t.sensitivity,xt(this,["gain","Q"])}static getDefaults(){return Object.assign(be.getDefaults(),{baseFrequency:100,octaves:6,sensitivity:0,Q:2,gain:2,follower:.2})}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._setSweepRange()}get follower(){return this._follower.smoothing}set follower(t){this._follower.smoothing=t}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._setSweepRange()}get sensitivity(){return Xi(1/this._inputBoost.gain.value)}set sensitivity(t){this._inputBoost.gain.value=1/ci(t)}_setSweepRange(){this._sweepRange.min=this._baseFrequency,this._sweepRange.max=Math.min(this._baseFrequency*Math.pow(2,this._octaves),this.context.sampleRate/2)}dispose(){return super.dispose(),this._follower.dispose(),this._sweepRange.dispose(),this._bandpass.dispose(),this._peaking.dispose(),this._inputBoost.dispose(),this}}const Ih="bit-crusher";Ah(Ih,`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`);class Ba extends be{constructor(){const t=K(Ba.getDefaults(),arguments,["bits"]);super(t),this.name="BitCrusher",this._bitCrusherWorklet=new qa({context:this.context,bits:t.bits}),this.connectEffect(this._bitCrusherWorklet),this.bits=this._bitCrusherWorklet.bits}static getDefaults(){return Object.assign(be.getDefaults(),{bits:4})}dispose(){return super.dispose(),this._bitCrusherWorklet.dispose(),this}}class qa extends Ea{constructor(){const t=K(qa.getDefaults(),arguments);super(t),this.name="BitCrusherWorklet",this.input=new yt({context:this.context}),this.output=new yt({context:this.context}),this.bits=new Ct({context:this.context,value:t.bits,units:"positive",minValue:1,maxValue:16,param:this._dummyParam,swappable:!0})}static getDefaults(){return Object.assign(Ea.getDefaults(),{bits:12})}_audioWorkletName(){return Ih}onReady(t){os(this.input,t,this.output);const e=t.parameters.get("bits");this.bits.setParam(e)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.bits.dispose(),this}}class za extends be{constructor(){const t=K(za.getDefaults(),arguments,["order"]);super(t),this.name="Chebyshev",this._shaper=new Cs({context:this.context,length:4096}),this._order=t.order,this.connectEffect(this._shaper),this.order=t.order,this.oversample=t.oversample}static getDefaults(){return Object.assign(be.getDefaults(),{order:1,oversample:"none"})}_getCoefficient(t,e,o){return o.has(e)||(e===0?o.set(e,0):e===1?o.set(e,t):o.set(e,2*t*this._getCoefficient(t,e-1,o)-this._getCoefficient(t,e-2,o))),o.get(e)}get order(){return this._order}set order(t){bt(Number.isInteger(t),"'order' must be an integer"),this._order=t,this._shaper.setMap(e=>this._getCoefficient(e,t,new Map))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class On extends it{constructor(){const t=K(On.getDefaults(),arguments,["channels"]);super(t),this.name="Split",this._splitter=this.input=this.output=this.context.createChannelSplitter(t.channels),this._internalChannels=[this._splitter]}static getDefaults(){return Object.assign(it.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._splitter.disconnect(),this}}class bn extends it{constructor(){const t=K(bn.getDefaults(),arguments,["channels"]);super(t),this.name="Merge",this._merger=this.output=this.input=this.context.createChannelMerger(t.channels)}static getDefaults(){return Object.assign(it.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._merger.disconnect(),this}}class Fs extends it{constructor(t){super(t),this.name="StereoEffect",this.input=new yt({context:this.context}),this.input.channelCount=2,this.input.channelCountMode="explicit",this._dryWet=this.output=new xi({context:this.context,fade:t.wet}),this.wet=this._dryWet.fade,this._split=new On({context:this.context,channels:2}),this._merge=new bn({context:this.context,channels:2}),this.input.connect(this._split),this.input.connect(this._dryWet.a),this._merge.connect(this._dryWet.b),xt(this,["wet"])}connectEffectLeft(...t){this._split.connect(t[0],0,0),os(...t),$e(t[t.length-1],this._merge,0,0)}connectEffectRight(...t){this._split.connect(t[0],1,0),os(...t),$e(t[t.length-1],this._merge,0,1)}static getDefaults(){return Object.assign(it.getDefaults(),{wet:1})}dispose(){return super.dispose(),this._dryWet.dispose(),this._split.dispose(),this._merge.dispose(),this}}class Wa extends Fs{constructor(t){super(t),this.feedback=new St({context:this.context,value:t.feedback,units:"normalRange"}),this._feedbackL=new yt({context:this.context}),this._feedbackR=new yt({context:this.context}),this._feedbackSplit=new On({context:this.context,channels:2}),this._feedbackMerge=new bn({context:this.context,channels:2}),this._merge.connect(this._feedbackSplit),this._feedbackMerge.connect(this._split),this._feedbackSplit.connect(this._feedbackL,0,0),this._feedbackL.connect(this._feedbackMerge,0,0),this._feedbackSplit.connect(this._feedbackR,1,0),this._feedbackR.connect(this._feedbackMerge,0,1),this.feedback.fan(this._feedbackL.gain,this._feedbackR.gain),xt(this,["feedback"])}static getDefaults(){return Object.assign(Fs.getDefaults(),{feedback:.5})}dispose(){return super.dispose(),this.feedback.dispose(),this._feedbackL.dispose(),this._feedbackR.dispose(),this._feedbackSplit.dispose(),this._feedbackMerge.dispose(),this}}class Va extends Wa{constructor(){const t=K(Va.getDefaults(),arguments,["frequency","delayTime","depth"]);super(t),this.name="Chorus",this._depth=t.depth,this._delayTime=t.delayTime/1e3,this._lfoL=new je({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new je({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._delayNodeL=new rs({context:this.context}),this._delayNodeR=new rs({context:this.context}),this.frequency=this._lfoL.frequency,xt(this,["frequency"]),this._lfoL.frequency.connect(this._lfoR.frequency),this.connectEffectLeft(this._delayNodeL),this.connectEffectRight(this._delayNodeR),this._lfoL.connect(this._delayNodeL.delayTime),this._lfoR.connect(this._delayNodeR.delayTime),this.depth=this._depth,this.type=t.type,this.spread=t.spread}static getDefaults(){return Object.assign(Wa.getDefaults(),{frequency:1.5,delayTime:3.5,depth:.7,type:"sine",spread:180,feedback:0,wet:.5})}get depth(){return this._depth}set depth(t){this._depth=t;const e=this._delayTime*t;this._lfoL.min=Math.max(this._delayTime-e,0),this._lfoL.max=this._delayTime+e,this._lfoR.min=Math.max(this._delayTime-e,0),this._lfoR.max=this._delayTime+e}get delayTime(){return 1e3*this._delayTime}set delayTime(t){this._delayTime=t/1e3,this.depth=this._depth}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._delayNodeL.dispose(),this._delayNodeR.dispose(),this.frequency.dispose(),this}}class $a extends be{constructor(){const t=K($a.getDefaults(),arguments,["distortion"]);super(t),this.name="Distortion",this._shaper=new Cs({context:this.context,length:4096}),this._distortion=t.distortion,this.connectEffect(this._shaper),this.distortion=t.distortion,this.oversample=t.oversample}static getDefaults(){return Object.assign(be.getDefaults(),{distortion:.4,oversample:"none"})}get distortion(){return this._distortion}set distortion(t){this._distortion=t;const e=100*t,o=Math.PI/180;this._shaper.setMap(c=>Math.abs(c)<.001?0:(3+e)*c*20*o/(Math.PI+e*Math.abs(c)))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class ar extends be{constructor(t){super(t),this.name="FeedbackEffect",this._feedbackGain=new yt({context:this.context,gain:t.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,xt(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(be.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class ja extends ar{constructor(){const t=K(ja.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="FeedbackDelay",this._delayNode=new rs({context:this.context,delayTime:t.delayTime,maxDelay:t.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),xt(this,"delayTime")}static getDefaults(){return Object.assign(ar.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class qp extends it{constructor(t){super(t),this.name="PhaseShiftAllpass",this.input=new yt({context:this.context}),this.output=new yt({context:this.context}),this.offset90=new yt({context:this.context}),this._bank0=this._createAllPassFilterBank([.6923878,.9360654322959,.988229522686,.9987488452737]),this._bank1=this._createAllPassFilterBank([.4021921162426,.856171088242,.9722909545651,.9952884791278]),this._oneSampleDelay=this.context.createIIRFilter([0,1],[1,0]),os(this.input,...this._bank0,this._oneSampleDelay,this.output),os(this.input,...this._bank1,this.offset90)}_createAllPassFilterBank(t){return t.map(e=>{const o=[[e*e,0,-1],[1,0,-e*e]];return this.context.createIIRFilter(o[0],o[1])})}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.offset90.dispose(),this._bank0.forEach(t=>t.disconnect()),this._bank1.forEach(t=>t.disconnect()),this._oneSampleDelay.disconnect(),this}}class Ga extends be{constructor(){const t=K(Ga.getDefaults(),arguments,["frequency"]);super(t),this.name="FrequencyShifter",this.frequency=new St({context:this.context,units:"frequency",value:t.frequency,minValue:-this.context.sampleRate/2,maxValue:this.context.sampleRate/2}),this._sine=new Qi({context:this.context,type:"sine"}),this._cosine=new re({context:this.context,phase:-90,type:"sine"}),this._sineMultiply=new ae({context:this.context}),this._cosineMultiply=new ae({context:this.context}),this._negate=new xa({context:this.context}),this._add=new Pn({context:this.context}),this._phaseShifter=new qp({context:this.context}),this.effectSend.connect(this._phaseShifter),this.frequency.fan(this._sine.frequency,this._cosine.frequency),this._phaseShifter.offset90.connect(this._cosineMultiply),this._cosine.connect(this._cosineMultiply.factor),this._phaseShifter.connect(this._sineMultiply),this._sine.connect(this._sineMultiply.factor),this._sineMultiply.connect(this._negate),this._cosineMultiply.connect(this._add),this._negate.connect(this._add.addend),this._add.connect(this.effectReturn);const e=this.immediate();this._sine.start(e),this._cosine.start(e)}static getDefaults(){return Object.assign(be.getDefaults(),{frequency:0})}dispose(){return super.dispose(),this.frequency.dispose(),this._add.dispose(),this._cosine.dispose(),this._cosineMultiply.dispose(),this._negate.dispose(),this._phaseShifter.dispose(),this._sine.dispose(),this._sineMultiply.dispose(),this}}const Oh=[1557/44100,1617/44100,1491/44100,1422/44100,1277/44100,1356/44100,1188/44100,1116/44100],Dh=[225,556,441,341];class Ha extends Fs{constructor(){const t=K(Ha.getDefaults(),arguments,["roomSize","dampening"]);super(t),this.name="Freeverb",this._combFilters=[],this._allpassFiltersL=[],this._allpassFiltersR=[],this.roomSize=new St({context:this.context,value:t.roomSize,units:"normalRange"}),this._allpassFiltersL=Dh.map(e=>{const o=this.context.createBiquadFilter();return o.type="allpass",o.frequency.value=e,o}),this._allpassFiltersR=Dh.map(e=>{const o=this.context.createBiquadFilter();return o.type="allpass",o.frequency.value=e,o}),this._combFilters=Oh.map((e,o)=>{const c=new ao({context:this.context,dampening:t.dampening,delayTime:e});return o<Oh.length/2?this.connectEffectLeft(c,...this._allpassFiltersL):this.connectEffectRight(c,...this._allpassFiltersR),this.roomSize.connect(c.resonance),c}),xt(this,["roomSize"])}static getDefaults(){return Object.assign(Fs.getDefaults(),{roomSize:.7,dampening:3e3})}get dampening(){return this._combFilters[0].dampening}set dampening(t){this._combFilters.forEach(e=>e.dampening=t)}dispose(){return super.dispose(),this._allpassFiltersL.forEach(t=>t.disconnect()),this._allpassFiltersR.forEach(t=>t.disconnect()),this._combFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this}}const Rh=[.06748,.06404,.08212,.09004],zp=[.773,.802,.753,.733],Wp=[347,113,37];class Ua extends Fs{constructor(){const t=K(Ua.getDefaults(),arguments,["roomSize"]);super(t),this.name="JCReverb",this._allpassFilters=[],this._feedbackCombFilters=[],this.roomSize=new St({context:this.context,value:t.roomSize,units:"normalRange"}),this._scaleRoomSize=new en({context:this.context,min:-.733,max:.197}),this._allpassFilters=Wp.map(e=>{const o=this.context.createBiquadFilter();return o.type="allpass",o.frequency.value=e,o}),this._feedbackCombFilters=Rh.map((e,o)=>{const c=new oo({context:this.context,delayTime:e});return this._scaleRoomSize.connect(c.resonance),c.resonance.value=zp[o],o<Rh.length/2?this.connectEffectLeft(...this._allpassFilters,c):this.connectEffectRight(...this._allpassFilters,c),c}),this.roomSize.connect(this._scaleRoomSize),xt(this,["roomSize"])}static getDefaults(){return Object.assign(Fs.getDefaults(),{roomSize:.5})}dispose(){return super.dispose(),this._allpassFilters.forEach(t=>t.disconnect()),this._feedbackCombFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this._scaleRoomSize.dispose(),this}}class Nh extends Wa{constructor(t){super(t),this._feedbackL.disconnect(),this._feedbackL.connect(this._feedbackMerge,0,1),this._feedbackR.disconnect(),this._feedbackR.connect(this._feedbackMerge,0,0),xt(this,["feedback"])}}class Xa extends Nh{constructor(){const t=K(Xa.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="PingPongDelay",this._leftDelay=new rs({context:this.context,maxDelay:t.maxDelay}),this._rightDelay=new rs({context:this.context,maxDelay:t.maxDelay}),this._rightPreDelay=new rs({context:this.context,maxDelay:t.maxDelay}),this.delayTime=new St({context:this.context,units:"time",value:t.delayTime}),this.connectEffectLeft(this._leftDelay),this.connectEffectRight(this._rightPreDelay,this._rightDelay),this.delayTime.fan(this._leftDelay.delayTime,this._rightDelay.delayTime,this._rightPreDelay.delayTime),this._feedbackL.disconnect(),this._feedbackL.connect(this._rightDelay),xt(this,["delayTime"])}static getDefaults(){return Object.assign(Nh.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._leftDelay.dispose(),this._rightDelay.dispose(),this._rightPreDelay.dispose(),this.delayTime.dispose(),this}}class Ya extends ar{constructor(){const t=K(Ya.getDefaults(),arguments,["pitch"]);super(t),this.name="PitchShift",this._frequency=new St({context:this.context}),this._delayA=new rs({maxDelay:1,context:this.context}),this._lfoA=new je({context:this.context,min:0,max:.1,type:"sawtooth"}).connect(this._delayA.delayTime),this._delayB=new rs({maxDelay:1,context:this.context}),this._lfoB=new je({context:this.context,min:0,max:.1,type:"sawtooth",phase:180}).connect(this._delayB.delayTime),this._crossFade=new xi({context:this.context}),this._crossFadeLFO=new je({context:this.context,min:0,max:1,type:"triangle",phase:90}).connect(this._crossFade.fade),this._feedbackDelay=new rs({delayTime:t.delayTime,context:this.context}),this.delayTime=this._feedbackDelay.delayTime,xt(this,"delayTime"),this._pitch=t.pitch,this._windowSize=t.windowSize,this._delayA.connect(this._crossFade.a),this._delayB.connect(this._crossFade.b),this._frequency.fan(this._lfoA.frequency,this._lfoB.frequency,this._crossFadeLFO.frequency),this.effectSend.fan(this._delayA,this._delayB),this._crossFade.chain(this._feedbackDelay,this.effectReturn);const e=this.now();this._lfoA.start(e),this._lfoB.start(e),this._crossFadeLFO.start(e),this.windowSize=this._windowSize}static getDefaults(){return Object.assign(ar.getDefaults(),{pitch:0,windowSize:.1,delayTime:0,feedback:0})}get pitch(){return this._pitch}set pitch(t){this._pitch=t;let e=0;t<0?(this._lfoA.min=0,this._lfoA.max=this._windowSize,this._lfoB.min=0,this._lfoB.max=this._windowSize,e=hi(t-1)+1):(this._lfoA.min=this._windowSize,this._lfoA.max=0,this._lfoB.min=this._windowSize,this._lfoB.max=0,e=hi(t)-1),this._frequency.value=e*(1.2/this._windowSize)}get windowSize(){return this._windowSize}set windowSize(t){this._windowSize=this.toSeconds(t),this.pitch=this._pitch}dispose(){return super.dispose(),this._frequency.dispose(),this._delayA.dispose(),this._delayB.dispose(),this._lfoA.dispose(),this._lfoB.dispose(),this._crossFade.dispose(),this._crossFadeLFO.dispose(),this._feedbackDelay.dispose(),this}}class Za extends Fs{constructor(){const t=K(Za.getDefaults(),arguments,["frequency","octaves","baseFrequency"]);super(t),this.name="Phaser",this._lfoL=new je({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new je({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this.Q=new St({context:this.context,value:t.Q,units:"positive"}),this._filtersL=this._makeFilters(t.stages,this._lfoL),this._filtersR=this._makeFilters(t.stages,this._lfoR),this.frequency=this._lfoL.frequency,this.frequency.value=t.frequency,this.connectEffectLeft(...this._filtersL),this.connectEffectRight(...this._filtersR),this._lfoL.frequency.connect(this._lfoR.frequency),this.baseFrequency=t.baseFrequency,this.octaves=t.octaves,this._lfoL.start(),this._lfoR.start(),xt(this,["frequency","Q"])}static getDefaults(){return Object.assign(Fs.getDefaults(),{frequency:.5,octaves:3,stages:10,Q:10,baseFrequency:350})}_makeFilters(t,e){const o=[];for(let c=0;c<t;c++){const w=this.context.createBiquadFilter();w.type="allpass",this.Q.connect(w.Q),e.connect(w.frequency),o.push(w)}return o}get octaves(){return this._octaves}set octaves(t){this._octaves=t;const e=this._baseFrequency*Math.pow(2,t);this._lfoL.max=e,this._lfoR.max=e}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._lfoL.min=this._baseFrequency,this._lfoR.min=this._baseFrequency,this.octaves=this._octaves}dispose(){return super.dispose(),this.Q.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._filtersL.forEach(t=>t.disconnect()),this._filtersR.forEach(t=>t.disconnect()),this.frequency.dispose(),this}}class Qa extends be{constructor(){const t=K(Qa.getDefaults(),arguments,["decay"]);super(t),this.name="Reverb",this._convolver=this.context.createConvolver(),this.ready=Promise.resolve(),this._decay=t.decay,this._preDelay=t.preDelay,this.generate(),this.connectEffect(this._convolver)}static getDefaults(){return Object.assign(be.getDefaults(),{decay:1.5,preDelay:.01})}get decay(){return this._decay}set decay(t){Ee(t=this.toSeconds(t),.001),this._decay=t,this.generate()}get preDelay(){return this._preDelay}set preDelay(t){Ee(t=this.toSeconds(t),0),this._preDelay=t,this.generate()}generate(){return Zt(this,void 0,void 0,function*(){const t=this.ready,e=new li(2,this._decay+this._preDelay,this.context.sampleRate),o=new vn({context:e}),c=new vn({context:e}),w=new bn({context:e});o.connect(w,0,0),c.connect(w,0,1);const M=new yt({context:e}).toDestination();w.connect(M),o.start(0),c.start(0),M.gain.setValueAtTime(0,0),M.gain.setValueAtTime(1,this._preDelay),M.gain.exponentialApproachValueAtTime(0,this._preDelay,this.decay);const C=e.render();return this.ready=C.then(Ot),yield t,this._convolver.buffer=(yield C).get(),this})}dispose(){return super.dispose(),this._convolver.disconnect(),this}}class mo extends it{constructor(){super(K(mo.getDefaults(),arguments)),this.name="MidSideSplit",this._split=this.input=new On({channels:2,context:this.context}),this._midAdd=new Pn({context:this.context}),this.mid=new ae({context:this.context,value:Math.SQRT1_2}),this._sideSubtract=new En({context:this.context}),this.side=new ae({context:this.context,value:Math.SQRT1_2}),this._split.connect(this._midAdd,0),this._split.connect(this._midAdd.addend,1),this._split.connect(this._sideSubtract,0),this._split.connect(this._sideSubtract.subtrahend,1),this._midAdd.connect(this.mid),this._sideSubtract.connect(this.side)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midAdd.dispose(),this._sideSubtract.dispose(),this._split.dispose(),this}}class go extends it{constructor(){super(K(go.getDefaults(),arguments)),this.name="MidSideMerge",this.mid=new yt({context:this.context}),this.side=new yt({context:this.context}),this._left=new Pn({context:this.context}),this._leftMult=new ae({context:this.context,value:Math.SQRT1_2}),this._right=new En({context:this.context}),this._rightMult=new ae({context:this.context,value:Math.SQRT1_2}),this._merge=this.output=new bn({context:this.context}),this.mid.fan(this._left),this.side.connect(this._left.addend),this.mid.connect(this._right),this.side.connect(this._right.subtrahend),this._left.connect(this._leftMult),this._right.connect(this._rightMult),this._leftMult.connect(this._merge,0,0),this._rightMult.connect(this._merge,0,1)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._leftMult.dispose(),this._rightMult.dispose(),this._left.dispose(),this._right.dispose(),this}}class Lh extends be{constructor(t){super(t),this.name="MidSideEffect",this._midSideMerge=new go({context:this.context}),this._midSideSplit=new mo({context:this.context}),this._midSend=this._midSideSplit.mid,this._sideSend=this._midSideSplit.side,this._midReturn=this._midSideMerge.mid,this._sideReturn=this._midSideMerge.side,this.effectSend.connect(this._midSideSplit),this._midSideMerge.connect(this.effectReturn)}connectEffectMid(...t){this._midSend.chain(...t,this._midReturn)}connectEffectSide(...t){this._sideSend.chain(...t,this._sideReturn)}dispose(){return super.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this._midSend.dispose(),this._sideSend.dispose(),this._midReturn.dispose(),this._sideReturn.dispose(),this}}class Ja extends Lh{constructor(){const t=K(Ja.getDefaults(),arguments,["width"]);super(t),this.name="StereoWidener",this.width=new St({context:this.context,value:t.width,units:"normalRange"}),xt(this,["width"]),this._twoTimesWidthMid=new ae({context:this.context,value:2}),this._twoTimesWidthSide=new ae({context:this.context,value:2}),this._midMult=new ae({context:this.context}),this._twoTimesWidthMid.connect(this._midMult.factor),this.connectEffectMid(this._midMult),this._oneMinusWidth=new En({context:this.context}),this._oneMinusWidth.connect(this._twoTimesWidthMid),$e(this.context.getConstant(1),this._oneMinusWidth),this.width.connect(this._oneMinusWidth.subtrahend),this._sideMult=new ae({context:this.context}),this.width.connect(this._twoTimesWidthSide),this._twoTimesWidthSide.connect(this._sideMult.factor),this.connectEffectSide(this._sideMult)}static getDefaults(){return Object.assign(Lh.getDefaults(),{width:.5})}dispose(){return super.dispose(),this.width.dispose(),this._midMult.dispose(),this._sideMult.dispose(),this._twoTimesWidthMid.dispose(),this._twoTimesWidthSide.dispose(),this._oneMinusWidth.dispose(),this}}class Ka extends Fs{constructor(){const t=K(Ka.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Tremolo",this._lfoL=new je({context:this.context,type:t.type,min:1,max:0}),this._lfoR=new je({context:this.context,type:t.type,min:1,max:0}),this._amplitudeL=new yt({context:this.context}),this._amplitudeR=new yt({context:this.context}),this.frequency=new St({context:this.context,value:t.frequency,units:"frequency"}),this.depth=new St({context:this.context,value:t.depth,units:"normalRange"}),xt(this,["frequency","depth"]),this.connectEffectLeft(this._amplitudeL),this.connectEffectRight(this._amplitudeR),this._lfoL.connect(this._amplitudeL.gain),this._lfoR.connect(this._amplitudeR.gain),this.frequency.fan(this._lfoL.frequency,this._lfoR.frequency),this.depth.fan(this._lfoR.amplitude,this._lfoL.amplitude),this.spread=t.spread}static getDefaults(){return Object.assign(Fs.getDefaults(),{frequency:10,type:"sine",depth:.5,spread:180})}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this.context.transport.syncSignal(this.frequency),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this.context.transport.unsyncSignal(this.frequency),this}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._amplitudeL.dispose(),this._amplitudeR.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class tl extends be{constructor(){const t=K(tl.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Vibrato",this._delayNode=new rs({context:this.context,delayTime:0,maxDelay:t.maxDelay}),this._lfo=new je({context:this.context,type:t.type,min:0,max:t.maxDelay,frequency:t.frequency,phase:-90}).start().connect(this._delayNode.delayTime),this.frequency=this._lfo.frequency,this.depth=this._lfo.amplitude,this.depth.value=t.depth,xt(this,["frequency","depth"]),this.effectSend.chain(this._delayNode,this.effectReturn)}static getDefaults(){return Object.assign(be.getDefaults(),{maxDelay:.005,frequency:5,depth:.1,type:"sine"})}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._delayNode.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class vo extends it{constructor(){const t=K(vo.getDefaults(),arguments,["type","size"]);super(t),this.name="Analyser",this._analysers=[],this._buffers=[],this.input=this.output=this._gain=new yt({context:this.context}),this._split=new On({context:this.context,channels:t.channels}),this.input.connect(this._split),Ee(t.channels,1);for(let e=0;e<t.channels;e++)this._analysers[e]=this.context.createAnalyser(),this._split.connect(this._analysers[e],e,0);this.size=t.size,this.type=t.type,this.smoothing=t.smoothing}static getDefaults(){return Object.assign(it.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach((t,e)=>{const o=this._buffers[e];this._type==="fft"?t.getFloatFrequencyData(o):this._type==="waveform"&&t.getFloatTimeDomainData(o)}),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(t){this._analysers.forEach((e,o)=>{e.fftSize=2*t,this._buffers[o]=new Float32Array(t)})}get channels(){return this._analysers.length}get type(){return this._type}set type(t){bt(t==="waveform"||t==="fft",`Analyser: invalid type: ${t}`),this._type=t}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(t){this._analysers.forEach(e=>e.smoothingTimeConstant=t)}dispose(){return super.dispose(),this._analysers.forEach(t=>t.disconnect()),this._split.dispose(),this._gain.dispose(),this}}class _n extends it{constructor(){super(K(_n.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new vo({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class el extends _n{constructor(){const t=K(el.getDefaults(),arguments,["smoothing"]);super(t),this.name="Meter",this.input=this.output=this._analyser=new vo({context:this.context,size:256,type:"waveform",channels:t.channelCount}),this.smoothing=t.smoothing,this.normalRange=t.normalRange,this._rms=new Array(t.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(_n.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return ni("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),e=(this.channels===1?[t]:t).map((o,c)=>{const w=o.reduce((C,k)=>C+k*k,0),M=Math.sqrt(w/o.length);return this._rms[c]=Math.max(M,this._rms[c]*this.smoothing),this.normalRange?this._rms[c]:Xi(this._rms[c])});return this.channels===1?e[0]:e}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class sl extends _n{constructor(){const t=K(sl.getDefaults(),arguments,["size"]);super(t),this.name="FFT",this.normalRange=t.normalRange,this._analyser.type="fft",this.size=t.size}static getDefaults(){return Object.assign(it.getDefaults(),{normalRange:!1,size:1024,smoothing:.8})}getValue(){return this._analyser.getValue().map(t=>this.normalRange?ci(t):t)}get size(){return this._analyser.size}set size(t){this._analyser.size=t}get smoothing(){return this._analyser.smoothing}set smoothing(t){this._analyser.smoothing=t}getFrequencyOfIndex(t){return bt(0<=t&&t<this.size,`index must be greater than or equal to 0 and less than ${this.size}`),t*this.context.sampleRate/(2*this.size)}}class nl extends _n{constructor(){super(K(nl.getDefaults(),arguments)),this.name="DCMeter",this._analyser.type="waveform",this._analyser.size=256}getValue(){return this._analyser.getValue()[0]}}class il extends _n{constructor(){const t=K(il.getDefaults(),arguments,["size"]);super(t),this.name="Waveform",this._analyser.type="waveform",this.size=t.size}static getDefaults(){return Object.assign(_n.getDefaults(),{size:1024})}getValue(){return this._analyser.getValue()}get size(){return this._analyser.size}set size(t){this._analyser.size=t}}class pe extends it{constructor(){const t=K(pe.getDefaults(),arguments,["solo"]);super(t),this.name="Solo",this.input=this.output=new yt({context:this.context}),pe._allSolos.has(this.context)||pe._allSolos.set(this.context,new Set),pe._allSolos.get(this.context).add(this),this.solo=t.solo}static getDefaults(){return Object.assign(it.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(t){t?this._addSolo():this._removeSolo(),pe._allSolos.get(this.context).forEach(e=>e._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){pe._soloed.has(this.context)||pe._soloed.set(this.context,new Set),pe._soloed.get(this.context).add(this)}_removeSolo(){pe._soloed.has(this.context)&&pe._soloed.get(this.context).delete(this)}_isSoloed(){return pe._soloed.has(this.context)&&pe._soloed.get(this.context).has(this)}_noSolos(){return!pe._soloed.has(this.context)||pe._soloed.has(this.context)&&pe._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),pe._allSolos.get(this.context).delete(this),this._removeSolo(),this}}pe._allSolos=new Map,pe._soloed=new Map;class lr extends it{constructor(){const t=K(lr.getDefaults(),arguments,["pan","volume"]);super(t),this.name="PanVol",this._panner=this.input=new fo({context:this.context,pan:t.pan,channelCount:t.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new Js({context:this.context,volume:t.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=t.mute,xt(this,["pan","volume"])}static getDefaults(){return Object.assign(it.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class Dn extends it{constructor(){const t=K(Dn.getDefaults(),arguments,["volume","pan"]);super(t),this.name="Channel",this._solo=this.input=new pe({solo:t.solo,context:this.context}),this._panVol=this.output=new lr({context:this.context,pan:t.pan,volume:t.volume,mute:t.mute,channelCount:t.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),xt(this,["pan","volume"])}static getDefaults(){return Object.assign(it.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(t){this._solo.solo=t}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(t){this._panVol.mute=t}_getBus(t){return Dn.buses.has(t)||Dn.buses.set(t,new yt({context:this.context})),Dn.buses.get(t)}send(t,e=0){const o=this._getBus(t),c=new yt({context:this.context,units:"decibels",gain:e});return this.connect(c),c.connect(o),c}receive(t){return this._getBus(t).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}Dn.buses=new Map;class ol extends it{constructor(){super(K(ol.getDefaults(),arguments)),this.name="Mono",this.input=new yt({context:this.context}),this._merge=this.output=new bn({channels:2,context:this.context}),this.input.connect(this._merge,0,0),this.input.connect(this._merge,0,1)}dispose(){return super.dispose(),this._merge.dispose(),this.input.dispose(),this}}class yo extends it{constructor(){const t=K(yo.getDefaults(),arguments,["lowFrequency","highFrequency"]);super(t),this.name="MultibandSplit",this.input=new yt({context:this.context}),this.output=void 0,this.low=new ls({context:this.context,frequency:0,type:"lowpass"}),this._lowMidFilter=new ls({context:this.context,frequency:0,type:"highpass"}),this.mid=new ls({context:this.context,frequency:0,type:"lowpass"}),this.high=new ls({context:this.context,frequency:0,type:"highpass"}),this._internalChannels=[this.low,this.mid,this.high],this.lowFrequency=new St({context:this.context,units:"frequency",value:t.lowFrequency}),this.highFrequency=new St({context:this.context,units:"frequency",value:t.highFrequency}),this.Q=new St({context:this.context,units:"positive",value:t.Q}),this.input.fan(this.low,this.high),this.input.chain(this._lowMidFilter,this.mid),this.lowFrequency.fan(this.low.frequency,this._lowMidFilter.frequency),this.highFrequency.fan(this.mid.frequency,this.high.frequency),this.Q.connect(this.low.Q),this.Q.connect(this._lowMidFilter.Q),this.Q.connect(this.mid.Q),this.Q.connect(this.high.Q),xt(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(it.getDefaults(),{Q:1,highFrequency:2500,lowFrequency:400})}dispose(){return super.dispose(),Hi(this,["high","mid","low","highFrequency","lowFrequency"]),this.low.dispose(),this._lowMidFilter.dispose(),this.mid.dispose(),this.high.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this.Q.dispose(),this}}class rl extends it{constructor(){const t=K(rl.getDefaults(),arguments,["positionX","positionY","positionZ"]);super(t),this.name="Panner3D",this._panner=this.input=this.output=this.context.createPanner(),this.panningModel=t.panningModel,this.maxDistance=t.maxDistance,this.distanceModel=t.distanceModel,this.coneOuterGain=t.coneOuterGain,this.coneOuterAngle=t.coneOuterAngle,this.coneInnerAngle=t.coneInnerAngle,this.refDistance=t.refDistance,this.rolloffFactor=t.rolloffFactor,this.positionX=new Ct({context:this.context,param:this._panner.positionX,value:t.positionX}),this.positionY=new Ct({context:this.context,param:this._panner.positionY,value:t.positionY}),this.positionZ=new Ct({context:this.context,param:this._panner.positionZ,value:t.positionZ}),this.orientationX=new Ct({context:this.context,param:this._panner.orientationX,value:t.orientationX}),this.orientationY=new Ct({context:this.context,param:this._panner.orientationY,value:t.orientationY}),this.orientationZ=new Ct({context:this.context,param:this._panner.orientationZ,value:t.orientationZ})}static getDefaults(){return Object.assign(it.getDefaults(),{coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:0,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1})}setPosition(t,e,o){return this.positionX.value=t,this.positionY.value=e,this.positionZ.value=o,this}setOrientation(t,e,o){return this.orientationX.value=t,this.orientationY.value=e,this.orientationZ.value=o,this}get panningModel(){return this._panner.panningModel}set panningModel(t){this._panner.panningModel=t}get refDistance(){return this._panner.refDistance}set refDistance(t){this._panner.refDistance=t}get rolloffFactor(){return this._panner.rolloffFactor}set rolloffFactor(t){this._panner.rolloffFactor=t}get distanceModel(){return this._panner.distanceModel}set distanceModel(t){this._panner.distanceModel=t}get coneInnerAngle(){return this._panner.coneInnerAngle}set coneInnerAngle(t){this._panner.coneInnerAngle=t}get coneOuterAngle(){return this._panner.coneOuterAngle}set coneOuterAngle(t){this._panner.coneOuterAngle=t}get coneOuterGain(){return this._panner.coneOuterGain}set coneOuterGain(t){this._panner.coneOuterGain=t}get maxDistance(){return this._panner.maxDistance}set maxDistance(t){this._panner.maxDistance=t}dispose(){return super.dispose(),this._panner.disconnect(),this.orientationX.dispose(),this.orientationY.dispose(),this.orientationZ.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this}}class cr extends it{constructor(){const t=K(cr.getDefaults(),arguments);super(t),this.name="Recorder",this.input=new yt({context:this.context}),bt(cr.supported,"Media Recorder API is not available"),this._stream=this.context.createMediaStreamDestination(),this.input.connect(this._stream),this._recorder=new MediaRecorder(this._stream.stream,{mimeType:t.mimeType})}static getDefaults(){return it.getDefaults()}get mimeType(){return this._recorder.mimeType}static get supported(){return ss!==null&&Reflect.has(ss,"MediaRecorder")}get state(){return this._recorder.state==="inactive"?"stopped":this._recorder.state==="paused"?"paused":"started"}start(){return Zt(this,void 0,void 0,function*(){bt(this.state!=="started","Recorder is already started");const t=new Promise(e=>{const o=()=>{this._recorder.removeEventListener("start",o,!1),e()};this._recorder.addEventListener("start",o,!1)});return this._recorder.start(),yield t})}stop(){return Zt(this,void 0,void 0,function*(){bt(this.state!=="stopped","Recorder is not started");const t=new Promise(e=>{const o=c=>{this._recorder.removeEventListener("dataavailable",o,!1),e(c.data)};this._recorder.addEventListener("dataavailable",o,!1)});return this._recorder.stop(),yield t})}pause(){return bt(this.state==="started","Recorder must be started"),this._recorder.pause(),this}dispose(){return super.dispose(),this.input.dispose(),this._stream.disconnect(),this}}class nn extends it{constructor(){const t=K(nn.getDefaults(),arguments,["threshold","ratio"]);super(t),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new Ct({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:t.threshold}),this.attack=new Ct({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:t.attack}),this.release=new Ct({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:t.release}),this.knee=new Ct({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:t.knee}),this.ratio=new Ct({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:t.ratio}),xt(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(it.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class al extends it{constructor(){const t=K(al.getDefaults(),arguments,["threshold","smoothing"]);super(t),this.name="Gate",this._follower=new po({context:this.context,smoothing:t.smoothing}),this._gt=new nr({context:this.context,value:ci(t.threshold)}),this.input=new yt({context:this.context}),this._gate=this.output=new yt({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(it.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return Xi(this._gt.value)}set threshold(t){this._gt.value=ci(t)}get smoothing(){return this._follower.smoothing}set smoothing(t){this._follower.smoothing=t}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}class ll extends it{constructor(){const t=K(ll.getDefaults(),arguments,["threshold"]);super(t),this.name="Limiter",this._compressor=this.input=this.output=new nn({context:this.context,ratio:20,attack:.003,release:.01,threshold:t.threshold}),this.threshold=this._compressor.threshold,xt(this,"threshold")}static getDefaults(){return Object.assign(it.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}class cl extends it{constructor(){const t=K(cl.getDefaults(),arguments);super(t),this.name="MidSideCompressor",this._midSideSplit=this.input=new mo({context:this.context}),this._midSideMerge=this.output=new go({context:this.context}),this.mid=new nn(Object.assign(t.mid,{context:this.context})),this.side=new nn(Object.assign(t.side,{context:this.context})),this._midSideSplit.mid.chain(this.mid,this._midSideMerge.mid),this._midSideSplit.side.chain(this.side,this._midSideMerge.side),xt(this,["mid","side"])}static getDefaults(){return Object.assign(it.getDefaults(),{mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},side:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10}})}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this}}class hl extends it{constructor(){const t=K(hl.getDefaults(),arguments);super(t),this.name="MultibandCompressor",this._splitter=this.input=new yo({context:this.context,lowFrequency:t.lowFrequency,highFrequency:t.highFrequency}),this.lowFrequency=this._splitter.lowFrequency,this.highFrequency=this._splitter.highFrequency,this.output=new yt({context:this.context}),this.low=new nn(Object.assign(t.low,{context:this.context})),this.mid=new nn(Object.assign(t.mid,{context:this.context})),this.high=new nn(Object.assign(t.high,{context:this.context})),this._splitter.low.chain(this.low,this.output),this._splitter.mid.chain(this.mid,this.output),this._splitter.high.chain(this.high,this.output),xt(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(it.getDefaults(),{lowFrequency:250,highFrequency:2e3,low:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10},mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},high:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16}})}dispose(){return super.dispose(),this._splitter.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.output.dispose(),this}}class ul extends it{constructor(){const t=K(ul.getDefaults(),arguments,["low","mid","high"]);super(t),this.name="EQ3",this.output=new yt({context:this.context}),this._internalChannels=[],this.input=this._multibandSplit=new yo({context:this.context,highFrequency:t.highFrequency,lowFrequency:t.lowFrequency}),this._lowGain=new yt({context:this.context,gain:t.low,units:"decibels"}),this._midGain=new yt({context:this.context,gain:t.mid,units:"decibels"}),this._highGain=new yt({context:this.context,gain:t.high,units:"decibels"}),this.low=this._lowGain.gain,this.mid=this._midGain.gain,this.high=this._highGain.gain,this.Q=this._multibandSplit.Q,this.lowFrequency=this._multibandSplit.lowFrequency,this.highFrequency=this._multibandSplit.highFrequency,this._multibandSplit.low.chain(this._lowGain,this.output),this._multibandSplit.mid.chain(this._midGain,this.output),this._multibandSplit.high.chain(this._highGain,this.output),xt(this,["low","mid","high","lowFrequency","highFrequency"]),this._internalChannels=[this._multibandSplit]}static getDefaults(){return Object.assign(it.getDefaults(),{high:0,highFrequency:2500,low:0,lowFrequency:400,mid:0})}dispose(){return super.dispose(),Hi(this,["low","mid","high","lowFrequency","highFrequency"]),this._multibandSplit.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this._lowGain.dispose(),this._midGain.dispose(),this._highGain.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.Q.dispose(),this}}class dl extends it{constructor(){const t=K(dl.getDefaults(),arguments,["url","onload"]);super(t),this.name="Convolver",this._convolver=this.context.createConvolver(),this._buffer=new Ft(t.url,e=>{this.buffer=e,t.onload()}),this.input=new yt({context:this.context}),this.output=new yt({context:this.context}),this._buffer.loaded&&(this.buffer=this._buffer),this.normalize=t.normalize,this.input.chain(this._convolver,this.output)}static getDefaults(){return Object.assign(it.getDefaults(),{normalize:!0,onload:Ot})}load(t){return Zt(this,void 0,void 0,function*(){this.buffer=yield this._buffer.load(t)})}get buffer(){return this._buffer.length?this._buffer:null}set buffer(t){t&&this._buffer.set(t),this._convolver.buffer&&(this.input.disconnect(),this._convolver.disconnect(),this._convolver=this.context.createConvolver(),this.input.chain(this._convolver,this.output));const e=this._buffer.get();this._convolver.buffer=e||null}get normalize(){return this._convolver.normalize}set normalize(t){this._convolver.normalize=t}dispose(){return super.dispose(),this._buffer.dispose(),this._convolver.disconnect(),this}}function Vp(){return ee().now()}function $p(){return ee().immediate()}const jp=ee().transport;function Gp(){return ee().transport}const Hp=ee().destination,Up=ee().destination;function Xp(){return ee().destination}const Yp=ee().listener;function Zp(){return ee().listener}const Qp=ee().draw;function Jp(){return ee().draw}const Kp=ee();function tm(){return Ft.loaded()}const em=Ft,sm=pi,nm=gn})(),l})())}(br)),br.exports}var rt=cm();const ku=Array(19).fill(2),Pu=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],hm=Array(16).fill(2),um=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function dm(){return{hasAnacrusis:!0,macrobeatGroupings:[...ku],macrobeatBoundaryStyles:[...Pu],baseMicrobeatPx:40,modulationMarkers:[]}}const Ri=12,fm=50,pm=1,mm=.52,gm=2,vm=.5,ur=3,dr=1,Do=30,Ro=.5,ym=3,bm=8,_m=.25,wm=1.25,xm=.8,Sm=.7,Tm=.9,Mm=4,Cm=1.5,Am=.15,km=.2,Pm=1,Eu=1.5,Em="#CCCCCC",Iu=1,zh=3,Wh=5,Im=7,_r=16,Om=0,Dm=255,Ou=()=>({enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass"}),Rm={"#4a90e2":{primary:"#4a90e2",light:"#63a9fd"},"#68a03f":{primary:"#68a03f",light:"#80b958"},"#d66573":{primary:"#d66573",light:"#f27e8b"},"#2d2d2d":{primary:"#2d2d2d",light:"#424242"}};function Vh(){const s=n=>{const i=new Float32Array(Ri).fill(0),a=new Float32Array(Ri).fill(0);return i[0]=1,{name:n,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},coeffs:i,phases:a,activePresetName:"sine",filter:Ou()}};return{timbres:{"#4a90e2":s("Blue"),"#2d2d2d":s("Black"),"#d66573":s("Red"),"#68a03f":s("Green")},colorPalette:Rm}}function Nm(){return{isMicPaintActive:!1,isDetecting:!1,detectedPitch:{frequency:0,clarity:0,midi:0,pitchClass:0},paintHistory:[],paintSettings:{thickness:6,opacity:80,minClarity:.1}}}const Du={placedNotes:[],placedChords:[],tonicSignGroups:{},stampPlacements:[],tripletPlacements:[],history:[{notes:[],tonicSignGroups:{},timbres:Vh().timbres,placedChords:[],stampPlacements:[],tripletPlacements:[]}],historyIndex:0,fullRowData:[],...dm(),...Vh(),paint:Nm(),selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},activeChordId:null,activeChordIntervals:["1P","3M","5P"],isChordCandidateMenuOpen:!1,chordCandidateMenuPosition:{x:0,y:0},activeMacrobeatIndex:null,chordCandidates:[],gridPosition:0,visualRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,isPrintPreviewActive:!1,printOptions:{topRow:0,bottomRow:87,includeDrums:!0,orientation:"landscape",colorMode:"color"}};function $h(s){const n=JSON.parse(JSON.stringify(s));for(const i in n){const a=n[i];a.coeffs&&typeof a.coeffs=="object"&&!Array.isArray(a.coeffs)?a.coeffs=new Float32Array(Object.values(a.coeffs)):Array.isArray(a.coeffs)&&(a.coeffs=new Float32Array(a.coeffs))}return n}const Lm={recordState(){this.state.history=this.state.history.slice(0,this.state.historyIndex+1);const s=JSON.parse(JSON.stringify(this.state.timbres)),n={notes:JSON.parse(JSON.stringify(this.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(this.state.tonicSignGroups)),stampPlacements:JSON.parse(JSON.stringify(this.state.stampPlacements)),tripletPlacements:JSON.parse(JSON.stringify(this.state.tripletPlacements||[])),timbres:s};this.state.history.push(n),this.state.historyIndex++,this.emit("historyChanged")},undo(){if(this.state.historyIndex>0){this.state.historyIndex--;const s=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(s.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(s.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(s.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(s.tripletPlacements||[])),this.state.timbres=$h(s.timbres),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.emit("timbreChanged",this.state.selectedNote.color),this.emit("historyChanged")}},redo(){if(this.state.historyIndex<this.state.history.length-1){this.state.historyIndex++;const s=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(s.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(s.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(s.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(s.tripletPlacements||[])),this.state.timbres=$h(s.timbres),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.emit("timbreChanged",this.state.selectedNote.color),this.emit("historyChanged")}}};function tc(s){return s!==null&&typeof s=="object"&&"name"in s&&typeof s.name=="string"}function ec(s){return s!==null&&typeof s=="object"&&"step"in s&&typeof s.step=="number"&&"alt"in s&&typeof s.alt=="number"&&!isNaN(s.step)&&!isNaN(s.alt)}var Ru=[0,2,4,-1,1,3,5],Nu=Ru.map(s=>Math.floor(s*7/12));function Lu(s){const{step:n,alt:i,oct:a,dir:r=1}=s,l=Ru[n]+7*i;if(a===void 0)return[r*l];const u=a-Nu[n]-4*i;return[r*l,r*u]}var Fm=[3,0,4,1,5,2,6];function Fu(s){const[n,i,a]=s,r=Fm[Bm(n)],l=Math.floor((n+1)/7);if(i===void 0)return{step:r,alt:l,dir:a};const u=i+4*l+Nu[r];return{step:r,alt:l,oct:u,dir:a}}function Bm(s){const n=(s+1)%7;return n<0?7+n:n}var jh=(s,n)=>Array(Math.abs(n)+1).join(s),Il=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),qm="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",zm="(AA|A|P|M|m|d|dd)([-+]?\\d+)",Wm=new RegExp("^"+qm+"|"+zm+"$");function Vm(s){const n=Wm.exec(`${s}`);return n===null?["",""]:n[1]?[n[1],n[2]]:[n[4],n[3]]}var Gh={};function Hs(s){return typeof s=="string"?Gh[s]||(Gh[s]=$m(s)):ec(s)?Hs(Gm(s)):tc(s)?Hs(s.name):Il}var Hh=[0,2,4,5,7,9,11],Bu="PMMPPMM";function $m(s){const n=Vm(s);if(n[0]==="")return Il;const i=+n[0],a=n[1],r=(Math.abs(i)-1)%7,l=Bu[r];if(l==="M"&&a==="P")return Il;const u=l==="M"?"majorable":"perfectable",d=""+i+a,v=i<0?-1:1,p=i===8||i===-8?i:v*(r+1),y=jm(u,a),x=Math.floor((Math.abs(i)-1)/7),_=v*(Hh[r]+y+12*x),m=(v*(Hh[r]+y)%12+12)%12,f=Lu({step:r,alt:y,oct:x,dir:v});return{empty:!1,name:d,num:i,q:a,step:r,alt:y,dir:v,type:u,simple:p,semitones:_,chroma:m,coord:f,oct:x}}function qu(s,n){const[i,a=0]=s,r=i*7+a*12<0,l=n||r?[-i,-a,-1]:[i,a,1];return Hs(Fu(l))}function jm(s,n){return n==="M"&&s==="majorable"||n==="P"&&s==="perfectable"?0:n==="m"&&s==="majorable"?-1:/^A+$/.test(n)?n.length:/^d+$/.test(n)?-1*(s==="perfectable"?n.length:n.length+1):0}function Gm(s){const{step:n,alt:i,oct:a=0,dir:r}=s;if(!r)return"";const l=n+1+7*a,u=l===0?n+1:l,d=r<0?"-":"",v=Bu[n]==="M"?"majorable":"perfectable";return d+u+Hm(v,i)}function Hm(s,n){return n===0?s==="majorable"?"M":"P":n===-1&&s==="majorable"?"m":n>0?jh("A",n):jh("d",s==="perfectable"?n:n+1)}var Uh=(s,n)=>Array(Math.abs(n)+1).join(s),zu=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),Xh=new Map,Um=s=>"CDEFGAB".charAt(s),Wu=s=>s<0?Uh("b",-s):Uh("#",s),Vu=s=>s[0]==="b"?-s.length:s.length;function qe(s){const n=JSON.stringify(s),i=Xh.get(n);if(i)return i;const a=typeof s=="string"?Qm(s):ec(s)?qe(Jm(s)):tc(s)?qe(s.name):zu;return Xh.set(n,a),a}var Xm=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function sc(s){const n=Xm.exec(s);return n?[n[1].toUpperCase(),n[2].replace(/x/g,"##"),n[3],n[4]]:["","","",""]}function Ym(s){return qe(Fu(s))}var Zm=(s,n)=>(s%n+n)%n,bl=[0,2,4,5,7,9,11];function Qm(s){const n=sc(s);if(n[0]===""||n[3]!=="")return zu;const i=n[0],a=n[1],r=n[2],l=(i.charCodeAt(0)+3)%7,u=Vu(a),d=r.length?+r:void 0,v=Lu({step:l,alt:u,oct:d}),p=i+a+r,y=i+a,x=(bl[l]+u+120)%12,_=d===void 0?Zm(bl[l]+u,12)-12*99:bl[l]+u+12*(d+1),m=_>=0&&_<=127?_:null,f=d===void 0?null:Math.pow(2,(_-69)/12)*440;return{empty:!1,acc:a,alt:u,chroma:x,coord:v,freq:f,height:_,letter:i,midi:m,name:p,oct:d,pc:y,step:l}}function Jm(s){const{step:n,alt:i,oct:a}=s,r=Um(n);if(!r)return"";const l=r+Wu(i);return a||a===0?l+a:l}function nc(s,n){const i=qe(s),a=Array.isArray(n)?n:Hs(n).coord;if(i.empty||!a||a.length<2)return"";const r=i.coord,l=r.length===1?[r[0]+a[0]]:[r[0]+a[0],r[1]+a[1]];return Ym(l).name}function Ir(s,n){const i=qe(s),a=qe(n);if(i.empty||a.empty)return"";const r=i.coord,l=a.coord,u=l[0]-r[0],d=r.length===2&&l.length===2?l[1]-r[1]:-Math.floor(u*7/12),v=a.height===i.height&&a.midi!==null&&i.oct===a.oct&&i.step>a.step;return qu([u,d],v).name}function ic(s,n){const i=n.length,a=(s%i+i)%i;return n.slice(a,i).concat(n.slice(0,a))}function Km(s){return s.filter(n=>n===0||n)}var Vn={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},$u=s=>Number(s).toString(2).padStart(12,"0"),Yh=s=>parseInt(s,2),tg=/^[01]{12}$/;function ju(s){return tg.test(s)}var eg=s=>typeof s=="number"&&s>=0&&s<=4095,sg=s=>s&&ju(s.chroma),Zh={[Vn.chroma]:Vn};function oc(s){const n=ju(s)?s:eg(s)?$u(s):Array.isArray(s)?lg(s):sg(s)?s.chroma:Vn.chroma;return Zh[n]=Zh[n]||ag(n)}var ng=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function ig(s){const n=[];for(let i=0;i<12;i++)s.charAt(i)==="1"&&n.push(ng[i]);return n}function og(s,n=!0){const a=oc(s).chroma.split("");return Km(a.map((r,l)=>{const u=ic(l,a);return n&&u[0]==="0"?null:u.join("")}))}function rg(s){const n=s.split("");return n.map((i,a)=>ic(a,n).join(""))}function ag(s){const n=Yh(s),i=rg(s).map(Yh).filter(l=>l>=2048).sort()[0],a=$u(i),r=ig(s);return{empty:!1,name:"",setNum:n,chroma:s,normalized:a,intervals:r}}function lg(s){if(s.length===0)return Vn.chroma;let n;const i=[0,0,0,0,0,0,0,0,0,0,0,0];for(let a=0;a<s.length;a++)n=qe(s[a]),n.empty&&(n=Hs(s[a])),n.empty||(i[n.chroma]=1);return i.join("")}var cg=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],hg=cg,ug={...Vn,name:"",quality:"Unknown",intervals:[],aliases:[]},rc=[],So={};function cs(s){return So[s]||ug}function dg(){return rc.slice()}function fg(s,n,i){const a=mg(s),r={...oc(s),name:i||"",quality:a,intervals:s,aliases:n};rc.push(r),r.name&&(So[r.name]=r),So[r.setNum]=r,So[r.chroma]=r,r.aliases.forEach(l=>pg(r,l))}function pg(s,n){So[n]=s}function mg(s){const n=i=>s.indexOf(i)!==-1;return n("5A")?"Augmented":n("3M")?"Major":n("5d")?"Diminished":n("3m")?"Minor":"Unknown"}hg.forEach(([s,n,i])=>fg(s.split(" "),i.split(" "),n));rc.sort((s,n)=>s.setNum-n.setNum);var gg=s=>{const n=s.reduce((i,a)=>{const r=qe(a).chroma;return r!==void 0&&(i[r]=i[r]||qe(a).name),i},{});return i=>n[i]};function vg(s,n={}){const i=s.map(r=>qe(r).pc).filter(r=>r);return qe.length===0?[]:Tg(i,1,n).filter(r=>r.weight).sort((r,l)=>l.weight-r.weight).map(r=>r.name)}var zr={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},Wr=s=>n=>!!(n&s),yg=Wr(zr.anyThirds),bg=Wr(zr.perfectFifth),_g=Wr(zr.anySeventh),wg=Wr(zr.nonPerfectFifths);function xg(s){const n=parseInt(s.chroma,2);return yg(n)&&bg(n)&&_g(n)}function Sg(s){const n=parseInt(s,2);return wg(n)?s:(n|16).toString(2)}function Tg(s,n,i){const a=s[0],r=qe(a).chroma,l=gg(s),u=og(s,!1),d=[];return u.forEach((v,p)=>{const y=i.assumePerfectFifth&&Sg(v);dg().filter(_=>i.assumePerfectFifth&&xg(_)?_.chroma===y:_.chroma===v).forEach(_=>{const m=_.aliases[0],f=l(p);p!==r?d.push({weight:.5*n,name:`${f}${m}/${a}`}):d.push({weight:1*n,name:`${f}${m}`})})}),d}var Mg=Hs,Qh=Ir,Cg=Ag((s,n)=>[s[0]-n[0],s[1]-n[1]]);function Ag(s){return(n,i)=>{const a=Hs(n).coord,r=Hs(i).coord;if(a&&r){const l=s(a,r);return qu(l).name}}}var kg=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],Pg=kg,Eg={...Vn,intervals:[],aliases:[]},To={};function Ig(s){return To[s]||Eg}function Og(s,n,i=[]){const a={...oc(s),name:n,intervals:s,aliases:i};return To[a.name]=a,To[a.setNum]=a,To[a.chroma]=a,a.aliases.forEach(r=>Dg(a,r)),a}function Dg(s,n){To[n]=s}Pg.forEach(([s,n,...i])=>Og(s.split(" "),n,i));var Gu={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function Hu(s){const[n,i,a,r]=sc(s);return n===""?_l("",s):n==="A"&&r==="ug"?_l("","aug"):_l(n+i,a+r)}function _l(s,n){const i=n.split("/");if(i.length===1)return[s,i[0],""];const[a,r,l,u]=sc(i[1]);return a!==""&&l===""&&u===""?[s,i[0],a+r]:[s,n,""]}function Ol(s){if(Array.isArray(s))return wr(s[1]||"",s[0],s[2]);if(s==="")return Gu;{const[n,i,a]=Hu(s),r=wr(i,n,a);return r.empty?wr(s):r}}function wr(s,n,i){const a=cs(s),r=qe(n||""),l=qe(i||"");if(a.empty||n&&r.empty||i&&l.empty)return Gu;const u=Ir(r.pc,l.pc),d=a.intervals.indexOf(u),v=d>=0,p=v?l:qe(""),y=d===-1?NaN:d+1,x=l.pc&&l.pc!==r.pc,_=Array.from(a.intervals);if(v)for(let g=1;g<y;g++){const S=_[0][0],A=_[0][1],E=parseInt(S,10)+7;_.push(`${E}${A}`),_.shift()}else if(x){const g=Cg(Ir(r.pc,l.pc),"8P");g&&_.unshift(g)}const m=r.empty?[]:_.map(g=>nc(r.pc,g));s=a.aliases.indexOf(s)!==-1?s:a.aliases[0];const f=`${r.empty?"":r.pc}${s}${v&&y>1?"/"+p.pc:x?"/"+l.pc:""}`,b=`${n?r.pc+" ":""}${a.name}${v&&y>1?" over "+p.pc:x?" over "+l.pc:""}`;return{...a,name:b,symbol:f,tonic:r.pc,type:a.name,root:p.pc,bass:x?l.pc:"",intervals:_,rootDegree:y,notes:m}}var Rg=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],Ng=Rg;Ng.forEach(([s,n,i])=>void 0);var Lg="C C# D D# E F F# G G# A A# B".split(" "),Fg="C Db D Eb E F Gb G Ab A Bb B".split(" ");function Uu(s,n={}){if(isNaN(s)||s===-1/0||s===1/0)return"";s=Math.round(s);const a=(n.sharps===!0?Lg:Fg)[s%12];if(n.pitchClass)return a;const r=Math.floor(s/12)-1;return a+r}var Ni=qe,Or=s=>Ni(s).pc,Bg=s=>Ni(s).oct,Ci=s=>Ni(s).midi,Xu=nc,ac=s=>{const n=Ni(s);return n.empty?"":Uu(n.midi||n.chroma,{sharps:n.alt>0,pitchClass:n.midi===null})};function qg(s,n){const i=Ni(s);if(i.empty)return"";const a=Ni(n||Uu(i.midi||i.chroma,{sharps:i.alt<0,pitchClass:!0}));if(a.empty||a.chroma!==i.chroma)return"";if(i.oct===void 0)return a.pc;const r=i.chroma-i.alt,l=a.chroma-a.alt,u=r>11||l<0?-1:r<0||l>11?1:0,d=i.oct+u;return a.pc+d}var Yu={empty:!0,name:"",chordType:""},Jh={};function Eo(s){return typeof s=="string"?Jh[s]||(Jh[s]=jg(s)):typeof s=="number"?Eo(lc[s]||""):ec(s)?zg(s):tc(s)?Eo(s.name):Yu}function zg(s){return Eo(Wu(s.alt)+lc[s.step])}var Wg=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function Vg(s){return Wg.exec(s)||["","","",""]}var $g="I II III IV V VI VII",lc=$g.split(" ");function jg(s){const[n,i,a,r]=Vg(s);if(!a)return Yu;const l=a.toUpperCase(),u=lc.indexOf(l),d=Vu(i),v=1;return{empty:!1,name:n,roman:a,interval:Hs({step:u,alt:d,dir:v}).name,acc:i,chordType:r,alt:d,step:u,major:a===l,oct:0,dir:v}}var cc=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],Kh={...Vn,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},Gg=cc.map(Hg),Dl={};Gg.forEach(s=>{Dl[s.name]=s,s.aliases.forEach(n=>{Dl[n]=s})});function Zu(s){return typeof s=="string"?Dl[s.toLowerCase()]||Kh:s&&s.name?Zu(s.name):Kh}function Hg(s){const[n,i,a,r,l,u,d]=s,v=d?[d]:[],p=Number(i).toString(2);return{empty:!1,intervals:Ig(r).intervals,modeNum:n,chroma:p,normalized:p,name:r,setNum:i,alt:a,triad:l,seventh:u,aliases:v}}function Qu(s){return(n,i)=>{const a=Zu(n);if(a.empty)return[];const r=ic(a.modeNum,s),l=a.intervals.map(u=>nc(i,u));return r.map((u,d)=>l[d]+u)}}Qu(cc.map(s=>s[4]));Qu(cc.map(s=>s[5]));function Ug(s,n){return n.map(i=>{const[a,r]=Hu(i),l=Ir(s,a);return Eo(Hs(l)).name+r})}class Xg{constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,paint:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...n){n.forEach(i=>{this.categories.hasOwnProperty(i)&&(this.categories[i]=!0,console.log(`[Logger] Enabled category: ${i}`))})}disable(...n){n.forEach(i=>{this.categories.hasOwnProperty(i)&&(this.categories[i]=!1,console.log(`[Logger] Disabled category: ${i}`))})}enableAll(){Object.keys(this.categories).forEach(n=>{this.categories[n]=!0}),this.setLevel("DEBUG"),console.log("[Logger] All categories enabled")}disableAll(){Object.keys(this.categories).forEach(n=>{this.categories[n]=!1}),this.setLevel("ERROR"),console.log("[Logger] All categories disabled")}isCategoryEnabled(n){return this.categories[n]===!0}setLevel(n){const a=["DEBUG","INFO","WARN","ERROR"].indexOf(n);a!==-1&&(this.enabledLevels={DEBUG:a<=0,INFO:a<=1,WARN:a<=2,ERROR:a<=3})}formatComponent(n){return`[${n}]`}moduleLoaded(n,i="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(i)||console.log(`${n}: Module loaded.`)}initStart(n,i="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(i)||console.log(`Main.js: Initializing ${n}...`)}initSuccess(n,i="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(i)||console.log(`Main.js: ${n} initialized successfully.`)}initFailed(n,i="",a="initialization"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(a))return;const r=i?` (${i})`:"";console.warn(`Main.js: ${n} failed to initialize${r}.`)}section(n,i="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(i)||(console.log("========================================"),console.log(n),console.log("========================================"))}event(n,i,a="",r="ui"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const l=this.formatComponent(n),u=a?`${i}. ${a}`:i;console.log(`${l} ${u}`)}state(n,i,a=null,r="state"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const l=this.formatComponent(n);if(a){const u=typeof a=="object"?JSON.stringify(a):String(a);console.log(`${l} ${i}: ${u}`)}else console.log(`${l} ${i}`)}debug(n,i,a=null,r="debug"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r))return;const l=this.formatComponent(n);if(a){const u=typeof a=="object"?JSON.stringify(a):String(a);console.log(`${l} ${i}: ${u}`)}else console.log(`${l} ${i}`)}timing(n,i,a,r="performance"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r))return;const l=this.formatComponent(n),u=Object.entries(a).map(([d,v])=>typeof v=="number"&&v%1!==0?`${d}=${v.toFixed(3)}`:`${d}=${v}`).join(", ");console.log(`${l} ${i}: ${u}`)}warn(n,i,a=null,r="general"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(r))return;const l=this.formatComponent(n);a?console.warn(`${l} ${i}`,a):console.warn(`${l} ${i}`)}error(n,i,a=null,r="general"){if(!this.enabledLevels.ERROR)return;const l=this.formatComponent(n);a?console.error(`${l} ${i}`,a):console.error(`${l} ${i}`)}info(n,i,a=null,r="general"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const l=this.formatComponent(n);a?console.log(`${l} ${i}`,a):console.log(`${l} ${i}`)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([n,i])=>i).map(([n])=>n)}}getAvailableCategories(){return Object.keys(this.categories)}log(n,i,a=null){this.info(n,i,a,"general")}}const B=new Xg;typeof window<"u"&&(window.logger=B);const Rl=24;let Je=pm,bo=mm,gs=0,ks,Mo,tu,Ai,eu,Nl,Ll,xo,su,xr=!1,fr=0;function Yg(){const s=[{name:"toolbar",el:document.getElementById("toolbar")},{name:"app-container",el:document.getElementById("app-container")},{name:"grid-container",el:document.getElementById("grid-container")},{name:"pitch-grid-container",el:document.getElementById("pitch-grid-container")},{name:"pitch-grid-wrapper",el:document.getElementById("pitch-grid-wrapper")},{name:"canvas-content",el:document.getElementById("canvas-content")},{name:"canvas-container",el:document.getElementById("canvas-container")},{name:"harmonyAnalysisGrid",el:document.getElementById("harmonyAnalysisGrid")},{name:"drum-grid-wrapper",el:document.getElementById("drum-grid-wrapper")}];B.debug("Layout Service","Container Width Pipeline",null,"layout"),s.forEach(({name:n,el:i})=>{if(i){const a=window.getComputedStyle(i);B.debug("Layout Service",`${n} container info`,{setWidth:i.style.width||"auto",computedWidth:a.width,clientWidth:i.clientWidth+"px",scrollWidth:i.scrollWidth+"px"},"layout")}else B.warn("Layout Service",`${n}: NOT FOUND`,null,"layout")})}function Zg(){document.getElementById("grid-container"),ks=document.getElementById("pitch-grid-wrapper"),Mo=document.getElementById("notation-grid"),document.getElementById("drum-grid-wrapper"),Ai=document.getElementById("drum-grid"),Nl=document.getElementById("playhead-canvas"),Ll=document.getElementById("hover-canvas"),xo=document.getElementById("drum-hover-canvas");const s=document.getElementById("canvas-container");return!ks||!Mo||!s?(B.error("Layout Service","FATAL: Could not find essential canvas elements",null,"initialization"),{}):(tu=Mo.getContext("2d"),eu=Ai.getContext("2d"),{ctx:tu,drumCtx:eu,canvasContainer:s})}function Rn(){if(B.debug("Layout Service","recalcAndApplyLayout() called",null,"layout"),!ks||ks.clientHeight===0){B.debug("Layout Service","Deferring layout - pitchGridWrapper not ready",null,"layout"),requestAnimationFrame(Rn);return}if(xr){B.warn("Layout Service","Skipping recalculation - already in progress",null,"layout");return}B.debug("Layout Service","Beginning layout recalculation",null,"layout"),xr=!0;const s=document.getElementById("pitch-grid-container"),n=s.clientHeight,i=ks.clientWidth,a=Math.abs(n-gs),r=Math.abs(i-(ks._lastViewportWidth||0));(a>0||r>0)&&(B.debug("Layout Service","Viewport changed",`${i}×${n}`,"layout"),(a>3||gs===0)&&(gs=n),(r>3||!ks._lastViewportWidth)&&(ks._lastViewportWidth=i));const l=gs/Rl*gm,u=l*vm,d=l*Je,v=u*Je;(T.state.cellWidth!==v||T.state.cellHeight!==d)&&B.debug("Layout Service","Cell size changed",`${v.toFixed(1)}×${d.toFixed(1)}`,"layout"),T.state.cellHeight=d,T.state.cellWidth=v;const{macrobeatGroupings:p}=T.state,y=Us(T.state),x=[...T.state.columnWidths||[]],_=[ur,ur];B.debug("Layout Service","Starting layout recalculation",null,"layout"),B.debug("Layout Service","Placed tonic signs",y.map(wt=>`col:${wt.columnIndex},mb:${wt.preMacrobeatIndex}`),"layout"),B.debug("Layout Service","Old columnWidths",x,"layout"),B.debug("Layout Service","Macrobeat groupings",p,"layout");const m=[...y].sort((wt,Mt)=>wt.preMacrobeatIndex-Mt.preMacrobeatIndex);let f=0;const b=wt=>{var Rt,Xt;let Mt=(Rt=m[f])==null?void 0:Rt.uuid;for(;m[f]&&m[f].preMacrobeatIndex===wt;){B.debug("Layout Service",`Adding tonic columns for mbIndex ${wt}, tonic at column ${m[f].columnIndex}`,null,"layout");const nt=_.length;for(_.push(dr),_.push(dr),B.debug("Layout Service",`Added 2 columns (width=${dr} each), total columns: ${nt} -> ${_.length}`,null,"layout");m[f]&&m[f].uuid===Mt;)f++;Mt=(Xt=m[f])==null?void 0:Xt.uuid}};b(-1),p.forEach((wt,Mt)=>{for(let Rt=0;Rt<wt;Rt++)_.push(dr);b(Mt)}),_.push(ur,ur),B.debug("Layout Service","Final newColumnWidths",_,"layout"),B.debug("Layout Service","Width change",`${x.length} -> ${_.length} columns`,"layout"),B.debug("Layout Service","Old total width units",x.reduce((wt,Mt)=>wt+Mt,0),"layout"),B.debug("Layout Service","New total width units",_.reduce((wt,Mt)=>wt+Mt,0),"layout"),T.state.columnWidths=_;const g=_.reduce((wt,Mt)=>wt+Mt,0),S=g*T.state.cellWidth,A=It.getModulatedCanvasWidth(),E=A>S?A:S,O=Math.round(E);B.debug("Layout Service","Grid width calculated",`${O}px (${g} units)`,"layout");const L=document.getElementById("drum-grid-wrapper"),F=document.getElementById("harmonyAnalysisGrid"),U=O+"px";s&&(s.style.width=U),L&&(L.style.width=U),F&&(F.style.width=U),B.debug("Layout Service","Container Width Sync",{pitchGridContainer:(s==null?void 0:s.clientWidth)+"px",drumGridWrapper:(L==null?void 0:L.clientWidth)+"px",harmonyAnalysisGrid:(F==null?void 0:F.clientWidth)+"px",setTo:U,allMatch:"Containers synchronized with canvas widths"},"layout"),[Mo,Nl,Ll,Ai,xo].forEach(wt=>{wt&&Math.abs(wt.width-O)>1&&(wt.width=O)});const X=Math.max(Do,Ro*T.state.cellHeight),Q=ym*X,ct=`${Q}px`,gt=Math.abs(fr-Q)>5,_t=L&&(gt||fr===0);B.debug("Layout Service","Drum Grid Height Debug (DEFERRED)",{drumRowHeight:X,drumCanvasHeight:Q,lastCalculatedDrumHeight:fr,drumHeightChanged:gt,willUpdateDeferred:_t},"layout"),_t&&(B.debug("Layout Service","Setting drum-grid-wrapper height to",ct,"layout"),L.style.height=ct,fr=Q),Ai&&Math.abs(Ai.height-Q)>1&&(Ai.height=Q),xo&&Math.abs(xo.height-Q)>1&&(xo.height=Q),setTimeout(()=>{const wt=document.getElementById("pitch-grid-container"),Mt=wt.clientHeight;B.debug("Layout Service","Canvas Heights (DEFERRED)",{oldViewportHeight:gs,finalViewportHeight:Mt,pitchGridContainer:wt==null?void 0:wt.clientHeight,pitchGridWrapper:ks==null?void 0:ks.clientHeight},"layout"),[Mo,Nl,Ll].forEach((Rt,Xt)=>{if(Rt&&Math.abs(Rt.height-Mt)>1){const nt=["notation-grid","playhead-canvas","hover-canvas"];B.debug("Layout Service",`Setting ${nt[Xt]} height (DEFERRED): ${Rt.height} → ${Mt}`,null,"layout"),Rt.height=Mt}}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}})),B.debug("Layout Service","Dispatched canvasResized event after deferred resize",null,"layout")},25),T.emit("layoutConfigChanged"),setTimeout(()=>{var wt,Mt,Rt,Xt,nt,ht;B.debug("Layout Service","Final Canvas Heights (after layout)",{"pitch-grid-container":(wt=document.getElementById("pitch-grid-container"))==null?void 0:wt.clientHeight,"notation-grid":(Mt=document.getElementById("notation-grid"))==null?void 0:Mt.height,"pitch-paint-canvas":(Rt=document.getElementById("pitch-paint-canvas"))==null?void 0:Rt.height,"playhead-canvas":(Xt=document.getElementById("playhead-canvas"))==null?void 0:Xt.height,"hover-canvas":(nt=document.getElementById("hover-canvas"))==null?void 0:nt.height,"pitch-canvas-wrapper":(ht=document.getElementById("pitch-canvas-wrapper"))==null?void 0:ht.clientHeight},"layout")},50),xr=!1}const It={init(){const{ctx:s,drumCtx:n,canvasContainer:i}=Zg();requestAnimationFrame(Rn);const a=()=>{if(xr){B.warn("Layout Service","Window resize: Skipping - recalculation in progress",null,"layout");return}clearTimeout(su),su=setTimeout(()=>{B.debug("Layout Service","Window resize: Triggering layout recalculation after debounce",null,"layout"),Rn()},fm)};return window.addEventListener("resize",a),B.debug("Layout Service","Layout trigger: Using window resize events instead of ResizeObserver",null,"layout"),{ctx:s,drumCtx:n}},zoomIn(){const s=Je;Je=Math.min(bm,Je*wm),B.debug("Layout Service","ZOOM IN",{from:s,to:Je},"zoom"),Rn()},zoomOut(){const s=Je;Je=Math.max(_m,Je*xm),B.debug("Layout Service","ZOOM OUT",{from:s,to:Je},"zoom"),Rn()},resetZoom(){Je=1,Rn()},scroll(s){const n=s/gs/4;bo=Math.max(0,Math.min(1,bo+n)),T.emit("layoutConfigChanged")},scrollByPixels(s,n=0){const i=-s,a=T.state.fullRowData.length,l=gs/Rl*Je,d=a*l+l,v=Math.max(0,d-gs);if(v>0){const p=i/v;bo=Math.max(0,Math.min(1,bo+p))}T.emit("layoutConfigChanged")},getViewportInfo(){const s=T.state.fullRowData.length,i=gs/Rl*Je,r=s*i+i*.5,u=Math.max(0,r-gs)*bo-i,d=Math.max(0,Math.floor(u/i)-2),v=gs/i,p=Math.min(s-1,Math.ceil(d+v+2));return{zoomLevel:Je,viewportHeight:gs,rowHeight:i,startRow:d,endRow:p,scrollOffset:u}},getMacrobeatWidthPx(s,n){return n*s.cellWidth},getColumnX(s){let n=0;for(let i=0;i<s;i++)n+=(T.state.columnWidths[i]||0)*T.state.cellWidth;return n},getCanvasWidth(){return T.state.columnWidths.reduce((s,n)=>s+n,0)*T.state.cellWidth},getModulatedCanvasWidth(){const s=this.getCanvasWidth();if(!T.state.modulationMarkers||T.state.modulationMarkers.length===0)return s;try{const n=T.state.baseMicrobeatPx||T.state.cellWidth||40;let i=s;return T.state.modulationMarkers.forEach(r=>{r.ratio>1?i*=r.ratio:r.ratio<1}),Math.max(s,i)}catch(n){return console.warn("[LAYOUT] Error calculating modulated width, using base width:",n),s}},recalculateLayout(){Rn()}};window.debugContainerWidths=Yg;const Qg=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],Us=s=>Object.values(s.tonicSignGroups).flat(),He=(s,n)=>{let i=2;const{macrobeatGroupings:a}=s,r=Us(s);r.some(v=>v.preMacrobeatIndex===-1)&&(i+=2);for(let v=0;v<n;v++)i+=a[v],r.some(p=>p.preMacrobeatIndex===v)&&(i+=2);const l=i,u=a[n],d=l+(u||0)-1;return{startColumn:l,endColumn:d,grouping:u}},Jg=s=>s.placedNotes.filter(n=>!n.isDrum),Kg=s=>s.placedNotes.filter(n=>n.isDrum),Ju=(s,n)=>{const a=Us(s).filter(d=>d.columnIndex<=n);if(a.length===0)return{keyTonic:"C",keyMode:"major"};const r=a.reduce((d,v)=>v.columnIndex>d.columnIndex?v:d),l=Or(s.fullRowData[r.row].toneNote),u=Qg[r.tonicNumber-1]||"major";return{keyTonic:l,keyMode:u}},tv=(s,n)=>{const i=[],{fullRowData:a,placedNotes:r,placedChords:l}=s;return r.forEach(u=>{var d;if(!u.isDrum&&n>=u.startColumnIndex&&n<=u.endColumnIndex){const v=(d=a[u.row])==null?void 0:d.toneNote;v&&i.push(v)}}),l.forEach(u=>{u.position.xBeat===n&&i.push(...u.notes)}),i},Ku=(s,n)=>{const i=new Set,{startColumn:a,endColumn:r}=He(s,n);for(let u=a;u<=r;u++)tv(s,u).forEach(v=>{i.add(Or(v))});return Array.from(i)};function wl(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const ev={addNote(s){if(this.state.placedNotes.find(a=>!a.isDrum&&a.row===s.row&&a.startColumnIndex===s.startColumnIndex&&a.color===s.color))return null;const i={...s,uuid:wl()};return this.state.placedNotes.push(i),this.emit("notesChanged"),i},updateNoteTail(s,n){s.endColumnIndex=n,this.emit("notesChanged")},updateMultipleNoteTails(s,n){console.log("[CHORD DEBUG] updateMultipleNoteTails called with:",s.length,"notes, newEndColumn:",n),s.forEach((i,a)=>{console.log(`[CHORD DEBUG] Updating note ${a}: ${i.endColumnIndex} -> ${n}`),i.endColumnIndex=n}),console.log("[CHORD DEBUG] Emitting notesChanged event"),this.emit("notesChanged")},eraseInPitchArea(s,n,i=1,a=!0){const r=s+i-1,l=n-1,u=n+1;let d=!1;const v=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(p=>{if(p.isDrum)return!0;if(p.shape==="circle"){const y=p.startColumnIndex+1,x=p.startColumnIndex<=r&&y>=s,_=p.row>=l&&p.row<=u;if(x&&_)return!1}else if(p.row>=l&&p.row<=u&&p.startColumnIndex<=r&&p.endColumnIndex>=s)return!1;return!0}),this.state.placedNotes.length<v&&(d=!0),d&&(this.emit("notesChanged"),a&&this.recordState()),d},eraseDrumNoteAt(s,n,i=!0){const a=this.state.placedNotes.length;this.state.placedNotes=this.state.placedNotes.filter(l=>!(l.isDrum&&l.drumTrack===n&&l.startColumnIndex===s));const r=this.state.placedNotes.length<a;return r&&(this.emit("notesChanged"),i&&this.recordState()),r},addTonicSignGroup(s){B.debug("TonicPlacement","Starting addTonicSignGroup",{tonicSignGroup:s},"state");const n=s[0],{preMacrobeatIndex:i}=n;if(B.debug("TonicPlacement","preMacrobeatIndex",{preMacrobeatIndex:i},"state"),Object.values(this.state.tonicSignGroups).flat().some(d=>d.preMacrobeatIndex===i)){B.debug("TonicPlacement","Tonic already exists at this preMacrobeatIndex, returning",null,"state");return}const a=He(this.state,i+1).startColumn;B.debug("TonicPlacement","Boundary column for shifting notes",{boundaryColumn:a},"state");const r=this.state.placedNotes.filter(d=>d.startColumnIndex>=a);B.debug("TonicPlacement","Notes that will be shifted",{noteRanges:r.map(d=>`${d.startColumnIndex}-${d.endColumnIndex}`)},"state"),this.state.placedNotes.forEach(d=>{if(d.startColumnIndex>=a){const v=d.startColumnIndex,p=d.endColumnIndex;d.startColumnIndex+=2,d.endColumnIndex+=2,B.debug("TonicPlacement",`Shifted note from ${v}-${p} to ${d.startColumnIndex}-${d.endColumnIndex}`,null,"state")}});const l=wl(),u=s.map(d=>({...d,uuid:l}));this.state.tonicSignGroups[l]=u,B.debug("TonicPlacement","Added tonic group",{uuid:l,columns:u.map(d=>d.columnIndex)},"state"),B.debug("TonicPlacement","Emitting events: notesChanged, rhythmStructureChanged",null,"state"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(s,n=!0){const i=Object.entries(this.state.tonicSignGroups).find(([d,v])=>v.some(p=>p.columnIndex===s));if(!i)return!1;const[a,r]=i,l=r[0].preMacrobeatIndex,u=He(this.state,l+1).startColumn;return delete this.state.tonicSignGroups[a],this.state.placedNotes.forEach(d=>{d.startColumnIndex>=u&&(d.startColumnIndex-=2,d.endColumnIndex-=2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),n&&this.recordState(),!0},toggleDrumNote(s){const n=this.state.placedNotes.findIndex(i=>i.isDrum&&i.drumTrack===s.drumTrack&&i.startColumnIndex===s.startColumnIndex);n>=0?this.state.placedNotes.splice(n,1):this.state.placedNotes.push({...s,uuid:wl()}),this.emit("notesChanged"),this.recordState()},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(s){this.state.placedNotes=s,this.emit("notesChanged"),this.recordState()}},sv={setADSR(s,n){this.state.timbres[s]&&(this.state.timbres[s].adsr=n,this.state.timbres[s].activePresetName=null,this.emit("timbreChanged",s))},setFilterSettings(s,n){if(this.state.timbres[s]){console.log("setFilterSettings called:",{color:s,newSettings:n,activePresetName:this.state.timbres[s].activePresetName}),console.trace("setFilterSettings call stack"),Object.assign(this.state.timbres[s].filter,n);const i=this.state.timbres[s].filter.blend;i<=0?this.state.timbres[s].filter.type="highpass":i>=2?this.state.timbres[s].filter.type="lowpass":this.state.timbres[s].filter.type="bandpass",n.enabled===void 0&&(console.log("Clearing activePresetName because enabled is undefined"),this.state.timbres[s].activePresetName=null),this.emit("timbreChanged",s)}},setHarmonicCoefficients(s,n){this.state.timbres[s]&&(this.state.timbres[s].coeffs=n,this.state.timbres[s].activePresetName=null,this.emit("timbreChanged",s))},setHarmonicPhases(s,n){this.state.timbres[s]&&(B.debug("TimbreActions",`setHarmonicPhases called for ${s}`,null,"state"),B.debug("TimbreActions","Old phases",{phases:this.state.timbres[s].phases},"state"),B.debug("TimbreActions","New phases",{phases:n},"state"),B.debug("TimbreActions","Coefficients before phase change",{coeffs:this.state.timbres[s].coeffs},"state"),this.state.timbres[s].phases=n,this.state.timbres[s].activePresetName=null,B.debug("TimbreActions","Coefficients after phase change",{coeffs:this.state.timbres[s].coeffs},"state"),B.debug("TimbreActions","Emitting timbreChanged for phase change",null,"state"),this.emit("timbreChanged",s))},applyPreset(s,n){!n||!this.state.timbres[s]||(B.debug("TimbreActions",`applyPreset called for ${s}`,null,"state"),B.debug("TimbreActions","Preset name",{name:n.name},"state"),B.debug("TimbreActions","Preset coeffs",{coeffs:n.coeffs},"state"),B.debug("TimbreActions","Old timbre coeffs",{coeffs:this.state.timbres[s].coeffs},"state"),this.state.timbres[s].adsr=n.adsr,this.state.timbres[s].coeffs=new Float32Array(n.coeffs),n.phases?this.state.timbres[s].phases=new Float32Array(n.phases):this.state.timbres[s].phases=new Float32Array(this.state.timbres[s].coeffs.length).fill(0),this.state.timbres[s].activePresetName=n.name,n.filter?this.state.timbres[s].filter=JSON.parse(JSON.stringify(n.filter)):this.state.timbres[s].filter=Ou(),B.debug("TimbreActions","Applied preset - new coeffs",{coeffs:this.state.timbres[s].coeffs},"state"),this.emit("timbreChanged",s),this.recordState())}},bs={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function nv(s,n){if(console.log("[MODULATION] measureIndexToCanvasX called:",{measureIndex:s,hasState:!!n,cellWidth:n?n.cellWidth:"N/A"}),!n){console.warn("[MODULATION] No state provided for measure conversion");const u=s*200;return console.log("[MODULATION] Using fallback calculation:",u),u}const i=n.cellWidth||40;if(console.log("[MODULATION] Using cellWidth:",i),s===0){const u=2*i;return console.log("[MODULATION] Measure 0 → column 2 →",u),u}const a=s-1;console.log("[MODULATION] Looking for macrobeat index:",a);const r=He(n,a);if(console.log("[MODULATION] getMacrobeatInfo result:",r),r){const u=(r.endColumn+1)*i;return console.log("[MODULATION] Found measure info, calculated position:",u),u}console.warn("[MODULATION] Could not find measure info for index:",s);const l=s*i*4;return console.log("[MODULATION] Using improved fallback calculation:",l),l}function iv(s,n,i=null,a=null,r=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:s,ratio:n,active:!0,xPosition:i,columnIndex:a,macrobeatIndex:r}}function td(s){return Math.abs(s-bs.COMPRESSION_2_3)<.001?"2:3":Math.abs(s-bs.EXPANSION_3_2)<.001?"3:2":`${s}`}function ed(s){return Math.abs(s-bs.COMPRESSION_2_3)<.001?"#dc3545":Math.abs(s-bs.EXPANSION_3_2)<.001?"#007bff":"#6c757d"}function nu(s){return{segments:[{startX:0,endX:1/0,scale:1,spacingPx:s}],microbeatToCanvasX(n){return n*s},canvasXToMicrobeat(n){return n/s},getSegmentAtX(n){return this.segments[0]},getGhostGridPositions(n,i){return[]}}}function sd(s,n,i=null){if(!s||s.length===0)return nu(n);const a=[...s.filter(d=>d.active)].sort((d,v)=>d.measureIndex-v.measureIndex);if(a.length===0)return nu(n);console.log("[MODULATION] Creating coordinate mapping for markers:",a);const r=a.map(d=>{let v;return d.xPosition!==null&&d.xPosition!==void 0?(v=d.xPosition,console.log(`[MODULATION] Marker at measure ${d.measureIndex} → using stored x=${v}`)):(v=nv(d.measureIndex,i),console.log(`[MODULATION] Marker at measure ${d.measureIndex} → calculated x=${v}`)),console.log("[MODULATION] Final marker position:",{id:d.id,measureIndex:d.measureIndex,canvasX:v,isStored:d.xPosition!==null&&d.xPosition!==void 0}),{...d,xCanvas:v}}),l=[];let u=1;(r.length===0||r[0].xCanvas>0)&&l.push({startX:0,endX:r.length>0?r[0].xCanvas:1/0,scale:1,spacingPx:n});for(let d=0;d<r.length;d++){const v=r[d],p=d+1<r.length?r[d+1].xCanvas:1/0;u*=v.ratio,l.push({startX:v.xCanvas,endX:p,scale:u,spacingPx:n*u,marker:v})}return{segments:l,microbeatToCanvasX(d){let v=0,p=0;for(const y of l){const _=(y.endX-y.startX)/y.spacingPx;if(p+_>=d){const m=d-p;return y.startX+m*y.spacingPx}p+=_,v=y.endX}return v},canvasXToMicrobeat(d){let v=0;for(const p of l){if(d>=p.startX&&d<p.endX){const _=(d-p.startX)/p.spacingPx;return v+_}const y=p.endX-p.startX;v+=y/p.spacingPx}return v},getSegmentAtX(d){return l.find(v=>d>=v.startX&&d<v.endX)||null},getGhostGridPositions(d,v){if(console.log("[GHOST-CALC] getGhostGridPositions called with:",{segment:d,hasMarker:!!d.marker,hasOptions:!!v}),!d.marker)return console.log("[GHOST-CALC] No marker on segment, returning empty array"),[];if(!v||!v.columnWidths)return console.warn("[GHOST-CALC] No grid options provided"),[];const p=[],{columnWidths:y,cellWidth:x}=v;if(console.log("[GHOST-CALC] Options check:",{hasColumnWidths:!!y,columnCount:y?y.length:0,cellWidth:x,segmentStartX:d.startX,segmentEndX:d.endX,segmentScale:d.scale}),!y||!x||x===0)return console.warn("[GHOST-CALC] Missing grid data"),[];let _=0;for(let m=0;m<y.length;m++){const f=_;if(d.endX===1/0?f>=d.startX:f>=d.startX&&f<d.endX){let S,A;if(d.endX===1/0){const E=y.reduce((O,L)=>O+L,0)*x;A=Math.max(E,d.startX+800),S=A-d.startX}else S=d.endX-d.startX,A=d.endX;if(S>0&&d.scale>0){const E=(f-d.startX)/S,O=S/d.scale,L=d.startX+E*O;!isNaN(L)&&isFinite(L)&&p.push(L)}}const g=y[m]||0;if(_+=g*x,d.endX!==1/0&&_>d.endX)break}return p}}}function ov(s,n,i){let a=0;for(const r of n.segments){if(s>=r.startX&&s<r.endX){const p=(s-r.startX)/r.spacingPx,y=i/r.scale;return a+p*y}const u=(r.endX-r.startX)/r.spacingPx,d=i/r.scale;a+=u*d}return a}const rv={setAnacrusis(s){if(this.state.hasAnacrusis===s)return;const n=this.state.macrobeatGroupings,i=s?ku:hm,a=n.reduce((u,d)=>u+d,0),l=i.reduce((u,d)=>u+d,0)-a;if(this.state.hasAnacrusis=s,this.state.macrobeatGroupings=[...i],this.state.macrobeatBoundaryStyles=s?[...Pu]:[...um],l!==0){const u=[];this.state.placedNotes.forEach(p=>{if(p.startColumnIndex>=2){const x=p.startColumnIndex+l,_=p.endColumnIndex+l;x<2?u.push(p):(p.startColumnIndex=x,p.endColumnIndex=_)}}),u.forEach(p=>{const y=this.state.placedNotes.indexOf(p);y>-1&&this.state.placedNotes.splice(y,1)});const d=[];this.state.stampPlacements.forEach(p=>{if(p.startColumn>=2){const x=p.startColumn+l,_=p.endColumn+l;x<2?d.push(p):(p.startColumn=x,p.endColumn=_)}}),d.forEach(p=>{const y=this.state.stampPlacements.indexOf(p);y>-1&&this.state.stampPlacements.splice(y,1)});const v=[];this.state.tripletPlacements&&(this.state.tripletPlacements.forEach(p=>{const y=l/2,x=1;if(p.startCellIndex>=x){const _=p.startCellIndex+y;_<x?v.push(p):p.startCellIndex=_}}),v.forEach(p=>{const y=this.state.tripletPlacements.indexOf(p);y>-1&&this.state.tripletPlacements.splice(y,1)})),Object.values(this.state.tonicSignGroups).flat().forEach(p=>{p.preMacrobeatIndex>=0})}this.emit("anacrusisChanged",s),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(s){if(s===void 0||s<0||s>=this.state.macrobeatGroupings.length){B.error("rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${s}`,null,"state");return}const n=this.state.macrobeatGroupings[s],i=n===2?3:2,a=i-n;let r=2;const l=Object.values(this.state.tonicSignGroups).flat(),u=new Set(l.filter(d=>d.preMacrobeatIndex<s).map(d=>d.uuid)).size;r+=u;for(let d=0;d<=s;d++)r+=this.state.macrobeatGroupings[d];this.state.placedNotes.forEach(d=>{d.startColumnIndex>=r&&(d.startColumnIndex+=a,d.endColumnIndex+=a)}),this.state.macrobeatGroupings[s]=i,this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(s){if(s===void 0||s<0||s>=this.state.macrobeatBoundaryStyles.length){B.error("rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${s}`,null,"state");return}const n=this._isBoundaryInAnacrusis(s);let i;n?i=["dashed","solid","anacrusis"]:i=["dashed","solid"];const a=this.state.macrobeatBoundaryStyles[s],r=i.indexOf(a),l=r===-1?0:(r+1)%i.length;this.state.macrobeatBoundaryStyles[s]=i[l],this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(s){if(!this.state.hasAnacrusis)return!1;for(let n=0;n<=s;n++)if(this.state.macrobeatBoundaryStyles[n]==="solid")return n===s;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){this.state.macrobeatGroupings.length>1&&(this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),this.emit("rhythmStructureChanged"),this.recordState())},updateTimeSignature(s,n){if(!Array.isArray(n)||n.length===0){B.error("rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let i=0,a=0,r=0;for(let m=0;m<this.state.macrobeatGroupings.length;m++){if(r===s){i=m;break}const f=m===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[m]==="solid"||f)&&r++}r=0;for(let m=0;m<this.state.macrobeatGroupings.length;m++)if(r===s){const f=m===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[m]==="solid"||f){a=m;break}}else if(r<s){const f=m===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[m]==="solid"||f)&&r++}const l=a-i+1,u=n.length,d=n.reduce((m,f)=>m+f,0)-this.state.macrobeatGroupings.slice(i,a+1).reduce((m,f)=>m+f,0);let v=2;const p=Object.values(this.state.tonicSignGroups).flat(),y=new Set(p.filter(m=>m.preMacrobeatIndex<=a).map(m=>m.uuid)).size;v+=y;for(let m=0;m<=a;m++)v+=this.state.macrobeatGroupings[m];d!==0&&this.state.placedNotes.forEach(m=>{m.startColumnIndex>=v&&(m.startColumnIndex+=d,m.endColumnIndex+=d)});const x=[...n],_=new Array(u-1).fill("dashed");if(a<this.state.macrobeatBoundaryStyles.length){const m=this.state.macrobeatBoundaryStyles[a];u>0&&_.push(m)}this.state.macrobeatGroupings.splice(i,l,...x),this.state.macrobeatBoundaryStyles.splice(i,l-1,..._),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(s,n,i=null,a=null,r=null){if(!Object.values(bs).includes(n))return B.error("rhythmActions",`Invalid modulation ratio: ${n}`,null,"state"),null;const l=this.state.modulationMarkers.findIndex(d=>d.measureIndex===s||r!==null&&d.macrobeatIndex===r||a!==null&&d.columnIndex===a);if(l!==-1){const d=this.state.modulationMarkers[l];return B.info("rhythmActions",`Replacing existing modulation marker ${d.id} at measure ${s} (old ratio: ${d.ratio}, new ratio: ${n})`,null,"state"),d.ratio=n,d.xPosition=i,a!==null&&(d.columnIndex=a),r!==null&&(d.macrobeatIndex=r),this.emit("modulationMarkersChanged"),this.recordState(),d.id}const u=iv(s,n,i,a,r);return this.state.modulationMarkers.push(u),this.state.modulationMarkers.sort((d,v)=>d.measureIndex-v.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),B.info("rhythmActions",`Added modulation marker ${u.id} at measure ${s} with ratio=${n}, columnIndex=${a}`,null,"state"),console.log("[MODULATION] State after adding marker:",{markerCount:this.state.modulationMarkers.length,markers:this.state.modulationMarkers}),u.id},removeModulationMarker(s){const n=this.state.modulationMarkers.findIndex(i=>i.id===s);if(n===-1){B.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}this.state.modulationMarkers.splice(n,1),this.emit("modulationMarkersChanged"),this.recordState(),B.info("rhythmActions",`Removed modulation marker ${s}`,null,"state")},setModulationRatio(s,n){if(!Object.values(bs).includes(n)){B.error("rhythmActions",`Invalid modulation ratio: ${n}`,null,"state");return}const i=this.state.modulationMarkers.find(a=>a.id===s);if(!i){B.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}i.ratio=n,this.emit("modulationMarkersChanged"),this.recordState(),B.info("rhythmActions",`Updated modulation marker ${s} ratio to ${n}`,null,"state")},moveModulationMarker(s,n){const i=this.state.modulationMarkers.find(a=>a.id===s);if(!i){B.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}i.measureIndex=n,this.state.modulationMarkers.sort((a,r)=>a.measureIndex-r.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),B.info("rhythmActions",`Moved modulation marker ${s} to measure ${n}`,null,"state")},toggleModulationMarker(s){const n=this.state.modulationMarkers.find(i=>i.id===s);if(!n){B.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}n.active=!n.active,this.emit("modulationMarkersChanged"),this.recordState(),B.info("rhythmActions",`Toggled modulation marker ${s} active state to ${n.active}`,null,"state")},clearModulationMarkers(){const s=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),B.info("rhythmActions",`Cleared ${s} modulation markers`,null,"state"),console.log("[MODULATION] All markers cleared")}},av={toggleAccidentalMode(s){if(this.state.accidentalMode.hasOwnProperty(s)){if(this.state.accidentalMode[s]=!this.state.accidentalMode[s],!this.state.accidentalMode.sharp&&!this.state.accidentalMode.flat){const n=s==="sharp"?"flat":"sharp";this.state.accidentalMode[n]=!0}this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged")}},setDegreeDisplayMode(s){this.state.degreeDisplayMode=this.state.degreeDisplayMode===s?"off":s,this.emit("layoutConfigChanged"),this.emit("degreeDisplayModeChanged",this.state.degreeDisplayMode)},setSelectedTool(s,n){if(this.state.selectedTool!==s||s==="tonicization"&&this.state.selectedToolTonicNumber!==n){const a=this.state.selectedTool;this.state.previousTool=a,this.state.selectedTool=s,s==="tonicization"&&n&&(this.state.selectedToolTonicNumber=parseInt(n,10)),this.emit("toolChanged",{newTool:s,oldTool:a})}},setSelectedNote(s,n){const i={...this.state.selectedNote};this.state.selectedNote={shape:s,color:n},this.emit("noteChanged",{newNote:this.state.selectedNote,oldNote:i})},setKeySignature(s){this.state.keySignature!==s&&(this.state.keySignature=s,this.emit("keySignatureChanged",s))},setTempo(s){this.state.tempo=s,this.emit("tempoChanged",s)},setLooping(s){this.state.isLooping=s,this.emit("loopingChanged",s)},setPlaybackState(s,n=!1){this.state.isPlaying=s,this.state.isPaused=n,this.emit("playbackStateChanged",{isPlaying:s,isPaused:n})},setGridPosition(s){const n=this.state.fullRowData.length-this.state.visualRows*2,i=Math.max(0,Math.min(s,n));this.state.gridPosition!==i&&(this.state.gridPosition=i,this.emit("layoutConfigChanged"))},shiftGridUp(){this.setGridPosition(this.state.gridPosition-1)},shiftGridDown(){this.setGridPosition(this.state.gridPosition+1)},setPrintOptions(s){this.state.printOptions={...this.state.printOptions,...s},this.emit("printOptionsChanged",this.state.printOptions)}},lv={addChord(s){},updateChord(s,n){},deleteChord(s){},setActiveChord(s){},setRegionContext(s){},rebuildAllChords(s){},setActiveChordIntervals(s){this.state.activeChordIntervals=s,this.emit("activeChordIntervalsChanged",s)},openChordCandidateMenu(s,n,i){this.state.isChordCandidateMenuOpen=!0,this.state.activeMacrobeatIndex=s,this.state.chordCandidates=n,this.state.chordCandidateMenuPosition=i,this.emit("chordCandidateMenuStateChanged")},closeChordCandidateMenu(){this.state.isChordCandidateMenuOpen=!1,this.state.activeMacrobeatIndex=null,this.emit("chordCandidateMenuStateChanged")},applyChordCandidate(s){if(this.state.activeMacrobeatIndex===null)return;const{startColumn:n,endColumn:i}=He(this.state,this.state.activeMacrobeatIndex);Ku(this.state,this.state.activeMacrobeatIndex);let a="C8";this.state.placedNotes.forEach(y=>{if(y.startColumnIndex>=n&&y.startColumnIndex<=i){const x=this.state.fullRowData[y.row].toneNote;Ci(x)<Ci(a)&&(a=x)}});const r=Bg(a),u=`${Ol(s).tonic}${r}`,d=wr(s,u).notes.map(y=>ac(y));this.state.placedNotes=this.state.placedNotes.filter(y=>y.startColumnIndex<n||y.startColumnIndex>i);const{shape:v,color:p}=this.state.selectedNote;d.forEach(y=>{const x=this.state.fullRowData.findIndex(_=>_.toneNote===y);if(x!==-1){const _={row:x,startColumnIndex:n,endColumnIndex:n,color:p,shape:v,isDrum:!1};this.addNote(_)}}),this.closeChordCandidateMenu(),this.recordState(),this.emit("notesChanged")}};B.moduleLoaded("paintActions","state");const cv={setMicPaintActive(s){this.state.paint.isMicPaintActive=s,B.debug("paintActions",`Mic Paint Active set to: ${s}`,null,"paint"),this.emit("micPaintStateChanged",s)},setDetectedPitch(s){this.state.paint.detectedPitch=s,this.emit("pitchDetected",s)},addPaintPoint(s){this.state.paint.paintHistory.push(s)},clearPaintHistory(){this.state.paint.paintHistory=[],B.debug("paintActions","Paint history cleared",null,"paint"),this.emit("paintHistoryChanged"),this.recordState()},setPaintSettings(s){Object.assign(this.state.paint.paintSettings,s),B.debug("paintActions","Paint settings updated",{settings:this.state.paint.paintSettings},"paint"),this.emit("paintSettingsChanged",this.state.paint.paintSettings),this.recordState()}};B.moduleLoaded("StampActions","stamps");function hv(){return`stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const uv={addStampPlacement(s,n,i,a="#4a90e2"){const r=n+1,l=this.state.stampPlacements.find(d=>d.row===i&&d.startColumn<=r&&d.endColumn>=n);l&&this.removeStampPlacement(l.id);const u={id:hv(),stampId:s,startColumn:n,endColumn:r,row:i,color:a,timestamp:Date.now()};return this.state.stampPlacements.push(u),this.emit("stampPlacementsChanged"),B.debug("StampActions",`Added stamp ${s} at ${n}-${r},${i}`,{stampId:s,startColumn:n,endColumn:r,row:i,placementId:u.id},"stamps"),u},removeStampPlacement(s){const n=this.state.stampPlacements.findIndex(a=>a.id===s);if(n===-1)return!1;const i=this.state.stampPlacements.splice(n,1)[0];return this.emit("stampPlacementsChanged"),B.debug("StampActions",`Removed stamp ${i.stampId} at ${i.startColumn}-${i.endColumn},${i.row}`,{placementId:s,stampId:i.stampId,startColumn:i.startColumn,endColumn:i.endColumn,row:i.row},"stamps"),!0},eraseStampsInArea(s,n,i,a){const r=[];for(const u of this.state.stampPlacements){const d=u.startColumn<=n&&u.endColumn>=s,v=u.row>=i&&u.row<=a;d&&v&&r.push(u.id)}let l=!1;return r.forEach(u=>{this.removeStampPlacement(u)&&(l=!0)}),l},getAllStampPlacements(){return[...this.state.stampPlacements]},getStampAt(s,n){return this.state.stampPlacements.find(i=>i.row===n&&s>=i.startColumn&&s<=i.endColumn)||null},clearAllStamps(){const s=this.state.stampPlacements.length>0;this.state.stampPlacements=[],s&&(this.emit("stampPlacementsChanged"),B.info("StampActions","Cleared all stamp placements",null,"stamps"))},getStampPlaybackData(){return this.state.stampPlacements.map(s=>{const n=this.state.fullRowData[s.row];return{stampId:s.stampId,column:s.startColumn,startColumn:s.startColumn,endColumn:s.endColumn,row:s.row,pitch:n==null?void 0:n.toneNote,color:s.color,placement:s}}).filter(s=>s.pitch)}};B.moduleLoaded("TripletActions","triplets");function dv(){return`triplet-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const fv={addTripletPlacement(s){this.state.tripletPlacements||(this.state.tripletPlacements=[]);const n=this.state.tripletPlacements.find(a=>a.row===s.row&&!(a.startCellIndex+a.span<=s.startCellIndex||s.startCellIndex+s.span<=a.startCellIndex));n&&this.removeTripletPlacement(n.id),this.state.stampPlacements&&this.state.stampPlacements.filter(r=>{if(r.row!==s.row)return!1;const l=Math.floor(r.startColumn/2),u=Math.floor(r.endColumn/2),d=s.startCellIndex+s.span-1;return!(u<s.startCellIndex||l>d)}).forEach(r=>this.removeStampPlacement(r.id));const i={id:dv(),...s};return this.state.tripletPlacements.push(i),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),B.debug("TripletActions",`Added triplet ${s.stampId} at cell ${s.startCellIndex}, row ${s.row}`,{stampId:s.stampId,startCellIndex:s.startCellIndex,span:s.span,row:s.row,placementId:i.id},"triplets"),i},removeTripletPlacement(s){if(!this.state.tripletPlacements)return!1;const n=this.state.tripletPlacements.findIndex(a=>a.id===s);if(n===-1)return!1;const i=this.state.tripletPlacements.splice(n,1)[0];return this.emit("tripletPlacementsChanged"),B.debug("TripletActions",`Removed triplet ${i.stampId} at cell ${i.startCellIndex}, row ${i.row}`,{placementId:s,stampId:i.stampId,startCellIndex:i.startCellIndex,span:i.span,row:i.row},"triplets"),!0},eraseTripletsInArea(s,n,i,a){if(!this.state.tripletPlacements)return!1;const r=Math.floor(s/2),l=Math.floor(n/2),u=[];for(const v of this.state.tripletPlacements)v.row>=i&&v.row<=a&&(v.startCellIndex+v.span-1<r||v.startCellIndex>l||u.push(v.id));let d=!1;return u.forEach(v=>{this.removeTripletPlacement(v)&&(d=!0)}),d},getAllTripletPlacements(){return[...this.state.tripletPlacements||[]]},getTripletAt(s,n){return this.state.tripletPlacements&&this.state.tripletPlacements.find(i=>i.row===n&&s>=i.startCellIndex&&s<i.startCellIndex+i.span)||null},clearAllTripletPlacements(){if(!this.state.tripletPlacements)return;const s=this.state.tripletPlacements.length>0;this.state.tripletPlacements=[],s&&(this.emit("tripletPlacementsChanged"),B.info("TripletActions","Cleared all triplet placements",null,"triplets"))},getTripletPlaybackData(){return this.state.tripletPlacements?this.state.tripletPlacements.map(s=>{const n=this.state.fullRowData[s.row];return{startCellIndex:s.startCellIndex,stampId:s.stampId,row:s.row,pitch:n==null?void 0:n.toneNote,color:s.color,span:s.span,placement:s}}).filter(s=>s.pitch):[]}};B.moduleLoaded("Store","general");const hc="studentNotationState";function pv(){try{const s=localStorage.getItem(hc);if(s===null)return;const n=JSON.parse(s);if(n.timbres)for(const i in n.timbres){const a=n.timbres[i];if(a.coeffs&&typeof a.coeffs=="object"){const r=Array.isArray(a.coeffs)?a.coeffs:Object.values(a.coeffs);a.coeffs=new Float32Array(r)}if(a.phases&&typeof a.phases=="object"){const r=Array.isArray(a.phases)?a.phases:Object.values(a.phases);a.phases=new Float32Array(r)}}if(n.paint){const i=Du.paint||{},a=n.paint;n.paint={...i,...a,paintSettings:{...i.paintSettings,...a.paintSettings||{}}}}return n}catch(s){B.error("Store","Could not load state from localStorage",s,"general");return}}function nd(s){try{const n=JSON.parse(JSON.stringify({placedNotes:s.placedNotes,placedChords:s.placedChords,tonicSignGroups:s.tonicSignGroups,stampPlacements:s.stampPlacements,tripletPlacements:s.tripletPlacements,timbres:s.timbres,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles,hasAnacrusis:s.hasAnacrusis,baseMicrobeatPx:s.baseMicrobeatPx,modulationMarkers:s.modulationMarkers,tempo:s.tempo,activeChordIntervals:s.activeChordIntervals,selectedNote:s.selectedNote,paint:{paintHistory:s.paint.paintHistory,paintSettings:s.paint.paintSettings}}));if(s.timbres)for(const a in s.timbres)s.timbres[a].coeffs&&n.timbres[a]&&(n.timbres[a].coeffs=Array.from(s.timbres[a].coeffs)),s.timbres[a].phases&&n.timbres[a]&&(n.timbres[a].phases=Array.from(s.timbres[a].phases));const i=JSON.stringify(n);localStorage.setItem(hc,i)}catch(n){B.error("Store","Could not save state to localStorage",n,"general")}}const iu={...Lm,...ev,...sv,...rv,...av,...lv,...cv,...uv,...fv,clearSavedState(){try{localStorage.removeItem(hc),window.location.reload()}catch(s){B.error("Store","Could not clear state from localStorage",s,"general")}}},_o={},id=pv(),mv={...Du,...id},T={state:mv,on(s,n){_o[s]||(_o[s]=[]),_o[s].push(n)},emit(s,n){_o[s]&&_o[s].forEach(i=>{try{i(n)}catch(a){B.error("Store",`Error in listener for event "${s}"`,a,"general")}})}};for(const s in iu)T[s]=iu[s].bind(T);const gv=T.recordState;T.recordState=function(...s){gv.apply(this,s),nd(this.state)};id||nd(T.state);const vv=[{pitch:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fef1f5"},{pitch:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fbf2fa"},{pitch:"B♭/A♯7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f6f3fd"},{pitch:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f1f5ff"},{pitch:"A♭/G♯7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#edf7fe"},{pitch:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#ebf8fa"},{pitch:"G♭/F♯7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#ecf8f5"},{pitch:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#eff8f0"},{pitch:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#f4f7ec"},{pitch:"E♭/D♯7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#f9f5eb"},{pitch:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#fdf3ec"},{pitch:"D♭/C♯7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fef2f0"},{pitch:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#fef1f5"},{pitch:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#f0d1ec"},{pitch:"B♭/A♯6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#e1d6f9"},{pitch:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#cfdcff"},{pitch:"A♭/G♯6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#bfe2fb"},{pitch:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#b7e6ef"},{pitch:"G♭/F♯6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#b9e8dd"},{pitch:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#c6e6cb"},{pitch:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#d8e2bd"},{pitch:"E♭/D♯6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#e9dcb7"},{pitch:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#f6d5bc"},{pitch:"D♭/C♯6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#fcd1c9"},{pitch:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#facfdb"},{pitch:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e6b2e1"},{pitch:"B♭/A♯5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#cebaf6"},{pitch:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#b0c4fe"},{pitch:"A♭/G♯5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#92cef8"},{pitch:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#7fd5e5"},{pitch:"G♭/F♯5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#84d8c8"},{pitch:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#9ed6a8"},{pitch:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#bece8f"},{pitch:"E♭/D♯5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#dbc484"},{pitch:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#f0b98d"},{pitch:"D♭/C♯5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#f9b1a5"},{pitch:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#f5afc3"},{pitch:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#db8fd4"},{pitch:"B♭/A♯4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#ba9bf2"},{pitch:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#8fa9ff"},{pitch:"A♭/G♯4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#58b8f6"},{pitch:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#16c3da"},{pitch:"G♭/F♯4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#2dc8b1"},{pitch:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#6ec482"},{pitch:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#a4ba57"},{pitch:"E♭/D♯4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#cdaa42"},{pitch:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#e89955"},{pitch:"D♭/C♯4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#f48e7d"},{pitch:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#ef8aab"},{pitch:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#be7cb8"},{pitch:"B♭/A♯3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#a286d2"},{pitch:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#7b93dd"},{pitch:"A♭/G♯3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#4c9fd6"},{pitch:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#13a9bd"},{pitch:"G♭/F♯3",toneNote:"Gb3",frequency:185,column:"A",hex:"#27ad99"},{pitch:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#5faa71"},{pitch:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#8ea14b"},{pitch:"E♭/D♯3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#b29338"},{pitch:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#ca8549"},{pitch:"D♭/C♯3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#d47a6c"},{pitch:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#cf7894"},{pitch:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#a46b9f"},{pitch:"B♭/A♯2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#8b73b6"},{pitch:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#6a7ebf"},{pitch:"A♭/G♯2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#4189b8"},{pitch:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#1092a3"},{pitch:"G♭/F♯2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#219584"},{pitch:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#519360"},{pitch:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#7a8b40"},{pitch:"E♭/D♯2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#997f30"},{pitch:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#ae723e"},{pitch:"D♭/C♯2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#b7695d"},{pitch:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#b3677f"},{pitch:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#6f466b"},{pitch:"B♭/A♯1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#5d4c7b"},{pitch:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#465482"},{pitch:"A♭/G♯1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#295c7d"},{pitch:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#06626e"},{pitch:"G♭/F♯1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#126458"},{pitch:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#34633f"},{pitch:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#515d28"},{pitch:"E♭/D♯1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#67541d"},{pitch:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#764c27"},{pitch:"D♭/C♯1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#7c453d"},{pitch:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#794455"}];let xl=null,Sl=null;const uc={setContexts({ctx:s,drumCtx:n}){xl=s,Sl=n},getPitchContext(){return xl||console.error("CanvasContextService: Pitch context requested before it was set."),xl},getDrumContext(){return Sl||console.error("CanvasContextService: Drum context requested before it was set."),Sl}},$n=Ri,zs={blend:2,cutoff:31,resonance:0,type:"lowpass"};function No(){return{coeffs:new Float32Array($n).fill(0),phases:new Float32Array($n).fill(0)}}function yv(){const s=No();return s.coeffs[0]=1,s}function bv(){const s=No();for(let n=1;n<=$n;n+=2){const i=n-1;s.coeffs[i]=1/n,s.phases[i]=n%4===1?0:Math.PI}return s}function _v(){const s=No();for(let n=1;n<=$n;n+=2){const i=n-1;s.coeffs[i]=1/(n*n);const a=n-1>>1&1;s.phases[i]=a?3*Math.PI/2:Math.PI/2}return s}function wv(){const s=No();for(let n=1;n<=$n;n++){const i=n-1;s.coeffs[i]=1/n,s.phases[i]=n&1?0:Math.PI}return s}const xv={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function pr(s){const n=No(),i=xv[s],a=Math.min($n,i.amps.length);for(let r=0;r<a;r++)n.coeffs[r]=i.amps[r]||0,n.phases[r]=i.phases[r]||0;return n}const wo={attack:.1,decay:.2,sustain:.8,release:.3},Fl={sine:{name:"sine",gain:1,adsr:wo,...yv(),filter:{...zs}},triangle:{name:"triangle",gain:.8,adsr:wo,..._v(),filter:{...zs}},square:{name:"square",gain:.4,adsr:wo,...bv(),filter:{...zs}},sawtooth:{name:"sawtooth",gain:.5,adsr:wo,...wv(),filter:{...zs}},trapezium:{name:"trapezium",gain:.5,adsr:wo,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array($n).fill(0),filter:{...zs}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...zs}},strings:{name:"strings",gain:.6,adsr:{attack:.03,decay:.4,sustain:.7,release:.5},...pr("strings"),filter:{...zs,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:.8,sustain:.1,release:1},...pr("piano"),filter:{...zs,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.8},...pr("marimba"),filter:{...zs,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...pr("woodwind"),filter:{...zs}}};B.moduleLoaded("SynthEngine");let Ws={},mr,ou,Ge={};class Sv extends rt.Synth{constructor(n){super(n),this.presetGain=new rt.Gain(n.gain||1),this.hpFilter=new rt.Filter({type:"highpass"}),this.lpFilterForBP=new rt.Filter({type:"lowpass"}),this.lpFilterSolo=new rt.Filter({type:"lowpass"}),this.hpOutput=new rt.Gain,this.bpOutput=new rt.Gain,this.lpOutput=new rt.Gain,this.hp_bp_fade=new rt.CrossFade(0),this.main_fade=new rt.CrossFade(0),this.wetDryFade=new rt.CrossFade(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.envelope),n.filter&&this._setFilter(n.filter)}_setPresetGain(n){this.presetGain&&(this.presetGain.gain.value=n)}_setFilter(n){this.wetDryFade.fade.value=n.enabled?1:0;const i=rt.Midi(n.cutoff+35).toFrequency(),a=n.resonance/100*12+.1;this.hpFilter.set({frequency:i,Q:a}),this.lpFilterForBP.set({frequency:i,Q:a}),this.lpFilterSolo.set({frequency:i,Q:a});const r=n.blend;r<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=r):(this.main_fade.fade.value=r-1,this.hp_bp_fade.fade.value=1)}}const _e={init(){ou=new rt.Limiter(-1).toDestination(),mr=new rt.Volume(-15).connect(ou);for(const s in T.state.timbres){const n=T.state.timbres[s],i=new rt.PolySynth({polyphony:8,voice:Sv,options:{oscillator:{type:"custom",partials:Array.from(n.coeffs)},envelope:n.adsr,filter:n.filter,gain:T.state.timbres[s].activePresetName?Fl[T.state.timbres[s].activePresetName].gain:.7}}).connect(mr);Ws[s]=i,B.debug("SynthEngine",`Created filtered synth for color: ${s}`,null,"audio")}T.on("timbreChanged",s=>{this.updateSynthForColor(s)}),T.on("volumeChanged",s=>this.setVolume(s)),B.info("SynthEngine","Initialized with multi-timbral support",null,"audio"),window.synthEngine=this},updateSynthForColor(s){const n=T.state.timbres[s],i=Ws[s];if(!(!i||!n)&&(B.debug("SynthEngine",`Updating timbre for color ${s}`,null,"audio"),i.set({oscillator:{partials:Array.from(n.coeffs)},envelope:n.adsr}),i.voices&&Array.isArray(i.voices))){const a=n.activePresetName?Fl[n.activePresetName]:null,r=a?a.gain:.7;i.voices.forEach(l=>{l._setFilter&&l._setFilter(n.filter),l._setPresetGain&&l._setPresetGain(r)})}},setVolume(s){mr&&(mr.volume.value=s)},async playNote(s,n,i=rt.now()){await rt.start();const a=T.state.selectedNote.color,r=Ws[a];r&&r.triggerAttackRelease(s,n,i)},triggerAttack(s,n,i=rt.now()){const a=Ws[n];a&&a.triggerAttack(s,i)},triggerRelease(s,n,i=rt.now()){const a=Ws[n];a&&a.triggerRelease(s,i)},releaseAll(){for(const s in Ws)Ws[s].releaseAll()},createWaveformAnalyzer(s){const n=Ws[s];return n?(Ge[s]||(Ge[s]=new rt.Analyser("waveform",1024),n.connect(Ge[s]),B.debug("SynthEngine",`Created waveform analyzer for color: ${s}`,null,"waveform")),Ge[s]):(B.warn("SynthEngine",`No synth found for color: ${s}`,null,"audio"),null)},getWaveformAnalyzer(s){return Ge[s]||null},getAllWaveformAnalyzers(){const s=new Map;for(const n in Ge)Ge[n]&&s.set(n,Ge[n]);return s},removeWaveformAnalyzer(s){Ge[s]&&(Ge[s].dispose(),delete Ge[s],B.debug("SynthEngine",`Removed waveform analyzer for color: ${s}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const s in Ge)Ge[s]&&Ge[s].dispose();Ge={},B.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(s){return Ws[s]||null},getAllSynths(){return{...Ws}}},Os={adsrComponent:null};class Tv{constructor(){this.elements=new Map,this.initialized=!1}init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("harmonyCanvas","harmony-analysis-canvas"),this.cacheElement("pitchPaintCanvas","pitch-paint-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("gridContainer","grid-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("harmonyContainer","harmonyAnalysisGrid"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicDropdownContainer","tonic-dropdown-container"),this.cacheElement("tonicDropdownButton","tonic-dropdown-button"),this.cacheElement("tonicDropdownLabel","tonic-dropdown-label"),this.cacheElement("tonicDropdownMenu","tonic-dropdown-menu"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(n,i){const a=document.getElementById(i);a&&this.elements.set(n,a)}get(n){return this.initialized&&this.elements.get(n)||null}getMultiple(...n){const i={};return n.forEach(a=>{i[a]=this.get(a)}),i}has(n){return this.elements.has(n)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const n=this.elements.size,i=Array.from(this.elements.values()).filter(a=>a!==null).length;return{totalCached:n,foundElements:i,missingElements:n-i}}}const jn=new Tv,Bl=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function dc(s){return Bl.find(n=>n.id===s)}B.moduleLoaded("StampPlacements","stamps");function Mv(s,n,i,a="#4a90e2"){return dc(s)?T.addStampPlacement(s,n,i,a):(B.warn("StampPlacements",`Invalid stamp ID: ${s}`,{stampId:s},"stamps"),null)}function Cv(s,n,i,a){return console.log("[STAMP ERASE] Function called with:",{eraseStartCol:s,eraseEndCol:n,eraseStartRow:i,eraseEndRow:a,totalStamps:T.state.stampPlacements.length,allStampPlacements:T.state.stampPlacements.map(r=>({id:r.id,startCol:r.startColumn,endCol:r.endColumn,row:r.row}))}),T.eraseStampsInArea(s,n,i,a)}function Av(){T.clearAllStamps()}function kv(){return T.getStampPlaybackData()}B.moduleLoaded("StampScheduler","stamps");const gr=["0","16n","8n",{"8n":1,"16n":1}];function Pv(s){const n=dc(s);if(!n)return B.warn("StampScheduler",`Unknown stamp ID: ${s}`,{stampId:s},"stamps"),[];const i=[];return n.ovals.forEach(a=>{i.push({offset:gr[a],duration:"8n",type:"oval",slot:a}),console.log(`[STAMP DEBUG] Stamp ${s} oval at slot ${a} with offset "${gr[a]}"`)}),n.diamonds.forEach(a=>{i.push({offset:gr[a],duration:"16n",type:"diamond",slot:a}),console.log(`[STAMP DEBUG] Stamp ${s} diamond at slot ${a} with offset "${gr[a]}"`)}),console.log(`[STAMP DEBUG] Total events for stamp ${s}:`,i.length,i),i}function ru(s,n,i){return[{id:n+0,span:s,hits:[0],label:`${i} [1]`},{id:n+1,span:s,hits:[1],label:`${i} [2]`},{id:n+2,span:s,hits:[2],label:`${i} [3]`},{id:n+3,span:s,hits:[0,1],label:`${i} [1 2]`},{id:n+4,span:s,hits:[1,2],label:`${i} [2 3]`},{id:n+5,span:s,hits:[0,2],label:`${i} [1 3]`},{id:n+6,span:s,hits:[0,1,2],label:`${i} [1 2 3]`}]}const ql=[...ru("eighth",1,"8th triplet"),...ru("quarter",8,"Quarter triplet")],Ev={eighth:1,quarter:2},Iv=[16.6667,50,83.3333];function Vr(s){return ql.find(n=>n.id===s)}B.moduleLoaded("TripletPlacements","triplets");function Ov(s,n,i,a="#4a90e2"){const r=Vr(s);if(!r)return B.warn("TripletPlacements",`Invalid triplet stamp ID: ${s}`,{tripletStampId:s},"triplets"),null;const l=Ev[r.span];if(!Dv(n,l,i))return B.debug("TripletPlacements",`Cannot place triplet at cell ${n}, row ${i} - collision detected`,{tripletStampId:s,startCellIndex:n,row:i,span:l},"triplets"),null;const u={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,stampId:s,startCellIndex:n,span:l,row:i,color:a,timestamp:Date.now()};return T.addTripletPlacement(u)}function Dv(s,n,i){const a=T.state;if(a.stampPlacements){for(const r of a.stampPlacements)if(r.row===i){const l=Math.floor(r.startColumn/2),u=Math.floor(r.endColumn/2);for(let d=0;d<n;d++){const v=s+d;if(v>=l&&v<=u)return!1}}}if(a.tripletPlacements){for(const r of a.tripletPlacements)if(r.row===i){const l=r.startCellIndex+r.span-1;if(!(s+n-1<r.startCellIndex||s>l))return!1}}return!0}function Rv(s,n,i,a){const r=T.state;if(!r.tripletPlacements)return!1;const l=Math.floor(s/2),u=Math.floor(n/2),d=[];for(const v of r.tripletPlacements)v.row>=i&&v.row<=a&&(v.startCellIndex+v.span-1<l||v.startCellIndex>u||d.push(v.id));return d.length>0?(d.forEach(v=>T.removeTripletPlacement(v)),B.debug("TripletPlacements",`Erased ${d.length} triplet groups`,{removedIds:d,eraseArea:{eraseStartCell:l,eraseEndCell:u,eraseStartRow:i,eraseEndRow:a}},"triplets"),!0):!1}function Nv(){const s=T.state;return s.tripletPlacements?s.tripletPlacements.map(n=>({startCellIndex:n.startCellIndex,stampId:n.stampId,row:n.row,color:n.color,span:n.span})):[]}function Lv(){T.clearAllTripletPlacements(),B.info("TripletPlacements","Cleared all triplet placements",null,"triplets")}B.moduleLoaded("TripletScheduler","triplets");function Fv(s){const n=Vr(s);if(!n)return B.warn("TripletScheduler",`Unknown triplet stamp ID: ${s}`,{tripletStampId:s},"triplets"),[];const i=[],a=n.span==="eighth"?"8t":"4t",r=a;return n.hits.forEach(l=>{let u;if(l===0)u="0";else if(l===1)u=a;else if(l===2){const d=rt.Time(a).toSeconds();u=rt.Time(d*2).toNotation()}else{const d=rt.Time(a).toSeconds();u=rt.Time(d*l).toNotation()}i.push({offset:u,duration:r,type:n.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:l}),B.debug("TripletScheduler",`Triplet stamp ${s} ${n.span} at slot ${l} with offset "${u}"`,"triplets")}),B.debug("TripletScheduler",`Total events for triplet stamp ${s}:`,i.length,"triplets"),i}T.on("modulationMarkersChanged",()=>{zv()});let Ti=null,zl=null;function Bv(s){const n=JSON.stringify({markers:s.modulationMarkers||[],baseMicrobeatPx:s.baseMicrobeatPx||s.cellWidth||40});if(Ti&&n===zl)return Ti;const i=s.baseMicrobeatPx||s.cellWidth||40;return console.log("[COORD] Creating new coordinate mapping with:",{markersCount:(s.modulationMarkers||[]).length,baseMicrobeatPx:i,options:s}),Ti=sd(s.modulationMarkers||[],i,s),zl=n,console.log("[COORD] Created mapping with segments:",Ti.segments),Ti}function Wt(s,n){let i=0;for(let d=0;d<s;d++){const v=n.columnWidths[d]||0;i+=v*n.cellWidth}if(!n.modulationMarkers||n.modulationMarkers.length===0)return i;const a=Bv(n),r=n.baseMicrobeatPx||n.cellWidth||40,l=i/r,u=a.microbeatToCanvasX(l);return console.log("[GETCOLUMNX] Modulated position calculation:",{index:s,originalX:i,baseMicrobeatPx:r,microbeatIndex:l,modulatedX:u,difference:u-i,segmentCount:a.segments.length}),u}function Ds(s,n){const i=It.getViewportInfo();return s*i.rowHeight-i.scrollOffset}function od(s){let n=(s||"").replace(/\d/g,"").trim();return n=n.replace(/b/g,"♭").replace(/#/g,"♯"),n}function Wl(s){switch(s){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[10,20],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"D♭/C♯":case"E♭/D♯":case"F":case"A":case"B":return null;default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function qv(){const{startRow:s,endRow:n}=It.getViewportInfo();return{startRow:s,endRow:n}}function zv(){Ti=null,zl=null}function au(s){if(!s)return null;const n=Mg(s);if(!n||n.num===void 0)return null;let i="";const a=n.alt,r=Math.abs(n.num);return a<0?i="♭".repeat(Math.abs(a)):a>0&&(i="♯".repeat(a)),`${i}${r}`}const rd={getDegreeForNote(s,n){var l;const{keyTonic:i}=Ju(n,s.startColumnIndex);if(!i)return null;const a=(l=n.fullRowData[s.row])==null?void 0:l.toneNote;if(!a)return null;const r=Qh(i,Or(a));return au(r)},getDegreesForNotes(s,n){return!s||s.length===0?[]:s.map(i=>{const a=Qh(n,Or(i));return au(a)})},getRomanNumeralForNotes(s,n,i){if(!s||s.length<2)return null;const[a]=vg(s);if(!a)return null;const r=Ol(a).symbol;if(!r)return null;const[l]=Ug(n,[r]);if(!l)return null;const u=Eo(l),d=u.roman;let v=u.name.replace(d,"");const p=Ol(a).tonic;return v==="6"&&(v="add6"),{roman:d,ext:v,root:p}}};function ad(s,n,i){const{cellWidth:a}=i,r=a*.25;if(!s.uuid)return 0;const l=n.filter(v=>!v.isDrum&&v.row===s.row&&v.startColumnIndex===s.startColumnIndex&&v.uuid&&v.uuid!==s.uuid);if(l.length===0)return 0;const u=[s,...l];return u.sort((v,p)=>{const y=parseInt(v.uuid.split("-")[1]),x=parseInt(p.uuid.split("-")[1]);return y-x}),u.findIndex(v=>v.uuid===s.uuid)*r}function Wv(s,n,i){const{cellHeight:a}=i,r=a*.12;if(!s.uuid)return 0;const l=n.filter(v=>!v.isDrum&&v.row===s.row&&v.startColumnIndex===s.startColumnIndex&&v.uuid&&v.uuid!==s.uuid&&v.endColumnIndex>v.startColumnIndex);if(l.length===0)return 0;const u=[s,...l];return u.sort((v,p)=>{const y=parseInt(v.uuid.split("-")[1]),x=parseInt(p.uuid.split("-")[1]);return y-x}),u.findIndex(v=>v.uuid===s.uuid)*r}function ld(s,n,i,a,r,l){const u=rd.getDegreeForNote(n,i);if(!u)return;const d=(n.shape==="oval"?l*Sm:l*Tm)*i.zoomLevel;d<Mm||(s.fillStyle="#212529",s.font=`bold ${d}px 'Atkinson Hyperlegible', sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(u,a,r))}function fc(s,n,i,a){const{cellWidth:r,cellHeight:l,zoomLevel:u}=n,d=Ds(a),v=Wt(i.startColumnIndex,n);let p;n.modulationMarkers&&n.modulationMarkers.length>0?p=Wt(i.startColumnIndex+1,n)-v:p=r;const y=ad(i,T.state.placedNotes,n),x=v+p+y,_=Math.max(Cm,p*Am);if(i.endColumnIndex>i.startColumnIndex){const g=Wt(i.endColumnIndex+1,n)+y-y,S=Wv(i,T.state.placedNotes,n),A=d+S;s.beginPath(),s.moveTo(x,A),s.lineTo(g,A),s.strokeStyle=i.color,s.lineWidth=Math.max(Pm,p*km),s.stroke()}const m=p-_/2,f=l/2-_/2;s.save(),s.beginPath(),s.ellipse(x,d,m,f,0,0,2*Math.PI),s.strokeStyle=i.color,s.lineWidth=_,s.shadowColor=i.color,s.shadowBlur=Eu,s.stroke(),s.shadowBlur=0,s.shadowColor="transparent",s.restore(),n.degreeDisplayMode!=="off"&&ld(s,i,n,x,d,l/2)}function pc(s,n,i,a){const{columnWidths:r,cellWidth:l,cellHeight:u,zoomLevel:d}=n,v=Ds(a),p=Wt(i.startColumnIndex,n);let y;n.modulationMarkers&&n.modulationMarkers.length>0?y=Wt(i.startColumnIndex+1,n)-p:y=r[i.startColumnIndex]*l;const x=ad(i,T.state.placedNotes,n),_=Math.max(.5,y*.15),m=p+y/2+x,f=y/2-_/2,b=u/2-_/2;s.save(),s.beginPath(),s.ellipse(m,v,f,b,0,0,2*Math.PI),s.strokeStyle=i.color,s.lineWidth=_,s.shadowColor=i.color,s.shadowBlur=Eu,s.stroke(),s.shadowBlur=0,s.shadowColor="transparent",s.restore(),n.degreeDisplayMode!=="off"&&ld(s,i,n,m,v,u/2)}function mc(s,n,i){const{cellWidth:a,cellHeight:r,zoomLevel:l}=n,u=Ds(i.row),d=Wt(i.columnIndex,n);let v;n.modulationMarkers&&n.modulationMarkers.length>0?v=Wt(i.columnIndex+1,n)-d:v=a;const p=v*2,y=d+p/2,x=Math.min(p,r)/2*.9*l;if(x<2||(s.beginPath(),s.arc(y,u,x,0,2*Math.PI),s.strokeStyle="#212529",s.lineWidth=2*l,s.stroke(),!i.tonicNumber))return;const _=i.tonicNumber.toString(),m=x*1.5;m<6||(s.fillStyle="#212529",s.font=`bold ${m}px 'Atkinson Hyperlegible', sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(_,y,u))}function Tl(s){let n=0;for(let i=0;i<s;i++){const a=T.state.columnWidths[i]||0;n+=a*T.state.cellWidth}return n}function Vv(s){const n=T.state.fullRowData[s];return n?n.toneNote.replace("♭","b").replace("♯","#"):"C4"}B.moduleLoaded("TransportService");let Ps,Co,te=[];function gc(){return 60/(T.state.tempo*2)}function $v(){if(!T.state.hasAnacrusis)return te[2]||0;for(let s=0;s<T.state.macrobeatBoundaryStyles.length;s++)if(T.state.macrobeatBoundaryStyles[s]==="solid"){const n=He(T.state,s+1);if(n)return te[n.startColumn]||0}return te[2]||0}function Vl(){var r;B.debug("transportService","calculateTimeMap",{tempo:`${T.state.tempo} BPM`}),te=[];const s=gc(),{columnWidths:n,modulationMarkers:i}=T.state,a=Us(T.state);console.log("[TIMEMAP] Using regular timing for consistent playhead speed"),i&&i.length>0&&console.log("[TIMEMAP] Modulation markers present:",i.length,"markers found - will affect note triggers only"),jv(s,n,a),B.timing("transportService","calculateTimeMap",{totalDuration:`${(r=te[te.length-1])==null?void 0:r.toFixed(2)}s`})}function jv(s,n,i){let a=0;for(let r=0;r<n.length;r++)te[r]=a,i.some(u=>u.columnIndex===r)||(a+=n[r]*s);te.push(a)}function Gv(s,n,i){let a=0;for(let r=0;r<s;r++){const l=n[r]||0;a+=l*i}return a}function lu(s){var d;const{modulationMarkers:n}=T.state;if(!n||n.length===0)return te[s];const i=gc(),a=T.state.baseMicrobeatPx||T.state.cellWidth||40,r=sd(n,a,T.state),l=Gv(s,T.state.columnWidths,a),u=ov(l,r,i);return console.log(`[MODULATED-TRIGGER] Column ${s}: x=${l.toFixed(1)}px → modulatedTime=${u.toFixed(4)}s vs regularTime=${(d=te[s])==null?void 0:d.toFixed(4)}s`),u}function Hv(s){const n=T.state.fullRowData;return n&&n[s.row]?n[s.row].toneNote.replace("♭","b").replace("♯","#"):"C4"}function Ml(){var r;B.debug("transportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),rt.Transport.cancel(),Vl(),(r=Os.adsrComponent)==null||r.playheadManager.clearAll();const s=te[2]||0,n=T.state.modulationMarkers&&T.state.modulationMarkers.length>0;T.state.placedNotes.forEach(l=>{var m;const u=te[l.startColumnIndex],d=n?lu(l.startColumnIndex):u;if(u===void 0)return;if(u<s){B.debug("transportService",`Skipping note at column ${l.startColumnIndex} (regular time ${u}) - before anacrusis offset (${s})`);return}const v=u;if(console.log(`[NOTE-SCHEDULE] ${n?"MODULATED":"REGULAR"} scheduling note ${l.uuid} at column ${l.startColumnIndex} → scheduleTime=${v.toFixed(4)}s`),n){const f=d-u;console.log(`[TIMING-COMPARISON] Note ${l.uuid}: regular=${u.toFixed(4)}s, modulated=${d.toFixed(4)}s, difference=${f>=0?"+":""}${f.toFixed(4)}s, using regular for scheduling`)}let p;const y=te[l.endColumnIndex+1],x=n?lu(l.endColumnIndex+1):y;if(y===void 0){B.warn("TransportService",`Skipping note with invalid endColumnIndex: ${l.endColumnIndex+1} (note ends at ${l.endColumnIndex})`,{noteId:l.uuid,startColumnIndex:l.startColumnIndex,endColumnIndex:l.endColumnIndex,lookupIndex:l.endColumnIndex+1,timeMapLength:te.length,maxValidIndex:te.length-1,noteShape:l.shape},"audio");return}const _=y-u;if(l.shape==="circle"){p=_;const f=gc(),b=2*f;console.log(`[DURATION] Circle note ${l.uuid}:`,{startColumn:l.startColumnIndex,endColumn:l.endColumnIndex,regularStartTime:u.toFixed(3),regularEndTime:y.toFixed(3),modulatedStartTime:n?d.toFixed(3):"N/A",modulatedEndTime:n?x.toFixed(3):"N/A",scheduleDuration:p.toFixed(3),defaultCircleDuration:b.toFixed(3),microbeatDuration:f.toFixed(3)})}else p=_,console.log(`[DURATION] Oval note ${l.uuid}:`,{startColumn:l.startColumnIndex,endColumn:l.endColumnIndex,regularStartTime:u.toFixed(3),regularEndTime:y.toFixed(3),scheduleDuration:p.toFixed(3)});if(l.isDrum)rt.Transport.schedule(f=>{var b;T.state.isPaused||(b=Co==null?void 0:Co.player(l.drumTrack))==null||b.start(f)},v);else{const f=Hv(l),b=l.color,g=((m=T.state.fullRowData[l.row])==null?void 0:m.hex)||"#888888",S=l.uuid,A=T.state.timbres[b];if(!A){B.warn("TransportService",`Timbre not found for color ${b}. Skipping note ${S}`,null,"audio");return}console.log(`[SCHEDULE] Attack for ${l.shape} note ${S} scheduled at time ${v.toFixed(3)}`),rt.Transport.schedule(O=>{var L;T.state.isPaused||(console.log(`[ATTACK] Triggering attack for ${l.shape} note ${S} at time ${O.toFixed(3)}`),_e.triggerAttack(f,b,O),(L=Os.adsrComponent)==null||L.playheadManager.trigger(S,"attack",g,A.adsr))},v);const E=v+p;console.log(`[SCHEDULE] Release for ${l.shape} note ${S} scheduled at time ${E.toFixed(3)} (duration: ${p.toFixed(3)})`),rt.Transport.schedule(O=>{var L;console.log(`[RELEASE] Triggering release for ${l.shape} note ${S} at time ${O.toFixed(3)}`),_e.triggerRelease(f,b,O),(L=Os.adsrComponent)==null||L.playheadManager.trigger(S,"release",g,A.adsr)},E)}});const i=kv();i.forEach(l=>{const u=te[l.column];if(u===void 0)return;if(u<s){B.debug("TransportService",`Skipping stamp at column ${l.column} - before anacrusis offset`);return}const d=Pv(l.stampId);d.forEach(v=>{const p=rt.Time(v.offset).toSeconds(),y=rt.Time(v.duration).toSeconds(),x=u+p,_=x+y;console.log(`[TRANSPORT DEBUG] Event: slot=${v.slot}, offset="${v.offset}" -> ${p}s, triggerTime=${x}s`),rt.Transport.schedule(m=>{T.state.isPaused||(console.log(`[TRANSPORT DEBUG] TRIGGERING: slot=${v.slot} at time=${m}s`),_e.triggerAttack(l.pitch,l.color,m))},x),rt.Transport.schedule(m=>{T.state.isPaused||_e.triggerRelease(l.pitch,l.color,m)},_)}),B.debug("TransportService",`Scheduled stamp ${l.stampId} with ${d.length} events at column ${l.column}`,{stampId:l.stampId,column:l.column,pitch:l.pitch,startTime:u,events:d.length},"audio")});const a=Nv();a.forEach(l=>{const u=l.startCellIndex*2,d=te[u];if(console.log(`[TRIPLET DEBUG] Triplet ${l.stampId} at cell ${l.startCellIndex} -> column ${u} -> time ${d}`),d===void 0)return;if(d<s){B.debug("TransportService",`Skipping triplet at cell ${l.startCellIndex} - before anacrusis offset`);return}const v=Vv(l.row),p=Fv(l.stampId);p.forEach(y=>{const x=rt.Time(y.offset).toSeconds(),_=rt.Time(y.duration).toSeconds(),m=d+x,f=m+_;rt.Transport.schedule(b=>{T.state.isPaused||(console.log(`[TRIPLET] Triggering ${y.type} for triplet ${l.stampId} slot ${y.slot} at time ${b.toFixed(3)} pitch ${v}`),_e.triggerAttack(v,l.color,b))},m),rt.Transport.schedule(b=>{T.state.isPaused||_e.triggerRelease(v,l.color,b)},f)}),B.debug("TransportService",`Scheduled triplet ${l.stampId} with ${p.length} events at cell ${l.startCellIndex}`,{stampId:l.stampId,cellIndex:l.startCellIndex,pitch:v,startTime:d,events:p.length},"audio")}),B.debug("TransportService","scheduleNotes",`Finished scheduling ${T.state.placedNotes.length} notes, ${i.length} stamps, and ${a.length} triplets`,"audio")}function Cl(){const s=jn.get("playheadCanvas");if(!s)return;const n=s.getContext("2d"),i=T.state.modulationMarkers&&T.state.modulationMarkers.length>0;console.log("[PLAYHEAD] Starting playhead animation at constant speed, modulation:",i?"ENABLED (dynamic tempo changes)":"DISABLED");const a=Tl(T.state.columnWidths.length-2),r=te[T.state.columnWidths.length-2]||0;let l=new Set;const u=T.state.tempo;let d=1;function v(){if(rt.Transport.state!=="started"||!s)return;const p=T.state.isLooping,y=rt.Transport.seconds;if(y>=r){B.info("TransportService","Playback reached end. Stopping playhead.",{currentTime:y,musicalDuration:r,isLooping:p},"transport"),ki.stop();return}if(T.state.isPaused){Ps=requestAnimationFrame(v);return}n.clearRect(0,0,s.width,s.height);let x=y;if(p){const f=rt.Transport.loopEnd-rt.Transport.loopStart;f>0&&(x=(y-rt.Transport.loopStart)%f+rt.Transport.loopStart)}let _=0;for(let f=0;f<te.length-1;f++)if(te[f]!==void 0&&x>=te[f]&&x<te[f+1]){const b=te[f],S=te[f+1]-b,A=x-b,E=Tl(f),O=Tl(f+1)-E,L=S>0?A/S:0;_=E+L*O,Math.floor(y*2)!==Math.floor((y-.016)*2)&&console.log(`[PLAYHEAD] CONSTANT-SPEED time=${y.toFixed(3)}, col=${f}, baseX=${E.toFixed(1)}, width=${O.toFixed(1)}, finalX=${_.toFixed(1)} ${i?"(modulation affects notes only)":""}`);break}const m=Math.min(_,a);if(i&&T.state.modulationMarkers)for(const f of T.state.modulationMarkers){if(!f.active)continue;const b=f.xPosition||477.5;if(m>=b&&!l.has(f.id)){l.add(f.id);let g;Math.abs(f.ratio-2/3)<.001?(g=1/f.ratio,console.log(`[TEMPO-MODULATION] 2:3 compression detected, applying 1/ratio = ${g.toFixed(3)}`)):Math.abs(f.ratio-3/2)<.001?(g=1/f.ratio,console.log(`[TEMPO-MODULATION] 3:2 expansion detected, applying 1/ratio = ${g.toFixed(3)} (slower tempo)`)):(g=1/f.ratio,console.log(`[TEMPO-MODULATION] Other ratio detected, applying 1/ratio = ${g.toFixed(3)}`)),d*=g;const S=u*d;console.log(`[TEMPO-MODULATION] Playhead crossed marker ${f.id} at x=${b}px, ratio=${f.ratio}, newMultiplier=${d.toFixed(3)}, newTempo=${S.toFixed(1)}BPM`),rt.Transport.bpm.value=S}}m>0&&(n.strokeStyle="rgba(255,0,0,0.8)",n.lineWidth=2,n.beginPath(),n.moveTo(m,0),n.lineTo(m,s.height),n.stroke()),Ps=requestAnimationFrame(v)}v()}const ki={init(){Co=new rt.Players({H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"}).toDestination(),window.transportService={drumPlayers:Co},rt.Transport.bpm.value=T.state.tempo,T.on("rhythmStructureChanged",()=>this.handleStateChange()),T.on("notesChanged",()=>this.handleStateChange()),T.on("stampPlacementsChanged",()=>this.handleStateChange()),T.on("modulationMarkersChanged",()=>this.handleStateChange()),T.on("tempoChanged",s=>{if(B.event("TransportService",`tempoChanged triggered with new value: ${s} BPM`,null,"transport"),rt.Transport.state==="started"){B.info("TransportService","Tempo changed WHILE PLAYING. Resynchronizing transport...",null,"transport");const n=rt.Transport.position;B.debug("TransportService",`Saved musical position: ${n}`,null,"transport"),rt.Transport.pause(),B.debug("TransportService","Transport paused",null,"transport"),Ps&&(cancelAnimationFrame(Ps),Ps=null),rt.Transport.bpm.value=s,B.debug("TransportService",`New BPM set to ${rt.Transport.bpm.value}`,null,"transport"),Ml(),rt.Transport.start(void 0,n),B.debug("TransportService",`Transport restarted at musical position ${n}`,null,"transport"),T.state.paint.isMicPaintActive||Cl()}else B.debug("TransportService","Tempo changed while stopped/paused. Updating BPM for next run",null,"transport"),rt.Transport.bpm.value=s,Vl()}),T.on("loopingChanged",s=>rt.Transport.loop=s),rt.Transport.on("stop",()=>{var s;B.event("TransportService","Tone.Transport 'stop' fired. Resetting playback state",null,"transport"),T.setPlaybackState(!1,!1),(s=Os.adsrComponent)==null||s.playheadManager.clearAll(),Ps&&(cancelAnimationFrame(Ps),Ps=null)}),B.info("TransportService","Initialized",null,"transport")},handleStateChange(){if(rt.Transport.state==="started"){B.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling",null,"transport");const s=rt.Transport.position;rt.Transport.pause(),Ml(),rt.Transport.start(void 0,s)}else Vl()},start(){B.info("TransportService","Starting playback",null,"transport"),(window.initAudio||(()=>rt.start()))().then(()=>{Ml();const n=te[T.state.columnWidths.length-2]||0,i=te[2]||0,a=$v();rt.Transport.loopStart=a,rt.Transport.loopEnd=n,rt.Transport.loop=T.state.isLooping,rt.Transport.bpm.value=T.state.tempo,B.debug("TransportService",`Transport configured. Loop: ${rt.Transport.loop}, BPM: ${rt.Transport.bpm.value}, StartOffset: ${i}, LoopStart: ${a}`,null,"transport"),T.state.modulationMarkers&&T.state.modulationMarkers.length>0&&console.log(`[TEMPO-MODULATION] Starting with base tempo ${T.state.tempo}BPM, ${T.state.modulationMarkers.length} modulation markers will affect tempo dynamically`),rt.Transport.start(rt.now(),i),T.state.paint.isMicPaintActive?(T.emit("playbackStateChanged",{isPlaying:!0,isPaused:!1}),B.debug("TransportService","Paint playhead is active, skipping regular playhead animation",null,"transport")):Cl()})},resume(){B.info("TransportService","Resuming playback",null,"transport"),(window.initAudio||(()=>rt.start()))().then(()=>{rt.Transport.start(),T.state.paint.isMicPaintActive||Cl()})},pause(){B.info("TransportService","Pausing playback",null,"transport"),rt.Transport.pause(),Ps&&(cancelAnimationFrame(Ps),Ps=null)},stop(){B.info("TransportService","Stopping playback and clearing visuals",null,"transport"),rt.Transport.stop(),rt.Transport.cancel(),_e.releaseAll();const s=jn.get("playheadCanvas");s&&s.getContext("2d").clearRect(0,0,s.width,s.height),T.state.paint.isMicPaintActive&&T.emit("playbackStateChanged",{isPlaying:!1,isPaused:!1})}};let vr=!1,Mi="C4",Dr=null,Vs=[];function Uv(s){const n=T.state.fullRowData[s.row];return n?n.toneNote:"C4"}function cu(){const s=T.state.placedNotes.slice().reverse().find(n=>!n.isDrum);Mi=s?Uv(s):"C4"}function hu(s){const{activeChordIntervals:n}=T.state;return!s||!n||!n.length?[]:n.map(i=>{const a=Xu(s,i);return ac(a)})}function Xv(){cu(),T.on("notesChanged",cu),document.addEventListener("keydown",s=>{var l;if(s.code!=="Space"||vr)return;const n=document.activeElement.tagName.toLowerCase();if(["input","textarea"].includes(n))return;s.preventDefault(),vr=!0;const i=T.state.selectedNote.color;let a,r=[];if(Dr&&i){const u=T.state.fullRowData[Dr.row];a=u?u.toneNote:Mi,T.state.selectedTool==="chord"?r=hu(a):r=[a]}else i&&Mi&&(a=Mi,T.state.selectedTool==="chord"?r=hu(Mi):r=[Mi]);if(r.length>0){Vs={pitches:[...r],rootNote:a,color:i},r.forEach(p=>{_e.triggerAttack(p,i)});const u=T.state.fullRowData.find(p=>p.toneNote===a),d=u?u.hex:"#888888",v=T.state.timbres[i].adsr;(l=Os.adsrComponent)==null||l.playheadManager.trigger("spacebar","attack",d,v),T.emit("spacebarPlayback",{note:a,color:i,isPlaying:!0})}}),document.addEventListener("keyup",s=>{var n;if(!(s.code!=="Space"||!vr)&&(s.preventDefault(),vr=!1,Vs.pitches&&Vs.pitches.length>0)){Vs.pitches.forEach(l=>{_e.triggerRelease(l,Vs.color)});const i=T.state.fullRowData.find(l=>l.toneNote===Vs.rootNote),a=i?i.hex:"#888888",r=T.state.timbres[Vs.color].adsr;(n=Os.adsrComponent)==null||n.playheadManager.trigger("spacebar","release",a,r),T.emit("spacebarPlayback",{note:Vs.rootNote,color:Vs.color,isPlaying:!1}),Vs=[]}})}function Yv(s,n){Dr={col:s,row:n}}function cd(){Dr=null}class Zv{constructor(){this.canvasContainer=null,this.pitchGridWrapper=null,this.drumGridWrapper=null,this.harmonyAnalysisGrid=null,this.isInitialized=!1,this.isScrolling=!1,this.lastScrollTime=0,this.pendingSync=null}init(){if(this.canvasContainer=document.getElementById("canvas-container"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),this.harmonyAnalysisGrid=document.getElementById("harmonyAnalysisGrid"),!this.canvasContainer||!this.pitchGridWrapper||!this.drumGridWrapper){console.error("ScrollSyncService: Required elements not found");return}this.setupScrollSynchronization(),this.isInitialized=!0}setupScrollSynchronization(){const n=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container")].filter(a=>a!==null),i=[...n,this.drumGridWrapper,this.harmonyAnalysisGrid].filter(a=>a!==null);n.forEach(a=>{a.addEventListener("scroll",r=>{const l=Date.now();if(l-this.lastScrollTime<10)return;if(this.lastScrollTime=l,this.isScrolling){console.log("📜 ScrollSync: Ignoring scroll event - sync in progress");return}this.isScrolling=!0;const u=r.target.scrollLeft;console.log(`📜 ScrollSync: ${r.target.id||r.target.className} scrolled to ${u}px`),this.pendingSync&&cancelAnimationFrame(this.pendingSync),this.syncAllTargets(r.target,u,i),this.isScrolling=!1})})}syncAllTargets(n,i,a){a.forEach(r=>{r!==n&&Math.abs(r.scrollLeft-i)>2&&(r.scrollLeft=i)})}syncScrollTo(n){if(!this.isInitialized)return;this.isScrolling=!0;const i=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container"),this.drumGridWrapper,this.harmonyAnalysisGrid].filter(a=>a!==null);this.syncAllTargets(null,n,i),setTimeout(()=>{this.isScrolling=!1},10)}}const Qv=new Zv;function Jv(){const s=document.getElementById("pitch-grid-wrapper");if(!s){B.error("GridScrollHandler","Scroll container #pitch-grid-wrapper not found",null,"scroll");return}let n=!1,i=0,a=0,r=0;s.addEventListener("wheel",l=>{l.preventDefault(),l.ctrlKey||l.metaKey?l.deltaY<0?T.emit("zoomIn"):T.emit("zoomOut"):It.scroll(l.deltaY)},{passive:!1}),s.addEventListener("mousedown",l=>{l.button===1&&(l.preventDefault(),n=!0,i=l.clientX,a=l.clientY,s.style.cursor="grabbing",document.body.style.userSelect="none")}),document.addEventListener("mousemove",l=>{if(n){l.preventDefault();const u=l.clientX-i,d=l.clientY-a;d!==0&&It.scrollByPixels(d,0),u!==0&&(r+=u,["pitch-grid-container","drum-grid-wrapper","harmonyAnalysisGrid","time-signature-display","canvas-macrobeat-tools"].forEach(p=>{const y=document.getElementById(p);y&&(y.style.transform=`translateX(${r}px)`)}),console.log("🔄 Horizontal transform applied:",r)),i=l.clientX,a=l.clientY}}),document.addEventListener("mouseup",l=>{l.button===1&&n&&(n=!1,s.style.cursor="",document.body.style.userSelect="")}),document.addEventListener("mouseleave",()=>{n&&(n=!1,s.style.cursor="",document.body.style.userSelect="")}),B.info("GridScrollHandler","Initialized with wheel listener for zoom and pan, and middle mouse drag",null,"scroll")}B.moduleLoaded("KeyboardHandler","keyboard");function Kv(){document.addEventListener("keydown",s=>{const n=document.activeElement.tagName.toLowerCase();if(["input","textarea"].includes(n))return;if(s.ctrlKey&&s.key.toLowerCase()==="p"){s.preventDefault(),B.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),T.emit("printPreviewStateChanged",!0);return}let i=!1;switch(s.key){case"ArrowUp":T.shiftGridUp(),i=!0;break;case"ArrowDown":T.shiftGridDown(),i=!0;break;case"ArrowLeft":B.debug("KeyboardHandler","Emitting 'zoomOut' event",null,"keyboard"),T.emit("zoomOut"),i=!0;break;case"ArrowRight":B.debug("KeyboardHandler","Emitting 'zoomIn' event",null,"keyboard"),T.emit("zoomIn"),i=!0;break}i&&s.preventDefault()}),B.info("KeyboardHandler","Initialized",null,"keyboard")}function ty(){const s=document.getElementById("anacrusis-on-btn"),n=document.getElementById("anacrusis-off-btn");!s||!n||(s.addEventListener("click",()=>T.setAnacrusis(!0)),n.addEventListener("click",()=>T.setAnacrusis(!1)),T.on("anacrusisChanged",i=>{s.classList.toggle("active",i),n.classList.toggle("active",!i)}),s.classList.toggle("active",T.state.hasAnacrusis),n.classList.toggle("active",!T.state.hasAnacrusis))}function ey(){const s=document.getElementById("settings-button"),n=document.getElementById("sidebar"),i=document.getElementById("sidebar-overlay"),a=document.getElementById("volume-icon-button"),r=document.getElementById("volume-popup"),l=document.getElementById("vertical-volume-slider"),u=()=>document.body.classList.toggle("sidebar-open");s&&n&&i&&(s.addEventListener("click",u),i.addEventListener("click",u)),a&&r&&l&&(a.addEventListener("click",d=>{d.stopPropagation();const v=r.classList.toggle("visible");a.classList.toggle("active",v)}),l.addEventListener("input",function(){const d=parseInt(this.value,10),v=d===0?-1/0:d/100*50-50;T.emit("volumeChanged",v)}),document.addEventListener("click",d=>{!r.contains(d.target)&&d.target!==a&&(r.classList.remove("visible"),a.classList.remove("active"))}),l.dispatchEvent(new Event("input"))),ty()}async function sy(s){try{const n={suggestedName:"student-notation-score.csv",types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},a=await(await window.showSaveFilePicker(n)).createWritable();await a.write(s),await a.close()}catch(n){n.name!=="AbortError"&&console.error("Error saving file with picker:",n)}}function ny(s){const n=document.createElement("a"),i=URL.createObjectURL(s);n.setAttribute("href",i),n.setAttribute("download","student-notation-export.csv"),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}function iy(){return T.state.placedNotes.map(s=>[s.row,s.startColumnIndex,s.endColumnIndex,s.color,s.shape,s.tonicNumber||"",s.isDrum,s.drumTrack||""].join(",")).join(`
`)}function oy(){var s,n,i,a;(s=document.getElementById("save-as-button"))==null||s.addEventListener("click",async()=>{const r=iy(),l=new Blob([r],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await sy(l):ny(l)}),(n=document.getElementById("import-button"))==null||n.addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.accept=".csv,.txt",r.onchange=l=>{const u=l.target.files[0];if(!u)return;const d=new FileReader;d.onload=v=>{const y=v.target.result.split(`
`).filter(x=>x.trim()).map(x=>{const _=x.split(",");return{row:parseInt(_[0]),startColumnIndex:parseInt(_[1]),endColumnIndex:parseInt(_[2]),color:_[3],shape:_[4],tonicNumber:_[5]?parseInt(_[5]):null,isDrum:_[6]==="true",drumTrack:_[7]||null}});T.loadNotes(y)},d.readAsText(u)},r.click()}),(i=document.getElementById("print-button"))==null||i.addEventListener("click",()=>{document.body.classList.remove("sidebar-open"),T.emit("printPreviewStateChanged",!0)}),(a=document.getElementById("reset-canvas-button"))==null||a.addEventListener("click",()=>{window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&T.clearSavedState()})}function hd(s){return`/Student-Notation/assets/${s}`}function uu(s){return hd(`icons/${s}`)}function ry(s){return hd(`tabicons/${s}`)}const ud={X:cs("M").intervals,x:cs("m").intervals,"x°":cs("dim").intervals,"X+":cs("aug").intervals,X7:cs("7").intervals,"x⁷":cs("m7").intervals,"ø⁷":cs("m7b5").intervals,Xadd6:cs("M6").intervals,Xsus4:cs("sus4").intervals,Xsus2:cs("sus2").intervals,Xmaj7:cs("M7").intervals,"x°7":cs("dim7").intervals};function du(){var n;const s=document.querySelector(".harmony-preset-grid");if(s&&(s.querySelectorAll(".harmony-preset-button").forEach(i=>i.classList.remove("selected")),T.state.selectedTool==="chord")){const i=T.state.activeChordIntervals.toString();for(const a of s.children)if(((n=ud[a.textContent])==null?void 0:n.toString())===i){a.classList.add("selected");break}}}function ay(){const{noteBankContainer:s,eraserButton:n,tonicDropdownContainer:i,tonicDropdownButton:a,tonicDropdownLabel:r,tonicDropdownMenu:l,degreeVisibilityToggle:u,degreeModeToggle:d,flatBtn:v,sharpBtn:p,harmonyContainerMain:y}=jn.getMultiple("noteBankContainer","eraserButton","tonicDropdownContainer","tonicDropdownButton","tonicDropdownLabel","tonicDropdownMenu","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","harmonyContainerMain"),x=document.querySelector(".harmony-preset-grid");s&&s.querySelectorAll(".note").forEach(m=>{m.addEventListener("click",()=>{T.setSelectedNote(m.dataset.type,m.closest(".note-pair").dataset.color),T.setSelectedTool("note")})}),n&&n.addEventListener("click",()=>T.setSelectedTool("eraser")),x&&x.querySelectorAll(".harmony-preset-button").forEach(m=>{m.addEventListener("click",()=>{const f=ud[m.textContent];f&&f.length>0?(T.setActiveChordIntervals(f),T.setSelectedTool("chord")):console.error(`Failed to retrieve valid intervals for symbol: "${m.textContent}"`),m.blur()}),m.addEventListener("dblclick",()=>{m.classList.contains("selected")&&T.setSelectedTool("note"),m.blur()})}),a&&l&&(a.addEventListener("click",m=>{m.stopPropagation(),i.classList.toggle("open");const f=document.querySelector(".tab-content"),b=document.getElementById("container-3"),g=i.classList.contains("open");f&&f.classList.toggle("dropdown-open",g),b&&b.classList.toggle("dropdown-open",g),a.blur()}),l.querySelectorAll(".tonic-sign-button").forEach(m=>{m.addEventListener("click",f=>{f.stopPropagation();const b=m.getAttribute("data-tonic"),g=m.querySelector(".mode-label").textContent;T.setSelectedTool("tonicization",b),r&&(r.innerHTML=`<img src="${ry(`tonicShape_${b}.svg`)}" alt="Tonic ${b}" class="tonic-shape-icon"> ${g}`),i.classList.remove("open");const S=document.querySelector(".tab-content"),A=document.getElementById("container-3");S&&S.classList.remove("dropdown-open"),A&&A.classList.remove("dropdown-open")})})),u&&u.addEventListener("click",()=>{if(T.state.degreeDisplayMode==="off"){const f=d.textContent==="Mode Degrees"?"modal":"diatonic";T.setDegreeDisplayMode(f)}else T.setDegreeDisplayMode("off");u.blur()}),d&&d.addEventListener("click",()=>{const m=T.state.degreeDisplayMode;if(m==="diatonic")T.setDegreeDisplayMode("modal");else if(m==="modal")T.setDegreeDisplayMode("diatonic");else{const f=d.textContent==="Scale Degrees"?"modal":"diatonic";T.setDegreeDisplayMode(f)}d.blur()}),v&&v.addEventListener("click",()=>{T.toggleAccidentalMode("flat"),v.blur()}),p&&p.addEventListener("click",()=>{T.toggleAccidentalMode("sharp"),p.blur()}),document.addEventListener("click",m=>{if(i&&!i.contains(m.target)){i.classList.remove("open");const f=document.querySelector(".tab-content"),b=document.getElementById("container-3");f&&f.classList.remove("dropdown-open"),b&&b.classList.remove("dropdown-open")}}),T.on("toolChanged",({newTool:m})=>{var f;if(document.querySelectorAll(".harmony-preset-button, #tonic-dropdown-button, #eraser-tool-button").forEach(b=>b.classList.remove("selected")),y&&y.classList.remove("active-tool"),m==="eraser")n==null||n.classList.add("selected");else if(m==="tonicization")a==null||a.classList.add("selected");else if(m==="chord")y==null||y.classList.add("active-tool"),du();else if(m==="note"){const b=T.state.selectedNote;if(b){const g=document.querySelector(`.note-pair[data-color='${b.color}']`);g==null||g.classList.add("selected"),(f=g==null?void 0:g.querySelector(`.note[data-type='${b.shape}']`))==null||f.classList.add("selected")}}}),T.on("activeChordIntervalsChanged",()=>{T.state.selectedTool==="chord"&&du()}),T.on("noteChanged",({newNote:m})=>{var g;document.querySelectorAll(".note, .note-pair").forEach(S=>S.classList.remove("selected"));const f=document.querySelector(`.note-pair[data-color='${m.color}']`);f==null||f.classList.add("selected"),(g=f==null?void 0:f.querySelector(`.note[data-type='${m.shape}']`))==null||g.classList.add("selected"),y&&y.style.setProperty("--c-accent",m.color);const b=document.querySelector(".tab-sidebar");b&&b.style.setProperty("--c-accent",m.color)}),T.on("degreeDisplayModeChanged",m=>{u&&(u.textContent=m==="off"?"Hide":"Show",u.classList.toggle("active",m!=="off")),d&&(d.textContent=m==="modal"?"Mode Degrees":"Scale Degrees",d.classList.toggle("active",m!=="off"))}),T.on("accidentalModeChanged",({sharp:m,flat:f})=>{p==null||p.classList.toggle("active",m),v==null||v.classList.toggle("active",f)}),y&&T.state.selectedNote&&y.style.setProperty("--c-accent",T.state.selectedNote.color);const _=document.querySelector(".tab-sidebar");_&&T.state.selectedNote&&_.style.setProperty("--c-accent",T.state.selectedNote.color)}function ly(){const s=document.getElementById("play-button"),n=document.getElementById("stop-button"),i=document.getElementById("clear-button"),a=document.getElementById("loop-button"),r=document.getElementById("undo-button"),l=document.getElementById("redo-button");s&&s.addEventListener("click",()=>{const{isPlaying:d,isPaused:v}=T.state;d&&v?(T.setPlaybackState(!0,!1),ki.resume()):d&&!v?(T.setPlaybackState(!0,!0),ki.pause()):(T.setPlaybackState(!0,!1),ki.start()),s.blur()}),n&&n.addEventListener("click",()=>{T.setPlaybackState(!1,!1),ki.stop(),n.blur()}),i&&i.addEventListener("click",()=>{i.classList.add("flash"),setTimeout(()=>i.classList.remove("flash"),300),T.clearAllNotes(),Av(),Lv(),i.blur()}),a&&a.addEventListener("click",()=>{T.setLooping(!T.state.isLooping)}),r&&r.addEventListener("click",()=>{T.undo(),r.blur()}),l&&l.addEventListener("click",()=>{T.redo(),l.blur()}),T.on("playbackStateChanged",({isPlaying:d,isPaused:v})=>{if(s){const p=`<img src="${uu("Play.svg")}" alt="Play">`,y=`<img src="${uu("Pause.svg")}" alt="Pause">`;s.innerHTML=d&&!v?y:p}}),T.on("loopingChanged",d=>{a&&a.classList.toggle("active",d)});const u=()=>{r&&(r.disabled=T.state.historyIndex<=0),l&&(l.disabled=T.state.historyIndex>=T.state.history.length-1)};T.on("historyChanged",u),u()}class Ao{constructor(n,i={}){if(this.parent=typeof n=="string"?document.querySelector(n):n,!this.parent)throw new Error("DraggableNumber: parent element not found");const a={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"}};this.settings={...a,...i,colors:{...a.colors,...i.colors||{}}},this._em=new hy,this._value=new cy(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[r,l]=this.settings.size;this._minDimension=Math.min(r,l),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${r}px`,`height:${l}px`,"background-color: var(--c-bg)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${r}px`,`height:${l}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),dy(this.element,u=>/^-?\d*\.?\d*$/.test(u)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=fu(this._value.value,this.decimalPlaces),this._bind()}on(n,i){return this._em.on(n,i),()=>this._em.off(n,i)}emit(n,i){this._em.emit(n,i)}get value(){return this._value.value}set value(n){this._value.update(n),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(n){this._value.min=n,this._render()}get max(){return this._value.max}set max(n){this._value.max=n,this._render()}get step(){return this._value.step}set step(n){this._value.step=n,this._render()}passiveUpdate(n){this._value.update(n),this._render()}link(n){this.min=n.min,this.max=n.max,this.step=n.step,typeof n.on=="function"&&n.on("change",i=>this.passiveUpdate(i)),this.on("change",i=>{"value"in n&&(n.value=i)}),this.value=n.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-bg)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const n=parseFloat(this.element.value);!Number.isNaN(n)&&n!==this.value?this.value=n:this._render()}),this.element.addEventListener("keydown",n=>{if(n.key==="Enter"){this.element.blur();const i=parseFloat(this.element.value);Number.isNaN(i)||(this.value=i)}},!0),this.element.addEventListener("mousedown",n=>this._onMouseDown(n)),this.element.addEventListener("dragstart",n=>n.preventDefault())}_onMouseDown(n){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:n.clientY};const i=this.element.getBoundingClientRect(),a=(n.clientX-i.left)/i.width;this._changeFactor=uy(a);const r=u=>this._onMouseMove(u),l=()=>this._onMouseUp(r,l);window.addEventListener("mousemove",r),window.addEventListener("mouseup",l)}_onMouseMove(n){if(!this.clicked)return;this.hasMoved=!0;const i=n.clientY-this._start.y,r=vc(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),l=this.actual-i*r;this._value.update(l),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(n,i){this.clicked=!1,window.removeEventListener("mousemove",n),window.removeEventListener("mouseup",i),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=fu(this._value.value,this.decimalPlaces)}}class cy{constructor(n,i,a,r){this.min=Number(n),this.max=Number(i),this.step=Number(a)||1,this._value=0,this.changed=!1,this.update(r)}get value(){return this._value}update(n){const i=vc(Number(n),this.min,this.max),a=this._stepTo(i),r=this._value;this._value=a,this.changed=a!==r}_stepTo(n){if(!isFinite(this.step)||this.step<=0)return n;const i=Math.round((n-this.min)/this.step);return this.min+i*this.step}}class hy{constructor(){this._m=new Map}on(n,i){const a=this._m.get(n)||[];a.push(i),this._m.set(n,a)}off(n,i){const a=this._m.get(n);if(!a)return;const r=a.indexOf(i);r>=0&&a.splice(r,1)}emit(n,i){const a=this._m.get(n);if(a)for(const r of a.slice())r(i)}}function vc(s,n,i){return Math.max(n,Math.min(i,s))}function uy(s){return 1-vc(s,0,1)}function fu(s,n=2){return isFinite(s)?Number(s).toFixed(Math.max(0,n)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function dy(s,n){let i=s.value;s.addEventListener("input",()=>{n(s.value)?i=s.value:s.value=i})}function fy(){const s=document.getElementById("tempo-slider"),n={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0},i=new Ao("#eighth-note-tempo",{...n,value:180,min:60,max:480}),a=new Ao("#quarter-note-tempo",{...n,value:90,min:30,max:240}),r=new Ao("#dotted-quarter-tempo",{...n,value:60,min:20,max:160});function l(x){const _=Math.round(x);parseInt(s.value,10)!==_&&(s.value=_);const m=_*2,f=Math.round(_/1.5);i.value!==m&&i.passiveUpdate(m),a.value!==_&&a.passiveUpdate(_),r.value!==f&&r.passiveUpdate(f),T.state.tempo!==_&&T.setTempo(_)}s&&(s.addEventListener("input",x=>l(parseInt(x.target.value,10))),i.on("change",x=>{!isNaN(x)&&x>0&&l(x/2)}),a.on("change",x=>{!isNaN(x)&&x>0&&l(x)}),r.on("change",x=>{!isNaN(x)&&x>0&&l(x*1.5)}),s.addEventListener("mouseup",function(){this.blur()}),l(T.state.tempo));const u=document.querySelector(".preset-effects-container");document.querySelectorAll(".preset-button").forEach(x=>{const _=x.id.replace("preset-",""),m=Fl[_];m&&x.addEventListener("click",()=>{const f=T.state.selectedNote.color;f&&(T.applyPreset(f,m),setTimeout(()=>{try{p(f)}catch{}},10)),x.blur()})});const d=(x,_=20)=>{const m=parseInt(x.slice(1,3),16),f=parseInt(x.slice(3,5),16),b=parseInt(x.slice(5,7),16),g=Math.max(0,Math.floor(m*(1-_/100))),S=Math.max(0,Math.floor(f*(1-_/100))),A=Math.max(0,Math.floor(b*(1-_/100)));return`#${g.toString(16).padStart(2,"0")}${S.toString(16).padStart(2,"0")}${A.toString(16).padStart(2,"0")}`},v=(x,_=50)=>{const m=parseInt(x.slice(1,3),16),f=parseInt(x.slice(3,5),16),b=parseInt(x.slice(5,7),16),g=Math.min(255,Math.floor(m+(255-m)*(_/100))),S=Math.min(255,Math.floor(f+(255-f)*(_/100))),A=Math.min(255,Math.floor(b+(255-b)*(_/100)));return`#${g.toString(16).padStart(2,"0")}${S.toString(16).padStart(2,"0")}${A.toString(16).padStart(2,"0")}`},p=x=>{if(!x||!u)return;const _=T.state.timbres[x],m=T.state.colorPalette[x]||{primary:x,light:x},f=m.light,b=m.primary;document.querySelectorAll(".preset-button").forEach(S=>{const A=S.id.replace("preset-",""),E=_&&_.activePresetName===A;S.classList.toggle("selected",E)});const g=v(f,60);u.style.setProperty("--c-accent",b),u.style.setProperty("--c-accent-light",g),u.style.setProperty("--c-accent-hover",d(b,20))};T.on("noteChanged",({newNote:x})=>{x.color?p(x.color):(document.querySelectorAll(".preset-button").forEach(_=>_.classList.remove("selected")),u&&(u.style.setProperty("--c-accent","#4A90E2"),u.style.setProperty("--c-accent-hover","#357ABD")))}),T.on("timbreChanged",x=>{x===T.state.selectedNote.color&&p(x)});const y=T.state.selectedNote.color;y&&p(y)}function py(){const s=document.getElementById("grid-zoom-in"),n=document.getElementById("grid-zoom-out"),i=document.getElementById("macrobeat-increase"),a=document.getElementById("macrobeat-decrease");s&&s.addEventListener("click",()=>{T.emit("zoomIn"),s.blur()}),n&&n.addEventListener("click",()=>{T.emit("zoomOut"),n.blur()}),i&&i.addEventListener("click",()=>T.increaseMacrobeatCount()),a&&a.addEventListener("click",()=>T.decreaseMacrobeatCount())}function my(){document.querySelectorAll("button"),document.querySelector(".modulation-controls");const s=document.getElementById("modulation-2-3-btn"),n=document.getElementById("modulation-3-2-btn"),i=document.getElementById("modulation-clear-btn");if(!s||!n||!i){B.warn("ModulationInitializer","Modulation control buttons not found in DOM",null,"ui");return}let a=null;s.addEventListener("click",()=>{a===bs.COMPRESSION_2_3?(a=null,s.classList.remove("active"),T.setSelectedTool("note"),B.info("ModulationInitializer","2:3 modulation tool deactivated",null,"ui")):(a=bs.COMPRESSION_2_3,s.classList.add("active"),n.classList.remove("active"),T.setSelectedTool("modulation"),T.state.selectedModulationRatio=a,B.info("ModulationInitializer","2:3 modulation tool activated",null,"ui"))}),n.addEventListener("click",()=>{a===bs.EXPANSION_3_2?(a=null,n.classList.remove("active"),T.setSelectedTool("note"),B.info("ModulationInitializer","3:2 modulation tool deactivated",null,"ui")):(a=bs.EXPANSION_3_2,n.classList.add("active"),s.classList.remove("active"),T.setSelectedTool("modulation"),T.state.selectedModulationRatio=a,B.info("ModulationInitializer","3:2 modulation tool activated",null,"ui"))}),i.addEventListener("click",()=>{const l=(T.state.modulationMarkers||[]).length;if(l===0){B.info("ModulationInitializer","No modulation markers to clear",null,"ui");return}T.clearModulationMarkers(),B.info("ModulationInitializer",`Cleared ${l} modulation markers`,null,"ui")}),T.on("toolChanged",l=>{(l.newTool||l)!=="modulation"&&(a=null,s.classList.remove("active"),n.classList.remove("active"))}),T.on("modulationMarkersChanged",()=>{const l=(T.state.modulationMarkers||[]).length;l===0?(i.disabled=!0,i.style.opacity="0.5"):(i.disabled=!1,i.style.opacity="1"),i.textContent=l>0?`Clear (${l})`:"Clear"});const r=(T.state.modulationMarkers||[]).length;r===0&&(i.disabled=!0,i.style.opacity="0.5"),i.textContent=r>0?`Clear (${r})`:"Clear",B.info("ModulationInitializer","Modulation controls initialized",null,"ui")}B.moduleLoaded("ToolbarComponent","toolbar");const gy={init(){ey(),oy(),ay(),ly(),fy(),py(),my(),B.info("ToolbarComponent","All controls initialized",null,"toolbar")}};function dd(s,n){return n.some(i=>i.columnIndex===s)}function vy(s,n){return n.some(i=>s===i.columnIndex||s===i.columnIndex+1)}function $l(s,n){const i=Us(n);return!vy(s,i)}function fd(s,n){for(const a of n)if(s===a.columnIndex+1)return console.log(`[TonicColumnUtils] Suppressing vertical line at column ${s} (middle of tonic at ${a.columnIndex})`),!1;return n.some(a=>s===a.columnIndex+2)&&console.log(`[TonicColumnUtils] Allowing vertical line at column ${s} (right border of tonic)`),!0}function yy(s,n,i,a){const r=Wt(2,n),l=Wt(n.columnWidths.length-2,n);for(let u=i;u<=a;u++){const d=n.fullRowData[u];if(!d)continue;const v=Ds(u);if(v<-10||v>n.viewportHeight+10)continue;const p=od(d.pitch),y=Wl(p);y&&(y.color==="#dee2e6"?(s.fillStyle=y.color,s.fillRect(r,v-n.cellHeight/2,l-r,n.cellHeight)):(s.beginPath(),s.moveTo(r,v),s.lineTo(l,v),s.lineWidth=y.lineWidth,s.strokeStyle=y.color,s.setLineDash(y.dash),s.stroke(),s.setLineDash([])))}}function by(s,n,i,a){yy(s,n,i,a)}function _y(s,n){wy(s,n)}function wy(s,n){const{columnWidths:i,macrobeatGroupings:a,macrobeatBoundaryStyles:r,placedTonicSigns:l}=n,u=i.length;let d=[],v=2;for(let p=0;p<a.length;p++){for(;l.some(y=>y.columnIndex===v);)v+=2;v+=a[p],d.push(v)}for(let p=0;p<=u;p++){const y=Wt(p,n);let x;const _=p===2||p===u-2,m=dd(p,l),f=l.some(S=>p===S.columnIndex+2),b=d.includes(p);if(fd(p,l)){if(_||m||f)x={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(b){const S=d.indexOf(p);if(S!==-1){const A=r[S];if(A==="anacrusis")continue;x={lineWidth:1,strokeStyle:"#adb5bd",dash:A==="solid"?[]:[5,5]}}else continue}else continue;s.beginPath(),s.moveTo(y,0),s.lineTo(y,s.canvas.height),s.lineWidth=x.lineWidth,s.strokeStyle=x.strokeStyle,s.setLineDash(x.dash),s.stroke()}}s.setLineDash([])}function pu(s,n,i,a,r){r&&(s.beginPath(),s.moveTo(n,i),s.lineTo(n+a,i),s.lineWidth=r.lineWidth,s.strokeStyle=r.color,s.setLineDash(r.dash),s.stroke(),s.setLineDash([]))}function xy(s,n){const{fullRowData:i,columnWidths:a,cellWidth:r,cellHeight:l,colorMode:u}=n,{sharp:d,flat:v}=T.state.accidentalMode,p=x=>{if(!x.includes("/"))return x;const _=x.slice(-1),m=x.substring(0,x.length-1),[f,b]=m.split("/");return d&&v?`${f}/${b}${_}`:d?`${b}${_}`:v?`${f}${_}`:`${b}${_}`};function y(x,_){const m=Wt(x,n),f=a.slice(x,x+2).map(g=>g*r);let b=m;_.forEach((g,S)=>{const A=f[S];i.forEach((E,O)=>{if(!E.isDummy&&E.column===g){const L=Ds(O);s.fillStyle=u==="bw"?"#ffffff":E.hex||"#ffffff",s.fillRect(b,L-l/2,A,l);const F=od(E.pitch),U=L-l/2;F==="B"&&pu(s,b,U,A,Wl("C")),F==="E♭/D♯"&&pu(s,b,U,A,Wl("E"));const X=p(E.pitch),Q=X.length<=3,ct=Math.max(10,Math.min(r*1.2,l*1.2)),gt=Q?ct:ct*.7;s.font=`bold ${gt}px 'Atkinson Hyperlegible', sans-serif`,s.textAlign="center",s.textBaseline="middle";const _t=b+A/2,wt=L;s.strokeStyle="#212529",s.lineWidth=2.5,s.lineJoin="round",s.strokeText(X,_t,wt),s.fillStyle="#ffffff",s.fillText(X,_t,wt)}}),b+=A})}y(0,["B","A"]),y(a.length-2,["A","B"])}function mu(s,n,i,a){const r=Math.sqrt(3)/2*i,l=Math.max(1,a-2*r),u=n-(l/2+r),d=u+r,v=d+l,p=v+r,y=s-i/2,x=s+i/2;return`M ${[`${s},${u}`,`${y},${d}`,`${y},${v}`,`${s},${p}`,`${x},${v}`,`${x},${d}`].join(" ")} Z`.replace(/,/g," ")}class Sy{constructor(n={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...n}}renderToCanvas(n,i,a,r,l,u,d="#000"){const v=Math.min(l/100,u/100)*.8,p=this.options.diamondW*v,y=this.options.diamondH*v,x=this.options.ovalRx*v,_=this.options.ovalRy*v,m=[.125,.375,.625,.875].map(b=>a+b*l),f=r+u/2;n.save(),n.strokeStyle=d,n.fillStyle=d,n.lineWidth=this.options.strokeWidth,n.lineCap="round",n.lineJoin="round",i.ovals.forEach(b=>{const g=b===0?a+.25*l:a+.75*l;n.beginPath(),n.ellipse(g,f,x,_,0,0,Math.PI*2),n.stroke()}),i.diamonds.forEach(b=>{const g=m[b],S=mu(g,f,p,y),A=new Path2D(S);n.stroke(A)}),n.restore()}renderToSVG(n,i=100,a=100){const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox",`0 0 ${i} ${a}`),r.style.color="#000000";const l=Math.min(i/100,a/100)*.8,u=this.options.diamondW*l,d=this.options.diamondH*l,v=this.options.ovalRx*l,p=this.options.ovalRy*l,y=[12.5,37.5,62.5,87.5],x=a/2;return n.ovals.forEach(_=>{const m=_===0?25:75,f=document.createElementNS("http://www.w3.org/2000/svg","ellipse");f.setAttribute("cx",m),f.setAttribute("cy",x),f.setAttribute("rx",v),f.setAttribute("ry",p),f.setAttribute("fill","none"),f.setAttribute("stroke","currentColor"),f.setAttribute("stroke-width",this.options.strokeWidth*2),f.setAttribute("stroke-linecap","round"),r.appendChild(f)}),n.diamonds.forEach(_=>{const m=y[_],f=mu(m,x,u,d),b=document.createElementNS("http://www.w3.org/2000/svg","path");b.setAttribute("d",f),b.setAttribute("fill","none"),b.setAttribute("stroke","currentColor"),b.setAttribute("stroke-width",this.options.strokeWidth*2),b.setAttribute("stroke-linejoin","round"),b.setAttribute("stroke-linecap","round"),r.appendChild(b)}),r}}const yc=new Sy;B.moduleLoaded("StampRenderer","stamps");function Ty(s,n){const i=T.getAllStampPlacements();i.length!==0&&(B.debug("StampRenderer",`Rendering ${i.length} stamps`,{count:i.length},"stamps"),i.forEach(a=>{My(s,a,n)}))}function My(s,n,i){const a=dc(n.stampId);if(!a)return;const{startColumn:r,endColumn:l,row:u,color:d}=n,v=Wt(r,i),y=Ds(u)-i.cellHeight/2,x=i.cellWidth*2,_=i.cellHeight;v+x<0||v>s.canvas.width||(yc.renderToCanvas(s,a,v,y,x,_,d),s.save(),s.globalAlpha=.1,s.fillStyle=d,s.fillRect(v+1,y+1,x-2,_-2),s.restore(),B.debug("StampRenderer",`Rendered stamp ${a.id} at ${r}-${l},${u}`,{stampId:a.id,startColumn:r,endColumn:l,row:u,stampX:v,stampY:y},"stamps"))}function Cy(s,n,i,a,r){if(!a)return;const l=Wt(n,r),d=Ds(i)-r.cellHeight/2,v=r.cellWidth*2,p=r.cellHeight;s.save(),s.globalAlpha=.6,yc.renderToCanvas(s,a,l,d,v,p,r.previewColor||"#4a90e2"),s.restore()}function Ay({kind:s,cx:n,cy:i,stroke:a="currentColor",strokeWidth:r=4,scale:l=1}){const u=20*l,d=60*l,v=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return v.setAttribute("cx",n),v.setAttribute("cy",i),v.setAttribute("fill","none"),v.setAttribute("stroke",a),v.setAttribute("stroke-width",r),v.setAttribute("stroke-linecap","round"),s==="circleWide"?(v.setAttribute("rx",u*2),v.setAttribute("ry",d)):(v.setAttribute("rx",u),v.setAttribute("ry",d)),v}function ky(s,n=48,i=48){const a=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=s.span==="quarter",l=r?200:100;a.setAttribute("viewBox",`0 0 ${l} 100`),a.setAttribute("width",n),a.setAttribute("height",i),a.setAttribute("aria-label",s.label),a.style.color="#000000";const u=50,d=s.span==="eighth"?"ovalWide":"circleWide";let v;return r?v=[33.33,100,166.67]:v=[16.67,50,83.33],s.hits.forEach(p=>{const y=Ay({kind:d,cx:v[p],cy:u,stroke:"currentColor",strokeWidth:3,scale:.8});a.appendChild(y)}),a}B.moduleLoaded("TripletRenderer","triplets");function Py(s,n){const i=T.getAllTripletPlacements();i.length!==0&&(B.debug("TripletRenderer",`Rendering ${i.length} triplet groups`,{count:i.length},"triplets"),i.forEach(a=>{Ey(s,a,n)}))}function Ey(s,n,i){const a=Vr(n.stampId);if(!a)return;const{startCellIndex:r,span:l,row:u,color:d}=n,v=r*2,p=Wt(v,i),y=Ds(u),x=y-i.cellHeight/2,_=i.cellWidth*2*l,m=i.cellHeight;p+_<0||p>s.canvas.width||(pd(s,a,p,y,_,m,d),s.save(),s.globalAlpha=.1,s.fillStyle=d,s.fillRect(p+1,x+1,_-2,m-2),s.restore())}function pd(s,n,i,a,r,l,u){const d=n.span==="eighth"?"ovalWide":"circleWide",v=Math.min(r/100,l/100)*.8,p=Math.max(1,3*v);n.hits.forEach(y=>{const x=Iv[y],_=i+r*x/100;Iy(s,d,_,a,u,p,v)})}function Iy(s,n,i,a,r="currentColor",l=4,u=1){const d=20*u,v=60*u;if(s.strokeStyle=r,s.lineWidth=l,s.fillStyle="none",s.beginPath(),n==="circleWide"){const p=d*2,y=v;s.ellipse(i,a,p,y,0,0,2*Math.PI)}else{const p=d,y=v;s.ellipse(i,a,p,y,0,0,2*Math.PI)}s.stroke()}function Oy(s,n,i,a,r){if(!a)return;const l=n*2,u=a.span==="eighth"?1:2,d=Wt(l,r),v=Ds(i),p=r.cellWidth*2*u,y=r.cellHeight;s.save(),s.globalAlpha=.6;const x=r.previewColor||"#4a90e2";pd(s,a,d,v,p,y,x),s.restore()}function Dy(s,n){const i=n.cellWidth||40;if(s===0)return 2*i;const a=s-1,r=He(n,a);return r?(r.endColumn+1)*i:(console.warn("[MODULATION] Could not find measure info for index:",s),s*200)}function bc(s,n){const{modulationMarkers:i}=n;if(!i||i.length===0)return;const a=i.filter(r=>r.active).map(r=>{let l;if(r.columnIndex!==null&&r.columnIndex!==void 0)l=Wt(r.columnIndex+1,n);else if(r.macrobeatIndex!==null&&r.macrobeatIndex!==void 0){const u=He(n,r.macrobeatIndex);u?l=Wt(u.endColumn+1,n):(console.warn(`[GRIDLINE-ALIGN] Could not find macrobeat info for index ${r.macrobeatIndex}`),l=r.xPosition||0)}else r.measureIndex!==null&&r.measureIndex!==void 0?l=Dy(r.measureIndex,n):l=r.xPosition||0;return{...r,xCanvas:l}});s.save(),a.forEach(r=>{Ry(s,r)}),s.restore()}function Ry(s,n,i){const a=n.xCanvas,r=n.ratio,l=ed(r),u=td(r);Ny(s,a,l),Ly(s,a,u,l)}function Ny(s,n,i,a){const l=s.canvas.height;s.beginPath(),s.moveTo(n,0),s.lineTo(n,l),s.lineWidth=3,s.strokeStyle=i,s.setLineDash([]),s.stroke()}function Ly(s,n,i,a,r){const u="Arial, sans-serif";s.font=`14px ${u}`,s.textAlign="center",s.textBaseline="middle";const x=s.measureText(i).width,_=14,m=x+6*2,f=_+6*2,b=n-m/2,g=20;Fy(s,b,g,m,f,8,a),s.fillStyle="white",s.fillText(i,n,g+f/2)}function Fy(s,n,i,a,r,l,u){s.beginPath(),s.moveTo(n+l,i),s.lineTo(n+a-l,i),s.quadraticCurveTo(n+a,i,n+a,i+l),s.lineTo(n+a,i+r-l),s.quadraticCurveTo(n+a,i+r,n+a-l,i+r),s.lineTo(n+l,i+r),s.quadraticCurveTo(n,i+r,n,i+r-l),s.lineTo(n,i+l),s.quadraticCurveTo(n,i,n+l,i),s.closePath(),s.fillStyle=u,s.fill(),s.strokeStyle="rgba(0, 0, 0, 0.2)",s.lineWidth=1,s.stroke()}function md(s,n){const i={...n,...T.state};i.modulationMarkers&&i.modulationMarkers.length>0,s.clearRect(0,0,s.canvas.width,s.canvas.height);const{startRow:a,endRow:r}=qv();xy(s,i),by(s,i,a,r),_y(s,i);const l=n.placedNotes.filter(d=>!d.isDrum&&d.row>=a&&d.row<=r),u=n.placedTonicSigns.filter(d=>d.row>=a&&d.row<=r);l.forEach(d=>{d.shape==="oval"?pc(s,i,d,d.row):d.shape==="circle"&&fc(s,i,d,d.row)}),u.forEach(d=>{mc(s,i,d)}),Ty(s,i),Py(s,i),bc(s,i)}const gd={getTimeSignatureSegments(){const s=[];let n=T.state.hasAnacrusis,i=He(T.state,0).startColumn,a=0,r=!1;return T.state.macrobeatGroupings.forEach((l,u)=>{a+=l,l===3&&(r=!0);const d=u===T.state.macrobeatGroupings.length-1,p=T.state.macrobeatBoundaryStyles[u]==="solid";if(p||d){const y=He(T.state,u).endColumn+1,x=T.state.modulationMarkers&&T.state.modulationMarkers.length>0;let _,m;if(x){const b={...T.state,modulationMarkers:T.state.modulationMarkers,cellWidth:T.state.cellWidth,columnWidths:T.state.columnWidths,baseMicrobeatPx:T.state.cellWidth};_=Wt(i,b),m=Wt(y,b)}else _=It.getColumnX(i),m=It.getColumnX(y);const f=r?`${a}/8`:`${a/2}/4`;s.push({label:f,centerX:(_+m)/2,isAnacrusis:n}),d||(i=y,a=0,r=!1,p&&(n=!1))}}),s},getRhythmUIButtons(){const s=[],n=T.state.modulationMarkers&&T.state.modulationMarkers.length>0,i=n?{...T.state,modulationMarkers:T.state.modulationMarkers,cellWidth:T.state.cellWidth,columnWidths:T.state.columnWidths,baseMicrobeatPx:T.state.cellWidth}:null;return T.state.macrobeatGroupings.forEach((a,r)=>{const{startColumn:l,endColumn:u}=He(T.state,r),d=n?Wt(l,i):It.getColumnX(l),v=n?Wt(u+1,i):It.getColumnX(u+1),p=(d+v)/2;if(s.push({type:"grouping",content:a,x:p,y:0,index:r}),r<T.state.macrobeatGroupings.length-1){const y=T.state.macrobeatBoundaryStyles[r];let x;switch(y){case"solid":x="●";break;case"anacrusis":x="x";break;default:x="○";break}s.push({type:"boundary",content:x,x:v,y:22,index:r})}}),s}};function By(){const s=document.getElementById("beat-line-controls");if(!s)return;s.innerHTML="";const n=document.getElementById("notation-grid");if(!n)return;const i=n.getBoundingClientRect(),a=s.getBoundingClientRect(),r=i.left-a.left;gd.getRhythmUIButtons().forEach((u,d)=>{const v=document.createElement("button");v.textContent=u.content,v.className="rhythm-ui-button",v.style.position="absolute";const p=r+u.x;v.style.left=`${p}px`,v.style.top=`${u.y}px`,v.style.transform="translateX(-50%)",u.type==="grouping"?v.addEventListener("click",()=>T.toggleMacrobeatGrouping(u.index)):v.addEventListener("click",()=>T.cycleMacrobeatBoundaryStyle(u.index)),s.appendChild(v)}),console.log("[RHYTHM-UI] renderRhythmUI() complete")}const qy={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const s=this.getTimeSignatureOptions();let n='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(s).forEach(([i,a])=>{n+='<div class="dropdown-category">',n+=`<div class="dropdown-category-header">${i}</div>`,a.forEach((r,l)=>{const u=`${i}-${l}`;n+=`<div class="dropdown-option" data-groupings="${JSON.stringify(r.groupings)}" data-key="${u}">`,n+=`<span class="dropdown-label">${r.label}</span>`,n+=`<span class="dropdown-description">${r.description}</span>`,n+="</div>"}),n+="</div>"}),n+="</div>",n},getTimeSignatureLabel(s){const n=s.reduce((a,r)=>a+r,0);return s.includes(3)?`${n}/8`:`${n/2}/4`}};let Pi=null;function zy(){const s=document.getElementById("time-signature-display");if(!s)return;s.innerHTML="";const n=document.getElementById("notation-grid");if(!n)return;const i=n.getBoundingClientRect(),a=s.getBoundingClientRect(),r=i.left-a.left;gd.getTimeSignatureSegments().forEach((u,d)=>{const v=document.createElement("div");v.className="time-signature-label",u.isAnacrusis&&v.classList.add("anacrusis-label"),v.textContent=u.label,v.style.position="absolute",v.style.left=`${r+u.centerX}px`,v.style.transform="translateX(-50%)",v.addEventListener("click",p=>{p.stopPropagation(),Vy(p.target,d)}),s.appendChild(v)}),Wy()}function Wy(){if(!document.getElementById("time-signature-dropdown")){const s=qy.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",s),document.getElementById("time-signature-dropdown").addEventListener("click",jy)}}function Vy(s,n){const i=document.getElementById("time-signature-dropdown");if(!i)return;i.dataset.measureIndex=n;const a=s.getBoundingClientRect();i.style.left=`${a.left}px`,i.style.top=`${a.bottom+5}px`;const r=i.getBoundingClientRect(),l=window.innerWidth,u=window.innerHeight;a.left+r.width>l&&(i.style.left=`${l-r.width-10}px`),a.bottom+r.height>u&&(i.style.top=`${a.top-r.height-5}px`),i.classList.remove("hidden"),Pi={dropdown:i,measureIndex:n},setTimeout(()=>{document.addEventListener("click",$y,{once:!0})},0)}function $y(s){const n=document.getElementById("time-signature-dropdown");n&&!n.contains(s.target)&&(n.classList.add("hidden"),Pi=null)}function jy(s){const n=s.target.closest(".dropdown-option");if(!n)return;const i=n.dataset.groupings,a=parseInt(Pi==null?void 0:Pi.measureIndex);if(!(!i||isNaN(a)))try{const r=JSON.parse(i);T.updateTimeSignature(a,r),document.getElementById("time-signature-dropdown").classList.add("hidden"),Pi=null}catch(r){console.error("Error parsing time signature groupings:",r)}}B.moduleLoaded("PitchGridController","grid");function Gy(){const s=uc.getPitchContext();if(!s||!s.canvas){B.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const n={placedNotes:Jg(T.state),placedTonicSigns:Us(T.state),fullRowData:T.state.fullRowData,columnWidths:T.state.columnWidths,cellWidth:T.state.cellWidth,cellHeight:T.state.cellHeight,rowHeight:T.state.cellHeight*.5,macrobeatGroupings:T.state.macrobeatGroupings,macrobeatBoundaryStyles:T.state.macrobeatBoundaryStyles,colorMode:"color",degreeDisplayMode:T.state.degreeDisplayMode,zoomLevel:It.getViewportInfo().zoomLevel,viewportHeight:s.canvas.height};md(s,n)}const Sr={render(){Gy()},renderMacrobeatTools(){By(),zy()}};function Tr(s,n){return n.modulationMarkers&&n.modulationMarkers.length>0?Wt(s,n):It.getColumnX(s)}function vd(s,n,i,a,r,l){const u=i+r/2,d=a+l/2,v=Math.min(r,l)*.4;if(s.beginPath(),n===0)s.moveTo(u,d-v),s.lineTo(u-v,d+v),s.lineTo(u+v,d+v),s.closePath();else if(n===1)s.moveTo(u,d-v),s.lineTo(u+v,d),s.lineTo(u,d+v),s.lineTo(u-v,d),s.closePath();else{for(let y=0;y<5;y++){const x=2*Math.PI/5*y-Math.PI/2,_=u+v*Math.cos(x),m=d+v*Math.sin(x);y===0?s.moveTo(_,m):s.lineTo(_,m)}s.closePath()}s.fill()}function Hy(s,n){const{columnWidths:i,macrobeatGroupings:a,macrobeatBoundaryStyles:r,placedTonicSigns:l}=n,u=i.length;let d=[],v=2;for(let p=0;p<a.length;p++){for(;l.some(y=>y.columnIndex===v);)v+=2;v+=a[p],d.push(v)}for(let p=0;p<=u;p++){const y=Tr(p,n);let x;const _=p===2||p===u-2,m=dd(p,l),f=l.some(S=>p===S.columnIndex+2),b=d.includes(p);if(fd(p,l)){if(_||m||f)x={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(b){const S=d.indexOf(p);if(S!==-1){const A=r[S];if(A==="anacrusis")continue;x={lineWidth:1,strokeStyle:"#adb5bd",dash:A==="solid"?[]:[5,5]}}else continue}else continue;s.beginPath(),s.moveTo(y,0),s.lineTo(y,s.canvas.height),s.lineWidth=x.lineWidth,s.strokeStyle=x.strokeStyle,s.setLineDash(x.dash),s.stroke()}}s.setLineDash([])}function yd(s,n){const{placedNotes:i,columnWidths:a,cellWidth:r,cellHeight:l,placedTonicSigns:u}=n;s.clearRect(0,0,s.canvas.width,s.canvas.height);const d=s.canvas;d.getBoundingClientRect(),window.getComputedStyle(d);const v=Math.max(Do,Ro*l),p=a.length,y=["H","M","L"];s.font=`${Math.floor(v*.7)}px 'Atkinson Hyperlegible', sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillStyle="#6c757d";const x=Tr(1,n);y.forEach((_,m)=>{s.fillText(_,x,m*v+v/2)});for(let _=0;_<4;_++){const m=_*v;s.beginPath(),s.moveTo(0,m),s.lineTo(s.canvas.width,m),s.strokeStyle="#ced4da",s.lineWidth=1,s.stroke()}Hy(s,n);for(let _=2;_<p-2;_++){if(u.some(b=>b.columnIndex===_))continue;const m=Tr(_,n);let f;n.modulationMarkers&&n.modulationMarkers.length>0?f=Tr(_+1,n)-m:f=a[_]*r;for(let b=0;b<3;b++){const g=b*v,S=y[b],A=i.find(E=>E.isDrum&&E.drumTrack===S&&E.startColumnIndex===_);A?(s.fillStyle=A.color,vd(s,b,m,g,f,v)):(s.fillStyle="#ced4da",s.beginPath(),s.arc(m+f/2,g+v/2,2,0,Math.PI*2),s.fill())}}bc(s,n)}function Uy(){const s=uc.getDrumContext();if(!s||!s.canvas)return;const n={placedNotes:Kg(T.state),placedTonicSigns:Us(T.state),columnWidths:T.state.columnWidths,cellWidth:T.state.cellWidth,cellHeight:T.state.cellHeight,macrobeatGroupings:T.state.macrobeatGroupings,macrobeatBoundaryStyles:T.state.macrobeatBoundaryStyles,modulationMarkers:T.state.modulationMarkers,baseMicrobeatPx:T.state.cellWidth};yd(s,n)}const Xy={render(){Uy()}},rn={getColumnIndex(s){const{columnWidths:n,cellWidth:i,modulationMarkers:a}=T.state;if(i===0)return 0;if(a&&a.length>0){const l={...T.state,modulationMarkers:a,cellWidth:i,columnWidths:n,baseMicrobeatPx:i};for(let u=0;u<n.length;u++){const d=Wt(u+1,l);if(s<d)return u}}else{let l=0;for(let u=0;u<n.length;u++)if(l+=n[u]*i,s<l)return u}return n.length-1},getPitchRowIndex(s){const n=It.getViewportInfo();if(!n||n.rowHeight===0)return-1;const i=s+n.scrollOffset;return Math.floor(i/n.rowHeight)},getDrumRowIndex(s){const n=Math.max(Do,Ro*T.state.cellHeight);return n===0?-1:Math.floor(s/n)}};B.moduleLoaded("StampsToolbar","stamps");const _c={selectedStampId:1,init(){this.render(),this.bindEvents(),B.info("StampsToolbar","Stamps toolbar initialized",null,"stamps")},render(){const s=document.getElementById("stamps-toolbar-container");if(!s){B.warn("StampsToolbar","Container not found",null,"stamps");return}s.innerHTML="";const n=document.createElement("div");n.className="stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((a,r)=>{const l=document.createElement("div");l.className=`stamps-row stamps-row-${r+1}`,a.forEach(u=>{const d=Bl.find(v=>v.id===u);if(d){const v=this.createStampButton(d,u-1);l.appendChild(v)}}),n.appendChild(l)}),s.appendChild(n),this.selectStamp(this.selectedStampId)},createStampButton(s,n){const i=document.createElement("button");i.className="stamp-button",i.setAttribute("data-stamp-id",s.id),i.setAttribute("title",`${s.id}: ${s.label}`);const a=this.createStampPreview(s);return i.appendChild(a),i},createStampPreview(s){const n=yc.renderToSVG(s,100,100);return n.setAttribute("width","48"),n.setAttribute("height","48"),n},bindEvents(){const s=document.getElementById("stamps-toolbar-container");if(!s)return;s.addEventListener("click",i=>{const a=i.target.closest(".stamp-button");if(a){const r=parseInt(a.getAttribute("data-stamp-id"));this.selectStamp(r)}}),this.updateStampColors=i=>{if(!i||!s)return;const a=(p,y=50)=>{const x=parseInt(p.slice(1,3),16),_=parseInt(p.slice(3,5),16),m=parseInt(p.slice(5,7),16),f=Math.min(255,Math.floor(x+(255-x)*(y/100))),b=Math.min(255,Math.floor(_+(255-_)*(y/100))),g=Math.min(255,Math.floor(m+(255-m)*(y/100)));return`#${f.toString(16).padStart(2,"0")}${b.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}`},r=(p,y=20)=>{const x=parseInt(p.slice(1,3),16),_=parseInt(p.slice(3,5),16),m=parseInt(p.slice(5,7),16),f=Math.max(0,Math.floor(x*(1-y/100))),b=Math.max(0,Math.floor(_*(1-y/100))),g=Math.max(0,Math.floor(m*(1-y/100)));return`#${f.toString(16).padStart(2,"0")}${b.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}`},l=T.state.colorPalette[i]||{primary:i,light:i},u=a(l.light,60),d=l.primary,v=r(d,20);s.style.setProperty("--c-accent",d),s.style.setProperty("--c-accent-light",u),s.style.setProperty("--c-accent-hover",v),B.info("StampsToolbar",`Updated colors for ${i}`,{primary:d,light:u,hover:v},"stamps")},T.on("noteChanged",({newNote:i})=>{i.color&&this.updateStampColors(i.color)});const n=T.state.selectedNote;n&&n.color&&this.updateStampColors(n.color),T.on("toolChanged",({newTool:i})=>{i!=="stamp"&&this.clearSelection()}),T.on("tripletToolSelected",()=>{this.clearSelection()})},selectStamp(s){this.selectedStampId=s;const n=document.getElementById("stamps-toolbar-container");n&&n.querySelectorAll(".stamp-button").forEach(i=>{i.classList.toggle("active",parseInt(i.getAttribute("data-stamp-id"))===s)}),T.setSelectedTool("stamp"),T.emit("stampSelected",s),T.emit("stampToolSelected"),B.info("StampsToolbar",`Selected stamp ${s} and switched to stamp tool`,{stampId:s},"stamps")},clearSelection(){this.selectedStampId=null;const s=document.getElementById("stamps-toolbar-container");s&&s.querySelectorAll(".stamp-button").forEach(n=>{n.classList.remove("active")})},getSelectedStamp(){return Bl.find(s=>s.id===this.selectedStampId)}};B.moduleLoaded("TripletsToolbar","triplets");const $r={selectedTripletStampId:null,init(){this.render(),this.bindEvents(),B.info("TripletsToolbar","Triplets toolbar initialized",null,"triplets")},render(){const s=document.getElementById("triplets-toolbar-container");if(!s){B.warn("TripletsToolbar","Container not found",null,"triplets");return}s.innerHTML="";const n=document.createElement("div");n.className="triplets-main-container";const i=document.createElement("div");i.className="triplets-sections";const a=this.createSection("Eighth Triplets",ql.slice(0,7));i.appendChild(a);const r=this.createQuarterTripletsSection(ql.slice(7,14));i.appendChild(r),n.appendChild(i),s.appendChild(n)},createSection(s,n){const i=document.createElement("div");i.className="triplets-section";const a=document.createElement("div");return a.className="triplets-grid",n.forEach(r=>{const l=this.createTripletButton(r);a.appendChild(l)}),i.appendChild(a),i},createQuarterTripletsSection(s){const n=document.createElement("div");n.className="triplets-section";const i=document.createElement("div");i.className="triplets-grid triplets-quarter-row",[s[0],s[1],s[2]].forEach(r=>{const l=this.createTripletButton(r);i.appendChild(l)});const a=document.createElement("div");return a.className="triplets-grid triplets-quarter-row",[s[3],s[4],s[5],s[6]].forEach(r=>{const l=this.createTripletButton(r);a.appendChild(l)}),n.appendChild(i),n.appendChild(a),n},createTripletButton(s){const n=document.createElement("button");n.className="triplet-button",n.setAttribute("data-triplet-stamp-id",s.id),n.setAttribute("title",s.label),s.span==="quarter"&&n.classList.add("triplet-button-wide");const a=s.span==="quarter"?96:48,r=ky(s,a,48);return n.appendChild(r),n},bindEvents(){const s=document.getElementById("triplets-toolbar-container");if(!s)return;s.addEventListener("click",i=>{const a=i.target.closest(".triplet-button");if(a){const r=parseInt(a.getAttribute("data-triplet-stamp-id"));this.selectTripletStamp(r)}}),this.updateTripletColors=i=>{if(!i||!s)return;const a=(p,y=50)=>{const x=parseInt(p.slice(1,3),16),_=parseInt(p.slice(3,5),16),m=parseInt(p.slice(5,7),16),f=Math.min(255,Math.floor(x+(255-x)*(y/100))),b=Math.min(255,Math.floor(_+(255-_)*(y/100))),g=Math.min(255,Math.floor(m+(255-m)*(y/100)));return`#${f.toString(16).padStart(2,"0")}${b.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}`},r=(p,y=20)=>{const x=parseInt(p.slice(1,3),16),_=parseInt(p.slice(3,5),16),m=parseInt(p.slice(5,7),16),f=Math.max(0,Math.floor(x*(1-y/100))),b=Math.max(0,Math.floor(_*(1-y/100))),g=Math.max(0,Math.floor(m*(1-y/100)));return`#${f.toString(16).padStart(2,"0")}${b.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}`},l=T.state.colorPalette[i]||{primary:i,light:i},u=a(l.light,60),d=l.primary,v=r(d,20);s.style.setProperty("--c-accent",d),s.style.setProperty("--c-accent-light",u),s.style.setProperty("--c-accent-hover",v),B.info("TripletsToolbar",`Updated colors for ${i}`,{primary:d,light:u,hover:v},"triplets")},T.on("noteChanged",({newNote:i})=>{i.color&&this.updateTripletColors(i.color)});const n=T.state.selectedNote;n&&n.color&&this.updateTripletColors(n.color),T.on("toolChanged",({newTool:i})=>{i!=="triplet"&&this.clearSelection()}),T.on("stampToolSelected",()=>{this.clearSelection()})},selectTripletStamp(s){this.selectedTripletStampId=s;const n=document.getElementById("triplets-toolbar-container");n&&n.querySelectorAll(".triplet-button").forEach(i=>{i.classList.toggle("active",parseInt(i.getAttribute("data-triplet-stamp-id"))===s)}),T.setSelectedTool("triplet"),T.emit("tripletStampSelected",s),T.emit("tripletToolSelected"),B.info("TripletsToolbar",`Selected triplet stamp ${s} and switched to triplet tool`,{stampId:s},"triplets")},clearSelection(){this.selectedTripletStampId=null;const s=document.getElementById("triplets-toolbar-container");s&&s.querySelectorAll(".triplet-button").forEach(n=>{n.classList.remove("active")})},getSelectedTripletStamp(){return this.selectedTripletStampId?Vr(this.selectedTripletStampId):null}};let $t,Ii=!1,_s=null,qn=[],Ln=[],Io=!1,Rr=!1,Mr=null,xn=null,zn=[],Es=!1;function vs(s){const n=T.state.fullRowData[s];return n?n.toneNote:null}function Yy(s){const{macrobeatGroupings:n,columnWidths:i,macrobeatBoundaryStyles:a}=T.state;if(s<2||s>=i.length-2)return null;let r=-1;for(let v=0;v<n.length;v++){const{startColumn:p,endColumn:y}=He(T.state,v);if(s>=p&&s<=y){r=v;break}}if(r===-1)return null;let l=0;for(let v=r-1;v>=0;v--)if(a[v]==="solid"){l=v+1;break}const u=l-1;return{drawColumn:He(T.state,l).startColumn,preMacrobeatIndex:u}}function bd(s){const{activeChordIntervals:n}=T.state;return!s||!n||n.length===0?[]:n.map(i=>{const a=Xu(s,i),r=ac(a);if(r.includes("#")){const l=qg(r);if(l.includes("b"))return l}return r})}function Cr(s,n,i){if(!$t)return;const a={...T.state,zoomLevel:It.getViewportInfo().zoomLevel},r=Wt(s,a),u=Ds(n,T.state)-T.state.cellHeight/2,d=T.state.selectedTool;let v;if(T.state.modulationMarkers&&T.state.modulationMarkers.length>0?v=Wt(s+1,a)-r:v=T.state.columnWidths[s]*T.state.cellWidth,d==="eraser"||Io)T.state.modulationMarkers&&T.state.modulationMarkers.length>0?v=Wt(s+2,a)-r:v=T.state.cellWidth*2;else if(d==="note"&&T.state.selectedNote.shape==="circle")T.state.modulationMarkers&&T.state.modulationMarkers.length>0?v=Wt(s+2,a)-r:v=T.state.cellWidth*2;else if(d==="stamp")T.state.modulationMarkers&&T.state.modulationMarkers.length>0?v=Wt(s+2,a)-r:v=T.state.cellWidth*2;else if(d==="triplet"){const p=$r.getSelectedTripletStamp();if(p){const x=2*(p.span==="eighth"?1:2);T.state.modulationMarkers&&T.state.modulationMarkers.length>0?v=Wt(s+x,a)-r:v=T.state.cellWidth*x}else v=T.state.cellWidth*2}else d==="tonicization"&&(T.state.modulationMarkers&&T.state.modulationMarkers.length>0?v=Wt(s+2,a)-r:v=T.state.cellWidth*2);$t.fillStyle=i,$t.fillRect(r,u,v,T.state.cellHeight)}function Zy(s,n,i=!1){if(!$t||!T.state.selectedNote)return;const a=T.state.selectedTool,{shape:r,color:l}=T.state.selectedNote;if($t.globalAlpha=i?.2:.4,a==="tonicization"){const u={row:n,columnIndex:s,tonicNumber:T.state.selectedToolTonicNumber};mc($t,T.state,u)}else if(a==="note"){const u={row:n,startColumnIndex:s,endColumnIndex:s,color:l,shape:r,isDrum:!1},d={...T.state,zoomLevel:It.getViewportInfo().zoomLevel};r==="oval"?pc($t,d,u,n):fc($t,d,u,n)}$t.globalAlpha=1}function Qy(s){var p,y,x,_,m;const n=s.target.getBoundingClientRect(),i=s.clientX-n.left,a=s.clientY-n.top,r=document.getElementById("canvas-container").scrollLeft,l=rn.getColumnIndex(i+r),u=rn.getPitchRowIndex(a),v=(T.state.selectedTool==="note"||T.state.selectedTool==="chord")&&T.state.selectedNote.shape==="circle"?T.state.columnWidths.length-3:T.state.columnWidths.length-2;if(!(l<2||l>=v||!vs(u))){if(s.button===2){s.preventDefault(),Io=!0,Es=!1,T.state.selectedTool!=="eraser"&&(Mr=T.state.selectedTool,T.setSelectedTool("eraser")),(p=jn.get("eraserButton"))==null||p.classList.add("erasing-active"),T.eraseInPitchArea(l,u,2,!1)&&(Es=!0),T.eraseTonicSignAt(l,!1)&&(Es=!0);const f=l+2-1,b=u-1,g=u+1;console.log("[RIGHT CLICK STAMP ERASE] Attempting to erase stamps in area:",{colIndex:l,rowIndex:u,eraseStartCol:l,eraseEndCol:f,eraseStartRow:b,eraseEndRow:g}),T.eraseStampsInArea(l,f,b,g)&&(Es=!0),T.eraseTripletsInArea(l,f,b,g)&&(Es=!0),$t.clearRect(0,0,$t.canvas.width,$t.canvas.height),Cr(l,u,"rgba(220, 53, 69, 0.3)");return}if(s.button===0){const f=i+r;({...T.state});for(const g of T.state.modulationMarkers||[]);const b=T.state.selectedTool;if(b==="chord"){if(!$l(l,T.state))return;const g=vs(u);if(!g)return;const S=bd(g),{shape:A,color:E}=T.state.selectedNote;Ln=[...S],Ln.forEach(L=>{_e.triggerAttack(L,E)});const O=((y=T.state.fullRowData[u])==null?void 0:y.hex)||"#888888";(x=Os.adsrComponent)==null||x.playheadManager.trigger("chord_preview","attack",O,T.state.timbres[E].adsr),qn=[],console.log("[CHORD DEBUG] Placing chord notes:",S),S.forEach(L=>{const F=T.state.fullRowData.findIndex(U=>U.toneNote===L);if(F!==-1){const U={row:F,startColumnIndex:l,endColumnIndex:l,color:E,shape:A,isDrum:!1},X=T.addNote(U);X?(qn.push(X),console.log("[CHORD DEBUG] Added chord note:",{noteName:L,noteRow:F,addedNote:X})):console.log("[CHORD DEBUG] Skipped duplicate chord note:",{noteName:L,noteRow:F,color:E})}}),Ii=!0,console.log("[CHORD DEBUG] Enabled dragging, activeChordNotes:",qn.length);return}if(b==="tonicization"){if(xn&&zn.length>0){const g=zn.map(S=>({row:S,tonicNumber:T.state.selectedToolTonicNumber,preMacrobeatIndex:xn.preMacrobeatIndex,columnIndex:xn.drawColumn}));T.addTonicSignGroup(g),xn=null,zn=[]}return}if(b==="eraser"){console.log("[ERASER] Using eraser tool at:",{mouseX:i,mouseY:a,colIndex:l,rowIndex:u,scrollOffset:r}),Rr=!0,T.eraseInPitchArea(l,u,2,!1);const g=l+2-1,S=u-1,A=u+1;console.log("[STAMP ERASE] Eraser area:",{colIndex:l,rowIndex:u,eraseStartCol:l,eraseEndCol:g,eraseStartRow:S,eraseEndRow:A});const E=Cv(l,g,S,A);console.log("[STAMP ERASE] Removed stamps:",E);const O=Rv(l,g,S,A);console.log("[TRIPLET ERASE] Removed triplets:",O);return}if(b==="stamp"){const g=_c.getSelectedStamp();if(g){console.log("[STAMP PLACE] Placing stamp:",{stampId:g.id,mouseX:i,mouseY:a,colIndex:l,rowIndex:u,pitch:vs(u),scrollOffset:r});const{color:S}=T.state.selectedNote;Mv(g.id,l,u,S);const A=vs(u);A&&_e.playNote(A,"16n"),T.recordState()}return}if(b==="triplet"){const g=$r.getSelectedTripletStamp();if(g){console.log("[TRIPLET PLACE] Placing triplet:",{stampId:g.id,mouseX:i,mouseY:a,colIndex:l,rowIndex:u,pitch:vs(u),scrollOffset:r});const S=Math.floor(l/2),{color:A}=T.state.selectedNote;Ov(g.id,S,u,A);const E=vs(u);E&&_e.playNote(E,"8t"),T.recordState()}return}if(b==="modulation"){const g=T.state.selectedModulationRatio;if(!g){console.warn("[MODULATION] No ratio selected - click 2:3 or 3:2 button first");return}const S=wd(f);if(!S){console.warn("[MODULATION] Click must be near a measure boundary");return}console.log("[MODULATION] Placing marker at measure boundary:",{measureIndex:S.measureIndex,ratio:g,clickX:f,boundaryX:S.xPosition});const A=T.addModulationMarker(S.measureIndex,g,S.xPosition,null,S.macrobeatIndex);console.log("[MODULATION] Marker placed successfully:",{markerId:A,measureIndex:S.measureIndex,ratio:g});return}if(b==="note"){if(!$l(l,T.state))return;const{shape:g,color:S}=T.state.selectedNote,A={row:u,startColumnIndex:l,endColumnIndex:l,color:S,shape:g,isDrum:!1},E=T.addNote(A);if(!E)return;_s=E,Ii=g==="circle",Ii||T.recordState();const O=vs(u);if(O){Ln=[O],_e.triggerAttack(O,_s.color);const L=((_=T.state.fullRowData[u])==null?void 0:_.hex)||"#888888";(m=Os.adsrComponent)==null||m.playheadManager.trigger(_s.uuid,"attack",L,T.state.timbres[_s.color].adsr)}}}}}function Jy(s){const n=s.target.getBoundingClientRect(),i=s.clientX-n.left,a=s.clientY-n.top,r=document.getElementById("canvas-container").scrollLeft,l=rn.getColumnIndex(i+r),u=rn.getPitchRowIndex(a);if(!$t)return;$t.clearRect(0,0,$t.canvas.width,$t.canvas.height);const d=i+r;({...T.state});for(const y of T.state.modulationMarkers||[]);if(T.state.selectedTool==="modulation"){const y=wd(d);y&&tb($t,y.xPosition,T.state.selectedModulationRatio)}s.target;const p=(T.state.selectedTool==="note"||T.state.selectedTool==="chord")&&T.state.selectedNote.shape==="circle"?T.state.columnWidths.length-3:T.state.columnWidths.length-2;if(l<2||l>=p||vs(u)===null){xn=null,zn=[],cd();return}if(Yv(l,u),Ii&&(_s||qn.length>0)){const y=l;if(_s)y!==_s.endColumnIndex&&T.updateNoteTail(_s,y);else if(qn.length>0){const x=qn.filter(_=>y!==_.endColumnIndex);x.length>0&&T.updateMultipleNoteTails(x,y)}return}if(T.state.selectedTool==="chord"){const y=vs(u);if(y){const x=bd(y),{shape:_,color:m}=T.state.selectedNote;$t.globalAlpha=.4,x.forEach(f=>{const b=T.state.fullRowData.findIndex(g=>g.toneNote===f);if(b>-1){const g={row:b,startColumnIndex:l,endColumnIndex:l,color:m,shape:_,isDrum:!1},S={...T.state,zoomLevel:It.getViewportInfo().zoomLevel};_==="oval"?pc($t,S,g,b):fc($t,S,g,b)}}),$t.globalAlpha=1}return}if(Io){T.eraseInPitchArea(l,u,2,!1)&&(Es=!0),T.eraseTonicSignAt(l,!1)&&(Es=!0);const y=l+2-1,x=u-1,_=u+1;T.eraseStampsInArea(l,y,x,_)&&(Es=!0),T.eraseTripletsInArea(l,y,x,_)&&(Es=!0),Cr(l,u,"rgba(220, 53, 69, 0.3)");return}if(Rr){T.eraseInPitchArea(l,u,2,!1);const y=l+2-1,x=u-1,_=u+1;T.eraseStampsInArea(l,y,x,_),T.eraseTripletsInArea(l,y,x,_),Cr(l,u,"rgba(220, 53, 69, 0.3)");return}if(T.state.selectedTool==="tonicization"){const y=Yy(l);if(y){const x=vs(u);if(x){const _=T.state.fullRowData.map((m,f)=>({...m,index:f})).filter(m=>m.toneNote&&m.toneNote.replace(/\d+$/,"")===x.replace(/\d+$/,"")).map(m=>m.index);xn=y,zn=_,$t.globalAlpha=.5,_.forEach(m=>{const f={row:m,columnIndex:y.drawColumn,tonicNumber:T.state.selectedToolTonicNumber};mc($t,T.state,f)}),$t.globalAlpha=1}}else xn=null,zn=[]}else{const y=T.state.selectedTool==="note"||T.state.selectedTool==="chord"?$l(l,T.state):!0,x=T.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":y?"rgba(74, 144, 226, 0.2)":"rgba(220, 53, 69, 0.15)";if(Cr(l,u,x),T.state.selectedTool==="stamp"){const m=_c.getSelectedStamp();if(m){console.log("[STAMP HOVER] Preview at:",{mouseX:i,mouseY:a,colIndex:l,rowIndex:u,pitch:vs(u),scrollOffset:r});const f={cellWidth:T.state.cellWidth,cellHeight:T.state.cellHeight,columnWidths:T.state.columnWidths,previewColor:"#4a90e2"};Cy($t,l,u,m,f)}}else if(T.state.selectedTool==="triplet"){const m=$r.getSelectedTripletStamp();if(m){console.log("[TRIPLET HOVER] Preview at:",{mouseX:i,mouseY:a,colIndex:l,rowIndex:u,pitch:vs(u),scrollOffset:r});const f=Math.floor(l/2),b={cellWidth:T.state.cellWidth,cellHeight:T.state.cellHeight,columnWidths:T.state.columnWidths,previewColor:"#4a90e2"};Oy($t,f,u,m,b)}}else y&&Zy(l,u)}}function _d(){$t&&$t.clearRect(0,0,$t.canvas.width,$t.canvas.height),xn=null,zn=[],cd()}function Ky(){var s,n,i,a;if(Ln.length>0){const r=T.state.selectedNote.color;if(Ln.forEach(u=>{_e.triggerRelease(u,r)}),!!_s){const u=((s=T.state.fullRowData[_s.row])==null?void 0:s.hex)||"#888888";(n=Os.adsrComponent)==null||n.playheadManager.trigger(_s.uuid,"release",u,T.state.timbres[r].adsr)}else{const u=Ln[0],d=T.state.fullRowData.find(v=>v.toneNote===u);if(d){const v=d.hex;(i=Os.adsrComponent)==null||i.playheadManager.trigger("chord_preview","release",v,T.state.timbres[r].adsr)}}Ln=[]}Ii&&T.recordState(),Ii=!1,_s=null,qn=[],Rr&&(T.recordState(),Rr=!1),Io&&(Es&&T.recordState(),Io=!1,Es=!1,Mr&&(T.setSelectedTool(Mr),Mr=null),(a=jn.get("eraserButton"))==null||a.classList.remove("erasing-active")),_d()}function wd(s,n){const{macrobeatGroupings:i,macrobeatBoundaryStyles:a}=T.state;Us(T.state);const r=100,l=[],u=T.state.modulationMarkers&&T.state.modulationMarkers.length>0;console.log("[MODULATION] Boundary calculation - has modulation:",u);for(let y=0;y<a.length;y++)if(a[y]==="solid"){const x=He(T.state,y);if(x){const _=u?Wt(x.endColumn+1,{...T.state,modulationMarkers:T.state.modulationMarkers,cellWidth:T.state.cellWidth,columnWidths:T.state.columnWidths,baseMicrobeatPx:T.state.cellWidth}):It.getColumnX(x.endColumn+1);console.log(`[MODULATION] Boundary ${y}: measureInfo.endColumn=${x.endColumn}, calculatedX=${_}, method=${u?"modulated":"base"}`),l.push({measureIndex:y+1,xPosition:_,macrobeatIndex:y})}}const d=u?Wt(2,{...T.state,modulationMarkers:T.state.modulationMarkers,cellWidth:T.state.cellWidth,columnWidths:T.state.columnWidths,baseMicrobeatPx:T.state.cellWidth}):It.getColumnX(2);console.log("[MODULATION] Start boundary: calculatedX=",d,", method=",u?"modulated":"base"),l.unshift({measureIndex:0,xPosition:d,macrobeatIndex:-1}),console.log("[MODULATION] Available measure boundaries:",l),console.log("[MODULATION] Click position:",s,"tolerance:",r);let v=null,p=1/0;return l.forEach(y=>{const x=Math.abs(s-y.xPosition);console.log(`[MODULATION] Boundary at x=${y.xPosition}, distance=${x}`),x<=r&&x<p&&(p=x,v=y)}),v?console.log("[MODULATION] Found closest boundary:",v,"distance:",p):console.log("[MODULATION] No boundary within tolerance"),v}function tb(s,n,i){if(!i)return;const a=ed(i),r=td(i);s.save();const l=3,u=2,d=s.canvas.height;s.strokeStyle=a,s.lineWidth=u,s.globalAlpha=.7,s.setLineDash([]);for(let v=-1;v<=1;v++){const p=n+v*l;s.beginPath(),s.moveTo(p,0),s.lineTo(p,d),s.stroke()}s.globalAlpha=.8,s.font="12px Arial, sans-serif",s.textAlign="center",s.textBaseline="top",s.fillStyle=a,s.fillText(`Preview: ${r}`,n,10),s.restore()}function eb(){const s=document.getElementById("notation-grid"),n=document.getElementById("hover-canvas");if(!s||!n){console.error("PitchGridInteractor: Could not find required canvas elements.");return}$t=n.getContext("2d"),s.addEventListener("mousedown",Qy),s.addEventListener("mousemove",Jy),s.addEventListener("mouseleave",_d),s.addEventListener("contextmenu",i=>i.preventDefault()),window.addEventListener("mouseup",Ky)}let ge,Nr=!1,Oo=!1;function Lr(s){if(T.state.modulationMarkers&&T.state.modulationMarkers.length>0){const i={modulationMarkers:T.state.modulationMarkers,columnWidths:T.state.columnWidths,cellWidth:T.state.cellWidth,baseMicrobeatPx:T.state.baseMicrobeatPx||T.state.cellWidth||40};return Wt(s,i)}else return It.getColumnX(s)}function xd(s){if(T.state.modulationMarkers&&T.state.modulationMarkers.length>0){const i=Lr(s);return Lr(s+1)-i}else return T.state.columnWidths[s]*T.state.cellWidth}function jl(s,n,i){if(!ge)return;const a=Lr(s),r=Math.max(Do,Ro*T.state.cellHeight),l=n*r,u=xd(s);ge.fillStyle=i,ge.fillRect(a,l,u,r)}function sb(s,n){if(!ge)return;const i=Lr(s),a=Math.max(Do,Ro*T.state.cellHeight),r=n*a,l=xd(s);ge.globalAlpha=.4,ge.fillStyle=T.state.selectedTool.color||"#212529",vd(ge,n,i,r,l,a),ge.globalAlpha=1}function nb(s){const n=s.target.getBoundingClientRect(),i=s.clientX-n.left,a=s.clientY-n.top,r=document.getElementById("canvas-container").scrollLeft,l=rn.getColumnIndex(i+r),u=rn.getDrumRowIndex(a);if(!ge||l<2||l>=T.state.columnWidths.length-2||u<0||u>2){wc();return}ge.clearRect(0,0,ge.canvas.width,ge.canvas.height);const d=["H","M","L"][u];Nr?(T.eraseDrumNoteAt(l,d,!1)&&(Oo=!0),jl(l,u,"rgba(220, 53, 69, 0.3)")):(jl(l,u,"rgba(74, 144, 226, 0.2)"),sb(l,u))}function wc(){ge&&ge.clearRect(0,0,ge.canvas.width,ge.canvas.height)}function ib(s){var v;s.preventDefault();const n=s.target.getBoundingClientRect(),i=s.clientX-n.left,a=s.clientY-n.top,r=document.getElementById("canvas-container").scrollLeft,l=rn.getColumnIndex(i+r);if(l<2||l>=T.state.columnWidths.length-2)return;const u=rn.getDrumRowIndex(a);if(u<0||u>2)return;const d=["H","M","L"][u];if(s.button===2){Nr=!0,Oo=!1,(v=document.getElementById("eraser-tool-button"))==null||v.classList.add("erasing-active"),T.eraseDrumNoteAt(l,d,!1)&&(Oo=!0),ge.clearRect(0,0,ge.canvas.width,ge.canvas.height),jl(l,u,"rgba(220, 53, 69, 0.3)");return}if(s.button===0){const{color:p}=T.state.selectedTool,y={isDrum:!0,drumTrack:d,startColumnIndex:l,endColumnIndex:l,color:p||"#000000",shape:d==="H"?"triangle":d==="M"?"square":"pentagon"};T.toggleDrumNote(y),window.transportService&&window.transportService.drumPlayers&&window.transportService.drumPlayers.player(d).start()}}function ob(){var s;Nr&&(Oo&&T.recordState(),Nr=!1,Oo=!1,(s=document.getElementById("eraser-tool-button"))==null||s.classList.remove("erasing-active")),wc()}function rb(){const s=document.getElementById("drum-grid"),n=document.getElementById("drum-hover-canvas");!s||!n||(ge=n.getContext("2d"),s.addEventListener("mousedown",ib),s.addEventListener("mousemove",nb),s.addEventListener("mouseleave",wc),s.addEventListener("contextmenu",i=>i.preventDefault()),window.addEventListener("mouseup",ob))}const Al={init(){eb(),rb(),document.addEventListener("canvasResized",s=>{this.renderPitchGrid(),this.renderDrumGrid()})},renderPitchGrid:Sr.render,renderDrumGrid:Xy.render};function ab(s,n){const{columnWidths:i,macrobeatGroupings:a,macrobeatBoundaryStyles:r,cellWidth:l}=n,u=Us(n),d=i.length;let v=[],p=2;for(let x=0;x<a.length;x++){for(;u.some(_=>_.columnIndex===p);)p+=2;p+=a[x],v.push(p)}function y(x){let _=0;for(let m=0;m<x;m++){const f=i[m]||0;_+=f*l}return _}for(let x=0;x<=d;x++){const _=y(x);let m;const f=x===2||x===d-2,b=u.some(A=>A.columnIndex===x),g=u.some(A=>x===A.columnIndex+2),S=v.includes(x);if(f||b||g)m={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(S){const A=v.indexOf(x);if(A!==-1){const E=r[A];if(E==="anacrusis")continue;m={lineWidth:1,strokeStyle:"#adb5bd",dash:E==="solid"?[]:[5,5]}}else continue}else continue;s.beginPath(),s.moveTo(_,0),s.lineTo(_,s.canvas.height),s.lineWidth=m.lineWidth,s.strokeStyle=m.strokeStyle,s.setLineDash(m.dash),s.stroke()}s.setLineDash([])}function lb(s,n,i){const a=Ku(n,i),{startColumn:r,grouping:l}=He(n,i),{keyTonic:u,keyMode:d}=Ju(n,r);function v(m){let f=0;for(let b=0;b<m;b++){const g=n.columnWidths[b]||0;f+=g*n.cellWidth}return f}const p=v(r),y=l*n.cellWidth,x=p+y/2,_=rd.getRomanNumeralForNotes(a,u,d);if(_&&_.roman){const{roman:m,ext:f}=_,b=s.canvas.height/40,g=Math.max(12,Math.round(22*b)),S=Math.max(8,Math.round(14*b)),A=`bold ${g}px 'Atkinson Hyperlegible', sans-serif`,E=`bold ${S}px 'Atkinson Hyperlegible', sans-serif`;s.font=A;const O=s.measureText(m).width;s.font=E;const L=s.measureText(f).width,F=O+L,U=x-F/2,X=s.canvas.height/2;s.font=A,s.fillStyle="#212529",s.textAlign="left",s.textBaseline="middle",s.fillText(m,U,X),f&&(s.font=E,s.fillText(f,U+O,X-8))}}function cb(s,n){const{state:i}=n;s.clearRect(0,0,s.canvas.width,s.canvas.height);const a=s.canvas;a.getBoundingClientRect(),window.getComputedStyle(a),ab(s,i);for(let r=0;r<i.macrobeatGroupings.length;r++)lb(s,i,r);bc(s,i)}let Fn,Gl;function yr(){if(!Gl)return;const s=It.getModulatedCanvasWidth();Fn.width!==s&&(Fn.width=s);const n=.5*T.state.cellHeight;Fn.height!==n&&(Fn.height=n);const i={state:T.state};cb(Gl,i)}const gu={init(){if(Fn=document.getElementById("harmony-analysis-canvas"),!Fn){B.error("Harmony","Could not find harmony canvas element",null,"harmony");return}Gl=Fn.getContext("2d"),T.on("layoutConfigChanged",yr),T.on("modulationMarkersChanged",yr),yr(),B.info("Harmony","Initialized",null,"harmony")},render:yr};function on(s,n){if(!s)return`rgba(204, 204, 204, ${n})`;const i=parseInt(s.slice(Iu,zh),_r),a=parseInt(s.slice(zh,Wh),_r),r=parseInt(s.slice(Wh,Im),_r);return`rgba(${i}, ${a}, ${r}, ${n})`}function jr(s,n){if(!s||typeof s!="string")return Em;const i=parseInt(s.slice(Iu),_r),a=n<0?Om:Dm,r=n<0?n*-1:n,l=i>>16,u=i>>8&255,d=i&255;return"#"+(16777216+(Math.round((a-l)*r)+l)*65536+(Math.round((a-u)*r)+u)*256+(Math.round((a-d)*r)+d)).toString(16).slice(1)}const hb=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,ub=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,db=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,fb=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`;B.moduleLoaded("HarmonicBins with Columnar Structure");const Ar={0:hb,90:ub,180:db,270:fb},an=Ri;let Le,Fe,Be=new Float32Array(an).fill(0),Jt,Gs=new Float32Array(an).fill(0);const xc=[],Hl=[],Sd=.1;let Ei=!1,ys=null;const Si=new Array(an).fill(null);function vu(s,n){const{blend:i,cutoff:a,resonance:r}=n,l=(a-1)/30,u=4,d=l>0?s/l:s*1e6,v=s>0?l/s:l*1e6,p=1/(1+Math.pow(d,2*u)),y=1/(1+Math.pow(v,2*u)),x=p*y*4;let _;i<=1?_=y*(1-i)+x*i:_=x*(2-i)+p*(i-1);const m=1-(r||0)/105,f=Math.max(.01,.2*m*m),b=Math.exp(-Math.pow((s-l)/f,2)),g=(r||0)/100*.6;return Math.min(1,_+b*g)}function pb(s,n){const i=n/100;return 1-i+i*s}let kr=new Float32Array(an).fill(1);function Ul(){var r;if((!Le||!Fe||!ys)&&(Le=document.getElementById("filter-overlay-canvas"),ys=document.querySelector(".harmonic-bins-grid"),Le&&(Fe=Le.getContext("2d"))),!Le||!Fe||!ys)return;ys.getBoundingClientRect();const{width:s,height:n}=Le;Fe.clearRect(0,0,s,n);const i=(r=T.state.timbres[Jt])==null?void 0:r.filter,a=i&&i.enabled!==!1;if(i&&a){const u=n*.95,d=n,v=i.mix||0;if(v===0){kr.fill(1);return}for(let m=0;m<an;m++){const f=(m+.5)/an,b=vu(f,i);kr[m]=pb(b,v)}Fe.beginPath();const p=2;for(let m=0;m<=s;m+=p){const f=m/s,b=vu(f,i),g=d-b*u;m===0?Fe.moveTo(m,g):Fe.lineTo(m,g)}const y=v/100,x=.4+y*.6,_=y*.3;Fe.strokeStyle=on(jr(Jt,-.3),x),Fe.lineWidth=2.5,Fe.stroke(),Fe.lineTo(s,d),Fe.lineTo(0,d),Fe.closePath(),Fe.fillStyle=on(Jt,_),Fe.fill()}else kr.fill(1)}function Sc(){xc.forEach((s,n)=>{const i=s.sliderTrack.querySelector(".slider-fill"),a=s.sliderTrack.querySelector(".harmonic-label-internal"),r=Be[n]<Sd?0:Be[n];if(i.style.height=`${r*100}%`,r>0){const l=kr[n]||1,u=r>l;let d=jr(Jt,-.1),v=1;u&&(v=1-(r-l)/r*.6),i.style.backgroundColor=on(d,v)}else i.style.backgroundColor="transparent";r>.1?(a.style.color="#ffffff",a.style.textShadow="0 0 2px rgba(0,0,0,0.5)"):(a.style.color="#333333",a.style.textShadow="0 0 1px rgba(255,255,255,0.5)")}),Ul()}function yu(s,n=null){var y,x;if(B.debug("HarmonicBins","handleBinPointerEvent called",{target:s.target.className},"filter"),s.target.classList.contains("phase-button")||s.target.closest(".phase-button")||s.target.tagName==="path"||s.target.tagName==="svg"){B.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(n===null){const _=ys.getBoundingClientRect(),m=s.clientX-_.left,f=_.width/an;n=Math.floor(m/f),n=Math.max(0,Math.min(an-1,n))}B.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:n},"filter");const a=xc[n].sliderTrack.getBoundingClientRect(),r=s.clientY-a.top,u=a.height,d=Be[n],v=(u-r)/u;let p=Math.max(0,Math.min(1,v));if(p<Sd&&(p=0),(((x=(y=T.state.timbres[Jt])==null?void 0:y.adsr)==null?void 0:x.release)||0)*1e3,p===0){d>0&&Ei&&(_e.triggerRelease("C4",Jt),T.emit("spacebarPlayback",{color:Jt,isPlaying:!1}),Ei=!1),B.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:n},"filter");const _=new Float32Array(T.state.timbres[Jt].coeffs);_[n]=0,Be[n]=0,T.setHarmonicCoefficients(Jt,_),Si[n]&&(clearTimeout(Si[n]),Si[n]=null)}else{Si[n]&&(clearTimeout(Si[n]),Si[n]=null),Ei||(_e.triggerAttack("C4",Jt),T.emit("spacebarPlayback",{color:Jt,isPlaying:!0}),Ei=!0),B.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:T.state.timbres[Jt].coeffs},"filter");const _=new Float32Array(T.state.timbres[Jt].coeffs);B.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:_},"filter"),_[n]=p,Be[n]=p,B.debug("HarmonicBins",`AFTER setting newCoeffs[${n}] = ${p}`,{newCoeffs:_},"filter"),T.setHarmonicCoefficients(Jt,_),B.debug("HarmonicBins",`Updated coefficient H${n+1} to ${p} for color ${Jt}`,null,"filter"),B.debug("HarmonicBins","All coefficients",{newCoeffs:_},"filter")}Sc()}function bu(s){if(!s)return;Jt=s;const n=T.state.timbres[s];n&&(n.filter?n.filter.enabled===void 0&&(n.filter.enabled=!0):n.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0},B.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:n.coeffs},"filter"),B.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:n.phases},"filter"),Be=new Float32Array(n.coeffs),n.phases?Gs=new Float32Array(n.phases):Gs=new Float32Array(Be.length).fill(0),B.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:Be},"filter"),B.debug("HarmonicBins","updateForNewColor - final phases",{phases:Gs},"filter"),Hl.forEach(({phaseBtn:i},a)=>{if(!i)return;let l=(Gs[a]||0)%(2*Math.PI);l<0&&(l+=2*Math.PI);const u=.1;let d=0;Math.abs(l-Math.PI/2)<u?d=90:Math.abs(l-Math.PI)<u?d=180:Math.abs(l-3*Math.PI/2)<u&&(d=270),i.innerHTML=Ar[d]}),Sc())}function mb(){const s=document.querySelector(".harmonic-bins-container"),n=s==null?void 0:s.querySelector(".filter-main-panel");if(!s||!n)return;ys=document.createElement("div"),ys.className="harmonic-bins-grid";for(let r=0;r<an;r++){const l=document.createElement("div");l.className="slider-column";const u=document.createElement("div");u.className="slider-track";const d=document.createElement("div");d.className="slider-fill",u.appendChild(d);const v=document.createElement("div");v.className="harmonic-label-internal",v.textContent=`${r+1}`,u.appendChild(v),l.appendChild(u);const p=document.createElement("button");p.className="phase-button",p.innerHTML=Ar[0],p.addEventListener("click",y=>{B.debug("HarmonicBins","Phase button click handler started",null,"filter"),B.debug("HarmonicBins","Current coeffs before phase change",{coeffs:Be},"filter"),y.preventDefault(),y.stopPropagation();const x=new Float32Array(Gs),_=new Float32Array(Gs);let f=(_[r]||0)%(2*Math.PI);f<0&&(f+=2*Math.PI);const b=.1;let g=0;Math.abs(f)<b?g=Math.PI/2:Math.abs(f-Math.PI/2)<b?g=Math.PI:Math.abs(f-Math.PI)<b?g=3*Math.PI/2:g=0,_[r]=g,Gs=_,window.staticWaveformVisualizer&&window.staticWaveformVisualizer.startPhaseTransition&&window.staticWaveformVisualizer.startPhaseTransition(x,_,r),T.setHarmonicPhases(Jt,_);const S=g===0?0:Math.abs(g-Math.PI/2)<b?90:Math.abs(g-Math.PI)<b?180:270;p.innerHTML=Ar[S],B.debug("HarmonicBins",`Phase button clicked for H${r+1}, new phase: ${S}°`,null,"filter")}),l.appendChild(p),ys.appendChild(l),xc.push({column:l,label:v,sliderTrack:u,sliderFill:d,phaseBtn:p}),Hl.push({phaseBtn:p})}ys.addEventListener("pointerdown",r=>{if(r.target.classList.contains("phase-button")||r.target.closest(".phase-button")){B.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}B.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),r.preventDefault(),_e.triggerAttack("C4",Jt),T.emit("spacebarPlayback",{color:Jt,isPlaying:!0}),Ei=!0,yu(r);const l=d=>yu(d),u=()=>{window.removeEventListener("pointermove",l),window.removeEventListener("pointerup",u),T.recordState(),_e.triggerRelease("C4",Jt),T.emit("spacebarPlayback",{color:Jt,isPlaying:!1}),Ei=!1};window.addEventListener("pointermove",l),window.addEventListener("pointerup",u)}),Le=document.createElement("canvas"),Le.id="filter-overlay-canvas",Le.className="filter-overlay-canvas",Le.style.pointerEvents="none",Fe=Le.getContext("2d"),ys.appendChild(Le),n.prepend(ys);const i=()=>{const r=Le.getBoundingClientRect();(Le.width!==r.width||Le.height!==r.height)&&(Le.width=r.width,Le.height=r.height,Ul())};Jt=T.state.selectedNote.color;const a=T.state.timbres[Jt];if(a&&a.coeffs[6]>.001){B.debug("HarmonicBins",`CLEARING H7 contamination: ${a.coeffs[6]} -> 0`,null,"filter");const r=new Float32Array(a.coeffs);r[6]=0,T.setHarmonicCoefficients(Jt,r)}bu(Jt),T.on("timbreChanged",r=>{if(r===Jt){B.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const l=T.state.timbres[r],u=l.coeffs,d=l.phases;let v=!1;if(B.debug("HarmonicBins","Comparing coefficients...",null,"filter"),B.debug("HarmonicBins","Local coeffs",{coeffs:Be},"filter"),B.debug("HarmonicBins","Store coeffs",{newCoeffs:u},"filter"),!Be||Be.length!==u.length)B.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),v=!0;else for(let p=0;p<u.length;p++){const y=Math.abs(Be[p]-u[p]);if(y>.001){B.debug("HarmonicBins",`Coefficient ${p} changed: ${Be[p]} -> ${u[p]} (diff: ${y})`,null,"filter"),v=!0;break}}B.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),Be=new Float32Array(u),v?(B.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),Sc()):(B.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),Ul()),d?Gs=new Float32Array(d):Gs=new Float32Array(Be.length).fill(0),Hl.forEach(({phaseBtn:p},y)=>{if(!p)return;let _=(Gs[y]||0)%(2*Math.PI);_<0&&(_+=2*Math.PI);const m=.1;let f=0;Math.abs(_-Math.PI/2)<m?f=90:Math.abs(_-Math.PI)<m?f=180:Math.abs(_-3*Math.PI/2)<m&&(f=270),p.innerHTML=Ar[f]})}}),T.on("noteChanged",({newNote:r})=>{r.color&&r.color!==Jt&&bu(r.color)}),new ResizeObserver(i).observe(ys),i(),B.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}const As={};function gb(){return As.container=document.querySelector("#adsr-envelope"),As.parentContainer=As.container.closest(".adsr-container"),As.sustainTrack=document.getElementById("sustain-slider-track"),As.sustainThumb=document.getElementById("sustain-slider-thumb"),As.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),As.thumbA=document.getElementById("thumb-a"),As.thumbD=document.getElementById("thumb-d"),As.thumbR=document.getElementById("thumb-r"),As}const vb={init:gb,get elements(){return As}};function Td(s,n){const{sustain:i}=T.state.timbres[n.currentColor].adsr,a=.01;s.d=Math.max(s.a+a,s.d),s.r=Math.max(s.d+a,s.r);const r=s.a,l=s.d-s.a,u=s.r-s.d;if(isNaN(r)||isNaN(l)||isNaN(u)){console.error("NaN value detected before setting ADSR. Aborting update.",{newAttack:r,newDecay:l,newRelease:u});return}T.setADSR(n.currentColor,{attack:r,decay:l,release:u,sustain:i})}function yb(s,n){let i=!1;const a=u=>{if(!i)return;const d=s.sustainTrack.getBoundingClientRect();let p=100-(u.clientY-d.top)/d.height*100;p=Math.max(0,Math.min(100,p));const y=T.state.timbres[n.currentColor];T.setADSR(n.currentColor,{...y.adsr,sustain:p/100})},r=u=>{i=!0,a(u)},l=()=>{i=!1};s.sustainTrack.addEventListener("pointerdown",r),document.addEventListener("pointermove",a),document.addEventListener("pointerup",l)}function bb(s,n){let i=null;const a=u=>{if(!i)return;const d=s.multiSliderContainer.getBoundingClientRect();let p=(u.clientX-d.left)/d.width*100;p=Math.max(0,Math.min(100,p));const y=p/100*Nn,{attack:x,decay:_,release:m}=T.state.timbres[n.currentColor].adsr,f={a:x,d:x+_,r:x+_+m};i.id==="thumb-a"&&(f.a=y),i.id==="thumb-d"&&(f.d=y),i.id==="thumb-r"&&(f.r=y),Td(f,n)},r=u=>{u.target.classList.contains("time-slider-thumb")&&(i=u.target,a(u))},l=()=>{i=null};s.multiSliderContainer.addEventListener("pointerdown",r),document.addEventListener("pointermove",a),document.addEventListener("pointerup",l)}function _b(s,n){let i=null;const a=u=>{if(!i)return;const d=n.svgContainer,v=d.createSVGPoint();v.x=u.clientX,v.y=u.clientY;const p=v.matrixTransform(d.getScreenCTM().inverse());let y=p.x/n.width*100,x=1-p.y/n.height;y=Math.max(0,Math.min(100,y)),x=Math.max(0,Math.min(1,x));const _=y/100*Nn,m=T.state.timbres[n.currentColor];let{attack:f,decay:b,release:g,sustain:S}=m.adsr;const A={a:f,d:f+b,r:f+b+g};switch(i.id){case"attack-node":A.a=_;break;case"decay-sustain-node":A.d=_,S=x;break;case"release-node":A.r=_;break}const E=T.state.timbres[n.currentColor].adsr.sustain;S!==E&&T.setADSR(n.currentColor,{attack:f,decay:b,release:g,sustain:S}),Td(A,n)},r=u=>{u.target.classList.contains("adsr-node")&&(i=u.target,i.style.cursor="grabbing",a(u))},l=()=>{i&&(i.style.cursor="grab",i=null)};n.nodeLayer.addEventListener("pointerdown",r),document.addEventListener("pointermove",a),document.addEventListener("pointerup",l)}function wb(s){const n=s.ui;yb(n,s),bb(n,s),_b(n,s)}function xb(s,{width:n,height:i},a){for(;s.firstChild;)s.removeChild(s.firstChild);const r=T.state.tempo;if(r<=0||a<=0)return;const l=30/r;let u=0;for(let d=l;d<a;d+=l){const v=d/a*n,p=document.createElementNS("http://www.w3.org/2000/svg","line");p.setAttribute("x1",v),p.setAttribute("y1",0),p.setAttribute("x2",v),p.setAttribute("y2",i);const y=(u+1)%2===0;p.setAttribute("stroke",y?"#adb5bd":"#ced4da"),p.setAttribute("stroke-width",y?"1":"0.5"),s.appendChild(p),u++}}function Sb(s,n,i,{height:a,width:r},l){for(;s.firstChild;)s.removeChild(s.firstChild);for(;n.firstChild;)n.removeChild(n.firstChild);if(i.length===0)return;const u=T.state.colorPalette[l]||{primary:l,light:l},d=u.primary,v=u.light,p=document.createElementNS("http://www.w3.org/2000/svg","polygon"),y=`0,${a} `+i.map(f=>`${f.x},${f.y}`).join(" ")+` ${r},${a}`;p.setAttribute("points",y),p.setAttribute("fill",on(v,.7));const x=document.createElementNS("http://www.w3.org/2000/svg","polyline");x.setAttribute("points",i.map(f=>`${f.x},${f.y}`).join(" ")),x.setAttribute("stroke-width",2),x.setAttribute("fill","none"),x.setAttribute("stroke",d),s.appendChild(p),s.appendChild(x);const _=["attack-node","decay-sustain-node","release-node"];[i[1],i[2],i[3]].forEach((f,b)=>{const g=document.createElementNS("http://www.w3.org/2000/svg","circle");g.setAttribute("id",_[b]),g.setAttribute("class","adsr-node"),g.setAttribute("cx",f.x),g.setAttribute("cy",f.y),g.setAttribute("r",8),g.setAttribute("fill",d),g.setAttribute("stroke",jr(d,-.3)),g.setAttribute("stroke-width",2),g.style.cursor="grab";const S=document.createElementNS("http://www.w3.org/2000/svg","title");g.appendChild(S),n.appendChild(g)})}function Tb(s,n){const i=jr(n,-.2);s.style.setProperty("--c-accent",n),s.style.setProperty("--c-accent-hover",i)}const Ce={};let Gn=null,Li=!1;function Mb(s,n){const i=document.createElementNS("http://www.w3.org/2000/svg","g");i.setAttribute("data-playhead-id",s);const a=document.createElementNS("http://www.w3.org/2000/svg","line");a.setAttribute("stroke",n),a.setAttribute("stroke-width",2),a.setAttribute("stroke-dasharray","3,3"),i.appendChild(a);const r=document.createElementNS("http://www.w3.org/2000/svg","circle");return r.setAttribute("r",5),r.setAttribute("fill",n),i.appendChild(r),i}function Cb(s,n,i,a=null){if(!(!Gn||!a)){if(n==="attack"){Ce[s]&&(cancelAnimationFrame(Ce[s].requestId),Ce[s].group.remove());const r=Mb(s,i);Gn.playheadLayer.appendChild(r),Ce[s]={group:r,phase:n,color:i,adsr:a,requestId:null,startTimestamp:rt.now(),elapsed:0},Tc(s)}else if(n==="release"){if(Li)return;const r=Ce[s];if(!r)return;cancelAnimationFrame(r.requestId),r.phase="release",r.adsr=a,r.startTimestamp=rt.now(),r.elapsed=0,Mc(s)}}}function Tc(s){if(!Ce[s]||Li)return;const n=Ce[s];if(!n.adsr)return;const{attack:i,decay:a}=n.adsr,r=Gn.calculateEnvelopePoints(n.adsr);if(r.length<4)return;const[l,u,d]=r,v=rt.now()-n.startTimestamp;n.elapsed=v;const p=i+a,y=Math.min(v,p);let x,_;if(y<=i){const b=i>0?y/i:1;x=l.x+b*(u.x-l.x),_=l.y+b*(u.y-l.y)}else{const b=y-i,g=a>0?b/a:1;x=u.x+g*(d.x-u.x),_=u.y+g*(d.y-u.y)}const[m,f]=n.group.children;m.setAttribute("x1",x),m.setAttribute("y1",0),m.setAttribute("x2",x),m.setAttribute("y2",Gn.height),f.setAttribute("cx",x),f.setAttribute("cy",_),y<p&&(n.requestId=requestAnimationFrame(()=>Tc(s)))}function Mc(s){if(!Ce[s]||Li)return;const n=Ce[s];if(!n.adsr)return;const{release:i}=n.adsr,a=Gn.calculateEnvelopePoints(n.adsr);if(a.length<4)return;const[,,r,l]=a,u=rt.now()-n.startTimestamp;n.elapsed=u;const d=Math.min(u,i),v=i>0?d/i:1,p=r.x+v*(l.x-r.x),y=r.y+v*(l.y-r.y),[x,_]=n.group.children;x.setAttribute("x1",p),x.setAttribute("y1",0),x.setAttribute("x2",p),x.setAttribute("y2",Gn.height),_.setAttribute("cx",p),_.setAttribute("cy",y),d<i?n.requestId=requestAnimationFrame(()=>Mc(s)):(n.group.remove(),delete Ce[s])}function Ab(){Li=!0;for(const s in Ce){const n=Ce[s];n.requestId&&(cancelAnimationFrame(n.requestId),n.requestId=null)}}function kb(){Li=!1;for(const s in Ce){const n=Ce[s];n.startTimestamp=rt.now()-n.elapsed,n.phase==="attack"?Tc(s):n.phase==="release"&&Mc(s)}}function Pb(){Li=!1;for(const s in Ce){const n=Ce[s];cancelAnimationFrame(n.requestId),n.group.remove()}for(const s in Ce)delete Ce[s]}function Eb(s){return Gn=s,{trigger:Cb,pause:Ab,resume:kb,clearAll:Pb}}const Nn=2.5;class Ib{constructor(){this.ui=vb.init(),this.currentColor=T.state.selectedNote.color,this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=Eb(this),Os.adsrComponent=this,wb(this),this.listenForStoreChanges(),this.ui.container&&new ResizeObserver(()=>this.resize()).observe(this.ui.container),this.updateFromStore(),B.info("ADSR Component","Initialized",null,"adsr")}resize(){this.ui.container&&(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render())}updateFromStore(){const n=T.state.timbres[this.currentColor];n&&({attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release}=n.adsr,this.render(),this.updateControls())}listenForStoreChanges(){T.on("noteChanged",({newNote:n})=>{n.color&&n.color!==this.currentColor&&(this.currentColor=n.color,this.updateFromStore())}),T.on("timbreChanged",n=>{n===this.currentColor&&this.updateFromStore()}),T.on("tempoChanged",()=>this.render()),T.on("playbackStateChanged",({isPlaying:n,isPaused:i})=>{n?i?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()})}createSVGLayers(){this.ui.container&&(this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(n=this){const{attack:i,decay:a,sustain:r,release:l}=n;if(!this.width||!this.height)return[];const u=x=>x/Nn*this.width,d={x:0,y:this.height},v={x:u(i),y:0},p={x:u(i+a),y:this.height*(1-r)},y={x:u(i+a+l),y:this.height};return[d,v,p,y]}render(){if(!this.ui||!this.width||!this.height)return;const n={width:this.width,height:this.height},i=this.calculateEnvelopePoints();xb(this.gridLayer,n,Nn),Sb(this.envelopeLayer,this.nodeLayer,i,n,this.currentColor),Tb(this.ui.parentContainer,this.currentColor)}updateControls(){if(!this.ui.sustainThumb)return;const n=this.sustain*100;this.ui.sustainThumb.style.bottom=`${n}%`,this.ui.sustainTrack.style.setProperty("--sustain-progress",`${n}%`);const i=this.attack/Nn*100,a=(this.attack+this.decay)/Nn*100,r=(this.attack+this.decay+this.release)/Nn*100;this.ui.thumbA.style.left=`${i}%`,this.ui.thumbD.style.left=`${a}%`,this.ui.thumbR.style.left=`${r}%`,this.ui.multiSliderContainer.style.setProperty("--adr-progress",`${r}%`);const l=y=>`${y.toFixed(3)}s`,u=y=>`${(y*100).toFixed(0)}%`;this.ui.thumbA.title=`Attack: ${l(this.attack)}`,this.ui.thumbD.title=`Decay: ${l(this.decay)}`,this.ui.thumbR.title=`Release: ${l(this.release)}`,this.ui.sustainThumb.title=`Sustain: ${u(this.sustain)}`;const d=this.nodeLayer.querySelector("#attack-node > title");d&&(d.textContent=`Attack: ${l(this.attack)}`);const v=this.nodeLayer.querySelector("#decay-sustain-node > title");v&&(v.textContent=`Decay: ${l(this.decay)}
Sustain: ${u(this.sustain)}`);const p=this.nodeLayer.querySelector("#release-node > title");p&&(p.textContent=`Release: ${l(this.release)}`)}}function Ob(){return document.getElementById("adsr-envelope")?new Ib:null}let ko,Oi,Bn,Di,Fr,$s,js,Xl=!1,Yl=!1,Zl=!1,Is;const Br=1,Md=31,Cd=0,qr=2;function kl(){if(!Is)return;const s=T.state.timbres[Is];if(!s)return;s.filter?s.filter.enabled===void 0&&(s.filter.enabled=!0):s.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0};const{cutoff:n,blend:i,mix:a}=s.filter;if(ko&&Oi){const r=(qr-i)/(qr-Cd);ko.style.left=`${r*100}%`,Oi.style.setProperty("--progress",`${r*100}%`)}if($s&&js){const r=(a||0)/100;$s.style.bottom=`${r*100}%`,js.style.setProperty("--blend-progress",`${r*100}%`)}if(Bn&&Di){const r=(n-Br)/(Md-Br);Bn.style.left=`${r*100}%`,Bn.style.top="50%",Bn.style.transform="translate(-50%, -50%)",Di.style.setProperty("--progress",`${r*100}%`)}Fr&&Fr.style.setProperty("--c-accent",Is)}function Db(s){if(!Xl)return;const n=Di.getBoundingClientRect(),i=s.clientX-n.left,a=n.width;let r=i/a;r=Math.max(0,Math.min(1,r));const l=r*(Md-Br)+Br;T.setFilterSettings(Is,{cutoff:l})}function Rb(s){if(!Yl)return;const n=Oi.getBoundingClientRect(),i=s.clientX-n.left,a=n.width;let r=i/a;r=Math.max(0,Math.min(1,r));const l=qr-r*(qr-Cd);T.setFilterSettings(Is,{blend:l})}function Nb(s){if(!Zl)return;const n=js.getBoundingClientRect(),i=s.clientY-n.top,a=n.height;let r=1-i/a;r=Math.max(0,Math.min(1,r));const l=r*100;T.setFilterSettings(Is,{mix:l})}function Lb(){if(Fr=document.querySelector(".harmonic-bins-container"),ko=document.getElementById("thumb-b"),Oi=document.getElementById("blend-slider-container"),Bn=document.getElementById("thumb-c"),Di=document.getElementById("cutoff-slider-container"),!Fr||!ko||!Bn)return;const s=document.querySelector(".blend-slider-container");s&&Oi&&(s.getBoundingClientRect(),Oi.getBoundingClientRect()),Di&&Di.getBoundingClientRect(),Fb(),ko.addEventListener("mousedown",n=>{n.preventDefault(),Yl=!0,document.body.style.cursor="ew-resize";const i=r=>Rb(r),a=()=>{Yl=!1,document.body.style.cursor="default",window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",a),T.recordState()};window.addEventListener("mousemove",i),window.addEventListener("mouseup",a)}),Bn.addEventListener("mousedown",n=>{n.preventDefault(),Xl=!0,document.body.style.cursor="ew-resize";const i=r=>Db(r),a=()=>{Xl=!1,document.body.style.cursor="default",window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",a),T.recordState()};window.addEventListener("mousemove",i),window.addEventListener("mouseup",a)}),T.on("noteChanged",({newNote:n})=>{n.color&&n.color!==Is&&(Is=n.color,kl())}),T.on("timbreChanged",n=>{n===Is&&kl()}),Is=T.state.selectedNote.color,kl(),setTimeout(()=>{const n=document.querySelector(".blend-slider-container");n&&n.getBoundingClientRect()},100)}function Fb(){const s=document.querySelector(".filter-button-wrapper");s&&(s.innerHTML="",s.className="vertical-blend-wrapper",js=document.createElement("div"),js.id="vertical-blend-track",js.className="vertical-slider-track",$s=document.createElement("div"),$s.id="vertical-blend-thumb",$s.className="vertical-slider-thumb",$s.textContent="M",$s.title="Filter Mix: 0% to 100%",js.appendChild($s),s.appendChild(js),$s.addEventListener("mousedown",n=>{n.preventDefault(),Zl=!0,document.body.style.cursor="ns-resize";const i=r=>Nb(r),a=()=>{Zl=!1,document.body.style.cursor="default",window.removeEventListener("mousemove",i),window.removeEventListener("mouseup",a),T.recordState()};window.addEventListener("mousemove",i),window.addEventListener("mouseup",a)}),js.addEventListener("click",n=>{if(n.target===$s)return;const i=js.getBoundingClientRect(),a=n.clientY-i.top,r=i.height;let l=1-a/r;l=Math.max(0,Math.min(1,l));const u=l*100;T.setFilterSettings(Is,{mix:u}),T.recordState()}))}function Bb(s,n,i){if(!(n.length<2)){s.globalAlpha=i.opacity;for(let a=1;a<n.length;a++){const r=n[a-1],l=n[a];if(l.timestamp-r.timestamp>200)continue;const u=s.createLinearGradient(r.x,r.y,l.x,l.y);u.addColorStop(0,`rgb(${r.color.join(",")})`),u.addColorStop(1,`rgb(${l.color.join(",")})`),s.strokeStyle=u,s.lineWidth=(r.thickness+l.thickness)/2,s.lineCap="round",s.lineJoin="round",s.beginPath(),s.moveTo(r.x,r.y),s.lineTo(l.x,l.y),s.stroke()}s.globalAlpha=1}}function qb(s,n){const i=T.state,a=Us(T.state),r=i.fullRowData.slice(s.topRow,s.bottomRow+1);let l=i.placedNotes.filter(O=>!O.isDrum&&O.row>=s.topRow&&O.row<=s.bottomRow).map(O=>({...O,row:O.row-s.topRow})),u=s.includeDrums?i.placedNotes.filter(O=>O.isDrum):[];if(s.colorMode==="bw"){const O=L=>L.map(F=>({...F,color:"#212529"}));l=O(l),u=O(u)}const d=i.columnWidths.reduce((O,L)=>O+L,0),v=50,p=v*2,y=d*v,x=r.length/2*p,_=s.includeDrums?3*.5*p:0,m=_>0?30:0,f=x+m+_,b=Math.min(n.width/y,n.height/f),g=document.createElement("canvas");g.width=y*b,g.height=f*b;const S=g.getContext("2d");S.scale(b,b),S.fillStyle="#FFF",S.fillRect(0,0,y,f);const A={placedNotes:l,placedTonicSigns:a,fullRowData:r,columnWidths:i.columnWidths,cellWidth:v,cellHeight:p,macrobeatGroupings:i.macrobeatGroupings,macrobeatBoundaryStyles:i.macrobeatBoundaryStyles,colorMode:s.colorMode,degreeDisplayMode:"off"},E=document.createElement("canvas");if(E.width=y,E.height=x,md(E.getContext("2d"),A),S.drawImage(E,0,0),i.paint&&i.paint.paintHistory.length>0){console.log(`[PrintService] Found ${i.paint.paintHistory.length} paint points to print.`);const O=document.createElement("canvas");O.width=y,O.height=x;const L=O.getContext("2d"),F=document.getElementById("notation-grid"),U=y/F.width,X=x/(F.height*(r.length/i.fullRowData.length)),Q=s.topRow*(p/2),ct=i.paint.paintHistory.map(gt=>({...gt,x:gt.x*U,y:gt.y*X-Q,thickness:gt.thickness*Math.min(U,X)}));Bb(L,ct,{opacity:i.paint.paintSettings.opacity/100}),S.drawImage(O,0,0),console.log("[PrintService] Paint trail has been rendered for printing.")}if(s.includeDrums){const O={placedNotes:u,placedTonicSigns:a,columnWidths:i.columnWidths,cellWidth:v,cellHeight:p,macrobeatGroupings:i.macrobeatGroupings,macrobeatBoundaryStyles:i.macrobeatBoundaryStyles},L=document.createElement("canvas");L.width=y,L.height=_,yd(L.getContext("2d"),O),S.drawImage(L,0,x+m)}return g}const _u={generateScoreCanvas:qb,generateAndPrint(){const s=T.state.printOptions,n=300,i=(s.orientation==="landscape"?10.5:8)*n,a=(s.orientation==="landscape"?8:10.5)*n,r=this.generateScoreCanvas(s,{width:i,height:a}),l=document.getElementById("print-staging-area");l.innerHTML="";const u=document.getElementById("print-style-rules");u.textContent=`@page { size: ${s.orientation}; margin: 0.25in; }`;const d=document.createElement("img");d.src=r.toDataURL("image/png"),d.style.width="100%",d.style.height="auto",l.appendChild(d),setTimeout(()=>window.print(),100)}},zb={init(){this.overlay=document.getElementById("print-preview-overlay"),this.overlay&&(this.canvas=document.getElementById("print-preview-canvas"),this.ctx=this.canvas.getContext("2d"),this.canvasWrapper=this.canvas.parentElement,this.topRowSlider=document.getElementById("print-top-row-slider"),this.bottomRowSlider=document.getElementById("print-bottom-row-slider"),this.topRowLabel=document.getElementById("print-top-row-label"),this.bottomRowLabel=document.getElementById("print-bottom-row-label"),this.orientationBtn=document.getElementById("print-orientation-toggle"),this.colorBtn=document.getElementById("print-color-mode-toggle"),this.drumsBtn=document.getElementById("print-drums-toggle"),document.getElementById("print-close-button").addEventListener("click",()=>this.hide()),document.getElementById("print-confirm-button").addEventListener("click",()=>{_u.generateAndPrint(),this.hide()}),this.topRowSlider.addEventListener("input",s=>T.setPrintOptions({topRow:parseInt(s.target.value)})),this.bottomRowSlider.addEventListener("input",s=>T.setPrintOptions({bottomRow:parseInt(s.target.value)})),this.orientationBtn.addEventListener("click",()=>this.handleToggle("orientation",["landscape","portrait"])),this.colorBtn.addEventListener("click",()=>this.handleToggle("colorMode",["color","bw"])),this.drumsBtn.addEventListener("click",()=>this.handleToggle("includeDrums",[!0,!1])),T.on("printPreviewStateChanged",s=>s?this.show():this.hide()),T.on("printOptionsChanged",()=>this.render()),T.on("notesChanged",()=>{T.state.isPrintPreviewActive&&this.render()}),new ResizeObserver(()=>{T.state.isPrintPreviewActive&&this.render()}).observe(this.canvasWrapper))},show(){T.state.isPrintPreviewActive=!0,this.overlay.classList.remove("hidden");const s=T.state.placedNotes.filter(u=>!u.isDrum);let n=s.length>0?1/0:34,i=s.length>0?-1/0:54;s.forEach(u=>{n=Math.min(n,u.row),i=Math.max(i,u.row)});const a=2,r=Math.max(0,n-a),l=Math.min(T.state.fullRowData.length-1,i+a);this.topRowSlider.max=T.state.fullRowData.length-1,this.bottomRowSlider.max=T.state.fullRowData.length-1,T.setPrintOptions({...T.state.printOptions,topRow:r,bottomRow:l})},hide(){T.state.isPrintPreviewActive=!1,this.overlay.classList.add("hidden")},handleToggle(s,n){const a=T.state.printOptions[s]===n[0]?n[1]:n[0];T.setPrintOptions({[s]:a})},updateControls(){var l,u;const{topRow:s,bottomRow:n,orientation:i,colorMode:a,includeDrums:r}=T.state.printOptions;this.topRowSlider.value=s,this.bottomRowSlider.value=n,this.topRowLabel.textContent=((l=T.state.fullRowData[s])==null?void 0:l.pitch)||"N/A",this.bottomRowLabel.textContent=((u=T.state.fullRowData[n])==null?void 0:u.pitch)||"N/A",this.orientationBtn.textContent=i.charAt(0).toUpperCase()+i.slice(1),this.colorBtn.textContent=a==="color"?"Color":"B&W",this.drumsBtn.textContent=r?"Yes":"No",this.drumsBtn.classList.toggle("active",r),this.colorBtn.classList.toggle("active",a==="color")},render(){if(!T.state.isPrintPreviewActive)return;this.updateControls();const s=this.canvasWrapper.clientWidth,n=this.canvasWrapper.clientHeight;if(s===0||n===0)return;const i=_u.generateScoreCanvas(T.state.printOptions,{width:s,height:n});i&&(this.canvas.width=i.width,this.canvas.height=i.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(i,0,0))}};class Wb{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.animationFrameId=null,this.waveformData=new Float32Array(512),this.isInitialized=!1,this.isPlaybackActive=!1,this.liveAnalysers=new Map,this.liveWaveforms=new Map,this.playbackAnimationId=null,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=300,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null}initialize(){if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;this.ctx=this.canvas.getContext("2d"),this.currentColor=T.state.selectedNote.color;const n=this.canvas.parentElement;return n&&new ResizeObserver(()=>this.resize()).observe(n),this.resize(),this.setupEventListeners(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const n=this.canvas.parentElement;if(!n)return;const{clientWidth:i,clientHeight:a}=n,r=this.canvas.width,l=this.canvas.height;if((i===0||a===0)&&this.canvas.width>0&&this.canvas.height>0)return;const d=Math.abs(i-r),v=Math.abs(a-l);(d>2||v>2)&&(this.canvas.width=i,this.canvas.height=a,this.draw())}setupEventListeners(){T.on("noteChanged",({newNote:n})=>{n.color&&n.color!==this.currentColor&&(this.currentColor=n.color,this.generateWaveform())}),T.on("timbreChanged",n=>{n===this.currentColor&&this.generateWaveform()}),T.on("playbackStateChanged",({isPlaying:n,isPaused:i})=>{n&&!i?this.startLiveVisualization():this.stopLiveVisualization()}),T.on("spacebarPlayback",({color:n,isPlaying:i})=>{i?this.startSingleNoteVisualization(n):this.stopLiveVisualization()}),document.querySelectorAll(".tab-button").forEach(n=>{n.addEventListener("click",()=>{n.dataset.tab==="timbre"&&setTimeout(()=>{this.resize()},100)})})}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const n=T.state.timbres[this.currentColor];if(!n||!n.coeffs)return;const i=n.coeffs,a=n.phases||[],r=this.waveformData.length,l=1,u=[];for(let d=0;d<i.length;d++)i[d]>.001&&u.push(`${d===0?"F0":"H"+(d+1)}: ${i[d].toFixed(3)}`);this.waveformData.fill(0);for(let d=0;d<r;d++){const v=d/r*1.3333333333333333*2*Math.PI;let p=0;for(let y=0;y<Ri;y++){const x=i[y]||0;if(x>.001){const _=a[y]||0,m=y+1;p+=x*Math.sin(m*v+_)}}this.waveformData[d]=p*l}this.draw()}startPhaseTransition(n,i,a){this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(i),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition()}generateTargetWaveform(n){if(!this.currentColor)return;const i=T.state.timbres[this.currentColor];if(!i||!i.coeffs)return;const a=i.coeffs,r=this.waveformData.length,l=1;this.waveformData.fill(0);for(let u=0;u<r;u++){const d=u/r*1.3333333333333333*2*Math.PI;let v=0;for(let p=0;p<Ri;p++){const y=a[p]||0;if(y>.001){const x=n[p]||0,_=p+1;v+=y*Math.sin(_*d+x)}}this.waveformData[u]=v*l}}animateTransition(){if(!this.isTransitioning)return;const n=performance.now()-this.transitionStartTime,i=Math.min(n/this.transitionDuration,1),a=1-Math.pow(1-i,3);for(let r=0;r<this.waveformData.length;r++)this.waveformData[r]=this.fromWaveform[r]+(this.toWaveform[r]-this.fromWaveform[r])*a;this.draw(),i>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let n=0;for(let i=0;i<this.waveformData.length;i++)n=Math.max(n,Math.abs(this.waveformData[i]));if(n>0){const i=.9/n;for(let a=0;a<this.waveformData.length;a++)this.waveformData[a]*=i}}draw(){if(!this.ctx||!this.canvas)return;const{width:n,height:i}=this.canvas,a=i/2,r=i*.4;this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,n,i),this.drawGrid(n,i,a),this.isPlaybackActive&&this.liveWaveforms.size>0?this.drawLiveWaveforms(n,a,r):this.drawWaveform(n,a,r),n>200&&i>100&&this.drawLabels(n,i)}drawGrid(n,i,a){this.ctx.strokeStyle="#ced4da",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,a),this.ctx.lineTo(n,a),this.ctx.stroke();for(let u=1;u<5;u++){const d=n/4*u;this.ctx.beginPath(),this.ctx.moveTo(d,0),this.ctx.lineTo(d,i),this.ctx.stroke()}const r=n/480*360;this.ctx.fillStyle="rgba(128, 128, 128, 0.15)",this.ctx.fillRect(r,0,n-r,i),[.25,.5,.75].forEach(u=>{const d=a-i*.4*u,v=a+i*.4*u;this.ctx.beginPath(),this.ctx.moveTo(0,d),this.ctx.lineTo(n,d),this.ctx.moveTo(0,v),this.ctx.lineTo(n,v),this.ctx.stroke()}),this.ctx.setLineDash([])}drawWaveform(n,i,a){if(this.waveformData.length===0)return;const r=this.currentColor||"#4A90E2";this.ctx.strokeStyle=r,this.ctx.lineWidth=2,this.ctx.beginPath();const l=this.waveformData.length/n;for(let d=0;d<n;d++){const v=Math.floor(d*l),p=this.waveformData[v]||0,y=i-p*a;d===0?this.ctx.moveTo(d,y):this.ctx.lineTo(d,y)}this.ctx.stroke(),this.ctx.lineTo(n,i),this.ctx.lineTo(0,i),this.ctx.closePath();const u=this.ctx.createLinearGradient(0,i-a,0,i+a);u.addColorStop(0,on(r,.3)),u.addColorStop(.5,on(r,.1)),u.addColorStop(1,on(r,.3)),this.ctx.fillStyle=u,this.ctx.fill()}drawLiveWaveforms(n,i,a){const r=Array.from(this.liveWaveforms.keys());if(r.length===1){const l=r[0],u=this.liveWaveforms.get(l);this.drawSingleLiveWaveform(u,l,n,i,a*1.1)}else r.length>1&&r.forEach((l,u)=>{const d=this.liveWaveforms.get(l);this.drawLayeredLiveWaveform(d,l,n,i,a,r.length)})}drawSingleLiveWaveform(n,i,a,r,l){if(this.waveformData&&this.waveformData.length>0){this.ctx.strokeStyle=i,this.ctx.lineWidth=2,this.ctx.beginPath();const d=this.waveformData.length/a;for(let v=0;v<a;v++){const p=Math.floor(v*d),y=this.waveformData[p]||0,x=r-y*l;v===0?this.ctx.moveTo(v,x):this.ctx.lineTo(v,x)}this.ctx.stroke();return}if(!n||n.length===0)return;this.ctx.strokeStyle=i,this.ctx.lineWidth=2,this.ctx.beginPath();const u=n.length/a;for(let d=0;d<a;d++){const v=Math.floor(d*u),p=n[v]||0,y=r-p*l;d===0?this.ctx.moveTo(d,y):this.ctx.lineTo(d,y)}this.ctx.stroke()}drawLayeredLiveWaveform(n,i,a,r,l,u){if(!n||n.length===0)return;const d=Math.max(.4,1/u),v=on(i,d*2);on(i,d*.5),this.ctx.strokeStyle=v,this.ctx.lineWidth=1.5,this.ctx.beginPath();const p=n.length/a;for(let y=0;y<a;y++){const x=Math.floor(y*p),_=n[x]||0,m=r-_*l*.7;y===0?this.ctx.moveTo(y,m):this.ctx.lineTo(y,m)}this.ctx.stroke()}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms())}startSingleNoteVisualization(n){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(n),this.updateContainerState(!0),this.animateLiveWaveforms())}stopLiveVisualization(){this.isPlaybackActive=!1,this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),this.draw()}updateContainerState(n){var a;const i=(a=this.canvas)==null?void 0:a.parentElement;i&&(n?(i.classList.add("live-mode"),T.state.isPlaying&&!T.state.isPaused&&i.classList.add("pulsing")):i.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const n=window.synthEngine;if(!n)return;this.getActivePlayingColors().forEach(a=>{const r=n.createWaveformAnalyzer(a);r&&(this.liveAnalysers.set(a,r),this.liveWaveforms.set(a,new Float32Array(1024)))})}setupSingleAnalyser(n){const i=window.synthEngine;if(!i)return;const a=i.createWaveformAnalyzer(n);a&&(this.liveAnalysers.set(n,a),this.liveWaveforms.set(n,new Float32Array(1024)))}getActivePlayingColors(){const n=new Set;return T.state.isPlaying&&T.state.placedNotes.forEach(i=>{!i.isDrum&&i.color&&n.add(i.color)}),n.size===0&&this.currentColor&&n.add(this.currentColor),Array.from(n)}animateLiveWaveforms(){this.isPlaybackActive&&(this.liveAnalysers.forEach((n,i)=>{const a=n.getValue();this.liveWaveforms.set(i,a)}),this.draw(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms()))}drawLabels(n,i){this.ctx.fillStyle="#666666",this.ctx.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.ctx.textAlign="center",["0°","120°","240°","360°","480°"].forEach((r,l)=>{const u=n/4*l;this.ctx.fillText(r,u,i-8)}),this.ctx.textAlign="left",this.ctx.fillText("+1.0",5,15),this.ctx.fillText("0.0",5,i/2+4),this.ctx.fillText("-1.0",5,i-8)}dispose(){this.stopLiveVisualization(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const Ad=new Wb;window.staticWaveformVisualizer=Ad;function Vb(){return Ad.initialize()}class $b{constructor(){this.dial=null,this.customDials=[],this.currentColor=T.state.selectedNote.color,this.currentEffect=null,this.effectButtons=[],this.effectControlsContainer=null}createCustomDial(n,i){const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("width","60"),a.setAttribute("height","60"),a.setAttribute("viewBox","0 0 60 60"),a.style.cursor="pointer";const r={x:30,y:30},l=60,u=document.createElementNS("http://www.w3.org/2000/svg","circle"),d=document.createElementNS("http://www.w3.org/2000/svg","path"),v=document.createElementNS("http://www.w3.org/2000/svg","path"),p=document.createElementNS("http://www.w3.org/2000/svg","path"),y=document.createElementNS("http://www.w3.org/2000/svg","path"),x=document.createElementNS("http://www.w3.org/2000/svg","path"),_=document.createElementNS("http://www.w3.org/2000/svg","circle"),f=(T.state.colorPalette[this.currentColor]||{primary:this.currentColor,light:this.currentColor}).primary,b=getComputedStyle(n),g=b.getPropertyValue("--c-surface").trim()||"#ffffff",S=b.getPropertyValue("--c-border").trim()||"#cccccc";u.setAttribute("cx",r.x),u.setAttribute("cy",r.y),u.setAttribute("r",l/2-l/40),u.setAttribute("fill",g),u.setAttribute("stroke",S),u.setAttribute("stroke-width","2"),_.setAttribute("cx",r.x),_.setAttribute("cy",r.y),_.setAttribute("r",l/12),_.setAttribute("fill",f),d.setAttribute("stroke-width",l/20),d.setAttribute("fill","none"),d.setAttribute("stroke",f),v.setAttribute("stroke-width",l/20),v.setAttribute("fill","none"),v.setAttribute("stroke",f),p.setAttribute("fill-opacity","0.3"),p.setAttribute("fill",f),y.setAttribute("fill-opacity","0.3"),y.setAttribute("fill",f),x.setAttribute("stroke-width",l/20),x.setAttribute("stroke",f),a.appendChild(u),a.appendChild(d),a.appendChild(v),a.appendChild(p),a.appendChild(y),a.appendChild(x),a.appendChild(_),n.appendChild(a);const A={value:i.value,min:i.min,max:i.max,element:a,width:60,height:60,coloredElements:{handle:d,handle2:v,handleFill:p,handle2Fill:y,handleLine:x,screw:_},clip(F,U,X){return Math.min(X,Math.max(U,F))},scale(F,U,X,Q,ct){return(F-U)*(ct-Q)/(X-U)+Q},render(){const F=(this.value-this.min)/(this.max-this.min),U={start:Math.PI*1.5,end:this.clip(this.scale(F,0,.5,Math.PI*1.5,Math.PI*.5),Math.PI*.5,Math.PI*1.5)},X={start:Math.PI*2.5,end:this.clip(this.scale(F,.5,1,Math.PI*2.5,Math.PI*1.5),Math.PI*1.5,Math.PI*2.5)},Q=l/2-l/40;let ct=this.createNexusArc(r.x,r.y,Q,U.start,U.end),gt=this.createNexusArc(r.x,r.y,Q,X.start,X.end);d.setAttribute("d",ct),v.setAttribute("d",gt);let _t=ct+` L ${r.x} ${r.y}`,wt=gt+` L ${r.x} ${r.y}`;p.setAttribute("d",_t),y.setAttribute("d",wt);let Mt;F<=.5?Mt=U.end:Mt=X.end;const Rt=r.x+Math.cos(Mt)*Q,Xt=r.y+Math.sin(Mt)*Q*-1;x.setAttribute("d",`M ${r.x} ${r.y} L ${Rt} ${Xt}`)},createNexusArc(F,U,X,Q,ct){const gt={x:F+Math.cos(Q)*X,y:U+Math.sin(Q)*X*-1},_t={x:F+Math.cos(ct)*X,y:U+Math.sin(ct)*X*-1},Mt=Math.abs(Q-ct)>=Math.PI?1:0,Rt=Q>ct?1:0;return["M",gt.x,gt.y,"A",X,X,0,Mt,Rt,_t.x,_t.y].join(" ")},on(F,U){F==="change"&&(this.changeCallback=U)},setValue(F){this.value=Math.max(this.min,Math.min(this.max,F)),this.render(),this.changeCallback&&this.changeCallback(this.value)},updateColors(F){const X=(T.state.colorPalette[F]||{primary:F}).primary,{handle:Q,handle2:ct,handleFill:gt,handle2Fill:_t,handleLine:wt,screw:Mt}=this.coloredElements;Q.setAttribute("stroke",X),ct.setAttribute("stroke",X),gt.setAttribute("fill",X),_t.setAttribute("fill",X),wt.setAttribute("stroke",X),Mt.setAttribute("fill",X)}};let E=!1,O=!1;const L=F=>{const U=a.getBoundingClientRect(),X=F.clientX-U.left-r.x,Q=F.clientY-U.top-r.y;let ct=Math.atan2(Q,X);return ct<0&&(ct+=Math.PI*2),ct-=Math.PI/2,ct<0&&(ct+=Math.PI*2),ct};return a.addEventListener("mousedown",F=>{E=!0,O=!1,a.style.cursor="grabbing"}),document.addEventListener("mousemove",F=>{if(!E)return;let U=L(F);O!==!1&&Math.abs(O-U)>2&&(O>3?U=Math.PI*2:U=0),O=U;const X=U/(Math.PI*2),Q=A.min+X*(A.max-A.min);A.setValue(Q)}),document.addEventListener("mouseup",()=>{E&&(E=!1,a.style.cursor="pointer")}),A.render(),A}init(){return this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),!this.effectControlsContainer||this.effectButtons.length===0?(console.error("SimpleEffectsTest: Could not find effect-controls container or effect buttons"),!1):(this.effectConfigs={reverb:{name:"Reverb",controls:[{name:"Room Size",min:0,max:100,value:50,isCustom:!0},{name:"Decay",min:0,max:100,value:30,isCustom:!0},{name:"Wet/Dry",min:0,max:100,value:25,isCustom:!0}]},delay:{name:"Delay",controls:[{name:"Time",min:0,max:100,value:25,isCustom:!0},{name:"Feedback",min:0,max:95,value:40,isCustom:!0},{name:"Wet/Dry",min:0,max:100,value:30,isCustom:!0}]},phaser:{name:"Phaser",controls:[{name:"Rate",min:0,max:100,value:50,isCustom:!0},{name:"Depth",min:0,max:100,value:75,isCustom:!0},{name:"Stages",min:2,max:12,value:6,isCustom:!0}]},vibratio:{name:"Vibrato",controls:[{name:"Speed",min:0,max:100,value:40,isCustom:!0},{name:"Span",min:0,max:100,value:60,isCustom:!0}]},tremelo:{name:"Tremolo",controls:[{name:"Speed",min:0,max:100,value:35,isCustom:!0},{name:"Span",min:0,max:100,value:50,isCustom:!0}]},portamento:{name:"Portamento",controls:[{name:"Glide Time",min:0,max:100,value:20,isCustom:!0},{name:"Glide Shape",min:0,max:100,value:50,isCustom:!0}]}},this.setupEventListeners(),this.updateButtonTheming(this.currentColor),T.on("noteChanged",({newNote:n})=>{n.color&&n.color!==this.currentColor&&(this.currentColor=n.color,this.customDials.forEach(i=>{i.updateColors(this.currentColor)}),this.updateButtonTheming(this.currentColor))}),!0)}setupEventListeners(){this.effectButtons.forEach(n=>{n.addEventListener("click",i=>{const a=i.target.dataset.effect;this.selectEffect(a)})})}selectEffect(n){if(console.log(`SimpleEffectsTest: Selecting effect: ${n}`),this.effectButtons.forEach(i=>{i.classList.remove("active"),i.dataset.effect===n&&i.classList.add("active")}),this.currentEffect===n){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=n,this.showEffectControls(n)}showEffectControls(n){const i=this.effectConfigs[n];if(!i){console.warn(`SimpleEffectsTest: No configuration found for effect: ${n}`);return}this.clearDials(),this.effectControlsContainer.innerHTML='<div id="dial-container"></div>',this.effectControlsContainer.classList.add("active");const a=this.effectControlsContainer.querySelector("#dial-container");i.controls.forEach(r=>{const l=document.createElement("div");l.className="dial-wrapper",a.appendChild(l);const u=document.createElement("div");u.className="dial-label",u.textContent=r.name,l.appendChild(u);const d=document.createElement("div");l.appendChild(d);let v;r.isCustom?(v=this.createCustomDial(d,r),this.customDials.push(v)):(v=this.createCustomDial(d,r),this.customDials.push(v));const p=document.createElement("div");p.className="dial-value dial-value-hidden",p.textContent=`${r.value}%`,l.appendChild(p),setTimeout(()=>{const y=d.querySelector("svg");y&&(y.addEventListener("mousedown",x=>{p.classList.remove("dial-value-hidden"),p.classList.add("dial-value-visible")}),y.addEventListener("mouseup",x=>{p.classList.remove("dial-value-visible"),p.classList.add("dial-value-hidden")}),y.addEventListener("mouseleave",x=>{p.classList.remove("dial-value-visible"),p.classList.add("dial-value-hidden")}))},100),v.on("change",y=>{p.textContent=`${Math.round(y)}%`,console.log(`${i.name} ${r.name}: ${Math.round(y)}%`)}),this.dials||(this.dials=[]),this.dials.push(v)}),this.effectControlsContainer.classList.add("active")}hideEffectControls(){this.clearDials(),this.effectControlsContainer.classList.remove("active"),this.effectControlsContainer.innerHTML="",this.effectButtons.forEach(n=>n.classList.remove("active"))}clearDials(){this.customDials=[],this.dials&&(this.dials.forEach(n=>{n.destroy&&n.destroy()}),this.dials=[])}updateButtonTheming(n){const i=T.state.colorPalette[n]||{primary:n,light:n},a=i.light,r=i.primary,l=this.lightenColor(a,60),u=document.querySelector(".effects-content-box")||document.body;u.style.setProperty("--c-accent",r),u.style.setProperty("--c-accent-light",l),u.style.setProperty("--c-accent-hover",this.darkenColor(r,20))}darkenColor(n,i=20){const a=parseInt(n.slice(1,3),16),r=parseInt(n.slice(3,5),16),l=parseInt(n.slice(5,7),16),u=Math.max(0,Math.floor(a*(1-i/100))),d=Math.max(0,Math.floor(r*(1-i/100))),v=Math.max(0,Math.floor(l*(1-i/100)));return`#${u.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}`}lightenColor(n,i=50){const a=parseInt(n.slice(1,3),16),r=parseInt(n.slice(3,5),16),l=parseInt(n.slice(5,7),16),u=Math.min(255,Math.floor(a+(255-a)*(i/100))),d=Math.min(255,Math.floor(r+(255-r)*(i/100))),v=Math.min(255,Math.floor(l+(255-l)*(i/100)));return`#${u.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${v.toString(16).padStart(2,"0")}`}}const jb=new $b,Ql=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function Gb(s){if(s===0||!s)return"#888888";const n=Math.round(s)%12;return Ql[n]}function Jl(s){if(s===0||!s)return Pl("#888888");const n=Math.floor(s),i=s-n;if(i<0||i>=1)return Gb(s);const a=n%12,r=(a+1)%12,l=Pl(Ql[a]),u=Pl(Ql[r]);return Hb(l,u,i)}function Pl(s){const n=parseInt(s.slice(1),16);return[n>>16&255,n>>8&255,n&255]}function Hb(s,n,i){return s.map((a,r)=>Math.round(a+i*(n[r]-a)))}class Ub{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0}initialize(){this.canvas=document.getElementById("playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),T.on("micPaintStateChanged",n=>this.handlePaintStateChange(n)),T.on("pitchDetected",n=>this.handlePitchDetection(n)),T.on("playbackStateChanged",()=>{T.state.paint.isMicPaintActive}))}handlePaintStateChange(n){console.log("PaintPlayheadRenderer: Paint state changed to:",n);const i=document.getElementById("hover-canvas");i&&(i.style.display=n?"none":"block"),n?(console.log("PaintPlayheadRenderer: Starting rendering..."),this.startRendering()):(console.log("PaintPlayheadRenderer: Stopping rendering..."),this.stopRendering())}handlePitchDetection(n){T.state.paint.isMicPaintActive&&T.state.isPlaying&&!T.state.isPaused&&this.addPaintAtPlayhead(n)}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!T.state.paint.isMicPaintActive||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),T.state.isPlaying,T.state.isPaused,T.state.isPlaying&&T.state.isPaused,T.state.isPlaying&&!T.state.isPaused?this.renderMovingPlayhead():this.renderStationaryPlayhead(),this.animationFrameId=requestAnimationFrame(()=>this.render())}renderStationaryPlayhead(){const{detectedPitch:n}=T.state.paint;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.midiToY(n.midi),a=i!==null,r=It.getColumnX(2),l=It.getCanvasWidth();if(a){const u=Jl(n.midi),d=`rgb(${u[0]}, ${u[1]}, ${u[2]})`;this.ctx.strokeStyle=d,this.ctx.globalAlpha=Math.min(n.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=d,this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(r,i),this.ctx.lineTo(l,i),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}else{const d=It.getViewportInfo().viewportHeight/2;this.ctx.strokeStyle="rgba(74, 144, 226, 0.6)",this.ctx.lineWidth=2,this.ctx.setLineDash([8,8]),this.ctx.beginPath(),this.ctx.moveTo(r,d),this.ctx.lineTo(l,d),this.ctx.stroke(),this.ctx.setLineDash([])}}renderMovingPlayhead(){const n=this.calculateXFromTime(rt.Transport.seconds);if(n===null)return;this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(n,0),this.ctx.lineTo(n,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0;const{detectedPitch:i}=T.state.paint,a=this.midiToY(i.midi);if(a!==null){const r=Jl(i.midi),l=`rgb(${r[0]}, ${r[1]}, ${r[2]})`;this.ctx.fillStyle=l,this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.shadowColor=l,this.ctx.shadowBlur=4,this.ctx.beginPath(),this.ctx.arc(n,a,8,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowBlur=0}}addPaintAtPlayhead(n){if(n.midi===0)return;const i=rt.Transport.seconds;Cc.addPaintPoint(i,n.midi)}buildTimeMap(){this.timeMap=[];let n=0;const i=30/T.state.tempo;for(let a=0;a<T.state.columnWidths.length;a++)this.timeMap[a]=n,n+=T.state.columnWidths[a]*i;this.timeMap.push(n)}calculateXFromTime(n){T.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=T.state.tempo);for(let i=0;i<this.timeMap.length-1;i++)if(n>=this.timeMap[i]&&n<this.timeMap[i+1]){const a=this.timeMap[i],r=this.timeMap[i+1]-a,l=n-a,u=It.getColumnX(i),d=It.getColumnX(i+1)-u;return u+(r>0?l/r*d:0)}return null}midiToY(n){if(n===0)return null;const{fullRowData:i}=T.state;if(!i||i.length===0)return null;const a=Math.min(...i.map(p=>Ci(p.toneNote))),r=Math.max(...i.map(p=>Ci(p.toneNote)));if(console.log("🎵 [Pitch->Y] Input:",n.toFixed(1),"Grid range:",a,"-",r),n<a||n>r){const p=this.canvas.height;let y;if(n>r){const x=n-r;y=Math.max(20,p*.2-x*5),console.log("🔼 [Above Grid] Y:",y.toFixed(1))}else{const x=a-n;y=Math.min(p-20,p*.8+x*5),console.log("🔽 [Below Grid] Y:",y.toFixed(1))}return Math.max(20,Math.min(y,p-20))}let l=0,u=Math.abs(Ci(i[0].toneNote)-n);for(let p=1;p<i.length;p++){const y=Ci(i[p].toneNote),x=Math.abs(y-n);x<u&&(u=x,l=p)}const d=Ds(l,T.state);console.log("🎯 [Grid Match] Y:",d.toFixed(1),"row:",l);const v=Math.max(20,Math.min(d,this.canvas.height-20));return v!==d&&console.log("🔒 [Clamped] From",d.toFixed(1),"to",v.toFixed(1)),v}canvasYToViewportY(n){const i=It.getViewportInfo();return rn.canvasToViewportY(n,i)}isCanvasYVisible(n){const i=this.canvasYToViewportY(n),a=It.getViewportInfo();return i>=0&&i<=a.viewportHeight}}const Kl=new Ub;class Xb{constructor(){this.canvas=null,this.ctx=null,this.isInitialized=!1,this.animationFrameId=null,this.lastHistoryLength=0}initialize(){if(this.canvas=document.getElementById("pitch-paint-canvas"),!this.canvas){B.error("PaintCanvas","Could not find #pitch-paint-canvas element",null,"paint");return}if(this.ctx=this.canvas.getContext("2d"),!document.getElementById("pitch-canvas-wrapper")){B.error("PaintCanvas","Could not find #pitch-canvas-wrapper element",null,"paint");return}T.on("paintHistoryChanged",()=>this.render()),T.on("layoutConfigChanged",()=>this.resize()),T.on("micPaintStateChanged",i=>{i?this.startRendering():this.stopRendering()}),this.resize(),this.isInitialized=!0}startRendering(){this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>this.animationLoop()))}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animationLoop(){T.state.paint.paintHistory.length!==this.lastHistoryLength&&(this.render(),this.lastHistoryLength=T.state.paint.paintHistory.length),this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}resize(){if(!this.canvas)return;const n=document.getElementById("pitch-canvas-wrapper");setTimeout(()=>{const i=document.getElementById("pitch-grid-container"),a=i?i.clientHeight:n.clientHeight;B.debug("PaintCanvas","Height Debug (DEFERRED)",{canvasId:"pitch-paint-canvas",currentCanvasHeight:this.canvas.height,pitchGridContainer:i==null?void 0:i.clientHeight,pitchCanvasWrapper:n==null?void 0:n.clientHeight,finalTargetHeight:a,willResize:this.canvas.width!==n.clientWidth||this.canvas.height!==a},"paint"),(this.canvas.width!==n.clientWidth||this.canvas.height!==a)&&(B.debug("PaintCanvas",`Setting pitch-paint-canvas height (DEFERRED): ${this.canvas.height} → ${a}`,null,"paint"),this.canvas.width=n.clientWidth,this.canvas.height=a,this.render())},30)}render(){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const n=T.state.paint.paintHistory;n.length!==0&&this.renderPaintTrail(n)}renderPaintTrail(n){if(n.length<2)return;const i=n.map(r=>{const l=Kl.calculateXFromTime(r.musicalTime),u=Kl.midiToY(r.midi);return l===null||u===null?null:{...r,x:l,y:u}}).filter(r=>r!==null);if(i.length<2)return;const a=T.state.paint.paintSettings.opacity/100;this.ctx.globalAlpha=a,this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let r=1;r<i.length;r++){const l=i[r-1],u=i[r];u.timestamp-l.timestamp>200||this.drawPaintSegment(l,u)}this.ctx.globalAlpha=1}drawPaintSegment(n,i){const a=this.ctx.createLinearGradient(n.x,n.y,i.x,i.y);a.addColorStop(0,`rgb(${n.color.join(",")})`),a.addColorStop(1,`rgb(${i.color.join(",")})`),this.ctx.strokeStyle=a,this.ctx.lineWidth=(n.thickness+i.thickness)/2,this.ctx.beginPath(),this.ctx.moveTo(n.x,n.y),this.ctx.lineTo(i.x,i.y),this.ctx.stroke()}addPaintPoint(n,i){const a=Jl(i),r={musicalTime:n,midi:i,color:a,timestamp:performance.now(),thickness:T.state.paint.paintSettings.thickness};T.addPaintPoint(r)}clear(){T.clearPaintHistory()}}const Cc=new Xb;var El,wu;function Yb(){if(wu)return El;wu=1;function s(n){if(this.size=n|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=n<<1;for(var i=new Array(this.size*2),a=0;a<i.length;a+=2){const p=Math.PI*a/this.size;i[a]=Math.cos(p),i[a+1]=-Math.sin(p)}this.table=i;for(var r=0,l=1;this.size>l;l<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var u=0;u<this._bitrev.length;u++){this._bitrev[u]=0;for(var d=0;d<this._width;d+=2){var v=this._width-d-2;this._bitrev[u]|=(u>>>d&3)<<v}}this._out=null,this._data=null,this._inv=0}return El=s,s.prototype.fromComplexArray=function(i,a){for(var r=a||new Array(i.length>>>1),l=0;l<i.length;l+=2)r[l>>>1]=i[l];return r},s.prototype.createComplexArray=function(){const i=new Array(this._csize);for(var a=0;a<i.length;a++)i[a]=0;return i},s.prototype.toComplexArray=function(i,a){for(var r=a||this.createComplexArray(),l=0;l<r.length;l+=2)r[l]=i[l>>>1],r[l+1]=0;return r},s.prototype.completeSpectrum=function(i){for(var a=this._csize,r=a>>>1,l=2;l<r;l+=2)i[a-l]=i[l],i[a-l+1]=-i[l+1]},s.prototype.transform=function(i,a){if(i===a)throw new Error("Input and output buffers must be different");this._out=i,this._data=a,this._inv=0,this._transform4(),this._out=null,this._data=null},s.prototype.realTransform=function(i,a){if(i===a)throw new Error("Input and output buffers must be different");this._out=i,this._data=a,this._inv=0,this._realTransform4(),this._out=null,this._data=null},s.prototype.inverseTransform=function(i,a){if(i===a)throw new Error("Input and output buffers must be different");this._out=i,this._data=a,this._inv=1,this._transform4();for(var r=0;r<i.length;r++)i[r]/=this.size;this._out=null,this._data=null},s.prototype._transform4=function(){var i=this._out,a=this._csize,r=this._width,l=1<<r,u=a/l<<1,d,v,p=this._bitrev;if(u===4)for(d=0,v=0;d<a;d+=u,v++){const g=p[v];this._singleTransform2(d,g,l)}else for(d=0,v=0;d<a;d+=u,v++){const g=p[v];this._singleTransform4(d,g,l)}var y=this._inv?-1:1,x=this.table;for(l>>=2;l>=2;l>>=2){u=a/l<<1;var _=u>>>2;for(d=0;d<a;d+=u)for(var m=d+_,f=d,b=0;f<m;f+=2,b+=l){const g=f,S=g+_,A=S+_,E=A+_,O=i[g],L=i[g+1],F=i[S],U=i[S+1],X=i[A],Q=i[A+1],ct=i[E],gt=i[E+1],_t=O,wt=L,Mt=x[b],Rt=y*x[b+1],Xt=F*Mt-U*Rt,nt=F*Rt+U*Mt,ht=x[2*b],ut=y*x[2*b+1],kt=X*ht-Q*ut,dt=X*ut+Q*ht,Lt=x[3*b],jt=y*x[3*b+1],Vt=ct*Lt-gt*jt,ce=ct*jt+gt*Lt,Ke=_t+kt,Ht=wt+dt,we=_t-kt,Ue=wt-dt,ts=Xt+Vt,xe=nt+ce,ze=y*(Xt-Vt),ve=y*(nt-ce),hs=Ke+ts,Xs=Ht+xe,Ae=Ke-ts,ln=Ht-xe,Hn=we+ve,Un=Ue-ze,Xn=we-ve,cn=Ue+ze;i[g]=hs,i[g+1]=Xs,i[S]=Hn,i[S+1]=Un,i[A]=Ae,i[A+1]=ln,i[E]=Xn,i[E+1]=cn}}},s.prototype._singleTransform2=function(i,a,r){const l=this._out,u=this._data,d=u[a],v=u[a+1],p=u[a+r],y=u[a+r+1],x=d+p,_=v+y,m=d-p,f=v-y;l[i]=x,l[i+1]=_,l[i+2]=m,l[i+3]=f},s.prototype._singleTransform4=function(i,a,r){const l=this._out,u=this._data,d=this._inv?-1:1,v=r*2,p=r*3,y=u[a],x=u[a+1],_=u[a+r],m=u[a+r+1],f=u[a+v],b=u[a+v+1],g=u[a+p],S=u[a+p+1],A=y+f,E=x+b,O=y-f,L=x-b,F=_+g,U=m+S,X=d*(_-g),Q=d*(m-S),ct=A+F,gt=E+U,_t=O+Q,wt=L-X,Mt=A-F,Rt=E-U,Xt=O-Q,nt=L+X;l[i]=ct,l[i+1]=gt,l[i+2]=_t,l[i+3]=wt,l[i+4]=Mt,l[i+5]=Rt,l[i+6]=Xt,l[i+7]=nt},s.prototype._realTransform4=function(){var i=this._out,a=this._csize,r=this._width,l=1<<r,u=a/l<<1,d,v,p=this._bitrev;if(u===4)for(d=0,v=0;d<a;d+=u,v++){const Qn=p[v];this._singleRealTransform2(d,Qn>>>1,l>>>1)}else for(d=0,v=0;d<a;d+=u,v++){const Qn=p[v];this._singleRealTransform4(d,Qn>>>1,l>>>1)}var y=this._inv?-1:1,x=this.table;for(l>>=2;l>=2;l>>=2){u=a/l<<1;var _=u>>>1,m=_>>>1,f=m>>>1;for(d=0;d<a;d+=u)for(var b=0,g=0;b<=f;b+=2,g+=l){var S=d+b,A=S+m,E=A+m,O=E+m,L=i[S],F=i[S+1],U=i[A],X=i[A+1],Q=i[E],ct=i[E+1],gt=i[O],_t=i[O+1],wt=L,Mt=F,Rt=x[g],Xt=y*x[g+1],nt=U*Rt-X*Xt,ht=U*Xt+X*Rt,ut=x[2*g],kt=y*x[2*g+1],dt=Q*ut-ct*kt,Lt=Q*kt+ct*ut,jt=x[3*g],Vt=y*x[3*g+1],ce=gt*jt-_t*Vt,Ke=gt*Vt+_t*jt,Ht=wt+dt,we=Mt+Lt,Ue=wt-dt,ts=Mt-Lt,xe=nt+ce,ze=ht+Ke,ve=y*(nt-ce),hs=y*(ht-Ke),Xs=Ht+xe,Ae=we+ze,ln=Ue+hs,Hn=ts-ve;if(i[S]=Xs,i[S+1]=Ae,i[A]=ln,i[A+1]=Hn,b===0){var Un=Ht-xe,Xn=we-ze;i[E]=Un,i[E+1]=Xn;continue}if(b!==f){var cn=Ue,Yt=-ts,Sn=Ht,Ys=-we,Yn=-y*hs,Lo=-y*ve,Fi=-y*ze,Zn=-y*xe,Gr=cn+Yn,Bi=Yt+Lo,qi=Sn+Zn,Fo=Ys-Fi,Bo=d+m-b,Tn=d+_-b;i[Bo]=Gr,i[Bo+1]=Bi,i[Tn]=qi,i[Tn+1]=Fo}}}},s.prototype._singleRealTransform2=function(i,a,r){const l=this._out,u=this._data,d=u[a],v=u[a+r],p=d+v,y=d-v;l[i]=p,l[i+1]=0,l[i+2]=y,l[i+3]=0},s.prototype._singleRealTransform4=function(i,a,r){const l=this._out,u=this._data,d=this._inv?-1:1,v=r*2,p=r*3,y=u[a],x=u[a+r],_=u[a+v],m=u[a+p],f=y+_,b=y-_,g=x+m,S=d*(x-m),A=f+g,E=b,O=-S,L=f-g,F=b,U=S;l[i]=A,l[i+1]=0,l[i+2]=E,l[i+3]=O,l[i+4]=L,l[i+5]=0,l[i+6]=F,l[i+7]=U},El}var Zb=Yb();const Qb=am(Zb);class Po{constructor(n,i){ms(this,"_inputLength");ms(this,"_fft");ms(this,"_bufferSupplier");ms(this,"_paddedInputBuffer");ms(this,"_transformBuffer");ms(this,"_inverseBuffer");if(n<1)throw new Error("Input length must be at least one");this._inputLength=n,this._fft=new Qb(t0(2*n)),this._bufferSupplier=i,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(n){return new Po(n,i=>new Float32Array(i))}static forFloat64Array(n){return new Po(n,i=>new Float64Array(i))}static forNumberArray(n){return new Po(n,i=>Array(i))}get inputLength(){return this._inputLength}autocorrelate(n,i=this._bufferSupplier(n.length)){if(n.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${n.length}`);for(let r=0;r<n.length;r++)this._paddedInputBuffer[r]=n[r];for(let r=n.length;r<this._paddedInputBuffer.length;r++)this._paddedInputBuffer[r]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const a=this._transformBuffer;for(let r=0;r<a.length;r+=2)a[r]=a[r]*a[r]+a[r+1]*a[r+1],a[r+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let r=0;r<n.length;r++)i[r]=this._inverseBuffer[2*r];return i}}function Jb(s){const n=[];let i=!1,a=-1/0,r=-1;for(let l=1;l<s.length-1;l++)s[l-1]<=0&&s[l]>0?(i=!0,r=l,a=s[l]):s[l-1]>0&&s[l]<=0?(i=!1,r!==-1&&n.push(r)):i&&s[l]>a&&(a=s[l],r=l);return n}function Kb(s,n){const[i,a,r]=[s-1,s,s+1],[l,u,d]=[n[i],n[a],n[r]],v=l/2-u+d/2,p=-(l/2)*(a+r)+u*(i+r)-d/2*(i+a),y=l*a*r/2-u*i*r+d*i*a/2,x=-p/(2*v),_=v*x*x+p*x+y;return[x,_]}class Wn{constructor(n,i){ms(this,"_autocorrelator");ms(this,"_nsdfBuffer");ms(this,"_clarityThreshold",.9);ms(this,"_minVolumeAbsolute",0);ms(this,"_maxInputAmplitude",1);this._autocorrelator=new Po(n,i),this._nsdfBuffer=i(n)}static forFloat32Array(n){return new Wn(n,i=>new Float32Array(i))}static forFloat64Array(n){return new Wn(n,i=>new Float64Array(i))}static forNumberArray(n){return new Wn(n,i=>Array(i))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(n){if(!Number.isFinite(n)||n<=0||n>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=n}set minVolumeAbsolute(n){if(!Number.isFinite(n)||n<0||n>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=n}set minVolumeDecibels(n){if(!Number.isFinite(n)||n>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(n/10)}set maxInputAmplitude(n){if(!Number.isFinite(n)||n<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=n}findPitch(n,i){if(this._belowMinimumVolume(n))return[0,0];this._nsdf(n);const a=Jb(this._nsdfBuffer);if(a.length===0)return[0,0];const r=Math.max(...a.map(v=>this._nsdfBuffer[v])),l=a.find(v=>this._nsdfBuffer[v]>=this._clarityThreshold*r),[u,d]=Kb(l,this._nsdfBuffer);return[i/u,Math.min(d,1)]}_belowMinimumVolume(n){if(this._minVolumeAbsolute===0)return!1;let i=0;for(let a=0;a<n.length;a++)i+=n[a]**2;return Math.sqrt(i/n.length)<this._minVolumeAbsolute}_nsdf(n){this._autocorrelator.autocorrelate(n,this._nsdfBuffer);let i=2*this._nsdfBuffer[0],a;for(a=0;a<this._nsdfBuffer.length&&i>0;a++)this._nsdfBuffer[a]=2*this._nsdfBuffer[a]/i,i-=n[a]**2+n[n.length-a-1]**2;for(;a<this._nsdfBuffer.length;a++)this._nsdfBuffer[a]=0}}function t0(s){return s--,s|=s>>1,s|=s>>2,s|=s>>4,s|=s>>8,s|=s>>16,s++,s}class e0{constructor(){this.mic=null,this.analyser=null,this.detector=null,this.animationFrameId=null,this.isInitialized=!1,this.lastLogTime=0,this.logThrottleMs=5e3,this.config={FFT_SIZE:2048,MIN_PITCH_HZ:60,MAX_PITCH_HZ:1600,MIN_VOLUME_DB:-60}}async initialize(){if(!this.isInitialized){console.log("PitchPaintService: Starting initialization...");try{console.log("PitchPaintService: Starting Tone.js..."),await rt.start(),console.log("PitchPaintService: Creating UserMedia..."),this.mic=new rt.UserMedia,console.log("PitchPaintService: Creating Analyser..."),this.analyser=new rt.Analyser("waveform",this.config.FFT_SIZE),console.log("PitchPaintService: Creating gain node for microphone..."),this.micGain=new rt.Gain(2),console.log("🔍 [Pitchy] Initializing PitchDetector with analyser size:",this.analyser.size),console.log("🔍 [Pitchy] PitchDetector class available:",!!Wn),console.log("🔍 [Pitchy] PitchDetector.forFloat32Array method:",typeof Wn.forFloat32Array),this.detector=Wn.forFloat32Array(this.analyser.size),console.log("🎯 [Pitchy] Detector created successfully:",{detectorExists:!!this.detector,detectorType:this.detector?this.detector.constructor.name:"null",analyserSize:this.analyser.size,fftSize:this.config.FFT_SIZE}),console.log("PitchPaintService: Creating splitter..."),this.micSplitter=new rt.Gain(1),console.log("PitchPaintService: Requesting microphone access..."),await this.mic.open(),console.log("PitchPaintService: Connecting audio chain..."),this.mic.connect(this.micGain),this.micGain.connect(this.micSplitter),this.micSplitter.connect(this.analyser),this.isInitialized=!0,console.log("PitchPaintService: Initialized successfully")}catch(n){throw console.error("PitchPaintService: Failed to initialize microphone:",n),T.setMicPaintActive(!1),n}}}startDetection(){!this.isInitialized||T.state.paint.isDetecting||(T.state.paint.isDetecting=!0,console.log("🎨 [PitchPaintService] Starting detection loop."),console.log("🎨 [PitchPaintService] Paint state:",T.state.paint),console.log("🎨 [PitchPaintService] Config:",this.config),console.log("🎨 [PitchPaintService] Pitchy detector initialized:",!!this.detector),this.animationLoop())}stopDetection(){T.state.paint.isDetecting&&(T.state.paint.isDetecting=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null,console.log("PitchPaintService: Stopped detection loop.")))}animationLoop(){if(!T.state.paint.isDetecting){this.animationFrameId=null;return}const n=this.analyser.getValue(),i=Math.sqrt(n.reduce((v,p)=>v+p*p,0)/n.length),a=performance.now();let r=null,l=0;if(i>1e-5)try{[r,l]=this.detector.findPitch(n,rt.context.sampleRate),r==null&&(r=null),l==null&&(l=0),r&&l>.1&&a-this.lastLogTime>this.logThrottleMs&&(console.log("🎯 [Pitch] Detected:",r.toFixed(1)+"Hz, clarity:",l.toFixed(2)),this.lastLogTime=a)}catch{r=null,l=0}const u=T.state.paint.paintSettings.minClarity;if(r&&l>u&&r>this.config.MIN_PITCH_HZ&&r<this.config.MAX_PITCH_HZ){const v=this.frequencyToMidi(r),p={frequency:r,clarity:l,midi:v,pitchClass:Math.round(v)%12,timestamp:a};T.setDetectedPitch(p)}else T.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:a});this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}frequencyToMidi(n){return 12*Math.log2(n/440)+69}testMicrophoneInput(){if(!this.isInitialized)return console.log("❌ [MicTest] PitchPaintService not initialized"),!1;const n=this.analyser.getValue(),i=Math.sqrt(n.reduce((a,r)=>a+r*r,0)/n.length);return console.log("🎤 [MicTest] Microphone Test Results:",{isInitialized:this.isInitialized,micOpen:this.mic&&this.mic.state==="started",contextState:rt.context.state,sampleRate:rt.context.sampleRate,waveformLength:n.length,rms:i.toFixed(6),hasInput:i>1e-4,suggestion:i<=1e-4?"Try speaking, singing, or making noise near your microphone":"Microphone is detecting audio!"}),i>1e-4}async dispose(){this.stopDetection(),this.mic&&(this.mic.close(),this.mic=null),this.micGain&&(this.micGain.dispose(),this.micGain=null),this.micSplitter&&(this.micSplitter.dispose(),this.micSplitter=null),this.analyser=null,this.detector=null,this.isInitialized=!1,console.log("PitchPaintService: Disposed.")}}const Pr=new e0,s0=Object.freeze(Object.defineProperty({__proto__:null,default:Pr},Symbol.toStringTag,{value:"Module"}));class n0{constructor(){this.elements={},this.draggableControls={}}initialize(){this.cacheDOMElements(),this.elements.toggleBtn&&(this.initializeDraggableControls(),this.setupEventListeners(),this.updateUI(),T.on("micPaintStateChanged",()=>this.updateUI()),T.on("paintHistoryChanged",()=>this.updateUI()),T.on("paintSettingsChanged",()=>this.updateUI()))}cacheDOMElements(){this.elements.toggleBtn=document.getElementById("mic-paint-toggle"),this.elements.clearBtn=document.getElementById("paint-clear-btn")}initializeDraggableControls(){const n={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0};this.draggableControls.thickness=new Ao("#trail-thickness",{...n,value:6,min:2,max:20}),this.draggableControls.opacity=new Ao("#trail-opacity",{...n,value:80,min:20,max:100})}setupEventListeners(){this.elements.toggleBtn.addEventListener("click",()=>this.handleMicPaintToggle()),this.elements.clearBtn.addEventListener("click",()=>this.handleClearPaint()),this.draggableControls.thickness.onChange=n=>{T.setPaintSettings({thickness:n})},this.draggableControls.opacity.onChange=n=>{T.setPaintSettings({opacity:n})}}async handleMicPaintToggle(){const n=T.state.paint.isMicPaintActive;if(this.elements.toggleBtn.disabled=!0,n)Pr.stopDetection(),T.setMicPaintActive(!1);else try{await Pr.initialize(),T.setMicPaintActive(!0),Pr.startDetection()}catch{alert("Microphone access is required for Pitch Painting. Please check your browser permissions and try again."),T.setMicPaintActive(!1)}this.elements.toggleBtn.disabled=!1}handleClearPaint(){confirm("Are you sure you want to clear the painted pitch trail? This cannot be undone.")&&Cc.clear()}updateUI(){const{isMicPaintActive:n,paintHistory:i,paintSettings:a}=T.state.paint;this.elements.toggleBtn.textContent=n?"Mic Paint (ON)":"Mic Paint (OFF)",this.elements.toggleBtn.classList.toggle("active",n),this.elements.clearBtn.disabled=i.length===0,this.draggableControls.thickness&&this.draggableControls.thickness.value!==a.thickness&&this.draggableControls.thickness.passiveUpdate(a.thickness),this.draggableControls.opacity&&this.draggableControls.opacity.value!==a.opacity&&this.draggableControls.opacity.passiveUpdate(a.opacity)}}const i0=new n0,o0="modulepreload",r0=function(s){return"/Student-Notation/"+s},xu={},Su=function(n,i,a){let r=Promise.resolve();if(i&&i.length>0){document.getElementsByTagName("link");const u=document.querySelector("meta[property=csp-nonce]"),d=(u==null?void 0:u.nonce)||(u==null?void 0:u.getAttribute("nonce"));r=Promise.allSettled(i.map(v=>{if(v=r0(v),v in xu)return;xu[v]=!0;const p=v.endsWith(".css"),y=p?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${v}"]${y}`))return;const x=document.createElement("link");if(x.rel=p?"stylesheet":o0,p||(x.as="script"),x.crossOrigin="",x.href=v,d&&x.setAttribute("nonce",d),document.head.appendChild(x),p)return new Promise((_,m)=>{x.addEventListener("load",_),x.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${v}`)))})}))}function l(u){const d=new Event("vite:preloadError",{cancelable:!0});if(d.payload=u,window.dispatchEvent(d),!d.defaultPrevented)throw u}return r.then(u=>{for(const d of u||[])d.status==="rejected"&&l(d.reason);return n().catch(l)})};var Er={exports:{}},a0=Er.exports,Tu;function l0(){return Tu||(Tu=1,function(s,n){(function(a,r){s.exports=r()})(a0,function(){return function(i){var a={};function r(l){if(a[l])return a[l].exports;var u=a[l]={exports:{},id:l,loaded:!1};return i[l].call(u.exports,u,u.exports,r),u.loaded=!0,u.exports}return r.m=i,r.c=a,r.p="",r(0)}([function(i,a,r){var l=function(d){return d&&d.__esModule?d.default:d},u=l(r(1));i.exports=u},function(i,a,r){var l=function(ct){return ct&&ct.__esModule?ct:{default:ct}},u=function(ct){return ct&&ct.__esModule?ct.default:ct},d=function(){function ct(gt,_t){for(var wt in _t){var Mt=_t[wt];Mt.configurable=!0,Mt.value&&(Mt.writable=!0)}Object.defineProperties(gt,_t)}return function(gt,_t,wt){return _t&&ct(gt.prototype,_t),wt&&ct(gt,wt),gt}}(),v=function(ct,gt){if(!(ct instanceof gt))throw new TypeError("Cannot call a class as a function")};a.colors=U,a.context=X,a.clock=Q,Object.defineProperty(a,"__esModule",{value:!0});var p=u(r(2)),y=u(r(5)),x=u(r(38)),_=u(r(40)),m=l(r(39)),f=r(28),b=r(41),g=r(27),S=r(26),A=r(25),E=u(r(42)),O=u(r(29)),L=function(){function ct(gt){v(this,ct);for(var _t in p)this[_t]=p[_t];for(var _t in y)this[_t]=y[_t];var wt={Rack:x},Mt={Counter:f,Radio:b,Drunk:g,Sequence:S,Matrix:A};for(var _t in Mt)this[_t]=Mt[_t];for(var _t in wt)this[_t]=wt[_t];var Rt=window.AudioContext||window.webkitAudioContext;this._context=gt||new Rt,this.tune=new _,this.note=this.tune.note.bind(this.tune),this.clock=new E(this._context),this.clock.start(),this.Interval=O,this.colors={accent:"#2bb",fill:"#eee",light:"#fff",dark:"#333",mediumLight:"#ccc",mediumDark:"#666"},this.transform=m,this.add=m.add,this.Add={};for(var _t in p)this.Add[_t]=m.add.bind(this,_t);var Xt=document.createElement("style");Xt.type="text/css",Xt.innerHTML="[nexus-ui]{height:5000px;width:5000px}";var nt=document.head;nt.insertBefore(Xt,nt.firstElementChild)}return d(ct,{context:{get:function(){return this._context},set:function(gt){this.clock.stop(),this._context=gt,this.clock=new E(this.context),this.clock.start()}}}),ct}(),F=new L;function U(){return F.colors}function X(){return F.context}function Q(){return F.clock}a.default=F},function(i,a,r){i.exports={Position:r(3),Slider:r(14),Toggle:r(15),Button:r(16),TextButton:r(18),RadioButton:r(19),Number:r(20),Select:r(21),Dial:r(22),Piano:r(23),Sequencer:r(24),Pan2D:r(30),Tilt:r(31),Multislider:r(32),Pan:r(33),Envelope:r(34),Spectrogram:r(35),Meter:r(36),Oscilloscope:r(37)}},function(i,a,r){var l=function(b){return b&&b.__esModule?b:{default:b}},u=function(){function b(g,S){for(var A in S){var E=S[A];E.configurable=!0,E.value&&(E.writable=!0)}Object.defineProperties(g,S)}return function(g,S,A){return S&&b(g.prototype,S),A&&b(g,A),g}}(),d=function b(g,S,A){var E=Object.getOwnPropertyDescriptor(g,S);if(E===void 0){var O=Object.getPrototypeOf(g);return O===null?void 0:b(O,S,A)}else{if("value"in E&&E.writable)return E.value;var L=E.get;return L===void 0?void 0:L.call(A)}},v=function(b,g){if(typeof g!="function"&&g!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof g);b.prototype=Object.create(g&&g.prototype,{constructor:{value:b,enumerable:!1,writable:!0,configurable:!0}}),g&&(b.__proto__=g)},p=function(b,g){if(!(b instanceof g))throw new TypeError("Cannot call a class as a function")},y=r(4),x=r(6),_=r(11),m=l(r(12)),f=function(b){function g(){p(this,g);var S=["value"],A={size:[200,200],mode:"absolute",minX:0,maxX:1,stepX:0,x:.5,minY:0,maxY:1,stepY:0,y:.5};d(Object.getPrototypeOf(g.prototype),"constructor",this).call(this,arguments,S,A),this._x=new _(this.settings.minX,this.settings.maxX,this.settings.stepX,this.settings.x),this._y=new _(this.settings.minY,this.settings.maxY,this.settings.stepY,this.settings.y),this.position={x:new m.Handle(this.settings.mode,"horizontal",[0,this.width],[this.height,0]),y:new m.Handle(this.settings.mode,"vertical",[0,this.width],[this.height,0])},this.position.x.value=this._x.normalized,this.position.y.value=this._y.normalized,this.init(),this.render()}return v(g,b),u(g,{buildInterface:{value:function(){this.knob=y.create("circle"),this.element.appendChild(this.knob)}},sizeInterface:{value:function(){this.position.x.resize([0,this.width],[this.height,0]),this.position.y.resize([0,this.width],[this.height,0]),this._minDimension=Math.min(this.width,this.height),this.knobRadius={off:~~(this._minDimension/100)*5+5},this.knobRadius.on=this.knobRadius.off*2,this.knob.setAttribute("cx",this.width/2),this.knob.setAttribute("cy",this.height/2),this.knob.setAttribute("r",this.knobRadius.off)}},colorInterface:{value:function(){this.element.style.backgroundColor=this.colors.fill,this.knob.setAttribute("fill",this.colors.accent)}},render:{value:function(){this.clicked?this.knob.setAttribute("r",this.knobRadius.on):this.knob.setAttribute("r",this.knobRadius.off),this.knobCoordinates={x:this._x.normalized*this.width,y:this.height-this._y.normalized*this.height},this.knob.setAttribute("cx",this.knobCoordinates.x),this.knob.setAttribute("cy",this.knobCoordinates.y)}},click:{value:function(){this.position.x.anchor=this.mouse,this.position.y.anchor=this.mouse,this.move()}},move:{value:function(){this.clicked&&(this.position.x.update(this.mouse),this.position.y.update(this.mouse),this._x.updateNormal(this.position.x.value),this._y.updateNormal(this.position.y.value),this.emit("change",{x:this._x.value,y:this._y.value}),this.render())}},release:{value:function(){this.render()}},x:{get:function(){return this._x.value},set:function(S){this._x.update(S),this.emit("change",{x:this._x.value,y:this._y.value}),this.render()}},y:{get:function(){return this._y.value},set:function(S){this._y.update(S),this.emit("change",{x:this._x.value,y:this._y.value}),this.render()}},normalized:{get:function(){return{x:this._x.normalized,y:this._y.normalized}}},minX:{get:function(){return this._x.min},set:function(S){this._x.min=S,this.render()}},minY:{get:function(){return this._y.min},set:function(S){this._y.min=S,this.render()}},maxX:{get:function(){return this._x.max},set:function(S){this._x.max=S,this.render()}},maxY:{get:function(){return this._y.max},set:function(S){this._y.max=S,this.render()}},stepX:{get:function(){return this._x.step},set:function(S){this._x.step=S,this.render()}},stepY:{get:function(){return this._y.step},set:function(S){this._y.step=S,this.render()}},mode:{get:function(){return this.position.x.mode},set:function(S){this.position.x.mode=S,this.position.y.mode=S}}}),g}(x);i.exports=f},function(i,a,r){var l=r(5);i.exports={create:function(u){return document.createElementNS("http://www.w3.org/2000/svg",u)},arc:function(u,d,v,p,y){var x=l.toCartesian(v,y),_=l.toCartesian(v,p),m=y-p<=180?"0":"1",f=["M",x.x+u,x.y+d,"A",v,v,0,m,0,_.x+u,_.y+d].join(" ");return f},radialGradient:function(u,d){var v="gradient"+l.ri(1e11),p=[],y=document.createElementNS("http://www.w3.org/2000/svg","radialGradient");y.setAttribute("id",v),y.setAttribute("cx","50%"),y.setAttribute("cy","50%"),y.setAttribute("r","50%"),u.appendChild(y);for(var x=0;x<d;x++){var _=document.createElementNS("http://www.w3.org/2000/svg","stop");_.setAttribute("id","stop"+x),y.appendChild(_),p.push(_)}return{id:v,stops:p,element:y}}}},function(i,a){a.clip=function(r,l,u){return Math.min(Math.max(r,l),u)},a.normalize=function(r,l,u){return(r-l)/(u-l)},a.scale=function(r,l,u,d,v){return l===u?d:(r-l)*(v-d)/(u-l)+d},a.toPolar=function(r,l){var u=Math.sqrt(r*r+l*l),d=Math.atan2(l,r);return d<0&&(d=d+2*Math.PI),{radius:u,angle:d}},a.toCartesian=function(r,l){var u=Math.cos(l),d=Math.sin(l);return{x:r*u,y:r*d*-1}},a.prune=function(r,l){return parseFloat(r.toFixed(l))},a.invert=function(r){return a.scale(r,1,0,0,1)},a.mtof=function(r){return Math.pow(2,(r-69)/12)*440},a.interp=function(r,l,u){return r*(u-l)+l},a.pick=function(){return arguments[~~(Math.random()*arguments.length)]},a.octave=function(r){return Math.pow(2,r)},a.ri=function(r,l){l||(l=r,r=0);var u=Math.min(r,l),d=Math.max(r,l);return Math.floor(Math.random()*(d-u)+u)},a.rf=function(r,l){l||(l=r,r=0);var u=Math.min(r,l),d=Math.max(r,l);return Math.random()*(d-u)+u},a.cycle=function(r,l,u){return r++,r>=u&&(r=l),r},a.average=function(r){for(var l=0,u=0;u<r.length;u++)l+=r[u];return l/r.length},a.distance=function(r,l,u,d){var v=r-u,p=l-d;return Math.sqrt(v*v+p*p)},a.gainToDB=function(r){return 20*Math.log10(r)},a.coin=function(){var r=arguments[0]===void 0?.5:arguments[0];return a.rf(0,1)<r?1:0}},function(i,a,r){var l=function(){function g(S,A){for(var E in A){var O=A[E];O.configurable=!0,O.value&&(O.writable=!0)}Object.defineProperties(S,A)}return function(S,A,E){return A&&g(S.prototype,A),E&&g(S,E),S}}(),u=function g(S,A,E){var O=Object.getOwnPropertyDescriptor(S,A);if(O===void 0){var L=Object.getPrototypeOf(S);return L===null?void 0:g(L,A,E)}else{if("value"in O&&O.writable)return O.value;var F=O.get;return F===void 0?void 0:F.call(E)}},d=function(g,S){if(typeof S!="function"&&S!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof S);g.prototype=Object.create(S&&S.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}),S&&(g.__proto__=S)},v=function(g,S){if(!(g instanceof S))throw new TypeError("Cannot call a class as a function")},p=r(4),y=r(7),x=r(8),_=r(9),m=r(10),f=r(1).colors,b=function(g){function S(A,E,O){v(this,S),u(Object.getPrototypeOf(S.prototype),"constructor",this).call(this),this.type=this.constructor.name,this.settings=this.parseSettings(A,E,O),this.mouse={},this.wait=!1,this.colors={};var L=f();this.colors.accent=L.accent,this.colors.fill=L.fill,this.colors.light=L.light,this.colors.dark=L.dark,this.colors.mediumLight=L.mediumLight,this.colors.mediumDark=L.mediumDark}return d(S,g),l(S,{parseSettings:{value:function(E,O,L){O.unshift("target"),L.defaultSize=L.size.splice(0,2),L.size=!1;var F={target:document.body,colors:{},snapWithParent:!0,event:function(){},component:!1};for(var U in L)F[U]=L[U];for(var X=0;X<E.length;X++){var Q=E[X];if(x.isObject(Q))for(var U in Q)F[U]=Q[U];else if(typeof Q=="function")F.event=Q;else if(O.length>=1){var U=O.splice(0,1)[0];F[U]=Q}}return this.parent=y.parseElement(F.target),this.parent&&this.parent instanceof HTMLElement&&!F.component&&(this.parent.hasAttribute("nexus-ui")||this.parent.setAttribute("nexus-ui","")),F.size&&Array.isArray(F.size)&&F.snapWithParent?(this.width=F.size[0],this.height=F.size[1],this.parent.style.width=this.width+"px",this.parent.style.height=this.height+"px"):F.snapWithParent&&!F.component?(this.width=parseFloat(window.getComputedStyle(this.parent,null).getPropertyValue("width").replace("px","")),this.height=parseFloat(window.getComputedStyle(this.parent,null).getPropertyValue("height").replace("px","")),this.width==5e3&&(this.width=F.defaultSize[0],this.parent.style.width=this.parent.width=this.width+"px"),this.height==5e3&&(this.height=F.defaultSize[1],this.parent.style.height=this.parent.height=this.height+"px")):(F.size=F.defaultSize,this.width=F.size[0],this.height=F.size[1]),F.event?this.event=this.on("change",F.event):this.event=!1,F}},init:{value:function(){this.buildFrame(),this.buildInterface(),this.sizeInterface(),this.attachListeners(),this.colorInterface(),this.finalTouches()}},buildFrame:{value:function(){this.element=p.create("svg"),this.element.setAttribute("width",this.width),this.element.setAttribute("height",this.height),this.parent.appendChild(this.element)}},buildInterface:{value:function(){}},sizeInterface:{value:function(){}},colorInterface:{value:function(){}},attachListeners:{value:function(){var E=this;this.interactionTarget=this.interactionTarget||this.element,_.exists&&(this.interactionTarget.addEventListener("touchstart",function(O){return E.preTouch(O)}),this.interactionTarget.addEventListener("touchmove",function(O){return E.preTouchMove(O)}),this.interactionTarget.addEventListener("touchend",function(O){return E.preTouchRelease(O)})),this.boundPreMove=function(O){return E.preMove(O)},this.boundPreRelease=function(O){return E.preRelease(O)},this.interactionTarget.addEventListener("mousedown",function(O){return E.preClick(O)})}},finalTouches:{value:function(){this.element.style.cursor="pointer"}},preClick:{value:function(E){this.element instanceof HTMLElement&&(this.width=window.getComputedStyle(this.element,null).getPropertyValue("width").replace("px","")),this.offset=y.findPosition(this.element),this.mouse=y.locateMouse(E,this.offset),this.clicked=!0,this.click(),this.moveEvent=document.addEventListener("mousemove",this.boundPreMove),this.releaseEvent=document.addEventListener("mouseup",this.boundPreRelease),this.emit("click"),E.preventDefault(),E.stopPropagation()}},preMove:{value:function(E){var O=this;this.wait||(this.mouse=y.locateMouse(E,this.offset),this.move(),this.wait=!0,setTimeout(function(){O.wait=!1},25)),E.preventDefault(),E.stopPropagation()}},preRelease:{value:function(E){this.mouse=y.locateMouse(E,this.offset),this.clicked=!1,this.release(),this.emit("release"),document.removeEventListener("mousemove",this.boundPreMove),document.removeEventListener("mouseup",this.boundPreRelease),E.preventDefault(),E.stopPropagation()}},click:{value:function(){}},move:{value:function(){}},release:{value:function(){}},preTouch:{value:function(E){this.element instanceof HTMLElement&&(this.width=window.getComputedStyle(this.element,null).getPropertyValue("width").replace("px","")),this.offset=y.findPosition(this.element),this.mouse=y.locateTouch(E,this.offset),this.clicked=!0,this.touch(E),this.emit("click"),E.preventDefault(),E.stopPropagation()}},preTouchMove:{value:function(E){this.clicked&&(this.mouse=y.locateTouch(E,this.offset),this.touchMove(),E.preventDefault(),E.stopPropagation())}},preTouchRelease:{value:function(E){this.mouse=y.locateTouch(E,this.offset),this.clicked=!1,this.touchRelease(),this.emit("release"),E.preventDefault(),E.stopPropagation()}},touch:{value:function(){this.click()}},touchMove:{value:function(){this.move()}},touchRelease:{value:function(){this.release()}},resize:{value:function(E,O){this.width=E,this.height=O,this.parent.style.width=this.width+"px",this.parent.style.height=this.height+"px",this.element.setAttribute("width",this.width),this.element.setAttribute("height",this.height),this.sizeInterface()}},empty:{value:function(){for(;this.element.lastChild;)this.element.removeChild(this.element.lastChild)}},destroy:{value:function(){this.empty(),this.parent.removeChild(this.element),this.removeAllListeners(),this.instrument&&delete this.instrument[this.id],this.customDestroy()}},customDestroy:{value:function(){}},colorize:{value:function(E,O){this.colors[E]=O,this.colorInterface()}}}),S}(m);i.exports=b},function(i,a){a.findPosition=function(r){var l=r.getBoundingClientRect(),u=l.top+window.scrollY,d=l.left+window.scrollX;return{top:u,left:d}},a.parseElement=function(r){return typeof r=="string"&&(r=document.getElementById(r.replace("#",""))),r instanceof HTMLElement||r instanceof SVGElement?r:"No valid parent argument"},a.locateMouse=function(r,l){return{x:r.pageX-l.left,y:r.pageY-l.top}},a.locateTouch=function(r,l){return{x:r.targetTouches.length?r.targetTouches[0].pageX-l.left:!1,y:r.targetTouches.length?r.targetTouches[0].pageY-l.top:!1}},a.SmartCanvas=function(r){var l=this;this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),r.appendChild(this.element),this.resize=function(u,d){l.element.width=u*2,l.element.height=d*2,l.element.style.width=u+"px",l.element.style.height=d+"px"}}},function(i,a){a.isObject=function(r){return typeof r=="object"&&!Array.isArray(r)&&r!==null&&!(r instanceof SVGElement)&&!(r instanceof HTMLElement)},a.setInputFilter=function(r,l){["input","keydown","keyup","mousedown","mouseup","select","contextmenu","drop"].forEach(function(u){r.addEventListener(u,function(){l(this.value)?(this.oldValue=this.value,this.oldSelectionStart=this.selectionStart,this.oldSelectionEnd=this.selectionEnd):this.hasOwnProperty("oldValue")?(this.value=this.oldValue,this.setSelectionRange(this.oldSelectionStart,this.oldSelectionEnd)):this.value=""})})}},function(i,a){a.exists="ontouchstart"in document.documentElement},function(i,a){function r(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}i.exports=r,r.EventEmitter=r,r.prototype._events=void 0,r.prototype._maxListeners=void 0,r.defaultMaxListeners=10,r.prototype.setMaxListeners=function(p){if(!u(p)||p<0||isNaN(p))throw TypeError("n must be a positive number");return this._maxListeners=p,this},r.prototype.emit=function(p){var y,x,_,m,f,b;if(this._events||(this._events={}),p==="error"&&(!this._events.error||d(this._events.error)&&!this._events.error.length)){if(y=arguments[1],y instanceof Error)throw y;var g=new Error('Uncaught, unspecified "error" event. ('+y+")");throw g.context=y,g}if(x=this._events[p],v(x))return!1;if(l(x))switch(arguments.length){case 1:x.call(this);break;case 2:x.call(this,arguments[1]);break;case 3:x.call(this,arguments[1],arguments[2]);break;default:m=Array.prototype.slice.call(arguments,1),x.apply(this,m)}else if(d(x))for(m=Array.prototype.slice.call(arguments,1),b=x.slice(),_=b.length,f=0;f<_;f++)b[f].apply(this,m);return!0},r.prototype.addListener=function(p,y){var x;if(!l(y))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",p,l(y.listener)?y.listener:y),this._events[p]?d(this._events[p])?this._events[p].push(y):this._events[p]=[this._events[p],y]:this._events[p]=y,d(this._events[p])&&!this._events[p].warned&&(v(this._maxListeners)?x=r.defaultMaxListeners:x=this._maxListeners,x&&x>0&&this._events[p].length>x&&(this._events[p].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[p].length),typeof console.trace=="function"&&console.trace())),this},r.prototype.on=r.prototype.addListener,r.prototype.once=function(p,y){if(!l(y))throw TypeError("listener must be a function");var x=!1;function _(){this.removeListener(p,_),x||(x=!0,y.apply(this,arguments))}return _.listener=y,this.on(p,_),this},r.prototype.removeListener=function(p,y){var x,_,m,f;if(!l(y))throw TypeError("listener must be a function");if(!this._events||!this._events[p])return this;if(x=this._events[p],m=x.length,_=-1,x===y||l(x.listener)&&x.listener===y)delete this._events[p],this._events.removeListener&&this.emit("removeListener",p,y);else if(d(x)){for(f=m;f-- >0;)if(x[f]===y||x[f].listener&&x[f].listener===y){_=f;break}if(_<0)return this;x.length===1?(x.length=0,delete this._events[p]):x.splice(_,1),this._events.removeListener&&this.emit("removeListener",p,y)}return this},r.prototype.removeAllListeners=function(p){var y,x;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[p]&&delete this._events[p],this;if(arguments.length===0){for(y in this._events)y!=="removeListener"&&this.removeAllListeners(y);return this.removeAllListeners("removeListener"),this._events={},this}if(x=this._events[p],l(x))this.removeListener(p,x);else if(x)for(;x.length;)this.removeListener(p,x[x.length-1]);return delete this._events[p],this},r.prototype.listeners=function(p){var y;return!this._events||!this._events[p]?y=[]:l(this._events[p])?y=[this._events[p]]:y=this._events[p].slice(),y},r.prototype.listenerCount=function(p){if(this._events){var y=this._events[p];if(l(y))return 1;if(y)return y.length}return 0},r.listenerCount=function(p,y){return p.listenerCount(y)};function l(p){return typeof p=="function"}function u(p){return typeof p=="number"}function d(p){return typeof p=="object"&&p!==null}function v(p){return p===void 0}},function(i,a,r){var l=function(){function p(y,x){for(var _ in x){var m=x[_];m.configurable=!0,m.value&&(m.writable=!0)}Object.defineProperties(y,x)}return function(y,x,_){return x&&p(y.prototype,x),_&&p(y,_),y}}(),u=function(p,y){if(!(p instanceof y))throw new TypeError("Cannot call a class as a function")},d=r(5),v=function(){function p(){var y=arguments[0]===void 0?0:arguments[0],x=arguments[1]===void 0?1:arguments[1],_=arguments[2]===void 0?0:arguments[2],m=arguments[3]===void 0?0:arguments[3];u(this,p),this.min=y,this.max=x,this.step=_,this.value=m,this.changed=!1,this.oldValue=!1,this.update(this.value)}return l(p,{update:{value:function(x){return this.step?this.value=d.clip(Math.round((x-this.min)/this.step)*this.step+this.min,this.min,this.max):this.value=d.clip(x,this.min,this.max),this.oldValue!==this.value?(this.oldValue=this.value,this.changed=!0):this.changed=!1,this.value}},updateNormal:{value:function(x){return this.value=d.scale(x,0,1,this.min,this.max),this.update(this.value)}},normalized:{get:function(){return d.normalize(this.value,this.min,this.max)}}}),p}();i.exports=v},function(i,a,r){var l=function(y){return y&&y.__esModule?y.default:y},u=function(){function y(x,_){for(var m in _){var f=_[m];f.configurable=!0,f.value&&(f.writable=!0)}Object.defineProperties(x,_)}return function(x,_,m){return _&&y(x.prototype,_),m&&y(x,m),x}}(),d=function(y,x){if(!(y instanceof x))throw new TypeError("Cannot call a class as a function")};Object.defineProperty(a,"__esModule",{value:!0});var v=l(r(5)),p=l(r(13));a.Handle=function(){function y(){var x=arguments[0]===void 0?"absolute":arguments[0],_=arguments[1]===void 0?"vertical":arguments[1],m=arguments[2]===void 0?[0,100]:arguments[2],f=arguments[3]===void 0?[0,100]:arguments[3];d(this,y),this.mode=x,this.direction=_,this.previous=0,this.value=0,this.sensitivity=1,this.resize(m,f)}return u(y,{resize:{value:function(_,m){this.boundary={min:{x:_[0],y:m[0]},max:{x:_[1],y:m[1]},center:{x:(_[1]-_[0])/2+_[0],y:(m[1]-m[0])/2+m[0]}}}},anchor:{set:function(x){this._anchor=this.convertPositionToValue(x)},get:function(){return this._anchor}},update:{value:function(_){if(this.mode==="relative"){var m=this.convertPositionToValue(_)-this.anchor;Math.abs(m)>.5&&(m=0),this.anchor=_,this.value=this.value+m*this.sensitivity}else this.value=this.convertPositionToValue(_);this.value=v.clip(this.value,0,1)}},convertPositionToValue:{value:function(_){switch(this.direction){case"radial":var m=v.toPolar(_.x-this.boundary.center.x,_.y-this.boundary.center.y);return m=m.angle/(Math.PI*2),m=(m-.25+1)%1,m;case"vertical":return v.scale(_.y,this.boundary.min.y,this.boundary.max.y,0,1);case"horizontal":return v.scale(_.x,this.boundary.min.x,this.boundary.max.x,0,1)}}}}),y}(),a.Button=function(){function y(){var x=arguments[0]===void 0?"button":arguments[0];d(this,y),this.mode=x,this.state=new p,this.paintbrush=!1}return u(y,{click:{value:function(){switch(this.mode){case"impulse":this.state.on(),this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.state.off.bind(this),30),this.emit("change",this.state);break;case"button":this.turnOn(),this.emit("change",this.state);break;case"aftertouch":this.position={x:v.clip(this.mouse.x/this.width,0,1),y:v.clip(1-this.mouse.y/this.height,0,1)},this.turnOn(),this.emit("change",{state:this.state,x:this.position.x,y:this.position.y});break;case"toggle":this.flip(),this.emit("change",this.state);break}}},move:{value:function(){this.mode==="aftertouch"&&(this.position={x:v.clip(this.mouse.x/this.width,0,1),y:v.clip(1-this.mouse.y/this.height,0,1)},this.emit("change",{state:this.state,x:this.position.x,y:this.position.y}),this.render())}},release:{value:function(){switch(this.mode){case"button":this.turnOff(),this.emit("change",this.state);break;case"aftertouch":this.turnOff(),this.position={x:this.mouse.x/this.width,y:1-this.mouse.y/this.height},this.emit("change",{state:this.state,x:this.position.x,y:this.position.y});break}}}}),y}()},function(i,a){var r=function(){function d(v,p){for(var y in p){var x=p[y];x.configurable=!0,x.value&&(x.writable=!0)}Object.defineProperties(v,p)}return function(v,p,y){return p&&d(v.prototype,p),y&&d(v,y),v}}(),l=function(d,v){if(!(d instanceof v))throw new TypeError("Cannot call a class as a function")},u=function(){function d(v){l(this,d),this.state=v||!1}return r(d,{flip:{value:function(p){p||p===!1?this.state=p:this.state=!this.state}},on:{value:function(){this.state=!0}},off:{value:function(){this.state=!1}}}),d}();i.exports=u},function(i,a,r){var l=function(b){return b&&b.__esModule?b:{default:b}},u=function(){function b(g,S){for(var A in S){var E=S[A];E.configurable=!0,E.value&&(E.writable=!0)}Object.defineProperties(g,S)}return function(g,S,A){return S&&b(g.prototype,S),A&&b(g,A),g}}(),d=function b(g,S,A){var E=Object.getOwnPropertyDescriptor(g,S);if(E===void 0){var O=Object.getPrototypeOf(g);return O===null?void 0:b(O,S,A)}else{if("value"in E&&E.writable)return E.value;var L=E.get;return L===void 0?void 0:L.call(A)}},v=function(b,g){if(typeof g!="function"&&g!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof g);b.prototype=Object.create(g&&g.prototype,{constructor:{value:b,enumerable:!1,writable:!0,configurable:!0}}),g&&(b.__proto__=g)},p=function(b,g){if(!(b instanceof g))throw new TypeError("Cannot call a class as a function")},y=r(4),x=r(6),_=r(11),m=l(r(12)),f=function(b){function g(){p(this,g);var S=["min","max","value"],A={size:[120,20],mode:"relative",min:0,max:1,step:0,value:0};d(Object.getPrototypeOf(g.prototype),"constructor",this).call(this,arguments,S,A),this.orientation="vertical",this._value=new _(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.position=new m.Handle(this.settings.mode,this.orientation,[0,this.width],[this.height,0]),this.position.value=this._value.normalized,this.init(),this.position.direction=this.orientation,this.emit("change",this.value)}return v(g,b),u(g,{buildInterface:{value:function(){this.bar=y.create("rect"),this.fillbar=y.create("rect"),this.knob=y.create("circle"),this.element.appendChild(this.bar),this.element.appendChild(this.fillbar),this.element.appendChild(this.knob)}},sizeInterface:{value:function(){this.width<this.height?(this.orientation="vertical",this.position.direction="vertical"):(this.orientation="horizontal",this.position.direction="horizontal"),this.position&&this.position.resize([0,this.width],[this.height,0]);var A=void 0,E=void 0,O=void 0,L=void 0,F=void 0,U=void 0;this.knobData={level:0,r:0},this.orientation==="vertical"?(this.thickness=this.width/2,A=this.width/2,E=0,O=this.thickness,L=this.height,this.knobData.r=this.thickness*.8,this.knobData.level=L-this.knobData.r-this.normalized*(L-this.knobData.r*2),F="translate("+this.thickness*-1/2+",0)",U=O/2):(this.thickness=this.height/2,A=0,E=this.height/2,O=this.width,L=this.thickness,this.knobData.r=this.thickness*.8,this.knobData.level=this.normalized*(O-this.knobData.r*2)+this.knobData.r,F="translate(0,"+this.thickness*-1/2+")",U=L/2),this.bar.setAttribute("x",A),this.bar.setAttribute("y",E),this.bar.setAttribute("transform",F),this.bar.setAttribute("rx",U),this.bar.setAttribute("ry",U),this.bar.setAttribute("width",O),this.bar.setAttribute("height",L),this.orientation==="vertical"?(this.fillbar.setAttribute("x",A),this.fillbar.setAttribute("y",this.knobData.level),this.fillbar.setAttribute("width",O),this.fillbar.setAttribute("height",L-this.knobData.level)):(this.fillbar.setAttribute("x",0),this.fillbar.setAttribute("y",E),this.fillbar.setAttribute("width",this.knobData.level),this.fillbar.setAttribute("height",L)),this.fillbar.setAttribute("transform",F),this.fillbar.setAttribute("rx",U),this.fillbar.setAttribute("ry",U),this.orientation==="vertical"?(this.knob.setAttribute("cx",A),this.knob.setAttribute("cy",this.knobData.level)):(this.knob.setAttribute("cx",this.knobData.level),this.knob.setAttribute("cy",E)),this.knob.setAttribute("r",this.knobData.r)}},colorInterface:{value:function(){this.bar.setAttribute("fill",this.colors.fill),this.fillbar.setAttribute("fill",this.colors.accent),this.knob.setAttribute("fill",this.colors.accent)}},render:{value:function(){this.clicked||(this.knobData.r=this.thickness*.75),this.knob.setAttribute("r",this.knobData.r),this.orientation==="vertical"?(this.knobData.level=this.knobData.r+this._value.normalized*(this.height-this.knobData.r*2),this.knob.setAttribute("cy",this.height-this.knobData.level),this.fillbar.setAttribute("y",this.height-this.knobData.level),this.fillbar.setAttribute("height",this.knobData.level)):(this.knobData.level=this._value.normalized*(this.width-this.knobData.r*2)+this.knobData.r,this.knob.setAttribute("cx",this.knobData.level),this.fillbar.setAttribute("x",0),this.fillbar.setAttribute("width",this.knobData.level))}},click:{value:function(){this.knobData.r=this.thickness*.9,this.position.anchor=this.mouse,this.move()}},move:{value:function(){this.clicked&&(this.position.update(this.mouse),this._value.updateNormal(this.position.value),this.emit("change",this._value.value),this.render())}},release:{value:function(){this.render()}},normalized:{get:function(){return this._value.normalized}},value:{get:function(){return this._value.value},set:function(S){this._value.update(S),this.position.value=this._value.normalized,this.emit("change",this._value.value),this.render()}},min:{get:function(){return this._value.min},set:function(S){this._value.min=S}},max:{get:function(){return this._value.max},set:function(S){this._value.max=S}},step:{get:function(){return this._value.step},set:function(S){this._value.step=S}},mode:{get:function(){return this.position.mode},set:function(S){this.position.mode=S}}}),g}(x);i.exports=f},function(i,a,r){var l=function(){function m(f,b){for(var g in b){var S=b[g];S.configurable=!0,S.value&&(S.writable=!0)}Object.defineProperties(f,b)}return function(f,b,g){return b&&m(f.prototype,b),g&&m(f,g),f}}(),u=function m(f,b,g){var S=Object.getOwnPropertyDescriptor(f,b);if(S===void 0){var A=Object.getPrototypeOf(f);return A===null?void 0:m(A,b,g)}else{if("value"in S&&S.writable)return S.value;var E=S.get;return E===void 0?void 0:E.call(g)}},d=function(m,f){if(typeof f!="function"&&f!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof f);m.prototype=Object.create(f&&f.prototype,{constructor:{value:m,enumerable:!1,writable:!0,configurable:!0}}),f&&(m.__proto__=f)},v=function(m,f){if(!(m instanceof f))throw new TypeError("Cannot call a class as a function")},p=r(4),y=r(13),x=r(6),_=function(m){function f(){v(this,f);var b=["value"],g={size:[40,20],target:!1,state:!1};u(Object.getPrototypeOf(f.prototype),"constructor",this).call(this,arguments,b,g),this._state=new y(this.settings.state),this.init()}return d(f,m),l(f,{buildInterface:{value:function(){this.bar=p.create("rect"),this.knob=p.create("circle"),this.element.appendChild(this.bar),this.element.appendChild(this.knob)}},sizeInterface:{value:function(){this.height<this.width/2?this.knobSize=this.height/2:this.knobSize=this.width/4,this.bar.setAttribute("x",this.width/2-this.knobSize*1.5),this.bar.setAttribute("y",this.height/2-this.knobSize/2),this.bar.setAttribute("rx",this.knobSize/2),this.bar.setAttribute("ry",this.knobSize/2),this.bar.setAttribute("width",this.knobSize*3),this.bar.setAttribute("height",this.knobSize),this.knob.setAttribute("cx",this.width/2-this.knobSize),this.knob.setAttribute("cy",this.height/2),this.knob.setAttribute("r",this.knobSize)}},colorInterface:{value:function(){this.knob.setAttribute("fill",this.colors.accent),this.render()}},render:{value:function(){this.state?(this.knob.setAttribute("cx",this.width/2+this.knobSize),this.bar.setAttribute("fill",this.colors.accent)):(this.knob.setAttribute("cx",this.width/2-this.knobSize),this.bar.setAttribute("fill",this.colors.fill))}},click:{value:function(){this.flip(),this.render(),this.emit("change",this.state)}},state:{get:function(){return this._state.state},set:function(b){this._state.flip(b),this.emit("change",this.state),this.render()}},flip:{value:function(){this._state.flip(),this.render()}}}),f}(x);i.exports=_},function(i,a,r){var l=function(){function _(m,f){for(var b in f){var g=f[b];g.configurable=!0,g.value&&(g.writable=!0)}Object.defineProperties(m,f)}return function(m,f,b){return f&&_(m.prototype,f),b&&_(m,b),m}}(),u=function _(m,f,b){var g=Object.getOwnPropertyDescriptor(m,f);if(g===void 0){var S=Object.getPrototypeOf(m);return S===null?void 0:_(S,f,b)}else{if("value"in g&&g.writable)return g.value;var A=g.get;return A===void 0?void 0:A.call(b)}},d=function(_,m){if(typeof m!="function"&&m!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof m);_.prototype=Object.create(m&&m.prototype,{constructor:{value:_,enumerable:!1,writable:!0,configurable:!0}}),m&&(_.__proto__=m)},v=function(_,m){if(!(_ instanceof m))throw new TypeError("Cannot call a class as a function")},p=r(4),y=r(17),x=function(_){function m(){v(this,m);var f=["mode"],b={size:[80,80],mode:"aftertouch",state:!1};u(Object.getPrototypeOf(m.prototype),"constructor",this).call(this,arguments,f,b),this.mode=this.settings.mode,this.init(),this.render()}return d(m,_),l(m,{buildInterface:{value:function(){this.pad=p.create("circle"),this.element.appendChild(this.pad),this.interactionTarget=this.pad,this.defs=p.create("defs"),this.element.appendChild(this.defs),this.gradient=p.radialGradient(this.defs,2),this.gradient.stops[0].setAttribute("offset","30%"),this.gradient.stops[1].setAttribute("offset","100%")}},sizeInterface:{value:function(){this.pad.setAttribute("cx",this.width/2),this.pad.setAttribute("cy",this.height/2),this.pad.setAttribute("r",Math.min(this.width,this.height)/2-this.width/40),this.pad.setAttribute("stroke-width",this.width/20)}},colorInterface:{value:function(){this.gradient.stops[0].setAttribute("stop-color",this.colors.accent),this.gradient.stops[1].setAttribute("stop-color",this.colors.fill),this.render()}},render:{value:function(){this.state?(this.mode==="aftertouch"?(this.pad.setAttribute("stroke","url(#"+this.gradient.id+")"),this.gradient.element.setAttribute("cx",this.position.x*100+"%"),this.gradient.element.setAttribute("cy",(1-this.position.y)*100+"%")):this.pad.setAttribute("stroke",this.colors.accent),this.pad.setAttribute("fill",this.colors.accent)):(this.pad.setAttribute("fill",this.colors.fill),this.pad.setAttribute("stroke",this.colors.mediumLight))}}}),m}(y);i.exports=x},function(i,a,r){var l=function(){function f(b,g){for(var S in g){var A=g[S];A.configurable=!0,A.value&&(A.writable=!0)}Object.defineProperties(b,g)}return function(b,g,S){return g&&f(b.prototype,g),S&&f(b,S),b}}(),u=function f(b,g,S){var A=Object.getOwnPropertyDescriptor(b,g);if(A===void 0){var E=Object.getPrototypeOf(b);return E===null?void 0:f(E,g,S)}else{if("value"in A&&A.writable)return A.value;var O=A.get;return O===void 0?void 0:O.call(S)}},d=function(f,b){if(typeof b!="function"&&b!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof b);f.prototype=Object.create(b&&b.prototype,{constructor:{value:f,enumerable:!1,writable:!0,configurable:!0}}),b&&(f.__proto__=b)},v=function(f,b){if(!(f instanceof b))throw new TypeError("Cannot call a class as a function")},p=r(4),y=r(5),x=r(13),_=r(6),m=function(f){function b(g,S,A){v(this,b),u(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,g,S,A),this.mode=this.settings.mode||"button",this.position={x:0,y:0},this._state=new x(this.settings.state)}return d(b,f),l(b,{buildInterface:{value:function(){this.pad=p.create("circle"),this.pad.setAttribute("fill","#d18"),this.pad.setAttribute("stroke","#d18"),this.pad.setAttribute("stroke-width",4),this.element.appendChild(this.pad),this.interactionTarget=this.pad,this.sizeInterface()}},sizeInterface:{value:function(){this.pad.setAttribute("cx",this.width/2),this.pad.setAttribute("cy",this.height/2),this.pad.setAttribute("r",Math.min(this.width,this.height)/2-2)}},render:{value:function(){this.state?(this.pad.setAttribute("fill",this.colors.accent),this.pad.setAttribute("stroke",this.colors.accent)):(this.pad.setAttribute("fill",this.colors.fill),this.pad.setAttribute("stroke",this.colors.mediumLight))}},down:{value:function(S){switch(this.mode){case"impulse":this.turnOn(),this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(this.turnOff.bind(this),30);break;case"button":this.turnOn();break;case"aftertouch":this.position={x:y.clip(this.mouse.x/this.width,0,1),y:y.clip(1-this.mouse.y/this.height,0,1)},this.turnOn();break;case"toggle":this.flip(S);break}}},bend:{value:function(S){this.mode==="aftertouch"&&(this.mouse=S||this.mouse,this.position={x:y.clip(this.mouse.x/this.width,0,1),y:y.clip(1-this.mouse.y/this.height,0,1)},this.emit("change",{state:this.state,x:this.position.x,y:this.position.y}),this.render())}},up:{value:function(){switch(this.mode){case"button":this.turnOff();break;case"aftertouch":this.turnOff(),this.position={x:y.clip(this.mouse.x/this.width,0,1),y:y.clip(1-this.mouse.y/this.height,0,1)};break}}},click:{value:function(){this.down()}},move:{value:function(){this.bend()}},release:{value:function(){this.up()}},state:{get:function(){return this._state.state},set:function(g){this._state.flip(g),this.mode==="aftertouch"?this.emit("change",{state:this.state,x:this.position.x,y:this.position.y}):this.emit("change",this.state),this.render()}},flip:{value:function(S){this._state.flip(S),this.mode==="aftertouch"?this.emit("change",{state:this.state,x:this.position.x,y:this.position.y}):this.emit("change",this.state),this.render()}},turnOn:{value:function(S){this._state.on(),S!==!1&&(this.mode==="aftertouch"?this.emit("change",{state:this.state,x:this.position.x,y:this.position.y}):this.emit("change",this.state)),this.render()}},turnOff:{value:function(S){this._state.off(),S!==!1&&(this.mode==="aftertouch"?this.emit("change",{state:this.state,x:this.position.x,y:this.position.y}):this.emit("change",this.state)),this.render()}}}),b}(_);i.exports=m},function(i,a,r){var l=function(){function x(_,m){for(var f in m){var b=m[f];b.configurable=!0,b.value&&(b.writable=!0)}Object.defineProperties(_,m)}return function(_,m,f){return m&&x(_.prototype,m),f&&x(_,f),_}}(),u=function x(_,m,f){var b=Object.getOwnPropertyDescriptor(_,m);if(b===void 0){var g=Object.getPrototypeOf(_);return g===null?void 0:x(g,m,f)}else{if("value"in b&&b.writable)return b.value;var S=b.get;return S===void 0?void 0:S.call(f)}},d=function(x,_){if(typeof _!="function"&&_!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof _);x.prototype=Object.create(_&&_.prototype,{constructor:{value:x,enumerable:!1,writable:!0,configurable:!0}}),_&&(x.__proto__=_)},v=function(x,_){if(!(x instanceof _))throw new TypeError("Cannot call a class as a function")},p=r(17),y=function(x){function _(){v(this,_);var m=["value"],f={size:[150,50],state:!1,text:"Play"};u(Object.getPrototypeOf(_.prototype),"constructor",this).call(this,arguments,m,f),this._text=this.settings.text,this.settings.alternate&&(this.settings.alternateText=this.settings.alternate,console.warn("'alternate' initiator is deprecated. Use 'alternateText' instead.")),this._alternateText=this.settings.alternateText,this.mode=this.settings.alternateText?"toggle":"button",this.init(),this.render(),this.state=this.settings.state}return d(_,x),l(_,{buildFrame:{value:function(){this.element=document.createElement("div"),this.parent.appendChild(this.element),this.textElement=document.createElement("div"),this.textElement.innerHTML=this._text,this.element.appendChild(this.textElement)}},buildInterface:{value:function(){}},colorInterface:{value:function(){this.element.style.color=this.colors.dark,this.render()}},sizeInterface:{value:function(){var f=this.height/3,b=this.width/(this._text.length+2);if(f=Math.min(f,b),this.alternateText){var g=this.width/(this.alternateText.length+2);f=Math.min(f,g)}var S="width: "+this.width+"px;";S+="height: "+this.height+"px;",S+="padding: "+(this.height-f)/2+"px 0px;",S+="box-sizing: border-box;",S+="text-align: center;",S+="font-family: inherit;",S+="font-weight: 700;",S+="opacity: 1;",S+="font-size:"+f+"px;",this.textElement.style.cssText=S,this.render()}},render:{value:function(){this.state?(this.element.style.backgroundColor=this.colors.accent,this.textElement.style.color=this.colors.fill,this.alternateText?this.textElement.innerHTML=this._alternateText:this.textElement.innerHTML=this._text):(this.element.style.backgroundColor=this.colors.fill,this.textElement.style.color=this.colors.dark,this.textElement.innerHTML=this._text)}},alternateText:{get:function(){return this._alternateText},set:function(m){m?this.mode="toggle":this.mode="button",this._alternateText=m,this.render()}},text:{get:function(){return this._text},set:function(m){this._text=m,this.sizeInterface(),this.render()}}}),_}(p);i.exports=y},function(i,a,r){var l=function(){function _(m,f){for(var b in f){var g=f[b];g.configurable=!0,g.value&&(g.writable=!0)}Object.defineProperties(m,f)}return function(m,f,b){return f&&_(m.prototype,f),b&&_(m,b),m}}(),u=function _(m,f,b){var g=Object.getOwnPropertyDescriptor(m,f);if(g===void 0){var S=Object.getPrototypeOf(m);return S===null?void 0:_(S,f,b)}else{if("value"in g&&g.writable)return g.value;var A=g.get;return A===void 0?void 0:A.call(b)}},d=function(_,m){if(typeof m!="function"&&m!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof m);_.prototype=Object.create(m&&m.prototype,{constructor:{value:_,enumerable:!1,writable:!0,configurable:!0}}),m&&(_.__proto__=m)},v=function(_,m){if(!(_ instanceof m))throw new TypeError("Cannot call a class as a function")},p=r(6),y=r(16),x=function(_){function m(){v(this,m);var f=["value"],b={size:[120,25],numberOfButtons:4,active:-1};u(Object.getPrototypeOf(m.prototype),"constructor",this).call(this,arguments,f,b),this.buttons=[],this._numberOfButtons=this.settings.numberOfButtons,this.active=this.settings.active,this.init(),this.render()}return d(m,_),l(m,{buildFrame:{value:function(){this.element=document.createElement("div"),this.parent.appendChild(this.element)}},buildInterface:{value:function(){for(var b=0;b<this._numberOfButtons;b++){var g=document.createElement("span"),S=new y(g,{mode:"toggle",component:!0},this.update.bind(this,b));this.buttons.push(S),this.element.appendChild(g)}}},sizeInterface:{value:function(){var b=void 0;this.width>this.height?b="horizontal":b="vertical";for(var g=this.width/(b==="vertical"?1:this._numberOfButtons),S=this.height/(b==="vertical"?this._numberOfButtons:1),A=0;A<this._numberOfButtons;A++)this.buttons[A].resize(g,S)}},colorInterface:{value:function(){for(var b=0;b<this._numberOfButtons;b++)this.buttons[b].colors=this.colors,this.buttons[b].render()}},update:{value:function(b){this.buttons[b].state?this.select(b):this.deselect()}},render:{value:function(){for(var b=0;b<this.buttons.length;b++)b===this.active?this.buttons[b].turnOn(!1):this.buttons[b].turnOff(!1)}},select:{value:function(b){b>=0&&b<this.buttons.length&&(this.active=b,this.emit("change",this.active),this.render())}},deselect:{value:function(){this.active=-1,this.emit("change",this.active),this.render()}},numberOfButtons:{get:function(){return this._numberOfButtons},set:function(f){this._numberOfButtons=f;for(var b=0;b<this.buttons.length;b++)this.buttons[b].destroy();this.buttons=[],this.empty(),this.buildInterface()}}}),m}(p);i.exports=x},function(i,a,r){var l=function(){function f(b,g){for(var S in g){var A=g[S];A.configurable=!0,A.value&&(A.writable=!0)}Object.defineProperties(b,g)}return function(b,g,S){return g&&f(b.prototype,g),S&&f(b,S),b}}(),u=function f(b,g,S){var A=Object.getOwnPropertyDescriptor(b,g);if(A===void 0){var E=Object.getPrototypeOf(b);return E===null?void 0:f(E,g,S)}else{if("value"in A&&A.writable)return A.value;var O=A.get;return O===void 0?void 0:O.call(S)}},d=function(f,b){if(typeof b!="function"&&b!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof b);f.prototype=Object.create(b&&b.prototype,{constructor:{value:f,enumerable:!1,writable:!0,configurable:!0}}),b&&(f.__proto__=b)},v=function(f,b){if(!(f instanceof b))throw new TypeError("Cannot call a class as a function")},p=r(6),y=r(11),x=r(5),_=r(8),m=function(f){function b(){v(this,b);var g=["value"],S={size:[60,30],value:0,min:0,max:2e4,step:1};u(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,arguments,g,S),this._value=new y(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=2,this.actual=0,this.max=this._value.max,this.min=this._value.min,this.step=this._value.step,this.init(),this.render()}return d(b,f),l(b,{buildFrame:{value:function(){this.element=document.createElement("input"),this.element.type="text",this.element.addEventListener("blur",(function(){this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark,this.element.value!==this.value&&(this.value=parseFloat(this.element.value),this.render())}).bind(this)),_.setInputFilter(this.element,function(S){return/^-?\d*\.?\d*$/.test(S)}),this.element.addEventListener("keydown",(function(S){S.which===13&&(this.element.blur(),this.value=this.element.value,this.emit("change",this.value),this.render())}).bind(this),!0),this.parent.appendChild(this.element)}},sizeInterface:{value:function(){this._minDimension=Math.min(this.width,this.height);var S="width: "+this.width+"px;";S+="height: "+this.height+"px;",S+="background-color: #e7e7e7;",S+="color: #333;",S+="font-family: arial;",S+="font-weight: 500;",S+="font-size:"+this._minDimension/2+"px;",S+="border: none;",S+="outline: none;",S+="padding: "+this._minDimension/4+"px "+this._minDimension/4+"px;",S+="box-sizing: border-box;",S+="userSelect: text;",S+="mozUserSelect: text;",S+="webkitUserSelect: text;",this.element.style.cssText+=S,this.element.value=this.value}},colorInterface:{value:function(){this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark}},render:{value:function(){this.element.value=x.prune(this.value,this.decimalPlaces)}},click:{value:function(){this.hasMoved=!1,this.element.readOnly=!0,this.actual=this.value,this.initial={y:this.mouse.y},this.changeFactor=x.invert(this.mouse.x/this.width)}},move:{value:function(){if(this.hasMoved=!0,this.clicked){var S=this.actual-(this.mouse.y-this.initial.y)*(x.clip(this.max-this.min,0,1e3)/200)*Math.pow(this.changeFactor,2);this.value=S,this.render(),this._value.changed&&this.emit("change",this.value)}}},release:{value:function(){this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light)}},link:{value:function(S){var A=this;this.min=S.min,this.max=S.max,this.step=S.step,S.on("change",function(E){A.passiveUpdate(E)}),this.on("change",function(E){S.value=E}),this.value=S.value}},passiveUpdate:{value:function(S){this._value.update(S),this.render()}},value:{get:function(){return this._value.value},set:function(g){this._value.update(g),this.emit("change",this.value),this.render()}},min:{get:function(){return this._value.min},set:function(g){this._value.min=g}},max:{get:function(){return this._value.max},set:function(g){this._value.max=g}},step:{get:function(){return this._value.step},set:function(g){this._value.step=g}}}),b}(p);i.exports=m},function(i,a,r){var l=function(){function x(_,m){for(var f in m){var b=m[f];b.configurable=!0,b.value&&(b.writable=!0)}Object.defineProperties(_,m)}return function(_,m,f){return m&&x(_.prototype,m),f&&x(_,f),_}}(),u=function x(_,m,f){var b=Object.getOwnPropertyDescriptor(_,m);if(b===void 0){var g=Object.getPrototypeOf(_);return g===null?void 0:x(g,m,f)}else{if("value"in b&&b.writable)return b.value;var S=b.get;return S===void 0?void 0:S.call(f)}},d=function(x,_){if(typeof _!="function"&&_!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof _);x.prototype=Object.create(_&&_.prototype,{constructor:{value:x,enumerable:!1,writable:!0,configurable:!0}}),_&&(x.__proto__=_)},v=function(x,_){if(!(x instanceof _))throw new TypeError("Cannot call a class as a function")},p=r(6),y=function(x){function _(){v(this,_);var m=["value"],f={size:[100,30],options:["default","options"]};u(Object.getPrototypeOf(_.prototype),"constructor",this).call(this,arguments,m,f),this._selectedIndex=-1,this._value=!1,this._options=this.settings.options,this.init(),this.render()}return d(_,x),l(_,{buildFrame:{value:function(){this.element=document.createElement("select"),this.element.style.fontSize=this.height/2+"px",this.element.style.outline="none",this.element.style.highlight="none",this.element.style.width=this.width+"px",this.element.style.height=this.height+"px",this.boundRender=this.render.bind(this),this.element.addEventListener("change",this.boundRender),this.parent.appendChild(this.element)}},attachListeners:{value:function(){}},buildInterface:{value:function(){this.defineOptions()}},colorInterface:{value:function(){this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark,this.element.style.border="solid 0px "+this.colors.mediumLight}},render:{value:function(){this._value=this.element.options[this.element.selectedIndex].text,this._selectedIndex=this.element.selectedIndex,this.emit("change",{value:this._value,index:this._selectedIndex})}},click:{value:function(){}},move:{value:function(){}},release:{value:function(){}},defineOptions:{value:function(f){f&&(this._options=f);for(var b=this.element.options.length-1;b>=0;b--)this.element.remove(b);for(var b=0;b<this._options.length;b++)this.element.options.add(new Option(this._options[b],b))}},value:{get:function(){return this._value},set:function(m){this._value=m;for(var f=0;f<this.element.options.length;f++)if(m===this.element.options[f].text){this.selectedIndex=f;break}}},selectedIndex:{get:function(){return this._selectedIndex},set:function(m){this._selectedIndex=m,this.element.selectedIndex=m,this.render()}},customDestroy:{value:function(){this.element.removeEventListener("change",this.boundRender)}}}),_}(p);i.exports=y},function(i,a,r){var l=function(g){return g&&g.__esModule?g:{default:g}},u=function(){function g(S,A){for(var E in A){var O=A[E];O.configurable=!0,O.value&&(O.writable=!0)}Object.defineProperties(S,A)}return function(S,A,E){return A&&g(S.prototype,A),E&&g(S,E),S}}(),d=function g(S,A,E){var O=Object.getOwnPropertyDescriptor(S,A);if(O===void 0){var L=Object.getPrototypeOf(S);return L===null?void 0:g(L,A,E)}else{if("value"in O&&O.writable)return O.value;var F=O.get;return F===void 0?void 0:F.call(E)}},v=function(g,S){if(typeof S!="function"&&S!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof S);g.prototype=Object.create(S&&S.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}),S&&(g.__proto__=S)},p=function(g,S){if(!(g instanceof S))throw new TypeError("Cannot call a class as a function")},y=r(4),x=r(5),_=r(6),m=r(11),f=l(r(12)),b=function(g){function S(){p(this,S);var A=["min","max","value"],E={size:[75,75],interaction:"radial",mode:"relative",min:0,max:1,step:0,value:0};d(Object.getPrototypeOf(S.prototype),"constructor",this).call(this,arguments,A,E),this.interaction=this.settings.interaction,this._value=new m(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.position=new f.Handle(this.settings.mode,this.interaction,[0,this.width],[this.height,0]),this.init(),this.value=this._value.value,this.position.value=this._value.normalized,this.previousAngle=!1,this.emit("change",this.value)}return v(S,g),u(S,{buildInterface:{value:function(){this.background=y.create("circle"),this.screw=y.create("circle"),this.handle=y.create("path"),this.handle2=y.create("path"),this.handleFill=y.create("path"),this.handle2Fill=y.create("path"),this.handleLine=y.create("path"),this.element.appendChild(this.background),this.element.appendChild(this.handle),this.element.appendChild(this.handle2),this.element.appendChild(this.handleFill),this.element.appendChild(this.handle2Fill),this.element.appendChild(this.handleLine),this.element.appendChild(this.screw)}},sizeInterface:{value:function(){this.position.resize([0,this.width],[this.height,0]);var E={x:this.width/2,y:this.height/2},O=Math.min(this.width,this.height);this.background.setAttribute("cx",E.x),this.background.setAttribute("cy",E.y),this.background.setAttribute("r",O/2-O/40),this.screw.setAttribute("cx",E.x),this.screw.setAttribute("cy",E.y),this.screw.setAttribute("r",O/12);var L=this.value,F={start:Math.PI*1.5,end:x.clip(x.scale(L,0,.5,Math.PI*1.5,Math.PI*.5),Math.PI*.5,Math.PI*1.5)},U={start:Math.PI*2.5,end:x.clip(x.scale(L,.5,1,Math.PI*2.5,Math.PI*1.5),Math.PI*1.5,Math.PI*2.5)},X=y.arc(E.x,E.y,O/2-O/40,F.start,F.end),Q=y.arc(E.x,E.y,O/2-O/40,U.start,U.end);this.handle.setAttribute("d",X),this.handle.setAttribute("stroke-width",O/20),this.handle.setAttribute("fill","none"),this.handle2.setAttribute("d",Q),this.handle2.setAttribute("stroke-width",O/20),this.handle2.setAttribute("fill","none"),X+=" L "+E.x+" "+E.y,this.handleFill.setAttribute("d",X),this.handleFill.setAttribute("fill-opacity","0.3"),Q+=" L "+E.x+" "+E.y,this.handle2Fill.setAttribute("d",Q),this.handle2Fill.setAttribute("fill-opacity","0.3");var ct=void 0;L<.5?ct=F.end:ct=U.end;var gt=E.x+Math.cos(ct)*(O/2),_t=E.y+Math.sin(ct)*(O/2)*-1;this.handleLine.setAttribute("d","M "+E.x+" "+E.y+" L "+gt+" "+_t),this.handleLine.setAttribute("stroke-width",O/20)}},colorInterface:{value:function(){this.background.setAttribute("fill",this.colors.fill),this.screw.setAttribute("fill",this.colors.accent),this.handle.setAttribute("stroke",this.colors.accent),this.handle2.setAttribute("stroke",this.colors.accent),this.handleFill.setAttribute("fill",this.colors.accent),this.handle2Fill.setAttribute("fill",this.colors.accent),this.handleLine.setAttribute("stroke",this.colors.accent)}},render:{value:function(){var E=this._value.normalized,O={x:this.width/2,y:this.height/2},L=Math.min(this.width,this.height),F={start:Math.PI*1.5,end:x.clip(x.scale(E,0,.5,Math.PI*1.5,Math.PI*.5),Math.PI*.5,Math.PI*1.5)},U={start:Math.PI*2.5,end:x.clip(x.scale(E,.5,1,Math.PI*2.5,Math.PI*1.5),Math.PI*1.5,Math.PI*2.5)},X=y.arc(O.x,O.y,L/2-L/40,F.start,F.end),Q=y.arc(O.x,O.y,L/2-L/40,U.start,U.end);this.handle.setAttribute("d",X),this.handle2.setAttribute("d",Q),X+=" L "+O.x+" "+O.y,this.handleFill.setAttribute("d",X),Q+=" L "+O.x+" "+O.y,this.handle2Fill.setAttribute("d",Q);var ct=void 0;E<=.5?ct=F.end:ct=U.end;var gt=O.x+Math.cos(ct)*(L/2),_t=O.y+Math.sin(ct)*(L/2)*-1;this.handleLine.setAttribute("d","M "+O.x+" "+O.y+" L "+gt+" "+_t)}},click:{value:function(){this.mode==="relative"&&(this.previousAngle=!1),this.position.anchor=this.mouse,this.position.value=this._value.normalized,this.move()}},move:{value:function(){if(this.clicked){this.position.update(this.mouse);var E=this.position.value*Math.PI*2;E<0&&(E+=Math.PI*2),this.mode==="relative"&&this.previousAngle!==!1&&Math.abs(this.previousAngle-E)>2&&(this.previousAngle>3?E=Math.PI*2:E=0),this.previousAngle=E;var O=E/(Math.PI*2);this.value=this._value.updateNormal(O),this.mode==="relative"&&(this.position.value=O),this.emit("change",this._value.value),this.render()}}},release:{value:function(){}},value:{get:function(){return this._value.value},set:function(A){this._value.update(A),this.position.value=this._value.normalized,this.emit("change",this._value.value),this.render()}},min:{get:function(){return this._value.min},set:function(A){this._value.min=A}},max:{get:function(){return this._value.max},set:function(A){this._value.max=A}},step:{get:function(){return this._value.step},set:function(A){this._value.step=A}},mode:{get:function(){return this.position.mode},set:function(A){this.position.mode=A}},normalized:{get:function(){return this._value.normalized},set:function(A){this._value.updateNormal(A),this.emit("change",this.value)}}}),S}(_);i.exports=b},function(i,a,r){var l=function(){function b(g,S){for(var A in S){var E=S[A];E.configurable=!0,E.value&&(E.writable=!0)}Object.defineProperties(g,S)}return function(g,S,A){return S&&b(g.prototype,S),A&&b(g,A),g}}(),u=function b(g,S,A){var E=Object.getOwnPropertyDescriptor(g,S);if(E===void 0){var O=Object.getPrototypeOf(g);return O===null?void 0:b(O,S,A)}else{if("value"in E&&E.writable)return E.value;var L=E.get;return L===void 0?void 0:L.call(A)}},d=function(b,g){if(typeof g!="function"&&g!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof g);b.prototype=Object.create(g&&g.prototype,{constructor:{value:b,enumerable:!1,writable:!0,configurable:!0}}),g&&(b.__proto__=g)},v=function(b,g){if(!(b instanceof g))throw new TypeError("Cannot call a class as a function")},p=r(4),y=r(6),x=r(17),_=r(9),m=function(b){function g(){v(this,g);var S=["value","note","color"],A={size:[80,80],target:!1,mode:"button",value:0};u(Object.getPrototypeOf(g.prototype),"constructor",this).call(this,arguments,S,A),this.note=this.settings.note,this.color=this.settings.color,this.colors={w:"#fff",b:"#666"},this.init(),this.render()}return d(g,b),l(g,{buildFrame:{value:function(){this.element=p.create("svg"),this.element.setAttribute("width",this.width),this.element.setAttribute("height",this.height),this.parent.appendChild(this.element)}},buildInterface:{value:function(){var A=this;this.pad=p.create("rect"),this.element.appendChild(this.pad),this.interactionTarget=this.pad,_.exists||(this.click=function(){A.piano.interacting=!0,A.piano.paintbrush=!A.state,A.down(A.piano.paintbrush)},this.pad.addEventListener("mouseover",function(){A.piano.interacting&&A.down(A.piano.paintbrush)}),this.move=function(){A.piano.interacting&&A.bend()},this.release=function(){A.piano.interacting=!1},this.pad.addEventListener("mouseup",function(){A.piano.interacting&&A.up()}),this.pad.addEventListener("mouseout",function(){A.piano.interacting&&A.up()}))}},sizeInterface:{value:function(){var A=0;this.pad.setAttribute("x",.5),this.pad.setAttribute("y",.5),this.width>2?this.pad.setAttribute("width",this.width-1):this.pad.setAttribute("width",this.width),this.height>2?this.pad.setAttribute("height",this.height):this.pad.setAttribute("height",this.height),this.pad.setAttribute("rx",A),this.pad.setAttribute("ry",A)}},render:{value:function(){this.state?this.pad.setAttribute("fill",this.colors.accent):this.pad.setAttribute("fill",this.colors[this.color])}}}),g}(x),f=function(b){function g(){v(this,g);var S=["value"],A={size:[500,125],lowNote:24,highNote:60,mode:"button"};u(Object.getPrototypeOf(g.prototype),"constructor",this).call(this,arguments,S,A),this.keyPattern=["w","b","w","b","w","w","b","w","b","w","b","w"],this.paintbrush=!1,this.mode=this.settings.mode,this.range={low:this.settings.lowNote,high:this.settings.highNote},this.range.size=this.range.high-this.range.low+1,this.keys=[],this.toggleTo=!1,this.init(),this.render()}return d(g,b),l(g,{buildFrame:{value:function(){this.element=document.createElement("div"),this.element.style.position="relative",this.element.style.borderRadius="0px",this.element.style.display="block",this.element.style.width="100%",this.element.style.height="100%",this.parent.appendChild(this.element)}},buildInterface:{value:function(){this.keys=[];for(var A=0;A<this.range.size;A++){var E=document.createElement("span"),O=(A+this.range.low)%this.keyPattern.length,L=new m(E,{component:!0,note:A+this.range.low,color:this.keyPattern[O],mode:this.mode},this.keyChange.bind(this,A+this.range.low));L.piano=this,_.exists&&(L.pad.index=A,L.preClick=L.preMove=L.preRelease=function(){},L.click=L.move=L.release=function(){},L.preTouch=L.preTouchMove=L.preTouchRelease=function(){},L.touch=L.touchMove=L.touchRelease=function(){}),this.keys.push(L),this.element.appendChild(E)}_.exists&&this.addTouchListeners()}},sizeInterface:{value:function(){for(var A=0,E=[],O=0;O<this.range.size;O++){E.push(A);var L=(O+this.range.low)%this.keyPattern.length,F=(O+1+this.range.low)%this.keyPattern.length;O+1+this.range.low>=this.range.high||this.keyPattern[L]==="w"&&this.keyPattern[F]==="w"?A+=1:A+=.5}for(var U=A,X=1,Q=(this.width-X*2)/U,ct=(this.height-X*2)/2,O=0;O<this.keys.length;O++){var gt=this.keys[O].parent;gt.style.position="absolute",gt.style.left=E[O]*Q+X+"px",this.keys[O].color==="w"?(gt.style.top=X+"px",this.keys[O].resize(Q,ct*2)):(gt.style.zIndex=1,gt.style.top=X+"px",this.keys[O].resize(Q,ct*1.1))}}},colorInterface:{value:function(){this.element.style.backgroundColor=this.colors.mediumLight;for(var A=0;A<this.keys.length;A++)this.keys[A].colors={w:this.colors.light,b:this.colors.dark,accent:this.colors.accent,border:this.colors.mediumLight},this.keys[A].colorInterface(),this.keys[A].render()}},keyChange:{value:function(A,E){var O={note:A};typeof E=="object"?O.state=E.state:O.state=E,this.emit("change",O)}},render:{value:function(){}},addTouchListeners:{value:function(){this.preClick=this.preMove=this.preRelease=function(){},this.click=this.move=this.release=function(){},this.preTouch=this.preTouchMove=this.preTouchRelease=function(){},this.touch=this.touchMove=this.touchRelease=function(){};var A={},E=this.keys;function O(X){return{identifier:X.identifier,clientX:X.clientX,clientY:X.clientY}}function L(){var X={};Object.keys(A).forEach(function(Q){var ct=A[Q],gt=document.elementFromPoint(ct.clientX,ct.clientY),_t=gt?E[gt.index]:null;_t?(X[gt.index]=Q,_t.state||_t.down()):delete A[Q]}),E.forEach(function(Q){Q.state&&!X[Q.pad.index]&&Q.up()})}function F(X){X.preventDefault(),X.stopPropagation();for(var Q=0;Q<X.changedTouches.length;Q++){var ct=X.changedTouches[Q];A[ct.identifier]=O(ct)}L()}function U(X){X.preventDefault(),X.stopPropagation();for(var Q=0;Q<X.changedTouches.length;Q++){var ct=X.changedTouches[Q];delete A[ct.identifier]}L()}this.element.addEventListener("touchstart",F),this.element.addEventListener("touchmove",F),this.element.addEventListener("touchend",U)}},setRange:{value:function(A,E){this.range.low=A,this.range.high=E,this.empty(),this.buildInterface()}},toggleKey:{value:function(A,E){this.keys[A-this.range.low].flip(E)}},toggleIndex:{value:function(A,E){this.keys[A].flip(E)}}}),g}(y);i.exports=f},function(i,a,r){var l=function(){function E(O,L){for(var F in L){var U=L[F];U.configurable=!0,U.value&&(U.writable=!0)}Object.defineProperties(O,L)}return function(O,L,F){return L&&E(O.prototype,L),F&&E(O,F),O}}(),u=function E(O,L,F){var U=Object.getOwnPropertyDescriptor(O,L);if(U===void 0){var X=Object.getPrototypeOf(O);return X===null?void 0:E(X,L,F)}else{if("value"in U&&U.writable)return U.value;var Q=U.get;return Q===void 0?void 0:Q.call(F)}},d=function(E,O){if(typeof O!="function"&&O!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof O);E.prototype=Object.create(O&&O.prototype,{constructor:{value:E,enumerable:!1,writable:!0,configurable:!0}}),O&&(E.__proto__=O)},v=function(E,O){if(!(E instanceof O))throw new TypeError("Cannot call a class as a function")},p=r(4),y=r(7),x=r(6),_=r(17),m=r(25),f=r(28),b=r(29),g=r(9),S=function(E){function O(){v(this,O);var L=["value"],F={size:[80,80],target:!1,mode:"toggle",value:0,paddingRow:2,paddingColumn:2};u(Object.getPrototypeOf(O.prototype),"constructor",this).call(this,arguments,L,F),this.index=this.settings.index,this.row=this.settings.row,this.column=this.settings.column,this.matrix=this.settings.matrix,this.paddingRow=this.settings.paddingRow||F.paddingRow,this.paddingColumn=this.settings.paddingColumn||F.paddingColumn,this.interacting=!1,this.paintbrush=!1,this.init(),this.render()}return d(O,E),l(O,{buildFrame:{value:function(){this.element=p.create("svg"),this.element.setAttribute("width",this.width),this.element.setAttribute("height",this.height),this.element.style.top="0px",this.element.style.left="0px",this.element.style.position="absolute",this.parent.appendChild(this.element)}},buildInterface:{value:function(){var F=this;this.pad=p.create("rect"),this.element.appendChild(this.pad),this.interactionTarget=this.pad,g.exists||(this.click=function(){F.matrix.interacting=!0,F.matrix.paintbrush=!F.state,F.down(F.matrix.paintbrush)},this.pad.addEventListener("mouseover",function(){F.matrix.interacting&&F.down(F.matrix.paintbrush)}),this.move=function(){},this.pad.addEventListener("mousemove",function(U){F.matrix.interacting&&(F.offset||(F.offset=y.findPosition(F.element)),F.mouse=y.locateMouse(U,F.offset),F.bend())}),this.release=function(){F.matrix.interacting=!1},this.pad.addEventListener("mouseup",function(){F.matrix.interacting&&F.up()}),this.pad.addEventListener("mouseout",function(){F.matrix.interacting&&F.up()}))}},sizeInterface:{value:function(){this.pad.setAttribute("x",this.paddingColumn/2),this.pad.setAttribute("y",this.paddingRow/2),this.width>2?this.pad.setAttribute("width",this.width-this.paddingColumn):this.pad.setAttribute("width",this.width),this.height>2?this.pad.setAttribute("height",this.height-this.paddingRow):this.pad.setAttribute("height",this.height),this.pad.setAttribute("fill",this.matrix.colors.fill)}},render:{value:function(){this.state?this.pad.setAttribute("fill",this.matrix.colors.accent):this.pad.setAttribute("fill",this.matrix.colors.fill)}}}),O}(_),A=function(E){function O(){v(this,O);var L=["value"],F={size:[400,200],mode:"toggle",rows:5,columns:10};u(Object.getPrototypeOf(O.prototype),"constructor",this).call(this,arguments,L,F),this.active=-1,this.mode=this.settings.mode,this.interval=new b(200,function(){},!1),this.matrix=new m(this.settings.rows,this.settings.columns),this.matrix.ui=this,this.stepper=new f(0,this.columns),this.paddingRow=this.settings.paddingRow,this.paddingColumn=this.settings.paddingColumn,this.init()}return d(O,E),l(O,{buildFrame:{value:function(){this.element=document.createElement("div"),this.element.style.position="relative",this.element.style.display="block",this.element.style.width="100%",this.element.style.height="100%",this.parent.appendChild(this.element),g.exists&&this.addTouchListeners()}},buildInterface:{value:function(){this.cells=[];for(var F=0;F<this.matrix.length;F++){var U=this.matrix.locate(F),X=document.createElement("span");X.style.position="absolute";var Q=new S(X,{component:!0,index:F,row:U.row,column:U.column,mode:this.mode,matrix:this,paddingRow:this.paddingRow,paddingColumn:this.paddingColumn},this.keyChange.bind(this,F));g.exists&&(Q.pad.index=F,Q.preClick=Q.preMove=Q.preRelease=function(){},Q.click=Q.move=Q.release=function(){},Q.preTouch=Q.preTouchMove=Q.preTouchRelease=function(){},Q.touch=Q.touchMove=Q.touchRelease=function(){}),this.cells.push(Q),this.element.appendChild(X)}this.sizeInterface()}},sizeInterface:{value:function(){for(var F=this.width/this.columns,U=this.height/this.rows,X=0;X<this.cells.length;X++){var Q=this.cells[X].parent;Q.style.left=this.cells[X].column*F+"px",Q.style.top=this.cells[X].row*U+"px",this.cells[X].resize(F,U)}}},colorInterface:{value:function(){for(var F=0;F<this.cells.length;F++)this.cells[F].render()}},update:{value:function(){var F=this;this.matrix.iterate(function(U,X,Q){F.matrix.pattern[U][X]!==F.cells[Q].state&&(F.matrix.pattern[U][X]>0?F.cells[Q].turnOn():F.cells[Q].turnOff())})}},keyChange:{value:function(F,U){var X=this.matrix.locate(F);this.matrix.pattern[X.row][X.column]=U;var Q={row:X.row,column:X.column,state:U};this.emit("change",Q)}},render:{value:function(){var F=this;this.stepper.value>=0&&this.matrix.iterate(function(U,X,Q){X===F.stepper.value?(F.cells[Q].pad.setAttribute("stroke",F.colors.mediumLight),F.cells[Q].pad.setAttribute("stroke-width","1"),F.cells[Q].pad.setAttribute("stroke-opacity","1")):F.cells[Q].pad.setAttribute("stroke","none")})}},start:{value:function(F){this.interval.event=this.next.bind(this),F&&this.interval.ms(F),this.interval.start()}},stop:{value:function(){this.interval.stop()}},next:{value:function(){this.stepper.next(),this.emit("step",this.matrix.column(this.stepper.value).reverse()),this.render()}},addTouchListeners:{value:function(){var F=this;this.preClick=this.preMove=this.preRelease=function(){},this.click=this.move=this.release=function(){},this.preTouch=this.preTouchMove=this.preTouchRelease=function(){},this.touch=this.touchMove=this.touchRelease=function(){},this.currentElement=!1,this.element.addEventListener("touchstart",function(U){var X=document.elementFromPoint(U.targetTouches[0].clientX,U.targetTouches[0].clientY),Q=F.cells[X.index];F.paintbrush=!Q.state,Q.down(F.paintbrush),F.currentElement=X.index,U.preventDefault(),U.stopPropagation()}),this.element.addEventListener("touchmove",function(U){var X=document.elementFromPoint(U.targetTouches[0].clientX,U.targetTouches[0].clientY),Q=F.cells[X.index];if(X.index!==F.currentElement){if(F.currentElement>=0){var ct=F.cells[F.currentElement];ct.up()}Q.down(F.paintbrush)}else Q.bend();F.currentElement=X.index,U.preventDefault(),U.stopPropagation()}),this.element.addEventListener("touchend",function(U){var X=F.cells[F.currentElement];X.up(),F.interacting=!1,F.currentElement=!1,U.preventDefault(),U.stopPropagation()})}},rows:{get:function(){return this.matrix.rows},set:function(L){this.matrix.rows=L,this.empty(),this.buildInterface(),this.update()}},columns:{get:function(){return this.matrix.columns},set:function(L){this.matrix.columns=L,this.stepper.max=L,this.empty(),this.buildInterface(),this.update()}}}),O}(x);i.exports=A},function(i,a,r){var l=function(x){return x&&x.__esModule?x.default:x},u=function(){function x(_,m){for(var f in m){var b=m[f];b.configurable=!0,b.value&&(b.writable=!0)}Object.defineProperties(_,m)}return function(_,m,f){return m&&x(_.prototype,m),f&&x(_,f),_}}(),d=function(x,_){if(!(x instanceof _))throw new TypeError("Cannot call a class as a function")},v=l(r(5)),p=l(r(26)),y=function(){function x(_,m){var f=this;d(this,x),this.pattern=[],this.create(_,m),this.toggle={cell:function(b,g){return f.pattern[g][b]=!f.pattern[g][b],f.ui&&f.ui.update(),f.pattern[g][b]},all:function(){f.iterate(function(b,g){f.toggle.cell(g,b)}),f.ui&&f.ui.update()},row:function(b){for(var g=0;g<f.columns;g++)f.toggle.cell(g,b);f.ui&&f.ui.update()},column:function(b){for(var g=0;g<f.rows;g++)f.toggle.cell(b,g);f.ui&&f.ui.update()}},this.set={cell:function(b,g,S){f.pattern[g][b]=S,f.ui&&f.ui.update()},all:function(b){f.pattern=b,f.ui&&f.ui.update()},row:function(b,g){f.pattern[b]=g,f.ui&&f.ui.update()},column:function(b,g){f.pattern.forEach(function(S,A){f.pattern[A][b]=g[A]}),f.ui&&f.ui.update()}},this.rotate={all:function(b){!b&&b!==0&&(b=1),b%=f.pattern[0].length,b<0&&(b=f.pattern[0].length+b);for(var g=0;g<f.rows;g++){var S=f.pattern[g].splice(f.pattern[g].length-b,b);f.pattern[g]=S.concat(f.pattern[g])}f.ui&&f.ui.update()},row:function(b,g){!g&&g!==0&&(g=1),g%=f.pattern[0].length,g<0&&(g=f.pattern[0].length+g);var S=f.pattern[b].splice(f.pattern[b].length-g,g);f.pattern[b]=S.concat(f.pattern[b]),f.ui&&f.ui.update()},column:function(b,g){!g&&g!==0&&(g=1),g%=f.pattern.length,g<0&&(g=f.pattern.length+g);var S=[];f.pattern.forEach(function(E){S.push(E[b])});var A=S.splice(S.length-g,g);S=A.concat(S),f.pattern.forEach(function(E,O){E[b]=S[O]}),f.ui&&f.ui.update()}},this.populate={all:function(b){var g=new p(b);f.iterate(function(S,A){f.pattern[S][A]=v.coin(g.next())}),f.ui&&f.ui.update()},row:function(){var b=arguments[0]===void 0?0:arguments[0],g=arguments[1]===void 0?1:arguments[1],S=new p(g);f.pattern[b].forEach(function(A,E){f.pattern[b][E]=v.coin(S.next())}),f.ui&&f.ui.update()},column:function(){var b=arguments[0]===void 0?0:arguments[0],g=arguments[1]===void 0?1:arguments[1],S=new p(g);f.pattern.forEach(function(A,E){f.pattern[E][b]=v.coin(S.next())}),f.ui&&f.ui.update()}},this.erase={all:function(){f.set.all(0)},row:function(b){f.set.row(b,0)},column:function(b){f.set.column(b,0)}}}return u(x,{create:{value:function(m,f){var b=this;this.pattern=[];for(var g=0;g<m;g++){var S=new Array(f);this.pattern.push(S)}this.iterate(function(A,E){b.pattern[A][E]=!1})}},iterate:{value:function(m,f){for(var b=0,g=0;g<this.rows;g++){f&&f(g);for(var S=0;S<this.columns;S++)m(g,S,b),b++}}},formatAsText:{value:function(){var m=this,f="";return this.iterate(function(b,g){f+=(m.pattern[b][g]?1:0)+" "},function(){f+=`
`}),f}},log:{value:function(){console.log(this.formatAsText())}},update:{value:function(m){this.pattern=m||this.pattern}},length:{get:function(){return this.rows*this.columns}},locate:{value:function(m){return{row:~~(m/this.columns),column:m%this.columns}}},indexOf:{value:function(m,f){return f+m*this.columns}},row:{value:function(_){var m=function(b){return _.apply(this,arguments)};return m.toString=function(){return _.toString()},m}(function(_){for(var m=[],f=0;f<this.columns;f++)m.push(this.pattern[_]?1:0);return m})},column:{value:function(_){var m=function(b){return _.apply(this,arguments)};return m.toString=function(){return _.toString()},m}(function(_){for(var m=[],f=0;f<this.rows;f++)m.push(this.pattern[f][_]?1:0);return m})},rows:{get:function(){return this.pattern.length},set:function(_){var m=this,f=this.pattern.slice(0);this.create(_,this.columns),this.iterate(function(b,g){f[b]&&f[b][g]&&(m.pattern[b][g]=f[b][g])})}},columns:{get:function(){return this.pattern[0].length},set:function(_){var m=this,f=this.pattern.slice(0);this.create(this.rows,_),this.iterate(function(b,g){f[b]&&f[b][g]&&(m.pattern[b][g]=f[b][g])})}}}),x}();i.exports=y},function(i,a,r){var l=function(x){return x&&x.__esModule?x.default:x},u=function(){function x(_,m){for(var f in m){var b=m[f];b.configurable=!0,b.value&&(b.writable=!0)}Object.defineProperties(_,m)}return function(_,m,f){return m&&x(_.prototype,m),f&&x(_,f),_}}(),d=function(x,_){if(!(x instanceof _))throw new TypeError("Cannot call a class as a function")},v=l(r(5)),p=l(r(27)),y=function(){function x(){var _=arguments[0]===void 0?[0,10,20,30]:arguments[0],m=arguments[1]===void 0?"up":arguments[1],f=arguments[2]===void 0?!1:arguments[2];d(this,x),this.values=_,Array.isArray(this.values)||(this.values=[this.values]),this._mode=m,this.position=f,this.drunkWalk=new p(0,this.values.length-1),this.startValues={up:0,down:this.values.length-1,drunk:~~(this.values.length/2),random:v.ri(this.values.length)},this.position!==!1?this.next=this[this._mode]:this.next=this.first}return u(x,{mode:{get:function(){return this._mode},set:function(_){if(!(_==="up"||_==="down"||_==="random"||_==="drunk")){console.error("The only modes currently allowed are: up, down, random, drunk");return}this._mode=_,this.position&&(this.next=this[this._mode])}},value:{get:function(){return this.values[this.position]},set:function(_){this.position=this.values.indexOf(_)}},first:{value:function(){return this.position!==!1?(this.next=this[this._mode],this.next()):(this.position=this.startValues[this._mode],this.next=this[this._mode],this.value)}},up:{value:function(){return this.position++,this.position%=this.values.length,this.value}},down:{value:function(){return this.position--,this.position<0&&(this.position=(this.position+this.values.length)%this.values.length),this.value}},random:{value:function(){return this.position=v.ri(0,this.values.length),this.value}},drunk:{value:function(){return this.drunkWalk.max=this.values.length,this.drunkWalk.value=this.position,this.position=this.drunkWalk.next(),this.value}}}),x}();i.exports=y},function(i,a,r){var l=function(y){return y&&y.__esModule?y.default:y},u=function(){function y(x,_){for(var m in _){var f=_[m];f.configurable=!0,f.value&&(f.writable=!0)}Object.defineProperties(x,_)}return function(x,_,m){return _&&y(x.prototype,_),m&&y(x,m),x}}(),d=function(y,x){if(!(y instanceof x))throw new TypeError("Cannot call a class as a function")},v=l(r(5)),p=function(){function y(){var x=arguments[0]===void 0?0:arguments[0],_=arguments[1]===void 0?9:arguments[1],m=arguments[2]===void 0?0:arguments[2],f=arguments[3]===void 0?1:arguments[3],b=arguments[4]===void 0?!1:arguments[4];d(this,y),this.min=x,this.max=_,this.value=m,this.increment=f,this.loop=b}return u(y,{next:{value:function(){return this.value+=v.pick(-1*this.increment,this.increment),this.value>this.max&&(this.loop?this.value=this.min:this.value=this.max-this.increment),this.value<this.min&&(this.loop?this.value=this.max:this.value=this.min+this.increment),this.value}}}),y}();i.exports=p},function(i,a,r){var l=function(x){return x&&x.__esModule?x.default:x},u=function(){function x(_,m){for(var f in m){var b=m[f];b.configurable=!0,b.value&&(b.writable=!0)}Object.defineProperties(_,m)}return function(_,m,f){return m&&x(_.prototype,m),f&&x(_,f),_}}(),d=function(x,_){if(!(x instanceof _))throw new TypeError("Cannot call a class as a function")},v=l(r(5)),p=l(r(27)),y=function(){function x(){var _=arguments[0]===void 0?0:arguments[0],m=arguments[1]===void 0?10:arguments[1],f=arguments[2]===void 0?"up":arguments[2],b=arguments[3]===void 0?!1:arguments[3];d(this,x),this.min=_,this.max=m,this.value=b,this.mode=f,this.drunkWalk=new p(this.min,this.max),this.value!==!1?this.next=this[this._mode]:this.next=this.first}return u(x,{mode:{set:function(_){if(!(_==="up"||_==="down"||_==="random"||_==="drunk")){console.error("The only modes currently allowed are: up, down, random, drunk");return}this._mode=_,this.value&&(this.next=this[this._mode])},get:function(){return this._mode}},first:{value:function(){return this.value!==!1?(this.next=this[this._mode],this.next()):(this.startValues={up:this.min,down:this.max,drunk:~~v.average(this.min,this.max),random:v.ri(this.min,this.max)},this.value=this.startValues[this._mode],this.next=this[this._mode],this.value)}},up:{value:function(){return this.value++,this.value>=this.max&&(this.value=this.min),this.value}},down:{value:function(){return this.value--,this.value<this.min&&(this.value=this.max),this.value}},random:{value:function(){return this.value=v.ri(this.min,this.max),this.value}},drunk:{value:function(){return this.drunkWalk.min=this.min,this.drunkWalk.max=this.max,this.drunkWalk.value=this.value,this.value=this.drunkWalk.next(),this.value}}}),x}();i.exports=y},function(i,a,r){var l=function(){function p(y,x){for(var _ in x){var m=x[_];m.configurable=!0,m.value&&(m.writable=!0)}Object.defineProperties(y,x)}return function(y,x,_){return x&&p(y.prototype,x),_&&p(y,_),y}}(),u=function(p,y){if(!(p instanceof y))throw new TypeError("Cannot call a class as a function")},d=r(1).clock,v=function(){function p(y,x,_){u(this,p),this.rate=y,this.on=_,this.clock=d(),this.pattern=[1],this.index=0,this.event=x||function(){},this.on&&this.start()}return l(p,{_event:{value:function(x){this.event(x),this.index++}},stop:{value:function(){this.on=!1,this.interval.clear()}},start:{value:function(){this.on=!0,this.interval=this.clock.callbackAtTime(this._event.bind(this),this.clock.context.currentTime).repeat(this.rate/1e3).tolerance({early:.1,late:1})}},ms:{value:function(x){if(this.on){var _=x/this.rate;this.rate=x,this.clock.timeStretch(this.clock.context.currentTime,[this.interval],_)}else this.rate=x}}}),p}();i.exports=v},function(i,a,r){var l=function(g){return g&&g.__esModule?g:{default:g}},u=function(){function g(S,A){for(var E in A){var O=A[E];O.configurable=!0,O.value&&(O.writable=!0)}Object.defineProperties(S,A)}return function(S,A,E){return A&&g(S.prototype,A),E&&g(S,E),S}}(),d=function g(S,A,E){var O=Object.getOwnPropertyDescriptor(S,A);if(O===void 0){var L=Object.getPrototypeOf(S);return L===null?void 0:g(L,A,E)}else{if("value"in O&&O.writable)return O.value;var F=O.get;return F===void 0?void 0:F.call(E)}},v=function(g,S){if(typeof S!="function"&&S!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof S);g.prototype=Object.create(S&&S.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}),S&&(g.__proto__=S)},p=function(g,S){if(!(g instanceof S))throw new TypeError("Cannot call a class as a function")},y=r(4),x=r(5),_=r(6),m=r(11),f=l(r(12)),b=function(g){function S(){p(this,S);var A=["range"],E={size:[200,200],range:.5,mode:"absolute",speakers:[[.5,.2],[.75,.25],[.8,.5],[.75,.75],[.5,.8],[.25,.75],[.2,.5],[.25,.25]]};d(Object.getPrototypeOf(S.prototype),"constructor",this).call(this,arguments,A,E),this.value={x:new m(0,1,0,.5),y:new m(0,1,0,.5)},this.mode=this.settings.mode,this.position={x:new f.Handle(this.mode,"horizontal",[0,this.width],[this.height,0]),y:new f.Handle(this.mode,"vertical",[0,this.width],[this.height,0])},this.position.x.value=this.value.x.normalized,this.position.y.value=this.value.y.normalized,this.speakers=this.settings.speakers,this.range=this.settings.range,this.levels=[],this.init(),this.calculateLevels(),this.render()}return v(S,g),u(S,{buildInterface:{value:function(){this.knob=y.create("circle"),this.element.appendChild(this.knob),this.speakerElements=[];for(var E=0;E<this.speakers.length;E++){var O=y.create("circle");this.element.appendChild(O),this.speakerElements.push(O)}}},sizeInterface:{value:function(){this._minDimension=Math.min(this.width,this.height),this.knobRadius={off:~~(this._minDimension/100)*3+5},this.knobRadius.on=this.knobRadius.off*2,this.knob.setAttribute("cx",this.width/2),this.knob.setAttribute("cy",this.height/2),this.knob.setAttribute("r",this.knobRadius.off);for(var E=0;E<this.speakers.length;E++){var O=this.speakerElements[E],L=this.speakers[E];O.setAttribute("cx",L[0]*this.width),O.setAttribute("cy",L[1]*this.height),O.setAttribute("r",this._minDimension/20+5),O.setAttribute("fill-opacity","0")}this.position.x.resize([0,this.width],[this.height,0]),this.position.y.resize([0,this.width],[this.height,0]),this.calculateLevels(),this.render()}},colorInterface:{value:function(){this.element.style.backgroundColor=this.colors.fill,this.knob.setAttribute("fill",this.colors.mediumLight);for(var E=0;E<this.speakers.length;E++){var O=this.speakerElements[E];O.setAttribute("fill",this.colors.accent),O.setAttribute("stroke",this.colors.accent)}}},render:{value:function(){this.knobCoordinates={x:this.value.x.normalized*this.width,y:this.height-this.value.y.normalized*this.height},this.knob.setAttribute("cx",this.knobCoordinates.x),this.knob.setAttribute("cy",this.knobCoordinates.y)}},click:{value:function(){this.position.x.anchor=this.mouse,this.position.y.anchor=this.mouse,this.move()}},move:{value:function(){this.clicked&&(this.position.x.update(this.mouse),this.position.y.update(this.mouse),this.calculateLevels(),this.emit("change",this.levels),this.render())}},release:{value:function(){this.render()}},normalized:{get:function(){return{x:this.value.x.normalized,y:this.value.y.normalized}}},calculateLevels:{value:function(){var E=this;this.value.x.updateNormal(this.position.x.value),this.value.y.updateNormal(this.position.y.value),this.levels=[],this.speakers.forEach(function(O,L){var F=x.distance(O[0]*E.width,O[1]*E.height,E.position.x.value*E.width,(1-E.position.y.value)*E.height),U=x.clip(1-F/(E.range*E.width),0,1);E.levels.push(U),E.speakerElements[L].setAttribute("fill-opacity",U)})}},moveSource:{value:function(E,O){var L={x:E*this.width,y:O*this.height};this.position.x.update(L),this.position.y.update(L),this.calculateLevels(),this.emit("change",this.levels),this.render()}},moveSpeaker:{value:function(E,O,L){this.speakers[E]=[O,L],this.speakerElements[E].setAttribute("cx",O*this.width),this.speakerElements[E].setAttribute("cy",L*this.height),this.calculateLevels(),this.emit("change",this.levels),this.render()}}}),S}(_);i.exports=b},function(i,a,r){var l=function(){function m(f,b){for(var g in b){var S=b[g];S.configurable=!0,S.value&&(S.writable=!0)}Object.defineProperties(f,b)}return function(f,b,g){return b&&m(f.prototype,b),g&&m(f,g),f}}(),u=function m(f,b,g){var S=Object.getOwnPropertyDescriptor(f,b);if(S===void 0){var A=Object.getPrototypeOf(f);return A===null?void 0:m(A,b,g)}else{if("value"in S&&S.writable)return S.value;var E=S.get;return E===void 0?void 0:E.call(g)}},d=function(m,f){if(typeof f!="function"&&f!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof f);m.prototype=Object.create(f&&f.prototype,{constructor:{value:m,enumerable:!1,writable:!0,configurable:!0}}),f&&(m.__proto__=f)},v=function(m,f){if(!(m instanceof f))throw new TypeError("Cannot call a class as a function")},p=r(5),y=r(4),x=r(6),_=function(m){function f(){v(this,f);var b=["value"],g={size:[80,80]};u(Object.getPrototypeOf(f.prototype),"constructor",this).call(this,arguments,b,g),this._active=!0,this.init(),this.boundUpdate=this.update.bind(this),window.DeviceOrientationEvent?this.orientationListener=window.addEventListener("deviceorientation",this.boundUpdate,!1):(this._active=!1,this.colorInterface())}return d(f,m),l(f,{buildInterface:{value:function(){this.title=y.create("text"),this.circleX=y.create("circle"),this.circleY=y.create("circle"),this.circleZ=y.create("circle"),this.barX=y.create("path"),this.barY=y.create("path"),this.barZ=y.create("path"),this.barX2=y.create("path"),this.barY2=y.create("path"),this.barZ2=y.create("path"),this.barX.setAttribute("opacity","0.8"),this.barY.setAttribute("opacity","0.8"),this.barZ.setAttribute("opacity","0.8"),this.barX2.setAttribute("opacity","0.8"),this.barY2.setAttribute("opacity","0.8"),this.barZ2.setAttribute("opacity","0.8"),this.circleX.setAttribute("cx",this.width*3/12),this.circleX.setAttribute("cy",this.height*3/4),this.circleX.setAttribute("r",this.height/10),this.circleX.setAttribute("opacity","0.4"),this.circleY.setAttribute("cx",this.width*6/12),this.circleY.setAttribute("cy",this.height*3/4),this.circleY.setAttribute("r",this.height/10),this.circleY.setAttribute("opacity","0.4"),this.circleZ.setAttribute("cx",this.width*9/12),this.circleZ.setAttribute("cy",this.height*3/4),this.circleZ.setAttribute("r",this.height/10),this.circleZ.setAttribute("opacity","0.4"),this.barX.setAttribute("stroke-width",Math.round(this.height/30)),this.barY.setAttribute("stroke-width",Math.round(this.height/30)),this.barZ.setAttribute("stroke-width",Math.round(this.height/30)),this.barX.setAttribute("fill","none"),this.barY.setAttribute("fill","none"),this.barZ.setAttribute("fill","none"),this.barX2.setAttribute("stroke-width",Math.round(this.height/30)),this.barY2.setAttribute("stroke-width",Math.round(this.height/30)),this.barZ2.setAttribute("stroke-width",Math.round(this.height/30)),this.barX2.setAttribute("fill","none"),this.barY2.setAttribute("fill","none"),this.barZ2.setAttribute("fill","none"),this.title.setAttribute("x",this.width/2),this.title.setAttribute("y",this.height/3+7),this.title.setAttribute("font-size","15px"),this.title.setAttribute("font-weight","bold"),this.title.setAttribute("letter-spacing","2px"),this.title.setAttribute("opacity","0.7"),this.title.setAttribute("text-anchor","middle"),this.title.textContent="TILT",this.element.appendChild(this.circleX),this.element.appendChild(this.circleY),this.element.appendChild(this.circleZ),this.element.appendChild(this.barX),this.element.appendChild(this.barY),this.element.appendChild(this.barZ),this.element.appendChild(this.barX2),this.element.appendChild(this.barY2),this.element.appendChild(this.barZ2),this.element.appendChild(this.title)}},colorInterface:{value:function(){this._active?(this.element.style.backgroundColor=this.colors.accent,this.circleX.setAttribute("fill",this.colors.light),this.circleY.setAttribute("fill",this.colors.light),this.circleZ.setAttribute("fill",this.colors.light),this.circleX.setAttribute("stroke",this.colors.light),this.circleY.setAttribute("stroke",this.colors.light),this.circleZ.setAttribute("stroke",this.colors.light),this.barX.setAttribute("stroke",this.colors.light),this.barY.setAttribute("stroke",this.colors.light),this.barZ.setAttribute("stroke",this.colors.light),this.barX2.setAttribute("stroke",this.colors.light),this.barY2.setAttribute("stroke",this.colors.light),this.barZ2.setAttribute("stroke",this.colors.light),this.title.setAttribute("fill",this.colors.light)):(this.element.style.backgroundColor=this.colors.fill,this.circleX.setAttribute("fill",this.colors.mediumLight),this.circleY.setAttribute("fill",this.colors.mediumLight),this.circleZ.setAttribute("fill",this.colors.mediumLight),this.circleX.setAttribute("stroke",this.colors.mediumLight),this.circleY.setAttribute("stroke",this.colors.mediumLight),this.circleZ.setAttribute("stroke",this.colors.mediumLight),this.barX.setAttribute("stroke",this.colors.mediumLight),this.barY.setAttribute("stroke",this.colors.mediumLight),this.barZ.setAttribute("stroke",this.colors.mediumLight),this.barX2.setAttribute("stroke",this.colors.mediumLight),this.barY2.setAttribute("stroke",this.colors.mediumLight),this.barZ2.setAttribute("stroke",this.colors.mediumLight),this.title.setAttribute("fill",this.colors.mediumLight))}},update:{value:function(g){if(this._active){var S=g.beta,A=g.gamma,E=g.alpha;A=p.scale(A,-90,90,0,1),S=p.scale(S,-90,90,0,1),E=p.scale(E,0,360,0,1);var O={start:Math.PI*1.5,end:p.clip(p.scale(A,0,.5,Math.PI*1.5,Math.PI*.5),Math.PI*.5,Math.PI*1.5)},L={start:Math.PI*2.5,end:p.clip(p.scale(A,.5,1,Math.PI*2.5,Math.PI*1.5),Math.PI*1.5,Math.PI*2.5)},F=y.arc(this.circleX.cx.baseVal.value,this.circleX.cy.baseVal.value,this.circleX.r.baseVal.value,O.start,O.end),U=y.arc(this.circleX.cx.baseVal.value,this.circleX.cy.baseVal.value,this.circleX.r.baseVal.value,L.start,L.end);this.barX.setAttribute("d",F),this.barX2.setAttribute("d",U),O={start:Math.PI*1.5,end:p.clip(p.scale(S,0,.5,Math.PI*1.5,Math.PI*.5),Math.PI*.5,Math.PI*1.5)},L={start:Math.PI*2.5,end:p.clip(p.scale(S,.5,1,Math.PI*2.5,Math.PI*1.5),Math.PI*1.5,Math.PI*2.5)},F=y.arc(this.circleY.cx.baseVal.value,this.circleY.cy.baseVal.value,this.circleY.r.baseVal.value,O.start,O.end),U=y.arc(this.circleY.cx.baseVal.value,this.circleY.cy.baseVal.value,this.circleY.r.baseVal.value,L.start,L.end),this.barY.setAttribute("d",F),this.barY2.setAttribute("d",U),O={start:Math.PI*1.5,end:p.clip(p.scale(E,0,.5,Math.PI*1.5,Math.PI*.5),Math.PI*.5,Math.PI*1.5)},L={start:Math.PI*2.5,end:p.clip(p.scale(E,.5,1,Math.PI*2.5,Math.PI*1.5),Math.PI*1.5,Math.PI*2.5)},F=y.arc(this.circleZ.cx.baseVal.value,this.circleZ.cy.baseVal.value,this.circleZ.r.baseVal.value,O.start,O.end),U=y.arc(this.circleZ.cx.baseVal.value,this.circleZ.cy.baseVal.value,this.circleZ.r.baseVal.value,L.start,L.end),this.barZ.setAttribute("d",F),this.barZ2.setAttribute("d",U),this.emit("change",{x:A,y:S,z:E})}}},click:{value:function(){window.DeviceOrientationEvent&&(this.active=!this.active)}},active:{get:function(){return this._active},set:function(b){this._active=b,this.colorInterface()}},customDestroy:{value:function(){window.removeEventListener("deviceorientation",this.boundUpdate,!1)}}}),f}(x);i.exports=_},function(i,a,r){var l=function(){function m(f,b){for(var g in b){var S=b[g];S.configurable=!0,S.value&&(S.writable=!0)}Object.defineProperties(f,b)}return function(f,b,g){return b&&m(f.prototype,b),g&&m(f,g),f}}(),u=function m(f,b,g){var S=Object.getOwnPropertyDescriptor(f,b);if(S===void 0){var A=Object.getPrototypeOf(f);return A===null?void 0:m(A,b,g)}else{if("value"in S&&S.writable)return S.value;var E=S.get;return E===void 0?void 0:E.call(g)}},d=function(m,f){if(typeof f!="function"&&f!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof f);m.prototype=Object.create(f&&f.prototype,{constructor:{value:m,enumerable:!1,writable:!0,configurable:!0}}),f&&(m.__proto__=f)},v=function(m,f){if(!(m instanceof f))throw new TypeError("Cannot call a class as a function")},p=r(5),y=r(4),x=r(6),_=function(m){function f(){v(this,f);var b=["value"],g={size:[200,100],numberOfSliders:5,min:0,max:1,step:0,candycane:3,values:[.9,.8,.7,.6,.5,.4,.3,.2,.1],smoothing:0,mode:"bar"};u(Object.getPrototypeOf(f.prototype),"constructor",this).call(this,arguments,b,g),this._numberOfSliders=this.settings.numberOfSliders,this._min=this.settings.min,this._max=this.settings.max,this._step=this.settings.step,this._mode=this.settings.mode;var S=this.settings.values;this.values=S.length>this._numberOfSliders?S.slice(0,this._numberOfSliders):S.concat(Array(this._numberOfSliders-S.length).fill(0)),this.candycane=this.settings.candycane,this.sliderWidth=this.width/this.values.length,this.smoothing=this.settings.smoothing,this.init(),this.render()}return d(f,m),l(f,{buildInterface:{value:function(){this._mode=="line"?(this.line=y.create("polyline"),this.line.setAttribute("stroke-width",2),this.line.setAttribute("fill","none"),this.element.appendChild(this.line),this.fill=y.create("polyline"),this.fill.setAttribute("fill-opacity","0.2"),this.element.appendChild(this.fill),this.nodes=[],this.values.forEach((function(g,S){var A=y.create("circle");A.setAttribute("cx",this.getX(S)),A.setAttribute("cy",this.getY(g)),this.element.appendChild(A),this.nodes.push(A)}).bind(this))):(this.bars=[],this.caps=[],this.values.forEach((function(g,S){var A=y.create("rect"),E=this.getBarX(S),O=this.getY(g);A.setAttribute("x",E-.1),A.setAttribute("y",O),A.setAttribute("width",this.sliderWidth+.2),A.setAttribute("height",this.height),A.setAttribute("opacity",1-(S%this.candycane+1)/(this.candycane+1)),this.element.appendChild(A),this.bars.push(A);var L=y.create("rect");L.setAttribute("x",E-.1),L.setAttribute("y",O),L.setAttribute("width",this.sliderWidth+.2),L.setAttribute("height",5),this.element.appendChild(L),this.caps.push(L)}).bind(this)))}},getBarX:{value:function(g){return this.getX(g)-this.sliderWidth/2}},getX:{value:function(g){return g*this.sliderWidth+this.sliderWidth/2}},getY:{value:function(g){return p.scale(g,this._min,this._max,this.height,0)}},getValueFromY:{value:function(g){var S=p.scale(g,this.height,0,this._min,this._max);return this.adjustValueToStep(S)}},getIndexFromX:{value:function(g){return p.clip(Math.floor(g/this.width*this.values.length),0,this.values.length-1)}},adjustValueToStep:{value:function(g){if(!this._step)return g;var S=g%this._step;return g=g-g%this._step,S>this._step/2&&(g+=this._step),g}},adjustAllValues:{value:function(){this.values.forEach((function(g,S){g=this.adjustValueToStep(g),this.values[S]=p.clip(g,this._min,this._max)}).bind(this))}},getNormalizedValues:{value:function(){this.normalizedValues=[],this.values.forEach((function(g){this.normalizedValues.push(p.scale(g,this._min,this._max,0,1))}).bind(this))}},colorInterface:{value:function(){var g=this;this.element.style.backgroundColor=this.colors.fill,this._mode=="line"?(this.line.setAttribute("stroke",this.colors.accent),this.fill.setAttribute("fill",this.colors.accent),this.nodes.forEach(function(S){S.setAttribute("fill",g.colors.accent)})):(this.bars.forEach(function(S){S.setAttribute("fill",g.colors.accent)}),this.caps.forEach(function(S){S.setAttribute("fill",g.colors.accent)}))}},sizeInterface:{value:function(){this.sliderWidth=this.width/this.values.length,this._mode=="line"&&this.nodes.forEach((function(g){var S=~~(Math.min(this.width,this.height)/50)+2;S=Math.min(this.sliderWidth,S),g.setAttribute("r",S)}).bind(this)),this.render()}},render:{value:function(){var g=this;this._mode=="line"?function(){var S="0 "+g.getY(g.values[0])+", ";g.values.forEach(function(A,E){var O=g.getX(E),L=g.getY(A);S+=O+" "+L+", ",g.nodes[E].setAttribute("cx",g.getX(E)),g.nodes[E].setAttribute("cy",g.getY(A))}),S+=g.width+" "+g.getY(g.values[g.values.length-1]),g.line.setAttribute("points",S),S+=", "+g.width+" "+g.height+", ",S+="0 "+g.height,g.fill.setAttribute("points",S)}():this.values.forEach(function(S,A){g.bars[A].setAttribute("y",g.getY(S)),g.caps[A].setAttribute("y",g.getY(S))})}},click:{value:function(){this.hasMoved=!1,this.previousSlider=!1,this.move()}},move:{value:function(){if(this.clicked){if(this.mouse.x=p.clip(this.mouse.x,0,this.width),this.mouse.y=p.clip(this.mouse.y,0,this.height),this.hasMoved=!0,this.selectedSlider=this.getIndexFromX(this.mouse.x),this.values[this.selectedSlider]=this.getValueFromY(this.mouse.y),this.previousSlider!==!1){var g=Math.abs(this.previousSlider-this.selectedSlider);if(g>1)for(var S=Math.min(this.previousSlider,this.selectedSlider),A=Math.max(this.previousSlider,this.selectedSlider),E=this.values[S],O=this.values[A],L=S;L<A;L++)this.values[L]=p.interp((L-S)/g,E,O),this.values[L]=this.adjustValueToStep(this.values[L])}if(this.smoothing>0)for(var F=1;F<=this.smoothing;F++){var U=this.selectedSlider-F,X=this.selectedSlider+F;if(U>=1){var Q=U-1>=0?U-1:0,ct=U+1;this.values[U]=(this.values[Q]+this.values[ct])/2,this.values[U]=this.adjustValueToStep(this.values[U])}if(X<this.values.length-1){var gt=X-1,_t=X+1<this.values.length?X+1:this.values.length-1;this.values[X]=(this.values[gt]+this.values[_t])/2,this.values[X]=this.adjustValueToStep(this.values[X])}}this.previousSlider=this.selectedSlider,this.emit("change",this.values),this.render()}}},scan:{value:function(){}},update:{value:function(g,S){this.values[g]=this.adjustValueToStep(S),this.emit("change",{index:g,value:S})}},numberOfSliders:{get:function(){return this.values.length}},min:{get:function(){return this._min},set:function(b){this._min=b,this.adjustAllValues(),this.render()}},max:{get:function(){return this._max},set:function(b){this._max=b,this.adjustAllValues(),this.render()}},step:{get:function(){return this._step},set:function(b){this._step=b,this.adjustAllValues(),this.render()}},setSlider:{value:function(g,S){this.values[g]=this.adjustValueToStep(S),this.values[g]=p.clip(this.values[g],this._min,this._max),this.emit("change",{index:g,value:S})}},setAllSliders:{value:function(g){var S=this.values.length,A=g.length;this.values=g,this.adjustAllValues(),S!=A&&(this.empty(),this.buildInterface(),this.colorInterface()),this.sizeInterface()}}}),f}(x);i.exports=_},function(i,a,r){var l=function(g){return g&&g.__esModule?g:{default:g}},u=function(){function g(S,A){for(var E in A){var O=A[E];O.configurable=!0,O.value&&(O.writable=!0)}Object.defineProperties(S,A)}return function(S,A,E){return A&&g(S.prototype,A),E&&g(S,E),S}}(),d=function g(S,A,E){var O=Object.getOwnPropertyDescriptor(S,A);if(O===void 0){var L=Object.getPrototypeOf(S);return L===null?void 0:g(L,A,E)}else{if("value"in O&&O.writable)return O.value;var F=O.get;return F===void 0?void 0:F.call(E)}},v=function(g,S){if(typeof S!="function"&&S!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof S);g.prototype=Object.create(S&&S.prototype,{constructor:{value:g,enumerable:!1,writable:!0,configurable:!0}}),S&&(g.__proto__=S)},p=function(g,S){if(!(g instanceof S))throw new TypeError("Cannot call a class as a function")},y=r(4),x=r(5),_=r(6),m=r(11),f=l(r(12)),b=function(g){function S(){p(this,S);var A=["scale","value"],E={size:[120,20],orientation:"horizontal",mode:"relative",scale:[-1,1],step:0,value:0,hasKnob:!0};d(Object.getPrototypeOf(S.prototype),"constructor",this).call(this,arguments,A,E),this.orientation=this.settings.orientation,this.mode=this.settings.mode,this.hasKnob=this.settings.hasKnob,this.step=this.settings.step,this._value=new m(this.settings.scale[0],this.settings.scale[1],this.settings.step,this.settings.value),this.init(),this.position=new f.Handle(this.mode,this.orientation,[0,this.width],[this.height,0]),this.position.value=this._value.normalized,this.value=this._value.value,this.emit("change",this.value)}return v(S,g),u(S,{buildInterface:{value:function(){this.bar=y.create("rect"),this.knob=y.create("circle"),this.element.appendChild(this.bar),this.element.appendChild(this.knob)}},sizeInterface:{value:function(){this.position&&this.position.resize([0,this.width],[this.height,0]),this.width<this.height?this.orientation="vertical":this.orientation="horizontal";var E=void 0,O=void 0,L=void 0,F=void 0,U=void 0,X=void 0;this.knobData={level:0,r:0},this.orientation==="vertical"?(this.thickness=this.width/2,E=this.width/2,O=0,L=this.thickness,F=this.height,this.knobData.r=this.thickness*.8,this.knobData.level=F-this.knobData.r-this.normalized*(F-this.knobData.r*2),U="translate("+this.thickness*-1/2+",0)",X=L/2):(this.thickness=this.height/2,E=0,O=this.height/2,L=this.width,F=this.thickness,this.knobData.r=this.thickness*.8,this.knobData.level=this.normalized*(L-this.knobData.r*2)+this.knobData.r,U="translate(0,"+this.thickness*-1/2+")",X=F/2),this.bar.setAttribute("x",E),this.bar.setAttribute("y",O),this.bar.setAttribute("transform",U),this.bar.setAttribute("rx",X),this.bar.setAttribute("ry",X),this.bar.setAttribute("width",L),this.bar.setAttribute("height",F),this.orientation==="vertical"?(this.knob.setAttribute("cx",E),this.knob.setAttribute("cy",this.knobData.level)):(this.knob.setAttribute("cx",this.knobData.level),this.knob.setAttribute("cy",O)),this.knob.setAttribute("r",this.knobData.r)}},colorInterface:{value:function(){this.bar.setAttribute("fill",this.colors.fill),this.knob.setAttribute("fill",this.colors.accent),this.hasKnob||this.knob.setAttribute("fill","transparent")}},render:{value:function(){this.clicked||(this.knobData.r=this.thickness*.75),this.knob.setAttribute("r",this.knobData.r),this.orientation==="vertical"?(this.knobData.level=this.knobData.r+this._value.normalized*(this.height-this.knobData.r*2),this.knob.setAttribute("cy",this.height-this.knobData.level)):(this.knobData.level=this._value.normalized*(this.width-this.knobData.r*2)+this.knobData.r,this.knob.setAttribute("cx",this.knobData.level))}},click:{value:function(){this.knobData.r=this.thickness*.9,this.position.anchor=this.mouse,this.move()}},move:{value:function(){this.clicked&&(this.position.update(this.mouse),this.value=this._value.updateNormal(this.position.value),this.emit("change",{value:this.value,L:Math.pow(x.scale(this.value,-1,1,1,0),2),R:Math.pow(x.scale(this.value,-1,1,0,1),2)}))}},release:{value:function(){this.render()}},value:{get:function(){return this._value.value},set:function(A){this._value.update(A),this.position.value=this._value.normalized,this.emit("change",{value:this.value,L:Math.pow(x.scale(this.value,-1,1,1,0),2),R:Math.pow(x.scale(this.value,-1,1,0,1),2)}),this.render()}},normalized:{get:function(){return this._value.normalized}}}),S}(_);i.exports=b},function(i,a,r){var l=function(){function f(b,g){for(var S in g){var A=g[S];A.configurable=!0,A.value&&(A.writable=!0)}Object.defineProperties(b,g)}return function(b,g,S){return g&&f(b.prototype,g),S&&f(b,S),b}}(),u=function f(b,g,S){var A=Object.getOwnPropertyDescriptor(b,g);if(A===void 0){var E=Object.getPrototypeOf(b);return E===null?void 0:f(E,g,S)}else{if("value"in A&&A.writable)return A.value;var O=A.get;return O===void 0?void 0:O.call(S)}},d=function(f,b){if(typeof b!="function"&&b!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof b);f.prototype=Object.create(b&&b.prototype,{constructor:{value:f,enumerable:!1,writable:!0,configurable:!0}}),b&&(f.__proto__=b)},v=function(f,b){if(!(f instanceof b))throw new TypeError("Cannot call a class as a function")},p=r(5),y=r(4),x=r(6),_=function(b,g){this.x=b.x,this.y=b.y,this.xMin=b.xMin||0,this.xMax=b.xMax||1,this.yMin=b.yMin||0,this.yMax=b.yMax||1,this.envelope=g,this.element=y.create("circle"),this.element.setAttribute("fill",this.envelope.colors.accent),this.envelope.element.appendChild(this.element),this.resize=function(){var S=~~(Math.min(this.envelope.width,this.envelope.height)/50)+2;this.element.setAttribute("r",S)},this.move=function(S,A){if(this.x=S||S===0?S:this.x,this.y=A||A===0?A:this.y,this.envelope.nodes.indexOf(this)>=0){var E=this.envelope.nodes.indexOf(this)-1,O=this.envelope.nodes.indexOf(this)+1,L=this.envelope.nodes[E],F=this.envelope.nodes[O],U=E>=0?L.x:0;U=U<this.xMin?this.xMin:U;var X=O<this.envelope.nodes.length?F.x:1;X=X>this.xMax?this.xMax:X,this.x<U&&(this.x=U),this.x>X&&(this.x=X),this.y<this.yMin&&(this.y=this.yMin),this.y>this.yMax&&(this.y=this.yMax)}this.location=this.getCoordinates(),this.element.setAttribute("cx",this.location.x),this.element.setAttribute("cy",this.location.y)},this.getCoordinates=function(){return{x:this.x*this.envelope.width,y:(1-this.y)*this.envelope.height}},this.move(this.x,this.y,!0),this.resize(),this.destroy=function(){this.envelope.element.removeChild(this.element),this.envelope.nodes.splice(this.envelope.nodes.indexOf(this),1)}},m=function(f){function b(){v(this,b);var g=["value"],S={size:[300,150],noNewPoints:!1,points:[{x:.1,y:.4},{x:.35,y:.6},{x:.65,y:.2},{x:.9,y:.4}]};u(Object.getPrototypeOf(b.prototype),"constructor",this).call(this,arguments,g,S),this.points=this.settings.points,this.nodes=[],this.selected=!1,this.init()}return d(b,f),l(b,{buildInterface:{value:function(){var S=this;this.points.forEach(function(A){var E=new _(A,S);S.nodes.push(E)}),this.sortPoints(),this.line=y.create("polyline"),this.line.setAttribute("stroke-width",2),this.line.setAttribute("fill","none"),this.element.appendChild(this.line),this.fill=y.create("polyline"),this.fill.setAttribute("fill-opacity","0.2"),this.element.appendChild(this.fill)}},sizeInterface:{value:function(){for(var S=0;S<this.nodes.length;S++)this.nodes[S].resize(),this.nodes[S].move();this.render()}},colorInterface:{value:function(){var S=this;this.element.style.backgroundColor=this.colors.fill,this.line.setAttribute("stroke",this.colors.accent),this.fill.setAttribute("fill",this.colors.accent),this.nodes.forEach(function(A){A.element.setAttribute("fill",S.colors.accent)})}},render:{value:function(){this.calculatePath()}},calculatePoints:{value:function(){var S=this;this.points=[],this.nodes.forEach(function(A){S.points.push({x:A.x,y:A.y})})}},calculatePath:{value:function(){var S="0 "+this.nodes[0].location.y+", ";this.nodes.forEach(function(A){S+=A.location.x+" "+A.location.y+", "}),S+=this.width+" "+this.nodes[this.nodes.length-1].location.y,this.line.setAttribute("points",S),S+=", "+this.width+" "+this.height+", ",S+="0 "+this.height,this.fill.setAttribute("points",S)}},click:{value:function(){this.hasMoved=!1,this.selected=this.findNearestNode(),this.nodes[this.selected].move(this.mouse.x/this.width,1-this.mouse.y/this.height),this.scaleNode(this.selected),this.calculatePoints(),this.emit("change",this.points),this.render()}},move:{value:function(){this.clicked&&(this.mouse.x=p.clip(this.mouse.x,0,this.width),this.hasMoved=!0,this.nodes[this.selected].move(this.mouse.x/this.width,1-this.mouse.y/this.height),this.scaleNode(this.selected),this.calculatePoints(),this.emit("change",this.points),this.render())}},release:{value:function(){this.hasMoved||this.nodes[this.selected].destroy(),this.calculatePoints(),this.emit("change",this.points),this.render(),this.selected=null}},findNearestNode:{value:function(){for(var S=null,A=1e4,E=this.mouse.x/this.width,O=1-this.mouse.y/this.height,L=this.nodes,F=0;F<L.length;F++){var U=Math.sqrt(Math.pow(L[F].x-E,2)+Math.pow(L[F].y-O,2));U<A&&(A=U,S=F,E>L[F].x)}return!this.settings.noNewPoints&&A>.07&&(S=this.getIndexFromX(this.mouse.x/this.width),this.nodes.splice(S,0,new _({x:this.mouse.x/this.width,y:1-this.mouse.y/this.height},this)),this.hasMoved=!0),S}},getIndexFromX:{value:function(S){var A=this,E=0;return this.nodes.forEach(function(O,L){A.nodes[L].x<=S&&(E=L+1)}),E}},scaleNode:{value:function(S){var A=p.clip(this.nodes[S].x,0,1),E=p.clip(this.nodes[S].y,0,1);this.nodes[S].move(A,E)}},sortPoints:{value:function(){this.nodes.sort(function(S,A){return S.x>A.x})}},addPoint:{value:function(S,A){var E=this.nodes.length;this.sortPoints();for(var O=0;O<this.nodes.length;O++)if(S<this.nodes[O].x){E=O;break}this.nodes.splice(E,0,new _({x:S,y:A},this)),this.scaleNode(E),this.calculatePoints(),this.emit("change",this.points),this.render()}},scan:{value:function(S){var A=this.getIndexFromX(S),E=A-1;E<0&&(E=0),A>=this.nodes.length&&(A=this.nodes.length-1);var O=this.nodes[E],L=this.nodes[A],F=p.scale(S,O.x,L.x,0,1),U=p.interp(F,O.y,L.y);return this.emit("scan",U),U}},movePoint:{value:function(S,A,E){this.nodes[S].move(A,E),this.scaleNode(S),this.calculatePoints(),this.emit("change",this.points),this.render()}},adjustPoint:{value:function(S,A,E){this.nodes[S].move(this.nodes[S].x+A,this.nodes[S].y+E),this.scaleNode(S),this.calculatePoints(),this.emit("change",this.points),this.render()}},destroyPoint:{value:function(S){this.nodes[S].destroy(),this.calculatePoints(),this.emit("change",this.points),this.render()}},setPoints:{value:function(S){for(var A=this;this.nodes.length;)this.nodes[0].destroy();S.forEach(function(E){A.addPoint(E.x,E.y)}),this.calculatePoints(),this.emit("change",this.points),this.render()}}}),b}(x);i.exports=m},function(i,a,r){var l=function(){function _(m,f){for(var b in f){var g=f[b];g.configurable=!0,g.value&&(g.writable=!0)}Object.defineProperties(m,f)}return function(m,f,b){return f&&_(m.prototype,f),b&&_(m,b),m}}(),u=function _(m,f,b){var g=Object.getOwnPropertyDescriptor(m,f);if(g===void 0){var S=Object.getPrototypeOf(m);return S===null?void 0:_(S,f,b)}else{if("value"in g&&g.writable)return g.value;var A=g.get;return A===void 0?void 0:A.call(b)}},d=function(_,m){if(typeof m!="function"&&m!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof m);_.prototype=Object.create(m&&m.prototype,{constructor:{value:_,enumerable:!1,writable:!0,configurable:!0}}),m&&(_.__proto__=m)},v=function(_,m){if(!(_ instanceof m))throw new TypeError("Cannot call a class as a function")},p=r(7),y=r(6),x=function(_){function m(){v(this,m);var f=[],b={size:[300,150]};u(Object.getPrototypeOf(m.prototype),"constructor",this).call(this,arguments,f,b),this.analyser=null,this.bufferLength=0,this.dataArray=null,this.active=!1,this.source=null,this.init()}return d(m,_),l(m,{buildFrame:{value:function(){this.canvas=new p.SmartCanvas(this.parent),this.element=this.canvas.element}},sizeInterface:{value:function(){this.canvas.resize(this.width,this.height)}},colorInterface:{value:function(){this.canvas.element.style.backgroundColor=this.colors.fill}},render:{value:function(){if(this.active&&requestAnimationFrame(this.render.bind(this)),this.analyser&&this.analyser.getByteFrequencyData(this.dataArray),this.canvas.context.fillStyle=this.colors.fill,this.canvas.context.fillRect(0,0,this.canvas.element.width,this.canvas.element.height),this.source&&this.dataArray)for(var b=this.canvas.element.width/this.bufferLength,g=void 0,S=0,A=this.canvas.element.width/50,E=0;E<this.bufferLength;E=E+A)g=Math.max.apply(null,this.dataArray.subarray(E,E+A)),g/=255,g*=this.canvas.element.height,this.canvas.context.fillStyle=this.colors.accent,this.canvas.context.fillRect(S,this.canvas.element.height-g,b*A,g),S+=b*A}},connect:{value:function(b){this.source&&this.disconnect(),this.analyser=b.context.createAnalyser(),this.analyser.fftSize=2048,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.active=!0,this.source=b,this.source.connect(this.analyser),this.render()}},disconnect:{value:function(){this.source&&this.source.disconnect(this.analyser),this.analyser=null,this.bufferLength=0,this.dataArray=null,this.active=!1,this.source=null}},click:{value:function(){this.active=!this.active&&this.source,this.render()}},customDestroy:{value:function(){this.active=!1}}}),m}(y);i.exports=x},function(i,a,r){var l=function(){function m(f,b){for(var g in b){var S=b[g];S.configurable=!0,S.value&&(S.writable=!0)}Object.defineProperties(f,b)}return function(f,b,g){return b&&m(f.prototype,b),g&&m(f,g),f}}(),u=function m(f,b,g){var S=Object.getOwnPropertyDescriptor(f,b);if(S===void 0){var A=Object.getPrototypeOf(f);return A===null?void 0:m(A,b,g)}else{if("value"in S&&S.writable)return S.value;var E=S.get;return E===void 0?void 0:E.call(g)}},d=function(m,f){if(typeof f!="function"&&f!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof f);m.prototype=Object.create(f&&f.prototype,{constructor:{value:m,enumerable:!1,writable:!0,configurable:!0}}),f&&(m.__proto__=f)},v=function(m,f){if(!(m instanceof f))throw new TypeError("Cannot call a class as a function")},p=r(7),y=r(5),x=r(6),_=function(m){function f(){v(this,f);var b=[],g={size:[30,100]};u(Object.getPrototypeOf(f.prototype),"constructor",this).call(this,arguments,b,g),this.channels=2,this.splitter=null,this.analysers=[],this.bufferLength=0,this.dataArray=null,this.active=!1,this.source=null,this.db=-1/0,this.init(),this.meterWidth=this.canvas.element.width/this.channels,this.render()}return d(f,m),l(f,{buildFrame:{value:function(){this.canvas=new p.SmartCanvas(this.parent),this.element=this.canvas.element}},sizeInterface:{value:function(){this.canvas.resize(this.width,this.height)}},colorInterface:{value:function(){this.canvas.element.style.backgroundColor=this.colors.fill}},render:{value:function(){this.active&&requestAnimationFrame(this.render.bind(this)),this.canvas.context.fillStyle=this.colors.fill,this.canvas.context.fillRect(0,0,this.canvas.element.width,this.canvas.element.height);for(var g=0;g<this.analysers.length;g++){if(this.source){this.analysers[g].getFloatTimeDomainData(this.dataArray);for(var S=0,A=0;A<this.dataArray.length;A++)S+=this.dataArray[A]*this.dataArray[A];S=Math.sqrt(S/this.dataArray.length),this.db=20*Math.log10(S)}else this.db>-200&&this.db!==-1/0?this.db-=1:this.db=-1/0;if(this.db>-70){var E=y.normalize(this.db,-70,5),O=E*E,L=y.scale(O,0,1,this.element.height,0);this.canvas.context.fillStyle=this.colors.accent,this.canvas.context.fillRect(this.meterWidth*g,L,this.meterWidth,this.canvas.element.height-L)}}}},connect:{value:function(g,S){this.source&&this.disconnect(),this.channels=S||g.channelCount||2,this.splitter=g.context.createChannelSplitter(this.channels),this.analysers=[];for(var A=0;A<this.channels;A++){var E=g.context.createAnalyser();E.fftSize=1024,E.smoothingTimeConstant=1,this.splitter.connect(E,A),this.analysers.push(E)}this.bufferLength=this.analysers[0].frequencyBinCount,this.dataArray=new Float32Array(this.bufferLength),this.active=!0,this.meterWidth=this.canvas.element.width/this.channels,this.source=g,this.source.connect(this.splitter),this.render()}},disconnect:{value:function(){this.source&&this.source.disconnect(this.splitter),this.splitter=null,this.analysers=[],this.bufferLength=0,this.dataArray=null,this.active=!1,this.source=null}},click:{value:function(){this.active=!this.active&&this.source,this.render()}},customDestroy:{value:function(){this.active=!1}}}),f}(x);i.exports=_},function(i,a,r){var l=function(){function _(m,f){for(var b in f){var g=f[b];g.configurable=!0,g.value&&(g.writable=!0)}Object.defineProperties(m,f)}return function(m,f,b){return f&&_(m.prototype,f),b&&_(m,b),m}}(),u=function _(m,f,b){var g=Object.getOwnPropertyDescriptor(m,f);if(g===void 0){var S=Object.getPrototypeOf(m);return S===null?void 0:_(S,f,b)}else{if("value"in g&&g.writable)return g.value;var A=g.get;return A===void 0?void 0:A.call(b)}},d=function(_,m){if(typeof m!="function"&&m!==null)throw new TypeError("Super expression must either be null or a function, not "+typeof m);_.prototype=Object.create(m&&m.prototype,{constructor:{value:_,enumerable:!1,writable:!0,configurable:!0}}),m&&(_.__proto__=m)},v=function(_,m){if(!(_ instanceof m))throw new TypeError("Cannot call a class as a function")},p=r(7),y=r(6),x=function(_){function m(){v(this,m);var f=[],b={size:[300,150]};u(Object.getPrototypeOf(m.prototype),"constructor",this).call(this,arguments,f,b),this.analyser=null,this.bufferLength=0,this.dataArray=null,this.active=!1,this.source=null,this.init(),this.render()}return d(m,_),l(m,{buildFrame:{value:function(){this.canvas=new p.SmartCanvas(this.parent),this.element=this.canvas.element}},sizeInterface:{value:function(){this.canvas.resize(this.width,this.height)}},colorInterface:{value:function(){this.canvas.element.style.backgroundColor=this.colors.fill}},render:{value:function(){if(this.active&&requestAnimationFrame(this.render.bind(this)),this.analyser&&this.analyser.getByteTimeDomainData(this.dataArray),this.canvas.context.fillStyle=this.colors.fill,this.canvas.context.fillRect(0,0,this.canvas.element.width,this.canvas.element.height),this.canvas.context.lineWidth=~~(this.height/100+2),this.canvas.context.strokeStyle=this.colors.accent,this.canvas.context.beginPath(),this.source)for(var b=this.canvas.element.width*1/this.bufferLength,g=0,S=0;S<this.bufferLength;S++){var A=this.dataArray[S]/128,E=A*this.canvas.element.height/2;S===0?this.canvas.context.moveTo(g,E):this.canvas.context.lineTo(g,E),g+=b}else this.canvas.context.moveTo(0,this.canvas.element.height/2),this.canvas.context.lineTo(this.canvas.element.width,this.canvas.element.height/2);this.canvas.context.stroke()}},connect:{value:function(b){this.source&&this.disconnect(),this.analyser=b.context.createAnalyser(),this.analyser.fftSize=2048,this.bufferLength=this.analyser.frequencyBinCount,this.dataArray=new Uint8Array(this.bufferLength),this.analyser.getByteTimeDomainData(this.dataArray),this.active=!0,this.source=b,this.source.connect(this.analyser),this.render()}},disconnect:{value:function(){this.source&&this.source.disconnect(this.analyser),this.analyser=null,this.bufferLength=0,this.dataArray=null,this.active=!1,this.source=null}},click:{value:function(){this.active=!this.active&&this.source,this.render()}},customDestroy:{value:function(){this.active=!1}}}),m}(y);i.exports=x},function(i,a,r){var l=function(m){return m&&m.__esModule?m.default:m},u=function(m){return m&&m.__esModule?m:{default:m}},d=function(){function m(f,b){for(var g in b){var S=b[g];S.configurable=!0,S.value&&(S.writable=!0)}Object.defineProperties(f,b)}return function(f,b,g){return b&&m(f.prototype,b),g&&m(f,g),f}}(),v=function(m,f){if(!(m instanceof f))throw new TypeError("Cannot call a class as a function")},p=u(r(39)),y=l(r(7)),x=r(1).colors,_=function(){function m(f,b){v(this,m),this.meta={},this.meta.target=f,this.meta.parent=y.parseElement(f),this.meta.colors={},b?(this.meta.attribute=b.attribute||"nexus-ui",this.meta.title=b.name||!1,this.meta.open=b.open||!1):(this.meta.attribute="nexus-ui",this.meta.title=!1,this.meta.open=!1);var g=x();this.meta.colors.accent=g.accent,this.meta.colors.fill=g.fill,this.meta.colors.light=g.light,this.meta.colors.dark=g.dark,this.meta.colors.mediumLight=g.mediumLight,this.meta.colors.mediumDark=g.mediumDark,this.buildInterface(),this.colorInterface()}return d(m,{buildInterface:{value:function(){var b=this;for(this.meta.parent.style.boxSizing="border-box",this.meta.parent.style.userSelect="none",this.meta.parent.style.mozUserSelect="none",this.meta.parent.style.webkitUserSelect="none",this.meta.contents=document.createElement("div");this.meta.parent.childNodes.length>0;)this.meta.contents.appendChild(this.meta.parent.childNodes[0]);this.meta.contents.style.padding="0px",this.meta.contents.style.boxSizing="border-box",this.meta.title&&(this.meta.titleBar=document.createElement("div"),this.meta.titleBar.innerHTML=this.meta.title,this.meta.titleBar.style.fontFamily="arial",this.meta.titleBar.style.position="relative",this.meta.titleBar.style.color="#888",this.meta.titleBar.style.padding="7px",this.meta.titleBar.style.fontSize="12px",this.meta.button=document.createElement("div"),this.meta.button.style.position="absolute",this.meta.button.style.top="5px",this.meta.button.style.right="5px",this.meta.button.innerHTML="-",this.meta.button.style.padding="0px 5px 2px",this.meta.button.style.lineHeight="12px",this.meta.button.style.fontSize="15px",this.meta.button.style.cursor="pointer",this.meta.button.addEventListener("mouseover",function(){b.meta.button.style.backgroundColor=b.meta.colors.mediumDark}),this.meta.button.addEventListener("mouseleave",function(){b.meta.button.style.backgroundColor=b.meta.colors.mediumLight}),this.meta.button.addEventListener("click",function(){b.meta.open?b.hide():b.show()}),this.meta.titleBar.appendChild(this.meta.button),this.meta.parent.appendChild(this.meta.titleBar)),this.meta.parent.appendChild(this.meta.contents);var g=p.section(this.meta.target,this.meta.attribute);for(var S in g)this[S]=g[S]}},colorInterface:{value:function(){this.meta.title&&(this.meta.button.style.backgroundColor=this.meta.colors.mediumLight,this.meta.button.style.border="solid 0px "+this.meta.colors.fill,this.meta.parent.style.border="solid 1px "+this.meta.colors.mediumLight,this.meta.parent.style.backgroundColor=this.meta.colors.light,this.meta.titleBar.style.backgroundColor=this.meta.colors.fill)}},show:{value:function(){this.meta.contents.style.display="block",this.meta.open=!0}},hide:{value:function(){this.meta.contents.style.display="none",this.meta.open=!1}},colorize:{value:function(b,g){for(var S in this)this[S].colorize&&this[S].colorize(b,g);this.meta.colors[b]=g,this.colorInterface()}},empty:{value:function(){for(var b in this)this[b].destroy&&this[b].destroy()}}}),m}();i.exports=_},function(i,a,r){var l=function(_){return _&&_.__esModule?_.default:_};Object.defineProperty(a,"__esModule",{value:!0});var u=l(r(7)),d=l(r(2)),v=function(_,m){var f=_.type;return m[f]?m[f]++:m[f]=1,f+m[f]},p=function(_,m,f){f=f||{};for(var b=0;b<_.attributes.length;b++){var g=_.attributes[b];f[g.nodeName]=g.nodeValue}m=m[0].toUpperCase()+m.slice(1);var S=new d[m](_,f);return S.id=_.id,S},y=function(_,m){m=m||"nexus-ui";for(var f={},b=u.parseElement(_),g={},S=b.getElementsByTagName("*"),A=[],E=0;E<S.length;E++)A.push(S[E]);for(var E=0;E<A.length;E++){var O=A[E].getAttribute(m);if(O){var L=!1;for(var F in d)O.toLowerCase()===F.toLowerCase()&&(L=F);console.log(L);var U=p(A[E],L);if(U.id)g[U.id]=U;else{var X=v(U,f);g[X]=U}}}return g},x=function(_,m,f){var b=document.createElement("div");return f=f||{},m?m=u.parseElement(m):m=document.body,m.appendChild(b),f.target=b,f.size&&(b.style.width=f.size[0]+"px",b.style.height=f.size[1]+"px"),p(b,_,f)};a.element=p,a.section=y,a.add=x},function(i,a,r){var l=function(y){return y&&y.__esModule?y.default:y},u=function(){function y(x,_){for(var m in _){var f=_[m];f.configurable=!0,f.value&&(f.writable=!0)}Object.defineProperties(x,_)}return function(x,_,m){return _&&y(x.prototype,_),m&&y(x,m),x}}(),d=function(y,x){if(!(y instanceof x))throw new TypeError("Cannot call a class as a function")},v=l(r(5)),p=function(){function y(){d(this,y),this.scale=[],this.mode={output:"frequency",input:"step"},this.etmajor=[261.62558,293.664764,329.627563,349.228241,391.995422,440,493.883301,523.25116],this.root=v.mtof(60),this.createScale(0,2,4,5,7,9,11)}return u(y,{note:{value:function(_,m){var f=void 0;return this.mode.output==="frequency"?f=this.frequency(_,m):this.mode.output==="ratio"?f=this.ratio(_,m):this.mode.output==="MIDI"?f=this.MIDI(_,m):f=this.frequency(_,m),f}},frequency:{value:function(_,m){(this.mode.input==="midi"||this.mode.input==="MIDI")&&(this.stepIn+=60);var f=Math.floor(_/this.scale.length);m&&(f+=m);for(var b=_%this.scale.length;b<0;)b+=this.scale.length;var g=this.scale[b],S=this.root*g;return S=S*Math.pow(2,f),S=Math.floor(S*1e11)/1e11,S}},ratio:{value:function(_,m){(this.mode.input==="midi"||this.mode.input==="MIDI")&&(this.stepIn+=60);var f=Math.floor(_/this.scale.length);m&&(f+=m);var b=_%this.scale.length,g=Math.pow(2,f)*this.scale[b];return g=Math.floor(g*1e11)/1e11,g}},MIDI:{value:function(_,m){var f=this.frequency(_,m),b=69+12*Math.log(f/440)/Math.log(2);return b=Math.floor(b*1e9)/1e9,b}},createScale:{value:function(){for(var _=[],m=0;m<arguments.length;m++)_.push(v.mtof(60+arguments[m]));this.loadScaleFromFrequencies(_)}},createJIScale:{value:function(){this.scale=[];for(var _=0;_<arguments.length;_++)this.scale.push(arguments[_])}},loadScaleFromFrequencies:{value:function(_){this.scale=[];for(var m=0;m<_.length;m++)this.scale.push(_[m]/_[0])}},loadScale:{value:function(_){var m=this.scales[_].frequencies;this.loadScaleFromFrequencies(m)}},search:{value:function(_){var m=[];for(var f in this.scales)f.toLowerCase().indexOf(_.toLowerCase())!==-1&&m.push(f);return m}},chord:{value:function(_){for(var m=[],f=0;f<_.length;f++)m.push(this.note(_[f]));return m}}}),y}();i.exports=p},function(i,a){var r=function(){function d(v,p){for(var y in p){var x=p[y];x.configurable=!0,x.value&&(x.writable=!0)}Object.defineProperties(v,p)}return function(v,p,y){return p&&d(v.prototype,p),y&&d(v,y),v}}(),l=function(d,v){if(!(d instanceof v))throw new TypeError("Cannot call a class as a function")},u=function(){function d(){for(var v=arguments.length,p=Array(v>1?v-1:0),y=1;y<v;y++)p[y-1]=arguments[y];var x=arguments[0]===void 0?3:arguments[0];l(this,d),x<0&&(x=1),this.length=x,this.onVals=p,this.array=new Array(x).fill(0),p.length>0&&this.on.apply(this,p)}return r(d,{select:{value:function(p){return this.array.fill(0),this.array[p]=1,this.array}},flip:{value:function(){for(var p=arguments.length,y=Array(p),x=0;x<p;x++)y[x]=arguments[x];var _=this.array;return y.length>0?y.forEach(function(m){m>_.length-1?console.warn("Warning: AnonRadio["+m+"] does not exist"):_[m]=_[m]?0:1}):_.forEach(function(m,f,b){b[f]=m?0:1}),_}},on:{value:function(){for(var p=arguments.length,y=Array(p),x=0;x<p;x++)y[x]=arguments[x];var _=this.array;return y.length>0?y.forEach(function(m){m>_.length-1?console.warn("Warning: AnonRadio["+m+"] exceeds size of object"):(_[m]===1&&console.warn("Warning: AnonRadio["+m+"] was already on."),_[m]=1)}):_.fill(1),_}},off:{value:function(){for(var p=arguments.length,y=Array(p),x=0;x<p;x++)y[x]=arguments[x];var _=this.array;return y.length>0?y.forEach(function(m){_[m]=0}):_.fill(0),_}}}),d}();i.exports=u},function(i,a,r){var l=r(43);i.exports=l,typeof window<"u"&&(window.WAAClock=l)},function(i,a,r){(function(l){var u={toleranceLate:.1,toleranceEarly:.001},d=function(p,y,x){this.clock=p,this.func=x,this._cleared=!1,this.toleranceLate=p.toleranceLate,this.toleranceEarly=p.toleranceEarly,this._latestTime=null,this._earliestTime=null,this.deadline=null,this.repeatTime=null,this.schedule(y)};d.prototype.clear=function(){return this.clock._removeEvent(this),this._cleared=!0,this},d.prototype.repeat=function(p){if(p===0)throw new Error("delay cannot be 0");return this.repeatTime=p,this.clock._hasEvent(this)||this.schedule(this.deadline+this.repeatTime),this},d.prototype.tolerance=function(p){return typeof p.late=="number"&&(this.toleranceLate=p.late),typeof p.early=="number"&&(this.toleranceEarly=p.early),this._refreshEarlyLateDates(),this.clock._hasEvent(this)&&(this.clock._removeEvent(this),this.clock._insertEvent(this)),this},d.prototype.isRepeated=function(){return this.repeatTime!==null},d.prototype.schedule=function(p){this._cleared=!1,this.deadline=p,this._refreshEarlyLateDates(),this.clock.context.currentTime>=this._earliestTime?this._execute():this.clock._hasEvent(this)?(this.clock._removeEvent(this),this.clock._insertEvent(this)):this.clock._insertEvent(this)},d.prototype.timeStretch=function(p,y){this.isRepeated()&&(this.repeatTime=this.repeatTime*y);var x=p+y*(this.deadline-p);if(this.isRepeated())for(;this.clock.context.currentTime>=x-this.toleranceEarly;)x+=this.repeatTime;this.schedule(x)},d.prototype._execute=function(){this.clock._started!==!1&&(this.clock._removeEvent(this),this.clock.context.currentTime<this._latestTime?this.func(this):(this.onexpired&&this.onexpired(this),console.warn("event expired")),!this.clock._hasEvent(this)&&this.isRepeated()&&!this._cleared&&this.schedule(this.deadline+this.repeatTime))},d.prototype._refreshEarlyLateDates=function(){this._latestTime=this.deadline+this.toleranceLate,this._earliestTime=this.deadline-this.toleranceEarly};var v=i.exports=function(p,y){y=y||{},this.tickMethod=y.tickMethod||"ScriptProcessorNode",this.toleranceEarly=y.toleranceEarly||u.toleranceEarly,this.toleranceLate=y.toleranceLate||u.toleranceLate,this.context=p,this._events=[],this._started=!1};v.prototype.setTimeout=function(p,y){return this._createEvent(p,this._absTime(y))},v.prototype.callbackAtTime=function(p,y){return this._createEvent(p,y)},v.prototype.timeStretch=function(p,y,x){return y.forEach(function(_){_.timeStretch(p,x)}),y},v.prototype.start=function(){if(this._started===!1){var p=this;if(this._started=!0,this._events=[],this.tickMethod==="ScriptProcessorNode"){var y=256;this._clockNode=this.context.createScriptProcessor(y,1,1),this._clockNode.connect(this.context.destination),this._clockNode.onaudioprocess=function(){l.nextTick(function(){p._tick()})}}else if(this.tickMethod!=="manual")throw new Error("invalid tickMethod "+this.tickMethod)}},v.prototype.stop=function(){this._started===!0&&(this._started=!1,this._clockNode.disconnect())},v.prototype._tick=function(){for(var p=this._events.shift();p&&p._earliestTime<=this.context.currentTime;)p._execute(),p=this._events.shift();p&&this._events.unshift(p)},v.prototype._createEvent=function(p,y){return new d(this,y,p)},v.prototype._insertEvent=function(p){this._events.splice(this._indexByTime(p._earliestTime),0,p)},v.prototype._removeEvent=function(p){var y=this._events.indexOf(p);y!==-1&&this._events.splice(y,1)},v.prototype._hasEvent=function(p){return this._events.indexOf(p)!==-1},v.prototype._indexByTime=function(p){for(var y=0,x=this._events.length,_;y<x;)_=Math.floor((y+x)/2),this._events[_]._earliestTime<p?y=_+1:x=_;return y},v.prototype._absTime=function(p){return p+this.context.currentTime},v.prototype._relTime=function(p){return p-this.context.currentTime}}).call(a,r(44))},function(i,a){var r=i.exports={},l,u;function d(){throw new Error("setTimeout has not been defined")}function v(){throw new Error("clearTimeout has not been defined")}(function(){try{typeof setTimeout=="function"?l=setTimeout:l=d}catch{l=d}try{typeof clearTimeout=="function"?u=clearTimeout:u=v}catch{u=v}})();function p(E){if(l===setTimeout)return setTimeout(E,0);if((l===d||!l)&&setTimeout)return l=setTimeout,setTimeout(E,0);try{return l(E,0)}catch{try{return l.call(null,E,0)}catch{return l.call(this,E,0)}}}function y(E){if(u===clearTimeout)return clearTimeout(E);if((u===v||!u)&&clearTimeout)return u=clearTimeout,clearTimeout(E);try{return u(E)}catch{try{return u.call(null,E)}catch{return u.call(this,E)}}}var x=[],_=!1,m,f=-1;function b(){!_||!m||(_=!1,m.length?x=m.concat(x):f=-1,x.length&&g())}function g(){if(!_){var E=p(b);_=!0;for(var O=x.length;O;){for(m=x,x=[];++f<O;)m&&m[f].run();f=-1,O=x.length}m=null,_=!1,y(E)}}r.nextTick=function(E){var O=new Array(arguments.length-1);if(arguments.length>1)for(var L=1;L<arguments.length;L++)O[L-1]=arguments[L];x.push(new S(E,O)),x.length===1&&!_&&p(g)};function S(E,O){this.fun=E,this.array=O}S.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={};function A(){}r.on=A,r.addListener=A,r.once=A,r.off=A,r.removeListener=A,r.removeAllListeners=A,r.emit=A,r.prependListener=A,r.prependOnceListener=A,r.listeners=function(E){return[]},r.binding=function(E){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(E){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}}])})}(Er)),Er.exports}l0();class c0{constructor(){this.meter=null,this.isInitialized=!1,this.meterWrapper=null,this.meterPlaceholder=null,this.meterSource=null,this.settingsPanel=null,this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.permissionState="unknown",this.errorMessage=null}initialize(){this.isInitialized||(console.log("📊 [MeterController] Starting initialization..."),this.cacheDOMElements(),this.setupEventListeners(),this.updateUI(),T.on("micPaintStateChanged",n=>this.handlePitchPaintingToggle(n)),this.isInitialized=!0,console.log("📊 [MeterController] Initialization complete. Elements found:",{meterWrapper:!!this.meterWrapper,meterPlaceholder:!!this.meterPlaceholder,settingsPanel:!!this.settingsPanel}))}cacheDOMElements(){console.log("🔍 [MeterController] Caching DOM elements..."),this.meterWrapper=document.getElementById("mic-meter-wrapper"),this.meterPlaceholder=document.getElementById("meter-placeholder"),this.settingsPanel=document.getElementById("meter-settings-panel"),this.settingsBtn=document.getElementById("meter-settings-btn"),this.sizeSelect=document.getElementById("meter-size-select"),this.fpsSelect=document.getElementById("meter-fps-select"),this.batterySaverCheckbox=document.getElementById("meter-battery-saver"),this.calibrateBtn=document.getElementById("meter-calibrate-btn"),this.resetBtn=document.getElementById("meter-reset-btn"),console.log("🔍 [MeterController] DOM Elements status:",{meterWrapper:this.meterWrapper?"found":"NOT FOUND",meterPlaceholder:this.meterPlaceholder?"found":"NOT FOUND",settingsBtn:this.settingsBtn?"found":"NOT FOUND",settingsPanel:this.settingsPanel?"found":"NOT FOUND"}),this.meterWrapper&&console.log("🔍 [MeterWrapper] Current state:",{innerHTML:this.meterWrapper.innerHTML.substring(0,100)+"...",classList:Array.from(this.meterWrapper.classList),clientWidth:this.meterWrapper.clientWidth,clientHeight:this.meterWrapper.clientHeight,style:this.meterWrapper.style.cssText})}setupEventListeners(){this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>this.toggleSettingsPanel()),this.sizeSelect&&this.sizeSelect.addEventListener("change",n=>this.handleSizeChange(n.target.value)),this.fpsSelect&&this.fpsSelect.addEventListener("change",n=>this.handleFpsChange(parseInt(n.target.value))),this.batterySaverCheckbox&&this.batterySaverCheckbox.addEventListener("change",n=>this.handleBatterySaverChange(n.target.checked)),this.calibrateBtn&&this.calibrateBtn.addEventListener("click",()=>this.handleAutoCalibrate()),this.resetBtn&&this.resetBtn.addEventListener("click",()=>this.handleReset())}async handlePitchPaintingToggle(n){console.log("📊 [Meter] Pitch painting toggled:",n),n?await this.startMeter():this.stopMeter()}async startMeter(){if(console.log("📊 [MeterController] startMeter() called"),this.meter){console.log("📊 [MeterController] Meter already running");return}try{console.log("📊 [MeterController] Checking microphone access..."),await this.ensureMicrophoneAccess();const n=rt.context;if(console.log("📊 [MeterController] Audio context state:",{exists:!!n,state:n?n.state:"no context",sampleRate:n?n.sampleRate:"no context"}),!n||n.state==="suspended")throw new Error("Audio context not available or suspended");console.log("📊 [MeterController] Creating meter from existing mic..."),await this.createMeterFromExistingMic(),this.updateUI(),console.log("🎉 [MeterController] Meter started successfully!")}catch(n){console.error("❌ [MeterController] Failed to start meter:",n),this.handleMeterError(n)}}async ensureMicrophoneAccess(){this.permissionState="pending",this.updateUI();try{this.permissionState="granted"}catch{throw this.permissionState="denied",new Error("Microphone access denied. Please check your browser permissions.")}}async createMeterFromExistingMic(){if(console.log("📊 [Meter] Creating custom meter from existing mic..."),!this.meterWrapper)throw new Error("Meter wrapper not found - cannot create meter");this.meterWrapper.innerHTML="";const n=this.getMeterDimensions();console.log("📊 [Meter] Dimensions:",n);const i=(await Su(async()=>{const{default:r}=await import("./Meter-Ccaw6VeE.js");return{default:r}},[])).default,a=(await Su(async()=>{const{default:r}=await Promise.resolve().then(()=>s0);return{default:r}},void 0)).default;if(!a||!a.micSplitter)throw new Error("PitchPaintService microphone splitter not available");try{this.meter=new i({target:this.meterWrapper,size:n,fps:this.settings.fps,colors:{fill:"#1a1a1a",accent:"#00ff88"},floorDb:this.settings.noiseFloor,ceilingDb:5}),console.log("📊 [Meter] Custom meter created successfully")}catch(r){throw console.error("❌ [Meter] Failed to create custom meter:",r),r}try{this.meter.connect(a.micSplitter),this.meterSource=a.micSplitter,console.log("📊 [Meter] Connected to mic splitter successfully")}catch(r){throw console.error("❌ [Meter] Audio connection failed:",r),r}this.meterWrapper.classList.add("active"),this.meterWrapper.classList.remove("error"),console.log("✅ [Meter] Meter fully created and connected")}stopMeter(){this.meter&&(this.meter.disconnect(),this.meter.destroy(),this.meter=null),this.meterSource&&(this.meterSource=null),this.meterWrapper.innerHTML=`
      <div class="meter-placeholder" id="meter-placeholder">
      </div>
    `,this.meterPlaceholder=document.getElementById("meter-placeholder"),this.meterWrapper.classList.remove("active"),this.updateUI(),console.log("MeterController: NexusUI Meter stopped")}getMeterDimensions(){const n=this.meterWrapper.clientWidth||200,i=this.meterWrapper.clientHeight||100;if(this.meterWrapper.classList.contains("mic-meter-wrapper-inline"))return[n,36];if(this.meterWrapper.classList.contains("mic-meter-wrapper-vertical"))return[n,i];const l=this.settings.size==="compact"?48:72;return[n,l]}updateUI(){if(this.meterWrapper){if(this.meterWrapper.classList.remove("compact","wide"),this.meterWrapper.classList.add(this.settings.size),this.updateAccessibilityAttributes(),this.meterPlaceholder){let n="",i="";const a=this.meterWrapper.classList.contains("mic-meter-wrapper-inline");this.permissionState==="denied"?(n=a?"Mic access denied":"Microphone access denied. Click to retry.",i="error"):this.permissionState==="pending"?(n=a?"Requesting access...":"Requesting microphone access...",i="pending"):T.state.paint.isMicPaintActive?this.meter?(n="",i="active"):(n=a?"Starting...":"Starting meter...",i="pending"):(n="",i="disabled");const r=this.meterPlaceholder.querySelector(".meter-status-text");r&&(r.textContent=n),this.meterWrapper.classList.remove("error","pending","disabled"),i&&this.meterWrapper.classList.add(i)}this.updateSettingsUI()}}updateAccessibilityAttributes(){this.meterWrapper&&(this.meterWrapper.setAttribute("role","meter"),this.meterWrapper.setAttribute("aria-label","Microphone Level Meter"),this.meter&&this.meter.active?(this.meterWrapper.setAttribute("aria-valuenow","0"),this.meterWrapper.setAttribute("aria-valuemin",this.settings.noiseFloor.toString()),this.meterWrapper.setAttribute("aria-valuemax","5"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level active")):(this.meterWrapper.removeAttribute("aria-valuenow"),this.meterWrapper.removeAttribute("aria-valuemin"),this.meterWrapper.removeAttribute("aria-valuemax"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level inactive")),window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches&&this.meterWrapper.setAttribute("data-reduced-motion","true"))}updateSettingsUI(){this.sizeSelect&&(this.sizeSelect.value=this.settings.size),this.fpsSelect&&(this.fpsSelect.value=this.settings.fps),this.batterySaverCheckbox&&(this.batterySaverCheckbox.checked=this.settings.batterySaver)}toggleSettingsPanel(){this.settingsPanel&&this.settingsPanel.classList.toggle("hidden")}handleSizeChange(n){if(this.settings.size=n,this.meter){const i=this.getMeterDimensions();this.meter.resize(i[0],i[1])}this.updateUI()}handleFpsChange(n){this.settings.fps=n}handleBatterySaverChange(n){this.settings.batterySaver=n}async handleAutoCalibrate(){if(this.meter){this.calibrateBtn.disabled=!0,this.calibrateBtn.textContent="Stay quiet...";try{await new Promise(n=>setTimeout(n,2e3)),this.settings.noiseFloor=-65,this.settings.autoCalibrated=!0,this.calibrateBtn.textContent="Calibrated ✓",setTimeout(()=>{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1},1500),console.log("MeterController: Auto-calibration complete (simulated), noise floor:",this.settings.noiseFloor)}catch(n){console.error("Calibration failed:",n),this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1}}}handleReset(){if(this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.updateSettingsUI(),this.meter){const n=this.getMeterDimensions();this.meter.resize(n[0],n[1])}}handleMeterError(n){this.errorMessage=n.message,this.meterWrapper.classList.add("error"),console.error("MeterController: Error occurred:",n),(n.message.includes("denied")||n.message.includes("permission"))&&this.showPermissionRetryPrompt(),this.updateUI()}showPermissionRetryPrompt(){let n=this.meterWrapper.querySelector(".meter-permission-prompt");if(!n){n=document.createElement("div"),n.className="meter-permission-prompt",n.innerHTML=`
        <p>Microphone access is required for the level meter.</p>
        <button class="meter-retry-btn">Grant Permission</button>
        <button class="meter-help-btn">Help</button>
      `,this.meterWrapper.appendChild(n);const i=n.querySelector(".meter-retry-btn"),a=n.querySelector(".meter-help-btn");i.addEventListener("click",()=>this.retryPermission()),a.addEventListener("click",()=>this.showPermissionHelp())}}async retryPermission(){try{const n=this.meterWrapper.querySelector(".meter-permission-prompt");n&&n.remove(),this.permissionState="unknown",this.meterWrapper.classList.remove("error"),T.state.paint.isMicPaintActive&&await this.startMeter()}catch(n){this.handleMeterError(n)}}showPermissionHelp(){alert(`
To enable the microphone level meter:

1. Look for a microphone icon in your browser's address bar
2. Click it and select "Allow"
3. If you don't see the icon, go to your browser settings:
   - Chrome: Settings > Privacy and security > Site Settings > Microphone
   - Firefox: Settings > Privacy & Security > Permissions > Microphone
   - Safari: Settings > Websites > Microphone

4. Find this website and set it to "Allow"
5. Refresh the page if needed
    `)}dispose(){this.stopMeter(),this.isInitialized=!1,console.log("MeterController: Disposed")}}const h0=new c0;class u0{constructor(){this.element=null,this.isVisible=!1,this.hideTimeout=null}initialize(){this.element=document.createElement("div"),this.element.className="zoom-indicator",this.element.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        `,document.body.appendChild(this.element),T.on("zoomIn",()=>this.show()),T.on("zoomOut",()=>this.show())}show(){if(!this.element)return;let n=100,i="";if(It.getViewportInfo){const a=It.getViewportInfo();n=Math.round(a.zoomLevel*100),a.canSeeFullRange?i=" (Full Range)":i=` (~${Math.floor(a.endRow-a.startRow+1)} semitones)`}this.element.textContent=`Zoom: ${n}%${i}`,this.element.style.opacity="1",this.isVisible=!0,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>this.hide(),2e3)}hide(){!this.element||!this.isVisible||(this.element.style.opacity="0",this.isVisible=!1,clearTimeout(this.hideTimeout))}dispose(){this.element&&(document.body.removeChild(this.element),this.element=null),clearTimeout(this.hideTimeout)}}const d0=new u0,kd={enableModulationTool(){T.setSelectedTool("modulation"),console.log("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),console.log("[MODULATION TEST] Click marker labels to toggle 2:3 ↔ 3:2"),console.log("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const n=this.findNearestGridLine(200),i=this.findMeasureIndexForX(n.x),a=T.addModulationMarker(i,bs.COMPRESSION_2_3,n.x,n.columnIndex);return console.log("[MODULATION TEST] Added test marker at measure",i,"columnIndex=",n.columnIndex,"x=",n.x,"(snapped from",200,")"),a},addTestMarker2(){const n=this.findNearestGridLine(400),i=this.findMeasureIndexForX(n.x),a=T.addModulationMarker(i,bs.EXPANSION_3_2,n.x,n.columnIndex);return console.log("[MODULATION TEST] Added test marker 2 at measure",i,"columnIndex=",n.columnIndex,"x=",n.x,"(snapped from",400,")"),a},findNearestGridLine(s){const n=T.state;let i=0,a=0,r=1/0,l=0;for(let u=0;u<n.columnWidths.length;u++){const d=Math.abs(l-s);d<r&&(r=d,a=l,i=u);const v=n.columnWidths[u]||0;l+=v*n.cellWidth}return console.log("[MODULATION TEST] findNearestGridLine:",{targetX:s,closestColumnIndex:i,closestX:a,minDistance:r}),{columnIndex:i,x:a}},findMeasureIndexForX(s){const n=T.state.cellWidth||40,i=5,a=Math.round(s/n);return Math.max(1,Math.round(a/i))},clearAllMarkers(){[...T.state.modulationMarkers||[]].forEach(n=>{T.removeModulationMarker(n.id)}),console.log("[MODULATION TEST] Cleared all markers")},testMapping(){const s=T.state.baseMicrobeatPx||T.state.cellWidth||40;if(console.log("[MODULATION TEST] Base microbeat pixels:",s),console.log("[MODULATION TEST] Modulation markers:",T.state.modulationMarkers),window.getModulationMapping){const n=window.getModulationMapping();console.log("[MODULATION TEST] Coordinate mapping:",n),[0,100,200,300,400,500].forEach(a=>{const r=n.canvasXToMicrobeat(a),l=n.microbeatToCanvasX(r);console.log(`[MODULATION TEST] x=${a} → microbeat=${r.toFixed(3)} → x=${l.toFixed(1)}`)})}},testVisualExpansion(){console.log("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const s=this.addTestMarker2();console.log("[MODULATION TEST] Added 3:2 expansion marker:",s),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show expansion after x=400"),console.log("[MODULATION TEST] Container should be wider to accommodate expansion"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){console.log("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const s=this.addTestMarker();console.log("[MODULATION TEST] Added 2:3 compression marker:",s),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show compression after x=200"),console.log("[MODULATION TEST] Container should adjust to accommodate compression"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){console.log("[MODULATION TEST] Current state:",{selectedTool:T.state.selectedTool,modulationMarkers:T.state.modulationMarkers,baseMicrobeatPx:T.state.baseMicrobeatPx,cellWidth:T.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=kd);function f0(){d0.initialize(),document.addEventListener("keydown",s=>{const n=document.activeElement.tagName.toLowerCase();["input","textarea"].includes(n)||((s.ctrlKey||s.metaKey)&&(s.key==="+"||s.key==="=")&&(s.preventDefault(),T.emit("zoomIn")),(s.ctrlKey||s.metaKey)&&s.key==="-"&&(s.preventDefault(),T.emit("zoomOut")),(s.ctrlKey||s.metaKey)&&s.key==="0"&&(s.preventDefault(),It.resetZoom&&It.resetZoom()))})}function p0(){window.debugZoom={info:()=>It.getViewportInfo?It.getViewportInfo():"Viewport info not available",zoomTo:s=>{B.debug("Debug Tools",`Setting zoom to ${s}`,null,"zoom")},scrollTo:s=>{if(B.debug("Debug Tools",`Scrolling to position ${s}`,null,"scroll"),It.scroll){const i=It.getViewportInfo().scrollPosition*(T.state.fullRowData.length*T.state.cellHeight*.5),a=s*(T.state.fullRowData.length*T.state.cellHeight*.5);It.scroll(a-i)}},goToNote:s=>{It.scrollToNote?It.scrollToNote(s):B.warn("Debug Tools",`scrollToNote not available. Requested: ${s}`,null,"debug")}}}let Mu=!1;window.initAudio=async()=>{if(Mu)return!0;try{return rt.context.state!=="running"&&(await rt.start(),B.info("Main.js","AudioContext started successfully")),Mu=!0,!0}catch(s){return B.error("Main.js","Could not start AudioContext",s),!1}};document.addEventListener("DOMContentLoaded",()=>{B.info("Main.js","DOMContentLoaded event fired"),B.section("STARTING INITIALIZATION"),jn.init(),(()=>{const a=jn.get("appContainer")||document.getElementById("app-container");a&&["click","keydown","touchstart"].forEach(l=>{a.addEventListener(l,window.initAudio,{once:!0})})})(),T.state.fullRowData=vv;const n=It.init();uc.setContexts(n),_e.init(),ki.init(),Xv(),Jv(),Kv(),Qv.init(),gy.init(),Al.init(),gu.init(),Ob(),mb(),Lb(),zb.init(),_c.init(),$r.init(),m0(),B.initStart("Static Waveform Visualizer"),Vb()?B.initSuccess("Static Waveform Visualizer"):B.initFailed("Static Waveform Visualizer"),jb.init(),B.initStart("Paint components"),Cc.initialize(),Kl.initialize(),i0.initialize(),h0.initialize(),B.initSuccess("Paint components"),f0(),p0(),B.section("SETTING UP STATE SUBSCRIPTIONS");const i=()=>{Al.renderPitchGrid(),Al.renderDrumGrid(),gu.render()};T.on("notesChanged",i),T.on("stampPlacementsChanged",i),T.on("tripletPlacementsChanged",i),T.on("modulationMarkersChanged",()=>{B.event("Main","modulationMarkersChanged event received, recalculating layout",null,"state"),It.recalculateLayout(),B.debug("Main","Layout recalculated for modulation, calling renderAll()",null,"state"),i(),B.debug("Main","renderAll() completed, calling renderMacrobeatTools() for modulation",null,"state"),Sr.renderMacrobeatTools(),B.debug("Main","modulationMarkersChanged handling complete",null,"state")}),T.on("rhythmStructureChanged",()=>{B.event("Main","rhythmStructureChanged event received, recalculating layout",null,"state"),It.recalculateLayout(),B.debug("Main","Layout recalculated, calling renderAll()",null,"state"),i(),B.debug("Main","renderAll() completed, calling renderMacrobeatTools()",null,"state"),Sr.renderMacrobeatTools(),B.debug("Main","rhythmStructureChanged handling complete",null,"state")}),T.on("layoutConfigChanged",()=>{i(),Sr.renderMacrobeatTools()}),T.on("zoomIn",()=>{B.event("Main","Zoom in event received",null,"zoom"),It.zoomIn()}),T.on("zoomOut",()=>{B.event("Main","Zoom out event received",null,"zoom"),It.zoomOut()}),B.section("PERFORMING INITIAL RENDER"),T.setSelectedTool("note"),T.setSelectedNote("circle","#4a90e2"),B.section("INITIALIZATION COMPLETE"),window.ModulationTest=kd,setTimeout(()=>{It.getViewportInfo},1e3)});function m0(){const s=document.querySelector(".rhythm-stamps-container"),n=document.querySelector(".rhythm-tab-sidebar");document.querySelector(".rhythm-tab-content");const i=document.querySelectorAll(".rhythm-tab-button"),a=document.querySelectorAll(".rhythm-tab-panel");s&&window.getComputedStyle(s),n&&window.getComputedStyle(n),!(!i.length||!a.length)&&i.forEach((r,l)=>{r.addEventListener("click",u=>{const d=r.getAttribute("data-rhythm-tab");i.forEach(p=>p.classList.remove("active")),a.forEach(p=>p.classList.remove("active")),r.classList.add("active");const v=document.getElementById(`${d}-panel`);v&&v.classList.add("active")})})}
