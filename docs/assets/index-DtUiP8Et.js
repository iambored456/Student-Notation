var Yg=Object.defineProperty;var Zg=(n,e,s)=>e in n?Yg(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var Ms=(n,e,s)=>Zg(n,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const c of r.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(a){if(a.ep)return;a.ep=!0;const r=s(a);fetch(a.href,r)}})();const Qg="modulepreload",Jg=function(n){return"/Student-Notation/"+n},sd={},ga=function(e,s,i){let a=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),h=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));a=Promise.allSettled(s.map(m=>{if(m=Jg(m),m in sd)return;sd[m]=!0;const f=m.endsWith(".css"),g=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${g}`))return;const b=document.createElement("link");if(b.rel=f?"stylesheet":Qg,f||(b.as="script"),b.crossOrigin="",b.href=m,h&&b.setAttribute("nonce",h),document.head.appendChild(b),f)return new Promise((w,x)=>{b.addEventListener("load",w),b.addEventListener("error",()=>x(new Error(`Unable to preload CSS for ${m}`)))})}))}function r(c){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=c,window.dispatchEvent(h),!h.defaultPrevented)throw c}return a.then(c=>{for(const h of c||[])h.status==="rejected"&&r(h.reason);return e().catch(r)})};function Kg(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var gr={exports:{}};/*! For license information please see Tone.js.LICENSE.txt */var tv=gr.exports,nd;function ev(){return nd||(nd=1,function(n,e){(function(s,i){n.exports=i()})(typeof self<"u"?self:tv,()=>(()=>{var s={871:function(c,h,m){(function(f,g,b,w){var x=function(it,ht,ut){return{endTime:ht,insertTime:ut,type:"exponentialRampToValue",value:it}},A=function(it,ht,ut){return{endTime:ht,insertTime:ut,type:"linearRampToValue",value:it}},P=function(it,ht){return{startTime:ht,type:"setValue",value:it}},M=function(it,ht,ut){return{duration:ut,startTime:ht,type:"setValueCurve",values:it}},I=function(it,ht,ut){var Ct=ut.startTime,dt=ut.target,Nt=ut.timeConstant;return dt+(ht-dt)*Math.exp((Ct-it)/Nt)},D=function(it){return it.type==="exponentialRampToValue"},R=function(it){return it.type==="linearRampToValue"},H=function(it){return D(it)||R(it)},j=function(it){return it.type==="setValue"},F=function(it){return it.type==="setValueCurve"},Y=function it(ht,ut,Ct,dt){var Nt=ht[ut];return Nt===void 0?dt:H(Nt)||j(Nt)?Nt.value:F(Nt)?Nt.values[Nt.values.length-1]:I(Ct,it(ht,ut-1,Nt.startTime,dt),Nt)},tt=function(it,ht,ut,Ct,dt){return ut===void 0?[Ct.insertTime,dt]:H(ut)?[ut.endTime,ut.value]:j(ut)?[ut.startTime,ut.value]:F(ut)?[ut.startTime+ut.duration,ut.values[ut.values.length-1]]:[ut.startTime,Y(it,ht-1,ut.startTime,dt)]},nt=function(it){return it.type==="cancelAndHold"},at=function(it){return it.type==="cancelScheduledValues"},gt=function(it){return nt(it)||at(it)?it.cancelTime:D(it)||R(it)?it.endTime:it.startTime},_t=function(it,ht,ut,Ct){var dt=Ct.endTime,Nt=Ct.value;return ut===Nt?Nt:0<ut&&0<Nt||ut<0&&Nt<0?ut*Math.pow(Nt/ut,(it-ht)/(dt-ht)):0},Mt=function(it,ht,ut,Ct){return ut+(it-ht)/(Ct.endTime-ht)*(Ct.value-ut)},me=function(it,ht){var ut=ht.duration,Ct=ht.startTime,dt=ht.values;return function(Nt,jt){var Bt=Math.floor(jt),ee=Math.ceil(jt);return Bt===ee?Nt[Bt]:(1-(jt-Bt))*Nt[Bt]+(1-(ee-jt))*Nt[ee]}(dt,(it-Ct)/ut*(dt.length-1))},Wt=function(it){return it.type==="setTarget"},Qt=function(){return w(function it(ht){b(this,it),this._automationEvents=[],this._currenTime=0,this._defaultValue=ht},[{key:Symbol.iterator,value:function(){return this._automationEvents[Symbol.iterator]()}},{key:"add",value:function(it){var ht=gt(it);if(nt(it)||at(it)){var ut=this._automationEvents.findIndex(function(Ne){return at(it)&&F(Ne)?Ne.startTime+Ne.duration>=ht:gt(Ne)>=ht}),Ct=this._automationEvents[ut];if(ut!==-1&&(this._automationEvents=this._automationEvents.slice(0,ut)),nt(it)){var dt=this._automationEvents[this._automationEvents.length-1];if(Ct!==void 0&&H(Ct)){if(dt!==void 0&&Wt(dt))throw new Error("The internal list is malformed.");var Nt=dt===void 0?Ct.insertTime:F(dt)?dt.startTime+dt.duration:gt(dt),jt=dt===void 0?this._defaultValue:F(dt)?dt.values[dt.values.length-1]:dt.value,Bt=D(Ct)?_t(ht,Nt,jt,Ct):Mt(ht,Nt,jt,Ct),ee=D(Ct)?x(Bt,ht,this._currenTime):A(Bt,ht,this._currenTime);this._automationEvents.push(ee)}if(dt!==void 0&&Wt(dt)&&this._automationEvents.push(P(this.getValue(ht),ht)),dt!==void 0&&F(dt)&&dt.startTime+dt.duration>ht){var je=ht-dt.startTime,$t=(dt.values.length-1)/dt.duration,_e=Math.max(2,1+Math.ceil(je*$t)),Ue=je/(_e-1)*$t,Ye=dt.values.slice(0,_e);if(Ue<1)for(var Ie=1;Ie<_e;Ie+=1){var Ze=Ue*Ie%1;Ye[Ie]=dt.values[Ie-1]*(1-Ze)+dt.values[Ie]*Ze}this._automationEvents[this._automationEvents.length-1]=M(Ye,dt.startTime,je)}}}else{var Ce=this._automationEvents.findIndex(function(Ne){return gt(Ne)>ht}),xs=Ce===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[Ce-1];if(xs!==void 0&&F(xs)&&gt(xs)+xs.duration>ht)return!1;var rn=D(it)?x(it.value,it.endTime,this._currenTime):R(it)?A(it.value,ht,this._currenTime):it;if(Ce===-1)this._automationEvents.push(rn);else{if(F(it)&&ht+it.duration>gt(this._automationEvents[Ce]))return!1;this._automationEvents.splice(Ce,0,rn)}}return!0}},{key:"flush",value:function(it){var ht=this._automationEvents.findIndex(function(dt){return gt(dt)>it});if(ht>1){var ut=this._automationEvents.slice(ht-1),Ct=ut[0];Wt(Ct)&&ut.unshift(P(Y(this._automationEvents,ht-2,Ct.startTime,this._defaultValue),Ct.startTime)),this._automationEvents=ut}}},{key:"getValue",value:function(it){if(this._automationEvents.length===0)return this._defaultValue;var ht=this._automationEvents.findIndex(function(Ye){return gt(Ye)>it}),ut=this._automationEvents[ht],Ct=(ht===-1?this._automationEvents.length:ht)-1,dt=this._automationEvents[Ct];if(dt!==void 0&&Wt(dt)&&(ut===void 0||!H(ut)||ut.insertTime>it))return I(it,Y(this._automationEvents,Ct-1,dt.startTime,this._defaultValue),dt);if(dt!==void 0&&j(dt)&&(ut===void 0||!H(ut)))return dt.value;if(dt!==void 0&&F(dt)&&(ut===void 0||!H(ut)||dt.startTime+dt.duration>it))return it<dt.startTime+dt.duration?me(it,dt):dt.values[dt.values.length-1];if(dt!==void 0&&H(dt)&&(ut===void 0||!H(ut)))return dt.value;if(ut!==void 0&&D(ut)){var Nt=tt(this._automationEvents,Ct,dt,ut,this._defaultValue),jt=g(Nt,2),Bt=jt[0],ee=jt[1];return _t(it,Bt,ee,ut)}if(ut!==void 0&&R(ut)){var je=tt(this._automationEvents,Ct,dt,ut,this._defaultValue),$t=g(je,2),_e=$t[0],Ue=$t[1];return Mt(it,_e,Ue,ut)}return this._defaultValue}}])}();f.AutomationEventList=Qt,f.createCancelAndHoldAutomationEvent=function(it){return{cancelTime:it,type:"cancelAndHold"}},f.createCancelScheduledValuesAutomationEvent=function(it){return{cancelTime:it,type:"cancelScheduledValues"}},f.createExponentialRampToValueAutomationEvent=function(it,ht){return{endTime:ht,type:"exponentialRampToValue",value:it}},f.createLinearRampToValueAutomationEvent=function(it,ht){return{endTime:ht,type:"linearRampToValue",value:it}},f.createSetTargetAutomationEvent=function(it,ht,ut){return{startTime:ht,target:it,timeConstant:ut,type:"setTarget"}},f.createSetValueAutomationEvent=P,f.createSetValueCurveAutomationEvent=M})(h,m(821),m(805),m(989))},113:c=>{c.exports=function(h,m){(m==null||m>h.length)&&(m=h.length);for(var f=0,g=new Array(m);f<m;f++)g[f]=h[f];return g},c.exports.__esModule=!0,c.exports.default=c.exports},569:c=>{c.exports=function(h){if(Array.isArray(h))return h},c.exports.__esModule=!0,c.exports.default=c.exports},805:c=>{c.exports=function(h,m){if(!(h instanceof m))throw new TypeError("Cannot call a class as a function")},c.exports.__esModule=!0,c.exports.default=c.exports},989:(c,h,m)=>{var f=m(498);function g(b,w){for(var x=0;x<w.length;x++){var A=w[x];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(b,f(A.key),A)}}c.exports=function(b,w,x){return w&&g(b.prototype,w),x&&g(b,x),Object.defineProperty(b,"prototype",{writable:!1}),b},c.exports.__esModule=!0,c.exports.default=c.exports},474:c=>{c.exports=function(h,m){var f=h==null?null:typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(f!=null){var g,b,w,x,A=[],P=!0,M=!1;try{if(w=(f=f.call(h)).next,m===0){if(Object(f)!==f)return;P=!1}else for(;!(P=(g=w.call(f)).done)&&(A.push(g.value),A.length!==m);P=!0);}catch(I){M=!0,b=I}finally{try{if(!P&&f.return!=null&&(x=f.return(),Object(x)!==x))return}finally{if(M)throw b}}return A}},c.exports.__esModule=!0,c.exports.default=c.exports},18:c=>{c.exports=function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)},c.exports.__esModule=!0,c.exports.default=c.exports},821:(c,h,m)=>{var f=m(569),g=m(474),b=m(744),w=m(18);c.exports=function(x,A){return f(x)||g(x,A)||b(x,A)||w()},c.exports.__esModule=!0,c.exports.default=c.exports},327:(c,h,m)=>{var f=m(564).default;c.exports=function(g,b){if(f(g)!="object"||!g)return g;var w=g[Symbol.toPrimitive];if(w!==void 0){var x=w.call(g,b||"default");if(f(x)!="object")return x;throw new TypeError("@@toPrimitive must return a primitive value.")}return(b==="string"?String:Number)(g)},c.exports.__esModule=!0,c.exports.default=c.exports},498:(c,h,m)=>{var f=m(564).default,g=m(327);c.exports=function(b){var w=g(b,"string");return f(w)=="symbol"?w:w+""},c.exports.__esModule=!0,c.exports.default=c.exports},564:c=>{function h(m){return c.exports=h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(f){return typeof f}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},c.exports.__esModule=!0,c.exports.default=c.exports,h(m)}c.exports=h,c.exports.__esModule=!0,c.exports.default=c.exports},744:(c,h,m)=>{var f=m(113);c.exports=function(g,b){if(g){if(typeof g=="string")return f(g,b);var w=Object.prototype.toString.call(g).slice(8,-1);return w==="Object"&&g.constructor&&(w=g.constructor.name),w==="Map"||w==="Set"?Array.from(g):w==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(w)?f(g,b):void 0}},c.exports.__esModule=!0,c.exports.default=c.exports}},i={};function a(c){var h=i[c];if(h!==void 0)return h.exports;var m=i[c]={exports:{}};return s[c].call(m.exports,m,m.exports,a),m.exports}a.d=(c,h)=>{for(var m in h)a.o(h,m)&&!a.o(c,m)&&Object.defineProperty(c,m,{enumerable:!0,get:h[m]})},a.o=(c,h)=>Object.prototype.hasOwnProperty.call(c,h),a.r=c=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(c,"__esModule",{value:!0})};var r={};return(()=>{a.r(r),a.d(r,{AMOscillator:()=>To,AMSynth:()=>Tl,Abs:()=>zu,Add:()=>Yn,AmplitudeEnvelope:()=>Fi,Analyser:()=>Vo,AudioToGain:()=>Ga,AutoFilter:()=>Fl,AutoPanner:()=>Bl,AutoWah:()=>$l,BaseContext:()=>pl,BiquadFilter:()=>Po,BitCrusher:()=>ql,Buffer:()=>Gg,BufferSource:()=>Ug,Buffers:()=>jg,Channel:()=>Kn,Chebyshev:()=>Wl,Chorus:()=>Hl,Clock:()=>Pi,Compressor:()=>gn,Context:()=>Si,Convolver:()=>mc,CrossFade:()=>Bi,DCMeter:()=>oc,Delay:()=>fs,Destination:()=>Lg,Distortion:()=>Gl,Draw:()=>zg,DuoSynth:()=>Al,EQ3:()=>pc,Emitter:()=>xi,Envelope:()=>qe,FFT:()=>ic,FMOscillator:()=>Oi,FMSynth:()=>Ml,FatOscillator:()=>Ao,FeedbackCombFilter:()=>Ro,FeedbackDelay:()=>jl,Filter:()=>vs,Follower:()=>qo,Freeverb:()=>Xl,Frequency:()=>pg,FrequencyClass:()=>Je,FrequencyEnvelope:()=>ko,FrequencyShifter:()=>Ul,Gain:()=>bt,GainToAudio:()=>Wu,Gate:()=>cc,GrainPlayer:()=>Sl,GreaterThan:()=>Xa,GreaterThanZero:()=>Ua,IntervalTimeline:()=>Fu,JCReverb:()=>Yl,LFO:()=>ts,Limiter:()=>hc,Listener:()=>$g,Loop:()=>Lo,LowpassCombFilter:()=>Oo,Master:()=>Fg,MembraneSynth:()=>Io,Merge:()=>Dn,MetalSynth:()=>El,Meter:()=>nc,MidSideCompressor:()=>uc,MidSideMerge:()=>Wo,MidSideSplit:()=>zo,Midi:()=>yg,MidiClass:()=>Ii,Mono:()=>rc,MonoSynth:()=>Qn,MultibandCompressor:()=>dc,MultibandSplit:()=>Ho,Multiply:()=>ue,Negate:()=>Cl,Noise:()=>In,NoiseSynth:()=>Pl,Offline:()=>vg,OfflineContext:()=>Ci,OmniOscillator:()=>pn,OnePoleFilter:()=>Do,Oscillator:()=>he,PWMOscillator:()=>Mo,PanVol:()=>Ka,Panner:()=>$o,Panner3D:()=>lc,Param:()=>Et,Part:()=>Fo,Pattern:()=>Nl,Phaser:()=>Jl,PingPongDelay:()=>Zl,PitchShift:()=>Ql,Player:()=>Li,Players:()=>xl,PluckSynth:()=>Dl,PolySynth:()=>Ol,Pow:()=>Ri,PulseOscillator:()=>Ni,Recorder:()=>tr,Reverb:()=>Kl,Sampler:()=>No,Scale:()=>mn,ScaleExp:()=>Ya,Sequence:()=>Ll,Signal:()=>Tt,Solo:()=>be,Split:()=>Jn,StateTimeline:()=>Mi,StereoWidener:()=>tc,Subtract:()=>Zn,SyncedSignal:()=>Sg,Synth:()=>Rn,Ticks:()=>bg,TicksClass:()=>ce,Time:()=>hg,TimeClass:()=>ps,Timeline:()=>ds,ToneAudioBuffer:()=>qt,ToneAudioBuffers:()=>ki,ToneAudioNode:()=>ot,ToneBufferSource:()=>kn,ToneEvent:()=>Xs,ToneOscillatorNode:()=>Co,Transport:()=>Og,TransportTime:()=>mg,TransportTimeClass:()=>xe,Tremolo:()=>ec,Unit:()=>h,UserMedia:()=>So,Vibrato:()=>sc,Volume:()=>un,WaveShaper:()=>Bs,Waveform:()=>ac,Zero:()=>ja,connect:()=>Ke,connectSeries:()=>ms,connectSignal:()=>xo,context:()=>Vg,dbToGain:()=>Ti,debug:()=>c,defaultArg:()=>Ts,disconnect:()=>gl,fanIn:()=>fg,ftom:()=>En,gainToDb:()=>_o,getContext:()=>ie,getDestination:()=>Bg,getDraw:()=>Wg,getListener:()=>qg,getTransport:()=>Ng,immediate:()=>Dg,intervalToFrequencyRatio:()=>Ai,isArray:()=>Fe,isBoolean:()=>rl,isDefined:()=>It,isFunction:()=>Eu,isNote:()=>yo,isNumber:()=>hs,isObject:()=>cn,isString:()=>Ns,isUndef:()=>os,loaded:()=>Hg,mtof:()=>ml,now:()=>Rg,optionsFromArguments:()=>J,setContext:()=>za,start:()=>cg,supported:()=>ig,version:()=>m});var c={};a.r(c),a.d(c,{assert:()=>wt,assertContextRunning:()=>ll,assertRange:()=>Be,assertUsedScheduleTime:()=>Iu,enterScheduledCallback:()=>cl,log:()=>Ru,setLogger:()=>og,warn:()=>bi});var h={};a.r(h);const m="15.0.4";var f=a(871);const g=new WeakSet,b=new WeakMap,w=new WeakMap,x=new WeakMap,A=new WeakMap,P=new WeakMap,M=new WeakMap,I=new WeakMap,D=new WeakMap,R=new WeakMap,H={construct:()=>H},j=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,F=(p,t)=>{const o=[];let l=p.replace(/^[\s]+/,""),d=l.match(j);for(;d!==null;){const v=d[1].slice(1,-1),y=d[0].replace(/([\s]+)?;?$/,"").replace(v,new URL(v,t).toString());o.push(y),l=l.slice(d[0].length).replace(/^[\s]+/,""),d=l.match(j)}return[o.join(";"),l]},Y=p=>{if(p!==void 0&&!Array.isArray(p))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},tt=p=>{if(!(t=>{try{new new Proxy(t,H)}catch{return!1}return!0})(p))throw new TypeError("The given value for processorCtor should be a constructor.");if(p.prototype===null||typeof p.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},nt=(p,t)=>{const o=p.get(t);if(o===void 0)throw new Error("A value with the given key could not be found.");return o},at=(p,t)=>{const o=Array.from(p).filter(t);if(o.length>1)throw Error("More than one element was found.");if(o.length===0)throw Error("No element was found.");const[l]=o;return p.delete(l),l},gt=(p,t,o,l)=>{const d=nt(p,t),v=at(d,y=>y[0]===o&&y[1]===l);return d.size===0&&p.delete(t),v},_t=p=>nt(M,p),Mt=p=>{if(g.has(p))throw new Error("The AudioNode is already stored.");g.add(p),_t(p).forEach(t=>t(!0))},me=p=>"port"in p,Wt=p=>{if(!g.has(p))throw new Error("The AudioNode is not stored.");g.delete(p),_t(p).forEach(t=>t(!1))},Qt=(p,t)=>{!me(p)&&t.every(o=>o.size===0)&&Wt(p)},it={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},ht=(p,t)=>p.context===t,ut=p=>{try{p.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Ct=()=>new DOMException("","IndexSizeError"),dt=p=>{var t;p.getChannelData=(t=p.getChannelData,o=>{try{return t.call(p,o)}catch(l){throw l.code===12?Ct():l}})},Nt={numberOfChannels:1},jt=-34028234663852886e22,Bt=34028234663852886e22,ee=p=>g.has(p),je={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},$t=p=>nt(b,p),_e=p=>nt(x,p),Ue=(p,t)=>{const{activeInputs:o}=$t(p);o.forEach(d=>d.forEach(([v])=>{t.includes(p)||Ue(v,[...t,p])}));const l=(d=>"playbackRate"in d)(p)?[p.playbackRate]:me(p)?Array.from(p.parameters.values()):(d=>"frequency"in d&&"gain"in d)(p)?[p.Q,p.detune,p.frequency,p.gain]:(d=>"offset"in d)(p)?[p.offset]:(d=>!("frequency"in d)&&"gain"in d)(p)?[p.gain]:(d=>"detune"in d&&"frequency"in d)(p)?[p.detune,p.frequency]:(d=>"pan"in d)(p)?[p.pan]:[];for(const d of l){const v=_e(d);v!==void 0&&v.activeInputs.forEach(([y])=>Ue(y,t))}ee(p)&&Wt(p)},Ye=p=>{Ue(p.destination,[])},Ie=p=>"context"in p,Ze=p=>Ie(p[0]),Ce=(p,t,o,l)=>{for(const d of p)if(o(d)){if(l)return!1;throw Error("The set contains at least one similar element.")}return p.add(t),!0},xs=(p,t,[o,l],d)=>{Ce(p,[t,o,l],v=>v[0]===t&&v[1]===o,d)},rn=(p,[t,o,l],d)=>{const v=p.get(t);v===void 0?p.set(t,new Set([[o,l]])):Ce(v,[o,l],y=>y[0]===o,d)},Ne=p=>"inputs"in p,xn=(p,t,o,l)=>{if(Ne(t)){const d=t.inputs[l];return p.connect(d,o,0),[d,o,0]}return p.connect(t,o,l),[t,o,l]},li=(p,t,o)=>{for(const l of p)if(l[0]===t&&l[1]===o)return p.delete(l),l;return null},ci=(p,t)=>{if(!_t(p).delete(t))throw new Error("Missing the expected event listener.")},hi=(p,t,o)=>{const l=nt(p,t),d=at(l,v=>v[0]===o);return l.size===0&&p.delete(t),d},Sn=(p,t,o,l)=>{Ne(t)?p.disconnect(t.inputs[l],o,0):p.disconnect(t,o,l)},Jt=p=>nt(w,p),Vn=p=>nt(A,p),ln=p=>I.has(p),ui=p=>!g.has(p),Ma=(p,t)=>new Promise(o=>{if(t!==null)o(!0);else{const l=p.createScriptProcessor(256,1,1),d=p.createGain(),v=p.createBuffer(1,2,44100),y=v.getChannelData(0);y[0]=1,y[1]=1;const _=p.createBufferSource();_.buffer=v,_.loop=!0,_.connect(l).connect(p.destination),_.connect(d),_.disconnect(d),l.onaudioprocess=S=>{const C=S.inputBuffer.getChannelData(0);Array.prototype.some.call(C,E=>E===1)?o(!0):o(!1),_.stop(),l.onaudioprocess=null,_.disconnect(l),l.disconnect(p.destination)},_.start()}}),co=(p,t)=>{const o=new Map;for(const l of p)for(const d of l){const v=o.get(d);o.set(d,v===void 0?1:v+1)}o.forEach((l,d)=>t(d,l))},di=p=>"context"in p,Ur=p=>{const t=new Map;p.connect=(o=>(l,d=0,v=0)=>{const y=di(l)?o(l,d,v):o(l,d),_=t.get(l);return _===void 0?t.set(l,[{input:v,output:d}]):_.every(S=>S.input!==v||S.output!==d)&&_.push({input:v,output:d}),y})(p.connect.bind(p)),p.disconnect=(o=>(l,d,v)=>{if(o.apply(p),l===void 0)t.clear();else if(typeof l=="number")for(const[y,_]of t){const S=_.filter(C=>C.output!==l);S.length===0?t.delete(y):t.set(y,S)}else if(t.has(l))if(d===void 0)t.delete(l);else{const y=t.get(l);if(y!==void 0){const _=y.filter(S=>S.output!==d&&(S.input!==v||v===void 0));_.length===0?t.delete(l):t.set(l,_)}}for(const[y,_]of t)_.forEach(S=>{di(y)?p.connect(y,S.output,S.input):p.connect(y,S.output)})})(p.disconnect)},ho=(p,t,o,l,d)=>{const[v,y]=((_,S,C,E)=>{const{activeInputs:k,passiveInputs:O}=$t(S),N=li(k[E],_,C);return N===null?[gt(O,_,C,E)[2],!1]:[N[2],!0]})(p,o,l,d);if(v!==null&&(ci(p,v),!y||t||ln(p)||Sn(Jt(p),Jt(o),l,d)),ee(o)){const{activeInputs:_}=$t(o);Qt(o,_)}},uo=(p,t,o,l)=>{const[d,v]=((y,_,S)=>{const{activeInputs:C,passiveInputs:E}=_e(_),k=li(C,y,S);return k===null?[hi(E,y,S)[1],!1]:[k[2],!0]})(p,o,l);d!==null&&(ci(p,d),!v||t||ln(p)||Jt(p).disconnect(Vn(o),l))};class Ea{constructor(t){this._map=new Map(t)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(t,o=null){return this._map.forEach((l,d)=>t.call(o,l,d,this))}get(t){return this._map.get(t)}has(t){return this._map.has(t)}keys(){return this._map.keys()}values(){return this._map.values()}}const Pa={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function Hn(p,t,o,l,d){if(typeof p.copyFromChannel=="function")t[o].byteLength===0&&(t[o]=new Float32Array(128)),p.copyFromChannel(t[o],l,d);else{const v=p.getChannelData(l);if(t[o].byteLength===0)t[o]=v.slice(d,d+128);else{const y=new Float32Array(v.buffer,d*Float32Array.BYTES_PER_ELEMENT,128);t[o].set(y)}}}const pi=(p,t,o,l,d)=>{typeof p.copyToChannel=="function"?t[o].byteLength!==0&&p.copyToChannel(t[o],l,d):t[o].byteLength!==0&&p.getChannelData(l).set(t[o],d)},ka=(p,t)=>{const o=[];for(let l=0;l<p;l+=1){const d=[],v=typeof t=="number"?t:t[l];for(let y=0;y<v;y+=1)d.push(new Float32Array(128));o.push(d)}return o},bm=async(p,t,o,l,d,v,y)=>{const _=t===null?128*Math.ceil(p.context.length/128):t.length,S=l.channelCount*l.numberOfInputs,C=d.reduce((L,W)=>L+W,0),E=C===0?null:o.createBuffer(C,_,o.sampleRate);if(v===void 0)throw new Error("Missing the processor constructor.");const k=$t(p),O=await((L,W)=>{const z=nt(R,L),B=Jt(W);return nt(z,B)})(o,p),N=ka(l.numberOfInputs,l.channelCount),q=ka(l.numberOfOutputs,d),$=Array.from(p.parameters.keys()).reduce((L,W)=>({...L,[W]:new Float32Array(128)}),{});for(let L=0;L<_;L+=128){if(l.numberOfInputs>0&&t!==null)for(let W=0;W<l.numberOfInputs;W+=1)for(let z=0;z<l.channelCount;z+=1)Hn(t,N[W],z,z,L);v.parameterDescriptors!==void 0&&t!==null&&v.parameterDescriptors.forEach(({name:W},z)=>{Hn(t,$,W,S+z,L)});for(let W=0;W<l.numberOfInputs;W+=1)for(let z=0;z<d[W];z+=1)q[W][z].byteLength===0&&(q[W][z]=new Float32Array(128));try{const W=N.map((B,Z)=>k.activeInputs[Z].size===0?[]:B),z=y(L/o.sampleRate,o.sampleRate,()=>O.process(W,q,$));if(E!==null)for(let B=0,Z=0;B<l.numberOfOutputs;B+=1){for(let et=0;et<d[B];et+=1)pi(E,q[B],et,Z+et,L);Z+=d[B]}if(!z)break}catch(W){p.dispatchEvent(new ErrorEvent("processorerror",{colno:W.colno,filename:W.filename,lineno:W.lineno,message:W.message}));break}}return E},wm={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},_m={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},xm={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Sm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Cm={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Hh=p=>{const{port1:t,port2:o}=new MessageChannel;return new Promise(l=>{const d=()=>{o.onmessage=null,t.close(),o.close(),l()};o.onmessage=()=>d();try{t.postMessage(p,[p])}catch{}finally{d()}})},Tm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Ia=(p,t,o)=>{const l=t[o];if(l===void 0)throw p();return l},Am={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Mm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},Re=()=>new DOMException("","InvalidStateError"),Ra=()=>new DOMException("","InvalidAccessError"),Em={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Gh=(p,t,o,l,d,v,y,_,S,C,E)=>{const k=C.length;let O=_;for(let N=0;N<k;N+=1){let q=o[0]*C[N];for(let $=1;$<d;$+=1){const L=O-$&S-1;q+=o[$]*v[L],q-=p[$]*y[L]}for(let $=d;$<l;$+=1)q+=o[$]*v[O-$&S-1];for(let $=d;$<t;$+=1)q-=p[$]*y[O-$&S-1];v[O]=C[N],y[O]=q,O=O+1&S-1,E[N]=q}return O},Pm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},po=p=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const o=p.decodeAudioData(t.buffer,()=>{});return o!==void 0&&(o.catch(()=>{}),!0)}catch{}return!1},le=(p,t,o)=>{const l=t[o];l!==void 0&&l!==p[o]&&(p[o]=l)},Te=(p,t)=>{le(p,t,"channelCount"),le(p,t,"channelCountMode"),le(p,t,"channelInterpretation")},jh=p=>typeof p.getFloatTimeDomainData=="function",fe=(p,t,o)=>{const l=t[o];l!==void 0&&l!==p[o].value&&(p[o].value=l)},Xr=p=>{p.start=(t=>(o=0,l=0,d)=>{if(typeof d=="number"&&d<0||l<0||o<0)throw new RangeError("The parameters can't be negative.");t.call(p,o,l,d)})(p.start)},Yr=p=>{var t;p.stop=(t=p.stop,(o=0)=>{if(o<0)throw new RangeError("The parameter can't be negative.");t.call(p,o)})},Uh=(p,t)=>p===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(p*t))))),Xh=(p,t)=>{const o=p.createBiquadFilter();return Te(o,t),fe(o,t,"Q"),fe(o,t,"detune"),fe(o,t,"frequency"),fe(o,t,"gain"),le(o,t,"type"),o},mo=(p,t)=>{const o=p.createChannelSplitter(t.numberOfOutputs);return Te(o,t),(l=>{const d=l.numberOfOutputs;Object.defineProperty(l,"channelCount",{get:()=>d,set:v=>{if(v!==d)throw Re()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:v=>{if(v!=="explicit")throw Re()}}),Object.defineProperty(l,"channelInterpretation",{get:()=>"discrete",set:v=>{if(v!=="discrete")throw Re()}})})(o),o},mi=(p,t)=>(p.connect=t.connect.bind(t),p.disconnect=t.disconnect.bind(t),p),Yh=(p,t)=>{const o=p.createDelay(t.maxDelayTime);return Te(o,t),fe(o,t,"delayTime"),o},is=(p,t)=>{const o=p.createGain();return Te(o,t),fe(o,t,"gain"),o};function km(p,t){const o=t[0]*t[0]+t[1]*t[1];return[(p[0]*t[0]+p[1]*t[1])/o,(p[1]*t[0]-p[0]*t[1])/o]}function Zh(p,t){let o=[0,0];for(let v=p.length-1;v>=0;v-=1)d=t,o=[(l=o)[0]*d[0]-l[1]*d[1],l[0]*d[1]+l[1]*d[0]],o[0]+=p[v];var l,d;return o}const fo=(p,t,o,l)=>p.createScriptProcessor(t,o,l),Qe=()=>new DOMException("","NotSupportedError"),Im={numberOfChannels:1},Rm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Dm={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},Om={disableNormalization:!1},Nm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Lm=()=>new DOMException("","UnknownError"),Fm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Qh=(p,t,o)=>p.copyFromChannel===void 0?p.getChannelData(o)[0]:(p.copyFromChannel(t,o),t[0]),Jh=p=>{if(p===null)return!1;const t=p.length;return t%2!=0?p[Math.floor(t/2)]!==0:p[t/2-1]+p[t/2]!==0},go=(p,t,o,l)=>{let d=p;for(;!d.hasOwnProperty(t);)d=Object.getPrototypeOf(d);const{get:v,set:y}=Object.getOwnPropertyDescriptor(d,t);Object.defineProperty(p,t,{get:o(v),set:l(y)})},Kh=(p,t,o)=>{try{p.setValueAtTime(t,o)}catch(l){if(l.code!==9)throw l;Kh(p,t,o+1e-7)}},Zr=p=>{const t=p.createOscillator();try{t.start(-1)}catch(o){return o instanceof RangeError}return!1},tu=p=>{const t=p.createBuffer(1,1,44100),o=p.createBufferSource();o.buffer=t,o.start(),o.stop();try{return o.stop(),!0}catch{return!1}},Qr=p=>{const t=p.createOscillator();try{t.stop(-1)}catch(o){return o instanceof RangeError}return!1},Bm=()=>{try{new DOMException}catch{return!1}return!0},$m=()=>new Promise(p=>{const t=new ArrayBuffer(0),{port1:o,port2:l}=new MessageChannel;o.onmessage=({data:d})=>p(d!==null),l.postMessage(t,[t])}),eu=(p,t)=>{const o=t.createGain();p.connect(o);const l=(d=>()=>{d.call(p,o),p.removeEventListener("ended",l)})(p.disconnect);p.addEventListener("ended",l),mi(p,o),p.stop=(d=>{let v=!1;return(y=0)=>{if(v)try{d.call(p,y)}catch{o.gain.setValueAtTime(0,y)}else d.call(p,y),v=!0}})(p.stop)},fi=(p,t)=>o=>{const l={value:p};return Object.defineProperties(o,{currentTarget:l,target:l}),typeof t=="function"?t.call(p,o):t.handleEvent.call(p,o)},qm=(p=>(t,o,[l,d,v],y)=>{p(t[d],[o,l,v],_=>_[0]===o&&_[1]===l,y)})(Ce),zm=(p=>(t,o,[l,d,v],y)=>{const _=t.get(l);_===void 0?t.set(l,new Set([[d,o,v]])):p(_,[d,o,v],S=>S[0]===d&&S[1]===o,y)})(Ce),Wm=(p=>(t,o,l,d)=>p(t[d],v=>v[0]===o&&v[1]===l))(at),su=new WeakMap,Vm=(p=>t=>{var o;return(o=p.get(t))!==null&&o!==void 0?o:0})(su),Ss=(Da=new Map,vo=new WeakMap,(p,t)=>{const o=vo.get(p);if(o!==void 0)return o;const l=Da.get(p);if(l!==void 0)return l;try{const d=t();return d instanceof Promise?(Da.set(p,d),d.catch(()=>!1).then(v=>(Da.delete(p),vo.set(p,v),v))):(vo.set(p,d),d)}catch{return vo.set(p,!1),!1}});var Da,vo;const Ds=typeof window>"u"?null:window,nu=((p,t)=>(o,l)=>{const d=o.createAnalyser();if(Te(d,l),!(l.maxDecibels>l.minDecibels))throw t();return le(d,l,"fftSize"),le(d,l,"maxDecibels"),le(d,l,"minDecibels"),le(d,l,"smoothingTimeConstant"),p(jh,()=>jh(d))||(v=>{v.getFloatTimeDomainData=y=>{const _=new Uint8Array(y.length);v.getByteTimeDomainData(_);const S=Math.max(_.length,v.fftSize);for(let C=0;C<S;C+=1)y[C]=.0078125*(_[C]-128);return y}})(d),d})(Ss,Ct),Jr=(p=>t=>{const o=p(t);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return o.renderer})($t),Le=((p,t,o)=>async(l,d,v)=>{const y=p(l);await Promise.all(y.activeInputs.map((_,S)=>Array.from(_).map(async([C,E])=>{const k=t(C),O=await k.render(C,d),N=l.context.destination;o(C)||l===N&&o(l)||O.connect(v,E,S)})).reduce((_,S)=>[..._,...S],[]))})($t,Jr,ln),Hm=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ht(C,S)){const E={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,fftSize:C.fftSize,maxDecibels:C.maxDecibels,minDecibels:C.minDecibels,smoothingTimeConstant:C.smoothingTimeConstant};C=p(S,E)}return l.set(S,C),await o(_,S,C),C})(d,v)}}})(nu,Jt,Le),se=(iu=P,p=>{const t=iu.get(p);if(t===void 0)throw Re();return t});var iu;const De=(p=>p===null?null:p.hasOwnProperty("OfflineAudioContext")?p.OfflineAudioContext:p.hasOwnProperty("webkitOfflineAudioContext")?p.webkitOfflineAudioContext:null)(Ds),Zt=(p=>t=>p!==null&&t instanceof p)(De),ou=new WeakMap,au=(p=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,o,l){if(o!==null){let d=this._listeners.get(o);d===void 0&&(d=p(this,o),typeof o=="function"&&this._listeners.set(o,d)),this._nativeEventTarget.addEventListener(t,d,l)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,o,l){const d=o===null?void 0:this._listeners.get(o);this._nativeEventTarget.removeEventListener(t,d===void 0?null:d,l)}})(fi),Cn=(p=>p===null?null:p.hasOwnProperty("AudioContext")?p.AudioContext:p.hasOwnProperty("webkitAudioContext")?p.webkitAudioContext:null)(Ds),Kr=(p=>t=>p!==null&&t instanceof p)(Cn),tl=(p=>t=>p!==null&&typeof p.AudioNode=="function"&&t instanceof p.AudioNode)(Ds),ru=(p=>t=>p!==null&&typeof p.AudioParam=="function"&&t instanceof p.AudioParam)(Ds),gi=(p=>p===null?null:p.hasOwnProperty("AudioWorkletNode")?p.AudioWorkletNode:null)(Ds),ye=((p,t,o,l,d,v,y,_,S,C,E,k,O,N,q,$)=>class extends C{constructor(L,W,z,B){super(z),this._context=L,this._nativeAudioNode=z;const Z=E(L);k(Z)&&o(Ma,()=>Ma(Z,$))!==!0&&Ur(z),w.set(this,z),M.set(this,new Set),L.state!=="closed"&&W&&Mt(this),p(this,B,z)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(L){this._nativeAudioNode.channelCount=L}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(L){this._nativeAudioNode.channelCountMode=L}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(L){this._nativeAudioNode.channelInterpretation=L}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(L,W=0,z=0){if(W<0||W>=this._nativeAudioNode.numberOfOutputs)throw d();const B=E(this._context),Z=q(B);if(O(L)||N(L))throw v();if(Ie(L)){const G=Jt(L);try{const X=xn(this._nativeAudioNode,G,W,z),V=ui(this);(Z||V)&&this._nativeAudioNode.disconnect(...X),this.context.state!=="closed"&&!V&&ui(L)&&Mt(L)}catch(X){throw X.code===12?v():X}if(t(this,L,W,z,Z)){const X=S([this],L);co(X,l(Z))}return L}const et=Vn(L);if(et.name==="playbackRate"&&et.maxValue===1024)throw y();try{this._nativeAudioNode.connect(et,W),(Z||ui(this))&&this._nativeAudioNode.disconnect(et,W)}catch(G){throw G.code===12?v():G}if(((G,X,V,st)=>{const{activeInputs:U,passiveInputs:K}=_e(X),{outputs:lt}=$t(G),ct=_t(G),At=yt=>{const vt=Jt(G),Pt=Vn(X);if(yt){const ft=hi(K,G,V);xs(U,G,ft,!1),st||ln(G)||vt.connect(Pt,V)}else{const ft=((kt,Lt,Vt)=>at(kt,oe=>oe[0]===Lt&&oe[1]===Vt))(U,G,V);rn(K,ft,!1),st||ln(G)||vt.disconnect(Pt,V)}};return!!Ce(lt,[X,V],yt=>yt[0]===X&&yt[1]===V,!0)&&(ct.add(At),ee(G)?xs(U,G,[V,At],!0):rn(K,[G,V,At],!0),!0)})(this,L,W,Z)){const G=S([this],L);co(G,l(Z))}}disconnect(L,W,z){let B;const Z=E(this._context),et=q(Z);if(L===void 0)B=((G,X)=>{const V=$t(G),st=[];for(const U of V.outputs)Ze(U)?ho(G,X,...U):uo(G,X,...U),st.push(U[0]);return V.outputs.clear(),st})(this,et);else if(typeof L=="number"){if(L<0||L>=this.numberOfOutputs)throw d();B=((G,X,V)=>{const st=$t(G),U=[];for(const K of st.outputs)K[1]===V&&(Ze(K)?ho(G,X,...K):uo(G,X,...K),U.push(K[0]),st.outputs.delete(K));return U})(this,et,L)}else{if(W!==void 0&&(W<0||W>=this.numberOfOutputs)||Ie(L)&&z!==void 0&&(z<0||z>=L.numberOfInputs))throw d();if(B=((G,X,V,st,U)=>{const K=$t(G);return Array.from(K.outputs).filter(lt=>!(lt[0]!==V||st!==void 0&&lt[1]!==st||U!==void 0&&lt[2]!==U)).map(lt=>(Ze(lt)?ho(G,X,...lt):uo(G,X,...lt),K.outputs.delete(lt),lt[0]))})(this,et,L,W,z),B.length===0)throw v()}for(const G of B){const X=S([this],G);co(X,_)}}})((lu=b,(p,t,o)=>{const l=[];for(let d=0;d<o.numberOfInputs;d+=1)l.push(new Set);lu.set(p,{activeInputs:l,outputs:new Set,passiveInputs:new WeakMap,renderer:t})}),((p,t,o,l,d,v,y,_,S,C,E,k,O)=>{const N=new WeakMap;return(q,$,L,W,z)=>{const{activeInputs:B,passiveInputs:Z}=v($),{outputs:et}=v(q),G=_(q),X=V=>{const st=S($),U=S(q);if(V){const K=gt(Z,q,L,W);p(B,q,K,!1),z||k(q)||o(U,st,L,W),O($)&&Mt($)}else{const K=l(B,q,L,W);t(Z,W,K,!1),z||k(q)||d(U,st,L,W);const lt=y($);if(lt===0)E($)&&Qt($,B);else{const ct=N.get($);ct!==void 0&&clearTimeout(ct),N.set($,setTimeout(()=>{E($)&&Qt($,B)},1e3*lt))}}};return!!C(et,[$,L,W],V=>V[0]===$&&V[1]===L&&V[2]===W,!0)&&(G.add(X),E(q)?p(B,q,[L,W,X],!0):t(Z,W,[q,L,X],!0),!0)}})(qm,zm,xn,Wm,Sn,$t,Vm,_t,Jt,Ce,ee,ln,ui),Ss,((p,t,o,l,d,v)=>y=>(_,S)=>{const C=p.get(_);if(C===void 0){if(!y&&v(_)){const E=l(_),{outputs:k}=o(_);for(const O of k)if(Ze(O)){const N=l(O[0]);t(E,N,O[1],O[2])}else{const N=d(O[0]);E.disconnect(N,O[1])}}p.set(_,S)}else p.set(_,C+S)})(I,Sn,$t,Jt,Vn,ee),Ct,Ra,Qe,((p,t,o,l,d,v,y,_)=>(S,C)=>{const E=t.get(S);if(E===void 0)throw new Error("Missing the expected cycle count.");const k=v(S.context),O=_(k);if(E===C){if(t.delete(S),!O&&y(S)){const N=l(S),{outputs:q}=o(S);for(const $ of q)if(Ze($)){const L=l($[0]);p(N,L,$[1],$[2])}else{const L=d($[0]);N.connect(L,$[1])}}}else t.set(S,E-C)})(xn,I,$t,Jt,Vn,se,ee,Zt),((p,t,o)=>function l(d,v){const y=Ie(v)?v:o(p,v);if((S=>"delayTime"in S)(y))return[];if(d[0]===y)return[d];if(d.includes(y))return[];const{outputs:_}=t(y);return Array.from(_).map(S=>l([...d,y],S[0])).reduce((S,C)=>S.concat(C),[])})(ou,$t,nt),au,se,Kr,tl,ru,Zt,gi);var lu;const Gm=((p,t,o,l,d,v)=>class extends p{constructor(y,_){const S=d(y),C={...it,..._},E=l(S,C);super(y,!1,E,v(S)?t():null),this._nativeAnalyserNode=E}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(y){this._nativeAnalyserNode.fftSize=y}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(y){const _=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=y,!(y>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=_,o()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(y){const _=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=y,!(this._nativeAnalyserNode.maxDecibels>y))throw this._nativeAnalyserNode.minDecibels=_,o()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(y){this._nativeAnalyserNode.smoothingTimeConstant=y}getByteFrequencyData(y){this._nativeAnalyserNode.getByteFrequencyData(y)}getByteTimeDomainData(y){this._nativeAnalyserNode.getByteTimeDomainData(y)}getFloatFrequencyData(y){this._nativeAnalyserNode.getFloatFrequencyData(y)}getFloatTimeDomainData(y){this._nativeAnalyserNode.getFloatTimeDomainData(y)}})(ye,Hm,Ct,nu,se,Zt),el=new WeakSet,cu=(p=>p===null?null:p.hasOwnProperty("AudioBuffer")?p.AudioBuffer:null)(Ds),hu=(sl=new Uint32Array(1),p=>(sl[0]=p,sl[0]));var sl;const nl=((p,t)=>o=>{o.copyFromChannel=(l,d,v=0)=>{const y=p(v),_=p(d);if(_>=o.numberOfChannels)throw t();const S=o.length,C=o.getChannelData(_),E=l.length;for(let k=y<0?-y:0;k+y<S&&k<E;k+=1)l[k]=C[k+y]},o.copyToChannel=(l,d,v=0)=>{const y=p(v),_=p(d);if(_>=o.numberOfChannels)throw t();const S=o.length,C=o.getChannelData(_),E=l.length;for(let k=y<0?-y:0;k+y<S&&k<E;k+=1)C[k+y]=l[k]}})(hu,Ct),il=(p=>t=>{t.copyFromChannel=(o=>(l,d,v=0)=>{const y=p(v),_=p(d);if(y<t.length)return o.call(t,l,_,y)})(t.copyFromChannel),t.copyToChannel=(o=>(l,d,v=0)=>{const y=p(v),_=p(d);if(y<t.length)return o.call(t,l,_,y)})(t.copyToChannel)})(hu),uu=((p,t,o,l,d,v,y,_)=>{let S=null;return class np{constructor(E){if(d===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:k,numberOfChannels:O,sampleRate:N}={...Nt,...E};S===null&&(S=new d(1,1,44100));const q=l!==null&&t(v,v)?new l({length:k,numberOfChannels:O,sampleRate:N}):S.createBuffer(O,k,N);if(q.numberOfChannels===0)throw o();return typeof q.copyFromChannel!="function"?(y(q),dt(q)):t(ut,()=>ut(q))||_(q),p.add(q),q}static[Symbol.hasInstance](E){return E!==null&&typeof E=="object"&&Object.getPrototypeOf(E)===np.prototype||p.has(E)}}})(el,Ss,Qe,cu,De,(p=>()=>{if(p===null)return!1;try{new p({length:1,sampleRate:44100})}catch{return!1}return!0})(cu),nl,il),Oa=(p=>(t,o)=>{const l=p(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});o.connect(l).connect(t.destination);const d=()=>{o.removeEventListener("ended",d),o.disconnect(l),l.disconnect()};o.addEventListener("ended",d)})(is),du=((p,t,o)=>async(l,d,v)=>{const y=t(l);await Promise.all(Array.from(y.activeInputs).map(async([_,S])=>{const C=p(_),E=await C.render(_,d);o(_)||E.connect(v,S)}))})(Jr,_e,ln),js=(p=>(t,o,l)=>p(o,t,l))(du),vi=((p,t,o,l,d,v,y,_,S,C,E)=>(k,O)=>{const N=k.createBufferSource();return Te(N,O),fe(N,O,"playbackRate"),le(N,O,"buffer"),le(N,O,"loop"),le(N,O,"loopEnd"),le(N,O,"loopStart"),t(o,()=>o(k))||(q=>{q.start=($=>{let L=!1;return(W=0,z=0,B)=>{if(L)throw Re();$.call(q,W,z,B),L=!0}})(q.start)})(N),t(l,()=>l(k))||(q=>{q.start=($=>(L=0,W=0,z)=>{const B=q.buffer,Z=B===null?W:Math.min(B.duration,W);B!==null&&Z>B.duration-.5/q.context.sampleRate?$.call(q,L,0,0):$.call(q,L,Z,z)})(q.start)})(N),t(d,()=>d(k))||C(N,k),t(v,()=>v(k))||Xr(N),t(y,()=>y(k))||E(N,k),t(_,()=>_(k))||Yr(N),p(k,N),N})(Oa,Ss,p=>{const t=p.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},p=>{const t=p.createBufferSource(),o=p.createBuffer(1,1,44100);t.buffer=o;try{t.start(0,1)}catch{return!1}return!0},p=>{const t=p.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},Zr,tu,Qr,0,(p=>(t,o)=>{const l=o.createBuffer(1,1,44100);t.buffer===null&&(t.buffer=l),p(t,"buffer",d=>()=>{const v=d.call(t);return v===l?null:v},d=>v=>d.call(t,v===null?l:v))})(go),eu),Us=((p,t)=>(o,l,d)=>(p(l).replay(d),t(l,o,d)))((p=>t=>{const o=p(t);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return o.renderer})(_e),du),jm=((p,t,o,l,d)=>()=>{const v=new WeakMap;let y=null,_=null;return{set start(S){y=S},set stop(S){_=S},render(S,C){const E=v.get(C);return E!==void 0?Promise.resolve(E):(async(k,O)=>{let N=o(k);const q=ht(N,O);if(!q){const $={buffer:N.buffer,channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,loop:N.loop,loopEnd:N.loopEnd,loopStart:N.loopStart,playbackRate:N.playbackRate.value};N=t(O,$),y!==null&&N.start(...y),_!==null&&N.stop(_)}return v.set(O,N),q?await p(O,k.playbackRate,N.playbackRate):await l(O,k.playbackRate,N.playbackRate),await d(k,O,N),N})(S,C)}}})(js,vi,Jt,Us,Le),Os=((p,t,o,l,d,v,y,_,S,C,E,k,O)=>(N,q,$,L=null,W=null)=>{const z=$.value,B=new f.AutomationEventList(z),Z=q?(G=>({replay(X){for(const V of G)if(V.type==="exponentialRampToValue"){const{endTime:st,value:U}=V;X.exponentialRampToValueAtTime(U,st)}else if(V.type==="linearRampToValue"){const{endTime:st,value:U}=V;X.linearRampToValueAtTime(U,st)}else if(V.type==="setTarget"){const{startTime:st,target:U,timeConstant:K}=V;X.setTargetAtTime(U,st,K)}else if(V.type==="setValue"){const{startTime:st,value:U}=V;X.setValueAtTime(U,st)}else{if(V.type!=="setValueCurve")throw new Error("Can't apply an unknown automation.");{const{duration:st,startTime:U,values:K}=V;X.setValueCurveAtTime(K,U,st)}}}}))(B):null,et={get defaultValue(){return z},get maxValue(){return L===null?$.maxValue:L},get minValue(){return W===null?$.minValue:W},get value(){return $.value},set value(G){$.value=G,et.setValueAtTime(G,N.context.currentTime)},cancelAndHoldAtTime(G){if(typeof $.cancelAndHoldAtTime=="function")Z===null&&B.flush(N.context.currentTime),B.add(d(G)),$.cancelAndHoldAtTime(G);else{const X=Array.from(B).pop();Z===null&&B.flush(N.context.currentTime),B.add(d(G));const V=Array.from(B).pop();$.cancelScheduledValues(G),X!==V&&V!==void 0&&(V.type==="exponentialRampToValue"?$.exponentialRampToValueAtTime(V.value,V.endTime):V.type==="linearRampToValue"?$.linearRampToValueAtTime(V.value,V.endTime):V.type==="setValue"?$.setValueAtTime(V.value,V.startTime):V.type==="setValueCurve"&&$.setValueCurveAtTime(V.values,V.startTime,V.duration))}return et},cancelScheduledValues:G=>(Z===null&&B.flush(N.context.currentTime),B.add(v(G)),$.cancelScheduledValues(G),et),exponentialRampToValueAtTime(G,X){if(G===0)throw new RangeError;if(!Number.isFinite(X)||X<0)throw new RangeError;const V=N.context.currentTime;return Z===null&&B.flush(V),Array.from(B).length===0&&(B.add(C(z,V)),$.setValueAtTime(z,V)),B.add(y(G,X)),$.exponentialRampToValueAtTime(G,X),et},linearRampToValueAtTime(G,X){const V=N.context.currentTime;return Z===null&&B.flush(V),Array.from(B).length===0&&(B.add(C(z,V)),$.setValueAtTime(z,V)),B.add(_(G,X)),$.linearRampToValueAtTime(G,X),et},setTargetAtTime:(G,X,V)=>(Z===null&&B.flush(N.context.currentTime),B.add(S(G,X,V)),$.setTargetAtTime(G,X,V),et),setValueAtTime:(G,X)=>(Z===null&&B.flush(N.context.currentTime),B.add(C(G,X)),$.setValueAtTime(G,X),et),setValueCurveAtTime(G,X,V){const st=G instanceof Float32Array?G:new Float32Array(G);if(k!==null&&k.name==="webkitAudioContext"){const U=X+V,K=N.context.sampleRate,lt=Math.ceil(X*K),ct=Math.floor(U*K),At=ct-lt,yt=new Float32Array(At);for(let Pt=0;Pt<At;Pt+=1){const ft=(st.length-1)/V*((lt+Pt)/K-X),kt=Math.floor(ft),Lt=Math.ceil(ft);yt[Pt]=kt===Lt?st[kt]:(1-(ft-kt))*st[kt]+(1-(Lt-ft))*st[Lt]}Z===null&&B.flush(N.context.currentTime),B.add(E(yt,X,V)),$.setValueCurveAtTime(yt,X,V);const vt=ct/K;vt<U&&O(et,yt[yt.length-1],vt),O(et,st[st.length-1],U)}else Z===null&&B.flush(N.context.currentTime),B.add(E(st,X,V)),$.setValueCurveAtTime(st,X,V);return et}};return o.set(et,$),t.set(et,N),p(et,Z),et})((pu=x,(p,t)=>{pu.set(p,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})}),ou,A,0,f.createCancelAndHoldAutomationEvent,f.createCancelScheduledValuesAutomationEvent,f.createExponentialRampToValueAutomationEvent,f.createLinearRampToValueAutomationEvent,f.createSetTargetAutomationEvent,f.createSetValueAutomationEvent,f.createSetValueCurveAutomationEvent,Cn,Kh);var pu;const Um=((p,t,o,l,d,v,y,_)=>class extends p{constructor(S,C){const E=v(S),k={...je,...C},O=d(E,k),N=y(E),q=N?t():null;super(S,!1,O,q),this._audioBufferSourceNodeRenderer=q,this._isBufferNullified=!1,this._isBufferSet=k.buffer!==null,this._nativeAudioBufferSourceNode=O,this._onended=null,this._playbackRate=o(this,N,O.playbackRate,Bt,jt)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(S){if(this._nativeAudioBufferSourceNode.buffer=S,S!==null){if(this._isBufferSet)throw l();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(S){this._nativeAudioBufferSourceNode.loop=S}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(S){this._nativeAudioBufferSourceNode.loopEnd=S}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(S){this._nativeAudioBufferSourceNode.loopStart=S}get onended(){return this._onended}set onended(S){const C=typeof S=="function"?_(this,S):null;this._nativeAudioBufferSourceNode.onended=C;const E=this._nativeAudioBufferSourceNode.onended;this._onended=E!==null&&E===C?S:E}get playbackRate(){return this._playbackRate}start(S=0,C=0,E){if(this._nativeAudioBufferSourceNode.start(S,C,E),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=E===void 0?[S,C]:[S,C,E]),this.context.state!=="closed"){Mt(this);const k=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",k),ee(this)&&Wt(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",k)}}stop(S=0){this._nativeAudioBufferSourceNode.stop(S),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=S)}})(ye,jm,Os,Re,vi,se,Zt,fi),Xm=((p,t,o,l,d,v,y,_)=>class extends p{constructor(S,C){const E=v(S),k=y(E),O=d(E,C,k);super(S,!1,O,k?(N=>{const q=new WeakMap;return{render($,L){const W=q.get(L);return W!==void 0?Promise.resolve(W):(async(z,B)=>{const Z=B.destination;return q.set(B,Z),await N(z,B,Z),Z})($,L)}}})(_):null),this._isNodeOfNativeOfflineAudioContext=k,this._nativeAudioDestinationNode=O}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(S){if(this._isNodeOfNativeOfflineAudioContext)throw l();if(S>this._nativeAudioDestinationNode.maxChannelCount)throw o();this._nativeAudioDestinationNode.channelCount=S}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(S){if(this._isNodeOfNativeOfflineAudioContext)throw l();this._nativeAudioDestinationNode.channelCountMode=S}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(ye,0,Ct,Re,((p,t)=>(o,l,d)=>{const v=o.destination;if(v.channelCount!==l)try{v.channelCount=l}catch{}d&&v.channelCountMode!=="explicit"&&(v.channelCountMode="explicit"),v.maxChannelCount===0&&Object.defineProperty(v,"maxChannelCount",{value:l});const y=p(o,{channelCount:l,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1});return t(y,"channelCount",_=>()=>_.call(y),_=>S=>{_.call(y,S);try{v.channelCount=S}catch(C){if(S>v.maxChannelCount)throw C}}),t(y,"channelCountMode",_=>()=>_.call(y),_=>S=>{_.call(y,S),v.channelCountMode=S}),t(y,"channelInterpretation",_=>()=>_.call(y),_=>S=>{_.call(y,S),v.channelInterpretation=S}),Object.defineProperty(y,"maxChannelCount",{get:()=>v.maxChannelCount}),y.connect(v),y})(is,go),se,Zt,Le),Ym=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,E)=>{let k=o(C);const O=ht(k,E);if(!O){const N={Q:k.Q.value,channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,detune:k.detune.value,frequency:k.frequency.value,gain:k.gain.value,type:k.type};k=t(E,N)}return v.set(E,k),O?(await p(E,C.Q,k.Q),await p(E,C.detune,k.detune),await p(E,C.frequency,k.frequency),await p(E,C.gain,k.gain)):(await l(E,C.Q,k.Q),await l(E,C.detune,k.detune),await l(E,C.frequency,k.frequency),await l(E,C.gain,k.gain)),await d(C,E,k),k})(y,_)}}})(js,Xh,Jt,Us,Le),Gn=(p=>(t,o)=>p.set(t,o))(su),Zm=((p,t,o,l,d,v,y,_)=>class extends p{constructor(S,C){const E=v(S),k={...wm,...C},O=d(E,k),N=y(E);super(S,!1,O,N?o():null),this._Q=t(this,N,O.Q,Bt,jt),this._detune=t(this,N,O.detune,1200*Math.log2(Bt),-1200*Math.log2(Bt)),this._frequency=t(this,N,O.frequency,S.sampleRate/2,0),this._gain=t(this,N,O.gain,40*Math.log10(Bt),jt),this._nativeBiquadFilterNode=O,_(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(S){this._nativeBiquadFilterNode.type=S}getFrequencyResponse(S,C,E){try{this._nativeBiquadFilterNode.getFrequencyResponse(S,C,E)}catch(k){throw k.code===11?l():k}if(S.length!==C.length||C.length!==E.length)throw l()}})(ye,Os,Ym,Ra,Xh,se,Zt,Gn),Tn=((p,t)=>(o,l,d)=>{const v=new Set;return o.connect=(y=>(_,S=0,C=0)=>{const E=v.size===0;if(t(_))return y.call(o,_,S,C),p(v,[_,S,C],k=>k[0]===_&&k[1]===S&&k[2]===C,!0),E&&l(),_;y.call(o,_,S),p(v,[_,S],k=>k[0]===_&&k[1]===S,!0),E&&l()})(o.connect),o.disconnect=(y=>(_,S,C)=>{const E=v.size>0;if(_===void 0)y.apply(o),v.clear();else if(typeof _=="number"){y.call(o,_);for(const O of v)O[1]===_&&v.delete(O)}else{t(_)?y.call(o,_,S,C):y.call(o,_,S);for(const O of v)O[0]!==_||S!==void 0&&O[1]!==S||C!==void 0&&O[2]!==C||v.delete(O)}const k=v.size===0;E&&k&&d()})(o.disconnect),o})(Ce,tl),Qm=((p,t)=>(o,l)=>{l.channelCount=1,l.channelCountMode="explicit",Object.defineProperty(l,"channelCount",{get:()=>1,set:()=>{throw p()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:()=>{throw p()}});const d=o.createBufferSource();t(l,()=>{const v=l.numberOfInputs;for(let y=0;y<v;y+=1)d.connect(l,0,y)},()=>d.disconnect(l))})(Re,Tn),An=((p,t)=>(o,l)=>{const d=o.createChannelMerger(l.numberOfInputs);return p!==null&&p.name==="webkitAudioContext"&&t(o,d),Te(d,l),d})(Cn,Qm),Jm=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ht(C,S)){const E={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,numberOfInputs:C.numberOfInputs};C=p(S,E)}return l.set(S,C),await o(_,S,C),C})(d,v)}}})(An,Jt,Le),Km=((p,t,o,l,d)=>class extends p{constructor(v,y){const _=l(v),S={..._m,...y};super(v,!1,o(_,S),d(_)?t():null)}})(ye,Jm,An,se,Zt),tf=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ht(C,S)){const E={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,numberOfOutputs:C.numberOfOutputs};C=p(S,E)}return l.set(S,C),await o(_,S,C),C})(d,v)}}})(mo,Jt,Le),ef=((p,t,o,l,d,v)=>class extends p{constructor(y,_){const S=l(y),C=(E=>({...E,channelCount:E.numberOfOutputs}))({...xm,..._});super(y,!1,o(S,C),d(S)?t():null)}})(ye,tf,mo,se,Zt),sf=((p,t,o,l)=>(d,{offset:v,...y})=>{const _=d.createBuffer(1,2,44100),S=t(d,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),C=o(d,{...y,gain:v}),E=_.getChannelData(0);E[0]=1,E[1]=1,S.buffer=_,S.loop=!0;const k={get bufferSize(){},get channelCount(){return C.channelCount},set channelCount(O){C.channelCount=O},get channelCountMode(){return C.channelCountMode},set channelCountMode(O){C.channelCountMode=O},get channelInterpretation(){return C.channelInterpretation},set channelInterpretation(O){C.channelInterpretation=O},get context(){return C.context},get inputs(){return[]},get numberOfInputs(){return S.numberOfInputs},get numberOfOutputs(){return C.numberOfOutputs},get offset(){return C.gain},get onended(){return S.onended},set onended(O){S.onended=O},addEventListener:(...O)=>S.addEventListener(O[0],O[1],O[2]),dispatchEvent:(...O)=>S.dispatchEvent(O[0]),removeEventListener:(...O)=>S.removeEventListener(O[0],O[1],O[2]),start(O=0){S.start.call(S,O)},stop(O=0){S.stop.call(S,O)}};return p(d,S),l(mi(k,C),()=>S.connect(C),()=>S.disconnect(C))})(Oa,vi,is,Tn),yi=((p,t,o,l,d)=>(v,y)=>{if(v.createConstantSource===void 0)return o(v,y);const _=v.createConstantSource();return Te(_,y),fe(_,y,"offset"),t(l,()=>l(v))||Xr(_),t(d,()=>d(v))||Yr(_),p(v,_),_})(Oa,Ss,sf,Zr,Qr),nf=((p,t,o,l,d)=>()=>{const v=new WeakMap;let y=null,_=null;return{set start(S){y=S},set stop(S){_=S},render(S,C){const E=v.get(C);return E!==void 0?Promise.resolve(E):(async(k,O)=>{let N=o(k);const q=ht(N,O);if(!q){const $={channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,offset:N.offset.value};N=t(O,$),y!==null&&N.start(y),_!==null&&N.stop(_)}return v.set(O,N),q?await p(O,k.offset,N.offset):await l(O,k.offset,N.offset),await d(k,O,N),N})(S,C)}}})(js,yi,Jt,Us,Le),of=((p,t,o,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),E={...Sm,...S},k=l(C,E),O=v(C),N=O?o():null;super(_,!1,k,N),this._constantSourceNodeRenderer=N,this._nativeConstantSourceNode=k,this._offset=t(this,O,k.offset,Bt,jt),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(_){const S=typeof _=="function"?y(this,_):null;this._nativeConstantSourceNode.onended=S;const C=this._nativeConstantSourceNode.onended;this._onended=C!==null&&C===S?_:C}start(_=0){if(this._nativeConstantSourceNode.start(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=_),this.context.state!=="closed"){Mt(this);const S=()=>{this._nativeConstantSourceNode.removeEventListener("ended",S),ee(this)&&Wt(this)};this._nativeConstantSourceNode.addEventListener("ended",S)}}stop(_=0){this._nativeConstantSourceNode.stop(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=_)}})(ye,Os,nf,yi,se,Zt,fi),mu=((p,t)=>(o,l)=>{const d=o.createConvolver();if(Te(d,l),l.disableNormalization===d.normalize&&(d.normalize=!l.disableNormalization),le(d,l,"buffer"),l.channelCount>2||(t(d,"channelCount",v=>()=>v.call(d),v=>y=>{if(y>2)throw p();return v.call(d,y)}),l.channelCountMode==="max"))throw p();return t(d,"channelCountMode",v=>()=>v.call(d),v=>y=>{if(y==="max")throw p();return v.call(d,y)}),d})(Qe,go),af=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ht(C,S)){const E={buffer:C.buffer,channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,disableNormalization:!C.normalize};C=p(S,E)}return l.set(S,C),Ne(C)?await o(_,S,C.inputs[0]):await o(_,S,C),C})(d,v)}}})(mu,Jt,Le),rf=((p,t,o,l,d,v)=>class extends p{constructor(y,_){const S=l(y),C={...Cm,..._},E=o(S,C);super(y,!1,E,d(S)?t():null),this._isBufferNullified=!1,this._nativeConvolverNode=E,C.buffer!==null&&v(this,C.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(y){if(this._nativeConvolverNode.buffer=y,y===null&&this._nativeConvolverNode.buffer!==null){const _=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=_.createBuffer(1,1,_.sampleRate),this._isBufferNullified=!0,v(this,0)}else this._isBufferNullified=!1,v(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(y){this._nativeConvolverNode.normalize=y}})(ye,af,mu,se,Zt,Gn),lf=((p,t,o,l,d)=>v=>{const y=new WeakMap;return{render(_,S){const C=y.get(S);return C!==void 0?Promise.resolve(C):(async(E,k)=>{let O=o(E);const N=ht(O,k);if(!N){const q={channelCount:O.channelCount,channelCountMode:O.channelCountMode,channelInterpretation:O.channelInterpretation,delayTime:O.delayTime.value,maxDelayTime:v};O=t(k,q)}return y.set(k,O),N?await p(k,E.delayTime,O.delayTime):await l(k,E.delayTime,O.delayTime),await d(E,k,O),O})(_,S)}}})(js,Yh,Jt,Us,Le),cf=((p,t,o,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),E={...Tm,...S},k=l(C,E),O=v(C);super(_,!1,k,O?o(E.maxDelayTime):null),this._delayTime=t(this,O,k.delayTime),y(this,E.maxDelayTime)}get delayTime(){return this._delayTime}})(ye,Os,lf,Yh,se,Zt,Gn),fu=(p=>(t,o)=>{const l=t.createDynamicsCompressor();if(Te(l,o),o.channelCount>2||o.channelCountMode==="max")throw p();return fe(l,o,"attack"),fe(l,o,"knee"),fe(l,o,"ratio"),fe(l,o,"release"),fe(l,o,"threshold"),l})(Qe),hf=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,E)=>{let k=o(C);const O=ht(k,E);if(!O){const N={attack:k.attack.value,channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,knee:k.knee.value,ratio:k.ratio.value,release:k.release.value,threshold:k.threshold.value};k=t(E,N)}return v.set(E,k),O?(await p(E,C.attack,k.attack),await p(E,C.knee,k.knee),await p(E,C.ratio,k.ratio),await p(E,C.release,k.release),await p(E,C.threshold,k.threshold)):(await l(E,C.attack,k.attack),await l(E,C.knee,k.knee),await l(E,C.ratio,k.ratio),await l(E,C.release,k.release),await l(E,C.threshold,k.threshold)),await d(C,E,k),k})(y,_)}}})(js,fu,Jt,Us,Le),uf=((p,t,o,l,d,v,y,_)=>class extends p{constructor(S,C){const E=v(S),k={...Am,...C},O=l(E,k),N=y(E);super(S,!1,O,N?o():null),this._attack=t(this,N,O.attack),this._knee=t(this,N,O.knee),this._nativeDynamicsCompressorNode=O,this._ratio=t(this,N,O.ratio),this._release=t(this,N,O.release),this._threshold=t(this,N,O.threshold),_(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(S){const C=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=S,S>2)throw this._nativeDynamicsCompressorNode.channelCount=C,d()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(S){const C=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=S,S==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=C,d()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(ye,Os,hf,fu,Qe,se,Zt,Gn),df=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,E)=>{let k=o(C);const O=ht(k,E);if(!O){const N={channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,gain:k.gain.value};k=t(E,N)}return v.set(E,k),O?await p(E,C.gain,k.gain):await l(E,C.gain,k.gain),await d(C,E,k),k})(y,_)}}})(js,is,Jt,Us,Le),pf=((p,t,o,l,d,v)=>class extends p{constructor(y,_){const S=d(y),C={...Mm,..._},E=l(S,C),k=v(S);super(y,!1,E,k?o():null),this._gain=t(this,k,E.gain,Bt,jt)}get gain(){return this._gain}})(ye,Os,df,is,se,Zt),mf=((p,t,o,l)=>(d,v,{channelCount:y,channelCountMode:_,channelInterpretation:S,feedback:C,feedforward:E})=>{const k=Uh(v,d.sampleRate),O=C instanceof Float64Array?C:new Float64Array(C),N=E instanceof Float64Array?E:new Float64Array(E),q=O.length,$=N.length,L=Math.min(q,$);if(q===0||q>20)throw l();if(O[0]===0)throw t();if($===0||$>20)throw l();if(N[0]===0)throw t();if(O[0]!==1){for(let G=0;G<$;G+=1)N[G]/=O[0];for(let G=1;G<q;G+=1)O[G]/=O[0]}const W=o(d,k,y,y);W.channelCount=y,W.channelCountMode=_,W.channelInterpretation=S;const z=[],B=[],Z=[];for(let G=0;G<y;G+=1){z.push(0);const X=new Float32Array(32),V=new Float32Array(32);X.fill(0),V.fill(0),B.push(X),Z.push(V)}W.onaudioprocess=G=>{const X=G.inputBuffer,V=G.outputBuffer,st=X.numberOfChannels;for(let U=0;U<st;U+=1){const K=X.getChannelData(U),lt=V.getChannelData(U);z[U]=Gh(O,q,N,$,L,B[U],Z[U],z[U],32,K,lt)}};const et=d.sampleRate/2;return mi({get bufferSize(){return k},get channelCount(){return W.channelCount},set channelCount(G){W.channelCount=G},get channelCountMode(){return W.channelCountMode},set channelCountMode(G){W.channelCountMode=G},get channelInterpretation(){return W.channelInterpretation},set channelInterpretation(G){W.channelInterpretation=G},get context(){return W.context},get inputs(){return[W]},get numberOfInputs(){return W.numberOfInputs},get numberOfOutputs(){return W.numberOfOutputs},addEventListener:(...G)=>W.addEventListener(G[0],G[1],G[2]),dispatchEvent:(...G)=>W.dispatchEvent(G[0]),getFrequencyResponse(G,X,V){if(G.length!==X.length||X.length!==V.length)throw p();const st=G.length;for(let U=0;U<st;U+=1){const K=-Math.PI*(G[U]/et),lt=[Math.cos(K),Math.sin(K)],ct=km(Zh(N,lt),Zh(O,lt));X[U]=Math.sqrt(ct[0]*ct[0]+ct[1]*ct[1]),V[U]=Math.atan2(ct[1],ct[0])}},removeEventListener:(...G)=>W.removeEventListener(G[0],G[1],G[2])},W)})(Ra,Re,fo,Qe),Na=((p,t,o,l)=>d=>p(po,()=>po(d))?Promise.resolve(p(l,l)).then(v=>{if(!v){const y=o(d,512,0,1);d.oncomplete=()=>{y.onaudioprocess=null,y.disconnect()},y.onaudioprocess=()=>d.currentTime,y.connect(d.destination)}return d.startRendering()}):new Promise(v=>{const y=t(d,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});d.oncomplete=_=>{y.disconnect(),v(_.renderedBuffer)},y.connect(d.destination),d.startRendering()}))(Ss,is,fo,((p,t)=>()=>{if(t===null)return Promise.resolve(!1);const o=new t(1,1,44100),l=p(o,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(d=>{o.oncomplete=()=>{l.disconnect(),d(o.currentTime!==0)},o.startRendering()})})(is,De)),ff=((p,t,o,l,d)=>(v,y)=>{const _=new WeakMap;let S=null;return{render(C,E){const k=_.get(E);return k!==void 0?Promise.resolve(k):(async(O,N)=>{let q=null,$=t(O);const L=ht($,N);if(N.createIIRFilter===void 0?q=p(N,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):L||($=N.createIIRFilter(y,v)),_.set(N,q===null?$:q),q!==null){if(S===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const z=new o(O.context.destination.channelCount,O.context.length,N.sampleRate);S=(async()=>(await l(O,z,z.destination),((B,Z,et,G)=>{const X=et instanceof Float64Array?et:new Float64Array(et),V=G instanceof Float64Array?G:new Float64Array(G),st=X.length,U=V.length,K=Math.min(st,U);if(X[0]!==1){for(let vt=0;vt<st;vt+=1)V[vt]/=X[0];for(let vt=1;vt<U;vt+=1)X[vt]/=X[0]}const lt=new Float32Array(32),ct=new Float32Array(32),At=Z.createBuffer(B.numberOfChannels,B.length,B.sampleRate),yt=B.numberOfChannels;for(let vt=0;vt<yt;vt+=1){const Pt=B.getChannelData(vt),ft=At.getChannelData(vt);lt.fill(0),ct.fill(0),Gh(X,st,V,U,K,lt,ct,0,32,Pt,ft)}return At})(await d(z),N,v,y)))()}const W=await S;return q.buffer=W,q.start(0),q}return await l(O,N,$),$})(C,E)}}})(vi,Jt,De,Le,Na),gf=(p=>(t,o,l)=>{if(t.createIIRFilter===void 0)return p(t,o,l);const d=t.createIIRFilter(l.feedforward,l.feedback);return Te(d,l),d})(mf),vf=((p,t,o,l,d,v)=>class extends p{constructor(y,_){const S=l(y),C=d(S),E={...Em,..._},k=t(S,C?null:y.baseLatency,E);super(y,!1,k,C?o(E.feedback,E.feedforward):null),(O=>{var N;O.getFrequencyResponse=(N=O.getFrequencyResponse,(q,$,L)=>{if(q.length!==$.length||$.length!==L.length)throw Ra();return N.call(O,q,$,L)})})(k),this._nativeIIRFilterNode=k,v(this,1)}getFrequencyResponse(y,_,S){return this._nativeIIRFilterNode.getFrequencyResponse(y,_,S)}})(ye,gf,ff,se,Zt,Gn),yf=((p,t,o,l,d,v,y,_)=>(S,C)=>{const E=C.listener,{forwardX:k,forwardY:O,forwardZ:N,positionX:q,positionY:$,positionZ:L,upX:W,upY:z,upZ:B}=E.forwardX===void 0?(()=>{const Z=new Float32Array(1),et=t(C,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),G=y(C);let X=!1,V=[0,0,-1,0,1,0],st=[0,0,0];const U=()=>{if(X)return;X=!0;const At=l(C,256,9,0);At.onaudioprocess=({inputBuffer:yt})=>{const vt=[v(yt,Z,0),v(yt,Z,1),v(yt,Z,2),v(yt,Z,3),v(yt,Z,4),v(yt,Z,5)];vt.some((ft,kt)=>ft!==V[kt])&&(E.setOrientation(...vt),V=vt);const Pt=[v(yt,Z,6),v(yt,Z,7),v(yt,Z,8)];Pt.some((ft,kt)=>ft!==st[kt])&&(E.setPosition(...Pt),st=Pt)},et.connect(At)},K=At=>yt=>{yt!==V[At]&&(V[At]=yt,E.setOrientation(...V))},lt=At=>yt=>{yt!==st[At]&&(st[At]=yt,E.setPosition(...st))},ct=(At,yt,vt)=>{const Pt=o(C,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:yt});Pt.connect(et,0,At),Pt.start(),Object.defineProperty(Pt.offset,"defaultValue",{get:()=>yt});const ft=p({context:S},G,Pt.offset,Bt,jt);var kt,Lt,Vt,oe,ve,as,Ot;return _(ft,"value",pt=>()=>pt.call(ft),pt=>te=>{try{pt.call(ft,te)}catch(Yt){if(Yt.code!==9)throw Yt}U(),G&&vt(te)}),ft.cancelAndHoldAtTime=(kt=ft.cancelAndHoldAtTime,G?()=>{throw d()}:(...pt)=>{const te=kt.apply(ft,pt);return U(),te}),ft.cancelScheduledValues=(Lt=ft.cancelScheduledValues,G?()=>{throw d()}:(...pt)=>{const te=Lt.apply(ft,pt);return U(),te}),ft.exponentialRampToValueAtTime=(Vt=ft.exponentialRampToValueAtTime,G?()=>{throw d()}:(...pt)=>{const te=Vt.apply(ft,pt);return U(),te}),ft.linearRampToValueAtTime=(oe=ft.linearRampToValueAtTime,G?()=>{throw d()}:(...pt)=>{const te=oe.apply(ft,pt);return U(),te}),ft.setTargetAtTime=(ve=ft.setTargetAtTime,G?()=>{throw d()}:(...pt)=>{const te=ve.apply(ft,pt);return U(),te}),ft.setValueAtTime=(as=ft.setValueAtTime,G?()=>{throw d()}:(...pt)=>{const te=as.apply(ft,pt);return U(),te}),ft.setValueCurveAtTime=(Ot=ft.setValueCurveAtTime,G?()=>{throw d()}:(...pt)=>{const te=Ot.apply(ft,pt);return U(),te}),ft};return{forwardX:ct(0,0,K(0)),forwardY:ct(1,0,K(1)),forwardZ:ct(2,-1,K(2)),positionX:ct(6,0,lt(0)),positionY:ct(7,0,lt(1)),positionZ:ct(8,0,lt(2)),upX:ct(3,0,K(3)),upY:ct(4,1,K(4)),upZ:ct(5,0,K(5))}})():E;return{get forwardX(){return k},get forwardY(){return O},get forwardZ(){return N},get positionX(){return q},get positionY(){return $},get positionZ(){return L},get upX(){return W},get upY(){return z},get upZ(){return B}}})(Os,An,yi,fo,Qe,Qh,Zt,go),gu=new WeakMap,bf=((p,t,o,l,d,v)=>class extends o{constructor(y,_){super(y),this._nativeContext=y,P.set(this,y),l(y)&&d.set(y,new Set),this._destination=new p(this,_),this._listener=t(this,y),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(y){const _=typeof y=="function"?v(this,y):null;this._nativeContext.onstatechange=_;const S=this._nativeContext.onstatechange;this._onstatechange=S!==null&&S===_?y:S}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(Xm,yf,au,Zt,gu,fi),vu=((p,t,o,l,d,v)=>(y,_)=>{const S=y.createOscillator();return Te(S,_),fe(S,_,"detune"),fe(S,_,"frequency"),_.periodicWave!==void 0?S.setPeriodicWave(_.periodicWave):le(S,_,"type"),t(o,()=>o(y))||Xr(S),t(l,()=>l(y))||v(S,y),t(d,()=>d(y))||Yr(S),p(y,S),S})(Oa,Ss,Zr,tu,Qr,eu),wf=((p,t,o,l,d)=>()=>{const v=new WeakMap;let y=null,_=null,S=null;return{set periodicWave(C){y=C},set start(C){_=C},set stop(C){S=C},render(C,E){const k=v.get(E);return k!==void 0?Promise.resolve(k):(async(O,N)=>{let q=o(O);const $=ht(q,N);if(!$){const L={channelCount:q.channelCount,channelCountMode:q.channelCountMode,channelInterpretation:q.channelInterpretation,detune:q.detune.value,frequency:q.frequency.value,periodicWave:y===null?void 0:y,type:q.type};q=t(N,L),_!==null&&q.start(_),S!==null&&q.stop(S)}return v.set(N,q),$?(await p(N,O.detune,q.detune),await p(N,O.frequency,q.frequency)):(await l(N,O.detune,q.detune),await l(N,O.frequency,q.frequency)),await d(O,N,q),q})(C,E)}}})(js,vu,Jt,Us,Le),_f=((p,t,o,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),E={...Rm,...S},k=o(C,E),O=v(C),N=O?l():null,q=_.sampleRate/2;super(_,!1,k,N),this._detune=t(this,O,k.detune,153600,-153600),this._frequency=t(this,O,k.frequency,q,-q),this._nativeOscillatorNode=k,this._onended=null,this._oscillatorNodeRenderer=N,this._oscillatorNodeRenderer!==null&&E.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=E.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(_){const S=typeof _=="function"?y(this,_):null;this._nativeOscillatorNode.onended=S;const C=this._nativeOscillatorNode.onended;this._onended=C!==null&&C===S?_:C}get type(){return this._nativeOscillatorNode.type}set type(_){this._nativeOscillatorNode.type=_,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(_){this._nativeOscillatorNode.setPeriodicWave(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=_)}start(_=0){if(this._nativeOscillatorNode.start(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=_),this.context.state!=="closed"){Mt(this);const S=()=>{this._nativeOscillatorNode.removeEventListener("ended",S),ee(this)&&Wt(this)};this._nativeOscillatorNode.addEventListener("ended",S)}}stop(_=0){this._nativeOscillatorNode.stop(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=_)}})(ye,Os,vu,wf,se,Zt,fi),yu=(p=>(t,o)=>{const l=p(t,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),d=t.createBuffer(1,2,44100);return l.buffer=d,l.loop=!0,l.connect(o),l.start(),()=>{l.stop(),l.disconnect(o)}})(vi),xf=((p,t,o,l,d)=>(v,{curve:y,oversample:_,...S})=>{const C=v.createWaveShaper(),E=v.createWaveShaper();Te(C,S),Te(E,S);const k=o(v,{...S,gain:1}),O=o(v,{...S,gain:-1}),N=o(v,{...S,gain:1}),q=o(v,{...S,gain:-1});let $=null,L=!1,W=null;const z={get bufferSize(){},get channelCount(){return C.channelCount},set channelCount(B){k.channelCount=B,O.channelCount=B,C.channelCount=B,N.channelCount=B,E.channelCount=B,q.channelCount=B},get channelCountMode(){return C.channelCountMode},set channelCountMode(B){k.channelCountMode=B,O.channelCountMode=B,C.channelCountMode=B,N.channelCountMode=B,E.channelCountMode=B,q.channelCountMode=B},get channelInterpretation(){return C.channelInterpretation},set channelInterpretation(B){k.channelInterpretation=B,O.channelInterpretation=B,C.channelInterpretation=B,N.channelInterpretation=B,E.channelInterpretation=B,q.channelInterpretation=B},get context(){return C.context},get curve(){return W},set curve(B){if(B!==null&&B.length<2)throw t();if(B===null)C.curve=B,E.curve=B;else{const Z=B.length,et=new Float32Array(Z+2-Z%2),G=new Float32Array(Z+2-Z%2);et[0]=B[0],G[0]=-B[Z-1];const X=Math.ceil((Z+1)/2),V=(Z+1)/2-1;for(let st=1;st<X;st+=1){const U=st/X*V,K=Math.floor(U),lt=Math.ceil(U);et[st]=K===lt?B[K]:(1-(U-K))*B[K]+(1-(lt-U))*B[lt],G[st]=K===lt?-B[Z-1-K]:-(1-(U-K))*B[Z-1-K]-(1-(lt-U))*B[Z-1-lt]}et[X]=Z%2==1?B[X-1]:(B[X-2]+B[X-1])/2,C.curve=et,E.curve=G}W=B,L&&(l(W)&&$===null?$=p(v,k):$!==null&&($(),$=null))},get inputs(){return[k]},get numberOfInputs(){return C.numberOfInputs},get numberOfOutputs(){return C.numberOfOutputs},get oversample(){return C.oversample},set oversample(B){C.oversample=B,E.oversample=B},addEventListener:(...B)=>k.addEventListener(B[0],B[1],B[2]),dispatchEvent:(...B)=>k.dispatchEvent(B[0]),removeEventListener:(...B)=>k.removeEventListener(B[0],B[1],B[2])};return y!==null&&(z.curve=y instanceof Float32Array?y:new Float32Array(y)),_!==z.oversample&&(z.oversample=_),d(mi(z,N),()=>{k.connect(C).connect(N),k.connect(O).connect(E).connect(q).connect(N),L=!0,l(W)&&($=p(v,k))},()=>{k.disconnect(C),C.disconnect(N),k.disconnect(O),O.disconnect(E),E.disconnect(q),q.disconnect(N),L=!1,$!==null&&($(),$=null)})})(yu,Re,is,Jh,Tn),La=((p,t,o,l,d,v,y)=>(_,S)=>{const C=_.createWaveShaper();if(v!==null&&v.name==="webkitAudioContext"&&_.createGain().gain.automationRate===void 0)return o(_,S);Te(C,S);const E=S.curve===null||S.curve instanceof Float32Array?S.curve:new Float32Array(S.curve);if(E!==null&&E.length<2)throw t();le(C,{curve:E},"curve"),le(C,S,"oversample");let k=null,O=!1;return y(C,"curve",N=>()=>N.call(C),N=>q=>(N.call(C,q),O&&(l(q)&&k===null?k=p(_,C):l(q)||k===null||(k(),k=null)),q)),d(C,()=>{O=!0,l(C.curve)&&(k=p(_,C))},()=>{O=!1,k!==null&&(k(),k=null)})})(yu,Re,xf,Jh,Tn,Cn,go),Sf=((p,t,o,l,d,v,y,_,S,C)=>(E,{coneInnerAngle:k,coneOuterAngle:O,coneOuterGain:N,distanceModel:q,maxDistance:$,orientationX:L,orientationY:W,orientationZ:z,panningModel:B,positionX:Z,positionY:et,positionZ:G,refDistance:X,rolloffFactor:V,...st})=>{const U=E.createPanner();if(st.channelCount>2||st.channelCountMode==="max")throw y();Te(U,st);const K={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},lt=o(E,{...K,channelInterpretation:"speakers",numberOfInputs:6}),ct=l(E,{...st,gain:1}),At=l(E,{...K,gain:1}),yt=l(E,{...K,gain:0}),vt=l(E,{...K,gain:0}),Pt=l(E,{...K,gain:0}),ft=l(E,{...K,gain:0}),kt=l(E,{...K,gain:0}),Lt=d(E,256,6,1),Vt=v(E,{...K,curve:new Float32Array([1,1]),oversample:"none"});let oe=[L,W,z],ve=[Z,et,G];const as=new Float32Array(1);Lt.onaudioprocess=({inputBuffer:pt})=>{const te=[S(pt,as,0),S(pt,as,1),S(pt,as,2)];te.some((We,Nn)=>We!==oe[Nn])&&(U.setOrientation(...te),oe=te);const Yt=[S(pt,as,3),S(pt,as,4),S(pt,as,5)];Yt.some((We,Nn)=>We!==ve[Nn])&&(U.setPosition(...Yt),ve=Yt)},Object.defineProperty(yt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(vt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Pt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(ft.gain,"defaultValue",{get:()=>0}),Object.defineProperty(kt.gain,"defaultValue",{get:()=>0});const Ot={get bufferSize(){},get channelCount(){return U.channelCount},set channelCount(pt){if(pt>2)throw y();ct.channelCount=pt,U.channelCount=pt},get channelCountMode(){return U.channelCountMode},set channelCountMode(pt){if(pt==="max")throw y();ct.channelCountMode=pt,U.channelCountMode=pt},get channelInterpretation(){return U.channelInterpretation},set channelInterpretation(pt){ct.channelInterpretation=pt,U.channelInterpretation=pt},get coneInnerAngle(){return U.coneInnerAngle},set coneInnerAngle(pt){U.coneInnerAngle=pt},get coneOuterAngle(){return U.coneOuterAngle},set coneOuterAngle(pt){U.coneOuterAngle=pt},get coneOuterGain(){return U.coneOuterGain},set coneOuterGain(pt){if(pt<0||pt>1)throw t();U.coneOuterGain=pt},get context(){return U.context},get distanceModel(){return U.distanceModel},set distanceModel(pt){U.distanceModel=pt},get inputs(){return[ct]},get maxDistance(){return U.maxDistance},set maxDistance(pt){if(pt<0)throw new RangeError;U.maxDistance=pt},get numberOfInputs(){return U.numberOfInputs},get numberOfOutputs(){return U.numberOfOutputs},get orientationX(){return At.gain},get orientationY(){return yt.gain},get orientationZ(){return vt.gain},get panningModel(){return U.panningModel},set panningModel(pt){U.panningModel=pt},get positionX(){return Pt.gain},get positionY(){return ft.gain},get positionZ(){return kt.gain},get refDistance(){return U.refDistance},set refDistance(pt){if(pt<0)throw new RangeError;U.refDistance=pt},get rolloffFactor(){return U.rolloffFactor},set rolloffFactor(pt){if(pt<0)throw new RangeError;U.rolloffFactor=pt},addEventListener:(...pt)=>ct.addEventListener(pt[0],pt[1],pt[2]),dispatchEvent:(...pt)=>ct.dispatchEvent(pt[0]),removeEventListener:(...pt)=>ct.removeEventListener(pt[0],pt[1],pt[2])};return k!==Ot.coneInnerAngle&&(Ot.coneInnerAngle=k),O!==Ot.coneOuterAngle&&(Ot.coneOuterAngle=O),N!==Ot.coneOuterGain&&(Ot.coneOuterGain=N),q!==Ot.distanceModel&&(Ot.distanceModel=q),$!==Ot.maxDistance&&(Ot.maxDistance=$),L!==Ot.orientationX.value&&(Ot.orientationX.value=L),W!==Ot.orientationY.value&&(Ot.orientationY.value=W),z!==Ot.orientationZ.value&&(Ot.orientationZ.value=z),B!==Ot.panningModel&&(Ot.panningModel=B),Z!==Ot.positionX.value&&(Ot.positionX.value=Z),et!==Ot.positionY.value&&(Ot.positionY.value=et),G!==Ot.positionZ.value&&(Ot.positionZ.value=G),X!==Ot.refDistance&&(Ot.refDistance=X),V!==Ot.rolloffFactor&&(Ot.rolloffFactor=V),oe[0]===1&&oe[1]===0&&oe[2]===0||U.setOrientation(...oe),ve[0]===0&&ve[1]===0&&ve[2]===0||U.setPosition(...ve),C(mi(Ot,U),()=>{ct.connect(U),p(ct,Vt,0,0),Vt.connect(At).connect(lt,0,0),Vt.connect(yt).connect(lt,0,1),Vt.connect(vt).connect(lt,0,2),Vt.connect(Pt).connect(lt,0,3),Vt.connect(ft).connect(lt,0,4),Vt.connect(kt).connect(lt,0,5),lt.connect(Lt).connect(E.destination)},()=>{ct.disconnect(U),_(ct,Vt,0,0),Vt.disconnect(At),At.disconnect(lt),Vt.disconnect(yt),yt.disconnect(lt),Vt.disconnect(vt),vt.disconnect(lt),Vt.disconnect(Pt),Pt.disconnect(lt),Vt.disconnect(ft),ft.disconnect(lt),Vt.disconnect(kt),kt.disconnect(lt),lt.disconnect(Lt),Lt.disconnect(E.destination)})})(xn,Re,An,is,fo,La,Qe,Sn,Qh,Tn),bu=(p=>(t,o)=>{const l=t.createPanner();return l.orientationX===void 0?p(t,o):(Te(l,o),fe(l,o,"orientationX"),fe(l,o,"orientationY"),fe(l,o,"orientationZ"),fe(l,o,"positionX"),fe(l,o,"positionY"),fe(l,o,"positionZ"),le(l,o,"coneInnerAngle"),le(l,o,"coneOuterAngle"),le(l,o,"coneOuterGain"),le(l,o,"distanceModel"),le(l,o,"maxDistance"),le(l,o,"panningModel"),le(l,o,"refDistance"),le(l,o,"rolloffFactor"),l)})(Sf),Cf=((p,t,o,l,d,v,y,_,S,C)=>()=>{const E=new WeakMap;let k=null;return{render(O,N){const q=E.get(N);return q!==void 0?Promise.resolve(q):(async($,L)=>{let W=null,z=v($);const B={channelCount:z.channelCount,channelCountMode:z.channelCountMode,channelInterpretation:z.channelInterpretation},Z={...B,coneInnerAngle:z.coneInnerAngle,coneOuterAngle:z.coneOuterAngle,coneOuterGain:z.coneOuterGain,distanceModel:z.distanceModel,maxDistance:z.maxDistance,panningModel:z.panningModel,refDistance:z.refDistance,rolloffFactor:z.rolloffFactor},et=ht(z,L);if("bufferSize"in z)W=l(L,{...B,gain:1});else if(!et){const G={...Z,orientationX:z.orientationX.value,orientationY:z.orientationY.value,orientationZ:z.orientationZ.value,positionX:z.positionX.value,positionY:z.positionY.value,positionZ:z.positionZ.value};z=d(L,G)}if(E.set(L,W===null?z:W),W!==null){if(k===null){if(y===null)throw new Error("Missing the native OfflineAudioContext constructor.");const ct=new y(6,$.context.length,L.sampleRate),At=t(ct,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});At.connect(ct.destination),k=(async()=>{const yt=await Promise.all([$.orientationX,$.orientationY,$.orientationZ,$.positionX,$.positionY,$.positionZ].map(async(vt,Pt)=>{const ft=o(ct,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Pt===0?1:0});return await _(ct,vt,ft.offset),ft}));for(let vt=0;vt<6;vt+=1)yt[vt].connect(At,0,vt),yt[vt].start(0);return C(ct)})()}const G=await k,X=l(L,{...B,gain:1});await S($,L,X);const V=[];for(let ct=0;ct<G.numberOfChannels;ct+=1)V.push(G.getChannelData(ct));let st=[V[0][0],V[1][0],V[2][0]],U=[V[3][0],V[4][0],V[5][0]],K=l(L,{...B,gain:1}),lt=d(L,{...Z,orientationX:st[0],orientationY:st[1],orientationZ:st[2],positionX:U[0],positionY:U[1],positionZ:U[2]});X.connect(K).connect(lt.inputs[0]),lt.connect(W);for(let ct=128;ct<G.length;ct+=128){const At=[V[0][ct],V[1][ct],V[2][ct]],yt=[V[3][ct],V[4][ct],V[5][ct]];if(At.some((vt,Pt)=>vt!==st[Pt])||yt.some((vt,Pt)=>vt!==U[Pt])){st=At,U=yt;const vt=ct/L.sampleRate;K.gain.setValueAtTime(0,vt),K=l(L,{...B,gain:0}),lt=d(L,{...Z,orientationX:st[0],orientationY:st[1],orientationZ:st[2],positionX:U[0],positionY:U[1],positionZ:U[2]}),K.gain.setValueAtTime(1,vt),X.connect(K).connect(lt.inputs[0]),lt.connect(W)}}return W}return et?(await p(L,$.orientationX,z.orientationX),await p(L,$.orientationY,z.orientationY),await p(L,$.orientationZ,z.orientationZ),await p(L,$.positionX,z.positionX),await p(L,$.positionY,z.positionY),await p(L,$.positionZ,z.positionZ)):(await _(L,$.orientationX,z.orientationX),await _(L,$.orientationY,z.orientationY),await _(L,$.orientationZ,z.orientationZ),await _(L,$.positionX,z.positionX),await _(L,$.positionY,z.positionY),await _(L,$.positionZ,z.positionZ)),Ne(z)?await S($,L,z.inputs[0]):await S($,L,z),z})(O,N)}}})(js,An,yi,is,bu,Jt,De,Us,Le,Na),Tf=((p,t,o,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),E={...Dm,...S},k=o(C,E),O=v(C);super(_,!1,k,O?l():null),this._nativePannerNode=k,this._orientationX=t(this,O,k.orientationX,Bt,jt),this._orientationY=t(this,O,k.orientationY,Bt,jt),this._orientationZ=t(this,O,k.orientationZ,Bt,jt),this._positionX=t(this,O,k.positionX,Bt,jt),this._positionY=t(this,O,k.positionY,Bt,jt),this._positionZ=t(this,O,k.positionZ,Bt,jt),y(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(_){this._nativePannerNode.coneInnerAngle=_}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(_){this._nativePannerNode.coneOuterAngle=_}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(_){this._nativePannerNode.coneOuterGain=_}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(_){this._nativePannerNode.distanceModel=_}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(_){this._nativePannerNode.maxDistance=_}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(_){this._nativePannerNode.panningModel=_}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(_){this._nativePannerNode.refDistance=_}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(_){this._nativePannerNode.rolloffFactor=_}})(ye,Os,bu,Cf,se,Zt,Gn),Af=(p=>(t,{disableNormalization:o,imag:l,real:d})=>{const v=l instanceof Float32Array?l:new Float32Array(l),y=d instanceof Float32Array?d:new Float32Array(d),_=t.createPeriodicWave(y,v,{disableNormalization:o});if(Array.from(l).length<2)throw p();return _})(Ct),Mf=((p,t,o,l)=>class ip{constructor(v,y){const _=t(v),S=(E=>{const{imag:k,real:O}=E;return k===void 0?O===void 0?{...E,imag:[0,0],real:[0,0]}:{...E,imag:Array.from(O,()=>0),real:O}:O===void 0?{...E,imag:k,real:Array.from(k,()=>0)}:{...E,imag:k,real:O}})({...Om,...y}),C=p(_,S);return o.add(C),C}static[Symbol.hasInstance](v){return v!==null&&typeof v=="object"&&Object.getPrototypeOf(v)===ip.prototype||o.has(v)}})(Af,se,new WeakSet),Ef=((p,t,o,l,d,v)=>{const _=new Float32Array([1,1]),S=Math.PI/2,C={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},E={...C,oversample:"none"},k=(O,N,q,$,L)=>{if(N===1)return((W,z,B,Z)=>{const et=new Float32Array(16385),G=new Float32Array(16385);for(let lt=0;lt<16385;lt+=1){const ct=lt/16384*S;et[lt]=Math.cos(ct),G[lt]=Math.sin(ct)}const X=o(W,{...C,gain:0}),V=l(W,{...E,curve:et}),st=l(W,{...E,curve:_}),U=o(W,{...C,gain:0}),K=l(W,{...E,curve:G});return{connectGraph(){z.connect(X),z.connect(st.inputs===void 0?st:st.inputs[0]),z.connect(U),st.connect(B),B.connect(V.inputs===void 0?V:V.inputs[0]),B.connect(K.inputs===void 0?K:K.inputs[0]),V.connect(X.gain),K.connect(U.gain),X.connect(Z,0,0),U.connect(Z,0,1)},disconnectGraph(){z.disconnect(X),z.disconnect(st.inputs===void 0?st:st.inputs[0]),z.disconnect(U),st.disconnect(B),B.disconnect(V.inputs===void 0?V:V.inputs[0]),B.disconnect(K.inputs===void 0?K:K.inputs[0]),V.disconnect(X.gain),K.disconnect(U.gain),X.disconnect(Z,0,0),U.disconnect(Z,0,1)}}})(O,q,$,L);if(N===2)return((W,z,B,Z)=>{const et=new Float32Array(16385),G=new Float32Array(16385),X=new Float32Array(16385),V=new Float32Array(16385),st=Math.floor(8192.5);for(let Lt=0;Lt<16385;Lt+=1)if(Lt>st){const Vt=(Lt-st)/(16384-st)*S;et[Lt]=Math.cos(Vt),G[Lt]=Math.sin(Vt),X[Lt]=0,V[Lt]=1}else{const Vt=Lt/(16384-st)*S;et[Lt]=1,G[Lt]=0,X[Lt]=Math.cos(Vt),V[Lt]=Math.sin(Vt)}const U=t(W,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),K=o(W,{...C,gain:0}),lt=l(W,{...E,curve:et}),ct=o(W,{...C,gain:0}),At=l(W,{...E,curve:G}),yt=l(W,{...E,curve:_}),vt=o(W,{...C,gain:0}),Pt=l(W,{...E,curve:X}),ft=o(W,{...C,gain:0}),kt=l(W,{...E,curve:V});return{connectGraph(){z.connect(U),z.connect(yt.inputs===void 0?yt:yt.inputs[0]),U.connect(K,0),U.connect(ct,0),U.connect(vt,1),U.connect(ft,1),yt.connect(B),B.connect(lt.inputs===void 0?lt:lt.inputs[0]),B.connect(At.inputs===void 0?At:At.inputs[0]),B.connect(Pt.inputs===void 0?Pt:Pt.inputs[0]),B.connect(kt.inputs===void 0?kt:kt.inputs[0]),lt.connect(K.gain),At.connect(ct.gain),Pt.connect(vt.gain),kt.connect(ft.gain),K.connect(Z,0,0),vt.connect(Z,0,0),ct.connect(Z,0,1),ft.connect(Z,0,1)},disconnectGraph(){z.disconnect(U),z.disconnect(yt.inputs===void 0?yt:yt.inputs[0]),U.disconnect(K,0),U.disconnect(ct,0),U.disconnect(vt,1),U.disconnect(ft,1),yt.disconnect(B),B.disconnect(lt.inputs===void 0?lt:lt.inputs[0]),B.disconnect(At.inputs===void 0?At:At.inputs[0]),B.disconnect(Pt.inputs===void 0?Pt:Pt.inputs[0]),B.disconnect(kt.inputs===void 0?kt:kt.inputs[0]),lt.disconnect(K.gain),At.disconnect(ct.gain),Pt.disconnect(vt.gain),kt.disconnect(ft.gain),K.disconnect(Z,0,0),vt.disconnect(Z,0,0),ct.disconnect(Z,0,1),ft.disconnect(Z,0,1)}}})(O,q,$,L);throw d()};return(O,{channelCount:N,channelCountMode:q,pan:$,...L})=>{if(q==="max")throw d();const W=p(O,{...L,channelCount:1,channelCountMode:q,numberOfInputs:2}),z=o(O,{...L,channelCount:N,channelCountMode:q,gain:1}),B=o(O,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:$});let{connectGraph:Z,disconnectGraph:et}=k(O,N,z,B,W);Object.defineProperty(B.gain,"defaultValue",{get:()=>0}),Object.defineProperty(B.gain,"maxValue",{get:()=>1}),Object.defineProperty(B.gain,"minValue",{get:()=>-1});const G={get bufferSize(){},get channelCount(){return z.channelCount},set channelCount(V){z.channelCount!==V&&(X&&et(),{connectGraph:Z,disconnectGraph:et}=k(O,V,z,B,W),X&&Z()),z.channelCount=V},get channelCountMode(){return z.channelCountMode},set channelCountMode(V){if(V==="clamped-max"||V==="max")throw d();z.channelCountMode=V},get channelInterpretation(){return z.channelInterpretation},set channelInterpretation(V){z.channelInterpretation=V},get context(){return z.context},get inputs(){return[z]},get numberOfInputs(){return z.numberOfInputs},get numberOfOutputs(){return z.numberOfOutputs},get pan(){return B.gain},addEventListener:(...V)=>z.addEventListener(V[0],V[1],V[2]),dispatchEvent:(...V)=>z.dispatchEvent(V[0]),removeEventListener:(...V)=>z.removeEventListener(V[0],V[1],V[2])};let X=!1;return v(mi(G,W),()=>{Z(),X=!0},()=>{et(),X=!1})}})(An,mo,is,La,Qe,Tn),wu=((p,t)=>(o,l)=>{const d=l.channelCountMode;if(d==="clamped-max")throw t();if(o.createStereoPanner===void 0)return p(o,l);const v=o.createStereoPanner();return Te(v,l),fe(v,l,"pan"),Object.defineProperty(v,"channelCountMode",{get:()=>d,set:y=>{if(y!==d)throw t()}}),v})(Ef,Qe),Pf=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(y,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(C,E)=>{let k=o(C);const O=ht(k,E);if(!O){const N={channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,pan:k.pan.value};k=t(E,N)}return v.set(E,k),O?await p(E,C.pan,k.pan):await l(E,C.pan,k.pan),Ne(k)?await d(C,E,k.inputs[0]):await d(C,E,k),k})(y,_)}}})(js,wu,Jt,Us,Le),kf=((p,t,o,l,d,v)=>class extends p{constructor(y,_){const S=d(y),C={...Nm,..._},E=o(S,C),k=v(S);super(y,!1,E,k?l():null),this._pan=t(this,k,E.pan)}get pan(){return this._pan}})(ye,Os,wu,Pf,se,Zt),If=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const y=l.get(v);return y!==void 0?Promise.resolve(y):(async(_,S)=>{let C=t(_);if(!ht(C,S)){const E={channelCount:C.channelCount,channelCountMode:C.channelCountMode,channelInterpretation:C.channelInterpretation,curve:C.curve,oversample:C.oversample};C=p(S,E)}return l.set(S,C),Ne(C)?await o(_,S,C.inputs[0]):await o(_,S,C),C})(d,v)}}})(La,Jt,Le),Rf=((p,t,o,l,d,v,y)=>class extends p{constructor(_,S){const C=d(_),E={...Fm,...S},k=o(C,E);super(_,!0,k,v(C)?l():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=k,y(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(_){if(_===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(_.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=_}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(_){this._nativeWaveShaperNode.oversample=_}})(ye,Re,La,If,se,Zt,Gn),_u=(p=>p!==null&&p.isSecureContext)(Ds),ol=(p=>(t,o,l)=>{Object.defineProperties(p,{currentFrame:{configurable:!0,get:()=>Math.round(t*o)},currentTime:{configurable:!0,get:()=>t}});try{return l()}finally{p!==null&&(delete p.currentFrame,delete p.currentTime)}})(Ds),xu=new WeakMap,Df=((p,t)=>o=>{let l=p.get(o);if(l!==void 0)return l;if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");return l=new t(1,1,44100),p.set(o,l),l})(xu,De),Of=_u?((p,t,o,l,d,v,y,_,S,C,E,k,O)=>{let N=0;return(q,$,L={credentials:"omit"})=>{const W=E.get(q);if(W!==void 0&&W.has($))return Promise.resolve();const z=C.get(q);if(z!==void 0){const et=z.get($);if(et!==void 0)return et}const B=v(q),Z=B.audioWorklet===void 0?d($).then(([et,G])=>{const[X,V]=F(et,G);return o(`${X};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${V}
})})(window,'_AWGS')`)}).then(()=>{const et=O._AWGS.pop();if(et===void 0)throw new SyntaxError;l(B.currentTime,B.sampleRate,()=>et(class{},void 0,(G,X)=>{if(G.trim()==="")throw t();const V=D.get(B);if(V!==void 0){if(V.has(G))throw t();tt(X),Y(X.parameterDescriptors),V.set(G,X)}else tt(X),Y(X.parameterDescriptors),D.set(B,new Map([[G,X]]))},B.sampleRate,void 0,void 0))}):Promise.all([d($),Promise.resolve(p(k,k))]).then(([[et,G],X])=>{const V=N+1;N=V;const[st,U]=F(et,G),K=new Blob([`${st};((AudioWorkletProcessor,registerProcessor)=>{${U}
})(${X?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${X?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${X?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${V}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),lt=URL.createObjectURL(K);return B.audioWorklet.addModule(lt,L).then(()=>{if(_(B))return B;const ct=y(B);return ct.audioWorklet.addModule(lt,L).then(()=>ct)}).then(ct=>{if(S===null)throw new SyntaxError;try{new S(ct,`__sac${V}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(lt))});return z===void 0?C.set(q,new Map([[$,Z]])):z.set($,Z),Z.then(()=>{const et=E.get(q);et===void 0?E.set(q,new Set([$])):et.add($)}).finally(()=>{const et=C.get(q);et!==void 0&&et.delete($)}),Z}})(Ss,Qe,(p=>t=>new Promise((o,l)=>{if(p===null)return void l(new SyntaxError);const d=p.document.head;if(d===null)l(new SyntaxError);else{const v=p.document.createElement("script"),y=new Blob([t],{type:"application/javascript"}),_=URL.createObjectURL(y),S=p.onerror,C=()=>{p.onerror=S,URL.revokeObjectURL(_)};p.onerror=(E,k,O,N,q)=>k===_||k===p.location.href&&O===1&&N===1?(C(),l(q),!1):S!==null?S(E,k,O,N,q):void 0,v.onerror=()=>{C(),l(new SyntaxError)},v.onload=()=>{C(),o()},v.src=_,v.type="module",d.appendChild(v)}}))(Ds),ol,async p=>{try{const t=await fetch(p);if(t.ok)return[await t.text(),t.url]}catch{}throw new DOMException("","AbortError")},se,Df,Zt,gi,new WeakMap,new WeakMap,((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const o=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new t(1,128,44100),d=URL.createObjectURL(o);let v=!1,y=!1;try{await l.audioWorklet.addModule(d);const _=new p(l,"a",{numberOfOutputs:0}),S=l.createOscillator();_.port.onmessage=()=>v=!0,_.onprocessorerror=()=>y=!0,S.connect(_),S.start(0),await l.startRendering(),await new Promise(C=>setTimeout(C))}catch{}finally{URL.revokeObjectURL(d)}return v&&!y})(gi,De),Ds):void 0,Nf=((p,t)=>o=>p(o)||t(o))(Kr,Zt),Lf=((p,t,o,l,d,v,y,_,S,C,E)=>(k,O)=>{const N=y(k)?k:v(k);if(d.has(O)){const q=new DOMException("","DataCloneError");return Promise.reject(q)}try{d.add(O)}catch{}return t(S,()=>S(N))?N.decodeAudioData(O).then(q=>(Hh(O).catch(()=>{}),t(_,()=>_(q))||E(q),p.add(q),q)):new Promise((q,$)=>{const L=async()=>{try{await Hh(O)}catch{}},W=z=>{$(z),L()};try{N.decodeAudioData(O,z=>{typeof z.copyFromChannel!="function"&&(C(z),dt(z)),p.add(z),L().then(()=>q(z))},z=>{W(z===null?new DOMException("","EncodingError"):z)})}catch(z){W(z)}})})(el,Ss,0,0,new WeakSet,se,Nf,ut,po,nl,il),Su=((p,t,o,l,d,v,y,_,S,C,E,k,O,N,q,$,L,W,z,B)=>class extends q{constructor(Z,et){super(Z,et),this._nativeContext=Z,this._audioWorklet=p===void 0?void 0:{addModule:(G,X)=>p(this,G,X)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new t(this)}createBiquadFilter(){return new d(this)}createBuffer(Z,et,G){return new o({length:et,numberOfChannels:Z,sampleRate:G})}createBufferSource(){return new l(this)}createChannelMerger(Z=6){return new v(this,{numberOfInputs:Z})}createChannelSplitter(Z=6){return new y(this,{numberOfOutputs:Z})}createConstantSource(){return new _(this)}createConvolver(){return new S(this)}createDelay(Z=1){return new E(this,{maxDelayTime:Z})}createDynamicsCompressor(){return new k(this)}createGain(){return new O(this)}createIIRFilter(Z,et){return new N(this,{feedback:et,feedforward:Z})}createOscillator(){return new $(this)}createPanner(){return new L(this)}createPeriodicWave(Z,et,G={disableNormalization:!1}){return new W(this,{...G,imag:et,real:Z})}createStereoPanner(){return new z(this)}createWaveShaper(){return new B(this)}decodeAudioData(Z,et,G){return C(this._nativeContext,Z).then(X=>(typeof et=="function"&&et(X),X),X=>{throw typeof G=="function"&&G(X),X})}})(Of,Gm,uu,Um,Zm,Km,ef,of,rf,Lf,cf,uf,pf,vf,bf,_f,Tf,Mf,kf,Rf),Ff=((p,t,o,l)=>class extends p{constructor(d,v){const y=o(d),_=((S,C)=>S.createMediaElementSource(C.mediaElement))(y,v);if(l(y))throw TypeError();super(d,!0,_,null),this._nativeMediaElementAudioSourceNode=_}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(ye,0,se,Zt),Bf=((p,t,o,l)=>class extends p{constructor(d,v){const y=o(d);if(l(y))throw new TypeError;const _=((S,C)=>{const E=S.createMediaStreamDestination();return Te(E,C),E.numberOfOutputs===1&&Object.defineProperty(E,"numberOfOutputs",{get:()=>0}),E})(y,{...Pm,...v});super(d,!1,_,null),this._nativeMediaStreamAudioDestinationNode=_}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(ye,0,se,Zt),$f=((p,t,o,l)=>class extends p{constructor(d,v){const y=o(d),_=((S,{mediaStream:C})=>{const E=C.getAudioTracks();E.sort((N,q)=>N.id<q.id?-1:N.id>q.id?1:0);const k=E.slice(0,1),O=S.createMediaStreamSource(new MediaStream(k));return Object.defineProperty(O,"mediaStream",{value:C}),O})(y,v);if(l(y))throw new TypeError;super(d,!0,_,null),this._nativeMediaStreamAudioSourceNode=_}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(ye,0,se,Zt),qf=((p,t)=>(o,{mediaStreamTrack:l})=>{if(typeof o.createMediaStreamTrackSource=="function")return o.createMediaStreamTrackSource(l);const d=new MediaStream([l]),v=o.createMediaStreamSource(d);if(l.kind!=="audio")throw p();if(t(o))throw new TypeError;return v})(Re,Zt),zf=((p,t,o)=>class extends p{constructor(l,d){const v=o(l);super(l,!0,t(v,d),null)}})(ye,qf,se),Wf=((p,t,o,l,d,v,y,_,S)=>class extends p{constructor(C={}){if(S===null)throw new Error("Missing the native AudioContext constructor.");let E;try{E=new S(C)}catch(N){throw N.code===12&&N.message==="sampleRate is not in range"?o():N}if(E===null)throw l();if(!(N=>N===void 0||typeof N=="number"||typeof N=="string"&&(N==="balanced"||N==="interactive"||N==="playback"))(C.latencyHint))throw new TypeError(`The provided value '${C.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(C.sampleRate!==void 0&&E.sampleRate!==C.sampleRate)throw o();super(E,2);const{latencyHint:k}=C,{sampleRate:O}=E;if(this._baseLatency=typeof E.baseLatency=="number"?E.baseLatency:k==="balanced"?512/O:k==="interactive"||k===void 0?256/O:k==="playback"?1024/O:128*Math.max(2,Math.min(128,Math.round(k*O/128)))/O,this._nativeAudioContext=E,S.name==="webkitAudioContext"?(this._nativeGainNode=E.createGain(),this._nativeOscillatorNode=E.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(E.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,E.state==="running"){this._state="suspended";const N=()=>{this._state==="suspended"&&(this._state=null),E.removeEventListener("statechange",N)};E.addEventListener("statechange",N)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw t()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),Ye(this)}))}createMediaElementSource(C){return new d(this,{mediaElement:C})}createMediaStreamDestination(){return new v(this)}createMediaStreamSource(C){return new y(this,{mediaStream:C})}createMediaStreamTrackSource(C){return new _(this,{mediaStreamTrack:C})}resume(){return this._state==="suspended"?new Promise((C,E)=>{const k=()=>{this._nativeAudioContext.removeEventListener("statechange",k),this._nativeAudioContext.state==="running"?C():this.resume().then(C,E)};this._nativeAudioContext.addEventListener("statechange",k)}):this._nativeAudioContext.resume().catch(C=>{throw C===void 0||C.code===15?t():C})}suspend(){return this._nativeAudioContext.suspend().catch(C=>{throw C===void 0?t():C})}})(Su,Re,Qe,Lm,Ff,Bf,$f,zf,Cn),al=(p=>t=>{const o=p.get(t);if(o===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return o})(gu),Vf=(p=>(t,o)=>{p(t).add(o)})(al),Cu=(p=>(t,o,l=0,d=0)=>{const v=t[l];if(v===void 0)throw p();return di(o)?v.connect(o,0,d):v.connect(o,0)})(Ct),Hf=(p=>(t,o)=>{p(t).delete(o)})(al),Tu=(p=>(t,o=void 0,l=void 0,d=0)=>o===void 0?t.forEach(v=>v.disconnect()):typeof o=="number"?Ia(p,t,o).disconnect():di(o)?l===void 0?t.forEach(v=>v.disconnect(o)):d===void 0?Ia(p,t,l).disconnect(o,0):Ia(p,t,l).disconnect(o,0,d):l===void 0?t.forEach(v=>v.disconnect(o)):Ia(p,t,l).disconnect(o,0))(Ct),Au=new WeakMap,Gf=((p,t)=>o=>t(p,o))(Au,nt),jf=((p,t,o,l,d,v,y,_,S,C,E,k,O)=>(N,q,$,L)=>{if(L.numberOfInputs===0&&L.numberOfOutputs===0)throw S();const W=Array.isArray(L.outputChannelCount)?L.outputChannelCount:Array.from(L.outputChannelCount);if(W.some(rt=>rt<1))throw S();if(W.length!==L.numberOfOutputs)throw t();if(L.channelCountMode!=="explicit")throw S();const z=L.channelCount*L.numberOfInputs,B=W.reduce((rt,Ht)=>rt+Ht,0),Z=$.parameterDescriptors===void 0?0:$.parameterDescriptors.length;if(z+Z>6||B>6)throw S();const et=new MessageChannel,G=[],X=[];for(let rt=0;rt<L.numberOfInputs;rt+=1)G.push(y(N,{channelCount:L.channelCount,channelCountMode:L.channelCountMode,channelInterpretation:L.channelInterpretation,gain:1})),X.push(d(N,{channelCount:L.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:L.channelCount}));const V=[];if($.parameterDescriptors!==void 0)for(const{defaultValue:rt,maxValue:Ht,minValue:Ve,name:de}of $.parameterDescriptors){const zt=v(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:L.parameterData[de]!==void 0?L.parameterData[de]:rt===void 0?0:rt});Object.defineProperties(zt.offset,{defaultValue:{get:()=>rt===void 0?0:rt},maxValue:{get:()=>Ht===void 0?Bt:Ht},minValue:{get:()=>Ve===void 0?jt:Ve}}),V.push(zt)}const st=l(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,z+Z)}),U=Uh(q,N.sampleRate),K=_(N,U,z+Z,Math.max(1,B)),lt=d(N,{channelCount:Math.max(1,B),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,B)}),ct=[];for(let rt=0;rt<L.numberOfOutputs;rt+=1)ct.push(l(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:W[rt]}));for(let rt=0;rt<L.numberOfInputs;rt+=1){G[rt].connect(X[rt]);for(let Ht=0;Ht<L.channelCount;Ht+=1)X[rt].connect(st,Ht,rt*L.channelCount+Ht)}const At=new Ea($.parameterDescriptors===void 0?[]:$.parameterDescriptors.map(({name:rt},Ht)=>{const Ve=V[Ht];return Ve.connect(st,0,z+Ht),Ve.start(0),[rt,Ve.offset]}));st.connect(K);let yt=L.channelInterpretation,vt=null;const Pt=L.numberOfOutputs===0?[K]:ct,ft={get bufferSize(){return U},get channelCount(){return L.channelCount},set channelCount(rt){throw o()},get channelCountMode(){return L.channelCountMode},set channelCountMode(rt){throw o()},get channelInterpretation(){return yt},set channelInterpretation(rt){for(const Ht of G)Ht.channelInterpretation=rt;yt=rt},get context(){return K.context},get inputs(){return G},get numberOfInputs(){return L.numberOfInputs},get numberOfOutputs(){return L.numberOfOutputs},get onprocessorerror(){return vt},set onprocessorerror(rt){typeof vt=="function"&&ft.removeEventListener("processorerror",vt),vt=typeof rt=="function"?rt:null,typeof vt=="function"&&ft.addEventListener("processorerror",vt)},get parameters(){return At},get port(){return et.port2},addEventListener:(...rt)=>K.addEventListener(rt[0],rt[1],rt[2]),connect:p.bind(null,Pt),disconnect:C.bind(null,Pt),dispatchEvent:(...rt)=>K.dispatchEvent(rt[0]),removeEventListener:(...rt)=>K.removeEventListener(rt[0],rt[1],rt[2])},kt=new Map;var Lt,Vt;et.port1.addEventListener=(Lt=et.port1.addEventListener,(...rt)=>{if(rt[0]==="message"){const Ht=typeof rt[1]=="function"?rt[1]:typeof rt[1]=="object"&&rt[1]!==null&&typeof rt[1].handleEvent=="function"?rt[1].handleEvent:null;if(Ht!==null){const Ve=kt.get(rt[1]);Ve!==void 0?rt[1]=Ve:(rt[1]=de=>{E(N.currentTime,N.sampleRate,()=>Ht(de))},kt.set(Ht,rt[1]))}}return Lt.call(et.port1,rt[0],rt[1],rt[2])}),et.port1.removeEventListener=(Vt=et.port1.removeEventListener,(...rt)=>{if(rt[0]==="message"){const Ht=kt.get(rt[1]);Ht!==void 0&&(kt.delete(rt[1]),rt[1]=Ht)}return Vt.call(et.port1,rt[0],rt[1],rt[2])});let oe=null;Object.defineProperty(et.port1,"onmessage",{get:()=>oe,set:rt=>{typeof oe=="function"&&et.port1.removeEventListener("message",oe),oe=typeof rt=="function"?rt:null,typeof oe=="function"&&(et.port1.addEventListener("message",oe),et.port1.start())}}),$.prototype.port=et.port1;let ve=null;((rt,Ht,Ve,de)=>{let zt=R.get(rt);zt===void 0&&(zt=new WeakMap,R.set(rt,zt));const ae=(async(rs,Zs)=>{const Qs=await(vc=>new Promise((yc,Xg)=>{const{port1:er,port2:bc}=new MessageChannel;er.onmessage=({data:wc})=>{er.close(),bc.close(),yc(wc)},er.onmessageerror=({data:wc})=>{er.close(),bc.close(),Xg(wc)},bc.postMessage(vc)}))(Zs);return new rs(Qs)})(Ve,de);return zt.set(Ht,ae),ae})(N,ft,$,L).then(rt=>ve=rt);const Ot=ka(L.numberOfInputs,L.channelCount),pt=ka(L.numberOfOutputs,W),te=$.parameterDescriptors===void 0?[]:$.parameterDescriptors.reduce((rt,{name:Ht})=>({...rt,[Ht]:new Float32Array(128)}),{});let Yt=!0;const We=()=>{L.numberOfOutputs>0&&K.disconnect(lt);for(let rt=0,Ht=0;rt<L.numberOfOutputs;rt+=1){const Ve=ct[rt];for(let de=0;de<W[rt];de+=1)lt.disconnect(Ve,Ht+de,de);Ht+=W[rt]}},Nn=new Map;K.onaudioprocess=({inputBuffer:rt,outputBuffer:Ht})=>{if(ve!==null){const Ve=k(ft);for(let de=0;de<U;de+=128){for(let zt=0;zt<L.numberOfInputs;zt+=1)for(let ae=0;ae<L.channelCount;ae+=1)Hn(rt,Ot[zt],ae,ae,de);$.parameterDescriptors!==void 0&&$.parameterDescriptors.forEach(({name:zt},ae)=>{Hn(rt,te,zt,z+ae,de)});for(let zt=0;zt<L.numberOfInputs;zt+=1)for(let ae=0;ae<W[zt];ae+=1)pt[zt][ae].byteLength===0&&(pt[zt][ae]=new Float32Array(128));try{const zt=Ot.map((rs,Zs)=>{if(Ve[Zs].size>0)return Nn.set(Zs,U/128),rs;const Qs=Nn.get(Zs);return Qs===void 0?[]:(rs.every(vc=>vc.every(yc=>yc===0))&&(Qs===1?Nn.delete(Zs):Nn.set(Zs,Qs-1)),rs)});Yt=E(N.currentTime+de/N.sampleRate,N.sampleRate,()=>ve.process(zt,pt,te));for(let rs=0,Zs=0;rs<L.numberOfOutputs;rs+=1){for(let Qs=0;Qs<W[rs];Qs+=1)pi(Ht,pt[rs],Qs,Zs+Qs,de);Zs+=W[rs]}}catch(zt){Yt=!1,ft.dispatchEvent(new ErrorEvent("processorerror",{colno:zt.colno,filename:zt.filename,lineno:zt.lineno,message:zt.message}))}if(!Yt){for(let zt=0;zt<L.numberOfInputs;zt+=1){G[zt].disconnect(X[zt]);for(let ae=0;ae<L.channelCount;ae+=1)X[de].disconnect(st,ae,zt*L.channelCount+ae)}if($.parameterDescriptors!==void 0){const zt=$.parameterDescriptors.length;for(let ae=0;ae<zt;ae+=1){const rs=V[ae];rs.disconnect(st,0,z+ae),rs.stop()}}st.disconnect(K),K.onaudioprocess=null,fc?We():ed();break}}}};let fc=!1;const gc=y(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),td=()=>K.connect(gc).connect(N.destination),ed=()=>{K.disconnect(gc),gc.disconnect()};return td(),O(ft,()=>{if(Yt){ed(),L.numberOfOutputs>0&&K.connect(lt);for(let rt=0,Ht=0;rt<L.numberOfOutputs;rt+=1){const Ve=ct[rt];for(let de=0;de<W[rt];de+=1)lt.connect(Ve,Ht+de,de);Ht+=W[rt]}}fc=!0},()=>{Yt&&(td(),We()),fc=!1})})(Cu,Ct,Re,An,mo,yi,is,fo,Qe,Tu,ol,Gf,Tn),Uf=((p,t,o,l,d)=>(v,y,_,S,C,E)=>{if(_!==null)try{const N=new _(v,S,E),q=new Map;let $=null;if(Object.defineProperties(N,{channelCount:{get:()=>E.channelCount,set:()=>{throw p()}},channelCountMode:{get:()=>"explicit",set:()=>{throw p()}},onprocessorerror:{get:()=>$,set:L=>{typeof $=="function"&&N.removeEventListener("processorerror",$),$=typeof L=="function"?L:null,typeof $=="function"&&N.addEventListener("processorerror",$)}}}),N.addEventListener=(O=N.addEventListener,(...L)=>{if(L[0]==="processorerror"){const W=typeof L[1]=="function"?L[1]:typeof L[1]=="object"&&L[1]!==null&&typeof L[1].handleEvent=="function"?L[1].handleEvent:null;if(W!==null){const z=q.get(L[1]);z!==void 0?L[1]=z:(L[1]=B=>{B.type==="error"?(Object.defineProperties(B,{type:{value:"processorerror"}}),W(B)):W(new ErrorEvent(L[0],{...B}))},q.set(W,L[1]))}}return O.call(N,"error",L[1],L[2]),O.call(N,...L)}),N.removeEventListener=(k=N.removeEventListener,(...L)=>{if(L[0]==="processorerror"){const W=q.get(L[1]);W!==void 0&&(q.delete(L[1]),L[1]=W)}return k.call(N,"error",L[1],L[2]),k.call(N,L[0],L[1],L[2])}),E.numberOfOutputs!==0){const L=o(v,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return N.connect(L).connect(v.destination),d(N,()=>L.disconnect(),()=>L.connect(v.destination))}return N}catch(N){throw N.code===11?l():N}var k,O;if(C===void 0)throw l();return(N=>{const{port1:q}=new MessageChannel;try{q.postMessage(N)}finally{q.close()}})(E),t(v,y,C,E)})(Re,jf,is,Qe,Tn),Xf=((p,t,o,l,d,v,y,_,S,C,E,k,O,N,q,$)=>(L,W,z)=>{const B=new WeakMap;let Z=null;return{render(et,G){_(G,et);const X=B.get(G);return X!==void 0?Promise.resolve(X):(async(V,st)=>{let U=E(V),K=null;const lt=ht(U,st),ct=Array.isArray(W.outputChannelCount)?W.outputChannelCount:Array.from(W.outputChannelCount);if(k===null){const At=ct.reduce((ft,kt)=>ft+kt,0),yt=d(st,{channelCount:Math.max(1,At),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,At)}),vt=[];for(let ft=0;ft<V.numberOfOutputs;ft+=1)vt.push(l(st,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:ct[ft]}));const Pt=y(st,{channelCount:W.channelCount,channelCountMode:W.channelCountMode,channelInterpretation:W.channelInterpretation,gain:1});Pt.connect=t.bind(null,vt),Pt.disconnect=S.bind(null,vt),K=[yt,vt,Pt]}else lt||(U=new k(st,L));if(B.set(st,K===null?U:K[2]),K!==null){if(Z===null){if(z===void 0)throw new Error("Missing the processor constructor.");if(O===null)throw new Error("Missing the native OfflineAudioContext constructor.");const kt=V.channelCount*V.numberOfInputs,Lt=z.parameterDescriptors===void 0?0:z.parameterDescriptors.length,Vt=kt+Lt;Z=bm(V,Vt===0?null:await(async()=>{const ve=new O(Vt,128*Math.ceil(V.context.length/128),st.sampleRate),as=[],Ot=[];for(let Yt=0;Yt<W.numberOfInputs;Yt+=1)as.push(y(ve,{channelCount:W.channelCount,channelCountMode:W.channelCountMode,channelInterpretation:W.channelInterpretation,gain:1})),Ot.push(d(ve,{channelCount:W.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:W.channelCount}));const pt=await Promise.all(Array.from(V.parameters.values()).map(async Yt=>{const We=v(ve,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Yt.value});return await N(ve,Yt,We.offset),We})),te=l(ve,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,kt+Lt)});for(let Yt=0;Yt<W.numberOfInputs;Yt+=1){as[Yt].connect(Ot[Yt]);for(let We=0;We<W.channelCount;We+=1)Ot[Yt].connect(te,We,Yt*W.channelCount+We)}for(const[Yt,We]of pt.entries())We.connect(te,0,kt+Yt),We.start(0);return te.connect(ve.destination),await Promise.all(as.map(Yt=>q(V,ve,Yt))),$(ve)})(),st,W,ct,z,C)}const At=await Z,yt=o(st,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[vt,Pt,ft]=K;At!==null&&(yt.buffer=At,yt.start(0)),yt.connect(vt);for(let kt=0,Lt=0;kt<V.numberOfOutputs;kt+=1){const Vt=Pt[kt];for(let oe=0;oe<ct[kt];oe+=1)vt.connect(Vt,Lt+oe,oe);Lt+=ct[kt]}return ft}if(lt)for(const[At,yt]of V.parameters.entries())await p(st,yt,U.parameters.get(At));else for(const[At,yt]of V.parameters.entries())await N(st,yt,U.parameters.get(At));return await q(V,st,U),U})(et,G)}}})(js,Cu,vi,An,mo,yi,is,Hf,Tu,ol,Jt,gi,De,Us,Le,Na),Yf=(p=>t=>p.get(t))(xu),Zf=(p=>(t,o)=>{p.set(t,o)})(Au),Mu=_u?((p,t,o,l,d,v,y,_,S,C,E,k,O,N)=>class extends t{constructor(q,$,L){var W;const z=_(q),B=S(z),Z=(K=>({...K,outputChannelCount:K.outputChannelCount!==void 0?K.outputChannelCount:K.numberOfInputs===1&&K.numberOfOutputs===1?[K.channelCount]:Array.from({length:K.numberOfOutputs},()=>1)}))({...Pa,...L});(K=>{const{port1:lt,port2:ct}=new MessageChannel;try{lt.postMessage(K)}finally{lt.close(),ct.close()}})(Z);const et=D.get(z),G=et==null?void 0:et.get($),X=B||z.state!=="closed"?z:(W=y(z))!==null&&W!==void 0?W:z,V=d(X,B?null:q.baseLatency,C,$,G,Z);super(q,!0,V,B?l($,Z,G):null);const st=[];V.parameters.forEach((K,lt)=>{const ct=o(this,B,K);st.push([lt,ct])}),this._nativeAudioWorkletNode=V,this._onprocessorerror=null,this._parameters=new Ea(st),B&&p(z,this);const{activeInputs:U}=v(this);k(V,U)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(q){const $=typeof q=="function"?N(this,q):null;this._nativeAudioWorkletNode.onprocessorerror=$;const L=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=L!==null&&L===$?q:L}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(Vf,ye,Os,Xf,Uf,$t,Yf,se,Zt,gi,0,Zf,0,fi):void 0,Qf=((p,t)=>(o,l,d)=>{if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(o,l,d)}catch(v){throw v.name==="SyntaxError"?p():v}})(Qe,De),Jf=((p,t,o,l,d,v,y,_)=>(S,C)=>o(S).render(S,C).then(()=>Promise.all(Array.from(l(C)).map(E=>o(E).render(E,C)))).then(()=>d(C)).then(E=>(typeof E.copyFromChannel!="function"?(y(E),dt(E)):t(v,()=>v(E))||_(E),p.add(E),E)))(el,Ss,Jr,al,Na,ut,nl,il),Kf=((p,t,o,l,d)=>class extends p{constructor(v,y,_){let S;if(typeof v=="number"&&y!==void 0&&_!==void 0)S={length:y,numberOfChannels:v,sampleRate:_};else{if(typeof v!="object")throw new Error("The given parameters are not valid.");S=v}const{length:C,numberOfChannels:E,sampleRate:k}={...Im,...S},O=l(E,C,k);t(po,()=>po(O))||O.addEventListener("statechange",(()=>{let N=0;const q=$=>{this._state==="running"&&(N>0?(O.removeEventListener("statechange",q),$.stopImmediatePropagation(),this._waitForThePromiseToSettle($)):N+=1)};return q})()),super(O,E),this._length=C,this._nativeOfflineAudioContext=O,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(o()):(this._state="running",d(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,Ye(this)}))}_waitForThePromiseToSettle(v){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(v):setTimeout(()=>this._waitForThePromiseToSettle(v))}})(Su,Ss,Re,Qf,Jf),tg=((p,t)=>o=>{const l=p.get(o);return t(l)||t(o)})(P,Kr),eg=((p,t)=>o=>p.has(o)||t(o))(w,tl),sg=((p,t)=>o=>p.has(o)||t(o))(A,ru),ng=((p,t)=>o=>{const l=p.get(o);return t(l)||t(o)})(P,Zt),ig=()=>(async(p,t,o,l,d,v,y,_,S,C,E,k,O,N,q,$)=>!!(p(t,t)&&p(o,o)&&p(d,d)&&p(v,v)&&p(_,_)&&p(S,S)&&p(C,C)&&p(E,E)&&p(k,k)&&p(O,O)&&p(N,N))&&(await Promise.all([p(l,l),p(y,y),p(q,q),p($,$)])).every(L=>L))(Ss,(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createBuffer(1,1,44100);if(t.copyToChannel===void 0)return!0;const o=new Float32Array(2);try{t.copyFromChannel(o,0,0)}catch{return!1}return!0})(De),(p=>()=>{if(p===null)return!1;if(p.prototype!==void 0&&p.prototype.close!==void 0)return!0;const t=new p,o=t.close!==void 0;try{t.close()}catch{}return o})(Cn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);return new Promise(o=>{let l=!0;const d=y=>{l&&(l=!1,t.startRendering(),o(y instanceof TypeError))};let v;try{v=t.decodeAudioData(null,()=>{},d)}catch(y){d(y)}v!==void 0&&v.catch(d)})})(De),(p=>()=>{if(p===null)return!1;let t;try{t=new p({latencyHint:"balanced"})}catch{return!1}return t.close(),!0})(Cn),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createGain(),o=t.connect(t)===t;return t.disconnect(t),o})(De),((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const o=new Blob(['let c,p;class A extends AudioWorkletProcessor{constructor(){super();this.port.onmessage=(e)=>{p=e.data;p.onmessage=()=>{p.postMessage(c);p.close()};this.port.postMessage(0)}}process(){c=1}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new MessageChannel,d=new t(1,128,44100),v=URL.createObjectURL(o);let y=!1;try{await d.audioWorklet.addModule(v);const _=new p(d,"a",{numberOfOutputs:0}),S=d.createOscillator();await new Promise(C=>{_.port.onmessage=()=>C(),_.port.postMessage(l.port2,[l.port2])}),_.port.onmessage=()=>y=!0,S.connect(_),S.start(0),await d.startRendering(),y=await new Promise(C=>{l.port1.onmessage=({data:E})=>C(E===1),l.port1.postMessage(0)})}catch{}finally{l.port1.close(),URL.revokeObjectURL(v)}return y})(gi,De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createChannelMerger();if(t.channelCountMode==="max")return!0;try{t.channelCount=2}catch{return!0}return!1})(De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100);return t.createConstantSource===void 0||t.createConstantSource().offset.maxValue!==Number.POSITIVE_INFINITY})(De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100),o=t.createConvolver();o.buffer=t.createBuffer(1,1,t.sampleRate);try{o.buffer=t.createBuffer(1,1,t.sampleRate)}catch{return!1}return!0})(De),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createConvolver();try{t.channelCount=1}catch{return!1}return!0})(De),Bm,(p=>()=>p!==null&&p.hasOwnProperty("isSecureContext"))(Ds),(p=>()=>{if(p===null)return!1;const t=new p;try{return t.createMediaStreamSource(new MediaStream),!1}catch{return!0}finally{t.close()}})(Cn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);if(t.createStereoPanner===void 0||t.createConstantSource===void 0)return Promise.resolve(!0);const o=t.createConstantSource(),l=t.createStereoPanner();return o.channelCount=1,o.offset.value=1,l.channelCount=1,o.start(),o.connect(l).connect(t.destination),t.startRendering().then(d=>d.getChannelData(0)[0]!==1)})(De),$m);function os(p){return p===void 0}function It(p){return p!==void 0}function Eu(p){return typeof p=="function"}function hs(p){return typeof p=="number"}function cn(p){return Object.prototype.toString.call(p)==="[object Object]"&&p.constructor===Object}function rl(p){return typeof p=="boolean"}function Fe(p){return Array.isArray(p)}function Ns(p){return typeof p=="string"}function yo(p){return Ns(p)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(p)}function wt(p,t){if(!p)throw new Error(t)}function Be(p,t,o=1/0){if(!(t<=p&&p<=o))throw new RangeError(`Value must be within [${t}, ${o}], got: ${p}`)}function ll(p){p.isOffline||p.state==="running"||bi('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Pu=!1,ku=!1;function cl(p){Pu=p}function Iu(p){os(p)&&Pu&&!ku&&(ku=!0,bi("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let hl=console;function og(p){hl=p}function Ru(...p){hl.log(...p)}function bi(...p){hl.warn(...p)}const us=typeof self=="object"?self:null,ag=us&&(us.hasOwnProperty("AudioContext")||us.hasOwnProperty("webkitAudioContext"));function Ls(p,t,o,l){var d,v=arguments.length,y=v<3?t:l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")y=Reflect.decorate(p,t,o,l);else for(var _=p.length-1;_>=0;_--)(d=p[_])&&(y=(v<3?d(y):v>3?d(t,o,y):d(t,o))||y);return v>3&&y&&Object.defineProperty(t,o,y),y}function Kt(p,t,o,l){return new(o||(o=Promise))(function(d,v){function y(C){try{S(l.next(C))}catch(E){v(E)}}function _(C){try{S(l.throw(C))}catch(E){v(E)}}function S(C){var E;C.done?d(C.value):(E=C.value,E instanceof o?E:new o(function(k){k(E)})).then(y,_)}S((l=l.apply(p,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;class rg{constructor(t,o,l,d){this._callback=t,this._type=o,this._minimumUpdateInterval=Math.max(128/(d||44100),.001),this.updateInterval=l,this._createClock()}_createWorker(){const t=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),o=URL.createObjectURL(t),l=new Worker(o);l.onmessage=this._callback.bind(this),this._worker=l}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},1e3*this._updateInterval)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(t){var o;this._updateInterval=Math.max(t,this._minimumUpdateInterval),this._type==="worker"&&((o=this._worker)===null||o===void 0||o.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(t){this._disposeClock(),this._type=t,this._createClock()}dispose(){this._disposeClock()}}function jn(p){return sg(p)}function Mn(p){return eg(p)}function Fa(p){return ng(p)}function wi(p){return tg(p)}function lg(p,t){return p==="value"||jn(t)||Mn(t)||function(o){return o instanceof uu}(t)}function Cs(p,...t){if(!t.length)return p;const o=t.shift();if(cn(p)&&cn(o))for(const l in o)lg(l,o[l])?p[l]=o[l]:cn(o[l])?(p[l]||Object.assign(p,{[l]:{}}),Cs(p[l],o[l])):Object.assign(p,{[l]:o[l]});return Cs(p,...t)}function J(p,t,o=[],l){const d={},v=Array.from(t);if(cn(v[0])&&l&&!Reflect.has(v[0],l)&&(Object.keys(v[0]).some(y=>Reflect.has(p,y))||(Cs(d,{[l]:v[0]}),o.splice(o.indexOf(l),1),v.shift())),v.length===1&&cn(v[0]))Cs(d,v[0]);else for(let y=0;y<o.length;y++)It(v[y])&&(d[o[y]]=v[y]);return Cs(p,d)}function Ts(p,t){return os(p)?t:p}function $e(p,t){return t.forEach(o=>{Reflect.has(p,o)&&delete p[o]}),p}class hn{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...t){(this.debug||us&&this.toString()===us.TONE_DEBUG_CLASS)&&Ru(this,...t)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}hn.version=m;const ul=1e-6;function _i(p,t){return p>t+ul}function dl(p,t){return _i(p,t)||Fs(p,t)}function Ba(p,t){return p+ul<t}function Fs(p,t){return Math.abs(p-t)<ul}function Un(p,t,o){return Math.max(Math.min(p,o),t)}class ds extends hn{constructor(){super(),this.name="Timeline",this._timeline=[];const t=J(ds.getDefaults(),arguments,["memory"]);this.memory=t.memory,this.increasing=t.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(t){if(wt(Reflect.has(t,"time"),"Timeline: events must have a time attribute"),t.time=t.time.valueOf(),this.increasing&&this.length){const o=this._timeline[this.length-1];wt(dl(t.time,o.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(t)}else{const o=this._search(t.time);this._timeline.splice(o+1,0,t)}if(this.length>this.memory){const o=this.length-this.memory;this._timeline.splice(0,o)}return this}remove(t){const o=this._timeline.indexOf(t);return o!==-1&&this._timeline.splice(o,1),this}get(t,o="time"){const l=this._search(t,o);return l!==-1?this._timeline[l]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(t,o="time"){const l=this._search(t,o);return l+1<this._timeline.length?this._timeline[l+1]:null}getBefore(t){const o=this._timeline.length;if(o>0&&this._timeline[o-1].time<t)return this._timeline[o-1];const l=this._search(t);return l-1>=0?this._timeline[l-1]:null}cancel(t){if(this._timeline.length>1){let o=this._search(t);if(o>=0)if(Fs(this._timeline[o].time,t)){for(let l=o;l>=0&&Fs(this._timeline[l].time,t);l--)o=l;this._timeline=this._timeline.slice(0,o)}else this._timeline=this._timeline.slice(0,o+1);else this._timeline=[]}else this._timeline.length===1&&dl(this._timeline[0].time,t)&&(this._timeline=[]);return this}cancelBefore(t){const o=this._search(t);return o>=0&&(this._timeline=this._timeline.slice(o+1)),this}previousEvent(t){const o=this._timeline.indexOf(t);return o>0?this._timeline[o-1]:null}_search(t,o="time"){if(this._timeline.length===0)return-1;let l=0;const d=this._timeline.length;let v=d;if(d>0&&this._timeline[d-1][o]<=t)return d-1;for(;l<v;){let y=Math.floor(l+(v-l)/2);const _=this._timeline[y],S=this._timeline[y+1];if(Fs(_[o],t)){for(let C=y;C<this._timeline.length&&Fs(this._timeline[C][o],t);C++)y=C;return y}if(Ba(_[o],t)&&_i(S[o],t))return y;_i(_[o],t)?v=y:l=y+1}return-1}_iterate(t,o=0,l=this._timeline.length-1){this._timeline.slice(o,l+1).forEach(t)}forEach(t){return this._iterate(t),this}forEachBefore(t,o){const l=this._search(t);return l!==-1&&this._iterate(o,0,l),this}forEachAfter(t,o){const l=this._search(t);return this._iterate(o,l+1),this}forEachBetween(t,o,l){let d=this._search(t),v=this._search(o);return d!==-1&&v!==-1?(this._timeline[d].time!==t&&(d+=1),this._timeline[v].time===o&&(v-=1),this._iterate(l,d,v)):d===-1&&this._iterate(l,0,v),this}forEachFrom(t,o){let l=this._search(t);for(;l>=0&&this._timeline[l].time>=t;)l--;return this._iterate(o,l+1),this}forEachAtTime(t,o){const l=this._search(t);if(l!==-1&&Fs(this._timeline[l].time,t)){let d=l;for(let v=l;v>=0&&Fs(this._timeline[v].time,t);v--)d=v;this._iterate(v=>{o(v)},d,l)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Du=[];function $a(p){Du.push(p)}const Ou=[];function qa(p){Ou.push(p)}class xi extends hn{constructor(){super(...arguments),this.name="Emitter"}on(t,o){return t.split(/\W+/).forEach(l=>{os(this._events)&&(this._events={}),this._events.hasOwnProperty(l)||(this._events[l]=[]),this._events[l].push(o)}),this}once(t,o){const l=(...d)=>{o(...d),this.off(t,l)};return this.on(t,l),this}off(t,o){return t.split(/\W+/).forEach(l=>{if(os(this._events)&&(this._events={}),this._events.hasOwnProperty(l))if(os(o))this._events[l]=[];else{const d=this._events[l];for(let v=d.length-1;v>=0;v--)d[v]===o&&d.splice(v,1)}}),this}emit(t,...o){if(this._events&&this._events.hasOwnProperty(t)){const l=this._events[t].slice(0);for(let d=0,v=l.length;d<v;d++)l[d].apply(this,o)}return this}static mixin(t){["on","once","off","emit"].forEach(o=>{const l=Object.getOwnPropertyDescriptor(xi.prototype,o);Object.defineProperty(t.prototype,o,l)})}dispose(){return super.dispose(),this._events=void 0,this}}class pl extends xi{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class Si extends pl{constructor(){var t,o;super(),this.name="Context",this._constants=new Map,this._timeouts=new ds,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const l=J(Si.getDefaults(),arguments,["context"]);l.context?(this._context=l.context,this._latencyHint=((t=arguments[0])===null||t===void 0?void 0:t.latencyHint)||""):(this._context=function(d){return new Wf(d)}({latencyHint:l.latencyHint}),this._latencyHint=l.latencyHint),this._ticker=new rg(this.emit.bind(this,"tick"),l.clockSource,l.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((o=arguments[0])===null||o===void 0)&&o.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=l.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var t;return this._initialized||(t=this,Du.forEach(o=>o(t)),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(t,o,l){return this._context.createBuffer(t,o,l)}createChannelMerger(t){return this._context.createChannelMerger(t)}createChannelSplitter(t){return this._context.createChannelSplitter(t)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(t){return this._context.createDelay(t)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(t,o){return this._context.createIIRFilter(t,o)}createPanner(){return this._context.createPanner()}createPeriodicWave(t,o,l){return this._context.createPeriodicWave(t,o,l)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(t){return wt(wi(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(t)}createMediaElementSource(t){return wt(wi(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(t)}createMediaStreamDestination(){return wt(wi(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(t){return this._context.decodeAudioData(t)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(t){wt(!this._initialized,"The listener cannot be set after initialization."),this._listener=t}get transport(){return this.initialize(),this._transport}set transport(t){wt(!this._initialized,"The transport cannot be set after initialization."),this._transport=t}get draw(){return this.initialize(),this._draw}set draw(t){wt(!this._initialized,"Draw cannot be set after initialization."),this._draw=t}get destination(){return this.initialize(),this._destination}set destination(t){wt(!this._initialized,"The destination cannot be set after initialization."),this._destination=t}createAudioWorkletNode(t,o){return function(l,d,v){return wt(It(Mu),"AudioWorkletNode only works in a secure context (https or localhost)"),new(l instanceof(us==null?void 0:us.BaseAudioContext)?us==null?void 0:us.AudioWorkletNode:Mu)(l,d,v)}(this.rawContext,t,o)}addAudioWorkletModule(t){return Kt(this,void 0,void 0,function*(){wt(It(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(t)),yield this._workletPromise})}workletsAreReady(){return Kt(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(t){this._ticker.updateInterval=t}get clockSource(){return this._ticker.type}set clockSource(t){this._ticker.type=t}get lookAhead(){return this._lookAhead}set lookAhead(t){this._lookAhead=t,this.updateInterval=t?t/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return wi(this._context)?this._context.resume():Promise.resolve()}close(){return Kt(this,void 0,void 0,function*(){var t;wi(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(t=this,Ou.forEach(o=>o(t)))})}getConstant(t){if(this._constants.has(t))return this._constants.get(t);{const o=this._context.createBuffer(1,128,this._context.sampleRate),l=o.getChannelData(0);for(let v=0;v<l.length;v++)l[v]=t;const d=this._context.createBufferSource();return d.channelCount=1,d.channelCountMode="explicit",d.buffer=o,d.loop=!0,d.start(0),this._constants.set(t,d),d}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(t=>this._constants[t].disconnect()),this.close(),this}_timeoutLoop(){const t=this.now();let o=this._timeouts.peek();for(;this._timeouts.length&&o&&o.time<=t;)o.callback(),this._timeouts.shift(),o=this._timeouts.peek()}setTimeout(t,o){this._timeoutIds++;const l=this.now();return this._timeouts.add({callback:t,id:this._timeoutIds,time:l+o}),this._timeoutIds}clearTimeout(t){return this._timeouts.forEach(o=>{o.id===t&&this._timeouts.remove(o)}),this}clearInterval(t){return this.clearTimeout(t)}setInterval(t,o){const l=++this._timeoutIds,d=()=>{const v=this.now();this._timeouts.add({callback:()=>{t(),d()},id:l,time:v+o})};return d(),l}}function St(p,t){Fe(t)?t.forEach(o=>St(p,o)):Object.defineProperty(p,t,{enumerable:!0,writable:!1})}function bo(p,t){Fe(t)?t.forEach(o=>bo(p,o)):Object.defineProperty(p,t,{writable:!0})}const Dt=()=>{};class qt extends hn{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Dt;const t=J(qt.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=t.reverse,this.onload=t.onload,Ns(t.url)?this.load(t.url).catch(t.onerror):t.url&&this.set(t.url)}static getDefaults(){return{onerror:Dt,onload:Dt,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:ie().sampleRate}set(t){return t instanceof qt?t.loaded?this._buffer=t.get():t.onload=()=>{this.set(t),this.onload(this)}:this._buffer=t,this._reversed&&this._reverse(),this}get(){return this._buffer}load(t){return Kt(this,void 0,void 0,function*(){const o=qt.load(t).then(l=>{this.set(l),this.onload(this)});qt.downloads.push(o);try{yield o}finally{const l=qt.downloads.indexOf(o);qt.downloads.splice(l,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(t){const o=Fe(t)&&t[0].length>0,l=o?t.length:1,d=o?t[0].length:t.length,v=ie(),y=v.createBuffer(l,d,v.sampleRate),_=o||l!==1?t:[t];for(let S=0;S<l;S++)y.copyToChannel(_[S],S);return this._buffer=y,this}toMono(t){if(hs(t))this.fromArray(this.toArray(t));else{let o=new Float32Array(this.length);const l=this.numberOfChannels;for(let d=0;d<l;d++){const v=this.toArray(d);for(let y=0;y<v.length;y++)o[y]+=v[y]}o=o.map(d=>d/l),this.fromArray(o)}return this}toArray(t){if(hs(t))return this.getChannelData(t);if(this.numberOfChannels===1)return this.toArray(0);{const o=[];for(let l=0;l<this.numberOfChannels;l++)o[l]=this.getChannelData(l);return o}}getChannelData(t){return this._buffer?this._buffer.getChannelData(t):new Float32Array(0)}slice(t,o=this.duration){wt(this.loaded,"Buffer is not loaded");const l=Math.floor(t*this.sampleRate),d=Math.floor(o*this.sampleRate);wt(l<d,"The start time must be less than the end time");const v=d-l,y=ie().createBuffer(this.numberOfChannels,v,this.sampleRate);for(let _=0;_<this.numberOfChannels;_++)y.copyToChannel(this.getChannelData(_).subarray(l,d),_);return new qt(y)}_reverse(){if(this.loaded)for(let t=0;t<this.numberOfChannels;t++)this.getChannelData(t).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(t){this._reversed!==t&&(this._reversed=t,this._reverse())}static fromArray(t){return new qt().fromArray(t)}static fromUrl(t){return Kt(this,void 0,void 0,function*(){return yield new qt().load(t)})}static load(t){return Kt(this,void 0,void 0,function*(){const o=t.match(/\[([^\]\[]+\|.+)\]$/);if(o){const _=o[1].split("|");let S=_[0];for(const C of _)if(qt.supportsType(C)){S=C;break}t=t.replace(o[0],S)}const l=qt.baseUrl===""||qt.baseUrl.endsWith("/")?qt.baseUrl:qt.baseUrl+"/",d=document.createElement("a");d.href=l+t,d.pathname=(d.pathname+d.hash).split("/").map(encodeURIComponent).join("/");const v=yield fetch(d.href);if(!v.ok)throw new Error(`could not load url: ${t}`);const y=yield v.arrayBuffer();return yield ie().decodeAudioData(y)})}static supportsType(t){const o=t.split("."),l=o[o.length-1];return document.createElement("audio").canPlayType("audio/"+l)!==""}static loaded(){return Kt(this,void 0,void 0,function*(){for(yield Promise.resolve();qt.downloads.length;)yield qt.downloads[0]})}}qt.baseUrl="",qt.downloads=[];class Ci extends Si{constructor(){var t,o,l;super({clockSource:"offline",context:Fa(arguments[0])?arguments[0]:(t=arguments[0],o=arguments[1]*arguments[2],l=arguments[2],new Kf(t,o,l)),lookAhead:0,updateInterval:Fa(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Fa(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(t){return Kt(this,void 0,void 0,function*(){let o=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,o++;const l=Math.floor(this.sampleRate/128);t&&o%l==0&&(yield new Promise(d=>setTimeout(d,1)))}})}render(){return Kt(this,arguments,void 0,function*(t=!0){yield this.workletsAreReady(),yield this._renderClock(t);const o=yield this._context.startRendering();return new qt(o)})}close(){return Promise.resolve()}}const Nu=new class extends pl{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(p,t,o){return{}}createChannelMerger(p){return{}}createChannelSplitter(p){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(p){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(p,t){return{}}createPanner(){return{}}createPeriodicWave(p,t,o){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(p){return{}}createMediaElementSource(p){return{}}createMediaStreamDestination(){return{}}decodeAudioData(p){return Promise.resolve({})}createAudioWorkletNode(p,t){return{}}get rawContext(){return{}}addAudioWorkletModule(p){return Kt(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(p,t){return 0}clearTimeout(p){return this}setInterval(p,t){return 0}clearInterval(p){return this}getConstant(p){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(p){}get destination(){return{}}set destination(p){}now(){return 0}immediate(){return 0}};let wo=Nu;function ie(){return wo===Nu&&ag&&za(new Si),wo}function za(p,t=!1){t&&wo.dispose(),wo=wi(p)?new Si(p):Fa(p)?new Ci(p):p}function cg(){return wo.resume()}if(us&&!us.TONE_SILENCE_LOGGING){const t=` * Tone.js v${m} * `;console.log(`%c${t}`,"background: #000; color: #fff")}function Ti(p){return Math.pow(10,p/20)}function _o(p){return Math.log(p)/Math.LN10*20}function Ai(p){return Math.pow(2,p/12)}let Wa=440;function En(p){return Math.round(Lu(p))}function Lu(p){return 69+12*Math.log2(p/Wa)}function ml(p){return Wa*Math.pow(2,(p-69)/12)}class fl extends hn{constructor(t,o,l){super(),this.defaultUnits="s",this._val=o,this._units=l,this.context=t,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:t=>this._frequencyToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:t=>this._ticksToUnits(parseInt(t,10)),regexp:/^(\d+)i$/i},m:{method:t=>this._beatsToUnits(parseInt(t,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(t,o)=>{const l=parseInt(t,10),d=o==="."?1.5:1;return l===1?this._beatsToUnits(this._getTimeSignature())*d:this._beatsToUnits(4/l)*d},regexp:/^(\d+)n(\.?)$/i},number:{method:t=>this._expressions[this.defaultUnits].method.call(this,t),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:t=>this._secondsToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:t=>parseInt(t,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:t=>{const o=parseInt(t,10);return this._beatsToUnits(8/(3*Math.floor(o)))},regexp:/^(\d+)t$/i},tr:{method:(t,o,l)=>{let d=0;return t&&t!=="0"&&(d+=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),o&&o!=="0"&&(d+=this._beatsToUnits(parseFloat(o))),l&&l!=="0"&&(d+=this._beatsToUnits(parseFloat(l)/4)),d},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof fl&&this.fromType(this._val),os(this._val))return this._noArg();if(Ns(this._val)&&os(this._units)){for(const t in this._expressions)if(this._expressions[t].regexp.test(this._val.trim())){this._units=t;break}}else if(cn(this._val)){let t=0;for(const o in this._val)if(It(this._val[o])){const l=this._val[o];t+=new this.constructor(this.context,o).valueOf()*l}return t}if(It(this._units)){const t=this._expressions[this._units],o=this._val.toString().trim().match(t.regexp);return o?t.method.apply(this,o.slice(1)):t.method.call(this,this._val)}return Ns(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(t){return 1/t}_beatsToUnits(t){return 60/this._getBpm()*t}_secondsToUnits(t){return t}_ticksToUnits(t){return t*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(t){switch(this._units=void 0,this.defaultUnits){case"s":this._val=t.toSeconds();break;case"i":this._val=t.toTicks();break;case"hz":this._val=t.toFrequency();break;case"midi":this._val=t.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class ps extends fl{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:t=>this._now()+new this.constructor(this.context,t).valueOf(),regexp:/^\+(.+)/},quantize:{method:t=>{const o=new ps(this.context,t).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(o))},regexp:/^@(.+)/}})}quantize(t,o=1){const l=new this.constructor(this.context,t).valueOf(),d=this.valueOf();return d+(Math.round(d/l)*l-d)*o}toNotation(){const t=this.toSeconds(),o=["1m"];for(let v=1;v<9;v++){const y=Math.pow(2,v);o.push(y+"n."),o.push(y+"n"),o.push(y+"t")}o.push("0");let l=o[0],d=new ps(this.context,o[0]).toSeconds();return o.forEach(v=>{const y=new ps(this.context,v).toSeconds();Math.abs(y-t)<Math.abs(d-t)&&(l=v,d=y)}),l}toBarsBeatsSixteenths(){const t=this._beatsToUnits(1);let o=this.valueOf()/t;o=parseFloat(o.toFixed(4));const l=Math.floor(o/this._getTimeSignature());let d=o%1*4;o=Math.floor(o)%this._getTimeSignature();const v=d.toString();return v.length>3&&(d=parseFloat(parseFloat(v).toFixed(3))),[l,o,d].join(":")}toTicks(){const t=this._beatsToUnits(1);return this.valueOf()/t*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return En(this.toFrequency())}_now(){return this.context.now()}}function hg(p,t){return new ps(ie(),p,t)}class Je extends ps{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Wa}static set A4(t){(function(o){Wa=o})(t)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(t){return this.defaultUnits==="midi"?t:Je.mtof(t)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(t,o){const l=ug[t.toLowerCase()]+12*(parseInt(o,10)+1);return this.defaultUnits==="midi"?l:Je.mtof(l)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(t,o,l){let d=1;return t&&t!=="0"&&(d*=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),o&&o!=="0"&&(d*=this._beatsToUnits(parseFloat(o))),l&&l!=="0"&&(d*=this._beatsToUnits(parseFloat(l)/4)),d}}})}transpose(t){return new Je(this.context,this.valueOf()*Ai(t))}harmonize(t){return t.map(o=>this.transpose(o))}toMidi(){return En(this.valueOf())}toNote(){const t=this.toFrequency(),o=Math.log2(t/Je.A4);let l=Math.round(12*o)+57;const d=Math.floor(l/12);return d<0&&(l+=-12*d),dg[l%12]+d.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const t=this._beatsToUnits(1),o=this.valueOf()/t;return Math.floor(o*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(t){return t}_ticksToUnits(t){return 1/(60*t/(this._getBpm()*this._getPPQ()))}_beatsToUnits(t){return 1/super._beatsToUnits(t)}_secondsToUnits(t){return 1/t}static mtof(t){return ml(t)}static ftom(t){return En(t)}}const ug={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},dg=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function pg(p,t){return new Je(ie(),p,t)}class xe extends ps{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}function mg(p,t){return new xe(ie(),p,t)}class Oe extends hn{constructor(){super();const t=J(Oe.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=t.context}static getDefaults(){return{context:ie()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(t){return Iu(t),new ps(this.context,t).toSeconds()}toFrequency(t){return new Je(this.context,t).toFrequency()}toTicks(t){return new xe(this.context,t).toTicks()}_getPartialProperties(t){const o=this.get();return Object.keys(o).forEach(l=>{os(t[l])&&delete o[l]}),o}get(){const t=this.constructor.getDefaults();return Object.keys(t).forEach(o=>{if(Reflect.has(this,o)){const l=this[o];It(l)&&It(l.value)&&It(l.setValueAtTime)?t[o]=l.value:l instanceof Oe?t[o]=l._getPartialProperties(t[o]):Fe(l)||hs(l)||Ns(l)||rl(l)?t[o]=l:delete t[o]}}),t}set(t){return Object.keys(t).forEach(o=>{Reflect.has(this,o)&&It(this[o])&&(this[o]&&It(this[o].value)&&It(this[o].setValueAtTime)?this[o].value!==t[o]&&(this[o].value=t[o]):this[o]instanceof Oe?this[o].set(t[o]):this[o]=t[o])}),this}}class Mi extends ds{constructor(t="stopped"){super(),this.name="StateTimeline",this._initial=t,this.setStateAtTime(this._initial,0)}getValueAtTime(t){const o=this.get(t);return o!==null?o.state:this._initial}setStateAtTime(t,o,l){return Be(o,0),this.add(Object.assign({},l,{state:t,time:o})),this}getLastState(t,o){for(let l=this._search(o);l>=0;l--){const d=this._timeline[l];if(d.state===t)return d}}getNextState(t,o){const l=this._search(o);if(l!==-1)for(let d=l;d<this._timeline.length;d++){const v=this._timeline[d];if(v.state===t)return v}}}class Et extends Oe{constructor(){const t=J(Et.getDefaults(),arguments,["param","units","convert"]);for(super(t),this.name="Param",this.overridden=!1,this._minOutput=1e-7,wt(It(t.param)&&(jn(t.param)||t.param instanceof Et),"param must be an AudioParam");!jn(t.param);)t.param=t.param._param;this._swappable=!!It(t.swappable)&&t.swappable,this._swappable?(this.input=this.context.createGain(),this._param=t.param,this.input.connect(this._param)):this._param=this.input=t.param,this._events=new ds(1e3),this._initialValue=this._param.defaultValue,this.units=t.units,this.convert=t.convert,this._minValue=t.minValue,this._maxValue=t.maxValue,It(t.value)&&t.value!==this._toType(this._initialValue)&&this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Oe.getDefaults(),{convert:!0,units:"number"})}get value(){const t=this.now();return this.getValueAtTime(t)}set value(t){this.cancelScheduledValues(this.now()),this.setValueAtTime(t,this.now())}get minValue(){return It(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return It(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(t,o){return this.units===o}_assertRange(t){return It(this.maxValue)&&It(this.minValue)&&Be(t,this._fromType(this.minValue),this._fromType(this.maxValue)),t}_fromType(t){return this.convert&&!this.overridden?this._is(t,"time")?this.toSeconds(t):this._is(t,"decibels")?Ti(t):this._is(t,"frequency")?this.toFrequency(t):t:this.overridden?0:t}_toType(t){return this.convert&&this.units==="decibels"?_o(t):t}setValueAtTime(t,o){const l=this.toSeconds(o),d=this._fromType(t);return wt(isFinite(d)&&isFinite(l),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._assertRange(d),this.log(this.units,"setValueAtTime",t,l),this._events.add({time:l,type:"setValueAtTime",value:d}),this._param.setValueAtTime(d,l),this}getValueAtTime(t){const o=Math.max(this.toSeconds(t),0),l=this._events.getAfter(o),d=this._events.get(o);let v=this._initialValue;if(d===null)v=this._initialValue;else if(d.type!=="setTargetAtTime"||l!==null&&l.type!=="setValueAtTime")if(l===null)v=d.value;else if(l.type==="linearRampToValueAtTime"||l.type==="exponentialRampToValueAtTime"){let y=d.value;if(d.type==="setTargetAtTime"){const _=this._events.getBefore(d.time);y=_===null?this._initialValue:_.value}v=l.type==="linearRampToValueAtTime"?this._linearInterpolate(d.time,y,l.time,l.value,o):this._exponentialInterpolate(d.time,y,l.time,l.value,o)}else v=d.value;else{const y=this._events.getBefore(d.time);let _;_=y===null?this._initialValue:y.value,d.type==="setTargetAtTime"&&(v=this._exponentialApproach(d.time,_,d.value,d.constant,o))}return this._toType(v)}setRampPoint(t){t=this.toSeconds(t);let o=this.getValueAtTime(t);return this.cancelAndHoldAtTime(t),this._fromType(o)===0&&(o=this._toType(this._minOutput)),this.setValueAtTime(o,t),this}linearRampToValueAtTime(t,o){const l=this._fromType(t),d=this.toSeconds(o);return wt(isFinite(l)&&isFinite(d),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._assertRange(l),this._events.add({time:d,type:"linearRampToValueAtTime",value:l}),this.log(this.units,"linearRampToValueAtTime",t,d),this._param.linearRampToValueAtTime(l,d),this}exponentialRampToValueAtTime(t,o){let l=this._fromType(t);l=Fs(l,0)?this._minOutput:l,this._assertRange(l);const d=this.toSeconds(o);return wt(isFinite(l)&&isFinite(d),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._events.add({time:d,type:"exponentialRampToValueAtTime",value:l}),this.log(this.units,"exponentialRampToValueAtTime",t,d),this._param.exponentialRampToValueAtTime(l,d),this}exponentialRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialRampToValueAtTime(t,l+this.toSeconds(o)),this}linearRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.linearRampToValueAtTime(t,l+this.toSeconds(o)),this}targetRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialApproachValueAtTime(t,l,o),this}exponentialApproachValueAtTime(t,o,l){o=this.toSeconds(o),l=this.toSeconds(l);const d=Math.log(l+1)/Math.log(200);return this.setTargetAtTime(t,o,d),this.cancelAndHoldAtTime(o+.9*l),this.linearRampToValueAtTime(t,o+l),this}setTargetAtTime(t,o,l){const d=this._fromType(t);wt(isFinite(l)&&l>0,"timeConstant must be a number greater than 0");const v=this.toSeconds(o);return this._assertRange(d),wt(isFinite(d)&&isFinite(v),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._events.add({constant:l,time:v,type:"setTargetAtTime",value:d}),this.log(this.units,"setTargetAtTime",t,v,l),this._param.setTargetAtTime(d,v,l),this}setValueCurveAtTime(t,o,l,d=1){l=this.toSeconds(l),o=this.toSeconds(o);const v=this._fromType(t[0])*d;this.setValueAtTime(this._toType(v),o);const y=l/(t.length-1);for(let _=1;_<t.length;_++){const S=this._fromType(t[_])*d;this.linearRampToValueAtTime(this._toType(S),o+_*y)}return this}cancelScheduledValues(t){const o=this.toSeconds(t);return wt(isFinite(o),`Invalid argument to cancelScheduledValues: ${JSON.stringify(t)}`),this._events.cancel(o),this._param.cancelScheduledValues(o),this.log(this.units,"cancelScheduledValues",o),this}cancelAndHoldAtTime(t){const o=this.toSeconds(t),l=this._fromType(this.getValueAtTime(o));wt(isFinite(o),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(t)}`),this.log(this.units,"cancelAndHoldAtTime",o,"value="+l);const d=this._events.get(o),v=this._events.getAfter(o);return d&&Fs(d.time,o)?v?(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time)):(this._param.cancelAndHoldAtTime(o),this._events.cancel(o+this.sampleTime)):v&&(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time),v.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(l),o):v.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(l),o)),this._events.add({time:o,type:"setValueAtTime",value:l}),this._param.setValueAtTime(l,o),this}rampTo(t,o=.1,l){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(t,o,l):this.linearRampTo(t,o,l),this}apply(t){const o=this.context.currentTime;t.setValueAtTime(this.getValueAtTime(o),o);const l=this._events.get(o);if(l&&l.type==="setTargetAtTime"){const d=this._events.getAfter(l.time),v=d?d.time:o+2,y=(v-o)/10;for(let _=o;_<v;_+=y)t.linearRampToValueAtTime(this.getValueAtTime(_),_)}return this._events.forEachAfter(this.context.currentTime,d=>{d.type==="cancelScheduledValues"?t.cancelScheduledValues(d.time):d.type==="setTargetAtTime"?t.setTargetAtTime(d.value,d.time,d.constant):t[d.type](d.value,d.time)}),this}setParam(t){wt(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const o=this.input;return o.disconnect(this._param),this.apply(t),this._param=t,o.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(t,o,l,d,v){return l+(o-l)*Math.exp(-(v-t)/d)}_linearInterpolate(t,o,l,d,v){return o+(v-t)/(l-t)*(d-o)}_exponentialInterpolate(t,o,l,d,v){return o*Math.pow(d/o,(v-t)/(l-t))}}class ot extends Oe{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return It(this.input)?jn(this.input)||this.input instanceof Et?1:this.input.numberOfInputs:0}get numberOfOutputs(){return It(this.output)?this.output.numberOfOutputs:0}_isAudioNode(t){return It(t)&&(t instanceof ot||Mn(t))}_getInternalNodes(){const t=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&t.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&t.push(this.output),t}_setChannelProperties(t){this._getInternalNodes().forEach(o=>{o.channelCount=t.channelCount,o.channelCountMode=t.channelCountMode,o.channelInterpretation=t.channelInterpretation})}_getChannelProperties(){const t=this._getInternalNodes();wt(t.length>0,"ToneAudioNode does not have any internal nodes");const o=t[0];return{channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCount:t}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCountMode:t}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelInterpretation:t}))}connect(t,o=0,l=0){return Ke(this,t,o,l),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return bi("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(t,o=0,l=0){return gl(this,t,o,l),this}chain(...t){return ms(this,...t),this}fan(...t){return t.forEach(o=>this.connect(o)),this}dispose(){return super.dispose(),It(this.input)&&(this.input instanceof ot?this.input.dispose():Mn(this.input)&&this.input.disconnect()),It(this.output)&&(this.output instanceof ot?this.output.dispose():Mn(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function ms(...p){const t=p.shift();p.reduce((o,l)=>(o instanceof ot?o.connect(l):Mn(o)&&Ke(o,l),l),t)}function Ke(p,t,o=0,l=0){for(wt(It(p),"Cannot connect from undefined node"),wt(It(t),"Cannot connect to undefined node"),(t instanceof ot||Mn(t))&&wt(t.numberOfInputs>0,"Cannot connect to node with no inputs"),wt(p.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof ot||t instanceof Et;)It(t.input)&&(t=t.input);for(;p instanceof ot;)It(p.output)&&(p=p.output);jn(t)?p.connect(t,o):p.connect(t,o,l)}function gl(p,t,o=0,l=0){if(It(t))for(;t instanceof ot;)t=t.input;for(;!Mn(p);)It(p.output)&&(p=p.output);jn(t)?p.disconnect(t,o):Mn(t)?p.disconnect(t,o,l):p.disconnect()}function fg(...p){const t=p.pop();It(t)&&p.forEach(o=>Ke(o,t))}class bt extends ot{constructor(){const t=J(bt.getDefaults(),arguments,["gain","units"]);super(t),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Et({context:this.context,convert:t.convert,param:this._gainNode.gain,units:t.units,value:t.gain,minValue:t.minValue,maxValue:t.maxValue}),St(this,"gain")}static getDefaults(){return Object.assign(ot.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Ei extends ot{constructor(t){super(t),this.onended=Dt,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new bt({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(o){const l=this.toSeconds(o);return this._startTime!==-1&&l>=this._startTime&&(this._stopTime===-1||l<=this._stopTime)?"started":"stopped"},this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut,this._curve=t.curve,this.onended=t.onended}static getDefaults(){return Object.assign(ot.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Dt})}_startGain(t,o=1){wt(this._startTime===-1,"Source cannot be started more than once");const l=this.toSeconds(this._fadeIn);return this._startTime=t+l,this._startTime=Math.max(this._startTime,this.context.currentTime),l>0?(this._gainNode.gain.setValueAtTime(0,t),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(o,t+l):this._gainNode.gain.exponentialApproachValueAtTime(o,t,l)):this._gainNode.gain.setValueAtTime(o,t),this}stop(t){return this.log("stop",t),this._stopGain(this.toSeconds(t)),this}_stopGain(t){wt(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const o=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(t)+o,this._stopTime=Math.max(this._stopTime,this.now()),o>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,o,t):this._gainNode.gain.targetRampTo(0,o,t):(this._gainNode.gain.cancelAndHoldAtTime(t),this._gainNode.gain.setValueAtTime(0,t)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const l=this._curve==="exponential"?2*o:0;this._stopSource(this.now()+l),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Dt&&(this.onended(this),this.onended=Dt,!this.context.isOffline)){const t=()=>this.dispose();window.requestIdleCallback!==void 0?window.requestIdleCallback(t):setTimeout(t,1e3)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),wt(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Dt,this}}class Va extends Ei{constructor(){const t=J(Va.getDefaults(),arguments,["offset"]);super(t),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Ke(this._source,this._gainNode),this.offset=new Et({context:this.context,convert:t.convert,param:this._source.offset,units:t.units,value:t.offset,minValue:t.minValue,maxValue:t.maxValue})}static getDefaults(){return Object.assign(Ei.getDefaults(),{convert:!0,offset:1,units:"number"})}start(t){const o=this.toSeconds(t);return this.log("start",o),this._startGain(o),this._source.start(o),this}_stopSource(t){this._source.stop(t)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Tt extends ot{constructor(){const t=J(Tt.getDefaults(),arguments,["value","units"]);super(t),this.name="Signal",this.override=!0,this.output=this._constantSource=new Va({context:this.context,convert:t.convert,offset:t.value,units:t.units,minValue:t.minValue,maxValue:t.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(ot.getDefaults(),{convert:!0,units:"number",value:0})}connect(t,o=0,l=0){return xo(this,t,o,l),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(t,o){return this._param.setValueAtTime(t,o),this}getValueAtTime(t){return this._param.getValueAtTime(t)}setRampPoint(t){return this._param.setRampPoint(t),this}linearRampToValueAtTime(t,o){return this._param.linearRampToValueAtTime(t,o),this}exponentialRampToValueAtTime(t,o){return this._param.exponentialRampToValueAtTime(t,o),this}exponentialRampTo(t,o,l){return this._param.exponentialRampTo(t,o,l),this}linearRampTo(t,o,l){return this._param.linearRampTo(t,o,l),this}targetRampTo(t,o,l){return this._param.targetRampTo(t,o,l),this}exponentialApproachValueAtTime(t,o,l){return this._param.exponentialApproachValueAtTime(t,o,l),this}setTargetAtTime(t,o,l){return this._param.setTargetAtTime(t,o,l),this}setValueCurveAtTime(t,o,l,d){return this._param.setValueCurveAtTime(t,o,l,d),this}cancelScheduledValues(t){return this._param.cancelScheduledValues(t),this}cancelAndHoldAtTime(t){return this._param.cancelAndHoldAtTime(t),this}rampTo(t,o,l){return this._param.rampTo(t,o,l),this}get value(){return this._param.value}set value(t){this._param.value=t}get convert(){return this._param.convert}set convert(t){this._param.convert=t}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(t){this._param.overridden=t}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(t){return this._param.apply(t),this}}function xo(p,t,o,l){(t instanceof Et||jn(t)||t instanceof Tt&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof Tt&&(t.overridden=!0)),Ke(p,t,o,l)}class vl extends Et{constructor(){const t=J(vl.getDefaults(),arguments,["value"]);super(t),this.name="TickParam",this._events=new ds(1/0),this._multiplier=1,this._multiplier=t.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(t.value)}),this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Et.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(t,o,l){o=this.toSeconds(o),this.setRampPoint(o);const d=this._fromType(t),v=this._events.get(o),y=Math.round(Math.max(1/l,1));for(let _=0;_<=y;_++){const S=l*_+o,C=this._exponentialApproach(v.time,v.value,d,l,S);this.linearRampToValueAtTime(this._toType(C),S)}return this}setValueAtTime(t,o){const l=this.toSeconds(o);super.setValueAtTime(t,o);const d=this._events.get(l),v=this._events.previousEvent(d),y=this._getTicksUntilEvent(v,l);return d.ticks=Math.max(y,0),this}linearRampToValueAtTime(t,o){const l=this.toSeconds(o);super.linearRampToValueAtTime(t,o);const d=this._events.get(l),v=this._events.previousEvent(d),y=this._getTicksUntilEvent(v,l);return d.ticks=Math.max(y,0),this}exponentialRampToValueAtTime(t,o){o=this.toSeconds(o);const l=this._fromType(t),d=this._events.get(o),v=Math.round(Math.max(10*(o-d.time),1)),y=(o-d.time)/v;for(let _=0;_<=v;_++){const S=y*_+d.time,C=this._exponentialInterpolate(d.time,d.value,o,l,S);this.linearRampToValueAtTime(this._toType(C),S)}return this}_getTicksUntilEvent(t,o){if(t===null)t={ticks:0,time:0,type:"setValueAtTime",value:0};else if(os(t.ticks)){const y=this._events.previousEvent(t);t.ticks=this._getTicksUntilEvent(y,t.time)}const l=this._fromType(this.getValueAtTime(t.time));let d=this._fromType(this.getValueAtTime(o));const v=this._events.get(o);return v&&v.time===o&&v.type==="setValueAtTime"&&(d=this._fromType(this.getValueAtTime(o-this.sampleTime))),.5*(o-t.time)*(l+d)+t.ticks}getTicksAtTime(t){const o=this.toSeconds(t),l=this._events.get(o);return Math.max(this._getTicksUntilEvent(l,o),0)}getDurationOfTicks(t,o){const l=this.toSeconds(o),d=this.getTicksAtTime(o);return this.getTimeOfTick(d+t)-l}getTimeOfTick(t){const o=this._events.get(t,"ticks"),l=this._events.getAfter(t,"ticks");if(o&&o.ticks===t)return o.time;if(o&&l&&l.type==="linearRampToValueAtTime"&&o.value!==l.value){const d=this._fromType(this.getValueAtTime(o.time)),v=(this._fromType(this.getValueAtTime(l.time))-d)/(l.time-o.time),y=Math.sqrt(Math.pow(d,2)-2*v*(o.ticks-t)),_=(-d+y)/v;return(_>0?_:(-d-y)/v)+o.time}return o?o.value===0?1/0:o.time+(t-o.ticks)/o.value:t/this._initialValue}ticksToTime(t,o){return this.getDurationOfTicks(t,o)}timeToTicks(t,o){const l=this.toSeconds(o),d=this.toSeconds(t),v=this.getTicksAtTime(l);return this.getTicksAtTime(l+d)-v}_fromType(t){return this.units==="bpm"&&this.multiplier?1/(60/t/this.multiplier):super._fromType(t)}_toType(t){return this.units==="bpm"&&this.multiplier?t/this.multiplier*60:super._toType(t)}get multiplier(){return this._multiplier}set multiplier(t){const o=this.value;this._multiplier=t,this.cancelScheduledValues(0),this.setValueAtTime(o,0)}}class yl extends Tt{constructor(){const t=J(yl.getDefaults(),arguments,["value"]);super(t),this.name="TickSignal",this.input=this._param=new vl({context:this.context,convert:t.convert,multiplier:t.multiplier,param:this._constantSource.offset,units:t.units,value:t.value})}static getDefaults(){return Object.assign(Tt.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(t,o){return this._param.ticksToTime(t,o)}timeToTicks(t,o){return this._param.timeToTicks(t,o)}getTimeOfTick(t){return this._param.getTimeOfTick(t)}getDurationOfTicks(t,o){return this._param.getDurationOfTicks(t,o)}getTicksAtTime(t){return this._param.getTicksAtTime(t)}get multiplier(){return this._param.multiplier}set multiplier(t){this._param.multiplier=t}dispose(){return super.dispose(),this._param.dispose(),this}}class bl extends Oe{constructor(){const t=J(bl.getDefaults(),arguments,["frequency"]);super(t),this.name="TickSource",this._state=new Mi,this._tickOffset=new ds,this._ticksAtTime=new ds,this._secondsAtTime=new ds,this.frequency=new yl({context:this.context,units:t.units,value:t.frequency}),St(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Oe.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(t,o){const l=this.toSeconds(t);return this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),It(o)&&this.setTicksAtTime(o,l),this._ticksAtTime.cancel(l),this._secondsAtTime.cancel(l)),this}stop(t){const o=this.toSeconds(t);if(this._state.getValueAtTime(o)==="stopped"){const l=this._state.get(o);l&&l.time>0&&(this._tickOffset.cancel(l.time),this._state.cancel(l.time))}return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this.setTicksAtTime(0,o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}pause(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o)),this}cancel(t){return t=this.toSeconds(t),this._state.cancel(t),this._tickOffset.cancel(t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getTicksAtTime(t){const o=this.toSeconds(t),l=this._state.getLastState("stopped",o),d=this._ticksAtTime.get(o),v={state:"paused",time:o};this._state.add(v);let y=d||l,_=d?d.ticks:0,S=null;return this._state.forEachBetween(y.time,o+this.sampleTime,C=>{let E=y.time;const k=this._tickOffset.get(C.time);k&&k.time>=y.time&&(_=k.ticks,E=k.time),y.state==="started"&&C.state!=="started"&&(_+=this.frequency.getTicksAtTime(C.time)-this.frequency.getTicksAtTime(E),C.time!==v.time&&(S={state:C.state,time:C.time,ticks:_})),y=C}),this._state.remove(v),S&&this._ticksAtTime.add(S),_}get ticks(){return this.getTicksAtTime(this.now())}set ticks(t){this.setTicksAtTime(t,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(t){const o=this.now(),l=this.frequency.timeToTicks(t,o);this.setTicksAtTime(l,o)}getSecondsAtTime(t){t=this.toSeconds(t);const o=this._state.getLastState("stopped",t),l={state:"paused",time:t};this._state.add(l);const d=this._secondsAtTime.get(t);let v=d||o,y=d?d.seconds:0,_=null;return this._state.forEachBetween(v.time,t+this.sampleTime,S=>{let C=v.time;const E=this._tickOffset.get(S.time);E&&E.time>=v.time&&(y=E.seconds,C=E.time),v.state==="started"&&S.state!=="started"&&(y+=S.time-C,S.time!==l.time&&(_={state:S.state,time:S.time,seconds:y})),v=S}),this._state.remove(l),_&&this._secondsAtTime.add(_),y}setTicksAtTime(t,o){return o=this.toSeconds(o),this._tickOffset.cancel(o),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(t,o),ticks:t,time:o}),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}getStateAtTime(t){return t=this.toSeconds(t),this._state.getValueAtTime(t)}getTimeOfTick(t,o=this.now()){const l=this._tickOffset.get(o),d=this._state.get(o),v=Math.max(l.time,d.time),y=this.frequency.getTicksAtTime(v)+t-l.ticks;return this.frequency.getTimeOfTick(y)}forEachTickBetween(t,o,l){let d=this._state.get(t);this._state.forEachBetween(t,o,y=>{d&&d.state==="started"&&y.state!=="started"&&this.forEachTickBetween(Math.max(d.time,t),y.time-this.sampleTime,l),d=y});let v=null;if(d&&d.state==="started"){const y=Math.max(d.time,t),_=this.frequency.getTicksAtTime(y),S=_-this.frequency.getTicksAtTime(d.time);let C=Math.ceil(S)-S;C=Fs(C,1)?0:C;let E=this.frequency.getTimeOfTick(_+C);for(;E<o;){try{l(E,Math.round(this.getTicksAtTime(E)))}catch(k){v=k;break}E+=this.frequency.getDurationOfTicks(1,E)}}if(v)throw v;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class Pi extends Oe{constructor(){const t=J(Pi.getDefaults(),arguments,["callback","frequency"]);super(t),this.name="Clock",this.callback=Dt,this._lastUpdate=0,this._state=new Mi("stopped"),this._boundLoop=this._loop.bind(this),this.callback=t.callback,this._tickSource=new bl({context:this.context,frequency:t.frequency,units:t.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,St(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Oe.getDefaults(),{callback:Dt,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(t,o){ll(this.context);const l=this.toSeconds(t);return this.log("start",l),this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),this._tickSource.start(l,o),l<this._lastUpdate&&this.emit("start",l,o)),this}stop(t){const o=this.toSeconds(t);return this.log("stop",o),this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._tickSource.stop(o),o<this._lastUpdate&&this.emit("stop",o),this}pause(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._tickSource.pause(o),o<this._lastUpdate&&this.emit("pause",o)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(t){this._tickSource.ticks=t}get seconds(){return this._tickSource.seconds}set seconds(t){this._tickSource.seconds=t}getSecondsAtTime(t){return this._tickSource.getSecondsAtTime(t)}setTicksAtTime(t,o){return this._tickSource.setTicksAtTime(t,o),this}getTimeOfTick(t,o=this.now()){return this._tickSource.getTimeOfTick(t,o)}getTicksAtTime(t){return this._tickSource.getTicksAtTime(t)}nextTickTime(t,o){const l=this.toSeconds(o),d=this.getTicksAtTime(l);return this._tickSource.getTimeOfTick(d+t,l)}_loop(){const t=this._lastUpdate,o=this.now();this._lastUpdate=o,this.log("loop",t,o),t!==o&&(this._state.forEachBetween(t,o,l=>{switch(l.state){case"started":const d=this._tickSource.getTicksAtTime(l.time);this.emit("start",l.time,d);break;case"stopped":l.time!==0&&this.emit("stop",l.time);break;case"paused":this.emit("pause",l.time)}}),this._tickSource.forEachTickBetween(t,o,(l,d)=>{this.callback(l,d)}))}getStateAtTime(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}xi.mixin(Pi);class fs extends ot{constructor(){const t=J(fs.getDefaults(),arguments,["delayTime","maxDelay"]);super(t),this.name="Delay";const o=this.toSeconds(t.maxDelay);this._maxDelay=Math.max(o,this.toSeconds(t.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(o),this.delayTime=new Et({context:this.context,param:this._delayNode.delayTime,units:"time",value:t.delayTime,minValue:0,maxValue:this.maxDelay}),St(this,"delayTime")}static getDefaults(){return Object.assign(ot.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class un extends ot{constructor(){const t=J(un.getDefaults(),arguments,["volume"]);super(t),this.name="Volume",this.input=this.output=new bt({context:this.context,gain:t.volume,units:"decibels"}),this.volume=this.output.gain,St(this,"volume"),this._unmutedVolume=t.volume,this.mute=t.mute}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(t){!this.mute&&t?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!t&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class wl extends ot{constructor(){const t=J(wl.getDefaults(),arguments);super(t),this.name="Destination",this.input=new un({context:this.context}),this.output=new bt({context:this.context}),this.volume=this.input.volume,ms(this.input,this.output,this.context.rawContext.destination),this.mute=t.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(t){this.input.mute=t}chain(...t){return this.input.disconnect(),t.unshift(this.input),t.push(this.output),ms(...t),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}$a(p=>{p.destination=new wl({context:p})}),qa(p=>{p.destination.dispose()});class gg extends ot{constructor(){super(...arguments),this.name="Listener",this.positionX=new Et({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Et({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Et({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Et({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Et({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Et({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Et({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Et({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Et({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(ot.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}function vg(p,t){return Kt(this,arguments,void 0,function*(o,l,d=2,v=ie().sampleRate){const y=ie(),_=new Ci(d,l,v);za(_),yield o(_);const S=_.render();za(y);const C=yield S;return new qt(C)})}$a(p=>{p.listener=new gg({context:p})}),qa(p=>{p.listener.dispose()});class ki extends hn{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const t=J(ki.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=t.baseUrl,Object.keys(t.urls).forEach(o=>{this._loadingCount++;const l=t.urls[o];this.add(o,l,this._bufferLoaded.bind(this,t.onload),t.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Dt,onload:Dt,urls:{}}}has(t){return this._buffers.has(t.toString())}get(t){return wt(this.has(t),`ToneAudioBuffers has no buffer named: ${t}`),this._buffers.get(t.toString())}_bufferLoaded(t){this._loadingCount--,this._loadingCount===0&&t&&t()}get loaded(){return Array.from(this._buffers).every(([t,o])=>o.loaded)}add(t,o,l=Dt,d=Dt){return Ns(o)?(this.baseUrl&&o.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(t.toString(),new qt(this.baseUrl+o,l,d))):this._buffers.set(t.toString(),new qt(o,l,d)),this}dispose(){return super.dispose(),this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this}}class Ii extends Je{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(t){return En(super._frequencyToUnits(t))}_ticksToUnits(t){return En(super._ticksToUnits(t))}_beatsToUnits(t){return En(super._beatsToUnits(t))}_secondsToUnits(t){return En(super._secondsToUnits(t))}toMidi(){return this.valueOf()}toFrequency(){return ml(this.toMidi())}transpose(t){return new Ii(this.context,this.toMidi()+t)}}function yg(p,t){return new Ii(ie(),p,t)}class ce extends xe{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(t){return this._getPPQ()*t}_secondsToUnits(t){return Math.floor(t/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(t){return t}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}function bg(p,t){return new ce(ie(),p,t)}class wg extends Oe{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new ds,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(t,o){return this._events.add({callback:t,time:this.toSeconds(o)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(t){return this._events.cancel(this.toSeconds(t)),this}_drawLoop(){const t=this.context.currentTime;for(;this._events.length&&this._events.peek().time-this.anticipation<=t;){const o=this._events.shift();o&&t-o.time<=this.expiration&&o.callback()}this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}$a(p=>{p.draw=new wg({context:p})}),qa(p=>{p.draw.dispose()});class Fu extends hn{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(t){wt(It(t.time),"Events must have a time property"),wt(It(t.duration),"Events must have a duration parameter"),t.time=t.time.valueOf();let o=new _g(t.time,t.time+t.duration,t);for(this._root===null?this._root=o:this._root.insert(o),this._length++;o!==null;)o.updateHeight(),o.updateMax(),this._rebalance(o),o=o.parent;return this}remove(t){if(this._root!==null){const o=[];this._root.search(t.time,o);for(const l of o)if(l.event===t){this._removeNode(l),this._length--;break}}return this}get length(){return this._length}cancel(t){return this.forEachFrom(t,o=>this.remove(o)),this}_setRoot(t){this._root=t,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(t,o){t.parent!==null?(t.isLeftChild()?t.parent.left=o:t.parent.right=o,this._rebalance(t.parent)):this._setRoot(o)}_removeNode(t){if(t.left===null&&t.right===null)this._replaceNodeInParent(t,null);else if(t.right===null)this._replaceNodeInParent(t,t.left);else if(t.left===null)this._replaceNodeInParent(t,t.right);else{let o,l=null;if(t.getBalance()>0)if(t.left.right===null)o=t.left,o.right=t.right,l=o;else{for(o=t.left.right;o.right!==null;)o=o.right;o.parent&&(o.parent.right=o.left,l=o.parent,o.left=t.left,o.right=t.right)}else if(t.right.left===null)o=t.right,o.left=t.left,l=o;else{for(o=t.right.left;o.left!==null;)o=o.left;o.parent&&(o.parent.left=o.right,l=o.parent,o.left=t.left,o.right=t.right)}t.parent!==null?t.isLeftChild()?t.parent.left=o:t.parent.right=o:this._setRoot(o),l&&this._rebalance(l)}t.dispose()}_rotateLeft(t){const o=t.parent,l=t.isLeftChild(),d=t.right;d&&(t.right=d.left,d.left=t),o!==null?l?o.left=d:o.right=d:this._setRoot(d)}_rotateRight(t){const o=t.parent,l=t.isLeftChild(),d=t.left;d&&(t.left=d.right,d.right=t),o!==null?l?o.left=d:o.right=d:this._setRoot(d)}_rebalance(t){const o=t.getBalance();o>1&&t.left?t.left.getBalance()<0?this._rotateLeft(t.left):this._rotateRight(t):o<-1&&t.right&&(t.right.getBalance()>0?this._rotateRight(t.right):this._rotateLeft(t))}get(t){if(this._root!==null){const o=[];if(this._root.search(t,o),o.length>0){let l=o[0];for(let d=1;d<o.length;d++)o[d].low>l.low&&(l=o[d]);return l.event}}return null}forEach(t){if(this._root!==null){const o=[];this._root.traverse(l=>o.push(l)),o.forEach(l=>{l.event&&t(l.event)})}return this}forEachAtTime(t,o){if(this._root!==null){const l=[];this._root.search(t,l),l.forEach(d=>{d.event&&o(d.event)})}return this}forEachFrom(t,o){if(this._root!==null){const l=[];this._root.searchAfter(t,l),l.forEach(d=>{d.event&&o(d.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(t=>t.dispose()),this._root=null,this}}class _g{constructor(t,o,l){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=l,this.low=t,this.high=o,this.max=this.high}insert(t){t.low<=this.low?this.left===null?this.left=t:this.left.insert(t):this.right===null?this.right=t:this.right.insert(t)}search(t,o){t>this.max||(this.left!==null&&this.left.search(t,o),this.low<=t&&this.high>t&&o.push(this),this.low>t||this.right!==null&&this.right.search(t,o))}searchAfter(t,o){this.low>=t&&(o.push(this),this.left!==null&&this.left.searchAfter(t,o)),this.right!==null&&this.right.searchAfter(t,o)}traverse(t){t(this),this.left!==null&&this.left.traverse(t),this.right!==null&&this.right.traverse(t)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let t=0;return this.left!==null&&this.right!==null?t=this.left.height-this.right.height:this.left!==null?t=this.left.height+1:this.right!==null&&(t=-(this.right.height+1)),t}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(t){this._left=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(t){this._right=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class xg extends hn{constructor(t){super(),this.name="TimelineValue",this._timeline=new ds({memory:10}),this._initialValue=t}set(t,o){return this._timeline.add({value:t,time:o}),this}get(t){const o=this._timeline.get(t);return o?o.value:this._initialValue}}class gs extends ot{constructor(){super(J(gs.getDefaults(),arguments,["context"]))}connect(t,o=0,l=0){return xo(this,t,o,l),this}}class Bs extends gs{constructor(){const t=J(Bs.getDefaults(),arguments,["mapping","length"]);super(t),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Fe(t.mapping)||t.mapping instanceof Float32Array?this.curve=Float32Array.from(t.mapping):Eu(t.mapping)&&this.setMap(t.mapping,t.length)}static getDefaults(){return Object.assign(Tt.getDefaults(),{length:1024})}setMap(t,o=1024){const l=new Float32Array(o);for(let d=0,v=o;d<v;d++){const y=d/(v-1)*2-1;l[d]=t(y,d)}return this.curve=l,this}get curve(){return this._shaper.curve}set curve(t){this._shaper.curve=t}get oversample(){return this._shaper.oversample}set oversample(t){wt(["none","2x","4x"].some(o=>o.includes(t)),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Ri extends gs{constructor(){const t=J(Ri.getDefaults(),arguments,["value"]);super(t),this.name="Pow",this._exponentScaler=this.input=this.output=new Bs({context:this.context,mapping:this._expFunc(t.value),length:8192}),this._exponent=t.value}static getDefaults(){return Object.assign(gs.getDefaults(),{value:1})}_expFunc(t){return o=>Math.pow(Math.abs(o),t)}get value(){return this._exponent}set value(t){this._exponent=t,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class Pn{constructor(t,o){this.id=Pn._eventId++,this._remainderTime=0;const l=Object.assign(Pn.getDefaults(),o);this.transport=t,this.callback=l.callback,this._once=l.once,this.time=Math.floor(l.time),this._remainderTime=l.time-this.time}static getDefaults(){return{callback:Dt,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(t){if(this.callback){const o=this.transport.bpm.getDurationOfTicks(1,t);this.callback(t+this._remainderTime*o),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}Pn._eventId=0;class _l extends Pn{constructor(t,o){super(t,o),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const l=Object.assign(_l.getDefaults(),o);this.duration=l.duration,this._interval=l.interval,this._nextTick=l.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},Pn.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(t){this._createEvents(t),super.invoke(t)}_createEvent(){return Ba(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new ce(this.context,this._nextTick).toSeconds()):-1}_createEvents(t){Ba(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new ce(this.context,this._nextTick).toSeconds()))}_restart(t){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const o=this.transport.getTicksAtTime(t);_i(o,this.time)&&(this._nextTick=this.floatTime+Math.ceil((o-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Ha extends Oe{constructor(){const t=J(Ha.getDefaults(),arguments);super(t),this.name="Transport",this._loop=new xg(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new ds,this._repeatedEvents=new Fu,this._syncedSignals=[],this._swingAmount=0,this._ppq=t.ppq,this._clock=new Pi({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=t.ppq,this.bpm.setValueAtTime(t.bpm,0),St(this,"bpm"),this._timeSignature=t.timeSignature,this._swingTicks=t.ppq/2}static getDefaults(){return Object.assign(Oe.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(t,o){if(this._loop.get(t)&&o>=this._loopEnd&&(this.emit("loopEnd",t),this._clock.setTicksAtTime(this._loopStart,t),o=this._loopStart,this.emit("loopStart",t,this._clock.getSecondsAtTime(t)),this.emit("loop",t)),this._swingAmount>0&&o%this._ppq!=0&&o%(2*this._swingTicks)!=0){const l=o%(2*this._swingTicks)/(2*this._swingTicks),d=Math.sin(l*Math.PI)*this._swingAmount;t+=new ce(this.context,2*this._swingTicks/3).toSeconds()*d}cl(!0),this._timeline.forEachAtTime(o,l=>l.invoke(t)),cl(!1)}schedule(t,o){const l=new Pn(this,{callback:t,time:new xe(this.context,o).toTicks()});return this._addEvent(l,this._timeline)}scheduleRepeat(t,o,l,d=1/0){const v=new _l(this,{callback:t,duration:new ps(this.context,d).toTicks(),interval:new ps(this.context,o).toTicks(),time:new xe(this.context,l).toTicks()});return this._addEvent(v,this._repeatedEvents)}scheduleOnce(t,o){const l=new Pn(this,{callback:t,once:!0,time:new xe(this.context,o).toTicks()});return this._addEvent(l,this._timeline)}clear(t){if(this._scheduledEvents.hasOwnProperty(t)){const o=this._scheduledEvents[t.toString()];o.timeline.remove(o.event),o.event.dispose(),delete this._scheduledEvents[t.toString()]}return this}_addEvent(t,o){return this._scheduledEvents[t.id.toString()]={event:t,timeline:o},o.add(t),t.id}cancel(t=0){const o=this.toTicks(t);return this._timeline.forEachFrom(o,l=>this.clear(l.id)),this._repeatedEvents.forEachFrom(o,l=>this.clear(l.id)),this}_bindClockEvents(){this._clock.on("start",(t,o)=>{o=new ce(this.context,o).toSeconds(),this.emit("start",t,o)}),this._clock.on("stop",t=>{this.emit("stop",t)}),this._clock.on("pause",t=>{this.emit("pause",t)})}get state(){return this._clock.getStateAtTime(this.now())}start(t,o){let l;return this.context.resume(),It(o)&&(l=this.toTicks(o)),this._clock.start(t,l),this}stop(t){return this._clock.stop(t),this}pause(t){return this._clock.pause(t),this}toggle(t){return t=this.toSeconds(t),this._clock.getStateAtTime(t)!=="started"?this.start(t):this.stop(t),this}get timeSignature(){return this._timeSignature}set timeSignature(t){Fe(t)&&(t=t[0]/t[1]*4),this._timeSignature=t}get loopStart(){return new ps(this.context,this._loopStart,"i").toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t)}get loopEnd(){return new ps(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t)}get loop(){return this._loop.get(this.now())}set loop(t){this._loop.set(t,this.now())}setLoopPoints(t,o){return this.loopStart=t,this.loopEnd=o,this}get swing(){return this._swingAmount}set swing(t){this._swingAmount=t}get swingSubdivision(){return new ce(this.context,this._swingTicks).toNotation()}set swingSubdivision(t){this._swingTicks=this.toTicks(t)}get position(){const t=this.now(),o=this._clock.getTicksAtTime(t);return new ce(this.context,o).toBarsBeatsSixteenths()}set position(t){const o=this.toTicks(t);this.ticks=o}get seconds(){return this._clock.seconds}set seconds(t){const o=this.now(),l=this._clock.frequency.timeToTicks(t,o);this.ticks=l}get progress(){if(this.loop){const t=this.now();return(this._clock.getTicksAtTime(t)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(t){if(this._clock.ticks!==t){const o=this.now();if(this.state==="started"){const l=this._clock.getTicksAtTime(o),d=o+this._clock.frequency.getDurationOfTicks(Math.ceil(l)-l,o);this.emit("stop",d),this._clock.setTicksAtTime(t,d),this.emit("start",d,this._clock.getSecondsAtTime(d))}else this.emit("ticks",o),this._clock.setTicksAtTime(t,o)}}getTicksAtTime(t){return this._clock.getTicksAtTime(t)}getSecondsAtTime(t){return this._clock.getSecondsAtTime(t)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(t){this._clock.frequency.multiplier=t}nextSubdivision(t){if(t=this.toTicks(t),this.state!=="started")return 0;{const o=this.now(),l=t-this.getTicksAtTime(o)%t;return this._clock.nextTickTime(l,o)}}syncSignal(t,o){const l=this.now();let d=this.bpm,v=1/(60/d.getValueAtTime(l)/this.PPQ),y=[];if(t.units==="time"){const S=.015625/v,C=new bt(S),E=new Ri(-1),k=new bt(S);d.chain(C,E,k),d=k,v=1/v,y=[C,E,k]}o||(o=t.getValueAtTime(l)!==0?t.getValueAtTime(l)/v:0);const _=new bt(o);return d.connect(_),_.connect(t._param),y.push(_),this._syncedSignals.push({initial:t.value,nodes:y,signal:t}),t.value=0,this}unsyncSignal(t){for(let o=this._syncedSignals.length-1;o>=0;o--){const l=this._syncedSignals[o];l.signal===t&&(l.nodes.forEach(d=>d.dispose()),l.signal.value=l.initial,this._syncedSignals.splice(o,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),bo(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}xi.mixin(Ha),$a(p=>{p.transport=new Ha({context:p})}),qa(p=>{p.transport.dispose()});class ge extends ot{constructor(t){super(t),this.input=void 0,this._state=new Mi("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Dt,this._syncedStop=Dt,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new un({context:this.context,mute:t.mute,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume"),this.onstop=t.onstop}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,onstop:Dt,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}_clampToCurrentTime(t){return this._synced?t:Math.max(t,this.context.currentTime)}start(t,o,l){let d=os(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(d=this._clampToCurrentTime(d),this._synced||this._state.getValueAtTime(d)!=="started")if(this.log("start",d),this._state.setStateAtTime("started",d),this._synced){const v=this._state.get(d);v&&(v.offset=this.toSeconds(Ts(o,0)),v.duration=l?this.toSeconds(l):void 0);const y=this.context.transport.schedule(_=>{this._start(_,o,l)},d);this._scheduled.push(y),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>d&&this._syncedStart(this.now(),this.context.transport.seconds)}else ll(this.context),this._start(d,o,l);else wt(_i(d,this._state.get(d).time),"Start time must be strictly greater than previous start time"),this._state.cancel(d),this._state.setStateAtTime("started",d),this.log("restart",d),this.restart(d,o,l);return this}stop(t){let o=os(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(o=this._clampToCurrentTime(o),this._state.getValueAtTime(o)==="started"||It(this._state.getNextState("started",o))){if(this.log("stop",o),this._synced){const l=this.context.transport.schedule(this._stop.bind(this),o);this._scheduled.push(l)}else this._stop(o);this._state.cancel(o),this._state.setStateAtTime("stopped",o)}return this}restart(t,o,l){return t=this.toSeconds(t),this._state.getValueAtTime(t)==="started"&&(this._state.cancel(t),this._restart(t,o,l)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(t,o)=>{if(_i(o,0)){const l=this._state.get(o);if(l&&l.state==="started"&&l.time!==o){const d=o-this.toSeconds(l.time);let v;l.duration&&(v=this.toSeconds(l.duration)-d),this._start(t,this.toSeconds(l.offset)+d,v)}}},this._syncedStop=t=>{const o=this.context.transport.getSecondsAtTime(Math.max(t-this.sampleTime,0));this._state.getValueAtTime(o)==="started"&&this._stop(t)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(t=>this.context.transport.clear(t)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Dt,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class kn extends Ei{constructor(){const t=J(kn.getDefaults(),arguments,["url","onload"]);super(t),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Ke(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Et({context:this.context,param:this._source.playbackRate,units:"positive",value:t.playbackRate}),this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this._buffer=new qt(t.url,t.onload,t.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Ei.getDefaults(),{url:new qt,loop:!1,loopEnd:0,loopStart:0,onload:Dt,onerror:Dt,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t}get curve(){return this._curve}set curve(t){this._curve=t}start(t,o,l,d=1){wt(this.buffer.loaded,"buffer is either not set or not loaded");const v=this.toSeconds(t);this._startGain(v,d),o=this.loop?Ts(o,this.loopStart):Ts(o,0);let y=Math.max(this.toSeconds(o),0);if(this.loop){const _=this.toSeconds(this.loopEnd)||this.buffer.duration,S=this.toSeconds(this.loopStart),C=_-S;dl(y,_)&&(y=(y-S)%C+S),Fs(y,this.buffer.duration)&&(y=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Ba(y,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(v,y)),It(l)){let _=this.toSeconds(l);_=Math.max(_,0),this.stop(v+_)}return this}_stopSource(t){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(t)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(t){this._source.loopStart=this.toSeconds(t)}get loopEnd(){return this._source.loopEnd}set loopEnd(t){this._source.loopEnd=this.toSeconds(t)}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._source.loop}set loop(t){this._source.loop=t,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}class In extends ge{constructor(){const t=J(In.getDefaults(),arguments,["type"]);super(t),this.name="Noise",this._source=null,this._playbackRate=t.playbackRate,this.type=t.type,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ge.getDefaults(),{fadeIn:0,fadeOut:0,playbackRate:1,type:"white"})}get type(){return this._type}set type(t){if(wt(t in Bu,"Noise: invalid type: "+t),this._type!==t&&(this._type=t,this.state==="started")){const o=this.now();this._stop(o),this._start(o)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._source&&(this._source.playbackRate.value=t)}_start(t){const o=Bu[this._type];this._source=new kn({url:o,context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,loop:!0,onended:()=>this.onstop(this),playbackRate:this._playbackRate}).connect(this.output),this._source.start(this.toSeconds(t),Math.random()*(o.duration-.001))}_stop(t){this._source&&(this._source.stop(this.toSeconds(t)),this._source=null)}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._source&&(this._source.fadeIn=this._fadeIn)}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._source&&(this._source.fadeOut=this._fadeOut)}_restart(t){this._stop(t),this._start(t)}dispose(){return super.dispose(),this._source&&this._source.disconnect(),this}}const Di=220500,dn={brown:null,pink:null,white:null},Bu={get brown(){if(!dn.brown){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Di);p[t]=o;let l=0;for(let d=0;d<Di;d++){const v=2*Math.random()-1;o[d]=(l+.02*v)/1.02,l=o[d],o[d]*=3.5}}dn.brown=new qt().fromArray(p)}return dn.brown},get pink(){if(!dn.pink){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Di);let l,d,v,y,_,S,C;p[t]=o,l=d=v=y=_=S=C=0;for(let E=0;E<Di;E++){const k=2*Math.random()-1;l=.99886*l+.0555179*k,d=.99332*d+.0750759*k,v=.969*v+.153852*k,y=.8665*y+.3104856*k,_=.55*_+.5329522*k,S=-.7616*S-.016898*k,o[E]=l+d+v+y+_+S+C+.5362*k,o[E]*=.11,C=.115926*k}}dn.pink=new qt().fromArray(p)}return dn.pink},get white(){if(!dn.white){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Di);p[t]=o;for(let l=0;l<Di;l++)o[l]=2*Math.random()-1}dn.white=new qt().fromArray(p)}return dn.white}};class So extends ot{constructor(){const t=J(So.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,volume:0})}open(t){return Kt(this,void 0,void 0,function*(){wt(So.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const o=yield So.enumerateDevices();hs(t)?this._device=o[t]:(this._device=o.find(v=>v.label===t||v.deviceId===t),!this._device&&o.length>0&&(this._device=o[0]),wt(It(this._device),`No matching device ${t}`));const l={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(l.audio.deviceId=this._device.deviceId);const d=yield navigator.mediaDevices.getUserMedia(l);if(!this._stream){this._stream=d;const v=this.context.createMediaStreamSource(d);Ke(v,this.output),this._mediaStream=v}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return Kt(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){return this._device?this._device.deviceId:void 0}get groupId(){return this._device?this._device.groupId:void 0}get label(){return this._device?this._device.label:void 0}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return It(navigator.mediaDevices)&&It(navigator.mediaDevices.getUserMedia)}}function Xn(p,t){return Kt(this,void 0,void 0,function*(){const o=t/p.context.sampleRate,l=new Ci(1,o,p.context.sampleRate);return new p.constructor(Object.assign(p.get(),{frequency:2/o,detune:0,context:l})).toDestination().start(0),(yield l.render()).getChannelData(0)})}class Co extends Ei{constructor(){const t=J(Co.getDefaults(),arguments,["frequency","type"]);super(t),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Ke(this._oscillator,this._gainNode),this.type=t.type,this.frequency=new Et({context:this.context,param:this._oscillator.frequency,units:"frequency",value:t.frequency}),this.detune=new Et({context:this.context,param:this._oscillator.detune,units:"cents",value:t.detune}),St(this,["frequency","detune"])}static getDefaults(){return Object.assign(Ei.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(t){const o=this.toSeconds(t);return this.log("start",o),this._startGain(o),this._oscillator.start(o),this}_stopSource(t){this._oscillator.stop(t)}setPeriodicWave(t){return this._oscillator.setPeriodicWave(t),this}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class he extends ge{constructor(){const t=J(he.getDefaults(),arguments,["frequency","type"]);super(t),this.name="Oscillator",this._oscillator=null,this.frequency=new Tt({context:this.context,units:"frequency",value:t.frequency}),St(this,"frequency"),this.detune=new Tt({context:this.context,units:"cents",value:t.detune}),St(this,"detune"),this._partials=t.partials,this._partialCount=t.partialCount,this._type=t.type,t.partialCount&&t.type!=="custom"&&(this._type=this.baseType+t.partialCount.toString()),this.phase=t.phase}static getDefaults(){return Object.assign(ge.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(t){const o=this.toSeconds(t),l=new Co({context:this.context,onended:()=>this.onstop(this)});this._oscillator=l,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(o)}_stop(t){const o=this.toSeconds(t);this._oscillator&&this._oscillator.stop(o)}_restart(t){const o=this.toSeconds(t);return this.log("restart",o),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(o),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return he._periodicWaveCache.find(t=>{return t.phase===this._phase&&(o=t.partials,l=this._partials,o.length===l.length&&o.every((d,v)=>l[v]===d));var o,l});{const t=he._periodicWaveCache.find(o=>o.type===this._type&&o.phase===this._phase);return this._partialCount=t?t.partialCount:this._partialCount,t}}get type(){return this._type}set type(t){this._type=t;const o=["sine","square","sawtooth","triangle"].indexOf(t)!==-1;if(this._phase===0&&o)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=t);else{const l=this._getCachedPeriodicWave();if(It(l)){const{partials:d,wave:v}=l;this._wave=v,this._partials=d,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[d,v]=this._getRealImaginary(t,this._phase),y=this.context.createPeriodicWave(d,v);this._wave=y,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),he._periodicWaveCache.push({imag:v,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:d,type:this._type,wave:this._wave}),he._periodicWaveCache.length>100&&he._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(t){this.partialCount&&this._type!=="custom"&&t!=="custom"?this.type=t+this.partialCount:this.type=t}get partialCount(){return this._partialCount}set partialCount(t){Be(t,0);let o=this._type;const l=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(l&&(o=l[1]),this._type!=="custom")this.type=t===0?o:o+t.toString();else{const d=new Float32Array(t);this._partials.forEach((v,y)=>d[y]=v),this._partials=Array.from(d),this.type=this._type}}_getRealImaginary(t,o){let l=2048;const d=new Float32Array(l),v=new Float32Array(l);let y=1;if(t==="custom"){if(y=this._partials.length+1,this._partialCount=this._partials.length,l=y,this._partials.length===0)return[d,v]}else{const _=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(t);_?(y=parseInt(_[2],10)+1,this._partialCount=parseInt(_[2],10),t=_[1],y=Math.max(y,2),l=y):this._partialCount=0,this._partials=[]}for(let _=1;_<l;++_){const S=2/(_*Math.PI);let C;switch(t){case"sine":C=_<=y?1:0,this._partials[_-1]=C;break;case"square":C=1&_?2*S:0,this._partials[_-1]=C;break;case"sawtooth":C=S*(1&_?1:-1),this._partials[_-1]=C;break;case"triangle":C=1&_?S*S*2*(_-1>>1&1?-1:1):0,this._partials[_-1]=C;break;case"custom":C=this._partials[_-1];break;default:throw new TypeError("Oscillator: invalid type: "+t)}C!==0?(d[_]=-C*Math.sin(o*_),v[_]=C*Math.cos(o*_)):(d[_]=0,v[_]=0)}return[d,v]}_inverseFFT(t,o,l){let d=0;const v=t.length;for(let y=0;y<v;y++)d+=t[y]*Math.cos(y*l)+o[y]*Math.sin(y*l);return d}getInitialValue(){const[t,o]=this._getRealImaginary(this._type,0);let l=0;const d=2*Math.PI;for(let v=0;v<32;v++)l=Math.max(this._inverseFFT(t,o,v/32*d),l);return Un(-this._inverseFFT(t,o,this._phase)/l,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(t){this._phase=t*Math.PI/180,this.type=this._type}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Xn(this,t)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}he._periodicWaveCache=[];class Ga extends gs{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Bs({context:this.context,mapping:t=>(t+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class ue extends Tt{constructor(){const t=J(ue.getDefaults(),arguments,["value"]);super(t),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new bt({context:this.context,minValue:t.minValue,maxValue:t.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Tt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class To extends ge{constructor(){const t=J(To.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="AMOscillator",this._modulationScale=new Ga({context:this.context}),this._modulationNode=new bt({context:this.context}),this._carrier=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new he({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),St(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(he.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){this._modulator.restart(t),this._carrier.restart(t)}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Xn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class Oi extends ge{constructor(){const t=J(Oi.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="FMOscillator",this._modulationNode=new bt({context:this.context,gain:0}),this._carrier=new he({context:this.context,detune:t.detune,frequency:0,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.detune=this._carrier.detune,this.frequency=new Tt({context:this.context,units:"frequency",value:t.frequency}),this._modulator=new he({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this.modulationIndex=new ue({context:this.context,units:"positive",value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),St(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(he.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){return this._modulator.restart(t),this._carrier.restart(t),this}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Xn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Ni extends ge{constructor(){const t=J(Ni.getDefaults(),arguments,["frequency","width"]);super(t),this.name="PulseOscillator",this._widthGate=new bt({context:this.context,gain:0}),this._thresh=new Bs({context:this.context,mapping:o=>o<=0?-1:1}),this.width=new Tt({context:this.context,units:"audioRange",value:t.width}),this._triangle=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),St(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(ge.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(t){t=this.toSeconds(t),this._triangle.start(t),this._widthGate.gain.setValueAtTime(1,t)}_stop(t){t=this.toSeconds(t),this._triangle.stop(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(0,t)}_restart(t){this._triangle.restart(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(1,t)}get phase(){return this._triangle.phase}set phase(t){this._triangle.phase=t}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(t){this._triangle.type=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Xn(this,t)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Ao extends ge{constructor(){const t=J(Ao.getDefaults(),arguments,["frequency","type","spread"]);super(t),this.name="FatOscillator",this._oscillators=[],this.frequency=new Tt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Tt({context:this.context,units:"cents",value:t.detune}),this._spread=t.spread,this._type=t.type,this._phase=t.phase,this._partials=t.partials,this._partialCount=t.partialCount,this.count=t.count,St(this,["frequency","detune"])}static getDefaults(){return Object.assign(he.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(t){t=this.toSeconds(t),this._forEach(o=>o.start(t))}_stop(t){t=this.toSeconds(t),this._forEach(o=>o.stop(t))}_restart(t){this._forEach(o=>o.restart(t))}_forEach(t){for(let o=0;o<this._oscillators.length;o++)t(this._oscillators[o],o)}get type(){return this._type}set type(t){this._type=t,this._forEach(o=>o.type=t)}get spread(){return this._spread}set spread(t){if(this._spread=t,this._oscillators.length>1){const o=-t/2,l=t/(this._oscillators.length-1);this._forEach((d,v)=>d.detune.value=o+l*v)}}get count(){return this._oscillators.length}set count(t){if(Be(t,1),this._oscillators.length!==t){this._forEach(o=>o.dispose()),this._oscillators=[];for(let o=0;o<t;o++){const l=new he({context:this.context,volume:-6-1.1*t,type:this._type,phase:this._phase+o/t*360,partialCount:this._partialCount,onstop:o===0?()=>this.onstop(this):Dt});this.type==="custom"&&(l.partials=this._partials),this.frequency.connect(l.frequency),this.detune.connect(l.detune),l.detune.overridden=!1,l.connect(this.output),this._oscillators[o]=l}this.spread=this._spread,this.state==="started"&&this._forEach(o=>o.start())}}get phase(){return this._phase}set phase(t){this._phase=t,this._forEach((o,l)=>o.phase=this._phase+l/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(t){this._forEach(o=>o.baseType=t),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this._type="custom",this._forEach(o=>o.partials=t))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(t){this._partialCount=t,this._forEach(o=>o.partialCount=t),this._type=this._oscillators[0].type}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Xn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(t=>t.dispose()),this}}class Mo extends ge{constructor(){const t=J(Mo.getDefaults(),arguments,["frequency","modulationFrequency"]);super(t),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new ue({context:this.context,value:2}),this._pulse=new Ni({context:this.context,frequency:t.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),St(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(ge.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(t){t=this.toSeconds(t),this._modulator.start(t),this._pulse.start(t)}_stop(t){t=this.toSeconds(t),this._modulator.stop(t),this._pulse.stop(t)}_restart(t){this._modulator.restart(t),this._pulse.restart(t)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(t){this._modulator.phase=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Xn(this,t)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const $u={am:To,fat:Ao,fm:Oi,oscillator:he,pulse:Ni,pwm:Mo};class pn extends ge{constructor(){const t=J(pn.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OmniOscillator",this.frequency=new Tt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Tt({context:this.context,units:"cents",value:t.detune}),St(this,["frequency","detune"]),this.set(t)}static getDefaults(){return Object.assign(he.getDefaults(),Oi.getDefaults(),To.getDefaults(),Ao.getDefaults(),Ni.getDefaults(),Mo.getDefaults())}_start(t){this._oscillator.start(t)}_stop(t){this._oscillator.stop(t)}_restart(t){return this._oscillator.restart(t),this}get type(){let t="";return["am","fm","fat"].some(o=>this._sourceType===o)&&(t=this._sourceType),t+this._oscillator.type}set type(t){t.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(3)):t==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):t==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=t)}get partials(){return this._oscillator.partials}set partials(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=t)}get partialCount(){return this._oscillator.partialCount}set partialCount(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=t)}set(t){return Reflect.has(t,"type")&&t.type&&(this.type=t.type),super.set(t),this}_createNewOscillator(t){if(t!==this._sourceType){this._sourceType=t;const o=$u[t],l=this.now();if(this._oscillator){const d=this._oscillator;d.stop(l),this.context.setTimeout(()=>d.dispose(),this.blockTime)}this._oscillator=new o({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(l)}}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t}get sourceType(){return this._sourceType}set sourceType(t){let o="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(o=this._oscillator.type),t==="fm"?this.type="fm"+o:t==="am"?this.type="am"+o:t==="fat"?this.type="fat"+o:t==="oscillator"?this.type=o:t==="pulse"?this.type="pulse":t==="pwm"&&(this.type="pwm")}_getOscType(t,o){return t instanceof $u[o]}get baseType(){return this._oscillator.baseType}set baseType(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||t==="pulse"||t==="pwm"||(this._oscillator.baseType=t)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(t){this._getOscType(this._oscillator,"fat")&&hs(t)&&(this._oscillator.count=t)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(t){this._getOscType(this._oscillator,"fat")&&hs(t)&&(this._oscillator.spread=t)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(t){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Ns(t)&&(this._oscillator.modulationType=t)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Xn(this,t)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}class Yn extends Tt{constructor(){super(J(Yn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new bt({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,ms(this._constantSource,this._sum)}static getDefaults(){return Object.assign(Tt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class mn extends gs{constructor(){const t=J(mn.getDefaults(),arguments,["min","max"]);super(t),this.name="Scale",this._mult=this.input=new ue({context:this.context,value:t.max-t.min}),this._add=this.output=new Yn({context:this.context,value:t.min}),this._min=t.min,this._max=t.max,this.input.connect(this.output)}static getDefaults(){return Object.assign(gs.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(t){this._min=t,this._setRange()}get max(){return this._max}set max(t){this._max=t,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class ja extends gs{constructor(){super(J(ja.getDefaults(),arguments)),this.name="Zero",this._gain=new bt({context:this.context}),this.output=this._gain,this.input=void 0,Ke(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),gl(this.context.getConstant(0),this._gain),this}}class ts extends ot{constructor(){const t=J(ts.getDefaults(),arguments,["frequency","min","max"]);super(t),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=Et.prototype._fromType,this._toType=Et.prototype._toType,this._is=Et.prototype._is,this._clampValue=Et.prototype._clampValue,this._oscillator=new he(t),this.frequency=this._oscillator.frequency,this._amplitudeGain=new bt({context:this.context,gain:t.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new Tt({context:this.context,units:"audioRange",value:0}),this._zeros=new ja({context:this.context}),this._a2g=new Ga({context:this.context}),this._scaler=this.output=new mn({context:this.context,max:t.max,min:t.min}),this.units=t.units,this.min=t.min,this.max=t.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),St(this,["amplitude","frequency"]),this.phase=t.phase}static getDefaults(){return Object.assign(he.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(0,t),this._oscillator.start(t),this}stop(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(this._stoppedValue,t),this._oscillator.stop(t),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(t){t=this._fromType(t),this._scaler.min=t}get max(){return this._toType(this._scaler.max)}set max(t){t=this._fromType(t),this._scaler.max=t}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(t){this._oscillator.partials=t,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t,this._setStoppedValue()}get units(){return this._units}set units(t){const o=this.min,l=this.max;this._units=t,this.min=o,this.max=l}get state(){return this._oscillator.state}connect(t,o,l){return(t instanceof Et||t instanceof Tt)&&(this.convert=t.convert,this.units=t.units),xo(this,t,o,l),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}function qu(p,t=1/0){const o=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(v){Be(v,p,t),o.set(this,v)}})}}function fn(p,t=1/0){const o=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(v){Be(this.toSeconds(v),p,t),o.set(this,v)}})}}class Li extends ge{constructor(){const t=J(Li.getDefaults(),arguments,["url","onload"]);super(t),this.name="Player",this._activeSources=new Set,this._buffer=new qt({onload:this._onload.bind(this,t.onload),onerror:t.onerror,reverse:t.reverse,url:t.url}),this.autostart=t.autostart,this._loop=t.loop,this._loopStart=t.loopStart,this._loopEnd=t.loopEnd,this._playbackRate=t.playbackRate,this.fadeIn=t.fadeIn,this.fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ge.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Dt,onerror:Dt,playbackRate:1,reverse:!1})}load(t){return Kt(this,void 0,void 0,function*(){return yield this._buffer.load(t),this._onload(),this})}_onload(t=Dt){t(),this.autostart&&this.start()}_onSourceEnd(t){this.onstop(this),this._activeSources.delete(t),this._activeSources.size!==0||this._synced||this._state.getValueAtTime(this.now())!=="started"||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(t,o,l){return super.start(t,o,l),this}_start(t,o,l){o=this._loop?Ts(o,this._loopStart):Ts(o,0);const d=this.toSeconds(o),v=l;l=Ts(l,Math.max(this._buffer.duration-d,0));let y=this.toSeconds(l);y/=this._playbackRate,t=this.toSeconds(t);const _=new kn({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(t+y),this._state.setStateAtTime("stopped",t+y,{implicitEnd:!0})),this._activeSources.add(_),this._loop&&os(v)?_.start(t,d):_.start(t,d,y-this.toSeconds(this.fadeOut))}_stop(t){const o=this.toSeconds(t);this._activeSources.forEach(l=>l.stop(o))}restart(t,o,l){return super.restart(t,o,l),this}_restart(t,o,l){var d;(d=[...this._activeSources].pop())===null||d===void 0||d.stop(t),this._start(t,o,l)}seek(t,o){const l=this.toSeconds(o);if(this._state.getValueAtTime(l)==="started"){const d=this.toSeconds(t);this._stop(l),this._start(l,d)}return this}setLoopPoints(t,o){return this.loopStart=t,this.loopEnd=o,this}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this.buffer.loaded&&Be(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(o=>{o.loopStart=t})}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this.buffer.loaded&&Be(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(o=>{o.loopEnd=t})}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._loop}set loop(t){if(this._loop!==t&&(this._loop=t,this._activeSources.forEach(o=>{o.loop=t}),t)){const o=this._state.getNextState("stopped",this.now());o&&this._state.cancel(o.time)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t;const o=this.now(),l=this._state.getNextState("stopped",o);l&&l.implicitEnd&&(this._state.cancel(l.time),this._activeSources.forEach(d=>d.cancelStop())),this._activeSources.forEach(d=>{d.playbackRate.setValueAtTime(t,o)})}get reverse(){return this._buffer.reverse}set reverse(t){this._buffer.reverse=t}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(t=>t.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}Ls([fn(0)],Li.prototype,"fadeIn",void 0),Ls([fn(0)],Li.prototype,"fadeOut",void 0);class xl extends ot{constructor(){const t=J(xl.getDefaults(),arguments,["urls","onload"],"urls");super(t),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume"),this._buffers=new ki({urls:t.urls,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.mute=t.mute,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ge.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:Dt,onerror:Dt,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._players.forEach(o=>{o.fadeIn=t})}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._players.forEach(o=>{o.fadeOut=t})}get state(){return Array.from(this._players).some(([t,o])=>o.state==="started")?"started":"stopped"}has(t){return this._buffers.has(t)}player(t){if(wt(this.has(t),`No Player with the name ${t} exists on this object`),!this._players.has(t)){const o=new Li({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(t)}).connect(this.output);this._players.set(t,o)}return this._players.get(t)}get loaded(){return this._buffers.loaded}add(t,o,l){return wt(!this._buffers.has(t),"A buffer with that name already exists on this object"),this._buffers.add(t,o,l),this}stopAll(t){return this._players.forEach(o=>o.stop(t)),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach(t=>t.dispose()),this._buffers.dispose(),this}}class Sl extends ge{constructor(){const t=J(Sl.getDefaults(),arguments,["url","onload"]);super(t),this.name="GrainPlayer",this._loopStart=0,this._loopEnd=0,this._activeSources=[],this.buffer=new qt({onload:t.onload,onerror:t.onerror,reverse:t.reverse,url:t.url}),this._clock=new Pi({context:this.context,callback:this._tick.bind(this),frequency:1/t.grainSize}),this._playbackRate=t.playbackRate,this._grainSize=t.grainSize,this._overlap=t.overlap,this.detune=t.detune,this.overlap=t.overlap,this.loop=t.loop,this.playbackRate=t.playbackRate,this.grainSize=t.grainSize,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.reverse=t.reverse,this._clock.on("stop",this._onstop.bind(this))}static getDefaults(){return Object.assign(ge.getDefaults(),{onload:Dt,onerror:Dt,overlap:.1,grainSize:.2,playbackRate:1,detune:0,loop:!1,loopStart:0,loopEnd:0,reverse:!1})}_start(t,o,l){o=Ts(o,0),o=this.toSeconds(o),t=this.toSeconds(t);const d=1/this._clock.frequency.getValueAtTime(t);this._clock.start(t,o/d),l&&this.stop(t+this.toSeconds(l))}restart(t,o,l){return super.restart(t,o,l),this}_restart(t,o,l){this._stop(t),this._start(t,o,l)}_stop(t){this._clock.stop(t)}_onstop(t){this._activeSources.forEach(o=>{o.fadeOut=0,o.stop(t)}),this.onstop(this)}_tick(t){const o=this._clock.getTicksAtTime(t),l=o*this._grainSize;if(this.log("offset",l),!this.loop&&l>this.buffer.duration)return void this.stop(t);const d=l<this._overlap?0:this._overlap,v=new kn({context:this.context,url:this.buffer,fadeIn:d,fadeOut:this._overlap,loop:this.loop,loopStart:this._loopStart,loopEnd:this._loopEnd,playbackRate:Ai(this.detune/100)}).connect(this.output);v.start(t,this._grainSize*o),v.stop(t+this._grainSize/this.playbackRate),this._activeSources.push(v),v.onended=()=>{const y=this._activeSources.indexOf(v);y!==-1&&this._activeSources.splice(y,1)}}get playbackRate(){return this._playbackRate}set playbackRate(t){Be(t,.001),this._playbackRate=t,this.grainSize=this._grainSize}get loopStart(){return this._loopStart}set loopStart(t){this.buffer.loaded&&Be(this.toSeconds(t),0,this.buffer.duration),this._loopStart=this.toSeconds(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this.buffer.loaded&&Be(this.toSeconds(t),0,this.buffer.duration),this._loopEnd=this.toSeconds(t)}get reverse(){return this.buffer.reverse}set reverse(t){this.buffer.reverse=t}get grainSize(){return this._grainSize}set grainSize(t){this._grainSize=this.toSeconds(t),this._clock.frequency.setValueAtTime(this._playbackRate/this._grainSize,this.now())}get overlap(){return this._overlap}set overlap(t){const o=this.toSeconds(t);Be(o,0),this._overlap=o}get loaded(){return this.buffer.loaded}dispose(){return super.dispose(),this.buffer.dispose(),this._clock.dispose(),this._activeSources.forEach(t=>t.dispose()),this}}class zu extends gs{constructor(){super(...arguments),this.name="Abs",this._abs=new Bs({context:this.context,mapping:t=>Math.abs(t)<.001?0:Math.abs(t)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class Wu extends gs{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new Bs({context:this.context,mapping:t=>2*Math.abs(t)-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Cl extends gs{constructor(){super(...arguments),this.name="Negate",this._multiply=new ue({context:this.context,value:-1}),this.input=this._multiply,this.output=this._multiply}dispose(){return super.dispose(),this._multiply.dispose(),this}}class Zn extends Tt{constructor(){super(J(Zn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Subtract",this._sum=new bt({context:this.context}),this.input=this._sum,this.output=this._sum,this._neg=new Cl({context:this.context}),this.subtrahend=this._param,ms(this._constantSource,this._neg,this._sum)}static getDefaults(){return Object.assign(Tt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._neg.dispose(),this._sum.dispose(),this}}class Ua extends gs{constructor(){super(J(Ua.getDefaults(),arguments)),this.name="GreaterThanZero",this._thresh=this.output=new Bs({context:this.context,length:127,mapping:t=>t<=0?0:1}),this._scale=this.input=new ue({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class Xa extends Tt{constructor(){const t=J(Xa.getDefaults(),arguments,["value"]);super(t),this.name="GreaterThan",this.override=!1,this._subtract=this.input=new Zn({context:this.context,value:t.value}),this._gtz=this.output=new Ua({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,St(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(Tt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class Ya extends mn{constructor(){const t=J(Ya.getDefaults(),arguments,["min","max","exponent"]);super(t),this.name="ScaleExp",this.input=this._exp=new Ri({context:this.context,value:t.exponent}),this._exp.connect(this._mult)}static getDefaults(){return Object.assign(mn.getDefaults(),{exponent:1})}get exponent(){return this._exp.value}set exponent(t){this._exp.value=t}dispose(){return super.dispose(),this._exp.dispose(),this}}class Sg extends Tt{constructor(){const t=J(Tt.getDefaults(),arguments,["value","units"]);super(t),this.name="SyncedSignal",this.override=!1,this._lastVal=t.value,this._synced=this.context.transport.scheduleRepeat(this._onTick.bind(this),"1i"),this._syncedCallback=this._anchorValue.bind(this),this.context.transport.on("start",this._syncedCallback),this.context.transport.on("pause",this._syncedCallback),this.context.transport.on("stop",this._syncedCallback),this._constantSource.disconnect(),this._constantSource.stop(0),this._constantSource=this.output=new Va({context:this.context,offset:t.value,units:t.units}).start(0),this.setValueAtTime(t.value,0)}_onTick(t){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal!==o&&(this._lastVal=o,this._constantSource.offset.setValueAtTime(o,t))}_anchorValue(t){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal=o,this._constantSource.offset.cancelAndHoldAtTime(t),this._constantSource.offset.setValueAtTime(o,t)}getValueAtTime(t){const o=new xe(this.context,t).toSeconds();return super.getValueAtTime(o)}setValueAtTime(t,o){const l=new xe(this.context,o).toSeconds();return super.setValueAtTime(t,l),this}linearRampToValueAtTime(t,o){const l=new xe(this.context,o).toSeconds();return super.linearRampToValueAtTime(t,l),this}exponentialRampToValueAtTime(t,o){const l=new xe(this.context,o).toSeconds();return super.exponentialRampToValueAtTime(t,l),this}setTargetAtTime(t,o,l){const d=new xe(this.context,o).toSeconds();return super.setTargetAtTime(t,d,l),this}cancelScheduledValues(t){const o=new xe(this.context,t).toSeconds();return super.cancelScheduledValues(o),this}setValueCurveAtTime(t,o,l,d){const v=new xe(this.context,o).toSeconds();return l=this.toSeconds(l),super.setValueCurveAtTime(t,v,l,d),this}cancelAndHoldAtTime(t){const o=new xe(this.context,t).toSeconds();return super.cancelAndHoldAtTime(o),this}setRampPoint(t){const o=new xe(this.context,t).toSeconds();return super.setRampPoint(o),this}exponentialRampTo(t,o,l){const d=new xe(this.context,l).toSeconds();return super.exponentialRampTo(t,o,d),this}linearRampTo(t,o,l){const d=new xe(this.context,l).toSeconds();return super.linearRampTo(t,o,d),this}targetRampTo(t,o,l){const d=new xe(this.context,l).toSeconds();return super.targetRampTo(t,o,d),this}dispose(){return super.dispose(),this.context.transport.clear(this._synced),this.context.transport.off("start",this._syncedCallback),this.context.transport.off("pause",this._syncedCallback),this.context.transport.off("stop",this._syncedCallback),this._constantSource.dispose(),this}}class qe extends ot{constructor(){const t=J(qe.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="Envelope",this._sig=new Tt({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=t.attack,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.attackCurve=t.attackCurve,this.releaseCurve=t.releaseCurve,this.decayCurve=t.decayCurve}static getDefaults(){return Object.assign(ot.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(t,o){if(Ns(t))return t;{let l;for(l in Za)if(Za[l][o]===t)return l;return t}}_setCurve(t,o,l){if(Ns(l)&&Reflect.has(Za,l)){const d=Za[l];cn(d)?t!=="_decayCurve"&&(this[t]=d[o]):this[t]=d}else{if(!Fe(l)||t==="_decayCurve")throw new Error("Envelope: invalid curve: "+l);this[t]=l}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(t){this._setCurve("_attackCurve","In",t)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(t){this._setCurve("_releaseCurve","Out",t)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(t){this._setCurve("_decayCurve","Out",t)}triggerAttack(t,o=1){this.log("triggerAttack",t,o),t=this.toSeconds(t);let l=this.toSeconds(this.attack);const d=this.toSeconds(this.decay),v=this.getValueAtTime(t);if(v>0&&(l=(1-v)/(1/l)),l<this.sampleTime)this._sig.cancelScheduledValues(t),this._sig.setValueAtTime(o,t);else if(this._attackCurve==="linear")this._sig.linearRampTo(o,l,t);else if(this._attackCurve==="exponential")this._sig.targetRampTo(o,l,t);else{this._sig.cancelAndHoldAtTime(t);let y=this._attackCurve;for(let _=1;_<y.length;_++)if(y[_-1]<=v&&v<=y[_]){y=this._attackCurve.slice(_),y[0]=v;break}this._sig.setValueCurveAtTime(y,t,l,o)}if(d&&this.sustain<1){const y=o*this.sustain,_=t+l;this.log("decay",_),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(y,d+_):this._sig.exponentialApproachValueAtTime(y,_,d)}return this}triggerRelease(t){this.log("triggerRelease",t),t=this.toSeconds(t);const o=this.getValueAtTime(t);if(o>0){const l=this.toSeconds(this.release);l<this.sampleTime?this._sig.setValueAtTime(0,t):this._releaseCurve==="linear"?this._sig.linearRampTo(0,l,t):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,l,t):(wt(Fe(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(t),this._sig.setValueCurveAtTime(this._releaseCurve,t,l,o))}return this}getValueAtTime(t){return this._sig.getValueAtTime(t)}triggerAttackRelease(t,o,l=1){return o=this.toSeconds(o),this.triggerAttack(o,l),this.triggerRelease(o+this.toSeconds(t)),this}cancel(t){return this._sig.cancelScheduledValues(this.toSeconds(t)),this}connect(t,o=0,l=0){return xo(this,t,o,l),this}asArray(){return Kt(this,arguments,void 0,function*(t=1024){const o=t/this.context.sampleRate,l=new Ci(1,o,this.context.sampleRate),d=this.toSeconds(this.attack)+this.toSeconds(this.decay),v=d+this.toSeconds(this.release),y=.1*v,_=v+y,S=new this.constructor(Object.assign(this.get(),{attack:o*this.toSeconds(this.attack)/_,decay:o*this.toSeconds(this.decay)/_,release:o*this.toSeconds(this.release)/_,context:l}));return S._sig.toDestination(),S.triggerAttackRelease(o*(d+y)/_,0),(yield l.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}Ls([fn(0)],qe.prototype,"attack",void 0),Ls([fn(0)],qe.prototype,"decay",void 0),Ls([qu(0,1)],qe.prototype,"sustain",void 0),Ls([fn(0)],qe.prototype,"release",void 0);const Za=(()=>{let t,o;const l=[];for(t=0;t<128;t++)l[t]=Math.sin(t/127*(Math.PI/2));const d=[];for(t=0;t<127;t++){o=t/127;const E=Math.sin(o*(2*Math.PI)*6.4-Math.PI/2)+1;d[t]=E/10+.83*o}d[127]=1;const v=[];for(t=0;t<128;t++)v[t]=Math.ceil(t/127*5)/5;const y=[];for(t=0;t<128;t++)o=t/127,y[t]=.5*(1-Math.cos(Math.PI*o));const _=[];for(t=0;t<128;t++){o=t/127;const E=4*Math.pow(o,3)+.2,k=Math.cos(E*Math.PI*2*o);_[t]=Math.abs(k*(1-o))}function S(E){const k=new Array(E.length);for(let O=0;O<E.length;O++)k[O]=1-E[O];return k}return{bounce:{In:S(_),Out:_},cosine:{In:l,Out:(C=l,C.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:d,Out:S(d)},sine:{In:y,Out:S(y)},step:{In:v,Out:S(v)}};var C})();class As extends ot{constructor(){const t=J(As.getDefaults(),arguments);super(t),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=o=>this._original_triggerRelease(o),this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume")}static getDefaults(){return Object.assign(ot.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let t=!1;return this._synced||(this._synced=!0,t=!0),t}_syncMethod(t,o){const l=this["_original_"+t]=this[t];this[t]=(...d)=>{const v=d[o],y=this.context.transport.schedule(_=>{d[o]=_,l.apply(this,d)},v);this._scheduledEvents.push(y)}}unsync(){return this._scheduledEvents.forEach(t=>this.context.transport.clear(t)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(t,o,l,d){const v=this.toSeconds(l),y=this.toSeconds(o);return this.triggerAttack(t,v,d),this.triggerRelease(v+y),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class ze extends As{constructor(){const t=J(ze.getDefaults(),arguments);super(t),this.portamento=t.portamento,this.onsilence=t.onsilence}static getDefaults(){return Object.assign(As.getDefaults(),{detune:0,onsilence:Dt,portamento:0})}triggerAttack(t,o,l=1){this.log("triggerAttack",t,o,l);const d=this.toSeconds(o);return this._triggerEnvelopeAttack(d,l),this.setNote(t,d),this}triggerRelease(t){this.log("triggerRelease",t);const o=this.toSeconds(t);return this._triggerEnvelopeRelease(o),this}setNote(t,o){const l=this.toSeconds(o),d=t instanceof Je?t.toFrequency():t;if(this.portamento>0&&this.getLevelAtTime(l)>.05){const v=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(d,v,l)}else this.frequency.setValueAtTime(d,l);return this}}Ls([fn(0)],ze.prototype,"portamento",void 0);class Fi extends qe{constructor(){super(J(Fi.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new bt({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Rn extends ze{constructor(){const t=J(Rn.getDefaults(),arguments);super(t),this.name="Synth",this.oscillator=new pn(Object.assign({context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)},t.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Fi(Object.assign({context:this.context},t.envelope)),this.oscillator.chain(this.envelope,this.output),St(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(ze.getDefaults(),{envelope:Object.assign($e(qe.getDefaults(),Object.keys(ot.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign($e(pn.getDefaults(),[...Object.keys(ge.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(t,o){if(this.envelope.triggerAttack(t,o),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class Eo extends ze{constructor(){const t=J(Eo.getDefaults(),arguments);super(t),this.name="ModulationSynth",this._carrier=new Rn({context:this.context,oscillator:t.oscillator,envelope:t.envelope,onsilence:()=>this.onsilence(this),volume:-10}),this._modulator=new Rn({context:this.context,oscillator:t.modulation,envelope:t.modulationEnvelope,volume:-10}),this.oscillator=this._carrier.oscillator,this.envelope=this._carrier.envelope,this.modulation=this._modulator.oscillator,this.modulationEnvelope=this._modulator.envelope,this.frequency=new Tt({context:this.context,units:"frequency"}),this.detune=new Tt({context:this.context,value:t.detune,units:"cents"}),this.harmonicity=new ue({context:this.context,value:t.harmonicity,minValue:0}),this._modulationNode=new bt({context:this.context,gain:0}),St(this,["frequency","harmonicity","oscillator","envelope","modulation","modulationEnvelope","detune"])}static getDefaults(){return Object.assign(ze.getDefaults(),{harmonicity:3,oscillator:Object.assign($e(pn.getDefaults(),[...Object.keys(ge.getDefaults()),"frequency","detune"]),{type:"sine"}),envelope:Object.assign($e(qe.getDefaults(),Object.keys(ot.getDefaults())),{attack:.01,decay:.01,sustain:1,release:.5}),modulation:Object.assign($e(pn.getDefaults(),[...Object.keys(ge.getDefaults()),"frequency","detune"]),{type:"square"}),modulationEnvelope:Object.assign($e(qe.getDefaults(),Object.keys(ot.getDefaults())),{attack:.5,decay:0,sustain:1,release:.5})})}_triggerEnvelopeAttack(t,o){this._carrier._triggerEnvelopeAttack(t,o),this._modulator._triggerEnvelopeAttack(t,o)}_triggerEnvelopeRelease(t){return this._carrier._triggerEnvelopeRelease(t),this._modulator._triggerEnvelopeRelease(t),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this._carrier.dispose(),this._modulator.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._modulationNode.dispose(),this}}class Tl extends Eo{constructor(){super(J(Tl.getDefaults(),arguments)),this.name="AMSynth",this._modulationScale=new Ga({context:this.context}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output)}dispose(){return super.dispose(),this._modulationScale.dispose(),this}}class Po extends ot{constructor(){const t=J(Po.getDefaults(),arguments,["frequency","type"]);super(t),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new Et({context:this.context,units:"number",value:t.Q,param:this._filter.Q}),this.frequency=new Et({context:this.context,units:"frequency",value:t.frequency,param:this._filter.frequency}),this.detune=new Et({context:this.context,units:"cents",value:t.detune,param:this._filter.detune}),this.gain=new Et({context:this.context,units:"decibels",convert:!1,value:t.gain,param:this._filter.gain}),this.type=t.type}static getDefaults(){return Object.assign(ot.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(t){wt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._filter.type=t}getFrequencyResponse(t=128){const o=new Float32Array(t);for(let y=0;y<t;y++){const _=19980*Math.pow(y/t,2)+20;o[y]=_}const l=new Float32Array(t),d=new Float32Array(t),v=this.context.createBiquadFilter();return v.type=this.type,v.Q.value=this.Q.value,v.frequency.value=this.frequency.value,v.gain.value=this.gain.value,v.getFrequencyResponse(o,l,d),l}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class vs extends ot{constructor(){const t=J(vs.getDefaults(),arguments,["frequency","type","rolloff"]);super(t),this.name="Filter",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this._filters=[],this._filters=[],this.Q=new Tt({context:this.context,units:"positive",value:t.Q}),this.frequency=new Tt({context:this.context,units:"frequency",value:t.frequency}),this.detune=new Tt({context:this.context,units:"cents",value:t.detune}),this.gain=new Tt({context:this.context,units:"decibels",convert:!1,value:t.gain}),this._type=t.type,this.rolloff=t.rolloff,St(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(ot.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(t){wt(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._type=t,this._filters.forEach(o=>o.type=t)}get rolloff(){return this._rolloff}set rolloff(t){const o=hs(t)?t:parseInt(t,10),l=[-12,-24,-48,-96];let d=l.indexOf(o);wt(d!==-1,`rolloff can only be ${l.join(", ")}`),d+=1,this._rolloff=o,this.input.disconnect(),this._filters.forEach(v=>v.disconnect()),this._filters=new Array(d);for(let v=0;v<d;v++){const y=new Po({context:this.context});y.type=this._type,this.frequency.connect(y.frequency),this.detune.connect(y.detune),this.Q.connect(y.Q),this.gain.connect(y.gain),this._filters[v]=y}this._internalChannels=this._filters,ms(this.input,...this._internalChannels,this.output)}getFrequencyResponse(t=128){const o=new Po({frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),l=new Float32Array(t).map(()=>1);return this._filters.forEach(()=>{o.getFrequencyResponse(t).forEach((d,v)=>l[v]*=d)}),o.dispose(),l}dispose(){return super.dispose(),this._filters.forEach(t=>{t.dispose()}),bo(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class ko extends qe{constructor(){const t=J(ko.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="FrequencyEnvelope",this._octaves=t.octaves,this._baseFrequency=this.toFrequency(t.baseFrequency),this._exponent=this.input=new Ri({context:this.context,value:t.exponent}),this._scale=this.output=new mn({context:this.context,min:this._baseFrequency,max:this._baseFrequency*Math.pow(2,this._octaves)}),this._sig.chain(this._exponent,this._scale)}static getDefaults(){return Object.assign(qe.getDefaults(),{baseFrequency:200,exponent:1,octaves:4})}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){const o=this.toFrequency(t);Be(o,0),this._baseFrequency=o,this._scale.min=this._baseFrequency,this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._scale.max=this._baseFrequency*Math.pow(2,t)}get exponent(){return this._exponent.value}set exponent(t){this._exponent.value=t}dispose(){return super.dispose(),this._exponent.dispose(),this._scale.dispose(),this}}class Qn extends ze{constructor(){const t=J(Qn.getDefaults(),arguments);super(t),this.name="MonoSynth",this.oscillator=new pn(Object.assign(t.oscillator,{context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)})),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.filter=new vs(Object.assign(t.filter,{context:this.context})),this.filterEnvelope=new ko(Object.assign(t.filterEnvelope,{context:this.context})),this.envelope=new Fi(Object.assign(t.envelope,{context:this.context})),this.oscillator.chain(this.filter,this.envelope,this.output),this.filterEnvelope.connect(this.filter.frequency),St(this,["oscillator","frequency","detune","filter","filterEnvelope","envelope"])}static getDefaults(){return Object.assign(ze.getDefaults(),{envelope:Object.assign($e(qe.getDefaults(),Object.keys(ot.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.9}),filter:Object.assign($e(vs.getDefaults(),Object.keys(ot.getDefaults())),{Q:1,rolloff:-12,type:"lowpass"}),filterEnvelope:Object.assign($e(ko.getDefaults(),Object.keys(ot.getDefaults())),{attack:.6,baseFrequency:200,decay:.2,exponent:2,octaves:3,release:2,sustain:.5}),oscillator:Object.assign($e(pn.getDefaults(),Object.keys(ge.getDefaults())),{type:"sawtooth"})})}_triggerEnvelopeAttack(t,o=1){if(this.envelope.triggerAttack(t,o),this.filterEnvelope.triggerAttack(t),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.filterEnvelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this.filterEnvelope.dispose(),this.filter.dispose(),this}}class Al extends ze{constructor(){const t=J(Al.getDefaults(),arguments);super(t),this.name="DuoSynth",this.voice0=new Qn(Object.assign(t.voice0,{context:this.context,onsilence:()=>this.onsilence(this)})),this.voice1=new Qn(Object.assign(t.voice1,{context:this.context})),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this._vibrato=new ts({frequency:t.vibratoRate,context:this.context,min:-50,max:50}),this._vibrato.start(),this.vibratoRate=this._vibrato.frequency,this._vibratoGain=new bt({context:this.context,units:"normalRange",gain:t.vibratoAmount}),this.vibratoAmount=this._vibratoGain.gain,this.frequency=new Tt({context:this.context,units:"frequency",value:440}),this.detune=new Tt({context:this.context,units:"cents",value:t.detune}),this.frequency.connect(this.voice0.frequency),this.frequency.chain(this.harmonicity,this.voice1.frequency),this._vibrato.connect(this._vibratoGain),this._vibratoGain.fan(this.voice0.detune,this.voice1.detune),this.detune.fan(this.voice0.detune,this.voice1.detune),this.voice0.connect(this.output),this.voice1.connect(this.output),St(this,["voice0","voice1","frequency","vibratoAmount","vibratoRate"])}getLevelAtTime(t){return t=this.toSeconds(t),this.voice0.envelope.getValueAtTime(t)+this.voice1.envelope.getValueAtTime(t)}static getDefaults(){return Cs(ze.getDefaults(),{vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:Cs($e(Qn.getDefaults(),Object.keys(ze.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}}),voice1:Cs($e(Qn.getDefaults(),Object.keys(ze.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}})})}_triggerEnvelopeAttack(t,o){this.voice0._triggerEnvelopeAttack(t,o),this.voice1._triggerEnvelopeAttack(t,o)}_triggerEnvelopeRelease(t){return this.voice0._triggerEnvelopeRelease(t),this.voice1._triggerEnvelopeRelease(t),this}dispose(){return super.dispose(),this.voice0.dispose(),this.voice1.dispose(),this.frequency.dispose(),this.detune.dispose(),this._vibrato.dispose(),this.vibratoRate.dispose(),this._vibratoGain.dispose(),this.harmonicity.dispose(),this}}class Ml extends Eo{constructor(){const t=J(Ml.getDefaults(),arguments);super(t),this.name="FMSynth",this.modulationIndex=new ue({context:this.context,value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output)}static getDefaults(){return Object.assign(Eo.getDefaults(),{modulationIndex:10})}dispose(){return super.dispose(),this.modulationIndex.dispose(),this}}const Vu=[1,1.483,1.932,2.546,2.63,3.897];class El extends ze{constructor(){const t=J(El.getDefaults(),arguments);super(t),this.name="MetalSynth",this._oscillators=[],this._freqMultipliers=[],this.detune=new Tt({context:this.context,units:"cents",value:t.detune}),this.frequency=new Tt({context:this.context,units:"frequency"}),this._amplitude=new bt({context:this.context,gain:0}).connect(this.output),this._highpass=new vs({Q:0,context:this.context,type:"highpass"}).connect(this._amplitude);for(let o=0;o<Vu.length;o++){const l=new Oi({context:this.context,harmonicity:t.harmonicity,modulationIndex:t.modulationIndex,modulationType:"square",onstop:o===0?()=>this.onsilence(this):Dt,type:"square"});l.connect(this._highpass),this._oscillators[o]=l;const d=new ue({context:this.context,value:Vu[o]});this._freqMultipliers[o]=d,this.frequency.chain(d,l.frequency),this.detune.connect(l.detune)}this._filterFreqScaler=new mn({context:this.context,max:7e3,min:this.toFrequency(t.resonance)}),this.envelope=new qe({attack:t.envelope.attack,attackCurve:"linear",context:this.context,decay:t.envelope.decay,release:t.envelope.release,sustain:0}),this.envelope.chain(this._filterFreqScaler,this._highpass.frequency),this.envelope.connect(this._amplitude.gain),this._octaves=t.octaves,this.octaves=t.octaves}static getDefaults(){return Cs(ze.getDefaults(),{envelope:Object.assign($e(qe.getDefaults(),Object.keys(ot.getDefaults())),{attack:.001,decay:1.4,release:.2}),harmonicity:5.1,modulationIndex:32,octaves:1.5,resonance:4e3})}_triggerEnvelopeAttack(t,o=1){return this.envelope.triggerAttack(t,o),this._oscillators.forEach(l=>l.start(t)),this.envelope.sustain===0&&this._oscillators.forEach(l=>{l.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay))}),this}_triggerEnvelopeRelease(t){return this.envelope.triggerRelease(t),this._oscillators.forEach(o=>o.stop(t+this.toSeconds(this.envelope.release))),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}get modulationIndex(){return this._oscillators[0].modulationIndex.value}set modulationIndex(t){this._oscillators.forEach(o=>o.modulationIndex.value=t)}get harmonicity(){return this._oscillators[0].harmonicity.value}set harmonicity(t){this._oscillators.forEach(o=>o.harmonicity.value=t)}get resonance(){return this._filterFreqScaler.min}set resonance(t){this._filterFreqScaler.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._filterFreqScaler.max=this._filterFreqScaler.min*Math.pow(2,t)}dispose(){return super.dispose(),this._oscillators.forEach(t=>t.dispose()),this._freqMultipliers.forEach(t=>t.dispose()),this.frequency.dispose(),this.detune.dispose(),this._filterFreqScaler.dispose(),this._amplitude.dispose(),this.envelope.dispose(),this._highpass.dispose(),this}}class Io extends Rn{constructor(){const t=J(Io.getDefaults(),arguments);super(t),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=t.pitchDecay,this.octaves=t.octaves,St(this,["oscillator","envelope"])}static getDefaults(){return Cs(ze.getDefaults(),Rn.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(t,o){const l=this.toSeconds(o),d=this.toFrequency(t instanceof Je?t.toFrequency():t),v=d*this.octaves;return this.oscillator.frequency.setValueAtTime(v,l),this.oscillator.frequency.exponentialRampToValueAtTime(d,l+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}Ls([qu(0)],Io.prototype,"octaves",void 0),Ls([fn(0)],Io.prototype,"pitchDecay",void 0);class Pl extends As{constructor(){const t=J(Pl.getDefaults(),arguments);super(t),this.name="NoiseSynth",this.noise=new In(Object.assign({context:this.context},t.noise)),this.envelope=new Fi(Object.assign({context:this.context},t.envelope)),this.noise.chain(this.envelope,this.output)}static getDefaults(){return Object.assign(As.getDefaults(),{envelope:Object.assign($e(qe.getDefaults(),Object.keys(ot.getDefaults())),{decay:.1,sustain:0}),noise:Object.assign($e(In.getDefaults(),Object.keys(ge.getDefaults())),{type:"white"})})}triggerAttack(t,o=1){return t=this.toSeconds(t),this.envelope.triggerAttack(t,o),this.noise.start(t),this.envelope.sustain===0&&this.noise.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay)),this}triggerRelease(t){return t=this.toSeconds(t),this.envelope.triggerRelease(t),this.noise.stop(t+this.toSeconds(this.envelope.release)),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",0),this._syncMethod("triggerRelease",0)),this}triggerAttackRelease(t,o,l=1){return o=this.toSeconds(o),t=this.toSeconds(t),this.triggerAttack(o,l),this.triggerRelease(o+t),this}dispose(){return super.dispose(),this.noise.dispose(),this.envelope.dispose(),this}}const kl=new Set;function Il(p){kl.add(p)}function Hu(p,t){const o=`registerProcessor("${p}", ${t})`;kl.add(o)}class Rl extends ot{constructor(t){super(t),this.name="ToneAudioWorklet",this.workletOptions={},this.onprocessorerror=Dt;const o=URL.createObjectURL(new Blob([Array.from(kl).join(`
`)],{type:"text/javascript"})),l=this._audioWorkletName();this._dummyGain=this.context.createGain(),this._dummyParam=this._dummyGain.gain,this.context.addAudioWorkletModule(o).then(()=>{this.disposed||(this._worklet=this.context.createAudioWorkletNode(l,this.workletOptions),this._worklet.onprocessorerror=this.onprocessorerror.bind(this),this.onReady(this._worklet))})}dispose(){return super.dispose(),this._dummyGain.disconnect(),this._worklet&&(this._worklet.port.postMessage("dispose"),this._worklet.disconnect()),this}}Il(`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`),Il(`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`),Il(`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`);const Gu="feedback-comb-filter";Hu(Gu,`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`);class Ro extends Rl{constructor(){const t=J(Ro.getDefaults(),arguments,["delayTime","resonance"]);super(t),this.name="FeedbackCombFilter",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this.delayTime=new Et({context:this.context,value:t.delayTime,units:"time",minValue:0,maxValue:1,param:this._dummyParam,swappable:!0}),this.resonance=new Et({context:this.context,value:t.resonance,units:"normalRange",param:this._dummyParam,swappable:!0}),St(this,["resonance","delayTime"])}_audioWorkletName(){return Gu}static getDefaults(){return Object.assign(ot.getDefaults(),{delayTime:.1,resonance:.5})}onReady(t){ms(this.input,t,this.output);const o=t.parameters.get("delayTime");this.delayTime.setParam(o);const l=t.parameters.get("feedback");this.resonance.setParam(l)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.delayTime.dispose(),this.resonance.dispose(),this}}class Do extends ot{constructor(){const t=J(Do.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OnePoleFilter",this._frequency=t.frequency,this._type=t.type,this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this._createFilter()}static getDefaults(){return Object.assign(ot.getDefaults(),{frequency:880,type:"lowpass"})}_createFilter(){const t=this._filter,o=this.toFrequency(this._frequency),l=1/(2*Math.PI*o);if(this._type==="lowpass"){const d=1/(l*this.context.sampleRate),v=d-1;this._filter=this.context.createIIRFilter([d,0],[1,v])}else{const d=1/(l*this.context.sampleRate)-1;this._filter=this.context.createIIRFilter([1,-1],[1,d])}this.input.chain(this._filter,this.output),t&&this.context.setTimeout(()=>{this.disposed||(this.input.disconnect(t),t.disconnect())},this.blockTime)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._createFilter()}get type(){return this._type}set type(t){this._type=t,this._createFilter()}getFrequencyResponse(t=128){const o=new Float32Array(t);for(let v=0;v<t;v++){const y=19980*Math.pow(v/t,2)+20;o[v]=y}const l=new Float32Array(t),d=new Float32Array(t);return this._filter.getFrequencyResponse(o,l,d),l}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this._filter.disconnect(),this}}class Oo extends ot{constructor(){const t=J(Oo.getDefaults(),arguments,["delayTime","resonance","dampening"]);super(t),this.name="LowpassCombFilter",this._combFilter=this.output=new Ro({context:this.context,delayTime:t.delayTime,resonance:t.resonance}),this.delayTime=this._combFilter.delayTime,this.resonance=this._combFilter.resonance,this._lowpass=this.input=new Do({context:this.context,frequency:t.dampening,type:"lowpass"}),this._lowpass.connect(this._combFilter)}static getDefaults(){return Object.assign(ot.getDefaults(),{dampening:3e3,delayTime:.1,resonance:.5})}get dampening(){return this._lowpass.frequency}set dampening(t){this._lowpass.frequency=t}dispose(){return super.dispose(),this._combFilter.dispose(),this._lowpass.dispose(),this}}class Dl extends As{constructor(){const t=J(Dl.getDefaults(),arguments);super(t),this.name="PluckSynth",this._noise=new In({context:this.context,type:"pink"}),this.attackNoise=t.attackNoise,this._lfcf=new Oo({context:this.context,dampening:t.dampening,resonance:t.resonance}),this.resonance=t.resonance,this.release=t.release,this._noise.connect(this._lfcf),this._lfcf.connect(this.output)}static getDefaults(){return Cs(As.getDefaults(),{attackNoise:1,dampening:4e3,resonance:.7,release:1})}get dampening(){return this._lfcf.dampening}set dampening(t){this._lfcf.dampening=t}triggerAttack(t,o){const l=this.toFrequency(t);o=this.toSeconds(o);const d=1/l;return this._lfcf.delayTime.setValueAtTime(d,o),this._noise.start(o),this._noise.stop(o+d*this.attackNoise),this._lfcf.resonance.cancelScheduledValues(o),this._lfcf.resonance.setValueAtTime(this.resonance,o),this}triggerRelease(t){return this._lfcf.resonance.linearRampTo(0,this.release,t),this}dispose(){return super.dispose(),this._noise.dispose(),this._lfcf.dispose(),this}}class Ol extends As{constructor(){const t=J(Ol.getDefaults(),arguments,["voice","options"]);super(t),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=d=>this.releaseAll(d),wt(!hs(t.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const o=t.voice.getDefaults();this.options=Object.assign(o,t.options),this.voice=t.voice,this.maxPolyphony=t.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const l=this._voices.indexOf(this._dummyVoice);this._voices.splice(l,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(As.getDefaults(),{maxPolyphony:32,options:{},voice:Rn})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(t){this._availableVoices.push(t);const o=this._activeVoices.findIndex(l=>l.voice===t);this._activeVoices.splice(o,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const t=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return wt(t instanceof ze,"Voice must extend Monophonic class"),t.connect(this.output),this._voices.push(t),t}bi("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(.95*this._averageActiveVoices,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const t=this._availableVoices.shift(),o=this._voices.indexOf(t);this._voices.splice(o,1),this.context.isOffline||t.dispose()}}_triggerAttack(t,o,l){t.forEach(d=>{const v=new Ii(this.context,d).toMidi(),y=this._getNextAvailableVoice();y&&(y.triggerAttack(d,o,l),this._activeVoices.push({midi:v,voice:y,released:!1}),this.log("triggerAttack",d,o))})}_triggerRelease(t,o){t.forEach(l=>{const d=new Ii(this.context,l).toMidi(),v=this._activeVoices.find(({midi:y,released:_})=>y===d&&!_);v&&(v.voice.triggerRelease(o),v.released=!0,this.log("triggerRelease",l,o))})}_scheduleEvent(t,o,l,d){wt(!this.disposed,"Synth was already disposed"),l<=this.now()?t==="attack"?this._triggerAttack(o,l,d):this._triggerRelease(o,l):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(t,o,l,d)},l-this.now())}triggerAttack(t,o,l){Array.isArray(t)||(t=[t]);const d=this.toSeconds(o);return this._scheduleEvent("attack",t,d,l),this}triggerRelease(t,o){Array.isArray(t)||(t=[t]);const l=this.toSeconds(o);return this._scheduleEvent("release",t,l),this}triggerAttackRelease(t,o,l,d){const v=this.toSeconds(l);if(this.triggerAttack(t,v,d),Fe(o)){wt(Fe(t),"If the duration is an array, the notes must also be an array");for(let y=0;y<t.length;y++){const _=o[Math.min(y,o.length-1)],S=this.toSeconds(_);wt(S>0,"The duration must be greater than 0"),this.triggerRelease(t[y],v+S)}}else{const y=this.toSeconds(o);wt(y>0,"The duration must be greater than 0"),this.triggerRelease(t,v+y)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(t){const o=$e(t,["onsilence","context"]);return this.options=Cs(this.options,o),this._voices.forEach(l=>l.set(o)),this._dummyVoice.set(o),this}get(){return this._dummyVoice.get()}releaseAll(t){const o=this.toSeconds(t);return this._activeVoices.forEach(({voice:l})=>{l.triggerRelease(o)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(t=>t.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class No extends As{constructor(){const t=J(No.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(t),this.name="Sampler",this._activeSources=new Map;const o={};Object.keys(t.urls).forEach(l=>{const d=parseInt(l,10);if(wt(yo(l)||hs(d)&&isFinite(d),`url key is neither a note or midi pitch: ${l}`),yo(l)){const v=new Je(this.context,l).toMidi();o[v]=t.urls[l]}else hs(d)&&isFinite(d)&&(o[d]=t.urls[d])}),this._buffers=new ki({urls:o,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.attack=t.attack,this.release=t.release,this.curve=t.curve,this._buffers.loaded&&Promise.resolve().then(t.onload)}static getDefaults(){return Object.assign(As.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Dt,onerror:Dt,release:.1,urls:{}})}_findClosest(t){let o=0;for(;o<96;){if(this._buffers.has(t+o))return-o;if(this._buffers.has(t-o))return o;o++}throw new Error(`No available buffers for note: ${t}`)}triggerAttack(t,o,l=1){return this.log("triggerAttack",t,o,l),Array.isArray(t)||(t=[t]),t.forEach(d=>{const v=Lu(new Je(this.context,d).toFrequency()),y=Math.round(v),_=v-y,S=this._findClosest(y),C=y-S,E=this._buffers.get(C),k=Ai(S+_),O=new kn({url:E,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:k}).connect(this.output);O.start(o,0,E.duration/k,l),Fe(this._activeSources.get(y))||this._activeSources.set(y,[]),this._activeSources.get(y).push(O),O.onended=()=>{if(this._activeSources&&this._activeSources.has(y)){const N=this._activeSources.get(y),q=N.indexOf(O);q!==-1&&N.splice(q,1)}}}),this}triggerRelease(t,o){return this.log("triggerRelease",t,o),Array.isArray(t)||(t=[t]),t.forEach(l=>{const d=new Je(this.context,l).toMidi();if(this._activeSources.has(d)&&this._activeSources.get(d).length){const v=this._activeSources.get(d);o=this.toSeconds(o),v.forEach(y=>{y.stop(o)}),this._activeSources.set(d,[])}}),this}releaseAll(t){const o=this.toSeconds(t);return this._activeSources.forEach(l=>{for(;l.length;)l.shift().stop(o)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(t,o,l,d=1){const v=this.toSeconds(l);return this.triggerAttack(t,v,d),Fe(o)?(wt(Fe(t),"notes must be an array when duration is array"),t.forEach((y,_)=>{const S=o[Math.min(_,o.length-1)];this.triggerRelease(y,v+this.toSeconds(S))})):this.triggerRelease(t,v+this.toSeconds(o)),this}add(t,o,l){if(wt(yo(t)||isFinite(t),`note must be a pitch or midi: ${t}`),yo(t)){const d=new Je(this.context,t).toMidi();this._buffers.add(d,o,l)}else this._buffers.add(t,o,l);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(t=>{t.forEach(o=>o.dispose())}),this._activeSources.clear(),this}}Ls([fn(0)],No.prototype,"attack",void 0),Ls([fn(0)],No.prototype,"release",void 0);class Xs extends Oe{constructor(){const t=J(Xs.getDefaults(),arguments,["callback","value"]);super(t),this.name="ToneEvent",this._state=new Mi("stopped"),this._startOffset=0,this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Oe.getDefaults(),{callback:Dt,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,o=>{let l;if(o.state==="started"){o.id!==-1&&this.context.transport.clear(o.id);const d=o.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||hs(this._loop)&&this._loop>1){l=1/0,hs(this._loop)&&(l=this._loop*this._getLoopDuration());const v=this._state.getAfter(d);v!==null&&(l=Math.min(l,v.time-d)),l!==1/0&&(l=new ce(this.context,l));const y=new ce(this.context,this._getLoopDuration());o.id=this.context.transport.scheduleRepeat(this._tick.bind(this),y,new ce(this.context,d),l)}else o.id=this.context.transport.schedule(this._tick.bind(this),new ce(this.context,d))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const o=this.toTicks(t);return this._state.getValueAtTime(o)==="stopped"&&(this._state.add({id:-1,state:"started",time:o}),this._rescheduleEvents(o)),this}stop(t){this.cancel(t);const o=this.toTicks(t);if(this._state.getValueAtTime(o)==="started"){this._state.setStateAtTime("stopped",o,{id:-1});const l=this._state.getBefore(o);let d=o;l!==null&&(d=l.time),this._rescheduleEvents(d)}return this}cancel(t){t=Ts(t,-1/0);const o=this.toTicks(t);return this._state.forEachFrom(o,l=>{this.context.transport.clear(l.id)}),this._state.cancel(o),this}_tick(t){const o=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(o)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let l=.02;rl(this.humanize)||(l=this.toSeconds(this.humanize)),t+=(2*Math.random()-1)*l}this.callback(t,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new ce(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new ce(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,o=this._state.get(t);if(o!==null&&o.state==="started"){const l=this._getLoopDuration();return(t-o.time)%l/l}return 0}return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class Lo extends Oe{constructor(){const t=J(Lo.getDefaults(),arguments,["callback","interval"]);super(t),this.name="Loop",this._event=new Xs({context:this.context,callback:this._tick.bind(this),loop:!0,loopEnd:t.interval,playbackRate:t.playbackRate,probability:t.probability,humanize:t.humanize}),this.callback=t.callback,this.iterations=t.iterations}static getDefaults(){return Object.assign(Oe.getDefaults(),{interval:"4n",callback:Dt,playbackRate:1,iterations:1/0,probability:1,mute:!1,humanize:!1})}start(t){return this._event.start(t),this}stop(t){return this._event.stop(t),this}cancel(t){return this._event.cancel(t),this}_tick(t){this.callback(t)}get state(){return this._event.state}get progress(){return this._event.progress}get interval(){return this._event.loopEnd}set interval(t){this._event.loopEnd=t}get playbackRate(){return this._event.playbackRate}set playbackRate(t){this._event.playbackRate=t}get humanize(){return this._event.humanize}set humanize(t){this._event.humanize=t}get probability(){return this._event.probability}set probability(t){this._event.probability=t}get mute(){return this._event.mute}set mute(t){this._event.mute=t}get iterations(){return this._event.loop===!0?1/0:this._event.loop}set iterations(t){this._event.loop=t===1/0||t}dispose(){return super.dispose(),this._event.dispose(),this}}class Fo extends Xs{constructor(){const t=J(Fo.getDefaults(),arguments,["callback","events"]);super(t),this.name="Part",this._state=new Mi("stopped"),this._events=new Set,this._state.increasing=!0,t.events.forEach(o=>{Fe(o)?this.add(o[0],o[1]):this.add(o)})}static getDefaults(){return Object.assign(Xs.getDefaults(),{events:[]})}start(t,o){const l=this.toTicks(t);if(this._state.getValueAtTime(l)!=="started"){o=Ts(o,this._loop?this._loopStart:0),o=this._loop?Ts(o,this._loopStart):Ts(o,0);const d=this.toTicks(o);this._state.add({id:-1,offset:d,state:"started",time:l}),this._forEach(v=>{this._startNote(v,l,d)})}return this}_startNote(t,o,l){o-=l,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<l&&(o+=this._getLoopDuration()),t.start(new ce(this.context,o))):t.startOffset<this._loopStart&&t.startOffset>=l&&(t.loop=!1,t.start(new ce(this.context,o))):t.startOffset>=l&&t.start(new ce(this.context,o))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(o=>{o.startOffset+=this._startOffset})}stop(t){const o=this.toTicks(t);return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._forEach(l=>{l.stop(t)}),this}at(t,o){const l=new xe(this.context,t).toTicks(),d=new ce(this.context,1).toSeconds(),v=this._events.values();let y=v.next();for(;!y.done;){const _=y.value;if(Math.abs(l-_.startOffset)<d)return It(o)&&(_.value=o),_;y=v.next()}return It(o)?(this.add(t,o),this.at(t)):null}add(t,o){t instanceof Object&&Reflect.has(t,"time")&&(t=(o=t).time);const l=this.toTicks(t);let d;return o instanceof Xs?(d=o,d.callback=this._tick.bind(this)):d=new Xs({callback:this._tick.bind(this),context:this.context,value:o}),d.startOffset=l,d.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(d),this._restartEvent(d),this}_restartEvent(t){this._state.forEach(o=>{o.state==="started"?this._startNote(t,o.time,o.offset):t.stop(new ce(this.context,o.time))})}remove(t,o){return cn(t)&&t.hasOwnProperty("time")&&(t=(o=t).time),t=this.toTicks(t),this._events.forEach(l=>{l.startOffset===t&&(os(o)||It(o)&&l.value===o)&&(this._events.delete(l),l.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(o=>o.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(o=>{o instanceof Fo?o._forEach(t):t(o)}),this}_setAll(t,o){this._forEach(l=>{l[t]=o})}_tick(t,o){this.mute||this.callback(t,o)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(o=>{o.loopStart=this.loopStart,o.loopEnd=this.loopEnd,o.loop=t,this._testLoopBoundries(o)})}get loopEnd(){return new ce(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(o=>{o.loopEnd=t,this._testLoopBoundries(o)})}get loopStart(){return new ce(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(o=>{o.loopStart=this.loopStart,this._testLoopBoundries(o)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}function*Cg(p){let t=0;for(;t<p;)t=Un(t,0,p-1),yield t,t++}function*Tg(p){let t=p-1;for(;t>=0;)t=Un(t,0,p-1),yield t,t--}function*Bo(p,t){for(;;)yield*t(p)}function*ju(p,t){let o=t?0:p-1;for(;;)o=Un(o,0,p-1),yield o,t?(o++,o>=p-1&&(t=!1)):(o--,o<=0&&(t=!0))}function*Ag(p){let t=0,o=0;for(;t<p;)t=Un(t,0,p-1),yield t,o++,t+=o%2?2:-1}function*Mg(p){let t=p-1,o=0;for(;t>=0;)t=Un(t,0,p-1),yield t,o++,t+=o%2?-2:1}function*Eg(p){const t=[];for(let o=0;o<p;o++)t.push(o);for(;t.length>0;)yield Un(t.splice(Math.floor(t.length*Math.random()),1)[0],0,p-1)}function*Uu(p,t="up",o=0){switch(wt(p>=1,"The number of values must be at least one"),t){case"up":yield*Bo(p,Cg);case"down":yield*Bo(p,Tg);case"upDown":yield*ju(p,!0);case"downUp":yield*ju(p,!1);case"alternateUp":yield*Bo(p,Ag);case"alternateDown":yield*Bo(p,Mg);case"random":yield*function*(l){for(;;)yield Math.floor(Math.random()*l)}(p);case"randomOnce":yield*Bo(p,Eg);case"randomWalk":yield*function*(l){let d=Math.floor(Math.random()*l);for(;;)d===0?d++:d===l-1||Math.random()<.5?d--:d++,yield d}(p)}}class Nl extends Lo{constructor(){const t=J(Nl.getDefaults(),arguments,["callback","values","pattern"]);super(t),this.name="Pattern",this.callback=t.callback,this._values=t.values,this._pattern=Uu(t.values.length,t.pattern),this._type=t.pattern}static getDefaults(){return Object.assign(Lo.getDefaults(),{pattern:"up",values:[],callback:Dt})}_tick(t){const o=this._pattern.next();this._index=o.value,this._value=this._values[o.value],this.callback(t,this._value)}get values(){return this._values}set values(t){this._values=t,this.pattern=this._type}get value(){return this._value}get index(){return this._index}get pattern(){return this._type}set pattern(t){this._type=t,this._pattern=Uu(this._values.length,this._type)}}class Ll extends Xs{constructor(){const t=J(Ll.getDefaults(),arguments,["callback","events","subdivision"]);super(t),this.name="Sequence",this._part=new Fo({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[],this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign($e(Xs.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,o){o===null||this.mute||this.callback(t,o)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,o){return this._part.start(t,o&&this._indexTime(o)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new ce(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(o,l)=>o[l],set:(o,l,d)=>(Ns(l)&&isFinite(parseInt(l,10))&&Fe(d)?o[l]=this._createSequence(d):o[l]=d,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,o,l){t.forEach((d,v)=>{const y=v*o+l;if(Fe(d))this._rescheduleSequence(d,o/d.length,y);else{const _=new ce(this.context,y,"i").toSeconds();this._part.add(_,d)}})}_indexTime(t){return new ce(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this._part.loopEnd=t===0?this._indexTime(this._eventsArray.length):this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}class Bi extends ot{constructor(){const t=J(Bi.getDefaults(),arguments,["fade"]);super(t),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new Wu({context:this.context}),this.a=new bt({context:this.context,gain:0}),this.b=new bt({context:this.context,gain:0}),this.output=new bt({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new Tt({context:this.context,units:"normalRange",value:t.fade}),St(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",Ke(this._split,this.a.gain,0),Ke(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(ot.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class Ae extends ot{constructor(t){super(t),this.name="Effect",this._dryWet=new Bi({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new bt({context:this.context}),this.effectReturn=new bt({context:this.context}),this.input=new bt({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(t.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],St(this,"wet")}static getDefaults(){return Object.assign(ot.getDefaults(),{wet:1})}connectEffect(t){return this._internalChannels.push(t),this.effectSend.chain(t,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class Qa extends Ae{constructor(t){super(t),this.name="LFOEffect",this._lfo=new ts({context:this.context,frequency:t.frequency,amplitude:t.depth}),this.depth=this._lfo.amplitude,this.frequency=this._lfo.frequency,this.type=t.type,St(this,["frequency","depth"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{frequency:1,type:"sine",depth:1})}start(t){return this._lfo.start(t),this}stop(t){return this._lfo.stop(t),this}sync(){return this._lfo.sync(),this}unsync(){return this._lfo.unsync(),this}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Fl extends Qa{constructor(){const t=J(Fl.getDefaults(),arguments,["frequency","baseFrequency","octaves"]);super(t),this.name="AutoFilter",this.filter=new vs(Object.assign(t.filter,{context:this.context})),this.connectEffect(this.filter),this._lfo.connect(this.filter.frequency),this.octaves=t.octaves,this.baseFrequency=t.baseFrequency}static getDefaults(){return Object.assign(Qa.getDefaults(),{baseFrequency:200,octaves:2.6,filter:{type:"lowpass",rolloff:-12,Q:1}})}get baseFrequency(){return this._lfo.min}set baseFrequency(t){this._lfo.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._lfo.max=this._lfo.min*Math.pow(2,t)}dispose(){return super.dispose(),this.filter.dispose(),this}}class $o extends ot{constructor(){const t=J($o.getDefaults(),arguments,["pan"]);super(t),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Et({context:this.context,param:this._panner.pan,value:t.pan,minValue:-1,maxValue:1}),this._panner.channelCount=t.channelCount,this._panner.channelCountMode="explicit",St(this,"pan")}static getDefaults(){return Object.assign(ot.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}class Bl extends Qa{constructor(){const t=J(Bl.getDefaults(),arguments,["frequency"]);super(t),this.name="AutoPanner",this._panner=new $o({context:this.context,channelCount:t.channelCount}),this.connectEffect(this._panner),this._lfo.connect(this._panner.pan),this._lfo.min=-1,this._lfo.max=1}static getDefaults(){return Object.assign(Qa.getDefaults(),{channelCount:1})}dispose(){return super.dispose(),this._panner.dispose(),this}}class qo extends ot{constructor(){const t=J(qo.getDefaults(),arguments,["smoothing"]);super(t),this.name="Follower",this._abs=this.input=new zu({context:this.context}),this._lowpass=this.output=new Do({context:this.context,frequency:1/this.toSeconds(t.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=t.smoothing}static getDefaults(){return Object.assign(ot.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class $l extends Ae{constructor(){const t=J($l.getDefaults(),arguments,["baseFrequency","octaves","sensitivity"]);super(t),this.name="AutoWah",this._follower=new qo({context:this.context,smoothing:t.follower}),this._sweepRange=new Ya({context:this.context,min:0,max:1,exponent:.5}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this._inputBoost=new bt({context:this.context}),this._bandpass=new vs({context:this.context,rolloff:-48,frequency:0,Q:t.Q}),this._peaking=new vs({context:this.context,type:"peaking"}),this._peaking.gain.value=t.gain,this.gain=this._peaking.gain,this.Q=this._bandpass.Q,this.effectSend.chain(this._inputBoost,this._follower,this._sweepRange),this._sweepRange.connect(this._bandpass.frequency),this._sweepRange.connect(this._peaking.frequency),this.effectSend.chain(this._bandpass,this._peaking,this.effectReturn),this._setSweepRange(),this.sensitivity=t.sensitivity,St(this,["gain","Q"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{baseFrequency:100,octaves:6,sensitivity:0,Q:2,gain:2,follower:.2})}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._setSweepRange()}get follower(){return this._follower.smoothing}set follower(t){this._follower.smoothing=t}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._setSweepRange()}get sensitivity(){return _o(1/this._inputBoost.gain.value)}set sensitivity(t){this._inputBoost.gain.value=1/Ti(t)}_setSweepRange(){this._sweepRange.min=this._baseFrequency,this._sweepRange.max=Math.min(this._baseFrequency*Math.pow(2,this._octaves),this.context.sampleRate/2)}dispose(){return super.dispose(),this._follower.dispose(),this._sweepRange.dispose(),this._bandpass.dispose(),this._peaking.dispose(),this._inputBoost.dispose(),this}}const Xu="bit-crusher";Hu(Xu,`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`);class ql extends Ae{constructor(){const t=J(ql.getDefaults(),arguments,["bits"]);super(t),this.name="BitCrusher",this._bitCrusherWorklet=new zl({context:this.context,bits:t.bits}),this.connectEffect(this._bitCrusherWorklet),this.bits=this._bitCrusherWorklet.bits}static getDefaults(){return Object.assign(Ae.getDefaults(),{bits:4})}dispose(){return super.dispose(),this._bitCrusherWorklet.dispose(),this}}class zl extends Rl{constructor(){const t=J(zl.getDefaults(),arguments);super(t),this.name="BitCrusherWorklet",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this.bits=new Et({context:this.context,value:t.bits,units:"positive",minValue:1,maxValue:16,param:this._dummyParam,swappable:!0})}static getDefaults(){return Object.assign(Rl.getDefaults(),{bits:12})}_audioWorkletName(){return Xu}onReady(t){ms(this.input,t,this.output);const o=t.parameters.get("bits");this.bits.setParam(o)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.bits.dispose(),this}}class Wl extends Ae{constructor(){const t=J(Wl.getDefaults(),arguments,["order"]);super(t),this.name="Chebyshev",this._shaper=new Bs({context:this.context,length:4096}),this._order=t.order,this.connectEffect(this._shaper),this.order=t.order,this.oversample=t.oversample}static getDefaults(){return Object.assign(Ae.getDefaults(),{order:1,oversample:"none"})}_getCoefficient(t,o,l){return l.has(o)||(o===0?l.set(o,0):o===1?l.set(o,t):l.set(o,2*t*this._getCoefficient(t,o-1,l)-this._getCoefficient(t,o-2,l))),l.get(o)}get order(){return this._order}set order(t){wt(Number.isInteger(t),"'order' must be an integer"),this._order=t,this._shaper.setMap(o=>this._getCoefficient(o,t,new Map))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Jn extends ot{constructor(){const t=J(Jn.getDefaults(),arguments,["channels"]);super(t),this.name="Split",this._splitter=this.input=this.output=this.context.createChannelSplitter(t.channels),this._internalChannels=[this._splitter]}static getDefaults(){return Object.assign(ot.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._splitter.disconnect(),this}}class Dn extends ot{constructor(){const t=J(Dn.getDefaults(),arguments,["channels"]);super(t),this.name="Merge",this._merger=this.output=this.input=this.context.createChannelMerger(t.channels)}static getDefaults(){return Object.assign(ot.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._merger.disconnect(),this}}class Ys extends ot{constructor(t){super(t),this.name="StereoEffect",this.input=new bt({context:this.context}),this.input.channelCount=2,this.input.channelCountMode="explicit",this._dryWet=this.output=new Bi({context:this.context,fade:t.wet}),this.wet=this._dryWet.fade,this._split=new Jn({context:this.context,channels:2}),this._merge=new Dn({context:this.context,channels:2}),this.input.connect(this._split),this.input.connect(this._dryWet.a),this._merge.connect(this._dryWet.b),St(this,["wet"])}connectEffectLeft(...t){this._split.connect(t[0],0,0),ms(...t),Ke(t[t.length-1],this._merge,0,0)}connectEffectRight(...t){this._split.connect(t[0],1,0),ms(...t),Ke(t[t.length-1],this._merge,0,1)}static getDefaults(){return Object.assign(ot.getDefaults(),{wet:1})}dispose(){return super.dispose(),this._dryWet.dispose(),this._split.dispose(),this._merge.dispose(),this}}class Vl extends Ys{constructor(t){super(t),this.feedback=new Tt({context:this.context,value:t.feedback,units:"normalRange"}),this._feedbackL=new bt({context:this.context}),this._feedbackR=new bt({context:this.context}),this._feedbackSplit=new Jn({context:this.context,channels:2}),this._feedbackMerge=new Dn({context:this.context,channels:2}),this._merge.connect(this._feedbackSplit),this._feedbackMerge.connect(this._split),this._feedbackSplit.connect(this._feedbackL,0,0),this._feedbackL.connect(this._feedbackMerge,0,0),this._feedbackSplit.connect(this._feedbackR,1,0),this._feedbackR.connect(this._feedbackMerge,0,1),this.feedback.fan(this._feedbackL.gain,this._feedbackR.gain),St(this,["feedback"])}static getDefaults(){return Object.assign(Ys.getDefaults(),{feedback:.5})}dispose(){return super.dispose(),this.feedback.dispose(),this._feedbackL.dispose(),this._feedbackR.dispose(),this._feedbackSplit.dispose(),this._feedbackMerge.dispose(),this}}class Hl extends Vl{constructor(){const t=J(Hl.getDefaults(),arguments,["frequency","delayTime","depth"]);super(t),this.name="Chorus",this._depth=t.depth,this._delayTime=t.delayTime/1e3,this._lfoL=new ts({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new ts({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._delayNodeL=new fs({context:this.context}),this._delayNodeR=new fs({context:this.context}),this.frequency=this._lfoL.frequency,St(this,["frequency"]),this._lfoL.frequency.connect(this._lfoR.frequency),this.connectEffectLeft(this._delayNodeL),this.connectEffectRight(this._delayNodeR),this._lfoL.connect(this._delayNodeL.delayTime),this._lfoR.connect(this._delayNodeR.delayTime),this.depth=this._depth,this.type=t.type,this.spread=t.spread}static getDefaults(){return Object.assign(Vl.getDefaults(),{frequency:1.5,delayTime:3.5,depth:.7,type:"sine",spread:180,feedback:0,wet:.5})}get depth(){return this._depth}set depth(t){this._depth=t;const o=this._delayTime*t;this._lfoL.min=Math.max(this._delayTime-o,0),this._lfoL.max=this._delayTime+o,this._lfoR.min=Math.max(this._delayTime-o,0),this._lfoR.max=this._delayTime+o}get delayTime(){return 1e3*this._delayTime}set delayTime(t){this._delayTime=t/1e3,this.depth=this._depth}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._delayNodeL.dispose(),this._delayNodeR.dispose(),this.frequency.dispose(),this}}class Gl extends Ae{constructor(){const t=J(Gl.getDefaults(),arguments,["distortion"]);super(t),this.name="Distortion",this._shaper=new Bs({context:this.context,length:4096}),this._distortion=t.distortion,this.connectEffect(this._shaper),this.distortion=t.distortion,this.oversample=t.oversample}static getDefaults(){return Object.assign(Ae.getDefaults(),{distortion:.4,oversample:"none"})}get distortion(){return this._distortion}set distortion(t){this._distortion=t;const o=100*t,l=Math.PI/180;this._shaper.setMap(d=>Math.abs(d)<.001?0:(3+o)*d*20*l/(Math.PI+o*Math.abs(d)))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Ja extends Ae{constructor(t){super(t),this.name="FeedbackEffect",this._feedbackGain=new bt({context:this.context,gain:t.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,St(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(Ae.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class jl extends Ja{constructor(){const t=J(jl.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="FeedbackDelay",this._delayNode=new fs({context:this.context,delayTime:t.delayTime,maxDelay:t.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),St(this,"delayTime")}static getDefaults(){return Object.assign(Ja.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class Pg extends ot{constructor(t){super(t),this.name="PhaseShiftAllpass",this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this.offset90=new bt({context:this.context}),this._bank0=this._createAllPassFilterBank([.6923878,.9360654322959,.988229522686,.9987488452737]),this._bank1=this._createAllPassFilterBank([.4021921162426,.856171088242,.9722909545651,.9952884791278]),this._oneSampleDelay=this.context.createIIRFilter([0,1],[1,0]),ms(this.input,...this._bank0,this._oneSampleDelay,this.output),ms(this.input,...this._bank1,this.offset90)}_createAllPassFilterBank(t){return t.map(o=>{const l=[[o*o,0,-1],[1,0,-o*o]];return this.context.createIIRFilter(l[0],l[1])})}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.offset90.dispose(),this._bank0.forEach(t=>t.disconnect()),this._bank1.forEach(t=>t.disconnect()),this._oneSampleDelay.disconnect(),this}}class Ul extends Ae{constructor(){const t=J(Ul.getDefaults(),arguments,["frequency"]);super(t),this.name="FrequencyShifter",this.frequency=new Tt({context:this.context,units:"frequency",value:t.frequency,minValue:-this.context.sampleRate/2,maxValue:this.context.sampleRate/2}),this._sine=new Co({context:this.context,type:"sine"}),this._cosine=new he({context:this.context,phase:-90,type:"sine"}),this._sineMultiply=new ue({context:this.context}),this._cosineMultiply=new ue({context:this.context}),this._negate=new Cl({context:this.context}),this._add=new Yn({context:this.context}),this._phaseShifter=new Pg({context:this.context}),this.effectSend.connect(this._phaseShifter),this.frequency.fan(this._sine.frequency,this._cosine.frequency),this._phaseShifter.offset90.connect(this._cosineMultiply),this._cosine.connect(this._cosineMultiply.factor),this._phaseShifter.connect(this._sineMultiply),this._sine.connect(this._sineMultiply.factor),this._sineMultiply.connect(this._negate),this._cosineMultiply.connect(this._add),this._negate.connect(this._add.addend),this._add.connect(this.effectReturn);const o=this.immediate();this._sine.start(o),this._cosine.start(o)}static getDefaults(){return Object.assign(Ae.getDefaults(),{frequency:0})}dispose(){return super.dispose(),this.frequency.dispose(),this._add.dispose(),this._cosine.dispose(),this._cosineMultiply.dispose(),this._negate.dispose(),this._phaseShifter.dispose(),this._sine.dispose(),this._sineMultiply.dispose(),this}}const Yu=[1557/44100,1617/44100,1491/44100,1422/44100,1277/44100,1356/44100,1188/44100,1116/44100],Zu=[225,556,441,341];class Xl extends Ys{constructor(){const t=J(Xl.getDefaults(),arguments,["roomSize","dampening"]);super(t),this.name="Freeverb",this._combFilters=[],this._allpassFiltersL=[],this._allpassFiltersR=[],this.roomSize=new Tt({context:this.context,value:t.roomSize,units:"normalRange"}),this._allpassFiltersL=Zu.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._allpassFiltersR=Zu.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._combFilters=Yu.map((o,l)=>{const d=new Oo({context:this.context,dampening:t.dampening,delayTime:o});return l<Yu.length/2?this.connectEffectLeft(d,...this._allpassFiltersL):this.connectEffectRight(d,...this._allpassFiltersR),this.roomSize.connect(d.resonance),d}),St(this,["roomSize"])}static getDefaults(){return Object.assign(Ys.getDefaults(),{roomSize:.7,dampening:3e3})}get dampening(){return this._combFilters[0].dampening}set dampening(t){this._combFilters.forEach(o=>o.dampening=t)}dispose(){return super.dispose(),this._allpassFiltersL.forEach(t=>t.disconnect()),this._allpassFiltersR.forEach(t=>t.disconnect()),this._combFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this}}const Qu=[.06748,.06404,.08212,.09004],kg=[.773,.802,.753,.733],Ig=[347,113,37];class Yl extends Ys{constructor(){const t=J(Yl.getDefaults(),arguments,["roomSize"]);super(t),this.name="JCReverb",this._allpassFilters=[],this._feedbackCombFilters=[],this.roomSize=new Tt({context:this.context,value:t.roomSize,units:"normalRange"}),this._scaleRoomSize=new mn({context:this.context,min:-.733,max:.197}),this._allpassFilters=Ig.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._feedbackCombFilters=Qu.map((o,l)=>{const d=new Ro({context:this.context,delayTime:o});return this._scaleRoomSize.connect(d.resonance),d.resonance.value=kg[l],l<Qu.length/2?this.connectEffectLeft(...this._allpassFilters,d):this.connectEffectRight(...this._allpassFilters,d),d}),this.roomSize.connect(this._scaleRoomSize),St(this,["roomSize"])}static getDefaults(){return Object.assign(Ys.getDefaults(),{roomSize:.5})}dispose(){return super.dispose(),this._allpassFilters.forEach(t=>t.disconnect()),this._feedbackCombFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this._scaleRoomSize.dispose(),this}}class Ju extends Vl{constructor(t){super(t),this._feedbackL.disconnect(),this._feedbackL.connect(this._feedbackMerge,0,1),this._feedbackR.disconnect(),this._feedbackR.connect(this._feedbackMerge,0,0),St(this,["feedback"])}}class Zl extends Ju{constructor(){const t=J(Zl.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="PingPongDelay",this._leftDelay=new fs({context:this.context,maxDelay:t.maxDelay}),this._rightDelay=new fs({context:this.context,maxDelay:t.maxDelay}),this._rightPreDelay=new fs({context:this.context,maxDelay:t.maxDelay}),this.delayTime=new Tt({context:this.context,units:"time",value:t.delayTime}),this.connectEffectLeft(this._leftDelay),this.connectEffectRight(this._rightPreDelay,this._rightDelay),this.delayTime.fan(this._leftDelay.delayTime,this._rightDelay.delayTime,this._rightPreDelay.delayTime),this._feedbackL.disconnect(),this._feedbackL.connect(this._rightDelay),St(this,["delayTime"])}static getDefaults(){return Object.assign(Ju.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._leftDelay.dispose(),this._rightDelay.dispose(),this._rightPreDelay.dispose(),this.delayTime.dispose(),this}}class Ql extends Ja{constructor(){const t=J(Ql.getDefaults(),arguments,["pitch"]);super(t),this.name="PitchShift",this._frequency=new Tt({context:this.context}),this._delayA=new fs({maxDelay:1,context:this.context}),this._lfoA=new ts({context:this.context,min:0,max:.1,type:"sawtooth"}).connect(this._delayA.delayTime),this._delayB=new fs({maxDelay:1,context:this.context}),this._lfoB=new ts({context:this.context,min:0,max:.1,type:"sawtooth",phase:180}).connect(this._delayB.delayTime),this._crossFade=new Bi({context:this.context}),this._crossFadeLFO=new ts({context:this.context,min:0,max:1,type:"triangle",phase:90}).connect(this._crossFade.fade),this._feedbackDelay=new fs({delayTime:t.delayTime,context:this.context}),this.delayTime=this._feedbackDelay.delayTime,St(this,"delayTime"),this._pitch=t.pitch,this._windowSize=t.windowSize,this._delayA.connect(this._crossFade.a),this._delayB.connect(this._crossFade.b),this._frequency.fan(this._lfoA.frequency,this._lfoB.frequency,this._crossFadeLFO.frequency),this.effectSend.fan(this._delayA,this._delayB),this._crossFade.chain(this._feedbackDelay,this.effectReturn);const o=this.now();this._lfoA.start(o),this._lfoB.start(o),this._crossFadeLFO.start(o),this.windowSize=this._windowSize}static getDefaults(){return Object.assign(Ja.getDefaults(),{pitch:0,windowSize:.1,delayTime:0,feedback:0})}get pitch(){return this._pitch}set pitch(t){this._pitch=t;let o=0;t<0?(this._lfoA.min=0,this._lfoA.max=this._windowSize,this._lfoB.min=0,this._lfoB.max=this._windowSize,o=Ai(t-1)+1):(this._lfoA.min=this._windowSize,this._lfoA.max=0,this._lfoB.min=this._windowSize,this._lfoB.max=0,o=Ai(t)-1),this._frequency.value=o*(1.2/this._windowSize)}get windowSize(){return this._windowSize}set windowSize(t){this._windowSize=this.toSeconds(t),this.pitch=this._pitch}dispose(){return super.dispose(),this._frequency.dispose(),this._delayA.dispose(),this._delayB.dispose(),this._lfoA.dispose(),this._lfoB.dispose(),this._crossFade.dispose(),this._crossFadeLFO.dispose(),this._feedbackDelay.dispose(),this}}class Jl extends Ys{constructor(){const t=J(Jl.getDefaults(),arguments,["frequency","octaves","baseFrequency"]);super(t),this.name="Phaser",this._lfoL=new ts({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new ts({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this.Q=new Tt({context:this.context,value:t.Q,units:"positive"}),this._filtersL=this._makeFilters(t.stages,this._lfoL),this._filtersR=this._makeFilters(t.stages,this._lfoR),this.frequency=this._lfoL.frequency,this.frequency.value=t.frequency,this.connectEffectLeft(...this._filtersL),this.connectEffectRight(...this._filtersR),this._lfoL.frequency.connect(this._lfoR.frequency),this.baseFrequency=t.baseFrequency,this.octaves=t.octaves,this._lfoL.start(),this._lfoR.start(),St(this,["frequency","Q"])}static getDefaults(){return Object.assign(Ys.getDefaults(),{frequency:.5,octaves:3,stages:10,Q:10,baseFrequency:350})}_makeFilters(t,o){const l=[];for(let d=0;d<t;d++){const v=this.context.createBiquadFilter();v.type="allpass",this.Q.connect(v.Q),o.connect(v.frequency),l.push(v)}return l}get octaves(){return this._octaves}set octaves(t){this._octaves=t;const o=this._baseFrequency*Math.pow(2,t);this._lfoL.max=o,this._lfoR.max=o}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._lfoL.min=this._baseFrequency,this._lfoR.min=this._baseFrequency,this.octaves=this._octaves}dispose(){return super.dispose(),this.Q.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._filtersL.forEach(t=>t.disconnect()),this._filtersR.forEach(t=>t.disconnect()),this.frequency.dispose(),this}}class Kl extends Ae{constructor(){const t=J(Kl.getDefaults(),arguments,["decay"]);super(t),this.name="Reverb",this._convolver=this.context.createConvolver(),this.ready=Promise.resolve(),this._decay=t.decay,this._preDelay=t.preDelay,this.generate(),this.connectEffect(this._convolver)}static getDefaults(){return Object.assign(Ae.getDefaults(),{decay:1.5,preDelay:.01})}get decay(){return this._decay}set decay(t){Be(t=this.toSeconds(t),.001),this._decay=t,this.generate()}get preDelay(){return this._preDelay}set preDelay(t){Be(t=this.toSeconds(t),0),this._preDelay=t,this.generate()}generate(){return Kt(this,void 0,void 0,function*(){const t=this.ready,o=new Ci(2,this._decay+this._preDelay,this.context.sampleRate),l=new In({context:o}),d=new In({context:o}),v=new Dn({context:o});l.connect(v,0,0),d.connect(v,0,1);const y=new bt({context:o}).toDestination();v.connect(y),l.start(0),d.start(0),y.gain.setValueAtTime(0,0),y.gain.setValueAtTime(1,this._preDelay),y.gain.exponentialApproachValueAtTime(0,this._preDelay,this.decay);const _=o.render();return this.ready=_.then(Dt),yield t,this._convolver.buffer=(yield _).get(),this})}dispose(){return super.dispose(),this._convolver.disconnect(),this}}class zo extends ot{constructor(){super(J(zo.getDefaults(),arguments)),this.name="MidSideSplit",this._split=this.input=new Jn({channels:2,context:this.context}),this._midAdd=new Yn({context:this.context}),this.mid=new ue({context:this.context,value:Math.SQRT1_2}),this._sideSubtract=new Zn({context:this.context}),this.side=new ue({context:this.context,value:Math.SQRT1_2}),this._split.connect(this._midAdd,0),this._split.connect(this._midAdd.addend,1),this._split.connect(this._sideSubtract,0),this._split.connect(this._sideSubtract.subtrahend,1),this._midAdd.connect(this.mid),this._sideSubtract.connect(this.side)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midAdd.dispose(),this._sideSubtract.dispose(),this._split.dispose(),this}}class Wo extends ot{constructor(){super(J(Wo.getDefaults(),arguments)),this.name="MidSideMerge",this.mid=new bt({context:this.context}),this.side=new bt({context:this.context}),this._left=new Yn({context:this.context}),this._leftMult=new ue({context:this.context,value:Math.SQRT1_2}),this._right=new Zn({context:this.context}),this._rightMult=new ue({context:this.context,value:Math.SQRT1_2}),this._merge=this.output=new Dn({context:this.context}),this.mid.fan(this._left),this.side.connect(this._left.addend),this.mid.connect(this._right),this.side.connect(this._right.subtrahend),this._left.connect(this._leftMult),this._right.connect(this._rightMult),this._leftMult.connect(this._merge,0,0),this._rightMult.connect(this._merge,0,1)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._leftMult.dispose(),this._rightMult.dispose(),this._left.dispose(),this._right.dispose(),this}}class Ku extends Ae{constructor(t){super(t),this.name="MidSideEffect",this._midSideMerge=new Wo({context:this.context}),this._midSideSplit=new zo({context:this.context}),this._midSend=this._midSideSplit.mid,this._sideSend=this._midSideSplit.side,this._midReturn=this._midSideMerge.mid,this._sideReturn=this._midSideMerge.side,this.effectSend.connect(this._midSideSplit),this._midSideMerge.connect(this.effectReturn)}connectEffectMid(...t){this._midSend.chain(...t,this._midReturn)}connectEffectSide(...t){this._sideSend.chain(...t,this._sideReturn)}dispose(){return super.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this._midSend.dispose(),this._sideSend.dispose(),this._midReturn.dispose(),this._sideReturn.dispose(),this}}class tc extends Ku{constructor(){const t=J(tc.getDefaults(),arguments,["width"]);super(t),this.name="StereoWidener",this.width=new Tt({context:this.context,value:t.width,units:"normalRange"}),St(this,["width"]),this._twoTimesWidthMid=new ue({context:this.context,value:2}),this._twoTimesWidthSide=new ue({context:this.context,value:2}),this._midMult=new ue({context:this.context}),this._twoTimesWidthMid.connect(this._midMult.factor),this.connectEffectMid(this._midMult),this._oneMinusWidth=new Zn({context:this.context}),this._oneMinusWidth.connect(this._twoTimesWidthMid),Ke(this.context.getConstant(1),this._oneMinusWidth),this.width.connect(this._oneMinusWidth.subtrahend),this._sideMult=new ue({context:this.context}),this.width.connect(this._twoTimesWidthSide),this._twoTimesWidthSide.connect(this._sideMult.factor),this.connectEffectSide(this._sideMult)}static getDefaults(){return Object.assign(Ku.getDefaults(),{width:.5})}dispose(){return super.dispose(),this.width.dispose(),this._midMult.dispose(),this._sideMult.dispose(),this._twoTimesWidthMid.dispose(),this._twoTimesWidthSide.dispose(),this._oneMinusWidth.dispose(),this}}class ec extends Ys{constructor(){const t=J(ec.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Tremolo",this._lfoL=new ts({context:this.context,type:t.type,min:1,max:0}),this._lfoR=new ts({context:this.context,type:t.type,min:1,max:0}),this._amplitudeL=new bt({context:this.context}),this._amplitudeR=new bt({context:this.context}),this.frequency=new Tt({context:this.context,value:t.frequency,units:"frequency"}),this.depth=new Tt({context:this.context,value:t.depth,units:"normalRange"}),St(this,["frequency","depth"]),this.connectEffectLeft(this._amplitudeL),this.connectEffectRight(this._amplitudeR),this._lfoL.connect(this._amplitudeL.gain),this._lfoR.connect(this._amplitudeR.gain),this.frequency.fan(this._lfoL.frequency,this._lfoR.frequency),this.depth.fan(this._lfoR.amplitude,this._lfoL.amplitude),this.spread=t.spread}static getDefaults(){return Object.assign(Ys.getDefaults(),{frequency:10,type:"sine",depth:.5,spread:180})}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this.context.transport.syncSignal(this.frequency),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this.context.transport.unsyncSignal(this.frequency),this}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._amplitudeL.dispose(),this._amplitudeR.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class sc extends Ae{constructor(){const t=J(sc.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Vibrato",this._delayNode=new fs({context:this.context,delayTime:0,maxDelay:t.maxDelay}),this._lfo=new ts({context:this.context,type:t.type,min:0,max:t.maxDelay,frequency:t.frequency,phase:-90}).start().connect(this._delayNode.delayTime),this.frequency=this._lfo.frequency,this.depth=this._lfo.amplitude,this.depth.value=t.depth,St(this,["frequency","depth"]),this.effectSend.chain(this._delayNode,this.effectReturn)}static getDefaults(){return Object.assign(Ae.getDefaults(),{maxDelay:.005,frequency:5,depth:.1,type:"sine"})}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._delayNode.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Vo extends ot{constructor(){const t=J(Vo.getDefaults(),arguments,["type","size"]);super(t),this.name="Analyser",this._analysers=[],this._buffers=[],this.input=this.output=this._gain=new bt({context:this.context}),this._split=new Jn({context:this.context,channels:t.channels}),this.input.connect(this._split),Be(t.channels,1);for(let o=0;o<t.channels;o++)this._analysers[o]=this.context.createAnalyser(),this._split.connect(this._analysers[o],o,0);this.size=t.size,this.type=t.type,this.smoothing=t.smoothing}static getDefaults(){return Object.assign(ot.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach((t,o)=>{const l=this._buffers[o];this._type==="fft"?t.getFloatFrequencyData(l):this._type==="waveform"&&t.getFloatTimeDomainData(l)}),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(t){this._analysers.forEach((o,l)=>{o.fftSize=2*t,this._buffers[l]=new Float32Array(t)})}get channels(){return this._analysers.length}get type(){return this._type}set type(t){wt(t==="waveform"||t==="fft",`Analyser: invalid type: ${t}`),this._type=t}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(t){this._analysers.forEach(o=>o.smoothingTimeConstant=t)}dispose(){return super.dispose(),this._analysers.forEach(t=>t.disconnect()),this._split.dispose(),this._gain.dispose(),this}}class On extends ot{constructor(){super(J(On.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new Vo({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class nc extends On{constructor(){const t=J(nc.getDefaults(),arguments,["smoothing"]);super(t),this.name="Meter",this.input=this.output=this._analyser=new Vo({context:this.context,size:256,type:"waveform",channels:t.channelCount}),this.smoothing=t.smoothing,this.normalRange=t.normalRange,this._rms=new Array(t.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(On.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return bi("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),o=(this.channels===1?[t]:t).map((l,d)=>{const v=l.reduce((_,S)=>_+S*S,0),y=Math.sqrt(v/l.length);return this._rms[d]=Math.max(y,this._rms[d]*this.smoothing),this.normalRange?this._rms[d]:_o(this._rms[d])});return this.channels===1?o[0]:o}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class ic extends On{constructor(){const t=J(ic.getDefaults(),arguments,["size"]);super(t),this.name="FFT",this.normalRange=t.normalRange,this._analyser.type="fft",this.size=t.size}static getDefaults(){return Object.assign(ot.getDefaults(),{normalRange:!1,size:1024,smoothing:.8})}getValue(){return this._analyser.getValue().map(t=>this.normalRange?Ti(t):t)}get size(){return this._analyser.size}set size(t){this._analyser.size=t}get smoothing(){return this._analyser.smoothing}set smoothing(t){this._analyser.smoothing=t}getFrequencyOfIndex(t){return wt(0<=t&&t<this.size,`index must be greater than or equal to 0 and less than ${this.size}`),t*this.context.sampleRate/(2*this.size)}}class oc extends On{constructor(){super(J(oc.getDefaults(),arguments)),this.name="DCMeter",this._analyser.type="waveform",this._analyser.size=256}getValue(){return this._analyser.getValue()[0]}}class ac extends On{constructor(){const t=J(ac.getDefaults(),arguments,["size"]);super(t),this.name="Waveform",this._analyser.type="waveform",this.size=t.size}static getDefaults(){return Object.assign(On.getDefaults(),{size:1024})}getValue(){return this._analyser.getValue()}get size(){return this._analyser.size}set size(t){this._analyser.size=t}}class be extends ot{constructor(){const t=J(be.getDefaults(),arguments,["solo"]);super(t),this.name="Solo",this.input=this.output=new bt({context:this.context}),be._allSolos.has(this.context)||be._allSolos.set(this.context,new Set),be._allSolos.get(this.context).add(this),this.solo=t.solo}static getDefaults(){return Object.assign(ot.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(t){t?this._addSolo():this._removeSolo(),be._allSolos.get(this.context).forEach(o=>o._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){be._soloed.has(this.context)||be._soloed.set(this.context,new Set),be._soloed.get(this.context).add(this)}_removeSolo(){be._soloed.has(this.context)&&be._soloed.get(this.context).delete(this)}_isSoloed(){return be._soloed.has(this.context)&&be._soloed.get(this.context).has(this)}_noSolos(){return!be._soloed.has(this.context)||be._soloed.has(this.context)&&be._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),be._allSolos.get(this.context).delete(this),this._removeSolo(),this}}be._allSolos=new Map,be._soloed=new Map;class Ka extends ot{constructor(){const t=J(Ka.getDefaults(),arguments,["pan","volume"]);super(t),this.name="PanVol",this._panner=this.input=new $o({context:this.context,pan:t.pan,channelCount:t.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new un({context:this.context,volume:t.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=t.mute,St(this,["pan","volume"])}static getDefaults(){return Object.assign(ot.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class Kn extends ot{constructor(){const t=J(Kn.getDefaults(),arguments,["volume","pan"]);super(t),this.name="Channel",this._solo=this.input=new be({solo:t.solo,context:this.context}),this._panVol=this.output=new Ka({context:this.context,pan:t.pan,volume:t.volume,mute:t.mute,channelCount:t.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),St(this,["pan","volume"])}static getDefaults(){return Object.assign(ot.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(t){this._solo.solo=t}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(t){this._panVol.mute=t}_getBus(t){return Kn.buses.has(t)||Kn.buses.set(t,new bt({context:this.context})),Kn.buses.get(t)}send(t,o=0){const l=this._getBus(t),d=new bt({context:this.context,units:"decibels",gain:o});return this.connect(d),d.connect(l),d}receive(t){return this._getBus(t).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}Kn.buses=new Map;class rc extends ot{constructor(){super(J(rc.getDefaults(),arguments)),this.name="Mono",this.input=new bt({context:this.context}),this._merge=this.output=new Dn({channels:2,context:this.context}),this.input.connect(this._merge,0,0),this.input.connect(this._merge,0,1)}dispose(){return super.dispose(),this._merge.dispose(),this.input.dispose(),this}}class Ho extends ot{constructor(){const t=J(Ho.getDefaults(),arguments,["lowFrequency","highFrequency"]);super(t),this.name="MultibandSplit",this.input=new bt({context:this.context}),this.output=void 0,this.low=new vs({context:this.context,frequency:0,type:"lowpass"}),this._lowMidFilter=new vs({context:this.context,frequency:0,type:"highpass"}),this.mid=new vs({context:this.context,frequency:0,type:"lowpass"}),this.high=new vs({context:this.context,frequency:0,type:"highpass"}),this._internalChannels=[this.low,this.mid,this.high],this.lowFrequency=new Tt({context:this.context,units:"frequency",value:t.lowFrequency}),this.highFrequency=new Tt({context:this.context,units:"frequency",value:t.highFrequency}),this.Q=new Tt({context:this.context,units:"positive",value:t.Q}),this.input.fan(this.low,this.high),this.input.chain(this._lowMidFilter,this.mid),this.lowFrequency.fan(this.low.frequency,this._lowMidFilter.frequency),this.highFrequency.fan(this.mid.frequency,this.high.frequency),this.Q.connect(this.low.Q),this.Q.connect(this._lowMidFilter.Q),this.Q.connect(this.mid.Q),this.Q.connect(this.high.Q),St(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(ot.getDefaults(),{Q:1,highFrequency:2500,lowFrequency:400})}dispose(){return super.dispose(),bo(this,["high","mid","low","highFrequency","lowFrequency"]),this.low.dispose(),this._lowMidFilter.dispose(),this.mid.dispose(),this.high.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this.Q.dispose(),this}}class lc extends ot{constructor(){const t=J(lc.getDefaults(),arguments,["positionX","positionY","positionZ"]);super(t),this.name="Panner3D",this._panner=this.input=this.output=this.context.createPanner(),this.panningModel=t.panningModel,this.maxDistance=t.maxDistance,this.distanceModel=t.distanceModel,this.coneOuterGain=t.coneOuterGain,this.coneOuterAngle=t.coneOuterAngle,this.coneInnerAngle=t.coneInnerAngle,this.refDistance=t.refDistance,this.rolloffFactor=t.rolloffFactor,this.positionX=new Et({context:this.context,param:this._panner.positionX,value:t.positionX}),this.positionY=new Et({context:this.context,param:this._panner.positionY,value:t.positionY}),this.positionZ=new Et({context:this.context,param:this._panner.positionZ,value:t.positionZ}),this.orientationX=new Et({context:this.context,param:this._panner.orientationX,value:t.orientationX}),this.orientationY=new Et({context:this.context,param:this._panner.orientationY,value:t.orientationY}),this.orientationZ=new Et({context:this.context,param:this._panner.orientationZ,value:t.orientationZ})}static getDefaults(){return Object.assign(ot.getDefaults(),{coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:0,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1})}setPosition(t,o,l){return this.positionX.value=t,this.positionY.value=o,this.positionZ.value=l,this}setOrientation(t,o,l){return this.orientationX.value=t,this.orientationY.value=o,this.orientationZ.value=l,this}get panningModel(){return this._panner.panningModel}set panningModel(t){this._panner.panningModel=t}get refDistance(){return this._panner.refDistance}set refDistance(t){this._panner.refDistance=t}get rolloffFactor(){return this._panner.rolloffFactor}set rolloffFactor(t){this._panner.rolloffFactor=t}get distanceModel(){return this._panner.distanceModel}set distanceModel(t){this._panner.distanceModel=t}get coneInnerAngle(){return this._panner.coneInnerAngle}set coneInnerAngle(t){this._panner.coneInnerAngle=t}get coneOuterAngle(){return this._panner.coneOuterAngle}set coneOuterAngle(t){this._panner.coneOuterAngle=t}get coneOuterGain(){return this._panner.coneOuterGain}set coneOuterGain(t){this._panner.coneOuterGain=t}get maxDistance(){return this._panner.maxDistance}set maxDistance(t){this._panner.maxDistance=t}dispose(){return super.dispose(),this._panner.disconnect(),this.orientationX.dispose(),this.orientationY.dispose(),this.orientationZ.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this}}class tr extends ot{constructor(){const t=J(tr.getDefaults(),arguments);super(t),this.name="Recorder",this.input=new bt({context:this.context}),wt(tr.supported,"Media Recorder API is not available"),this._stream=this.context.createMediaStreamDestination(),this.input.connect(this._stream),this._recorder=new MediaRecorder(this._stream.stream,{mimeType:t.mimeType})}static getDefaults(){return ot.getDefaults()}get mimeType(){return this._recorder.mimeType}static get supported(){return us!==null&&Reflect.has(us,"MediaRecorder")}get state(){return this._recorder.state==="inactive"?"stopped":this._recorder.state==="paused"?"paused":"started"}start(){return Kt(this,void 0,void 0,function*(){wt(this.state!=="started","Recorder is already started");const t=new Promise(o=>{const l=()=>{this._recorder.removeEventListener("start",l,!1),o()};this._recorder.addEventListener("start",l,!1)});return this._recorder.start(),yield t})}stop(){return Kt(this,void 0,void 0,function*(){wt(this.state!=="stopped","Recorder is not started");const t=new Promise(o=>{const l=d=>{this._recorder.removeEventListener("dataavailable",l,!1),o(d.data)};this._recorder.addEventListener("dataavailable",l,!1)});return this._recorder.stop(),yield t})}pause(){return wt(this.state==="started","Recorder must be started"),this._recorder.pause(),this}dispose(){return super.dispose(),this.input.dispose(),this._stream.disconnect(),this}}class gn extends ot{constructor(){const t=J(gn.getDefaults(),arguments,["threshold","ratio"]);super(t),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new Et({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:t.threshold}),this.attack=new Et({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:t.attack}),this.release=new Et({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:t.release}),this.knee=new Et({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:t.knee}),this.ratio=new Et({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:t.ratio}),St(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(ot.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class cc extends ot{constructor(){const t=J(cc.getDefaults(),arguments,["threshold","smoothing"]);super(t),this.name="Gate",this._follower=new qo({context:this.context,smoothing:t.smoothing}),this._gt=new Xa({context:this.context,value:Ti(t.threshold)}),this.input=new bt({context:this.context}),this._gate=this.output=new bt({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(ot.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return _o(this._gt.value)}set threshold(t){this._gt.value=Ti(t)}get smoothing(){return this._follower.smoothing}set smoothing(t){this._follower.smoothing=t}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}class hc extends ot{constructor(){const t=J(hc.getDefaults(),arguments,["threshold"]);super(t),this.name="Limiter",this._compressor=this.input=this.output=new gn({context:this.context,ratio:20,attack:.003,release:.01,threshold:t.threshold}),this.threshold=this._compressor.threshold,St(this,"threshold")}static getDefaults(){return Object.assign(ot.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}class uc extends ot{constructor(){const t=J(uc.getDefaults(),arguments);super(t),this.name="MidSideCompressor",this._midSideSplit=this.input=new zo({context:this.context}),this._midSideMerge=this.output=new Wo({context:this.context}),this.mid=new gn(Object.assign(t.mid,{context:this.context})),this.side=new gn(Object.assign(t.side,{context:this.context})),this._midSideSplit.mid.chain(this.mid,this._midSideMerge.mid),this._midSideSplit.side.chain(this.side,this._midSideMerge.side),St(this,["mid","side"])}static getDefaults(){return Object.assign(ot.getDefaults(),{mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},side:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10}})}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this}}class dc extends ot{constructor(){const t=J(dc.getDefaults(),arguments);super(t),this.name="MultibandCompressor",this._splitter=this.input=new Ho({context:this.context,lowFrequency:t.lowFrequency,highFrequency:t.highFrequency}),this.lowFrequency=this._splitter.lowFrequency,this.highFrequency=this._splitter.highFrequency,this.output=new bt({context:this.context}),this.low=new gn(Object.assign(t.low,{context:this.context})),this.mid=new gn(Object.assign(t.mid,{context:this.context})),this.high=new gn(Object.assign(t.high,{context:this.context})),this._splitter.low.chain(this.low,this.output),this._splitter.mid.chain(this.mid,this.output),this._splitter.high.chain(this.high,this.output),St(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(ot.getDefaults(),{lowFrequency:250,highFrequency:2e3,low:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10},mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},high:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16}})}dispose(){return super.dispose(),this._splitter.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.output.dispose(),this}}class pc extends ot{constructor(){const t=J(pc.getDefaults(),arguments,["low","mid","high"]);super(t),this.name="EQ3",this.output=new bt({context:this.context}),this._internalChannels=[],this.input=this._multibandSplit=new Ho({context:this.context,highFrequency:t.highFrequency,lowFrequency:t.lowFrequency}),this._lowGain=new bt({context:this.context,gain:t.low,units:"decibels"}),this._midGain=new bt({context:this.context,gain:t.mid,units:"decibels"}),this._highGain=new bt({context:this.context,gain:t.high,units:"decibels"}),this.low=this._lowGain.gain,this.mid=this._midGain.gain,this.high=this._highGain.gain,this.Q=this._multibandSplit.Q,this.lowFrequency=this._multibandSplit.lowFrequency,this.highFrequency=this._multibandSplit.highFrequency,this._multibandSplit.low.chain(this._lowGain,this.output),this._multibandSplit.mid.chain(this._midGain,this.output),this._multibandSplit.high.chain(this._highGain,this.output),St(this,["low","mid","high","lowFrequency","highFrequency"]),this._internalChannels=[this._multibandSplit]}static getDefaults(){return Object.assign(ot.getDefaults(),{high:0,highFrequency:2500,low:0,lowFrequency:400,mid:0})}dispose(){return super.dispose(),bo(this,["low","mid","high","lowFrequency","highFrequency"]),this._multibandSplit.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this._lowGain.dispose(),this._midGain.dispose(),this._highGain.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.Q.dispose(),this}}class mc extends ot{constructor(){const t=J(mc.getDefaults(),arguments,["url","onload"]);super(t),this.name="Convolver",this._convolver=this.context.createConvolver(),this._buffer=new qt(t.url,o=>{this.buffer=o,t.onload()}),this.input=new bt({context:this.context}),this.output=new bt({context:this.context}),this._buffer.loaded&&(this.buffer=this._buffer),this.normalize=t.normalize,this.input.chain(this._convolver,this.output)}static getDefaults(){return Object.assign(ot.getDefaults(),{normalize:!0,onload:Dt})}load(t){return Kt(this,void 0,void 0,function*(){this.buffer=yield this._buffer.load(t)})}get buffer(){return this._buffer.length?this._buffer:null}set buffer(t){t&&this._buffer.set(t),this._convolver.buffer&&(this.input.disconnect(),this._convolver.disconnect(),this._convolver=this.context.createConvolver(),this.input.chain(this._convolver,this.output));const o=this._buffer.get();this._convolver.buffer=o||null}get normalize(){return this._convolver.normalize}set normalize(t){this._convolver.normalize=t}dispose(){return super.dispose(),this._buffer.dispose(),this._convolver.disconnect(),this}}function Rg(){return ie().now()}function Dg(){return ie().immediate()}const Og=ie().transport;function Ng(){return ie().transport}const Lg=ie().destination,Fg=ie().destination;function Bg(){return ie().destination}const $g=ie().listener;function qg(){return ie().listener}const zg=ie().draw;function Wg(){return ie().draw}const Vg=ie();function Hg(){return qt.loaded()}const Gg=qt,jg=ki,Ug=kn})(),r})())}(gr)),gr.exports}var Q=ev();const op=Array(19).fill(2),ap=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],sv=Array(16).fill(2),nv=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function iv(){return{hasAnacrusis:!0,macrobeatGroupings:[...op],macrobeatBoundaryStyles:[...ap],baseMicrobeatPx:40,modulationMarkers:[]}}const ao=12,ov=50,av=.52,rv=.5,sr=3,nr=1,Ca=30,Ta=.5,lv=3,ir=8,vr=.25,cv=1.25,hv=.8,uv=.7,dv=.9,pv=4,mv=1.5,fv=.15,gv=.2,vv=1,rp=1.5,yv="#CCCCCC",lp=1,id=3,od=5,bv=7,yr=16,wv=0,_v=255,cp=()=>({enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass"}),xv=()=>({speed:0,span:0}),Sv=()=>({speed:0,span:0}),Cv={"#4a90e2":{primary:"#4a90e2",light:"#63a9fd"},"#68a03f":{primary:"#68a03f",light:"#80b958"},"#d66573":{primary:"#d66573",light:"#f27e8b"},"#2d2d2d":{primary:"#2d2d2d",light:"#424242"}};function ad(){const n=e=>{const s=new Float32Array(ao).fill(0),i=new Float32Array(ao).fill(0);return s[0]=1,{name:e,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},coeffs:s,phases:i,activePresetName:"sine",gain:1,filter:cp(),vibrato:xv(),tremelo:Sv()}};return{timbres:{"#4a90e2":n("Blue"),"#2d2d2d":n("Black"),"#d66573":n("Red"),"#68a03f":n("Green")},colorPalette:Cv}}function Tv(){return{isMicPaintActive:!1,isDetecting:!1,detectedPitch:{frequency:0,clarity:0,midi:0,pitchClass:0},paintHistory:[],paintSettings:{thickness:6,opacity:80,minClarity:.1,colorMode:"chromatic",playbackEnabled:!0}}}const Pe=[{pitch:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fef1f5"},{pitch:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fbf2fa"},{pitch:"B♭/A♯7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f6f3fd"},{pitch:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f1f5ff"},{pitch:"A♭/G♯7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#edf7fe"},{pitch:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#ebf8fa"},{pitch:"G♭/F♯7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#ecf8f5"},{pitch:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#eff8f0"},{pitch:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#f4f7ec"},{pitch:"E♭/D♯7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#f9f5eb"},{pitch:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#fdf3ec"},{pitch:"D♭/C♯7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fef2f0"},{pitch:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#fef1f5"},{pitch:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#f0d1ec"},{pitch:"B♭/A♯6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#e1d6f9"},{pitch:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#cfdcff"},{pitch:"A♭/G♯6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#bfe2fb"},{pitch:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#b7e6ef"},{pitch:"G♭/F♯6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#b9e8dd"},{pitch:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#c6e6cb"},{pitch:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#d8e2bd"},{pitch:"E♭/D♯6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#e9dcb7"},{pitch:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#f6d5bc"},{pitch:"D♭/C♯6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#fcd1c9"},{pitch:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#facfdb"},{pitch:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e6b2e1"},{pitch:"B♭/A♯5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#cebaf6"},{pitch:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#b0c4fe"},{pitch:"A♭/G♯5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#92cef8"},{pitch:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#7fd5e5"},{pitch:"G♭/F♯5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#84d8c8"},{pitch:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#9ed6a8"},{pitch:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#bece8f"},{pitch:"E♭/D♯5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#dbc484"},{pitch:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#f0b98d"},{pitch:"D♭/C♯5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#f9b1a5"},{pitch:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#f5afc3"},{pitch:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#db8fd4"},{pitch:"B♭/A♯4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#ba9bf2"},{pitch:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#8fa9ff"},{pitch:"A♭/G♯4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#58b8f6"},{pitch:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#16c3da"},{pitch:"G♭/F♯4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#2dc8b1"},{pitch:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#6ec482"},{pitch:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#a4ba57"},{pitch:"E♭/D♯4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#cdaa42"},{pitch:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#e89955"},{pitch:"D♭/C♯4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#f48e7d"},{pitch:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#ef8aab"},{pitch:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#be7cb8"},{pitch:"B♭/A♯3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#a286d2"},{pitch:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#7b93dd"},{pitch:"A♭/G♯3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#4c9fd6"},{pitch:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#13a9bd"},{pitch:"G♭/F♯3",toneNote:"Gb3",frequency:185,column:"A",hex:"#27ad99"},{pitch:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#5faa71"},{pitch:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#8ea14b"},{pitch:"E♭/D♯3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#b29338"},{pitch:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#ca8549"},{pitch:"D♭/C♯3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#d47a6c"},{pitch:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#cf7894"},{pitch:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#a46b9f"},{pitch:"B♭/A♯2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#8b73b6"},{pitch:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#6a7ebf"},{pitch:"A♭/G♯2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#4189b8"},{pitch:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#1092a3"},{pitch:"G♭/F♯2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#219584"},{pitch:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#519360"},{pitch:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#7a8b40"},{pitch:"E♭/D♯2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#997f30"},{pitch:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#ae723e"},{pitch:"D♭/C♯2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#b7695d"},{pitch:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#b3677f"},{pitch:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#6f466b"},{pitch:"B♭/A♯1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#5d4c7b"},{pitch:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#465482"},{pitch:"A♭/G♯1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#295c7d"},{pitch:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#06626e"},{pitch:"G♭/F♯1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#126458"},{pitch:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#34633f"},{pitch:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#515d28"},{pitch:"E♭/D♯1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#67541d"},{pitch:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#764c27"},{pitch:"D♭/C♯1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#7c453d"},{pitch:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#794455"}],hp={placedNotes:[],placedChords:[],tonicSignGroups:{},stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:ad().timbres,placedChords:[],stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[],pitchRange:{topIndex:0,bottomIndex:Math.max(0,((Pe==null?void 0:Pe.length)||1)-1)},...iv(),...ad(),paint:Tv(),selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},activeChordId:null,activeChordIntervals:["1P","3M","5P"],isIntervalsInverted:!1,chordPositionState:0,isChordCandidateMenuOpen:!1,chordCandidateMenuPosition:{x:0,y:0},activeMacrobeatIndex:null,chordCandidates:[],gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,savedAccidentalMode:{sharp:!0,flat:!0},focusColours:!1,snapZoomToRange:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,waveformExtendedView:!1,adsrTimeAxisScale:1,adsrComponentWidth:100,isPrintPreviewActive:!1,printOptions:{topRow:0,bottomRow:87,includeDrums:!0,orientation:"landscape",colorMode:"color"}};function rd(n){const e=JSON.parse(JSON.stringify(n));for(const s in e){const i=e[s];i.coeffs&&typeof i.coeffs=="object"&&!Array.isArray(i.coeffs)?i.coeffs=new Float32Array(Object.values(i.coeffs)):Array.isArray(i.coeffs)&&(i.coeffs=new Float32Array(i.coeffs))}return e}const Av={recordState(){this.state.history=this.state.history.slice(0,this.state.historyIndex+1);const n=JSON.parse(JSON.stringify(this.state.timbres)),e={notes:JSON.parse(JSON.stringify(this.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(this.state.tonicSignGroups)),stampPlacements:JSON.parse(JSON.stringify(this.state.stampPlacements)),tripletPlacements:JSON.parse(JSON.stringify(this.state.tripletPlacements||[])),timbres:n,annotations:this.state.annotations?JSON.parse(JSON.stringify(this.state.annotations)):[]};this.state.history.push(e),this.state.historyIndex++,this.emit("historyChanged")},undo(){var n;if(this.state.historyIndex>0){this.state.historyIndex--;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=rd(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}},redo(){var n;if(this.state.historyIndex<this.state.history.length-1){this.state.historyIndex++;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=rd(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}}};function bh(n){return n!==null&&typeof n=="object"&&"name"in n&&typeof n.name=="string"}function wh(n){return n!==null&&typeof n=="object"&&"step"in n&&typeof n.step=="number"&&"alt"in n&&typeof n.alt=="number"&&!isNaN(n.step)&&!isNaN(n.alt)}var up=[0,2,4,-1,1,3,5],dp=up.map(n=>Math.floor(n*7/12));function pp(n){const{step:e,alt:s,oct:i,dir:a=1}=n,r=up[e]+7*s;if(i===void 0)return[a*r];const c=i-dp[e]-4*s;return[a*r,a*c]}var Mv=[3,0,4,1,5,2,6];function mp(n){const[e,s,i]=n,a=Mv[Ev(e)],r=Math.floor((e+1)/7);if(s===void 0)return{step:a,alt:r,dir:i};const c=s+4*r+dp[a];return{step:a,alt:r,oct:c,dir:i}}function Ev(n){const e=(n+1)%7;return e<0?7+e:e}var ld=(n,e)=>Array(Math.abs(e)+1).join(n),Vc=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),Pv="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",kv="(AA|A|P|M|m|d|dd)([-+]?\\d+)",Iv=new RegExp("^"+Pv+"|"+kv+"$");function Rv(n){const e=Iv.exec(`${n}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var cd={};function Is(n){return typeof n=="string"?cd[n]||(cd[n]=Dv(n)):wh(n)?Is(Nv(n)):bh(n)?Is(n.name):Vc}var hd=[0,2,4,5,7,9,11],fp="PMMPPMM";function Dv(n){const e=Rv(n);if(e[0]==="")return Vc;const s=+e[0],i=e[1],a=(Math.abs(s)-1)%7,r=fp[a];if(r==="M"&&i==="P")return Vc;const c=r==="M"?"majorable":"perfectable",h=""+s+i,m=s<0?-1:1,f=s===8||s===-8?s:m*(a+1),g=Ov(c,i),b=Math.floor((Math.abs(s)-1)/7),w=m*(hd[a]+g+12*b),x=(m*(hd[a]+g)%12+12)%12,A=pp({step:a,alt:g,oct:b,dir:m});return{empty:!1,name:h,num:s,q:i,step:a,alt:g,dir:m,type:c,simple:f,semitones:w,chroma:x,coord:A,oct:b}}function gp(n,e){const[s,i=0]=n,a=s*7+i*12<0,r=e||a?[-s,-i,-1]:[s,i,1];return Is(mp(r))}function Ov(n,e){return e==="M"&&n==="majorable"||e==="P"&&n==="perfectable"?0:e==="m"&&n==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(n==="perfectable"?e.length:e.length+1):0}function Nv(n){const{step:e,alt:s,oct:i=0,dir:a}=n;if(!a)return"";const r=e+1+7*i,c=r===0?e+1:r,h=a<0?"-":"",m=fp[e]==="M"?"majorable":"perfectable";return h+c+Lv(m,s)}function Lv(n,e){return e===0?n==="majorable"?"M":"P":e===-1&&n==="majorable"?"m":e>0?ld("A",e):ld("d",n==="perfectable"?e:e+1)}var ud=(n,e)=>Array(Math.abs(e)+1).join(n),vp=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),dd=new Map,Fv=n=>"CDEFGAB".charAt(n),yp=n=>n<0?ud("b",-n):ud("#",n),bp=n=>n[0]==="b"?-n.length:n.length;function ke(n){const e=JSON.stringify(n),s=dd.get(e);if(s)return s;const i=typeof n=="string"?zv(n):wh(n)?ke(Wv(n)):bh(n)?ke(n.name):vp;return dd.set(e,i),i}var Bv=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function _h(n){const e=Bv.exec(n);return e?[e[1].toUpperCase(),e[2].replace(/x/g,"##"),e[3],e[4]]:["","","",""]}function $v(n){return ke(mp(n))}var qv=(n,e)=>(n%e+e)%e,_c=[0,2,4,5,7,9,11];function zv(n){const e=_h(n);if(e[0]===""||e[3]!=="")return vp;const s=e[0],i=e[1],a=e[2],r=(s.charCodeAt(0)+3)%7,c=bp(i),h=a.length?+a:void 0,m=pp({step:r,alt:c,oct:h}),f=s+i+a,g=s+i,b=(_c[r]+c+120)%12,w=h===void 0?qv(_c[r]+c,12)-12*99:_c[r]+c+12*(h+1),x=w>=0&&w<=127?w:null,A=h===void 0?null:Math.pow(2,(w-69)/12)*440;return{empty:!1,acc:i,alt:c,chroma:b,coord:m,freq:A,height:w,letter:s,midi:x,name:f,oct:h,pc:g,step:r}}function Wv(n){const{step:e,alt:s,oct:i}=n,a=Fv(e);if(!a)return"";const r=a+yp(s);return i||i===0?r+i:r}function qr(n,e){const s=ke(n),i=Array.isArray(e)?e:Is(e).coord;if(s.empty||!i||i.length<2)return"";const a=s.coord,r=a.length===1?[a[0]+i[0]]:[a[0]+i[0],a[1]+i[1]];return $v(r).name}function Rr(n,e){const s=ke(n),i=ke(e);if(s.empty||i.empty)return"";const a=s.coord,r=i.coord,c=r[0]-a[0],h=a.length===2&&r.length===2?r[1]-a[1]:-Math.floor(c*7/12),m=i.height===s.height&&i.midi!==null&&s.oct===i.oct&&s.step>i.step;return gp([c,h],m).name}function xh(n,e){const s=e.length,i=(n%s+s)%s;return e.slice(i,s).concat(e.slice(0,i))}function Vv(n){return n.filter(e=>e===0||e)}var ni={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},wp=n=>Number(n).toString(2).padStart(12,"0"),pd=n=>parseInt(n,2),Hv=/^[01]{12}$/;function _p(n){return Hv.test(n)}var Gv=n=>typeof n=="number"&&n>=0&&n<=4095,jv=n=>n&&_p(n.chroma),md={[ni.chroma]:ni};function Sh(n){const e=_p(n)?n:Gv(n)?wp(n):Array.isArray(n)?Jv(n):jv(n)?n.chroma:ni.chroma;return md[e]=md[e]||Qv(e)}var Uv=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function Xv(n){const e=[];for(let s=0;s<12;s++)n.charAt(s)==="1"&&e.push(Uv[s]);return e}function Yv(n,e=!0){const i=Sh(n).chroma.split("");return Vv(i.map((a,r)=>{const c=xh(r,i);return e&&c[0]==="0"?null:c.join("")}))}function Zv(n){const e=n.split("");return e.map((s,i)=>xh(i,e).join(""))}function Qv(n){const e=pd(n),s=Zv(n).map(pd).filter(r=>r>=2048).sort()[0],i=wp(s),a=Xv(n);return{empty:!1,name:"",setNum:e,chroma:n,normalized:i,intervals:a}}function Jv(n){if(n.length===0)return ni.chroma;let e;const s=[0,0,0,0,0,0,0,0,0,0,0,0];for(let i=0;i<n.length;i++)e=ke(n[i]),e.empty&&(e=Is(n[i])),e.empty||(s[e.chroma]=1);return s.join("")}var Kv=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7 Δ ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 Δ9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 Δ#4 Δ#11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -Δ7 mΔ -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim ° o"],["1P 3m 5d 7d","diminished seventh","dim7 °7 o7"],["1P 3m 5d 7m","half-diminished","m7b5 ø -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 Δ9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],ty=Kv,ey={...ni,name:"",quality:"Unknown",intervals:[],aliases:[]},Ch=[],sa={};function sy(n){return sa[n]||ey}function ny(){return Ch.slice()}function iy(n,e,s){const i=ay(n),a={...Sh(n),name:s||"",quality:i,intervals:n,aliases:e};Ch.push(a),a.name&&(sa[a.name]=a),sa[a.setNum]=a,sa[a.chroma]=a,a.aliases.forEach(r=>oy(a,r))}function oy(n,e){sa[e]=n}function ay(n){const e=s=>n.indexOf(s)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}ty.forEach(([n,e,s])=>iy(n.split(" "),s.split(" "),e));Ch.sort((n,e)=>n.setNum-e.setNum);var ry=n=>{const e=n.reduce((s,i)=>{const a=ke(i).chroma;return a!==void 0&&(s[a]=s[a]||ke(i).name),s},{});return s=>e[s]};function ly(n,e={}){const s=n.map(a=>ke(a).pc).filter(a=>a);return ke.length===0?[]:fy(s,1,e).filter(a=>a.weight).sort((a,r)=>r.weight-a.weight).map(a=>a.name)}var zr={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},Wr=n=>e=>!!(e&n),cy=Wr(zr.anyThirds),hy=Wr(zr.perfectFifth),uy=Wr(zr.anySeventh),dy=Wr(zr.nonPerfectFifths);function py(n){const e=parseInt(n.chroma,2);return cy(e)&&hy(e)&&uy(e)}function my(n){const e=parseInt(n,2);return dy(e)?n:(e|16).toString(2)}function fy(n,e,s){const i=n[0],a=ke(i).chroma,r=ry(n),c=Yv(n,!1),h=[];return c.forEach((m,f)=>{const g=s.assumePerfectFifth&&my(m);ny().filter(w=>s.assumePerfectFifth&&py(w)?w.chroma===g:w.chroma===m).forEach(w=>{const x=w.aliases[0],A=r(f);f!==a?h.push({weight:.5*e,name:`${A}${x}/${i}`}):h.push({weight:1*e,name:`${A}${x}`})})}),h}var gy=Is;function vy(n){const e=Is(n);if(e.empty)return"";const s=(7-e.step)%7,i=e.type==="perfectable"?-e.alt:-(e.alt+1);return Is({step:s,alt:i,oct:e.oct,dir:e.dir}).name}var xc=Rr,yy=by((n,e)=>[n[0]-e[0],n[1]-e[1]]);function by(n){return(e,s)=>{const i=Is(e).coord,a=Is(s).coord;if(i&&a){const r=n(i,a);return gp(r).name}}}var wy=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],_y=wy,xy={...ni,intervals:[],aliases:[]},na={};function xp(n){return na[n]||xy}function Sy(n,e,s=[]){const i={...Sh(n),name:e,intervals:n,aliases:s};return na[i.name]=i,na[i.setNum]=i,na[i.chroma]=i,i.aliases.forEach(a=>Cy(i,a)),i}function Cy(n,e){na[e]=n}_y.forEach(([n,e,...s])=>Sy(n.split(" "),e,s));var Sp={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function Cp(n){const[e,s,i,a]=_h(n);return e===""?Sc("",n):e==="A"&&a==="ug"?Sc("","aug"):Sc(e+s,i+a)}function Sc(n,e){const s=e.split("/");if(s.length===1)return[n,s[0],""];const[i,a,r,c]=_h(s[1]);return i!==""&&r===""&&c===""?[n,s[0],i+a]:[n,e,""]}function Hc(n){if(Array.isArray(n))return br(n[1]||"",n[0],n[2]);if(n==="")return Sp;{const[e,s,i]=Cp(n),a=br(s,e,i);return a.empty?br(n):a}}function br(n,e,s){const i=sy(n),a=ke(e||""),r=ke(s||"");if(i.empty||e&&a.empty||s&&r.empty)return Sp;const c=Rr(a.pc,r.pc),h=i.intervals.indexOf(c),m=h>=0,f=m?r:ke(""),g=h===-1?NaN:h+1,b=r.pc&&r.pc!==a.pc,w=Array.from(i.intervals);if(m)for(let M=1;M<g;M++){const I=w[0][0],D=w[0][1],R=parseInt(I,10)+7;w.push(`${R}${D}`),w.shift()}else if(b){const M=yy(Rr(a.pc,r.pc),"8P");M&&w.unshift(M)}const x=a.empty?[]:w.map(M=>qr(a.pc,M));n=i.aliases.indexOf(n)!==-1?n:i.aliases[0];const A=`${a.empty?"":a.pc}${n}${m&&g>1?"/"+f.pc:b?"/"+r.pc:""}`,P=`${e?a.pc+" ":""}${i.name}${m&&g>1?" over "+f.pc:b?" over "+r.pc:""}`;return{...i,name:P,symbol:A,tonic:a.pc,type:i.name,root:f.pc,bass:b?r.pc:"",intervals:w,rootDegree:g,notes:x}}var Ty=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],Ay=Ty;Ay.forEach(([n,e,s])=>void 0);var My="C C# D D# E F F# G G# A A# B".split(" "),Ey="C Db D Eb E F Gb G Ab A Bb B".split(" ");function Th(n,e={}){if(isNaN(n)||n===-1/0||n===1/0)return"";n=Math.round(n);const i=(e.sharps===!0?My:Ey)[n%12];if(e.pitchClass)return i;const a=Math.floor(n/12)-1;return i+a}var ro=ke,Dr=n=>ro(n).pc,Py=n=>ro(n).oct,nn=n=>ro(n).midi;function ky(n){return Th(n)}var ia=qr,oa=n=>{const e=ro(n);return e.empty?"":Th(e.midi||e.chroma,{sharps:e.alt>0,pitchClass:e.midi===null})};function bn(n,e){const s=ro(n);if(s.empty)return"";const i=ro(e||Th(s.midi||s.chroma,{sharps:s.alt<0,pitchClass:!0}));if(i.empty||i.chroma!==s.chroma)return"";if(s.oct===void 0)return i.pc;const a=s.chroma-s.alt,r=i.chroma-i.alt,c=a>11||r<0?-1:a<0||r>11?1:0,h=s.oct+c;return i.pc+h}var Tp={empty:!0,name:"",chordType:""},fd={};function va(n){return typeof n=="string"?fd[n]||(fd[n]=Ny(n)):typeof n=="number"?va(Ah[n]||""):wh(n)?Iy(n):bh(n)?va(n.name):Tp}function Iy(n){return va(yp(n.alt)+Ah[n.step])}var Ry=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function Dy(n){return Ry.exec(n)||["","","",""]}var Oy="I II III IV V VI VII",Ah=Oy.split(" ");function Ny(n){const[e,s,i,a]=Dy(n);if(!i)return Tp;const r=i.toUpperCase(),c=Ah.indexOf(r),h=bp(s),m=1;return{empty:!1,name:e,roman:i,interval:Is({step:c,alt:h,dir:m}).name,acc:s,chordType:a,alt:h,step:c,major:i===r,oct:0,dir:m}}var Mh=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],gd={...ni,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},Ly=Mh.map(Fy),Gc={};Ly.forEach(n=>{Gc[n.name]=n,n.aliases.forEach(e=>{Gc[e]=n})});function Ap(n){return typeof n=="string"?Gc[n.toLowerCase()]||gd:n&&n.name?Ap(n.name):gd}function Fy(n){const[e,s,i,a,r,c,h]=n,m=h?[h]:[],f=Number(s).toString(2);return{empty:!1,intervals:xp(a).intervals,modeNum:e,chroma:f,normalized:f,name:a,setNum:s,alt:i,triad:r,seventh:c,aliases:m}}function Mp(n){return(e,s)=>{const i=Ap(e);if(i.empty)return[];const a=xh(i.modeNum,n),r=i.intervals.map(c=>qr(s,c));return a.map((c,h)=>r[h]+c)}}Mp(Mh.map(n=>n[4]));Mp(Mh.map(n=>n[5]));function By(n,e){return e.map(s=>{const[i,a]=Cp(s),r=Rr(n,i);return va(Is(r)).name+a})}var $y={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function qy(n){if(typeof n!="string")return["",""];const e=n.indexOf(" "),s=ke(n.substring(0,e));if(s.empty){const a=ke(n);return a.empty?["",n.toLowerCase()]:[a.name,""]}const i=n.substring(s.name.length+1).toLowerCase();return[s.name,i.length?i:""]}function zy(n){const e=Array.isArray(n)?n:qy(n),s=ke(e[0]).name,i=xp(e[1]);if(i.empty)return $y;const a=i.name,r=s?i.intervals.map(h=>qr(s,h)):[],c=s?s+" "+a:a;return{...i,name:c,type:a,tonic:s,notes:r}}class Wy{constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,paint:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!0,console.log(`[Logger] Enabled category: ${s}`))})}disable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!1,console.log(`[Logger] Disabled category: ${s}`))})}enableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!0}),this.setLevel("DEBUG"),console.log("[Logger] All categories enabled")}disableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!1}),this.setLevel("ERROR"),console.log("[Logger] All categories disabled")}isCategoryEnabled(e){return this.categories[e]===!0}setLevel(e){const i=["DEBUG","INFO","WARN","ERROR"].indexOf(e);i!==-1&&(this.enabledLevels={DEBUG:i<=0,INFO:i<=1,WARN:i<=2,ERROR:i<=3})}formatComponent(e){return`[${e}]`}moduleLoaded(e,s="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`${e}: Module loaded.`)}initStart(e,s="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`Main.js: Initializing ${e}...`)}initSuccess(e,s="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`Main.js: ${e} initialized successfully.`)}initFailed(e,s="",i="initialization"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(i))return;const a=s?` (${s})`:"";console.warn(`Main.js: ${e} failed to initialize${a}.`)}section(e,s="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||(console.log("========================================"),console.log(e),console.log("========================================"))}event(e,s,i="",a="ui"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(a))return;const r=this.formatComponent(e),c=i?`${s}. ${i}`:s;console.log(`${r} ${c}`)}state(e,s,i=null,a="state"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(a))return;const r=this.formatComponent(e);if(i){const c=typeof i=="object"?JSON.stringify(i):String(i);console.log(`${r} ${s}: ${c}`)}else console.log(`${r} ${s}`)}debug(e,s,i=null,a="debug"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(a))return;const r=this.formatComponent(e);if(i){const c=typeof i=="object"?JSON.stringify(i):String(i);console.log(`${r} ${s}: ${c}`)}else console.log(`${r} ${s}`)}timing(e,s,i,a="performance"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(a))return;const r=this.formatComponent(e),c=Object.entries(i).map(([h,m])=>typeof m=="number"&&m%1!==0?`${h}=${m.toFixed(3)}`:`${h}=${m}`).join(", ");console.log(`${r} ${s}: ${c}`)}warn(e,s,i=null,a="general"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(a))return;const r=this.formatComponent(e);i?console.warn(`${r} ${s}`,i):console.warn(`${r} ${s}`)}error(e,s,i=null,a="general"){if(!this.enabledLevels.ERROR)return;const r=this.formatComponent(e);i?console.error(`${r} ${s}`,i):console.error(`${r} ${s}`)}info(e,s,i=null,a="general"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(a))return;const r=this.formatComponent(e);i?console.log(`${r} ${s}`,i):console.log(`${r} ${s}`)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([e,s])=>s).map(([e])=>e)}}getAvailableCategories(){return Object.keys(this.categories)}log(e,s,i=null){this.info(e,s,i,"general")}}const T=new Wy;typeof window<"u"&&(window.logger=T);function Vy(n){const{macrobeatGroupings:e}=n,s=an(n),i=[...n.columnWidths||[]],a=[sr,sr];T.debug("Columns Layout","Starting column width calculation",null,"layout"),T.debug("Columns Layout","Placed tonic signs",s.map(m=>`col:${m.columnIndex},mb:${m.preMacrobeatIndex}`),"layout"),T.debug("Columns Layout","Old columnWidths",i,"layout"),T.debug("Columns Layout","Macrobeat groupings",e,"layout");const r=[...s].sort((m,f)=>m.preMacrobeatIndex-f.preMacrobeatIndex);let c=0;const h=m=>{var g,b;let f=(g=r[c])==null?void 0:g.uuid;for(;r[c]&&r[c].preMacrobeatIndex===m;){T.debug("Columns Layout",`Adding tonic columns for mbIndex ${m}, tonic at column ${r[c].columnIndex}`,null,"layout");const w=a.length;for(a.push(nr),a.push(nr),T.debug("Columns Layout",`Added 2 columns (width=${nr} each), total columns: ${w} -> ${a.length}`,null,"layout");r[c]&&r[c].uuid===f;)c++;f=(b=r[c])==null?void 0:b.uuid}};return h(-1),e.forEach((m,f)=>{for(let g=0;g<m;g++)a.push(nr);h(f)}),a.push(sr,sr),T.debug("Columns Layout","Final newColumnWidths",a,"layout"),T.debug("Columns Layout","Width change",`${i.length} -> ${a.length} columns`,"layout"),T.debug("Columns Layout","Old total width units",i.reduce((m,f)=>m+f,0),"layout"),T.debug("Columns Layout","New total width units",a.reduce((m,f)=>m+f,0),"layout"),a}function Hy(n,e,s){let i=0;for(let a=0;a<n;a++)i+=(e[a]||0)*s;return i}function Gy(n,e){return n.reduce((s,i)=>s+i,0)*e}const Ki=30;let Ee=1,sn=av,on=0,ti,aa,vd,Hi,yd,Jo,jc,Uc,Ko,Xc,wr,bd,_r=!1,ys=!1,Cc=0,ra=!1,la=null;function Yc(){var r;const n=((r=u.state.fullRowData)==null?void 0:r.length)||0;if(n===0)return vr;const e=document.getElementById("pitch-grid-container"),s=on||window.innerHeight||0,i=(e==null?void 0:e.clientHeight)||(s?s*.7:0);if(!i||i<=0)return vr;const a=2*i/(n*Ki);return Math.max(vr,a)}function jy(){ti=document.getElementById("pitch-grid-wrapper"),aa=document.getElementById("notation-grid"),document.getElementById("drum-grid-wrapper"),Hi=document.getElementById("drum-grid"),Jo=document.getElementById("drum-playhead-canvas"),jc=document.getElementById("playhead-canvas"),Uc=document.getElementById("hover-canvas"),Ko=document.getElementById("drum-hover-canvas"),Xc=document.getElementById("pitch-paint-canvas"),wr=document.getElementById("canvas-macrobeat-tools");const n=document.getElementById("canvas-container");return!ti||!aa||!n?{}:(vd=aa.getContext("2d"),yd=Hi.getContext("2d"),{ctx:vd,drumCtx:yd,canvasContainer:n})}function yn(){if(!ti||ti.clientHeight===0){requestAnimationFrame(yn);return}if(_r)return;_r=!0;const n=document.getElementById("pitch-grid-container");ti.clientWidth;const e=window.innerHeight;(Math.abs(e-on)>3||on===0)&&(on=e);const i=Yc();Ee<i&&(Ee=i,console.log(`[Zoom] Enforcing minimum zoom to maintain grid height: ${Math.round(Ee*100)}%`));const a=Ki,r=a*rv,c=a*Ee,h=r*Ee;u.setLayoutConfig({cellHeight:c,cellWidth:h});const m=Vy(u.state);u.setLayoutConfig({columnWidths:m});const g=m.reduce((at,gt)=>at+gt,0)*u.state.cellWidth,b=xt.getModulatedCanvasWidth(),w=b>g?b:g,x=Math.round(w),A=document.getElementById("drum-grid-wrapper"),P=x+"px";n&&(n.style.width=P),ti&&(ti.style.width=P);const M=u.state.columnWidths.length-2;let I=0;for(let at=0;at<M;at++)I+=(u.state.columnWidths[at]||0)*u.state.cellWidth;const D=2,R=u.state.columnWidths.length-2;let H=0;for(let at=D;at<R;at++)H+=(u.state.columnWidths[at]||0)*u.state.cellWidth;if(A&&(A.style.width=`${I}px`),wr){wr.style.width=`${H}px`;const at=u.state.columnWidths.slice(0,D).reduce((gt,_t)=>gt+_t*u.state.cellWidth,0);wr.style.marginLeft=`${at}px`}[aa,jc,Uc,Xc].forEach(at=>{at&&Math.abs(at.width-x)>1&&(at.width=x)}),[Hi,Jo,Ko].forEach(at=>{at&&Math.abs(at.width-I)>1&&(at.width=I)});const j=Math.max(Ca,Ta*u.state.cellHeight),F=lv*j,Y=`${F}px`,tt=Math.abs(Cc-F)>5;if(A&&(tt||Cc===0)&&(A.style.height=Y,Cc=F),Hi&&Math.abs(Hi.height-F)>1&&(Hi.height=F),Jo&&Math.abs(Jo.height-F)>1&&(Jo.height=F),Ko&&Math.abs(Ko.height-F)>1&&(Ko.height=F),setTimeout(()=>{const gt=document.getElementById("pitch-grid-container").clientHeight;[aa,jc,Uc,Xc].forEach((_t,Mt)=>{_t&&Math.abs(_t.height-gt)>1&&(_t.height=gt)}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))}),la!==null){const at=u.state.fullRowData.length;if(at<=0)sn=0;else{const gt=Math.max(0,Math.min(at-1,la)),_t=document.getElementById("pitch-grid-container"),Mt=(_t==null?void 0:_t.clientHeight)||on*.7,Wt=(u.state.cellHeight||Ki)/2,Qt=Math.max(0,at*Wt-Mt);if(Qt<=0)sn=0;else{const it=gt*Wt;sn=Math.max(0,Math.min(1,it/Qt))}}la=null}u.emit("layoutConfigChanged"),_r=!1,ra&&(ra=!1,xt.snapZoomToCurrentRange())}const xt={init(){const{ctx:n,drumCtx:e,canvasContainer:s}=jy();requestAnimationFrame(yn),this.initScrollHandler();const i=()=>{_r||(clearTimeout(bd),bd=setTimeout(()=>{yn()},ov))};return window.addEventListener("resize",i),{ctx:n,drumCtx:e}},getCurrentZoomLevel(){return Ee},setZoomLevel(n){Ee=n,yn()},initScrollHandler(){const n=document.getElementById("pitch-grid-wrapper");n&&n.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey||e.metaKey)e.deltaY<0?this.zoomIn():this.zoomOut();else{const s=e.deltaY>0?1:-1;this.scrollByUnits(s)}},{passive:!1})},zoomIn(){ys||(u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ys=!0,Ee=Math.min(ir,Ee*cv),console.log(`[Zoom] Zoom level: ${Math.round(Ee*100)}%`),requestAnimationFrame(()=>{requestAnimationFrame(()=>{yn(),ys=!1})}))},zoomOut(){if(ys)return;u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ys=!0;const n=Yc(),e=Math.max(vr,Ee*hv),s=Math.max(n,e);s!==e&&console.log(`[Zoom] Minimum zoom reached; clamping to ${Math.round(s*100)}%`),Ee=s,console.log(`[Zoom] Zoom level: ${Math.round(Ee*100)}%`),requestAnimationFrame(()=>{requestAnimationFrame(()=>{yn(),ys=!1})})},resetZoom(){ys||(u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ys=!0,Ee=1,console.log("[Zoom] Zoom level reset to 100%"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{yn(),ys=!1})}))},snapZoomToCurrentRange(){if(ys){ra=!0;return}const n=Yc(),e=Math.min(ir,n);if(!isFinite(e)||e<=0)return;const s=Math.abs(Ee-e)>1e-4;ys=!0,Ee=e,n>ir+1e-4?console.log(`[Zoom] Snap zoom limited by MAX_ZOOM_LEVEL (${Math.round(ir*100)}%)`):s&&console.log(`[Zoom] Snap zoom to range: ${Math.round(Ee*100)}%`),requestAnimationFrame(()=>{requestAnimationFrame(()=>{yn(),ys=!1,ra&&(ra=!1,this.snapZoomToCurrentRange())})})},setPendingStartRow(n){typeof n=="number"&&Number.isFinite(n)?la=Math.max(0,n):la=null},scroll(n){const e=n/on/4;sn=Math.max(0,Math.min(1,sn+e)),u.emit("layoutConfigChanged")},scrollByUnits(n){const e=u.state.fullRowData.length,i=(u.state.cellHeight||Ki)/2,r=e*i,c=document.getElementById("pitch-grid-container"),h=(c==null?void 0:c.clientHeight)||on*.7,m=Math.max(0,r-h);if(m>0){const f=n*i/m;sn=Math.max(0,Math.min(1,sn+f)),u.emit("layoutConfigChanged")}},scrollByPixels(n,e=0){const s=-n,i=u.state.fullRowData.length,r=(u.state.cellHeight||Ki)*Ee,h=i*r,m=Math.max(0,h-on);if(m>0){const f=s/m;sn=Math.max(0,Math.min(1,sn+f))}u.emit("layoutConfigChanged")},getViewportInfo(){const n=u.state.fullRowData.length,e=document.getElementById("pitch-grid-container"),s=(e==null?void 0:e.clientHeight)||on*.7,i=u.state.cellHeight||Ki,a=i/2,c=n*a,m=Math.max(0,c-s)*sn,f=Math.max(0,Math.floor(m/a)),g=s/a,b=Math.min(n,Math.ceil(f+g));return{zoomLevel:Ee,viewportHeight:on,containerHeight:s,cellHeight:i,halfUnit:a,startRank:f,endRank:b,scrollOffset:m}},getMacrobeatWidthPx(n,e){return e*n.cellWidth},getColumnX(n){return Hy(n,u.state.columnWidths,u.state.cellWidth)},getCanvasWidth(){return Gy(u.state.columnWidths,u.state.cellWidth)},getModulatedCanvasWidth(){const n=this.getCanvasWidth();if(!u.state.modulationMarkers||u.state.modulationMarkers.length===0)return n;try{const e=u.state.baseMicrobeatPx||u.state.cellWidth||40;let s=n;return u.state.modulationMarkers.forEach(a=>{a.ratio>1&&(s*=a.ratio)}),Math.max(n,s)}catch{return n}},recalculateLayout(){yn()},get isZooming(){return ys}},Uy=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],an=n=>n.tonicSignGroups?Object.values(n.tonicSignGroups).flat():[],cs=(n,e)=>{let s=2;const{macrobeatGroupings:i}=n,a=an(n);a.some(m=>m.preMacrobeatIndex===-1)&&(s+=2);for(let m=0;m<e;m++)s+=i[m],a.some(f=>f.preMacrobeatIndex===m)&&(s+=2);const r=s,c=i[e],h=r+(c||0)-1;return{startColumn:r,endColumn:h,grouping:c}},Xy=n=>n.placedNotes.filter(e=>!e.isDrum),Yy=n=>n.placedNotes.filter(e=>e.isDrum),Zy=(n,e)=>{const i=an(n).filter(h=>h.columnIndex<=e);if(i.length===0)return{keyTonic:"C",keyMode:"major"};const a=i.reduce((h,m)=>m.columnIndex>h.columnIndex?m:h),r=Dr(n.fullRowData[a.row].toneNote),c=Uy[a.tonicNumber-1]||"major";return{keyTonic:r,keyMode:c}},Qy=(n,e)=>{const s=[],{fullRowData:i,placedNotes:a,placedChords:r}=n;return a.forEach(c=>{var h;if(!c.isDrum&&e>=c.startColumnIndex&&e<=c.endColumnIndex){const m=(h=i[c.row])==null?void 0:h.toneNote;m&&s.push(m)}}),r.forEach(c=>{c.position.xBeat===e&&s.push(...c.notes)}),s},Jy=(n,e)=>{const s=new Set,{startColumn:i,endColumn:a}=cs(n,e);for(let c=i;c<=a;c++)Qy(n,c).forEach(m=>{s.add(Dr(m))});return Array.from(s)};function Tc(n){if(!n)return null;const e=gy(n);if(!e||e.num===void 0)return null;let s="";const i=e.alt,a=Math.abs(e.num);return i<0?s="♭".repeat(Math.abs(i)):i>0&&(s="♯".repeat(i)),`${s}${a}`}function wd(n){return n&&{"♯1":"♭2","♭2":"♯1","♯2":"♭3","♭3":"♯2","♯4":"♭5","♭5":"♯4","♯5":"♭6","♭6":"♯5","♯6":"♭7","♭7":"♯6"}[n]||null}function _d(n){return n&&(n.includes("♯")||n.includes("♭"))}const Zc={getEnharmonicDegree:wd,hasAccidental:_d,getDegreeForNote(n,e){var f;console.log("🎵 [TONAL] getDegreeForNote called:",{degreeDisplayMode:e.degreeDisplayMode,noteRow:n.row,noteStartCol:n.startColumnIndex});const{keyTonic:s,keyMode:i}=Zy(e,n.startColumnIndex);if(console.log("🎵 [TONAL] Key context:",{keyTonic:s,keyMode:i}),!s)return null;const a=(f=e.fullRowData[n.row])==null?void 0:f.toneNote;if(console.log("🎵 [TONAL] Note pitch:",{notePitch:a}),!a)return null;const r=Dr(a);let c,h,m;if(e.degreeDisplayMode==="modal")c=s,h=xc(c,r),m=Tc(h);else{if(i==="major")c=s;else{const g=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(i);if(g>0){const w=["1P","2M","3M","4P","5P","6M","7M"][g];c=ia(s,vy(w))}else c=s}h=xc(c,r),m=Tc(h)}if(console.log("🎵 [TONAL] Calculation:",{keyTonic:s,keyMode:i,referenceTonic:c,notePitchClass:r,rawInterval:h,formattedInterval:m,degreeDisplayMode:e.degreeDisplayMode,enharmonicPreference:n.enharmonicPreference}),n.enharmonicPreference&&_d(m)){const g=wd(m);if(g)return console.log(`🎵 [TONAL] Using enharmonic preference: ${m} → ${g}`),g}return m},getDegreesForNotes(n,e){return!n||n.length===0?[]:n.map(s=>{const i=xc(e,Dr(s));return Tc(i)})},getRomanNumeralForNotes(n,e,s){if(!n||n.length<2)return null;const[i]=ly(n);if(!i)return null;const a=Hc(i).symbol;if(!a)return null;const[r]=By(e,[a]);if(!r)return null;const c=va(r),h=c.roman;let m=c.name.replace(h,"");const f=Hc(i).tonic;return m==="6"&&(m="add6"),{roman:h,ext:m,root:f}}};function Ac(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const Ky={addNote(n){const e=this.state.placedNotes.find(i=>!i.isDrum&&i.row===n.row&&i.startColumnIndex===n.startColumnIndex&&i.color===n.color);if(e){if(this.state.degreeDisplayMode!=="off"){const i=Zc.getDegreeForNote(e,this.state);if(Zc.hasAccidental(i))return e.enharmonicPreference=!e.enharmonicPreference,console.log("🎵 [ENHARMONIC] Toggled enharmonic preference for note:",{noteUuid:e.uuid,currentDegree:i,enharmonicPreference:e.enharmonicPreference}),this.emit("notesChanged"),e}return null}const s={...n,uuid:Ac()};return this.state.placedNotes.push(s),this.emit("notesChanged"),s},updateNoteTail(n,e){n.endColumnIndex=e,this.emit("notesChanged")},updateMultipleNoteTails(n,e){n.forEach(s=>{s.endColumnIndex=e}),this.emit("notesChanged")},updateNoteRow(n,e){n.row=e,this.emit("notesChanged")},updateMultipleNoteRows(n,e){n.forEach((s,i)=>{s.row=e[i]}),this.emit("notesChanged")},eraseInPitchArea(n,e,s=1,i=!0){const a=n+s-1,r=e-1,c=e+1;let h=!1;const m=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(f=>{if(f.isDrum)return!0;if(f.shape==="circle"){const g=f.startColumnIndex+1,b=f.startColumnIndex<=a&&g>=n,w=f.row>=r&&f.row<=c;if(b&&w)return!1}else if(f.row>=r&&f.row<=c&&f.startColumnIndex<=a&&f.endColumnIndex>=n)return!1;return!0}),this.state.placedNotes.length<m&&(h=!0),h&&(this.emit("notesChanged"),i&&this.recordState()),h},eraseDrumNoteAt(n,e,s=!0){const i=this.state.placedNotes.length;this.state.placedNotes=this.state.placedNotes.filter(r=>!(r.isDrum&&r.drumTrack===e&&r.startColumnIndex===n));const a=this.state.placedNotes.length<i;return a&&(this.emit("notesChanged"),s&&this.recordState()),a},addTonicSignGroup(n){T.debug("TonicPlacement","Starting addTonicSignGroup",{tonicSignGroup:n},"state");const e=n[0],{preMacrobeatIndex:s}=e;if(T.debug("TonicPlacement","preMacrobeatIndex",{preMacrobeatIndex:s},"state"),Object.values(this.state.tonicSignGroups).flat().some(h=>h.preMacrobeatIndex===s)){T.debug("TonicPlacement","Tonic already exists at this preMacrobeatIndex, returning",null,"state");return}const i=cs(this.state,s+1).startColumn;T.debug("TonicPlacement","Boundary column for shifting notes",{boundaryColumn:i},"state");const a=this.state.placedNotes.filter(h=>h.startColumnIndex>=i);T.debug("TonicPlacement","Notes that will be shifted",{noteRanges:a.map(h=>`${h.startColumnIndex}-${h.endColumnIndex}`)},"state"),this.state.placedNotes.forEach(h=>{if(h.startColumnIndex>=i){const m=h.startColumnIndex,f=h.endColumnIndex;h.startColumnIndex+=2,h.endColumnIndex+=2,T.debug("TonicPlacement",`Shifted note from ${m}-${f} to ${h.startColumnIndex}-${h.endColumnIndex}`,null,"state")}});const r=Ac(),c=n.map(h=>({...h,uuid:r}));this.state.tonicSignGroups[r]=c,T.debug("TonicPlacement","Added tonic group",{uuid:r,columns:c.map(h=>h.columnIndex)},"state"),T.debug("TonicPlacement","Emitting events: notesChanged, rhythmStructureChanged",null,"state"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(n,e=!0){const s=Object.entries(this.state.tonicSignGroups).find(([h,m])=>m.some(f=>f.columnIndex===n));if(!s)return!1;const[i,a]=s,r=a[0].preMacrobeatIndex,c=cs(this.state,r+1).startColumn;return delete this.state.tonicSignGroups[i],this.state.placedNotes.forEach(h=>{h.startColumnIndex>=c&&(h.startColumnIndex-=2,h.endColumnIndex-=2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),e&&this.recordState(),!0},toggleDrumNote(n){const e=this.state.placedNotes.findIndex(s=>s.isDrum&&s.drumTrack===n.drumTrack&&s.startColumnIndex===n.startColumnIndex);e>=0?this.state.placedNotes.splice(e,1):this.state.placedNotes.push({...n,uuid:Ac()}),this.emit("notesChanged"),this.recordState()},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(n){this.state.placedNotes=n,this.emit("notesChanged"),this.recordState()}},t0={setADSR(n,e){this.state.timbres[n]&&(this.state.timbres[n].adsr=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setFilterSettings(n,e){if(this.state.timbres[n]){console.log("setFilterSettings called:",{color:n,newSettings:e,activePresetName:this.state.timbres[n].activePresetName}),console.trace("setFilterSettings call stack"),Object.assign(this.state.timbres[n].filter,e);const s=this.state.timbres[n].filter.blend;s<=0?this.state.timbres[n].filter.type="highpass":s>=2?this.state.timbres[n].filter.type="lowpass":this.state.timbres[n].filter.type="bandpass",e.enabled===void 0&&(console.log("Clearing activePresetName because enabled is undefined"),this.state.timbres[n].activePresetName=null),this.emit("timbreChanged",n)}},setHarmonicCoefficients(n,e){this.state.timbres[n]&&(this.state.timbres[n].coeffs=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setHarmonicPhases(n,e){this.state.timbres[n]&&(T.debug("TimbreActions",`setHarmonicPhases called for ${n}`,null,"state"),T.debug("TimbreActions","Old phases",{phases:this.state.timbres[n].phases},"state"),T.debug("TimbreActions","New phases",{phases:e},"state"),T.debug("TimbreActions","Coefficients before phase change",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].phases=e,this.state.timbres[n].activePresetName=null,T.debug("TimbreActions","Coefficients after phase change",{coeffs:this.state.timbres[n].coeffs},"state"),T.debug("TimbreActions","Emitting timbreChanged for phase change",null,"state"),this.emit("timbreChanged",n))},applyPreset(n,e){!e||!this.state.timbres[n]||(T.debug("TimbreActions",`applyPreset called for ${n}`,null,"state"),T.debug("TimbreActions","Preset name",{name:e.name},"state"),T.debug("TimbreActions","Preset coeffs",{coeffs:e.coeffs},"state"),T.debug("TimbreActions","Old timbre coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].adsr=e.adsr,this.state.timbres[n].coeffs=new Float32Array(e.coeffs),e.phases?this.state.timbres[n].phases=new Float32Array(e.phases):this.state.timbres[n].phases=new Float32Array(this.state.timbres[n].coeffs.length).fill(0),this.state.timbres[n].activePresetName=e.name,this.state.timbres[n].gain=e.gain||1,e.filter?this.state.timbres[n].filter=JSON.parse(JSON.stringify(e.filter)):this.state.timbres[n].filter=cp(),T.debug("TimbreActions","Applied preset - new coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.emit("timbreChanged",n),this.recordState())}},ks={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function e0(n,e){if(console.log("[MODULATION] measureIndexToCanvasX called:",{measureIndex:n,hasState:!!e,cellWidth:e?e.cellWidth:"N/A"}),!e){console.warn("[MODULATION] No state provided for measure conversion");const c=n*200;return console.log("[MODULATION] Using fallback calculation:",c),c}const s=e.cellWidth||40;if(console.log("[MODULATION] Using cellWidth:",s),n===0){const c=2*s;return console.log("[MODULATION] Measure 0 → column 2 →",c),c}const i=n-1;console.log("[MODULATION] Looking for macrobeat index:",i);const a=cs(e,i);if(console.log("[MODULATION] getMacrobeatInfo result:",a),a){const c=(a.endColumn+1)*s;return console.log("[MODULATION] Found measure info, calculated position:",c),c}console.warn("[MODULATION] Could not find measure info for index:",n);const r=n*s*4;return console.log("[MODULATION] Using improved fallback calculation:",r),r}function s0(n,e,s=null,i=null,a=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:n,ratio:e,active:!0,xPosition:s,columnIndex:i,macrobeatIndex:a}}function Ep(n){return Math.abs(n-ks.COMPRESSION_2_3)<.001?"2:3":Math.abs(n-ks.EXPANSION_3_2)<.001?"3:2":`${n}`}function Pp(n){return Math.abs(n-ks.COMPRESSION_2_3)<.001?"#dc3545":Math.abs(n-ks.EXPANSION_3_2)<.001?"#007bff":"#6c757d"}function xd(n){return{segments:[{startX:0,endX:1/0,scale:1,spacingPx:n}],microbeatToCanvasX(e){return e*n},canvasXToMicrobeat(e){return e/n},getSegmentAtX(e){return this.segments[0]},getGhostGridPositions(e,s){return[]}}}function kp(n,e,s=null){if(!n||n.length===0)return xd(e);const i=[...n.filter(h=>h.active)].sort((h,m)=>h.measureIndex-m.measureIndex);if(i.length===0)return xd(e);console.log("[MODULATION] Creating coordinate mapping for markers:",i);const a=i.map(h=>{let m;return h.xPosition!==null&&h.xPosition!==void 0?(m=h.xPosition,console.log(`[MODULATION] Marker at measure ${h.measureIndex} → using stored x=${m}`)):(m=e0(h.measureIndex,s),console.log(`[MODULATION] Marker at measure ${h.measureIndex} → calculated x=${m}`)),console.log("[MODULATION] Final marker position:",{id:h.id,measureIndex:h.measureIndex,canvasX:m,isStored:h.xPosition!==null&&h.xPosition!==void 0}),{...h,xCanvas:m}}),r=[];let c=1;(a.length===0||a[0].xCanvas>0)&&r.push({startX:0,endX:a.length>0?a[0].xCanvas:1/0,scale:1,spacingPx:e});for(let h=0;h<a.length;h++){const m=a[h],f=h+1<a.length?a[h+1].xCanvas:1/0;c*=m.ratio,r.push({startX:m.xCanvas,endX:f,scale:c,spacingPx:e*c,marker:m})}return{segments:r,microbeatToCanvasX(h){let m=0,f=0;for(const g of r){const w=(g.endX-g.startX)/g.spacingPx;if(f+w>=h){const x=h-f;return g.startX+x*g.spacingPx}f+=w,m=g.endX}return m},canvasXToMicrobeat(h){let m=0;for(const f of r){if(h>=f.startX&&h<f.endX){const w=(h-f.startX)/f.spacingPx;return m+w}const g=f.endX-f.startX;m+=g/f.spacingPx}return m},getSegmentAtX(h){return r.find(m=>h>=m.startX&&h<m.endX)||null},getGhostGridPositions(h,m){if(console.log("[GHOST-CALC] getGhostGridPositions called with:",{segment:h,hasMarker:!!h.marker,hasOptions:!!m}),!h.marker)return console.log("[GHOST-CALC] No marker on segment, returning empty array"),[];if(!m||!m.columnWidths)return console.warn("[GHOST-CALC] No grid options provided"),[];const f=[],{columnWidths:g,cellWidth:b}=m;if(console.log("[GHOST-CALC] Options check:",{hasColumnWidths:!!g,columnCount:g?g.length:0,cellWidth:b,segmentStartX:h.startX,segmentEndX:h.endX,segmentScale:h.scale}),!g||!b||b===0)return console.warn("[GHOST-CALC] Missing grid data"),[];let w=0;for(let x=0;x<g.length;x++){const A=w;if(h.endX===1/0?A>=h.startX:A>=h.startX&&A<h.endX){let I,D;if(h.endX===1/0){const R=g.reduce((H,j)=>H+j,0)*b;D=Math.max(R,h.startX+800),I=D-h.startX}else I=h.endX-h.startX,D=h.endX;if(I>0&&h.scale>0){const R=(A-h.startX)/I,H=I/h.scale,j=h.startX+R*H;!isNaN(j)&&isFinite(j)&&f.push(j)}}const M=g[x]||0;if(w+=M*b,h.endX!==1/0&&w>h.endX)break}return f}}}function n0(n,e,s){let i=0;for(const a of e.segments){if(n>=a.startX&&n<a.endX){const f=(n-a.startX)/a.spacingPx,g=s/a.scale;return i+f*g}const c=(a.endX-a.startX)/a.spacingPx,h=s/a.scale;i+=c*h}return i}const i0={setAnacrusis(n){if(this.state.hasAnacrusis===n)return;const e=this.state.macrobeatGroupings,s=n?op:sv,i=e.reduce((c,h)=>c+h,0),r=s.reduce((c,h)=>c+h,0)-i;if(this.state.hasAnacrusis=n,this.state.macrobeatGroupings=[...s],this.state.macrobeatBoundaryStyles=n?[...ap]:[...nv],r!==0){const c=[];this.state.placedNotes.forEach(f=>{if(f.startColumnIndex>=2){const b=f.startColumnIndex+r,w=f.endColumnIndex+r;b<2?c.push(f):(f.startColumnIndex=b,f.endColumnIndex=w)}}),c.forEach(f=>{const g=this.state.placedNotes.indexOf(f);g>-1&&this.state.placedNotes.splice(g,1)});const h=[];this.state.stampPlacements.forEach(f=>{if(f.startColumn>=2){const b=f.startColumn+r,w=f.endColumn+r;b<2?h.push(f):(f.startColumn=b,f.endColumn=w)}}),h.forEach(f=>{const g=this.state.stampPlacements.indexOf(f);g>-1&&this.state.stampPlacements.splice(g,1)});const m=[];this.state.tripletPlacements&&(this.state.tripletPlacements.forEach(f=>{const g=r/2,b=1;if(f.startCellIndex>=b){const w=f.startCellIndex+g;w<b?m.push(f):f.startCellIndex=w}}),m.forEach(f=>{const g=this.state.tripletPlacements.indexOf(f);g>-1&&this.state.tripletPlacements.splice(g,1)})),Object.values(this.state.tonicSignGroups).flat().forEach(f=>{f.preMacrobeatIndex>=0})}this.emit("anacrusisChanged",n),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(n){if(n===void 0||n<0||n>=this.state.macrobeatGroupings.length){T.error("rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${n}`,null,"state");return}const e=this.state.macrobeatGroupings[n],s=e===2?3:2,i=s-e;let a=2;const r=Object.values(this.state.tonicSignGroups).flat(),c=new Set(r.filter(h=>h.preMacrobeatIndex<n).map(h=>h.uuid)).size;a+=c;for(let h=0;h<=n;h++)a+=this.state.macrobeatGroupings[h];this.state.placedNotes.forEach(h=>{h.startColumnIndex>=a&&(h.startColumnIndex+=i,h.endColumnIndex+=i)}),this.state.macrobeatGroupings[n]=s,this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(n){if(n===void 0||n<0||n>=this.state.macrobeatBoundaryStyles.length){T.error("rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${n}`,null,"state");return}const e=this._isBoundaryInAnacrusis(n);let s;e?s=["dashed","solid","anacrusis"]:s=["dashed","solid"];const i=this.state.macrobeatBoundaryStyles[n],a=s.indexOf(i),r=a===-1?0:(a+1)%s.length;this.state.macrobeatBoundaryStyles[n]=s[r],this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(n){if(!this.state.hasAnacrusis)return!1;for(let e=0;e<=n;e++)if(this.state.macrobeatBoundaryStyles[e]==="solid")return e===n;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){this.state.macrobeatGroupings.length>1&&(this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),this.emit("rhythmStructureChanged"),this.recordState())},updateTimeSignature(n,e){if(!Array.isArray(e)||e.length===0){T.error("rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let s=0,i=0,a=0;for(let x=0;x<this.state.macrobeatGroupings.length;x++){if(a===n){s=x;break}const A=x===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[x]==="solid"||A)&&a++}a=0;for(let x=0;x<this.state.macrobeatGroupings.length;x++)if(a===n){const A=x===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[x]==="solid"||A){i=x;break}}else if(a<n){const A=x===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[x]==="solid"||A)&&a++}const r=i-s+1,c=e.length,h=e.reduce((x,A)=>x+A,0)-this.state.macrobeatGroupings.slice(s,i+1).reduce((x,A)=>x+A,0);let m=2;const f=Object.values(this.state.tonicSignGroups).flat(),g=new Set(f.filter(x=>x.preMacrobeatIndex<=i).map(x=>x.uuid)).size;m+=g;for(let x=0;x<=i;x++)m+=this.state.macrobeatGroupings[x];h!==0&&this.state.placedNotes.forEach(x=>{x.startColumnIndex>=m&&(x.startColumnIndex+=h,x.endColumnIndex+=h)});const b=[...e],w=new Array(c-1).fill("dashed");if(i<this.state.macrobeatBoundaryStyles.length){const x=this.state.macrobeatBoundaryStyles[i];c>0&&w.push(x)}this.state.macrobeatGroupings.splice(s,r,...b),this.state.macrobeatBoundaryStyles.splice(s,r-1,...w),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(n,e,s=null,i=null,a=null){if(!Object.values(ks).includes(e))return T.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state"),null;const r=this.state.modulationMarkers.findIndex(h=>h.measureIndex===n||a!==null&&h.macrobeatIndex===a||i!==null&&h.columnIndex===i);if(r!==-1){const h=this.state.modulationMarkers[r];return T.info("rhythmActions",`Replacing existing modulation marker ${h.id} at measure ${n} (old ratio: ${h.ratio}, new ratio: ${e})`,null,"state"),h.ratio=e,h.xPosition=s,i!==null&&(h.columnIndex=i),a!==null&&(h.macrobeatIndex=a),this.emit("modulationMarkersChanged"),this.recordState(),h.id}const c=s0(n,e,s,i,a);return this.state.modulationMarkers.push(c),this.state.modulationMarkers.sort((h,m)=>h.measureIndex-m.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Added modulation marker ${c.id} at measure ${n} with ratio=${e}, columnIndex=${i}`,null,"state"),console.log("[MODULATION] State after adding marker:",{markerCount:this.state.modulationMarkers.length,markers:this.state.modulationMarkers}),c.id},removeModulationMarker(n){const e=this.state.modulationMarkers.findIndex(s=>s.id===n);if(e===-1){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}this.state.modulationMarkers.splice(e,1),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Removed modulation marker ${n}`,null,"state")},setModulationRatio(n,e){if(!Object.values(ks).includes(e)){T.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state");return}const s=this.state.modulationMarkers.find(i=>i.id===n);if(!s){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.ratio=e,this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Updated modulation marker ${n} ratio to ${e}`,null,"state")},moveModulationMarker(n,e){const s=this.state.modulationMarkers.find(i=>i.id===n);if(!s){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.measureIndex=e,this.state.modulationMarkers.sort((i,a)=>i.measureIndex-a.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Moved modulation marker ${n} to measure ${e}`,null,"state")},toggleModulationMarker(n){const e=this.state.modulationMarkers.find(s=>s.id===n);if(!e){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}e.active=!e.active,this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Toggled modulation marker ${n} active state to ${e.active}`,null,"state")},clearModulationMarkers(){const n=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Cleared ${n} modulation markers`,null,"state"),console.log("[MODULATION] All markers cleared")}};function o0(n,e,s){if(!n||typeof n!="object")return!0;const i=e.topIndex,a=s.topIndex,r=s.bottomIndex,c=r-a;let h=!1,m=!1;const f=g=>{if(typeof g!="number")return g;h=!0;const b=g+i;b>=a&&b<=r&&(m=!0);const w=b-a;return Math.max(0,Math.min(c,w))};if(typeof n.row=="number"&&(n.row=f(n.row)),typeof n.startRow=="number"&&(n.startRow=f(n.startRow)),typeof n.endRow=="number"&&(n.endRow=f(n.endRow)),typeof n.mouseRow=="number"&&(n.mouseRow=f(n.mouseRow)),typeof n.baseRow=="number"&&(n.baseRow=f(n.baseRow)),Array.isArray(n.path)){let g=!1;n.path.forEach(b=>{if(b&&typeof b.row=="number"){const w=b.row+i;w>=a&&w<=r&&(g=!0),b.row=Math.max(0,Math.min(c,w-a))}}),n.path.length>0&&(h=!0,g&&(m=!0))}if(Array.isArray(n.points)){let g=!1;n.points.forEach(b=>{if(b&&typeof b.row=="number"){const w=b.row+i;w>=a&&w<=r&&(g=!0),b.row=Math.max(0,Math.min(c,w-a))}}),n.points.length>0&&(h=!0,g&&(m=!0))}return n.data&&typeof n.data=="object"&&Object.entries(n.data).forEach(([g,b])=>{if(b&&typeof b=="object"){if(Array.isArray(b))b.forEach(w=>{if(w&&typeof w.row=="number"){const x=w.row+i;x>=a&&x<=r&&(m=!0),h=!0,w.row=Math.max(0,Math.min(c,x-a))}});else if(typeof b.row=="number"){const w=b.row+i;w>=a&&w<=r&&(m=!0),h=!0,b.row=Math.max(0,Math.min(c,w-a))}}}),!h||m}const a0={toggleAccidentalMode(n){this.state.accidentalMode.hasOwnProperty(n)&&(this.state.accidentalMode[n]=!this.state.accidentalMode[n],this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged"))},toggleFrequencyLabels(){this.state.showFrequencyLabels?(this.state.showFrequencyLabels=!1,this.state.accidentalMode={...this.state.savedAccidentalMode}):(this.state.savedAccidentalMode={...this.state.accidentalMode},this.state.showFrequencyLabels=!0,this.state.accidentalMode={sharp:!1,flat:!1}),this.emit("frequencyLabelsChanged",this.state.showFrequencyLabels),this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged")},toggleFocusColours(){this.state.focusColours=!this.state.focusColours,this.emit("focusColoursChanged",this.state.focusColours),this.emit("layoutConfigChanged")},setSnapZoomToRange(n){const e=!!n;this.state.snapZoomToRange!==e&&(this.state.snapZoomToRange=e,this.emit("snapZoomSettingChanged",e))},setDegreeDisplayMode(n){this.state.degreeDisplayMode,this.state.degreeDisplayMode=this.state.degreeDisplayMode===n?"off":n;const e=this.state.degreeDisplayMode;this.emit("layoutConfigChanged"),this.emit("degreeDisplayModeChanged",e)},setSelectedTool(n,e){if(this.state.selectedTool!==n||n==="tonicization"&&this.state.selectedToolTonicNumber!==e){const i=this.state.selectedTool;this.state.previousTool=i,this.state.selectedTool=n,n==="tonicization"&&e&&(this.state.selectedToolTonicNumber=parseInt(e,10)),this.emit("toolChanged",{newTool:n,oldTool:i})}},setSelectedNote(n,e){const s={...this.state.selectedNote};this.state.selectedNote={shape:n,color:e},this.emit("noteChanged",{newNote:this.state.selectedNote,oldNote:s})},setKeySignature(n){this.state.keySignature!==n&&(this.state.keySignature=n,this.emit("keySignatureChanged",n))},setTempo(n){this.state.tempo=n,this.emit("tempoChanged",n)},setLooping(n){this.state.isLooping=n,this.emit("loopingChanged",n)},setPlaybackState(n,e=!1){this.state.isPlaying=n,this.state.isPaused=e,this.emit("playbackStateChanged",{isPlaying:n,isPaused:e})},toggleWaveformExtendedView(){this.state.waveformExtendedView=!this.state.waveformExtendedView,this.emit("waveformExtendedViewChanged",this.state.waveformExtendedView)},setAdsrTimeAxisScale(n){const e=Math.max(.1,Math.min(5,n));this.state.adsrTimeAxisScale=e,this.emit("adsrTimeAxisScaleChanged",e)},setAdsrComponentWidth(n){const e=Math.max(50,Math.min(200,n));this.state.adsrComponentWidth=e,this.emit("adsrComponentWidthChanged",e)},setLayoutConfig(n){const e={cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]};let s=!1;if(n.cellWidth!==void 0&&this.state.cellWidth!==n.cellWidth&&(this.state.cellWidth=n.cellWidth,s=!0),n.cellHeight!==void 0&&this.state.cellHeight!==n.cellHeight&&(this.state.cellHeight=n.cellHeight,s=!0),n.columnWidths!==void 0){const i=JSON.stringify(this.state.columnWidths||[]),a=JSON.stringify(n.columnWidths);i!==a&&(this.state.columnWidths=[...n.columnWidths],s=!0)}s&&this.emit("layoutConfigChanged",{oldConfig:e,newConfig:{cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]}})},setGridPosition(n){const e=this.state.fullRowData.length-this.state.viewportRows*2,s=Math.max(0,Math.min(n,e));this.state.gridPosition!==s&&(this.state.gridPosition=s,this.emit("layoutConfigChanged"))},shiftGridUp(){this.setGridPosition(this.state.gridPosition-1)},shiftGridDown(){this.setGridPosition(this.state.gridPosition+1)},setPrintOptions(n){this.state.printOptions={...this.state.printOptions,...n},this.emit("printOptionsChanged",this.state.printOptions)},setPrintPreviewActive(n){this.state.isPrintPreviewActive,this.state.isPrintPreviewActive=n,this.emit("printPreviewStateChanged",n)},setPitchRange(n,e={}){const s=Pe.length,i=this.state.pitchRange||{topIndex:0,bottomIndex:s-1};if(!n||s===0)return;const a=n.topIndex??i.topIndex,r=n.bottomIndex??i.bottomIndex,c=Math.max(0,Math.min(s-1,a)),h=Math.max(c,Math.min(s-1,r));if(i.topIndex===c&&i.bottomIndex===h)return;const m=Pe.slice(c,h+1),f=m.length-1;let g=0,b=0,w=0;if(this.state.placedNotes=this.state.placedNotes.filter(P=>{if(P.isDrum)return!0;const M=P.row+i.topIndex;return M<c||M>h?(g+=1,!1):(P.row=M-c,!0)}),this.state.tonicSignGroups){const P={};Object.entries(this.state.tonicSignGroups).forEach(([M,I])=>{const D=I.map(R=>{if(typeof R.row!="number")return null;const H=R.row+i.topIndex;return H<c||H>h?null:{...R,row:H-c}}).filter(Boolean);D.length>0&&(P[M]=D)}),this.state.tonicSignGroups=P}if(Array.isArray(this.state.stampPlacements)&&(this.state.stampPlacements=this.state.stampPlacements.filter(P=>{const M=P.row+i.topIndex;return M<c||M>h?(b+=1,!1):(P.row=M-c,!0)})),Array.isArray(this.state.tripletPlacements)&&(this.state.tripletPlacements=this.state.tripletPlacements.filter(P=>{const M=P.row+i.topIndex;return M<c||M>h?(w+=1,!1):(P.row=M-c,!0)})),Array.isArray(this.state.annotations)&&this.state.annotations.length>0){const P={topIndex:c,bottomIndex:h};this.state.annotations=this.state.annotations.filter(M=>o0(M,i,P))}if(this.state.printOptions){const P=this.state.printOptions.topRow??0,M=this.state.printOptions.bottomRow??f,I=i.topIndex-c,D=Math.max(0,Math.min(f,P+I)),R=Math.max(D,Math.min(f,M+I));this.state.printOptions={...this.state.printOptions,topRow:D,bottomRow:R}}this.state.pitchRange={topIndex:c,bottomIndex:h},this.state.fullRowData=m;let x=null;if(typeof e.maintainGlobalStart=="number"&&Number.isFinite(e.maintainGlobalStart)){const P=Math.round(e.maintainGlobalStart-c);x=Math.max(0,Math.min(f,P))}const A={removedNotes:g,removedStamps:b,removedTriplets:w,maintainStartRow:x};this.emit("pitchRangeChanged",{topIndex:c,bottomIndex:h,metadata:A}),this.emit("layoutConfigChanged"),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("annotationsChanged"),this.recordState()}},r0={addChord(n){},updateChord(n,e){},deleteChord(n){},setActiveChord(n){},setRegionContext(n){},rebuildAllChords(n){},setActiveChordIntervals(n){this.state.activeChordIntervals=n,this.emit("activeChordIntervalsChanged",n)},setIntervalsInversion(n){this.state.isIntervalsInverted=n,this.emit("intervalsInversionChanged",n)},setChordPosition(n){this.state.chordPositionState=n,this.emit("chordPositionChanged",n)},openChordCandidateMenu(n,e,s){this.state.isChordCandidateMenuOpen=!0,this.state.activeMacrobeatIndex=n,this.state.chordCandidates=e,this.state.chordCandidateMenuPosition=s,this.emit("chordCandidateMenuStateChanged")},closeChordCandidateMenu(){this.state.isChordCandidateMenuOpen=!1,this.state.activeMacrobeatIndex=null,this.emit("chordCandidateMenuStateChanged")},applyChordCandidate(n){if(this.state.activeMacrobeatIndex===null)return;const{startColumn:e,endColumn:s}=cs(this.state,this.state.activeMacrobeatIndex);Jy(this.state,this.state.activeMacrobeatIndex);let i="C8";this.state.placedNotes.forEach(g=>{if(g.startColumnIndex>=e&&g.startColumnIndex<=s){const b=this.state.fullRowData[g.row].toneNote;nn(b)<nn(i)&&(i=b)}});const a=Py(i),c=`${Hc(n).tonic}${a}`,h=br(n,c).notes.map(g=>oa(g));this.state.placedNotes=this.state.placedNotes.filter(g=>g.startColumnIndex<e||g.startColumnIndex>s);const{shape:m,color:f}=this.state.selectedNote;h.forEach(g=>{const b=this.state.fullRowData.findIndex(w=>w.toneNote===g);if(b!==-1){const w={row:b,startColumnIndex:e,endColumnIndex:e,color:f,shape:m,isDrum:!1};this.addNote(w)}}),this.closeChordCandidateMenu(),this.recordState(),this.emit("notesChanged")}};T.moduleLoaded("paintActions","state");const l0={setMicPaintActive(n){this.state.paint.isMicPaintActive=n,T.debug("paintActions",`Mic Paint Active set to: ${n}`,null,"paint"),this.emit("micPaintStateChanged",n)},setPaintDetectionState(n){this.state.paint.isDetecting,this.state.paint.isDetecting=n,T.debug("paintActions",`Paint detection state set to: ${n}`,null,"paint"),this.emit("paintDetectionStateChanged",n)},setDetectedPitch(n){this.state.paint.detectedPitch=n,this.emit("pitchDetected",n)},addPaintPoint(n){this.state.paint.paintHistory.push(n)},clearPaintHistory(){this.state.paint.paintHistory=[],T.debug("paintActions","Paint history cleared",null,"paint"),this.emit("paintHistoryChanged"),this.recordState()},setPaintSettings(n){Object.assign(this.state.paint.paintSettings,n),T.debug("paintActions","Paint settings updated",{settings:this.state.paint.paintSettings},"paint"),this.emit("paintSettingsChanged",this.state.paint.paintSettings),this.recordState()}};T.moduleLoaded("StampActions","stamps");function c0(){return`stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const h0={addStampPlacement(n,e,s,i="#4a90e2"){const a=e+1,r=this.state.stampPlacements.find(h=>h.row===s&&h.startColumn<=a&&h.endColumn>=e);r&&this.removeStampPlacement(r.id);const c={id:c0(),stampId:n,startColumn:e,endColumn:a,row:s,color:i,timestamp:Date.now()};return this.state.stampPlacements.push(c),this.emit("stampPlacementsChanged"),T.debug("StampActions",`Added stamp ${n} at ${e}-${a},${s}`,{stampId:n,startColumn:e,endColumn:a,row:s,placementId:c.id},"stamps"),c},removeStampPlacement(n){const e=this.state.stampPlacements.findIndex(i=>i.id===n);if(e===-1)return!1;const s=this.state.stampPlacements.splice(e,1)[0];return this.emit("stampPlacementsChanged"),T.debug("StampActions",`Removed stamp ${s.stampId} at ${s.startColumn}-${s.endColumn},${s.row}`,{placementId:n,stampId:s.stampId,startColumn:s.startColumn,endColumn:s.endColumn,row:s.row},"stamps"),!0},eraseStampsInArea(n,e,s,i){const a=[];for(const c of this.state.stampPlacements){const h=c.startColumn<=e&&c.endColumn>=n,m=c.row>=s&&c.row<=i;h&&m&&a.push(c.id)}let r=!1;return a.forEach(c=>{this.removeStampPlacement(c)&&(r=!0)}),r},getAllStampPlacements(){return[...this.state.stampPlacements]},getStampAt(n,e){return this.state.stampPlacements.find(s=>s.row===e&&n>=s.startColumn&&n<=s.endColumn)||null},clearAllStamps(){const n=this.state.stampPlacements.length>0;this.state.stampPlacements=[],n&&(this.emit("stampPlacementsChanged"),T.info("StampActions","Cleared all stamp placements",null,"stamps"))},getStampPlaybackData(){return this.state.stampPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{stampId:n.stampId,column:n.startColumn,startColumn:n.startColumn,endColumn:n.endColumn,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,placement:n}}).filter(n=>n.pitch)},updateStampShapeOffset(n,e,s){const i=this.state.stampPlacements.find(a=>a.id===n);if(!i){console.warn("[STAMP SHAPE OFFSET] Placement not found:",n);return}i.shapeOffsets||(i.shapeOffsets={}),console.log("[STAMP SHAPE OFFSET] Updating shape offset:",{placementId:n,shapeKey:e,oldOffset:i.shapeOffsets[e]||0,newOffset:s,baseRow:i.row,targetRow:i.row+s}),i.shapeOffsets[e]=s,this.emit("stampPlacementsChanged")},getShapeRow(n,e){var i;const s=((i=n.shapeOffsets)==null?void 0:i[e])||0;return n.row+s}};T.moduleLoaded("TripletActions","triplets");function u0(){return`triplet-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const d0={addTripletPlacement(n){this.state.tripletPlacements||(this.state.tripletPlacements=[]);const e=this.state.tripletPlacements.find(i=>i.row===n.row&&!(i.startCellIndex+i.span<=n.startCellIndex||n.startCellIndex+n.span<=i.startCellIndex));e&&this.removeTripletPlacement(e.id),this.state.stampPlacements&&this.state.stampPlacements.filter(a=>{if(a.row!==n.row)return!1;const r=Math.floor(a.startColumn/2),c=Math.floor(a.endColumn/2),h=n.startCellIndex+n.span-1;return!(c<n.startCellIndex||r>h)}).forEach(a=>this.removeStampPlacement(a.id));const s={id:u0(),...n};return this.state.tripletPlacements.push(s),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),T.debug("TripletActions",`Added triplet ${n.stampId} at cell ${n.startCellIndex}, row ${n.row}`,{stampId:n.stampId,startCellIndex:n.startCellIndex,span:n.span,row:n.row,placementId:s.id},"triplets"),s},removeTripletPlacement(n){if(!this.state.tripletPlacements)return!1;const e=this.state.tripletPlacements.findIndex(i=>i.id===n);if(e===-1)return!1;const s=this.state.tripletPlacements.splice(e,1)[0];return this.emit("tripletPlacementsChanged"),T.debug("TripletActions",`Removed triplet ${s.stampId} at cell ${s.startCellIndex}, row ${s.row}`,{placementId:n,stampId:s.stampId,startCellIndex:s.startCellIndex,span:s.span,row:s.row},"triplets"),!0},eraseTripletsInArea(n,e,s,i){if(!this.state.tripletPlacements)return!1;const a=Math.floor(n/2),r=Math.floor(e/2),c=[];for(const m of this.state.tripletPlacements)m.row>=s&&m.row<=i&&(m.startCellIndex+m.span-1<a||m.startCellIndex>r||c.push(m.id));let h=!1;return c.forEach(m=>{this.removeTripletPlacement(m)&&(h=!0)}),h},getAllTripletPlacements(){return[...this.state.tripletPlacements||[]]},getTripletAt(n,e){return this.state.tripletPlacements&&this.state.tripletPlacements.find(s=>s.row===e&&n>=s.startCellIndex&&n<s.startCellIndex+s.span)||null},clearAllTripletPlacements(){if(!this.state.tripletPlacements)return;const n=this.state.tripletPlacements.length>0;this.state.tripletPlacements=[],n&&(this.emit("tripletPlacementsChanged"),T.info("TripletActions","Cleared all triplet placements",null,"triplets"))},getTripletPlaybackData(){return this.state.tripletPlacements?this.state.tripletPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{startCellIndex:n.startCellIndex,stampId:n.stampId,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,span:n.span,placement:n}}).filter(n=>n.pitch):[]},updateTripletShapeOffset(n,e,s){const i=this.state.tripletPlacements.find(a=>a.id===n);if(!i){console.warn("[TRIPLET SHAPE OFFSET] Placement not found:",n);return}i.shapeOffsets||(i.shapeOffsets={}),console.log("[TRIPLET SHAPE OFFSET] Updating shape offset:",{placementId:n,shapeKey:e,oldOffset:i.shapeOffsets[e]||0,newOffset:s,baseRow:i.row,targetRow:i.row+s}),i.shapeOffsets[e]=s,this.emit("tripletPlacementsChanged")},getTripletShapeRow(n,e){var i;const s=((i=n.shapeOffsets)==null?void 0:i[e])||0;return n.row+s}};T.moduleLoaded("Store","general");const Eh="studentNotationState";function p0(){var n;try{const e=localStorage.getItem(Eh);if(e===null)return;const s=JSON.parse(e);if(s.timbres)for(const i in s.timbres){const a=s.timbres[i];if(a.coeffs&&typeof a.coeffs=="object"){const r=Array.isArray(a.coeffs)?a.coeffs:Object.values(a.coeffs);a.coeffs=new Float32Array(r)}if(a.phases&&typeof a.phases=="object"){const r=Array.isArray(a.phases)?a.phases:Object.values(a.phases);a.phases=new Float32Array(r)}}if(s.paint){const i=hp.paint||{},a=s.paint;s.paint={...i,...a,paintSettings:{...i.paintSettings,...a.paintSettings||{}}}}if(s.pitchRange){const i=(Pe==null?void 0:Pe.length)||((n=s.fullRowData)==null?void 0:n.length)||0,a=Math.max(0,i-1),r=Math.max(0,Math.min(a,s.pitchRange.topIndex??0)),c=Math.max(r,Math.min(a,s.pitchRange.bottomIndex??a));s.pitchRange={topIndex:r,bottomIndex:c}}return s}catch(e){T.error("Store","Could not load state from localStorage",e,"general");return}}function Ip(n){try{const e=JSON.parse(JSON.stringify({placedNotes:n.placedNotes,placedChords:n.placedChords,tonicSignGroups:n.tonicSignGroups,stampPlacements:n.stampPlacements,tripletPlacements:n.tripletPlacements,timbres:n.timbres,macrobeatGroupings:n.macrobeatGroupings,macrobeatBoundaryStyles:n.macrobeatBoundaryStyles,hasAnacrusis:n.hasAnacrusis,baseMicrobeatPx:n.baseMicrobeatPx,modulationMarkers:n.modulationMarkers,tempo:n.tempo,activeChordIntervals:n.activeChordIntervals,selectedNote:n.selectedNote,annotations:n.annotations,pitchRange:n.pitchRange,snapZoomToRange:n.snapZoomToRange,paint:{paintHistory:n.paint.paintHistory,paintSettings:n.paint.paintSettings}}));if(n.timbres)for(const i in n.timbres)n.timbres[i].coeffs&&e.timbres[i]&&(e.timbres[i].coeffs=Array.from(n.timbres[i].coeffs)),n.timbres[i].phases&&e.timbres[i]&&(e.timbres[i].phases=Array.from(n.timbres[i].phases));const s=JSON.stringify(e);localStorage.setItem(Eh,s)}catch(e){T.error("Store","Could not save state to localStorage",e,"general")}}const Sd={...Av,...Ky,...t0,...i0,...a0,...r0,...l0,...h0,...d0,clearSavedState(){try{localStorage.removeItem(Eh),localStorage.removeItem("effectDialValues"),window.location.reload()}catch(n){T.error("Store","Could not clear state from localStorage",n,"general")}}},Go={},Rp=p0(),m0={...hp,...Rp},u={state:m0,on(n,e){Go[n]||(Go[n]=[]),Go[n].push(e)},emit(n,e){Go[n]&&Go[n].forEach(s=>{try{s(e)}catch(i){T.error("Store",`Error in listener for event "${n}"`,i,"general")}})}};for(const n in Sd)u[n]=Sd[n].bind(u);const f0=u.recordState;u.recordState=function(...n){f0.apply(this,n),Ip(this.state)};Rp||Ip(u.state);const g0=Object.freeze(Object.defineProperty({__proto__:null,default:u},Symbol.toStringTag,{value:"Module"}));let Mc=null,Ec=null;const Ph={setContexts({ctx:n,drumCtx:e}){Mc=n,Ec=e},getPitchContext(){return Mc||console.error("CanvasContextService: Pitch context requested before it was set."),Mc},getDrumContext(){return Ec||console.error("CanvasContextService: Drum context requested before it was set."),Ec}},ii=ao,Js={blend:2,cutoff:31,resonance:0,type:"lowpass"};function Aa(){return{coeffs:new Float32Array(ii).fill(0),phases:new Float32Array(ii).fill(0)}}function v0(){const n=Aa();return n.coeffs[0]=1,n}function y0(){const n=Aa();for(let e=1;e<=ii;e+=2){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=0}return n}function b0(){const n=Aa();for(let e=1;e<=ii;e+=2){const s=e-1;n.coeffs[s]=1/(e*e),n.phases[s]=Math.PI/2}return n}function w0(){const n=Aa();for(let e=1;e<=ii;e++){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=e&1?0:Math.PI}return n}const _0={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function or(n){const e=Aa(),s=_0[n],i=Math.min(ii,s.amps.length);for(let a=0;a<i;a++)e.coeffs[a]=s.amps[a]||0,e.phases[a]=s.phases[a]||0;return e}const jo={attack:.1,decay:.2,sustain:.8,release:.3},x0={sine:{name:"sine",gain:1,adsr:jo,...v0(),filter:{...Js}},triangle:{name:"triangle",gain:.81,adsr:jo,...b0(),filter:{...Js}},square:{name:"square",gain:4/Math.PI,adsr:jo,...y0(),filter:{...Js}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:jo,...w0(),filter:{...Js}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:jo,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(ii).fill(0),filter:{...Js}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...Js}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...or("strings"),filter:{...Js,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...or("piano"),filter:{...Js,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...or("marimba"),filter:{...Js,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...or("woodwind"),filter:{...Js}}};function Vs(n,e){if(!n)return`rgba(204, 204, 204, ${e})`;const s=parseInt(n.slice(lp,id),yr),i=parseInt(n.slice(id,od),yr),a=parseInt(n.slice(od,bv),yr);return`rgba(${s}, ${i}, ${a}, ${e})`}function Vr(n,e){if(!n||typeof n!="string")return yv;const s=parseInt(n.slice(lp),yr),i=e<0?wv:_v,a=e<0?e*-1:e,r=s>>16,c=s>>8&255,h=s&255;return"#"+(16777216+(Math.round((i-r)*a)+r)*65536+(Math.round((i-c)*a)+c)*256+(Math.round((i-h)*a)+h)).toString(16).slice(1)}const S0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,C0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,T0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,A0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`;T.moduleLoaded("HarmonicBins with Columnar Structure");const xr={0:S0,90:C0,180:T0,270:A0},Rs=ao;let He,Me,we=new Float32Array(Rs).fill(0),Ft,ns=new Float32Array(Rs).fill(0);const kh=[],Qc=[];let Gi=!1,Ps=null;const $i=new Array(Rs).fill(null);let ar=!1;function ta(n,e){const{blend:s,cutoff:i,resonance:a}=e,r=(i-1)/30,c=20,h=n-r,m=r-n;let f=1/(1+Math.pow(Math.max(0,h*c),2)),g=1/(1+Math.pow(Math.max(0,m*c),2));const b=.01;f<b&&(f=0),g<b&&(g=0);const w=f*g;let x;s<=1?x=g*(1-s)+w*s:x=w*(2-s)+f*(s-1);const A=1-(a||0)/105,P=Math.max(.01,.2*A*A),M=Math.exp(-Math.pow((n-r)/P,2)),I=(a||0)/100*.6,D=x+M*I,R=Math.max(0,Math.min(1,D));return R<b?0:R}function M0(n,e){const s=e/100;return 1-s+s*n}let rr=new Float32Array(Rs).fill(1);new Float32Array(Rs).fill(0);function ya(n,e){const s=e.mix||0;if(s===0)return new Float32Array(n);const i=new Float32Array(n.length),a=s/100;for(let r=0;r<n.length;r++){const c=n[r],h=(r+.5)/Rs,m=ta(h,e);if(m<c){const g=(c-m)*a;i[r]=c-g}else i[r]=c;i[r]=Math.max(0,i[r])}return i}function Or(n){const e=u.state.timbres[n];if(!e)return new Float32Array(Rs);const s=e.filter;return s&&s.enabled!==!1&&(s.mix||0)>0?ya(e.coeffs,s):new Float32Array(e.coeffs)}function Jc(){var h;if((!He||!Me||!Ps)&&(He=document.getElementById("filter-overlay-canvas"),Ps=document.querySelector(".harmonic-bins-grid"),He&&(Me=He.getContext("2d"))),!He||!Me||!Ps)return;Ps.getBoundingClientRect();const{width:n,height:e}=He;Me.clearRect(0,0,n,e);const i=e*.95,a=e,r=(h=u.state.timbres[Ft])==null?void 0:h.filter,c=r&&r.enabled!==!1;if(r&&c){const m=r.mix||0;if(m===0){rr.fill(1);return}const f=[];for(let A=0;A<Rs;A++){const P=(A+.5)/Rs,M=ta(P,r);rr[A]=M0(M,m),f.push({bin:A+1,rawFilterAmp:M.toFixed(3),afterMix:rr[A].toFixed(3)})}Me.beginPath();const g=2;for(let A=0;A<=n;A+=g){const P=A/n,M=ta(P,r),I=a-M*i;A===0?Me.moveTo(A,I):Me.lineTo(A,I)}const w=.4+m/100*.6;Me.strokeStyle=Vs(Vr(Ft,-.3),w),Me.lineWidth=2.5,Me.stroke();const x=m/100;if(x>0){Me.beginPath(),Me.moveTo(0,0),Me.lineTo(n,0);const A=ta(1,r),P=a-A*i;Me.lineTo(n,P);for(let M=n;M>=0;M-=2){const I=M/n,D=ta(I,r),R=a-D*i;Me.lineTo(M,R)}Me.closePath(),Me.fillStyle=`rgba(255, 255, 255, ${x})`,Me.fill()}}else rr.fill(1)}function ca(){kh.forEach((n,e)=>{const s=n.sliderTrack.querySelector(".slider-fill"),i=n.sliderTrack.querySelector(".harmonic-label-internal"),a=we[e];if(s.style.height=`${a*100}%`,a>0){const c=Vr(Ft,-.1);s.style.backgroundColor=Vs(c,1)}else s.style.backgroundColor="transparent";const r=s.querySelector("canvas");r&&r.remove(),a>.1?(i.style.color="rgba(255, 255, 255, 0.35)",i.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(i.style.color="rgba(51, 51, 51, 0.5)",i.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),Jc()}function Pc(n,e=null){var m,f,g,b;if(console.log("[BINS DRAG] handleBinPointerEvent called",{clientX:n.clientX,clientY:n.clientY}),T.debug("HarmonicBins","handleBinPointerEvent called",{target:n.target.className},"filter"),n.target.classList.contains("phase-button")||n.target.closest(".phase-button")||n.target.tagName==="path"||n.target.tagName==="svg"){console.log("[BINS DRAG] Blocked - phase button element"),T.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(e===null){const w=Ps.getBoundingClientRect(),x=n.clientX-w.left,A=w.width/Rs;e=Math.floor(x/A),e=Math.max(0,Math.min(Rs-1,e)),console.log("[BINS DRAG] Calculated binIndex:",e,"from x:",x,"binWidth:",A)}T.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:e},"filter");const i=kh[e].sliderTrack.getBoundingClientRect(),a=n.clientY-i.top,r=i.height;we[e];const c=(r-a)/r,h=Math.max(0,Math.min(1,c));if(console.log("[BINS DRAG] Setting bin",e+1,"value:",h.toFixed(3)),(((f=(m=u.state.timbres[Ft])==null?void 0:m.adsr)==null?void 0:f.release)||0)*1e3,h===0){T.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:e},"filter");const w=new Float32Array(u.state.timbres[Ft].coeffs);w[e]=0,we[e]=0,u.setHarmonicCoefficients(Ft,w),$i[e]&&(clearTimeout($i[e]),$i[e]=null),Gi||(Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Gi=!0);const x=(g=u.state.timbres[Ft])==null?void 0:g.filter;x&&x.enabled!==!1&&(x.mix||0)>0&&ya(w,x),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),T.debug("HarmonicBins",`Set coefficient H${e+1} to 0 for color ${Ft}`,null,"filter")}else{$i[e]&&(clearTimeout($i[e]),$i[e]=null),Gi||(Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Gi=!0),T.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:u.state.timbres[Ft].coeffs},"filter");const w=new Float32Array(u.state.timbres[Ft].coeffs);T.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:w},"filter"),w[e]=h,we[e]=h,T.debug("HarmonicBins",`AFTER setting newCoeffs[${e}] = ${h}`,{newCoeffs:w},"filter"),u.setHarmonicCoefficients(Ft,w);const x=(b=u.state.timbres[Ft])==null?void 0:b.filter;x&&x.enabled!==!1&&(x.mix||0)>0&&ya(w,x),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),T.debug("HarmonicBins",`Updated coefficient H${e+1} to ${h} for color ${Ft}`,null,"filter"),T.debug("HarmonicBins","All coefficients",{newCoeffs:w},"filter")}ca()}function Kc(n,e,s,i){const a=s.coeffs,r=s.phases||new Float32Array(a.length).fill(0);let c=!0,h=!0;if(n.length!==a.length)c=!1;else for(let f=0;f<n.length;f++)if(Math.abs(n[f]-a[f])>.001){c=!1;break}if(e.length!==r.length)h=!1;else for(let f=0;f<e.length;f++)if(Math.abs(e[f]-r[f])>.001){h=!1;break}return c&&h}function Cd(n){if(!n)return;Ft=n;const e=u.state.timbres[n];e&&(e.filter?e.filter.enabled===void 0&&(e.filter.enabled=!0):e.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0},T.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:e.coeffs},"filter"),T.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:e.phases},"filter"),we&&Array.from(we),ns&&Array.from(ns),we=new Float32Array(e.coeffs),e.phases?ns=new Float32Array(e.phases):ns=new Float32Array(we.length).fill(0),Kc(we,ns,e),T.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:we},"filter"),T.debug("HarmonicBins","updateForNewColor - final phases",{phases:ns},"filter"),Qc.forEach(({phaseBtn:s},i)=>{if(!s)return;let r=(ns[i]||0)%(2*Math.PI);r<0&&(r+=2*Math.PI);const c=.1;let h=0;Math.abs(r-Math.PI/2)<c?h=90:Math.abs(r-Math.PI)<c?h=180:Math.abs(r-3*Math.PI/2)<c&&(h=270),s.innerHTML=xr[h]}),ca())}function E0(){var h;const n=document.querySelector(".filter-container"),e=n==null?void 0:n.querySelector(".filter-bins-wrapper"),s=n==null?void 0:n.querySelector(".filter-vertical-blend-wrapper");if(!n||!e||!s){console.error("[FILTER] Missing required elements - aborting init");return}Ps=document.createElement("div"),Ps.className="harmonic-bins-grid";for(let m=0;m<Rs;m++){const f=document.createElement("div");f.className="slider-column";const g=document.createElement("div");g.className="slider-track";const b=document.createElement("div");b.className="slider-fill",g.appendChild(b);const w=document.createElement("div");w.className="harmonic-label-internal",w.textContent=`${m+1}`,g.appendChild(w),f.appendChild(g);const x=document.createElement("button");x.className="phase-button",x.innerHTML=xr[0],x.dataset.binIndex=m,x.addEventListener("pointerenter",A=>{var P,M,I,D;if(ar){console.log("[SNAP-TO-ZERO] 🎯 Drag entered phase button for bin",m+1);const R=.015,H=Q.now();if(u.state.timbres[Ft],(I=(M=(P=Gt.synths)==null?void 0:P[Ft])==null?void 0:M.activeNotes)!=null&&I.C4){const j=Gt.synths[Ft].activeNotes.C4;(D=j.oscillators)!=null&&D[m]&&(j.oscillators[m].volume.linearRampTo(-1/0,R,H),console.log("[SNAP-TO-ZERO] Applied smooth ramp for bin",m+1))}setTimeout(()=>{var Y;const j=new Float32Array(u.state.timbres[Ft].coeffs);j[m]=0,we[m]=0,u.setHarmonicCoefficients(Ft,j);const F=(Y=u.state.timbres[Ft])==null?void 0:Y.filter;F&&F.enabled!==!1&&(F.mix||0)>0&&ya(j,F),ca(),console.log("[SNAP-TO-ZERO] ✓ Bin",m+1,"snapped to ZERO via phase button drag")},R*1e3)}}),x.addEventListener("click",A=>{if(ar){console.log("[SNAP-TO-ZERO] Click blocked during drag"),A.preventDefault();return}T.debug("HarmonicBins","Phase button click handler started",null,"filter"),T.debug("HarmonicBins","Current coeffs before phase change",{coeffs:we},"filter"),A.preventDefault();const P=new Float32Array(ns),M=new Float32Array(ns);let D=(M[m]||0)%(2*Math.PI);D<0&&(D+=2*Math.PI);const R=.1;let H=0;Math.abs(D)<R?H=Math.PI/2:Math.abs(D-Math.PI/2)<R?H=Math.PI:Math.abs(D-Math.PI)<R?H=3*Math.PI/2:H=0,M[m]=H,ns=M,window.staticWaveformVisualizer&&window.staticWaveformVisualizer.startPhaseTransition&&window.staticWaveformVisualizer.startPhaseTransition(P,M,m),u.setHarmonicPhases(Ft,M);const j=H===0?0:Math.abs(H-Math.PI/2)<R?90:Math.abs(H-Math.PI)<R?180:270;x.innerHTML=xr[j],T.debug("HarmonicBins",`Phase button clicked for H${m+1}, new phase: ${j}°`,null,"filter")}),f.appendChild(x),Ps.appendChild(f),kh.push({column:f,label:w,sliderTrack:g,sliderFill:b,phaseBtn:x}),Qc.push({phaseBtn:x})}Ps.addEventListener("pointerdown",m=>{if(console.log("[BINS DRAG] Pointerdown event fired",{target:m.target,className:m.target.className}),m.target.classList.contains("phase-button")||m.target.closest(".phase-button")){console.log("[BINS DRAG] Blocked - phase button clicked"),T.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}console.log("[BINS DRAG] Starting drag interaction"),T.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),m.preventDefault(),ar=!0,console.log("[SNAP-TO-ZERO] Drag started - isDraggingBin = true"),Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Gi=!0,Pc(m);const f=b=>Pc(b),g=()=>{var w;window.removeEventListener("pointermove",f),window.removeEventListener("pointerup",g),ar=!1,console.log("[SNAP-TO-ZERO] Drag ended - isDraggingBin = false");const b=!!((w=window.staticWaveformVisualizer)!=null&&w.generateWaveform);console.log("[HarmonicBins] stopDrag invoked",{waveformAvailable:b,hasChanges:typeof Pc=="function"}),u.recordState(),Gt.triggerRelease("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!1}),Gi=!1,b?setTimeout(()=>{console.log("[HarmonicBins] Generating static waveform after drag"),window.staticWaveformVisualizer.generateWaveform()},0):console.warn("[HarmonicBins] Static waveform visualizer not ready when drag ended")};window.addEventListener("pointermove",f),window.addEventListener("pointerup",g)}),He=document.createElement("canvas"),He.id="filter-overlay-canvas",He.className="filter-overlay-canvas",He.style.pointerEvents="none",Me=He.getContext("2d"),Ps.appendChild(He);const i=document.createElement("div");i.className="vertical-blend-wrapper";const a=document.createElement("div");a.id="vertical-blend-track";const r=document.createElement("div");r.id="vertical-blend-thumb",r.textContent="M",a.appendChild(r),i.appendChild(a),e.appendChild(Ps),s.appendChild(i);const c=()=>{const m=He.getBoundingClientRect();(He.width!==m.width||He.height!==m.height)&&(He.width=m.width,He.height=m.height,Jc())};Ft=((h=u.state.selectedNote)==null?void 0:h.color)||"#4a90e2",Cd(Ft),u.on("timbreChanged",m=>{if(m===Ft){T.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const f=u.state.timbres[m],g=f.coeffs,b=f.phases;let w=!1;if(T.debug("HarmonicBins","Comparing coefficients...",null,"filter"),T.debug("HarmonicBins","Local coeffs",{coeffs:we},"filter"),T.debug("HarmonicBins","Store coeffs",{newCoeffs:g},"filter"),!we||we.length!==g.length)T.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),w=!0;else for(let x=0;x<g.length;x++){const A=Math.abs(we[x]-g[x]);if(A>.001){T.debug("HarmonicBins",`Coefficient ${x} changed: ${we[x]} -> ${g[x]} (diff: ${A})`,null,"filter"),w=!0;break}}T.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),Kc(we||new Float32Array(12),ns||new Float32Array(12),f),we=new Float32Array(g),b?ns=new Float32Array(b):ns=new Float32Array(we.length).fill(0),Kc(we,ns,f),w?(T.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),ca()):(T.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),Jc()),Qc.forEach(({phaseBtn:x},A)=>{if(!x)return;let M=(ns[A]||0)%(2*Math.PI);M<0&&(M+=2*Math.PI);const I=.1;let D=0;Math.abs(M-Math.PI/2)<I?D=90:Math.abs(M-Math.PI)<I?D=180:Math.abs(M-3*Math.PI/2)<I&&(D=270),x.innerHTML=xr[D]})}}),u.on("noteChanged",({newNote:m})=>{m.color&&m.color!==Ft&&Cd(m.color)}),u.on("filterChanged",m=>{if(m===Ft){ca();const f=u.state.timbres[Ft],g=f==null?void 0:f.filter;g&&g.enabled!==!1&&(g.mix||0)>0?ya(f.coeffs,g):new Float32Array(f.coeffs)}}),new ResizeObserver(c).observe(Ps),c(),T.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}T.moduleLoaded("SynthEngine");const ha=8,Dp=1/Math.sqrt(ha),P0=200,k0=50;let Ks={},Fn,qi,kc,lr,Ic,es={},ji=0,Uo=ha;function I0(){if(!Fn)return;const n=Q.now();if(ji===0){Uo=.01*ha+(1-.01)*Uo;return}const e=1-Math.exp(-.016/(P0/1e3)),s=Math.max(1,Math.min(ha,ji));Uo=e*s+(1-e)*Uo;const i=Math.sqrt(ha/Uo),a=Dp*i;Fn.gain.rampTo(a,k0/1e3,n)}class R0 extends Q.Synth{constructor(e){super(e),this.presetGain=new Q.Gain(e.gain||1),this.vibratoLFO=new Q.LFO(0,0),this.vibratoDepth=new Q.Scale(-1,1),this.vibratoGain=new Q.Gain(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new Q.LFO(0,0),this.tremoloDepth=new Q.Scale(0,1),this.tremoloGain=new Q.Gain(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new Q.Filter({type:"highpass"}),this.lpFilterForBP=new Q.Filter({type:"lowpass"}),this.lpFilterSolo=new Q.Filter({type:"lowpass"}),this.hpOutput=new Q.Gain,this.bpOutput=new Q.Gain,this.lpOutput=new Q.Gain,this.hp_bp_fade=new Q.CrossFade(0),this.main_fade=new Q.CrossFade(0),this.wetDryFade=new Q.CrossFade(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),e.filter&&this._setFilter(e.filter),e.vibrato?this._setVibrato(e.vibrato):this._setVibrato({speed:0,span:0}),e.tremelo?this._setTremolo(e.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(e){this.presetGain&&(this.presetGain.gain.value=e)}_setVibrato(e,s=Q.now()){if(this.vibratoLFO&&this.vibratoGain){const i=e.speed/100*16;if(e.speed===0||e.span===0){this.vibratoLFO.stop(s),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(s),this.vibratoLFO.frequency.value=i;const r=e.span/100*50,c=r/1200,f=440*(Math.pow(2,c)-1);this.vibratoGain.gain.value=f,console.log("Audio vibrato gain set to:",f,"Hz (for",r,"cents)")}}_setTremolo(e,s=Q.now()){if(this.tremoloLFO&&this.tremoloGain){const i=e.speed/100*16;if(e.speed===0||e.span===0){this.tremoloLFO.stop(s),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(s),this.tremoloGain.gain.value=1;return}this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(s),this.tremoloLFO.frequency.value=i;const a=e.span/100,r=Math.max(0,1-a),c=1;this.tremoloDepth.min=r,this.tremoloDepth.max=c}}_setFilter(e){this.wetDryFade.fade.value=e.enabled?1:0;const s=Q.Midi(e.cutoff+35).toFrequency(),i=e.resonance/100*12+.1;this.hpFilter.set({frequency:s,Q:i}),this.lpFilterForBP.set({frequency:s,Q:i}),this.lpFilterSolo.set({frequency:s,Q:i});const a=e.blend;a<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=a):(this.main_fade.fade.value=a-1,this.hp_bp_fade.fade.value=1)}}const Gt={init(){Fn=new Q.Gain(Dp),qi=new Q.Volume(0),kc=new Q.Compressor({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),lr=new Q.Limiter(-3),Ic=new Q.Meter,Fn.connect(qi),qi.connect(kc),kc.connect(lr),lr.toDestination(),lr.connect(Ic),setInterval(()=>{Ic.getValue()},500);for(const e in u.state.timbres){const s=u.state.timbres[e],i=Or(e),a=i.reduce((f,g)=>f+Math.abs(g),0),r=a>1?i.map(f=>f/a):i,c=s.gain||1,h=new Q.PolySynth({polyphony:8,voice:R0,options:{oscillator:{type:"custom",partials:Array.from(r)},envelope:s.adsr,filter:s.filter,vibrato:s.vibrato,tremelo:s.tremelo,gain:c}}).connect(Fn);window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(h,e,Fn);const m=h.triggerAttack;h.triggerAttack=function(...f){const g=m.apply(this,f);return setTimeout(()=>{const b=this._activeVoices;window.audioEffectsManager?b&&b.size>0?b.forEach((w,x)=>{w.effectsApplied||(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,x)=>{w&&!w.effectsApplied&&(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):b&&b.size>0?b.forEach((w,x)=>{w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,x)=>{w&&w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w&&w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)})},10),g},h._currentVibrato=s.vibrato,h._currentTremolo=s.tremelo,h._currentFilter=s.filter,Ks[e]=h,T.debug("SynthEngine",`Created filtered synth for color: ${e}`,null,"audio")}u.on("timbreChanged",e=>{this.updateSynthForColor(e)}),u.on("filterChanged",e=>{this.updateSynthForColor(e)}),u.on("audioEffectChanged",({effectType:e,parameter:s,value:i,color:a,effectParams:r})=>{this.updateSynthForColor(a)}),u.on("volumeChanged",e=>this.setVolume(e)),setInterval(()=>{I0()},16),T.info("SynthEngine","Initialized with multi-timbral support",null,"audio"),window.synthEngine=this},updateSynthForColor(n){const e=u.state.timbres[n],s=Ks[n];if(!s||!e)return;e.vibrato||(e.vibrato={speed:0,span:0},T.debug("SynthEngine",`Initialized vibrato for color ${n}`,e.vibrato,"audio")),e.tremelo||(e.tremelo={speed:0,span:0},T.debug("SynthEngine",`Initialized tremolo for color ${n}`,e.tremelo,"audio")),T.debug("SynthEngine",`Updating timbre for color ${n}`,null,"audio");const i=Or(n),a=i.reduce((h,m)=>h+Math.abs(m),0),r=a>1?i.map(h=>h/a):i;s.set({oscillator:{partials:Array.from(r)},envelope:e.adsr}),window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(s,n,Fn),s._currentVibrato=e.vibrato,s._currentTremolo=e.tremelo,s._currentFilter=e.filter;const c=s._activeVoices;c&&c.size>0?c.forEach((h,m)=>{if(h._setFilter&&h._setFilter(e.filter),h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}}):s._voices&&Array.isArray(s._voices)&&s._voices.forEach((h,m)=>{if(h&&h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h&&h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h&&h._setFilter&&h._setFilter(e.filter),h&&h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}})},setVolume(n){qi&&(qi.volume.value=n)},async playNote(n,e,s=Q.now()){var c;await(window.initAudio||(()=>Q.start()))();const a=(c=u.state.selectedNote)==null?void 0:c.color,r=a?Ks[a]:null;r&&r.triggerAttackRelease(n,e,s)},triggerAttack(n,e,s=Q.now(),i=!1){const a=Ks[e];if(a)if(ji++,i&&window.getDrumVolume){const r=window.getDrumVolume(),c=a.volume.value,h=c+20*Math.log10(r);a.volume.value=h,a.triggerAttack(n,s),setTimeout(()=>{a&&a.volume&&(a.volume.value=c)},100)}else a.triggerAttack(n,s)},triggerRelease(n,e,s=Q.now()){const i=Ks[e];i&&(i.triggerRelease(n,s),ji=Math.max(0,ji-1))},releaseAll(){for(const n in Ks)Ks[n].releaseAll();ji=0},createWaveformAnalyzer(n){const e=Ks[n];return e?(es[n]||(es[n]=new Q.Analyser("waveform",1024),e.connect(es[n]),T.debug("SynthEngine",`Created waveform analyzer for color: ${n}`,null,"waveform")),es[n]):(T.warn("SynthEngine",`No synth found for color: ${n}`,null,"audio"),null)},getWaveformAnalyzer(n){return es[n]||null},getAllWaveformAnalyzers(){const n=new Map;for(const e in es)es[e]&&n.set(e,es[e]);return n},removeWaveformAnalyzer(n){es[n]&&(es[n].dispose(),delete es[n],T.debug("SynthEngine",`Removed waveform analyzer for color: ${n}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const n in es)es[n]&&es[n].dispose();es={},T.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(n){return Ks[n]||null},getAllSynths(){return{...Ks}},getMainVolumeNode(){return qi||null},getMasterGainNode(){return Fn||null}},_s={adsrComponent:null};class D0{constructor(){this.elements=new Map,this.initialized=!1}init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("pitchPaintCanvas","pitch-paint-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","frequency-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(e,s){const i=document.getElementById(s);i&&this.elements.set(e,i)}get(e){return this.initialized&&this.elements.get(e)||null}getMultiple(...e){const s={};return e.forEach(i=>{s[i]=this.get(i)}),s}has(e){return this.elements.has(e)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const e=this.elements.size,s=Array.from(this.elements.values()).filter(i=>i!==null).length;return{totalCached:e,foundElements:s,missingElements:e-s}}}const oi=new D0;u.on("modulationMarkersChanged",()=>{L0()});u.on("scrollChanged",()=>{ua=null,da=null});u.on("zoomChanged",()=>{ua=null,da=null});let ea=null,th=null,ua=null,da=null;function Op(n){const e=JSON.stringify({markers:n.modulationMarkers||[],baseMicrobeatPx:n.baseMicrobeatPx||n.cellWidth||40});if(ea&&e===th)return ea;const s=n.baseMicrobeatPx||n.cellWidth||40;return ea=kp(n.modulationMarkers||[],s,n),th=e,ea}function Np(){const n=performance.now();return(!ua||!da||n-da>1)&&(ua=xt.getViewportInfo(),da=n),ua}function mt(n,e){let s=0;const i=Math.floor(n),a=n-i;for(let f=0;f<i;f++){const g=e.columnWidths[f]||0;s+=g*e.cellWidth}if(a>0&&i<e.columnWidths.length){const f=e.columnWidths[i]||0;s+=a*f*e.cellWidth}if(!e.modulationMarkers||e.modulationMarkers.length===0)return s;const r=Op(e),c=e.baseMicrobeatPx||e.cellWidth||40,h=s/c;return r.microbeatToCanvasX(h)}function Rt(n,e){const s=Np(),i=n-s.startRank,a=e.cellHeight/2;return i*a}function Sr(n){let e=(n||"").replace(/\d/g,"").trim();return e=e.replace(/b/g,"♭").replace(/#/g,"♯"),e}function O0(n,e=1){switch(n){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"E♭/D♯":case"D♭/C♯":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function N0(){const n=xt.getViewportInfo(),{startRank:e,endRank:s}=n;return{startRow:e,endRow:s}}function L0(){ea=null,th=null}function F0(n,e){if(e.modulationMarkers&&e.modulationMarkers.length>0){const r=Op(e),c=e.baseMicrobeatPx||e.cellWidth||40;return r.canvasXToMicrobeat(n)*c/e.cellWidth}let s=0;const{columnWidths:i,cellWidth:a}=e;if(a===0)return 0;for(let r=0;r<i.length;r++){const c=i[r]*a;if(n<s+c){const h=(n-s)/c;return r+h}s+=c}return i.length-1}function B0(n,e){const s=Np(),i=e.cellHeight/2;return n/i+s.startRank}class $0{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.activeAnimations=new Map,this.popDuration={scaleUp:100,scaleDown:300},this.popScale=1.5}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),u.on("tempoChanged",()=>this.invalidateTimeMap()))}handlePlaybackStateChange(){u.state.isPlaying&&!u.state.isPaused?this.startRendering():this.stopRendering()}invalidateTimeMap(){this._lastTempo=0}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.isPlaying||u.state.isPaused||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.calculateXFromTime(Q.Transport.seconds);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0,this.animationFrameId=requestAnimationFrame(()=>this.render())}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let i=0;i<u.state.columnWidths.length;i++)this.timeMap[i]=e,e+=u.state.columnWidths[i]*s;this.timeMap.push(e)}getColumnX(e){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const i={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return mt(e,i)}else return xt.getColumnX(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const i=this.timeMap[s],a=this.timeMap[s+1]-i,r=e-i,c=this.getColumnX(s),h=this.getColumnX(s+1)-c;return c+(a>0?r/a*h:0)}return null}triggerNotePop(e,s){const i=`${e}-${s}`;this.activeAnimations.set(i,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(e,s){const i=`${e}-${s}`,a=this.activeAnimations.get(i);if(!a)return 1;const r=performance.now(),c=r-a.startTime;if(a.phase==="scaleUp"){if(c>=this.popDuration.scaleUp)return a.phase="scaleDown",a.startTime=r,this.popScale;{const h=c/this.popDuration.scaleUp;return 1+(this.popScale-1)*h}}else if(a.phase==="scaleDown"){if(c>=this.popDuration.scaleDown)return this.activeAnimations.delete(i),1;{const h=c/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*h}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const e=performance.now();for(const[s,i]of this.activeAnimations.entries()){const a=e-i.startTime,r=i.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;a>r&&this.activeAnimations.delete(s)}}}const Wn=new $0,eh=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function Hr(n){return eh.find(e=>e.id===n)}T.moduleLoaded("StampPlacements","stamps");function q0(n,e,s,i="#4a90e2"){return Hr(n)?u.addStampPlacement(n,e,s,i):(T.warn("StampPlacements",`Invalid stamp ID: ${n}`,{stampId:n},"stamps"),null)}function z0(n,e,s,i){return console.log("[STAMP ERASE] Function called with:",{eraseStartCol:n,eraseEndCol:e,eraseStartRow:s,eraseEndRow:i,totalStamps:u.state.stampPlacements.length,allStampPlacements:u.state.stampPlacements.map(a=>({id:a.id,startCol:a.startColumn,endCol:a.endColumn,row:a.row}))}),u.eraseStampsInArea(n,e,s,i)}function W0(){u.clearAllStamps()}function V0(){return u.getStampPlaybackData()}T.moduleLoaded("StampScheduler","stamps");const cr=["0","16n","8n",{"8n":1,"16n":1}];function Lp(n,e=null){const s=Hr(n);if(!s)return T.warn("StampScheduler",`Unknown stamp ID: ${n}`,{stampId:n},"stamps"),[];const i=[];return s.ovals.forEach(a=>{var h;const r=`oval_${a}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[r])||0;i.push({offset:cr[a],duration:"8n",type:"oval",slot:a,shapeKey:r,rowOffset:c}),console.log(`[STAMP DEBUG] Stamp ${n} oval at slot ${a} with offset "${cr[a]}", rowOffset: ${c}`)}),s.diamonds.forEach(a=>{var h;const r=`diamond_${a}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[r])||0;i.push({offset:cr[a],duration:"16n",type:"diamond",slot:a,shapeKey:r,rowOffset:c}),console.log(`[STAMP DEBUG] Stamp ${n} diamond at slot ${a} with offset "${cr[a]}", rowOffset: ${c}`)}),console.log(`[STAMP DEBUG] Total events for stamp ${n}:`,i.length,i),i}function Td(n,e,s){return[{id:e+0,span:n,hits:[0],label:`${s} [1]`},{id:e+1,span:n,hits:[1],label:`${s} [2]`},{id:e+2,span:n,hits:[2],label:`${s} [3]`},{id:e+3,span:n,hits:[0,1],label:`${s} [1 2]`},{id:e+4,span:n,hits:[1,2],label:`${s} [2 3]`},{id:e+5,span:n,hits:[0,2],label:`${s} [1 3]`},{id:e+6,span:n,hits:[0,1,2],label:`${s} [1 2 3]`}]}const sh=[...Td("eighth",1,"8th triplet"),...Td("quarter",8,"Quarter triplet")],Fp={eighth:1,quarter:2},Bp=[16.6667,50,83.3333];function ai(n){return sh.find(e=>e.id===n)}T.moduleLoaded("TripletPlacements","triplets");function H0(n,e,s,i="#4a90e2"){const a=ai(n);if(!a)return T.warn("TripletPlacements",`Invalid triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),null;const r=Fp[a.span];if(!G0(e,r,s))return T.debug("TripletPlacements",`Cannot place triplet at cell ${e}, row ${s} - collision detected`,{tripletStampId:n,startCellIndex:e,row:s,span:r},"triplets"),null;const c={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,stampId:n,startCellIndex:e,span:r,row:s,color:i,timestamp:Date.now()};return u.addTripletPlacement(c)}function G0(n,e,s){const i=u.state;if(i.stampPlacements){for(const a of i.stampPlacements)if(a.row===s){const r=Math.floor(a.startColumn/2),c=Math.floor(a.endColumn/2);for(let h=0;h<e;h++){const m=n+h;if(m>=r&&m<=c)return!1}}}if(i.tripletPlacements){for(const a of i.tripletPlacements)if(a.row===s){const r=a.startCellIndex+a.span-1;if(!(n+e-1<a.startCellIndex||n>r))return!1}}return!0}function j0(n,e,s,i){const a=u.state;if(!a.tripletPlacements)return!1;const r=Math.floor(n/2),c=Math.floor(e/2),h=[];for(const m of a.tripletPlacements)m.row>=s&&m.row<=i&&(m.startCellIndex+m.span-1<r||m.startCellIndex>c||h.push(m.id));return h.length>0?(h.forEach(m=>u.removeTripletPlacement(m)),T.debug("TripletPlacements",`Erased ${h.length} triplet groups`,{removedIds:h,eraseArea:{eraseStartCell:r,eraseEndCell:c,eraseStartRow:s,eraseEndRow:i}},"triplets"),!0):!1}function U0(){const n=u.state;return n.tripletPlacements?n.tripletPlacements.map(e=>({startCellIndex:e.startCellIndex,stampId:e.stampId,row:e.row,color:e.color,span:e.span,placement:e})):[]}function X0(){u.clearAllTripletPlacements(),T.info("TripletPlacements","Cleared all triplet placements",null,"triplets")}T.moduleLoaded("TripletScheduler","triplets");function Y0(n){return Q.Time(`${n} * 4n`).toSeconds()}function $p(n,e=null){const s=ai(n);if(!s)return T.warn("TripletScheduler",`Unknown triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),[];const i=[],a=s.span==="eighth"?"8t":"4t",r=a;return s.hits.forEach(c=>{var g;const h=`triplet_${c}`,m=((g=e==null?void 0:e.shapeOffsets)==null?void 0:g[h])||0;let f;if(c===0)f="0";else if(c===1)f=a;else if(c===2){const b=Q.Time(a).toSeconds();f=Q.Time(b*2).toNotation()}else{const b=Q.Time(a).toSeconds();f=Q.Time(b*c).toNotation()}i.push({offset:f,duration:r,type:s.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:c,shapeKey:h,rowOffset:m}),T.debug("TripletScheduler",`Triplet stamp ${n} ${s.span} at slot ${c} with offset "${f}", rowOffset: ${m}`,"triplets")}),T.debug("TripletScheduler",`Total events for triplet stamp ${n}:`,i.length,"triplets"),i}function qp(n,e){const{startCellIndex:s,stampId:i,pitch:a}=n,r=ai(i);if(!r){T.warn("TripletScheduler",`Cannot schedule unknown triplet stamp ID: ${i}`,{stampId:i},"triplets");return}const c=Y0(s),h=r.span==="eighth"?"8t":"4t",m=Q.Time(h).toSeconds();T.debug("TripletScheduler","Scheduling triplet group",{startCellIndex:s,stampId:i,pitch:a,groupStart:c,stepStr:h,stepSec:m,hits:r.hits},"triplets"),r.hits.forEach(f=>{const g=c+f*m;e.triggerAttackRelease(a,m,g),T.debug("TripletScheduler","Scheduled triplet note",{slot:f,triggerTime:g,duration:m,pitch:a},"triplets")})}function Z0(n){n.forEach(e=>{qp({startCellIndex:e.startCellIndex,stampId:e.stampId,pitch:e.pitch},e.synth)})}function nh(n){const e=ai(n);return e?Fp[e.span]:1}function Q0(n,e,s=[]){const i=nh(e);for(let a=0;a<i;a++){const r=n+a;if(s.some(h=>h.cellIndex===r||h.tripletGroup&&h.tripletGroup.startCellIndex<=r&&r<h.tripletGroup.startCellIndex+nh(h.tripletGroup.stampId)))return T.debug("TripletScheduler",`Triplet placement conflict at cell ${r}`,{startCellIndex:n,tripletStampId:e,span:i},"triplets"),!1}return!0}const J0=Object.freeze(Object.defineProperty({__proto__:null,canPlaceTripletGroup:Q0,getTripletGroupSpan:nh,getTripletScheduleEvents:$p,scheduleTripletGroup:qp,scheduleTripletGroups:Z0},Symbol.toStringTag,{value:"Module"}));function zp(n,e,s){const{cellWidth:i}=s,a=i*.25;if(!n.uuid)return 0;const r=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid);if(r.length===0)return 0;const c=[n,...r];return c.sort((m,f)=>{const g=parseInt(m.uuid.split("-")[1]),b=parseInt(f.uuid.split("-")[1]);return g-b}),c.findIndex(m=>m.uuid===n.uuid)*a}function Wp(n,e){const{cellHeight:s}=e;return(window.animationEffectsManager?window.animationEffectsManager.shouldAnimateNote(n):!1)?(window.animationEffectsManager?window.animationEffectsManager.getVibratoYOffset(n.color):0)*s:0}function Vp(n,e,s,i,a,r){if(!window.animationEffectsManager||!window.animationEffectsManager.shouldFillNote(e))return;const h=window.animationEffectsManager.getFillLevel(e);if(h<=0)return;n.save();const m=1-h,f=n.createRadialGradient(s,i,0,s,i,Math.max(a,r));f.addColorStop(0,"transparent"),f.addColorStop(Math.max(0,m-.05),"transparent"),f.addColorStop(m,e.color+"1F"),f.addColorStop(1,e.color+"BF"),n.beginPath(),n.ellipse(s,i,a,r,0,0,2*Math.PI),n.clip(),n.fillStyle=f,n.fillRect(s-a-10,i-r-10,(a+10)*2,(r+10)*2),n.restore()}function K0(n,e,s){const{cellHeight:i}=s,a=i/2*.12;if(!n.uuid)return 0;const r=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid&&m.endColumnIndex>m.startColumnIndex);if(r.length===0)return 0;const c=[n,...r];return c.sort((m,f)=>{const g=parseInt(m.uuid.split("-")[1]),b=parseInt(f.uuid.split("-")[1]);return g-b}),c.findIndex(m=>m.uuid===n.uuid)*a}function Hp(n,e,s,i,a,r){var m;console.log("🎵 [SCALE/MODE] drawScaleDegreeText called:",{degreeDisplayMode:s.degreeDisplayMode,noteRow:e.row,noteStartCol:e.startColumnIndex,pitch:(m=s.fullRowData[e.row])==null?void 0:m.pitch});const c=Zc.getDegreeForNote(e,s);if(console.log("🎵 [SCALE/MODE] TonalService returned:",{degreeStr:c,degreeDisplayMode:s.degreeDisplayMode}),!c)return;const h=(e.shape==="oval"?r*uv:r*dv)*s.zoomLevel;h<pv||(n.fillStyle="#212529",n.font=`bold ${h}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(c,i,a))}function Ih(n,e,s,i){const{cellWidth:a,cellHeight:r,zoomLevel:c}=e,h=Rt(i,e),m=Wp(s,e),f=h+m,g=mt(s.startColumnIndex,e);let b;e.modulationMarkers&&e.modulationMarkers.length>0?b=mt(s.startColumnIndex+1,e)-g:b=a;const w=zp(s,u.state.placedNotes,e),x=g+b+w,A=Math.max(mv,b*fv);if(s.endColumnIndex>s.startColumnIndex){const D=mt(s.endColumnIndex+1,e)+w-w,R=K0(s,u.state.placedNotes,e),H=f+R;n.beginPath(),n.moveTo(x,H),n.lineTo(D,H),n.strokeStyle=s.color,n.lineWidth=Math.max(vv,b*gv),n.stroke()}const P=b-A/2,M=r/2-A/2;n.save(),Vp(n,s,x,f,P,M),n.beginPath(),n.ellipse(x,f,P,M,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=rp,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Hp(n,s,e,x,f,r/2)}function Rh(n,e,s,i){const{columnWidths:a,cellWidth:r,cellHeight:c,zoomLevel:h}=e,m=Rt(i,e),f=Wp(s,e),g=m+f,b=mt(s.startColumnIndex,e);let w;e.modulationMarkers&&e.modulationMarkers.length>0?w=mt(s.startColumnIndex+1,e)-b:w=a[s.startColumnIndex]*r;const x=zp(s,u.state.placedNotes,e),A=Math.max(.5,w*.15),P=b+w/2+x,M=w/2-A/2,I=c/2-A/2;n.save(),Vp(n,s,P,g,M,I),n.beginPath(),n.ellipse(P,g,M,I,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=rp,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Hp(n,s,e,P,g,c/2)}function Dh(n,e,s){const{cellWidth:i,cellHeight:a}=e,r=Rt(s.row,e),c=mt(s.columnIndex,e);let h;e.modulationMarkers&&e.modulationMarkers.length>0?h=mt(s.columnIndex+1,e)-c:h=i;const m=h*2,f=c+m/2,g=Math.min(m,a)/2*.9;if(g<2||(n.beginPath(),n.arc(f,r,g,0,2*Math.PI),n.strokeStyle="#212529",n.lineWidth=Math.max(.5,h*.05),n.stroke(),!s.tonicNumber))return;const b=s.tonicNumber.toString(),w=g*1.5;w<6||(n.fillStyle="#212529",n.font=`bold ${w}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(b,f,r))}function Rc(n){let e=0;for(let s=0;s<n;s++){const i=u.state.columnWidths[s]||0;e+=i*u.state.cellWidth}return e}function Dc(n){const e=u.state.fullRowData[n];return e?e.toneNote.replace("♭","b").replace("♯","#"):"C4"}T.moduleLoaded("TransportService");let qs,pa,re=[];function Oh(){return 60/(u.state.tempo*2)}function tb(){if(!u.state.hasAnacrusis)return re[2]||0;for(let n=0;n<u.state.macrobeatBoundaryStyles.length;n++)if(u.state.macrobeatBoundaryStyles[n]==="solid"){const e=cs(u.state,n+1);if(e)return re[e.startColumn]||0}return re[2]||0}function ih(){var a;T.debug("transportService","calculateTimeMap",{tempo:`${u.state.tempo} BPM`}),re=[];const n=Oh(),{columnWidths:e,modulationMarkers:s}=u.state,i=an(u.state);s&&s.length>0,eb(n,e,i),T.timing("transportService","calculateTimeMap",{totalDuration:`${(a=re[re.length-1])==null?void 0:a.toFixed(2)}s`})}function eb(n,e,s){let i=0;for(let a=0;a<e.length;a++)re[a]=i,s.some(c=>c.columnIndex===a)||(i+=e[a]*n);re.push(i)}function sb(n,e,s){let i=0;for(let a=0;a<n;a++){const r=e[a]||0;i+=r*s}return i}function Ad(n){const{modulationMarkers:e}=u.state;if(!e||e.length===0)return re[n];const s=Oh(),i=u.state.baseMicrobeatPx||u.state.cellWidth||40,a=kp(e,i,u.state),r=sb(n,u.state.columnWidths,i);return n0(r,a,s)}function nb(n){const e=u.state.fullRowData;return e&&e[n.row]?e[n.row].toneNote.replace("♭","b").replace("♯","#"):"C4"}function Oc(){var m,f;T.debug("transportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),Q.Transport.cancel(),ih(),(m=_s.adsrComponent)==null||m.playheadManager.clearAll();const n=re[2]||0,e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,s=(f=u.state.lassoSelection)==null?void 0:f.isActive,i=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="note").map(g=>g.id)):null;u.state.placedNotes.forEach(g=>{var M;if(s){const I=`note-${g.row}-${g.columnIndex}-${g.color}-${g.shape}`;if(!i.has(I))return}const b=re[g.startColumnIndex];if(e&&Ad(g.startColumnIndex),b===void 0)return;if(b<n){T.debug("transportService",`Skipping note at column ${g.startColumnIndex} (regular time ${b}) - before anacrusis offset (${n})`);return}const w=b;let x;const A=re[g.endColumnIndex+1];if(e&&Ad(g.endColumnIndex+1),A===void 0){T.warn("TransportService",`Skipping note with invalid endColumnIndex: ${g.endColumnIndex+1} (note ends at ${g.endColumnIndex})`,{noteId:g.uuid,startColumnIndex:g.startColumnIndex,endColumnIndex:g.endColumnIndex,lookupIndex:g.endColumnIndex+1,timeMapLength:re.length,maxValidIndex:re.length-1,noteShape:g.shape},"audio");return}const P=A-b;if(g.shape==="circle"?(x=P,Oh()):x=P,g.isDrum)Q.Transport.schedule(I=>{var D;u.state.isPaused||((D=pa==null?void 0:pa.player(g.drumTrack))==null||D.start(I),Wn.triggerNotePop(g.startColumnIndex,g.drumTrack))},w);else{const I=nb(g),D=g.color,R=((M=u.state.fullRowData[g.row])==null?void 0:M.hex)||"#888888",H=g.uuid,j=u.state.timbres[D];if(!j){T.warn("TransportService",`Timbre not found for color ${D}. Skipping note ${H}`,null,"audio");return}Q.Transport.schedule(Y=>{var tt;u.state.isPaused||(Gt.triggerAttack(I,D,Y),(tt=_s.adsrComponent)==null||tt.playheadManager.trigger(H,"attack",R,j.adsr),u.emit("noteAttack",{noteId:H,color:D}))},w);const F=w+x;Q.Transport.schedule(Y=>{var tt;Gt.triggerRelease(I,D,Y),(tt=_s.adsrComponent)==null||tt.playheadManager.trigger(H,"release",R,j.adsr),u.emit("noteRelease",{noteId:H,color:D})},F)}});const a=V0(),r=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="stamp").map(g=>g.id)):null;a.forEach(g=>{var x;if(s){const A=`stamp-${g.row}-${g.column}-${g.stampId}`;if(!r.has(A))return}const b=re[g.column];if(b===void 0)return;if(b<n){T.debug("TransportService",`Skipping stamp at column ${g.column} - before anacrusis offset`);return}const w=Lp(g.stampId,g.placement);w.forEach(A=>{const P=Q.Time(A.offset).toSeconds(),M=Q.Time(A.duration).toSeconds(),I=b+P,D=I+M,R=g.row+A.rowOffset,H=Dc(R);Q.Transport.schedule(j=>{u.state.isPaused||Gt.triggerAttack(H,g.color,j)},I),Q.Transport.schedule(j=>{u.state.isPaused||Gt.triggerRelease(H,g.color,j)},D)}),T.debug("TransportService",`Scheduled stamp ${g.stampId} with ${w.length} events at column ${g.column}`,{stampId:g.stampId,column:g.column,basePitch:g.pitch,baseRow:g.row,startTime:b,events:w.length,hasShapeOffsets:!!((x=g.placement)!=null&&x.shapeOffsets)},"audio")});const c=U0(),h=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="triplet").map(g=>g.id)):null;c.forEach(g=>{var A,P,M;if(s){const I=`triplet-${g.row}-${g.column}-${g.tripletId}`;if(!h.has(I))return}const b=g.startCellIndex*2,w=re[b];if(w===void 0)return;if(w<n){T.debug("TransportService",`Skipping triplet at cell ${g.startCellIndex} - before anacrusis offset`);return}console.log("[TRANSPORT DEBUG] Scheduling triplet:",{stampId:g.stampId,baseRow:g.row,hasPlacement:!!g.placement,hasShapeOffsets:!!((A=g.placement)!=null&&A.shapeOffsets),shapeOffsets:(P=g.placement)==null?void 0:P.shapeOffsets});const x=$p(g.stampId,g.placement);x.forEach(I=>{const D=Q.Time(I.offset).toSeconds(),R=Q.Time(I.duration).toSeconds(),H=w+D,j=H+R,F=g.row+I.rowOffset,Y=Dc(F);console.log("[TRANSPORT DEBUG] Scheduling shape:",{slot:I.slot,rowOffset:I.rowOffset,baseRow:g.row,shapeRow:F,shapePitch:Y}),Q.Transport.schedule(tt=>{u.state.isPaused||Gt.triggerAttack(Y,g.color,tt)},H),Q.Transport.schedule(tt=>{u.state.isPaused||Gt.triggerRelease(Y,g.color,tt)},j)}),T.debug("TransportService",`Scheduled triplet ${g.stampId} with ${x.length} events at cell ${g.startCellIndex}`,{stampId:g.stampId,cellIndex:g.startCellIndex,basePitch:Dc(g.row),baseRow:g.row,startTime:w,events:x.length,hasShapeOffsets:!!((M=g.placement)!=null&&M.shapeOffsets)},"audio")}),T.debug("TransportService","scheduleNotes",`Finished scheduling ${u.state.placedNotes.length} notes, ${a.length} stamps, and ${c.length} triplets`,"audio")}function Nc(){const n=oi.get("playheadCanvas");if(!n)return;const e=n.getContext("2d"),s=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,i=Rc(u.state.columnWidths.length-2),a=re[u.state.columnWidths.length-2]||0;let r=new Set;const c=u.state.tempo;let h=1;function m(){if(Q.Transport.state!=="started"||!n)return;const f=u.state.isLooping,g=Q.Transport.seconds;if(g>=a){T.info("TransportService","Playback reached end. Stopping playhead.",{currentTime:g,musicalDuration:a,isLooping:f},"transport"),Ui.stop();return}if(u.state.isPaused){qs=requestAnimationFrame(m);return}e.clearRect(0,0,n.width,n.height);let b=g;if(f){const A=Q.Transport.loopEnd-Q.Transport.loopStart;A>0&&(b=(g-Q.Transport.loopStart)%A+Q.Transport.loopStart)}let w=0;for(let A=0;A<re.length-1;A++)if(re[A]!==void 0&&b>=re[A]&&b<re[A+1]){const P=re[A],I=re[A+1]-P,D=b-P,R=Rc(A),H=Rc(A+1)-R,j=I>0?D/I:0;w=R+j*H;break}const x=Math.min(w,i);if(s&&u.state.modulationMarkers)for(const A of u.state.modulationMarkers){if(!A.active)continue;const P=A.xPosition||477.5;if(x>=P&&!r.has(A.id)){r.add(A.id);let M;Math.abs(A.ratio-2/3)<.001||Math.abs(A.ratio-3/2)<.001,M=1/A.ratio,h*=M;const I=c*h;Q.Transport.bpm.value=I}}x>0&&(e.strokeStyle="rgba(255,0,0,0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(x,0),e.lineTo(x,n.height),e.stroke()),qs=requestAnimationFrame(m)}m()}const Ui={init(){const n=new Q.Volume(0);if(pa=new Q.Players({H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"}).connect(n),window.synthEngine){const e=window.synthEngine.getMainVolumeNode&&window.synthEngine.getMainVolumeNode();e?n.connect(e):n.toDestination()}else n.toDestination();window.drumVolumeNode=n,window.transportService={drumPlayers:pa},Q.Transport.bpm.value=u.state.tempo,u.on("rhythmStructureChanged",()=>this.handleStateChange()),u.on("notesChanged",()=>this.handleStateChange()),u.on("stampPlacementsChanged",()=>this.handleStateChange()),u.on("modulationMarkersChanged",()=>this.handleStateChange()),u.on("tempoChanged",e=>{if(T.event("TransportService",`tempoChanged triggered with new value: ${e} BPM`,null,"transport"),Q.Transport.state==="started"){T.info("TransportService","Tempo changed WHILE PLAYING. Resynchronizing transport...",null,"transport");const s=Q.Transport.position;T.debug("TransportService",`Saved musical position: ${s}`,null,"transport"),Q.Transport.pause(),T.debug("TransportService","Transport paused",null,"transport"),qs&&(cancelAnimationFrame(qs),qs=null),Q.Transport.bpm.value=e,T.debug("TransportService",`New BPM set to ${Q.Transport.bpm.value}`,null,"transport"),Oc(),Q.Transport.start(void 0,s),T.debug("TransportService",`Transport restarted at musical position ${s}`,null,"transport"),u.state.paint.isMicPaintActive||Nc()}else T.debug("TransportService","Tempo changed while stopped/paused. Updating BPM for next run",null,"transport"),Q.Transport.bpm.value=e,ih()}),u.on("loopingChanged",e=>Q.Transport.loop=e),Q.Transport.on("stop",()=>{var e;T.event("TransportService","Tone.Transport 'stop' fired. Resetting playback state",null,"transport"),u.setPlaybackState(!1,!1),(e=_s.adsrComponent)==null||e.playheadManager.clearAll(),qs&&(cancelAnimationFrame(qs),qs=null)}),T.info("TransportService","Initialized",null,"transport")},handleStateChange(){if(Q.Transport.state==="started"){T.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling",null,"transport");const n=Q.Transport.position;Q.Transport.pause(),Oc(),Q.Transport.start(void 0,n)}else ih()},start(){T.info("TransportService","Starting playback",null,"transport"),(window.initAudio||(()=>Q.start()))().then(()=>{Oc();const e=re[u.state.columnWidths.length-2]||0,s=re[2]||0,i=tb();Q.Transport.loopStart=i,Q.Transport.loopEnd=e,Q.Transport.loop=u.state.isLooping,Q.Transport.bpm.value=u.state.tempo,T.debug("TransportService",`Transport configured. Loop: ${Q.Transport.loop}, BPM: ${Q.Transport.bpm.value}, StartOffset: ${s}, LoopStart: ${i}`,null,"transport"),u.state.modulationMarkers&&u.state.modulationMarkers.length>0,Q.Transport.start(Q.now(),s),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive?(u.emit("playbackStateChanged",{isPlaying:!0,isPaused:!1}),T.debug("TransportService","Paint playhead is active, skipping regular playhead animation",null,"transport")):Nc(),u.emit("playbackStarted")})},resume(){T.info("TransportService","Resuming playback",null,"transport"),(window.initAudio||(()=>Q.start()))().then(()=>{Q.Transport.start(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive||Nc(),u.emit("playbackResumed")})},pause(){T.info("TransportService","Pausing playback",null,"transport"),Q.Transport.pause(),qs&&(cancelAnimationFrame(qs),qs=null),u.emit("playbackPaused")},stop(){T.info("TransportService","Stopping playback and clearing visuals",null,"transport"),Q.Transport.stop(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStop&&window.PaintPlaybackService.onTransportStop(),Q.Transport.cancel(),Gt.releaseAll();const n=oi.get("playheadCanvas");n&&n.getContext("2d").clearRect(0,0,n.width,n.height),u.state.paint.isMicPaintActive&&u.emit("playbackStateChanged",{isPlaying:!1,isPaused:!1}),u.emit("playbackStopped")}};let hr=!1,Wi="C4",Nr=null,ls=[];function ib(n){const e=u.state.fullRowData[n.row];return e?e.toneNote:"C4"}function Md(){const n=u.state.placedNotes.slice().reverse().find(e=>!e.isDrum);Wi=n?ib(n):"C4"}function Ed(n){const{activeChordIntervals:e}=u.state;return!n||!e||!e.length?[]:e.map(s=>{const i=ia(n,s);return oa(i)})}function ob(){Md(),u.on("notesChanged",Md),document.addEventListener("keydown",n=>{var h,m;if(n.code!=="Space"||hr)return;const e=document.activeElement,s=e.tagName.toLowerCase(),i=e.contentEditable==="true";if(["input","textarea"].includes(s)||i)return;n.preventDefault(),hr=!0;const a=(h=u.state.selectedNote)==null?void 0:h.color;let r,c=[];if(Nr&&a){const f=u.state.fullRowData[Nr.row];r=f?f.toneNote:Wi,u.state.selectedTool==="chord"?c=Ed(r):c=[r]}else a&&Wi&&(r=Wi,u.state.selectedTool==="chord"?c=Ed(Wi):c=[Wi]);if(c.length>0){ls={pitches:[...c],rootNote:r,color:a},c.forEach(x=>{Gt.triggerAttack(x,a)});const f=u.state.fullRowData.find(x=>x.toneNote===r),g=f?f.hex:"#888888",b=u.state.timbres[a].adsr;(m=_s.adsrComponent)==null||m.playheadManager.trigger("spacebar","attack",g,b),u.emit("spacebarPlayback",{note:r,color:a,isPlaying:!0});const w=`spacebar-${Date.now()}`;u.emit("noteAttack",{noteId:w,color:a}),ls.noteId=w}}),document.addEventListener("keyup",n=>{var e;if(!(n.code!=="Space"||!hr)&&(n.preventDefault(),hr=!1,ls.pitches&&ls.pitches.length>0)){ls.pitches.forEach(r=>{Gt.triggerRelease(r,ls.color)});const s=u.state.fullRowData.find(r=>r.toneNote===ls.rootNote),i=s?s.hex:"#888888",a=u.state.timbres[ls.color].adsr;(e=_s.adsrComponent)==null||e.playheadManager.trigger("spacebar","release",i,a),u.emit("spacebarPlayback",{note:ls.rootNote,color:ls.color,isPlaying:!1}),ls.noteId&&u.emit("noteRelease",{noteId:ls.noteId,color:ls.color}),ls=[]}})}function ab(n,e){var i;Nr={col:n,row:e};const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&u.emit("ghostNoteUpdated",{color:s})}function Gp(){Nr=null,u.emit("ghostNoteCleared")}let Gr=!1,Nh=[],Cr=null;function jp(){Gr=!0}function rb(){Gr=!1}function Up(n){try{return JSON.parse(JSON.stringify(n,(e,s)=>s instanceof Float32Array?{__type:"Float32Array",data:Array.from(s)}:s))}catch{return null}}function oh(n,e,s="root"){const i=[];if(!n||!e)return i;if(typeof n!=typeof e)return i.push({path:s,type:"type_change",oldValue:typeof n,newValue:typeof e,timestamp:Date.now()}),i;if(typeof n!="object")return n!==e&&i.push({path:s,type:"value_change",oldValue:n,newValue:e,timestamp:Date.now()}),i;if(Array.isArray(n)){if(!Array.isArray(e))return i.push({path:s,type:"array_to_non_array",oldLength:n.length,newType:typeof e,timestamp:Date.now()}),i;n.length!==e.length&&i.push({path:s,type:"array_length_change",oldLength:n.length,newLength:e.length,timestamp:Date.now()});const r=Math.max(n.length,e.length);for(let c=0;c<r;c++){const h=oh(n[c],e[c],`${s}[${c}]`);i.push(...h)}return i}const a=new Set([...Object.keys(n),...Object.keys(e)]);for(const r of a)if(!(r in n))i.push({path:`${s}.${r}`,type:"property_added",newValue:e[r],timestamp:Date.now()});else if(!(r in e))i.push({path:`${s}.${r}`,type:"property_removed",oldValue:n[r],timestamp:Date.now()});else{const c=oh(n[r],e[r],`${s}.${r}`);i.push(...c)}return i}function lb(n){Gr&&(Cr=Up(n))}function Pd(n,e="unknown"){if(!Gr||!Cr)return;const s=Up(n),i=oh(Cr,s);if(i.length>0){const a=i.filter(r=>!r.path.includes("paint.paintHistory")&&!r.path.includes("tempo")&&!r.path.includes("isPlaying")&&!r.path.includes("fullRowData")&&!r.path.includes("columnWidths"));a.length>0&&(console.error("[STATE GUARD] Unauthorized state mutations detected!",{action:e,mutations:a,totalMutations:i.length,criticalMutations:a.length}),a.forEach(r=>{console.error("[STATE MUTATION]",{path:r.path,type:r.type,oldValue:r.oldValue,newValue:r.newValue,action:e})}),Nh.push({action:e,mutations:a,timestamp:Date.now()}))}Cr=s}function cb(){return[...Nh]}function hb(){Nh=[]}window.stateGuard={enable:jp,disable:rb,getLog:cb,clearLog:hb};T.moduleLoaded("KeyboardHandler","keyboard");function ub(){document.addEventListener("keydown",n=>{var r,c,h;const e=document.activeElement,s=e.tagName.toLowerCase(),i=e.contentEditable==="true";if(["input","textarea"].includes(s)||i)return;if(n.ctrlKey&&n.key.toLowerCase()==="p"){n.preventDefault(),T.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),u.emit("printPreviewStateChanged",!0);return}if(n.ctrlKey&&n.key.toLowerCase()==="z"){n.preventDefault(),u.undo();return}if(n.ctrlKey&&n.key.toLowerCase()==="y"){n.preventDefault(),u.redo();return}let a=!1;switch(n.key){case"Escape":(r=u.state.lassoSelection)!=null&&r.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),a=!0,T.debug("KeyboardHandler","Lasso selection cleared (Escape)",null,"keyboard"));break;case"Enter":(c=u.state.lassoSelection)!=null&&c.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),a=!0,T.debug("KeyboardHandler","Lasso selection cleared (Enter)",null,"keyboard"));break;case"Backspace":case"Delete":if((h=u.state.lassoSelection)!=null&&h.isActive){const m=u.state.lassoSelection.selectedItems;m.filter(f=>f.type==="note").forEach(f=>{const g=u.state.placedNotes.findIndex(b=>b.row===f.data.row&&b.columnIndex===f.data.columnIndex&&b.color===f.data.color&&b.shape===f.data.shape);g!==-1&&u.state.placedNotes.splice(g,1)}),m.filter(f=>f.type==="stamp").forEach(f=>{const g=u.state.stampPlacements.findIndex(b=>b.row===f.data.row&&b.column===f.data.column&&b.stampId===f.data.stampId);g!==-1&&u.state.stampPlacements.splice(g,1)}),m.filter(f=>f.type==="triplet").forEach(f=>{const g=u.state.tripletPlacements.findIndex(b=>b.row===f.data.row&&b.column===f.data.column&&b.tripletId===f.data.tripletId);g!==-1&&u.state.tripletPlacements.splice(g,1)}),u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.recordState(),u.emit("render"),a=!0,T.info("KeyboardHandler",`Deleted ${m.length} items from lasso selection`,null,"keyboard")}break;case"ArrowUp":u.shiftGridUp(),a=!0;break;case"ArrowDown":u.shiftGridDown(),a=!0;break;case"ArrowLeft":T.debug("KeyboardHandler","Emitting 'zoomOut' event",null,"keyboard"),u.emit("zoomOut"),a=!0;break;case"ArrowRight":T.debug("KeyboardHandler","Emitting 'zoomIn' event",null,"keyboard"),u.emit("zoomIn"),a=!0;break}a&&n.preventDefault()}),T.info("KeyboardHandler","Initialized",null,"keyboard")}class db{constructor(){this.canvasContainer=null,this.pitchGridWrapper=null,this.drumGridWrapper=null,this.isInitialized=!1,this.isScrolling=!1,this.lastScrollTime=0,this.pendingSync=null}init(){if(this.canvasContainer=document.getElementById("canvas-container"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),!this.canvasContainer||!this.pitchGridWrapper||!this.drumGridWrapper){console.error("ScrollSyncService: Required elements not found");return}this.setupScrollSynchronization(),this.isInitialized=!0}setupScrollSynchronization(){const e=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container")].filter(i=>i!==null),s=[...e,this.drumGridWrapper].filter(i=>i!==null);e.forEach(i=>{i.addEventListener("scroll",a=>{const r=Date.now();if(r-this.lastScrollTime<10)return;if(this.lastScrollTime=r,this.isScrolling){console.log("📜 ScrollSync: Ignoring scroll event - sync in progress");return}this.isScrolling=!0;const c=a.target.scrollLeft;console.log(`📜 ScrollSync: ${a.target.id||a.target.className} scrolled to ${c}px`),this.pendingSync&&cancelAnimationFrame(this.pendingSync),this.syncAllTargets(a.target,c,s),this.isScrolling=!1})})}syncAllTargets(e,s,i){i.forEach(a=>{a!==e&&Math.abs(a.scrollLeft-s)>2&&(a.scrollLeft=s)})}syncScrollTo(e){if(!this.isInitialized)return;this.isScrolling=!0;const s=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container"),this.drumGridWrapper].filter(i=>i!==null);this.syncAllTargets(null,e,s),setTimeout(()=>{this.isScrolling=!1},10)}}const pb=new db;function mb(){const n=document.getElementById("anacrusis-on-btn"),e=document.getElementById("anacrusis-off-btn");!n||!e||(n.addEventListener("click",()=>u.setAnacrusis(!0)),e.addEventListener("click",()=>u.setAnacrusis(!1)),u.on("anacrusisChanged",s=>{n.classList.toggle("active",s),e.classList.toggle("active",!s)}),n.classList.toggle("active",u.state.hasAnacrusis),e.classList.toggle("active",!u.state.hasAnacrusis))}function fb(){const n=document.getElementById("hide-drumgrid-toggle"),e=document.getElementById("drum-grid-wrapper");let s=!0;n&&e&&n.addEventListener("click",()=>{s=!s,e.style.display=s?"flex":"none",n.querySelector(".sidebar-button-text").textContent=s?"Hide Drum Grid":"Show Drum Grid",setTimeout(()=>xt.recalculateLayout(),10)})}function gb(){const n=document.getElementById("settings-button"),e=document.getElementById("sidebar"),s=document.getElementById("sidebar-overlay"),i=document.getElementById("volume-icon-button"),a=document.getElementById("volume-popup"),r=document.getElementById("vertical-volume-slider"),c=()=>document.body.classList.toggle("sidebar-open");n&&e&&s&&(n.addEventListener("click",c),s.addEventListener("click",c)),i&&a&&r&&(i.addEventListener("click",h=>{h.stopPropagation();const m=a.classList.toggle("visible");i.classList.toggle("active",m)}),r.addEventListener("input",function(){const h=parseInt(this.value,10),m=h===0?-1/0:h/100*37.5-50;u.emit("volumeChanged",m)}),document.addEventListener("click",h=>{!a.contains(h.target)&&h.target!==i&&(a.classList.remove("visible"),i.classList.remove("active"))}),r.dispatchEvent(new Event("input"))),mb(),fb()}function Xp(){const n=new Date,e=n.toLocaleDateString("en-US",{month:"long"}),s=n.getDate();return`SN-score-${e}${s}.csv`}async function vb(n){try{const e={suggestedName:Xp(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},i=await(await window.showSaveFilePicker(e)).createWritable();await i.write(n),await i.close()}catch(e){e.name!=="AbortError"&&console.error("Error saving file with picker:",e)}}function yb(n){const e=document.createElement("a"),s=URL.createObjectURL(n);e.setAttribute("href",s),e.setAttribute("download",Xp()),document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(s)}function bb(){return u.state.placedNotes.map(n=>[n.row,n.startColumnIndex,n.endColumnIndex,n.color,n.shape,n.tonicNumber||"",n.isDrum,n.drumTrack||""].join(",")).join(`
`)}function wb(){var n,e,s,i;(n=document.getElementById("save-as-button"))==null||n.addEventListener("click",async()=>{const a=bb(),r=new Blob([a],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await vb(r):yb(r)}),(e=document.getElementById("import-button"))==null||e.addEventListener("click",()=>{const a=document.createElement("input");a.type="file",a.accept=".csv,.txt",a.onchange=r=>{const c=r.target.files[0];if(!c)return;const h=new FileReader;h.onload=m=>{const g=m.target.result.split(`
`).filter(b=>b.trim()).map(b=>{const w=b.split(",");return{row:parseInt(w[0]),startColumnIndex:parseInt(w[1]),endColumnIndex:parseInt(w[2]),color:w[3],shape:w[4],tonicNumber:w[5]?parseInt(w[5]):null,isDrum:w[6]==="true",drumTrack:w[7]||null}});u.loadNotes(g)},h.readAsText(c)},a.click()}),(s=document.getElementById("print-button"))==null||s.addEventListener("click",()=>{document.body.classList.remove("sidebar-open"),u.emit("printPreviewStateChanged",!0)}),(i=document.getElementById("reset-canvas-button"))==null||i.addEventListener("click",()=>{window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&u.clearSavedState()})}class _b{constructor(){var e,s,i,a,r;this.overlay=document.getElementById("notification-overlay"),this.modal=(e=this.overlay)==null?void 0:e.querySelector(".notification-modal"),this.title=(s=this.overlay)==null?void 0:s.querySelector(".notification-title"),this.message=(i=this.overlay)==null?void 0:i.querySelector(".notification-message"),this.actionsContainer=(a=this.overlay)==null?void 0:a.querySelector(".notification-actions"),this.closeButton=(r=this.overlay)==null?void 0:r.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){var e;this.overlay&&((e=this.closeButton)==null||e.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",s=>{s.target===this.overlay&&this.hide()}),document.addEventListener("keydown",s=>{var i;s.key==="Escape"&&((i=this.overlay)!=null&&i.classList.contains("visible"))&&this.hide()}))}show(e={}){if(!this.overlay)return;const{title:s="Notice",message:i="",buttons:a=[{text:"OK",primary:!0,action:()=>this.hide()}]}=e;this.title&&(this.title.textContent=s),this.message&&(this.message.textContent=i),this.actionsContainer&&(this.actionsContainer.innerHTML="",a.forEach(r=>{const c=document.createElement("button");c.className=`notification-button ${r.primary?"":"secondary"}`,c.textContent=r.text,c.addEventListener("click",()=>{r.action?r.action():this.hide()}),this.actionsContainer.appendChild(c)})),this.overlay.classList.add("visible"),setTimeout(()=>{var c;const r=(c=this.actionsContainer)==null?void 0:c.querySelector(".notification-button");r==null||r.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(e,s="Notice"){this.show({title:s,message:e,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(e,s="Confirm"){return new Promise(i=>{this.show({title:s,message:e,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),i(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),i(!0)}}]})})}}const kd=new _b,ah=40,xb=ah;class Id{constructor(e,s,i,a){this.element=e,this.viewportEl=e==null?void 0:e.querySelector(".clef-wheel-viewport"),this.optionsEl=e==null?void 0:e.querySelector(".clef-wheel-options"),this.onChange=a,this.options=s,this.selectedIndex=0,this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.silent=!1,this.optionHeight=ah,this.resizeObserver=null,this.debugLabel=(e==null?void 0:e.id)||"clef-wheel",!(!e||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(i,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){this.optionsEl.innerHTML="",this.optionNodes=this.options.map((e,s)=>{const i=document.createElement("div");return i.className="clef-wheel-option",i.dataset.index=s.toString(),i.textContent=e.label,this.optionsEl.appendChild(i),i})}attachEvents(){this.element.addEventListener("wheel",s=>{s.preventDefault(),s.stopPropagation();const i=Math.sign(s.deltaY);i!==0&&this.increment(i)},{passive:!1}),this.element.addEventListener("keydown",s=>{s.key==="ArrowUp"?(s.preventDefault(),this.increment(-1)):s.key==="ArrowDown"?(s.preventDefault(),this.increment(1)):s.key==="Home"?(s.preventDefault(),this.setIndex(0)):s.key==="End"&&(s.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",s=>{if(this.pointerActive=!0,this.pointerId=s.pointerId,this.lastPointerY=s.clientY,this.deltaBuffer=0,typeof this.element.setPointerCapture=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",s=>{if(!this.pointerActive||s.pointerId!==this.pointerId)return;const i=s.clientY-this.lastPointerY;if(this.lastPointerY=s.clientY,i===0)return;this.deltaBuffer+=i;const a=this.optionHeight||xb;for(;Math.abs(this.deltaBuffer)>=a;){const r=-Math.sign(this.deltaBuffer);this.increment(r),this.deltaBuffer-=Math.sign(this.deltaBuffer)*a}});const e=s=>{this.pointerActive&&s.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element.hasPointerCapture(s.pointerId)&&this.element.releasePointerCapture(s.pointerId))};this.element.addEventListener("pointerup",e),this.element.addEventListener("pointercancel",e),this.element.addEventListener("pointerleave",s=>{this.pointerActive&&s.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element.hasPointerCapture(s.pointerId)&&this.element.releasePointerCapture(s.pointerId))})}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(e=>{for(const s of e)s.target===this.element&&s.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(e){if(e===0||!this.options||this.options.length===0)return;const s=this.selectedIndex+e;this.setIndex(s)}setIndex(e,{silent:s=!1}={}){if(!this.optionsEl)return;const i=Math.max(0,Math.min(this.options.length-1,e));if(i===this.selectedIndex){this.updateVisuals();return}this.selectedIndex=i,this.updateVisuals(),!s&&typeof this.onChange=="function"&&this.onChange(i,this.options[i])}updateVisuals(){var h,m;if(!this.optionsEl||!this.viewportEl)return;const e=this.viewportEl.clientHeight||0,s=(h=this.optionNodes)==null?void 0:h[this.selectedIndex],i=(m=this.optionNodes)==null?void 0:m[0],a=(s==null?void 0:s.offsetHeight)||(i==null?void 0:i.offsetHeight)||ah;if(this.optionHeight=a,this.optionNodes&&this.optionNodes.forEach((f,g)=>{const b=Math.abs(g-this.selectedIndex),w=Math.min(b,3);f.dataset.distance=String(w)}),e===0||a===0)return;const r=Math.max(0,(e-a)/2);this.optionsEl.style.paddingTop=`${r}px`,this.optionsEl.style.paddingBottom=`${r}px`;let c=0;if(s){const f=s.offsetTop+a/2;c=e/2-f}else c=e/2-(r+a/2);this.optionsEl.style.transform=`translateY(${c}px)`}}class Sb{constructor(){this.initialized=!1,this.topPicker=null,this.bottomPicker=null,this.suppressStoreSync=!1,this.snapToggle=null}init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),!this.topWheel||!this.bottomWheel){T.warn("ClefRangeController","Clef tab elements not found; skipping initialization",null,"ui");return}this.masterOptions=Pe.map((s,i)=>({index:i,label:s.pitch,toneNote:s.toneNote,frequency:s.frequency}));const e=this.normaliseRange(u.state.pitchRange,this.masterOptions.length);this.topPicker=new Id(this.topWheel,this.masterOptions,e.topIndex,s=>this.handleTopSelection(s)),this.bottomPicker=new Id(this.bottomWheel,this.masterOptions,e.bottomIndex,s=>this.handleBottomSelection(s)),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.setPresetRange("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.setPresetRange("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.setPresetRange("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.setPresetRange("bass")),u.on("pitchRangeChanged",s=>{this.syncFromStore(s)}),this.currentRange=e,this.lastTopIndex=e.topIndex,this.lastBottomIndex=e.bottomIndex,this.updateSummary(),this.initialized=!0,T.moduleLoaded("ClefRangeController","ui")}normaliseRange(e,s){const i={topIndex:0,bottomIndex:s-1};if(!e)return i;const a=Math.max(0,Math.min(s-1,e.topIndex)),r=Math.max(a,Math.min(s-1,e.bottomIndex));return{topIndex:a,bottomIndex:r}}handleTopSelection(e){const s=this.bottomPicker.getIndex(),i=Math.max(e,s);i!==s&&this.bottomPicker.setIndex(i,{silent:!0}),this.commitRangeChange(e,i)}handleBottomSelection(e){const s=this.topPicker.getIndex(),i=Math.min(e,s);i!==s&&this.topPicker.setIndex(i,{silent:!0}),this.commitRangeChange(i,e)}commitRangeChange(e,s){console.log(`[CommitRange] Called with top=${e}, bottom=${s}`);const i=this.currentRange||u.state.pitchRange||{topIndex:0},a=Math.max(0,Math.min(this.masterOptions.length-1,e)),r=Math.max(a,Math.min(this.masterOptions.length-1,s));if(console.log(`[CommitRange] Normalized to top=${a}, bottom=${r}`),console.log("[CommitRange] Current range:",this.currentRange),this.currentRange&&this.currentRange.topIndex===a&&this.currentRange.bottomIndex===r){console.log("[CommitRange] Range unchanged, skipping commit");return}let c=null;if(xt!=null&&xt.getViewportInfo){const h=xt.getViewportInfo();h&&(c=(i.topIndex??0)+h.startRank)}this.currentRange={topIndex:a,bottomIndex:r},this.lastTopIndex=a,this.lastBottomIndex=r,this.updateSummary(),console.log("[CommitRange] Setting pitch range in store"),u.setPitchRange({topIndex:a,bottomIndex:r},{maintainGlobalStart:c}),console.log(`[CommitRange] Snap zoom currently: ${u.state.snapZoomToRange}`),u.state.snapZoomToRange||(console.log("[CommitRange] Enabling snap zoom"),u.setSnapZoomToRange(!0)),console.log(`[CommitRange] Snap zoom now: ${u.state.snapZoomToRange}`),xt&&typeof xt.snapZoomToCurrentRange=="function"&&u.state.snapZoomToRange?(console.log("[CommitRange] Calling snapZoomToCurrentRange"),xt.snapZoomToCurrentRange()):xt&&typeof xt.recalculateLayout=="function"&&(console.log("[CommitRange] Calling recalculateLayout (snap zoom not enabled)"),xt.recalculateLayout()),console.log("[CommitRange] Complete")}syncFromStore(e){if(!this.initialized||!e)return;const s=this.normaliseRange(e,this.masterOptions.length);this.currentRange=s,this.topPicker&&this.topPicker.getIndex()!==s.topIndex&&this.topPicker.setIndex(s.topIndex,{silent:!0}),this.bottomPicker&&this.bottomPicker.getIndex()!==s.bottomIndex&&this.bottomPicker.setIndex(s.bottomIndex,{silent:!0}),this.updateSummary(e.metadata)}updateSummary(e){if(!this.currentRange)return;const s=this.masterOptions[this.currentRange.topIndex],i=this.masterOptions[this.currentRange.bottomIndex],a=this.currentRange.bottomIndex-this.currentRange.topIndex+1;if(this.rangeLabel&&(this.rangeLabel.textContent=`${s.label} – ${i.label}`),this.rangeCount&&(this.rangeCount.textContent=`${a} ${a===1?"pitch":"pitches"}`),e){const{removedNotes:r=0,removedStamps:c=0,removedTriplets:h=0}=e,m=r+c+h;m>0&&T.info("ClefRangeController",`Range change removed: ${m} items`,e,"ui")}}resetRange(){this.topPicker.setIndex(0,{silent:!0}),this.bottomPicker.setIndex(this.masterOptions.length-1,{silent:!0}),this.commitRangeChange(0,this.masterOptions.length-1)}findNoteIndex(e){return this.masterOptions.findIndex(s=>s.label===e)}animateWheelToIndex(e,s,i=300){const a=e.getIndex(),r=s-a,c=performance.now(),h=m=>{const f=m-c,g=Math.min(f/i,1),b=1-Math.pow(1-g,3),w=Math.round(a+r*b);e.setIndex(w,{silent:g<1}),g<1?requestAnimationFrame(h):(e.selectedIndex=s,e.updateVisuals(),typeof e.onChange=="function"&&e.onChange(s,e.options[s]))};requestAnimationFrame(h)}setPresetRange(e){let s,i;switch(e){case"full":this.animateRangeTransition(0,this.masterOptions.length-1);return;case"treble":s="A♭/G♯5",i="C4";break;case"alto":s="B♭/A♯4",i="D3";break;case"bass":s="D♭/C♯4",i="F2";break;default:return}const a=this.findNoteIndex(s),r=this.findNoteIndex(i);if(a===-1||r===-1){T.warn("ClefRangeController",`Preset notes not found: ${s} or ${i}`,null,"ui");return}this.animateRangeTransition(a,r)}animateRangeTransition(e,s,i=500){const a=this.topPicker.getIndex(),r=this.bottomPicker.getIndex(),c=e-a,h=s-r,m=performance.now();console.log("[AnimateRange] Starting animation:",{startTop:a,targetTop:e,startBottom:r,targetBottom:s,duration:i});const f=u.state.snapZoomToRange;console.log(`[AnimateRange] Snap zoom was ${f?"enabled":"disabled"}, disabling for animation`),f&&u.setSnapZoomToRange(!1);const g=xt.getCurrentZoomLevel?xt.getCurrentZoomLevel():1,b=this.calculateTargetZoom(e,s),w=b-g;console.log(`[AnimateRange] Zoom animation: ${Math.round(g*100)}% -> ${Math.round(b*100)}%`);let x=0;const A=P=>{const M=P-m,I=Math.min(M/i,1),D=I<.5?4*I*I*I:1-Math.pow(-2*I+2,3)/2,R=Math.round(a+c*D),H=Math.round(r+h*D),j=g+w*D;x++,(x%10===0||I===1)&&console.log(`[AnimateRange] Frame ${x}: progress=${(I*100).toFixed(1)}%, top=${R}, bottom=${H}, zoom=${Math.round(j*100)}%`),this.topPicker.setIndex(R,{silent:!0}),this.bottomPicker.setIndex(H,{silent:!0}),u.state.pitchRange={topIndex:R,bottomIndex:H},Pe&&Pe.length>0&&(u.state.fullRowData=Pe.slice(R,H+1)),xt.setZoomLevel&&xt.setZoomLevel(j),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"clefRangeAnimation"}})),I<1?requestAnimationFrame(A):(console.log(`[AnimateRange] Animation complete, finalizing at top=${e}, bottom=${s}`),this.topPicker.selectedIndex=e,this.bottomPicker.selectedIndex=s,this.topPicker.updateVisuals(),this.bottomPicker.updateVisuals(),this.currentRange={topIndex:e,bottomIndex:s},this.lastTopIndex=e,this.lastBottomIndex=s,this.updateSummary(),console.log("[AnimateRange] Committing final range change through setPitchRange"),u.setPitchRange({topIndex:e,bottomIndex:s}),console.log("[AnimateRange] Re-enabling snap zoom"),u.setSnapZoomToRange(!0),console.log("[AnimateRange] Animation fully complete"))};requestAnimationFrame(A)}calculateTargetZoom(e,s){const i=s-e+1;if(i===0)return 1;const a=document.getElementById("pitch-grid-container"),r=(a==null?void 0:a.clientHeight)||window.innerHeight*.7;if(!r||r<=0)return 1;const h=2*r/(i*30);return Math.max(.1,Math.min(5,h))}}const Cb=new Sb,Tb={X:["1P","3M","5P"],x:["1P","3m","5P"],"x°":["1P","3m","5d"],"X+":["1P","3M","6m"],X7:["1P","3M","5P","7m"],"x⁷":["1P","3m","5P","7m"],"Xmaj⁷":["1P","3M","5P","7M"],"ø⁷":["1P","3m","5d","7m"],"x°⁷":["1P","3m","5d","6M"],"X⁶":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},Ab={"xmaj⁷":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x⁹":["1P","3m","5P","7m","9M"],"x⁶":["1P","3m","5P","6M"],"x¹¹":["1P","3m","5P","7m","9M","11P"],"Xmaj7♯11":["1P","3M","5P","7M","11A"]},Yp={...Tb,...Ab},rh={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]};function Rd(){return Object.keys(u.state.tonicSignGroups).length>0}function Dd(){const n=document.getElementById("degree-mode-toggle");if(n){const e=u.state.degreeDisplayMode==="off";n.classList.toggle("disabled",e)}}function Od(){var e;const n=document.querySelector("#chords-panel .harmony-preset-grid");if(n&&n.querySelectorAll(".harmony-preset-button").forEach(s=>s.classList.remove("selected")),u.state.selectedTool==="chord"&&n){const s=u.state.activeChordIntervals.toString();for(const i of n.querySelectorAll(".harmony-preset-button"))if(((e=Yp[i.textContent.trim()])==null?void 0:e.toString())===s){i.classList.add("selected");return}}}function Nd(){const n=document.querySelector("#intervals-panel .harmony-preset-grid");if(n&&(n.querySelectorAll(".harmony-preset-button").forEach(e=>e.classList.remove("selected")),u.state.selectedTool==="chord"&&u.state.activeChordIntervals)){const e=u.state.activeChordIntervals;n.querySelectorAll(".harmony-preset-button").forEach(s=>{const i=s.textContent.trim(),a=rh[i];a&&e.includes(a[0])&&s.classList.add("selected")})}}const ur=(n,e=50)=>{const s=parseInt(n.slice(1,3),16),i=parseInt(n.slice(3,5),16),a=parseInt(n.slice(5,7),16),r=Math.min(255,Math.floor(s+(255-s)*(e/100))),c=Math.min(255,Math.floor(i+(255-i)*(e/100))),h=Math.min(255,Math.floor(a+(255-a)*(e/100)));return`#${r.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`};function Mb(){const{noteBankContainer:n,eraserButton:e,degreeVisibilityToggle:s,degreeModeToggle:i,flatBtn:a,sharpBtn:r,frequencyBtn:c,focusColoursToggle:h}=oi.getMultiple("noteBankContainer","eraserButton","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","focusColoursToggle"),m=document.querySelector(".pitch-tabs-container");document.querySelector(".harmony-preset-grid");const f=document.getElementById("inversion-toggle"),g=document.getElementById("chord-position-toggle-6");Cb.init(),n&&n.querySelectorAll(".note").forEach(F=>{F.addEventListener("click",()=>{u.setSelectedNote(F.dataset.type,F.closest(".note-pair").dataset.color),u.setSelectedTool("note")})}),e&&e.addEventListener("click",()=>u.setSelectedTool("eraser"));const b=Array.from(document.querySelectorAll(".tonic-mode-button")),w=(F=u.state.selectedToolTonicNumber)=>{if(!b.length)return;const Y=b[0]?parseInt(b[0].dataset.tonic,10):1,tt=parseInt(F,10),nt=Number.isNaN(tt)?Y:tt;b.forEach(at=>{const _t=parseInt(at.dataset.tonic,10)===nt;at.classList.toggle("selected",_t),at.setAttribute("aria-pressed",_t?"true":"false")})};b.length&&(b.forEach(F=>{F.addEventListener("click",()=>{const Y=F.getAttribute("data-tonic");Y&&(u.setSelectedTool("tonicization",Y),w(parseInt(Y,10)))})}),w());const x=document.querySelector("#chords-panel .harmony-preset-grid");function A(F,Y,tt){F&&F.querySelectorAll(".harmony-preset-button").forEach(nt=>{nt.addEventListener("click",()=>{const at=Y[nt.textContent];at&&at.length>0?(u.setActiveChordIntervals(at),u.setSelectedTool("chord")):console.error(`Failed to retrieve valid intervals for ${tt} chord: "${nt.textContent}"`),nt.blur()}),nt.addEventListener("dblclick",()=>{nt.classList.contains("selected")&&u.setSelectedTool("note"),nt.blur()})})}A(x,Yp,"chords");const P=document.querySelectorAll(".pitch-tab-button"),M=document.querySelectorAll(".pitch-tab-panel");if(P.length>0&&P.forEach(F=>{F.addEventListener("click",()=>{const Y=F.dataset.pitchTab;P.forEach(nt=>nt.classList.remove("active")),F.classList.add("active"),M.forEach(nt=>nt.classList.remove("active"));const tt=document.getElementById(`${Y}-panel`);tt&&tt.classList.add("active"),Y==="chords"&&R()})}),f){f.addEventListener("click",()=>{const Y=!u.state.isIntervalsInverted;u.setIntervalsInversion(Y),f.blur()});const F=Y=>{f.classList.toggle("active",Y)};u.on("intervalsInversionChanged",F),F(u.state.isIntervalsInverted)}if(g){g.addEventListener("click",()=>{const Y=u.state.chordPositionState,tt=I(),nt=(Y+1)%tt;u.setChordPosition(nt),g.blur()});const F=Y=>{g.classList.remove("state-1","state-2","state-3","state-4","state-5"),Y===1?g.classList.add("state-1"):Y===2?g.classList.add("state-2"):Y===3?g.classList.add("state-3"):Y===4?g.classList.add("state-4"):Y===5&&g.classList.add("state-5")};u.on("chordPositionChanged",Y=>{F(Y)}),F(u.state.chordPositionState)}function I(){const F=u.state.activeChordIntervals;return!F||F.length===0?3:F.length}function D(){const F=u.state.activeChordIntervals;return!F||F.length===0?3:F.length}function R(){if(!g)return;const F=D();for(let tt=0;tt<=5;tt++)g.classList.remove(`disabled-state-${tt}`);F<4?g.classList.add("disabled-state-3","disabled-state-4","disabled-state-5"):F===4?g.classList.add("disabled-state-4","disabled-state-5"):F===5&&g.classList.add("disabled-state-5");const Y=F-1;u.state.chordPositionState>Y&&u.setChordPosition(0)}const H=document.querySelector("#intervals-panel .harmony-preset-grid");if(H&&H.querySelectorAll(".harmony-preset-button").forEach(F=>{F.addEventListener("click",()=>{const Y=F.textContent.trim(),tt=rh[Y];if(tt&&tt.length>0){const nt=["1P",tt[0]];u.setActiveChordIntervals(nt),u.setSelectedTool("chord"),console.log(`Interval ${Y} selected:`,nt)}else console.error(`Failed to retrieve valid interval for symbol: "${Y}"`),console.error("Available interval shapes:",Object.keys(rh));F.blur()}),F.addEventListener("dblclick",()=>{F.classList.contains("selected")&&u.setSelectedTool("note"),F.blur()})}),s&&s.addEventListener("click",()=>{if(u.state.degreeDisplayMode==="off"){if(!Rd()){kd.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}const tt=i.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(tt)}else u.setDegreeDisplayMode("off");s.blur()}),i&&i.addEventListener("click",()=>{if(i.classList.contains("disabled"))return;i.classList.toggle("active");const Y=i.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(Y),i.blur()}),a&&a.addEventListener("click",()=>{if(u.state.showFrequencyLabels){u.toggleFrequencyLabels(),a.blur();return}u.toggleAccidentalMode("flat"),a.blur()}),r&&r.addEventListener("click",()=>{if(u.state.showFrequencyLabels){u.toggleFrequencyLabels(),r.blur();return}u.toggleAccidentalMode("sharp"),r.blur()}),c&&c.addEventListener("click",()=>{u.toggleFrequencyLabels(),c.blur()}),h&&h.addEventListener("change",()=>{if(!u.state.focusColours&&!Rd()){kd.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),h.checked=!1;return}u.toggleFocusColours()}),u.on("toolChanged",({newTool:F})=>{var nt;const Y=document.querySelector("#chords-panel .harmony-preset-grid");Y&&Y.querySelectorAll(".harmony-preset-button").forEach(at=>at.classList.remove("selected"));const tt=document.querySelector("#intervals-panel .harmony-preset-grid");if(tt&&tt.querySelectorAll(".harmony-preset-button").forEach(at=>at.classList.remove("selected")),e==null||e.classList.remove("selected"),m&&m.classList.remove("active-tool"),F==="eraser")e==null||e.classList.add("selected");else if(F!=="tonicization"){if(F==="chord")m==null||m.classList.add("active-tool"),Od(),Nd(),R();else if(F==="note"){const at=u.state.selectedNote;if(at){const gt=document.querySelector(`.note-pair[data-color='${at.color}']`);gt==null||gt.classList.add("selected"),(nt=gt==null?void 0:gt.querySelector(`.note[data-type='${at.shape}']`))==null||nt.classList.add("selected")}}}w()}),u.on("activeChordIntervalsChanged",()=>{u.state.selectedTool==="chord"&&(Od(),Nd(),R())}),u.on("noteChanged",({newNote:F})=>{var nt;document.querySelectorAll(".note, .note-pair").forEach(at=>at.classList.remove("selected"));const Y=document.querySelector(`.note-pair[data-color='${F.color}']`);if(Y==null||Y.classList.add("selected"),(nt=Y==null?void 0:Y.querySelector(`.note[data-type='${F.shape}']`))==null||nt.classList.add("selected"),m){const at=ur(F.color,50),gt=ur(at,60);m.style.setProperty("--c-accent",F.color),m.style.setProperty("--c-accent-light",gt)}const tt=document.querySelector(".tab-sidebar");tt&&tt.style.setProperty("--c-accent",F.color)}),u.on("degreeDisplayModeChanged",F=>{s&&s.classList.toggle("active",F!=="off"),i&&(i.classList.contains("active"),i.classList.toggle("active",F==="modal"),i.classList.contains("active")),Dd()}),u.on("accidentalModeChanged",({sharp:F,flat:Y})=>{r==null||r.classList.toggle("active",F),a==null||a.classList.toggle("active",Y)}),u.on("frequencyLabelsChanged",F=>{c==null||c.classList.toggle("active",F),a&&(a.style.opacity=F?"0.3":""),r&&(r.style.opacity=F?"0.3":""),a&&(a.style.pointerEvents=F?"none":""),r&&(r.style.pointerEvents=F?"none":"")}),m&&u.state.selectedNote){const F=u.state.selectedNote.color,Y=ur(F,50),tt=ur(Y,60);m.style.setProperty("--c-accent",F),m.style.setProperty("--c-accent-light",tt)}const j=document.querySelector(".tab-sidebar");j&&u.state.selectedNote&&j.style.setProperty("--c-accent",u.state.selectedNote.color),setTimeout(()=>R(),50),Dd()}function Eb(n){return`/Student-Notation/assets/${n}`}function Ld(n){return Eb(`icons/${n}`)}function Pb(){const n=document.getElementById("play-button"),e=document.getElementById("stop-button"),s=document.getElementById("clear-button"),i=document.getElementById("loop-button"),a=document.getElementById("undo-button"),r=document.getElementById("redo-button");n&&n.addEventListener("click",()=>{const{isPlaying:h,isPaused:m}=u.state;h&&m?(u.setPlaybackState(!0,!1),Ui.resume()):h&&!m?(u.setPlaybackState(!0,!0),Ui.pause()):(u.setPlaybackState(!0,!1),Ui.start()),n.blur()}),e&&e.addEventListener("click",()=>{u.setPlaybackState(!1,!1),Ui.stop(),e.blur()}),s&&s.addEventListener("click",()=>{s.classList.add("flash"),setTimeout(()=>s.classList.remove("flash"),300),u.clearAllNotes(),W0(),X0(),s.blur()}),i&&i.addEventListener("click",()=>{u.setLooping(!u.state.isLooping)}),a&&a.addEventListener("click",()=>{u.undo(),a.blur()}),r&&r.addEventListener("click",()=>{u.redo(),r.blur()}),u.on("playbackStateChanged",({isPlaying:h,isPaused:m})=>{if(n){const f=`<img src="${Ld("Play.svg")}" alt="Play">`,g=`<img src="${Ld("Pause.svg")}" alt="Pause">`;n.innerHTML=h&&!m?g:f}}),u.on("loopingChanged",h=>{i&&i.classList.toggle("active",h)});const c=()=>{a&&(a.disabled=u.state.historyIndex<=0),r&&(r.disabled=u.state.historyIndex>=u.state.history.length-1)};u.on("historyChanged",c),c()}class Lc{constructor(e,s={}){if(this.parent=typeof e=="string"?document.querySelector(e):e,!this.parent)throw new Error("DraggableNumber: parent element not found");const i={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"}};this.settings={...i,...s,colors:{...i.colors,...s.colors||{}}},this._em=new Ib,this._value=new kb(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[a,r]=this.settings.size;this._minDimension=Math.min(a,r),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${a}px`,`height:${r}px`,"background-color: var(--c-bg)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${a}px`,`height:${r}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),Db(this.element,c=>/^-?\d*\.?\d*$/.test(c)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=Fd(this._value.value,this.decimalPlaces),this._bind()}on(e,s){return this._em.on(e,s),()=>this._em.off(e,s)}emit(e,s){this._em.emit(e,s)}get value(){return this._value.value}set value(e){this._value.update(e),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(e){this._value.min=e,this._render()}get max(){return this._value.max}set max(e){this._value.max=e,this._render()}get step(){return this._value.step}set step(e){this._value.step=e,this._render()}passiveUpdate(e){this._value.update(e),this._render()}link(e){this.min=e.min,this.max=e.max,this.step=e.step,typeof e.on=="function"&&e.on("change",s=>this.passiveUpdate(s)),this.on("change",s=>{"value"in e&&(e.value=s)}),this.value=e.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-bg)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const e=parseFloat(this.element.value);!Number.isNaN(e)&&e!==this.value?this.value=e:this._render()}),this.element.addEventListener("keydown",e=>{if(e.key==="Enter"){this.element.blur();const s=parseFloat(this.element.value);Number.isNaN(s)||(this.value=s)}},!0),this.element.addEventListener("mousedown",e=>this._onMouseDown(e)),this.element.addEventListener("dragstart",e=>e.preventDefault())}_onMouseDown(e){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:e.clientY};const s=this.element.getBoundingClientRect(),i=(e.clientX-s.left)/s.width;this._changeFactor=Rb(i);const a=c=>this._onMouseMove(c),r=()=>this._onMouseUp(a,r);window.addEventListener("mousemove",a),window.addEventListener("mouseup",r)}_onMouseMove(e){if(!this.clicked)return;this.hasMoved=!0;const s=e.clientY-this._start.y,a=Lh(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),r=this.actual-s*a;this._value.update(r),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(e,s){this.clicked=!1,window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",s),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=Fd(this._value.value,this.decimalPlaces)}}class kb{constructor(e,s,i,a){this.min=Number(e),this.max=Number(s),this.step=Number(i)||1,this._value=0,this.changed=!1,this.update(a)}get value(){return this._value}update(e){const s=Lh(Number(e),this.min,this.max),i=this._stepTo(s),a=this._value;this._value=i,this.changed=i!==a}_stepTo(e){if(!isFinite(this.step)||this.step<=0)return e;const s=Math.round((e-this.min)/this.step);return this.min+s*this.step}}class Ib{constructor(){this._m=new Map}on(e,s){const i=this._m.get(e)||[];i.push(s),this._m.set(e,i)}off(e,s){const i=this._m.get(e);if(!i)return;const a=i.indexOf(s);a>=0&&i.splice(a,1)}emit(e,s){const i=this._m.get(e);if(i)for(const a of i.slice())a(s)}}function Lh(n,e,s){return Math.max(e,Math.min(s,n))}function Rb(n){return 1-Lh(n,0,1)}function Fd(n,e=2){return isFinite(n)?Number(n).toFixed(Math.max(0,e)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function Db(n,e){let s=n.value;n.addEventListener("input",()=>{e(n.value)?s=n.value:n.value=s})}class Ob{constructor(){this.isActive=!1,this.pulseIntervals=new Map,this.tempoElements=new Map,this.popDuration={scaleUp:40,scaleDown:80},this.popScale=1.4,this.activeAnimations=new Map,this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:s,containerId:i,bpmMultiplier:a})=>{const r=document.getElementById(i),c=r==null?void 0:r.parentElement,h=c==null?void 0:c.querySelector(".tempo-label-icon");r&&h?this.tempoElements.set(s,{container:r,icon:h,bpmMultiplier:a,originalTransform:r.style.transform||"",originalIconTransform:h.style.transform||""}):console.warn(`TempoVisualizer: Could not find elements for ${s} tempo`,{container:!!r,icon:!!h,tempoGroup:!!c})})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((e,s)=>{this.startPulseForType(s)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(e=>{clearInterval(e)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(e=>{e.container.style.transform=e.originalTransform,e.icon.style.transform=e.originalIconTransform}))}startPulseForType(e){const s=this.tempoElements.get(e);if(!s)return;const r=60/(u.state.tempo*s.bpmMultiplier)*1e3;this.triggerPulse(e);const c=setInterval(()=>{this.isActive&&this.triggerPulse(e)},r);this.pulseIntervals.set(e,c)}triggerPulse(e){this.activeAnimations.has(e);const i={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(e,i);const a=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),a||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const e=performance.now();this.activeAnimations.forEach((s,i)=>{const a=this.calculateScale(s,e);this.applyScale(i,a),a===1&&s.phase==="complete"&&this.activeAnimations.delete(i)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(e,s){const i=s-e.startTime;if(e.phase==="scaleUp"){if(i>=this.popDuration.scaleUp)return e.phase="scaleDown",e.startTime=s,this.popScale;{const a=Math.min(i/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*a}}else if(e.phase==="scaleDown"){if(i>=this.popDuration.scaleDown)return e.phase="complete",1;{const a=Math.min(i/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*a}}return 1}applyScale(e,s){const i=this.tempoElements.get(e);if(!i)return;const a=`scale(${s})`;i.container.style.transform=i.originalTransform+" "+a,i.icon.style.transform=i.originalIconTransform+" "+a;const r=s<this.popScale?"transform 0.08s ease-out":"none";i.container.style.transition=r,i.icon.style.transition=r}updateTempo(){this.isActive&&(this.stop(),this.start())}}const zi=new Ob;function Nb(){var w;const n=document.getElementById("tempo-slider");n||console.warn("⚠️ [AudioControls] Tempo slider not found during initial load - will retry when rhythm tab is accessed");const e={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0},s=new Lc("#eighth-note-tempo",{...e,value:180,min:60,max:480}),i=new Lc("#quarter-note-tempo",{...e,value:90,min:30,max:240}),a=new Lc("#dotted-quarter-tempo",{...e,value:60,min:20,max:160});function r(x){const A=Math.round(x),P=n||document.getElementById("tempo-slider");P&&parseInt(P.value,10)!==A&&(P.value=A);const M=A*2,I=Math.round(A/1.5);s.value!==M&&s.passiveUpdate(M),i.value!==A&&i.passiveUpdate(A),a.value!==I&&a.passiveUpdate(I),u.state.tempo!==A&&(u.setTempo(A),zi.updateTempo())}let c=!1;if(n){const x=()=>{const A=document.querySelector(".tempo-content-box"),P=document.querySelector(".tempo-container"),M=document.querySelector(".tempo-column-2");console.log("[Tempo Slider Heights]",{slider:{offsetHeight:n.offsetHeight,clientHeight:n.clientHeight,scrollHeight:n.scrollHeight,computedHeight:getComputedStyle(n).height,computedMaxHeight:getComputedStyle(n).maxHeight},tempoColumn2:M?{offsetHeight:M.offsetHeight,clientHeight:M.clientHeight,computedHeight:getComputedStyle(M).height}:"not found",tempoContainer:P?{offsetHeight:P.offsetHeight,clientHeight:P.clientHeight,computedHeight:getComputedStyle(P).height,computedFlex:getComputedStyle(P).flex}:"not found",tempoContentBox:A?{offsetHeight:A.offsetHeight,clientHeight:A.clientHeight,computedHeight:getComputedStyle(A).height}:"not found"})};setTimeout(x,100),setTimeout(x,500),n.addEventListener("mousedown",()=>{c=!0,zi.start()}),n.addEventListener("touchstart",()=>{c=!0,zi.start()}),n.addEventListener("input",A=>{const P=parseInt(A.target.value,10);r(P)}),n.addEventListener("mouseup",function(){this.blur()}),r(u.state.tempo)}else console.warn("⚠️ [AudioControls] Tempo slider not found - will initialize when rhythm tab is opened");s.on("change",x=>{!isNaN(x)&&x>0&&r(x/2)}),i.on("change",x=>{!isNaN(x)&&x>0&&r(x)}),a.on("change",x=>{!isNaN(x)&&x>0&&r(x*1.5)}),r(u.state.tempo),document.addEventListener("mouseup",()=>{c&&(c=!1,zi.stop())}),document.addEventListener("touchend",()=>{c&&(c=!1,zi.stop())}),document.addEventListener("touchcancel",()=>{c&&(c=!1,zi.stop())});const h=document.querySelector(".preset-effects-container");document.querySelectorAll(".preset-button").forEach(x=>{const A=x.id.replace("preset-",""),P=x0[A];P&&x.addEventListener("click",()=>{var I;const M=(I=u.state.selectedNote)==null?void 0:I.color;M&&(u.applyPreset(M,P),setTimeout(()=>{try{g(M)}catch{}},10)),x.blur()})});const m=(x,A=20)=>{const P=parseInt(x.slice(1,3),16),M=parseInt(x.slice(3,5),16),I=parseInt(x.slice(5,7),16),D=Math.max(0,Math.floor(P*(1-A/100))),R=Math.max(0,Math.floor(M*(1-A/100))),H=Math.max(0,Math.floor(I*(1-A/100)));return`#${D.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}${H.toString(16).padStart(2,"0")}`},f=(x,A=50)=>{const P=parseInt(x.slice(1,3),16),M=parseInt(x.slice(3,5),16),I=parseInt(x.slice(5,7),16),D=Math.min(255,Math.floor(P+(255-P)*(A/100))),R=Math.min(255,Math.floor(M+(255-M)*(A/100))),H=Math.min(255,Math.floor(I+(255-I)*(A/100)));return`#${D.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}${H.toString(16).padStart(2,"0")}`},g=x=>{if(!x||!h)return;const A=u.state.timbres[x],P=u.state.colorPalette[x]||{primary:x,light:x},M=P.light,I=P.primary;document.querySelectorAll(".preset-button").forEach(R=>{const H=R.id.replace("preset-",""),j=A&&A.activePresetName===H;R.classList.toggle("selected",j)});const D=f(M,60);h.style.setProperty("--c-accent",I),h.style.setProperty("--c-accent-light",D),h.style.setProperty("--c-accent-hover",m(I,20))};u.on("noteChanged",({newNote:x})=>{x.color?g(x.color):(document.querySelectorAll(".preset-button").forEach(A=>A.classList.remove("selected")),h&&(h.style.setProperty("--c-accent","#4A90E2"),h.style.setProperty("--c-accent-hover","#357ABD")))}),u.on("timbreChanged",x=>{var A;x===((A=u.state.selectedNote)==null?void 0:A.color)&&g(x)}),u.on("tempoChanged",x=>{r(x)});const b=(w=u.state.selectedNote)==null?void 0:w.color;b&&g(b)}function Lb(){const n=document.getElementById("grid-zoom-in"),e=document.getElementById("grid-zoom-out"),s=document.getElementById("macrobeat-increase"),i=document.getElementById("macrobeat-decrease");n&&n.addEventListener("click",()=>{u.emit("zoomIn"),n.blur()}),e&&e.addEventListener("click",()=>{u.emit("zoomOut"),e.blur()}),s&&s.addEventListener("click",()=>u.increaseMacrobeatCount()),i&&i.addEventListener("click",()=>u.decreaseMacrobeatCount())}function Fb(){document.querySelectorAll("button"),document.querySelector(".modulation-controls");const n=document.getElementById("modulation-2-3-btn"),e=document.getElementById("modulation-3-2-btn"),s=document.getElementById("modulation-clear-btn");if(!n||!e||!s){T.warn("ModulationInitializer","Modulation control buttons not found in DOM",null,"ui");return}let i=null;n.addEventListener("click",()=>{i===ks.COMPRESSION_2_3?(i=null,n.classList.remove("active"),u.setSelectedTool("note"),T.info("ModulationInitializer","2:3 modulation tool deactivated",null,"ui")):(i=ks.COMPRESSION_2_3,n.classList.add("active"),e.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=i,T.info("ModulationInitializer","2:3 modulation tool activated",null,"ui"))}),e.addEventListener("click",()=>{i===ks.EXPANSION_3_2?(i=null,e.classList.remove("active"),u.setSelectedTool("note"),T.info("ModulationInitializer","3:2 modulation tool deactivated",null,"ui")):(i=ks.EXPANSION_3_2,e.classList.add("active"),n.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=i,T.info("ModulationInitializer","3:2 modulation tool activated",null,"ui"))}),s.addEventListener("click",()=>{const r=(u.state.modulationMarkers||[]).length;if(r===0){T.info("ModulationInitializer","No modulation markers to clear",null,"ui");return}u.clearModulationMarkers(),T.info("ModulationInitializer",`Cleared ${r} modulation markers`,null,"ui")}),u.on("toolChanged",r=>{(r.newTool||r)!=="modulation"&&(i=null,n.classList.remove("active"),e.classList.remove("active"))}),u.on("modulationMarkersChanged",()=>{const r=(u.state.modulationMarkers||[]).length;r===0?(s.disabled=!0,s.style.opacity="0.5"):(s.disabled=!1,s.style.opacity="1"),s.textContent=r>0?`Clear (${r})`:"Clear"});const a=(u.state.modulationMarkers||[]).length;a===0&&(s.disabled=!0,s.style.opacity="0.5"),s.textContent=a>0?`Clear (${a})`:"Clear",T.info("ModulationInitializer","Modulation controls initialized",null,"ui")}T.moduleLoaded("ToolbarComponent","toolbar");const Bb={init(){gb(),wb(),Mb(),Pb(),Nb(),Lb(),Fb(),T.info("ToolbarComponent","All controls initialized",null,"toolbar")}};function Zp(n,e){return e.some(s=>s.columnIndex===n)}function $b(n,e){return e.some(s=>n===s.columnIndex||n===s.columnIndex+1)}function lh(n,e){const s=an(e);return!$b(n,s)}function Qp(n,e){for(const s of e)if(n===s.columnIndex+1)return!1;return e.some(s=>n===s.columnIndex+2),!0}function qb(n,e,s,i){const{sharp:a,flat:r}=e.accidentalMode,c=e.showFrequencyLabels||!1,h=a||r,m=!a&&!r;function f(w){const x=[];return Pe.forEach(A=>{Sr(A.pitch)===w&&(A.column==="A"||A.column==="B")&&(A.column==="A"?x.push(1,e.columnWidths.length-2):A.column==="B"&&x.push(0,e.columnWidths.length-1))}),[...new Set(x)]}function g(w){const x=[];return Pe.forEach(A=>{Sr(A.pitch)===w&&(A.column==="A"||A.column==="B")&&(A.column==="A"?x.push(0,e.columnWidths.length-1):A.column==="B"&&x.push(1,e.columnWidths.length-2))}),[...new Set(x)]}function b(){return[1,e.columnWidths.length-2]}for(let w=s;w<=i;w++){const x=e.fullRowData[w];if(!x)continue;const A=Rt(w,e);if(A<-10||A>e.viewportHeight+10)continue;const P=Sr(x.pitch),M=O0(P);if(P==="C"||P==="E"){const I=f(P),D=mt(0,e),R=mt(e.columnWidths.length,e);Fc(n,D,R,A,e,I,"stroke",M)}else if(P==="G"){const I=mt(2,e),R=mt(e.columnWidths.length-2,e)-I;if(n.fillStyle=M.color,n.fillRect(I,A-e.cellHeight/2,R,e.cellHeight),!c){const H=b();m?(n.fillStyle=M.color,Xo(n,A,e,H,"fill",M)):h&&Xo(n,A,e,H,"stroke",M)}}else if(["B","A","F"].includes(P))if(m){let D=g(P).filter(R=>R!==0&&R!==e.columnWidths.length-1);P==="A"&&(D=D.filter(R=>R!==1&&R!==e.columnWidths.length-2)),D.length>0&&Xo(n,A,e,D,"stroke",M)}else{const I=g(P);Xo(n,A,e,I,"stroke",M)}else if(["E♭/D♯","D♭/C♯"].includes(P)){const I=g(P);Xo(n,A,e,I,"stroke",M)}else if(P==="B♭/A♯")if(m){const I=mt(0,e),D=mt(e.columnWidths.length,e);n.beginPath(),n.moveTo(I,A),n.lineTo(D,A),n.lineWidth=M.lineWidth,n.strokeStyle=M.color,n.setLineDash(M.dash),n.stroke(),n.setLineDash([])}else{const I=f(P),D=mt(0,e),R=mt(e.columnWidths.length,e);Fc(n,D,R,A,e,I,"stroke",M)}else{const I=f(P),D=mt(0,e),R=mt(e.columnWidths.length,e);Fc(n,D,R,A,e,I,"stroke",M)}}}function Fc(n,e,s,i,a,r,c,h){const m=r.map(g=>({start:mt(g,a),end:mt(g+1,a)})).sort((g,b)=>g.start-b.start);let f=e;m.forEach(g=>{f<g.start&&ch(n,f,g.start,i,a,c,h),f=Math.max(f,g.end)}),f<s&&ch(n,f,s,i,a,c,h)}function ch(n,e,s,i,a,r,c){r==="fill"?n.fillRect(e,i-a.cellHeight/2,s-e,a.cellHeight):(n.beginPath(),n.moveTo(e,i),n.lineTo(s,i),n.lineWidth=c.lineWidth,n.strokeStyle=c.color,n.setLineDash(c.dash),n.stroke(),n.setLineDash([]))}function Xo(n,e,s,i,a,r){i.forEach(c=>{const h=mt(c,s),m=mt(c+1,s);ch(n,h,m,e,s,a||"stroke",r)})}function zb(n,e,s,i){qb(n,e,s,i)}function Wb(n,e){Vb(n,e)}function Vb(n,e){const{columnWidths:s,macrobeatGroupings:i,macrobeatBoundaryStyles:a,placedTonicSigns:r}=e,c=s.length;let h=[],m=2;for(let f=0;f<i.length;f++){for(;r.some(g=>g.columnIndex===m);)m+=2;m+=i[f],h.push(m)}for(let f=0;f<=c;f++){const g=mt(f,e);let b;const w=f===2||f===c-2,x=Zp(f,r),A=r.some(I=>f===I.columnIndex+2),P=h.includes(f);if(Qp(f,r)){if(w||x||A)b={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(P){const I=h.indexOf(f);if(I!==-1){const D=a[I];if(D==="anacrusis")continue;b={lineWidth:1,strokeStyle:"#adb5bd",dash:D==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(g,0),n.lineTo(g,n.canvas.height),n.lineWidth=b.lineWidth,n.strokeStyle=b.strokeStyle,n.setLineDash(b.dash),n.stroke()}}n.setLineDash([])}const Bd=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function Hb(n){const e=an(n);if(e.length===0)return{leftTonic:null,rightTonic:null};const s=e.reduce((a,r)=>r.columnIndex<a.columnIndex?r:a),i=e.reduce((a,r)=>r.columnIndex>a.columnIndex?r:a);return{leftTonic:s,rightTonic:e.length===1?s:i}}function $d(n,e){const s=e[n];if(!s)return null;const a=s.pitch.replace(/\d+$/,"");return(a.includes("/")?a.split("/")[0]:a).replace(/♭/g,"b").replace(/♯/g,"#")}function qd(n,e){if(!n||!e)return[];const s=e-1;if(s<0||s>=Bd.length)return console.warn(`Invalid tonic number: ${e}`),[];const i=Bd[s];try{const a=`${n} ${i}`,r=zy(a);return console.log(`🎵 Focus Colours: Generated ${a} scale:`,r.notes),r.notes||[]}catch(a){return console.warn(`Could not generate ${i} scale for tonic: ${n}`,a),[]}}function Gb(n,e){if(!n||!e.length)return!1;const s=n.replace(/\d+$/,"");return(s.includes("/")?s.split("/"):[s]).map(r=>r.replace(/♭/g,"b").replace(/♯/g,"#")).some(r=>e.some(c=>{try{return bn(r)===bn(c)||r===c}catch{return r===c}}))}function jb(n,e,s,i){const{fullRowData:a,columnWidths:r,cellWidth:c,cellHeight:h,colorMode:m}=e,{sharp:f,flat:g}=u.state.accidentalMode,{focusColours:b,showFrequencyLabels:w}=u.state;let x=[],A=[];if(b){const D=Hb(u.state);if(D.leftTonic){const R=$d(D.leftTonic.row,a);x=qd(R,D.leftTonic.tonicNumber)}if(D.rightTonic){const R=$d(D.rightTonic.row,a);A=qd(R,D.rightTonic.tonicNumber)}}const P=(D,R=[],H=null)=>{if(w)return H&&H.frequency?String(H.frequency):D;if(!D.includes("/"))return D;const j=D.slice(-1),F=D.substring(0,D.length-1),[Y,tt]=F.split("/");if(b&&R.length>0){const nt=Y.replace(/♭/g,"b").replace(/♯/g,"#"),at=tt.replace(/♭/g,"b").replace(/♯/g,"#"),gt=R.some(Mt=>{try{return bn(Mt)===bn(nt)||Mt===nt}catch{return Mt===nt}}),_t=R.some(Mt=>{try{return bn(Mt)===bn(at)||Mt===at}catch{return Mt===at}});if(!f&&!g){if(gt)return`${Y}${j}`;if(_t)return`${tt}${j}`}else{if(f&&!g)return _t?`${tt}${j}`:null;if(!f&&g)return gt?`${Y}${j}`:null;if(f&&g)return gt||_t?`${Y}/${tt}${j}`:null}}return f&&g?`${Y}/${tt}${j}`:f?`${tt}${j}`:g?`${Y}${j}`:`${tt}${j}`},M=()=>!f&&!g;function I(D,R){const H=mt(D,e),j=r.slice(D,D+2).map(nt=>nt*c);let F=H;const tt=D===0?x:A;R.forEach((nt,at)=>{const gt=j[at];for(let _t=s;_t<=i;_t++){const Mt=a[_t];if(!(!Mt||Mt.isDummy)&&Mt.column===nt){const me=Rt(_t,e),Wt=Mt.pitch.includes("/"),Qt=!w&&Wt&&M();let it=m==="bw"?"#ffffff":Mt.hex||"#ffffff";const ht=P(Mt.pitch,tt,Mt),ut=ht===null;let Ct=Qt||ut;if(!w&&b&&tt.length>0&&!ut&&(Gb(Mt.pitch,tt)||(Ct=!0)),Ct){const $t=it.match(/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if($t){const _e=parseInt($t[1],16),Ue=parseInt($t[2],16),Ye=parseInt($t[3],16);it=`rgba(${_e}, ${Ue}, ${Ye}, 0)`}}if(n.fillStyle=it,n.fillRect(F,me-h/2,gt,h),Sr(Mt.pitch),ut)continue;const dt=ht.length<=3,Nt=Math.max(10,Math.min(c*1.2,h*1.2)),jt=dt?Nt:Nt*.7;n.font=`bold ${jt}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle";const Bt=F+gt/2,ee=me,je=Ct?"00":"FF";n.strokeStyle=`#212529${je}`,n.lineWidth=2.5,n.lineJoin="round",n.strokeText(ht,Bt,ee),n.fillStyle=`#ffffff${je}`,n.fillText(ht,Bt,ee)}}F+=gt})}I(0,["B","A"]),I(r.length-2,["A","B"])}function zd(n,e,s,i){const a=Math.sqrt(3)/2*s,r=Math.max(1,i-2*a),c=e-(r/2+a),h=c+a,m=h+r,f=m+a,g=n-s/2,b=n+s/2;return`M ${[`${n},${c}`,`${g},${h}`,`${g},${m}`,`${n},${f}`,`${b},${m}`,`${b},${h}`].join(" ")} Z`.replace(/,/g," ")}class Ub{constructor(e={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...e}}renderToCanvas(e,s,i,a,r,c,h="#000",m=null,f=null){const g=Math.min(r/100,c/100)*.8,b=this.options.diamondW*g,w=this.options.diamondH*g,x=this.options.ovalRx*g,A=this.options.ovalRy*g,P=[.125,.375,.625,.875].map(I=>i+I*r),M=a+c/2;e.save(),e.strokeStyle=h,e.fillStyle=h,e.lineWidth=this.options.strokeWidth,e.lineCap="round",e.lineJoin="round",s.ovals.forEach(I=>{var H;const D=I===0?i+.25*r:i+.75*r;let R=M;if(m&&f){const j=`oval_${I}`,F=((H=m.shapeOffsets)==null?void 0:H[j])||0,Y=m.row+F;R=f(Y),F!==0&&console.log("[STAMP RENDER] Drawing oval with offset:",{shapeKey:j,rowOffset:F,baseRow:m.row,shapeRow:Y,y:R})}e.beginPath(),e.ellipse(D,R,x,A,0,0,Math.PI*2),e.stroke()}),s.diamonds.forEach(I=>{var F;const D=P[I];let R=M;if(m&&f){const Y=`diamond_${I}`,tt=((F=m.shapeOffsets)==null?void 0:F[Y])||0,nt=m.row+tt;R=f(nt),tt!==0&&console.log("[STAMP RENDER] Drawing diamond with offset:",{slot:I,shapeKey:Y,rowOffset:tt,baseRow:m.row,shapeRow:nt,y:R})}const H=zd(D,R,b,w),j=new Path2D(H);e.stroke(j)}),e.restore()}renderToSVG(e,s=100,i=100){const a=document.createElementNS("http://www.w3.org/2000/svg","svg");a.setAttribute("viewBox",`0 0 ${s} ${i}`),a.style.color="#000000";const r=Math.min(s/100,i/100)*.8,c=this.options.diamondW*r,h=this.options.diamondH*r,m=this.options.ovalRx*r,f=this.options.ovalRy*r,g=[12.5,37.5,62.5,87.5],b=i/2;return e.ovals.forEach(w=>{const x=w===0?25:75,A=document.createElementNS("http://www.w3.org/2000/svg","ellipse");A.setAttribute("cx",x),A.setAttribute("cy",b),A.setAttribute("rx",m),A.setAttribute("ry",f),A.setAttribute("fill","none"),A.setAttribute("stroke","currentColor"),A.setAttribute("stroke-width",this.options.strokeWidth*2),A.setAttribute("stroke-linecap","round"),a.appendChild(A)}),e.diamonds.forEach(w=>{const x=g[w],A=zd(x,b,c,h),P=document.createElementNS("http://www.w3.org/2000/svg","path");P.setAttribute("d",A),P.setAttribute("fill","none"),P.setAttribute("stroke","currentColor"),P.setAttribute("stroke-width",this.options.strokeWidth*2),P.setAttribute("stroke-linejoin","round"),P.setAttribute("stroke-linecap","round"),a.appendChild(P)}),a}}const Fh=new Ub;T.moduleLoaded("StampRenderer","stamps");function Xb(n,e){const s=u.getAllStampPlacements();s.length!==0&&(T.debug("StampRenderer",`Rendering ${s.length} stamps`,{count:s.length},"stamps"),s.forEach(i=>{Yb(n,i,e)}))}function Yb(n,e,s){const i=Hr(e.stampId);if(!i)return;const{startColumn:a,endColumn:r,row:c,color:h}=e,m=mt(a,s),g=Rt(c,s)-s.cellHeight/2,b=s.cellWidth*2,w=s.cellHeight;if(m+b<0||m>n.canvas.width)return;const x=A=>Rt(A,s);Fh.renderToCanvas(n,i,m,g,b,w,h,e,x),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(m+1,g+1,b-2,w-2),n.restore(),T.debug("StampRenderer",`Rendered stamp ${i.id} at ${a}-${r},${c}`,{stampId:i.id,startColumn:a,endColumn:r,row:c,stampX:m,stampY:g,hasOffsets:!!e.shapeOffsets},"stamps")}function Zb(n,e,s,i,a){if(!i)return;const r=mt(e,a),h=Rt(s,a)-a.cellHeight/2,m=a.cellWidth*2,f=a.cellHeight;n.save(),n.globalAlpha=.6,Fh.renderToCanvas(n,i,r,h,m,f,a.previewColor||"#4a90e2"),n.restore()}function Qb({kind:n,cx:e,cy:s,stroke:i="currentColor",strokeWidth:a=4,scale:r=1}){const c=20*r,h=60*r,m=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return m.setAttribute("cx",e),m.setAttribute("cy",s),m.setAttribute("fill","none"),m.setAttribute("stroke",i),m.setAttribute("stroke-width",a),m.setAttribute("stroke-linecap","round"),n==="circleWide"?(m.setAttribute("rx",c*2),m.setAttribute("ry",h)):(m.setAttribute("rx",c),m.setAttribute("ry",h)),m}function Jb(n,e=48,s=48){const i=document.createElementNS("http://www.w3.org/2000/svg","svg"),a=n.span==="quarter",r=a?200:100;i.setAttribute("viewBox",`0 0 ${r} 100`),i.setAttribute("width",e),i.setAttribute("height",s),i.setAttribute("aria-label",n.label),i.style.color="#000000";const c=50,h=n.span==="eighth"?"ovalWide":"circleWide";let m;return a?m=[33.33,100,166.67]:m=[16.67,50,83.33],n.hits.forEach(f=>{const g=Qb({kind:h,cx:m[f],cy:c,stroke:"currentColor",strokeWidth:3,scale:.8});i.appendChild(g)}),i}T.moduleLoaded("TripletRenderer","triplets");function Kb(n,e){const s=u.getAllTripletPlacements();s.length!==0&&(T.debug("TripletRenderer",`Rendering ${s.length} triplet groups`,{count:s.length},"triplets"),s.forEach(i=>{tw(n,i,e)}))}function tw(n,e,s){const i=ai(e.stampId);if(!i)return;const{startCellIndex:a,span:r,row:c,color:h}=e,m=a*2,f=mt(m,s),g=Rt(c,s),b=g-s.cellHeight/2,w=s.cellWidth*2*r,x=s.cellHeight;if(f+w<0||f>n.canvas.width)return;Jp(n,i,f,g,w,x,h,e,P=>Rt(P,s)),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(f+1,b+1,w-2,x-2),n.restore()}function Jp(n,e,s,i,a,r,c,h=null,m=null){const f=e.span==="eighth"?"ovalWide":"circleWide",g=Math.min(a/100,r/100)*.8,b=Math.max(1,3*g);e.hits.forEach(w=>{var M;const x=Bp[w],A=s+a*x/100;let P=i;if(h&&m){const I=`triplet_${w}`,D=((M=h.shapeOffsets)==null?void 0:M[I])||0,R=h.row+D;P=m(R),D!==0&&console.log("[TRIPLET RENDER] Drawing notehead with offset:",{slot:w,shapeKey:I,rowOffset:D,baseRow:h.row,shapeRow:R,y:P})}ew(n,f,A,P,c,b,g)})}function ew(n,e,s,i,a="currentColor",r=4,c=1){const h=20*c,m=60*c;if(n.strokeStyle=a,n.lineWidth=r,n.fillStyle="none",n.beginPath(),e==="circleWide"){const f=h*2,g=m;n.ellipse(s,i,f,g,0,0,2*Math.PI)}else{const f=h,g=m;n.ellipse(s,i,f,g,0,0,2*Math.PI)}n.stroke()}function sw(n,e,s,i,a){if(!i)return;const r=e*2,c=i.span==="eighth"?1:2,h=mt(r,a),m=Rt(s,a),f=a.cellWidth*2*c,g=a.cellHeight;n.save(),n.globalAlpha=.6;const b=a.previewColor||"#4a90e2";Jp(n,i,h,m,f,g,b),n.restore()}function nw(n,e){const s=e.cellWidth||40;if(n===0)return 2*s;const i=n-1,a=cs(e,i);return a?(a.endColumn+1)*s:(console.warn("[MODULATION] Could not find measure info for index:",n),n*200)}function Kp(n,e){const{modulationMarkers:s}=e;if(!s||s.length===0)return;const i=s.filter(a=>a.active).map(a=>{let r;if(a.columnIndex!==null&&a.columnIndex!==void 0)r=mt(a.columnIndex+1,e);else if(a.macrobeatIndex!==null&&a.macrobeatIndex!==void 0){const c=cs(e,a.macrobeatIndex);c?r=mt(c.endColumn+1,e):(console.warn(`[GRIDLINE-ALIGN] Could not find macrobeat info for index ${a.macrobeatIndex}`),r=a.xPosition||0)}else a.measureIndex!==null&&a.measureIndex!==void 0?r=nw(a.measureIndex,e):r=a.xPosition||0;return{...a,xCanvas:r}});n.save(),i.forEach(a=>{iw(n,a)}),n.restore()}function iw(n,e,s){const i=e.xCanvas,a=e.ratio,r=Pp(a),c=Ep(a);ow(n,i,r),aw(n,i,c,r)}function ow(n,e,s,i){const r=n.canvas.height;n.beginPath(),n.moveTo(e,0),n.lineTo(e,r),n.lineWidth=3,n.strokeStyle=s,n.setLineDash([]),n.stroke()}function aw(n,e,s,i,a){const c="Arial, sans-serif";n.font=`14px ${c}`,n.textAlign="center",n.textBaseline="middle";const b=n.measureText(s).width,w=14,x=b+6*2,A=w+6*2,P=e-x/2,M=20;rw(n,P,M,x,A,8,i),n.fillStyle="white",n.fillText(s,e,M+A/2)}function rw(n,e,s,i,a,r,c){n.beginPath(),n.moveTo(e+r,s),n.lineTo(e+i-r,s),n.quadraticCurveTo(e+i,s,e+i,s+r),n.lineTo(e+i,s+a-r),n.quadraticCurveTo(e+i,s+a,e+i-r,s+a),n.lineTo(e+r,s+a),n.quadraticCurveTo(e,s+a,e,s+a-r),n.lineTo(e,s+r),n.quadraticCurveTo(e,s,e+r,s),n.closePath(),n.fillStyle=c,n.fill(),n.strokeStyle="rgba(0, 0, 0, 0.2)",n.lineWidth=1,n.stroke()}function ba(n,e){if(!e||e.length<3)return!1;const s=n.x!==void 0?n.x:n.col,i=n.y!==void 0?n.y:n.row;let a=!1;for(let r=0,c=e.length-1;r<e.length;c=r++){const h=e[r].x!==void 0?e[r].x:e[r].col,m=e[r].y!==void 0?e[r].y:e[r].row,f=e[c].x!==void 0?e[c].x:e[c].col,g=e[c].y!==void 0?e[c].y:e[c].row;m>i!=g>i&&s<(f-h)*(i-m)/(g-m)+h&&(a=!a)}return a}function dr(n){if(!n||n.length<3)return n;const e=n.map(r=>({x:r.x!==void 0?r.x:r.col,y:r.y!==void 0?r.y:r.row}));let s=e[0];for(let r=1;r<e.length;r++)(e[r].y<s.y||e[r].y===s.y&&e[r].x<s.x)&&(s=e[r]);const i=e.filter(r=>r!==s);i.sort((r,c)=>{const h=Math.atan2(r.y-s.y,r.x-s.x),m=Math.atan2(c.y-s.y,c.x-s.x);if(h!==m)return h-m;const f=Math.hypot(r.x-s.x,r.y-s.y),g=Math.hypot(c.x-s.x,c.y-s.y);return f-g});const a=[s,i[0]];for(let r=1;r<i.length;r++){for(;a.length>1&&!lw(a[a.length-2],a[a.length-1],i[r]);)a.pop();a.push(i[r])}return a}function lw(n,e,s){return(e.x-n.x)*(s.y-n.y)-(e.y-n.y)*(s.x-n.x)>0}function cw(n,e,s,i=10){const a=n.x,r=n.y,c=e.x,h=e.y,m=s.x,f=s.y,g=m-c,b=f-h,w=g*g+b*b;if(w===0)return Math.hypot(a-c,r-h)<=i;let x=((a-c)*g+(r-h)*b)/w;x=Math.max(0,Math.min(1,x));const A=c+x*g,P=h+x*b;return Math.hypot(a-A,r-P)<=i}function Wd(n,e,s=10){if(!e||e.length<2)return!1;for(let i=0;i<e.length;i++){const a=e[i],r=e[(i+1)%e.length];if(cw(n,a,r,s))return!0}return!1}function hw(n,e){const{centerX:s,centerY:i,rx:a,ry:r}=e,c=16;for(let h=0;h<c;h++){const m=h/c*2*Math.PI,f=s+a*Math.cos(m),g=i+r*Math.sin(m);if(ba({x:f,y:g},n))return!0}return!!ba({x:s,y:i},n)}function Vd(n,e){const{x:s,y:i,width:a,height:r}=e,c=[{x:s,y:i},{x:s+a,y:i},{x:s+a,y:i+r},{x:s,y:i+r}];for(const h of c)if(ba(h,n))return!0;for(const h of n){const m=h.x!==void 0?h.x:h.col,f=h.y!==void 0?h.y:h.row;if(m>=s&&m<=s+a&&f>=i&&f<=i+r)return!0}return!1}T.moduleLoaded("AnnotationService","annotation");class uw{constructor(){this.canvas=null,this.ctx=null,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null}initialize(){if(this.canvas=document.getElementById("notation-grid"),!this.canvas){T.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}this.ctx=this.canvas.getContext("2d"),this.setupEventListeners(),u.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),T.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){if(!this.selectedAnnotation)return;const s=document.activeElement,i=s.contentEditable==="true",a=s.tagName.toLowerCase();["input","textarea"].includes(a)||i||(e.key==="Delete"||e.key==="Backspace")&&(e.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const e=u.state.annotations.indexOf(this.selectedAnnotation);e>-1&&(u.state.annotations.splice(e,1),this.selectedAnnotation=null,u.recordState(),this.render(),T.log("AnnotationService","Deleted annotation","annotation"))}resize(){if(!this.canvas)return;const e=document.getElementById("notation-grid");e&&(this.canvas.width=e.width,this.canvas.height=e.height,this.render())}getRenderOptions(){return{columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth}}canvasToGrid(e,s){const i=this.getRenderOptions();return{col:F0(e,i),row:B0(s,i)}}gridToCanvas(e,s){const i=this.getRenderOptions();return{x:mt(e,i),y:Rt(s,i)}}setTool(e,s){if(this.currentTool=e,this.toolSettings=s,this.canvas)switch(e){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(e){var h,m;if(!this.currentTool||!this.toolSettings)return;const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,a=e.clientY-s.top,r=this.canvasToGrid(i,a);if(e.button===2){if(this.currentTool==="lasso"&&((h=u.state.lassoSelection)!=null&&h.isActive)){this.removeFromLassoSelection(i,a);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(i,a),this.showEraserCursor(i,a);return}if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const f=this.getResizeHandleAt(i,a,this.selectedAnnotation);if(f){this.isResizing=!0,this.resizeHandle=f,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:r.col,mouseRow:r.row};return}}if((m=u.state.lassoSelection)!=null&&m.isActive&&u.state.lassoSelection.convexHull){const f=Wd({x:i,y:a},u.state.lassoSelection.convexHull,10),g=ba({x:i,y:a},u.state.lassoSelection.convexHull);if(f||g){this.isDraggingSelection=!0,this.selectionDragStart={canvasX:i,canvasY:a},this.selectionDragTotal={col:0,row:0};return}}const c=this.getAnnotationAt(i,a);if(c&&(c.type==="arrow"||c.type==="text")){if(this.selectedAnnotation===c){this.isDragging=!0,c.type==="arrow"?this.dragOffset={startCol:r.col-c.startCol,startRow:r.row-c.startRow,endCol:r.col-c.endCol,endRow:r.row-c.endRow}:c.type==="text"&&(this.dragOffset={col:r.col-c.col,row:r.row-c.row});return}this.selectedAnnotation=c,this.loadAnnotationSettings(c),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=r,this.currentPath=[r],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[r],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:i,y:a}]};break}}handleMouseMove(e){const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,a=e.clientY-s.top,r=this.canvasToGrid(i,a);if(this.tempEraserMode){this.eraseAtPoint(i,a),this.showEraserCursor(i,a);return}if(this.isResizing&&this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=r.col-this.resizeStartBounds.mouseCol,h=r.row-this.resizeStartBounds.mouseRow;let m=this.resizeStartBounds.col,f=this.resizeStartBounds.row,g=this.resizeStartBounds.widthCols,b=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+h,b=this.resizeStartBounds.heightRows-h),this.resizeHandle.includes("s")&&(b=this.resizeStartBounds.heightRows+h),this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+c,g=this.resizeStartBounds.widthCols-c),this.resizeHandle.includes("e")&&(g=this.resizeStartBounds.widthCols+c);const w=2,x=1;g<w&&(this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-w),g=w),b<x&&(this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-x),b=x),this.selectedAnnotation.col=m,this.selectedAnnotation.row=f,this.selectedAnnotation.widthCols=g,this.selectedAnnotation.heightRows=b,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart){const c=this.getRenderOptions(),h=i-this.selectionDragStart.canvasX,m=a-this.selectionDragStart.canvasY,f=Math.round(h/c.cellWidth),g=Math.round(m/(c.cellHeight/2)),b={col:f-this.selectionDragTotal.col,row:g-this.selectionDragTotal.row};if(b.col!==0||b.row!==0){u.state.lassoSelection.selectedItems.forEach(x=>{if(x.type==="note"){x.data.row+=b.row;const A=x.data.columnIndex!==void 0?"columnIndex":"startColumnIndex";x.data[A]+=b.col,x.data.endColumnIndex!==void 0&&(x.data.endColumnIndex+=b.col)}else x.type==="stamp"?(x.data.row+=b.row,x.data.startColumn+=b.col,x.data.endColumn+=b.col):x.type==="triplet"&&(x.data.row+=b.row,x.data.column+=b.col)}),this.selectionDragTotal.col=f,this.selectionDragTotal.row=g;const w=u.state.lassoSelection.selectedItems.map(x=>{const A=x.data.columnIndex!==void 0?x.data.columnIndex:x.data.startColumnIndex!==void 0?x.data.startColumnIndex:x.data.column,P=mt(A,c),M=Rt(x.data.row,c);return{x:P,y:M}});u.state.lassoSelection.convexHull=dr(w),this.render()}return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=r.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=r.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=r.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=r.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=r.col-this.dragOffset.col,this.selectedAnnotation.row=r.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(i,a);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"text":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const c=this.tempAnnotation.path[this.tempAnnotation.path.length-1],h=this.interpolatePoints(c,r);this.tempAnnotation.path.push(...h)}else this.tempAnnotation.path.push(r);this.render();break;case"lasso":this.tempAnnotation.path.push({x:i,y:a}),this.render();break}}handleMouseUp(e){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,u.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,u.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,u.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:s,startRow:i,endCol:a,endRow:r}=this.tempAnnotation,c=Math.abs(a-s),h=Math.abs(r-i),m=Math.min(s,a),f=Math.min(i,r);c>.5&&h>.2&&this.createTextAnnotation(m,f,c,h),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection():(u.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),u.recordState()),this.tempAnnotation=null,this.render()}}}handleMouseLeave(e){this.isDrawing&&this.handleMouseUp(e)}handleDoubleClick(e){const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,a=e.clientY-s.top,r=this.getAnnotationAt(i,a);r&&r.type==="text"&&this.editTextAnnotation(r)}editTextAnnotation(e){const{col:s,row:i,widthCols:a,heightRows:r,text:c,settings:h}=e,m=u.state.annotations.indexOf(e);m>-1&&(u.state.annotations.splice(m,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(s,i,a,r,c,h)}createTextAnnotation(e,s,i,a,r=null,c=null){this.isDrawing=!1;const h=this.gridToCanvas(e,s),m=this.gridToCanvas(e+i,s+a),f=h.x,g=h.y,b=m.x-f,w=m.y-g,A=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',P=c||this.toolSettings.text,M=document.createElement("div");M.contentEditable=!0,M.className="annotation-text-input",M.textContent=r||"Type here...";const I=P.size,D=I*1.2;M.style.width=`${b}px`,M.style.height=`${w}px`,M.style.padding=P.background?"4px 8px":"4px",M.style.border="2px dashed rgba(74, 144, 226, 0.5)",M.style.backgroundColor=P.background?"#ffffff":"transparent",M.style.color=P.color,M.style.fontSize=`${I}px`,M.style.lineHeight=`${D}px`,M.style.fontWeight=P.bold?"bold":"normal",M.style.fontStyle=P.italic?"italic":"normal",M.style.textDecoration=P.underline?"underline":"none",P.superscript?(M.style.fontSize=`${I*.6}px`,M.style.verticalAlign="super"):P.subscript&&(M.style.fontSize=`${I*.6}px`,M.style.verticalAlign="sub"),M.style.outline="none",M.style.zIndex="10000",M.style.position="fixed",M.style.cursor="text",M.style.pointerEvents="auto",M.style.fontFamily=A,M.style.whiteSpace="pre-wrap",M.style.wordWrap="break-word",M.style.overflow="hidden",M.style.boxSizing="border-box";const R=this.canvas.getBoundingClientRect();M.style.left=`${R.left+f}px`,M.style.top=`${R.top+g}px`,document.body.appendChild(M),M.focus();const H=document.createRange();H.selectNodeContents(M);const j=window.getSelection();j.removeAllRanges(),j.addRange(H);let F=!1;const Y=()=>{if(F)return;F=!0;const nt=M.textContent.trim();if(nt&&nt!=="Type here..."){const at={type:"text",col:e,row:s,widthCols:i,heightRows:a,text:nt,settings:{...P}};u.state.annotations.push(at),this.selectedAnnotation=u.state.annotations[u.state.annotations.length-1],u.recordState(),this.render()}document.body.contains(M)&&document.body.removeChild(M)};let tt=!1;M.addEventListener("input",()=>{!tt&&M.textContent==="Type here..."&&(M.textContent="",tt=!0)}),setTimeout(()=>{M.addEventListener("blur",Y)},100),M.addEventListener("keydown",nt=>{nt.key==="Enter"&&!nt.shiftKey&&(nt.preventDefault(),Y()),nt.key==="Escape"&&(F=!0,document.body.contains(M)&&document.body.removeChild(M))})}handleLassoSelection(){if(!this.tempAnnotation||!this.tempAnnotation.path)return;const e=this.tempAnnotation.path,s=[],i=this.getRenderOptions();window.event&&window.event.shiftKey&&u.state.lassoSelection.selectedItems&&s.push(...u.state.lassoSelection.selectedItems),u.state.placedNotes.forEach((c,h)=>{if(c.isDrum)return;const m=c.columnIndex!==void 0?c.columnIndex:c.startColumnIndex,f=mt(m,i),g=Rt(c.row,i),{cellWidth:b,cellHeight:w}=i;let x=b;i.modulationMarkers&&i.modulationMarkers.length>0&&(x=mt(m+1,i)-f);const A=c.shape==="oval"?f+x:f+x/2,P=g,M=c.shape==="oval"?x:x/2,I=w/2;if(hw(e,{centerX:A,centerY:P,rx:M,ry:I})){const D=`note-${c.row}-${m}-${c.color}-${c.shape}`;s.find(R=>R.id===D)||s.push({type:"note",id:D,data:c,index:h})}}),u.state.stampPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=i,g=mt(c.startColumn,i),b=Rt(c.row,i)-f/2,w=m*2;if(Vd(e,{x:g,y:b,width:w,height:f})){const A=`stamp-${c.row}-${c.startColumn}-${c.stampId}`;s.find(P=>P.id===A)||s.push({type:"stamp",id:A,data:c,index:h})}}),u.state.tripletPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=i,g=mt(c.column,i),b=Rt(c.row,i)-f/2,w=m*2;if(Vd(e,{x:g,y:b,width:w,height:f})){const A=`triplet-${c.row}-${c.column}-${c.tripletId}`;s.find(P=>P.id===A)||s.push({type:"triplet",id:A,data:c,index:h})}});let r=null;if(s.length>0){const c=s.map(h=>{const m=h.data.columnIndex!==void 0?h.data.columnIndex:h.data.startColumnIndex!==void 0?h.data.startColumnIndex:h.data.column,f=mt(m,i),g=Rt(h.data.row,i);return{x:f,y:g}});r=dr(c)}u.state.lassoSelection={selectedItems:s,convexHull:r,isActive:s.length>0},u.recordState(),T.log("AnnotationService",`Lasso selection completed: ${s.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){var i,a;if(!((i=u.state.lassoSelection)!=null&&i.isActive)||!((a=u.state.lassoSelection.selectedItems)!=null&&a.length))return;const e=this.getRenderOptions(),s=u.state.lassoSelection.selectedItems.map(r=>{const c=r.data.columnIndex!==void 0?r.data.columnIndex:r.data.startColumnIndex!==void 0?r.data.startColumnIndex:r.data.column,h=mt(c,e),m=Rt(r.data.row,e);return{x:h,y:m}});u.state.lassoSelection.convexHull=dr(s)}removeFromLassoSelection(e,s){var c;if(!((c=u.state.lassoSelection)!=null&&c.isActive))return;const i=this.getRenderOptions(),a=15;let r=null;if(u.state.placedNotes.forEach(h=>{const m=mt(h.columnIndex,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=a&&(r=`note-${h.row}-${h.columnIndex}-${h.color}-${h.shape}`)}),r||u.state.stampPlacements.forEach(h=>{const m=mt(h.column,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=a&&(r=`stamp-${h.row}-${h.column}-${h.stampId}`)}),r||u.state.tripletPlacements.forEach(h=>{const m=mt(h.column,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=a&&(r=`triplet-${h.row}-${h.column}-${h.tripletId}`)}),r){const h=u.state.lassoSelection.selectedItems.filter(f=>f.id!==r);let m=null;if(h.length>0){const f=h.map(g=>{const b=mt(g.data.columnIndex||g.data.column,i),w=Rt(g.data.row,i);return{x:b,y:w}});m=dr(f)}u.state.lassoSelection={selectedItems:h,convexHull:m,isActive:h.length>0},u.recordState(),this.render(),T.log("AnnotationService",`Removed item from lasso selection. ${h.length} items remain.`,"annotation")}}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(e){const{startX:s,startY:i,endX:a,endY:r}=e,c=this.ctx,h=Math.min(s,a),m=Math.min(i,r),f=Math.abs(a-s),g=Math.abs(r-i);c.save(),c.strokeStyle="rgba(74, 144, 226, 0.6)",c.lineWidth=2,c.setLineDash([5,5]),c.strokeRect(h,m,f,g),this.toolSettings.text.background&&(c.fillStyle="rgba(255, 255, 255, 0.8)",c.fillRect(h,m,f,g)),c.restore()}render(){Yi.render()}drawArrow(e,s=!1,i=!1,a=!1){const{startX:r,startY:c,endX:h,endY:m,settings:f}=e,g=this.ctx;g.save(),i&&(g.strokeStyle="#4a90e2",g.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,g.globalAlpha=.3,g.setLineDash([]),g.beginPath(),g.moveTo(r,c),g.lineTo(h,m),g.stroke(),g.globalAlpha=1),a&&!i&&(g.strokeStyle="#4a90e2",g.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,g.globalAlpha=.15,g.setLineDash([]),g.beginPath(),g.moveTo(r,c),g.lineTo(h,m),g.stroke(),g.globalAlpha=1),g.strokeStyle=s?"rgba(0, 0, 0, 0.5)":"#000000",g.lineWidth=this.getStrokeWidth(f.strokeWeight),g.setLineDash(this.getLineDash(f.lineStyle));const b=Math.atan2(m-c,h-r),w=f.arrowheadSize||12;let x=r,A=c,P=h,M=m;f.startArrowhead!=="none"&&(x=r+Math.cos(b)*w,A=c+Math.sin(b)*w),f.endArrowhead!=="none"&&(P=h-Math.cos(b)*w,M=m-Math.sin(b)*w),g.beginPath(),g.moveTo(x,A),g.lineTo(P,M),g.stroke(),f.startArrowhead!=="none"&&this.drawArrowhead(g,r,c,b+Math.PI,f.startArrowhead,w),f.endArrowhead!=="none"&&this.drawArrowhead(g,h,m,b,f.endArrowhead,w),g.restore()}drawArrowhead(e,s,i,a,r,c=12){switch(e.save(),e.translate(s,i),e.rotate(a),e.setLineDash([]),r){case"filled":case"filled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.fillStyle=e.strokeStyle,e.fill();break;case"unfilled":case"unfilled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.stroke();break;case"circle":e.beginPath(),e.arc(0,0,c/3,0,Math.PI*2),e.fillStyle=e.strokeStyle,e.fill();break}e.restore()}wrapText(e,s,i){const a=s.split(`
`),r=[];return a.forEach(c=>{if(!c.trim()){r.push("");return}const h=c.split(" ");let m="";h.forEach((f,g)=>{const b=m?m+" "+f:f;e.measureText(b).width>i&&m?(r.push(m),m=f):m=b}),m&&r.push(m)}),r}drawText(e,s=!1,i=!1){const{x:a,y:r,text:c,settings:h}=e,m=this.ctx;m.save();const g=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',b=this.getSizeValue(h.size);m.font=`${h.italic?"italic ":""}${h.bold?"bold ":""}${b} ${g}`,m.textBaseline="top";const w=parseInt(b)*1.2,x=e.width||0,A=e.height||0,P=h.background?16:8,M=x-P,I=this.wrapText(m,c,M);if(h.background){m.fillStyle="#ffffff";const R=8;m.fillRect(a-R/2,r-R/2,x+R,A+R/2)}if(i&&!s){m.fillStyle="rgba(74, 144, 226, 0.1)";const R=h.background?8:2;m.fillRect(a-R/2,r-R/2,x+R,A+R/2)}if(s){m.fillStyle="rgba(74, 144, 226, 0.2)";const R=h.background?8:2;m.fillRect(a-R/2,r-R/2,x+R,A+R/2)}m.fillStyle=h.color;const D=parseInt(b);I.forEach((R,H)=>{const j=r+H*w;this.drawTextWithSuperscripts(m,R,a,j,D,h,g)}),s&&this.drawResizeHandles(a,r,x,A),m.restore()}drawTextWithSuperscripts(e,s,i,a,r,c,h){if(c.superscript||c.subscript){e.save();const b=r*.6,w=c.superscript?-r*.4:r*.3;if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${b}px ${h}`,e.fillText(s,i,a+w),c.underline){const x=e.measureText(s);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(i,a+w+b*1.2-2),e.lineTo(i+x.width,a+w+b*1.2-2),e.stroke()}e.restore();return}let m=i;const f=this.parseFormattedText(s),g=(b,w)=>{if(b){if(e.save(),w==="superscript"){const x=r*.6,A=-r*.4;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${x}px ${h}`,e.fillText(b,m,a+A),m+=e.measureText(b).width}else if(w==="subscript"){const x=r*.6,A=r*.3;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${x}px ${h}`,e.fillText(b,m,a+A),m+=e.measureText(b).width}else{if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${r}px ${h}`,e.fillText(b,m,a),c.underline){const x=e.measureText(b);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(m,a+r*1.2-2),e.lineTo(m+x.width,a+r*1.2-2),e.stroke()}m+=e.measureText(b).width}e.restore()}};f.forEach(b=>{g(b.text,b.format)})}parseFormattedText(e){const s=[];let i=0,a="",r=!1;for(;i<e.length;){if(e.substr(i,5)==="<sup>"){a&&(s.push({text:a,format:"normal"}),a="");const c=e.indexOf("</sup>",i);if(c!==-1){const h=e.substring(i+5,c);s.push({text:h,format:"superscript"}),i=c+6;continue}}if(e.substr(i,5)==="<sub>"){a&&(s.push({text:a,format:"normal"}),a="");const c=e.indexOf("</sub>",i);if(c!==-1){const h=e.substring(i+5,c);s.push({text:h,format:"subscript"}),i=c+6;continue}}if(e[i]==="^"&&!r){a&&(s.push({text:a,format:"normal"}),a=""),r=!0,i++;continue}if(r&&e[i]===" "){a&&(s.push({text:a,format:"superscript"}),a=""),r=!1,s.push({text:" ",format:"normal"}),i++;continue}a+=e[i],i++}return a&&s.push({text:a,format:r?"superscript":"normal"}),s}drawResizeHandles(e,s,i,a){const r=this.ctx,c=8,h=[{pos:"nw",x:e,y:s},{pos:"n",x:e+i/2,y:s},{pos:"ne",x:e+i,y:s},{pos:"e",x:e+i,y:s+a/2},{pos:"se",x:e+i,y:s+a},{pos:"s",x:e+i/2,y:s+a},{pos:"sw",x:e,y:s+a},{pos:"w",x:e,y:s+a/2}];r.save(),h.forEach(m=>{r.fillStyle="#4a90e2",r.strokeStyle="#ffffff",r.lineWidth=2,r.fillRect(m.x-c/2,m.y-c/2,c,c),r.strokeRect(m.x-c/2,m.y-c/2,c,c)}),r.restore()}drawPath(e,s){const{path:i,settings:a}=e,r=this.ctx;if(!(i.length<2)){r.save(),s&&(r.globalAlpha=.3),r.strokeStyle=a.color,r.lineWidth=this.getStrokeWidth(a.size),r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(i[0].x,i[0].y);for(let c=1;c<i.length;c++)r.lineTo(i[c].x,i[c].y);r.stroke(),r.restore()}}drawLassoPath(e){const{path:s}=e,i=this.ctx;if(!(s.length<2)){i.save(),i.strokeStyle="rgba(0, 100, 255, 0.8)",i.lineWidth=2,i.setLineDash([5,5]),i.beginPath(),i.moveTo(s[0].x,s[0].y);for(let a=1;a<s.length;a++)i.lineTo(s[a].x,s[a].y);i.lineTo(s[0].x,s[0].y),i.stroke(),i.restore()}}getStrokeWidth(e){if(typeof e=="number")return e;switch(e){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(e){switch(e){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(e){if(typeof e=="number")return`${e}px`;switch(e){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(e,s){var r;const i=this.hoverAnnotation;if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=this.getResizeHandleAt(e,s,this.selectedAnnotation);if(c){const h={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=h[c];return}}if((r=u.state.lassoSelection)!=null&&r.isActive&&u.state.lassoSelection.convexHull){const c=Wd({x:e,y:s},u.state.lassoSelection.convexHull,10),h=ba({x:e,y:s},u.state.lassoSelection.convexHull);if(c||h){this.canvas.style.cursor="move";return}}const a=this.getAnnotationAt(e,s);a&&(a.type==="arrow"||a.type==="text")?(this.canvas.style.cursor="move",this.hoverAnnotation=a):(this.setTool(this.currentTool,this.toolSettings),this.hoverAnnotation=null),i!==this.hoverAnnotation&&this.render()}getResizeHandleAt(e,s,i){if(!i||i.type!=="text")return null;const r=8/2+2,c=i.width||0,h=i.height||0,m=i.x,f=i.y,g=[{pos:"nw",x:m,y:f},{pos:"n",x:m+c/2,y:f},{pos:"ne",x:m+c,y:f},{pos:"e",x:m+c,y:f+h/2},{pos:"se",x:m+c,y:f+h},{pos:"s",x:m+c/2,y:f+h},{pos:"sw",x:m,y:f+h},{pos:"w",x:m,y:f+h/2}];for(const b of g)if(Math.sqrt(Math.pow(e-b.x,2)+Math.pow(s-b.y,2))<=r)return b.pos;return null}getAnnotationAt(e,s){for(let a=u.state.annotations.length-1;a>=0;a--){const r=u.state.annotations[a];if(r.type==="arrow"){if(this.distanceToLineSegment(e,s,r.startX,r.startY,r.endX,r.endY)<10)return r}else if(r.type==="text"){let c=r.width,h=r.height;if(!c||!h){const m=r.text.split(`
`),f=r.settings.size,g=f*1.2;this.ctx.font=`${f}px Arial`,c=0,m.forEach(b=>{const w=this.ctx.measureText(b);c=Math.max(c,w.width)}),h=m.length*g}if(e>=r.x&&e<=r.x+c&&s>=r.y&&s<=r.y+h)return r}}return null}showEraserCursor(e,s){this.render();const a=(u.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(e-a/2,s-a/2,a,a),this.ctx.restore()}loadAnnotationSettings(e){if(e.type==="arrow"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.arrow={...s},window.drawToolsController.renderArrowOptions()}else if(e.type==="text"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.text={...s},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){u.state.annotations=[],this.render()}eraseAtPoint(e,s){let a=!1;return u.state.annotations=u.state.annotations.filter(r=>{let c=!0;if(r.type==="arrow"){const h=this.getRenderOptions(),m=mt(r.startCol,h),f=Rt(r.startRow,h),g=mt(r.endCol,h),b=Rt(r.endRow,h);this.distanceToLineSegment(e,s,m,f,g,b)<10&&(c=!1,a=!0)}else if(r.type==="text"){const h=this.getRenderOptions(),m=mt(r.col,h),f=Rt(r.row,h),g=mt(r.col+r.widthCols,h),b=Rt(r.row+r.heightRows,h);e>=m&&e<=g&&s>=f&&s<=b&&(c=!1,a=!0)}else if(r.type==="marker"||r.type==="highlighter"){const h=this.getRenderOptions();for(let m=0;m<r.path.length;m++){const f=mt(r.path[m].col,h),g=Rt(r.path[m].row,h),b=e-f,w=s-g;if(Math.sqrt(b*b+w*w)<10){c=!1,a=!0;break}}}return c}),a&&this.render(),a}interpolatePoints(e,s){const i=[],a=s.col-e.col,r=s.row-e.row,c=Math.sqrt(a*a+r*r),h=Math.max(1,Math.floor(c/.1));for(let m=1;m<=h;m++){const f=m/h;i.push({col:e.col+f*a,row:e.row+f*r})}return i}distanceToLineSegment(e,s,i,a,r,c){const h=r-i,m=c-a,f=h*h+m*m;if(f===0){const P=e-i,M=s-a;return Math.sqrt(P*P+M*M)}let g=((e-i)*h+(s-a)*m)/f;g=Math.max(0,Math.min(1,g));const b=i+g*h,w=a+g*m,x=e-b,A=s-w;return Math.sqrt(x*x+A*A)}deleteAnnotationAt(e,s){this.eraseAtPoint(e,s)}getAnnotations(){return u.state.annotations}loadAnnotations(e){u.state.annotations=e||[],this.render()}applyInlineFormatting(e){const s=document.querySelector(".annotation-text-input");if(!s)return;const i=window.getSelection();if(!i.rangeCount)return;const a=i.getRangeAt(0),r=a.toString();if(!r)return;let c;if(e==="superscript")c=`<sup>${r}</sup>`;else if(e==="subscript")c=`<sub>${r}</sub>`;else return;a.deleteContents();const h=document.createTextNode(c);a.insertNode(h),a.setStartAfter(h),a.setEndAfter(h),i.removeAllRanges(),i.addRange(a),s.focus()}}const Ut=new uw;function dw(n,e){var c;const s=u.state.annotations,i=Ut.tempAnnotation,a=Ut.selectedAnnotation,r=Ut.hoverAnnotation;if(s&&s.length>0&&s.forEach(h=>{const m=h===a,f=h===r;switch(h.type){case"arrow":Hd(n,h,m,f,e);break;case"text":pw(n,h,m,f,e);break;case"marker":pr(n,h,!1,e);break;case"highlighter":pr(n,h,!0,e);break}}),i)switch(i.type){case"arrow":Hd(n,i,!1,!1,e);break;case"text":yw(n,i,e);break;case"marker":pr(n,i,!1,e);break;case"highlighter":pr(n,i,!0,e);break;case"lasso":ww(n,i);break}(c=u.state.lassoSelection)!=null&&c.isActive&&u.state.lassoSelection.convexHull&&(Ut.updateLassoConvexHull(),_w(n,u.state.lassoSelection.convexHull))}function Hd(n,e,s=!1,i=!1,a){const{startCol:r,startRow:c,endCol:h,endRow:m,settings:f}=e,g=mt(r,a),b=Rt(c,a),w=mt(h,a),x=Rt(m,a);n.save(),n.strokeStyle=e.color||"#000000",n.lineWidth=hh(f.strokeWeight),n.setLineDash(bw(f.lineStyle));const A=Math.atan2(x-b,w-g),P=f.arrowheadSize||12;let M=g,I=b,D=w,R=x;f.startArrowhead!=="none"&&(M=g+Math.cos(A)*P,I=b+Math.sin(A)*P),f.endArrowhead!=="none"&&(D=w-Math.cos(A)*P,R=x-Math.sin(A)*P),n.beginPath(),n.moveTo(M,I),n.lineTo(D,R),n.stroke(),n.setLineDash([]),f.startArrowhead!=="none"&&Gd(n,g,b,A+Math.PI,f.startArrowhead,P),f.endArrowhead!=="none"&&Gd(n,w,x,A,f.endArrowhead,P),(s||i)&&(n.strokeStyle=s?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",n.lineWidth=hh(f.strokeWeight)+4,n.setLineDash([]),n.beginPath(),n.moveTo(g,b),n.lineTo(w,x),n.stroke()),n.restore()}function Gd(n,e,s,i,a,r){switch(n.save(),n.translate(e,s),n.rotate(i),a){case"filled":case"filled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-r,-r/2),n.lineTo(-r,r/2),n.closePath(),n.fillStyle=n.strokeStyle,n.fill();break;case"unfilled":case"unfilled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-r,-r/2),n.lineTo(-r,r/2),n.closePath(),n.stroke();break;case"circle":n.beginPath(),n.arc(0,0,r/3,0,Math.PI*2),n.fillStyle=n.strokeStyle,n.fill();break}n.restore()}function pw(n,e,s=!1,i=!1,a){const{col:r,row:c,text:h,settings:m,widthCols:f,heightRows:g}=e,b=mt(r,a),w=Rt(c,a),x=mt(r+f,a)-b,A=Rt(c+g,a)-w;n.save();const M=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',I=m.size,D=I*1.2,R=m.background?8:4,H=4,j=x-R*2,F=mw(n,h,j,I,m,M);m.background&&(n.fillStyle="#ffffff",n.fillRect(b,w,x,A)),i&&!s&&(n.fillStyle="rgba(74, 144, 226, 0.1)",n.fillRect(b,w,x,A)),s&&(n.fillStyle="rgba(74, 144, 226, 0.2)",n.fillRect(b,w,x,A)),n.fillStyle=m.color,F.forEach((Y,tt)=>{const nt=w+H+tt*D;fw(n,Y,b+R,nt,I,m,M)}),s&&vw(n,b,w,x,A),n.restore()}function mw(n,e,s,i,a,r){n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${i}px ${r}`;const c=e.split(`
`),h=[];return c.forEach(m=>{if(!m.trim()){h.push("");return}const f=m.split(" ");let g="";f.forEach(b=>{const w=g?g+" "+b:b;n.measureText(w).width>s&&g?(h.push(g),g=b):g=w}),g&&h.push(g)}),h}function fw(n,e,s,i,a,r,c){if(r.superscript||r.subscript){n.save();const f=a*.6,g=r.superscript?-a*.4:a*.3;if(n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${f}px ${c}`,n.fillText(e,s,i+g),r.underline){const b=n.measureText(e);n.beginPath(),n.strokeStyle=r.color,n.lineWidth=1,n.moveTo(s,i+g+f*1.2-2),n.lineTo(s+b.width,i+g+f*1.2-2),n.stroke()}n.restore();return}const h=gw(e);let m=s;h.forEach(f=>{if(n.save(),f.format==="superscript"){const g=a*.6,b=-a*.4;n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${g}px ${c}`,n.fillText(f.text,m,i+b),m+=n.measureText(f.text).width}else if(f.format==="subscript"){const g=a*.6,b=a*.3;n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${g}px ${c}`,n.fillText(f.text,m,i+b),m+=n.measureText(f.text).width}else{if(n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${a}px ${c}`,n.fillText(f.text,m,i),r.underline){const g=n.measureText(f.text);n.beginPath(),n.strokeStyle=r.color,n.lineWidth=1,n.moveTo(m,i+a*1.2-2),n.lineTo(m+g.width,i+a*1.2-2),n.stroke()}m+=n.measureText(f.text).width}n.restore()})}function gw(n){const e=[];let s=0,i="",a=!1;for(;s<n.length;){if(n.substr(s,5)==="<sup>"){i&&(e.push({text:i,format:"normal"}),i="");const r=n.indexOf("</sup>",s);if(r!==-1){const c=n.substring(s+5,r);e.push({text:c,format:"superscript"}),s=r+6;continue}}if(n.substr(s,5)==="<sub>"){i&&(e.push({text:i,format:"normal"}),i="");const r=n.indexOf("</sub>",s);if(r!==-1){const c=n.substring(s+5,r);e.push({text:c,format:"subscript"}),s=r+6;continue}}if(n[s]==="^"&&!a){i&&(e.push({text:i,format:"normal"}),i=""),a=!0,s++;continue}if(a&&n[s]===" "){i&&(e.push({text:i,format:"superscript"}),i=""),a=!1,e.push({text:" ",format:"normal"}),s++;continue}i+=n[s],s++}return i&&e.push({text:i,format:a?"superscript":"normal"}),e}function vw(n,e,s,i,a){const c=[{x:e,y:s},{x:e+i/2,y:s},{x:e+i,y:s},{x:e+i,y:s+a/2},{x:e+i,y:s+a},{x:e+i/2,y:s+a},{x:e,y:s+a},{x:e,y:s+a/2}];n.save(),c.forEach(h=>{n.fillStyle="#4a90e2",n.strokeStyle="#ffffff",n.lineWidth=2,n.fillRect(h.x-8/2,h.y-8/2,8,8),n.strokeRect(h.x-8/2,h.y-8/2,8,8)}),n.restore()}function yw(n,e,s){const{startCol:i,startRow:a,endCol:r,endRow:c}=e,h=mt(i,s),m=Rt(a,s),f=mt(r,s),g=Rt(c,s),b=Math.min(h,f),w=Math.min(m,g),x=Math.abs(f-h),A=Math.abs(g-m);n.save(),n.strokeStyle="rgba(74, 144, 226, 0.6)",n.lineWidth=2,n.setLineDash([5,5]),n.strokeRect(b,w,x,A),n.restore()}function pr(n,e,s,i){const{path:a,settings:r}=e;if(!a||a.length<2)return;const c=a.map(h=>({x:mt(h.col,i),y:Rt(h.row,i)}));n.save(),s&&(n.globalAlpha=.3),n.strokeStyle=r.color,n.lineWidth=typeof r.size=="number"?r.size:hh(r.size),n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(c[0].x,c[0].y);for(let h=1;h<c.length;h++)n.lineTo(c[h].x,c[h].y);n.stroke(),n.restore()}function hh(n){if(typeof n=="number")return n;switch(n){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function bw(n){switch(n){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function ww(n,e){if(!(!e.path||e.path.length<2)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([5,5]),n.globalAlpha=.7,n.beginPath(),n.moveTo(e.path[0].x,e.path[0].y);for(let s=1;s<e.path.length;s++)n.lineTo(e.path[s].x,e.path[s].y);e.path.length>2&&n.lineTo(e.path[0].x,e.path[0].y),n.stroke(),n.restore()}}function _w(n,e){if(!(!e||e.length<3)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([8,4]),n.globalAlpha=.8,n.beginPath(),n.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)n.lineTo(e[s].x,e[s].y);n.closePath(),n.stroke(),n.fillStyle="rgba(74, 144, 226, 0.1)",n.fill(),n.restore()}}function tm(n,e){const s={...e,...u.state};s.modulationMarkers&&s.modulationMarkers.length>0,n.clearRect(0,0,n.canvas.width,n.canvas.height);const{startRow:i,endRow:a}=N0();jb(n,s,i,a),zb(n,s,i,a),Wb(n,s);const r=e.placedNotes.filter(h=>!h.isDrum&&h.row>=i&&h.row<=a),c=e.placedTonicSigns.filter(h=>h.row>=i&&h.row<=a);r.forEach(h=>{h.shape==="oval"?Rh(n,s,h,h.row):h.shape==="circle"&&Ih(n,s,h,h.row)}),c.forEach(h=>{Dh(n,s,h)}),Xb(n,s),Kb(n,s),Kp(n,s),dw(n,s)}const em={getTimeSignatureSegments(){const n=[];let e=u.state.hasAnacrusis,s=cs(u.state,0).startColumn,i=0,a=!1;return u.state.macrobeatGroupings.forEach((r,c)=>{i+=r,r===3&&(a=!0);const h=c===u.state.macrobeatGroupings.length-1,f=u.state.macrobeatBoundaryStyles[c]==="solid";if(f||h){const g=cs(u.state,c).endColumn+1,b=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;let w,x;if(b){const P={...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth};w=mt(s,P),x=mt(g,P)}else w=xt.getColumnX(s),x=xt.getColumnX(g);const A=a?`${i}/8`:`${i/2}/4`;n.push({label:A,centerX:(w+x)/2,startX:w,endX:x,isAnacrusis:e}),h||(s=g,i=0,a=!1,f&&(e=!1))}}),n},getRhythmUIButtons(){const n=[],e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,s=e?{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}:null;return u.state.macrobeatGroupings.forEach((i,a)=>{const{startColumn:r,endColumn:c}=cs(u.state,a),h=e?mt(r,s):xt.getColumnX(r),m=e?mt(c+1,s):xt.getColumnX(c+1),f=(h+m)/2;if(n.push({type:"grouping",content:i,x:f,y:20,index:a}),a<u.state.macrobeatGroupings.length-1){const g=u.state.macrobeatBoundaryStyles[a];let b;switch(g){case"solid":b="●";break;case"anacrusis":b="x";break;default:b="○";break}n.push({type:"boundary",content:b,x:m,y:35,index:a})}}),n}};function xw(){const n=document.getElementById("beat-line-button-layer");if(!n)return;n.innerHTML="";const e=document.getElementById("notation-grid");if(!e)return;const s=e.getBoundingClientRect(),i=n.getBoundingClientRect(),a=s.left-i.left;em.getRhythmUIButtons().forEach((c,h)=>{const m=document.createElement("button");m.type="button",m.textContent=c.content,m.className="rhythm-ui-button",m.dataset.type=c.type,m.classList.add(`rhythm-ui-button--${c.type}`),m.style.position="absolute";const f=a+c.x;m.style.left=`${f}px`,m.style.top=`${c.y}px`,m.style.transform="translateX(-50%)",c.type==="grouping"?m.addEventListener("click",()=>u.toggleMacrobeatGrouping(c.index)):m.addEventListener("click",()=>u.cycleMacrobeatBoundaryStyle(c.index)),n.appendChild(m)})}const Sw={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const n=this.getTimeSignatureOptions();let e='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(n).forEach(([s,i])=>{e+='<div class="dropdown-category">',e+=`<div class="dropdown-category-header">${s}</div>`,i.forEach((a,r)=>{const c=`${s}-${r}`;e+=`<div class="dropdown-option" data-groupings="${JSON.stringify(a.groupings)}" data-key="${c}">`,e+=`<span class="dropdown-label">${a.label}</span>`,e+=`<span class="dropdown-description">${a.description}</span>`,e+="</div>"}),e+="</div>"}),e+="</div>",e},getTimeSignatureLabel(n){const e=n.reduce((i,a)=>i+a,0);return n.includes(3)?`${e}/8`:`${e/2}/4`}};let Xi=null;function Cw(){const n=document.getElementById("beat-line-button-layer");if(!n)return;n.querySelectorAll(".time-signature-label").forEach(h=>h.remove());const s=document.getElementById("notation-grid");if(!s)return;const i=s.getBoundingClientRect(),a=n.getBoundingClientRect(),r=i.left-a.left;em.getTimeSignatureSegments().forEach((h,m)=>{const f=document.createElement("div");f.className="time-signature-label",h.isAnacrusis&&f.classList.add("anacrusis-label"),f.textContent=h.label,f.style.position="absolute",f.style.left=`${r+h.centerX}px`,f.style.transform="translateX(-50%)",f.addEventListener("click",g=>{g.stopPropagation(),Aw(f,m)}),n.appendChild(f)}),Tw()}function Tw(){if(!document.getElementById("time-signature-dropdown")){const n=Sw.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",n),document.getElementById("time-signature-dropdown").addEventListener("click",Ew)}}function Aw(n,e){const s=document.getElementById("time-signature-dropdown");if(!s)return;s.dataset.measureIndex=e;const i=n.getBoundingClientRect();s.style.left=`${i.left}px`,s.style.top=`${i.bottom+5}px`;const a=s.getBoundingClientRect(),r=window.innerWidth,c=window.innerHeight;i.left+a.width>r&&(s.style.left=`${r-a.width-10}px`),i.bottom+a.height>c&&(s.style.top=`${i.top-a.height-5}px`),s.classList.remove("hidden"),Xi={dropdown:s,measureIndex:e},setTimeout(()=>{document.addEventListener("click",Mw,{once:!0})},0)}function Mw(n){const e=document.getElementById("time-signature-dropdown");e&&!e.contains(n.target)&&(e.classList.add("hidden"),Xi=null)}function Ew(n){const e=n.target.closest(".dropdown-option");if(!e)return;const s=e.dataset.groupings,i=parseInt(Xi==null?void 0:Xi.measureIndex,10);if(!(!s||Number.isNaN(i)))try{const a=JSON.parse(s);u.updateTimeSignature(i,a),document.getElementById("time-signature-dropdown").classList.add("hidden"),Xi=null}catch{}}T.moduleLoaded("PitchGridController","grid");function Pw(){const n=Ph.getPitchContext();if(!n||!n.canvas){T.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const e={placedNotes:Xy(u.state),placedTonicSigns:an(u.state),fullRowData:u.state.fullRowData,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,rowHeight:u.state.cellHeight*.5,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,colorMode:"color",degreeDisplayMode:u.state.degreeDisplayMode,zoomLevel:xt.getViewportInfo().zoomLevel,viewportHeight:n.canvas.height};tm(n,e)}const Yi={render(){Pw()},renderMacrobeatTools(){xw(),Cw()}};let mr=null;const kw=()=>(mr||(mr=new Image,mr.src="/assets/icons/Volume.svg"),mr);function Ln(n,e){return e.modulationMarkers&&e.modulationMarkers.length>0?mt(n,e):xt.getColumnX(n)}function sm(n,e,s,i,a,r,c=1){const h=s+a/2,m=i+r/2,f=Math.min(a,r)*.4*c;if(n.beginPath(),e===0)n.moveTo(h,m-f),n.lineTo(h-f,m+f),n.lineTo(h+f,m+f),n.closePath();else if(e===1)n.moveTo(h,m-f),n.lineTo(h+f,m),n.lineTo(h,m+f),n.lineTo(h-f,m),n.closePath();else{for(let b=0;b<5;b++){const w=2*Math.PI/5*b-Math.PI/2,x=h+f*Math.cos(w),A=m+f*Math.sin(w);b===0?n.moveTo(x,A):n.lineTo(x,A)}n.closePath()}n.fill()}function Iw(n,e,s,i,a="normal"){const r=kw();if(a!=="normal"){const c=i*1.3;n.beginPath(),n.arc(e,s,c/2,0,Math.PI*2),a==="hover"?n.fillStyle="rgba(74, 144, 226, 0.2)":a==="active"&&(n.fillStyle="rgba(74, 144, 226, 0.4)"),n.fill()}if(r.complete&&r.naturalWidth>0)a==="hover"?n.filter="brightness(1.2)":a==="active"&&(n.filter="brightness(0.8)"),n.drawImage(r,e-i/2,s-i/2,i,i),n.filter="none";else{let c="#6c757d",h="#6c757d";a==="hover"?(c="#4a90e2",h="#4a90e2"):a==="active"&&(c="#357abd",h="#357abd"),n.fillStyle=c,n.strokeStyle=h,n.lineWidth=1;const m=i*.4,f=i*.6,g=i*.3;n.fillRect(e-m/2,s-f/2,m,f),n.beginPath(),n.moveTo(e+m/2,s-f/3),n.lineTo(e+m/2+g,s-f/2),n.lineTo(e+m/2+g,s+f/2),n.lineTo(e+m/2,s+f/3),n.closePath(),n.fill();for(let b=1;b<=2;b++)n.beginPath(),n.arc(e+m/2+g+i*.1,s,i*.2*b,-Math.PI/4,Math.PI/4,!1),n.stroke()}}function Rw(n,e){const{columnWidths:s,macrobeatGroupings:i,macrobeatBoundaryStyles:a,placedTonicSigns:r}=e,c=s.length-2;let h=[],m=2;for(let f=0;f<i.length;f++){for(;r.some(g=>g.columnIndex===m);)m+=2;m+=i[f],h.push(m)}for(let f=0;f<=c;f++){const g=Ln(f,e);if(g<0||g>n.canvas.width)continue;let b;const w=f===2||f===c,x=Zp(f,r),A=r.some(I=>f===I.columnIndex+2),P=h.includes(f);if(Qp(f,r)){if(w||x||A)b={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(P){const I=h.indexOf(f);if(I!==-1){const D=a[I];if(D==="anacrusis")continue;b={lineWidth:1,strokeStyle:"#adb5bd",dash:D==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(g,0),n.lineTo(g,n.canvas.height),n.lineWidth=b.lineWidth,n.strokeStyle=b.strokeStyle,n.setLineDash(b.dash),n.stroke()}}n.setLineDash([])}function nm(n,e){const{placedNotes:s,columnWidths:i,cellWidth:a,cellHeight:r,placedTonicSigns:c}=e;n.clearRect(0,0,n.canvas.width,n.canvas.height);const h=n.canvas;h.getBoundingClientRect(),window.getComputedStyle(h);const m=Math.max(Ca,Ta*r),f=i.length,g=["H","M","L"];n.font=`${Math.floor(m*.7)}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#6c757d";const b=Ln(1,e)+Ln(1,e)*.3;g.forEach((M,I)=>{n.fillText(M,b,I*m+m/2)});const w=Ln(1,e)-Ln(1,e)*.3,x=3*m/2,A=e.volumeIconState||"normal";Iw(n,w,x,m*.6,A);const P=Ln(2,e);for(let M=0;M<4;M++){const I=M*m;n.beginPath(),n.moveTo(P,I),n.lineTo(n.canvas.width,I),n.strokeStyle="#ced4da",n.lineWidth=1,n.stroke()}Rw(n,e);for(let M=2;M<f-2;M++){if(c.some(R=>R.columnIndex===M))continue;const I=Ln(M,e);let D;e.modulationMarkers&&e.modulationMarkers.length>0?D=Ln(M+1,e)-I:D=i[M]*a;for(let R=0;R<3;R++){const H=R*m,j=g[R],F=s.find(Y=>Y.isDrum&&Y.drumTrack===j&&Y.startColumnIndex===M);if(F){n.fillStyle=F.color;const Y=Wn.getAnimationScale(M,j);sm(n,R,I,H,D,m,Y)}else n.fillStyle="#ced4da",n.beginPath(),n.arc(I+D/2,H+m/2,2,0,Math.PI*2),n.fill()}}Kp(n,e)}const Hs={getColumnIndex(n){const{columnWidths:e,cellWidth:s,modulationMarkers:i}=u.state;if(s===0)return 0;if(i&&i.length>0){const r={...u.state,modulationMarkers:i,cellWidth:s,columnWidths:e,baseMicrobeatPx:s};for(let c=0;c<e.length;c++){const h=mt(c+1,r);if(n<h)return c}}else{let r=0;for(let c=0;c<e.length;c++)if(r+=e[c]*s,n<r)return c}return e.length-1},getPitchRowIndex(n){const e=xt.getViewportInfo();if(!e||!e.halfUnit||e.halfUnit===0)return-1;const s=Math.floor(n/e.halfUnit);return e.startRank+s},getDrumRowIndex(n){const e=Math.max(Ca,Ta*u.state.cellHeight);return e===0?-1:Math.floor(n/e)}};let pe,Lr=!1,wa=!1,Tr=1,vn=null,wn="normal",jd=0;const Dw=500;function lo(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return mt(n,s)}else return xt.getColumnX(n)}function im(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s=lo(n);return lo(n+1)-s}else return u.state.columnWidths[n]*u.state.cellWidth}function uh(n,e,s){if(!pe)return;const i=lo(n),a=Math.max(Ca,Ta*u.state.cellHeight),r=e*a,c=im(n);pe.fillStyle=s,pe.fillRect(i,r,c,a)}function Ow(n,e){if(!pe)return;const s=lo(n),i=Math.max(Ca,Ta*u.state.cellHeight),a=e*i,r=im(n),c=["H","M","L"][e],h=Wn.getAnimationScale(n,c);pe.globalAlpha=.4,pe.fillStyle=u.state.selectedTool.color||"#212529",sm(pe,e,s,a,r,i,h),pe.globalAlpha=1}function Nw(n){const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,a=lo(2),r=s<a,c=wn;if(wn=r?"hover":"normal",c!==wn&&window.drumGridRenderer&&window.drumGridRenderer.render(),r){pe&&pe.clearRect(0,0,pe.canvas.width,pe.canvas.height);return}const h=document.getElementById("canvas-container").scrollLeft,m=Hs.getColumnIndex(s+h),f=Hs.getDrumRowIndex(i);if(!pe||m<2||m>=u.state.columnWidths.length-2||f<0||f>2){Bh();return}pe.clearRect(0,0,pe.canvas.width,pe.canvas.height);const g=["H","M","L"][f];Lr?(u.eraseDrumNoteAt(m,g,!1)&&(wa=!0),uh(m,f,"rgba(220, 53, 69, 0.3)")):(uh(m,f,"rgba(74, 144, 226, 0.2)"),Ow(m,f))}function Bh(){pe&&pe.clearRect(0,0,pe.canvas.width,pe.canvas.height),wn!=="normal"&&(wn="normal",window.drumGridRenderer&&window.drumGridRenderer.render())}function Lw(n){var f;n.preventDefault();const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,a=lo(2);if(s<a){wn="active",window.drumGridRenderer&&window.drumGridRenderer.render();const g=document.querySelector(".drum-volume-control");if(g){const b=g.style.display==="flex";g.style.display=b?"none":"flex"}return}const r=document.getElementById("canvas-container").scrollLeft,c=Hs.getColumnIndex(s+r);if(c<2||c>=u.state.columnWidths.length-2)return;const h=Hs.getDrumRowIndex(i);if(h<0||h>2)return;const m=["H","M","L"][h];if(n.button===2){Lr=!0,wa=!1,(f=document.getElementById("eraser-tool-button"))==null||f.classList.add("erasing-active"),u.eraseDrumNoteAt(c,m,!1)&&(wa=!0),pe.clearRect(0,0,pe.canvas.width,pe.canvas.height),uh(c,h,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const{color:g}=u.state.selectedTool,b={isDrum:!0,drumTrack:m,startColumnIndex:c,endColumnIndex:c,color:g||"#000000",shape:m==="H"?"triangle":m==="M"?"square":"pentagon"};u.toggleDrumNote(b),window.transportService&&window.transportService.drumPlayers&&(window.transportService.drumPlayers.player(m).start(),Wn.triggerNotePop(c,m))}}function Fw(){var n;Lr&&(wa&&u.recordState(),Lr=!1,wa=!1,(n=document.getElementById("eraser-tool-button"))==null||n.classList.remove("erasing-active")),wn==="active"&&(wn="normal",window.drumGridRenderer&&window.drumGridRenderer.render()),Bh()}function Bw(){const n=document.getElementById("drum-grid-wrapper");if(!n)return;const e=document.createElement("div");e.className="drum-volume-control",e.style.cssText=`
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        display: none;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 10;
    `,vn=document.createElement("input"),vn.type="range",vn.min="0",vn.max="100",vn.value="100",vn.className="drum-volume-slider",vn.style.cssText="width: 80px; margin: 0;",vn.addEventListener("input",a=>{if(Tr=a.target.value/100,window.drumVolumeNode){const r=Tr===0?-60:20*Math.log10(Tr);window.drumVolumeNode.volume.value=r;const c=Date.now();window.transportService&&window.transportService.drumPlayers&&c-jd>=Dw&&(window.transportService.drumPlayers.player("M").start("+0.1"),jd=c)}}),e.appendChild(vn),n.appendChild(e);const s=()=>{e.style.display="flex"},i=()=>{e.style.display="none"};n.addEventListener("mouseenter",a=>{const r=n.getBoundingClientRect();a.clientX-r.left<60&&s()}),e.addEventListener("mouseenter",s),e.addEventListener("mouseleave",i),n.addEventListener("mouseleave",i)}function $w(){return Tr}function qw(){return wn}window.getDrumVolume=$w;function zw(){const n=document.getElementById("drum-grid"),e=document.getElementById("drum-hover-canvas");!n||!e||(pe=e.getContext("2d"),n.addEventListener("mousedown",Lw),n.addEventListener("mousemove",Nw),n.addEventListener("mouseleave",Bh),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",Fw),Bw())}function Ud(){const n=Ph.getDrumContext();if(!n||!n.canvas)return;const e={placedNotes:Yy(u.state),placedTonicSigns:an(u.state),columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth,volumeIconState:qw()};nm(n,e)}const Es={animationFrameId:null,render(){Ud(),Wn.hasActiveAnimations()?Es.animationFrameId||Es.startAnimationLoop():Es.stopAnimationLoop()},startAnimationLoop(){if(Es.animationFrameId)return;const n=()=>{Wn.cleanupAnimations(),Ud(),Wn.hasActiveAnimations()?Es.animationFrameId=requestAnimationFrame(n):Es.animationFrameId=null};Es.animationFrameId=requestAnimationFrame(n)},stopAnimationLoop(){Es.animationFrameId&&(cancelAnimationFrame(Es.animationFrameId),Es.animationFrameId=null)}};window.drumGridRenderer=Es;T.moduleLoaded("RhythmPlaybackService");class Ww{constructor(){this.scheduledEvents=[],this.isInitialized=!1}async initialize(){this.isInitialized||(await Q.start(),this.isInitialized=!0,T.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(e,s,i,a="oval",r=null){if(!this.isInitialized){T.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const c=Lp(e,r);if(!c||c.length===0){T.warn("RhythmPlaybackService",`No events found for stamp ${e}`);return}T.debug("RhythmPlaybackService",`Playing pattern for stamp ${e}: ${c.length} notes`,{stampId:e,basePitch:s,color:i,events:c,hasShapeOffsets:!!(r!=null&&r.shapeOffsets)});const h=Q.now(),m=r==null?void 0:r.row;c.forEach((f,g)=>{try{const b=Q.Time(f.offset).toSeconds(),w=h+b;let x=Q.Time(f.duration).toSeconds();const A=a==="circle"?x*2:x,P=w+A;let M=s;if(m!==void 0&&f.rowOffset!==0){const I=m+f.rowOffset,D=u.state.fullRowData[I];D&&(M=D.toneNote.replace("♭","b").replace("♯","#"))}Gt.triggerAttack(M,i,w),Gt.triggerRelease(M,i,P),this.scheduledEvents.push({pitch:M,color:i,attackTime:w,releaseTime:P})}catch(b){T.warn("RhythmPlaybackService",`Error scheduling note ${g+1}`,b)}}),T.info("RhythmPlaybackService",`Scheduled ${c.length} notes for rhythm pattern ${e}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(T.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),Gt.releaseAll(),this.scheduledEvents=[])}getStampAtPosition(e,s){return u.state.stampPlacements&&u.state.stampPlacements.find(a=>{const r=a.row===s,c=e>=a.startColumn&&e<=a.endColumn;return r&&c})||null}playTripletPattern(e,s,i,a=null){if(!this.isInitialized){T.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}ga(()=>Promise.resolve().then(()=>J0),void 0).then(r=>{const{getTripletScheduleEvents:c}=r;this.stopCurrentPattern();const h=c(e,a);if(!h||h.length===0){T.warn("RhythmPlaybackService",`No events found for triplet ${e}`);return}T.debug("RhythmPlaybackService",`Playing triplet pattern ${e}: ${h.length} notes`,{tripletStampId:e,basePitch:s,color:i,events:h,hasShapeOffsets:!!(a!=null&&a.shapeOffsets)});const m=Q.now(),f=a==null?void 0:a.row;h.forEach((g,b)=>{try{const w=Q.Time(g.offset).toSeconds(),x=m+w,A=Q.Time(g.duration).toSeconds(),P=x+A;let M=s;if(f!==void 0&&g.rowOffset!==0){const I=f+g.rowOffset,D=u.state.fullRowData[I];D&&(M=D.toneNote.replace("♭","b").replace("♯","#"))}Gt.triggerAttack(M,i,x),Gt.triggerRelease(M,i,P),this.scheduledEvents.push({pitch:M,color:i,attackTime:x,releaseTime:P})}catch(w){T.warn("RhythmPlaybackService",`Error scheduling triplet note ${b+1}`,w)}}),T.info("RhythmPlaybackService",`Scheduled ${h.length} notes for triplet pattern ${e}`)})}getTripletAtPosition(e,s){return u.state.tripletPlacements&&u.state.tripletPlacements.find(i=>i.row===s&&e>=i.startCellIndex&&e<i.startCellIndex+i.span)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,T.info("RhythmPlaybackService","Disposed")}}const en=new Ww;T.moduleLoaded("StampsToolbar","stamps");const $h={selectedStampId:1,init(){this.render(),this.bindEvents(),T.info("StampsToolbar","Stamps toolbar initialized",null,"stamps")},render(){const n=document.getElementById("stamps-toolbar-container");if(!n){T.warn("StampsToolbar","Container not found",null,"stamps");return}n.innerHTML="";const e=document.createElement("div");e.className="stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((i,a)=>{const r=document.createElement("div");r.className=`stamps-row stamps-row-${a+1}`,i.forEach(c=>{const h=eh.find(m=>m.id===c);if(h){const m=this.createStampButton(h,c-1);r.appendChild(m)}}),e.appendChild(r)}),n.appendChild(e),this.setInitialSelection(this.selectedStampId)},createStampButton(n,e){const s=document.createElement("button");s.className="stamp-button",s.setAttribute("data-stamp-id",n.id),s.setAttribute("title",`${n.id}: ${n.label}`);const i=this.createStampPreview(n);return s.appendChild(i),s},createStampPreview(n){const e=Fh.renderToSVG(n,100,100);return e.setAttribute("width","40"),e.setAttribute("height","40"),e},bindEvents(){const n=document.getElementById("stamps-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const i=s.target.closest(".stamp-button");if(i){const a=parseInt(i.getAttribute("data-stamp-id"));this.selectStamp(a)}}),this.updateStampColors=s=>{if(!s||!n)return;const i=(f,g=50)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(b+(255-b)*(g/100))),P=Math.min(255,Math.floor(w+(255-w)*(g/100))),M=Math.min(255,Math.floor(x+(255-x)*(g/100)));return`#${A.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},a=(f,g=20)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(b*(1-g/100))),P=Math.max(0,Math.floor(w*(1-g/100))),M=Math.max(0,Math.floor(x*(1-g/100)));return`#${A.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},r=u.state.colorPalette[s]||{primary:s,light:s},c=i(r.light,60),h=r.primary,m=a(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),T.info("StampsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"stamps")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateStampColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateStampColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="stamp"&&this.clearSelection()}),u.on("tripletToolSelected",()=>{this.clearSelection()})},setInitialSelection(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),T.info("StampsToolbar",`Initial stamp selection set to ${n} (no tool change during init)`,{stampId:n},"stamps")},selectStamp(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),console.log("🛠️ [STAMPS] Selecting stamp tool via proper action"),u.setSelectedTool("stamp"),u.emit("stampSelected",n),u.emit("stampToolSelected"),T.info("StampsToolbar",`Selected stamp ${n} and switched to stamp tool`,{stampId:n},"stamps")},clearSelection(){this.selectedStampId=null;const n=document.getElementById("stamps-toolbar-container");n&&n.querySelectorAll(".stamp-button").forEach(e=>{e.classList.remove("active")})},getSelectedStamp(){return eh.find(n=>n.id===this.selectedStampId)}};T.moduleLoaded("TripletsToolbar","triplets");const jr={selectedTripletStampId:null,init(){this.render(),this.bindEvents(),T.info("TripletsToolbar","Triplets toolbar initialized",null,"triplets")},render(){const n=document.getElementById("triplets-toolbar-container");if(!n){T.warn("TripletsToolbar","Container not found",null,"triplets");return}n.innerHTML="";const e=document.createElement("div");e.className="triplets-main-container";const s=document.createElement("div");s.className="triplets-sections";const i=this.createSection("Eighth Triplets",sh.slice(0,7));s.appendChild(i);const a=this.createQuarterTripletsSection(sh.slice(7,14));s.appendChild(a),e.appendChild(s),n.appendChild(e)},createSection(n,e){const s=document.createElement("div");s.className="triplets-section";const i=document.createElement("div");return i.className="triplets-grid",e.forEach(a=>{const r=this.createTripletButton(a);i.appendChild(r)}),s.appendChild(i),s},createQuarterTripletsSection(n){const e=document.createElement("div");e.className="triplets-section";const s=document.createElement("div");s.className="triplets-grid triplets-quarter-row",[n[0],n[1],n[2]].forEach(a=>{const r=this.createTripletButton(a);s.appendChild(r)});const i=document.createElement("div");return i.className="triplets-grid triplets-quarter-row",[n[3],n[4],n[5],n[6]].forEach(a=>{const r=this.createTripletButton(a);i.appendChild(r)}),e.appendChild(s),e.appendChild(i),e},createTripletButton(n){const e=document.createElement("button");e.className="triplet-button",e.setAttribute("data-triplet-stamp-id",n.id),e.setAttribute("title",n.label),n.span==="quarter"&&e.classList.add("triplet-button-wide");const i=n.span==="quarter"?80:40,a=Jb(n,i,40);return e.appendChild(a),e},bindEvents(){const n=document.getElementById("triplets-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const i=s.target.closest(".triplet-button");if(i){const a=parseInt(i.getAttribute("data-triplet-stamp-id"));this.selectTripletStamp(a)}}),this.updateTripletColors=s=>{if(!s||!n)return;const i=(f,g=50)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(b+(255-b)*(g/100))),P=Math.min(255,Math.floor(w+(255-w)*(g/100))),M=Math.min(255,Math.floor(x+(255-x)*(g/100)));return`#${A.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},a=(f,g=20)=>{const b=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),x=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(b*(1-g/100))),P=Math.max(0,Math.floor(w*(1-g/100))),M=Math.max(0,Math.floor(x*(1-g/100)));return`#${A.toString(16).padStart(2,"0")}${P.toString(16).padStart(2,"0")}${M.toString(16).padStart(2,"0")}`},r=u.state.colorPalette[s]||{primary:s,light:s},c=i(r.light,60),h=r.primary,m=a(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),T.info("TripletsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"triplets")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateTripletColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateTripletColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="triplet"&&this.clearSelection()}),u.on("stampToolSelected",()=>{this.clearSelection()})},selectTripletStamp(n){this.selectedTripletStampId=n;const e=document.getElementById("triplets-toolbar-container");e&&e.querySelectorAll(".triplet-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-triplet-stamp-id"))===n)}),u.setSelectedTool("triplet"),u.emit("tripletStampSelected",n),u.emit("tripletToolSelected"),T.info("TripletsToolbar",`Selected triplet stamp ${n} and switched to triplet tool`,{stampId:n},"triplets")},clearSelection(){this.selectedTripletStampId=null;const n=document.getElementById("triplets-toolbar-container");n&&n.querySelectorAll(".triplet-button").forEach(e=>{e.classList.remove("active")})},getSelectedTripletStamp(){return this.selectedTripletStampId?ai(this.selectedTripletStampId):null}};function Vw(n,e,s,i){var g,b;const a=Hr(s.stampId);if(!a)return console.log("[STAMP HIT TEST] No stamp found for stampId:",s.stampId),null;const r=mt(s.startColumn,i),c=Rt(s.row,i)-i.cellHeight/2,h=i.cellWidth*2,m=i.cellHeight;console.log("[STAMP HIT TEST] Testing position:",{mouseX:n,mouseY:e,stampBounds:{x:r,y:c,width:h,height:m},stampId:s.stampId});const f=[.125,.375,.625,.875].map(w=>r+w*h);for(const w of a.diamonds){const x=`diamond_${w}`,A=((g=s.shapeOffsets)==null?void 0:g[x])||0,P=s.row+A,M=Rt(P,i),I=f[w],D=Math.sqrt(Math.pow(n-I,2)+Math.pow(e-M,2)),R=Math.min(h*.2,m*1);if(console.log(`[STAMP HIT TEST] Testing diamond slot ${w}:`,{cx:I,cy:M,distance:D,hitRadius:R,isHit:D<R}),D<R)return console.log("[STAMP HIT TEST] ✓ Hit diamond:",{slot:w,shapeKey:x,rowOffset:A}),{type:"diamond",slot:w,shapeKey:x,cx:I,cy:M,placement:s}}for(const w of a.ovals){const x=`oval_${w}`,A=((b=s.shapeOffsets)==null?void 0:b[x])||0,P=s.row+A,M=Rt(P,i),I=w===0?r+.25*h:r+.75*h,D=Math.sqrt(Math.pow(n-I,2)+Math.pow(e-M,2)),R=Math.min(h*.25,m*1);if(console.log(`[STAMP HIT TEST] Testing oval slot ${w}:`,{cx:I,cy:M,distance:D,hitRadius:R,isHit:D<R}),D<R)return console.log("[STAMP HIT TEST] ✓ Hit oval:",{slot:w,shapeKey:x,rowOffset:A}),{type:"oval",slot:w,shapeKey:x,cx:I,cy:M,placement:s}}return console.log("[STAMP HIT TEST] No shape hit"),null}function om(n,e,s,i){console.log("[STAMP HIT TEST] Testing against",s.length,"stamp placements");for(const a of s){const r=Vw(n,e,a,i);if(r)return r}return null}function Hw(n,e,s,i){var g;const a=ai(s.stampId);if(!a)return console.log("[TRIPLET HIT TEST] No stamp found for stampId:",s.stampId),null;const r=s.startCellIndex*2,c=mt(r,i),h=Rt(s.row,i)-i.cellHeight/2,m=i.cellWidth*2*s.span,f=i.cellHeight;console.log("[TRIPLET HIT TEST] Testing position:",{mouseX:n,mouseY:e,groupBounds:{x:c,y:h,width:m,height:f},stampId:s.stampId});for(const b of a.hits){const w=`triplet_${b}`,x=((g=s.shapeOffsets)==null?void 0:g[w])||0,A=s.row+x,P=Rt(A,i),M=Bp[b],I=c+m*M/100,D=Math.sqrt(Math.pow(n-I,2)+Math.pow(e-P,2)),R=Math.min(m*.15,f*1);if(console.log(`[TRIPLET HIT TEST] Testing slot ${b}:`,{cx:I,cy:P,distance:D,hitRadius:R,isHit:D<R}),D<R)return console.log("[TRIPLET HIT TEST] ✓ Hit triplet notehead:",{slot:b,shapeKey:w,rowOffset:x}),{type:"triplet",slot:b,shapeKey:w,cx:I,cy:P,placement:s}}return console.log("[TRIPLET HIT TEST] No shape hit"),null}function am(n,e,s,i){console.log("[TRIPLET HIT TEST] Testing against",s.length,"triplet placements");for(const a of s){const r=Hw(n,e,a,i);if(r)return r}return null}let Xt,to=!1,ne=null,Ws=[],Xe=[],_a=!1,Fr=!1,Ar=null,qn=null,si=[],ws=!1,$n=null,ss=null,xa=!1,bs=null,Sa=!1;function Ge(n){const e=u.state.fullRowData[n];return e?e.toneNote:null}function Gw(n){const{macrobeatGroupings:e,columnWidths:s,macrobeatBoundaryStyles:i}=u.state;if(n<2||n>=s.length-2)return null;let a=-1;for(let m=0;m<e.length;m++){const{startColumn:f,endColumn:g}=cs(u.state,m);if(n>=f&&n<=g){a=m;break}}if(a===-1)return null;let r=0;for(let m=a-1;m>=0;m--)if(i[m]==="solid"){r=m+1;break}const c=r-1;return{drawColumn:cs(u.state,r).startColumn,preMacrobeatIndex:c}}function rm(n,e){const{activeChordIntervals:s,isIntervalsInverted:i,chordPositionState:a}=u.state;if(!n||!s||s.length===0)return[];if(i&&s.length===2&&s[0]==="1P"){const h="-"+s[1],m=ia(n,h),f=oa(m),g=f.includes("#")&&bn(f).includes("b")?bn(f):f;return[n,g]}const r=s.map(c=>{const h=ia(n,c),m=oa(h);if(m.includes("#")){const f=bn(m);if(f.includes("b"))return f}return m});if(s.length>=3&&a>0){const c=[...r];for(let x=0;x<a;x++){const A=c.shift(),P=ia(A,"8P");c.push(oa(P))}const h=c[0],m=n,f=nn(h),g=nn(m);let b=0,w=f;for(;w>g;)w-=12,b-=12;for(;w+12<=g;)w+=12,b+=12;return c.map(x=>{const A=nn(x)+b;return ky(A)})}return r}function Mr(n,e,s){if(!Xt)return;const i={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel},a=mt(n,i),c=Rt(e,u.state)-u.state.cellHeight/2,h=u.state.selectedTool;let m;if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=mt(n+1,i)-a:m=u.state.columnWidths[n]*u.state.cellWidth,h==="eraser"||_a)u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=mt(n+2,i)-a:m=u.state.cellWidth*2;else if(h==="note"&&u.state.selectedNote&&u.state.selectedNote.shape==="circle")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=mt(n+2,i)-a:m=u.state.cellWidth*2;else if(h==="stamp")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=mt(n+2,i)-a:m=u.state.cellWidth*2;else if(h==="triplet"){const f=jr.getSelectedTripletStamp();if(f){const b=2*(f.span==="eighth"?1:2);u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=mt(n+b,i)-a:m=u.state.cellWidth*b}else m=u.state.cellWidth*2}else h==="tonicization"&&(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=mt(n+2,i)-a:m=u.state.cellWidth*2);Xt.fillStyle=s,Xt.fillRect(a,c,m,u.state.cellHeight)}function jw(n,e,s=!1){if(!Xt||!u.state.selectedNote)return;const i=u.state.selectedTool,{shape:a,color:r}=u.state.selectedNote;if(Xt.globalAlpha=s?.2:.4,i==="tonicization"){const c={row:e,columnIndex:n,tonicNumber:u.state.selectedToolTonicNumber},h={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};Dh(Xt,h,c)}else if(i==="note"){const c={row:e,startColumnIndex:n,endColumnIndex:n,color:r,shape:a,isDrum:!1},h={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};a==="oval"?Rh(Xt,h,c,e):Ih(Xt,h,c,e)}Xt.globalAlpha=1}function Uw(n){var f,g,b,w,x,A,P;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,a=document.getElementById("canvas-container").scrollLeft,r=Hs.getColumnIndex(s+a),c=Hs.getPitchRowIndex(i),m=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(!(r<2||r>=m||!Ge(c))){if(n.button===2){n.preventDefault(),_a=!0,ws=!1,u.state.selectedTool!=="eraser"&&(Ar=u.state.selectedTool,u.setSelectedTool("eraser")),(f=oi.get("eraserButton"))==null||f.classList.add("erasing-active"),u.eraseInPitchArea(r,c,2,!1)&&(ws=!0),u.eraseTonicSignAt(r,!1)&&(ws=!0);const M=r+2-1,I=c-1,D=c+1;u.eraseStampsInArea(r,M,I,D)&&(ws=!0),u.eraseTripletsInArea(r,M,I,D)&&(ws=!0);const R=n.target.getBoundingClientRect(),H=n.clientX-R.left,j=n.clientY-R.top;Ut.eraseAtPoint(H,j)&&(ws=!0),Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),Mr(r,c,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const M=s+a;({...u.state});for(const R of u.state.modulationMarkers||[]);const I=u.state.placedNotes.find(R=>!R.isDrum&&R.row===c&&r>=R.startColumnIndex&&r<=R.endColumnIndex);if(I&&u.state.selectedTool==="note"){const R=en.getStampAtPosition(r,c),H=Ge(c);if(R&&H){const j=window.staticWaveformVisualizer;j&&(j.currentColor=I.color,j.generateWaveform(),j.startSingleNoteVisualization(I.color)),en.playRhythmPattern(R.stampId,H,I.color,I.shape,R),Xe=[H],ne=I}else if(H){const j=window.staticWaveformVisualizer;j&&(j.currentColor=I.color,j.generateWaveform(),j.startSingleNoteVisualization(I.color)),Gt.triggerAttack(H,I.color);const F=((g=u.state.fullRowData[c])==null?void 0:g.hex)||"#888888";(b=_s.adsrComponent)==null||b.playheadManager.trigger(I.uuid,"attack",F,u.state.timbres[I.color].adsr),Xe=[H],ne=I}return}const D=u.state.selectedTool;if(D==="chord"){if(!lh(r,u.state))return;const R=Ge(c);if(!R)return;const H=rm(R),{shape:j,color:F}=u.state.selectedNote;Xe=[...H],Xe.forEach(tt=>{Gt.triggerAttack(tt,F)});const Y=((w=u.state.fullRowData[c])==null?void 0:w.hex)||"#888888";(x=_s.adsrComponent)==null||x.playheadManager.trigger("chord_preview","attack",Y,u.state.timbres[F].adsr),Ws=[],H.forEach(tt=>{const nt=u.state.fullRowData.findIndex(at=>at.toneNote===tt);if(nt!==-1){const at={row:nt,startColumnIndex:r,endColumnIndex:r,color:F,shape:j,isDrum:!1},gt=u.addNote(at);gt&&(Ws.push(gt),gt.uuid&&u.emit("noteInteractionStart",{noteId:gt.uuid,color:gt.color}))}}),to=!0,$n=c;return}if(D==="tonicization"){if(qn&&si.length>0){const R=si.map(H=>({row:H,tonicNumber:u.state.selectedToolTonicNumber,preMacrobeatIndex:qn.preMacrobeatIndex,columnIndex:qn.drawColumn}));u.addTonicSignGroup(R),qn=null,si=[]}return}if(D==="eraser"){Fr=!0,u.eraseInPitchArea(r,c,2,!1);const R=r+2-1,H=c-1,j=c+1;z0(r,R,H,j),j0(r,R,H,j);return}if(D==="stamp"){const R=u.getAllStampPlacements(),H=s+a,j={...u.state},F=om(H,i,R,j);if(F){console.log("[STAMP INTERACTION] ✓ Hit detected, starting shape drag:",F),ss={...F,startRow:u.getShapeRow(F.placement,F.shapeKey),startMouseY:i},xa=!0,console.log("[STAMP INTERACTION] Drag state initialized:",{shapeKey:ss.shapeKey,startRow:ss.startRow,placementId:ss.placement.id});return}const Y=en.getStampAtPosition(r,c);if(Y){console.log("[STAMP INTERACTION] Clicked existing stamp, replaying pattern:",Y.stampId);const nt=Ge(c);if(nt){const at=u.state.placedNotes.find(_t=>!_t.isDrum&&_t.row===c&&r>=_t.startColumnIndex&&r<=_t.endColumnIndex),gt=at?at.shape:"oval";en.playRhythmPattern(Y.stampId,nt,Y.color,gt,Y),Xe=[nt]}return}const tt=$h.getSelectedStamp();if(tt){console.log("[STAMP INTERACTION] Placing new stamp:",{stampId:tt.id,colIndex:r,rowIndex:c});const{color:nt,shape:at}=u.state.selectedNote;q0(tt.id,r,c,nt);const gt=Ge(c);gt&&(en.playRhythmPattern(tt.id,gt,nt,at),Xe=[gt]),u.recordState()}return}if(D==="triplet"){const R=u.getAllTripletPlacements(),H=s+a,j={...u.state};console.log("[TRIPLET INTERACTION] Checking for shape hit at:",{actualX:H,y:i,numTriplets:R.length});const F=am(H,i,R,j);if(F){console.log("[TRIPLET INTERACTION] ✓ Hit detected, starting shape drag:",F),bs={...F,startRow:u.getTripletShapeRow(F.placement,F.shapeKey),startMouseY:i},Sa=!0;return}const Y=Math.floor(r/2),tt=en.getTripletAtPosition(Y,c);if(tt){console.log("[TRIPLET INTERACTION] Clicked existing triplet, replaying pattern:",tt.stampId);const at=Ge(c);at&&(en.playTripletPattern(tt.stampId,at,tt.color,tt),Xe=[at]);return}const nt=jr.getSelectedTripletStamp();if(nt&&u.state.selectedNote){console.log("[TRIPLET INTERACTION] Placing new triplet:",{stampId:nt.id,colIndex:r,rowIndex:c});const at=H0(nt.id,Y,c,u.state.selectedNote.color),gt=Ge(c);gt&&at&&(en.playTripletPattern(nt.id,gt,u.state.selectedNote.color,at),Xe=[gt]),u.recordState()}return}if(D==="modulation"){const R=u.state.selectedModulationRatio;if(!R){console.warn("[MODULATION] No ratio selected - click 2:3 or 3:2 button first");return}const H=cm(M);if(!H){console.warn("[MODULATION] Click must be near a measure boundary");return}console.log("[MODULATION] Placing marker at measure boundary:",{measureIndex:H.measureIndex,ratio:R,clickX:M,boundaryX:H.xPosition});const j=u.addModulationMarker(H.measureIndex,R,H.xPosition,null,H.macrobeatIndex);console.log("[MODULATION] Marker placed successfully:",{markerId:j,measureIndex:H.measureIndex,ratio:R});return}if(D==="note"){if(!lh(r,u.state)||!u.state.selectedNote)return;const{shape:R,color:H}=u.state.selectedNote,j={row:c,startColumnIndex:r,endColumnIndex:r,color:H,shape:R,isDrum:!1},F=u.addNote(j);if(!F)return;ne=F,F.uuid&&u.emit("noteInteractionStart",{noteId:F.uuid,color:F.color}),to=R==="circle",$n=c,to||u.recordState();const Y=Ge(c);if(Y){Xe=[Y],Gt.triggerAttack(Y,ne.color);const tt=((A=u.state.fullRowData[c])==null?void 0:A.hex)||"#888888";(P=_s.adsrComponent)==null||P.playheadManager.trigger(ne.uuid,"attack",tt,u.state.timbres[ne.color].adsr);const nt=window.staticWaveformVisualizer;nt&&(nt.currentColor=ne.color,nt.generateWaveform(),nt.startSingleNoteVisualization(ne.color))}}}}}function Xw(n){var b,w,x,A;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,a=document.getElementById("canvas-container").scrollLeft,r=Hs.getColumnIndex(s+a),c=Hs.getPitchRowIndex(i);if(!Xt)return;if(Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),xa&&ss){const P=Hs.getPitchRowIndex(i),M=P-ss.placement.row;if(console.log("[STAMP DRAG] Mouse moved, updating shape position:",{mouseY:i,newRow:P,baseRow:ss.placement.row,rowOffset:M,shapeKey:ss.shapeKey}),u.updateStampShapeOffset(ss.placement.id,ss.shapeKey,M),P!==ss.startRow){const I=Ge(P);if(I){const D=ss.placement.color||((b=u.state.selectedNote)==null?void 0:b.color);Gt.triggerAttack(I,D),setTimeout(()=>Gt.triggerRelease(I,D),100)}ss.startRow=P}n.target.style.cursor="ns-resize";return}if(Sa&&bs){const P=Hs.getPitchRowIndex(i),M=P-bs.placement.row;if(console.log("[TRIPLET DRAG] Mouse moved, updating shape position:",{mouseY:i,newRow:P,baseRow:bs.placement.row,rowOffset:M,shapeKey:bs.shapeKey}),u.updateTripletShapeOffset(bs.placement.id,bs.shapeKey,M),P!==bs.startRow){const I=Ge(P);if(console.log("[TRIPLET DRAG] Row changed, playing audio:",{oldRow:bs.startRow,newRow:P,pitch:I,hasPitch:!!I}),I){const D=bs.placement.color||((w=u.state.selectedNote)==null?void 0:w.color);console.log("[TRIPLET DRAG] Triggering audio for pitch:",I,"color:",D),Gt.triggerAttack(I,D),setTimeout(()=>Gt.triggerRelease(I,D),100)}bs.startRow=P}n.target.style.cursor="ns-resize";return}const h=u.state.selectedTool;if(h==="stamp"&&!xa){const P=s+a,M=u.getAllStampPlacements(),I={...u.state};om(P,i,M,I)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}if(h==="triplet"&&!Sa){const P=s+a,M=u.getAllTripletPlacements(),I={...u.state};am(P,i,M,I)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}const m=s+a;({...u.state});for(const P of u.state.modulationMarkers||[]);if(u.state.selectedTool==="modulation"){const P=cm(m);P&&Zw(Xt,P.xPosition,u.state.selectedModulationRatio)}n.target;const g=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(r<2||r>=g||Ge(c)===null){qn=null,si=[],Gp();return}if(ab(r,c),to&&(ne||Ws.length>0)){const P=r,M=c;if(ne){if(P!==ne.endColumnIndex&&u.updateNoteTail(ne,P),M!==$n&&M!==ne.row){const I=Ge(M);if(I){const D=Ge(ne.row);D&&Gt.triggerRelease(D,ne.color),u.updateNoteRow(ne,M),Gt.triggerAttack(I,ne.color),Xe=[I];const R=((x=u.state.fullRowData[M])==null?void 0:x.hex)||"#888888";(A=_s.adsrComponent)==null||A.playheadManager.trigger(ne.uuid,"attack",R,u.state.timbres[ne.color].adsr),$n=M}}}else if(Ws.length>0){const I=Ws.filter(D=>P!==D.endColumnIndex);if(I.length>0&&u.updateMultipleNoteTails(I,P),M!==$n){const D=M-$n;Xe.forEach(j=>{Gt.triggerRelease(j,Ws[0].color)});const R=Ws.map(j=>j.row+D);if(R.every(j=>Ge(j)!==null)){u.updateMultipleNoteRows(Ws,R);const j=R.map(F=>Ge(F)).filter(F=>F);j.forEach(F=>{Gt.triggerAttack(F,Ws[0].color)}),Xe=j,$n=M}}}return}if(u.state.selectedTool==="chord"){const P=Ge(c);if(P){const M=rm(P),{shape:I,color:D}=u.state.selectedNote;Xt.globalAlpha=.4,M.forEach(R=>{const H=u.state.fullRowData.findIndex(j=>j.toneNote===R);if(H>-1){const j={row:H,startColumnIndex:r,endColumnIndex:r,color:D,shape:I,isDrum:!1},F={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};I==="oval"?Rh(Xt,F,j,H):Ih(Xt,F,j,H)}}),Xt.globalAlpha=1}return}if(_a){u.eraseInPitchArea(r,c,2,!1)&&(ws=!0),u.eraseTonicSignAt(r,!1)&&(ws=!0);const P=r+2-1,M=c-1,I=c+1;u.eraseStampsInArea(r,P,M,I)&&(ws=!0),u.eraseTripletsInArea(r,P,M,I)&&(ws=!0);const D=n.target.getBoundingClientRect(),R=n.clientX-D.left,H=n.clientY-D.top;Ut.eraseAtPoint(R,H)&&(ws=!0),Mr(r,c,"rgba(220, 53, 69, 0.3)");return}if(Fr){u.eraseInPitchArea(r,c,2,!1);const P=r+2-1,M=c-1,I=c+1;u.eraseStampsInArea(r,P,M,I),u.eraseTripletsInArea(r,P,M,I),Mr(r,c,"rgba(220, 53, 69, 0.3)");return}if(u.state.selectedTool==="tonicization"){const P=Gw(r);if(P){const M=Ge(c);if(M){const I=u.state.fullRowData.map((R,H)=>({...R,index:H})).filter(R=>R.toneNote&&R.toneNote.replace(/\d+$/,"")===M.replace(/\d+$/,"")).map(R=>R.index);qn=P,si=I,Xt.globalAlpha=.5;const D={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};I.forEach(R=>{const H={row:R,columnIndex:P.drawColumn,tonicNumber:u.state.selectedToolTonicNumber};Dh(Xt,D,H)}),Xt.globalAlpha=1}}else qn=null,si=[]}else{const P=u.state.selectedTool==="note"||u.state.selectedTool==="chord"?lh(r,u.state):!0,M=u.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":P?"rgba(74, 144, 226, 0.2)":"rgba(220, 53, 69, 0.15)";if(Mr(r,c,M),u.state.selectedTool==="stamp"){const D=$h.getSelectedStamp();if(D){const R={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};Zb(Xt,r,c,D,R)}}else if(u.state.selectedTool==="triplet"){const D=jr.getSelectedTripletStamp();if(D){const R=Math.floor(r/2),H={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};sw(Xt,R,c,D,H)}}else P&&jw(r,c)}}function lm(){Xt&&Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),qn=null,si=[],Gp()}function Yw(){var n,e,s,i,a;if(xa&&ss){console.log("[STAMP DRAG] Drag ended, saving state for undo/redo"),xa=!1,ss=null,u.recordState();const r=document.getElementById("notation-grid");r&&(r.style.cursor="default");return}if(Sa&&bs){console.log("[TRIPLET DRAG] Drag ended, saving state for undo/redo"),Sa=!1,bs=null,u.recordState();const r=document.getElementById("notation-grid");r&&(r.style.cursor="default");return}if(Xe.length>0){en.stopCurrentPattern();const r=(n=u.state.selectedNote)==null?void 0:n.color;if(r&&Xe.forEach(m=>{Gt.triggerRelease(m,r)}),!!ne){const m=((e=u.state.fullRowData[ne.row])==null?void 0:e.hex)||"#888888";(s=_s.adsrComponent)==null||s.playheadManager.trigger(ne.uuid,"release",m,u.state.timbres[r].adsr)}else{const m=Xe[0],f=u.state.fullRowData.find(g=>g.toneNote===m);if(f){const g=f.hex;(i=_s.adsrComponent)==null||i.playheadManager.trigger("chord_preview","release",g,u.state.timbres[r].adsr)}}Xe=[];const h=window.staticWaveformVisualizer;h&&h.stopLiveVisualization()}to&&u.recordState(),to=!1,$n=null,ne&&ne.uuid&&u.emit("noteInteractionEnd",{noteId:ne.uuid}),Ws.forEach(r=>{r.uuid&&u.emit("noteInteractionEnd",{noteId:r.uuid})}),ne=null,Ws=[],Fr&&(u.recordState(),Fr=!1),_a&&(ws&&u.recordState(),_a=!1,ws=!1,Ar&&(u.setSelectedTool(Ar),Ar=null),(a=oi.get("eraserButton"))==null||a.classList.remove("erasing-active")),lm()}function cm(n,e){const{macrobeatGroupings:s,macrobeatBoundaryStyles:i}=u.state;an(u.state);const a=100,r=[],c=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;console.log("[MODULATION] Boundary calculation - has modulation:",c);for(let g=0;g<i.length;g++)if(i[g]==="solid"){const b=cs(u.state,g);if(b){const w=c?mt(b.endColumn+1,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):xt.getColumnX(b.endColumn+1);console.log(`[MODULATION] Boundary ${g}: measureInfo.endColumn=${b.endColumn}, calculatedX=${w}, method=${c?"modulated":"base"}`),r.push({measureIndex:g+1,xPosition:w,macrobeatIndex:g})}}const h=c?mt(2,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):xt.getColumnX(2);console.log("[MODULATION] Start boundary: calculatedX=",h,", method=",c?"modulated":"base"),r.unshift({measureIndex:0,xPosition:h,macrobeatIndex:-1}),console.log("[MODULATION] Available measure boundaries:",r),console.log("[MODULATION] Click position:",n,"tolerance:",a);let m=null,f=1/0;return r.forEach(g=>{const b=Math.abs(n-g.xPosition);console.log(`[MODULATION] Boundary at x=${g.xPosition}, distance=${b}`),b<=a&&b<f&&(f=b,m=g)}),m?console.log("[MODULATION] Found closest boundary:",m,"distance:",f):console.log("[MODULATION] No boundary within tolerance"),m}function Zw(n,e,s){if(!s)return;const i=Pp(s),a=Ep(s);n.save();const r=3,c=2,h=n.canvas.height;n.strokeStyle=i,n.lineWidth=c,n.globalAlpha=.7,n.setLineDash([]);for(let m=-1;m<=1;m++){const f=e+m*r;n.beginPath(),n.moveTo(f,0),n.lineTo(f,h),n.stroke()}n.globalAlpha=.8,n.font="12px Arial, sans-serif",n.textAlign="center",n.textBaseline="top",n.fillStyle=i,n.fillText(`Preview: ${a}`,e,10),n.restore()}function Qw(){const n=document.getElementById("notation-grid"),e=document.getElementById("hover-canvas");if(!n||!e){console.error("PitchGridInteractor: Could not find required canvas elements.");return}Xt=e.getContext("2d"),n.addEventListener("mousedown",Uw),n.addEventListener("mousemove",Xw),n.addEventListener("mouseleave",lm),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",Yw)}const Bc={init(){Qw(),zw(),document.addEventListener("canvasResized",n=>{this.renderPitchGrid(),this.renderDrumGrid()}),ga(async()=>{const{default:n}=await Promise.resolve().then(()=>g0);return{default:n}},void 0).then(({default:n})=>{n.on("animationUpdate",e=>{e.type==="vibrato"&&e.activeColors&&e.activeColors.length>0?this.renderPitchGrid():e.type==="envelopeFill"||e.hasEnvelopeFills?this.renderPitchGrid():e.type==="combined"&&e.vibratoColors&&e.vibratoColors.length>0&&this.renderPitchGrid()})})},renderPitchGrid:Yi.render,renderDrumGrid:Es.render},$s={};function Jw(){return $s.container=document.querySelector("#adsr-envelope"),$s.parentContainer=$s.container.closest(".adsr-container"),$s.sustainTrack=document.getElementById("sustain-slider-track"),$s.sustainThumb=document.getElementById("sustain-slider-thumb"),$s.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),$s.thumbA=document.getElementById("thumb-a"),$s.thumbD=document.getElementById("thumb-d"),$s.thumbR=document.getElementById("thumb-r"),$s}const Kw={init:Jw,get elements(){return $s}};function hm(){return dm*u.state.adsrTimeAxisScale}function um(n,e){const{sustain:s}=u.state.timbres[e.currentColor].adsr,i=.01;n.d=Math.max(n.a+i,n.d),n.r=Math.max(n.d+i,n.r);const a=n.a,r=n.d-n.a,c=n.r-n.d;if(isNaN(a)||isNaN(r)||isNaN(c)){console.error("NaN value detected before setting ADSR. Aborting update.",{newAttack:a,newDecay:r,newRelease:c});return}u.setADSR(e.currentColor,{attack:a,decay:r,release:c,sustain:s})}function t_(n,e){let s=!1;const i=c=>{var x;if(!s)return;const h=n.sustainTrack.getBoundingClientRect();let f=100-(c.clientY-h.top)/h.height*100;f=Math.max(0,Math.min(100,f));const b=(((x=window.staticWaveformVisualizer)==null?void 0:x.getNormalizedAmplitude())||1)*100;f=Math.min(f,b);const w=u.state.timbres[e.currentColor];u.setADSR(e.currentColor,{...w.adsr,sustain:f/100})},a=c=>{s=!0,i(c)},r=()=>{s=!1};n.sustainTrack.addEventListener("pointerdown",a),document.addEventListener("pointermove",i),document.addEventListener("pointerup",r)}function e_(n,e){let s=null;const i=c=>{if(!s)return;const h=n.multiSliderContainer.getBoundingClientRect();let f=(c.clientX-h.left)/h.width*100;f=Math.max(0,Math.min(100,f));const g=f/100*hm(),{attack:b,decay:w,release:x}=u.state.timbres[e.currentColor].adsr,A={a:b,d:b+w,r:b+w+x};s.id==="thumb-a"&&(A.a=g),s.id==="thumb-d"&&(A.d=g),s.id==="thumb-r"&&(A.r=g),um(A,e)},a=c=>{c.target.classList.contains("time-slider-thumb")&&(s=c.target,i(c))},r=()=>{s=null};n.multiSliderContainer.addEventListener("pointerdown",a),document.addEventListener("pointermove",i),document.addEventListener("pointerup",r)}function s_(n,e){let s=null;const i=c=>{var H;if(!s)return;const h=e.svgContainer,m=h.createSVGPoint();m.x=c.clientX,m.y=c.clientY;const f=m.matrixTransform(h.getScreenCTM().inverse());let g=f.x/e.width*100,b=1-f.y/e.height;g=Math.max(0,Math.min(100,g)),b=Math.max(0,Math.min(1,b));const w=g/100*hm(),x=u.state.timbres[e.currentColor];let{attack:A,decay:P,release:M,sustain:I}=x.adsr;const D={a:A,d:A+P,r:A+P+M};switch(s.id){case"attack-node":D.a=w;break;case"decay-sustain-node":D.d=w;const j=((H=window.staticWaveformVisualizer)==null?void 0:H.getNormalizedAmplitude())||1;I=Math.min(b,j);break;case"release-node":D.r=w;break}const R=u.state.timbres[e.currentColor].adsr.sustain;I!==R&&u.setADSR(e.currentColor,{attack:A,decay:P,release:M,sustain:I}),um(D,e)},a=c=>{c.target.classList.contains("adsr-node")&&(s=c.target,s.style.cursor="grabbing",i(c))},r=()=>{s&&(s.style.cursor="grab",s=null)};e.nodeLayer.addEventListener("pointerdown",a),document.addEventListener("pointermove",i),document.addEventListener("pointerup",r)}function n_(n){const e=n.ui;t_(e,n),e_(e,n),s_(e,n)}function i_(n,{width:e,height:s},i){for(;n.firstChild;)n.removeChild(n.firstChild);if(i>0){for(let h=1;h<=5;h++)if(h<=i){const m=h/i*e,f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",m),f.setAttribute("y",s-5),f.setAttribute("fill","#d0d0d0"),f.setAttribute("font-size","24"),f.setAttribute("font-weight","bold"),f.setAttribute("text-anchor","middle"),f.setAttribute("dominant-baseline","auto"),f.setAttribute("opacity","0.3"),f.textContent=`${h}s`,n.appendChild(f)}}const a=u.state.tempo;if(a<=0||i<=0)return;const r=30/a;let c=0;for(let h=r;h<i;h+=r){const m=h/i*e,f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",m),f.setAttribute("y1",0),f.setAttribute("x2",m),f.setAttribute("y2",s);const g=(c+1)%2===0;f.setAttribute("stroke",g?"#adb5bd":"#ced4da"),f.setAttribute("stroke-width",g?"1":"0.5"),f.setAttribute("stroke-dasharray","3,3"),n.appendChild(f),c++}}function o_(n,e,s,{height:i,width:a},r,c,h){for(;n.firstChild;)n.removeChild(n.firstChild);for(;e.firstChild;)e.removeChild(e.firstChild);if(s.length===0)return;const m=u.state.colorPalette[r]||{primary:r,light:r},f=m.primary,g=m.light;let b={time:0,feedback:0},w={decay:0,roomSize:0};window.effectsCoordinator&&(b=window.effectsCoordinator.getEffectParameters(r,"delay"),w=window.effectsCoordinator.getEffectParameters(r,"reverb")),h&&h.clearRect(0,0,a,i);const x=(F,Y=1)=>{if(!h||w.decay===0||w.roomSize===0||!c)return;const tt=w.decay/100*5*(a/c),nt=w.roomSize/100*Y;h.filter="blur(30px)";const at=parseInt(g.slice(1,3),16),gt=parseInt(g.slice(3,5),16),_t=parseInt(g.slice(5,7),16),Mt=60;for(let me=0;me<Mt;me++){const Wt=me/Mt,Qt=(me+1)/Mt,it=F[1].y+(F[3].y-F[1].y)*Wt,ht=F[1].y+(F[3].y-F[1].y)*Qt,ut=F[1].x+(F[3].x-F[1].x)*Wt,Ct=F[1].x+(F[3].x-F[1].x)*Qt,dt=h.createLinearGradient(ut,it,ut+tt,it);dt.addColorStop(0,`rgba(${at}, ${gt}, ${_t}, ${nt})`),dt.addColorStop(1,`rgba(${at}, ${gt}, ${_t}, 0)`),h.fillStyle=dt,h.beginPath(),h.moveTo(ut,it),h.lineTo(ut+tt,it),h.lineTo(Ct+tt,ht),h.lineTo(Ct,ht),h.closePath(),h.fill()}h.filter="none"};if(x(s,1),b.time>0&&b.feedback>0&&c){const F=Math.max(.01,b.time/100*.5),Y=Math.min(.95,b.feedback/100),tt=.05;let nt=Y,at=0;for(;nt>tt&&at<10;){at++;const gt=F*at/c*a,_t=s.map(Mt=>({x:Mt.x+gt,y:Mt.y}));if(_t[0].x<a){x(_t,nt);const Mt=document.createElementNS("http://www.w3.org/2000/svg","polygon"),me=`${_t[0].x},${i} `+_t.map(Qt=>`${Qt.x},${Qt.y}`).join(" ")+` ${Math.min(_t[3].x,a)},${i}`;Mt.setAttribute("points",me),Mt.setAttribute("fill",Vs(g,.7*nt)),Mt.setAttribute("class","delay-echo"),n.appendChild(Mt);const Wt=document.createElementNS("http://www.w3.org/2000/svg","polyline");Wt.setAttribute("points",_t.map(Qt=>`${Qt.x},${Qt.y}`).join(" ")),Wt.setAttribute("stroke-width",2),Wt.setAttribute("fill","none"),Wt.setAttribute("stroke",Vs(f,nt)),Wt.setAttribute("class","delay-echo"),n.appendChild(Wt)}nt*=Y}}const A=document.createElementNS("http://www.w3.org/2000/svg","polygon"),P=`0,${i} `+s.map(F=>`${F.x},${F.y}`).join(" ")+` ${a},${i}`;A.setAttribute("points",P),A.setAttribute("fill",Vs(g,.7)),n.appendChild(A);const M=document.createElementNS("http://www.w3.org/2000/svg","line");M.setAttribute("x1",s[0].x),M.setAttribute("y1",s[0].y),M.setAttribute("x2",s[1].x),M.setAttribute("y2",s[1].y),M.setAttribute("stroke",f),M.setAttribute("stroke-width",2),n.appendChild(M);const I=document.createElementNS("http://www.w3.org/2000/svg","line");I.setAttribute("x1",s[1].x),I.setAttribute("y1",s[1].y),I.setAttribute("x2",s[2].x),I.setAttribute("y2",s[2].y),I.setAttribute("stroke",f),I.setAttribute("stroke-width",2),n.appendChild(I);const D=w.decay>0&&w.roomSize>0?Math.max(.3,1-w.decay/100*(w.roomSize/100)*.7):1,R=document.createElementNS("http://www.w3.org/2000/svg","line");R.setAttribute("x1",s[2].x),R.setAttribute("y1",s[2].y),R.setAttribute("x2",s[3].x),R.setAttribute("y2",s[3].y),R.setAttribute("stroke",Vs(f,D)),R.setAttribute("stroke-width",2),n.appendChild(R);const H=["attack-node","decay-sustain-node","release-node"];[s[1],s[2],s[3]].forEach((F,Y)=>{const tt=document.createElementNS("http://www.w3.org/2000/svg","circle");tt.setAttribute("id",H[Y]),tt.setAttribute("class","adsr-node"),tt.setAttribute("cx",F.x),tt.setAttribute("cy",F.y),tt.setAttribute("r",8),tt.setAttribute("fill",f),tt.setAttribute("stroke",Vr(f,-.3)),tt.setAttribute("stroke-width",2),tt.style.cursor="grab";const nt=document.createElementNS("http://www.w3.org/2000/svg","title");tt.appendChild(nt),e.appendChild(tt)})}function a_(n,e){const s=Vr(e,-.2);n.style.setProperty("--c-accent",e),n.style.setProperty("--c-accent-hover",s)}const Se={};let _n=null,ri=!1;function r_(n,e){const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("data-playhead-id",n);const i=document.createElementNS("http://www.w3.org/2000/svg","line");i.setAttribute("stroke",e),i.setAttribute("stroke-width",2),i.setAttribute("stroke-dasharray","3,3"),s.appendChild(i);const a=document.createElementNS("http://www.w3.org/2000/svg","circle");return a.setAttribute("r",5),a.setAttribute("fill",e),s.appendChild(a),s}function l_(n,e,s,i=null){if(!(!_n||!i)){if(e==="attack"){Se[n]&&(cancelAnimationFrame(Se[n].requestId),Se[n].group.remove());const a=r_(n,s);_n.playheadLayer.appendChild(a),Se[n]={group:a,phase:e,color:s,adsr:i,requestId:null,startTimestamp:Q.now(),elapsed:0},qh(n)}else if(e==="release"){if(ri)return;const a=Se[n];if(!a)return;cancelAnimationFrame(a.requestId),a.phase="release",a.adsr=i,a.startTimestamp=Q.now(),a.elapsed=0,Wh(n)}}}function qh(n){if(!Se[n]||ri)return;const e=Se[n];if(!e.adsr)return;const{attack:s,decay:i}=e.adsr,a=_n.calculateEnvelopePoints(e.adsr);if(a.length<4)return;const[r,c,h]=a,m=Q.now()-e.startTimestamp;e.elapsed=m;const f=s+i,g=Math.min(m,f);let b,w;if(g<=s){const P=s>0?g/s:1;b=r.x+P*(c.x-r.x),w=r.y+P*(c.y-r.y)}else{const P=g-s,M=i>0?P/i:1;b=c.x+M*(h.x-c.x),w=c.y+M*(h.y-c.y)}const[x,A]=e.group.children;x.setAttribute("x1",b),x.setAttribute("y1",0),x.setAttribute("x2",b),x.setAttribute("y2",_n.height),A.setAttribute("cx",b),A.setAttribute("cy",w),g<f?e.requestId=requestAnimationFrame(()=>qh(n)):(e.phase="sustain",zh(n))}function zh(n){if(!Se[n]||ri)return;const e=Se[n];if(!e.adsr)return;const s=_n.calculateEnvelopePoints(e.adsr);if(s.length<4)return;const[,,i]=s,[a,r]=e.group.children;a.setAttribute("x1",i.x),a.setAttribute("y1",0),a.setAttribute("x2",i.x),a.setAttribute("y2",_n.height),r.setAttribute("cx",i.x),r.setAttribute("cy",i.y),e.requestId=requestAnimationFrame(()=>zh(n))}function Wh(n){if(!Se[n]||ri)return;const e=Se[n];if(!e.adsr)return;const{release:s}=e.adsr,i=_n.calculateEnvelopePoints(e.adsr);if(i.length<4)return;const[,,a,r]=i,c=Q.now()-e.startTimestamp;e.elapsed=c;const h=Math.min(c,s),m=s>0?h/s:1,f=a.x+m*(r.x-a.x),g=a.y+m*(r.y-a.y),[b,w]=e.group.children;b.setAttribute("x1",f),b.setAttribute("y1",0),b.setAttribute("x2",f),b.setAttribute("y2",_n.height),w.setAttribute("cx",f),w.setAttribute("cy",g),h<s?e.requestId=requestAnimationFrame(()=>Wh(n)):(e.group.remove(),delete Se[n])}function c_(){ri=!0;for(const n in Se){const e=Se[n];e.requestId&&(cancelAnimationFrame(e.requestId),e.requestId=null)}}function h_(){ri=!1;for(const n in Se){const e=Se[n];e.startTimestamp=Q.now()-e.elapsed,e.phase==="attack"?qh(n):e.phase==="sustain"?zh(n):e.phase==="release"&&Wh(n)}}function u_(){ri=!1;for(const n in Se){const e=Se[n];cancelAnimationFrame(e.requestId),e.group.remove()}for(const n in Se)delete Se[n]}function d_(n){return _n=n,{trigger:l_,pause:c_,resume:h_,clearAll:u_}}const dm=2.5;class p_{constructor(){var e;this.ui=Kw.init(),this.currentColor=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=d_(this),_s.adsrComponent=this,n_(this),this.listenForStoreChanges(),this.initControls(),this.ui.container&&new ResizeObserver(()=>this.resize()).observe(this.ui.container),this.updateFromStore(),this.updateComponentWidth(u.state.adsrComponentWidth),T.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const e=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*e,this.reverbCanvas.height=this.height*e,this.reverbCtx.scale(e,e)}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const e=u.state.timbres[this.currentColor];e&&({attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release}=e.adsr,this.render(),this.updateControls())}getCurrentMaxTime(){return dm*u.state.adsrTimeAxisScale}updateComponentWidth(e){if(this.ui.parentContainer){const i=.5+u.state.adsrTimeAxisScale*.2,a=e*i;this.ui.parentContainer.style.setProperty("width",`${a}%`,"important"),this.resize()}}updateTimeScaleWidth(){const e=u.state.adsrComponentWidth;this.updateComponentWidth(e)}initControls(){const e=document.getElementById("adsr-time-scale"),s=document.getElementById("adsr-time-scale-value");e&&s&&(e.value=u.state.adsrTimeAxisScale,s.textContent=`${u.state.adsrTimeAxisScale}x`,e.addEventListener("input",r=>{const c=parseFloat(r.target.value);u.setAdsrTimeAxisScale(c),s.textContent=`${c}x`}));const i=document.getElementById("adsr-width-scale"),a=document.getElementById("adsr-width-scale-value");i&&a&&(i.value=u.state.adsrComponentWidth,a.textContent=`${u.state.adsrComponentWidth}%`,i.addEventListener("input",r=>{const c=parseInt(r.target.value);u.setAdsrComponentWidth(c),a.textContent=`${c}%`}))}listenForStoreChanges(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.updateFromStore())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.updateFromStore()}),u.on("tempoChanged",()=>this.render()),u.on("adsrTimeAxisScaleChanged",e=>{this.render(),this.updateSliders(),this.updateTimeScaleWidth()}),u.on("adsrComponentWidthChanged",e=>{this.updateComponentWidth(e)}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{e&&e.includes(this.currentColor)&&this.render()}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e?s?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),u.on("audioEffectChanged",({effectType:e,color:s})=>{s===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(e=this){var A;const{attack:s,decay:i,sustain:a,release:r}=e;if(!this.width||!this.height)return[];const c=P=>P/this.getCurrentMaxTime()*this.width;let h=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(h=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const m=((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)??1,f=m*h;console.log("[ADSR] Amplitude calculation:",{originalAmplitude:m,tremoloMultiplier:h,normalizedAmplitude:f});const g={x:0,y:this.height},b={x:c(s),y:this.height*(1-f)},w={x:c(s+i),y:this.height*(1-Math.min(a*f,f))},x={x:c(s+i+r),y:this.height};return[g,b,w,x]}render(){if(!this.ui||!this.width||!this.height)return;const e={width:this.width,height:this.height},s=this.calculateEnvelopePoints(),i=this.getCurrentMaxTime();i_(this.gridLayer,e,i),o_(this.envelopeLayer,this.nodeLayer,s,e,this.currentColor,i,this.reverbCtx),a_(this.ui.parentContainer,this.currentColor)}updateControls(){var P;if(!this.ui.sustainThumb)return;let e=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(e=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const i=(((P=window.staticWaveformVisualizer)==null?void 0:P.calculatedAmplitude)||1)*e,a=i*100;if(this.sustain>i){const M=u.state.timbres[this.currentColor];u.setADSR(this.currentColor,{...M.adsr,sustain:i}),this.sustain=i}const r=this.sustain*100;this.ui.sustainThumb.style.bottom=`${r}%`,this.ui.sustainTrack.style.setProperty("--sustain-progress",`${r}%`);const c=100-a;this.ui.sustainTrack.style.setProperty("--ineligible-height",`${c}%`);const h=this.attack/this.getCurrentMaxTime()*100,m=(this.attack+this.decay)/this.getCurrentMaxTime()*100,f=(this.attack+this.decay+this.release)/this.getCurrentMaxTime()*100;this.ui.thumbA.style.left=`${h}%`,this.ui.thumbD.style.left=`${m}%`,this.ui.thumbR.style.left=`${f}%`,this.ui.multiSliderContainer.style.setProperty("--adr-progress",`${f}%`);const g=M=>`${M.toFixed(3)}s`,b=M=>`${(M*100).toFixed(0)}%`;this.ui.thumbA.title=`Attack: ${g(this.attack)}`,this.ui.thumbD.title=`Decay: ${g(this.decay)}`,this.ui.thumbR.title=`Release: ${g(this.release)}`,this.ui.sustainThumb.title=`Sustain: ${b(this.sustain)}`;const w=this.nodeLayer.querySelector("#attack-node > title");w&&(w.textContent=`Attack: ${g(this.attack)}`);const x=this.nodeLayer.querySelector("#decay-sustain-node > title");x&&(x.textContent=`Decay: ${g(this.decay)}
Sustain: ${b(this.sustain)}`);const A=this.nodeLayer.querySelector("#release-node > title");A&&(A.textContent=`Release: ${g(this.release)}`)}}function m_(){return document.getElementById("adsr-envelope")?new p_:null}let Zi,eo,zn,so,zs,Qi,ei,dh=!1,ph=!1,mh=!1,Gs;const Br=1,pm=31,mm=0,$r=2;function $c(){if(!Gs)return;const n=u.state.timbres[Gs];if(!n)return;n.filter?n.filter.enabled===void 0&&(n.filter.enabled=!0):n.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0};const{cutoff:e,blend:s,mix:i}=n.filter;if(Zi&&eo){const a=($r-s)/($r-mm);Zi.style.left=`${a*100}%`,eo.style.setProperty("--progress",`${a*100}%`)}if(Qi&&ei){const a=(i||0)/100;Qi.style.bottom=`${a*100}%`,ei.style.setProperty("--blend-progress",`${a*100}%`)}if(zn&&so){const a=(e-Br)/(pm-Br);zn.style.left=`${a*100}%`,zn.style.top="50%",zn.style.transform="translate(-50%, -50%)",so.style.setProperty("--progress",`${a*100}%`)}zs&&zs.style.setProperty("--c-accent",Gs)}function f_(n){if(!dh)return;const e=so.getBoundingClientRect(),s=n.clientX-e.left,i=e.width;let a=s/i;a=Math.max(0,Math.min(1,a));const r=a*(pm-Br)+Br;u.setFilterSettings(Gs,{cutoff:r})}function g_(n){if(!ph)return;const e=eo.getBoundingClientRect(),s=n.clientX-e.left,i=e.width;let a=s/i;a=Math.max(0,Math.min(1,a));const r=$r-a*($r-mm);u.setFilterSettings(Gs,{blend:r})}function v_(n){if(!mh)return;const e=ei.getBoundingClientRect(),s=n.clientY-e.top,i=e.height;let a=1-s/i;a=Math.max(0,Math.min(1,a));const r=a*100;u.setFilterSettings(Gs,{mix:r})}function y_(){var e;if(zs=document.querySelector(".filter-container"),Zi=document.getElementById("thumb-b"),eo=document.getElementById("blend-slider-container"),zn=document.getElementById("thumb-c"),so=document.getElementById("cutoff-slider-container"),!zs||!Zi||!zn){console.error("[FILTER CONTROLS] Missing required elements",{container:zs,blendThumb:Zi,cutoffThumb:zn});return}const n=zs==null?void 0:zs.querySelector(".blend-slider-container");n&&eo&&(n.getBoundingClientRect(),eo.getBoundingClientRect()),so&&so.getBoundingClientRect(),b_(),Zi.addEventListener("pointerdown",s=>{console.log("[BLEND SLIDER] Pointerdown on blend thumb"),s.preventDefault(),ph=!0,document.body.style.cursor="ew-resize";const i=r=>{console.log("[BLEND SLIDER] Moving",{clientX:r.clientX}),g_(r)},a=()=>{console.log("[BLEND SLIDER] Pointerup"),ph=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",i),window.removeEventListener("pointerup",a),u.recordState()};window.addEventListener("pointermove",i),window.addEventListener("pointerup",a)}),zn.addEventListener("pointerdown",s=>{console.log("[CUTOFF SLIDER] Pointerdown on cutoff thumb"),s.preventDefault(),dh=!0,document.body.style.cursor="ew-resize";const i=r=>{console.log("[CUTOFF SLIDER] Moving",{clientX:r.clientX}),f_(r)},a=()=>{console.log("[CUTOFF SLIDER] Pointerup"),dh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",i),window.removeEventListener("pointerup",a),u.recordState()};window.addEventListener("pointermove",i),window.addEventListener("pointerup",a)}),u.on("noteChanged",({newNote:s})=>{s.color&&s.color!==Gs&&(Gs=s.color,$c())}),u.on("timbreChanged",s=>{s===Gs&&$c()}),Gs=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",$c(),setTimeout(()=>{const s=zs==null?void 0:zs.querySelector(".blend-slider-container");s&&s.getBoundingClientRect()},100)}function b_(){if(ei=document.getElementById("vertical-blend-track"),Qi=document.getElementById("vertical-blend-thumb"),!ei||!Qi){console.error("[FILTER CONTROLS] Vertical blend slider elements not found");return}Qi.addEventListener("pointerdown",n=>{console.log("[VERTICAL BLEND] Pointerdown on M thumb"),n.preventDefault(),mh=!0,document.body.style.cursor="ns-resize";const e=i=>{console.log("[VERTICAL BLEND] Moving",{clientY:i.clientY}),v_(i)},s=()=>{console.log("[VERTICAL BLEND] Pointerup"),mh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",s),u.recordState()};window.addEventListener("pointermove",e),window.addEventListener("pointerup",s)}),ei.addEventListener("click",n=>{if(n.target===Qi)return;const e=ei.getBoundingClientRect(),s=n.clientY-e.top,i=e.height;let a=1-s/i;a=Math.max(0,Math.min(1,a));const r=a*100;u.setFilterSettings(Gs,{mix:r}),u.recordState()})}function w_(n,e,s){if(!(e.length<2)){n.globalAlpha=s.opacity;for(let i=1;i<e.length;i++){const a=e[i-1],r=e[i];if(r.timestamp-a.timestamp>200)continue;const c=n.createLinearGradient(a.x,a.y,r.x,r.y);c.addColorStop(0,`rgb(${a.color.join(",")})`),c.addColorStop(1,`rgb(${r.color.join(",")})`),n.strokeStyle=c,n.lineWidth=(a.thickness+r.thickness)/2,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(a.x,a.y),n.lineTo(r.x,r.y),n.stroke()}n.globalAlpha=1}}function __(n,e){const s=u.state,i=an(u.state),a=s.fullRowData.slice(n.topRow,n.bottomRow+1);let r=s.placedNotes.filter(j=>!j.isDrum&&j.row>=n.topRow&&j.row<=n.bottomRow).map(j=>({...j,row:j.row-n.topRow})),c=n.includeDrums?s.placedNotes.filter(j=>j.isDrum):[];if(n.colorMode==="bw"){const j=F=>F.map(Y=>({...Y,color:"#212529"}));r=j(r),c=j(c)}const h=s.columnWidths.reduce((j,F)=>j+F,0),m=50,f=m*2,g=f/2,b=h*m,w=a.length*g,x=n.includeDrums?3*.5*f:0,A=x>0?30:0,P=w+A+x,M=Math.min(e.width/b,e.height/P),I=document.createElement("canvas");I.width=b*M,I.height=P*M;const D=I.getContext("2d");D.scale(M,M),D.fillStyle="#FFF",D.fillRect(0,0,b,P);const R={placedNotes:r,placedTonicSigns:i,fullRowData:a,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles,colorMode:n.colorMode,degreeDisplayMode:"off"},H=document.createElement("canvas");if(H.width=b,H.height=w,tm(H.getContext("2d"),R),D.drawImage(H,0,0),s.paint&&s.paint.paintHistory.length>0){console.log(`[PrintService] Found ${s.paint.paintHistory.length} paint points to print.`);const j=document.createElement("canvas");j.width=b,j.height=w;const F=j.getContext("2d"),Y=document.getElementById("notation-grid"),tt=b/Y.width,nt=w/(Y.height*(a.length/s.fullRowData.length)),at=n.topRow*g,gt=s.paint.paintHistory.map(_t=>({..._t,x:_t.x*tt,y:_t.y*nt-at,thickness:_t.thickness*Math.min(tt,nt)}));w_(F,gt,{opacity:s.paint.paintSettings.opacity/100}),D.drawImage(j,0,0),console.log("[PrintService] Paint trail has been rendered for printing.")}if(n.includeDrums){const j={placedNotes:c,placedTonicSigns:i,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles},F=document.createElement("canvas");F.width=b,F.height=x,nm(F.getContext("2d"),j),D.drawImage(F,0,w+A)}return I}const Xd={generateScoreCanvas:__,generateAndPrint(){const n=u.state.printOptions,e=300,s=(n.orientation==="landscape"?10.5:8)*e,i=(n.orientation==="landscape"?8:10.5)*e,a=this.generateScoreCanvas(n,{width:s,height:i}),r=document.getElementById("print-staging-area");r.innerHTML="";const c=document.getElementById("print-style-rules");c.textContent=`@page { size: ${n.orientation}; margin: 0.25in; }`;const h=document.createElement("img");h.src=a.toDataURL("image/png"),h.style.width="100%",h.style.height="auto",r.appendChild(h),setTimeout(()=>window.print(),100)}},x_={init(){this.overlay=document.getElementById("print-preview-overlay"),this.overlay&&(this.canvas=document.getElementById("print-preview-canvas"),this.ctx=this.canvas.getContext("2d"),this.canvasWrapper=this.canvas.parentElement,this.topRowSlider=document.getElementById("print-top-row-slider"),this.bottomRowSlider=document.getElementById("print-bottom-row-slider"),this.topRowLabel=document.getElementById("print-top-row-label"),this.bottomRowLabel=document.getElementById("print-bottom-row-label"),this.orientationBtn=document.getElementById("print-orientation-toggle"),this.colorBtn=document.getElementById("print-color-mode-toggle"),this.drumsBtn=document.getElementById("print-drums-toggle"),document.getElementById("print-close-button").addEventListener("click",()=>this.hide()),document.getElementById("print-confirm-button").addEventListener("click",()=>{Xd.generateAndPrint(),this.hide()}),this.topRowSlider.addEventListener("input",n=>u.setPrintOptions({topRow:parseInt(n.target.value)})),this.bottomRowSlider.addEventListener("input",n=>u.setPrintOptions({bottomRow:parseInt(n.target.value)})),this.orientationBtn.addEventListener("click",()=>this.handleToggle("orientation",["landscape","portrait"])),this.colorBtn.addEventListener("click",()=>this.handleToggle("colorMode",["color","bw"])),this.drumsBtn.addEventListener("click",()=>this.handleToggle("includeDrums",[!0,!1])),u.on("printPreviewStateChanged",n=>n?this.show():this.hide()),u.on("printOptionsChanged",()=>this.render()),u.on("notesChanged",()=>{u.state.isPrintPreviewActive&&this.render()}),new ResizeObserver(()=>{u.state.isPrintPreviewActive&&this.render()}).observe(this.canvasWrapper))},show(){console.log("🖨️ [PRINT PREVIEW] Showing preview"),u.state.isPrintPreviewActive||u.setPrintPreviewActive(!0),this.overlay.classList.remove("hidden");const n=u.state.placedNotes.filter(c=>!c.isDrum);let e=n.length>0?1/0:34,s=n.length>0?-1/0:54;n.forEach(c=>{e=Math.min(e,c.row),s=Math.max(s,c.row)});const i=2,a=Math.max(0,e-i),r=Math.min(u.state.fullRowData.length-1,s+i);this.topRowSlider.max=u.state.fullRowData.length-1,this.bottomRowSlider.max=u.state.fullRowData.length-1,u.setPrintOptions({...u.state.printOptions,topRow:a,bottomRow:r})},hide(){console.log("🖨️ [PRINT PREVIEW] Hiding preview"),u.state.isPrintPreviewActive&&u.setPrintPreviewActive(!1),this.overlay.classList.add("hidden")},handleToggle(n,e){const i=u.state.printOptions[n]===e[0]?e[1]:e[0];u.setPrintOptions({[n]:i})},updateControls(){var r,c;const{topRow:n,bottomRow:e,orientation:s,colorMode:i,includeDrums:a}=u.state.printOptions;this.topRowSlider.value=n,this.bottomRowSlider.value=e,this.topRowLabel.textContent=((r=u.state.fullRowData[n])==null?void 0:r.pitch)||"N/A",this.bottomRowLabel.textContent=((c=u.state.fullRowData[e])==null?void 0:c.pitch)||"N/A",this.orientationBtn.textContent=s.charAt(0).toUpperCase()+s.slice(1),this.colorBtn.textContent=i==="color"?"Color":"B&W",this.drumsBtn.textContent=a?"Yes":"No",this.drumsBtn.classList.toggle("active",a),this.colorBtn.classList.toggle("active",i==="color")},render(){if(!u.state.isPrintPreviewActive)return;this.updateControls();const n=this.canvasWrapper.clientWidth,e=this.canvasWrapper.clientHeight;if(n===0||e===0)return;const i=u.state.printOptions.orientation==="landscape"?10.5/8:8/10.5;let a=n,r=e;n/e>i?a=e*i:r=n/i;const c=Xd.generateScoreCanvas(u.state.printOptions,{width:a,height:r});c&&(this.canvas.width=c.width,this.canvas.height=c.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(c,0,0))}};T.moduleLoaded("DynamicWaveformVisualizer");class S_{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.isPlaybackActive=!1,this.liveAnalysers=new Map,this.liveWaveforms=new Map,this.playbackAnimationId=null,this.animationSpeed=100,this.frameSkipCounter=0,T.info("DynamicWaveformVisualizer","Initialized for live waveform visualization",null,"waveform")}initialize(e,s){var i;return this.canvas=e,this.ctx=s,this.currentColor=((i=u.state.selectedNote)==null?void 0:i.color)||"#4a90e2",this.setupEventListeners(),T.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color)}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e&&!s?this.startLiveVisualization():this.stopLiveVisualization()}),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.startSingleNoteVisualization(e):this.stopLiveVisualization()}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{this.isPlaybackActive&&e&&e.some(s=>this.liveWaveforms.has(s))&&T.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",e,"waveform")}),T.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),T.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(e){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(e),this.updateContainerState(!0),this.animateLiveWaveforms(),T.debug("DynamicWaveformVisualizer",`Started single note visualization for ${e}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1,this.liveAnalysers.forEach((e,s)=>{window.synthEngine&&window.synthEngine.removeWaveformAnalyzer(s)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),T.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(e){var i;const s=(i=this.canvas)==null?void 0:i.parentElement;s&&(e?(s.classList.add("live-mode"),u.state.isPlaying&&!u.state.isPaused&&s.classList.add("pulsing")):s.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const e=window.synthEngine;if(!e){T.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(i=>{const a=e.createWaveformAnalyzer(i);a&&(this.liveAnalysers.set(i,a),this.liveWaveforms.set(i,new Float32Array(1024)),T.debug("DynamicWaveformVisualizer",`Created analyser for ${i}`,null,"waveform"))})}setupSingleAnalyser(e){const s=window.synthEngine;if(!s)return;const i=s.createWaveformAnalyzer(e);i&&(this.liveAnalysers.set(e,i),this.liveWaveforms.set(e,new Float32Array(1024)),T.debug("DynamicWaveformVisualizer",`Created single analyser for ${e}`,null,"waveform"))}getActivePlayingColors(){const e=new Set;u.state.isPlaying&&u.state.placedNotes.forEach(i=>{!i.isDrum&&i.color&&e.add(i.color)}),e.size===0&&this.currentColor&&e.add(this.currentColor);const s=Array.from(e);return T.debug("DynamicWaveformVisualizer","Active playing colors detected",s,"waveform"),s}animateLiveWaveforms(){if(!this.isPlaybackActive)return;this.frameSkipCounter++;const e=Math.floor(100/this.animationSpeed);if(this.frameSkipCounter%e!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((s,i)=>{const a=s.getValue();this.liveWaveforms.set(i,a)}),this.onWaveformUpdate&&this.onWaveformUpdate(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(e,s,i){const a=Array.from(this.liveWaveforms.keys());if(a.length===1){const r=a[0],c=this.liveWaveforms.get(r);this.drawSingleLiveWaveform(c,r,e,s,i)}else a.length>1&&a.forEach((r,c)=>{const h=this.liveWaveforms.get(r);this.drawLayeredLiveWaveform(h,r,e,s,i,a.length)})}drawSingleLiveWaveform(e,s,i,a,r){if(!e||e.length===0)return;let c=r,h=1;window.animationEffectsManager&&s&&(h=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s),c=c*h);let m=0;if(window.animationEffectsManager&&window.animationEffectsManager.vibratoCanvasEffect){const x=window.animationEffectsManager.vibratoCanvasEffect,A=x.animations.get(s);A&&x.shouldBeRunning()&&(m=Math.sin(A.phase)*A.amplitude*.4)}let f=0;for(let x=0;x<e.length;x++)f=Math.max(f,Math.abs(e[x]));const g=f>1?1/f:1;this.ctx.strokeStyle=s,this.ctx.lineWidth=2,this.ctx.beginPath();const w=e.length/i*(1+m);for(let x=0;x<i;x++){const A=m*i*.3,P=x+A,M=Math.floor(P*w),I=Math.max(0,Math.min(e.length-1,M)),D=(e[I]||0)*g,R=a-D*c;x===0?this.ctx.moveTo(x,R):this.ctx.lineTo(x,R)}this.ctx.stroke(),T.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${s} with tremolo and vibrato stretch`,{tremoloMultiplier:c/r,vibratoStretch:m},"waveform")}drawLayeredLiveWaveform(e,s,i,a,r,c){if(!e||e.length===0)return;let h=r;if(window.animationEffectsManager&&s){const P=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s);h=h*P}let m=0;if(window.animationEffectsManager&&window.animationEffectsManager.vibratoCanvasEffect){const P=window.animationEffectsManager.vibratoCanvasEffect,M=P.animations.get(s);M&&P.shouldBeRunning()&&(m=Math.sin(M.phase)*M.amplitude*.4)}let f=0;for(let P=0;P<e.length;P++)f=Math.max(f,Math.abs(e[P]));const g=f>1?1/f:1,b=Math.max(.4,1/c),w=Vs(s,b*2);Vs(s,b*.5),this.ctx.strokeStyle=w,this.ctx.lineWidth=1.5,this.ctx.beginPath();const A=e.length/i*(1+m);for(let P=0;P<i;P++){const M=m*i*.3,I=P+M,D=Math.floor(I*A),R=Math.max(0,Math.min(e.length-1,D)),H=(e[R]||0)*g,j=a-H*h*.7;P===0?this.ctx.moveTo(P,j):this.ctx.lineTo(P,j)}this.ctx.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),T.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}T.moduleLoaded("StaticWaveformVisualizer");class C_{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.animationFrameId=null,this.waveformData=new Float32Array(512),this.isInitialized=!1,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=300,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null,this.dynamicVisualizer=new S_,this.animationSpeed=100,this.frameSkipCounter=0,T.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){var s;if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;this.ctx=this.canvas.getContext("2d"),this.currentColor=((s=u.state.selectedNote)==null?void 0:s.color)||"#4a90e2";const e=this.canvas.parentElement;return e&&new ResizeObserver(()=>this.resize()).observe(e),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const e=this.canvas.parentElement;if(!e)return;const{clientWidth:s,clientHeight:i}=e,a=this.canvas.width,r=this.canvas.height;if((s===0||i===0)&&this.canvas.width>0&&this.canvas.height>0)return;const h=Math.abs(s-a),m=Math.abs(i-r);(h>2||m>2)&&(this.canvas.width=s,this.canvas.height=i,this.draw())}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.generateWaveform())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.generateWaveform()}),u.on("waveformExtendedViewChanged",e=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>{this.resize()},100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const e=document.querySelectorAll(".waveform-speed-btn");e.forEach(s=>{s.addEventListener("click",()=>{const i=parseInt(s.dataset.speed);s.classList.contains("active")?(s.classList.remove("active"),this.setAnimationSpeed(100)):(e.forEach(a=>a.classList.remove("active")),s.classList.add("active"),this.setAnimationSpeed(i))})})}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(e)}setupExtendToggle(){const e=document.getElementById("waveform-extend-toggle");e&&(e.addEventListener("click",()=>{u.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const e=document.getElementById("waveform-extend-toggle");if(e){const s=u.state.waveformExtendedView;e.classList.toggle("extended",s),e.textContent=s?"480° View":"360° View",e.title=s?"Switch to 360° waveform view":"Switch to 480° waveform view (shows extra 120°)"}}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const e=u.state.timbres[this.currentColor];if(!e||!e.coeffs)return;const s=Or(this.currentColor),i=e.phases||[],a=this.waveformData.length,r=1,c=[];for(let m=0;m<s.length;m++)s[m]>.001&&c.push(`${m===0?"F0":"H"+(m+1)}: ${s[m].toFixed(3)}`);this.waveformData.fill(0);let h=0;for(let m=0;m<a;m++){const g=(u.state.waveformExtendedView?480:360)/360,b=m/a*g*2*Math.PI;let w=0;for(let x=0;x<ao;x++){const A=s[x]||0;if(A>.001){const P=i[x]||0,M=x+1;w+=A*Math.sin(M*b+P)}}this.waveformData[m]=w*r,h=Math.max(h,Math.abs(w*r))}if(this.calculatedAmplitude=Math.min(1,h),h>1){const m=1/h;for(let f=0;f<this.waveformData.length;f++)this.waveformData[f]*=m}this.draw()}startPhaseTransition(e,s,i){this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(s),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition()}generateTargetWaveform(e){if(!this.currentColor)return;const s=u.state.timbres[this.currentColor];if(!s||!s.coeffs)return;const i=Or(this.currentColor),a=this.waveformData.length,r=1;this.waveformData.fill(0);let c=0;for(let h=0;h<a;h++){const f=(u.state.waveformExtendedView?480:360)/360,g=h/a*f*2*Math.PI;let b=0;for(let w=0;w<ao;w++){const x=i[w]||0;if(x>.001){const A=e[w]||0,P=w+1;b+=x*Math.sin(P*g+A)}}this.waveformData[h]=b*r,c=Math.max(c,Math.abs(b*r))}if(this.calculatedAmplitude=Math.min(1,c),c>1){const h=1/c;for(let m=0;m<this.waveformData.length;m++)this.waveformData[m]*=h}}animateTransition(){if(!this.isTransitioning)return;const e=performance.now()-this.transitionStartTime,s=Math.min(e/this.transitionDuration,1),i=1-Math.pow(1-s,3);for(let a=0;a<this.waveformData.length;a++)this.waveformData[a]=this.fromWaveform[a]+(this.toWaveform[a]-this.fromWaveform[a])*i;this.draw(),s>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let e=0;for(let s=0;s<this.waveformData.length;s++)e=Math.max(e,Math.abs(this.waveformData[s]));if(e>0){const s=.9/e;for(let i=0;i<this.waveformData.length;i++)this.waveformData[i]*=s}}draw(){if(!this.ctx||!this.canvas)return;const{width:e,height:s}=this.canvas,i=s/2,a=s/2;this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,e,s),this.drawGrid(e,s,i,a),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(e,i,a):this.drawWaveform(e,i,a),e>200&&s>100&&this.drawLabels(e,s)}drawGrid(e,s,i,a){this.ctx.strokeStyle="#ced4da",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(e,i),this.ctx.stroke();const r=u.state.waveformExtendedView?480:360;if((u.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(g=>{const b=e/r*g;this.ctx.beginPath(),this.ctx.moveTo(b,0),this.ctx.lineTo(b,s),this.ctx.stroke()}),u.state.waveformExtendedView){const g=e/480*360;this.ctx.fillStyle="rgba(128, 128, 128, 0.15)",this.ctx.fillRect(g,0,e-g,s)}[.5].forEach(g=>{const b=i-a*g,w=i+a*g;this.ctx.beginPath(),this.ctx.moveTo(0,b),this.ctx.lineTo(e,b),this.ctx.moveTo(0,w),this.ctx.lineTo(e,w),this.ctx.stroke()}),this.ctx.setLineDash([]),this.ctx.strokeStyle="#999999",this.ctx.lineWidth=1;const m=i-a,f=i+a;this.ctx.beginPath(),this.ctx.moveTo(0,m),this.ctx.lineTo(e,m),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,f),this.ctx.lineTo(e,f),this.ctx.stroke()}drawWaveform(e,s,i){if(this.waveformData.length===0)return;const a=this.currentColor||"#4A90E2";this.ctx.strokeStyle=a,this.ctx.lineWidth=2,this.ctx.beginPath();const r=this.waveformData.length/e;for(let h=0;h<e;h++){const m=Math.floor(h*r),f=this.waveformData[m]||0,g=s-f*i;h===0?this.ctx.moveTo(h,g):this.ctx.lineTo(h,g)}this.ctx.stroke(),this.ctx.lineTo(e,s),this.ctx.lineTo(0,s),this.ctx.closePath();const c=this.ctx.createLinearGradient(0,s-i,0,s+i);c.addColorStop(0,Vs(a,.3)),c.addColorStop(.5,Vs(a,.1)),c.addColorStop(1,Vs(a,.3)),this.ctx.fillStyle=c,this.ctx.fill()}drawLabels(e,s){this.ctx.fillStyle="#666666",this.ctx.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.ctx.textAlign="center";const i=u.state.waveformExtendedView?480:360,a=u.state.waveformExtendedView?["0°","90°","180°","270°","360°","450°"]:["0°","90°","180°","270°","360°"],r=u.state.waveformExtendedView?[0,90,180,270,360,450]:[0,90,180,270,360];a.forEach((c,h)=>{const m=e/i*r[h]+10;this.ctx.fillText(c,m,s/2+4)}),this.ctx.textAlign="left",this.ctx.fillText("+1.0",5,15),this.ctx.fillText("-1.0",5,s-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const e=this.calculatedAmplitude||0;if(window.animationEffectsManager&&this.currentColor){const s=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor);return e*s}return e}startSingleNoteVisualization(e){return this.dynamicVisualizer.startSingleNoteVisualization(e)}stopLiveVisualization(){return this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){return this.dynamicVisualizer.startLiveVisualization()}dispose(){this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const fm=new C_;window.staticWaveformVisualizer=fm;function T_(){return fm.initialize()}class gm{constructor(e){this.effectName=e,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,T.info(`${e}AnimationEffect`,"Base initialized",null,"animation")}initBase(){u.on("visualEffectChanged",({effectType:e,parameter:s,value:i,color:a,effectParams:r})=>{e===this.effectName.toLowerCase()&&this.updateAnimationParameters(a,r)}),u.on("playbackStarted",()=>{this.isPlaybackActive=!0,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteInteractionStart",({noteId:e,color:s})=>this.onNoteInteractionStart(e,s)),u.on("noteInteractionEnd",({noteId:e})=>this.onNoteInteractionEnd(e)),u.on("ghostNoteUpdated",({color:e})=>this.onGhostNoteUpdated(e)),u.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.isPlaybackActive=!0:this.isPlaybackActive=!1,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteAttack",({noteId:e,color:s})=>this.onNoteAttack(e,s)),u.on("noteRelease",({noteId:e,color:s})=>this.onNoteRelease(e,s)),u.on("effectDialInteractionStart",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionStart(s)}),u.on("effectDialInteractionEnd",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionEnd(s)}),T.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}updateAnimationParameters(e,s){throw new Error("updateAnimationParameters must be implemented by subclass")}updateAnimationPhases(e){throw new Error("updateAnimationPhases must be implemented by subclass")}shouldAnimateColor(e){return!!this.animations.get(e)}shouldAnimateNote(e){if(!this.shouldAnimateColor(e.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const i=this.activeNoteAnimations.get("dial-preview");if(e.color===i)return!0}return!!(this.isPlaybackActive&&e.uuid&&this.activeSoundingNotes.has(e.uuid)||this.hasActiveInteraction&&e.uuid&&this.activeNoteAnimations.has(e.uuid)||!e.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===e.color&&this.isPlaybackActive)}shouldBeRunning(){const e=this.animations.size>0;return e?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||e:!1}onNoteInteractionStart(e,s){this.shouldAnimateColor(s)&&(this.activeNoteAnimations.set(e,s),this.hasActiveInteraction=!0,T.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${e} (${s})`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteInteractionEnd(e){this.activeNoteAnimations.delete(e),this.hasActiveInteraction=this.activeNoteAnimations.size>0,T.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onGhostNoteUpdated(e){this.shouldAnimateColor(e)?(this.ghostNoteAnimation={color:e,active:!0},T.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${e}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,T.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(e,s){this.shouldAnimateColor(s)&&(this.activeSoundingNotes.set(e,s),T.debug(`${this.effectName}AnimationEffect`,`Note attack: ${e} (${s}) added to active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteRelease(e,s){this.activeSoundingNotes.delete(e),T.debug(`${this.effectName}AnimationEffect`,`Note release: ${e} (${s}) removed from active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onDialInteractionStart(e){this.shouldAnimateColor(e)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",e),T.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onDialInteractionEnd(e){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),T.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}getActiveColors(){const e=new Set;for(const[s,i]of this.activeSoundingNotes.entries())this.shouldAnimateColor(i)&&e.add(i);for(const[s,i]of this.activeNoteAnimations.entries())this.shouldAnimateColor(i)&&e.add(i);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&e.add(this.ghostNoteAnimation.color),Array.from(e)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,T.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}}T.moduleLoaded("VibratoCanvasEffect");class A_ extends gm{constructor(){super("Vibrato"),T.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),T.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(e,s){const{speed:i,span:a}=s;if(i===0||a===0)this.animations.delete(e),T.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${e}`,null,"animation");else{const r=this.animations.get(e),c=i/100*16,h=a/100*.5,m={frequency:c,amplitude:h,phase:(r==null?void 0:r.phase)||0,lastUpdate:performance.now()};this.animations.set(e,m),T.debug("VibratoCanvasEffect",`Updated vibrato animation for ${e}`,{frequency:c,amplitude:h,preservedPhase:!!r},"animation")}}updateAnimationPhases(e){this.animations.forEach((s,i)=>{const a=(e-s.lastUpdate)/1e3;s.phase+=s.frequency*a*2*Math.PI,s.lastUpdate=e,s.phase>4*Math.PI&&(s.phase-=4*Math.PI)})}getVibratoYOffset(e){const s=this.animations.get(e);if(!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning())return 0;const i=Math.sin(s.phase),a=-i*s.amplitude;return console.log("Visual vibrato | sine:",i.toFixed(3),"offset (negated):",a.toFixed(3),"phase:",s.phase.toFixed(3)),a}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.amplitude>0:!1}dispose(){this.disposeBase(),T.info("VibratoCanvasEffect","Disposed",null,"animation")}}T.moduleLoaded("TremoloWaveformEffect");class M_ extends gm{constructor(){super("Tremolo"),T.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),T.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(e,s){var r;const{speed:i,span:a}=s;if(i===0||a===0)this.animations.delete(e),T.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${e}`,null,"animation");else{const c=this.animations.get(e),h=i/100*16,m=a/100,f={frequency:h,span:m,phase:(c==null?void 0:c.phase)||0,lastUpdate:(r=window.Tone)!=null&&r.now?window.Tone.now()*1e3:performance.now()};this.animations.set(e,f),T.debug("TremoloWaveformEffect",`Updated tremolo animation for ${e}`,{frequency:h,span:m,preservedPhase:!!c},"animation")}}updateAnimationPhases(e){var a,r,c;let s=0;const i=(a=window.Tone)!=null&&a.now?window.Tone.now()*1e3:e;if(this.animations.forEach((h,m)=>{const f=(i-h.lastUpdate)/1e3,g=h.phase;h.phase+=h.frequency*f*2*Math.PI,h.lastUpdate=i,s++,Math.abs(h.phase-g)<.001&&T.warn("TremoloWaveformEffect",`Phase not advancing for ${m}`,{deltaSeconds:Number(f.toFixed(4)),frequency:h.frequency},"animation"),h.phase>4*Math.PI&&(h.phase-=4*Math.PI)}),s>0&&Math.random()<.05){const h=(r=window.Tone)!=null&&r.now?"Tone.js":"performance";T.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!((c=window.Tone)!=null&&c.now),toneTime:i,currentTime:e,timingSource:h},"animation")}}getTremoloAmplitudeMultiplier(e){var A,P;const s=this.animations.get(e);if(!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const i=((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)||1,a=Math.sin(s.phase),r=s.span,c=i,h=i*(1-r),m=(c+h)/2,f=(c-h)/2,b=(m+a*f)/i,x=(((P=window.Tone)==null?void 0:P.now())*1e3||performance.now())-s.lastUpdate;if(x>100&&s.span>0){const M=s.frequency*(x/1e3)*2*Math.PI;M>.1&&T.warn("TremoloWaveformEffect",`Phase stagnation detected for ${e}`,{phase:Number(s.phase.toFixed(3)),millisecondsSinceUpdate:Number(x.toFixed(1)),expectedAdvancement:Number(M.toFixed(3))},"animation")}return Math.max(0,Math.min(1,b))}getADSRTremoloAmplitudeMultiplier(e){return this.getTremoloAmplitudeMultiplier(e)}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.span>0:!1}dispose(){this.disposeBase(),T.info("TremoloWaveformEffect","Disposed",null,"animation")}}T.moduleLoaded("EnvelopeFillEffect");class E_{constructor(){this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),T.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){u.on("noteAttack",({noteId:e,color:s})=>{const i=u.state.timbres[s];if(!i){console.warn("[ENVELOPE FILL] ⚠️ No timbre found for color:",s);return}this.activeFills.set(e,{fillLevel:0,color:s,startTime:Q.now(),adsr:i.adsr,phase:"attack"}),T.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteRelease",({noteId:e,color:s})=>{const i=this.activeFills.get(e);i?(i.phase="release",i.releaseStartTime=Q.now(),i.releaseStartLevel=i.fillLevel,T.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):console.warn("[ENVELOPE FILL] ⚠️ No fill data found for release:",e)}),u.on("playbackStopped",()=>{this.activeFills.clear(),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState(),u.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),T.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(e){const s=Q.now();for(const[i,a]of this.activeFills.entries()){const{adsr:r,startTime:c,phase:h,releaseStartTime:m,releaseStartLevel:f}=a,g=s-c;if(h==="attack"){const b=r.attack||.01;g<b?a.fillLevel=g/b:(a.phase="decay",a.decayStartTime=s)}else if(h==="decay"){const b=r.decay||.1,w=s-a.decayStartTime,x=r.sustain!==void 0?r.sustain:.5;if(w<b){const A=w/b;a.fillLevel=1-A*(1-x)}else a.phase="sustain",a.fillLevel=x}else if(h==="sustain"){const b=r.sustain!==void 0?r.sustain:.5;a.fillLevel=b}else if(h==="release"){const b=r.release||.5,w=s-m;if(w<b){const x=w/b;a.fillLevel=f*(1-x)}else this.activeFills.delete(i),T.debug("EnvelopeFillEffect",`Completed fill animation for note ${i}`,null,"animation"),this.activeFills.size===0&&window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}}}getFillLevel(e){if(!e.uuid)return 0;const s=this.activeFills.get(e.uuid);return s?s.fillLevel:0}shouldFillNote(e){return e.uuid?this.activeFills.has(e.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),T.info("EnvelopeFillEffect","Disposed",null,"animation")}}T.moduleLoaded("AnimationEffectsManager");class P_{constructor(){this.vibratoEffect=new A_,this.tremoloEffect=new M_,this.envelopeFillEffect=new E_,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,T.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),u.on("visualEffectChanged",({effectType:e,parameter:s,value:i,color:a})=>{(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),T.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(e){this.isRunning&&(this.lastTime=e,this.vibratoEffect.updateAnimationPhases(e),this.tremoloEffect.updateAnimationPhases(e),this.envelopeFillEffect.updateAnimationPhases(e),this.triggerVisualUpdates(e),this.animationFrameId=requestAnimationFrame(s=>this.animate(s)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)),T.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),T.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const s=this.tremoloEffect.activeSoundingNotes.size>0,i=this.tremoloEffect.hasDialInteraction;return s||i}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const e=this.shouldVibratoBeRunning(),s=this.shouldTremoloBeRunning(),i=this.shouldEnvelopeFillBeRunning(),a=e||s||i;a&&!this.isRunning?this.start():!a&&this.isRunning&&this.stop()}triggerVisualUpdates(e){if(!this.lastRenderTrigger||e-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=e;const s=this.vibratoEffect.getActiveColors(),i=this.tremoloEffect.getActiveColors(),a=this.envelopeFillEffect.activeFills.size>0;(s.length>0||a)&&u.emit("animationUpdate",{type:s.length>0?"vibrato":"envelopeFill",activeColors:s,hasEnvelopeFills:a}),i.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:i})}}triggerFinalUpdates(){const e=Array.from(this.vibratoEffect.animations.keys());e.length>0&&u.emit("animationUpdate",{type:"vibrato",activeColors:e});const s=Array.from(this.tremoloEffect.animations.keys());s.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:s})}shouldAnimateNote(e){return this.vibratoEffect.shouldAnimateNote(e)}getVibratoYOffset(e){return this.vibratoEffect.getVibratoYOffset(e)}getTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getTremoloAmplitudeMultiplier(e)}getADSRTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(e)}getFillLevel(e){return this.envelopeFillEffect.getFillLevel(e)}shouldFillNote(e){return this.envelopeFillEffect.shouldFillNote(e)}triggerTremoloAmplitudeUpdate(){const e=this.tremoloEffect.getActiveColors();e.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:e})}getAllActiveColors(){const e=this.vibratoEffect.getActiveColors(),s=this.tremoloEffect.getActiveColors();return[...new Set([...e,...s])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),T.info("AnimationEffectsManager","Disposed",null,"animation")}}const Yd=new P_;T.moduleLoaded("VibratoAudioEffect");class k_{constructor(){this.currentSettings=new Map,T.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return T.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:i,span:a}=e;this.currentSettings.set(s,{speed:i,span:a}),T.debug("VibratoAudioEffect",`Updated parameters for ${s}`,{speed:i,span:a},"audio")}applyToVoice(e,s){if(!e||!e._setVibrato)return;const i=this.currentSettings.get(s);if(!i){T.debug("VibratoAudioEffect",`No vibrato settings found for color ${s}`,null,"audio");return}try{e._setVibrato(i),e.vibratoApplied=!0,T.debug("VibratoAudioEffect",`Applied vibrato to voice for ${s}`,i,"audio")}catch(a){T.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${s}`,a,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createVibratoSettings(e,s){if(e===0||s===0)return null;const i=e/100*16,a=s/100*50;return{frequency:i,depth:a}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),T.info("VibratoAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("TremoloAudioEffect");class I_{constructor(){this.currentSettings=new Map,T.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return T.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:i,span:a}=e;this.currentSettings.set(s,{speed:i,span:a}),T.debug("TremoloAudioEffect",`Updated parameters for ${s}`,{speed:i,span:a},"audio")}applyToVoice(e,s){if(!e||!e._setTremolo)return;const i=this.currentSettings.get(s);if(!i){T.debug("TremoloAudioEffect",`No tremolo settings found for color ${s}`,null,"audio");return}try{e._setTremolo(i),e.tremoloApplied=!0,T.debug("TremoloAudioEffect",`Applied tremolo to voice for ${s}`,i,"audio")}catch(a){T.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${s}`,a,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createTremoloSettings(e,s){if(e===0||s===0)return null;const i=e/100*16,a=s/100;return{frequency:i,depth:a}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),T.info("TremoloAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("ReverbAudioEffect");class R_{constructor(){this.currentSettings=new Map,this.reverbInstances=new Map,T.info("ReverbAudioEffect","Initialized",null,"audio")}init(){return T.info("ReverbAudioEffect","Ready for audio processing",null,"audio"),!0}async updateParameters(e,s){const{decay:i,roomSize:a,wet:r=10}=e;this.currentSettings.set(s,{decay:i,roomSize:a,wet:r}),T.debug("ReverbAudioEffect",`Updated parameters for ${s}`,{decay:i,roomSize:a,wet:r},"audio");let c=this.reverbInstances.get(s);c?this.updateReverbInstance(c,i,a,r):(i>0||a>0)&&(c=await this.createReverbInstance(i,a,r),c&&(this.reverbInstances.set(s,c),T.debug("ReverbAudioEffect",`Created new reverb instance for ${s}`,{decay:i,roomSize:a,wet:r},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}async applyToVoice(e,s){if(!e)return;const i=this.currentSettings.get(s);if(!(!i||i.decay===0&&i.roomSize===0))try{let a=this.reverbInstances.get(s);if(a||(a=await this.createReverbInstance(i.decay,i.roomSize,i.wet),this.reverbInstances.set(s,a)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(a)}catch{e.output&&e.output.connect(a)}T.debug("ReverbAudioEffect",`Applied reverb to voice for ${s}`,i,"audio")}catch(a){T.warn("ReverbAudioEffect",`Failed to apply reverb to voice for ${s}`,a,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{decay:0,roomSize:0}}getEffectInstance(e){return this.getCurrentSettings(e).wet>0?this.reverbInstances.get(e):null}async createReverbInstance(e,s,i=10){if(e===0&&s===0)return null;const a=Math.max(.1,e/100*8),r=1+s/100*1.5,c=a*r,h=i/100,m=new Q.Reverb({decay:c,wet:h});return m._wetAmount=h,await m.ready,T.debug("ReverbAudioEffect","Created reverb instance",{decayTime:c,wetAmount:h,roomSize:s},"audio"),m}updateReverbInstance(e,s,i,a=10){if(e)try{const r=Math.max(.1,s/100*8),c=1+i/100*1.5,h=r*c,m=a/100;e.decay=h,e._crossFade&&(e._crossFade.fade.value=m),e._wetAmount=m,T.debug("ReverbAudioEffect","Updated reverb instance",{decayTime:h,wetAmount:m,roomSize:i},"audio")}catch(r){T.warn("ReverbAudioEffect","Failed to update reverb instance",r,"audio")}}createReverbSettings(e,s,i=25){if(e===0&&s===0)return null;const a=Math.max(.1,e/100*10),r=i/100;return{decay:a,roomSize:s/100,wet:r}}disableForColor(e){this.updateParameters({decay:0,roomSize:0,wet:0},e);const s=this.reverbInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.reverbInstances.delete(e))}dispose(){this.reverbInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(i){T.warn("ReverbAudioEffect",`Failed to dispose reverb for ${s}`,i,"audio")}}),this.currentSettings.clear(),this.reverbInstances.clear(),T.info("ReverbAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("DelayAudioEffect");class D_{constructor(){this.currentSettings=new Map,this.delayInstances=new Map,T.info("DelayAudioEffect","Initialized",null,"audio")}init(){return T.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{time:i,feedback:a,wet:r=15}=e;this.currentSettings.set(s,{time:i,feedback:a,wet:r}),T.debug("DelayAudioEffect",`Updated parameters for ${s}`,{time:i,feedback:a,wet:r},"audio");let c=this.delayInstances.get(s);c?this.updateDelayInstance(c,i,a,r):(i>0||a>0)&&(c=this.createDelayInstance(i,a,r),c&&(this.delayInstances.set(s,c),T.debug("DelayAudioEffect",`Created new delay instance for ${s}`,{time:i,feedback:a,wet:r},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}applyToVoice(e,s){if(!e)return;const i=this.currentSettings.get(s);if(!(!i||i.time===0&&i.feedback===0))try{let a=this.delayInstances.get(s);if(a||(a=this.createDelayInstance(i.time,i.feedback,i.wet),this.delayInstances.set(s,a)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(a)}catch{e.output&&e.output.connect(a)}T.debug("DelayAudioEffect",`Applied delay to voice for ${s}`,i,"audio")}catch(a){T.warn("DelayAudioEffect",`Failed to apply delay to voice for ${s}`,a,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{time:0,feedback:0}}getEffectInstance(e){const s=this.getCurrentSettings(e);return s.time>0&&s.wet>0?this.delayInstances.get(e):null}createDelayInstance(e,s,i=30){if(e===0&&s===0)return null;const a=Math.max(.01,e/100*.5),r=Math.min(.95,s/100),c=i/100,h=new Q.FeedbackDelay({delayTime:a,feedback:r,wet:c});return h._wetAmount=c,T.debug("DelayAudioEffect","Created delay instance",{delayTime:a,feedbackAmount:r,wetAmount:c},"audio"),h}updateDelayInstance(e,s,i,a=15){if(e)try{const r=Math.max(.01,s/100*.5),c=Math.min(.95,i/100),h=a/100;e.delayTime.value=r,e.feedback.value=c,e._crossFade&&(e._crossFade.fade.value=h),e._wetAmount=h,T.debug("DelayAudioEffect","Updated delay instance",{delayTime:r,feedbackAmount:c,wetAmount:h},"audio")}catch(r){T.warn("DelayAudioEffect","Failed to update delay instance",r,"audio")}}createDelaySettings(e,s,i=30){if(e===0&&s===0)return null;const a=Math.max(.01,e/100*.5),r=Math.min(.95,s/100),c=i/100;return{delayTime:a,feedback:r,wet:c}}disableForColor(e){this.updateParameters({time:0,feedback:0,wet:0},e);const s=this.delayInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.delayInstances.delete(e))}dispose(){this.delayInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(i){T.warn("DelayAudioEffect",`Failed to dispose delay for ${s}`,i,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),T.info("DelayAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("AudioEffectsManager");class O_{constructor(){this.vibratoEffect=new k_,this.tremoloEffect=new I_,this.reverbEffect=new R_,this.delayEffect=new D_,T.info("AudioEffectsManager","Initialized with audio effect handlers",null,"audio")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.reverbEffect.init(),this.delayEffect.init(),u.on("audioEffectChanged",({effectType:e,parameter:s,value:i,color:a,effectParams:r})=>{this.handleAudioEffectChange(e,s,i,a,r)}),T.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(e,s,i,a,r){switch(T.debug("AudioEffectsManager",`Processing audio effect: ${e}.${s} = ${i} for ${a}`,null,"audio"),e){case"vibrato":this.vibratoEffect.updateParameters(r,a);break;case"tremolo":this.tremoloEffect.updateParameters(r,a);break;case"reverb":this.reverbEffect.updateParameters(r,a);break;case"delay":this.delayEffect.updateParameters(r,a);break;default:T.debug("AudioEffectsManager",`Effect type ${e} not handled by audio system`,null,"audio")}}getEffectHandler(e){switch(e){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"reverb":return this.reverbEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(e,s,i){const a=this.reverbEffect.getEffectInstance(s),r=this.delayEffect.getEffectInstance(s);this.reverbEffect.getCurrentSettings(s),this.delayEffect.getCurrentSettings(s);try{e.disconnect()}catch{}let c=e;if(a)try{a.disconnect(),c.connect(a),c=a}catch{}if(r)try{r.disconnect(),c.connect(r),c=r}catch{}try{if(c.connect(i),window.synthEngine){const h=window.synthEngine.getWaveformAnalyzer(s);h&&e.connect(h)}}catch{}}applyEffectsToVoice(e,s){this.vibratoEffect.applyToVoice(e,s),this.tremoloEffect.applyToVoice(e,s)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.reverbEffect.dispose(),this.delayEffect.dispose(),T.info("AudioEffectsManager","Disposed",null,"audio")}}const Zd=new O_;T.moduleLoaded("EffectsCoordinator");class N_{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0},tremolo:{speed:0,span:0},reverb:{decay:0,roomSize:0},delay:{time:0,feedback:0}},T.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(u.state.timbres).forEach(e=>{this.initializeColorEffects(e)}),u.on("timbreCreated",({color:e})=>{this.initializeColorEffects(e)}),this.loadSavedValues(),T.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(e){if(!this.effectParameters.has(e)){const s={};Object.entries(this.defaultEffects).forEach(([a,r])=>{s[a]={...r}}),this.effectParameters.set(e,s);const i=u.state.timbres[e];i&&(i.vibrato&&(s.vibrato={...i.vibrato}),i.tremelo&&(s.tremolo={...i.tremelo})),T.debug("EffectsCoordinator",`Initialized effects for color ${e}`,s,"effects")}}updateParameter(e,s,i,a){if(!a){T.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:e,parameter:s,value:i},"effects");return}this.initializeColorEffects(a);const r=this.effectParameters.get(a);r[e]||(r[e]={...this.defaultEffects[e]}),r[e][s],r[e][s]=i,this.notifyAudioSystem(e,s,i,a,r[e]),this.notifyAnimationSystem(e,s,i,a,r[e]),this.updateTimbreState(e,r[e],a),this.saveValues()}notifyAudioSystem(e,s,i,a,r){u.emit("audioEffectChanged",{effectType:e,parameter:s,value:i,color:a,effectParams:{...r}}),T.debug("EffectsCoordinator",`Notified audio system: ${e}.${s} = ${i} for ${a}`,null,"effects")}notifyAnimationSystem(e,s,i,a,r){(e==="vibrato"||e==="tremolo")&&(u.emit("visualEffectChanged",{effectType:e,parameter:s,value:i,color:a,effectParams:{...r}}),T.debug("EffectsCoordinator",`Notified animation system: ${e}.${s} = ${i} for ${a}`,null,"effects"))}updateTimbreState(e,s,i){const a=u.state.timbres[i];if(!a)return;const c={vibrato:"vibrato",tremolo:"tremelo"}[e];c&&(a[c]||(a[c]={}),Object.assign(a[c],s),u.recordState())}getEffectParameters(e,s){const i=this.effectParameters.get(e);return!i||!i[s]?{...this.defaultEffects[s]}:{...i[s]}}getAllEffectParameters(e){const s=this.effectParameters.get(e);return s?{...s}:{...this.defaultEffects}}resetColorEffects(e){const s={};Object.entries(this.defaultEffects).forEach(([i,a])=>{s[i]={...a}}),this.effectParameters.set(e,s),Object.keys(s).forEach(i=>{Object.keys(s[i]).forEach(a=>{this.notifyAudioSystem(i,a,s[i][a],e,s[i]),this.notifyAnimationSystem(i,a,s[i][a],e,s[i])})}),T.info("EffectsCoordinator",`Reset all effects for color ${e}`,s,"effects")}saveValues(){const e={};Object.keys(u.state.timbres).forEach(s=>{const i=this.effectParameters.get(s);i&&(e[s]={vibrato:i.vibrato||{speed:0,span:0},tremelo:i.tremolo||{speed:0,span:0},reverb:i.reverb||{decay:0,roomSize:0},delay:i.delay||{time:0,feedback:0}})});try{localStorage.setItem("effectDialValues",JSON.stringify(e)),T.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(s){T.warn("EffectsCoordinator","Failed to save effect values to localStorage",s,"effects")}}loadSavedValues(){try{const e=localStorage.getItem("effectDialValues");if(!e){T.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const s=JSON.parse(e);T.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(s).forEach(i=>{const a=u.state.timbres[i],r=s[i];a&&r&&(r.vibrato&&Object.entries(r.vibrato).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("vibrato",c,h,i)}),r.tremelo&&Object.entries(r.tremelo).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("tremolo",c,h,i)}),r.reverb&&Object.entries(r.reverb).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("reverb",c,h,i)}),r.delay&&Object.entries(r.delay).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("delay",c,h,i)}))}),T.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(s).forEach(i=>{const a=s[i];(a.reverb&&(a.reverb.decay>0||a.reverb.roomSize>0)||a.delay&&(a.delay.time>0||a.delay.feedback>0))&&(window.synthEngine.updateSynthForColor(i),T.debug("EffectsCoordinator",`Re-applied effects to synth for ${i}`,null,"effects"))})}catch(e){T.warn("EffectsCoordinator","Failed to load saved effect values",e,"effects")}}dispose(){this.effectParameters.clear(),T.info("EffectsCoordinator","Disposed",null,"effects")}}const Er=new N_,L_=Object.freeze(Object.defineProperty({__proto__:null,default:Er},Symbol.toStringTag,{value:"Module"}));class F_{constructor(){this.currentEffect=null,this.effectControlsContainer=null,this.effectButtons=[],this.dials=[],this.currentColor=null,this.isDialInteractionActive=!1,this.effectConfigs={reverb:{name:"Reverb",controls:{decay:{label:"Time",min:0,max:100,default:0,unit:"%"},roomSize:{label:"Size",min:0,max:100,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:10,unit:"%"}}},delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}}}init(){return T.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),!this.effectControlsContainer||this.effectButtons.length===0?(T.initFailed("Effects Controller","Required DOM elements not found"),!1):(this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),T.initSuccess("Effects Controller"),!0)}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(e=>{e.addEventListener("click",s=>{const i=s.target.dataset.effect;this.selectEffect(i)})})}selectEffect(e){if(T.debug("Effects",`Selecting effect: ${e}`,null,"ui"),!this.effectConfigs[e]){T.info("Effects",`Effect ${e} not configured`,null,"ui");return}if(this.effectButtons.forEach(s=>{s.classList.remove("active"),s.dataset.effect===e&&s.classList.add("active")}),this.currentEffect===e){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=e,this.showEffectControls(e)}showEffectControls(e){const s=this.effectConfigs[e];if(!s){T.warn("Effects",`No configuration found for effect: ${e}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const i=this.effectControlsContainer.querySelector(".effect-controls");Object.entries(s.controls).forEach(([a,r])=>{const c=this.currentColor?Er.getEffectParameters(this.currentColor,e):null,h=(c==null?void 0:c[a])||0,m=document.createElement("div");m.className="effect-slider-group",m.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",i.appendChild(m);const f=document.createElement("label");f.className="effect-slider-label",f.textContent=r.label,f.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",m.appendChild(f);const g=document.createElement("input");g.type="range",g.min=r.min,g.max=r.max,g.value=h,g.className="effect-slider",g.style.cssText="width: 100%; margin: 5px 0;",m.appendChild(g);const b=document.createElement("div");b.className="effect-slider-value";const w=r.unit?`${Math.round(h)}${r.unit}`:Math.round(h);b.textContent=w,b.style.cssText="text-align: center; font-size: 12px; color: #666;",m.appendChild(b),this.dials.push({dial:{element:g,value:h,destroy:()=>{}},control:a,effectType:e,valueDisplay:b,controlConfig:r});const x=A=>{const P=parseFloat(A.target.value),M=r.unit?`${Math.round(P)}${r.unit}`:Math.round(P);b.textContent=M,T.debug("Effects",`${e} ${a}: ${P}`,null,"audio"),this.onEffectParameterChange(e,a,P)};g.addEventListener("mousedown",A=>{this.onDialInteractionStart(e)}),g.addEventListener("mouseup",A=>{this.onDialInteractionEnd(e)}),g.addEventListener("mouseleave",A=>{A.buttons}),g.addEventListener("touchstart",A=>{this.onDialInteractionStart(e)}),g.addEventListener("touchend",A=>{this.onDialInteractionEnd(e)}),g.addEventListener("input",x),g.addEventListener("change",x)}),this.effectControlsContainer.classList.add("active")}hideEffectControls(){this.clearControls(),this.effectControlsContainer.classList.remove("active"),this.effectControlsContainer.innerHTML="",this.effectButtons.forEach(e=>e.classList.remove("active"))}clearControls(){this.dials.forEach(({dial:e})=>{e.destroy&&e.destroy()}),this.dials=[]}onEffectParameterChange(e,s,i){var r;T.debug("Effects",`Effect parameter changed: ${e}.${s} = ${i}`,null,"audio");const a=(r=u.state.selectedNote)==null?void 0:r.color;if(!a){T.warn("Effects","Cannot update effect parameter: no color selected",{effectType:e,parameter:s,value:i},"audio");return}Er.updateParameter(e,s,i,a),u.emit("effectParameterChanged",{effectType:e,parameter:s,value:i,color:a})}onDialInteractionStart(e){var i;if(this.isDialInteractionActive||e!=="vibrato"&&e!=="tremolo")return;this.isDialInteractionActive=!0;const s=(i=u.state.selectedNote)==null?void 0:i.color;if(!s){T.debug("Effects","Dial interaction started but no color selected",null,"ui");return}u.emit("effectDialInteractionStart",{effectType:e,color:s}),T.debug("Effects",`Dial interaction started for ${e} on ${s}`,null,"ui")}onDialInteractionEnd(e){var i;if(!this.isDialInteractionActive)return;this.isDialInteractionActive=!1;const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&(u.emit("effectDialInteractionEnd",{effectType:e,color:s}),T.debug("Effects",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}getCurrentEffect(){return this.currentEffect}getEffectParameters(e){var a;if(!this.effectConfigs[e])return null;const s=(a=u.state.selectedNote)==null?void 0:a.color;if(!s)return null;if(window.effectsCoordinator)return window.effectsCoordinator.getEffectParameters(s,e);const i={};return this.dials.forEach(({dial:r,control:c,effectType:h})=>{h===e&&(i[c]=parseFloat(r.element.value))}),i}initializeSelectedColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("selectedNoteChanged",()=>{var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s!==this.currentColor&&(this.currentColor=s,this.updateEffectButtonIndicators())}),u.on("audioEffectChanged",()=>{this.updateEffectButtonIndicators()}),this.updateEffectButtonIndicators()}updateEffectButtonIndicators(){!this.effectButtons||!this.currentColor||this.effectButtons.forEach(e=>{const s=e.getAttribute("data-effect");let i=!1;const a=Er.getEffectParameters(this.currentColor,s);switch(s){case"vibrato":i=a.speed>0&&a.span>0;break;case"tremolo":i=a.speed>0&&a.span>0;break;case"reverb":i=a.roomSize>0||a.decay>0||a.wet>0&&(a.roomSize>0||a.decay>0);break;case"delay":i=a.time>0||a.feedback>0||a.wet>0&&(a.time>0||a.feedback>0);break}i?(e.style.backgroundColor=this.currentColor,e.style.color="white",e.classList.add("effect-active")):(e.style.backgroundColor="",e.style.color="",e.classList.remove("effect-active"))})}}const Bn=new F_;class B_{constructor(e,s={}){if(this._root=typeof e=="string"?document.querySelector(e):e,!this._root)throw new Error("Position: target not found");const{size:i=[200,200],mode:a="absolute",x:r=.5,minX:c=0,maxX:h=1,stepX:m=0,y:f=.5,minY:g=0,maxY:b=1,stepY:w=0}=s;this._events=new Map,this._emit=(I,D)=>{const R=this._events.get(I);if(R)for(const H of R)H(D)};class x{constructor(D,R,H,j){this.min=D,this.max=R,this.step=H,this.value=0,this.update(j)}update(D){const R=Math.min(this.max,Math.max(this.min,D));if(!this.step||this.step<=0)return this.value=R,this.value;const H=Math.round((R-this.min)/this.step)*this.step+this.min;return this.value=Math.min(this.max,Math.max(this.min,parseFloat(H.toFixed(12)))),this.value}updateNormal(D){const R=this.max-this.min||1;return this.update(this.min+R*Math.min(1,Math.max(0,D)))}get normalized(){const D=this.max-this.min||1;return(this.value-this.min)/D}}class A{constructor(D,R,H,j){this.mode=D,this.orient=R,this._xr=H.slice(),this._yr=j.slice(),this.value=.5,this._anchorN=.5}resize(D,R){this._xr=D.slice(),this._yr=R.slice()}set anchor(D){this._anchorN=this._posToNorm(D)}update(D){if(this.mode==="absolute")this.value=this._posToNorm(D);else{const R=this._posToNorm(D),H=R-this._anchorN;this.value=P(this.value+H),this._anchorN=R}this.value=P(this.value)}_posToNorm(D){if(this.orient==="horizontal"){const R=this._xr[1]-this._xr[0]||1;return P((D.x-this._xr[0])/R)}else{const R=this._yr[1]-this._yr[0]||1;return P(1-(D.y-this._yr[0])/R)}}}const P=I=>Math.min(1,Math.max(0,I));this._x=new x(c,h,m,r),this._y=new x(g,b,w,f),this._w=Math.max(10,Math.floor(i[0])),this._h=Math.max(10,Math.floor(i[1])),this._mode=a==="relative"?"relative":"absolute",this._hX=new A(this._mode,"horizontal",[0,this._w],[0,this._h]),this._hY=new A(this._mode,"vertical",[0,this._w],[0,this._h]),this._hX.value=this._x.normalized,this._hY.value=this._y.normalized,this._style={bg:"rgba(74, 144, 226, 0.1)",grid:"#dee2e6",cross:"#6c757d",handle:"#4A90E2",text:"#212529"},this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._svg.style.display="block",this._svg.style.touchAction="none",this._root.innerHTML="",this._root.appendChild(this._svg),this._bg=document.createElementNS(this._svg.namespaceURI,"rect"),this._bg.setAttribute("x",0),this._bg.setAttribute("y",0),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h),this._bg.setAttribute("fill",this._style.bg),this._svg.appendChild(this._bg),this._grid=document.createElementNS(this._svg.namespaceURI,"g"),this._grid.setAttribute("stroke",this._style.grid),this._grid.setAttribute("stroke-width","1");const M=[.25,.5,.75];for(const I of M){const D=document.createElementNS(this._svg.namespaceURI,"line");D.setAttribute("x1",this._w*I),D.setAttribute("y1",0),D.setAttribute("x2",this._w*I),D.setAttribute("y2",this._h),this._grid.appendChild(D);const R=document.createElementNS(this._svg.namespaceURI,"line");R.setAttribute("x1",0),R.setAttribute("y1",this._h*I),R.setAttribute("x2",this._w),R.setAttribute("y2",this._h*I),this._grid.appendChild(R)}this._svg.appendChild(this._grid),this._xh=document.createElementNS(this._svg.namespaceURI,"line"),this._yh=document.createElementNS(this._svg.namespaceURI,"line");for(const I of[this._xh,this._yh])I.setAttribute("stroke",this._style.cross),I.setAttribute("stroke-width","2"),this._svg.appendChild(I);this._knob=document.createElementNS(this._svg.namespaceURI,"circle"),this._knob.setAttribute("r",Math.max(4,Math.min(this._w,this._h)*.04)),this._knob.setAttribute("fill",this._style.handle),this._svg.appendChild(this._knob),this._clicked=!1,this._onDown=this._onDown.bind(this),this._onMove=this._onMove.bind(this),this._onUp=this._onUp.bind(this),this._svg.addEventListener("pointerdown",this._onDown),window.addEventListener("pointerup",this._onUp),window.addEventListener("pointercancel",this._onUp),this._draw()}on(e,s){return this._events.has(e)||this._events.set(e,new Set),this._events.get(e).add(s),()=>this.off(e,s)}off(e,s){const i=this._events.get(e);i&&i.delete(s)}get x(){return this._x.value}set x(e){const s=this._x.value;this._x.update(e),this._hX.value=this._x.normalized,this._x.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get y(){return this._y.value}set y(e){const s=this._y.value;this._y.update(e),this._hY.value=this._y.normalized,this._y.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get minX(){return this._x.min}set minX(e){this._x.min=e,this.x=this._x.value}get maxX(){return this._x.max}set maxX(e){this._x.max=e,this.x=this._x.value}get stepX(){return this._x.step}set stepX(e){this._x.step=e,this.x=this._x.value}get minY(){return this._y.min}set minY(e){this._y.min=e,this.y=this._y.value}get maxY(){return this._y.max}set maxY(e){this._y.max=e,this.y=this._y.value}get stepY(){return this._y.step}set stepY(e){this._y.step=e,this.y=this._y.value}get mode(){return this._mode}set mode(e){this._mode=e==="relative"?"relative":"absolute",this._hX.mode=this._mode,this._hY.mode=this._mode}get normalized(){return{x:this._x.normalized,y:this._y.normalized}}resize(e,s){for(this._w=Math.max(10,Math.floor(e)),this._h=Math.max(10,Math.floor(s)),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._hX.resize([0,this._w],[0,this._h]),this._hY.resize([0,this._w],[0,this._h]),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h);this._grid.firstChild;)this._grid.removeChild(this._grid.firstChild);const i=[.25,.5,.75];for(const a of i){const r=document.createElementNS(this._svg.namespaceURI,"line");r.setAttribute("x1",this._w*a),r.setAttribute("y1",0),r.setAttribute("x2",this._w*a),r.setAttribute("y2",this._h),this._grid.appendChild(r);const c=document.createElementNS(this._svg.namespaceURI,"line");c.setAttribute("x1",0),c.setAttribute("y1",this._h*a),c.setAttribute("x2",this._w),c.setAttribute("y2",this._h*a),this._grid.appendChild(c)}this._draw()}destroy(){this._svg.removeEventListener("pointerdown",this._onDown),window.removeEventListener("pointerup",this._onUp),window.removeEventListener("pointercancel",this._onUp),window.removeEventListener("pointermove",this._onMove),this._root&&this._root.contains(this._svg)&&this._root.removeChild(this._svg),this._events.clear()}colorize(e){Object.assign(this._style,e||{}),this._bg.setAttribute("fill",this._style.bg),this._xh.setAttribute("stroke",this._style.cross),this._yh.setAttribute("stroke",this._style.cross),this._knob.setAttribute("fill",this._style.handle),this._label&&this._label.setAttribute("fill",this._style.text),this._grid.setAttribute("stroke",this._style.grid),this._draw()}_localPoint(e){const s=this._svg.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}}_onDown(e){var i,a;(a=(i=this._svg).setPointerCapture)==null||a.call(i,e.pointerId),this._clicked=!0;const s=this._localPoint(e);this._mode==="absolute"?(this._hX.update(s),this._hY.update(s),this._batchSetFromHandles()):(this._hX.anchor=s,this._hY.anchor=s),window.addEventListener("pointermove",this._onMove,{passive:!1}),this._emit("down",{x:this._x.value,y:this._y.value}),e.preventDefault()}_onMove(e){if(!this._clicked)return;const s=this._localPoint(e);this._hX.update(s),this._hY.update(s),this._batchSetFromHandles(),e.preventDefault()}_onUp(){this._clicked&&(this._clicked=!1,window.removeEventListener("pointermove",this._onMove),this._emit("up",{x:this._x.value,y:this._y.value}))}_batchSetFromHandles(){const e=this._hX.value,s=this._hY.value,i=this._x.updateNormal(e),a=this._y.updateNormal(s);(i!==void 0||a!==void 0)&&this._emit("change",{x:this._x.value,y:this._y.value}),this._draw()}_draw(){const e=(this._w-1)*this._x.normalized,s=(this._h-1)*(1-this._y.normalized);this._xh.setAttribute("x1",e),this._xh.setAttribute("y1",0),this._xh.setAttribute("x2",e),this._xh.setAttribute("y2",this._h),this._yh.setAttribute("x1",0),this._yh.setAttribute("y1",s),this._yh.setAttribute("x2",this._w),this._yh.setAttribute("y2",s),this._knob.setAttribute("cx",e),this._knob.setAttribute("cy",s)}}T.moduleLoaded("PositionEffectsController");class $_{constructor(){this.positions={},this.currentColor=null,this.resizeObservers=[],this.effectConfigs={reverb:{containerId:"reverb-position",xParam:"decay",yParam:"roomSize",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1}},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}}},this.colorMappings={"#4a90e2":{bg:"rgba(74, 144, 226, 0.1)",handle:"#4a90e2",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#2d2d2d":{bg:"rgba(45, 45, 45, 0.1)",handle:"#2d2d2d",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#d66573":{bg:"rgba(214, 101, 115, 0.1)",handle:"#d66573",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#68a03f":{bg:"rgba(104, 160, 63, 0.1)",handle:"#68a03f",grid:"#dee2e6",cross:"#6c757d",text:"#212529"}},T.info("PositionEffectsController","Initialized",null,"ui")}init(){return T.initStart("Position Effects Controller"),Object.entries(this.effectConfigs).forEach(([e,s])=>{this.createPositionComponent(e,s)}),this.initializeColorTracking(),this.updateColorsForCurrentSelection(),T.initSuccess("Position Effects Controller"),!0}createPositionComponent(e,s){const i=document.getElementById(s.containerId);if(!i){T.warn("PositionEffectsController",`Container not found for ${e}`,{containerId:s.containerId},"ui");return}try{const[a,r]=this.getPositionComponentSize(i),c=new B_(i,{size:[a,r],mode:"absolute",x:s.xRange.min,minX:s.xRange.min,maxX:s.xRange.max,stepX:s.xRange.step,y:s.yRange.min,minY:s.yRange.min,maxY:s.yRange.max,stepY:s.yRange.step});this.positions[e]=c,this.observePositionResize(i,c,a,r),c.on("change",({x:h,y:m})=>{this.onPositionChange(e,s.xParam,h,s.yParam,m)}),c.on("down",()=>{this.onDialInteractionStart(e)}),c.on("up",()=>{this.onDialInteractionEnd(e)}),this.loadInitialValues(e,s,c),T.debug("PositionEffectsController",`Created Position component for ${e}`,null,"ui")}catch(a){T.error("PositionEffectsController",`Failed to create Position component for ${e}`,a,"ui")}}getPositionComponentSize(e){const i=e.getBoundingClientRect();let a=(i==null?void 0:i.width)||e.clientWidth||e.offsetWidth||120,r=(i==null?void 0:i.height)||e.clientHeight||e.offsetHeight||a;return(!a||a<10)&&(a=120),(!r||r<10)&&(r=a),[Math.round(a),Math.round(r)]}observePositionResize(e,s,i,a){if(typeof ResizeObserver>"u")return;const r={currentWidth:Math.round(i)||0,currentHeight:Math.round(a)||0},c=new ResizeObserver(h=>{for(const m of h){const{width:f,height:g}=m.contentRect,b=Math.round(f),w=Math.round(g||f);!b||!w||b===r.currentWidth&&w===r.currentHeight||(r.currentWidth=b,r.currentHeight=w,s.resize(b,w))}});c.observe(e),this.resizeObservers.push(c)}loadInitialValues(e,s,i){var c;const a=(c=u.state.selectedNote)==null?void 0:c.color;if(!a){const h=s.xRange.min,m=s.yRange.min;i.x=h,i.y=m,T.debug("PositionEffectsController",`Set default values for ${e} (no color selected)`,{x:h,y:m},"ui");return}const r=Bn.getEffectParameters?Bn.getEffectParameters(e):null;if(r){const h=r[s.xParam]!==void 0?r[s.xParam]:s.xRange.min,m=r[s.yParam]!==void 0?r[s.yParam]:s.yRange.min;i.x=h,i.y=m,T.debug("PositionEffectsController",`Loaded values for ${e} color ${a}`,{x:h,y:m},"ui")}else{const h=s.xRange.min,m=s.yRange.min;i.x=h,i.y=m,T.debug("PositionEffectsController",`Set default values for ${e} (no effect params)`,{x:h,y:m},"ui")}}transformValue(e){return e<=1,e}isInOffZone(e,s){return e<=1&&s<=1}transformPositionValues(e,s){if(this.isInOffZone(e,s))return{x:e,y:s};const i=e<=1?Math.max(1,e):e,a=s<=1?Math.max(1,s):s;return{x:i,y:a}}onPositionChange(e,s,i,a,r){var m;if(!((m=u.state.selectedNote)==null?void 0:m.color)){T.warn("PositionEffectsController","No color selected for position change",{effectType:e,xParam:s,xValue:i,yParam:a,yValue:r},"ui");return}const h=this.transformPositionValues(i,r);T.debug("PositionEffectsController",`Position changed: ${e} ${s}=${i}->${h.x}, ${a}=${r}->${h.y}`,null,"ui"),Bn.onEffectParameterChange(e,s,h.x),Bn.onEffectParameterChange(e,a,h.y)}initializeColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("noteChanged",()=>{var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s!==this.currentColor&&(this.currentColor=s,this.updateColorsForCurrentSelection(),this.updatePositionValuesForColor())}),u.on("effectParameterChanged",({effectType:s,parameter:i,value:a,color:r})=>{T.debug("PositionEffectsController",`Effect parameter changed: ${s}.${i} = ${a} for ${r}`,null,"ui"),r===this.currentColor&&this.syncPositionFromEffects(s,i,a)}),u.on("audioEffectChanged",({effectType:s,parameter:i,value:a,color:r})=>{T.debug("PositionEffectsController",`Audio effect changed: ${s}.${i} = ${a} for ${r}`,null,"ui"),r===this.currentColor&&this.syncPositionFromEffects(s,i,a)})}updateColorsForCurrentSelection(){if(!this.currentColor||!this.colorMappings[this.currentColor])return;const e=this.colorMappings[this.currentColor];Object.values(this.positions).forEach(s=>{s&&s.colorize&&s.colorize(e)}),T.debug("PositionEffectsController",`Applied color theme for ${this.currentColor}`,e,"ui")}updatePositionValuesForColor(){this.currentColor&&Object.entries(this.effectConfigs).forEach(([e,s])=>{const i=this.positions[e];if(!i)return;const a=Bn.getEffectParameters?Bn.getEffectParameters(e):null;if(a){const r=a[s.xParam]!==void 0?a[s.xParam]:s.xRange.min,c=a[s.yParam]!==void 0?a[s.yParam]:s.yRange.min;i.x=r,i.y=c}})}syncPositionFromEffects(e,s,i){const a=this.positions[e],r=this.effectConfigs[e];!a||!r||(s===r.xParam?a.x=i:s===r.yParam&&(a.y=i),T.debug("PositionEffectsController",`Synced ${e}.${s} = ${i} from effects`,null,"ui"))}getPositionValues(e){const s=this.positions[e];return s?{x:s.x,y:s.y,normalized:s.normalized}:null}testPositionComponents(){T.info("PositionEffectsController","Testing Position components...",null,"ui"),Object.entries(this.positions).forEach(([e,s])=>{s?T.info("PositionEffectsController",`${e} Position component:`,{x:s.x,y:s.y,normalized:s.normalized},"ui"):T.warn("PositionEffectsController",`${e} Position component not found`,null,"ui")}),T.info("PositionEffectsController",`Current color: ${this.currentColor}`,null,"ui"),this.positions.vibrato&&(T.info("PositionEffectsController","Testing vibrato position change...",null,"ui"),this.positions.vibrato.x=75,this.positions.vibrato.y=50)}testDeadZoneElimination(){T.info("PositionEffectsController","Testing dead zone elimination...",null,"ui"),[{x:0,y:0,description:"Origin (should stay 0,0 - effect off)"},{x:.5,y:.5,description:"Inside off zone (should stay 0.5,0.5 - effect off)"},{x:1,y:1,description:"Edge of off zone (should stay 1,1 - effect off)"},{x:0,y:50,description:"X in dead zone (should become 1,50 - effect on)"},{x:50,y:0,description:"Y in dead zone (should become 50,1 - effect on)"},{x:.5,y:75,description:"X in dead zone (should become 1,75 - effect on)"},{x:25,y:.8,description:"Y in dead zone (should become 25,1 - effect on)"},{x:50,y:75,description:"Both normal (should stay 50,75 - effect on)"}].forEach(s=>{const i=this.transformPositionValues(s.x,s.y),a=this.isInOffZone(s.x,s.y);T.info("PositionEffectsController",`Test: ${s.description}`,{input:{x:s.x,y:s.y},output:i,inOffZone:a},"ui")})}onDialInteractionStart(e){var i;if(e!=="vibrato"&&e!=="tremolo")return;const s=(i=u.state.selectedNote)==null?void 0:i.color;if(!s){console.warn("⚠️ Position dial interaction started but no color selected");return}console.log(`🎛️ Position dial interaction START: ${e} on ${s}`),u.emit("effectDialInteractionStart",{effectType:e,color:s}),T.debug("PositionEffectsController",`Dial interaction started for ${e} on ${s}`,null,"ui")}onDialInteractionEnd(e){var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&(console.log(`🎛️ Position dial interaction END: ${e} on ${s}`),u.emit("effectDialInteractionEnd",{effectType:e,color:s}),T.debug("PositionEffectsController",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}destroy(){Object.values(this.positions).forEach(e=>{e&&e.destroy&&e.destroy()}),this.positions={},this.resizeObservers.forEach(e=>e.disconnect()),this.resizeObservers=[],T.info("PositionEffectsController","Destroyed",null,"ui")}}const Qd=new $_,q_=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Echo Card",selector:"#timbre-panel #reverb-delay-panel .effects-content-box, #timbre-panel #echo-panel .effects-content-box"},{label:"Shake Card",selector:"#timbre-panel #vibrato-tremolo-panel .effects-content-box, #timbre-panel #shake-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],fh=new Map;let gh,qc,zc=null,Yo="",Ji=!1;function fr(n){return Number.isFinite(n)?Number(n.toFixed(1)):n}function z_(n){const e=n.getBoundingClientRect(),s=window.getComputedStyle(n);return{tag:n.tagName.toLowerCase(),id:n.id||null,class:n.className||null,top:fr(e.top),left:fr(e.left),width:fr(e.width),height:fr(e.height),offsetWidth:n.offsetWidth,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,scrollHeight:n.scrollHeight,clientWidth:n.clientWidth,clientHeight:n.clientHeight,display:s.display,position:s.position,overflowX:s.overflowX,overflowY:s.overflowY,transform:s.transform!=="none"?s.transform:void 0}}function vm(n="manual"){const e=window.__uiDiagnosticsTrackedElements;if(!e)return[];if(!Ji&&n!=="manual")return[];Pr();const s=[];return console.groupCollapsed(`[UI Diagnostics] ${n}`),e.forEach(i=>{const a=Array.from(document.querySelectorAll(i.selector));if(!a.length){console.warn(`${i.label}: selector "${i.selector}" not found`);return}a.forEach((r,c)=>{const h=a.length>1?`${i.label} [${c}]`:i.label,m=z_(r);console.log(h,m),s.push({label:h,selector:i.selector,info:m})})}),console.groupEnd(),window.__uiDiagnosticsLastSnapshot=s,s}function Vi(n){Ji&&(Yo=Yo?`${Yo}; ${n}`:n,zc===null&&(zc=requestAnimationFrame(()=>{const e=Yo||"auto";zc=null,Yo="",vm(e)})))}function Pr(){const n=window.__uiDiagnosticsTrackedElements;!n||!gh||n.forEach(e=>{document.querySelectorAll(e.selector).forEach(i=>{fh.has(i)||(fh.set(i,e.label),gh.observe(i),i.addEventListener("scroll",()=>Vi(`${e.label} scroll`),{passive:!0}))})})}function W_(n={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:e,autoLog:s=!1}=n;Ji=!!s,window.__uiDiagnosticsAutoLog=Ji;const i=e||q_;window.__uiDiagnosticsTrackedElements=i,gh=new ResizeObserver(a=>{const r=a.map(c=>fh.get(c.target)||c.target.id||c.target.tagName.toLowerCase()).filter(Boolean);r.length&&Vi(`Resize: ${r.join(", ")}`)}),qc=new MutationObserver(()=>Pr()),document.body?qc.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{qc.observe(document.body,{childList:!0,subtree:!0}),Pr(),Vi("init")},{once:!0}),window.addEventListener("resize",()=>Vi("window resize")),Pr(),Vi("init"),window.logUIState=(a="manual")=>vm(a),window.enableUIDiagnosticsAutoLog=()=>{Ji=!0,window.__uiDiagnosticsAutoLog=!0,Vi("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{Ji=!1,window.__uiDiagnosticsAutoLog=!1}}const vh=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function V_(n){if(n===0||!n)return"#888888";const e=Math.round(n)%12;return vh[e]}function H_(n){if(n===0||!n)return no("#888888");const e=Math.floor(n),s=n-e;if(s<0||s>=1)return V_(n);const i=e%12,a=(i+1)%12,r=no(vh[i]),c=no(vh[a]);return G_(r,c,s)}function no(n){const e=parseInt(n.slice(1),16);return[e>>16&255,e>>8&255,e&255]}function G_(n,e,s){return n.map((i,a)=>Math.round(i+s*(e[a]-i)))}function kr(n,e,s){return n===0||!n?no("#888888"):e==="shapenote"?no(s||"#4A90E2"):H_(n)}class j_{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.lastValidPitch=null,this.lastValidPitchTime=0,this.fadeOutDurationMs=100,this.isFading=!1}initialize(){this.canvas=document.getElementById("playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("micPaintStateChanged",e=>this.handlePaintStateChange(e)),u.on("pitchDetected",e=>this.handlePitchDetection(e)),u.on("playbackStateChanged",()=>{u.state.paint.isMicPaintActive}))}handlePaintStateChange(e){const s=document.getElementById("hover-canvas");s&&(s.style.display=e?"none":"block"),e?this.startRendering():this.stopRendering()}handlePitchDetection(e){u.state.paint.isMicPaintActive&&u.state.isPlaying&&!u.state.isPaused&&this.addPaintAtPlayhead(e)}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.paint.isMicPaintActive||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),u.state.isPlaying,u.state.isPaused,u.state.isPlaying&&u.state.isPaused,u.state.isPlaying&&!u.state.isPaused?this.renderMovingPlayhead():this.renderStationaryPlayhead(),this.animationFrameId=requestAnimationFrame(()=>this.render())}renderStationaryPlayhead(){var h,m;const{detectedPitch:e}=u.state.paint,s=performance.now();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.midiToY(e.midi),a=i!==null,r=xt.getColumnX(2),c=xt.getCanvasWidth();if(a){this.lastValidPitch=e,this.lastValidPitchTime=s,this.isFading=!1;const{colorMode:f}=u.state.paint.paintSettings,g=(h=u.state.selectedNote)==null?void 0:h.color,b=kr(e.midi,f,g),w=`rgb(${b[0]}, ${b[1]}, ${b[2]})`;this.ctx.strokeStyle=w,this.ctx.globalAlpha=Math.min(e.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=w,this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(r,i),this.ctx.lineTo(c,i),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}else if(this.lastValidPitch&&s-this.lastValidPitchTime<this.fadeOutDurationMs){this.isFading=!0;const f=(s-this.lastValidPitchTime)/this.fadeOutDurationMs,g=this.easeOutCubic(1-f),b=this.midiToY(this.lastValidPitch.midi);if(b!==null){const{colorMode:w}=u.state.paint.paintSettings,x=(m=u.state.selectedNote)==null?void 0:m.color,A=kr(this.lastValidPitch.midi,w,x),P=`rgb(${A[0]}, ${A[1]}, ${A[2]})`;this.ctx.strokeStyle=P,this.ctx.globalAlpha=g*Math.min(this.lastValidPitch.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=P,this.ctx.shadowBlur=6*g,this.ctx.beginPath(),this.ctx.moveTo(r,b),this.ctx.lineTo(c,b),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}}else this.isFading=!1,this.lastValidPitch=null}easeOutCubic(e){return 1-Math.pow(1-e,3)}renderMovingPlayhead(){var a;const e=this.calculateXFromTime(Q.Transport.seconds);if(e===null)return;this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0;const{detectedPitch:s}=u.state.paint,i=this.midiToY(s.midi);if(i!==null){const{colorMode:r}=u.state.paint.paintSettings,c=(a=u.state.selectedNote)==null?void 0:a.color,h=kr(s.midi,r,c),m=`rgb(${h[0]}, ${h[1]}, ${h[2]})`;this.ctx.fillStyle=m,this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.shadowColor=m,this.ctx.shadowBlur=4,this.ctx.beginPath(),this.ctx.arc(e,i,8,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowBlur=0}}addPaintAtPlayhead(e){if(e.midi===0)return;const s=Q.Transport.seconds;Vh.addPaintPoint(s,e.midi)}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let i=0;i<u.state.columnWidths.length;i++)this.timeMap[i]=e,e+=u.state.columnWidths[i]*s;this.timeMap.push(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const i=this.timeMap[s],a=this.timeMap[s+1]-i,r=e-i,c=xt.getColumnX(s),h=xt.getColumnX(s+1)-c;return c+(a>0?r/a*h:0)}return null}midiToY(e){if(e===0)return null;const{fullRowData:s}=u.state;if(!s||s.length===0)return null;const i=Math.min(...s.map(w=>nn(w.toneNote))),a=Math.max(...s.map(w=>nn(w.toneNote)));if(e<24||e>96||e<i||e>a)return null;let r=-1,c=-1,h=-999,m=999;for(let w=0;w<s.length;w++){const x=nn(s[w].toneNote);x<=e&&x>h&&(r=w,h=x),x>=e&&x<m&&(c=w,m=x)}if(h===e){const w=Rt(r,u.state);return Math.max(0,Math.min(w,this.canvas.height))}if(r>=0&&c>=0&&h!==m){const w=Rt(r,u.state),x=Rt(c,u.state),A=(e-h)/(m-h),P=w+(x-w)*A;return Math.max(0,Math.min(P,this.canvas.height))}let f=0,g=Math.abs(nn(s[0].toneNote)-e);for(let w=1;w<s.length;w++){const x=nn(s[w].toneNote),A=Math.abs(x-e);A<g&&(g=A,f=w)}const b=Rt(f,u.state);return Math.max(0,Math.min(b,this.canvas.height))}canvasYToViewportY(e){const s=xt.getViewportInfo();return Hs.canvasToViewportY(e,s)}isCanvasYVisible(e){const s=this.canvasYToViewportY(e),i=xt.getViewportInfo();return s>=0&&s<=i.viewportHeight}}const yh=new j_;class U_{constructor(){this.canvas=null,this.ctx=null,this.isInitialized=!1,this.animationFrameId=null,this.lastHistoryLength=0}initialize(){if(this.canvas=document.getElementById("pitch-paint-canvas"),!this.canvas){T.error("PaintCanvas","Could not find #pitch-paint-canvas element",null,"paint");return}if(this.ctx=this.canvas.getContext("2d"),!document.getElementById("pitch-canvas-wrapper")){T.error("PaintCanvas","Could not find #pitch-canvas-wrapper element",null,"paint");return}u.on("paintHistoryChanged",()=>this.render()),u.on("layoutConfigChanged",()=>this.resize()),u.on("micPaintStateChanged",s=>{s?this.startRendering():this.stopRendering()}),this.resize(),this.isInitialized=!0}startRendering(){this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>this.animationLoop()))}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animationLoop(){u.state.paint.paintHistory.length!==this.lastHistoryLength&&(this.render(),this.lastHistoryLength=u.state.paint.paintHistory.length),this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}resize(){if(!this.canvas)return;const e=document.getElementById("pitch-canvas-wrapper");setTimeout(()=>{document.getElementById("pitch-grid-container");const s=68,i=u.state.cellHeight||18.35,r=s*(i/2);(this.canvas.width!==e.clientWidth||this.canvas.height!==r)&&(T.debug("PaintCanvas",`Setting pitch-paint-canvas height (DEFERRED): ${this.canvas.height} → ${r}`,null,"paint"),this.canvas.width=e.clientWidth,this.canvas.height=r,this.render())},30)}render(){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=u.state.paint.paintHistory;e.length!==0&&this.renderPaintTrail(e)}renderPaintTrail(e){if(e.length<2)return;const s=e.map(a=>{const r=yh.calculateXFromTime(a.musicalTime),c=yh.midiToY(a.midi);return r===null||c===null?null:{...a,x:r,y:c}}).filter(a=>a!==null);if(s.length<2)return;const i=u.state.paint.paintSettings.opacity/100;this.ctx.globalAlpha=i,this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let a=1;a<s.length;a++){const r=s[a-1],c=s[a];c.timestamp-r.timestamp>200||this.drawPaintSegment(r,c)}this.ctx.globalAlpha=1}drawPaintSegment(e,s){const i=this.ctx.createLinearGradient(e.x,e.y,s.x,s.y);i.addColorStop(0,`rgb(${e.color.join(",")})`),i.addColorStop(1,`rgb(${s.color.join(",")})`),this.ctx.strokeStyle=i,this.ctx.lineWidth=(e.thickness+s.thickness)/2,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}addPaintPoint(e,s){var h;const{colorMode:i}=u.state.paint.paintSettings,a=(h=u.state.selectedNote)==null?void 0:h.color,r=kr(s,i,a),c={musicalTime:e,midi:s,color:r,timestamp:performance.now(),thickness:u.state.paint.paintSettings.thickness};u.addPaintPoint(c)}clear(){u.clearPaintHistory()}}const Vh=new U_;var Wc,Jd;function X_(){if(Jd)return Wc;Jd=1;function n(e){if(this.size=e|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=e<<1;for(var s=new Array(this.size*2),i=0;i<s.length;i+=2){const f=Math.PI*i/this.size;s[i]=Math.cos(f),s[i+1]=-Math.sin(f)}this.table=s;for(var a=0,r=1;this.size>r;r<<=1)a++;this._width=a%2===0?a-1:a,this._bitrev=new Array(1<<this._width);for(var c=0;c<this._bitrev.length;c++){this._bitrev[c]=0;for(var h=0;h<this._width;h+=2){var m=this._width-h-2;this._bitrev[c]|=(c>>>h&3)<<m}}this._out=null,this._data=null,this._inv=0}return Wc=n,n.prototype.fromComplexArray=function(s,i){for(var a=i||new Array(s.length>>>1),r=0;r<s.length;r+=2)a[r>>>1]=s[r];return a},n.prototype.createComplexArray=function(){const s=new Array(this._csize);for(var i=0;i<s.length;i++)s[i]=0;return s},n.prototype.toComplexArray=function(s,i){for(var a=i||this.createComplexArray(),r=0;r<a.length;r+=2)a[r]=s[r>>>1],a[r+1]=0;return a},n.prototype.completeSpectrum=function(s){for(var i=this._csize,a=i>>>1,r=2;r<a;r+=2)s[i-r]=s[r],s[i-r+1]=-s[r+1]},n.prototype.transform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._transform4(),this._out=null,this._data=null},n.prototype.realTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._realTransform4(),this._out=null,this._data=null},n.prototype.inverseTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=1,this._transform4();for(var a=0;a<s.length;a++)s[a]/=this.size;this._out=null,this._data=null},n.prototype._transform4=function(){var s=this._out,i=this._csize,a=this._width,r=1<<a,c=i/r<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<i;h+=c,m++){const M=f[m];this._singleTransform2(h,M,r)}else for(h=0,m=0;h<i;h+=c,m++){const M=f[m];this._singleTransform4(h,M,r)}var g=this._inv?-1:1,b=this.table;for(r>>=2;r>=2;r>>=2){c=i/r<<1;var w=c>>>2;for(h=0;h<i;h+=c)for(var x=h+w,A=h,P=0;A<x;A+=2,P+=r){const M=A,I=M+w,D=I+w,R=D+w,H=s[M],j=s[M+1],F=s[I],Y=s[I+1],tt=s[D],nt=s[D+1],at=s[R],gt=s[R+1],_t=H,Mt=j,me=b[P],Wt=g*b[P+1],Qt=F*me-Y*Wt,it=F*Wt+Y*me,ht=b[2*P],ut=g*b[2*P+1],Ct=tt*ht-nt*ut,dt=tt*ut+nt*ht,Nt=b[3*P],jt=g*b[3*P+1],Bt=at*Nt-gt*jt,ee=at*jt+gt*Nt,je=_t+Ct,$t=Mt+dt,_e=_t-Ct,Ue=Mt-dt,Ye=Qt+Bt,Ie=it+ee,Ze=g*(Qt-Bt),Ce=g*(it-ee),xs=je+Ye,rn=$t+Ie,Ne=je-Ye,xn=$t-Ie,li=_e+Ce,ci=Ue-Ze,hi=_e-Ce,Sn=Ue+Ze;s[M]=xs,s[M+1]=rn,s[I]=li,s[I+1]=ci,s[D]=Ne,s[D+1]=xn,s[R]=hi,s[R+1]=Sn}}},n.prototype._singleTransform2=function(s,i,a){const r=this._out,c=this._data,h=c[i],m=c[i+1],f=c[i+a],g=c[i+a+1],b=h+f,w=m+g,x=h-f,A=m-g;r[s]=b,r[s+1]=w,r[s+2]=x,r[s+3]=A},n.prototype._singleTransform4=function(s,i,a){const r=this._out,c=this._data,h=this._inv?-1:1,m=a*2,f=a*3,g=c[i],b=c[i+1],w=c[i+a],x=c[i+a+1],A=c[i+m],P=c[i+m+1],M=c[i+f],I=c[i+f+1],D=g+A,R=b+P,H=g-A,j=b-P,F=w+M,Y=x+I,tt=h*(w-M),nt=h*(x-I),at=D+F,gt=R+Y,_t=H+nt,Mt=j-tt,me=D-F,Wt=R-Y,Qt=H-nt,it=j+tt;r[s]=at,r[s+1]=gt,r[s+2]=_t,r[s+3]=Mt,r[s+4]=me,r[s+5]=Wt,r[s+6]=Qt,r[s+7]=it},n.prototype._realTransform4=function(){var s=this._out,i=this._csize,a=this._width,r=1<<a,c=i/r<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<i;h+=c,m++){const pi=f[m];this._singleRealTransform2(h,pi>>>1,r>>>1)}else for(h=0,m=0;h<i;h+=c,m++){const pi=f[m];this._singleRealTransform4(h,pi>>>1,r>>>1)}var g=this._inv?-1:1,b=this.table;for(r>>=2;r>=2;r>>=2){c=i/r<<1;var w=c>>>1,x=w>>>1,A=x>>>1;for(h=0;h<i;h+=c)for(var P=0,M=0;P<=A;P+=2,M+=r){var I=h+P,D=I+x,R=D+x,H=R+x,j=s[I],F=s[I+1],Y=s[D],tt=s[D+1],nt=s[R],at=s[R+1],gt=s[H],_t=s[H+1],Mt=j,me=F,Wt=b[M],Qt=g*b[M+1],it=Y*Wt-tt*Qt,ht=Y*Qt+tt*Wt,ut=b[2*M],Ct=g*b[2*M+1],dt=nt*ut-at*Ct,Nt=nt*Ct+at*ut,jt=b[3*M],Bt=g*b[3*M+1],ee=gt*jt-_t*Bt,je=gt*Bt+_t*jt,$t=Mt+dt,_e=me+Nt,Ue=Mt-dt,Ye=me-Nt,Ie=it+ee,Ze=ht+je,Ce=g*(it-ee),xs=g*(ht-je),rn=$t+Ie,Ne=_e+Ze,xn=Ue+xs,li=Ye-Ce;if(s[I]=rn,s[I+1]=Ne,s[D]=xn,s[D+1]=li,P===0){var ci=$t-Ie,hi=_e-Ze;s[R]=ci,s[R+1]=hi;continue}if(P!==A){var Sn=Ue,Jt=-Ye,Vn=$t,ln=-_e,ui=-g*xs,Ma=-g*Ce,co=-g*Ze,di=-g*Ie,Ur=Sn+ui,ho=Jt+Ma,uo=Vn+di,Ea=ln-co,Pa=h+x-P,Hn=h+w-P;s[Pa]=Ur,s[Pa+1]=ho,s[Hn]=uo,s[Hn+1]=Ea}}}},n.prototype._singleRealTransform2=function(s,i,a){const r=this._out,c=this._data,h=c[i],m=c[i+a],f=h+m,g=h-m;r[s]=f,r[s+1]=0,r[s+2]=g,r[s+3]=0},n.prototype._singleRealTransform4=function(s,i,a){const r=this._out,c=this._data,h=this._inv?-1:1,m=a*2,f=a*3,g=c[i],b=c[i+a],w=c[i+m],x=c[i+f],A=g+w,P=g-w,M=b+x,I=h*(b-x),D=A+M,R=P,H=-I,j=A-M,F=P,Y=I;r[s]=D,r[s+1]=0,r[s+2]=R,r[s+3]=H,r[s+4]=j,r[s+5]=0,r[s+6]=F,r[s+7]=Y},Wc}var Y_=X_();const Z_=Kg(Y_);class ma{constructor(e,s){Ms(this,"_inputLength");Ms(this,"_fft");Ms(this,"_bufferSupplier");Ms(this,"_paddedInputBuffer");Ms(this,"_transformBuffer");Ms(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new Z_(K_(2*e)),this._bufferSupplier=s,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new ma(e,s=>new Float32Array(s))}static forFloat64Array(e){return new ma(e,s=>new Float64Array(s))}static forNumberArray(e){return new ma(e,s=>Array(s))}get inputLength(){return this._inputLength}autocorrelate(e,s=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let a=0;a<e.length;a++)this._paddedInputBuffer[a]=e[a];for(let a=e.length;a<this._paddedInputBuffer.length;a++)this._paddedInputBuffer[a]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const i=this._transformBuffer;for(let a=0;a<i.length;a+=2)i[a]=i[a]*i[a]+i[a+1]*i[a+1],i[a+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let a=0;a<e.length;a++)s[a]=this._inverseBuffer[2*a];return s}}function Q_(n){const e=[];let s=!1,i=-1/0,a=-1;for(let r=1;r<n.length-1;r++)n[r-1]<=0&&n[r]>0?(s=!0,a=r,i=n[r]):n[r-1]>0&&n[r]<=0?(s=!1,a!==-1&&e.push(a)):s&&n[r]>i&&(i=n[r],a=r);return e}function J_(n,e){const[s,i,a]=[n-1,n,n+1],[r,c,h]=[e[s],e[i],e[a]],m=r/2-c+h/2,f=-(r/2)*(i+a)+c*(s+a)-h/2*(s+i),g=r*i*a/2-c*s*a+h*s*i/2,b=-f/(2*m),w=m*b*b+f*b+g;return[b,w]}class fa{constructor(e,s){Ms(this,"_autocorrelator");Ms(this,"_nsdfBuffer");Ms(this,"_clarityThreshold",.9);Ms(this,"_minVolumeAbsolute",0);Ms(this,"_maxInputAmplitude",1);this._autocorrelator=new ma(e,s),this._nsdfBuffer=s(e)}static forFloat32Array(e){return new fa(e,s=>new Float32Array(s))}static forFloat64Array(e){return new fa(e,s=>new Float64Array(s))}static forNumberArray(e){return new fa(e,s=>Array(s))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,s){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const i=Q_(this._nsdfBuffer);if(i.length===0)return[0,0];const a=Math.max(...i.map(m=>this._nsdfBuffer[m])),r=i.find(m=>this._nsdfBuffer[m]>=this._clarityThreshold*a),[c,h]=J_(r,this._nsdfBuffer);return[s/c,Math.min(h,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let s=0;for(let i=0;i<e.length;i++)s+=e[i]**2;return Math.sqrt(s/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let s=2*this._nsdfBuffer[0],i;for(i=0;i<this._nsdfBuffer.length&&s>0;i++)this._nsdfBuffer[i]=2*this._nsdfBuffer[i]/s,s-=e[i]**2+e[e.length-i-1]**2;for(;i<this._nsdfBuffer.length;i++)this._nsdfBuffer[i]=0}}function K_(n){return n--,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,n++,n}class tx{constructor(){this.mic=null,this.analyser=null,this.detector=null,this.animationFrameId=null,this.isInitialized=!1,this.lastLogTime=0,this.logThrottleMs=5e3,this.pitchHistory=[],this.maxHistoryLength=3,this.maxPitchJumpSemitones=24,this.maxJumpTimeMs=20,this.config={FFT_SIZE:2048,MIN_PITCH_HZ:75,MAX_PITCH_HZ:1300,MIN_VOLUME_DB:-50}}async initialize(){if(!this.isInitialized)try{await(window.initAudio||(()=>Q.start()))(),this.mic=new Q.UserMedia,this.analyser=new Q.Analyser("waveform",this.config.FFT_SIZE),this.micGain=new Q.Gain(2),this.detector=fa.forFloat32Array(this.analyser.size),this.micSplitter=new Q.Gain(1),await this.mic.open(),this.mic.connect(this.micGain),this.micGain.connect(this.micSplitter),this.micSplitter.connect(this.analyser),this.isInitialized=!0}catch(e){throw console.error("PitchPaintService: Failed to initialize microphone:",e),u.setMicPaintActive(!1),e}}startDetection(){!this.isInitialized||u.state.paint.isDetecting||(u.setPaintDetectionState(!0),this.animationLoop())}stopDetection(){u.state.paint.isDetecting&&(u.setPaintDetectionState(!1),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}animationLoop(){if(!u.state.paint.isDetecting){this.animationFrameId=null;return}const e=this.analyser.getValue(),s=Math.sqrt(e.reduce((m,f)=>m+f*f,0)/e.length),i=performance.now();let a=null,r=0;if(s>1e-5)try{[a,r]=this.detector.findPitch(e,Q.context.sampleRate),a==null&&(a=null),r==null&&(r=0),a&&r>.1&&i-this.lastLogTime>this.logThrottleMs&&(this.lastLogTime=i)}catch{a=null,r=0}const c=u.state.paint.paintSettings.minClarity;if(a&&r>c&&a>this.config.MIN_PITCH_HZ&&a<this.config.MAX_PITCH_HZ){const m=this.frequencyToMidi(a);if(this.isPitchJumpValid(m,i)){this.addPitchToHistory(m,i);const f=this.getSmoothedPitch(),g={frequency:a,clarity:r,midi:f,pitchClass:Math.round(f)%12,timestamp:i};u.setDetectedPitch(g)}else{const f=this.getSmoothedPitch();if(f!==null){const g={frequency:a,clarity:r,midi:f,pitchClass:Math.round(f)%12,timestamp:i};u.setDetectedPitch(g)}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i})}}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i});this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}frequencyToMidi(e){return 12*Math.log2(e/440)+69}addPitchToHistory(e,s){this.pitchHistory.push({midi:e,timestamp:s}),this.pitchHistory.length>this.maxHistoryLength&&this.pitchHistory.shift()}isPitchJumpValid(e,s){if(this.pitchHistory.length===0)return!0;const i=this.pitchHistory[this.pitchHistory.length-1],a=s-i.timestamp,r=Math.abs(e-i.midi);return a>this.maxJumpTimeMs?!0:r>this.maxPitchJumpSemitones?(console.log("🚫 [Filter] Pitch jump rejected:",r.toFixed(1),"semitones in",a.toFixed(0)+"ms"),!1):!0}getSmoothedPitch(){return this.pitchHistory.length<3?this.pitchHistory.length>0?this.pitchHistory[this.pitchHistory.length-1].midi:null:this.pitchHistory.slice(-3).map(s=>s.midi).sort((s,i)=>s-i)[1]}testMicrophoneInput(){if(!this.isInitialized)return!1;const e=this.analyser.getValue();return Math.sqrt(e.reduce((i,a)=>i+a*a,0)/e.length)>1e-4}async dispose(){this.stopDetection(),this.mic&&(this.mic.close(),this.mic=null),this.micGain&&(this.micGain.dispose(),this.micGain=null),this.micSplitter&&(this.micSplitter.dispose(),this.micSplitter=null),this.analyser=null,this.detector=null,this.isInitialized=!1}}const Ir=new tx,ex=Object.freeze(Object.defineProperty({__proto__:null,default:Ir},Symbol.toStringTag,{value:"Module"}));class sx{constructor(){this.elements={}}initialize(){this.cacheDOMElements(),this.elements.toggleBtn&&(this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",()=>this.updateUI()),u.on("paintHistoryChanged",()=>this.updateUI()),u.on("paintSettingsChanged",()=>this.updateUI()))}cacheDOMElements(){this.elements.toggleBtn=document.getElementById("mic-paint-toggle"),this.elements.clearBtn=document.getElementById("paint-clear-btn"),this.elements.thicknessSelect=document.getElementById("sidebar-trail-thickness"),this.elements.opacitySelect=document.getElementById("sidebar-trail-opacity"),this.elements.colorToggle=document.getElementById("paint-color-toggle"),this.elements.playbackToggle=document.getElementById("paint-playback-toggle")}setupEventListeners(){this.elements.toggleBtn.addEventListener("click",()=>this.handleMicPaintToggle()),this.elements.clearBtn.addEventListener("click",()=>this.handleClearPaint()),this.elements.thicknessSelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({thickness:s})}),this.elements.opacitySelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({opacity:s})}),this.elements.colorToggle.addEventListener("click",()=>this.handleColorToggle()),this.elements.playbackToggle.addEventListener("click",()=>this.handlePlaybackToggle())}async handleMicPaintToggle(){const e=u.state.paint.isMicPaintActive;if(this.elements.toggleBtn.disabled=!0,e)Ir.stopDetection(),u.setMicPaintActive(!1);else try{await Ir.initialize(),u.setMicPaintActive(!0),Ir.startDetection()}catch{alert("Microphone access is required for Pitch Painting. Please check your browser permissions and try again."),u.setMicPaintActive(!1)}this.elements.toggleBtn.disabled=!1}handleClearPaint(){confirm("Are you sure you want to clear the painted pitch trail? This cannot be undone.")&&Vh.clear()}handleColorToggle(){const s=u.state.paint.paintSettings.colorMode==="chromatic"?"shapenote":"chromatic";u.setPaintSettings({colorMode:s})}handlePlaybackToggle(){const e=u.state.paint.paintSettings.playbackEnabled;u.setPaintSettings({playbackEnabled:!e})}updateUI(){const{isMicPaintActive:e,paintHistory:s,paintSettings:i}=u.state.paint;if(this.elements.toggleBtn.textContent=e?"Mic Paint (ON)":"Mic Paint (OFF)",this.elements.toggleBtn.classList.toggle("active",e),this.elements.clearBtn.disabled=s.length===0,this.elements.thicknessSelect&&this.elements.thicknessSelect.value!==i.thickness.toString()&&(this.elements.thicknessSelect.value=i.thickness.toString()),this.elements.opacitySelect&&this.elements.opacitySelect.value!==i.opacity.toString()&&(this.elements.opacitySelect.value=i.opacity.toString()),this.elements.colorToggle){const a=i.colorMode==="shapenote";this.elements.colorToggle.classList.toggle("active",a)}this.elements.playbackToggle&&this.elements.playbackToggle.classList.toggle("active",i.playbackEnabled)}}const nx=new sx;T.moduleLoaded("PaintPlaybackService");class ix{constructor(){this.paintSynth=null,this.scheduledEvents=[],this.isInitialized=!1}async initialize(){if(!this.isInitialized)try{if(this.paintSynth=new Q.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:0,release:.1}}),this.paintGain=new Q.Gain(.3),this.paintSynth.connect(this.paintGain),window.synthEngine&&window.synthEngine.getMainVolumeNode){const e=window.synthEngine.getMainVolumeNode();e?(this.paintGain.connect(e),T.info("PaintPlaybackService","Connected to SynthEngine master chain (with limiter)")):(this.paintGain.toDestination(),T.warn("PaintPlaybackService","SynthEngine main volume node not found, connecting directly to destination"))}else this.paintGain.toDestination(),T.warn("PaintPlaybackService","SynthEngine not available, connecting directly to destination");this.isInitialized=!0,T.info("PaintPlaybackService","Initialized with sine wave synthesis")}catch(e){throw T.error("PaintPlaybackService","Failed to initialize",e),e}}midiToFrequency(e){return 440*Math.pow(2,(e-69)/12)}schedulePaintPlayback(){if(!this.isInitialized||!u.state.paint.paintSettings.playbackEnabled)return;this.clearScheduledEvents();const e=u.state.paint.paintHistory;if(!e||e.length===0){T.debug("PaintPlaybackService","No paint history to schedule");return}T.info("PaintPlaybackService",`Scheduling ${e.length} paint points for playback`),e.forEach((s,i)=>{const a=this.midiToFrequency(s.midi),r=.2,c=Q.Transport.schedule(h=>{this.paintSynth&&u.state.paint.paintSettings.playbackEnabled&&(this.paintSynth.triggerAttackRelease(a,r,h),T.debug("PaintPlaybackService",`Playing paint point ${i}: ${s.midi.toFixed(2)} MIDI (${a.toFixed(1)}Hz) at time ${s.musicalTime.toFixed(2)}s`))},s.musicalTime);this.scheduledEvents.push(c)}),T.info("PaintPlaybackService",`Scheduled ${this.scheduledEvents.length} paint events`)}clearScheduledEvents(){this.scheduledEvents.forEach(e=>{Q.Transport.clear(e)}),this.scheduledEvents=[],T.debug("PaintPlaybackService","Cleared all scheduled paint events")}onTransportStart(){u.state.paint.paintSettings.playbackEnabled&&this.schedulePaintPlayback()}onTransportStop(){this.clearScheduledEvents()}setPaintVolume(e){this.paintGain&&(this.paintGain.gain.value=Math.max(0,Math.min(1,e)))}getPaintVolume(){return this.paintGain?this.paintGain.gain.value:.3}async dispose(){this.clearScheduledEvents(),this.paintSynth&&(this.paintSynth.dispose(),this.paintSynth=null),this.paintGain&&(this.paintGain.dispose(),this.paintGain=null),this.isInitialized=!1,T.info("PaintPlaybackService","Disposed")}}const Kd=new ix;class ox{constructor(){this.currentTool=null,this.toolButtons=null,this.optionsContainer=null,this.lastSelectedNote=null,this.settings={arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}}}initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.optionsContainer=document.getElementById("draw-tool-options"),!this.toolButtons.length||!this.optionsContainer){console.warn("[DrawTools] Could not find draw tool elements");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),u.on("noteChanged",({newNote:e})=>{this.lastSelectedNote=e,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.drawTool;this.selectTool(s)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(u.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),u.setSelectedTool("note")):u.state.selectedNote&&(u.setSelectedNote(u.state.selectedNote.shape,u.state.selectedNote.color),u.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(e=>e.classList.remove("active")),this.currentTool=null,this.optionsContainer.innerHTML="",Ut.setTool(null,null)}selectTool(e){this.toolButtons.forEach(i=>i.classList.remove("active"));const s=Array.from(this.toolButtons).find(i=>i.dataset.drawTool===e);s&&s.classList.add("active"),this.currentTool=e,this.renderToolOptions(e),Ut.setTool(e,this.settings),u.state.selectedNote=null}renderToolOptions(e){switch(e){case"arrow":this.renderArrowOptions();break;case"text":this.renderTextOptions();break;case"marker":this.renderMarkerOptions();break;case"highlighter":this.renderHighlighterOptions();break;case"lasso":this.renderLassoOptions();break;default:this.optionsContainer.innerHTML=""}}renderArrowOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="stroke-weight" title="Stroke Weight">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${Math.min(this.settings.arrow.strokeWeight,5)}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="line-style" title="Line Style">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="${this.getLineDashArray()}">
                        <line x1="4" y1="12" x2="20" y2="12"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="start-arrowhead" title="Start Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.startArrowhead,"left")}
                </button>
                <button class="draw-toolbar-button draw-swap-button" data-action="swap-endpoints" title="Swap endpoints">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17,1 21,5 17,9"></polyline>
                        <path d="M3,11V9A4,4 0 0,1 7,5H21"></path>
                        <polyline points="7,23 3,19 7,15"></polyline>
                        <path d="M21,13v2a4,4 0 0,1 -4,4H3"></path>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="end-arrowhead" title="End Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.endArrowhead,"right")}
                </button>
            </div>
        `,this.attachArrowToolbarListeners()}getLineDashArray(){switch(this.settings.arrow.lineStyle){case"solid":return"0";case"dashed-big":return"8,4";case"dashed-small":return"4,2";case"dotted":return"1,2";default:return"0"}}getArrowheadIcon(e,s){const i=s==="left";switch(e){case"none":return`<svg width="20" height="20" viewBox="0 0 24 24"><line x1="${i?20:4}" y1="12" x2="${i?4:20}" y2="12" stroke="currentColor" stroke-width="2"/></svg>`;case"unfilled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?4:20}" y2="12"/>
                    <polyline points="${i?"10,6 4,12 10,18":"14,6 20,12 14,18"}"/>
                </svg>`;case"filled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?8:16}" y2="12"/>
                    <polygon points="${i?"4,12 10,6 10,18":"20,12 14,6 14,18"}"/>
                </svg>`;case"circle":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?8:16}" y2="12"/>
                    <circle cx="${i?4:20}" cy="12" r="3"/>
                </svg>`;default:return""}}attachArrowToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(i=>{i.addEventListener("click",a=>{const r=i.dataset.popup;this.showPopupMenu(r,i)})});const s=this.optionsContainer.querySelector('[data-action="swap-endpoints"]');s&&s.addEventListener("click",()=>{const i=this.settings.arrow.startArrowhead;this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=i,this.renderArrowOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()})}showPopupMenu(e,s){const i=document.querySelector(".draw-popup-menu");i&&i.remove();const a=document.createElement("div");a.className="draw-popup-menu";let r="";switch(e){case"stroke-weight":const f=this.settings.arrow.strokeWeight,g=2,b=4,w=7;r=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-stroke-slider"
                            min="1"
                            max="10"
                            value="${f}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${f===g?"active":""}" data-value="${g}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===b?"active":""}" data-value="${b}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="4"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===w?"active":""}" data-value="${w}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="6"/></svg>
                            </button>
                        </div>
                    </div>
                `;break;case"line-style":r=`
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="solid"?"active":""}" data-value="solid">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-big"?"active":""}" data-value="dashed-big">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="6,3"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-small"?"active":""}" data-value="dashed-small">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="3,2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dotted"?"active":""}" data-value="dotted">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="1,2"/></svg>
                    </button>
                `;break;case"start-arrowhead":case"end-arrowhead":const x=e==="start-arrowhead",A=x?this.settings.arrow.startArrowhead:this.settings.arrow.endArrowhead;r=`
                    <div style="padding: 8px; min-width: 180px;">
                        <div style="margin-bottom: 8px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Size
                        </div>
                        <input type="range"
                            class="draw-arrowhead-size-slider"
                            min="8"
                            max="24"
                            value="${this.settings.arrow.arrowheadSize}"
                            style="width: 100%; margin-bottom: 12px;">
                        <div style="margin-bottom: 6px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Style
                        </div>
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${A==="none"?"active":""}" data-value="none">
                                <svg width="30" height="20" viewBox="0 0 30 20"><line x1="5" y1="10" x2="25" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${A==="unfilled-arrow"?"active":""}" data-value="unfilled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?10:20}" y2="10"/>
                                    <polyline points="${x?"10,5 5,10 10,15":"20,5 25,10 20,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="filled-arrow"?"active":""}" data-value="filled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="currentColor" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?12:18}" y2="10"/>
                                    <polygon points="${x?"5,10 12,5 12,15":"25,10 18,5 18,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="circle"?"active":""}" data-value="circle">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${x?25:5}" y1="10" x2="${x?10:20}" y2="10"/>
                                    <circle cx="${x?5:25}" cy="10" r="4"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;break}a.innerHTML=r,document.body.appendChild(a);const c=s.getBoundingClientRect();a.style.position="absolute",a.style.top=`${c.bottom+5}px`,a.style.left=`${c.left}px`;const h=a.querySelector(".draw-stroke-slider");h&&h.addEventListener("input",f=>{const g=Number(f.target.value);this.settings.arrow.strokeWeight=g,this.renderArrowOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()});const m=a.querySelector(".draw-arrowhead-size-slider");m&&m.addEventListener("input",f=>{const g=Number(f.target.value);this.settings.arrow.arrowheadSize=g,Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()}),a.querySelectorAll(".draw-popup-option").forEach(f=>{f.addEventListener("click",()=>{const g=f.dataset.value;e==="stroke-weight"?(this.settings.arrow.strokeWeight=Number(g),h&&(h.value=g)):e==="line-style"?this.settings.arrow.lineStyle=g:e==="start-arrowhead"?this.settings.arrow.startArrowhead=g:e==="end-arrowhead"&&(this.settings.arrow.endArrowhead=g),this.renderArrowOptions(),a.remove(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()})}),setTimeout(()=>{const f=g=>{!a.contains(g.target)&&!s.contains(g.target)&&(a.remove(),document.removeEventListener("click",f))};document.addEventListener("click",f)},0)}renderTextOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="text-color" title="Text Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.text.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-action="decrease-size" title="Decrease Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;">−</span>
                </button>
                <div style="min-width: 35px; text-align: center; font-size: 0.85em; color: var(--c-text);">
                    ${this.settings.text.size}px
                </div>
                <button class="draw-toolbar-button" data-action="increase-size" title="Increase Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;">+</span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.background?"active":""}" data-action="toggle-background" title="Background Fill">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="${this.settings.text.background?"currentColor":"none"}" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.superscript?"active":""}" data-action="toggle-superscript" title="Superscript">
                    <span style="font-size: 0.85em;">x<sup style="font-size: 0.7em;">2</sup></span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.subscript?"active":""}" data-action="toggle-subscript" title="Subscript">
                    <span style="font-size: 0.85em;">x<sub style="font-size: 0.7em;">2</sub></span>
                </button>
            </div>
        `,this.attachCommonToolbarListeners();const e=this.optionsContainer.querySelector('[data-action="decrease-size"]');e&&e.addEventListener("click",()=>{const c=Math.max(8,this.settings.text.size-2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected())});const s=this.optionsContainer.querySelector('[data-action="increase-size"]');s&&s.addEventListener("click",()=>{const c=Math.min(72,this.settings.text.size+2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected())});const i=this.optionsContainer.querySelector('[data-action="toggle-background"]');i&&i.addEventListener("click",()=>{this.settings.text.background=!this.settings.text.background,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()});const a=this.optionsContainer.querySelector('[data-action="toggle-superscript"]');a&&(a.addEventListener("mousedown",c=>{c.preventDefault()}),a.addEventListener("click",()=>{Ut.applyInlineFormatting("superscript")}));const r=this.optionsContainer.querySelector('[data-action="toggle-subscript"]');r&&(r.addEventListener("mousedown",c=>{c.preventDefault()}),r.addEventListener("click",()=>{Ut.applyInlineFormatting("subscript")}))}renderMarkerOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="marker-color" title="Marker Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.marker.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="marker-size" title="Marker Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.marker.size==="small"?"1":this.settings.marker.size==="medium"?"3":"5"}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderHighlighterOptions(){const e=(s,i)=>{const a=parseInt(s.slice(1,3),16),r=parseInt(s.slice(3,5),16),c=parseInt(s.slice(5,7),16);return`rgba(${a}, ${r}, ${c}, ${i})`};this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="highlighter-color" title="Highlighter Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${e(this.settings.highlighter.color,.4)}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="highlighter-size" title="Highlighter Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.highlighter.size==="small"?"2":this.settings.highlighter.size==="medium"?"4":"6"}">
                        <rect x="6" y="8" width="12" height="8" rx="1"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderLassoOptions(){this.optionsContainer.innerHTML=`
            <div style="padding: var(--space-2); text-align: center;">
                <p style="color: var(--c-text-muted); font-size: var(--font-size-sm); margin: 0;">
                    Draw around notes to select and drag them as a group.
                </p>
            </div>
        `}attachCommonToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(s=>{s.addEventListener("click",()=>{const i=s.dataset.popup;this.showCommonPopupMenu(i,s)})})}showCommonPopupMenu(e,s){const i=document.querySelector(".draw-popup-menu");i&&i.remove();const a=document.createElement("div");a.className="draw-popup-menu";let r="",c="",h="";if(e.startsWith("text-")?(c="text",h=e.replace("text-","")):e.startsWith("marker-")?(c="marker",h=e.replace("marker-","")):e.startsWith("highlighter-")&&(c="highlighter",h=e.replace("highlighter-","")),h==="color"){const g=c==="text"?["#4a90e2","#2d2d2d","#d66573","#68a03f"]:["#4a90e2","#2d2d2d","#d66573","#68a03f","#ffc107"],b=c==="highlighter";r=g.map(w=>{const x=b?this.hexToRgba(w,.4):w;return`
                    <button class="draw-popup-option ${this.settings[c].color===w?"active":""}" data-value="${w}">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background-color: ${x};"></div>
                    </button>
                `}).join("")}else if(h==="size")if(c==="text")r=`
                    <button class="draw-popup-option ${this.settings.text.size===12?"active":""}" data-value="12">
                        <span style="font-size: 0.8em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===16?"active":""}" data-value="16">
                        <span style="font-size: 1em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===20?"active":""}" data-value="20">
                        <span style="font-size: 1.2em; font-weight: bold;">A</span>
                    </button>
                `;else{const g=c==="marker"?1:5,b=c==="marker"?15:30,w=this.settings[c].size,x=c==="marker"?3:8,A=c==="marker"?6:15,P=c==="marker"?10:22;r=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-size-slider"
                            min="${g}"
                            max="${b}"
                            value="${w}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${w===x?"active":""}" data-value="${x}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===A?"active":""}" data-value="${A}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="4"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===P?"active":""}" data-value="${P}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `}a.innerHTML=r,document.body.appendChild(a);const m=s.getBoundingClientRect();a.style.position="absolute",a.style.top=`${m.bottom+5}px`,a.style.left=`${m.left}px`;const f=a.querySelector(".draw-size-slider");f&&f.addEventListener("input",g=>{const b=Number(g.target.value);this.settings[c].size=b,c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()}),a.querySelectorAll(".draw-popup-option").forEach(g=>{g.addEventListener("click",()=>{const b=g.dataset.value;h==="color"?this.settings[c].color=b:h==="size"&&(this.settings[c].size=Number(b),f&&(f.value=b)),c==="text"?this.renderTextOptions():c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected(),a.remove()})}),setTimeout(()=>{const g=b=>{!a.contains(b.target)&&!s.contains(b.target)&&(a.remove(),document.removeEventListener("click",g))};document.addEventListener("click",g)},0)}hexToRgba(e,s){const i=parseInt(e.slice(1,3),16),a=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return`rgba(${i}, ${a}, ${r}, ${s})`}getCurrentTool(){return this.currentTool}getCurrentSettings(){return this.currentTool?this.settings[this.currentTool]:null}}const tp=new ox;class ax{constructor(){this.meter=null,this.isInitialized=!1,this.meterWrapper=null,this.meterPlaceholder=null,this.meterSource=null,this.settingsPanel=null,this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.permissionState="unknown",this.errorMessage=null}initialize(){this.isInitialized||(this.cacheDOMElements(),this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",e=>this.handlePitchPaintingToggle(e)),this.isInitialized=!0)}cacheDOMElements(){this.meterWrapper=document.getElementById("mic-meter-wrapper"),this.meterPlaceholder=document.getElementById("meter-placeholder"),this.settingsPanel=document.getElementById("meter-settings-panel"),this.settingsBtn=document.getElementById("meter-settings-btn"),this.sizeSelect=document.getElementById("meter-size-select"),this.fpsSelect=document.getElementById("meter-fps-select"),this.batterySaverCheckbox=document.getElementById("meter-battery-saver"),this.calibrateBtn=document.getElementById("meter-calibrate-btn"),this.resetBtn=document.getElementById("meter-reset-btn"),this.meterWrapper}setupEventListeners(){this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>this.toggleSettingsPanel()),this.sizeSelect&&this.sizeSelect.addEventListener("change",e=>this.handleSizeChange(e.target.value)),this.fpsSelect&&this.fpsSelect.addEventListener("change",e=>this.handleFpsChange(parseInt(e.target.value))),this.batterySaverCheckbox&&this.batterySaverCheckbox.addEventListener("change",e=>this.handleBatterySaverChange(e.target.checked)),this.calibrateBtn&&this.calibrateBtn.addEventListener("click",()=>this.handleAutoCalibrate()),this.resetBtn&&this.resetBtn.addEventListener("click",()=>this.handleReset())}async handlePitchPaintingToggle(e){e?await this.startMeter():this.stopMeter()}async startMeter(){if(!this.meter)try{await this.ensureMicrophoneAccess();const e=Q.context;if(!e||e.state==="suspended")throw new Error("Audio context not available or suspended");await this.createMeterFromExistingMic(),this.updateUI()}catch(e){this.handleMeterError(e)}}async ensureMicrophoneAccess(){this.permissionState="pending",this.updateUI();try{this.permissionState="granted"}catch{throw this.permissionState="denied",new Error("Microphone access denied. Please check your browser permissions.")}}async createMeterFromExistingMic(){if(!this.meterWrapper)throw new Error("Meter wrapper not found - cannot create meter");this.meterWrapper.innerHTML="";const e=this.getMeterDimensions(),s=(await ga(async()=>{const{default:a}=await import("./Meter-Ccaw6VeE.js");return{default:a}},[])).default,i=(await ga(async()=>{const{default:a}=await Promise.resolve().then(()=>ex);return{default:a}},void 0)).default;if(!i||!i.micSplitter)throw new Error("PitchPaintService microphone splitter not available");try{this.meter=new s({target:this.meterWrapper,size:e,fps:this.settings.fps,colors:{fill:"#1a1a1a",accent:"#00ff88"},floorDb:this.settings.noiseFloor,ceilingDb:5})}catch(a){throw a}try{this.meter.connect(i.micSplitter),this.meterSource=i.micSplitter}catch(a){throw a}this.meterWrapper.classList.add("active"),this.meterWrapper.classList.remove("error")}stopMeter(){this.meter&&(this.meter.disconnect(),this.meter.destroy(),this.meter=null),this.meterSource&&(this.meterSource=null),this.meterWrapper.innerHTML=`
      <div class="meter-placeholder" id="meter-placeholder">
      </div>
    `,this.meterPlaceholder=document.getElementById("meter-placeholder"),this.meterWrapper.classList.remove("active"),this.updateUI()}getMeterDimensions(){const e=this.meterWrapper.clientWidth||200,s=this.meterWrapper.clientHeight||100;if(this.meterWrapper.classList.contains("mic-meter-wrapper-inline"))return[e,36];if(this.meterWrapper.classList.contains("mic-meter-wrapper-vertical"))return[e,s];const r=this.settings.size==="compact"?48:72;return[e,r]}updateUI(){if(this.meterWrapper){if(this.meterWrapper.classList.remove("compact","wide"),this.meterWrapper.classList.add(this.settings.size),this.updateAccessibilityAttributes(),this.meterPlaceholder){let e="",s="";const i=this.meterWrapper.classList.contains("mic-meter-wrapper-inline");this.permissionState==="denied"?(e=i?"Mic access denied":"Microphone access denied. Click to retry.",s="error"):this.permissionState==="pending"?(e=i?"Requesting access...":"Requesting microphone access...",s="pending"):u.state.paint.isMicPaintActive?this.meter?(e="",s="active"):(e=i?"Starting...":"Starting meter...",s="pending"):(e="",s="disabled");const a=this.meterPlaceholder.querySelector(".meter-status-text");a&&(a.textContent=e),this.meterWrapper.classList.remove("error","pending","disabled"),s&&this.meterWrapper.classList.add(s)}this.updateSettingsUI()}}updateAccessibilityAttributes(){this.meterWrapper&&(this.meterWrapper.setAttribute("role","meter"),this.meterWrapper.setAttribute("aria-label","Microphone Level Meter"),this.meter&&this.meter.active?(this.meterWrapper.setAttribute("aria-valuenow","0"),this.meterWrapper.setAttribute("aria-valuemin",this.settings.noiseFloor.toString()),this.meterWrapper.setAttribute("aria-valuemax","5"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level active")):(this.meterWrapper.removeAttribute("aria-valuenow"),this.meterWrapper.removeAttribute("aria-valuemin"),this.meterWrapper.removeAttribute("aria-valuemax"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level inactive")),window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches&&this.meterWrapper.setAttribute("data-reduced-motion","true"))}updateSettingsUI(){this.sizeSelect&&(this.sizeSelect.value=this.settings.size),this.fpsSelect&&(this.fpsSelect.value=this.settings.fps),this.batterySaverCheckbox&&(this.batterySaverCheckbox.checked=this.settings.batterySaver)}toggleSettingsPanel(){this.settingsPanel&&this.settingsPanel.classList.toggle("hidden")}handleSizeChange(e){if(this.settings.size=e,this.meter){const s=this.getMeterDimensions();this.meter.resize(s[0],s[1])}this.updateUI()}handleFpsChange(e){this.settings.fps=e}handleBatterySaverChange(e){this.settings.batterySaver=e}async handleAutoCalibrate(){if(this.meter){this.calibrateBtn.disabled=!0,this.calibrateBtn.textContent="Stay quiet...";try{await new Promise(e=>setTimeout(e,2e3)),this.settings.noiseFloor=-65,this.settings.autoCalibrated=!0,this.calibrateBtn.textContent="Calibrated ✓",setTimeout(()=>{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1},1500)}catch{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1}}}handleReset(){if(this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.updateSettingsUI(),this.meter){const e=this.getMeterDimensions();this.meter.resize(e[0],e[1])}}handleMeterError(e){this.errorMessage=e.message,this.meterWrapper.classList.add("error"),(e.message.includes("denied")||e.message.includes("permission"))&&this.showPermissionRetryPrompt(),this.updateUI()}showPermissionRetryPrompt(){let e=this.meterWrapper.querySelector(".meter-permission-prompt");if(!e){e=document.createElement("div"),e.className="meter-permission-prompt",e.innerHTML=`
        <p>Microphone access is required for the level meter.</p>
        <button class="meter-retry-btn">Grant Permission</button>
        <button class="meter-help-btn">Help</button>
      `,this.meterWrapper.appendChild(e);const s=e.querySelector(".meter-retry-btn"),i=e.querySelector(".meter-help-btn");s.addEventListener("click",()=>this.retryPermission()),i.addEventListener("click",()=>this.showPermissionHelp())}}async retryPermission(){try{const e=this.meterWrapper.querySelector(".meter-permission-prompt");e&&e.remove(),this.permissionState="unknown",this.meterWrapper.classList.remove("error"),u.state.paint.isMicPaintActive&&await this.startMeter()}catch(e){this.handleMeterError(e)}}showPermissionHelp(){alert(`
To enable the microphone level meter:

1. Look for a microphone icon in your browser's address bar
2. Click it and select "Allow"
3. If you don't see the icon, go to your browser settings:
   - Chrome: Settings > Privacy and security > Site Settings > Microphone
   - Firefox: Settings > Privacy & Security > Permissions > Microphone
   - Safari: Settings > Websites > Microphone

4. Find this website and set it to "Allow"
5. Refresh the page if needed
    `)}dispose(){this.stopMeter(),this.isInitialized=!1}}const rx=new ax;class lx{constructor(){this.element=null,this.isVisible=!1,this.hideTimeout=null}initialize(){this.element=document.createElement("div"),this.element.className="zoom-indicator",this.element.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        `,document.body.appendChild(this.element),u.on("zoomIn",()=>this.show()),u.on("zoomOut",()=>this.show())}show(){if(!this.element)return;let e=100,s="";if(xt.getViewportInfo){const i=xt.getViewportInfo();if(e=Math.round(i.zoomLevel*100),i.canSeeFullRange)s=" (Full Range)";else{const a=i.startRank||i.startRow,r=i.endRank||i.endRow;s=` (~${Math.floor(r-a+1)} semitones)`}}this.element.textContent=`Zoom: ${e}%${s}`,this.element.style.opacity="1",this.isVisible=!0,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>this.hide(),2e3)}hide(){!this.element||!this.isVisible||(this.element.style.opacity="0",this.isVisible=!1,clearTimeout(this.hideTimeout))}dispose(){this.element&&(document.body.removeChild(this.element),this.element=null),clearTimeout(this.hideTimeout)}}const cx=new lx,ym={enableModulationTool(){u.setSelectedTool("modulation"),console.log("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),console.log("[MODULATION TEST] Click marker labels to toggle 2:3 ↔ 3:2"),console.log("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const e=this.findNearestGridLine(200),s=this.findMeasureIndexForX(e.x),i=u.addModulationMarker(s,ks.COMPRESSION_2_3,e.x,e.columnIndex);return console.log("[MODULATION TEST] Added test marker at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",200,")"),i},addTestMarker2(){const e=this.findNearestGridLine(400),s=this.findMeasureIndexForX(e.x),i=u.addModulationMarker(s,ks.EXPANSION_3_2,e.x,e.columnIndex);return console.log("[MODULATION TEST] Added test marker 2 at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",400,")"),i},findNearestGridLine(n){const e=u.state;let s=0,i=0,a=1/0,r=0;for(let c=0;c<e.columnWidths.length;c++){const h=Math.abs(r-n);h<a&&(a=h,i=r,s=c);const m=e.columnWidths[c]||0;r+=m*e.cellWidth}return console.log("[MODULATION TEST] findNearestGridLine:",{targetX:n,closestColumnIndex:s,closestX:i,minDistance:a}),{columnIndex:s,x:i}},findMeasureIndexForX(n){const e=u.state.cellWidth||40,s=5,i=Math.round(n/e);return Math.max(1,Math.round(i/s))},clearAllMarkers(){[...u.state.modulationMarkers||[]].forEach(e=>{u.removeModulationMarker(e.id)}),console.log("[MODULATION TEST] Cleared all markers")},testMapping(){const n=u.state.baseMicrobeatPx||u.state.cellWidth||40;if(console.log("[MODULATION TEST] Base microbeat pixels:",n),console.log("[MODULATION TEST] Modulation markers:",u.state.modulationMarkers),window.getModulationMapping){const e=window.getModulationMapping();console.log("[MODULATION TEST] Coordinate mapping:",e),[0,100,200,300,400,500].forEach(i=>{const a=e.canvasXToMicrobeat(i),r=e.microbeatToCanvasX(a);console.log(`[MODULATION TEST] x=${i} → microbeat=${a.toFixed(3)} → x=${r.toFixed(1)}`)})}},testVisualExpansion(){console.log("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const n=this.addTestMarker2();console.log("[MODULATION TEST] Added 3:2 expansion marker:",n),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show expansion after x=400"),console.log("[MODULATION TEST] Container should be wider to accommodate expansion"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){console.log("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const n=this.addTestMarker();console.log("[MODULATION TEST] Added 2:3 compression marker:",n),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show compression after x=200"),console.log("[MODULATION TEST] Container should adjust to accommodate compression"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){console.log("[MODULATION TEST] Current state:",{selectedTool:u.state.selectedTool,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.baseMicrobeatPx,cellWidth:u.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=ym);function hx(){cx.initialize(),document.addEventListener("keydown",n=>{const e=document.activeElement.tagName.toLowerCase();["input","textarea"].includes(e)||((n.ctrlKey||n.metaKey)&&(n.key==="+"||n.key==="=")&&(n.preventDefault(),u.emit("zoomIn")),(n.ctrlKey||n.metaKey)&&n.key==="-"&&(n.preventDefault(),u.emit("zoomOut")),(n.ctrlKey||n.metaKey)&&n.key==="0"&&(n.preventDefault(),xt.resetZoom&&xt.resetZoom()))})}function ux(){window.debugZoom={info:()=>xt.getViewportInfo?xt.getViewportInfo():"Viewport info not available",zoomTo:n=>{T.debug("Debug Tools",`Setting zoom to ${n}`,null,"zoom")},scrollTo:n=>{if(T.debug("Debug Tools",`Scrolling to position ${n}`,null,"scroll"),xt.scroll){const s=xt.getViewportInfo().scrollPosition*(u.state.fullRowData.length*u.state.cellHeight*.5),i=n*(u.state.fullRowData.length*u.state.cellHeight*.5);xt.scroll(i-s)}},goToNote:n=>{xt.scrollToNote?xt.scrollToNote(n):T.warn("Debug Tools",`scrollToNote not available. Requested: ${n}`,null,"debug")}}}let ep=!1,Zo=null;window.initAudio=async()=>ep?!0:Zo||(Zo=(async()=>{try{return Q.context.state!=="running"&&(await Q.start(),T.info("Main.js","AudioContext started successfully")),ep=!0,!0}catch(n){return T.error("Main.js","Could not start AudioContext",n),Zo=null,!1}})(),Zo);let sp=!1;const io=()=>{sp||(sp=!0,window.initAudio().catch(n=>console.warn("Failed to initialize audio:",n)),document.removeEventListener("click",io,!0),document.removeEventListener("keydown",io,!0),document.removeEventListener("touchstart",io,!0))};document.addEventListener("click",io,!0);document.addEventListener("keydown",io,!0);document.addEventListener("touchstart",io,!0);const oo={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,initialized:!1};function tn(n){oo[n]=!0}function Qo(n,e=5e3){return new Promise((s,i)=>{if(oo[n]){s();return}const a=Date.now(),r=()=>{oo[n]?s():Date.now()-a>e?i(new Error(`Component ${n} not ready within ${e}ms`)):setTimeout(r,50)};r()})}document.addEventListener("DOMContentLoaded",async()=>{window.initStartTime=Date.now(),T.info("Main.js","DOMContentLoaded event fired"),T.section("STARTING INITIALIZATION");try{(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&jp(),oi.init(),tn("domCache"),(()=>{const h=oi.get("appContainer")||document.getElementById("app-container");h&&["click","keydown","touchstart"].forEach(f=>{h.addEventListener(f,window.initAudio,{once:!0})})})(),lb(u.state);const e=u.state.pitchRange||{topIndex:0,bottomIndex:Pe.length-1},s=Math.max(0,Math.min(Pe.length-1,e.topIndex??0)),i=Math.max(s,Math.min(Pe.length-1,e.bottomIndex??Pe.length-1));u.state.pitchRange={topIndex:s,bottomIndex:i},u.state.fullRowData=Pe.slice(s,i+1);const a=xt.init();tn("layoutService"),Ph.setContexts(a),tn("canvasContextService"),Gt.init(),tn("synthEngine"),en.initialize().catch(h=>{console.warn("[INIT] RhythmPlaybackService initialization deferred (needs user interaction):",h)}),tn("rhythmPlaybackService"),Ui.init(),tn("transportService"),ob(),ub(),await Qo("layoutService"),await Qo("canvasContextService"),pb.init(),tn("scrollSync"),Pd(u.state,"core-services-initialization"),await Qo("scrollSync"),Bb.init(),Bc.init(),x_.init(),$h.init(),jr.init(),tn("uiComponents"),await Qo("uiComponents"),m_(),E0(),y_(),tn("audioComponents"),Pd(u.state,"audio-components-initialization"),dx(),px(),T.initStart("Static Waveform Visualizer"),T_()?T.initSuccess("Static Waveform Visualizer"):T.initFailed("Static Waveform Visualizer");const{default:r}=await ga(async()=>{const{default:h}=await Promise.resolve().then(()=>L_);return{default:h}},void 0);window.effectsCoordinator=r,T.initStart("Effects Managers"),Yd.init(),Zd.init(),r.init(),Bn.init(),Qd.init(),window.animationEffectsManager=Yd,window.audioEffectsManager=Zd,window.effectsController=Bn,window.positionEffectsController=Qd,T.initSuccess("Effects Managers"),T.initStart("Paint components"),Vh.initialize(),yh.initialize(),nx.initialize(),await Kd.initialize(),window.PaintPlaybackService=Kd,rx.initialize(),T.initSuccess("Paint components"),T.initStart("Draw Tools"),Ut.initialize(),tp.initialize(),window.drawToolsController=tp,window.annotationService=Ut,T.initSuccess("Draw Tools"),T.initStart("Drum components"),Wn.initialize(),T.initSuccess("Drum components"),hx(),ux(),await Qo("audioComponents"),T.section("SETTING UP STATE SUBSCRIPTIONS");const c=()=>{oo.uiComponents&&(Bc.renderPitchGrid(),Bc.renderDrumGrid(),Ut.resize())};u.on("notesChanged",()=>{c()}),u.on("stampPlacementsChanged",()=>{c()}),u.on("tripletPlacementsChanged",()=>{c()}),u.on("modulationMarkersChanged",()=>{if(T.event("Main","modulationMarkersChanged event received, recalculating layout",null,"state"),!oo.layoutService){T.warn("Main","LayoutService not ready, skipping layout recalculation");return}xt.recalculateLayout(),T.debug("Main","Layout recalculated for modulation, calling renderAll()",null,"state"),c(),T.debug("Main","renderAll() completed, calling renderMacrobeatTools() for modulation",null,"state"),Yi.renderMacrobeatTools(),T.debug("Main","modulationMarkersChanged handling complete",null,"state")}),u.on("rhythmStructureChanged",()=>{T.event("Main","rhythmStructureChanged event received, recalculating layout",null,"state"),xt.recalculateLayout(),T.debug("Main","Layout recalculated, calling renderAll()",null,"state"),c(),T.debug("Main","renderAll() completed, calling renderMacrobeatTools()",null,"state"),Yi.renderMacrobeatTools(),T.debug("Main","rhythmStructureChanged handling complete",null,"state")}),u.on("layoutConfigChanged",()=>{c(),Yi.renderMacrobeatTools()}),u.on("zoomIn",()=>{T.event("Main","Zoom in event received",null,"zoom"),xt.zoomIn()}),u.on("zoomOut",()=>{T.event("Main","Zoom out event received",null,"zoom"),xt.zoomOut()}),T.section("PERFORMING INITIAL RENDER"),u.setSelectedTool("note"),u.setSelectedNote("circle","#4a90e2"),c(),Yi.renderMacrobeatTools(),W_(),tn("initialized"),T.section("INITIALIZATION COMPLETE"),window.ModulationTest=ym,setTimeout(()=>{xt.getViewportInfo},1e3)}catch(n){console.error("[INIT] ❌ INITIALIZATION FAILED:",n),console.error("[INIT] Error stack:",n.stack),console.error("[INIT] Component readiness at failure:",oo),T.error("Main.js","Initialization failed",n);const e=document.createElement("div");e.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,e.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${n.message}</pre>
                <pre>Stack: ${n.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(e)}});function dx(){const n=document.querySelector(".rhythm-tabs-container"),e=document.querySelector(".rhythm-tabs"),s=document.querySelector(".rhythm-tab-content"),i=document.querySelectorAll(".rhythm-tab-button"),a=document.querySelectorAll(".rhythm-tab-panel");if(n&&window.getComputedStyle(n),e&&window.getComputedStyle(e),console.log("[Rhythm Tabs Init]",{rhythmContainer:n?"found":"NOT FOUND",rhythmTabs:e?"found":"NOT FOUND",rhythmTabContent:s?"found":"NOT FOUND",buttonsCount:i.length,panelsCount:a.length,buttons:Array.from(i).map(r=>({text:r.textContent,dataTab:r.getAttribute("data-rhythm-tab")})),panels:Array.from(a).map(r=>({id:r.id,hasActiveClass:r.classList.contains("active")}))}),!i.length||!a.length){console.warn("[Rhythm Tabs] No buttons or panels found, aborting");return}i.forEach((r,c)=>{r.addEventListener("click",h=>{const m=r.getAttribute("data-rhythm-tab");console.log("[Rhythm Tab Click]",{clickedButton:r.textContent,targetTab:m,targetPanelId:`${m}-panel`}),i.forEach(g=>{console.log("[Removing active from button]",g.textContent),g.classList.remove("active")}),a.forEach(g=>{console.log("[Removing active from panel]",g.id),g.classList.remove("active")}),r.classList.add("active"),console.log("[Added active to button]",r.textContent);const f=document.getElementById(`${m}-panel`);f?(f.classList.add("active"),console.log("[Added active to panel]",f.id,{display:getComputedStyle(f).display,hasActiveClass:f.classList.contains("active")})):console.warn("[Target panel NOT FOUND]",`${m}-panel`),console.log("[Final state after click]",{allPanels:Array.from(a).map(g=>({id:g.id,hasActive:g.classList.contains("active"),display:getComputedStyle(g).display}))})})})}function px(){const n=document.getElementById("flat-toggle-btn"),e=document.getElementById("sharp-toggle-btn"),s=document.getElementById("hz-toggle-btn");if(!n||!e||!s){console.warn("[Accidental Buttons] One or more buttons not found");return}let i=n.classList.contains("active"),a=e.classList.contains("active");s.addEventListener("click",()=>{s.classList.contains("active")?(s.classList.remove("active"),s.setAttribute("aria-pressed","false"),n.classList.toggle("active",i),n.setAttribute("aria-pressed",i),e.classList.toggle("active",a),e.setAttribute("aria-pressed",a),u.state.showFrequencyLabels=!1,u.emit("layoutConfigChanged")):(i=n.classList.contains("active"),a=e.classList.contains("active"),s.classList.add("active"),s.setAttribute("aria-pressed","true"),n.classList.remove("active"),n.setAttribute("aria-pressed","false"),e.classList.remove("active"),e.setAttribute("aria-pressed","false"),u.state.showFrequencyLabels=!0,u.emit("layoutConfigChanged"))}),n.addEventListener("click",()=>{s.classList.contains("active")&&(s.classList.remove("active"),s.setAttribute("aria-pressed","false"),u.state.showFrequencyLabels=!1);const c=!n.classList.contains("active");n.classList.toggle("active",c),n.setAttribute("aria-pressed",c),i=c,u.emit("layoutConfigChanged")}),e.addEventListener("click",()=>{s.classList.contains("active")&&(s.classList.remove("active"),s.setAttribute("aria-pressed","false"),u.state.showFrequencyLabels=!1);const c=!e.classList.contains("active");e.classList.toggle("active",c),e.setAttribute("aria-pressed",c),a=c,u.emit("layoutConfigChanged")}),console.log("[Accidental Buttons] Initialized Hz, Flat, and Sharp buttons")}
