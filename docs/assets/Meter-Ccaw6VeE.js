const c={normalize(a,t,e){return(a-t)/(e-t)},scale(a,t,e,i,s){return t===e?i:(a-t)*(s-i)/(e-t)+i}};class m{constructor(t,e){const i=typeof t=="string"?document.querySelector(t):t;if(!i)throw new Error("Meter: parent element not found.");this.element=document.createElement("canvas"),this.context=this.element.getContext("2d"),this.scale=window.devicePixelRatio||1,this.lastRefreshTime=0,this.millisecondsPerFrame=0,i.appendChild(this.element),this.setFramerate(e)}resize(t,e){const i=Math.max(1,Math.floor(t*this.scale)),s=Math.max(1,Math.floor(e*this.scale));this.element.width=i,this.element.height=s,this.element.style.width=`${t}px`,this.element.style.height=`${e}px`}setFramerate(t){this.millisecondsPerFrame=t?1e3/t:0}refreshIntervalReached(t){return this.millisecondsPerFrame?t-this.lastRefreshTime>=this.millisecondsPerFrame?(this.lastRefreshTime=t,!0):!1:!0}}class f{constructor(t={}){const{target:e=document.body,size:i=[30,100],fps:s=void 0,colors:h={},floorDb:r=-70,ceilingDb:n=5}=t;this.width=i[0],this.height=i[1],this.colors={fill:"#eee",accent:"#2bb",...h},this.floorDb=r,this.ceilingDb=n,this.channels=2,this.splitter=null,this.analysers=[],this.bufferLength=0,this.dataArray=null,this.active=!1,this.source=null,this.dbs=[];const l=typeof e=="string"?document.querySelector(e):e;this.canvas=new m(l,s),this.element=this.canvas.element,this.canvas.resize(this.width,this.height),this._updateBarGeometry(),this._renderOnce(),this.element.style.cursor="pointer",this.element.addEventListener("click",()=>{this.source&&(this.active=!this.active,this.render())})}setFramerate(t){this.canvas.setFramerate(t)}connect(t,e){if(!t||!t.context)throw new Error("Meter.connect: expected a Web Audio AudioNode.");this.source&&this.disconnect(),this.channels=Math.max(1,e||t.channelCount||2);const i=t.context;this.splitter=i.createChannelSplitter(this.channels),this.analysers=[];for(let s=0;s<this.channels;s++){const h=i.createAnalyser();h.fftSize=1024,h.smoothingTimeConstant=1,this.splitter.connect(h,s),this.analysers.push(h)}this.bufferLength=this.analysers[0].frequencyBinCount,this.dataArray=new Float32Array(this.bufferLength),this.dbs=new Array(this.channels).fill(-1/0),this.source=t,this.source.connect(this.splitter),this._updateBarGeometry(),this.active=!0,this.render()}disconnect(){if(this.source&&this.splitter)try{this.source.disconnect(this.splitter)}catch{}this.splitter=null,this.analysers=[],this.bufferLength=0,this.dataArray=null,this.source=null,this.active=!1,this.dbs=[],this._renderOnce()}resize(t,e){this.width=t,this.height=e,this.canvas.resize(t,e),this._updateBarGeometry(),this._renderOnce()}destroy(){this.disconnect(),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element)}render(t=performance.now()){if(!(this.active&&(requestAnimationFrame(this.render.bind(this)),!this.canvas.refreshIntervalReached(t))))if(this.active&&typeof performance<"u"){const e=performance.now();this._drawFrame();const s=performance.now()-e;s>16&&Math.random()<.01&&console.warn(`Meter: Slow frame detected: ${s.toFixed(2)}ms`)}else this._drawFrame()}_updateBarGeometry(){this._deviceWidth=this.element.width,this._deviceHeight=this.element.height,this._barWidth=Math.max(1,Math.floor(this._deviceWidth/Math.max(1,this.channels)))}_renderOnce(){const t=this.canvas.context;t.fillStyle=this.colors.fill,t.fillRect(0,0,this.element.width,this.element.height)}_drawFrame(){const t=this.canvas.context,e=this._deviceWidth,i=this._deviceHeight;if(t.fillStyle=this.colors.fill,t.fillRect(0,0,e,i),!!this.analysers.length)for(let s=0;s<this.analysers.length;s++){let h=this._sampleDb(this.analysers[s],this.dataArray);if(isFinite(h)||(h=this.dbs[s]>this.floorDb-130&&isFinite(this.dbs[s])?this.dbs[s]-1:-1/0),this.dbs[s]=h,h>this.floorDb){const r=c.normalize(h,this.floorDb,this.ceilingDb),n=r*r,l=c.scale(n,0,1,i,0);t.fillStyle=this.colors.accent;const o=s*this._barWidth,d=Math.max(1,this._barWidth-1);t.fillRect(o,l,d,i-l)}}}_sampleDb(t,e){t.getFloatTimeDomainData(e);let i=0;for(let r=0;r<e.length;r++){const n=e[r];i+=n*n}const s=Math.sqrt(i/e.length);return 20*Math.log10(Math.max(s,1e-12))}}export{f as default};
