var Yg=Object.defineProperty;var Zg=(n,e,s)=>e in n?Yg(n,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):n[e]=s;var Es=(n,e,s)=>Zg(n,typeof e!="symbol"?e+"":e,s);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const a of r)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&i(c)}).observe(document,{childList:!0,subtree:!0});function s(r){const a={};return r.integrity&&(a.integrity=r.integrity),r.referrerPolicy&&(a.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?a.credentials="include":r.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(r){if(r.ep)return;r.ep=!0;const a=s(r);fetch(r.href,a)}})();const Qg="modulepreload",Jg=function(n){return"/Student-Notation/"+n},sd={},gr=function(e,s,i){let r=Promise.resolve();if(s&&s.length>0){document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),h=(c==null?void 0:c.nonce)||(c==null?void 0:c.getAttribute("nonce"));r=Promise.allSettled(s.map(m=>{if(m=Jg(m),m in sd)return;sd[m]=!0;const f=m.endsWith(".css"),g=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${g}`))return;const y=document.createElement("link");if(y.rel=f?"stylesheet":Qg,f||(y.as="script"),y.crossOrigin="",y.href=m,h&&y.setAttribute("nonce",h),document.head.appendChild(y),f)return new Promise((w,C)=>{y.addEventListener("load",w),y.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${m}`)))})}))}function a(c){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=c,window.dispatchEvent(h),!h.defaultPrevented)throw c}return r.then(c=>{for(const h of c||[])h.status==="rejected"&&a(h.reason);return e().catch(a)})};function Kg(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var ga={exports:{}};/*! For license information please see Tone.js.LICENSE.txt */var tv=ga.exports,nd;function ev(){return nd||(nd=1,function(n,e){(function(s,i){n.exports=i()})(typeof self<"u"?self:tv,()=>(()=>{var s={871:function(c,h,m){(function(f,g,y,w){var C=function(it,ht,ut){return{endTime:ht,insertTime:ut,type:"exponentialRampToValue",value:it}},A=function(it,ht,ut){return{endTime:ht,insertTime:ut,type:"linearRampToValue",value:it}},I=function(it,ht){return{startTime:ht,type:"setValue",value:it}},E=function(it,ht,ut){return{duration:ut,startTime:ht,type:"setValueCurve",values:it}},O=function(it,ht,ut){var Ct=ut.startTime,pt=ut.target,Nt=ut.timeConstant;return pt+(ht-pt)*Math.exp((Ct-it)/Nt)},P=function(it){return it.type==="exponentialRampToValue"},R=function(it){return it.type==="linearRampToValue"},q=function(it){return P(it)||R(it)},G=function(it){return it.type==="setValue"},U=function(it){return it.type==="setValueCurve"},j=function it(ht,ut,Ct,pt){var Nt=ht[ut];return Nt===void 0?pt:q(Nt)||G(Nt)?Nt.value:U(Nt)?Nt.values[Nt.values.length-1]:O(Ct,it(ht,ut-1,Nt.startTime,pt),Nt)},Y=function(it,ht,ut,Ct,pt){return ut===void 0?[Ct.insertTime,pt]:q(ut)?[ut.endTime,ut.value]:G(ut)?[ut.startTime,ut.value]:U(ut)?[ut.startTime+ut.duration,ut.values[ut.values.length-1]]:[ut.startTime,j(it,ht-1,ut.startTime,pt)]},tt=function(it){return it.type==="cancelAndHold"},ot=function(it){return it.type==="cancelScheduledValues"},dt=function(it){return tt(it)||ot(it)?it.cancelTime:P(it)||R(it)?it.endTime:it.startTime},yt=function(it,ht,ut,Ct){var pt=Ct.endTime,Nt=Ct.value;return ut===Nt?Nt:0<ut&&0<Nt||ut<0&&Nt<0?ut*Math.pow(Nt/ut,(it-ht)/(pt-ht)):0},Tt=function(it,ht,ut,Ct){return ut+(it-ht)/(Ct.endTime-ht)*(Ct.value-ut)},me=function(it,ht){var ut=ht.duration,Ct=ht.startTime,pt=ht.values;return function(Nt,jt){var Bt=Math.floor(jt),ee=Math.ceil(jt);return Bt===ee?Nt[Bt]:(1-(jt-Bt))*Nt[Bt]+(1-(ee-jt))*Nt[ee]}(pt,(it-Ct)/ut*(pt.length-1))},Wt=function(it){return it.type==="setTarget"},Qt=function(){return w(function it(ht){y(this,it),this._automationEvents=[],this._currenTime=0,this._defaultValue=ht},[{key:Symbol.iterator,value:function(){return this._automationEvents[Symbol.iterator]()}},{key:"add",value:function(it){var ht=dt(it);if(tt(it)||ot(it)){var ut=this._automationEvents.findIndex(function(De){return ot(it)&&U(De)?De.startTime+De.duration>=ht:dt(De)>=ht}),Ct=this._automationEvents[ut];if(ut!==-1&&(this._automationEvents=this._automationEvents.slice(0,ut)),tt(it)){var pt=this._automationEvents[this._automationEvents.length-1];if(Ct!==void 0&&q(Ct)){if(pt!==void 0&&Wt(pt))throw new Error("The internal list is malformed.");var Nt=pt===void 0?Ct.insertTime:U(pt)?pt.startTime+pt.duration:dt(pt),jt=pt===void 0?this._defaultValue:U(pt)?pt.values[pt.values.length-1]:pt.value,Bt=P(Ct)?yt(ht,Nt,jt,Ct):Tt(ht,Nt,jt,Ct),ee=P(Ct)?C(Bt,ht,this._currenTime):A(Bt,ht,this._currenTime);this._automationEvents.push(ee)}if(pt!==void 0&&Wt(pt)&&this._automationEvents.push(I(this.getValue(ht),ht)),pt!==void 0&&U(pt)&&pt.startTime+pt.duration>ht){var Ge=ht-pt.startTime,$t=(pt.values.length-1)/pt.duration,_e=Math.max(2,1+Math.ceil(Ge*$t)),je=Ge/(_e-1)*$t,Ye=pt.values.slice(0,_e);if(je<1)for(var Pe=1;Pe<_e;Pe+=1){var Ze=je*Pe%1;Ye[Pe]=pt.values[Pe-1]*(1-Ze)+pt.values[Pe]*Ze}this._automationEvents[this._automationEvents.length-1]=E(Ye,pt.startTime,Ge)}}}else{var Ce=this._automationEvents.findIndex(function(De){return dt(De)>ht}),Ss=Ce===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[Ce-1];if(Ss!==void 0&&U(Ss)&&dt(Ss)+Ss.duration>ht)return!1;var ln=P(it)?C(it.value,it.endTime,this._currenTime):R(it)?A(it.value,ht,this._currenTime):it;if(Ce===-1)this._automationEvents.push(ln);else{if(U(it)&&ht+it.duration>dt(this._automationEvents[Ce]))return!1;this._automationEvents.splice(Ce,0,ln)}}return!0}},{key:"flush",value:function(it){var ht=this._automationEvents.findIndex(function(pt){return dt(pt)>it});if(ht>1){var ut=this._automationEvents.slice(ht-1),Ct=ut[0];Wt(Ct)&&ut.unshift(I(j(this._automationEvents,ht-2,Ct.startTime,this._defaultValue),Ct.startTime)),this._automationEvents=ut}}},{key:"getValue",value:function(it){if(this._automationEvents.length===0)return this._defaultValue;var ht=this._automationEvents.findIndex(function(Ye){return dt(Ye)>it}),ut=this._automationEvents[ht],Ct=(ht===-1?this._automationEvents.length:ht)-1,pt=this._automationEvents[Ct];if(pt!==void 0&&Wt(pt)&&(ut===void 0||!q(ut)||ut.insertTime>it))return O(it,j(this._automationEvents,Ct-1,pt.startTime,this._defaultValue),pt);if(pt!==void 0&&G(pt)&&(ut===void 0||!q(ut)))return pt.value;if(pt!==void 0&&U(pt)&&(ut===void 0||!q(ut)||pt.startTime+pt.duration>it))return it<pt.startTime+pt.duration?me(it,pt):pt.values[pt.values.length-1];if(pt!==void 0&&q(pt)&&(ut===void 0||!q(ut)))return pt.value;if(ut!==void 0&&P(ut)){var Nt=Y(this._automationEvents,Ct,pt,ut,this._defaultValue),jt=g(Nt,2),Bt=jt[0],ee=jt[1];return yt(it,Bt,ee,ut)}if(ut!==void 0&&R(ut)){var Ge=Y(this._automationEvents,Ct,pt,ut,this._defaultValue),$t=g(Ge,2),_e=$t[0],je=$t[1];return Tt(it,_e,je,ut)}return this._defaultValue}}])}();f.AutomationEventList=Qt,f.createCancelAndHoldAutomationEvent=function(it){return{cancelTime:it,type:"cancelAndHold"}},f.createCancelScheduledValuesAutomationEvent=function(it){return{cancelTime:it,type:"cancelScheduledValues"}},f.createExponentialRampToValueAutomationEvent=function(it,ht){return{endTime:ht,type:"exponentialRampToValue",value:it}},f.createLinearRampToValueAutomationEvent=function(it,ht){return{endTime:ht,type:"linearRampToValue",value:it}},f.createSetTargetAutomationEvent=function(it,ht,ut){return{startTime:ht,target:it,timeConstant:ut,type:"setTarget"}},f.createSetValueAutomationEvent=I,f.createSetValueCurveAutomationEvent=E})(h,m(821),m(805),m(989))},113:c=>{c.exports=function(h,m){(m==null||m>h.length)&&(m=h.length);for(var f=0,g=new Array(m);f<m;f++)g[f]=h[f];return g},c.exports.__esModule=!0,c.exports.default=c.exports},569:c=>{c.exports=function(h){if(Array.isArray(h))return h},c.exports.__esModule=!0,c.exports.default=c.exports},805:c=>{c.exports=function(h,m){if(!(h instanceof m))throw new TypeError("Cannot call a class as a function")},c.exports.__esModule=!0,c.exports.default=c.exports},989:(c,h,m)=>{var f=m(498);function g(y,w){for(var C=0;C<w.length;C++){var A=w[C];A.enumerable=A.enumerable||!1,A.configurable=!0,"value"in A&&(A.writable=!0),Object.defineProperty(y,f(A.key),A)}}c.exports=function(y,w,C){return w&&g(y.prototype,w),C&&g(y,C),Object.defineProperty(y,"prototype",{writable:!1}),y},c.exports.__esModule=!0,c.exports.default=c.exports},474:c=>{c.exports=function(h,m){var f=h==null?null:typeof Symbol<"u"&&h[Symbol.iterator]||h["@@iterator"];if(f!=null){var g,y,w,C,A=[],I=!0,E=!1;try{if(w=(f=f.call(h)).next,m===0){if(Object(f)!==f)return;I=!1}else for(;!(I=(g=w.call(f)).done)&&(A.push(g.value),A.length!==m);I=!0);}catch(O){E=!0,y=O}finally{try{if(!I&&f.return!=null&&(C=f.return(),Object(C)!==C))return}finally{if(E)throw y}}return A}},c.exports.__esModule=!0,c.exports.default=c.exports},18:c=>{c.exports=function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)},c.exports.__esModule=!0,c.exports.default=c.exports},821:(c,h,m)=>{var f=m(569),g=m(474),y=m(744),w=m(18);c.exports=function(C,A){return f(C)||g(C,A)||y(C,A)||w()},c.exports.__esModule=!0,c.exports.default=c.exports},327:(c,h,m)=>{var f=m(564).default;c.exports=function(g,y){if(f(g)!="object"||!g)return g;var w=g[Symbol.toPrimitive];if(w!==void 0){var C=w.call(g,y||"default");if(f(C)!="object")return C;throw new TypeError("@@toPrimitive must return a primitive value.")}return(y==="string"?String:Number)(g)},c.exports.__esModule=!0,c.exports.default=c.exports},498:(c,h,m)=>{var f=m(564).default,g=m(327);c.exports=function(y){var w=g(y,"string");return f(w)=="symbol"?w:w+""},c.exports.__esModule=!0,c.exports.default=c.exports},564:c=>{function h(m){return c.exports=h=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(f){return typeof f}:function(f){return f&&typeof Symbol=="function"&&f.constructor===Symbol&&f!==Symbol.prototype?"symbol":typeof f},c.exports.__esModule=!0,c.exports.default=c.exports,h(m)}c.exports=h,c.exports.__esModule=!0,c.exports.default=c.exports},744:(c,h,m)=>{var f=m(113);c.exports=function(g,y){if(g){if(typeof g=="string")return f(g,y);var w=Object.prototype.toString.call(g).slice(8,-1);return w==="Object"&&g.constructor&&(w=g.constructor.name),w==="Map"||w==="Set"?Array.from(g):w==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(w)?f(g,y):void 0}},c.exports.__esModule=!0,c.exports.default=c.exports}},i={};function r(c){var h=i[c];if(h!==void 0)return h.exports;var m=i[c]={exports:{}};return s[c].call(m.exports,m,m.exports,r),m.exports}r.d=(c,h)=>{for(var m in h)r.o(h,m)&&!r.o(c,m)&&Object.defineProperty(c,m,{enumerable:!0,get:h[m]})},r.o=(c,h)=>Object.prototype.hasOwnProperty.call(c,h),r.r=c=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(c,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(c,"__esModule",{value:!0})};var a={};return(()=>{r.r(a),r.d(a,{AMOscillator:()=>To,AMSynth:()=>Tl,Abs:()=>zu,Add:()=>Zn,AmplitudeEnvelope:()=>Bi,Analyser:()=>Vo,AudioToGain:()=>Gr,AutoFilter:()=>Fl,AutoPanner:()=>Bl,AutoWah:()=>$l,BaseContext:()=>pl,BiquadFilter:()=>Po,BitCrusher:()=>ql,Buffer:()=>Gg,BufferSource:()=>Ug,Buffers:()=>jg,Channel:()=>ti,Chebyshev:()=>Wl,Chorus:()=>Hl,Clock:()=>ki,Compressor:()=>vn,Context:()=>Ci,Convolver:()=>mc,CrossFade:()=>$i,DCMeter:()=>oc,Delay:()=>fs,Destination:()=>Lg,Distortion:()=>Gl,Draw:()=>zg,DuoSynth:()=>Al,EQ3:()=>pc,Emitter:()=>Si,Envelope:()=>Be,FFT:()=>ic,FMOscillator:()=>Ni,FMSynth:()=>Ml,FatOscillator:()=>Ao,FeedbackCombFilter:()=>Ro,FeedbackDelay:()=>jl,Filter:()=>vs,Follower:()=>qo,Freeverb:()=>Xl,Frequency:()=>pg,FrequencyClass:()=>Je,FrequencyEnvelope:()=>ko,FrequencyShifter:()=>Ul,Gain:()=>wt,GainToAudio:()=>Wu,Gate:()=>cc,GrainPlayer:()=>Sl,GreaterThan:()=>Xr,GreaterThanZero:()=>Ur,IntervalTimeline:()=>Fu,JCReverb:()=>Yl,LFO:()=>ts,Limiter:()=>hc,Listener:()=>$g,Loop:()=>Lo,LowpassCombFilter:()=>Oo,Master:()=>Fg,MembraneSynth:()=>Io,Merge:()=>Dn,MetalSynth:()=>El,Meter:()=>nc,MidSideCompressor:()=>uc,MidSideMerge:()=>Wo,MidSideSplit:()=>zo,Midi:()=>yg,MidiClass:()=>Ri,Mono:()=>ac,MonoSynth:()=>Jn,MultibandCompressor:()=>dc,MultibandSplit:()=>Ho,Multiply:()=>ue,Negate:()=>Cl,Noise:()=>In,NoiseSynth:()=>Pl,Offline:()=>vg,OfflineContext:()=>Ti,OmniOscillator:()=>mn,OnePoleFilter:()=>Do,Oscillator:()=>he,PWMOscillator:()=>Mo,PanVol:()=>Kr,Panner:()=>$o,Panner3D:()=>lc,Param:()=>Et,Part:()=>Fo,Pattern:()=>Nl,Phaser:()=>Jl,PingPongDelay:()=>Zl,PitchShift:()=>Ql,Player:()=>Fi,Players:()=>xl,PluckSynth:()=>Dl,PolySynth:()=>Ol,Pow:()=>Di,PulseOscillator:()=>Li,Recorder:()=>ta,Reverb:()=>Kl,Sampler:()=>No,Scale:()=>fn,ScaleExp:()=>Yr,Sequence:()=>Ll,Signal:()=>At,Solo:()=>be,Split:()=>Kn,StateTimeline:()=>Ei,StereoWidener:()=>tc,Subtract:()=>Qn,SyncedSignal:()=>Sg,Synth:()=>Rn,Ticks:()=>bg,TicksClass:()=>ce,Time:()=>hg,TimeClass:()=>ps,Timeline:()=>ds,ToneAudioBuffer:()=>qt,ToneAudioBuffers:()=>Ii,ToneAudioNode:()=>rt,ToneBufferSource:()=>kn,ToneEvent:()=>Ys,ToneOscillatorNode:()=>Co,Transport:()=>Og,TransportTime:()=>mg,TransportTimeClass:()=>xe,Tremolo:()=>ec,Unit:()=>h,UserMedia:()=>So,Vibrato:()=>sc,Volume:()=>dn,WaveShaper:()=>$s,Waveform:()=>rc,Zero:()=>jr,connect:()=>Ke,connectSeries:()=>ms,connectSignal:()=>xo,context:()=>Vg,dbToGain:()=>Ai,debug:()=>c,defaultArg:()=>As,disconnect:()=>gl,fanIn:()=>fg,ftom:()=>En,gainToDb:()=>_o,getContext:()=>ie,getDestination:()=>Bg,getDraw:()=>Wg,getListener:()=>qg,getTransport:()=>Ng,immediate:()=>Dg,intervalToFrequencyRatio:()=>Mi,isArray:()=>Ne,isBoolean:()=>al,isDefined:()=>It,isFunction:()=>Eu,isNote:()=>yo,isNumber:()=>hs,isObject:()=>hn,isString:()=>Ls,isUndef:()=>os,loaded:()=>Hg,mtof:()=>ml,now:()=>Rg,optionsFromArguments:()=>K,setContext:()=>zr,start:()=>cg,supported:()=>ig,version:()=>m});var c={};r.r(c),r.d(c,{assert:()=>_t,assertContextRunning:()=>ll,assertRange:()=>Le,assertUsedScheduleTime:()=>Iu,enterScheduledCallback:()=>cl,log:()=>Ru,setLogger:()=>og,warn:()=>wi});var h={};r.r(h);const m="15.0.4";var f=r(871);const g=new WeakSet,y=new WeakMap,w=new WeakMap,C=new WeakMap,A=new WeakMap,I=new WeakMap,E=new WeakMap,O=new WeakMap,P=new WeakMap,R=new WeakMap,q={construct:()=>q},G=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,U=(p,t)=>{const o=[];let l=p.replace(/^[\s]+/,""),d=l.match(G);for(;d!==null;){const v=d[1].slice(1,-1),b=d[0].replace(/([\s]+)?;?$/,"").replace(v,new URL(v,t).toString());o.push(b),l=l.slice(d[0].length).replace(/^[\s]+/,""),d=l.match(G)}return[o.join(";"),l]},j=p=>{if(p!==void 0&&!Array.isArray(p))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Y=p=>{if(!(t=>{try{new new Proxy(t,q)}catch{return!1}return!0})(p))throw new TypeError("The given value for processorCtor should be a constructor.");if(p.prototype===null||typeof p.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},tt=(p,t)=>{const o=p.get(t);if(o===void 0)throw new Error("A value with the given key could not be found.");return o},ot=(p,t)=>{const o=Array.from(p).filter(t);if(o.length>1)throw Error("More than one element was found.");if(o.length===0)throw Error("No element was found.");const[l]=o;return p.delete(l),l},dt=(p,t,o,l)=>{const d=tt(p,t),v=ot(d,b=>b[0]===o&&b[1]===l);return d.size===0&&p.delete(t),v},yt=p=>tt(E,p),Tt=p=>{if(g.has(p))throw new Error("The AudioNode is already stored.");g.add(p),yt(p).forEach(t=>t(!0))},me=p=>"port"in p,Wt=p=>{if(!g.has(p))throw new Error("The AudioNode is not stored.");g.delete(p),yt(p).forEach(t=>t(!1))},Qt=(p,t)=>{!me(p)&&t.every(o=>o.size===0)&&Wt(p)},it={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},ht=(p,t)=>p.context===t,ut=p=>{try{p.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},Ct=()=>new DOMException("","IndexSizeError"),pt=p=>{var t;p.getChannelData=(t=p.getChannelData,o=>{try{return t.call(p,o)}catch(l){throw l.code===12?Ct():l}})},Nt={numberOfChannels:1},jt=-34028234663852886e22,Bt=34028234663852886e22,ee=p=>g.has(p),Ge={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},$t=p=>tt(y,p),_e=p=>tt(C,p),je=(p,t)=>{const{activeInputs:o}=$t(p);o.forEach(d=>d.forEach(([v])=>{t.includes(p)||je(v,[...t,p])}));const l=(d=>"playbackRate"in d)(p)?[p.playbackRate]:me(p)?Array.from(p.parameters.values()):(d=>"frequency"in d&&"gain"in d)(p)?[p.Q,p.detune,p.frequency,p.gain]:(d=>"offset"in d)(p)?[p.offset]:(d=>!("frequency"in d)&&"gain"in d)(p)?[p.gain]:(d=>"detune"in d&&"frequency"in d)(p)?[p.detune,p.frequency]:(d=>"pan"in d)(p)?[p.pan]:[];for(const d of l){const v=_e(d);v!==void 0&&v.activeInputs.forEach(([b])=>je(b,t))}ee(p)&&Wt(p)},Ye=p=>{je(p.destination,[])},Pe=p=>"context"in p,Ze=p=>Pe(p[0]),Ce=(p,t,o,l)=>{for(const d of p)if(o(d)){if(l)return!1;throw Error("The set contains at least one similar element.")}return p.add(t),!0},Ss=(p,t,[o,l],d)=>{Ce(p,[t,o,l],v=>v[0]===t&&v[1]===o,d)},ln=(p,[t,o,l],d)=>{const v=p.get(t);v===void 0?p.set(t,new Set([[o,l]])):Ce(v,[o,l],b=>b[0]===o,d)},De=p=>"inputs"in p,xn=(p,t,o,l)=>{if(De(t)){const d=t.inputs[l];return p.connect(d,o,0),[d,o,0]}return p.connect(t,o,l),[t,o,l]},ci=(p,t,o)=>{for(const l of p)if(l[0]===t&&l[1]===o)return p.delete(l),l;return null},hi=(p,t)=>{if(!yt(p).delete(t))throw new Error("Missing the expected event listener.")},ui=(p,t,o)=>{const l=tt(p,t),d=ot(l,v=>v[0]===o);return l.size===0&&p.delete(t),d},Sn=(p,t,o,l)=>{De(t)?p.disconnect(t.inputs[l],o,0):p.disconnect(t,o,l)},Jt=p=>tt(w,p),Hn=p=>tt(A,p),cn=p=>O.has(p),di=p=>!g.has(p),Mr=(p,t)=>new Promise(o=>{if(t!==null)o(!0);else{const l=p.createScriptProcessor(256,1,1),d=p.createGain(),v=p.createBuffer(1,2,44100),b=v.getChannelData(0);b[0]=1,b[1]=1;const _=p.createBufferSource();_.buffer=v,_.loop=!0,_.connect(l).connect(p.destination),_.connect(d),_.disconnect(d),l.onaudioprocess=x=>{const S=x.inputBuffer.getChannelData(0);Array.prototype.some.call(S,M=>M===1)?o(!0):o(!1),_.stop(),l.onaudioprocess=null,_.disconnect(l),l.disconnect(p.destination)},_.start()}}),co=(p,t)=>{const o=new Map;for(const l of p)for(const d of l){const v=o.get(d);o.set(d,v===void 0?1:v+1)}o.forEach((l,d)=>t(d,l))},pi=p=>"context"in p,Ua=p=>{const t=new Map;p.connect=(o=>(l,d=0,v=0)=>{const b=pi(l)?o(l,d,v):o(l,d),_=t.get(l);return _===void 0?t.set(l,[{input:v,output:d}]):_.every(x=>x.input!==v||x.output!==d)&&_.push({input:v,output:d}),b})(p.connect.bind(p)),p.disconnect=(o=>(l,d,v)=>{if(o.apply(p),l===void 0)t.clear();else if(typeof l=="number")for(const[b,_]of t){const x=_.filter(S=>S.output!==l);x.length===0?t.delete(b):t.set(b,x)}else if(t.has(l))if(d===void 0)t.delete(l);else{const b=t.get(l);if(b!==void 0){const _=b.filter(x=>x.output!==d&&(x.input!==v||v===void 0));_.length===0?t.delete(l):t.set(l,_)}}for(const[b,_]of t)_.forEach(x=>{pi(b)?p.connect(b,x.output,x.input):p.connect(b,x.output)})})(p.disconnect)},ho=(p,t,o,l,d)=>{const[v,b]=((_,x,S,M)=>{const{activeInputs:k,passiveInputs:D}=$t(x),N=ci(k[M],_,S);return N===null?[dt(D,_,S,M)[2],!1]:[N[2],!0]})(p,o,l,d);if(v!==null&&(hi(p,v),!b||t||cn(p)||Sn(Jt(p),Jt(o),l,d)),ee(o)){const{activeInputs:_}=$t(o);Qt(o,_)}},uo=(p,t,o,l)=>{const[d,v]=((b,_,x)=>{const{activeInputs:S,passiveInputs:M}=_e(_),k=ci(S,b,x);return k===null?[ui(M,b,x)[1],!1]:[k[2],!0]})(p,o,l);d!==null&&(hi(p,d),!v||t||cn(p)||Jt(p).disconnect(Hn(o),l))};class Er{constructor(t){this._map=new Map(t)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(t,o=null){return this._map.forEach((l,d)=>t.call(o,l,d,this))}get(t){return this._map.get(t)}has(t){return this._map.has(t)}keys(){return this._map.keys()}values(){return this._map.values()}}const Pr={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function Gn(p,t,o,l,d){if(typeof p.copyFromChannel=="function")t[o].byteLength===0&&(t[o]=new Float32Array(128)),p.copyFromChannel(t[o],l,d);else{const v=p.getChannelData(l);if(t[o].byteLength===0)t[o]=v.slice(d,d+128);else{const b=new Float32Array(v.buffer,d*Float32Array.BYTES_PER_ELEMENT,128);t[o].set(b)}}}const mi=(p,t,o,l,d)=>{typeof p.copyToChannel=="function"?t[o].byteLength!==0&&p.copyToChannel(t[o],l,d):t[o].byteLength!==0&&p.getChannelData(l).set(t[o],d)},kr=(p,t)=>{const o=[];for(let l=0;l<p;l+=1){const d=[],v=typeof t=="number"?t:t[l];for(let b=0;b<v;b+=1)d.push(new Float32Array(128));o.push(d)}return o},bm=async(p,t,o,l,d,v,b)=>{const _=t===null?128*Math.ceil(p.context.length/128):t.length,x=l.channelCount*l.numberOfInputs,S=d.reduce((L,W)=>L+W,0),M=S===0?null:o.createBuffer(S,_,o.sampleRate);if(v===void 0)throw new Error("Missing the processor constructor.");const k=$t(p),D=await((L,W)=>{const z=tt(R,L),F=Jt(W);return tt(z,F)})(o,p),N=kr(l.numberOfInputs,l.channelCount),$=kr(l.numberOfOutputs,d),B=Array.from(p.parameters.keys()).reduce((L,W)=>({...L,[W]:new Float32Array(128)}),{});for(let L=0;L<_;L+=128){if(l.numberOfInputs>0&&t!==null)for(let W=0;W<l.numberOfInputs;W+=1)for(let z=0;z<l.channelCount;z+=1)Gn(t,N[W],z,z,L);v.parameterDescriptors!==void 0&&t!==null&&v.parameterDescriptors.forEach(({name:W},z)=>{Gn(t,B,W,x+z,L)});for(let W=0;W<l.numberOfInputs;W+=1)for(let z=0;z<d[W];z+=1)$[W][z].byteLength===0&&($[W][z]=new Float32Array(128));try{const W=N.map((F,Q)=>k.activeInputs[Q].size===0?[]:F),z=b(L/o.sampleRate,o.sampleRate,()=>D.process(W,$,B));if(M!==null)for(let F=0,Q=0;F<l.numberOfOutputs;F+=1){for(let st=0;st<d[F];st+=1)mi(M,$[F],st,Q+st,L);Q+=d[F]}if(!z)break}catch(W){p.dispatchEvent(new ErrorEvent("processorerror",{colno:W.colno,filename:W.filename,lineno:W.lineno,message:W.message}));break}}return M},wm={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},_m={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},xm={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Sm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},Cm={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},Hh=p=>{const{port1:t,port2:o}=new MessageChannel;return new Promise(l=>{const d=()=>{o.onmessage=null,t.close(),o.close(),l()};o.onmessage=()=>d();try{t.postMessage(p,[p])}catch{}finally{d()}})},Tm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Ir=(p,t,o)=>{const l=t[o];if(l===void 0)throw p();return l},Am={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},Mm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},ke=()=>new DOMException("","InvalidStateError"),Rr=()=>new DOMException("","InvalidAccessError"),Em={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Gh=(p,t,o,l,d,v,b,_,x,S,M)=>{const k=S.length;let D=_;for(let N=0;N<k;N+=1){let $=o[0]*S[N];for(let B=1;B<d;B+=1){const L=D-B&x-1;$+=o[B]*v[L],$-=p[B]*b[L]}for(let B=d;B<l;B+=1)$+=o[B]*v[D-B&x-1];for(let B=d;B<t;B+=1)$-=p[B]*b[D-B&x-1];v[D]=S[N],b[D]=$,D=D+1&x-1,M[N]=$}return D},Pm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},po=p=>{const t=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const o=p.decodeAudioData(t.buffer,()=>{});return o!==void 0&&(o.catch(()=>{}),!0)}catch{}return!1},le=(p,t,o)=>{const l=t[o];l!==void 0&&l!==p[o]&&(p[o]=l)},Te=(p,t)=>{le(p,t,"channelCount"),le(p,t,"channelCountMode"),le(p,t,"channelInterpretation")},jh=p=>typeof p.getFloatTimeDomainData=="function",fe=(p,t,o)=>{const l=t[o];l!==void 0&&l!==p[o].value&&(p[o].value=l)},Xa=p=>{p.start=(t=>(o=0,l=0,d)=>{if(typeof d=="number"&&d<0||l<0||o<0)throw new RangeError("The parameters can't be negative.");t.call(p,o,l,d)})(p.start)},Ya=p=>{var t;p.stop=(t=p.stop,(o=0)=>{if(o<0)throw new RangeError("The parameter can't be negative.");t.call(p,o)})},Uh=(p,t)=>p===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(p*t))))),Xh=(p,t)=>{const o=p.createBiquadFilter();return Te(o,t),fe(o,t,"Q"),fe(o,t,"detune"),fe(o,t,"frequency"),fe(o,t,"gain"),le(o,t,"type"),o},mo=(p,t)=>{const o=p.createChannelSplitter(t.numberOfOutputs);return Te(o,t),(l=>{const d=l.numberOfOutputs;Object.defineProperty(l,"channelCount",{get:()=>d,set:v=>{if(v!==d)throw ke()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:v=>{if(v!=="explicit")throw ke()}}),Object.defineProperty(l,"channelInterpretation",{get:()=>"discrete",set:v=>{if(v!=="discrete")throw ke()}})})(o),o},fi=(p,t)=>(p.connect=t.connect.bind(t),p.disconnect=t.disconnect.bind(t),p),Yh=(p,t)=>{const o=p.createDelay(t.maxDelayTime);return Te(o,t),fe(o,t,"delayTime"),o},is=(p,t)=>{const o=p.createGain();return Te(o,t),fe(o,t,"gain"),o};function km(p,t){const o=t[0]*t[0]+t[1]*t[1];return[(p[0]*t[0]+p[1]*t[1])/o,(p[1]*t[0]-p[0]*t[1])/o]}function Zh(p,t){let o=[0,0];for(let v=p.length-1;v>=0;v-=1)d=t,o=[(l=o)[0]*d[0]-l[1]*d[1],l[0]*d[1]+l[1]*d[0]],o[0]+=p[v];var l,d;return o}const fo=(p,t,o,l)=>p.createScriptProcessor(t,o,l),Qe=()=>new DOMException("","NotSupportedError"),Im={numberOfChannels:1},Rm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},Dm={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},Om={disableNormalization:!1},Nm={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},Lm=()=>new DOMException("","UnknownError"),Fm={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Qh=(p,t,o)=>p.copyFromChannel===void 0?p.getChannelData(o)[0]:(p.copyFromChannel(t,o),t[0]),Jh=p=>{if(p===null)return!1;const t=p.length;return t%2!=0?p[Math.floor(t/2)]!==0:p[t/2-1]+p[t/2]!==0},go=(p,t,o,l)=>{let d=p;for(;!d.hasOwnProperty(t);)d=Object.getPrototypeOf(d);const{get:v,set:b}=Object.getOwnPropertyDescriptor(d,t);Object.defineProperty(p,t,{get:o(v),set:l(b)})},Kh=(p,t,o)=>{try{p.setValueAtTime(t,o)}catch(l){if(l.code!==9)throw l;Kh(p,t,o+1e-7)}},Za=p=>{const t=p.createOscillator();try{t.start(-1)}catch(o){return o instanceof RangeError}return!1},tu=p=>{const t=p.createBuffer(1,1,44100),o=p.createBufferSource();o.buffer=t,o.start(),o.stop();try{return o.stop(),!0}catch{return!1}},Qa=p=>{const t=p.createOscillator();try{t.stop(-1)}catch(o){return o instanceof RangeError}return!1},Bm=()=>{try{new DOMException}catch{return!1}return!0},$m=()=>new Promise(p=>{const t=new ArrayBuffer(0),{port1:o,port2:l}=new MessageChannel;o.onmessage=({data:d})=>p(d!==null),l.postMessage(t,[t])}),eu=(p,t)=>{const o=t.createGain();p.connect(o);const l=(d=>()=>{d.call(p,o),p.removeEventListener("ended",l)})(p.disconnect);p.addEventListener("ended",l),fi(p,o),p.stop=(d=>{let v=!1;return(b=0)=>{if(v)try{d.call(p,b)}catch{o.gain.setValueAtTime(0,b)}else d.call(p,b),v=!0}})(p.stop)},gi=(p,t)=>o=>{const l={value:p};return Object.defineProperties(o,{currentTarget:l,target:l}),typeof t=="function"?t.call(p,o):t.handleEvent.call(p,o)},qm=(p=>(t,o,[l,d,v],b)=>{p(t[d],[o,l,v],_=>_[0]===o&&_[1]===l,b)})(Ce),zm=(p=>(t,o,[l,d,v],b)=>{const _=t.get(l);_===void 0?t.set(l,new Set([[d,o,v]])):p(_,[d,o,v],x=>x[0]===d&&x[1]===o,b)})(Ce),Wm=(p=>(t,o,l,d)=>p(t[d],v=>v[0]===o&&v[1]===l))(ot),su=new WeakMap,Vm=(p=>t=>{var o;return(o=p.get(t))!==null&&o!==void 0?o:0})(su),Cs=(Dr=new Map,vo=new WeakMap,(p,t)=>{const o=vo.get(p);if(o!==void 0)return o;const l=Dr.get(p);if(l!==void 0)return l;try{const d=t();return d instanceof Promise?(Dr.set(p,d),d.catch(()=>!1).then(v=>(Dr.delete(p),vo.set(p,v),v))):(vo.set(p,d),d)}catch{return vo.set(p,!1),!1}});var Dr,vo;const Os=typeof window>"u"?null:window,nu=((p,t)=>(o,l)=>{const d=o.createAnalyser();if(Te(d,l),!(l.maxDecibels>l.minDecibels))throw t();return le(d,l,"fftSize"),le(d,l,"maxDecibels"),le(d,l,"minDecibels"),le(d,l,"smoothingTimeConstant"),p(jh,()=>jh(d))||(v=>{v.getFloatTimeDomainData=b=>{const _=new Uint8Array(b.length);v.getByteTimeDomainData(_);const x=Math.max(_.length,v.fftSize);for(let S=0;S<x;S+=1)b[S]=.0078125*(_[S]-128);return b}})(d),d})(Cs,Ct),Ja=(p=>t=>{const o=p(t);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return o.renderer})($t),Oe=((p,t,o)=>async(l,d,v)=>{const b=p(l);await Promise.all(b.activeInputs.map((_,x)=>Array.from(_).map(async([S,M])=>{const k=t(S),D=await k.render(S,d),N=l.context.destination;o(S)||l===N&&o(l)||D.connect(v,M,x)})).reduce((_,x)=>[..._,...x],[]))})($t,Ja,cn),Hm=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const b=l.get(v);return b!==void 0?Promise.resolve(b):(async(_,x)=>{let S=t(_);if(!ht(S,x)){const M={channelCount:S.channelCount,channelCountMode:S.channelCountMode,channelInterpretation:S.channelInterpretation,fftSize:S.fftSize,maxDecibels:S.maxDecibels,minDecibels:S.minDecibels,smoothingTimeConstant:S.smoothingTimeConstant};S=p(x,M)}return l.set(x,S),await o(_,x,S),S})(d,v)}}})(nu,Jt,Oe),se=(iu=I,p=>{const t=iu.get(p);if(t===void 0)throw ke();return t});var iu;const Ie=(p=>p===null?null:p.hasOwnProperty("OfflineAudioContext")?p.OfflineAudioContext:p.hasOwnProperty("webkitOfflineAudioContext")?p.webkitOfflineAudioContext:null)(Os),Zt=(p=>t=>p!==null&&t instanceof p)(Ie),ou=new WeakMap,ru=(p=>class{constructor(t){this._nativeEventTarget=t,this._listeners=new WeakMap}addEventListener(t,o,l){if(o!==null){let d=this._listeners.get(o);d===void 0&&(d=p(this,o),typeof o=="function"&&this._listeners.set(o,d)),this._nativeEventTarget.addEventListener(t,d,l)}}dispatchEvent(t){return this._nativeEventTarget.dispatchEvent(t)}removeEventListener(t,o,l){const d=o===null?void 0:this._listeners.get(o);this._nativeEventTarget.removeEventListener(t,d===void 0?null:d,l)}})(gi),Cn=(p=>p===null?null:p.hasOwnProperty("AudioContext")?p.AudioContext:p.hasOwnProperty("webkitAudioContext")?p.webkitAudioContext:null)(Os),Ka=(p=>t=>p!==null&&t instanceof p)(Cn),tl=(p=>t=>p!==null&&typeof p.AudioNode=="function"&&t instanceof p.AudioNode)(Os),au=(p=>t=>p!==null&&typeof p.AudioParam=="function"&&t instanceof p.AudioParam)(Os),vi=(p=>p===null?null:p.hasOwnProperty("AudioWorkletNode")?p.AudioWorkletNode:null)(Os),ye=((p,t,o,l,d,v,b,_,x,S,M,k,D,N,$,B)=>class extends S{constructor(L,W,z,F){super(z),this._context=L,this._nativeAudioNode=z;const Q=M(L);k(Q)&&o(Mr,()=>Mr(Q,B))!==!0&&Ua(z),w.set(this,z),E.set(this,new Set),L.state!=="closed"&&W&&Tt(this),p(this,F,z)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(L){this._nativeAudioNode.channelCount=L}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(L){this._nativeAudioNode.channelCountMode=L}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(L){this._nativeAudioNode.channelInterpretation=L}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(L,W=0,z=0){if(W<0||W>=this._nativeAudioNode.numberOfOutputs)throw d();const F=M(this._context),Q=$(F);if(D(L)||N(L))throw v();if(Pe(L)){const H=Jt(L);try{const Z=xn(this._nativeAudioNode,H,W,z),V=di(this);(Q||V)&&this._nativeAudioNode.disconnect(...Z),this.context.state!=="closed"&&!V&&di(L)&&Tt(L)}catch(Z){throw Z.code===12?v():Z}if(t(this,L,W,z,Q)){const Z=x([this],L);co(Z,l(Q))}return L}const st=Hn(L);if(st.name==="playbackRate"&&st.maxValue===1024)throw b();try{this._nativeAudioNode.connect(st,W),(Q||di(this))&&this._nativeAudioNode.disconnect(st,W)}catch(H){throw H.code===12?v():H}if(((H,Z,V,nt)=>{const{activeInputs:X,passiveInputs:et}=_e(Z),{outputs:lt}=$t(H),ct=yt(H),Mt=bt=>{const vt=Jt(H),Pt=Hn(Z);if(bt){const gt=ui(et,H,V);Ss(X,H,gt,!1),nt||cn(H)||vt.connect(Pt,V)}else{const gt=((kt,Lt,Vt)=>ot(kt,oe=>oe[0]===Lt&&oe[1]===Vt))(X,H,V);ln(et,gt,!1),nt||cn(H)||vt.disconnect(Pt,V)}};return!!Ce(lt,[Z,V],bt=>bt[0]===Z&&bt[1]===V,!0)&&(ct.add(Mt),ee(H)?Ss(X,H,[V,Mt],!0):ln(et,[H,V,Mt],!0),!0)})(this,L,W,Q)){const H=x([this],L);co(H,l(Q))}}disconnect(L,W,z){let F;const Q=M(this._context),st=$(Q);if(L===void 0)F=((H,Z)=>{const V=$t(H),nt=[];for(const X of V.outputs)Ze(X)?ho(H,Z,...X):uo(H,Z,...X),nt.push(X[0]);return V.outputs.clear(),nt})(this,st);else if(typeof L=="number"){if(L<0||L>=this.numberOfOutputs)throw d();F=((H,Z,V)=>{const nt=$t(H),X=[];for(const et of nt.outputs)et[1]===V&&(Ze(et)?ho(H,Z,...et):uo(H,Z,...et),X.push(et[0]),nt.outputs.delete(et));return X})(this,st,L)}else{if(W!==void 0&&(W<0||W>=this.numberOfOutputs)||Pe(L)&&z!==void 0&&(z<0||z>=L.numberOfInputs))throw d();if(F=((H,Z,V,nt,X)=>{const et=$t(H);return Array.from(et.outputs).filter(lt=>!(lt[0]!==V||nt!==void 0&&lt[1]!==nt||X!==void 0&&lt[2]!==X)).map(lt=>(Ze(lt)?ho(H,Z,...lt):uo(H,Z,...lt),et.outputs.delete(lt),lt[0]))})(this,st,L,W,z),F.length===0)throw v()}for(const H of F){const Z=x([this],H);co(Z,_)}}})((lu=y,(p,t,o)=>{const l=[];for(let d=0;d<o.numberOfInputs;d+=1)l.push(new Set);lu.set(p,{activeInputs:l,outputs:new Set,passiveInputs:new WeakMap,renderer:t})}),((p,t,o,l,d,v,b,_,x,S,M,k,D)=>{const N=new WeakMap;return($,B,L,W,z)=>{const{activeInputs:F,passiveInputs:Q}=v(B),{outputs:st}=v($),H=_($),Z=V=>{const nt=x(B),X=x($);if(V){const et=dt(Q,$,L,W);p(F,$,et,!1),z||k($)||o(X,nt,L,W),D(B)&&Tt(B)}else{const et=l(F,$,L,W);t(Q,W,et,!1),z||k($)||d(X,nt,L,W);const lt=b(B);if(lt===0)M(B)&&Qt(B,F);else{const ct=N.get(B);ct!==void 0&&clearTimeout(ct),N.set(B,setTimeout(()=>{M(B)&&Qt(B,F)},1e3*lt))}}};return!!S(st,[B,L,W],V=>V[0]===B&&V[1]===L&&V[2]===W,!0)&&(H.add(Z),M($)?p(F,$,[L,W,Z],!0):t(Q,W,[$,L,Z],!0),!0)}})(qm,zm,xn,Wm,Sn,$t,Vm,yt,Jt,Ce,ee,cn,di),Cs,((p,t,o,l,d,v)=>b=>(_,x)=>{const S=p.get(_);if(S===void 0){if(!b&&v(_)){const M=l(_),{outputs:k}=o(_);for(const D of k)if(Ze(D)){const N=l(D[0]);t(M,N,D[1],D[2])}else{const N=d(D[0]);M.disconnect(N,D[1])}}p.set(_,x)}else p.set(_,S+x)})(O,Sn,$t,Jt,Hn,ee),Ct,Rr,Qe,((p,t,o,l,d,v,b,_)=>(x,S)=>{const M=t.get(x);if(M===void 0)throw new Error("Missing the expected cycle count.");const k=v(x.context),D=_(k);if(M===S){if(t.delete(x),!D&&b(x)){const N=l(x),{outputs:$}=o(x);for(const B of $)if(Ze(B)){const L=l(B[0]);p(N,L,B[1],B[2])}else{const L=d(B[0]);N.connect(L,B[1])}}}else t.set(x,M-S)})(xn,O,$t,Jt,Hn,se,ee,Zt),((p,t,o)=>function l(d,v){const b=Pe(v)?v:o(p,v);if((x=>"delayTime"in x)(b))return[];if(d[0]===b)return[d];if(d.includes(b))return[];const{outputs:_}=t(b);return Array.from(_).map(x=>l([...d,b],x[0])).reduce((x,S)=>x.concat(S),[])})(ou,$t,tt),ru,se,Ka,tl,au,Zt,vi);var lu;const Gm=((p,t,o,l,d,v)=>class extends p{constructor(b,_){const x=d(b),S={...it,..._},M=l(x,S);super(b,!1,M,v(x)?t():null),this._nativeAnalyserNode=M}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(b){this._nativeAnalyserNode.fftSize=b}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(b){const _=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=b,!(b>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=_,o()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(b){const _=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=b,!(this._nativeAnalyserNode.maxDecibels>b))throw this._nativeAnalyserNode.minDecibels=_,o()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(b){this._nativeAnalyserNode.smoothingTimeConstant=b}getByteFrequencyData(b){this._nativeAnalyserNode.getByteFrequencyData(b)}getByteTimeDomainData(b){this._nativeAnalyserNode.getByteTimeDomainData(b)}getFloatFrequencyData(b){this._nativeAnalyserNode.getFloatFrequencyData(b)}getFloatTimeDomainData(b){this._nativeAnalyserNode.getFloatTimeDomainData(b)}})(ye,Hm,Ct,nu,se,Zt),el=new WeakSet,cu=(p=>p===null?null:p.hasOwnProperty("AudioBuffer")?p.AudioBuffer:null)(Os),hu=(sl=new Uint32Array(1),p=>(sl[0]=p,sl[0]));var sl;const nl=((p,t)=>o=>{o.copyFromChannel=(l,d,v=0)=>{const b=p(v),_=p(d);if(_>=o.numberOfChannels)throw t();const x=o.length,S=o.getChannelData(_),M=l.length;for(let k=b<0?-b:0;k+b<x&&k<M;k+=1)l[k]=S[k+b]},o.copyToChannel=(l,d,v=0)=>{const b=p(v),_=p(d);if(_>=o.numberOfChannels)throw t();const x=o.length,S=o.getChannelData(_),M=l.length;for(let k=b<0?-b:0;k+b<x&&k<M;k+=1)S[k+b]=l[k]}})(hu,Ct),il=(p=>t=>{t.copyFromChannel=(o=>(l,d,v=0)=>{const b=p(v),_=p(d);if(b<t.length)return o.call(t,l,_,b)})(t.copyFromChannel),t.copyToChannel=(o=>(l,d,v=0)=>{const b=p(v),_=p(d);if(b<t.length)return o.call(t,l,_,b)})(t.copyToChannel)})(hu),uu=((p,t,o,l,d,v,b,_)=>{let x=null;return class np{constructor(M){if(d===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:k,numberOfChannels:D,sampleRate:N}={...Nt,...M};x===null&&(x=new d(1,1,44100));const $=l!==null&&t(v,v)?new l({length:k,numberOfChannels:D,sampleRate:N}):x.createBuffer(D,k,N);if($.numberOfChannels===0)throw o();return typeof $.copyFromChannel!="function"?(b($),pt($)):t(ut,()=>ut($))||_($),p.add($),$}static[Symbol.hasInstance](M){return M!==null&&typeof M=="object"&&Object.getPrototypeOf(M)===np.prototype||p.has(M)}}})(el,Cs,Qe,cu,Ie,(p=>()=>{if(p===null)return!1;try{new p({length:1,sampleRate:44100})}catch{return!1}return!0})(cu),nl,il),Or=(p=>(t,o)=>{const l=p(t,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});o.connect(l).connect(t.destination);const d=()=>{o.removeEventListener("ended",d),o.disconnect(l),l.disconnect()};o.addEventListener("ended",d)})(is),du=((p,t,o)=>async(l,d,v)=>{const b=t(l);await Promise.all(Array.from(b.activeInputs).map(async([_,x])=>{const S=p(_),M=await S.render(_,d);o(_)||M.connect(v,x)}))})(Ja,_e,cn),Us=(p=>(t,o,l)=>p(o,t,l))(du),yi=((p,t,o,l,d,v,b,_,x,S,M)=>(k,D)=>{const N=k.createBufferSource();return Te(N,D),fe(N,D,"playbackRate"),le(N,D,"buffer"),le(N,D,"loop"),le(N,D,"loopEnd"),le(N,D,"loopStart"),t(o,()=>o(k))||($=>{$.start=(B=>{let L=!1;return(W=0,z=0,F)=>{if(L)throw ke();B.call($,W,z,F),L=!0}})($.start)})(N),t(l,()=>l(k))||($=>{$.start=(B=>(L=0,W=0,z)=>{const F=$.buffer,Q=F===null?W:Math.min(F.duration,W);F!==null&&Q>F.duration-.5/$.context.sampleRate?B.call($,L,0,0):B.call($,L,Q,z)})($.start)})(N),t(d,()=>d(k))||S(N,k),t(v,()=>v(k))||Xa(N),t(b,()=>b(k))||M(N,k),t(_,()=>_(k))||Ya(N),p(k,N),N})(Or,Cs,p=>{const t=p.createBufferSource();t.start();try{t.start()}catch{return!0}return!1},p=>{const t=p.createBufferSource(),o=p.createBuffer(1,1,44100);t.buffer=o;try{t.start(0,1)}catch{return!1}return!0},p=>{const t=p.createBufferSource();t.start();try{t.stop()}catch{return!1}return!0},Za,tu,Qa,0,(p=>(t,o)=>{const l=o.createBuffer(1,1,44100);t.buffer===null&&(t.buffer=l),p(t,"buffer",d=>()=>{const v=d.call(t);return v===l?null:v},d=>v=>d.call(t,v===null?l:v))})(go),eu),Xs=((p,t)=>(o,l,d)=>(p(l).replay(d),t(l,o,d)))((p=>t=>{const o=p(t);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return o.renderer})(_e),du),jm=((p,t,o,l,d)=>()=>{const v=new WeakMap;let b=null,_=null;return{set start(x){b=x},set stop(x){_=x},render(x,S){const M=v.get(S);return M!==void 0?Promise.resolve(M):(async(k,D)=>{let N=o(k);const $=ht(N,D);if(!$){const B={buffer:N.buffer,channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,loop:N.loop,loopEnd:N.loopEnd,loopStart:N.loopStart,playbackRate:N.playbackRate.value};N=t(D,B),b!==null&&N.start(...b),_!==null&&N.stop(_)}return v.set(D,N),$?await p(D,k.playbackRate,N.playbackRate):await l(D,k.playbackRate,N.playbackRate),await d(k,D,N),N})(x,S)}}})(Us,yi,Jt,Xs,Oe),Ns=((p,t,o,l,d,v,b,_,x,S,M,k,D)=>(N,$,B,L=null,W=null)=>{const z=B.value,F=new f.AutomationEventList(z),Q=$?(H=>({replay(Z){for(const V of H)if(V.type==="exponentialRampToValue"){const{endTime:nt,value:X}=V;Z.exponentialRampToValueAtTime(X,nt)}else if(V.type==="linearRampToValue"){const{endTime:nt,value:X}=V;Z.linearRampToValueAtTime(X,nt)}else if(V.type==="setTarget"){const{startTime:nt,target:X,timeConstant:et}=V;Z.setTargetAtTime(X,nt,et)}else if(V.type==="setValue"){const{startTime:nt,value:X}=V;Z.setValueAtTime(X,nt)}else{if(V.type!=="setValueCurve")throw new Error("Can't apply an unknown automation.");{const{duration:nt,startTime:X,values:et}=V;Z.setValueCurveAtTime(et,X,nt)}}}}))(F):null,st={get defaultValue(){return z},get maxValue(){return L===null?B.maxValue:L},get minValue(){return W===null?B.minValue:W},get value(){return B.value},set value(H){B.value=H,st.setValueAtTime(H,N.context.currentTime)},cancelAndHoldAtTime(H){if(typeof B.cancelAndHoldAtTime=="function")Q===null&&F.flush(N.context.currentTime),F.add(d(H)),B.cancelAndHoldAtTime(H);else{const Z=Array.from(F).pop();Q===null&&F.flush(N.context.currentTime),F.add(d(H));const V=Array.from(F).pop();B.cancelScheduledValues(H),Z!==V&&V!==void 0&&(V.type==="exponentialRampToValue"?B.exponentialRampToValueAtTime(V.value,V.endTime):V.type==="linearRampToValue"?B.linearRampToValueAtTime(V.value,V.endTime):V.type==="setValue"?B.setValueAtTime(V.value,V.startTime):V.type==="setValueCurve"&&B.setValueCurveAtTime(V.values,V.startTime,V.duration))}return st},cancelScheduledValues:H=>(Q===null&&F.flush(N.context.currentTime),F.add(v(H)),B.cancelScheduledValues(H),st),exponentialRampToValueAtTime(H,Z){if(H===0)throw new RangeError;if(!Number.isFinite(Z)||Z<0)throw new RangeError;const V=N.context.currentTime;return Q===null&&F.flush(V),Array.from(F).length===0&&(F.add(S(z,V)),B.setValueAtTime(z,V)),F.add(b(H,Z)),B.exponentialRampToValueAtTime(H,Z),st},linearRampToValueAtTime(H,Z){const V=N.context.currentTime;return Q===null&&F.flush(V),Array.from(F).length===0&&(F.add(S(z,V)),B.setValueAtTime(z,V)),F.add(_(H,Z)),B.linearRampToValueAtTime(H,Z),st},setTargetAtTime:(H,Z,V)=>(Q===null&&F.flush(N.context.currentTime),F.add(x(H,Z,V)),B.setTargetAtTime(H,Z,V),st),setValueAtTime:(H,Z)=>(Q===null&&F.flush(N.context.currentTime),F.add(S(H,Z)),B.setValueAtTime(H,Z),st),setValueCurveAtTime(H,Z,V){const nt=H instanceof Float32Array?H:new Float32Array(H);if(k!==null&&k.name==="webkitAudioContext"){const X=Z+V,et=N.context.sampleRate,lt=Math.ceil(Z*et),ct=Math.floor(X*et),Mt=ct-lt,bt=new Float32Array(Mt);for(let Pt=0;Pt<Mt;Pt+=1){const gt=(nt.length-1)/V*((lt+Pt)/et-Z),kt=Math.floor(gt),Lt=Math.ceil(gt);bt[Pt]=kt===Lt?nt[kt]:(1-(gt-kt))*nt[kt]+(1-(Lt-gt))*nt[Lt]}Q===null&&F.flush(N.context.currentTime),F.add(M(bt,Z,V)),B.setValueCurveAtTime(bt,Z,V);const vt=ct/et;vt<X&&D(st,bt[bt.length-1],vt),D(st,nt[nt.length-1],X)}else Q===null&&F.flush(N.context.currentTime),F.add(M(nt,Z,V)),B.setValueCurveAtTime(nt,Z,V);return st}};return o.set(st,B),t.set(st,N),p(st,Q),st})((pu=C,(p,t)=>{pu.set(p,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:t})}),ou,A,0,f.createCancelAndHoldAutomationEvent,f.createCancelScheduledValuesAutomationEvent,f.createExponentialRampToValueAutomationEvent,f.createLinearRampToValueAutomationEvent,f.createSetTargetAutomationEvent,f.createSetValueAutomationEvent,f.createSetValueCurveAutomationEvent,Cn,Kh);var pu;const Um=((p,t,o,l,d,v,b,_)=>class extends p{constructor(x,S){const M=v(x),k={...Ge,...S},D=d(M,k),N=b(M),$=N?t():null;super(x,!1,D,$),this._audioBufferSourceNodeRenderer=$,this._isBufferNullified=!1,this._isBufferSet=k.buffer!==null,this._nativeAudioBufferSourceNode=D,this._onended=null,this._playbackRate=o(this,N,D.playbackRate,Bt,jt)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(x){if(this._nativeAudioBufferSourceNode.buffer=x,x!==null){if(this._isBufferSet)throw l();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(x){this._nativeAudioBufferSourceNode.loop=x}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(x){this._nativeAudioBufferSourceNode.loopEnd=x}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(x){this._nativeAudioBufferSourceNode.loopStart=x}get onended(){return this._onended}set onended(x){const S=typeof x=="function"?_(this,x):null;this._nativeAudioBufferSourceNode.onended=S;const M=this._nativeAudioBufferSourceNode.onended;this._onended=M!==null&&M===S?x:M}get playbackRate(){return this._playbackRate}start(x=0,S=0,M){if(this._nativeAudioBufferSourceNode.start(x,S,M),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=M===void 0?[x,S]:[x,S,M]),this.context.state!=="closed"){Tt(this);const k=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",k),ee(this)&&Wt(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",k)}}stop(x=0){this._nativeAudioBufferSourceNode.stop(x),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=x)}})(ye,jm,Ns,ke,yi,se,Zt,gi),Xm=((p,t,o,l,d,v,b,_)=>class extends p{constructor(x,S){const M=v(x),k=b(M),D=d(M,S,k);super(x,!1,D,k?(N=>{const $=new WeakMap;return{render(B,L){const W=$.get(L);return W!==void 0?Promise.resolve(W):(async(z,F)=>{const Q=F.destination;return $.set(F,Q),await N(z,F,Q),Q})(B,L)}}})(_):null),this._isNodeOfNativeOfflineAudioContext=k,this._nativeAudioDestinationNode=D}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(x){if(this._isNodeOfNativeOfflineAudioContext)throw l();if(x>this._nativeAudioDestinationNode.maxChannelCount)throw o();this._nativeAudioDestinationNode.channelCount=x}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(x){if(this._isNodeOfNativeOfflineAudioContext)throw l();this._nativeAudioDestinationNode.channelCountMode=x}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(ye,0,Ct,ke,((p,t)=>(o,l,d)=>{const v=o.destination;if(v.channelCount!==l)try{v.channelCount=l}catch{}d&&v.channelCountMode!=="explicit"&&(v.channelCountMode="explicit"),v.maxChannelCount===0&&Object.defineProperty(v,"maxChannelCount",{value:l});const b=p(o,{channelCount:l,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1});return t(b,"channelCount",_=>()=>_.call(b),_=>x=>{_.call(b,x);try{v.channelCount=x}catch(S){if(x>v.maxChannelCount)throw S}}),t(b,"channelCountMode",_=>()=>_.call(b),_=>x=>{_.call(b,x),v.channelCountMode=x}),t(b,"channelInterpretation",_=>()=>_.call(b),_=>x=>{_.call(b,x),v.channelInterpretation=x}),Object.defineProperty(b,"maxChannelCount",{get:()=>v.maxChannelCount}),b.connect(v),b})(is,go),se,Zt,Oe),Ym=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(b,_){const x=v.get(_);return x!==void 0?Promise.resolve(x):(async(S,M)=>{let k=o(S);const D=ht(k,M);if(!D){const N={Q:k.Q.value,channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,detune:k.detune.value,frequency:k.frequency.value,gain:k.gain.value,type:k.type};k=t(M,N)}return v.set(M,k),D?(await p(M,S.Q,k.Q),await p(M,S.detune,k.detune),await p(M,S.frequency,k.frequency),await p(M,S.gain,k.gain)):(await l(M,S.Q,k.Q),await l(M,S.detune,k.detune),await l(M,S.frequency,k.frequency),await l(M,S.gain,k.gain)),await d(S,M,k),k})(b,_)}}})(Us,Xh,Jt,Xs,Oe),jn=(p=>(t,o)=>p.set(t,o))(su),Zm=((p,t,o,l,d,v,b,_)=>class extends p{constructor(x,S){const M=v(x),k={...wm,...S},D=d(M,k),N=b(M);super(x,!1,D,N?o():null),this._Q=t(this,N,D.Q,Bt,jt),this._detune=t(this,N,D.detune,1200*Math.log2(Bt),-1200*Math.log2(Bt)),this._frequency=t(this,N,D.frequency,x.sampleRate/2,0),this._gain=t(this,N,D.gain,40*Math.log10(Bt),jt),this._nativeBiquadFilterNode=D,_(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(x){this._nativeBiquadFilterNode.type=x}getFrequencyResponse(x,S,M){try{this._nativeBiquadFilterNode.getFrequencyResponse(x,S,M)}catch(k){throw k.code===11?l():k}if(x.length!==S.length||S.length!==M.length)throw l()}})(ye,Ns,Ym,Rr,Xh,se,Zt,jn),Tn=((p,t)=>(o,l,d)=>{const v=new Set;return o.connect=(b=>(_,x=0,S=0)=>{const M=v.size===0;if(t(_))return b.call(o,_,x,S),p(v,[_,x,S],k=>k[0]===_&&k[1]===x&&k[2]===S,!0),M&&l(),_;b.call(o,_,x),p(v,[_,x],k=>k[0]===_&&k[1]===x,!0),M&&l()})(o.connect),o.disconnect=(b=>(_,x,S)=>{const M=v.size>0;if(_===void 0)b.apply(o),v.clear();else if(typeof _=="number"){b.call(o,_);for(const D of v)D[1]===_&&v.delete(D)}else{t(_)?b.call(o,_,x,S):b.call(o,_,x);for(const D of v)D[0]!==_||x!==void 0&&D[1]!==x||S!==void 0&&D[2]!==S||v.delete(D)}const k=v.size===0;M&&k&&d()})(o.disconnect),o})(Ce,tl),Qm=((p,t)=>(o,l)=>{l.channelCount=1,l.channelCountMode="explicit",Object.defineProperty(l,"channelCount",{get:()=>1,set:()=>{throw p()}}),Object.defineProperty(l,"channelCountMode",{get:()=>"explicit",set:()=>{throw p()}});const d=o.createBufferSource();t(l,()=>{const v=l.numberOfInputs;for(let b=0;b<v;b+=1)d.connect(l,0,b)},()=>d.disconnect(l))})(ke,Tn),An=((p,t)=>(o,l)=>{const d=o.createChannelMerger(l.numberOfInputs);return p!==null&&p.name==="webkitAudioContext"&&t(o,d),Te(d,l),d})(Cn,Qm),Jm=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const b=l.get(v);return b!==void 0?Promise.resolve(b):(async(_,x)=>{let S=t(_);if(!ht(S,x)){const M={channelCount:S.channelCount,channelCountMode:S.channelCountMode,channelInterpretation:S.channelInterpretation,numberOfInputs:S.numberOfInputs};S=p(x,M)}return l.set(x,S),await o(_,x,S),S})(d,v)}}})(An,Jt,Oe),Km=((p,t,o,l,d)=>class extends p{constructor(v,b){const _=l(v),x={..._m,...b};super(v,!1,o(_,x),d(_)?t():null)}})(ye,Jm,An,se,Zt),tf=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const b=l.get(v);return b!==void 0?Promise.resolve(b):(async(_,x)=>{let S=t(_);if(!ht(S,x)){const M={channelCount:S.channelCount,channelCountMode:S.channelCountMode,channelInterpretation:S.channelInterpretation,numberOfOutputs:S.numberOfOutputs};S=p(x,M)}return l.set(x,S),await o(_,x,S),S})(d,v)}}})(mo,Jt,Oe),ef=((p,t,o,l,d,v)=>class extends p{constructor(b,_){const x=l(b),S=(M=>({...M,channelCount:M.numberOfOutputs}))({...xm,..._});super(b,!1,o(x,S),d(x)?t():null)}})(ye,tf,mo,se,Zt),sf=((p,t,o,l)=>(d,{offset:v,...b})=>{const _=d.createBuffer(1,2,44100),x=t(d,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),S=o(d,{...b,gain:v}),M=_.getChannelData(0);M[0]=1,M[1]=1,x.buffer=_,x.loop=!0;const k={get bufferSize(){},get channelCount(){return S.channelCount},set channelCount(D){S.channelCount=D},get channelCountMode(){return S.channelCountMode},set channelCountMode(D){S.channelCountMode=D},get channelInterpretation(){return S.channelInterpretation},set channelInterpretation(D){S.channelInterpretation=D},get context(){return S.context},get inputs(){return[]},get numberOfInputs(){return x.numberOfInputs},get numberOfOutputs(){return S.numberOfOutputs},get offset(){return S.gain},get onended(){return x.onended},set onended(D){x.onended=D},addEventListener:(...D)=>x.addEventListener(D[0],D[1],D[2]),dispatchEvent:(...D)=>x.dispatchEvent(D[0]),removeEventListener:(...D)=>x.removeEventListener(D[0],D[1],D[2]),start(D=0){x.start.call(x,D)},stop(D=0){x.stop.call(x,D)}};return p(d,x),l(fi(k,S),()=>x.connect(S),()=>x.disconnect(S))})(Or,yi,is,Tn),bi=((p,t,o,l,d)=>(v,b)=>{if(v.createConstantSource===void 0)return o(v,b);const _=v.createConstantSource();return Te(_,b),fe(_,b,"offset"),t(l,()=>l(v))||Xa(_),t(d,()=>d(v))||Ya(_),p(v,_),_})(Or,Cs,sf,Za,Qa),nf=((p,t,o,l,d)=>()=>{const v=new WeakMap;let b=null,_=null;return{set start(x){b=x},set stop(x){_=x},render(x,S){const M=v.get(S);return M!==void 0?Promise.resolve(M):(async(k,D)=>{let N=o(k);const $=ht(N,D);if(!$){const B={channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,offset:N.offset.value};N=t(D,B),b!==null&&N.start(b),_!==null&&N.stop(_)}return v.set(D,N),$?await p(D,k.offset,N.offset):await l(D,k.offset,N.offset),await d(k,D,N),N})(x,S)}}})(Us,bi,Jt,Xs,Oe),of=((p,t,o,l,d,v,b)=>class extends p{constructor(_,x){const S=d(_),M={...Sm,...x},k=l(S,M),D=v(S),N=D?o():null;super(_,!1,k,N),this._constantSourceNodeRenderer=N,this._nativeConstantSourceNode=k,this._offset=t(this,D,k.offset,Bt,jt),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(_){const x=typeof _=="function"?b(this,_):null;this._nativeConstantSourceNode.onended=x;const S=this._nativeConstantSourceNode.onended;this._onended=S!==null&&S===x?_:S}start(_=0){if(this._nativeConstantSourceNode.start(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=_),this.context.state!=="closed"){Tt(this);const x=()=>{this._nativeConstantSourceNode.removeEventListener("ended",x),ee(this)&&Wt(this)};this._nativeConstantSourceNode.addEventListener("ended",x)}}stop(_=0){this._nativeConstantSourceNode.stop(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=_)}})(ye,Ns,nf,bi,se,Zt,gi),mu=((p,t)=>(o,l)=>{const d=o.createConvolver();if(Te(d,l),l.disableNormalization===d.normalize&&(d.normalize=!l.disableNormalization),le(d,l,"buffer"),l.channelCount>2||(t(d,"channelCount",v=>()=>v.call(d),v=>b=>{if(b>2)throw p();return v.call(d,b)}),l.channelCountMode==="max"))throw p();return t(d,"channelCountMode",v=>()=>v.call(d),v=>b=>{if(b==="max")throw p();return v.call(d,b)}),d})(Qe,go),rf=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const b=l.get(v);return b!==void 0?Promise.resolve(b):(async(_,x)=>{let S=t(_);if(!ht(S,x)){const M={buffer:S.buffer,channelCount:S.channelCount,channelCountMode:S.channelCountMode,channelInterpretation:S.channelInterpretation,disableNormalization:!S.normalize};S=p(x,M)}return l.set(x,S),De(S)?await o(_,x,S.inputs[0]):await o(_,x,S),S})(d,v)}}})(mu,Jt,Oe),af=((p,t,o,l,d,v)=>class extends p{constructor(b,_){const x=l(b),S={...Cm,..._},M=o(x,S);super(b,!1,M,d(x)?t():null),this._isBufferNullified=!1,this._nativeConvolverNode=M,S.buffer!==null&&v(this,S.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(b){if(this._nativeConvolverNode.buffer=b,b===null&&this._nativeConvolverNode.buffer!==null){const _=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=_.createBuffer(1,1,_.sampleRate),this._isBufferNullified=!0,v(this,0)}else this._isBufferNullified=!1,v(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(b){this._nativeConvolverNode.normalize=b}})(ye,rf,mu,se,Zt,jn),lf=((p,t,o,l,d)=>v=>{const b=new WeakMap;return{render(_,x){const S=b.get(x);return S!==void 0?Promise.resolve(S):(async(M,k)=>{let D=o(M);const N=ht(D,k);if(!N){const $={channelCount:D.channelCount,channelCountMode:D.channelCountMode,channelInterpretation:D.channelInterpretation,delayTime:D.delayTime.value,maxDelayTime:v};D=t(k,$)}return b.set(k,D),N?await p(k,M.delayTime,D.delayTime):await l(k,M.delayTime,D.delayTime),await d(M,k,D),D})(_,x)}}})(Us,Yh,Jt,Xs,Oe),cf=((p,t,o,l,d,v,b)=>class extends p{constructor(_,x){const S=d(_),M={...Tm,...x},k=l(S,M),D=v(S);super(_,!1,k,D?o(M.maxDelayTime):null),this._delayTime=t(this,D,k.delayTime),b(this,M.maxDelayTime)}get delayTime(){return this._delayTime}})(ye,Ns,lf,Yh,se,Zt,jn),fu=(p=>(t,o)=>{const l=t.createDynamicsCompressor();if(Te(l,o),o.channelCount>2||o.channelCountMode==="max")throw p();return fe(l,o,"attack"),fe(l,o,"knee"),fe(l,o,"ratio"),fe(l,o,"release"),fe(l,o,"threshold"),l})(Qe),hf=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(b,_){const x=v.get(_);return x!==void 0?Promise.resolve(x):(async(S,M)=>{let k=o(S);const D=ht(k,M);if(!D){const N={attack:k.attack.value,channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,knee:k.knee.value,ratio:k.ratio.value,release:k.release.value,threshold:k.threshold.value};k=t(M,N)}return v.set(M,k),D?(await p(M,S.attack,k.attack),await p(M,S.knee,k.knee),await p(M,S.ratio,k.ratio),await p(M,S.release,k.release),await p(M,S.threshold,k.threshold)):(await l(M,S.attack,k.attack),await l(M,S.knee,k.knee),await l(M,S.ratio,k.ratio),await l(M,S.release,k.release),await l(M,S.threshold,k.threshold)),await d(S,M,k),k})(b,_)}}})(Us,fu,Jt,Xs,Oe),uf=((p,t,o,l,d,v,b,_)=>class extends p{constructor(x,S){const M=v(x),k={...Am,...S},D=l(M,k),N=b(M);super(x,!1,D,N?o():null),this._attack=t(this,N,D.attack),this._knee=t(this,N,D.knee),this._nativeDynamicsCompressorNode=D,this._ratio=t(this,N,D.ratio),this._release=t(this,N,D.release),this._threshold=t(this,N,D.threshold),_(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(x){const S=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=x,x>2)throw this._nativeDynamicsCompressorNode.channelCount=S,d()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(x){const S=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=x,x==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=S,d()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(ye,Ns,hf,fu,Qe,se,Zt,jn),df=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(b,_){const x=v.get(_);return x!==void 0?Promise.resolve(x):(async(S,M)=>{let k=o(S);const D=ht(k,M);if(!D){const N={channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,gain:k.gain.value};k=t(M,N)}return v.set(M,k),D?await p(M,S.gain,k.gain):await l(M,S.gain,k.gain),await d(S,M,k),k})(b,_)}}})(Us,is,Jt,Xs,Oe),pf=((p,t,o,l,d,v)=>class extends p{constructor(b,_){const x=d(b),S={...Mm,..._},M=l(x,S),k=v(x);super(b,!1,M,k?o():null),this._gain=t(this,k,M.gain,Bt,jt)}get gain(){return this._gain}})(ye,Ns,df,is,se,Zt),mf=((p,t,o,l)=>(d,v,{channelCount:b,channelCountMode:_,channelInterpretation:x,feedback:S,feedforward:M})=>{const k=Uh(v,d.sampleRate),D=S instanceof Float64Array?S:new Float64Array(S),N=M instanceof Float64Array?M:new Float64Array(M),$=D.length,B=N.length,L=Math.min($,B);if($===0||$>20)throw l();if(D[0]===0)throw t();if(B===0||B>20)throw l();if(N[0]===0)throw t();if(D[0]!==1){for(let H=0;H<B;H+=1)N[H]/=D[0];for(let H=1;H<$;H+=1)D[H]/=D[0]}const W=o(d,k,b,b);W.channelCount=b,W.channelCountMode=_,W.channelInterpretation=x;const z=[],F=[],Q=[];for(let H=0;H<b;H+=1){z.push(0);const Z=new Float32Array(32),V=new Float32Array(32);Z.fill(0),V.fill(0),F.push(Z),Q.push(V)}W.onaudioprocess=H=>{const Z=H.inputBuffer,V=H.outputBuffer,nt=Z.numberOfChannels;for(let X=0;X<nt;X+=1){const et=Z.getChannelData(X),lt=V.getChannelData(X);z[X]=Gh(D,$,N,B,L,F[X],Q[X],z[X],32,et,lt)}};const st=d.sampleRate/2;return fi({get bufferSize(){return k},get channelCount(){return W.channelCount},set channelCount(H){W.channelCount=H},get channelCountMode(){return W.channelCountMode},set channelCountMode(H){W.channelCountMode=H},get channelInterpretation(){return W.channelInterpretation},set channelInterpretation(H){W.channelInterpretation=H},get context(){return W.context},get inputs(){return[W]},get numberOfInputs(){return W.numberOfInputs},get numberOfOutputs(){return W.numberOfOutputs},addEventListener:(...H)=>W.addEventListener(H[0],H[1],H[2]),dispatchEvent:(...H)=>W.dispatchEvent(H[0]),getFrequencyResponse(H,Z,V){if(H.length!==Z.length||Z.length!==V.length)throw p();const nt=H.length;for(let X=0;X<nt;X+=1){const et=-Math.PI*(H[X]/st),lt=[Math.cos(et),Math.sin(et)],ct=km(Zh(N,lt),Zh(D,lt));Z[X]=Math.sqrt(ct[0]*ct[0]+ct[1]*ct[1]),V[X]=Math.atan2(ct[1],ct[0])}},removeEventListener:(...H)=>W.removeEventListener(H[0],H[1],H[2])},W)})(Rr,ke,fo,Qe),Nr=((p,t,o,l)=>d=>p(po,()=>po(d))?Promise.resolve(p(l,l)).then(v=>{if(!v){const b=o(d,512,0,1);d.oncomplete=()=>{b.onaudioprocess=null,b.disconnect()},b.onaudioprocess=()=>d.currentTime,b.connect(d.destination)}return d.startRendering()}):new Promise(v=>{const b=t(d,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});d.oncomplete=_=>{b.disconnect(),v(_.renderedBuffer)},b.connect(d.destination),d.startRendering()}))(Cs,is,fo,((p,t)=>()=>{if(t===null)return Promise.resolve(!1);const o=new t(1,1,44100),l=p(o,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise(d=>{o.oncomplete=()=>{l.disconnect(),d(o.currentTime!==0)},o.startRendering()})})(is,Ie)),ff=((p,t,o,l,d)=>(v,b)=>{const _=new WeakMap;let x=null;return{render(S,M){const k=_.get(M);return k!==void 0?Promise.resolve(k):(async(D,N)=>{let $=null,B=t(D);const L=ht(B,N);if(N.createIIRFilter===void 0?$=p(N,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):L||(B=N.createIIRFilter(b,v)),_.set(N,$===null?B:$),$!==null){if(x===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const z=new o(D.context.destination.channelCount,D.context.length,N.sampleRate);x=(async()=>(await l(D,z,z.destination),((F,Q,st,H)=>{const Z=st instanceof Float64Array?st:new Float64Array(st),V=H instanceof Float64Array?H:new Float64Array(H),nt=Z.length,X=V.length,et=Math.min(nt,X);if(Z[0]!==1){for(let vt=0;vt<nt;vt+=1)V[vt]/=Z[0];for(let vt=1;vt<X;vt+=1)Z[vt]/=Z[0]}const lt=new Float32Array(32),ct=new Float32Array(32),Mt=Q.createBuffer(F.numberOfChannels,F.length,F.sampleRate),bt=F.numberOfChannels;for(let vt=0;vt<bt;vt+=1){const Pt=F.getChannelData(vt),gt=Mt.getChannelData(vt);lt.fill(0),ct.fill(0),Gh(Z,nt,V,X,et,lt,ct,0,32,Pt,gt)}return Mt})(await d(z),N,v,b)))()}const W=await x;return $.buffer=W,$.start(0),$}return await l(D,N,B),B})(S,M)}}})(yi,Jt,Ie,Oe,Nr),gf=(p=>(t,o,l)=>{if(t.createIIRFilter===void 0)return p(t,o,l);const d=t.createIIRFilter(l.feedforward,l.feedback);return Te(d,l),d})(mf),vf=((p,t,o,l,d,v)=>class extends p{constructor(b,_){const x=l(b),S=d(x),M={...Em,..._},k=t(x,S?null:b.baseLatency,M);super(b,!1,k,S?o(M.feedback,M.feedforward):null),(D=>{var N;D.getFrequencyResponse=(N=D.getFrequencyResponse,($,B,L)=>{if($.length!==B.length||B.length!==L.length)throw Rr();return N.call(D,$,B,L)})})(k),this._nativeIIRFilterNode=k,v(this,1)}getFrequencyResponse(b,_,x){return this._nativeIIRFilterNode.getFrequencyResponse(b,_,x)}})(ye,gf,ff,se,Zt,jn),yf=((p,t,o,l,d,v,b,_)=>(x,S)=>{const M=S.listener,{forwardX:k,forwardY:D,forwardZ:N,positionX:$,positionY:B,positionZ:L,upX:W,upY:z,upZ:F}=M.forwardX===void 0?(()=>{const Q=new Float32Array(1),st=t(S,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),H=b(S);let Z=!1,V=[0,0,-1,0,1,0],nt=[0,0,0];const X=()=>{if(Z)return;Z=!0;const Mt=l(S,256,9,0);Mt.onaudioprocess=({inputBuffer:bt})=>{const vt=[v(bt,Q,0),v(bt,Q,1),v(bt,Q,2),v(bt,Q,3),v(bt,Q,4),v(bt,Q,5)];vt.some((gt,kt)=>gt!==V[kt])&&(M.setOrientation(...vt),V=vt);const Pt=[v(bt,Q,6),v(bt,Q,7),v(bt,Q,8)];Pt.some((gt,kt)=>gt!==nt[kt])&&(M.setPosition(...Pt),nt=Pt)},st.connect(Mt)},et=Mt=>bt=>{bt!==V[Mt]&&(V[Mt]=bt,M.setOrientation(...V))},lt=Mt=>bt=>{bt!==nt[Mt]&&(nt[Mt]=bt,M.setPosition(...nt))},ct=(Mt,bt,vt)=>{const Pt=o(S,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:bt});Pt.connect(st,0,Mt),Pt.start(),Object.defineProperty(Pt.offset,"defaultValue",{get:()=>bt});const gt=p({context:x},H,Pt.offset,Bt,jt);var kt,Lt,Vt,oe,ve,rs,Ot;return _(gt,"value",mt=>()=>mt.call(gt),mt=>te=>{try{mt.call(gt,te)}catch(Yt){if(Yt.code!==9)throw Yt}X(),H&&vt(te)}),gt.cancelAndHoldAtTime=(kt=gt.cancelAndHoldAtTime,H?()=>{throw d()}:(...mt)=>{const te=kt.apply(gt,mt);return X(),te}),gt.cancelScheduledValues=(Lt=gt.cancelScheduledValues,H?()=>{throw d()}:(...mt)=>{const te=Lt.apply(gt,mt);return X(),te}),gt.exponentialRampToValueAtTime=(Vt=gt.exponentialRampToValueAtTime,H?()=>{throw d()}:(...mt)=>{const te=Vt.apply(gt,mt);return X(),te}),gt.linearRampToValueAtTime=(oe=gt.linearRampToValueAtTime,H?()=>{throw d()}:(...mt)=>{const te=oe.apply(gt,mt);return X(),te}),gt.setTargetAtTime=(ve=gt.setTargetAtTime,H?()=>{throw d()}:(...mt)=>{const te=ve.apply(gt,mt);return X(),te}),gt.setValueAtTime=(rs=gt.setValueAtTime,H?()=>{throw d()}:(...mt)=>{const te=rs.apply(gt,mt);return X(),te}),gt.setValueCurveAtTime=(Ot=gt.setValueCurveAtTime,H?()=>{throw d()}:(...mt)=>{const te=Ot.apply(gt,mt);return X(),te}),gt};return{forwardX:ct(0,0,et(0)),forwardY:ct(1,0,et(1)),forwardZ:ct(2,-1,et(2)),positionX:ct(6,0,lt(0)),positionY:ct(7,0,lt(1)),positionZ:ct(8,0,lt(2)),upX:ct(3,0,et(3)),upY:ct(4,1,et(4)),upZ:ct(5,0,et(5))}})():M;return{get forwardX(){return k},get forwardY(){return D},get forwardZ(){return N},get positionX(){return $},get positionY(){return B},get positionZ(){return L},get upX(){return W},get upY(){return z},get upZ(){return F}}})(Ns,An,bi,fo,Qe,Qh,Zt,go),gu=new WeakMap,bf=((p,t,o,l,d,v)=>class extends o{constructor(b,_){super(b),this._nativeContext=b,I.set(this,b),l(b)&&d.set(b,new Set),this._destination=new p(this,_),this._listener=t(this,b),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(b){const _=typeof b=="function"?v(this,b):null;this._nativeContext.onstatechange=_;const x=this._nativeContext.onstatechange;this._onstatechange=x!==null&&x===_?b:x}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(Xm,yf,ru,Zt,gu,gi),vu=((p,t,o,l,d,v)=>(b,_)=>{const x=b.createOscillator();return Te(x,_),fe(x,_,"detune"),fe(x,_,"frequency"),_.periodicWave!==void 0?x.setPeriodicWave(_.periodicWave):le(x,_,"type"),t(o,()=>o(b))||Xa(x),t(l,()=>l(b))||v(x,b),t(d,()=>d(b))||Ya(x),p(b,x),x})(Or,Cs,Za,tu,Qa,eu),wf=((p,t,o,l,d)=>()=>{const v=new WeakMap;let b=null,_=null,x=null;return{set periodicWave(S){b=S},set start(S){_=S},set stop(S){x=S},render(S,M){const k=v.get(M);return k!==void 0?Promise.resolve(k):(async(D,N)=>{let $=o(D);const B=ht($,N);if(!B){const L={channelCount:$.channelCount,channelCountMode:$.channelCountMode,channelInterpretation:$.channelInterpretation,detune:$.detune.value,frequency:$.frequency.value,periodicWave:b===null?void 0:b,type:$.type};$=t(N,L),_!==null&&$.start(_),x!==null&&$.stop(x)}return v.set(N,$),B?(await p(N,D.detune,$.detune),await p(N,D.frequency,$.frequency)):(await l(N,D.detune,$.detune),await l(N,D.frequency,$.frequency)),await d(D,N,$),$})(S,M)}}})(Us,vu,Jt,Xs,Oe),_f=((p,t,o,l,d,v,b)=>class extends p{constructor(_,x){const S=d(_),M={...Rm,...x},k=o(S,M),D=v(S),N=D?l():null,$=_.sampleRate/2;super(_,!1,k,N),this._detune=t(this,D,k.detune,153600,-153600),this._frequency=t(this,D,k.frequency,$,-$),this._nativeOscillatorNode=k,this._onended=null,this._oscillatorNodeRenderer=N,this._oscillatorNodeRenderer!==null&&M.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=M.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(_){const x=typeof _=="function"?b(this,_):null;this._nativeOscillatorNode.onended=x;const S=this._nativeOscillatorNode.onended;this._onended=S!==null&&S===x?_:S}get type(){return this._nativeOscillatorNode.type}set type(_){this._nativeOscillatorNode.type=_,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(_){this._nativeOscillatorNode.setPeriodicWave(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=_)}start(_=0){if(this._nativeOscillatorNode.start(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=_),this.context.state!=="closed"){Tt(this);const x=()=>{this._nativeOscillatorNode.removeEventListener("ended",x),ee(this)&&Wt(this)};this._nativeOscillatorNode.addEventListener("ended",x)}}stop(_=0){this._nativeOscillatorNode.stop(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=_)}})(ye,Ns,vu,wf,se,Zt,gi),yu=(p=>(t,o)=>{const l=p(t,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),d=t.createBuffer(1,2,44100);return l.buffer=d,l.loop=!0,l.connect(o),l.start(),()=>{l.stop(),l.disconnect(o)}})(yi),xf=((p,t,o,l,d)=>(v,{curve:b,oversample:_,...x})=>{const S=v.createWaveShaper(),M=v.createWaveShaper();Te(S,x),Te(M,x);const k=o(v,{...x,gain:1}),D=o(v,{...x,gain:-1}),N=o(v,{...x,gain:1}),$=o(v,{...x,gain:-1});let B=null,L=!1,W=null;const z={get bufferSize(){},get channelCount(){return S.channelCount},set channelCount(F){k.channelCount=F,D.channelCount=F,S.channelCount=F,N.channelCount=F,M.channelCount=F,$.channelCount=F},get channelCountMode(){return S.channelCountMode},set channelCountMode(F){k.channelCountMode=F,D.channelCountMode=F,S.channelCountMode=F,N.channelCountMode=F,M.channelCountMode=F,$.channelCountMode=F},get channelInterpretation(){return S.channelInterpretation},set channelInterpretation(F){k.channelInterpretation=F,D.channelInterpretation=F,S.channelInterpretation=F,N.channelInterpretation=F,M.channelInterpretation=F,$.channelInterpretation=F},get context(){return S.context},get curve(){return W},set curve(F){if(F!==null&&F.length<2)throw t();if(F===null)S.curve=F,M.curve=F;else{const Q=F.length,st=new Float32Array(Q+2-Q%2),H=new Float32Array(Q+2-Q%2);st[0]=F[0],H[0]=-F[Q-1];const Z=Math.ceil((Q+1)/2),V=(Q+1)/2-1;for(let nt=1;nt<Z;nt+=1){const X=nt/Z*V,et=Math.floor(X),lt=Math.ceil(X);st[nt]=et===lt?F[et]:(1-(X-et))*F[et]+(1-(lt-X))*F[lt],H[nt]=et===lt?-F[Q-1-et]:-(1-(X-et))*F[Q-1-et]-(1-(lt-X))*F[Q-1-lt]}st[Z]=Q%2==1?F[Z-1]:(F[Z-2]+F[Z-1])/2,S.curve=st,M.curve=H}W=F,L&&(l(W)&&B===null?B=p(v,k):B!==null&&(B(),B=null))},get inputs(){return[k]},get numberOfInputs(){return S.numberOfInputs},get numberOfOutputs(){return S.numberOfOutputs},get oversample(){return S.oversample},set oversample(F){S.oversample=F,M.oversample=F},addEventListener:(...F)=>k.addEventListener(F[0],F[1],F[2]),dispatchEvent:(...F)=>k.dispatchEvent(F[0]),removeEventListener:(...F)=>k.removeEventListener(F[0],F[1],F[2])};return b!==null&&(z.curve=b instanceof Float32Array?b:new Float32Array(b)),_!==z.oversample&&(z.oversample=_),d(fi(z,N),()=>{k.connect(S).connect(N),k.connect(D).connect(M).connect($).connect(N),L=!0,l(W)&&(B=p(v,k))},()=>{k.disconnect(S),S.disconnect(N),k.disconnect(D),D.disconnect(M),M.disconnect($),$.disconnect(N),L=!1,B!==null&&(B(),B=null)})})(yu,ke,is,Jh,Tn),Lr=((p,t,o,l,d,v,b)=>(_,x)=>{const S=_.createWaveShaper();if(v!==null&&v.name==="webkitAudioContext"&&_.createGain().gain.automationRate===void 0)return o(_,x);Te(S,x);const M=x.curve===null||x.curve instanceof Float32Array?x.curve:new Float32Array(x.curve);if(M!==null&&M.length<2)throw t();le(S,{curve:M},"curve"),le(S,x,"oversample");let k=null,D=!1;return b(S,"curve",N=>()=>N.call(S),N=>$=>(N.call(S,$),D&&(l($)&&k===null?k=p(_,S):l($)||k===null||(k(),k=null)),$)),d(S,()=>{D=!0,l(S.curve)&&(k=p(_,S))},()=>{D=!1,k!==null&&(k(),k=null)})})(yu,ke,xf,Jh,Tn,Cn,go),Sf=((p,t,o,l,d,v,b,_,x,S)=>(M,{coneInnerAngle:k,coneOuterAngle:D,coneOuterGain:N,distanceModel:$,maxDistance:B,orientationX:L,orientationY:W,orientationZ:z,panningModel:F,positionX:Q,positionY:st,positionZ:H,refDistance:Z,rolloffFactor:V,...nt})=>{const X=M.createPanner();if(nt.channelCount>2||nt.channelCountMode==="max")throw b();Te(X,nt);const et={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},lt=o(M,{...et,channelInterpretation:"speakers",numberOfInputs:6}),ct=l(M,{...nt,gain:1}),Mt=l(M,{...et,gain:1}),bt=l(M,{...et,gain:0}),vt=l(M,{...et,gain:0}),Pt=l(M,{...et,gain:0}),gt=l(M,{...et,gain:0}),kt=l(M,{...et,gain:0}),Lt=d(M,256,6,1),Vt=v(M,{...et,curve:new Float32Array([1,1]),oversample:"none"});let oe=[L,W,z],ve=[Q,st,H];const rs=new Float32Array(1);Lt.onaudioprocess=({inputBuffer:mt})=>{const te=[x(mt,rs,0),x(mt,rs,1),x(mt,rs,2)];te.some((qe,Nn)=>qe!==oe[Nn])&&(X.setOrientation(...te),oe=te);const Yt=[x(mt,rs,3),x(mt,rs,4),x(mt,rs,5)];Yt.some((qe,Nn)=>qe!==ve[Nn])&&(X.setPosition(...Yt),ve=Yt)},Object.defineProperty(bt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(vt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Pt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(gt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(kt.gain,"defaultValue",{get:()=>0});const Ot={get bufferSize(){},get channelCount(){return X.channelCount},set channelCount(mt){if(mt>2)throw b();ct.channelCount=mt,X.channelCount=mt},get channelCountMode(){return X.channelCountMode},set channelCountMode(mt){if(mt==="max")throw b();ct.channelCountMode=mt,X.channelCountMode=mt},get channelInterpretation(){return X.channelInterpretation},set channelInterpretation(mt){ct.channelInterpretation=mt,X.channelInterpretation=mt},get coneInnerAngle(){return X.coneInnerAngle},set coneInnerAngle(mt){X.coneInnerAngle=mt},get coneOuterAngle(){return X.coneOuterAngle},set coneOuterAngle(mt){X.coneOuterAngle=mt},get coneOuterGain(){return X.coneOuterGain},set coneOuterGain(mt){if(mt<0||mt>1)throw t();X.coneOuterGain=mt},get context(){return X.context},get distanceModel(){return X.distanceModel},set distanceModel(mt){X.distanceModel=mt},get inputs(){return[ct]},get maxDistance(){return X.maxDistance},set maxDistance(mt){if(mt<0)throw new RangeError;X.maxDistance=mt},get numberOfInputs(){return X.numberOfInputs},get numberOfOutputs(){return X.numberOfOutputs},get orientationX(){return Mt.gain},get orientationY(){return bt.gain},get orientationZ(){return vt.gain},get panningModel(){return X.panningModel},set panningModel(mt){X.panningModel=mt},get positionX(){return Pt.gain},get positionY(){return gt.gain},get positionZ(){return kt.gain},get refDistance(){return X.refDistance},set refDistance(mt){if(mt<0)throw new RangeError;X.refDistance=mt},get rolloffFactor(){return X.rolloffFactor},set rolloffFactor(mt){if(mt<0)throw new RangeError;X.rolloffFactor=mt},addEventListener:(...mt)=>ct.addEventListener(mt[0],mt[1],mt[2]),dispatchEvent:(...mt)=>ct.dispatchEvent(mt[0]),removeEventListener:(...mt)=>ct.removeEventListener(mt[0],mt[1],mt[2])};return k!==Ot.coneInnerAngle&&(Ot.coneInnerAngle=k),D!==Ot.coneOuterAngle&&(Ot.coneOuterAngle=D),N!==Ot.coneOuterGain&&(Ot.coneOuterGain=N),$!==Ot.distanceModel&&(Ot.distanceModel=$),B!==Ot.maxDistance&&(Ot.maxDistance=B),L!==Ot.orientationX.value&&(Ot.orientationX.value=L),W!==Ot.orientationY.value&&(Ot.orientationY.value=W),z!==Ot.orientationZ.value&&(Ot.orientationZ.value=z),F!==Ot.panningModel&&(Ot.panningModel=F),Q!==Ot.positionX.value&&(Ot.positionX.value=Q),st!==Ot.positionY.value&&(Ot.positionY.value=st),H!==Ot.positionZ.value&&(Ot.positionZ.value=H),Z!==Ot.refDistance&&(Ot.refDistance=Z),V!==Ot.rolloffFactor&&(Ot.rolloffFactor=V),oe[0]===1&&oe[1]===0&&oe[2]===0||X.setOrientation(...oe),ve[0]===0&&ve[1]===0&&ve[2]===0||X.setPosition(...ve),S(fi(Ot,X),()=>{ct.connect(X),p(ct,Vt,0,0),Vt.connect(Mt).connect(lt,0,0),Vt.connect(bt).connect(lt,0,1),Vt.connect(vt).connect(lt,0,2),Vt.connect(Pt).connect(lt,0,3),Vt.connect(gt).connect(lt,0,4),Vt.connect(kt).connect(lt,0,5),lt.connect(Lt).connect(M.destination)},()=>{ct.disconnect(X),_(ct,Vt,0,0),Vt.disconnect(Mt),Mt.disconnect(lt),Vt.disconnect(bt),bt.disconnect(lt),Vt.disconnect(vt),vt.disconnect(lt),Vt.disconnect(Pt),Pt.disconnect(lt),Vt.disconnect(gt),gt.disconnect(lt),Vt.disconnect(kt),kt.disconnect(lt),lt.disconnect(Lt),Lt.disconnect(M.destination)})})(xn,ke,An,is,fo,Lr,Qe,Sn,Qh,Tn),bu=(p=>(t,o)=>{const l=t.createPanner();return l.orientationX===void 0?p(t,o):(Te(l,o),fe(l,o,"orientationX"),fe(l,o,"orientationY"),fe(l,o,"orientationZ"),fe(l,o,"positionX"),fe(l,o,"positionY"),fe(l,o,"positionZ"),le(l,o,"coneInnerAngle"),le(l,o,"coneOuterAngle"),le(l,o,"coneOuterGain"),le(l,o,"distanceModel"),le(l,o,"maxDistance"),le(l,o,"panningModel"),le(l,o,"refDistance"),le(l,o,"rolloffFactor"),l)})(Sf),Cf=((p,t,o,l,d,v,b,_,x,S)=>()=>{const M=new WeakMap;let k=null;return{render(D,N){const $=M.get(N);return $!==void 0?Promise.resolve($):(async(B,L)=>{let W=null,z=v(B);const F={channelCount:z.channelCount,channelCountMode:z.channelCountMode,channelInterpretation:z.channelInterpretation},Q={...F,coneInnerAngle:z.coneInnerAngle,coneOuterAngle:z.coneOuterAngle,coneOuterGain:z.coneOuterGain,distanceModel:z.distanceModel,maxDistance:z.maxDistance,panningModel:z.panningModel,refDistance:z.refDistance,rolloffFactor:z.rolloffFactor},st=ht(z,L);if("bufferSize"in z)W=l(L,{...F,gain:1});else if(!st){const H={...Q,orientationX:z.orientationX.value,orientationY:z.orientationY.value,orientationZ:z.orientationZ.value,positionX:z.positionX.value,positionY:z.positionY.value,positionZ:z.positionZ.value};z=d(L,H)}if(M.set(L,W===null?z:W),W!==null){if(k===null){if(b===null)throw new Error("Missing the native OfflineAudioContext constructor.");const ct=new b(6,B.context.length,L.sampleRate),Mt=t(ct,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});Mt.connect(ct.destination),k=(async()=>{const bt=await Promise.all([B.orientationX,B.orientationY,B.orientationZ,B.positionX,B.positionY,B.positionZ].map(async(vt,Pt)=>{const gt=o(ct,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Pt===0?1:0});return await _(ct,vt,gt.offset),gt}));for(let vt=0;vt<6;vt+=1)bt[vt].connect(Mt,0,vt),bt[vt].start(0);return S(ct)})()}const H=await k,Z=l(L,{...F,gain:1});await x(B,L,Z);const V=[];for(let ct=0;ct<H.numberOfChannels;ct+=1)V.push(H.getChannelData(ct));let nt=[V[0][0],V[1][0],V[2][0]],X=[V[3][0],V[4][0],V[5][0]],et=l(L,{...F,gain:1}),lt=d(L,{...Q,orientationX:nt[0],orientationY:nt[1],orientationZ:nt[2],positionX:X[0],positionY:X[1],positionZ:X[2]});Z.connect(et).connect(lt.inputs[0]),lt.connect(W);for(let ct=128;ct<H.length;ct+=128){const Mt=[V[0][ct],V[1][ct],V[2][ct]],bt=[V[3][ct],V[4][ct],V[5][ct]];if(Mt.some((vt,Pt)=>vt!==nt[Pt])||bt.some((vt,Pt)=>vt!==X[Pt])){nt=Mt,X=bt;const vt=ct/L.sampleRate;et.gain.setValueAtTime(0,vt),et=l(L,{...F,gain:0}),lt=d(L,{...Q,orientationX:nt[0],orientationY:nt[1],orientationZ:nt[2],positionX:X[0],positionY:X[1],positionZ:X[2]}),et.gain.setValueAtTime(1,vt),Z.connect(et).connect(lt.inputs[0]),lt.connect(W)}}return W}return st?(await p(L,B.orientationX,z.orientationX),await p(L,B.orientationY,z.orientationY),await p(L,B.orientationZ,z.orientationZ),await p(L,B.positionX,z.positionX),await p(L,B.positionY,z.positionY),await p(L,B.positionZ,z.positionZ)):(await _(L,B.orientationX,z.orientationX),await _(L,B.orientationY,z.orientationY),await _(L,B.orientationZ,z.orientationZ),await _(L,B.positionX,z.positionX),await _(L,B.positionY,z.positionY),await _(L,B.positionZ,z.positionZ)),De(z)?await x(B,L,z.inputs[0]):await x(B,L,z),z})(D,N)}}})(Us,An,bi,is,bu,Jt,Ie,Xs,Oe,Nr),Tf=((p,t,o,l,d,v,b)=>class extends p{constructor(_,x){const S=d(_),M={...Dm,...x},k=o(S,M),D=v(S);super(_,!1,k,D?l():null),this._nativePannerNode=k,this._orientationX=t(this,D,k.orientationX,Bt,jt),this._orientationY=t(this,D,k.orientationY,Bt,jt),this._orientationZ=t(this,D,k.orientationZ,Bt,jt),this._positionX=t(this,D,k.positionX,Bt,jt),this._positionY=t(this,D,k.positionY,Bt,jt),this._positionZ=t(this,D,k.positionZ,Bt,jt),b(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(_){this._nativePannerNode.coneInnerAngle=_}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(_){this._nativePannerNode.coneOuterAngle=_}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(_){this._nativePannerNode.coneOuterGain=_}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(_){this._nativePannerNode.distanceModel=_}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(_){this._nativePannerNode.maxDistance=_}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(_){this._nativePannerNode.panningModel=_}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(_){this._nativePannerNode.refDistance=_}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(_){this._nativePannerNode.rolloffFactor=_}})(ye,Ns,bu,Cf,se,Zt,jn),Af=(p=>(t,{disableNormalization:o,imag:l,real:d})=>{const v=l instanceof Float32Array?l:new Float32Array(l),b=d instanceof Float32Array?d:new Float32Array(d),_=t.createPeriodicWave(b,v,{disableNormalization:o});if(Array.from(l).length<2)throw p();return _})(Ct),Mf=((p,t,o,l)=>class ip{constructor(v,b){const _=t(v),x=(M=>{const{imag:k,real:D}=M;return k===void 0?D===void 0?{...M,imag:[0,0],real:[0,0]}:{...M,imag:Array.from(D,()=>0),real:D}:D===void 0?{...M,imag:k,real:Array.from(k,()=>0)}:{...M,imag:k,real:D}})({...Om,...b}),S=p(_,x);return o.add(S),S}static[Symbol.hasInstance](v){return v!==null&&typeof v=="object"&&Object.getPrototypeOf(v)===ip.prototype||o.has(v)}})(Af,se,new WeakSet),Ef=((p,t,o,l,d,v)=>{const _=new Float32Array([1,1]),x=Math.PI/2,S={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},M={...S,oversample:"none"},k=(D,N,$,B,L)=>{if(N===1)return((W,z,F,Q)=>{const st=new Float32Array(16385),H=new Float32Array(16385);for(let lt=0;lt<16385;lt+=1){const ct=lt/16384*x;st[lt]=Math.cos(ct),H[lt]=Math.sin(ct)}const Z=o(W,{...S,gain:0}),V=l(W,{...M,curve:st}),nt=l(W,{...M,curve:_}),X=o(W,{...S,gain:0}),et=l(W,{...M,curve:H});return{connectGraph(){z.connect(Z),z.connect(nt.inputs===void 0?nt:nt.inputs[0]),z.connect(X),nt.connect(F),F.connect(V.inputs===void 0?V:V.inputs[0]),F.connect(et.inputs===void 0?et:et.inputs[0]),V.connect(Z.gain),et.connect(X.gain),Z.connect(Q,0,0),X.connect(Q,0,1)},disconnectGraph(){z.disconnect(Z),z.disconnect(nt.inputs===void 0?nt:nt.inputs[0]),z.disconnect(X),nt.disconnect(F),F.disconnect(V.inputs===void 0?V:V.inputs[0]),F.disconnect(et.inputs===void 0?et:et.inputs[0]),V.disconnect(Z.gain),et.disconnect(X.gain),Z.disconnect(Q,0,0),X.disconnect(Q,0,1)}}})(D,$,B,L);if(N===2)return((W,z,F,Q)=>{const st=new Float32Array(16385),H=new Float32Array(16385),Z=new Float32Array(16385),V=new Float32Array(16385),nt=Math.floor(8192.5);for(let Lt=0;Lt<16385;Lt+=1)if(Lt>nt){const Vt=(Lt-nt)/(16384-nt)*x;st[Lt]=Math.cos(Vt),H[Lt]=Math.sin(Vt),Z[Lt]=0,V[Lt]=1}else{const Vt=Lt/(16384-nt)*x;st[Lt]=1,H[Lt]=0,Z[Lt]=Math.cos(Vt),V[Lt]=Math.sin(Vt)}const X=t(W,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),et=o(W,{...S,gain:0}),lt=l(W,{...M,curve:st}),ct=o(W,{...S,gain:0}),Mt=l(W,{...M,curve:H}),bt=l(W,{...M,curve:_}),vt=o(W,{...S,gain:0}),Pt=l(W,{...M,curve:Z}),gt=o(W,{...S,gain:0}),kt=l(W,{...M,curve:V});return{connectGraph(){z.connect(X),z.connect(bt.inputs===void 0?bt:bt.inputs[0]),X.connect(et,0),X.connect(ct,0),X.connect(vt,1),X.connect(gt,1),bt.connect(F),F.connect(lt.inputs===void 0?lt:lt.inputs[0]),F.connect(Mt.inputs===void 0?Mt:Mt.inputs[0]),F.connect(Pt.inputs===void 0?Pt:Pt.inputs[0]),F.connect(kt.inputs===void 0?kt:kt.inputs[0]),lt.connect(et.gain),Mt.connect(ct.gain),Pt.connect(vt.gain),kt.connect(gt.gain),et.connect(Q,0,0),vt.connect(Q,0,0),ct.connect(Q,0,1),gt.connect(Q,0,1)},disconnectGraph(){z.disconnect(X),z.disconnect(bt.inputs===void 0?bt:bt.inputs[0]),X.disconnect(et,0),X.disconnect(ct,0),X.disconnect(vt,1),X.disconnect(gt,1),bt.disconnect(F),F.disconnect(lt.inputs===void 0?lt:lt.inputs[0]),F.disconnect(Mt.inputs===void 0?Mt:Mt.inputs[0]),F.disconnect(Pt.inputs===void 0?Pt:Pt.inputs[0]),F.disconnect(kt.inputs===void 0?kt:kt.inputs[0]),lt.disconnect(et.gain),Mt.disconnect(ct.gain),Pt.disconnect(vt.gain),kt.disconnect(gt.gain),et.disconnect(Q,0,0),vt.disconnect(Q,0,0),ct.disconnect(Q,0,1),gt.disconnect(Q,0,1)}}})(D,$,B,L);throw d()};return(D,{channelCount:N,channelCountMode:$,pan:B,...L})=>{if($==="max")throw d();const W=p(D,{...L,channelCount:1,channelCountMode:$,numberOfInputs:2}),z=o(D,{...L,channelCount:N,channelCountMode:$,gain:1}),F=o(D,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:B});let{connectGraph:Q,disconnectGraph:st}=k(D,N,z,F,W);Object.defineProperty(F.gain,"defaultValue",{get:()=>0}),Object.defineProperty(F.gain,"maxValue",{get:()=>1}),Object.defineProperty(F.gain,"minValue",{get:()=>-1});const H={get bufferSize(){},get channelCount(){return z.channelCount},set channelCount(V){z.channelCount!==V&&(Z&&st(),{connectGraph:Q,disconnectGraph:st}=k(D,V,z,F,W),Z&&Q()),z.channelCount=V},get channelCountMode(){return z.channelCountMode},set channelCountMode(V){if(V==="clamped-max"||V==="max")throw d();z.channelCountMode=V},get channelInterpretation(){return z.channelInterpretation},set channelInterpretation(V){z.channelInterpretation=V},get context(){return z.context},get inputs(){return[z]},get numberOfInputs(){return z.numberOfInputs},get numberOfOutputs(){return z.numberOfOutputs},get pan(){return F.gain},addEventListener:(...V)=>z.addEventListener(V[0],V[1],V[2]),dispatchEvent:(...V)=>z.dispatchEvent(V[0]),removeEventListener:(...V)=>z.removeEventListener(V[0],V[1],V[2])};let Z=!1;return v(fi(H,W),()=>{Q(),Z=!0},()=>{st(),Z=!1})}})(An,mo,is,Lr,Qe,Tn),wu=((p,t)=>(o,l)=>{const d=l.channelCountMode;if(d==="clamped-max")throw t();if(o.createStereoPanner===void 0)return p(o,l);const v=o.createStereoPanner();return Te(v,l),fe(v,l,"pan"),Object.defineProperty(v,"channelCountMode",{get:()=>d,set:b=>{if(b!==d)throw t()}}),v})(Ef,Qe),Pf=((p,t,o,l,d)=>()=>{const v=new WeakMap;return{render(b,_){const x=v.get(_);return x!==void 0?Promise.resolve(x):(async(S,M)=>{let k=o(S);const D=ht(k,M);if(!D){const N={channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,pan:k.pan.value};k=t(M,N)}return v.set(M,k),D?await p(M,S.pan,k.pan):await l(M,S.pan,k.pan),De(k)?await d(S,M,k.inputs[0]):await d(S,M,k),k})(b,_)}}})(Us,wu,Jt,Xs,Oe),kf=((p,t,o,l,d,v)=>class extends p{constructor(b,_){const x=d(b),S={...Nm,..._},M=o(x,S),k=v(x);super(b,!1,M,k?l():null),this._pan=t(this,k,M.pan)}get pan(){return this._pan}})(ye,Ns,wu,Pf,se,Zt),If=((p,t,o)=>()=>{const l=new WeakMap;return{render(d,v){const b=l.get(v);return b!==void 0?Promise.resolve(b):(async(_,x)=>{let S=t(_);if(!ht(S,x)){const M={channelCount:S.channelCount,channelCountMode:S.channelCountMode,channelInterpretation:S.channelInterpretation,curve:S.curve,oversample:S.oversample};S=p(x,M)}return l.set(x,S),De(S)?await o(_,x,S.inputs[0]):await o(_,x,S),S})(d,v)}}})(Lr,Jt,Oe),Rf=((p,t,o,l,d,v,b)=>class extends p{constructor(_,x){const S=d(_),M={...Fm,...x},k=o(S,M);super(_,!0,k,v(S)?l():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=k,b(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(_){if(_===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(_.length<2)throw t();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=_}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(_){this._nativeWaveShaperNode.oversample=_}})(ye,ke,Lr,If,se,Zt,jn),_u=(p=>p!==null&&p.isSecureContext)(Os),ol=(p=>(t,o,l)=>{Object.defineProperties(p,{currentFrame:{configurable:!0,get:()=>Math.round(t*o)},currentTime:{configurable:!0,get:()=>t}});try{return l()}finally{p!==null&&(delete p.currentFrame,delete p.currentTime)}})(Os),xu=new WeakMap,Df=((p,t)=>o=>{let l=p.get(o);if(l!==void 0)return l;if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");return l=new t(1,1,44100),p.set(o,l),l})(xu,Ie),Of=_u?((p,t,o,l,d,v,b,_,x,S,M,k,D)=>{let N=0;return($,B,L={credentials:"omit"})=>{const W=M.get($);if(W!==void 0&&W.has(B))return Promise.resolve();const z=S.get($);if(z!==void 0){const st=z.get(B);if(st!==void 0)return st}const F=v($),Q=F.audioWorklet===void 0?d(B).then(([st,H])=>{const[Z,V]=U(st,H);return o(`${Z};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${V}
})})(window,'_AWGS')`)}).then(()=>{const st=D._AWGS.pop();if(st===void 0)throw new SyntaxError;l(F.currentTime,F.sampleRate,()=>st(class{},void 0,(H,Z)=>{if(H.trim()==="")throw t();const V=P.get(F);if(V!==void 0){if(V.has(H))throw t();Y(Z),j(Z.parameterDescriptors),V.set(H,Z)}else Y(Z),j(Z.parameterDescriptors),P.set(F,new Map([[H,Z]]))},F.sampleRate,void 0,void 0))}):Promise.all([d(B),Promise.resolve(p(k,k))]).then(([[st,H],Z])=>{const V=N+1;N=V;const[nt,X]=U(st,H),et=new Blob([`${nt};((AudioWorkletProcessor,registerProcessor)=>{${X}
})(${Z?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${Z?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${Z?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${V}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),lt=URL.createObjectURL(et);return F.audioWorklet.addModule(lt,L).then(()=>{if(_(F))return F;const ct=b(F);return ct.audioWorklet.addModule(lt,L).then(()=>ct)}).then(ct=>{if(x===null)throw new SyntaxError;try{new x(ct,`__sac${V}`)}catch{throw new SyntaxError}}).finally(()=>URL.revokeObjectURL(lt))});return z===void 0?S.set($,new Map([[B,Q]])):z.set(B,Q),Q.then(()=>{const st=M.get($);st===void 0?M.set($,new Set([B])):st.add(B)}).finally(()=>{const st=S.get($);st!==void 0&&st.delete(B)}),Q}})(Cs,Qe,(p=>t=>new Promise((o,l)=>{if(p===null)return void l(new SyntaxError);const d=p.document.head;if(d===null)l(new SyntaxError);else{const v=p.document.createElement("script"),b=new Blob([t],{type:"application/javascript"}),_=URL.createObjectURL(b),x=p.onerror,S=()=>{p.onerror=x,URL.revokeObjectURL(_)};p.onerror=(M,k,D,N,$)=>k===_||k===p.location.href&&D===1&&N===1?(S(),l($),!1):x!==null?x(M,k,D,N,$):void 0,v.onerror=()=>{S(),l(new SyntaxError)},v.onload=()=>{S(),o()},v.src=_,v.type="module",d.appendChild(v)}}))(Os),ol,async p=>{try{const t=await fetch(p);if(t.ok)return[await t.text(),t.url]}catch{}throw new DOMException("","AbortError")},se,Df,Zt,vi,new WeakMap,new WeakMap,((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const o=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new t(1,128,44100),d=URL.createObjectURL(o);let v=!1,b=!1;try{await l.audioWorklet.addModule(d);const _=new p(l,"a",{numberOfOutputs:0}),x=l.createOscillator();_.port.onmessage=()=>v=!0,_.onprocessorerror=()=>b=!0,x.connect(_),x.start(0),await l.startRendering(),await new Promise(S=>setTimeout(S))}catch{}finally{URL.revokeObjectURL(d)}return v&&!b})(vi,Ie),Os):void 0,Nf=((p,t)=>o=>p(o)||t(o))(Ka,Zt),Lf=((p,t,o,l,d,v,b,_,x,S,M)=>(k,D)=>{const N=b(k)?k:v(k);if(d.has(D)){const $=new DOMException("","DataCloneError");return Promise.reject($)}try{d.add(D)}catch{}return t(x,()=>x(N))?N.decodeAudioData(D).then($=>(Hh(D).catch(()=>{}),t(_,()=>_($))||M($),p.add($),$)):new Promise(($,B)=>{const L=async()=>{try{await Hh(D)}catch{}},W=z=>{B(z),L()};try{N.decodeAudioData(D,z=>{typeof z.copyFromChannel!="function"&&(S(z),pt(z)),p.add(z),L().then(()=>$(z))},z=>{W(z===null?new DOMException("","EncodingError"):z)})}catch(z){W(z)}})})(el,Cs,0,0,new WeakSet,se,Nf,ut,po,nl,il),Su=((p,t,o,l,d,v,b,_,x,S,M,k,D,N,$,B,L,W,z,F)=>class extends ${constructor(Q,st){super(Q,st),this._nativeContext=Q,this._audioWorklet=p===void 0?void 0:{addModule:(H,Z)=>p(this,H,Z)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new t(this)}createBiquadFilter(){return new d(this)}createBuffer(Q,st,H){return new o({length:st,numberOfChannels:Q,sampleRate:H})}createBufferSource(){return new l(this)}createChannelMerger(Q=6){return new v(this,{numberOfInputs:Q})}createChannelSplitter(Q=6){return new b(this,{numberOfOutputs:Q})}createConstantSource(){return new _(this)}createConvolver(){return new x(this)}createDelay(Q=1){return new M(this,{maxDelayTime:Q})}createDynamicsCompressor(){return new k(this)}createGain(){return new D(this)}createIIRFilter(Q,st){return new N(this,{feedback:st,feedforward:Q})}createOscillator(){return new B(this)}createPanner(){return new L(this)}createPeriodicWave(Q,st,H={disableNormalization:!1}){return new W(this,{...H,imag:st,real:Q})}createStereoPanner(){return new z(this)}createWaveShaper(){return new F(this)}decodeAudioData(Q,st,H){return S(this._nativeContext,Q).then(Z=>(typeof st=="function"&&st(Z),Z),Z=>{throw typeof H=="function"&&H(Z),Z})}})(Of,Gm,uu,Um,Zm,Km,ef,of,af,Lf,cf,uf,pf,vf,bf,_f,Tf,Mf,kf,Rf),Ff=((p,t,o,l)=>class extends p{constructor(d,v){const b=o(d),_=((x,S)=>x.createMediaElementSource(S.mediaElement))(b,v);if(l(b))throw TypeError();super(d,!0,_,null),this._nativeMediaElementAudioSourceNode=_}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(ye,0,se,Zt),Bf=((p,t,o,l)=>class extends p{constructor(d,v){const b=o(d);if(l(b))throw new TypeError;const _=((x,S)=>{const M=x.createMediaStreamDestination();return Te(M,S),M.numberOfOutputs===1&&Object.defineProperty(M,"numberOfOutputs",{get:()=>0}),M})(b,{...Pm,...v});super(d,!1,_,null),this._nativeMediaStreamAudioDestinationNode=_}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(ye,0,se,Zt),$f=((p,t,o,l)=>class extends p{constructor(d,v){const b=o(d),_=((x,{mediaStream:S})=>{const M=S.getAudioTracks();M.sort((N,$)=>N.id<$.id?-1:N.id>$.id?1:0);const k=M.slice(0,1),D=x.createMediaStreamSource(new MediaStream(k));return Object.defineProperty(D,"mediaStream",{value:S}),D})(b,v);if(l(b))throw new TypeError;super(d,!0,_,null),this._nativeMediaStreamAudioSourceNode=_}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(ye,0,se,Zt),qf=((p,t)=>(o,{mediaStreamTrack:l})=>{if(typeof o.createMediaStreamTrackSource=="function")return o.createMediaStreamTrackSource(l);const d=new MediaStream([l]),v=o.createMediaStreamSource(d);if(l.kind!=="audio")throw p();if(t(o))throw new TypeError;return v})(ke,Zt),zf=((p,t,o)=>class extends p{constructor(l,d){const v=o(l);super(l,!0,t(v,d),null)}})(ye,qf,se),Wf=((p,t,o,l,d,v,b,_,x)=>class extends p{constructor(S={}){if(x===null)throw new Error("Missing the native AudioContext constructor.");let M;try{M=new x(S)}catch(N){throw N.code===12&&N.message==="sampleRate is not in range"?o():N}if(M===null)throw l();if(!(N=>N===void 0||typeof N=="number"||typeof N=="string"&&(N==="balanced"||N==="interactive"||N==="playback"))(S.latencyHint))throw new TypeError(`The provided value '${S.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(S.sampleRate!==void 0&&M.sampleRate!==S.sampleRate)throw o();super(M,2);const{latencyHint:k}=S,{sampleRate:D}=M;if(this._baseLatency=typeof M.baseLatency=="number"?M.baseLatency:k==="balanced"?512/D:k==="interactive"||k===void 0?256/D:k==="playback"?1024/D:128*Math.max(2,Math.min(128,Math.round(k*D/128)))/D,this._nativeAudioContext=M,x.name==="webkitAudioContext"?(this._nativeGainNode=M.createGain(),this._nativeOscillatorNode=M.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(M.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,M.state==="running"){this._state="suspended";const N=()=>{this._state==="suspended"&&(this._state=null),M.removeEventListener("statechange",N)};M.addEventListener("statechange",N)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then(()=>{throw t()}):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then(()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),Ye(this)}))}createMediaElementSource(S){return new d(this,{mediaElement:S})}createMediaStreamDestination(){return new v(this)}createMediaStreamSource(S){return new b(this,{mediaStream:S})}createMediaStreamTrackSource(S){return new _(this,{mediaStreamTrack:S})}resume(){return this._state==="suspended"?new Promise((S,M)=>{const k=()=>{this._nativeAudioContext.removeEventListener("statechange",k),this._nativeAudioContext.state==="running"?S():this.resume().then(S,M)};this._nativeAudioContext.addEventListener("statechange",k)}):this._nativeAudioContext.resume().catch(S=>{throw S===void 0||S.code===15?t():S})}suspend(){return this._nativeAudioContext.suspend().catch(S=>{throw S===void 0?t():S})}})(Su,ke,Qe,Lm,Ff,Bf,$f,zf,Cn),rl=(p=>t=>{const o=p.get(t);if(o===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return o})(gu),Vf=(p=>(t,o)=>{p(t).add(o)})(rl),Cu=(p=>(t,o,l=0,d=0)=>{const v=t[l];if(v===void 0)throw p();return pi(o)?v.connect(o,0,d):v.connect(o,0)})(Ct),Hf=(p=>(t,o)=>{p(t).delete(o)})(rl),Tu=(p=>(t,o=void 0,l=void 0,d=0)=>o===void 0?t.forEach(v=>v.disconnect()):typeof o=="number"?Ir(p,t,o).disconnect():pi(o)?l===void 0?t.forEach(v=>v.disconnect(o)):d===void 0?Ir(p,t,l).disconnect(o,0):Ir(p,t,l).disconnect(o,0,d):l===void 0?t.forEach(v=>v.disconnect(o)):Ir(p,t,l).disconnect(o,0))(Ct),Au=new WeakMap,Gf=((p,t)=>o=>t(p,o))(Au,tt),jf=((p,t,o,l,d,v,b,_,x,S,M,k,D)=>(N,$,B,L)=>{if(L.numberOfInputs===0&&L.numberOfOutputs===0)throw x();const W=Array.isArray(L.outputChannelCount)?L.outputChannelCount:Array.from(L.outputChannelCount);if(W.some(at=>at<1))throw x();if(W.length!==L.numberOfOutputs)throw t();if(L.channelCountMode!=="explicit")throw x();const z=L.channelCount*L.numberOfInputs,F=W.reduce((at,Ht)=>at+Ht,0),Q=B.parameterDescriptors===void 0?0:B.parameterDescriptors.length;if(z+Q>6||F>6)throw x();const st=new MessageChannel,H=[],Z=[];for(let at=0;at<L.numberOfInputs;at+=1)H.push(b(N,{channelCount:L.channelCount,channelCountMode:L.channelCountMode,channelInterpretation:L.channelInterpretation,gain:1})),Z.push(d(N,{channelCount:L.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:L.channelCount}));const V=[];if(B.parameterDescriptors!==void 0)for(const{defaultValue:at,maxValue:Ht,minValue:ze,name:de}of B.parameterDescriptors){const zt=v(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:L.parameterData[de]!==void 0?L.parameterData[de]:at===void 0?0:at});Object.defineProperties(zt.offset,{defaultValue:{get:()=>at===void 0?0:at},maxValue:{get:()=>Ht===void 0?Bt:Ht},minValue:{get:()=>ze===void 0?jt:ze}}),V.push(zt)}const nt=l(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,z+Q)}),X=Uh($,N.sampleRate),et=_(N,X,z+Q,Math.max(1,F)),lt=d(N,{channelCount:Math.max(1,F),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,F)}),ct=[];for(let at=0;at<L.numberOfOutputs;at+=1)ct.push(l(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:W[at]}));for(let at=0;at<L.numberOfInputs;at+=1){H[at].connect(Z[at]);for(let Ht=0;Ht<L.channelCount;Ht+=1)Z[at].connect(nt,Ht,at*L.channelCount+Ht)}const Mt=new Er(B.parameterDescriptors===void 0?[]:B.parameterDescriptors.map(({name:at},Ht)=>{const ze=V[Ht];return ze.connect(nt,0,z+Ht),ze.start(0),[at,ze.offset]}));nt.connect(et);let bt=L.channelInterpretation,vt=null;const Pt=L.numberOfOutputs===0?[et]:ct,gt={get bufferSize(){return X},get channelCount(){return L.channelCount},set channelCount(at){throw o()},get channelCountMode(){return L.channelCountMode},set channelCountMode(at){throw o()},get channelInterpretation(){return bt},set channelInterpretation(at){for(const Ht of H)Ht.channelInterpretation=at;bt=at},get context(){return et.context},get inputs(){return H},get numberOfInputs(){return L.numberOfInputs},get numberOfOutputs(){return L.numberOfOutputs},get onprocessorerror(){return vt},set onprocessorerror(at){typeof vt=="function"&&gt.removeEventListener("processorerror",vt),vt=typeof at=="function"?at:null,typeof vt=="function"&&gt.addEventListener("processorerror",vt)},get parameters(){return Mt},get port(){return st.port2},addEventListener:(...at)=>et.addEventListener(at[0],at[1],at[2]),connect:p.bind(null,Pt),disconnect:S.bind(null,Pt),dispatchEvent:(...at)=>et.dispatchEvent(at[0]),removeEventListener:(...at)=>et.removeEventListener(at[0],at[1],at[2])},kt=new Map;var Lt,Vt;st.port1.addEventListener=(Lt=st.port1.addEventListener,(...at)=>{if(at[0]==="message"){const Ht=typeof at[1]=="function"?at[1]:typeof at[1]=="object"&&at[1]!==null&&typeof at[1].handleEvent=="function"?at[1].handleEvent:null;if(Ht!==null){const ze=kt.get(at[1]);ze!==void 0?at[1]=ze:(at[1]=de=>{M(N.currentTime,N.sampleRate,()=>Ht(de))},kt.set(Ht,at[1]))}}return Lt.call(st.port1,at[0],at[1],at[2])}),st.port1.removeEventListener=(Vt=st.port1.removeEventListener,(...at)=>{if(at[0]==="message"){const Ht=kt.get(at[1]);Ht!==void 0&&(kt.delete(at[1]),at[1]=Ht)}return Vt.call(st.port1,at[0],at[1],at[2])});let oe=null;Object.defineProperty(st.port1,"onmessage",{get:()=>oe,set:at=>{typeof oe=="function"&&st.port1.removeEventListener("message",oe),oe=typeof at=="function"?at:null,typeof oe=="function"&&(st.port1.addEventListener("message",oe),st.port1.start())}}),B.prototype.port=st.port1;let ve=null;((at,Ht,ze,de)=>{let zt=R.get(at);zt===void 0&&(zt=new WeakMap,R.set(at,zt));const re=(async(as,Qs)=>{const Js=await(vc=>new Promise((yc,Xg)=>{const{port1:ea,port2:bc}=new MessageChannel;ea.onmessage=({data:wc})=>{ea.close(),bc.close(),yc(wc)},ea.onmessageerror=({data:wc})=>{ea.close(),bc.close(),Xg(wc)},bc.postMessage(vc)}))(Qs);return new as(Js)})(ze,de);return zt.set(Ht,re),re})(N,gt,B,L).then(at=>ve=at);const Ot=kr(L.numberOfInputs,L.channelCount),mt=kr(L.numberOfOutputs,W),te=B.parameterDescriptors===void 0?[]:B.parameterDescriptors.reduce((at,{name:Ht})=>({...at,[Ht]:new Float32Array(128)}),{});let Yt=!0;const qe=()=>{L.numberOfOutputs>0&&et.disconnect(lt);for(let at=0,Ht=0;at<L.numberOfOutputs;at+=1){const ze=ct[at];for(let de=0;de<W[at];de+=1)lt.disconnect(ze,Ht+de,de);Ht+=W[at]}},Nn=new Map;et.onaudioprocess=({inputBuffer:at,outputBuffer:Ht})=>{if(ve!==null){const ze=k(gt);for(let de=0;de<X;de+=128){for(let zt=0;zt<L.numberOfInputs;zt+=1)for(let re=0;re<L.channelCount;re+=1)Gn(at,Ot[zt],re,re,de);B.parameterDescriptors!==void 0&&B.parameterDescriptors.forEach(({name:zt},re)=>{Gn(at,te,zt,z+re,de)});for(let zt=0;zt<L.numberOfInputs;zt+=1)for(let re=0;re<W[zt];re+=1)mt[zt][re].byteLength===0&&(mt[zt][re]=new Float32Array(128));try{const zt=Ot.map((as,Qs)=>{if(ze[Qs].size>0)return Nn.set(Qs,X/128),as;const Js=Nn.get(Qs);return Js===void 0?[]:(as.every(vc=>vc.every(yc=>yc===0))&&(Js===1?Nn.delete(Qs):Nn.set(Qs,Js-1)),as)});Yt=M(N.currentTime+de/N.sampleRate,N.sampleRate,()=>ve.process(zt,mt,te));for(let as=0,Qs=0;as<L.numberOfOutputs;as+=1){for(let Js=0;Js<W[as];Js+=1)mi(Ht,mt[as],Js,Qs+Js,de);Qs+=W[as]}}catch(zt){Yt=!1,gt.dispatchEvent(new ErrorEvent("processorerror",{colno:zt.colno,filename:zt.filename,lineno:zt.lineno,message:zt.message}))}if(!Yt){for(let zt=0;zt<L.numberOfInputs;zt+=1){H[zt].disconnect(Z[zt]);for(let re=0;re<L.channelCount;re+=1)Z[de].disconnect(nt,re,zt*L.channelCount+re)}if(B.parameterDescriptors!==void 0){const zt=B.parameterDescriptors.length;for(let re=0;re<zt;re+=1){const as=V[re];as.disconnect(nt,0,z+re),as.stop()}}nt.disconnect(et),et.onaudioprocess=null,fc?qe():ed();break}}}};let fc=!1;const gc=b(N,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),td=()=>et.connect(gc).connect(N.destination),ed=()=>{et.disconnect(gc),gc.disconnect()};return td(),D(gt,()=>{if(Yt){ed(),L.numberOfOutputs>0&&et.connect(lt);for(let at=0,Ht=0;at<L.numberOfOutputs;at+=1){const ze=ct[at];for(let de=0;de<W[at];de+=1)lt.connect(ze,Ht+de,de);Ht+=W[at]}}fc=!0},()=>{Yt&&(td(),qe()),fc=!1})})(Cu,Ct,ke,An,mo,bi,is,fo,Qe,Tu,ol,Gf,Tn),Uf=((p,t,o,l,d)=>(v,b,_,x,S,M)=>{if(_!==null)try{const N=new _(v,x,M),$=new Map;let B=null;if(Object.defineProperties(N,{channelCount:{get:()=>M.channelCount,set:()=>{throw p()}},channelCountMode:{get:()=>"explicit",set:()=>{throw p()}},onprocessorerror:{get:()=>B,set:L=>{typeof B=="function"&&N.removeEventListener("processorerror",B),B=typeof L=="function"?L:null,typeof B=="function"&&N.addEventListener("processorerror",B)}}}),N.addEventListener=(D=N.addEventListener,(...L)=>{if(L[0]==="processorerror"){const W=typeof L[1]=="function"?L[1]:typeof L[1]=="object"&&L[1]!==null&&typeof L[1].handleEvent=="function"?L[1].handleEvent:null;if(W!==null){const z=$.get(L[1]);z!==void 0?L[1]=z:(L[1]=F=>{F.type==="error"?(Object.defineProperties(F,{type:{value:"processorerror"}}),W(F)):W(new ErrorEvent(L[0],{...F}))},$.set(W,L[1]))}}return D.call(N,"error",L[1],L[2]),D.call(N,...L)}),N.removeEventListener=(k=N.removeEventListener,(...L)=>{if(L[0]==="processorerror"){const W=$.get(L[1]);W!==void 0&&($.delete(L[1]),L[1]=W)}return k.call(N,"error",L[1],L[2]),k.call(N,L[0],L[1],L[2])}),M.numberOfOutputs!==0){const L=o(v,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return N.connect(L).connect(v.destination),d(N,()=>L.disconnect(),()=>L.connect(v.destination))}return N}catch(N){throw N.code===11?l():N}var k,D;if(S===void 0)throw l();return(N=>{const{port1:$}=new MessageChannel;try{$.postMessage(N)}finally{$.close()}})(M),t(v,b,S,M)})(ke,jf,is,Qe,Tn),Xf=((p,t,o,l,d,v,b,_,x,S,M,k,D,N,$,B)=>(L,W,z)=>{const F=new WeakMap;let Q=null;return{render(st,H){_(H,st);const Z=F.get(H);return Z!==void 0?Promise.resolve(Z):(async(V,nt)=>{let X=M(V),et=null;const lt=ht(X,nt),ct=Array.isArray(W.outputChannelCount)?W.outputChannelCount:Array.from(W.outputChannelCount);if(k===null){const Mt=ct.reduce((gt,kt)=>gt+kt,0),bt=d(nt,{channelCount:Math.max(1,Mt),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,Mt)}),vt=[];for(let gt=0;gt<V.numberOfOutputs;gt+=1)vt.push(l(nt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:ct[gt]}));const Pt=b(nt,{channelCount:W.channelCount,channelCountMode:W.channelCountMode,channelInterpretation:W.channelInterpretation,gain:1});Pt.connect=t.bind(null,vt),Pt.disconnect=x.bind(null,vt),et=[bt,vt,Pt]}else lt||(X=new k(nt,L));if(F.set(nt,et===null?X:et[2]),et!==null){if(Q===null){if(z===void 0)throw new Error("Missing the processor constructor.");if(D===null)throw new Error("Missing the native OfflineAudioContext constructor.");const kt=V.channelCount*V.numberOfInputs,Lt=z.parameterDescriptors===void 0?0:z.parameterDescriptors.length,Vt=kt+Lt;Q=bm(V,Vt===0?null:await(async()=>{const ve=new D(Vt,128*Math.ceil(V.context.length/128),nt.sampleRate),rs=[],Ot=[];for(let Yt=0;Yt<W.numberOfInputs;Yt+=1)rs.push(b(ve,{channelCount:W.channelCount,channelCountMode:W.channelCountMode,channelInterpretation:W.channelInterpretation,gain:1})),Ot.push(d(ve,{channelCount:W.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:W.channelCount}));const mt=await Promise.all(Array.from(V.parameters.values()).map(async Yt=>{const qe=v(ve,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Yt.value});return await N(ve,Yt,qe.offset),qe})),te=l(ve,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,kt+Lt)});for(let Yt=0;Yt<W.numberOfInputs;Yt+=1){rs[Yt].connect(Ot[Yt]);for(let qe=0;qe<W.channelCount;qe+=1)Ot[Yt].connect(te,qe,Yt*W.channelCount+qe)}for(const[Yt,qe]of mt.entries())qe.connect(te,0,kt+Yt),qe.start(0);return te.connect(ve.destination),await Promise.all(rs.map(Yt=>$(V,ve,Yt))),B(ve)})(),nt,W,ct,z,S)}const Mt=await Q,bt=o(nt,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[vt,Pt,gt]=et;Mt!==null&&(bt.buffer=Mt,bt.start(0)),bt.connect(vt);for(let kt=0,Lt=0;kt<V.numberOfOutputs;kt+=1){const Vt=Pt[kt];for(let oe=0;oe<ct[kt];oe+=1)vt.connect(Vt,Lt+oe,oe);Lt+=ct[kt]}return gt}if(lt)for(const[Mt,bt]of V.parameters.entries())await p(nt,bt,X.parameters.get(Mt));else for(const[Mt,bt]of V.parameters.entries())await N(nt,bt,X.parameters.get(Mt));return await $(V,nt,X),X})(st,H)}}})(Us,Cu,yi,An,mo,bi,is,Hf,Tu,ol,Jt,vi,Ie,Xs,Oe,Nr),Yf=(p=>t=>p.get(t))(xu),Zf=(p=>(t,o)=>{p.set(t,o)})(Au),Mu=_u?((p,t,o,l,d,v,b,_,x,S,M,k,D,N)=>class extends t{constructor($,B,L){var W;const z=_($),F=x(z),Q=(et=>({...et,outputChannelCount:et.outputChannelCount!==void 0?et.outputChannelCount:et.numberOfInputs===1&&et.numberOfOutputs===1?[et.channelCount]:Array.from({length:et.numberOfOutputs},()=>1)}))({...Pr,...L});(et=>{const{port1:lt,port2:ct}=new MessageChannel;try{lt.postMessage(et)}finally{lt.close(),ct.close()}})(Q);const st=P.get(z),H=st==null?void 0:st.get(B),Z=F||z.state!=="closed"?z:(W=b(z))!==null&&W!==void 0?W:z,V=d(Z,F?null:$.baseLatency,S,B,H,Q);super($,!0,V,F?l(B,Q,H):null);const nt=[];V.parameters.forEach((et,lt)=>{const ct=o(this,F,et);nt.push([lt,ct])}),this._nativeAudioWorkletNode=V,this._onprocessorerror=null,this._parameters=new Er(nt),F&&p(z,this);const{activeInputs:X}=v(this);k(V,X)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror($){const B=typeof $=="function"?N(this,$):null;this._nativeAudioWorkletNode.onprocessorerror=B;const L=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=L!==null&&L===B?$:L}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(Vf,ye,Ns,Xf,Uf,$t,Yf,se,Zt,vi,0,Zf,0,gi):void 0,Qf=((p,t)=>(o,l,d)=>{if(t===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new t(o,l,d)}catch(v){throw v.name==="SyntaxError"?p():v}})(Qe,Ie),Jf=((p,t,o,l,d,v,b,_)=>(x,S)=>o(x).render(x,S).then(()=>Promise.all(Array.from(l(S)).map(M=>o(M).render(M,S)))).then(()=>d(S)).then(M=>(typeof M.copyFromChannel!="function"?(b(M),pt(M)):t(v,()=>v(M))||_(M),p.add(M),M)))(el,Cs,Ja,rl,Nr,ut,nl,il),Kf=((p,t,o,l,d)=>class extends p{constructor(v,b,_){let x;if(typeof v=="number"&&b!==void 0&&_!==void 0)x={length:b,numberOfChannels:v,sampleRate:_};else{if(typeof v!="object")throw new Error("The given parameters are not valid.");x=v}const{length:S,numberOfChannels:M,sampleRate:k}={...Im,...x},D=l(M,S,k);t(po,()=>po(D))||D.addEventListener("statechange",(()=>{let N=0;const $=B=>{this._state==="running"&&(N>0?(D.removeEventListener("statechange",$),B.stopImmediatePropagation(),this._waitForThePromiseToSettle(B)):N+=1)};return $})()),super(D,M),this._length=S,this._nativeOfflineAudioContext=D,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(o()):(this._state="running",d(this.destination,this._nativeOfflineAudioContext).finally(()=>{this._state=null,Ye(this)}))}_waitForThePromiseToSettle(v){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(v):setTimeout(()=>this._waitForThePromiseToSettle(v))}})(Su,Cs,ke,Qf,Jf),tg=((p,t)=>o=>{const l=p.get(o);return t(l)||t(o)})(I,Ka),eg=((p,t)=>o=>p.has(o)||t(o))(w,tl),sg=((p,t)=>o=>p.has(o)||t(o))(A,au),ng=((p,t)=>o=>{const l=p.get(o);return t(l)||t(o)})(I,Zt),ig=()=>(async(p,t,o,l,d,v,b,_,x,S,M,k,D,N,$,B)=>!!(p(t,t)&&p(o,o)&&p(d,d)&&p(v,v)&&p(_,_)&&p(x,x)&&p(S,S)&&p(M,M)&&p(k,k)&&p(D,D)&&p(N,N))&&(await Promise.all([p(l,l),p(b,b),p($,$),p(B,B)])).every(L=>L))(Cs,(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createBuffer(1,1,44100);if(t.copyToChannel===void 0)return!0;const o=new Float32Array(2);try{t.copyFromChannel(o,0,0)}catch{return!1}return!0})(Ie),(p=>()=>{if(p===null)return!1;if(p.prototype!==void 0&&p.prototype.close!==void 0)return!0;const t=new p,o=t.close!==void 0;try{t.close()}catch{}return o})(Cn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);return new Promise(o=>{let l=!0;const d=b=>{l&&(l=!1,t.startRendering(),o(b instanceof TypeError))};let v;try{v=t.decodeAudioData(null,()=>{},d)}catch(b){d(b)}v!==void 0&&v.catch(d)})})(Ie),(p=>()=>{if(p===null)return!1;let t;try{t=new p({latencyHint:"balanced"})}catch{return!1}return t.close(),!0})(Cn),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createGain(),o=t.connect(t)===t;return t.disconnect(t),o})(Ie),((p,t)=>async()=>{if(p===null)return!0;if(t===null)return!1;const o=new Blob(['let c,p;class A extends AudioWorkletProcessor{constructor(){super();this.port.onmessage=(e)=>{p=e.data;p.onmessage=()=>{p.postMessage(c);p.close()};this.port.postMessage(0)}}process(){c=1}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),l=new MessageChannel,d=new t(1,128,44100),v=URL.createObjectURL(o);let b=!1;try{await d.audioWorklet.addModule(v);const _=new p(d,"a",{numberOfOutputs:0}),x=d.createOscillator();await new Promise(S=>{_.port.onmessage=()=>S(),_.port.postMessage(l.port2,[l.port2])}),_.port.onmessage=()=>b=!0,x.connect(_),x.start(0),await d.startRendering(),b=await new Promise(S=>{l.port1.onmessage=({data:M})=>S(M===1),l.port1.postMessage(0)})}catch{}finally{l.port1.close(),URL.revokeObjectURL(v)}return b})(vi,Ie),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createChannelMerger();if(t.channelCountMode==="max")return!0;try{t.channelCount=2}catch{return!0}return!1})(Ie),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100);return t.createConstantSource===void 0||t.createConstantSource().offset.maxValue!==Number.POSITIVE_INFINITY})(Ie),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100),o=t.createConvolver();o.buffer=t.createBuffer(1,1,t.sampleRate);try{o.buffer=t.createBuffer(1,1,t.sampleRate)}catch{return!1}return!0})(Ie),(p=>()=>{if(p===null)return!1;const t=new p(1,1,44100).createConvolver();try{t.channelCount=1}catch{return!1}return!0})(Ie),Bm,(p=>()=>p!==null&&p.hasOwnProperty("isSecureContext"))(Os),(p=>()=>{if(p===null)return!1;const t=new p;try{return t.createMediaStreamSource(new MediaStream),!1}catch{return!0}finally{t.close()}})(Cn),(p=>()=>{if(p===null)return Promise.resolve(!1);const t=new p(1,1,44100);if(t.createStereoPanner===void 0||t.createConstantSource===void 0)return Promise.resolve(!0);const o=t.createConstantSource(),l=t.createStereoPanner();return o.channelCount=1,o.offset.value=1,l.channelCount=1,o.start(),o.connect(l).connect(t.destination),t.startRendering().then(d=>d.getChannelData(0)[0]!==1)})(Ie),$m);function os(p){return p===void 0}function It(p){return p!==void 0}function Eu(p){return typeof p=="function"}function hs(p){return typeof p=="number"}function hn(p){return Object.prototype.toString.call(p)==="[object Object]"&&p.constructor===Object}function al(p){return typeof p=="boolean"}function Ne(p){return Array.isArray(p)}function Ls(p){return typeof p=="string"}function yo(p){return Ls(p)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(p)}function _t(p,t){if(!p)throw new Error(t)}function Le(p,t,o=1/0){if(!(t<=p&&p<=o))throw new RangeError(`Value must be within [${t}, ${o}], got: ${p}`)}function ll(p){p.isOffline||p.state==="running"||wi('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let Pu=!1,ku=!1;function cl(p){Pu=p}function Iu(p){os(p)&&Pu&&!ku&&(ku=!0,wi("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let hl=console;function og(p){hl=p}function Ru(...p){hl.log(...p)}function wi(...p){hl.warn(...p)}const us=typeof self=="object"?self:null,rg=us&&(us.hasOwnProperty("AudioContext")||us.hasOwnProperty("webkitAudioContext"));function Fs(p,t,o,l){var d,v=arguments.length,b=v<3?t:l;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")b=Reflect.decorate(p,t,o,l);else for(var _=p.length-1;_>=0;_--)(d=p[_])&&(b=(v<3?d(b):v>3?d(t,o,b):d(t,o))||b);return v>3&&b&&Object.defineProperty(t,o,b),b}function Kt(p,t,o,l){return new(o||(o=Promise))(function(d,v){function b(S){try{x(l.next(S))}catch(M){v(M)}}function _(S){try{x(l.throw(S))}catch(M){v(M)}}function x(S){var M;S.done?d(S.value):(M=S.value,M instanceof o?M:new o(function(k){k(M)})).then(b,_)}x((l=l.apply(p,t||[])).next())})}typeof SuppressedError=="function"&&SuppressedError;class ag{constructor(t,o,l,d){this._callback=t,this._type=o,this._minimumUpdateInterval=Math.max(128/(d||44100),.001),this.updateInterval=l,this._createClock()}_createWorker(){const t=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),o=URL.createObjectURL(t),l=new Worker(o);l.onmessage=this._callback.bind(this),this._worker=l}_createTimeout(){this._timeout=setTimeout(()=>{this._createTimeout(),this._callback()},1e3*this._updateInterval)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(t){var o;this._updateInterval=Math.max(t,this._minimumUpdateInterval),this._type==="worker"&&((o=this._worker)===null||o===void 0||o.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(t){this._disposeClock(),this._type=t,this._createClock()}dispose(){this._disposeClock()}}function Un(p){return sg(p)}function Mn(p){return eg(p)}function Fr(p){return ng(p)}function _i(p){return tg(p)}function lg(p,t){return p==="value"||Un(t)||Mn(t)||function(o){return o instanceof uu}(t)}function Ts(p,...t){if(!t.length)return p;const o=t.shift();if(hn(p)&&hn(o))for(const l in o)lg(l,o[l])?p[l]=o[l]:hn(o[l])?(p[l]||Object.assign(p,{[l]:{}}),Ts(p[l],o[l])):Object.assign(p,{[l]:o[l]});return Ts(p,...t)}function K(p,t,o=[],l){const d={},v=Array.from(t);if(hn(v[0])&&l&&!Reflect.has(v[0],l)&&(Object.keys(v[0]).some(b=>Reflect.has(p,b))||(Ts(d,{[l]:v[0]}),o.splice(o.indexOf(l),1),v.shift())),v.length===1&&hn(v[0]))Ts(d,v[0]);else for(let b=0;b<o.length;b++)It(v[b])&&(d[o[b]]=v[b]);return Ts(p,d)}function As(p,t){return os(p)?t:p}function Fe(p,t){return t.forEach(o=>{Reflect.has(p,o)&&delete p[o]}),p}class un{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...t){(this.debug||us&&this.toString()===us.TONE_DEBUG_CLASS)&&Ru(this,...t)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}un.version=m;const ul=1e-6;function xi(p,t){return p>t+ul}function dl(p,t){return xi(p,t)||Bs(p,t)}function Br(p,t){return p+ul<t}function Bs(p,t){return Math.abs(p-t)<ul}function Xn(p,t,o){return Math.max(Math.min(p,o),t)}class ds extends un{constructor(){super(),this.name="Timeline",this._timeline=[];const t=K(ds.getDefaults(),arguments,["memory"]);this.memory=t.memory,this.increasing=t.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(t){if(_t(Reflect.has(t,"time"),"Timeline: events must have a time attribute"),t.time=t.time.valueOf(),this.increasing&&this.length){const o=this._timeline[this.length-1];_t(dl(t.time,o.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(t)}else{const o=this._search(t.time);this._timeline.splice(o+1,0,t)}if(this.length>this.memory){const o=this.length-this.memory;this._timeline.splice(0,o)}return this}remove(t){const o=this._timeline.indexOf(t);return o!==-1&&this._timeline.splice(o,1),this}get(t,o="time"){const l=this._search(t,o);return l!==-1?this._timeline[l]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(t,o="time"){const l=this._search(t,o);return l+1<this._timeline.length?this._timeline[l+1]:null}getBefore(t){const o=this._timeline.length;if(o>0&&this._timeline[o-1].time<t)return this._timeline[o-1];const l=this._search(t);return l-1>=0?this._timeline[l-1]:null}cancel(t){if(this._timeline.length>1){let o=this._search(t);if(o>=0)if(Bs(this._timeline[o].time,t)){for(let l=o;l>=0&&Bs(this._timeline[l].time,t);l--)o=l;this._timeline=this._timeline.slice(0,o)}else this._timeline=this._timeline.slice(0,o+1);else this._timeline=[]}else this._timeline.length===1&&dl(this._timeline[0].time,t)&&(this._timeline=[]);return this}cancelBefore(t){const o=this._search(t);return o>=0&&(this._timeline=this._timeline.slice(o+1)),this}previousEvent(t){const o=this._timeline.indexOf(t);return o>0?this._timeline[o-1]:null}_search(t,o="time"){if(this._timeline.length===0)return-1;let l=0;const d=this._timeline.length;let v=d;if(d>0&&this._timeline[d-1][o]<=t)return d-1;for(;l<v;){let b=Math.floor(l+(v-l)/2);const _=this._timeline[b],x=this._timeline[b+1];if(Bs(_[o],t)){for(let S=b;S<this._timeline.length&&Bs(this._timeline[S][o],t);S++)b=S;return b}if(Br(_[o],t)&&xi(x[o],t))return b;xi(_[o],t)?v=b:l=b+1}return-1}_iterate(t,o=0,l=this._timeline.length-1){this._timeline.slice(o,l+1).forEach(t)}forEach(t){return this._iterate(t),this}forEachBefore(t,o){const l=this._search(t);return l!==-1&&this._iterate(o,0,l),this}forEachAfter(t,o){const l=this._search(t);return this._iterate(o,l+1),this}forEachBetween(t,o,l){let d=this._search(t),v=this._search(o);return d!==-1&&v!==-1?(this._timeline[d].time!==t&&(d+=1),this._timeline[v].time===o&&(v-=1),this._iterate(l,d,v)):d===-1&&this._iterate(l,0,v),this}forEachFrom(t,o){let l=this._search(t);for(;l>=0&&this._timeline[l].time>=t;)l--;return this._iterate(o,l+1),this}forEachAtTime(t,o){const l=this._search(t);if(l!==-1&&Bs(this._timeline[l].time,t)){let d=l;for(let v=l;v>=0&&Bs(this._timeline[v].time,t);v--)d=v;this._iterate(v=>{o(v)},d,l)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const Du=[];function $r(p){Du.push(p)}const Ou=[];function qr(p){Ou.push(p)}class Si extends un{constructor(){super(...arguments),this.name="Emitter"}on(t,o){return t.split(/\W+/).forEach(l=>{os(this._events)&&(this._events={}),this._events.hasOwnProperty(l)||(this._events[l]=[]),this._events[l].push(o)}),this}once(t,o){const l=(...d)=>{o(...d),this.off(t,l)};return this.on(t,l),this}off(t,o){return t.split(/\W+/).forEach(l=>{if(os(this._events)&&(this._events={}),this._events.hasOwnProperty(l))if(os(o))this._events[l]=[];else{const d=this._events[l];for(let v=d.length-1;v>=0;v--)d[v]===o&&d.splice(v,1)}}),this}emit(t,...o){if(this._events&&this._events.hasOwnProperty(t)){const l=this._events[t].slice(0);for(let d=0,v=l.length;d<v;d++)l[d].apply(this,o)}return this}static mixin(t){["on","once","off","emit"].forEach(o=>{const l=Object.getOwnPropertyDescriptor(Si.prototype,o);Object.defineProperty(t.prototype,o,l)})}dispose(){return super.dispose(),this._events=void 0,this}}class pl extends Si{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class Ci extends pl{constructor(){var t,o;super(),this.name="Context",this._constants=new Map,this._timeouts=new ds,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const l=K(Ci.getDefaults(),arguments,["context"]);l.context?(this._context=l.context,this._latencyHint=((t=arguments[0])===null||t===void 0?void 0:t.latencyHint)||""):(this._context=function(d){return new Wf(d)}({latencyHint:l.latencyHint}),this._latencyHint=l.latencyHint),this._ticker=new ag(this.emit.bind(this,"tick"),l.clockSource,l.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((o=arguments[0])===null||o===void 0)&&o.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=l.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var t;return this._initialized||(t=this,Du.forEach(o=>o(t)),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(t,o,l){return this._context.createBuffer(t,o,l)}createChannelMerger(t){return this._context.createChannelMerger(t)}createChannelSplitter(t){return this._context.createChannelSplitter(t)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(t){return this._context.createDelay(t)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(t,o){return this._context.createIIRFilter(t,o)}createPanner(){return this._context.createPanner()}createPeriodicWave(t,o,l){return this._context.createPeriodicWave(t,o,l)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(t){return _t(_i(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(t)}createMediaElementSource(t){return _t(_i(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(t)}createMediaStreamDestination(){return _t(_i(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(t){return this._context.decodeAudioData(t)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(t){_t(!this._initialized,"The listener cannot be set after initialization."),this._listener=t}get transport(){return this.initialize(),this._transport}set transport(t){_t(!this._initialized,"The transport cannot be set after initialization."),this._transport=t}get draw(){return this.initialize(),this._draw}set draw(t){_t(!this._initialized,"Draw cannot be set after initialization."),this._draw=t}get destination(){return this.initialize(),this._destination}set destination(t){_t(!this._initialized,"The destination cannot be set after initialization."),this._destination=t}createAudioWorkletNode(t,o){return function(l,d,v){return _t(It(Mu),"AudioWorkletNode only works in a secure context (https or localhost)"),new(l instanceof(us==null?void 0:us.BaseAudioContext)?us==null?void 0:us.AudioWorkletNode:Mu)(l,d,v)}(this.rawContext,t,o)}addAudioWorkletModule(t){return Kt(this,void 0,void 0,function*(){_t(It(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(t)),yield this._workletPromise})}workletsAreReady(){return Kt(this,void 0,void 0,function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()})}get updateInterval(){return this._ticker.updateInterval}set updateInterval(t){this._ticker.updateInterval=t}get clockSource(){return this._ticker.type}set clockSource(t){this._ticker.type=t}get lookAhead(){return this._lookAhead}set lookAhead(t){this._lookAhead=t,this.updateInterval=t?t/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return _i(this._context)?this._context.resume():Promise.resolve()}close(){return Kt(this,void 0,void 0,function*(){var t;_i(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(t=this,Ou.forEach(o=>o(t)))})}getConstant(t){if(this._constants.has(t))return this._constants.get(t);{const o=this._context.createBuffer(1,128,this._context.sampleRate),l=o.getChannelData(0);for(let v=0;v<l.length;v++)l[v]=t;const d=this._context.createBufferSource();return d.channelCount=1,d.channelCountMode="explicit",d.buffer=o,d.loop=!0,d.start(0),this._constants.set(t,d),d}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map(t=>this._constants[t].disconnect()),this.close(),this}_timeoutLoop(){const t=this.now();let o=this._timeouts.peek();for(;this._timeouts.length&&o&&o.time<=t;)o.callback(),this._timeouts.shift(),o=this._timeouts.peek()}setTimeout(t,o){this._timeoutIds++;const l=this.now();return this._timeouts.add({callback:t,id:this._timeoutIds,time:l+o}),this._timeoutIds}clearTimeout(t){return this._timeouts.forEach(o=>{o.id===t&&this._timeouts.remove(o)}),this}clearInterval(t){return this.clearTimeout(t)}setInterval(t,o){const l=++this._timeoutIds,d=()=>{const v=this.now();this._timeouts.add({callback:()=>{t(),d()},id:l,time:v+o})};return d(),l}}function St(p,t){Ne(t)?t.forEach(o=>St(p,o)):Object.defineProperty(p,t,{enumerable:!0,writable:!1})}function bo(p,t){Ne(t)?t.forEach(o=>bo(p,o)):Object.defineProperty(p,t,{writable:!0})}const Dt=()=>{};class qt extends un{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Dt;const t=K(qt.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=t.reverse,this.onload=t.onload,Ls(t.url)?this.load(t.url).catch(t.onerror):t.url&&this.set(t.url)}static getDefaults(){return{onerror:Dt,onload:Dt,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:ie().sampleRate}set(t){return t instanceof qt?t.loaded?this._buffer=t.get():t.onload=()=>{this.set(t),this.onload(this)}:this._buffer=t,this._reversed&&this._reverse(),this}get(){return this._buffer}load(t){return Kt(this,void 0,void 0,function*(){const o=qt.load(t).then(l=>{this.set(l),this.onload(this)});qt.downloads.push(o);try{yield o}finally{const l=qt.downloads.indexOf(o);qt.downloads.splice(l,1)}return this})}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(t){const o=Ne(t)&&t[0].length>0,l=o?t.length:1,d=o?t[0].length:t.length,v=ie(),b=v.createBuffer(l,d,v.sampleRate),_=o||l!==1?t:[t];for(let x=0;x<l;x++)b.copyToChannel(_[x],x);return this._buffer=b,this}toMono(t){if(hs(t))this.fromArray(this.toArray(t));else{let o=new Float32Array(this.length);const l=this.numberOfChannels;for(let d=0;d<l;d++){const v=this.toArray(d);for(let b=0;b<v.length;b++)o[b]+=v[b]}o=o.map(d=>d/l),this.fromArray(o)}return this}toArray(t){if(hs(t))return this.getChannelData(t);if(this.numberOfChannels===1)return this.toArray(0);{const o=[];for(let l=0;l<this.numberOfChannels;l++)o[l]=this.getChannelData(l);return o}}getChannelData(t){return this._buffer?this._buffer.getChannelData(t):new Float32Array(0)}slice(t,o=this.duration){_t(this.loaded,"Buffer is not loaded");const l=Math.floor(t*this.sampleRate),d=Math.floor(o*this.sampleRate);_t(l<d,"The start time must be less than the end time");const v=d-l,b=ie().createBuffer(this.numberOfChannels,v,this.sampleRate);for(let _=0;_<this.numberOfChannels;_++)b.copyToChannel(this.getChannelData(_).subarray(l,d),_);return new qt(b)}_reverse(){if(this.loaded)for(let t=0;t<this.numberOfChannels;t++)this.getChannelData(t).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(t){this._reversed!==t&&(this._reversed=t,this._reverse())}static fromArray(t){return new qt().fromArray(t)}static fromUrl(t){return Kt(this,void 0,void 0,function*(){return yield new qt().load(t)})}static load(t){return Kt(this,void 0,void 0,function*(){const o=t.match(/\[([^\]\[]+\|.+)\]$/);if(o){const _=o[1].split("|");let x=_[0];for(const S of _)if(qt.supportsType(S)){x=S;break}t=t.replace(o[0],x)}const l=qt.baseUrl===""||qt.baseUrl.endsWith("/")?qt.baseUrl:qt.baseUrl+"/",d=document.createElement("a");d.href=l+t,d.pathname=(d.pathname+d.hash).split("/").map(encodeURIComponent).join("/");const v=yield fetch(d.href);if(!v.ok)throw new Error(`could not load url: ${t}`);const b=yield v.arrayBuffer();return yield ie().decodeAudioData(b)})}static supportsType(t){const o=t.split("."),l=o[o.length-1];return document.createElement("audio").canPlayType("audio/"+l)!==""}static loaded(){return Kt(this,void 0,void 0,function*(){for(yield Promise.resolve();qt.downloads.length;)yield qt.downloads[0]})}}qt.baseUrl="",qt.downloads=[];class Ti extends Ci{constructor(){var t,o,l;super({clockSource:"offline",context:Fr(arguments[0])?arguments[0]:(t=arguments[0],o=arguments[1]*arguments[2],l=arguments[2],new Kf(t,o,l)),lookAhead:0,updateInterval:Fr(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Fr(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(t){return Kt(this,void 0,void 0,function*(){let o=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,o++;const l=Math.floor(this.sampleRate/128);t&&o%l==0&&(yield new Promise(d=>setTimeout(d,1)))}})}render(){return Kt(this,arguments,void 0,function*(t=!0){yield this.workletsAreReady(),yield this._renderClock(t);const o=yield this._context.startRendering();return new qt(o)})}close(){return Promise.resolve()}}const Nu=new class extends pl{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(p,t,o){return{}}createChannelMerger(p){return{}}createChannelSplitter(p){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(p){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(p,t){return{}}createPanner(){return{}}createPeriodicWave(p,t,o){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(p){return{}}createMediaElementSource(p){return{}}createMediaStreamDestination(){return{}}decodeAudioData(p){return Promise.resolve({})}createAudioWorkletNode(p,t){return{}}get rawContext(){return{}}addAudioWorkletModule(p){return Kt(this,void 0,void 0,function*(){return Promise.resolve()})}resume(){return Promise.resolve()}setTimeout(p,t){return 0}clearTimeout(p){return this}setInterval(p,t){return 0}clearInterval(p){return this}getConstant(p){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(p){}get destination(){return{}}set destination(p){}now(){return 0}immediate(){return 0}};let wo=Nu;function ie(){return wo===Nu&&rg&&zr(new Ci),wo}function zr(p,t=!1){t&&wo.dispose(),wo=_i(p)?new Ci(p):Fr(p)?new Ti(p):p}function cg(){return wo.resume()}if(us&&!us.TONE_SILENCE_LOGGING){const t=` * Tone.js v${m} * `;console.log(`%c${t}`,"background: #000; color: #fff")}function Ai(p){return Math.pow(10,p/20)}function _o(p){return Math.log(p)/Math.LN10*20}function Mi(p){return Math.pow(2,p/12)}let Wr=440;function En(p){return Math.round(Lu(p))}function Lu(p){return 69+12*Math.log2(p/Wr)}function ml(p){return Wr*Math.pow(2,(p-69)/12)}class fl extends un{constructor(t,o,l){super(),this.defaultUnits="s",this._val=o,this._units=l,this.context=t,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:t=>this._frequencyToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:t=>this._ticksToUnits(parseInt(t,10)),regexp:/^(\d+)i$/i},m:{method:t=>this._beatsToUnits(parseInt(t,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(t,o)=>{const l=parseInt(t,10),d=o==="."?1.5:1;return l===1?this._beatsToUnits(this._getTimeSignature())*d:this._beatsToUnits(4/l)*d},regexp:/^(\d+)n(\.?)$/i},number:{method:t=>this._expressions[this.defaultUnits].method.call(this,t),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:t=>this._secondsToUnits(parseFloat(t)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:t=>parseInt(t,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:t=>{const o=parseInt(t,10);return this._beatsToUnits(8/(3*Math.floor(o)))},regexp:/^(\d+)t$/i},tr:{method:(t,o,l)=>{let d=0;return t&&t!=="0"&&(d+=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),o&&o!=="0"&&(d+=this._beatsToUnits(parseFloat(o))),l&&l!=="0"&&(d+=this._beatsToUnits(parseFloat(l)/4)),d},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof fl&&this.fromType(this._val),os(this._val))return this._noArg();if(Ls(this._val)&&os(this._units)){for(const t in this._expressions)if(this._expressions[t].regexp.test(this._val.trim())){this._units=t;break}}else if(hn(this._val)){let t=0;for(const o in this._val)if(It(this._val[o])){const l=this._val[o];t+=new this.constructor(this.context,o).valueOf()*l}return t}if(It(this._units)){const t=this._expressions[this._units],o=this._val.toString().trim().match(t.regexp);return o?t.method.apply(this,o.slice(1)):t.method.call(this,this._val)}return Ls(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(t){return 1/t}_beatsToUnits(t){return 60/this._getBpm()*t}_secondsToUnits(t){return t}_ticksToUnits(t){return t*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(t){switch(this._units=void 0,this.defaultUnits){case"s":this._val=t.toSeconds();break;case"i":this._val=t.toTicks();break;case"hz":this._val=t.toFrequency();break;case"midi":this._val=t.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class ps extends fl{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:t=>this._now()+new this.constructor(this.context,t).valueOf(),regexp:/^\+(.+)/},quantize:{method:t=>{const o=new ps(this.context,t).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(o))},regexp:/^@(.+)/}})}quantize(t,o=1){const l=new this.constructor(this.context,t).valueOf(),d=this.valueOf();return d+(Math.round(d/l)*l-d)*o}toNotation(){const t=this.toSeconds(),o=["1m"];for(let v=1;v<9;v++){const b=Math.pow(2,v);o.push(b+"n."),o.push(b+"n"),o.push(b+"t")}o.push("0");let l=o[0],d=new ps(this.context,o[0]).toSeconds();return o.forEach(v=>{const b=new ps(this.context,v).toSeconds();Math.abs(b-t)<Math.abs(d-t)&&(l=v,d=b)}),l}toBarsBeatsSixteenths(){const t=this._beatsToUnits(1);let o=this.valueOf()/t;o=parseFloat(o.toFixed(4));const l=Math.floor(o/this._getTimeSignature());let d=o%1*4;o=Math.floor(o)%this._getTimeSignature();const v=d.toString();return v.length>3&&(d=parseFloat(parseFloat(v).toFixed(3))),[l,o,d].join(":")}toTicks(){const t=this._beatsToUnits(1);return this.valueOf()/t*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return En(this.toFrequency())}_now(){return this.context.now()}}function hg(p,t){return new ps(ie(),p,t)}class Je extends ps{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Wr}static set A4(t){(function(o){Wr=o})(t)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(t){return this.defaultUnits==="midi"?t:Je.mtof(t)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(t,o){const l=ug[t.toLowerCase()]+12*(parseInt(o,10)+1);return this.defaultUnits==="midi"?l:Je.mtof(l)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(t,o,l){let d=1;return t&&t!=="0"&&(d*=this._beatsToUnits(this._getTimeSignature()*parseFloat(t))),o&&o!=="0"&&(d*=this._beatsToUnits(parseFloat(o))),l&&l!=="0"&&(d*=this._beatsToUnits(parseFloat(l)/4)),d}}})}transpose(t){return new Je(this.context,this.valueOf()*Mi(t))}harmonize(t){return t.map(o=>this.transpose(o))}toMidi(){return En(this.valueOf())}toNote(){const t=this.toFrequency(),o=Math.log2(t/Je.A4);let l=Math.round(12*o)+57;const d=Math.floor(l/12);return d<0&&(l+=-12*d),dg[l%12]+d.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const t=this._beatsToUnits(1),o=this.valueOf()/t;return Math.floor(o*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(t){return t}_ticksToUnits(t){return 1/(60*t/(this._getBpm()*this._getPPQ()))}_beatsToUnits(t){return 1/super._beatsToUnits(t)}_secondsToUnits(t){return 1/t}static mtof(t){return ml(t)}static ftom(t){return En(t)}}const ug={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},dg=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function pg(p,t){return new Je(ie(),p,t)}class xe extends ps{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}function mg(p,t){return new xe(ie(),p,t)}class Re extends un{constructor(){super();const t=K(Re.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=t.context}static getDefaults(){return{context:ie()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(t){return Iu(t),new ps(this.context,t).toSeconds()}toFrequency(t){return new Je(this.context,t).toFrequency()}toTicks(t){return new xe(this.context,t).toTicks()}_getPartialProperties(t){const o=this.get();return Object.keys(o).forEach(l=>{os(t[l])&&delete o[l]}),o}get(){const t=this.constructor.getDefaults();return Object.keys(t).forEach(o=>{if(Reflect.has(this,o)){const l=this[o];It(l)&&It(l.value)&&It(l.setValueAtTime)?t[o]=l.value:l instanceof Re?t[o]=l._getPartialProperties(t[o]):Ne(l)||hs(l)||Ls(l)||al(l)?t[o]=l:delete t[o]}}),t}set(t){return Object.keys(t).forEach(o=>{Reflect.has(this,o)&&It(this[o])&&(this[o]&&It(this[o].value)&&It(this[o].setValueAtTime)?this[o].value!==t[o]&&(this[o].value=t[o]):this[o]instanceof Re?this[o].set(t[o]):this[o]=t[o])}),this}}class Ei extends ds{constructor(t="stopped"){super(),this.name="StateTimeline",this._initial=t,this.setStateAtTime(this._initial,0)}getValueAtTime(t){const o=this.get(t);return o!==null?o.state:this._initial}setStateAtTime(t,o,l){return Le(o,0),this.add(Object.assign({},l,{state:t,time:o})),this}getLastState(t,o){for(let l=this._search(o);l>=0;l--){const d=this._timeline[l];if(d.state===t)return d}}getNextState(t,o){const l=this._search(o);if(l!==-1)for(let d=l;d<this._timeline.length;d++){const v=this._timeline[d];if(v.state===t)return v}}}class Et extends Re{constructor(){const t=K(Et.getDefaults(),arguments,["param","units","convert"]);for(super(t),this.name="Param",this.overridden=!1,this._minOutput=1e-7,_t(It(t.param)&&(Un(t.param)||t.param instanceof Et),"param must be an AudioParam");!Un(t.param);)t.param=t.param._param;this._swappable=!!It(t.swappable)&&t.swappable,this._swappable?(this.input=this.context.createGain(),this._param=t.param,this.input.connect(this._param)):this._param=this.input=t.param,this._events=new ds(1e3),this._initialValue=this._param.defaultValue,this.units=t.units,this.convert=t.convert,this._minValue=t.minValue,this._maxValue=t.maxValue,It(t.value)&&t.value!==this._toType(this._initialValue)&&this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Re.getDefaults(),{convert:!0,units:"number"})}get value(){const t=this.now();return this.getValueAtTime(t)}set value(t){this.cancelScheduledValues(this.now()),this.setValueAtTime(t,this.now())}get minValue(){return It(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return It(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(t,o){return this.units===o}_assertRange(t){return It(this.maxValue)&&It(this.minValue)&&Le(t,this._fromType(this.minValue),this._fromType(this.maxValue)),t}_fromType(t){return this.convert&&!this.overridden?this._is(t,"time")?this.toSeconds(t):this._is(t,"decibels")?Ai(t):this._is(t,"frequency")?this.toFrequency(t):t:this.overridden?0:t}_toType(t){return this.convert&&this.units==="decibels"?_o(t):t}setValueAtTime(t,o){const l=this.toSeconds(o),d=this._fromType(t);return _t(isFinite(d)&&isFinite(l),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._assertRange(d),this.log(this.units,"setValueAtTime",t,l),this._events.add({time:l,type:"setValueAtTime",value:d}),this._param.setValueAtTime(d,l),this}getValueAtTime(t){const o=Math.max(this.toSeconds(t),0),l=this._events.getAfter(o),d=this._events.get(o);let v=this._initialValue;if(d===null)v=this._initialValue;else if(d.type!=="setTargetAtTime"||l!==null&&l.type!=="setValueAtTime")if(l===null)v=d.value;else if(l.type==="linearRampToValueAtTime"||l.type==="exponentialRampToValueAtTime"){let b=d.value;if(d.type==="setTargetAtTime"){const _=this._events.getBefore(d.time);b=_===null?this._initialValue:_.value}v=l.type==="linearRampToValueAtTime"?this._linearInterpolate(d.time,b,l.time,l.value,o):this._exponentialInterpolate(d.time,b,l.time,l.value,o)}else v=d.value;else{const b=this._events.getBefore(d.time);let _;_=b===null?this._initialValue:b.value,d.type==="setTargetAtTime"&&(v=this._exponentialApproach(d.time,_,d.value,d.constant,o))}return this._toType(v)}setRampPoint(t){t=this.toSeconds(t);let o=this.getValueAtTime(t);return this.cancelAndHoldAtTime(t),this._fromType(o)===0&&(o=this._toType(this._minOutput)),this.setValueAtTime(o,t),this}linearRampToValueAtTime(t,o){const l=this._fromType(t),d=this.toSeconds(o);return _t(isFinite(l)&&isFinite(d),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._assertRange(l),this._events.add({time:d,type:"linearRampToValueAtTime",value:l}),this.log(this.units,"linearRampToValueAtTime",t,d),this._param.linearRampToValueAtTime(l,d),this}exponentialRampToValueAtTime(t,o){let l=this._fromType(t);l=Bs(l,0)?this._minOutput:l,this._assertRange(l);const d=this.toSeconds(o);return _t(isFinite(l)&&isFinite(d),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._events.add({time:d,type:"exponentialRampToValueAtTime",value:l}),this.log(this.units,"exponentialRampToValueAtTime",t,d),this._param.exponentialRampToValueAtTime(l,d),this}exponentialRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialRampToValueAtTime(t,l+this.toSeconds(o)),this}linearRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.linearRampToValueAtTime(t,l+this.toSeconds(o)),this}targetRampTo(t,o,l){return l=this.toSeconds(l),this.setRampPoint(l),this.exponentialApproachValueAtTime(t,l,o),this}exponentialApproachValueAtTime(t,o,l){o=this.toSeconds(o),l=this.toSeconds(l);const d=Math.log(l+1)/Math.log(200);return this.setTargetAtTime(t,o,d),this.cancelAndHoldAtTime(o+.9*l),this.linearRampToValueAtTime(t,o+l),this}setTargetAtTime(t,o,l){const d=this._fromType(t);_t(isFinite(l)&&l>0,"timeConstant must be a number greater than 0");const v=this.toSeconds(o);return this._assertRange(d),_t(isFinite(d)&&isFinite(v),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(t)}, ${JSON.stringify(o)}`),this._events.add({constant:l,time:v,type:"setTargetAtTime",value:d}),this.log(this.units,"setTargetAtTime",t,v,l),this._param.setTargetAtTime(d,v,l),this}setValueCurveAtTime(t,o,l,d=1){l=this.toSeconds(l),o=this.toSeconds(o);const v=this._fromType(t[0])*d;this.setValueAtTime(this._toType(v),o);const b=l/(t.length-1);for(let _=1;_<t.length;_++){const x=this._fromType(t[_])*d;this.linearRampToValueAtTime(this._toType(x),o+_*b)}return this}cancelScheduledValues(t){const o=this.toSeconds(t);return _t(isFinite(o),`Invalid argument to cancelScheduledValues: ${JSON.stringify(t)}`),this._events.cancel(o),this._param.cancelScheduledValues(o),this.log(this.units,"cancelScheduledValues",o),this}cancelAndHoldAtTime(t){const o=this.toSeconds(t),l=this._fromType(this.getValueAtTime(o));_t(isFinite(o),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(t)}`),this.log(this.units,"cancelAndHoldAtTime",o,"value="+l);const d=this._events.get(o),v=this._events.getAfter(o);return d&&Bs(d.time,o)?v?(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time)):(this._param.cancelAndHoldAtTime(o),this._events.cancel(o+this.sampleTime)):v&&(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time),v.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(l),o):v.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(l),o)),this._events.add({time:o,type:"setValueAtTime",value:l}),this._param.setValueAtTime(l,o),this}rampTo(t,o=.1,l){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(t,o,l):this.linearRampTo(t,o,l),this}apply(t){const o=this.context.currentTime;t.setValueAtTime(this.getValueAtTime(o),o);const l=this._events.get(o);if(l&&l.type==="setTargetAtTime"){const d=this._events.getAfter(l.time),v=d?d.time:o+2,b=(v-o)/10;for(let _=o;_<v;_+=b)t.linearRampToValueAtTime(this.getValueAtTime(_),_)}return this._events.forEachAfter(this.context.currentTime,d=>{d.type==="cancelScheduledValues"?t.cancelScheduledValues(d.time):d.type==="setTargetAtTime"?t.setTargetAtTime(d.value,d.time,d.constant):t[d.type](d.value,d.time)}),this}setParam(t){_t(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const o=this.input;return o.disconnect(this._param),this.apply(t),this._param=t,o.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(t,o,l,d,v){return l+(o-l)*Math.exp(-(v-t)/d)}_linearInterpolate(t,o,l,d,v){return o+(v-t)/(l-t)*(d-o)}_exponentialInterpolate(t,o,l,d,v){return o*Math.pow(d/o,(v-t)/(l-t))}}class rt extends Re{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return It(this.input)?Un(this.input)||this.input instanceof Et?1:this.input.numberOfInputs:0}get numberOfOutputs(){return It(this.output)?this.output.numberOfOutputs:0}_isAudioNode(t){return It(t)&&(t instanceof rt||Mn(t))}_getInternalNodes(){const t=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&t.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&t.push(this.output),t}_setChannelProperties(t){this._getInternalNodes().forEach(o=>{o.channelCount=t.channelCount,o.channelCountMode=t.channelCountMode,o.channelInterpretation=t.channelInterpretation})}_getChannelProperties(){const t=this._getInternalNodes();_t(t.length>0,"ToneAudioNode does not have any internal nodes");const o=t[0];return{channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCount:t}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCountMode:t}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(t){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelInterpretation:t}))}connect(t,o=0,l=0){return Ke(this,t,o,l),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return wi("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(t,o=0,l=0){return gl(this,t,o,l),this}chain(...t){return ms(this,...t),this}fan(...t){return t.forEach(o=>this.connect(o)),this}dispose(){return super.dispose(),It(this.input)&&(this.input instanceof rt?this.input.dispose():Mn(this.input)&&this.input.disconnect()),It(this.output)&&(this.output instanceof rt?this.output.dispose():Mn(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function ms(...p){const t=p.shift();p.reduce((o,l)=>(o instanceof rt?o.connect(l):Mn(o)&&Ke(o,l),l),t)}function Ke(p,t,o=0,l=0){for(_t(It(p),"Cannot connect from undefined node"),_t(It(t),"Cannot connect to undefined node"),(t instanceof rt||Mn(t))&&_t(t.numberOfInputs>0,"Cannot connect to node with no inputs"),_t(p.numberOfOutputs>0,"Cannot connect from node with no outputs");t instanceof rt||t instanceof Et;)It(t.input)&&(t=t.input);for(;p instanceof rt;)It(p.output)&&(p=p.output);Un(t)?p.connect(t,o):p.connect(t,o,l)}function gl(p,t,o=0,l=0){if(It(t))for(;t instanceof rt;)t=t.input;for(;!Mn(p);)It(p.output)&&(p=p.output);Un(t)?p.disconnect(t,o):Mn(t)?p.disconnect(t,o,l):p.disconnect()}function fg(...p){const t=p.pop();It(t)&&p.forEach(o=>Ke(o,t))}class wt extends rt{constructor(){const t=K(wt.getDefaults(),arguments,["gain","units"]);super(t),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Et({context:this.context,convert:t.convert,param:this._gainNode.gain,units:t.units,value:t.gain,minValue:t.minValue,maxValue:t.maxValue}),St(this,"gain")}static getDefaults(){return Object.assign(rt.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class Pi extends rt{constructor(t){super(t),this.onended=Dt,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new wt({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(o){const l=this.toSeconds(o);return this._startTime!==-1&&l>=this._startTime&&(this._stopTime===-1||l<=this._stopTime)?"started":"stopped"},this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut,this._curve=t.curve,this.onended=t.onended}static getDefaults(){return Object.assign(rt.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Dt})}_startGain(t,o=1){_t(this._startTime===-1,"Source cannot be started more than once");const l=this.toSeconds(this._fadeIn);return this._startTime=t+l,this._startTime=Math.max(this._startTime,this.context.currentTime),l>0?(this._gainNode.gain.setValueAtTime(0,t),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(o,t+l):this._gainNode.gain.exponentialApproachValueAtTime(o,t,l)):this._gainNode.gain.setValueAtTime(o,t),this}stop(t){return this.log("stop",t),this._stopGain(this.toSeconds(t)),this}_stopGain(t){_t(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const o=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(t)+o,this._stopTime=Math.max(this._stopTime,this.now()),o>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,o,t):this._gainNode.gain.targetRampTo(0,o,t):(this._gainNode.gain.cancelAndHoldAtTime(t),this._gainNode.gain.setValueAtTime(0,t)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout(()=>{const l=this._curve==="exponential"?2*o:0;this._stopSource(this.now()+l),this._onended()},this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Dt&&(this.onended(this),this.onended=Dt,!this.context.isOffline)){const t=()=>this.dispose();window.requestIdleCallback!==void 0?window.requestIdleCallback(t):setTimeout(t,1e3)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),_t(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Dt,this}}class Vr extends Pi{constructor(){const t=K(Vr.getDefaults(),arguments,["offset"]);super(t),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Ke(this._source,this._gainNode),this.offset=new Et({context:this.context,convert:t.convert,param:this._source.offset,units:t.units,value:t.offset,minValue:t.minValue,maxValue:t.maxValue})}static getDefaults(){return Object.assign(Pi.getDefaults(),{convert:!0,offset:1,units:"number"})}start(t){const o=this.toSeconds(t);return this.log("start",o),this._startGain(o),this._source.start(o),this}_stopSource(t){this._source.stop(t)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class At extends rt{constructor(){const t=K(At.getDefaults(),arguments,["value","units"]);super(t),this.name="Signal",this.override=!0,this.output=this._constantSource=new Vr({context:this.context,convert:t.convert,offset:t.value,units:t.units,minValue:t.minValue,maxValue:t.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(rt.getDefaults(),{convert:!0,units:"number",value:0})}connect(t,o=0,l=0){return xo(this,t,o,l),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(t,o){return this._param.setValueAtTime(t,o),this}getValueAtTime(t){return this._param.getValueAtTime(t)}setRampPoint(t){return this._param.setRampPoint(t),this}linearRampToValueAtTime(t,o){return this._param.linearRampToValueAtTime(t,o),this}exponentialRampToValueAtTime(t,o){return this._param.exponentialRampToValueAtTime(t,o),this}exponentialRampTo(t,o,l){return this._param.exponentialRampTo(t,o,l),this}linearRampTo(t,o,l){return this._param.linearRampTo(t,o,l),this}targetRampTo(t,o,l){return this._param.targetRampTo(t,o,l),this}exponentialApproachValueAtTime(t,o,l){return this._param.exponentialApproachValueAtTime(t,o,l),this}setTargetAtTime(t,o,l){return this._param.setTargetAtTime(t,o,l),this}setValueCurveAtTime(t,o,l,d){return this._param.setValueCurveAtTime(t,o,l,d),this}cancelScheduledValues(t){return this._param.cancelScheduledValues(t),this}cancelAndHoldAtTime(t){return this._param.cancelAndHoldAtTime(t),this}rampTo(t,o,l){return this._param.rampTo(t,o,l),this}get value(){return this._param.value}set value(t){this._param.value=t}get convert(){return this._param.convert}set convert(t){this._param.convert=t}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(t){this._param.overridden=t}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(t){return this._param.apply(t),this}}function xo(p,t,o,l){(t instanceof Et||Un(t)||t instanceof At&&t.override)&&(t.cancelScheduledValues(0),t.setValueAtTime(0,0),t instanceof At&&(t.overridden=!0)),Ke(p,t,o,l)}class vl extends Et{constructor(){const t=K(vl.getDefaults(),arguments,["value"]);super(t),this.name="TickParam",this._events=new ds(1/0),this._multiplier=1,this._multiplier=t.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(t.value)}),this.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(Et.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(t,o,l){o=this.toSeconds(o),this.setRampPoint(o);const d=this._fromType(t),v=this._events.get(o),b=Math.round(Math.max(1/l,1));for(let _=0;_<=b;_++){const x=l*_+o,S=this._exponentialApproach(v.time,v.value,d,l,x);this.linearRampToValueAtTime(this._toType(S),x)}return this}setValueAtTime(t,o){const l=this.toSeconds(o);super.setValueAtTime(t,o);const d=this._events.get(l),v=this._events.previousEvent(d),b=this._getTicksUntilEvent(v,l);return d.ticks=Math.max(b,0),this}linearRampToValueAtTime(t,o){const l=this.toSeconds(o);super.linearRampToValueAtTime(t,o);const d=this._events.get(l),v=this._events.previousEvent(d),b=this._getTicksUntilEvent(v,l);return d.ticks=Math.max(b,0),this}exponentialRampToValueAtTime(t,o){o=this.toSeconds(o);const l=this._fromType(t),d=this._events.get(o),v=Math.round(Math.max(10*(o-d.time),1)),b=(o-d.time)/v;for(let _=0;_<=v;_++){const x=b*_+d.time,S=this._exponentialInterpolate(d.time,d.value,o,l,x);this.linearRampToValueAtTime(this._toType(S),x)}return this}_getTicksUntilEvent(t,o){if(t===null)t={ticks:0,time:0,type:"setValueAtTime",value:0};else if(os(t.ticks)){const b=this._events.previousEvent(t);t.ticks=this._getTicksUntilEvent(b,t.time)}const l=this._fromType(this.getValueAtTime(t.time));let d=this._fromType(this.getValueAtTime(o));const v=this._events.get(o);return v&&v.time===o&&v.type==="setValueAtTime"&&(d=this._fromType(this.getValueAtTime(o-this.sampleTime))),.5*(o-t.time)*(l+d)+t.ticks}getTicksAtTime(t){const o=this.toSeconds(t),l=this._events.get(o);return Math.max(this._getTicksUntilEvent(l,o),0)}getDurationOfTicks(t,o){const l=this.toSeconds(o),d=this.getTicksAtTime(o);return this.getTimeOfTick(d+t)-l}getTimeOfTick(t){const o=this._events.get(t,"ticks"),l=this._events.getAfter(t,"ticks");if(o&&o.ticks===t)return o.time;if(o&&l&&l.type==="linearRampToValueAtTime"&&o.value!==l.value){const d=this._fromType(this.getValueAtTime(o.time)),v=(this._fromType(this.getValueAtTime(l.time))-d)/(l.time-o.time),b=Math.sqrt(Math.pow(d,2)-2*v*(o.ticks-t)),_=(-d+b)/v;return(_>0?_:(-d-b)/v)+o.time}return o?o.value===0?1/0:o.time+(t-o.ticks)/o.value:t/this._initialValue}ticksToTime(t,o){return this.getDurationOfTicks(t,o)}timeToTicks(t,o){const l=this.toSeconds(o),d=this.toSeconds(t),v=this.getTicksAtTime(l);return this.getTicksAtTime(l+d)-v}_fromType(t){return this.units==="bpm"&&this.multiplier?1/(60/t/this.multiplier):super._fromType(t)}_toType(t){return this.units==="bpm"&&this.multiplier?t/this.multiplier*60:super._toType(t)}get multiplier(){return this._multiplier}set multiplier(t){const o=this.value;this._multiplier=t,this.cancelScheduledValues(0),this.setValueAtTime(o,0)}}class yl extends At{constructor(){const t=K(yl.getDefaults(),arguments,["value"]);super(t),this.name="TickSignal",this.input=this._param=new vl({context:this.context,convert:t.convert,multiplier:t.multiplier,param:this._constantSource.offset,units:t.units,value:t.value})}static getDefaults(){return Object.assign(At.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(t,o){return this._param.ticksToTime(t,o)}timeToTicks(t,o){return this._param.timeToTicks(t,o)}getTimeOfTick(t){return this._param.getTimeOfTick(t)}getDurationOfTicks(t,o){return this._param.getDurationOfTicks(t,o)}getTicksAtTime(t){return this._param.getTicksAtTime(t)}get multiplier(){return this._param.multiplier}set multiplier(t){this._param.multiplier=t}dispose(){return super.dispose(),this._param.dispose(),this}}class bl extends Re{constructor(){const t=K(bl.getDefaults(),arguments,["frequency"]);super(t),this.name="TickSource",this._state=new Ei,this._tickOffset=new ds,this._ticksAtTime=new ds,this._secondsAtTime=new ds,this.frequency=new yl({context:this.context,units:t.units,value:t.frequency}),St(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},Re.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(t,o){const l=this.toSeconds(t);return this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),It(o)&&this.setTicksAtTime(o,l),this._ticksAtTime.cancel(l),this._secondsAtTime.cancel(l)),this}stop(t){const o=this.toSeconds(t);if(this._state.getValueAtTime(o)==="stopped"){const l=this._state.get(o);l&&l.time>0&&(this._tickOffset.cancel(l.time),this._state.cancel(l.time))}return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this.setTicksAtTime(0,o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}pause(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o)),this}cancel(t){return t=this.toSeconds(t),this._state.cancel(t),this._tickOffset.cancel(t),this._ticksAtTime.cancel(t),this._secondsAtTime.cancel(t),this}getTicksAtTime(t){const o=this.toSeconds(t),l=this._state.getLastState("stopped",o),d=this._ticksAtTime.get(o),v={state:"paused",time:o};this._state.add(v);let b=d||l,_=d?d.ticks:0,x=null;return this._state.forEachBetween(b.time,o+this.sampleTime,S=>{let M=b.time;const k=this._tickOffset.get(S.time);k&&k.time>=b.time&&(_=k.ticks,M=k.time),b.state==="started"&&S.state!=="started"&&(_+=this.frequency.getTicksAtTime(S.time)-this.frequency.getTicksAtTime(M),S.time!==v.time&&(x={state:S.state,time:S.time,ticks:_})),b=S}),this._state.remove(v),x&&this._ticksAtTime.add(x),_}get ticks(){return this.getTicksAtTime(this.now())}set ticks(t){this.setTicksAtTime(t,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(t){const o=this.now(),l=this.frequency.timeToTicks(t,o);this.setTicksAtTime(l,o)}getSecondsAtTime(t){t=this.toSeconds(t);const o=this._state.getLastState("stopped",t),l={state:"paused",time:t};this._state.add(l);const d=this._secondsAtTime.get(t);let v=d||o,b=d?d.seconds:0,_=null;return this._state.forEachBetween(v.time,t+this.sampleTime,x=>{let S=v.time;const M=this._tickOffset.get(x.time);M&&M.time>=v.time&&(b=M.seconds,S=M.time),v.state==="started"&&x.state!=="started"&&(b+=x.time-S,x.time!==l.time&&(_={state:x.state,time:x.time,seconds:b})),v=x}),this._state.remove(l),_&&this._secondsAtTime.add(_),b}setTicksAtTime(t,o){return o=this.toSeconds(o),this._tickOffset.cancel(o),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(t,o),ticks:t,time:o}),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}getStateAtTime(t){return t=this.toSeconds(t),this._state.getValueAtTime(t)}getTimeOfTick(t,o=this.now()){const l=this._tickOffset.get(o),d=this._state.get(o),v=Math.max(l.time,d.time),b=this.frequency.getTicksAtTime(v)+t-l.ticks;return this.frequency.getTimeOfTick(b)}forEachTickBetween(t,o,l){let d=this._state.get(t);this._state.forEachBetween(t,o,b=>{d&&d.state==="started"&&b.state!=="started"&&this.forEachTickBetween(Math.max(d.time,t),b.time-this.sampleTime,l),d=b});let v=null;if(d&&d.state==="started"){const b=Math.max(d.time,t),_=this.frequency.getTicksAtTime(b),x=_-this.frequency.getTicksAtTime(d.time);let S=Math.ceil(x)-x;S=Bs(S,1)?0:S;let M=this.frequency.getTimeOfTick(_+S);for(;M<o;){try{l(M,Math.round(this.getTicksAtTime(M)))}catch(k){v=k;break}M+=this.frequency.getDurationOfTicks(1,M)}}if(v)throw v;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class ki extends Re{constructor(){const t=K(ki.getDefaults(),arguments,["callback","frequency"]);super(t),this.name="Clock",this.callback=Dt,this._lastUpdate=0,this._state=new Ei("stopped"),this._boundLoop=this._loop.bind(this),this.callback=t.callback,this._tickSource=new bl({context:this.context,frequency:t.frequency,units:t.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,St(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(Re.getDefaults(),{callback:Dt,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(t,o){ll(this.context);const l=this.toSeconds(t);return this.log("start",l),this._state.getValueAtTime(l)!=="started"&&(this._state.setStateAtTime("started",l),this._tickSource.start(l,o),l<this._lastUpdate&&this.emit("start",l,o)),this}stop(t){const o=this.toSeconds(t);return this.log("stop",o),this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._tickSource.stop(o),o<this._lastUpdate&&this.emit("stop",o),this}pause(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._tickSource.pause(o),o<this._lastUpdate&&this.emit("pause",o)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(t){this._tickSource.ticks=t}get seconds(){return this._tickSource.seconds}set seconds(t){this._tickSource.seconds=t}getSecondsAtTime(t){return this._tickSource.getSecondsAtTime(t)}setTicksAtTime(t,o){return this._tickSource.setTicksAtTime(t,o),this}getTimeOfTick(t,o=this.now()){return this._tickSource.getTimeOfTick(t,o)}getTicksAtTime(t){return this._tickSource.getTicksAtTime(t)}nextTickTime(t,o){const l=this.toSeconds(o),d=this.getTicksAtTime(l);return this._tickSource.getTimeOfTick(d+t,l)}_loop(){const t=this._lastUpdate,o=this.now();this._lastUpdate=o,this.log("loop",t,o),t!==o&&(this._state.forEachBetween(t,o,l=>{switch(l.state){case"started":const d=this._tickSource.getTicksAtTime(l.time);this.emit("start",l.time,d);break;case"stopped":l.time!==0&&this.emit("stop",l.time);break;case"paused":this.emit("pause",l.time)}}),this._tickSource.forEachTickBetween(t,o,(l,d)=>{this.callback(l,d)}))}getStateAtTime(t){const o=this.toSeconds(t);return this._state.getValueAtTime(o)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}Si.mixin(ki);class fs extends rt{constructor(){const t=K(fs.getDefaults(),arguments,["delayTime","maxDelay"]);super(t),this.name="Delay";const o=this.toSeconds(t.maxDelay);this._maxDelay=Math.max(o,this.toSeconds(t.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(o),this.delayTime=new Et({context:this.context,param:this._delayNode.delayTime,units:"time",value:t.delayTime,minValue:0,maxValue:this.maxDelay}),St(this,"delayTime")}static getDefaults(){return Object.assign(rt.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class dn extends rt{constructor(){const t=K(dn.getDefaults(),arguments,["volume"]);super(t),this.name="Volume",this.input=this.output=new wt({context:this.context,gain:t.volume,units:"decibels"}),this.volume=this.output.gain,St(this,"volume"),this._unmutedVolume=t.volume,this.mute=t.mute}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(t){!this.mute&&t?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!t&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class wl extends rt{constructor(){const t=K(wl.getDefaults(),arguments);super(t),this.name="Destination",this.input=new dn({context:this.context}),this.output=new wt({context:this.context}),this.volume=this.input.volume,ms(this.input,this.output,this.context.rawContext.destination),this.mute=t.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(t){this.input.mute=t}chain(...t){return this.input.disconnect(),t.unshift(this.input),t.push(this.output),ms(...t),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}$r(p=>{p.destination=new wl({context:p})}),qr(p=>{p.destination.dispose()});class gg extends rt{constructor(){super(...arguments),this.name="Listener",this.positionX=new Et({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Et({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Et({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Et({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Et({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Et({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Et({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Et({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Et({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(rt.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}function vg(p,t){return Kt(this,arguments,void 0,function*(o,l,d=2,v=ie().sampleRate){const b=ie(),_=new Ti(d,l,v);zr(_),yield o(_);const x=_.render();zr(b);const S=yield x;return new qt(S)})}$r(p=>{p.listener=new gg({context:p})}),qr(p=>{p.listener.dispose()});class Ii extends un{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const t=K(Ii.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=t.baseUrl,Object.keys(t.urls).forEach(o=>{this._loadingCount++;const l=t.urls[o];this.add(o,l,this._bufferLoaded.bind(this,t.onload),t.onerror)})}static getDefaults(){return{baseUrl:"",onerror:Dt,onload:Dt,urls:{}}}has(t){return this._buffers.has(t.toString())}get(t){return _t(this.has(t),`ToneAudioBuffers has no buffer named: ${t}`),this._buffers.get(t.toString())}_bufferLoaded(t){this._loadingCount--,this._loadingCount===0&&t&&t()}get loaded(){return Array.from(this._buffers).every(([t,o])=>o.loaded)}add(t,o,l=Dt,d=Dt){return Ls(o)?(this.baseUrl&&o.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(t.toString(),new qt(this.baseUrl+o,l,d))):this._buffers.set(t.toString(),new qt(o,l,d)),this}dispose(){return super.dispose(),this._buffers.forEach(t=>t.dispose()),this._buffers.clear(),this}}class Ri extends Je{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(t){return En(super._frequencyToUnits(t))}_ticksToUnits(t){return En(super._ticksToUnits(t))}_beatsToUnits(t){return En(super._beatsToUnits(t))}_secondsToUnits(t){return En(super._secondsToUnits(t))}toMidi(){return this.valueOf()}toFrequency(){return ml(this.toMidi())}transpose(t){return new Ri(this.context,this.toMidi()+t)}}function yg(p,t){return new Ri(ie(),p,t)}class ce extends xe{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(t){return this._getPPQ()*t}_secondsToUnits(t){return Math.floor(t/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(t){return t}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}function bg(p,t){return new ce(ie(),p,t)}class wg extends Re{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new ds,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(t,o){return this._events.add({callback:t,time:this.toSeconds(o)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(t){return this._events.cancel(this.toSeconds(t)),this}_drawLoop(){const t=this.context.currentTime;for(;this._events.length&&this._events.peek().time-this.anticipation<=t;){const o=this._events.shift();o&&t-o.time<=this.expiration&&o.callback()}this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}$r(p=>{p.draw=new wg({context:p})}),qr(p=>{p.draw.dispose()});class Fu extends un{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(t){_t(It(t.time),"Events must have a time property"),_t(It(t.duration),"Events must have a duration parameter"),t.time=t.time.valueOf();let o=new _g(t.time,t.time+t.duration,t);for(this._root===null?this._root=o:this._root.insert(o),this._length++;o!==null;)o.updateHeight(),o.updateMax(),this._rebalance(o),o=o.parent;return this}remove(t){if(this._root!==null){const o=[];this._root.search(t.time,o);for(const l of o)if(l.event===t){this._removeNode(l),this._length--;break}}return this}get length(){return this._length}cancel(t){return this.forEachFrom(t,o=>this.remove(o)),this}_setRoot(t){this._root=t,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(t,o){t.parent!==null?(t.isLeftChild()?t.parent.left=o:t.parent.right=o,this._rebalance(t.parent)):this._setRoot(o)}_removeNode(t){if(t.left===null&&t.right===null)this._replaceNodeInParent(t,null);else if(t.right===null)this._replaceNodeInParent(t,t.left);else if(t.left===null)this._replaceNodeInParent(t,t.right);else{let o,l=null;if(t.getBalance()>0)if(t.left.right===null)o=t.left,o.right=t.right,l=o;else{for(o=t.left.right;o.right!==null;)o=o.right;o.parent&&(o.parent.right=o.left,l=o.parent,o.left=t.left,o.right=t.right)}else if(t.right.left===null)o=t.right,o.left=t.left,l=o;else{for(o=t.right.left;o.left!==null;)o=o.left;o.parent&&(o.parent.left=o.right,l=o.parent,o.left=t.left,o.right=t.right)}t.parent!==null?t.isLeftChild()?t.parent.left=o:t.parent.right=o:this._setRoot(o),l&&this._rebalance(l)}t.dispose()}_rotateLeft(t){const o=t.parent,l=t.isLeftChild(),d=t.right;d&&(t.right=d.left,d.left=t),o!==null?l?o.left=d:o.right=d:this._setRoot(d)}_rotateRight(t){const o=t.parent,l=t.isLeftChild(),d=t.left;d&&(t.left=d.right,d.right=t),o!==null?l?o.left=d:o.right=d:this._setRoot(d)}_rebalance(t){const o=t.getBalance();o>1&&t.left?t.left.getBalance()<0?this._rotateLeft(t.left):this._rotateRight(t):o<-1&&t.right&&(t.right.getBalance()>0?this._rotateRight(t.right):this._rotateLeft(t))}get(t){if(this._root!==null){const o=[];if(this._root.search(t,o),o.length>0){let l=o[0];for(let d=1;d<o.length;d++)o[d].low>l.low&&(l=o[d]);return l.event}}return null}forEach(t){if(this._root!==null){const o=[];this._root.traverse(l=>o.push(l)),o.forEach(l=>{l.event&&t(l.event)})}return this}forEachAtTime(t,o){if(this._root!==null){const l=[];this._root.search(t,l),l.forEach(d=>{d.event&&o(d.event)})}return this}forEachFrom(t,o){if(this._root!==null){const l=[];this._root.searchAfter(t,l),l.forEach(d=>{d.event&&o(d.event)})}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse(t=>t.dispose()),this._root=null,this}}class _g{constructor(t,o,l){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=l,this.low=t,this.high=o,this.max=this.high}insert(t){t.low<=this.low?this.left===null?this.left=t:this.left.insert(t):this.right===null?this.right=t:this.right.insert(t)}search(t,o){t>this.max||(this.left!==null&&this.left.search(t,o),this.low<=t&&this.high>t&&o.push(this),this.low>t||this.right!==null&&this.right.search(t,o))}searchAfter(t,o){this.low>=t&&(o.push(this),this.left!==null&&this.left.searchAfter(t,o)),this.right!==null&&this.right.searchAfter(t,o)}traverse(t){t(this),this.left!==null&&this.left.traverse(t),this.right!==null&&this.right.traverse(t)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let t=0;return this.left!==null&&this.right!==null?t=this.left.height-this.right.height:this.left!==null?t=this.left.height+1:this.right!==null&&(t=-(this.right.height+1)),t}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(t){this._left=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(t){this._right=t,t!==null&&(t.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class xg extends un{constructor(t){super(),this.name="TimelineValue",this._timeline=new ds({memory:10}),this._initialValue=t}set(t,o){return this._timeline.add({value:t,time:o}),this}get(t){const o=this._timeline.get(t);return o?o.value:this._initialValue}}class gs extends rt{constructor(){super(K(gs.getDefaults(),arguments,["context"]))}connect(t,o=0,l=0){return xo(this,t,o,l),this}}class $s extends gs{constructor(){const t=K($s.getDefaults(),arguments,["mapping","length"]);super(t),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,Ne(t.mapping)||t.mapping instanceof Float32Array?this.curve=Float32Array.from(t.mapping):Eu(t.mapping)&&this.setMap(t.mapping,t.length)}static getDefaults(){return Object.assign(At.getDefaults(),{length:1024})}setMap(t,o=1024){const l=new Float32Array(o);for(let d=0,v=o;d<v;d++){const b=d/(v-1)*2-1;l[d]=t(b,d)}return this.curve=l,this}get curve(){return this._shaper.curve}set curve(t){this._shaper.curve=t}get oversample(){return this._shaper.oversample}set oversample(t){_t(["none","2x","4x"].some(o=>o.includes(t)),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class Di extends gs{constructor(){const t=K(Di.getDefaults(),arguments,["value"]);super(t),this.name="Pow",this._exponentScaler=this.input=this.output=new $s({context:this.context,mapping:this._expFunc(t.value),length:8192}),this._exponent=t.value}static getDefaults(){return Object.assign(gs.getDefaults(),{value:1})}_expFunc(t){return o=>Math.pow(Math.abs(o),t)}get value(){return this._exponent}set value(t){this._exponent=t,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class Pn{constructor(t,o){this.id=Pn._eventId++,this._remainderTime=0;const l=Object.assign(Pn.getDefaults(),o);this.transport=t,this.callback=l.callback,this._once=l.once,this.time=Math.floor(l.time),this._remainderTime=l.time-this.time}static getDefaults(){return{callback:Dt,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(t){if(this.callback){const o=this.transport.bpm.getDurationOfTicks(1,t);this.callback(t+this._remainderTime*o),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}Pn._eventId=0;class _l extends Pn{constructor(t,o){super(t,o),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const l=Object.assign(_l.getDefaults(),o);this.duration=l.duration,this._interval=l.interval,this._nextTick=l.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},Pn.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(t){this._createEvents(t),super.invoke(t)}_createEvent(){return Br(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new ce(this.context,this._nextTick).toSeconds()):-1}_createEvents(t){Br(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new ce(this.context,this._nextTick).toSeconds()))}_restart(t){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const o=this.transport.getTicksAtTime(t);xi(o,this.time)&&(this._nextTick=this.floatTime+Math.ceil((o-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Hr extends Re{constructor(){const t=K(Hr.getDefaults(),arguments);super(t),this.name="Transport",this._loop=new xg(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new ds,this._repeatedEvents=new Fu,this._syncedSignals=[],this._swingAmount=0,this._ppq=t.ppq,this._clock=new ki({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=t.ppq,this.bpm.setValueAtTime(t.bpm,0),St(this,"bpm"),this._timeSignature=t.timeSignature,this._swingTicks=t.ppq/2}static getDefaults(){return Object.assign(Re.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(t,o){if(this._loop.get(t)&&o>=this._loopEnd&&(this.emit("loopEnd",t),this._clock.setTicksAtTime(this._loopStart,t),o=this._loopStart,this.emit("loopStart",t,this._clock.getSecondsAtTime(t)),this.emit("loop",t)),this._swingAmount>0&&o%this._ppq!=0&&o%(2*this._swingTicks)!=0){const l=o%(2*this._swingTicks)/(2*this._swingTicks),d=Math.sin(l*Math.PI)*this._swingAmount;t+=new ce(this.context,2*this._swingTicks/3).toSeconds()*d}cl(!0),this._timeline.forEachAtTime(o,l=>l.invoke(t)),cl(!1)}schedule(t,o){const l=new Pn(this,{callback:t,time:new xe(this.context,o).toTicks()});return this._addEvent(l,this._timeline)}scheduleRepeat(t,o,l,d=1/0){const v=new _l(this,{callback:t,duration:new ps(this.context,d).toTicks(),interval:new ps(this.context,o).toTicks(),time:new xe(this.context,l).toTicks()});return this._addEvent(v,this._repeatedEvents)}scheduleOnce(t,o){const l=new Pn(this,{callback:t,once:!0,time:new xe(this.context,o).toTicks()});return this._addEvent(l,this._timeline)}clear(t){if(this._scheduledEvents.hasOwnProperty(t)){const o=this._scheduledEvents[t.toString()];o.timeline.remove(o.event),o.event.dispose(),delete this._scheduledEvents[t.toString()]}return this}_addEvent(t,o){return this._scheduledEvents[t.id.toString()]={event:t,timeline:o},o.add(t),t.id}cancel(t=0){const o=this.toTicks(t);return this._timeline.forEachFrom(o,l=>this.clear(l.id)),this._repeatedEvents.forEachFrom(o,l=>this.clear(l.id)),this}_bindClockEvents(){this._clock.on("start",(t,o)=>{o=new ce(this.context,o).toSeconds(),this.emit("start",t,o)}),this._clock.on("stop",t=>{this.emit("stop",t)}),this._clock.on("pause",t=>{this.emit("pause",t)})}get state(){return this._clock.getStateAtTime(this.now())}start(t,o){let l;return this.context.resume(),It(o)&&(l=this.toTicks(o)),this._clock.start(t,l),this}stop(t){return this._clock.stop(t),this}pause(t){return this._clock.pause(t),this}toggle(t){return t=this.toSeconds(t),this._clock.getStateAtTime(t)!=="started"?this.start(t):this.stop(t),this}get timeSignature(){return this._timeSignature}set timeSignature(t){Ne(t)&&(t=t[0]/t[1]*4),this._timeSignature=t}get loopStart(){return new ps(this.context,this._loopStart,"i").toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t)}get loopEnd(){return new ps(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t)}get loop(){return this._loop.get(this.now())}set loop(t){this._loop.set(t,this.now())}setLoopPoints(t,o){return this.loopStart=t,this.loopEnd=o,this}get swing(){return this._swingAmount}set swing(t){this._swingAmount=t}get swingSubdivision(){return new ce(this.context,this._swingTicks).toNotation()}set swingSubdivision(t){this._swingTicks=this.toTicks(t)}get position(){const t=this.now(),o=this._clock.getTicksAtTime(t);return new ce(this.context,o).toBarsBeatsSixteenths()}set position(t){const o=this.toTicks(t);this.ticks=o}get seconds(){return this._clock.seconds}set seconds(t){const o=this.now(),l=this._clock.frequency.timeToTicks(t,o);this.ticks=l}get progress(){if(this.loop){const t=this.now();return(this._clock.getTicksAtTime(t)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(t){if(this._clock.ticks!==t){const o=this.now();if(this.state==="started"){const l=this._clock.getTicksAtTime(o),d=o+this._clock.frequency.getDurationOfTicks(Math.ceil(l)-l,o);this.emit("stop",d),this._clock.setTicksAtTime(t,d),this.emit("start",d,this._clock.getSecondsAtTime(d))}else this.emit("ticks",o),this._clock.setTicksAtTime(t,o)}}getTicksAtTime(t){return this._clock.getTicksAtTime(t)}getSecondsAtTime(t){return this._clock.getSecondsAtTime(t)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(t){this._clock.frequency.multiplier=t}nextSubdivision(t){if(t=this.toTicks(t),this.state!=="started")return 0;{const o=this.now(),l=t-this.getTicksAtTime(o)%t;return this._clock.nextTickTime(l,o)}}syncSignal(t,o){const l=this.now();let d=this.bpm,v=1/(60/d.getValueAtTime(l)/this.PPQ),b=[];if(t.units==="time"){const x=.015625/v,S=new wt(x),M=new Di(-1),k=new wt(x);d.chain(S,M,k),d=k,v=1/v,b=[S,M,k]}o||(o=t.getValueAtTime(l)!==0?t.getValueAtTime(l)/v:0);const _=new wt(o);return d.connect(_),_.connect(t._param),b.push(_),this._syncedSignals.push({initial:t.value,nodes:b,signal:t}),t.value=0,this}unsyncSignal(t){for(let o=this._syncedSignals.length-1;o>=0;o--){const l=this._syncedSignals[o];l.signal===t&&(l.nodes.forEach(d=>d.dispose()),l.signal.value=l.initial,this._syncedSignals.splice(o,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),bo(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}Si.mixin(Hr),$r(p=>{p.transport=new Hr({context:p})}),qr(p=>{p.transport.dispose()});class ge extends rt{constructor(t){super(t),this.input=void 0,this._state=new Ei("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Dt,this._syncedStop=Dt,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new dn({context:this.context,mute:t.mute,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume"),this.onstop=t.onstop}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,onstop:Dt,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}_clampToCurrentTime(t){return this._synced?t:Math.max(t,this.context.currentTime)}start(t,o,l){let d=os(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(d=this._clampToCurrentTime(d),this._synced||this._state.getValueAtTime(d)!=="started")if(this.log("start",d),this._state.setStateAtTime("started",d),this._synced){const v=this._state.get(d);v&&(v.offset=this.toSeconds(As(o,0)),v.duration=l?this.toSeconds(l):void 0);const b=this.context.transport.schedule(_=>{this._start(_,o,l)},d);this._scheduled.push(b),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>d&&this._syncedStart(this.now(),this.context.transport.seconds)}else ll(this.context),this._start(d,o,l);else _t(xi(d,this._state.get(d).time),"Start time must be strictly greater than previous start time"),this._state.cancel(d),this._state.setStateAtTime("started",d),this.log("restart",d),this.restart(d,o,l);return this}stop(t){let o=os(t)&&this._synced?this.context.transport.seconds:this.toSeconds(t);if(o=this._clampToCurrentTime(o),this._state.getValueAtTime(o)==="started"||It(this._state.getNextState("started",o))){if(this.log("stop",o),this._synced){const l=this.context.transport.schedule(this._stop.bind(this),o);this._scheduled.push(l)}else this._stop(o);this._state.cancel(o),this._state.setStateAtTime("stopped",o)}return this}restart(t,o,l){return t=this.toSeconds(t),this._state.getValueAtTime(t)==="started"&&(this._state.cancel(t),this._restart(t,o,l)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(t,o)=>{if(xi(o,0)){const l=this._state.get(o);if(l&&l.state==="started"&&l.time!==o){const d=o-this.toSeconds(l.time);let v;l.duration&&(v=this.toSeconds(l.duration)-d),this._start(t,this.toSeconds(l.offset)+d,v)}}},this._syncedStop=t=>{const o=this.context.transport.getSecondsAtTime(Math.max(t-this.sampleTime,0));this._state.getValueAtTime(o)==="started"&&this._stop(t)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach(t=>this.context.transport.clear(t)),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Dt,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class kn extends Pi{constructor(){const t=K(kn.getDefaults(),arguments,["url","onload"]);super(t),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Ke(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Et({context:this.context,param:this._source.playbackRate,units:"positive",value:t.playbackRate}),this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this._buffer=new qt(t.url,t.onload,t.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(Pi.getDefaults(),{url:new qt,loop:!1,loopEnd:0,loopStart:0,onload:Dt,onerror:Dt,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t}get curve(){return this._curve}set curve(t){this._curve=t}start(t,o,l,d=1){_t(this.buffer.loaded,"buffer is either not set or not loaded");const v=this.toSeconds(t);this._startGain(v,d),o=this.loop?As(o,this.loopStart):As(o,0);let b=Math.max(this.toSeconds(o),0);if(this.loop){const _=this.toSeconds(this.loopEnd)||this.buffer.duration,x=this.toSeconds(this.loopStart),S=_-x;dl(b,_)&&(b=(b-x)%S+x),Bs(b,this.buffer.duration)&&(b=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,Br(b,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(v,b)),It(l)){let _=this.toSeconds(l);_=Math.max(_,0),this.stop(v+_)}return this}_stopSource(t){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(t)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(t){this._source.loopStart=this.toSeconds(t)}get loopEnd(){return this._source.loopEnd}set loopEnd(t){this._source.loopEnd=this.toSeconds(t)}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._source.loop}set loop(t){this._source.loop=t,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}class In extends ge{constructor(){const t=K(In.getDefaults(),arguments,["type"]);super(t),this.name="Noise",this._source=null,this._playbackRate=t.playbackRate,this.type=t.type,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ge.getDefaults(),{fadeIn:0,fadeOut:0,playbackRate:1,type:"white"})}get type(){return this._type}set type(t){if(_t(t in Bu,"Noise: invalid type: "+t),this._type!==t&&(this._type=t,this.state==="started")){const o=this.now();this._stop(o),this._start(o)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._source&&(this._source.playbackRate.value=t)}_start(t){const o=Bu[this._type];this._source=new kn({url:o,context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,loop:!0,onended:()=>this.onstop(this),playbackRate:this._playbackRate}).connect(this.output),this._source.start(this.toSeconds(t),Math.random()*(o.duration-.001))}_stop(t){this._source&&(this._source.stop(this.toSeconds(t)),this._source=null)}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._source&&(this._source.fadeIn=this._fadeIn)}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._source&&(this._source.fadeOut=this._fadeOut)}_restart(t){this._stop(t),this._start(t)}dispose(){return super.dispose(),this._source&&this._source.disconnect(),this}}const Oi=220500,pn={brown:null,pink:null,white:null},Bu={get brown(){if(!pn.brown){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Oi);p[t]=o;let l=0;for(let d=0;d<Oi;d++){const v=2*Math.random()-1;o[d]=(l+.02*v)/1.02,l=o[d],o[d]*=3.5}}pn.brown=new qt().fromArray(p)}return pn.brown},get pink(){if(!pn.pink){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Oi);let l,d,v,b,_,x,S;p[t]=o,l=d=v=b=_=x=S=0;for(let M=0;M<Oi;M++){const k=2*Math.random()-1;l=.99886*l+.0555179*k,d=.99332*d+.0750759*k,v=.969*v+.153852*k,b=.8665*b+.3104856*k,_=.55*_+.5329522*k,x=-.7616*x-.016898*k,o[M]=l+d+v+b+_+x+S+.5362*k,o[M]*=.11,S=.115926*k}}pn.pink=new qt().fromArray(p)}return pn.pink},get white(){if(!pn.white){const p=[];for(let t=0;t<2;t++){const o=new Float32Array(Oi);p[t]=o;for(let l=0;l<Oi;l++)o[l]=2*Math.random()-1}pn.white=new qt().fromArray(p)}return pn.white}};class So extends rt{constructor(){const t=K(So.getDefaults(),arguments,["volume"]);super(t),this.name="UserMedia",this._volume=this.output=new dn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume"),this.mute=t.mute}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,volume:0})}open(t){return Kt(this,void 0,void 0,function*(){_t(So.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const o=yield So.enumerateDevices();hs(t)?this._device=o[t]:(this._device=o.find(v=>v.label===t||v.deviceId===t),!this._device&&o.length>0&&(this._device=o[0]),_t(It(this._device),`No matching device ${t}`));const l={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(l.audio.deviceId=this._device.deviceId);const d=yield navigator.mediaDevices.getUserMedia(l);if(!this._stream){this._stream=d;const v=this.context.createMediaStreamSource(d);Ke(v,this.output),this._mediaStream=v}return this})}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach(t=>{t.stop()}),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return Kt(this,void 0,void 0,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){return this._device?this._device.deviceId:void 0}get groupId(){return this._device?this._device.groupId:void 0}get label(){return this._device?this._device.label:void 0}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return It(navigator.mediaDevices)&&It(navigator.mediaDevices.getUserMedia)}}function Yn(p,t){return Kt(this,void 0,void 0,function*(){const o=t/p.context.sampleRate,l=new Ti(1,o,p.context.sampleRate);return new p.constructor(Object.assign(p.get(),{frequency:2/o,detune:0,context:l})).toDestination().start(0),(yield l.render()).getChannelData(0)})}class Co extends Pi{constructor(){const t=K(Co.getDefaults(),arguments,["frequency","type"]);super(t),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Ke(this._oscillator,this._gainNode),this.type=t.type,this.frequency=new Et({context:this.context,param:this._oscillator.frequency,units:"frequency",value:t.frequency}),this.detune=new Et({context:this.context,param:this._oscillator.detune,units:"cents",value:t.detune}),St(this,["frequency","detune"])}static getDefaults(){return Object.assign(Pi.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(t){const o=this.toSeconds(t);return this.log("start",o),this._startGain(o),this._oscillator.start(o),this}_stopSource(t){this._oscillator.stop(t)}setPeriodicWave(t){return this._oscillator.setPeriodicWave(t),this}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class he extends ge{constructor(){const t=K(he.getDefaults(),arguments,["frequency","type"]);super(t),this.name="Oscillator",this._oscillator=null,this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),St(this,"frequency"),this.detune=new At({context:this.context,units:"cents",value:t.detune}),St(this,"detune"),this._partials=t.partials,this._partialCount=t.partialCount,this._type=t.type,t.partialCount&&t.type!=="custom"&&(this._type=this.baseType+t.partialCount.toString()),this.phase=t.phase}static getDefaults(){return Object.assign(ge.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(t){const o=this.toSeconds(t),l=new Co({context:this.context,onended:()=>this.onstop(this)});this._oscillator=l,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(o)}_stop(t){const o=this.toSeconds(t);this._oscillator&&this._oscillator.stop(o)}_restart(t){const o=this.toSeconds(t);return this.log("restart",o),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(o),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return he._periodicWaveCache.find(t=>{return t.phase===this._phase&&(o=t.partials,l=this._partials,o.length===l.length&&o.every((d,v)=>l[v]===d));var o,l});{const t=he._periodicWaveCache.find(o=>o.type===this._type&&o.phase===this._phase);return this._partialCount=t?t.partialCount:this._partialCount,t}}get type(){return this._type}set type(t){this._type=t;const o=["sine","square","sawtooth","triangle"].indexOf(t)!==-1;if(this._phase===0&&o)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=t);else{const l=this._getCachedPeriodicWave();if(It(l)){const{partials:d,wave:v}=l;this._wave=v,this._partials=d,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[d,v]=this._getRealImaginary(t,this._phase),b=this.context.createPeriodicWave(d,v);this._wave=b,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),he._periodicWaveCache.push({imag:v,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:d,type:this._type,wave:this._wave}),he._periodicWaveCache.length>100&&he._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(t){this.partialCount&&this._type!=="custom"&&t!=="custom"?this.type=t+this.partialCount:this.type=t}get partialCount(){return this._partialCount}set partialCount(t){Le(t,0);let o=this._type;const l=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(l&&(o=l[1]),this._type!=="custom")this.type=t===0?o:o+t.toString();else{const d=new Float32Array(t);this._partials.forEach((v,b)=>d[b]=v),this._partials=Array.from(d),this.type=this._type}}_getRealImaginary(t,o){let l=2048;const d=new Float32Array(l),v=new Float32Array(l);let b=1;if(t==="custom"){if(b=this._partials.length+1,this._partialCount=this._partials.length,l=b,this._partials.length===0)return[d,v]}else{const _=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(t);_?(b=parseInt(_[2],10)+1,this._partialCount=parseInt(_[2],10),t=_[1],b=Math.max(b,2),l=b):this._partialCount=0,this._partials=[]}for(let _=1;_<l;++_){const x=2/(_*Math.PI);let S;switch(t){case"sine":S=_<=b?1:0,this._partials[_-1]=S;break;case"square":S=1&_?2*x:0,this._partials[_-1]=S;break;case"sawtooth":S=x*(1&_?1:-1),this._partials[_-1]=S;break;case"triangle":S=1&_?x*x*2*(_-1>>1&1?-1:1):0,this._partials[_-1]=S;break;case"custom":S=this._partials[_-1];break;default:throw new TypeError("Oscillator: invalid type: "+t)}S!==0?(d[_]=-S*Math.sin(o*_),v[_]=S*Math.cos(o*_)):(d[_]=0,v[_]=0)}return[d,v]}_inverseFFT(t,o,l){let d=0;const v=t.length;for(let b=0;b<v;b++)d+=t[b]*Math.cos(b*l)+o[b]*Math.sin(b*l);return d}getInitialValue(){const[t,o]=this._getRealImaginary(this._type,0);let l=0;const d=2*Math.PI;for(let v=0;v<32;v++)l=Math.max(this._inverseFFT(t,o,v/32*d),l);return Xn(-this._inverseFFT(t,o,this._phase)/l,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(t){this._phase=t*Math.PI/180,this.type=this._type}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}he._periodicWaveCache=[];class Gr extends gs{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new $s({context:this.context,mapping:t=>(t+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class ue extends At{constructor(){const t=K(ue.getDefaults(),arguments,["value"]);super(t),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new wt({context:this.context,minValue:t.minValue,maxValue:t.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(t.value,0)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class To extends ge{constructor(){const t=K(To.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="AMOscillator",this._modulationScale=new Gr({context:this.context}),this._modulationNode=new wt({context:this.context}),this._carrier=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new he({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),St(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(he.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){this._modulator.restart(t),this._carrier.restart(t)}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class Ni extends ge{constructor(){const t=K(Ni.getDefaults(),arguments,["frequency","type","modulationType"]);super(t),this.name="FMOscillator",this._modulationNode=new wt({context:this.context,gain:0}),this._carrier=new he({context:this.context,detune:t.detune,frequency:0,onstop:()=>this.onstop(this),phase:t.phase,type:t.type}),this.detune=this._carrier.detune,this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this._modulator=new he({context:this.context,phase:t.phase,type:t.modulationType}),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this.modulationIndex=new ue({context:this.context,units:"positive",value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),St(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(he.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(t){this._modulator.start(t),this._carrier.start(t)}_stop(t){this._modulator.stop(t),this._carrier.stop(t)}_restart(t){return this._modulator.restart(t),this._carrier.restart(t),this}get type(){return this._carrier.type}set type(t){this._carrier.type=t}get baseType(){return this._carrier.baseType}set baseType(t){this._carrier.baseType=t}get partialCount(){return this._carrier.partialCount}set partialCount(t){this._carrier.partialCount=t}get modulationType(){return this._modulator.type}set modulationType(t){this._modulator.type=t}get phase(){return this._carrier.phase}set phase(t){this._carrier.phase=t,this._modulator.phase=t}get partials(){return this._carrier.partials}set partials(t){this._carrier.partials=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class Li extends ge{constructor(){const t=K(Li.getDefaults(),arguments,["frequency","width"]);super(t),this.name="PulseOscillator",this._widthGate=new wt({context:this.context,gain:0}),this._thresh=new $s({context:this.context,mapping:o=>o<=0?-1:1}),this.width=new At({context:this.context,units:"audioRange",value:t.width}),this._triangle=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),St(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(ge.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(t){t=this.toSeconds(t),this._triangle.start(t),this._widthGate.gain.setValueAtTime(1,t)}_stop(t){t=this.toSeconds(t),this._triangle.stop(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(0,t)}_restart(t){this._triangle.restart(t),this._widthGate.gain.cancelScheduledValues(t),this._widthGate.gain.setValueAtTime(1,t)}get phase(){return this._triangle.phase}set phase(t){this._triangle.phase=t}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(t){this._triangle.type=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Ao extends ge{constructor(){const t=K(Ao.getDefaults(),arguments,["frequency","type","spread"]);super(t),this.name="FatOscillator",this._oscillators=[],this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),this._spread=t.spread,this._type=t.type,this._phase=t.phase,this._partials=t.partials,this._partialCount=t.partialCount,this.count=t.count,St(this,["frequency","detune"])}static getDefaults(){return Object.assign(he.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(t){t=this.toSeconds(t),this._forEach(o=>o.start(t))}_stop(t){t=this.toSeconds(t),this._forEach(o=>o.stop(t))}_restart(t){this._forEach(o=>o.restart(t))}_forEach(t){for(let o=0;o<this._oscillators.length;o++)t(this._oscillators[o],o)}get type(){return this._type}set type(t){this._type=t,this._forEach(o=>o.type=t)}get spread(){return this._spread}set spread(t){if(this._spread=t,this._oscillators.length>1){const o=-t/2,l=t/(this._oscillators.length-1);this._forEach((d,v)=>d.detune.value=o+l*v)}}get count(){return this._oscillators.length}set count(t){if(Le(t,1),this._oscillators.length!==t){this._forEach(o=>o.dispose()),this._oscillators=[];for(let o=0;o<t;o++){const l=new he({context:this.context,volume:-6-1.1*t,type:this._type,phase:this._phase+o/t*360,partialCount:this._partialCount,onstop:o===0?()=>this.onstop(this):Dt});this.type==="custom"&&(l.partials=this._partials),this.frequency.connect(l.frequency),this.detune.connect(l.detune),l.detune.overridden=!1,l.connect(this.output),this._oscillators[o]=l}this.spread=this._spread,this.state==="started"&&this._forEach(o=>o.start())}}get phase(){return this._phase}set phase(t){this._phase=t,this._forEach((o,l)=>o.phase=this._phase+l/this.count*360)}get baseType(){return this._oscillators[0].baseType}set baseType(t){this._forEach(o=>o.baseType=t),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(t){this._partials=t,this._partialCount=this._partials.length,t.length&&(this._type="custom",this._forEach(o=>o.partials=t))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(t){this._partialCount=t,this._forEach(o=>o.partialCount=t),this._type=this._oscillators[0].type}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach(t=>t.dispose()),this}}class Mo extends ge{constructor(){const t=K(Mo.getDefaults(),arguments,["frequency","modulationFrequency"]);super(t),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new ue({context:this.context,value:2}),this._pulse=new Li({context:this.context,frequency:t.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new he({context:this.context,detune:t.detune,frequency:t.frequency,onstop:()=>this.onstop(this),phase:t.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),St(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(ge.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(t){t=this.toSeconds(t),this._modulator.start(t),this._pulse.start(t)}_stop(t){t=this.toSeconds(t),this._modulator.stop(t),this._pulse.stop(t)}_restart(t){this._modulator.restart(t),this._pulse.restart(t)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(t){this._modulator.phase=t}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const $u={am:To,fat:Ao,fm:Ni,oscillator:he,pulse:Li,pwm:Mo};class mn extends ge{constructor(){const t=K(mn.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OmniOscillator",this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),St(this,["frequency","detune"]),this.set(t)}static getDefaults(){return Object.assign(he.getDefaults(),Ni.getDefaults(),To.getDefaults(),Ao.getDefaults(),Li.getDefaults(),Mo.getDefaults())}_start(t){this._oscillator.start(t)}_stop(t){this._oscillator.stop(t)}_restart(t){return this._oscillator.restart(t),this}get type(){let t="";return["am","fm","fat"].some(o=>this._sourceType===o)&&(t=this._sourceType),t+this._oscillator.type}set type(t){t.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(2)):t.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=t.substr(3)):t==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):t==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=t)}get partials(){return this._oscillator.partials}set partials(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=t)}get partialCount(){return this._oscillator.partialCount}set partialCount(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=t)}set(t){return Reflect.has(t,"type")&&t.type&&(this.type=t.type),super.set(t),this}_createNewOscillator(t){if(t!==this._sourceType){this._sourceType=t;const o=$u[t],l=this.now();if(this._oscillator){const d=this._oscillator;d.stop(l),this.context.setTimeout(()=>d.dispose(),this.blockTime)}this._oscillator=new o({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(l)}}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t}get sourceType(){return this._sourceType}set sourceType(t){let o="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(o=this._oscillator.type),t==="fm"?this.type="fm"+o:t==="am"?this.type="am"+o:t==="fat"?this.type="fat"+o:t==="oscillator"?this.type=o:t==="pulse"?this.type="pulse":t==="pwm"&&(this.type="pwm")}_getOscType(t,o){return t instanceof $u[o]}get baseType(){return this._oscillator.baseType}set baseType(t){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||t==="pulse"||t==="pwm"||(this._oscillator.baseType=t)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(t){this._getOscType(this._oscillator,"fat")&&hs(t)&&(this._oscillator.count=t)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(t){this._getOscType(this._oscillator,"fat")&&hs(t)&&(this._oscillator.spread=t)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(t){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&Ls(t)&&(this._oscillator.modulationType=t)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return Kt(this,arguments,void 0,function*(t=1024){return Yn(this,t)})}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}class Zn extends At{constructor(){super(K(Zn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new wt({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,ms(this._constantSource,this._sum)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class fn extends gs{constructor(){const t=K(fn.getDefaults(),arguments,["min","max"]);super(t),this.name="Scale",this._mult=this.input=new ue({context:this.context,value:t.max-t.min}),this._add=this.output=new Zn({context:this.context,value:t.min}),this._min=t.min,this._max=t.max,this.input.connect(this.output)}static getDefaults(){return Object.assign(gs.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(t){this._min=t,this._setRange()}get max(){return this._max}set max(t){this._max=t,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class jr extends gs{constructor(){super(K(jr.getDefaults(),arguments)),this.name="Zero",this._gain=new wt({context:this.context}),this.output=this._gain,this.input=void 0,Ke(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),gl(this.context.getConstant(0),this._gain),this}}class ts extends rt{constructor(){const t=K(ts.getDefaults(),arguments,["frequency","min","max"]);super(t),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=Et.prototype._fromType,this._toType=Et.prototype._toType,this._is=Et.prototype._is,this._clampValue=Et.prototype._clampValue,this._oscillator=new he(t),this.frequency=this._oscillator.frequency,this._amplitudeGain=new wt({context:this.context,gain:t.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new At({context:this.context,units:"audioRange",value:0}),this._zeros=new jr({context:this.context}),this._a2g=new Gr({context:this.context}),this._scaler=this.output=new fn({context:this.context,max:t.max,min:t.min}),this.units=t.units,this.min=t.min,this.max=t.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),St(this,["amplitude","frequency"]),this.phase=t.phase}static getDefaults(){return Object.assign(he.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(0,t),this._oscillator.start(t),this}stop(t){return t=this.toSeconds(t),this._stoppedSignal.setValueAtTime(this._stoppedValue,t),this._oscillator.stop(t),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(t){t=this._fromType(t),this._scaler.min=t}get max(){return this._toType(this._scaler.max)}set max(t){t=this._fromType(t),this._scaler.max=t}get type(){return this._oscillator.type}set type(t){this._oscillator.type=t,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(t){this._oscillator.partials=t,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(t){this._oscillator.phase=t,this._setStoppedValue()}get units(){return this._units}set units(t){const o=this.min,l=this.max;this._units=t,this.min=o,this.max=l}get state(){return this._oscillator.state}connect(t,o,l){return(t instanceof Et||t instanceof At)&&(this.convert=t.convert,this.units=t.units),xo(this,t,o,l),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}function qu(p,t=1/0){const o=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(v){Le(v,p,t),o.set(this,v)}})}}function gn(p,t=1/0){const o=new WeakMap;return function(l,d){Reflect.defineProperty(l,d,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(v){Le(this.toSeconds(v),p,t),o.set(this,v)}})}}class Fi extends ge{constructor(){const t=K(Fi.getDefaults(),arguments,["url","onload"]);super(t),this.name="Player",this._activeSources=new Set,this._buffer=new qt({onload:this._onload.bind(this,t.onload),onerror:t.onerror,reverse:t.reverse,url:t.url}),this.autostart=t.autostart,this._loop=t.loop,this._loopStart=t.loopStart,this._loopEnd=t.loopEnd,this._playbackRate=t.playbackRate,this.fadeIn=t.fadeIn,this.fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ge.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Dt,onerror:Dt,playbackRate:1,reverse:!1})}load(t){return Kt(this,void 0,void 0,function*(){return yield this._buffer.load(t),this._onload(),this})}_onload(t=Dt){t(),this.autostart&&this.start()}_onSourceEnd(t){this.onstop(this),this._activeSources.delete(t),this._activeSources.size!==0||this._synced||this._state.getValueAtTime(this.now())!=="started"||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(t,o,l){return super.start(t,o,l),this}_start(t,o,l){o=this._loop?As(o,this._loopStart):As(o,0);const d=this.toSeconds(o),v=l;l=As(l,Math.max(this._buffer.duration-d,0));let b=this.toSeconds(l);b/=this._playbackRate,t=this.toSeconds(t);const _=new kn({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(t+b),this._state.setStateAtTime("stopped",t+b,{implicitEnd:!0})),this._activeSources.add(_),this._loop&&os(v)?_.start(t,d):_.start(t,d,b-this.toSeconds(this.fadeOut))}_stop(t){const o=this.toSeconds(t);this._activeSources.forEach(l=>l.stop(o))}restart(t,o,l){return super.restart(t,o,l),this}_restart(t,o,l){var d;(d=[...this._activeSources].pop())===null||d===void 0||d.stop(t),this._start(t,o,l)}seek(t,o){const l=this.toSeconds(o);if(this._state.getValueAtTime(l)==="started"){const d=this.toSeconds(t);this._stop(l),this._start(l,d)}return this}setLoopPoints(t,o){return this.loopStart=t,this.loopEnd=o,this}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this.buffer.loaded&&Le(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(o=>{o.loopStart=t})}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this.buffer.loaded&&Le(this.toSeconds(t),0,this.buffer.duration),this._activeSources.forEach(o=>{o.loopEnd=t})}get buffer(){return this._buffer}set buffer(t){this._buffer.set(t)}get loop(){return this._loop}set loop(t){if(this._loop!==t&&(this._loop=t,this._activeSources.forEach(o=>{o.loop=t}),t)){const o=this._state.getNextState("stopped",this.now());o&&this._state.cancel(o.time)}}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t;const o=this.now(),l=this._state.getNextState("stopped",o);l&&l.implicitEnd&&(this._state.cancel(l.time),this._activeSources.forEach(d=>d.cancelStop())),this._activeSources.forEach(d=>{d.playbackRate.setValueAtTime(t,o)})}get reverse(){return this._buffer.reverse}set reverse(t){this._buffer.reverse=t}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach(t=>t.dispose()),this._activeSources.clear(),this._buffer.dispose(),this}}Fs([gn(0)],Fi.prototype,"fadeIn",void 0),Fs([gn(0)],Fi.prototype,"fadeOut",void 0);class xl extends rt{constructor(){const t=K(xl.getDefaults(),arguments,["urls","onload"],"urls");super(t),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new dn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume"),this._buffers=new Ii({urls:t.urls,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.mute=t.mute,this._fadeIn=t.fadeIn,this._fadeOut=t.fadeOut}static getDefaults(){return Object.assign(ge.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:Dt,onerror:Dt,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}get fadeIn(){return this._fadeIn}set fadeIn(t){this._fadeIn=t,this._players.forEach(o=>{o.fadeIn=t})}get fadeOut(){return this._fadeOut}set fadeOut(t){this._fadeOut=t,this._players.forEach(o=>{o.fadeOut=t})}get state(){return Array.from(this._players).some(([t,o])=>o.state==="started")?"started":"stopped"}has(t){return this._buffers.has(t)}player(t){if(_t(this.has(t),`No Player with the name ${t} exists on this object`),!this._players.has(t)){const o=new Fi({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(t)}).connect(this.output);this._players.set(t,o)}return this._players.get(t)}get loaded(){return this._buffers.loaded}add(t,o,l){return _t(!this._buffers.has(t),"A buffer with that name already exists on this object"),this._buffers.add(t,o,l),this}stopAll(t){return this._players.forEach(o=>o.stop(t)),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach(t=>t.dispose()),this._buffers.dispose(),this}}class Sl extends ge{constructor(){const t=K(Sl.getDefaults(),arguments,["url","onload"]);super(t),this.name="GrainPlayer",this._loopStart=0,this._loopEnd=0,this._activeSources=[],this.buffer=new qt({onload:t.onload,onerror:t.onerror,reverse:t.reverse,url:t.url}),this._clock=new ki({context:this.context,callback:this._tick.bind(this),frequency:1/t.grainSize}),this._playbackRate=t.playbackRate,this._grainSize=t.grainSize,this._overlap=t.overlap,this.detune=t.detune,this.overlap=t.overlap,this.loop=t.loop,this.playbackRate=t.playbackRate,this.grainSize=t.grainSize,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.reverse=t.reverse,this._clock.on("stop",this._onstop.bind(this))}static getDefaults(){return Object.assign(ge.getDefaults(),{onload:Dt,onerror:Dt,overlap:.1,grainSize:.2,playbackRate:1,detune:0,loop:!1,loopStart:0,loopEnd:0,reverse:!1})}_start(t,o,l){o=As(o,0),o=this.toSeconds(o),t=this.toSeconds(t);const d=1/this._clock.frequency.getValueAtTime(t);this._clock.start(t,o/d),l&&this.stop(t+this.toSeconds(l))}restart(t,o,l){return super.restart(t,o,l),this}_restart(t,o,l){this._stop(t),this._start(t,o,l)}_stop(t){this._clock.stop(t)}_onstop(t){this._activeSources.forEach(o=>{o.fadeOut=0,o.stop(t)}),this.onstop(this)}_tick(t){const o=this._clock.getTicksAtTime(t),l=o*this._grainSize;if(this.log("offset",l),!this.loop&&l>this.buffer.duration)return void this.stop(t);const d=l<this._overlap?0:this._overlap,v=new kn({context:this.context,url:this.buffer,fadeIn:d,fadeOut:this._overlap,loop:this.loop,loopStart:this._loopStart,loopEnd:this._loopEnd,playbackRate:Mi(this.detune/100)}).connect(this.output);v.start(t,this._grainSize*o),v.stop(t+this._grainSize/this.playbackRate),this._activeSources.push(v),v.onended=()=>{const b=this._activeSources.indexOf(v);b!==-1&&this._activeSources.splice(b,1)}}get playbackRate(){return this._playbackRate}set playbackRate(t){Le(t,.001),this._playbackRate=t,this.grainSize=this._grainSize}get loopStart(){return this._loopStart}set loopStart(t){this.buffer.loaded&&Le(this.toSeconds(t),0,this.buffer.duration),this._loopStart=this.toSeconds(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this.buffer.loaded&&Le(this.toSeconds(t),0,this.buffer.duration),this._loopEnd=this.toSeconds(t)}get reverse(){return this.buffer.reverse}set reverse(t){this.buffer.reverse=t}get grainSize(){return this._grainSize}set grainSize(t){this._grainSize=this.toSeconds(t),this._clock.frequency.setValueAtTime(this._playbackRate/this._grainSize,this.now())}get overlap(){return this._overlap}set overlap(t){const o=this.toSeconds(t);Le(o,0),this._overlap=o}get loaded(){return this.buffer.loaded}dispose(){return super.dispose(),this.buffer.dispose(),this._clock.dispose(),this._activeSources.forEach(t=>t.dispose()),this}}class zu extends gs{constructor(){super(...arguments),this.name="Abs",this._abs=new $s({context:this.context,mapping:t=>Math.abs(t)<.001?0:Math.abs(t)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class Wu extends gs{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new $s({context:this.context,mapping:t=>2*Math.abs(t)-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Cl extends gs{constructor(){super(...arguments),this.name="Negate",this._multiply=new ue({context:this.context,value:-1}),this.input=this._multiply,this.output=this._multiply}dispose(){return super.dispose(),this._multiply.dispose(),this}}class Qn extends At{constructor(){super(K(Qn.getDefaults(),arguments,["value"])),this.override=!1,this.name="Subtract",this._sum=new wt({context:this.context}),this.input=this._sum,this.output=this._sum,this._neg=new Cl({context:this.context}),this.subtrahend=this._param,ms(this._constantSource,this._neg,this._sum)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._neg.dispose(),this._sum.dispose(),this}}class Ur extends gs{constructor(){super(K(Ur.getDefaults(),arguments)),this.name="GreaterThanZero",this._thresh=this.output=new $s({context:this.context,length:127,mapping:t=>t<=0?0:1}),this._scale=this.input=new ue({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class Xr extends At{constructor(){const t=K(Xr.getDefaults(),arguments,["value"]);super(t),this.name="GreaterThan",this.override=!1,this._subtract=this.input=new Qn({context:this.context,value:t.value}),this._gtz=this.output=new Ur({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,St(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(At.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class Yr extends fn{constructor(){const t=K(Yr.getDefaults(),arguments,["min","max","exponent"]);super(t),this.name="ScaleExp",this.input=this._exp=new Di({context:this.context,value:t.exponent}),this._exp.connect(this._mult)}static getDefaults(){return Object.assign(fn.getDefaults(),{exponent:1})}get exponent(){return this._exp.value}set exponent(t){this._exp.value=t}dispose(){return super.dispose(),this._exp.dispose(),this}}class Sg extends At{constructor(){const t=K(At.getDefaults(),arguments,["value","units"]);super(t),this.name="SyncedSignal",this.override=!1,this._lastVal=t.value,this._synced=this.context.transport.scheduleRepeat(this._onTick.bind(this),"1i"),this._syncedCallback=this._anchorValue.bind(this),this.context.transport.on("start",this._syncedCallback),this.context.transport.on("pause",this._syncedCallback),this.context.transport.on("stop",this._syncedCallback),this._constantSource.disconnect(),this._constantSource.stop(0),this._constantSource=this.output=new Vr({context:this.context,offset:t.value,units:t.units}).start(0),this.setValueAtTime(t.value,0)}_onTick(t){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal!==o&&(this._lastVal=o,this._constantSource.offset.setValueAtTime(o,t))}_anchorValue(t){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal=o,this._constantSource.offset.cancelAndHoldAtTime(t),this._constantSource.offset.setValueAtTime(o,t)}getValueAtTime(t){const o=new xe(this.context,t).toSeconds();return super.getValueAtTime(o)}setValueAtTime(t,o){const l=new xe(this.context,o).toSeconds();return super.setValueAtTime(t,l),this}linearRampToValueAtTime(t,o){const l=new xe(this.context,o).toSeconds();return super.linearRampToValueAtTime(t,l),this}exponentialRampToValueAtTime(t,o){const l=new xe(this.context,o).toSeconds();return super.exponentialRampToValueAtTime(t,l),this}setTargetAtTime(t,o,l){const d=new xe(this.context,o).toSeconds();return super.setTargetAtTime(t,d,l),this}cancelScheduledValues(t){const o=new xe(this.context,t).toSeconds();return super.cancelScheduledValues(o),this}setValueCurveAtTime(t,o,l,d){const v=new xe(this.context,o).toSeconds();return l=this.toSeconds(l),super.setValueCurveAtTime(t,v,l,d),this}cancelAndHoldAtTime(t){const o=new xe(this.context,t).toSeconds();return super.cancelAndHoldAtTime(o),this}setRampPoint(t){const o=new xe(this.context,t).toSeconds();return super.setRampPoint(o),this}exponentialRampTo(t,o,l){const d=new xe(this.context,l).toSeconds();return super.exponentialRampTo(t,o,d),this}linearRampTo(t,o,l){const d=new xe(this.context,l).toSeconds();return super.linearRampTo(t,o,d),this}targetRampTo(t,o,l){const d=new xe(this.context,l).toSeconds();return super.targetRampTo(t,o,d),this}dispose(){return super.dispose(),this.context.transport.clear(this._synced),this.context.transport.off("start",this._syncedCallback),this.context.transport.off("pause",this._syncedCallback),this.context.transport.off("stop",this._syncedCallback),this._constantSource.dispose(),this}}class Be extends rt{constructor(){const t=K(Be.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="Envelope",this._sig=new At({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=t.attack,this.decay=t.decay,this.sustain=t.sustain,this.release=t.release,this.attackCurve=t.attackCurve,this.releaseCurve=t.releaseCurve,this.decayCurve=t.decayCurve}static getDefaults(){return Object.assign(rt.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(t,o){if(Ls(t))return t;{let l;for(l in Zr)if(Zr[l][o]===t)return l;return t}}_setCurve(t,o,l){if(Ls(l)&&Reflect.has(Zr,l)){const d=Zr[l];hn(d)?t!=="_decayCurve"&&(this[t]=d[o]):this[t]=d}else{if(!Ne(l)||t==="_decayCurve")throw new Error("Envelope: invalid curve: "+l);this[t]=l}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(t){this._setCurve("_attackCurve","In",t)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(t){this._setCurve("_releaseCurve","Out",t)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(t){this._setCurve("_decayCurve","Out",t)}triggerAttack(t,o=1){this.log("triggerAttack",t,o),t=this.toSeconds(t);let l=this.toSeconds(this.attack);const d=this.toSeconds(this.decay),v=this.getValueAtTime(t);if(v>0&&(l=(1-v)/(1/l)),l<this.sampleTime)this._sig.cancelScheduledValues(t),this._sig.setValueAtTime(o,t);else if(this._attackCurve==="linear")this._sig.linearRampTo(o,l,t);else if(this._attackCurve==="exponential")this._sig.targetRampTo(o,l,t);else{this._sig.cancelAndHoldAtTime(t);let b=this._attackCurve;for(let _=1;_<b.length;_++)if(b[_-1]<=v&&v<=b[_]){b=this._attackCurve.slice(_),b[0]=v;break}this._sig.setValueCurveAtTime(b,t,l,o)}if(d&&this.sustain<1){const b=o*this.sustain,_=t+l;this.log("decay",_),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(b,d+_):this._sig.exponentialApproachValueAtTime(b,_,d)}return this}triggerRelease(t){this.log("triggerRelease",t),t=this.toSeconds(t);const o=this.getValueAtTime(t);if(o>0){const l=this.toSeconds(this.release);l<this.sampleTime?this._sig.setValueAtTime(0,t):this._releaseCurve==="linear"?this._sig.linearRampTo(0,l,t):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,l,t):(_t(Ne(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(t),this._sig.setValueCurveAtTime(this._releaseCurve,t,l,o))}return this}getValueAtTime(t){return this._sig.getValueAtTime(t)}triggerAttackRelease(t,o,l=1){return o=this.toSeconds(o),this.triggerAttack(o,l),this.triggerRelease(o+this.toSeconds(t)),this}cancel(t){return this._sig.cancelScheduledValues(this.toSeconds(t)),this}connect(t,o=0,l=0){return xo(this,t,o,l),this}asArray(){return Kt(this,arguments,void 0,function*(t=1024){const o=t/this.context.sampleRate,l=new Ti(1,o,this.context.sampleRate),d=this.toSeconds(this.attack)+this.toSeconds(this.decay),v=d+this.toSeconds(this.release),b=.1*v,_=v+b,x=new this.constructor(Object.assign(this.get(),{attack:o*this.toSeconds(this.attack)/_,decay:o*this.toSeconds(this.decay)/_,release:o*this.toSeconds(this.release)/_,context:l}));return x._sig.toDestination(),x.triggerAttackRelease(o*(d+b)/_,0),(yield l.render()).getChannelData(0)})}dispose(){return super.dispose(),this._sig.dispose(),this}}Fs([gn(0)],Be.prototype,"attack",void 0),Fs([gn(0)],Be.prototype,"decay",void 0),Fs([qu(0,1)],Be.prototype,"sustain",void 0),Fs([gn(0)],Be.prototype,"release",void 0);const Zr=(()=>{let t,o;const l=[];for(t=0;t<128;t++)l[t]=Math.sin(t/127*(Math.PI/2));const d=[];for(t=0;t<127;t++){o=t/127;const M=Math.sin(o*(2*Math.PI)*6.4-Math.PI/2)+1;d[t]=M/10+.83*o}d[127]=1;const v=[];for(t=0;t<128;t++)v[t]=Math.ceil(t/127*5)/5;const b=[];for(t=0;t<128;t++)o=t/127,b[t]=.5*(1-Math.cos(Math.PI*o));const _=[];for(t=0;t<128;t++){o=t/127;const M=4*Math.pow(o,3)+.2,k=Math.cos(M*Math.PI*2*o);_[t]=Math.abs(k*(1-o))}function x(M){const k=new Array(M.length);for(let D=0;D<M.length;D++)k[D]=1-M[D];return k}return{bounce:{In:x(_),Out:_},cosine:{In:l,Out:(S=l,S.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:d,Out:x(d)},sine:{In:b,Out:x(b)},step:{In:v,Out:x(v)}};var S})();class Ms extends rt{constructor(){const t=K(Ms.getDefaults(),arguments);super(t),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=o=>this._original_triggerRelease(o),this._volume=this.output=new dn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,St(this,"volume")}static getDefaults(){return Object.assign(rt.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let t=!1;return this._synced||(this._synced=!0,t=!0),t}_syncMethod(t,o){const l=this["_original_"+t]=this[t];this[t]=(...d)=>{const v=d[o],b=this.context.transport.schedule(_=>{d[o]=_,l.apply(this,d)},v);this._scheduledEvents.push(b)}}unsync(){return this._scheduledEvents.forEach(t=>this.context.transport.clear(t)),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(t,o,l,d){const v=this.toSeconds(l),b=this.toSeconds(o);return this.triggerAttack(t,v,d),this.triggerRelease(v+b),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class $e extends Ms{constructor(){const t=K($e.getDefaults(),arguments);super(t),this.portamento=t.portamento,this.onsilence=t.onsilence}static getDefaults(){return Object.assign(Ms.getDefaults(),{detune:0,onsilence:Dt,portamento:0})}triggerAttack(t,o,l=1){this.log("triggerAttack",t,o,l);const d=this.toSeconds(o);return this._triggerEnvelopeAttack(d,l),this.setNote(t,d),this}triggerRelease(t){this.log("triggerRelease",t);const o=this.toSeconds(t);return this._triggerEnvelopeRelease(o),this}setNote(t,o){const l=this.toSeconds(o),d=t instanceof Je?t.toFrequency():t;if(this.portamento>0&&this.getLevelAtTime(l)>.05){const v=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(d,v,l)}else this.frequency.setValueAtTime(d,l);return this}}Fs([gn(0)],$e.prototype,"portamento",void 0);class Bi extends Be{constructor(){super(K(Bi.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new wt({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Rn extends $e{constructor(){const t=K(Rn.getDefaults(),arguments);super(t),this.name="Synth",this.oscillator=new mn(Object.assign({context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)},t.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new Bi(Object.assign({context:this.context},t.envelope)),this.oscillator.chain(this.envelope,this.output),St(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign($e.getDefaults(),{envelope:Object.assign(Fe(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(Fe(mn.getDefaults(),[...Object.keys(ge.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(t,o){if(this.envelope.triggerAttack(t,o),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class Eo extends $e{constructor(){const t=K(Eo.getDefaults(),arguments);super(t),this.name="ModulationSynth",this._carrier=new Rn({context:this.context,oscillator:t.oscillator,envelope:t.envelope,onsilence:()=>this.onsilence(this),volume:-10}),this._modulator=new Rn({context:this.context,oscillator:t.modulation,envelope:t.modulationEnvelope,volume:-10}),this.oscillator=this._carrier.oscillator,this.envelope=this._carrier.envelope,this.modulation=this._modulator.oscillator,this.modulationEnvelope=this._modulator.envelope,this.frequency=new At({context:this.context,units:"frequency"}),this.detune=new At({context:this.context,value:t.detune,units:"cents"}),this.harmonicity=new ue({context:this.context,value:t.harmonicity,minValue:0}),this._modulationNode=new wt({context:this.context,gain:0}),St(this,["frequency","harmonicity","oscillator","envelope","modulation","modulationEnvelope","detune"])}static getDefaults(){return Object.assign($e.getDefaults(),{harmonicity:3,oscillator:Object.assign(Fe(mn.getDefaults(),[...Object.keys(ge.getDefaults()),"frequency","detune"]),{type:"sine"}),envelope:Object.assign(Fe(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.01,decay:.01,sustain:1,release:.5}),modulation:Object.assign(Fe(mn.getDefaults(),[...Object.keys(ge.getDefaults()),"frequency","detune"]),{type:"square"}),modulationEnvelope:Object.assign(Fe(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.5,decay:0,sustain:1,release:.5})})}_triggerEnvelopeAttack(t,o){this._carrier._triggerEnvelopeAttack(t,o),this._modulator._triggerEnvelopeAttack(t,o)}_triggerEnvelopeRelease(t){return this._carrier._triggerEnvelopeRelease(t),this._modulator._triggerEnvelopeRelease(t),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this._carrier.dispose(),this._modulator.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._modulationNode.dispose(),this}}class Tl extends Eo{constructor(){super(K(Tl.getDefaults(),arguments)),this.name="AMSynth",this._modulationScale=new Gr({context:this.context}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output)}dispose(){return super.dispose(),this._modulationScale.dispose(),this}}class Po extends rt{constructor(){const t=K(Po.getDefaults(),arguments,["frequency","type"]);super(t),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new Et({context:this.context,units:"number",value:t.Q,param:this._filter.Q}),this.frequency=new Et({context:this.context,units:"frequency",value:t.frequency,param:this._filter.frequency}),this.detune=new Et({context:this.context,units:"cents",value:t.detune,param:this._filter.detune}),this.gain=new Et({context:this.context,units:"decibels",convert:!1,value:t.gain,param:this._filter.gain}),this.type=t.type}static getDefaults(){return Object.assign(rt.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(t){_t(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._filter.type=t}getFrequencyResponse(t=128){const o=new Float32Array(t);for(let b=0;b<t;b++){const _=19980*Math.pow(b/t,2)+20;o[b]=_}const l=new Float32Array(t),d=new Float32Array(t),v=this.context.createBiquadFilter();return v.type=this.type,v.Q.value=this.Q.value,v.frequency.value=this.frequency.value,v.gain.value=this.gain.value,v.getFrequencyResponse(o,l,d),l}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class vs extends rt{constructor(){const t=K(vs.getDefaults(),arguments,["frequency","type","rolloff"]);super(t),this.name="Filter",this.input=new wt({context:this.context}),this.output=new wt({context:this.context}),this._filters=[],this._filters=[],this.Q=new At({context:this.context,units:"positive",value:t.Q}),this.frequency=new At({context:this.context,units:"frequency",value:t.frequency}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),this.gain=new At({context:this.context,units:"decibels",convert:!1,value:t.gain}),this._type=t.type,this.rolloff=t.rolloff,St(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(rt.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(t){_t(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(t)!==-1,`Invalid filter type: ${t}`),this._type=t,this._filters.forEach(o=>o.type=t)}get rolloff(){return this._rolloff}set rolloff(t){const o=hs(t)?t:parseInt(t,10),l=[-12,-24,-48,-96];let d=l.indexOf(o);_t(d!==-1,`rolloff can only be ${l.join(", ")}`),d+=1,this._rolloff=o,this.input.disconnect(),this._filters.forEach(v=>v.disconnect()),this._filters=new Array(d);for(let v=0;v<d;v++){const b=new Po({context:this.context});b.type=this._type,this.frequency.connect(b.frequency),this.detune.connect(b.detune),this.Q.connect(b.Q),this.gain.connect(b.gain),this._filters[v]=b}this._internalChannels=this._filters,ms(this.input,...this._internalChannels,this.output)}getFrequencyResponse(t=128){const o=new Po({frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),l=new Float32Array(t).map(()=>1);return this._filters.forEach(()=>{o.getFrequencyResponse(t).forEach((d,v)=>l[v]*=d)}),o.dispose(),l}dispose(){return super.dispose(),this._filters.forEach(t=>{t.dispose()}),bo(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class ko extends Be{constructor(){const t=K(ko.getDefaults(),arguments,["attack","decay","sustain","release"]);super(t),this.name="FrequencyEnvelope",this._octaves=t.octaves,this._baseFrequency=this.toFrequency(t.baseFrequency),this._exponent=this.input=new Di({context:this.context,value:t.exponent}),this._scale=this.output=new fn({context:this.context,min:this._baseFrequency,max:this._baseFrequency*Math.pow(2,this._octaves)}),this._sig.chain(this._exponent,this._scale)}static getDefaults(){return Object.assign(Be.getDefaults(),{baseFrequency:200,exponent:1,octaves:4})}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){const o=this.toFrequency(t);Le(o,0),this._baseFrequency=o,this._scale.min=this._baseFrequency,this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._scale.max=this._baseFrequency*Math.pow(2,t)}get exponent(){return this._exponent.value}set exponent(t){this._exponent.value=t}dispose(){return super.dispose(),this._exponent.dispose(),this._scale.dispose(),this}}class Jn extends $e{constructor(){const t=K(Jn.getDefaults(),arguments);super(t),this.name="MonoSynth",this.oscillator=new mn(Object.assign(t.oscillator,{context:this.context,detune:t.detune,onstop:()=>this.onsilence(this)})),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.filter=new vs(Object.assign(t.filter,{context:this.context})),this.filterEnvelope=new ko(Object.assign(t.filterEnvelope,{context:this.context})),this.envelope=new Bi(Object.assign(t.envelope,{context:this.context})),this.oscillator.chain(this.filter,this.envelope,this.output),this.filterEnvelope.connect(this.filter.frequency),St(this,["oscillator","frequency","detune","filter","filterEnvelope","envelope"])}static getDefaults(){return Object.assign($e.getDefaults(),{envelope:Object.assign(Fe(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.9}),filter:Object.assign(Fe(vs.getDefaults(),Object.keys(rt.getDefaults())),{Q:1,rolloff:-12,type:"lowpass"}),filterEnvelope:Object.assign(Fe(ko.getDefaults(),Object.keys(rt.getDefaults())),{attack:.6,baseFrequency:200,decay:.2,exponent:2,octaves:3,release:2,sustain:.5}),oscillator:Object.assign(Fe(mn.getDefaults(),Object.keys(ge.getDefaults())),{type:"sawtooth"})})}_triggerEnvelopeAttack(t,o=1){if(this.envelope.triggerAttack(t,o),this.filterEnvelope.triggerAttack(t),this.oscillator.start(t),this.envelope.sustain===0){const l=this.toSeconds(this.envelope.attack),d=this.toSeconds(this.envelope.decay);this.oscillator.stop(t+l+d)}}_triggerEnvelopeRelease(t){this.envelope.triggerRelease(t),this.filterEnvelope.triggerRelease(t),this.oscillator.stop(t+this.toSeconds(this.envelope.release))}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this.filterEnvelope.dispose(),this.filter.dispose(),this}}class Al extends $e{constructor(){const t=K(Al.getDefaults(),arguments);super(t),this.name="DuoSynth",this.voice0=new Jn(Object.assign(t.voice0,{context:this.context,onsilence:()=>this.onsilence(this)})),this.voice1=new Jn(Object.assign(t.voice1,{context:this.context})),this.harmonicity=new ue({context:this.context,units:"positive",value:t.harmonicity}),this._vibrato=new ts({frequency:t.vibratoRate,context:this.context,min:-50,max:50}),this._vibrato.start(),this.vibratoRate=this._vibrato.frequency,this._vibratoGain=new wt({context:this.context,units:"normalRange",gain:t.vibratoAmount}),this.vibratoAmount=this._vibratoGain.gain,this.frequency=new At({context:this.context,units:"frequency",value:440}),this.detune=new At({context:this.context,units:"cents",value:t.detune}),this.frequency.connect(this.voice0.frequency),this.frequency.chain(this.harmonicity,this.voice1.frequency),this._vibrato.connect(this._vibratoGain),this._vibratoGain.fan(this.voice0.detune,this.voice1.detune),this.detune.fan(this.voice0.detune,this.voice1.detune),this.voice0.connect(this.output),this.voice1.connect(this.output),St(this,["voice0","voice1","frequency","vibratoAmount","vibratoRate"])}getLevelAtTime(t){return t=this.toSeconds(t),this.voice0.envelope.getValueAtTime(t)+this.voice1.envelope.getValueAtTime(t)}static getDefaults(){return Ts($e.getDefaults(),{vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:Ts(Fe(Jn.getDefaults(),Object.keys($e.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}}),voice1:Ts(Fe(Jn.getDefaults(),Object.keys($e.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}})})}_triggerEnvelopeAttack(t,o){this.voice0._triggerEnvelopeAttack(t,o),this.voice1._triggerEnvelopeAttack(t,o)}_triggerEnvelopeRelease(t){return this.voice0._triggerEnvelopeRelease(t),this.voice1._triggerEnvelopeRelease(t),this}dispose(){return super.dispose(),this.voice0.dispose(),this.voice1.dispose(),this.frequency.dispose(),this.detune.dispose(),this._vibrato.dispose(),this.vibratoRate.dispose(),this._vibratoGain.dispose(),this.harmonicity.dispose(),this}}class Ml extends Eo{constructor(){const t=K(Ml.getDefaults(),arguments);super(t),this.name="FMSynth",this.modulationIndex=new ue({context:this.context,value:t.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output)}static getDefaults(){return Object.assign(Eo.getDefaults(),{modulationIndex:10})}dispose(){return super.dispose(),this.modulationIndex.dispose(),this}}const Vu=[1,1.483,1.932,2.546,2.63,3.897];class El extends $e{constructor(){const t=K(El.getDefaults(),arguments);super(t),this.name="MetalSynth",this._oscillators=[],this._freqMultipliers=[],this.detune=new At({context:this.context,units:"cents",value:t.detune}),this.frequency=new At({context:this.context,units:"frequency"}),this._amplitude=new wt({context:this.context,gain:0}).connect(this.output),this._highpass=new vs({Q:0,context:this.context,type:"highpass"}).connect(this._amplitude);for(let o=0;o<Vu.length;o++){const l=new Ni({context:this.context,harmonicity:t.harmonicity,modulationIndex:t.modulationIndex,modulationType:"square",onstop:o===0?()=>this.onsilence(this):Dt,type:"square"});l.connect(this._highpass),this._oscillators[o]=l;const d=new ue({context:this.context,value:Vu[o]});this._freqMultipliers[o]=d,this.frequency.chain(d,l.frequency),this.detune.connect(l.detune)}this._filterFreqScaler=new fn({context:this.context,max:7e3,min:this.toFrequency(t.resonance)}),this.envelope=new Be({attack:t.envelope.attack,attackCurve:"linear",context:this.context,decay:t.envelope.decay,release:t.envelope.release,sustain:0}),this.envelope.chain(this._filterFreqScaler,this._highpass.frequency),this.envelope.connect(this._amplitude.gain),this._octaves=t.octaves,this.octaves=t.octaves}static getDefaults(){return Ts($e.getDefaults(),{envelope:Object.assign(Fe(Be.getDefaults(),Object.keys(rt.getDefaults())),{attack:.001,decay:1.4,release:.2}),harmonicity:5.1,modulationIndex:32,octaves:1.5,resonance:4e3})}_triggerEnvelopeAttack(t,o=1){return this.envelope.triggerAttack(t,o),this._oscillators.forEach(l=>l.start(t)),this.envelope.sustain===0&&this._oscillators.forEach(l=>{l.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay))}),this}_triggerEnvelopeRelease(t){return this.envelope.triggerRelease(t),this._oscillators.forEach(o=>o.stop(t+this.toSeconds(this.envelope.release))),this}getLevelAtTime(t){return t=this.toSeconds(t),this.envelope.getValueAtTime(t)}get modulationIndex(){return this._oscillators[0].modulationIndex.value}set modulationIndex(t){this._oscillators.forEach(o=>o.modulationIndex.value=t)}get harmonicity(){return this._oscillators[0].harmonicity.value}set harmonicity(t){this._oscillators.forEach(o=>o.harmonicity.value=t)}get resonance(){return this._filterFreqScaler.min}set resonance(t){this._filterFreqScaler.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._filterFreqScaler.max=this._filterFreqScaler.min*Math.pow(2,t)}dispose(){return super.dispose(),this._oscillators.forEach(t=>t.dispose()),this._freqMultipliers.forEach(t=>t.dispose()),this.frequency.dispose(),this.detune.dispose(),this._filterFreqScaler.dispose(),this._amplitude.dispose(),this.envelope.dispose(),this._highpass.dispose(),this}}class Io extends Rn{constructor(){const t=K(Io.getDefaults(),arguments);super(t),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=t.pitchDecay,this.octaves=t.octaves,St(this,["oscillator","envelope"])}static getDefaults(){return Ts($e.getDefaults(),Rn.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(t,o){const l=this.toSeconds(o),d=this.toFrequency(t instanceof Je?t.toFrequency():t),v=d*this.octaves;return this.oscillator.frequency.setValueAtTime(v,l),this.oscillator.frequency.exponentialRampToValueAtTime(d,l+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}Fs([qu(0)],Io.prototype,"octaves",void 0),Fs([gn(0)],Io.prototype,"pitchDecay",void 0);class Pl extends Ms{constructor(){const t=K(Pl.getDefaults(),arguments);super(t),this.name="NoiseSynth",this.noise=new In(Object.assign({context:this.context},t.noise)),this.envelope=new Bi(Object.assign({context:this.context},t.envelope)),this.noise.chain(this.envelope,this.output)}static getDefaults(){return Object.assign(Ms.getDefaults(),{envelope:Object.assign(Fe(Be.getDefaults(),Object.keys(rt.getDefaults())),{decay:.1,sustain:0}),noise:Object.assign(Fe(In.getDefaults(),Object.keys(ge.getDefaults())),{type:"white"})})}triggerAttack(t,o=1){return t=this.toSeconds(t),this.envelope.triggerAttack(t,o),this.noise.start(t),this.envelope.sustain===0&&this.noise.stop(t+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay)),this}triggerRelease(t){return t=this.toSeconds(t),this.envelope.triggerRelease(t),this.noise.stop(t+this.toSeconds(this.envelope.release)),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",0),this._syncMethod("triggerRelease",0)),this}triggerAttackRelease(t,o,l=1){return o=this.toSeconds(o),t=this.toSeconds(t),this.triggerAttack(o,l),this.triggerRelease(o+t),this}dispose(){return super.dispose(),this.noise.dispose(),this.envelope.dispose(),this}}const kl=new Set;function Il(p){kl.add(p)}function Hu(p,t){const o=`registerProcessor("${p}", ${t})`;kl.add(o)}class Rl extends rt{constructor(t){super(t),this.name="ToneAudioWorklet",this.workletOptions={},this.onprocessorerror=Dt;const o=URL.createObjectURL(new Blob([Array.from(kl).join(`
`)],{type:"text/javascript"})),l=this._audioWorkletName();this._dummyGain=this.context.createGain(),this._dummyParam=this._dummyGain.gain,this.context.addAudioWorkletModule(o).then(()=>{this.disposed||(this._worklet=this.context.createAudioWorkletNode(l,this.workletOptions),this._worklet.onprocessorerror=this.onprocessorerror.bind(this),this.onReady(this._worklet))})}dispose(){return super.dispose(),this._dummyGain.disconnect(),this._worklet&&(this._worklet.port.postMessage("dispose"),this._worklet.disconnect()),this}}Il(`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`),Il(`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`),Il(`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`);const Gu="feedback-comb-filter";Hu(Gu,`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`);class Ro extends Rl{constructor(){const t=K(Ro.getDefaults(),arguments,["delayTime","resonance"]);super(t),this.name="FeedbackCombFilter",this.input=new wt({context:this.context}),this.output=new wt({context:this.context}),this.delayTime=new Et({context:this.context,value:t.delayTime,units:"time",minValue:0,maxValue:1,param:this._dummyParam,swappable:!0}),this.resonance=new Et({context:this.context,value:t.resonance,units:"normalRange",param:this._dummyParam,swappable:!0}),St(this,["resonance","delayTime"])}_audioWorkletName(){return Gu}static getDefaults(){return Object.assign(rt.getDefaults(),{delayTime:.1,resonance:.5})}onReady(t){ms(this.input,t,this.output);const o=t.parameters.get("delayTime");this.delayTime.setParam(o);const l=t.parameters.get("feedback");this.resonance.setParam(l)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.delayTime.dispose(),this.resonance.dispose(),this}}class Do extends rt{constructor(){const t=K(Do.getDefaults(),arguments,["frequency","type"]);super(t),this.name="OnePoleFilter",this._frequency=t.frequency,this._type=t.type,this.input=new wt({context:this.context}),this.output=new wt({context:this.context}),this._createFilter()}static getDefaults(){return Object.assign(rt.getDefaults(),{frequency:880,type:"lowpass"})}_createFilter(){const t=this._filter,o=this.toFrequency(this._frequency),l=1/(2*Math.PI*o);if(this._type==="lowpass"){const d=1/(l*this.context.sampleRate),v=d-1;this._filter=this.context.createIIRFilter([d,0],[1,v])}else{const d=1/(l*this.context.sampleRate)-1;this._filter=this.context.createIIRFilter([1,-1],[1,d])}this.input.chain(this._filter,this.output),t&&this.context.setTimeout(()=>{this.disposed||(this.input.disconnect(t),t.disconnect())},this.blockTime)}get frequency(){return this._frequency}set frequency(t){this._frequency=t,this._createFilter()}get type(){return this._type}set type(t){this._type=t,this._createFilter()}getFrequencyResponse(t=128){const o=new Float32Array(t);for(let v=0;v<t;v++){const b=19980*Math.pow(v/t,2)+20;o[v]=b}const l=new Float32Array(t),d=new Float32Array(t);return this._filter.getFrequencyResponse(o,l,d),l}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this._filter.disconnect(),this}}class Oo extends rt{constructor(){const t=K(Oo.getDefaults(),arguments,["delayTime","resonance","dampening"]);super(t),this.name="LowpassCombFilter",this._combFilter=this.output=new Ro({context:this.context,delayTime:t.delayTime,resonance:t.resonance}),this.delayTime=this._combFilter.delayTime,this.resonance=this._combFilter.resonance,this._lowpass=this.input=new Do({context:this.context,frequency:t.dampening,type:"lowpass"}),this._lowpass.connect(this._combFilter)}static getDefaults(){return Object.assign(rt.getDefaults(),{dampening:3e3,delayTime:.1,resonance:.5})}get dampening(){return this._lowpass.frequency}set dampening(t){this._lowpass.frequency=t}dispose(){return super.dispose(),this._combFilter.dispose(),this._lowpass.dispose(),this}}class Dl extends Ms{constructor(){const t=K(Dl.getDefaults(),arguments);super(t),this.name="PluckSynth",this._noise=new In({context:this.context,type:"pink"}),this.attackNoise=t.attackNoise,this._lfcf=new Oo({context:this.context,dampening:t.dampening,resonance:t.resonance}),this.resonance=t.resonance,this.release=t.release,this._noise.connect(this._lfcf),this._lfcf.connect(this.output)}static getDefaults(){return Ts(Ms.getDefaults(),{attackNoise:1,dampening:4e3,resonance:.7,release:1})}get dampening(){return this._lfcf.dampening}set dampening(t){this._lfcf.dampening=t}triggerAttack(t,o){const l=this.toFrequency(t);o=this.toSeconds(o);const d=1/l;return this._lfcf.delayTime.setValueAtTime(d,o),this._noise.start(o),this._noise.stop(o+d*this.attackNoise),this._lfcf.resonance.cancelScheduledValues(o),this._lfcf.resonance.setValueAtTime(this.resonance,o),this}triggerRelease(t){return this._lfcf.resonance.linearRampTo(0,this.release,t),this}dispose(){return super.dispose(),this._noise.dispose(),this._lfcf.dispose(),this}}class Ol extends Ms{constructor(){const t=K(Ol.getDefaults(),arguments,["voice","options"]);super(t),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=d=>this.releaseAll(d),_t(!hs(t.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const o=t.voice.getDefaults();this.options=Object.assign(o,t.options),this.voice=t.voice,this.maxPolyphony=t.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const l=this._voices.indexOf(this._dummyVoice);this._voices.splice(l,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(Ms.getDefaults(),{maxPolyphony:32,options:{},voice:Rn})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(t){this._availableVoices.push(t);const o=this._activeVoices.findIndex(l=>l.voice===t);this._activeVoices.splice(o,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const t=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return _t(t instanceof $e,"Voice must extend Monophonic class"),t.connect(this.output),this._voices.push(t),t}wi("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(.95*this._averageActiveVoices,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const t=this._availableVoices.shift(),o=this._voices.indexOf(t);this._voices.splice(o,1),this.context.isOffline||t.dispose()}}_triggerAttack(t,o,l){t.forEach(d=>{const v=new Ri(this.context,d).toMidi(),b=this._getNextAvailableVoice();b&&(b.triggerAttack(d,o,l),this._activeVoices.push({midi:v,voice:b,released:!1}),this.log("triggerAttack",d,o))})}_triggerRelease(t,o){t.forEach(l=>{const d=new Ri(this.context,l).toMidi(),v=this._activeVoices.find(({midi:b,released:_})=>b===d&&!_);v&&(v.voice.triggerRelease(o),v.released=!0,this.log("triggerRelease",l,o))})}_scheduleEvent(t,o,l,d){_t(!this.disposed,"Synth was already disposed"),l<=this.now()?t==="attack"?this._triggerAttack(o,l,d):this._triggerRelease(o,l):this.context.setTimeout(()=>{this.disposed||this._scheduleEvent(t,o,l,d)},l-this.now())}triggerAttack(t,o,l){Array.isArray(t)||(t=[t]);const d=this.toSeconds(o);return this._scheduleEvent("attack",t,d,l),this}triggerRelease(t,o){Array.isArray(t)||(t=[t]);const l=this.toSeconds(o);return this._scheduleEvent("release",t,l),this}triggerAttackRelease(t,o,l,d){const v=this.toSeconds(l);if(this.triggerAttack(t,v,d),Ne(o)){_t(Ne(t),"If the duration is an array, the notes must also be an array");for(let b=0;b<t.length;b++){const _=o[Math.min(b,o.length-1)],x=this.toSeconds(_);_t(x>0,"The duration must be greater than 0"),this.triggerRelease(t[b],v+x)}}else{const b=this.toSeconds(o);_t(b>0,"The duration must be greater than 0"),this.triggerRelease(t,v+b)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(t){const o=Fe(t,["onsilence","context"]);return this.options=Ts(this.options,o),this._voices.forEach(l=>l.set(o)),this._dummyVoice.set(o),this}get(){return this._dummyVoice.get()}releaseAll(t){const o=this.toSeconds(t);return this._activeVoices.forEach(({voice:l})=>{l.triggerRelease(o)}),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach(t=>t.dispose()),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class No extends Ms{constructor(){const t=K(No.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(t),this.name="Sampler",this._activeSources=new Map;const o={};Object.keys(t.urls).forEach(l=>{const d=parseInt(l,10);if(_t(yo(l)||hs(d)&&isFinite(d),`url key is neither a note or midi pitch: ${l}`),yo(l)){const v=new Je(this.context,l).toMidi();o[v]=t.urls[l]}else hs(d)&&isFinite(d)&&(o[d]=t.urls[d])}),this._buffers=new Ii({urls:o,onload:t.onload,baseUrl:t.baseUrl,onerror:t.onerror}),this.attack=t.attack,this.release=t.release,this.curve=t.curve,this._buffers.loaded&&Promise.resolve().then(t.onload)}static getDefaults(){return Object.assign(Ms.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Dt,onerror:Dt,release:.1,urls:{}})}_findClosest(t){let o=0;for(;o<96;){if(this._buffers.has(t+o))return-o;if(this._buffers.has(t-o))return o;o++}throw new Error(`No available buffers for note: ${t}`)}triggerAttack(t,o,l=1){return this.log("triggerAttack",t,o,l),Array.isArray(t)||(t=[t]),t.forEach(d=>{const v=Lu(new Je(this.context,d).toFrequency()),b=Math.round(v),_=v-b,x=this._findClosest(b),S=b-x,M=this._buffers.get(S),k=Mi(x+_),D=new kn({url:M,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:k}).connect(this.output);D.start(o,0,M.duration/k,l),Ne(this._activeSources.get(b))||this._activeSources.set(b,[]),this._activeSources.get(b).push(D),D.onended=()=>{if(this._activeSources&&this._activeSources.has(b)){const N=this._activeSources.get(b),$=N.indexOf(D);$!==-1&&N.splice($,1)}}}),this}triggerRelease(t,o){return this.log("triggerRelease",t,o),Array.isArray(t)||(t=[t]),t.forEach(l=>{const d=new Je(this.context,l).toMidi();if(this._activeSources.has(d)&&this._activeSources.get(d).length){const v=this._activeSources.get(d);o=this.toSeconds(o),v.forEach(b=>{b.stop(o)}),this._activeSources.set(d,[])}}),this}releaseAll(t){const o=this.toSeconds(t);return this._activeSources.forEach(l=>{for(;l.length;)l.shift().stop(o)}),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(t,o,l,d=1){const v=this.toSeconds(l);return this.triggerAttack(t,v,d),Ne(o)?(_t(Ne(t),"notes must be an array when duration is array"),t.forEach((b,_)=>{const x=o[Math.min(_,o.length-1)];this.triggerRelease(b,v+this.toSeconds(x))})):this.triggerRelease(t,v+this.toSeconds(o)),this}add(t,o,l){if(_t(yo(t)||isFinite(t),`note must be a pitch or midi: ${t}`),yo(t)){const d=new Je(this.context,t).toMidi();this._buffers.add(d,o,l)}else this._buffers.add(t,o,l);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach(t=>{t.forEach(o=>o.dispose())}),this._activeSources.clear(),this}}Fs([gn(0)],No.prototype,"attack",void 0),Fs([gn(0)],No.prototype,"release",void 0);class Ys extends Re{constructor(){const t=K(Ys.getDefaults(),arguments,["callback","value"]);super(t),this.name="ToneEvent",this._state=new Ei("stopped"),this._startOffset=0,this._loop=t.loop,this.callback=t.callback,this.value=t.value,this._loopStart=this.toTicks(t.loopStart),this._loopEnd=this.toTicks(t.loopEnd),this._playbackRate=t.playbackRate,this._probability=t.probability,this._humanize=t.humanize,this.mute=t.mute,this._playbackRate=t.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(Re.getDefaults(),{callback:Dt,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(t=-1){this._state.forEachFrom(t,o=>{let l;if(o.state==="started"){o.id!==-1&&this.context.transport.clear(o.id);const d=o.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||hs(this._loop)&&this._loop>1){l=1/0,hs(this._loop)&&(l=this._loop*this._getLoopDuration());const v=this._state.getAfter(d);v!==null&&(l=Math.min(l,v.time-d)),l!==1/0&&(l=new ce(this.context,l));const b=new ce(this.context,this._getLoopDuration());o.id=this.context.transport.scheduleRepeat(this._tick.bind(this),b,new ce(this.context,d),l)}else o.id=this.context.transport.schedule(this._tick.bind(this),new ce(this.context,d))}})}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t}get probability(){return this._probability}set probability(t){this._probability=t}get humanize(){return this._humanize}set humanize(t){this._humanize=t}start(t){const o=this.toTicks(t);return this._state.getValueAtTime(o)==="stopped"&&(this._state.add({id:-1,state:"started",time:o}),this._rescheduleEvents(o)),this}stop(t){this.cancel(t);const o=this.toTicks(t);if(this._state.getValueAtTime(o)==="started"){this._state.setStateAtTime("stopped",o,{id:-1});const l=this._state.getBefore(o);let d=o;l!==null&&(d=l.time),this._rescheduleEvents(d)}return this}cancel(t){t=As(t,-1/0);const o=this.toTicks(t);return this._state.forEachFrom(o,l=>{this.context.transport.clear(l.id)}),this._state.cancel(o),this}_tick(t){const o=this.context.transport.getTicksAtTime(t);if(!this.mute&&this._state.getValueAtTime(o)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let l=.02;al(this.humanize)||(l=this.toSeconds(this.humanize)),t+=(2*Math.random()-1)*l}this.callback(t,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(t){this._loop=t,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._rescheduleEvents()}get loopEnd(){return new ce(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._rescheduleEvents()}get loopStart(){return new ce(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const t=this.context.transport.ticks,o=this._state.get(t);if(o!==null&&o.state==="started"){const l=this._getLoopDuration();return(t-o.time)%l/l}return 0}return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class Lo extends Re{constructor(){const t=K(Lo.getDefaults(),arguments,["callback","interval"]);super(t),this.name="Loop",this._event=new Ys({context:this.context,callback:this._tick.bind(this),loop:!0,loopEnd:t.interval,playbackRate:t.playbackRate,probability:t.probability,humanize:t.humanize}),this.callback=t.callback,this.iterations=t.iterations}static getDefaults(){return Object.assign(Re.getDefaults(),{interval:"4n",callback:Dt,playbackRate:1,iterations:1/0,probability:1,mute:!1,humanize:!1})}start(t){return this._event.start(t),this}stop(t){return this._event.stop(t),this}cancel(t){return this._event.cancel(t),this}_tick(t){this.callback(t)}get state(){return this._event.state}get progress(){return this._event.progress}get interval(){return this._event.loopEnd}set interval(t){this._event.loopEnd=t}get playbackRate(){return this._event.playbackRate}set playbackRate(t){this._event.playbackRate=t}get humanize(){return this._event.humanize}set humanize(t){this._event.humanize=t}get probability(){return this._event.probability}set probability(t){this._event.probability=t}get mute(){return this._event.mute}set mute(t){this._event.mute=t}get iterations(){return this._event.loop===!0?1/0:this._event.loop}set iterations(t){this._event.loop=t===1/0||t}dispose(){return super.dispose(),this._event.dispose(),this}}class Fo extends Ys{constructor(){const t=K(Fo.getDefaults(),arguments,["callback","events"]);super(t),this.name="Part",this._state=new Ei("stopped"),this._events=new Set,this._state.increasing=!0,t.events.forEach(o=>{Ne(o)?this.add(o[0],o[1]):this.add(o)})}static getDefaults(){return Object.assign(Ys.getDefaults(),{events:[]})}start(t,o){const l=this.toTicks(t);if(this._state.getValueAtTime(l)!=="started"){o=As(o,this._loop?this._loopStart:0),o=this._loop?As(o,this._loopStart):As(o,0);const d=this.toTicks(o);this._state.add({id:-1,offset:d,state:"started",time:l}),this._forEach(v=>{this._startNote(v,l,d)})}return this}_startNote(t,o,l){o-=l,this._loop?t.startOffset>=this._loopStart&&t.startOffset<this._loopEnd?(t.startOffset<l&&(o+=this._getLoopDuration()),t.start(new ce(this.context,o))):t.startOffset<this._loopStart&&t.startOffset>=l&&(t.loop=!1,t.start(new ce(this.context,o))):t.startOffset>=l&&t.start(new ce(this.context,o))}get startOffset(){return this._startOffset}set startOffset(t){this._startOffset=t,this._forEach(o=>{o.startOffset+=this._startOffset})}stop(t){const o=this.toTicks(t);return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._forEach(l=>{l.stop(t)}),this}at(t,o){const l=new xe(this.context,t).toTicks(),d=new ce(this.context,1).toSeconds(),v=this._events.values();let b=v.next();for(;!b.done;){const _=b.value;if(Math.abs(l-_.startOffset)<d)return It(o)&&(_.value=o),_;b=v.next()}return It(o)?(this.add(t,o),this.at(t)):null}add(t,o){t instanceof Object&&Reflect.has(t,"time")&&(t=(o=t).time);const l=this.toTicks(t);let d;return o instanceof Ys?(d=o,d.callback=this._tick.bind(this)):d=new Ys({callback:this._tick.bind(this),context:this.context,value:o}),d.startOffset=l,d.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(d),this._restartEvent(d),this}_restartEvent(t){this._state.forEach(o=>{o.state==="started"?this._startNote(t,o.time,o.offset):t.stop(new ce(this.context,o.time))})}remove(t,o){return hn(t)&&t.hasOwnProperty("time")&&(t=(o=t).time),t=this.toTicks(t),this._events.forEach(l=>{l.startOffset===t&&(os(o)||It(o)&&l.value===o)&&(this._events.delete(l),l.dispose())}),this}clear(){return this._forEach(t=>t.dispose()),this._events.clear(),this}cancel(t){return this._forEach(o=>o.cancel(t)),this._state.cancel(this.toTicks(t)),this}_forEach(t){return this._events&&this._events.forEach(o=>{o instanceof Fo?o._forEach(t):t(o)}),this}_setAll(t,o){this._forEach(l=>{l[t]=o})}_tick(t,o){this.mute||this.callback(t,o)}_testLoopBoundries(t){this._loop&&(t.startOffset<this._loopStart||t.startOffset>=this._loopEnd)?t.cancel(0):t.state==="stopped"&&this._restartEvent(t)}get probability(){return this._probability}set probability(t){this._probability=t,this._setAll("probability",t)}get humanize(){return this._humanize}set humanize(t){this._humanize=t,this._setAll("humanize",t)}get loop(){return this._loop}set loop(t){this._loop=t,this._forEach(o=>{o.loopStart=this.loopStart,o.loopEnd=this.loopEnd,o.loop=t,this._testLoopBoundries(o)})}get loopEnd(){return new ce(this.context,this._loopEnd).toSeconds()}set loopEnd(t){this._loopEnd=this.toTicks(t),this._loop&&this._forEach(o=>{o.loopEnd=t,this._testLoopBoundries(o)})}get loopStart(){return new ce(this.context,this._loopStart).toSeconds()}set loopStart(t){this._loopStart=this.toTicks(t),this._loop&&this._forEach(o=>{o.loopStart=this.loopStart,this._testLoopBoundries(o)})}get playbackRate(){return this._playbackRate}set playbackRate(t){this._playbackRate=t,this._setAll("playbackRate",t)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}function*Cg(p){let t=0;for(;t<p;)t=Xn(t,0,p-1),yield t,t++}function*Tg(p){let t=p-1;for(;t>=0;)t=Xn(t,0,p-1),yield t,t--}function*Bo(p,t){for(;;)yield*t(p)}function*ju(p,t){let o=t?0:p-1;for(;;)o=Xn(o,0,p-1),yield o,t?(o++,o>=p-1&&(t=!1)):(o--,o<=0&&(t=!0))}function*Ag(p){let t=0,o=0;for(;t<p;)t=Xn(t,0,p-1),yield t,o++,t+=o%2?2:-1}function*Mg(p){let t=p-1,o=0;for(;t>=0;)t=Xn(t,0,p-1),yield t,o++,t+=o%2?-2:1}function*Eg(p){const t=[];for(let o=0;o<p;o++)t.push(o);for(;t.length>0;)yield Xn(t.splice(Math.floor(t.length*Math.random()),1)[0],0,p-1)}function*Uu(p,t="up",o=0){switch(_t(p>=1,"The number of values must be at least one"),t){case"up":yield*Bo(p,Cg);case"down":yield*Bo(p,Tg);case"upDown":yield*ju(p,!0);case"downUp":yield*ju(p,!1);case"alternateUp":yield*Bo(p,Ag);case"alternateDown":yield*Bo(p,Mg);case"random":yield*function*(l){for(;;)yield Math.floor(Math.random()*l)}(p);case"randomOnce":yield*Bo(p,Eg);case"randomWalk":yield*function*(l){let d=Math.floor(Math.random()*l);for(;;)d===0?d++:d===l-1||Math.random()<.5?d--:d++,yield d}(p)}}class Nl extends Lo{constructor(){const t=K(Nl.getDefaults(),arguments,["callback","values","pattern"]);super(t),this.name="Pattern",this.callback=t.callback,this._values=t.values,this._pattern=Uu(t.values.length,t.pattern),this._type=t.pattern}static getDefaults(){return Object.assign(Lo.getDefaults(),{pattern:"up",values:[],callback:Dt})}_tick(t){const o=this._pattern.next();this._index=o.value,this._value=this._values[o.value],this.callback(t,this._value)}get values(){return this._values}set values(t){this._values=t,this.pattern=this._type}get value(){return this._value}get index(){return this._index}get pattern(){return this._type}set pattern(t){this._type=t,this._pattern=Uu(this._values.length,this._type)}}class Ll extends Ys{constructor(){const t=K(Ll.getDefaults(),arguments,["callback","events","subdivision"]);super(t),this.name="Sequence",this._part=new Fo({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[],this._subdivision=this.toTicks(t.subdivision),this.events=t.events,this.loop=t.loop,this.loopStart=t.loopStart,this.loopEnd=t.loopEnd,this.playbackRate=t.playbackRate,this.probability=t.probability,this.humanize=t.humanize,this.mute=t.mute,this.playbackRate=t.playbackRate}static getDefaults(){return Object.assign(Fe(Ys.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(t,o){o===null||this.mute||this.callback(t,o)}get events(){return this._events}set events(t){this.clear(),this._eventsArray=t,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(t,o){return this._part.start(t,o&&this._indexTime(o)),this}stop(t){return this._part.stop(t),this}get subdivision(){return new ce(this.context,this._subdivision).toSeconds()}_createSequence(t){return new Proxy(t,{get:(o,l)=>o[l],set:(o,l,d)=>(Ls(l)&&isFinite(parseInt(l,10))&&Ne(d)?o[l]=this._createSequence(d):o[l]=d,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(t,o,l){t.forEach((d,v)=>{const b=v*o+l;if(Ne(d))this._rescheduleSequence(d,o/d.length,b);else{const _=new ce(this.context,b,"i").toSeconds();this._part.add(_,d)}})}_indexTime(t){return new ce(this.context,t*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(t){this._part.loop=t}get loopStart(){return this._loopStart}set loopStart(t){this._loopStart=t,this._part.loopStart=this._indexTime(t)}get loopEnd(){return this._loopEnd}set loopEnd(t){this._loopEnd=t,this._part.loopEnd=t===0?this._indexTime(this._eventsArray.length):this._indexTime(t)}get startOffset(){return this._part.startOffset}set startOffset(t){this._part.startOffset=t}get playbackRate(){return this._part.playbackRate}set playbackRate(t){this._part.playbackRate=t}get probability(){return this._part.probability}set probability(t){this._part.probability=t}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(t){this._part.humanize=t}get length(){return this._part.length}}class $i extends rt{constructor(){const t=K($i.getDefaults(),arguments,["fade"]);super(t),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new Wu({context:this.context}),this.a=new wt({context:this.context,gain:0}),this.b=new wt({context:this.context,gain:0}),this.output=new wt({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new At({context:this.context,units:"normalRange",value:t.fade}),St(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",Ke(this._split,this.a.gain,0),Ke(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(rt.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class Ae extends rt{constructor(t){super(t),this.name="Effect",this._dryWet=new $i({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new wt({context:this.context}),this.effectReturn=new wt({context:this.context}),this.input=new wt({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(t.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],St(this,"wet")}static getDefaults(){return Object.assign(rt.getDefaults(),{wet:1})}connectEffect(t){return this._internalChannels.push(t),this.effectSend.chain(t,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class Qr extends Ae{constructor(t){super(t),this.name="LFOEffect",this._lfo=new ts({context:this.context,frequency:t.frequency,amplitude:t.depth}),this.depth=this._lfo.amplitude,this.frequency=this._lfo.frequency,this.type=t.type,St(this,["frequency","depth"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{frequency:1,type:"sine",depth:1})}start(t){return this._lfo.start(t),this}stop(t){return this._lfo.stop(t),this}sync(){return this._lfo.sync(),this}unsync(){return this._lfo.unsync(),this}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Fl extends Qr{constructor(){const t=K(Fl.getDefaults(),arguments,["frequency","baseFrequency","octaves"]);super(t),this.name="AutoFilter",this.filter=new vs(Object.assign(t.filter,{context:this.context})),this.connectEffect(this.filter),this._lfo.connect(this.filter.frequency),this.octaves=t.octaves,this.baseFrequency=t.baseFrequency}static getDefaults(){return Object.assign(Qr.getDefaults(),{baseFrequency:200,octaves:2.6,filter:{type:"lowpass",rolloff:-12,Q:1}})}get baseFrequency(){return this._lfo.min}set baseFrequency(t){this._lfo.min=this.toFrequency(t),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._lfo.max=this._lfo.min*Math.pow(2,t)}dispose(){return super.dispose(),this.filter.dispose(),this}}class $o extends rt{constructor(){const t=K($o.getDefaults(),arguments,["pan"]);super(t),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Et({context:this.context,param:this._panner.pan,value:t.pan,minValue:-1,maxValue:1}),this._panner.channelCount=t.channelCount,this._panner.channelCountMode="explicit",St(this,"pan")}static getDefaults(){return Object.assign(rt.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}class Bl extends Qr{constructor(){const t=K(Bl.getDefaults(),arguments,["frequency"]);super(t),this.name="AutoPanner",this._panner=new $o({context:this.context,channelCount:t.channelCount}),this.connectEffect(this._panner),this._lfo.connect(this._panner.pan),this._lfo.min=-1,this._lfo.max=1}static getDefaults(){return Object.assign(Qr.getDefaults(),{channelCount:1})}dispose(){return super.dispose(),this._panner.dispose(),this}}class qo extends rt{constructor(){const t=K(qo.getDefaults(),arguments,["smoothing"]);super(t),this.name="Follower",this._abs=this.input=new zu({context:this.context}),this._lowpass=this.output=new Do({context:this.context,frequency:1/this.toSeconds(t.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=t.smoothing}static getDefaults(){return Object.assign(rt.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(t){this._smoothing=t,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class $l extends Ae{constructor(){const t=K($l.getDefaults(),arguments,["baseFrequency","octaves","sensitivity"]);super(t),this.name="AutoWah",this._follower=new qo({context:this.context,smoothing:t.follower}),this._sweepRange=new Yr({context:this.context,min:0,max:1,exponent:.5}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this._inputBoost=new wt({context:this.context}),this._bandpass=new vs({context:this.context,rolloff:-48,frequency:0,Q:t.Q}),this._peaking=new vs({context:this.context,type:"peaking"}),this._peaking.gain.value=t.gain,this.gain=this._peaking.gain,this.Q=this._bandpass.Q,this.effectSend.chain(this._inputBoost,this._follower,this._sweepRange),this._sweepRange.connect(this._bandpass.frequency),this._sweepRange.connect(this._peaking.frequency),this.effectSend.chain(this._bandpass,this._peaking,this.effectReturn),this._setSweepRange(),this.sensitivity=t.sensitivity,St(this,["gain","Q"])}static getDefaults(){return Object.assign(Ae.getDefaults(),{baseFrequency:100,octaves:6,sensitivity:0,Q:2,gain:2,follower:.2})}get octaves(){return this._octaves}set octaves(t){this._octaves=t,this._setSweepRange()}get follower(){return this._follower.smoothing}set follower(t){this._follower.smoothing=t}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._setSweepRange()}get sensitivity(){return _o(1/this._inputBoost.gain.value)}set sensitivity(t){this._inputBoost.gain.value=1/Ai(t)}_setSweepRange(){this._sweepRange.min=this._baseFrequency,this._sweepRange.max=Math.min(this._baseFrequency*Math.pow(2,this._octaves),this.context.sampleRate/2)}dispose(){return super.dispose(),this._follower.dispose(),this._sweepRange.dispose(),this._bandpass.dispose(),this._peaking.dispose(),this._inputBoost.dispose(),this}}const Xu="bit-crusher";Hu(Xu,`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`);class ql extends Ae{constructor(){const t=K(ql.getDefaults(),arguments,["bits"]);super(t),this.name="BitCrusher",this._bitCrusherWorklet=new zl({context:this.context,bits:t.bits}),this.connectEffect(this._bitCrusherWorklet),this.bits=this._bitCrusherWorklet.bits}static getDefaults(){return Object.assign(Ae.getDefaults(),{bits:4})}dispose(){return super.dispose(),this._bitCrusherWorklet.dispose(),this}}class zl extends Rl{constructor(){const t=K(zl.getDefaults(),arguments);super(t),this.name="BitCrusherWorklet",this.input=new wt({context:this.context}),this.output=new wt({context:this.context}),this.bits=new Et({context:this.context,value:t.bits,units:"positive",minValue:1,maxValue:16,param:this._dummyParam,swappable:!0})}static getDefaults(){return Object.assign(Rl.getDefaults(),{bits:12})}_audioWorkletName(){return Xu}onReady(t){ms(this.input,t,this.output);const o=t.parameters.get("bits");this.bits.setParam(o)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.bits.dispose(),this}}class Wl extends Ae{constructor(){const t=K(Wl.getDefaults(),arguments,["order"]);super(t),this.name="Chebyshev",this._shaper=new $s({context:this.context,length:4096}),this._order=t.order,this.connectEffect(this._shaper),this.order=t.order,this.oversample=t.oversample}static getDefaults(){return Object.assign(Ae.getDefaults(),{order:1,oversample:"none"})}_getCoefficient(t,o,l){return l.has(o)||(o===0?l.set(o,0):o===1?l.set(o,t):l.set(o,2*t*this._getCoefficient(t,o-1,l)-this._getCoefficient(t,o-2,l))),l.get(o)}get order(){return this._order}set order(t){_t(Number.isInteger(t),"'order' must be an integer"),this._order=t,this._shaper.setMap(o=>this._getCoefficient(o,t,new Map))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Kn extends rt{constructor(){const t=K(Kn.getDefaults(),arguments,["channels"]);super(t),this.name="Split",this._splitter=this.input=this.output=this.context.createChannelSplitter(t.channels),this._internalChannels=[this._splitter]}static getDefaults(){return Object.assign(rt.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._splitter.disconnect(),this}}class Dn extends rt{constructor(){const t=K(Dn.getDefaults(),arguments,["channels"]);super(t),this.name="Merge",this._merger=this.output=this.input=this.context.createChannelMerger(t.channels)}static getDefaults(){return Object.assign(rt.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._merger.disconnect(),this}}class Zs extends rt{constructor(t){super(t),this.name="StereoEffect",this.input=new wt({context:this.context}),this.input.channelCount=2,this.input.channelCountMode="explicit",this._dryWet=this.output=new $i({context:this.context,fade:t.wet}),this.wet=this._dryWet.fade,this._split=new Kn({context:this.context,channels:2}),this._merge=new Dn({context:this.context,channels:2}),this.input.connect(this._split),this.input.connect(this._dryWet.a),this._merge.connect(this._dryWet.b),St(this,["wet"])}connectEffectLeft(...t){this._split.connect(t[0],0,0),ms(...t),Ke(t[t.length-1],this._merge,0,0)}connectEffectRight(...t){this._split.connect(t[0],1,0),ms(...t),Ke(t[t.length-1],this._merge,0,1)}static getDefaults(){return Object.assign(rt.getDefaults(),{wet:1})}dispose(){return super.dispose(),this._dryWet.dispose(),this._split.dispose(),this._merge.dispose(),this}}class Vl extends Zs{constructor(t){super(t),this.feedback=new At({context:this.context,value:t.feedback,units:"normalRange"}),this._feedbackL=new wt({context:this.context}),this._feedbackR=new wt({context:this.context}),this._feedbackSplit=new Kn({context:this.context,channels:2}),this._feedbackMerge=new Dn({context:this.context,channels:2}),this._merge.connect(this._feedbackSplit),this._feedbackMerge.connect(this._split),this._feedbackSplit.connect(this._feedbackL,0,0),this._feedbackL.connect(this._feedbackMerge,0,0),this._feedbackSplit.connect(this._feedbackR,1,0),this._feedbackR.connect(this._feedbackMerge,0,1),this.feedback.fan(this._feedbackL.gain,this._feedbackR.gain),St(this,["feedback"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{feedback:.5})}dispose(){return super.dispose(),this.feedback.dispose(),this._feedbackL.dispose(),this._feedbackR.dispose(),this._feedbackSplit.dispose(),this._feedbackMerge.dispose(),this}}class Hl extends Vl{constructor(){const t=K(Hl.getDefaults(),arguments,["frequency","delayTime","depth"]);super(t),this.name="Chorus",this._depth=t.depth,this._delayTime=t.delayTime/1e3,this._lfoL=new ts({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new ts({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._delayNodeL=new fs({context:this.context}),this._delayNodeR=new fs({context:this.context}),this.frequency=this._lfoL.frequency,St(this,["frequency"]),this._lfoL.frequency.connect(this._lfoR.frequency),this.connectEffectLeft(this._delayNodeL),this.connectEffectRight(this._delayNodeR),this._lfoL.connect(this._delayNodeL.delayTime),this._lfoR.connect(this._delayNodeR.delayTime),this.depth=this._depth,this.type=t.type,this.spread=t.spread}static getDefaults(){return Object.assign(Vl.getDefaults(),{frequency:1.5,delayTime:3.5,depth:.7,type:"sine",spread:180,feedback:0,wet:.5})}get depth(){return this._depth}set depth(t){this._depth=t;const o=this._delayTime*t;this._lfoL.min=Math.max(this._delayTime-o,0),this._lfoL.max=this._delayTime+o,this._lfoR.min=Math.max(this._delayTime-o,0),this._lfoR.max=this._delayTime+o}get delayTime(){return 1e3*this._delayTime}set delayTime(t){this._delayTime=t/1e3,this.depth=this._depth}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._delayNodeL.dispose(),this._delayNodeR.dispose(),this.frequency.dispose(),this}}class Gl extends Ae{constructor(){const t=K(Gl.getDefaults(),arguments,["distortion"]);super(t),this.name="Distortion",this._shaper=new $s({context:this.context,length:4096}),this._distortion=t.distortion,this.connectEffect(this._shaper),this.distortion=t.distortion,this.oversample=t.oversample}static getDefaults(){return Object.assign(Ae.getDefaults(),{distortion:.4,oversample:"none"})}get distortion(){return this._distortion}set distortion(t){this._distortion=t;const o=100*t,l=Math.PI/180;this._shaper.setMap(d=>Math.abs(d)<.001?0:(3+o)*d*20*l/(Math.PI+o*Math.abs(d)))}get oversample(){return this._shaper.oversample}set oversample(t){this._shaper.oversample=t}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Jr extends Ae{constructor(t){super(t),this.name="FeedbackEffect",this._feedbackGain=new wt({context:this.context,gain:t.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,St(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(Ae.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class jl extends Jr{constructor(){const t=K(jl.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="FeedbackDelay",this._delayNode=new fs({context:this.context,delayTime:t.delayTime,maxDelay:t.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),St(this,"delayTime")}static getDefaults(){return Object.assign(Jr.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class Pg extends rt{constructor(t){super(t),this.name="PhaseShiftAllpass",this.input=new wt({context:this.context}),this.output=new wt({context:this.context}),this.offset90=new wt({context:this.context}),this._bank0=this._createAllPassFilterBank([.6923878,.9360654322959,.988229522686,.9987488452737]),this._bank1=this._createAllPassFilterBank([.4021921162426,.856171088242,.9722909545651,.9952884791278]),this._oneSampleDelay=this.context.createIIRFilter([0,1],[1,0]),ms(this.input,...this._bank0,this._oneSampleDelay,this.output),ms(this.input,...this._bank1,this.offset90)}_createAllPassFilterBank(t){return t.map(o=>{const l=[[o*o,0,-1],[1,0,-o*o]];return this.context.createIIRFilter(l[0],l[1])})}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.offset90.dispose(),this._bank0.forEach(t=>t.disconnect()),this._bank1.forEach(t=>t.disconnect()),this._oneSampleDelay.disconnect(),this}}class Ul extends Ae{constructor(){const t=K(Ul.getDefaults(),arguments,["frequency"]);super(t),this.name="FrequencyShifter",this.frequency=new At({context:this.context,units:"frequency",value:t.frequency,minValue:-this.context.sampleRate/2,maxValue:this.context.sampleRate/2}),this._sine=new Co({context:this.context,type:"sine"}),this._cosine=new he({context:this.context,phase:-90,type:"sine"}),this._sineMultiply=new ue({context:this.context}),this._cosineMultiply=new ue({context:this.context}),this._negate=new Cl({context:this.context}),this._add=new Zn({context:this.context}),this._phaseShifter=new Pg({context:this.context}),this.effectSend.connect(this._phaseShifter),this.frequency.fan(this._sine.frequency,this._cosine.frequency),this._phaseShifter.offset90.connect(this._cosineMultiply),this._cosine.connect(this._cosineMultiply.factor),this._phaseShifter.connect(this._sineMultiply),this._sine.connect(this._sineMultiply.factor),this._sineMultiply.connect(this._negate),this._cosineMultiply.connect(this._add),this._negate.connect(this._add.addend),this._add.connect(this.effectReturn);const o=this.immediate();this._sine.start(o),this._cosine.start(o)}static getDefaults(){return Object.assign(Ae.getDefaults(),{frequency:0})}dispose(){return super.dispose(),this.frequency.dispose(),this._add.dispose(),this._cosine.dispose(),this._cosineMultiply.dispose(),this._negate.dispose(),this._phaseShifter.dispose(),this._sine.dispose(),this._sineMultiply.dispose(),this}}const Yu=[1557/44100,1617/44100,1491/44100,1422/44100,1277/44100,1356/44100,1188/44100,1116/44100],Zu=[225,556,441,341];class Xl extends Zs{constructor(){const t=K(Xl.getDefaults(),arguments,["roomSize","dampening"]);super(t),this.name="Freeverb",this._combFilters=[],this._allpassFiltersL=[],this._allpassFiltersR=[],this.roomSize=new At({context:this.context,value:t.roomSize,units:"normalRange"}),this._allpassFiltersL=Zu.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._allpassFiltersR=Zu.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._combFilters=Yu.map((o,l)=>{const d=new Oo({context:this.context,dampening:t.dampening,delayTime:o});return l<Yu.length/2?this.connectEffectLeft(d,...this._allpassFiltersL):this.connectEffectRight(d,...this._allpassFiltersR),this.roomSize.connect(d.resonance),d}),St(this,["roomSize"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{roomSize:.7,dampening:3e3})}get dampening(){return this._combFilters[0].dampening}set dampening(t){this._combFilters.forEach(o=>o.dampening=t)}dispose(){return super.dispose(),this._allpassFiltersL.forEach(t=>t.disconnect()),this._allpassFiltersR.forEach(t=>t.disconnect()),this._combFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this}}const Qu=[.06748,.06404,.08212,.09004],kg=[.773,.802,.753,.733],Ig=[347,113,37];class Yl extends Zs{constructor(){const t=K(Yl.getDefaults(),arguments,["roomSize"]);super(t),this.name="JCReverb",this._allpassFilters=[],this._feedbackCombFilters=[],this.roomSize=new At({context:this.context,value:t.roomSize,units:"normalRange"}),this._scaleRoomSize=new fn({context:this.context,min:-.733,max:.197}),this._allpassFilters=Ig.map(o=>{const l=this.context.createBiquadFilter();return l.type="allpass",l.frequency.value=o,l}),this._feedbackCombFilters=Qu.map((o,l)=>{const d=new Ro({context:this.context,delayTime:o});return this._scaleRoomSize.connect(d.resonance),d.resonance.value=kg[l],l<Qu.length/2?this.connectEffectLeft(...this._allpassFilters,d):this.connectEffectRight(...this._allpassFilters,d),d}),this.roomSize.connect(this._scaleRoomSize),St(this,["roomSize"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{roomSize:.5})}dispose(){return super.dispose(),this._allpassFilters.forEach(t=>t.disconnect()),this._feedbackCombFilters.forEach(t=>t.dispose()),this.roomSize.dispose(),this._scaleRoomSize.dispose(),this}}class Ju extends Vl{constructor(t){super(t),this._feedbackL.disconnect(),this._feedbackL.connect(this._feedbackMerge,0,1),this._feedbackR.disconnect(),this._feedbackR.connect(this._feedbackMerge,0,0),St(this,["feedback"])}}class Zl extends Ju{constructor(){const t=K(Zl.getDefaults(),arguments,["delayTime","feedback"]);super(t),this.name="PingPongDelay",this._leftDelay=new fs({context:this.context,maxDelay:t.maxDelay}),this._rightDelay=new fs({context:this.context,maxDelay:t.maxDelay}),this._rightPreDelay=new fs({context:this.context,maxDelay:t.maxDelay}),this.delayTime=new At({context:this.context,units:"time",value:t.delayTime}),this.connectEffectLeft(this._leftDelay),this.connectEffectRight(this._rightPreDelay,this._rightDelay),this.delayTime.fan(this._leftDelay.delayTime,this._rightDelay.delayTime,this._rightPreDelay.delayTime),this._feedbackL.disconnect(),this._feedbackL.connect(this._rightDelay),St(this,["delayTime"])}static getDefaults(){return Object.assign(Ju.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._leftDelay.dispose(),this._rightDelay.dispose(),this._rightPreDelay.dispose(),this.delayTime.dispose(),this}}class Ql extends Jr{constructor(){const t=K(Ql.getDefaults(),arguments,["pitch"]);super(t),this.name="PitchShift",this._frequency=new At({context:this.context}),this._delayA=new fs({maxDelay:1,context:this.context}),this._lfoA=new ts({context:this.context,min:0,max:.1,type:"sawtooth"}).connect(this._delayA.delayTime),this._delayB=new fs({maxDelay:1,context:this.context}),this._lfoB=new ts({context:this.context,min:0,max:.1,type:"sawtooth",phase:180}).connect(this._delayB.delayTime),this._crossFade=new $i({context:this.context}),this._crossFadeLFO=new ts({context:this.context,min:0,max:1,type:"triangle",phase:90}).connect(this._crossFade.fade),this._feedbackDelay=new fs({delayTime:t.delayTime,context:this.context}),this.delayTime=this._feedbackDelay.delayTime,St(this,"delayTime"),this._pitch=t.pitch,this._windowSize=t.windowSize,this._delayA.connect(this._crossFade.a),this._delayB.connect(this._crossFade.b),this._frequency.fan(this._lfoA.frequency,this._lfoB.frequency,this._crossFadeLFO.frequency),this.effectSend.fan(this._delayA,this._delayB),this._crossFade.chain(this._feedbackDelay,this.effectReturn);const o=this.now();this._lfoA.start(o),this._lfoB.start(o),this._crossFadeLFO.start(o),this.windowSize=this._windowSize}static getDefaults(){return Object.assign(Jr.getDefaults(),{pitch:0,windowSize:.1,delayTime:0,feedback:0})}get pitch(){return this._pitch}set pitch(t){this._pitch=t;let o=0;t<0?(this._lfoA.min=0,this._lfoA.max=this._windowSize,this._lfoB.min=0,this._lfoB.max=this._windowSize,o=Mi(t-1)+1):(this._lfoA.min=this._windowSize,this._lfoA.max=0,this._lfoB.min=this._windowSize,this._lfoB.max=0,o=Mi(t)-1),this._frequency.value=o*(1.2/this._windowSize)}get windowSize(){return this._windowSize}set windowSize(t){this._windowSize=this.toSeconds(t),this.pitch=this._pitch}dispose(){return super.dispose(),this._frequency.dispose(),this._delayA.dispose(),this._delayB.dispose(),this._lfoA.dispose(),this._lfoB.dispose(),this._crossFade.dispose(),this._crossFadeLFO.dispose(),this._feedbackDelay.dispose(),this}}class Jl extends Zs{constructor(){const t=K(Jl.getDefaults(),arguments,["frequency","octaves","baseFrequency"]);super(t),this.name="Phaser",this._lfoL=new ts({context:this.context,frequency:t.frequency,min:0,max:1}),this._lfoR=new ts({context:this.context,frequency:t.frequency,min:0,max:1,phase:180}),this._baseFrequency=this.toFrequency(t.baseFrequency),this._octaves=t.octaves,this.Q=new At({context:this.context,value:t.Q,units:"positive"}),this._filtersL=this._makeFilters(t.stages,this._lfoL),this._filtersR=this._makeFilters(t.stages,this._lfoR),this.frequency=this._lfoL.frequency,this.frequency.value=t.frequency,this.connectEffectLeft(...this._filtersL),this.connectEffectRight(...this._filtersR),this._lfoL.frequency.connect(this._lfoR.frequency),this.baseFrequency=t.baseFrequency,this.octaves=t.octaves,this._lfoL.start(),this._lfoR.start(),St(this,["frequency","Q"])}static getDefaults(){return Object.assign(Zs.getDefaults(),{frequency:.5,octaves:3,stages:10,Q:10,baseFrequency:350})}_makeFilters(t,o){const l=[];for(let d=0;d<t;d++){const v=this.context.createBiquadFilter();v.type="allpass",this.Q.connect(v.Q),o.connect(v.frequency),l.push(v)}return l}get octaves(){return this._octaves}set octaves(t){this._octaves=t;const o=this._baseFrequency*Math.pow(2,t);this._lfoL.max=o,this._lfoR.max=o}get baseFrequency(){return this._baseFrequency}set baseFrequency(t){this._baseFrequency=this.toFrequency(t),this._lfoL.min=this._baseFrequency,this._lfoR.min=this._baseFrequency,this.octaves=this._octaves}dispose(){return super.dispose(),this.Q.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._filtersL.forEach(t=>t.disconnect()),this._filtersR.forEach(t=>t.disconnect()),this.frequency.dispose(),this}}class Kl extends Ae{constructor(){const t=K(Kl.getDefaults(),arguments,["decay"]);super(t),this.name="Reverb",this._convolver=this.context.createConvolver(),this.ready=Promise.resolve(),this._decay=t.decay,this._preDelay=t.preDelay,this.generate(),this.connectEffect(this._convolver)}static getDefaults(){return Object.assign(Ae.getDefaults(),{decay:1.5,preDelay:.01})}get decay(){return this._decay}set decay(t){Le(t=this.toSeconds(t),.001),this._decay=t,this.generate()}get preDelay(){return this._preDelay}set preDelay(t){Le(t=this.toSeconds(t),0),this._preDelay=t,this.generate()}generate(){return Kt(this,void 0,void 0,function*(){const t=this.ready,o=new Ti(2,this._decay+this._preDelay,this.context.sampleRate),l=new In({context:o}),d=new In({context:o}),v=new Dn({context:o});l.connect(v,0,0),d.connect(v,0,1);const b=new wt({context:o}).toDestination();v.connect(b),l.start(0),d.start(0),b.gain.setValueAtTime(0,0),b.gain.setValueAtTime(1,this._preDelay),b.gain.exponentialApproachValueAtTime(0,this._preDelay,this.decay);const _=o.render();return this.ready=_.then(Dt),yield t,this._convolver.buffer=(yield _).get(),this})}dispose(){return super.dispose(),this._convolver.disconnect(),this}}class zo extends rt{constructor(){super(K(zo.getDefaults(),arguments)),this.name="MidSideSplit",this._split=this.input=new Kn({channels:2,context:this.context}),this._midAdd=new Zn({context:this.context}),this.mid=new ue({context:this.context,value:Math.SQRT1_2}),this._sideSubtract=new Qn({context:this.context}),this.side=new ue({context:this.context,value:Math.SQRT1_2}),this._split.connect(this._midAdd,0),this._split.connect(this._midAdd.addend,1),this._split.connect(this._sideSubtract,0),this._split.connect(this._sideSubtract.subtrahend,1),this._midAdd.connect(this.mid),this._sideSubtract.connect(this.side)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midAdd.dispose(),this._sideSubtract.dispose(),this._split.dispose(),this}}class Wo extends rt{constructor(){super(K(Wo.getDefaults(),arguments)),this.name="MidSideMerge",this.mid=new wt({context:this.context}),this.side=new wt({context:this.context}),this._left=new Zn({context:this.context}),this._leftMult=new ue({context:this.context,value:Math.SQRT1_2}),this._right=new Qn({context:this.context}),this._rightMult=new ue({context:this.context,value:Math.SQRT1_2}),this._merge=this.output=new Dn({context:this.context}),this.mid.fan(this._left),this.side.connect(this._left.addend),this.mid.connect(this._right),this.side.connect(this._right.subtrahend),this._left.connect(this._leftMult),this._right.connect(this._rightMult),this._leftMult.connect(this._merge,0,0),this._rightMult.connect(this._merge,0,1)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._leftMult.dispose(),this._rightMult.dispose(),this._left.dispose(),this._right.dispose(),this}}class Ku extends Ae{constructor(t){super(t),this.name="MidSideEffect",this._midSideMerge=new Wo({context:this.context}),this._midSideSplit=new zo({context:this.context}),this._midSend=this._midSideSplit.mid,this._sideSend=this._midSideSplit.side,this._midReturn=this._midSideMerge.mid,this._sideReturn=this._midSideMerge.side,this.effectSend.connect(this._midSideSplit),this._midSideMerge.connect(this.effectReturn)}connectEffectMid(...t){this._midSend.chain(...t,this._midReturn)}connectEffectSide(...t){this._sideSend.chain(...t,this._sideReturn)}dispose(){return super.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this._midSend.dispose(),this._sideSend.dispose(),this._midReturn.dispose(),this._sideReturn.dispose(),this}}class tc extends Ku{constructor(){const t=K(tc.getDefaults(),arguments,["width"]);super(t),this.name="StereoWidener",this.width=new At({context:this.context,value:t.width,units:"normalRange"}),St(this,["width"]),this._twoTimesWidthMid=new ue({context:this.context,value:2}),this._twoTimesWidthSide=new ue({context:this.context,value:2}),this._midMult=new ue({context:this.context}),this._twoTimesWidthMid.connect(this._midMult.factor),this.connectEffectMid(this._midMult),this._oneMinusWidth=new Qn({context:this.context}),this._oneMinusWidth.connect(this._twoTimesWidthMid),Ke(this.context.getConstant(1),this._oneMinusWidth),this.width.connect(this._oneMinusWidth.subtrahend),this._sideMult=new ue({context:this.context}),this.width.connect(this._twoTimesWidthSide),this._twoTimesWidthSide.connect(this._sideMult.factor),this.connectEffectSide(this._sideMult)}static getDefaults(){return Object.assign(Ku.getDefaults(),{width:.5})}dispose(){return super.dispose(),this.width.dispose(),this._midMult.dispose(),this._sideMult.dispose(),this._twoTimesWidthMid.dispose(),this._twoTimesWidthSide.dispose(),this._oneMinusWidth.dispose(),this}}class ec extends Zs{constructor(){const t=K(ec.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Tremolo",this._lfoL=new ts({context:this.context,type:t.type,min:1,max:0}),this._lfoR=new ts({context:this.context,type:t.type,min:1,max:0}),this._amplitudeL=new wt({context:this.context}),this._amplitudeR=new wt({context:this.context}),this.frequency=new At({context:this.context,value:t.frequency,units:"frequency"}),this.depth=new At({context:this.context,value:t.depth,units:"normalRange"}),St(this,["frequency","depth"]),this.connectEffectLeft(this._amplitudeL),this.connectEffectRight(this._amplitudeR),this._lfoL.connect(this._amplitudeL.gain),this._lfoR.connect(this._amplitudeR.gain),this.frequency.fan(this._lfoL.frequency,this._lfoR.frequency),this.depth.fan(this._lfoR.amplitude,this._lfoL.amplitude),this.spread=t.spread}static getDefaults(){return Object.assign(Zs.getDefaults(),{frequency:10,type:"sine",depth:.5,spread:180})}start(t){return this._lfoL.start(t),this._lfoR.start(t),this}stop(t){return this._lfoL.stop(t),this._lfoR.stop(t),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this.context.transport.syncSignal(this.frequency),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this.context.transport.unsyncSignal(this.frequency),this}get type(){return this._lfoL.type}set type(t){this._lfoL.type=t,this._lfoR.type=t}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(t){this._lfoL.phase=90-t/2,this._lfoR.phase=t/2+90}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._amplitudeL.dispose(),this._amplitudeR.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class sc extends Ae{constructor(){const t=K(sc.getDefaults(),arguments,["frequency","depth"]);super(t),this.name="Vibrato",this._delayNode=new fs({context:this.context,delayTime:0,maxDelay:t.maxDelay}),this._lfo=new ts({context:this.context,type:t.type,min:0,max:t.maxDelay,frequency:t.frequency,phase:-90}).start().connect(this._delayNode.delayTime),this.frequency=this._lfo.frequency,this.depth=this._lfo.amplitude,this.depth.value=t.depth,St(this,["frequency","depth"]),this.effectSend.chain(this._delayNode,this.effectReturn)}static getDefaults(){return Object.assign(Ae.getDefaults(),{maxDelay:.005,frequency:5,depth:.1,type:"sine"})}get type(){return this._lfo.type}set type(t){this._lfo.type=t}dispose(){return super.dispose(),this._delayNode.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Vo extends rt{constructor(){const t=K(Vo.getDefaults(),arguments,["type","size"]);super(t),this.name="Analyser",this._analysers=[],this._buffers=[],this.input=this.output=this._gain=new wt({context:this.context}),this._split=new Kn({context:this.context,channels:t.channels}),this.input.connect(this._split),Le(t.channels,1);for(let o=0;o<t.channels;o++)this._analysers[o]=this.context.createAnalyser(),this._split.connect(this._analysers[o],o,0);this.size=t.size,this.type=t.type,this.smoothing=t.smoothing}static getDefaults(){return Object.assign(rt.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach((t,o)=>{const l=this._buffers[o];this._type==="fft"?t.getFloatFrequencyData(l):this._type==="waveform"&&t.getFloatTimeDomainData(l)}),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(t){this._analysers.forEach((o,l)=>{o.fftSize=2*t,this._buffers[l]=new Float32Array(t)})}get channels(){return this._analysers.length}get type(){return this._type}set type(t){_t(t==="waveform"||t==="fft",`Analyser: invalid type: ${t}`),this._type=t}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(t){this._analysers.forEach(o=>o.smoothingTimeConstant=t)}dispose(){return super.dispose(),this._analysers.forEach(t=>t.disconnect()),this._split.dispose(),this._gain.dispose(),this}}class On extends rt{constructor(){super(K(On.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new Vo({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class nc extends On{constructor(){const t=K(nc.getDefaults(),arguments,["smoothing"]);super(t),this.name="Meter",this.input=this.output=this._analyser=new Vo({context:this.context,size:256,type:"waveform",channels:t.channelCount}),this.smoothing=t.smoothing,this.normalRange=t.normalRange,this._rms=new Array(t.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(On.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return wi("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const t=this._analyser.getValue(),o=(this.channels===1?[t]:t).map((l,d)=>{const v=l.reduce((_,x)=>_+x*x,0),b=Math.sqrt(v/l.length);return this._rms[d]=Math.max(b,this._rms[d]*this.smoothing),this.normalRange?this._rms[d]:_o(this._rms[d])});return this.channels===1?o[0]:o}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class ic extends On{constructor(){const t=K(ic.getDefaults(),arguments,["size"]);super(t),this.name="FFT",this.normalRange=t.normalRange,this._analyser.type="fft",this.size=t.size}static getDefaults(){return Object.assign(rt.getDefaults(),{normalRange:!1,size:1024,smoothing:.8})}getValue(){return this._analyser.getValue().map(t=>this.normalRange?Ai(t):t)}get size(){return this._analyser.size}set size(t){this._analyser.size=t}get smoothing(){return this._analyser.smoothing}set smoothing(t){this._analyser.smoothing=t}getFrequencyOfIndex(t){return _t(0<=t&&t<this.size,`index must be greater than or equal to 0 and less than ${this.size}`),t*this.context.sampleRate/(2*this.size)}}class oc extends On{constructor(){super(K(oc.getDefaults(),arguments)),this.name="DCMeter",this._analyser.type="waveform",this._analyser.size=256}getValue(){return this._analyser.getValue()[0]}}class rc extends On{constructor(){const t=K(rc.getDefaults(),arguments,["size"]);super(t),this.name="Waveform",this._analyser.type="waveform",this.size=t.size}static getDefaults(){return Object.assign(On.getDefaults(),{size:1024})}getValue(){return this._analyser.getValue()}get size(){return this._analyser.size}set size(t){this._analyser.size=t}}class be extends rt{constructor(){const t=K(be.getDefaults(),arguments,["solo"]);super(t),this.name="Solo",this.input=this.output=new wt({context:this.context}),be._allSolos.has(this.context)||be._allSolos.set(this.context,new Set),be._allSolos.get(this.context).add(this),this.solo=t.solo}static getDefaults(){return Object.assign(rt.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(t){t?this._addSolo():this._removeSolo(),be._allSolos.get(this.context).forEach(o=>o._updateSolo())}get muted(){return this.input.gain.value===0}_addSolo(){be._soloed.has(this.context)||be._soloed.set(this.context,new Set),be._soloed.get(this.context).add(this)}_removeSolo(){be._soloed.has(this.context)&&be._soloed.get(this.context).delete(this)}_isSoloed(){return be._soloed.has(this.context)&&be._soloed.get(this.context).has(this)}_noSolos(){return!be._soloed.has(this.context)||be._soloed.has(this.context)&&be._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),be._allSolos.get(this.context).delete(this),this._removeSolo(),this}}be._allSolos=new Map,be._soloed=new Map;class Kr extends rt{constructor(){const t=K(Kr.getDefaults(),arguments,["pan","volume"]);super(t),this.name="PanVol",this._panner=this.input=new $o({context:this.context,pan:t.pan,channelCount:t.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new dn({context:this.context,volume:t.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=t.mute,St(this,["pan","volume"])}static getDefaults(){return Object.assign(rt.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(t){this._volume.mute=t}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class ti extends rt{constructor(){const t=K(ti.getDefaults(),arguments,["volume","pan"]);super(t),this.name="Channel",this._solo=this.input=new be({solo:t.solo,context:this.context}),this._panVol=this.output=new Kr({context:this.context,pan:t.pan,volume:t.volume,mute:t.mute,channelCount:t.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),St(this,["pan","volume"])}static getDefaults(){return Object.assign(rt.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(t){this._solo.solo=t}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(t){this._panVol.mute=t}_getBus(t){return ti.buses.has(t)||ti.buses.set(t,new wt({context:this.context})),ti.buses.get(t)}send(t,o=0){const l=this._getBus(t),d=new wt({context:this.context,units:"decibels",gain:o});return this.connect(d),d.connect(l),d}receive(t){return this._getBus(t).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}ti.buses=new Map;class ac extends rt{constructor(){super(K(ac.getDefaults(),arguments)),this.name="Mono",this.input=new wt({context:this.context}),this._merge=this.output=new Dn({channels:2,context:this.context}),this.input.connect(this._merge,0,0),this.input.connect(this._merge,0,1)}dispose(){return super.dispose(),this._merge.dispose(),this.input.dispose(),this}}class Ho extends rt{constructor(){const t=K(Ho.getDefaults(),arguments,["lowFrequency","highFrequency"]);super(t),this.name="MultibandSplit",this.input=new wt({context:this.context}),this.output=void 0,this.low=new vs({context:this.context,frequency:0,type:"lowpass"}),this._lowMidFilter=new vs({context:this.context,frequency:0,type:"highpass"}),this.mid=new vs({context:this.context,frequency:0,type:"lowpass"}),this.high=new vs({context:this.context,frequency:0,type:"highpass"}),this._internalChannels=[this.low,this.mid,this.high],this.lowFrequency=new At({context:this.context,units:"frequency",value:t.lowFrequency}),this.highFrequency=new At({context:this.context,units:"frequency",value:t.highFrequency}),this.Q=new At({context:this.context,units:"positive",value:t.Q}),this.input.fan(this.low,this.high),this.input.chain(this._lowMidFilter,this.mid),this.lowFrequency.fan(this.low.frequency,this._lowMidFilter.frequency),this.highFrequency.fan(this.mid.frequency,this.high.frequency),this.Q.connect(this.low.Q),this.Q.connect(this._lowMidFilter.Q),this.Q.connect(this.mid.Q),this.Q.connect(this.high.Q),St(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(rt.getDefaults(),{Q:1,highFrequency:2500,lowFrequency:400})}dispose(){return super.dispose(),bo(this,["high","mid","low","highFrequency","lowFrequency"]),this.low.dispose(),this._lowMidFilter.dispose(),this.mid.dispose(),this.high.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this.Q.dispose(),this}}class lc extends rt{constructor(){const t=K(lc.getDefaults(),arguments,["positionX","positionY","positionZ"]);super(t),this.name="Panner3D",this._panner=this.input=this.output=this.context.createPanner(),this.panningModel=t.panningModel,this.maxDistance=t.maxDistance,this.distanceModel=t.distanceModel,this.coneOuterGain=t.coneOuterGain,this.coneOuterAngle=t.coneOuterAngle,this.coneInnerAngle=t.coneInnerAngle,this.refDistance=t.refDistance,this.rolloffFactor=t.rolloffFactor,this.positionX=new Et({context:this.context,param:this._panner.positionX,value:t.positionX}),this.positionY=new Et({context:this.context,param:this._panner.positionY,value:t.positionY}),this.positionZ=new Et({context:this.context,param:this._panner.positionZ,value:t.positionZ}),this.orientationX=new Et({context:this.context,param:this._panner.orientationX,value:t.orientationX}),this.orientationY=new Et({context:this.context,param:this._panner.orientationY,value:t.orientationY}),this.orientationZ=new Et({context:this.context,param:this._panner.orientationZ,value:t.orientationZ})}static getDefaults(){return Object.assign(rt.getDefaults(),{coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:0,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1})}setPosition(t,o,l){return this.positionX.value=t,this.positionY.value=o,this.positionZ.value=l,this}setOrientation(t,o,l){return this.orientationX.value=t,this.orientationY.value=o,this.orientationZ.value=l,this}get panningModel(){return this._panner.panningModel}set panningModel(t){this._panner.panningModel=t}get refDistance(){return this._panner.refDistance}set refDistance(t){this._panner.refDistance=t}get rolloffFactor(){return this._panner.rolloffFactor}set rolloffFactor(t){this._panner.rolloffFactor=t}get distanceModel(){return this._panner.distanceModel}set distanceModel(t){this._panner.distanceModel=t}get coneInnerAngle(){return this._panner.coneInnerAngle}set coneInnerAngle(t){this._panner.coneInnerAngle=t}get coneOuterAngle(){return this._panner.coneOuterAngle}set coneOuterAngle(t){this._panner.coneOuterAngle=t}get coneOuterGain(){return this._panner.coneOuterGain}set coneOuterGain(t){this._panner.coneOuterGain=t}get maxDistance(){return this._panner.maxDistance}set maxDistance(t){this._panner.maxDistance=t}dispose(){return super.dispose(),this._panner.disconnect(),this.orientationX.dispose(),this.orientationY.dispose(),this.orientationZ.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this}}class ta extends rt{constructor(){const t=K(ta.getDefaults(),arguments);super(t),this.name="Recorder",this.input=new wt({context:this.context}),_t(ta.supported,"Media Recorder API is not available"),this._stream=this.context.createMediaStreamDestination(),this.input.connect(this._stream),this._recorder=new MediaRecorder(this._stream.stream,{mimeType:t.mimeType})}static getDefaults(){return rt.getDefaults()}get mimeType(){return this._recorder.mimeType}static get supported(){return us!==null&&Reflect.has(us,"MediaRecorder")}get state(){return this._recorder.state==="inactive"?"stopped":this._recorder.state==="paused"?"paused":"started"}start(){return Kt(this,void 0,void 0,function*(){_t(this.state!=="started","Recorder is already started");const t=new Promise(o=>{const l=()=>{this._recorder.removeEventListener("start",l,!1),o()};this._recorder.addEventListener("start",l,!1)});return this._recorder.start(),yield t})}stop(){return Kt(this,void 0,void 0,function*(){_t(this.state!=="stopped","Recorder is not started");const t=new Promise(o=>{const l=d=>{this._recorder.removeEventListener("dataavailable",l,!1),o(d.data)};this._recorder.addEventListener("dataavailable",l,!1)});return this._recorder.stop(),yield t})}pause(){return _t(this.state==="started","Recorder must be started"),this._recorder.pause(),this}dispose(){return super.dispose(),this.input.dispose(),this._stream.disconnect(),this}}class vn extends rt{constructor(){const t=K(vn.getDefaults(),arguments,["threshold","ratio"]);super(t),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new Et({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:t.threshold}),this.attack=new Et({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:t.attack}),this.release=new Et({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:t.release}),this.knee=new Et({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:t.knee}),this.ratio=new Et({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:t.ratio}),St(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(rt.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class cc extends rt{constructor(){const t=K(cc.getDefaults(),arguments,["threshold","smoothing"]);super(t),this.name="Gate",this._follower=new qo({context:this.context,smoothing:t.smoothing}),this._gt=new Xr({context:this.context,value:Ai(t.threshold)}),this.input=new wt({context:this.context}),this._gate=this.output=new wt({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(rt.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return _o(this._gt.value)}set threshold(t){this._gt.value=Ai(t)}get smoothing(){return this._follower.smoothing}set smoothing(t){this._follower.smoothing=t}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}class hc extends rt{constructor(){const t=K(hc.getDefaults(),arguments,["threshold"]);super(t),this.name="Limiter",this._compressor=this.input=this.output=new vn({context:this.context,ratio:20,attack:.003,release:.01,threshold:t.threshold}),this.threshold=this._compressor.threshold,St(this,"threshold")}static getDefaults(){return Object.assign(rt.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}class uc extends rt{constructor(){const t=K(uc.getDefaults(),arguments);super(t),this.name="MidSideCompressor",this._midSideSplit=this.input=new zo({context:this.context}),this._midSideMerge=this.output=new Wo({context:this.context}),this.mid=new vn(Object.assign(t.mid,{context:this.context})),this.side=new vn(Object.assign(t.side,{context:this.context})),this._midSideSplit.mid.chain(this.mid,this._midSideMerge.mid),this._midSideSplit.side.chain(this.side,this._midSideMerge.side),St(this,["mid","side"])}static getDefaults(){return Object.assign(rt.getDefaults(),{mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},side:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10}})}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this}}class dc extends rt{constructor(){const t=K(dc.getDefaults(),arguments);super(t),this.name="MultibandCompressor",this._splitter=this.input=new Ho({context:this.context,lowFrequency:t.lowFrequency,highFrequency:t.highFrequency}),this.lowFrequency=this._splitter.lowFrequency,this.highFrequency=this._splitter.highFrequency,this.output=new wt({context:this.context}),this.low=new vn(Object.assign(t.low,{context:this.context})),this.mid=new vn(Object.assign(t.mid,{context:this.context})),this.high=new vn(Object.assign(t.high,{context:this.context})),this._splitter.low.chain(this.low,this.output),this._splitter.mid.chain(this.mid,this.output),this._splitter.high.chain(this.high,this.output),St(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(rt.getDefaults(),{lowFrequency:250,highFrequency:2e3,low:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10},mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},high:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16}})}dispose(){return super.dispose(),this._splitter.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.output.dispose(),this}}class pc extends rt{constructor(){const t=K(pc.getDefaults(),arguments,["low","mid","high"]);super(t),this.name="EQ3",this.output=new wt({context:this.context}),this._internalChannels=[],this.input=this._multibandSplit=new Ho({context:this.context,highFrequency:t.highFrequency,lowFrequency:t.lowFrequency}),this._lowGain=new wt({context:this.context,gain:t.low,units:"decibels"}),this._midGain=new wt({context:this.context,gain:t.mid,units:"decibels"}),this._highGain=new wt({context:this.context,gain:t.high,units:"decibels"}),this.low=this._lowGain.gain,this.mid=this._midGain.gain,this.high=this._highGain.gain,this.Q=this._multibandSplit.Q,this.lowFrequency=this._multibandSplit.lowFrequency,this.highFrequency=this._multibandSplit.highFrequency,this._multibandSplit.low.chain(this._lowGain,this.output),this._multibandSplit.mid.chain(this._midGain,this.output),this._multibandSplit.high.chain(this._highGain,this.output),St(this,["low","mid","high","lowFrequency","highFrequency"]),this._internalChannels=[this._multibandSplit]}static getDefaults(){return Object.assign(rt.getDefaults(),{high:0,highFrequency:2500,low:0,lowFrequency:400,mid:0})}dispose(){return super.dispose(),bo(this,["low","mid","high","lowFrequency","highFrequency"]),this._multibandSplit.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this._lowGain.dispose(),this._midGain.dispose(),this._highGain.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.Q.dispose(),this}}class mc extends rt{constructor(){const t=K(mc.getDefaults(),arguments,["url","onload"]);super(t),this.name="Convolver",this._convolver=this.context.createConvolver(),this._buffer=new qt(t.url,o=>{this.buffer=o,t.onload()}),this.input=new wt({context:this.context}),this.output=new wt({context:this.context}),this._buffer.loaded&&(this.buffer=this._buffer),this.normalize=t.normalize,this.input.chain(this._convolver,this.output)}static getDefaults(){return Object.assign(rt.getDefaults(),{normalize:!0,onload:Dt})}load(t){return Kt(this,void 0,void 0,function*(){this.buffer=yield this._buffer.load(t)})}get buffer(){return this._buffer.length?this._buffer:null}set buffer(t){t&&this._buffer.set(t),this._convolver.buffer&&(this.input.disconnect(),this._convolver.disconnect(),this._convolver=this.context.createConvolver(),this.input.chain(this._convolver,this.output));const o=this._buffer.get();this._convolver.buffer=o||null}get normalize(){return this._convolver.normalize}set normalize(t){this._convolver.normalize=t}dispose(){return super.dispose(),this._buffer.dispose(),this._convolver.disconnect(),this}}function Rg(){return ie().now()}function Dg(){return ie().immediate()}const Og=ie().transport;function Ng(){return ie().transport}const Lg=ie().destination,Fg=ie().destination;function Bg(){return ie().destination}const $g=ie().listener;function qg(){return ie().listener}const zg=ie().draw;function Wg(){return ie().draw}const Vg=ie();function Hg(){return qt.loaded()}const Gg=qt,jg=Ii,Ug=kn})(),a})())}(ga)),ga.exports}var J=ev();const op=Array(19).fill(2),rp=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],sv=Array(16).fill(2),nv=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function iv(){return{hasAnacrusis:!0,macrobeatGroupings:[...op],macrobeatBoundaryStyles:[...rp],baseMicrobeatPx:40,modulationMarkers:[]}}const ro=12,ov=50,rv=.52,av=.5,sa=3,na=1,Cr=30,Tr=.5,lv=3,ia=8,va=.25,cv=1.25,hv=.8,uv=.7,dv=.9,pv=4,mv=1.5,fv=.15,gv=.2,vv=1,ap=1.5,yv="#CCCCCC",lp=1,id=3,od=5,bv=7,ya=16,wv=0,_v=255,cp=()=>({enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass"}),xv=()=>({speed:0,span:0}),Sv=()=>({speed:0,span:0}),Cv={"#4a90e2":{primary:"#4a90e2",light:"#63a9fd"},"#68a03f":{primary:"#68a03f",light:"#80b958"},"#d66573":{primary:"#d66573",light:"#f27e8b"},"#2d2d2d":{primary:"#2d2d2d",light:"#424242"}};function rd(){const n=e=>{const s=new Float32Array(ro).fill(0),i=new Float32Array(ro).fill(0);return s[0]=1,{name:e,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},coeffs:s,phases:i,activePresetName:"sine",gain:1,filter:cp(),vibrato:xv(),tremelo:Sv()}};return{timbres:{"#4a90e2":n("Blue"),"#2d2d2d":n("Black"),"#d66573":n("Red"),"#68a03f":n("Green")},colorPalette:Cv}}function Tv(){return{isMicPaintActive:!1,isDetecting:!1,detectedPitch:{frequency:0,clarity:0,midi:0,pitchClass:0},paintHistory:[],paintSettings:{thickness:6,opacity:80,minClarity:.1,colorMode:"chromatic",playbackEnabled:!0}}}const Xe=[{pitch:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fef1f5"},{pitch:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fbf2fa"},{pitch:"B/A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f6f3fd"},{pitch:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f1f5ff"},{pitch:"A/G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#edf7fe"},{pitch:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#ebf8fa"},{pitch:"G/F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#ecf8f5"},{pitch:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#eff8f0"},{pitch:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#f4f7ec"},{pitch:"E/D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#f9f5eb"},{pitch:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#fdf3ec"},{pitch:"D/C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fef2f0"},{pitch:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#fef1f5"},{pitch:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#f0d1ec"},{pitch:"B/A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#e1d6f9"},{pitch:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#cfdcff"},{pitch:"A/G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#bfe2fb"},{pitch:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#b7e6ef"},{pitch:"G/F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#b9e8dd"},{pitch:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#c6e6cb"},{pitch:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#d8e2bd"},{pitch:"E/D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#e9dcb7"},{pitch:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#f6d5bc"},{pitch:"D/C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#fcd1c9"},{pitch:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#facfdb"},{pitch:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e6b2e1"},{pitch:"B/A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#cebaf6"},{pitch:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#b0c4fe"},{pitch:"A/G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#92cef8"},{pitch:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#7fd5e5"},{pitch:"G/F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#84d8c8"},{pitch:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#9ed6a8"},{pitch:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#bece8f"},{pitch:"E/D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#dbc484"},{pitch:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#f0b98d"},{pitch:"D/C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#f9b1a5"},{pitch:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#f5afc3"},{pitch:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#db8fd4"},{pitch:"B/A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#ba9bf2"},{pitch:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#8fa9ff"},{pitch:"A/G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#58b8f6"},{pitch:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#16c3da"},{pitch:"G/F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#2dc8b1"},{pitch:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#6ec482"},{pitch:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#a4ba57"},{pitch:"E/D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#cdaa42"},{pitch:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#e89955"},{pitch:"D/C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#f48e7d"},{pitch:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#ef8aab"},{pitch:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#be7cb8"},{pitch:"B/A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#a286d2"},{pitch:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#7b93dd"},{pitch:"A/G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#4c9fd6"},{pitch:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#13a9bd"},{pitch:"G/F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#27ad99"},{pitch:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#5faa71"},{pitch:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#8ea14b"},{pitch:"E/D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#b29338"},{pitch:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#ca8549"},{pitch:"D/C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#d47a6c"},{pitch:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#cf7894"},{pitch:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#a46b9f"},{pitch:"B/A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#8b73b6"},{pitch:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#6a7ebf"},{pitch:"A/G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#4189b8"},{pitch:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#1092a3"},{pitch:"G/F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#219584"},{pitch:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#519360"},{pitch:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#7a8b40"},{pitch:"E/D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#997f30"},{pitch:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#ae723e"},{pitch:"D/C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#b7695d"},{pitch:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#b3677f"},{pitch:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#6f466b"},{pitch:"B/A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#5d4c7b"},{pitch:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#465482"},{pitch:"A/G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#295c7d"},{pitch:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#06626e"},{pitch:"G/F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#126458"},{pitch:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#34633f"},{pitch:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#515d28"},{pitch:"E/D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#67541d"},{pitch:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#764c27"},{pitch:"D/C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#7c453d"},{pitch:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#794455"}],hp={placedNotes:[],placedChords:[],tonicSignGroups:{},stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],tonicSignGroups:{},timbres:rd().timbres,placedChords:[],stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[],pitchRange:{topIndex:0,bottomIndex:Math.max(0,((Xe==null?void 0:Xe.length)||1)-1)},...iv(),...rd(),paint:Tv(),selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},activeChordId:null,activeChordIntervals:["1P","3M","5P"],isIntervalsInverted:!1,chordPositionState:0,isChordCandidateMenuOpen:!1,chordCandidateMenuPosition:{x:0,y:0},activeMacrobeatIndex:null,chordCandidates:[],gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,savedAccidentalMode:{sharp:!0,flat:!0},focusColours:!1,snapZoomToRange:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,waveformExtendedView:!1,adsrTimeAxisScale:1,adsrComponentWidth:100,isPrintPreviewActive:!1,printOptions:{topRow:0,bottomRow:87,includeDrums:!0,orientation:"landscape",colorMode:"color"}};function ad(n){const e=JSON.parse(JSON.stringify(n));for(const s in e){const i=e[s];i.coeffs&&typeof i.coeffs=="object"&&!Array.isArray(i.coeffs)?i.coeffs=new Float32Array(Object.values(i.coeffs)):Array.isArray(i.coeffs)&&(i.coeffs=new Float32Array(i.coeffs))}return e}const Av={recordState(){this.state.history=this.state.history.slice(0,this.state.historyIndex+1);const n=JSON.parse(JSON.stringify(this.state.timbres)),e={notes:JSON.parse(JSON.stringify(this.state.placedNotes)),tonicSignGroups:JSON.parse(JSON.stringify(this.state.tonicSignGroups)),stampPlacements:JSON.parse(JSON.stringify(this.state.stampPlacements)),tripletPlacements:JSON.parse(JSON.stringify(this.state.tripletPlacements||[])),timbres:n,annotations:this.state.annotations?JSON.parse(JSON.stringify(this.state.annotations)):[]};this.state.history.push(e),this.state.historyIndex++,this.emit("historyChanged")},undo(){var n;if(this.state.historyIndex>0){this.state.historyIndex--;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=ad(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}},redo(){var n;if(this.state.historyIndex<this.state.history.length-1){this.state.historyIndex++;const e=this.state.history[this.state.historyIndex];this.state.placedNotes=JSON.parse(JSON.stringify(e.notes)),this.state.tonicSignGroups=JSON.parse(JSON.stringify(e.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(e.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(e.tripletPlacements||[])),this.state.timbres=ad(e.timbres),this.state.annotations=e.annotations?JSON.parse(JSON.stringify(e.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(n=this.state.selectedNote)!=null&&n.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}}};function bh(n){return n!==null&&typeof n=="object"&&"name"in n&&typeof n.name=="string"}function wh(n){return n!==null&&typeof n=="object"&&"step"in n&&typeof n.step=="number"&&"alt"in n&&typeof n.alt=="number"&&!isNaN(n.step)&&!isNaN(n.alt)}var up=[0,2,4,-1,1,3,5],dp=up.map(n=>Math.floor(n*7/12));function pp(n){const{step:e,alt:s,oct:i,dir:r=1}=n,a=up[e]+7*s;if(i===void 0)return[r*a];const c=i-dp[e]-4*s;return[r*a,r*c]}var Mv=[3,0,4,1,5,2,6];function mp(n){const[e,s,i]=n,r=Mv[Ev(e)],a=Math.floor((e+1)/7);if(s===void 0)return{step:r,alt:a,dir:i};const c=s+4*a+dp[r];return{step:r,alt:a,oct:c,dir:i}}function Ev(n){const e=(n+1)%7;return e<0?7+e:e}var ld=(n,e)=>Array(Math.abs(e)+1).join(n),Vc=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),Pv="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",kv="(AA|A|P|M|m|d|dd)([-+]?\\d+)",Iv=new RegExp("^"+Pv+"|"+kv+"$");function Rv(n){const e=Iv.exec(`${n}`);return e===null?["",""]:e[1]?[e[1],e[2]]:[e[4],e[3]]}var cd={};function Rs(n){return typeof n=="string"?cd[n]||(cd[n]=Dv(n)):wh(n)?Rs(Nv(n)):bh(n)?Rs(n.name):Vc}var hd=[0,2,4,5,7,9,11],fp="PMMPPMM";function Dv(n){const e=Rv(n);if(e[0]==="")return Vc;const s=+e[0],i=e[1],r=(Math.abs(s)-1)%7,a=fp[r];if(a==="M"&&i==="P")return Vc;const c=a==="M"?"majorable":"perfectable",h=""+s+i,m=s<0?-1:1,f=s===8||s===-8?s:m*(r+1),g=Ov(c,i),y=Math.floor((Math.abs(s)-1)/7),w=m*(hd[r]+g+12*y),C=(m*(hd[r]+g)%12+12)%12,A=pp({step:r,alt:g,oct:y,dir:m});return{empty:!1,name:h,num:s,q:i,step:r,alt:g,dir:m,type:c,simple:f,semitones:w,chroma:C,coord:A,oct:y}}function gp(n,e){const[s,i=0]=n,r=s*7+i*12<0,a=e||r?[-s,-i,-1]:[s,i,1];return Rs(mp(a))}function Ov(n,e){return e==="M"&&n==="majorable"||e==="P"&&n==="perfectable"?0:e==="m"&&n==="majorable"?-1:/^A+$/.test(e)?e.length:/^d+$/.test(e)?-1*(n==="perfectable"?e.length:e.length+1):0}function Nv(n){const{step:e,alt:s,oct:i=0,dir:r}=n;if(!r)return"";const a=e+1+7*i,c=a===0?e+1:a,h=r<0?"-":"",m=fp[e]==="M"?"majorable":"perfectable";return h+c+Lv(m,s)}function Lv(n,e){return e===0?n==="majorable"?"M":"P":e===-1&&n==="majorable"?"m":e>0?ld("A",e):ld("d",n==="perfectable"?e:e+1)}var ud=(n,e)=>Array(Math.abs(e)+1).join(n),vp=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),dd=new Map,Fv=n=>"CDEFGAB".charAt(n),yp=n=>n<0?ud("b",-n):ud("#",n),bp=n=>n[0]==="b"?-n.length:n.length;function Ee(n){const e=JSON.stringify(n),s=dd.get(e);if(s)return s;const i=typeof n=="string"?zv(n):wh(n)?Ee(Wv(n)):bh(n)?Ee(n.name):vp;return dd.set(e,i),i}var Bv=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function _h(n){const e=Bv.exec(n);return e?[e[1].toUpperCase(),e[2].replace(/x/g,"##"),e[3],e[4]]:["","","",""]}function $v(n){return Ee(mp(n))}var qv=(n,e)=>(n%e+e)%e,_c=[0,2,4,5,7,9,11];function zv(n){const e=_h(n);if(e[0]===""||e[3]!=="")return vp;const s=e[0],i=e[1],r=e[2],a=(s.charCodeAt(0)+3)%7,c=bp(i),h=r.length?+r:void 0,m=pp({step:a,alt:c,oct:h}),f=s+i+r,g=s+i,y=(_c[a]+c+120)%12,w=h===void 0?qv(_c[a]+c,12)-12*99:_c[a]+c+12*(h+1),C=w>=0&&w<=127?w:null,A=h===void 0?null:Math.pow(2,(w-69)/12)*440;return{empty:!1,acc:i,alt:c,chroma:y,coord:m,freq:A,height:w,letter:s,midi:C,name:f,oct:h,pc:g,step:a}}function Wv(n){const{step:e,alt:s,oct:i}=n,r=Fv(e);if(!r)return"";const a=r+yp(s);return i||i===0?a+i:a}function qa(n,e){const s=Ee(n),i=Array.isArray(e)?e:Rs(e).coord;if(s.empty||!i||i.length<2)return"";const r=s.coord,a=r.length===1?[r[0]+i[0]]:[r[0]+i[0],r[1]+i[1]];return $v(a).name}function Ra(n,e){const s=Ee(n),i=Ee(e);if(s.empty||i.empty)return"";const r=s.coord,a=i.coord,c=a[0]-r[0],h=r.length===2&&a.length===2?a[1]-r[1]:-Math.floor(c*7/12),m=i.height===s.height&&i.midi!==null&&s.oct===i.oct&&s.step>i.step;return gp([c,h],m).name}function xh(n,e){const s=e.length,i=(n%s+s)%s;return e.slice(i,s).concat(e.slice(0,i))}function Vv(n){return n.filter(e=>e===0||e)}var ii={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},wp=n=>Number(n).toString(2).padStart(12,"0"),pd=n=>parseInt(n,2),Hv=/^[01]{12}$/;function _p(n){return Hv.test(n)}var Gv=n=>typeof n=="number"&&n>=0&&n<=4095,jv=n=>n&&_p(n.chroma),md={[ii.chroma]:ii};function Sh(n){const e=_p(n)?n:Gv(n)?wp(n):Array.isArray(n)?Jv(n):jv(n)?n.chroma:ii.chroma;return md[e]=md[e]||Qv(e)}var Uv=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function Xv(n){const e=[];for(let s=0;s<12;s++)n.charAt(s)==="1"&&e.push(Uv[s]);return e}function Yv(n,e=!0){const i=Sh(n).chroma.split("");return Vv(i.map((r,a)=>{const c=xh(a,i);return e&&c[0]==="0"?null:c.join("")}))}function Zv(n){const e=n.split("");return e.map((s,i)=>xh(i,e).join(""))}function Qv(n){const e=pd(n),s=Zv(n).map(pd).filter(a=>a>=2048).sort()[0],i=wp(s),r=Xv(n);return{empty:!1,name:"",setNum:e,chroma:n,normalized:i,intervals:r}}function Jv(n){if(n.length===0)return ii.chroma;let e;const s=[0,0,0,0,0,0,0,0,0,0,0,0];for(let i=0;i<n.length;i++)e=Ee(n[i]),e.empty&&(e=Rs(n[i])),e.empty||(s[e.chroma]=1);return s.join("")}var Kv=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7  ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 #4 #11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -7 m -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim  o"],["1P 3m 5d 7d","diminished seventh","dim7 7 o7"],["1P 3m 5d 7m","half-diminished","m7b5  -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],ty=Kv,ey={...ii,name:"",quality:"Unknown",intervals:[],aliases:[]},Ch=[],sr={};function sy(n){return sr[n]||ey}function ny(){return Ch.slice()}function iy(n,e,s){const i=ry(n),r={...Sh(n),name:s||"",quality:i,intervals:n,aliases:e};Ch.push(r),r.name&&(sr[r.name]=r),sr[r.setNum]=r,sr[r.chroma]=r,r.aliases.forEach(a=>oy(r,a))}function oy(n,e){sr[e]=n}function ry(n){const e=s=>n.indexOf(s)!==-1;return e("5A")?"Augmented":e("3M")?"Major":e("5d")?"Diminished":e("3m")?"Minor":"Unknown"}ty.forEach(([n,e,s])=>iy(n.split(" "),s.split(" "),e));Ch.sort((n,e)=>n.setNum-e.setNum);var ay=n=>{const e=n.reduce((s,i)=>{const r=Ee(i).chroma;return r!==void 0&&(s[r]=s[r]||Ee(i).name),s},{});return s=>e[s]};function ly(n,e={}){const s=n.map(r=>Ee(r).pc).filter(r=>r);return Ee.length===0?[]:fy(s,1,e).filter(r=>r.weight).sort((r,a)=>a.weight-r.weight).map(r=>r.name)}var za={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},Wa=n=>e=>!!(e&n),cy=Wa(za.anyThirds),hy=Wa(za.perfectFifth),uy=Wa(za.anySeventh),dy=Wa(za.nonPerfectFifths);function py(n){const e=parseInt(n.chroma,2);return cy(e)&&hy(e)&&uy(e)}function my(n){const e=parseInt(n,2);return dy(e)?n:(e|16).toString(2)}function fy(n,e,s){const i=n[0],r=Ee(i).chroma,a=ay(n),c=Yv(n,!1),h=[];return c.forEach((m,f)=>{const g=s.assumePerfectFifth&&my(m);ny().filter(w=>s.assumePerfectFifth&&py(w)?w.chroma===g:w.chroma===m).forEach(w=>{const C=w.aliases[0],A=a(f);f!==r?h.push({weight:.5*e,name:`${A}${C}/${i}`}):h.push({weight:1*e,name:`${A}${C}`})})}),h}var gy=Rs;function vy(n){const e=Rs(n);if(e.empty)return"";const s=(7-e.step)%7,i=e.type==="perfectable"?-e.alt:-(e.alt+1);return Rs({step:s,alt:i,oct:e.oct,dir:e.dir}).name}var xc=Ra,yy=by((n,e)=>[n[0]-e[0],n[1]-e[1]]);function by(n){return(e,s)=>{const i=Rs(e).coord,r=Rs(s).coord;if(i&&r){const a=n(i,r);return gp(a).name}}}var wy=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],_y=wy,xy={...ii,intervals:[],aliases:[]},nr={};function xp(n){return nr[n]||xy}function Sy(n,e,s=[]){const i={...Sh(n),name:e,intervals:n,aliases:s};return nr[i.name]=i,nr[i.setNum]=i,nr[i.chroma]=i,i.aliases.forEach(r=>Cy(i,r)),i}function Cy(n,e){nr[e]=n}_y.forEach(([n,e,...s])=>Sy(n.split(" "),e,s));var Sp={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function Cp(n){const[e,s,i,r]=_h(n);return e===""?Sc("",n):e==="A"&&r==="ug"?Sc("","aug"):Sc(e+s,i+r)}function Sc(n,e){const s=e.split("/");if(s.length===1)return[n,s[0],""];const[i,r,a,c]=_h(s[1]);return i!==""&&a===""&&c===""?[n,s[0],i+r]:[n,e,""]}function Hc(n){if(Array.isArray(n))return ba(n[1]||"",n[0],n[2]);if(n==="")return Sp;{const[e,s,i]=Cp(n),r=ba(s,e,i);return r.empty?ba(n):r}}function ba(n,e,s){const i=sy(n),r=Ee(e||""),a=Ee(s||"");if(i.empty||e&&r.empty||s&&a.empty)return Sp;const c=Ra(r.pc,a.pc),h=i.intervals.indexOf(c),m=h>=0,f=m?a:Ee(""),g=h===-1?NaN:h+1,y=a.pc&&a.pc!==r.pc,w=Array.from(i.intervals);if(m)for(let E=1;E<g;E++){const O=w[0][0],P=w[0][1],R=parseInt(O,10)+7;w.push(`${R}${P}`),w.shift()}else if(y){const E=yy(Ra(r.pc,a.pc),"8P");E&&w.unshift(E)}const C=r.empty?[]:w.map(E=>qa(r.pc,E));n=i.aliases.indexOf(n)!==-1?n:i.aliases[0];const A=`${r.empty?"":r.pc}${n}${m&&g>1?"/"+f.pc:y?"/"+a.pc:""}`,I=`${e?r.pc+" ":""}${i.name}${m&&g>1?" over "+f.pc:y?" over "+a.pc:""}`;return{...i,name:I,symbol:A,tonic:r.pc,type:i.name,root:f.pc,bass:y?a.pc:"",intervals:w,rootDegree:g,notes:C}}var Ty=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],Ay=Ty;Ay.forEach(([n,e,s])=>void 0);var My="C C# D D# E F F# G G# A A# B".split(" "),Ey="C Db D Eb E F Gb G Ab A Bb B".split(" ");function Th(n,e={}){if(isNaN(n)||n===-1/0||n===1/0)return"";n=Math.round(n);const i=(e.sharps===!0?My:Ey)[n%12];if(e.pitchClass)return i;const r=Math.floor(n/12)-1;return i+r}var ao=Ee,Da=n=>ao(n).pc,Py=n=>ao(n).oct,on=n=>ao(n).midi;function ky(n){return Th(n)}var ir=qa,or=n=>{const e=ao(n);return e.empty?"":Th(e.midi||e.chroma,{sharps:e.alt>0,pitchClass:e.midi===null})};function bn(n,e){const s=ao(n);if(s.empty)return"";const i=ao(e||Th(s.midi||s.chroma,{sharps:s.alt<0,pitchClass:!0}));if(i.empty||i.chroma!==s.chroma)return"";if(s.oct===void 0)return i.pc;const r=s.chroma-s.alt,a=i.chroma-i.alt,c=r>11||a<0?-1:r<0||a>11?1:0,h=s.oct+c;return i.pc+h}var Tp={empty:!0,name:"",chordType:""},fd={};function vr(n){return typeof n=="string"?fd[n]||(fd[n]=Ny(n)):typeof n=="number"?vr(Ah[n]||""):wh(n)?Iy(n):bh(n)?vr(n.name):Tp}function Iy(n){return vr(yp(n.alt)+Ah[n.step])}var Ry=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function Dy(n){return Ry.exec(n)||["","","",""]}var Oy="I II III IV V VI VII",Ah=Oy.split(" ");function Ny(n){const[e,s,i,r]=Dy(n);if(!i)return Tp;const a=i.toUpperCase(),c=Ah.indexOf(a),h=bp(s),m=1;return{empty:!1,name:e,roman:i,interval:Rs({step:c,alt:h,dir:m}).name,acc:s,chordType:r,alt:h,step:c,major:i===a,oct:0,dir:m}}var Mh=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],gd={...ii,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},Ly=Mh.map(Fy),Gc={};Ly.forEach(n=>{Gc[n.name]=n,n.aliases.forEach(e=>{Gc[e]=n})});function Ap(n){return typeof n=="string"?Gc[n.toLowerCase()]||gd:n&&n.name?Ap(n.name):gd}function Fy(n){const[e,s,i,r,a,c,h]=n,m=h?[h]:[],f=Number(s).toString(2);return{empty:!1,intervals:xp(r).intervals,modeNum:e,chroma:f,normalized:f,name:r,setNum:s,alt:i,triad:a,seventh:c,aliases:m}}function Mp(n){return(e,s)=>{const i=Ap(e);if(i.empty)return[];const r=xh(i.modeNum,n),a=i.intervals.map(c=>qa(s,c));return r.map((c,h)=>a[h]+c)}}Mp(Mh.map(n=>n[4]));Mp(Mh.map(n=>n[5]));function By(n,e){return e.map(s=>{const[i,r]=Cp(s),a=Ra(n,i);return vr(Rs(a)).name+r})}var $y={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function qy(n){if(typeof n!="string")return["",""];const e=n.indexOf(" "),s=Ee(n.substring(0,e));if(s.empty){const r=Ee(n);return r.empty?["",n.toLowerCase()]:[r.name,""]}const i=n.substring(s.name.length+1).toLowerCase();return[s.name,i.length?i:""]}function zy(n){const e=Array.isArray(n)?n:qy(n),s=Ee(e[0]).name,i=xp(e[1]);if(i.empty)return $y;const r=i.name,a=s?i.intervals.map(h=>qa(s,h)):[],c=s?s+" "+r:r;return{...i,name:c,type:r,tonic:s,notes:a}}class Wy{constructor(){this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,paint:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!0,console.log(`[Logger] Enabled category: ${s}`))})}disable(...e){e.forEach(s=>{this.categories.hasOwnProperty(s)&&(this.categories[s]=!1,console.log(`[Logger] Disabled category: ${s}`))})}enableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!0}),this.setLevel("DEBUG"),console.log("[Logger] All categories enabled")}disableAll(){Object.keys(this.categories).forEach(e=>{this.categories[e]=!1}),this.setLevel("ERROR"),console.log("[Logger] All categories disabled")}isCategoryEnabled(e){return this.categories[e]===!0}setLevel(e){const i=["DEBUG","INFO","WARN","ERROR"].indexOf(e);i!==-1&&(this.enabledLevels={DEBUG:i<=0,INFO:i<=1,WARN:i<=2,ERROR:i<=3})}formatComponent(e){return`[${e}]`}moduleLoaded(e,s="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`${e}: Module loaded.`)}initStart(e,s="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`Main.js: Initializing ${e}...`)}initSuccess(e,s="initialization"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||console.log(`Main.js: ${e} initialized successfully.`)}initFailed(e,s="",i="initialization"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(i))return;const r=s?` (${s})`:"";console.warn(`Main.js: ${e} failed to initialize${r}.`)}section(e,s="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(s)||(console.log("========================================"),console.log(e),console.log("========================================"))}event(e,s,i="",r="ui"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e),c=i?`${s}. ${i}`:s;console.log(`${a} ${c}`)}state(e,s,i=null,r="state"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);if(i){const c=typeof i=="object"?JSON.stringify(i):String(i);console.log(`${a} ${s}: ${c}`)}else console.log(`${a} ${s}`)}debug(e,s,i=null,r="debug"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);if(i){const c=typeof i=="object"?JSON.stringify(i):String(i);console.log(`${a} ${s}: ${c}`)}else console.log(`${a} ${s}`)}timing(e,s,i,r="performance"){if(!this.enabledLevels.DEBUG||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e),c=Object.entries(i).map(([h,m])=>typeof m=="number"&&m%1!==0?`${h}=${m.toFixed(3)}`:`${h}=${m}`).join(", ");console.log(`${a} ${s}: ${c}`)}warn(e,s,i=null,r="general"){if(!this.enabledLevels.WARN||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);i?console.warn(`${a} ${s}`,i):console.warn(`${a} ${s}`)}error(e,s,i=null,r="general"){if(!this.enabledLevels.ERROR)return;const a=this.formatComponent(e);i?console.error(`${a} ${s}`,i):console.error(`${a} ${s}`)}info(e,s,i=null,r="general"){if(!this.enabledLevels.INFO||!this.isCategoryEnabled(r))return;const a=this.formatComponent(e);i?console.log(`${a} ${s}`,i):console.log(`${a} ${s}`)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([e,s])=>s).map(([e])=>e)}}getAvailableCategories(){return Object.keys(this.categories)}log(e,s,i=null){this.info(e,s,i,"general")}}const T=new Wy;typeof window<"u"&&(window.logger=T);function Vy(n){const{macrobeatGroupings:e}=n,s=an(n),i=[...n.columnWidths||[]],r=[sa,sa];T.debug("Columns Layout","Starting column width calculation",null,"layout"),T.debug("Columns Layout","Placed tonic signs",s.map(m=>`col:${m.columnIndex},mb:${m.preMacrobeatIndex}`),"layout"),T.debug("Columns Layout","Old columnWidths",i,"layout"),T.debug("Columns Layout","Macrobeat groupings",e,"layout");const a=[...s].sort((m,f)=>m.preMacrobeatIndex-f.preMacrobeatIndex);let c=0;const h=m=>{var g,y;let f=(g=a[c])==null?void 0:g.uuid;for(;a[c]&&a[c].preMacrobeatIndex===m;){T.debug("Columns Layout",`Adding tonic columns for mbIndex ${m}, tonic at column ${a[c].columnIndex}`,null,"layout");const w=r.length;for(r.push(na),r.push(na),T.debug("Columns Layout",`Added 2 columns (width=${na} each), total columns: ${w} -> ${r.length}`,null,"layout");a[c]&&a[c].uuid===f;)c++;f=(y=a[c])==null?void 0:y.uuid}};return h(-1),e.forEach((m,f)=>{for(let g=0;g<m;g++)r.push(na);h(f)}),r.push(sa,sa),T.debug("Columns Layout","Final newColumnWidths",r,"layout"),T.debug("Columns Layout","Width change",`${i.length} -> ${r.length} columns`,"layout"),T.debug("Columns Layout","Old total width units",i.reduce((m,f)=>m+f,0),"layout"),T.debug("Columns Layout","New total width units",r.reduce((m,f)=>m+f,0),"layout"),r}function Hy(n,e,s){let i=0;for(let r=0;r<n;r++)i+=(e[r]||0)*s;return i}function Gy(n,e){return n.reduce((s,i)=>s+i,0)*e}const Ki=30;let We=1,nn=rv,rn=0,ei,rr,vd,Hi,yd,Jo,jc,Uc,Ko,Xc,wa,bd,_a=!1,ys=!1,Cc=0,ar=!1,lr=null;function Yc(){var a;const n=((a=u.state.fullRowData)==null?void 0:a.length)||0;if(n===0)return va;const e=document.getElementById("pitch-grid-container"),s=rn||window.innerHeight||0,i=(e==null?void 0:e.clientHeight)||(s?s*.7:0);if(!i||i<=0)return va;const r=2*i/(n*Ki);return Math.max(va,r)}function jy(){ei=document.getElementById("pitch-grid-wrapper"),rr=document.getElementById("notation-grid"),document.getElementById("drum-grid-wrapper"),Hi=document.getElementById("drum-grid"),Jo=document.getElementById("drum-playhead-canvas"),jc=document.getElementById("playhead-canvas"),Uc=document.getElementById("hover-canvas"),Ko=document.getElementById("drum-hover-canvas"),Xc=document.getElementById("pitch-paint-canvas"),wa=document.getElementById("canvas-macrobeat-tools");const n=document.getElementById("canvas-container");return!ei||!rr||!n?{}:(vd=rr.getContext("2d"),yd=Hi.getContext("2d"),{ctx:vd,drumCtx:yd,canvasContainer:n})}function Ln(){if(!ei||ei.clientHeight===0){requestAnimationFrame(Ln);return}if(_a)return;_a=!0;const n=document.getElementById("pitch-grid-container");ei.clientWidth;const e=window.innerHeight;(Math.abs(e-rn)>3||rn===0)&&(rn=e);const i=Yc();We<i&&(We=i,console.log(`[Zoom] Enforcing minimum zoom to maintain grid height: ${Math.round(We*100)}%`));const r=Ki,a=r*av,c=r*We,h=a*We;u.setLayoutConfig({cellHeight:c,cellWidth:h});const m=Vy(u.state);u.setLayoutConfig({columnWidths:m});const g=m.reduce((ot,dt)=>ot+dt,0)*u.state.cellWidth,y=xt.getModulatedCanvasWidth(),w=y>g?y:g,C=Math.round(w),A=document.getElementById("drum-grid-wrapper"),I=C+"px";n&&(n.style.width=I),ei&&(ei.style.width=I);const E=u.state.columnWidths.length-2;let O=0;for(let ot=0;ot<E;ot++)O+=(u.state.columnWidths[ot]||0)*u.state.cellWidth;const P=2,R=u.state.columnWidths.length-2;let q=0;for(let ot=P;ot<R;ot++)q+=(u.state.columnWidths[ot]||0)*u.state.cellWidth;if(A&&(A.style.width=`${O}px`),wa){wa.style.width=`${q}px`;const ot=u.state.columnWidths.slice(0,P).reduce((dt,yt)=>dt+yt*u.state.cellWidth,0);wa.style.marginLeft=`${ot}px`}[rr,jc,Uc,Xc].forEach(ot=>{ot&&Math.abs(ot.width-C)>1&&(ot.width=C)}),[Hi,Jo,Ko].forEach(ot=>{ot&&Math.abs(ot.width-O)>1&&(ot.width=O)});const G=Math.max(Cr,Tr*u.state.cellHeight),U=lv*G,j=`${U}px`,Y=Math.abs(Cc-U)>5;if(A&&(Y||Cc===0)&&(A.style.height=j,Cc=U),Hi&&Math.abs(Hi.height-U)>1&&(Hi.height=U),Jo&&Math.abs(Jo.height-U)>1&&(Jo.height=U),Ko&&Math.abs(Ko.height-U)>1&&(Ko.height=U),setTimeout(()=>{const dt=document.getElementById("pitch-grid-container").clientHeight;[rr,jc,Uc,Xc].forEach((yt,Tt)=>{yt&&Math.abs(yt.height-dt)>1&&(yt.height=dt)}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))}),lr!==null){const ot=u.state.fullRowData.length;if(ot<=0)nn=0;else{const dt=Math.max(0,Math.min(ot-1,lr)),yt=document.getElementById("pitch-grid-container"),Tt=(yt==null?void 0:yt.clientHeight)||rn*.7,Wt=(u.state.cellHeight||Ki)/2,Qt=Math.max(0,ot*Wt-Tt);if(Qt<=0)nn=0;else{const it=dt*Wt;nn=Math.max(0,Math.min(1,it/Qt))}}lr=null}u.emit("layoutConfigChanged"),_a=!1,ar&&(ar=!1,xt.snapZoomToCurrentRange())}const xt={init(){const{ctx:n,drumCtx:e,canvasContainer:s}=jy();requestAnimationFrame(Ln),this.initScrollHandler();const i=()=>{_a||(clearTimeout(bd),bd=setTimeout(()=>{Ln()},ov))};return window.addEventListener("resize",i),{ctx:n,drumCtx:e}},initScrollHandler(){const n=document.getElementById("pitch-grid-wrapper");n&&n.addEventListener("wheel",e=>{if(e.preventDefault(),e.ctrlKey||e.metaKey)e.deltaY<0?this.zoomIn():this.zoomOut();else{const s=e.deltaY>0?1:-1;this.scrollByUnits(s)}},{passive:!1})},zoomIn(){ys||(u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ys=!0,We=Math.min(ia,We*cv),console.log(`[Zoom] Zoom level: ${Math.round(We*100)}%`),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Ln(),ys=!1})}))},zoomOut(){if(ys)return;u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ys=!0;const n=Yc(),e=Math.max(va,We*hv),s=Math.max(n,e);s!==e&&console.log(`[Zoom] Minimum zoom reached; clamping to ${Math.round(s*100)}%`),We=s,console.log(`[Zoom] Zoom level: ${Math.round(We*100)}%`),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Ln(),ys=!1})})},resetZoom(){ys||(u.state.snapZoomToRange&&u.setSnapZoomToRange(!1),ys=!0,We=1,console.log("[Zoom] Zoom level reset to 100%"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Ln(),ys=!1})}))},snapZoomToCurrentRange(){if(ys){ar=!0;return}const n=Yc(),e=Math.min(ia,n);if(!isFinite(e)||e<=0)return;const s=Math.abs(We-e)>1e-4;ys=!0,We=e,n>ia+1e-4?console.log(`[Zoom] Snap zoom limited by MAX_ZOOM_LEVEL (${Math.round(ia*100)}%)`):s&&console.log(`[Zoom] Snap zoom to range: ${Math.round(We*100)}%`),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Ln(),ys=!1,ar&&(ar=!1,this.snapZoomToCurrentRange())})})},setPendingStartRow(n){typeof n=="number"&&Number.isFinite(n)?lr=Math.max(0,n):lr=null},scroll(n){const e=n/rn/4;nn=Math.max(0,Math.min(1,nn+e)),u.emit("layoutConfigChanged")},scrollByUnits(n){const e=u.state.fullRowData.length,i=(u.state.cellHeight||Ki)/2,a=e*i,c=document.getElementById("pitch-grid-container"),h=(c==null?void 0:c.clientHeight)||rn*.7,m=Math.max(0,a-h);if(m>0){const f=n*i/m;nn=Math.max(0,Math.min(1,nn+f)),u.emit("layoutConfigChanged")}},scrollByPixels(n,e=0){const s=-n,i=u.state.fullRowData.length,a=(u.state.cellHeight||Ki)*We,h=i*a,m=Math.max(0,h-rn);if(m>0){const f=s/m;nn=Math.max(0,Math.min(1,nn+f))}u.emit("layoutConfigChanged")},getViewportInfo(){const n=u.state.fullRowData.length,e=document.getElementById("pitch-grid-container"),s=(e==null?void 0:e.clientHeight)||rn*.7,i=u.state.cellHeight||Ki,r=i/2,c=n*r,m=Math.max(0,c-s)*nn,f=Math.max(0,Math.floor(m/r)),g=s/r,y=Math.min(n,Math.ceil(f+g));return{zoomLevel:We,viewportHeight:rn,containerHeight:s,cellHeight:i,halfUnit:r,startRank:f,endRank:y,scrollOffset:m}},getMacrobeatWidthPx(n,e){return e*n.cellWidth},getColumnX(n){return Hy(n,u.state.columnWidths,u.state.cellWidth)},getCanvasWidth(){return Gy(u.state.columnWidths,u.state.cellWidth)},getModulatedCanvasWidth(){const n=this.getCanvasWidth();if(!u.state.modulationMarkers||u.state.modulationMarkers.length===0)return n;try{const e=u.state.baseMicrobeatPx||u.state.cellWidth||40;let s=n;return u.state.modulationMarkers.forEach(r=>{r.ratio>1&&(s*=r.ratio)}),Math.max(n,s)}catch{return n}},recalculateLayout(){Ln()},get isZooming(){return ys}},Uy=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],an=n=>n.tonicSignGroups?Object.values(n.tonicSignGroups).flat():[],cs=(n,e)=>{let s=2;const{macrobeatGroupings:i}=n,r=an(n);r.some(m=>m.preMacrobeatIndex===-1)&&(s+=2);for(let m=0;m<e;m++)s+=i[m],r.some(f=>f.preMacrobeatIndex===m)&&(s+=2);const a=s,c=i[e],h=a+(c||0)-1;return{startColumn:a,endColumn:h,grouping:c}},Xy=n=>n.placedNotes.filter(e=>!e.isDrum),Yy=n=>n.placedNotes.filter(e=>e.isDrum),Zy=(n,e)=>{const i=an(n).filter(h=>h.columnIndex<=e);if(i.length===0)return{keyTonic:"C",keyMode:"major"};const r=i.reduce((h,m)=>m.columnIndex>h.columnIndex?m:h),a=Da(n.fullRowData[r.row].toneNote),c=Uy[r.tonicNumber-1]||"major";return{keyTonic:a,keyMode:c}},Qy=(n,e)=>{const s=[],{fullRowData:i,placedNotes:r,placedChords:a}=n;return r.forEach(c=>{var h;if(!c.isDrum&&e>=c.startColumnIndex&&e<=c.endColumnIndex){const m=(h=i[c.row])==null?void 0:h.toneNote;m&&s.push(m)}}),a.forEach(c=>{c.position.xBeat===e&&s.push(...c.notes)}),s},Jy=(n,e)=>{const s=new Set,{startColumn:i,endColumn:r}=cs(n,e);for(let c=i;c<=r;c++)Qy(n,c).forEach(m=>{s.add(Da(m))});return Array.from(s)};function Tc(n){if(!n)return null;const e=gy(n);if(!e||e.num===void 0)return null;let s="";const i=e.alt,r=Math.abs(e.num);return i<0?s="".repeat(Math.abs(i)):i>0&&(s="".repeat(i)),`${s}${r}`}function wd(n){return n&&{"1":"2","2":"1","2":"3","3":"2","4":"5","5":"4","5":"6","6":"5","6":"7","7":"6"}[n]||null}function _d(n){return n&&(n.includes("")||n.includes(""))}const Zc={getEnharmonicDegree:wd,hasAccidental:_d,getDegreeForNote(n,e){var f;console.log(" [TONAL] getDegreeForNote called:",{degreeDisplayMode:e.degreeDisplayMode,noteRow:n.row,noteStartCol:n.startColumnIndex});const{keyTonic:s,keyMode:i}=Zy(e,n.startColumnIndex);if(console.log(" [TONAL] Key context:",{keyTonic:s,keyMode:i}),!s)return null;const r=(f=e.fullRowData[n.row])==null?void 0:f.toneNote;if(console.log(" [TONAL] Note pitch:",{notePitch:r}),!r)return null;const a=Da(r);let c,h,m;if(e.degreeDisplayMode==="modal")c=s,h=xc(c,a),m=Tc(h);else{if(i==="major")c=s;else{const g=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(i);if(g>0){const w=["1P","2M","3M","4P","5P","6M","7M"][g];c=ir(s,vy(w))}else c=s}h=xc(c,a),m=Tc(h)}if(console.log(" [TONAL] Calculation:",{keyTonic:s,keyMode:i,referenceTonic:c,notePitchClass:a,rawInterval:h,formattedInterval:m,degreeDisplayMode:e.degreeDisplayMode,enharmonicPreference:n.enharmonicPreference}),n.enharmonicPreference&&_d(m)){const g=wd(m);if(g)return console.log(` [TONAL] Using enharmonic preference: ${m}  ${g}`),g}return m},getDegreesForNotes(n,e){return!n||n.length===0?[]:n.map(s=>{const i=xc(e,Da(s));return Tc(i)})},getRomanNumeralForNotes(n,e,s){if(!n||n.length<2)return null;const[i]=ly(n);if(!i)return null;const r=Hc(i).symbol;if(!r)return null;const[a]=By(e,[r]);if(!a)return null;const c=vr(a),h=c.roman;let m=c.name.replace(h,"");const f=Hc(i).tonic;return m==="6"&&(m="add6"),{roman:h,ext:m,root:f}}};function Ac(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const Ky={addNote(n){const e=this.state.placedNotes.find(i=>!i.isDrum&&i.row===n.row&&i.startColumnIndex===n.startColumnIndex&&i.color===n.color);if(e){if(this.state.degreeDisplayMode!=="off"){const i=Zc.getDegreeForNote(e,this.state);if(Zc.hasAccidental(i))return e.enharmonicPreference=!e.enharmonicPreference,console.log(" [ENHARMONIC] Toggled enharmonic preference for note:",{noteUuid:e.uuid,currentDegree:i,enharmonicPreference:e.enharmonicPreference}),this.emit("notesChanged"),e}return null}const s={...n,uuid:Ac()};return this.state.placedNotes.push(s),this.emit("notesChanged"),s},updateNoteTail(n,e){n.endColumnIndex=e,this.emit("notesChanged")},updateMultipleNoteTails(n,e){n.forEach(s=>{s.endColumnIndex=e}),this.emit("notesChanged")},updateNoteRow(n,e){n.row=e,this.emit("notesChanged")},updateMultipleNoteRows(n,e){n.forEach((s,i)=>{s.row=e[i]}),this.emit("notesChanged")},eraseInPitchArea(n,e,s=1,i=!0){const r=n+s-1,a=e-1,c=e+1;let h=!1;const m=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(f=>{if(f.isDrum)return!0;if(f.shape==="circle"){const g=f.startColumnIndex+1,y=f.startColumnIndex<=r&&g>=n,w=f.row>=a&&f.row<=c;if(y&&w)return!1}else if(f.row>=a&&f.row<=c&&f.startColumnIndex<=r&&f.endColumnIndex>=n)return!1;return!0}),this.state.placedNotes.length<m&&(h=!0),h&&(this.emit("notesChanged"),i&&this.recordState()),h},eraseDrumNoteAt(n,e,s=!0){const i=this.state.placedNotes.length;this.state.placedNotes=this.state.placedNotes.filter(a=>!(a.isDrum&&a.drumTrack===e&&a.startColumnIndex===n));const r=this.state.placedNotes.length<i;return r&&(this.emit("notesChanged"),s&&this.recordState()),r},addTonicSignGroup(n){T.debug("TonicPlacement","Starting addTonicSignGroup",{tonicSignGroup:n},"state");const e=n[0],{preMacrobeatIndex:s}=e;if(T.debug("TonicPlacement","preMacrobeatIndex",{preMacrobeatIndex:s},"state"),Object.values(this.state.tonicSignGroups).flat().some(h=>h.preMacrobeatIndex===s)){T.debug("TonicPlacement","Tonic already exists at this preMacrobeatIndex, returning",null,"state");return}const i=cs(this.state,s+1).startColumn;T.debug("TonicPlacement","Boundary column for shifting notes",{boundaryColumn:i},"state");const r=this.state.placedNotes.filter(h=>h.startColumnIndex>=i);T.debug("TonicPlacement","Notes that will be shifted",{noteRanges:r.map(h=>`${h.startColumnIndex}-${h.endColumnIndex}`)},"state"),this.state.placedNotes.forEach(h=>{if(h.startColumnIndex>=i){const m=h.startColumnIndex,f=h.endColumnIndex;h.startColumnIndex+=2,h.endColumnIndex+=2,T.debug("TonicPlacement",`Shifted note from ${m}-${f} to ${h.startColumnIndex}-${h.endColumnIndex}`,null,"state")}});const a=Ac(),c=n.map(h=>({...h,uuid:a}));this.state.tonicSignGroups[a]=c,T.debug("TonicPlacement","Added tonic group",{uuid:a,columns:c.map(h=>h.columnIndex)},"state"),T.debug("TonicPlacement","Emitting events: notesChanged, rhythmStructureChanged",null,"state"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(n,e=!0){const s=Object.entries(this.state.tonicSignGroups).find(([h,m])=>m.some(f=>f.columnIndex===n));if(!s)return!1;const[i,r]=s,a=r[0].preMacrobeatIndex,c=cs(this.state,a+1).startColumn;return delete this.state.tonicSignGroups[i],this.state.placedNotes.forEach(h=>{h.startColumnIndex>=c&&(h.startColumnIndex-=2,h.endColumnIndex-=2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),e&&this.recordState(),!0},toggleDrumNote(n){const e=this.state.placedNotes.findIndex(s=>s.isDrum&&s.drumTrack===n.drumTrack&&s.startColumnIndex===n.startColumnIndex);e>=0?this.state.placedNotes.splice(e,1):this.state.placedNotes.push({...n,uuid:Ac()}),this.emit("notesChanged"),this.recordState()},clearAllNotes(){this.state.placedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(n){this.state.placedNotes=n,this.emit("notesChanged"),this.recordState()}},t0={setADSR(n,e){this.state.timbres[n]&&(this.state.timbres[n].adsr=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setFilterSettings(n,e){if(this.state.timbres[n]){console.log("setFilterSettings called:",{color:n,newSettings:e,activePresetName:this.state.timbres[n].activePresetName}),console.trace("setFilterSettings call stack"),Object.assign(this.state.timbres[n].filter,e);const s=this.state.timbres[n].filter.blend;s<=0?this.state.timbres[n].filter.type="highpass":s>=2?this.state.timbres[n].filter.type="lowpass":this.state.timbres[n].filter.type="bandpass",e.enabled===void 0&&(console.log("Clearing activePresetName because enabled is undefined"),this.state.timbres[n].activePresetName=null),this.emit("timbreChanged",n)}},setHarmonicCoefficients(n,e){this.state.timbres[n]&&(this.state.timbres[n].coeffs=e,this.state.timbres[n].activePresetName=null,this.emit("timbreChanged",n))},setHarmonicPhases(n,e){this.state.timbres[n]&&(T.debug("TimbreActions",`setHarmonicPhases called for ${n}`,null,"state"),T.debug("TimbreActions","Old phases",{phases:this.state.timbres[n].phases},"state"),T.debug("TimbreActions","New phases",{phases:e},"state"),T.debug("TimbreActions","Coefficients before phase change",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].phases=e,this.state.timbres[n].activePresetName=null,T.debug("TimbreActions","Coefficients after phase change",{coeffs:this.state.timbres[n].coeffs},"state"),T.debug("TimbreActions","Emitting timbreChanged for phase change",null,"state"),this.emit("timbreChanged",n))},applyPreset(n,e){!e||!this.state.timbres[n]||(T.debug("TimbreActions",`applyPreset called for ${n}`,null,"state"),T.debug("TimbreActions","Preset name",{name:e.name},"state"),T.debug("TimbreActions","Preset coeffs",{coeffs:e.coeffs},"state"),T.debug("TimbreActions","Old timbre coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.state.timbres[n].adsr=e.adsr,this.state.timbres[n].coeffs=new Float32Array(e.coeffs),e.phases?this.state.timbres[n].phases=new Float32Array(e.phases):this.state.timbres[n].phases=new Float32Array(this.state.timbres[n].coeffs.length).fill(0),this.state.timbres[n].activePresetName=e.name,this.state.timbres[n].gain=e.gain||1,e.filter?this.state.timbres[n].filter=JSON.parse(JSON.stringify(e.filter)):this.state.timbres[n].filter=cp(),T.debug("TimbreActions","Applied preset - new coeffs",{coeffs:this.state.timbres[n].coeffs},"state"),this.emit("timbreChanged",n),this.recordState())}},Is={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function e0(n,e){if(console.log("[MODULATION] measureIndexToCanvasX called:",{measureIndex:n,hasState:!!e,cellWidth:e?e.cellWidth:"N/A"}),!e){console.warn("[MODULATION] No state provided for measure conversion");const c=n*200;return console.log("[MODULATION] Using fallback calculation:",c),c}const s=e.cellWidth||40;if(console.log("[MODULATION] Using cellWidth:",s),n===0){const c=2*s;return console.log("[MODULATION] Measure 0  column 2 ",c),c}const i=n-1;console.log("[MODULATION] Looking for macrobeat index:",i);const r=cs(e,i);if(console.log("[MODULATION] getMacrobeatInfo result:",r),r){const c=(r.endColumn+1)*s;return console.log("[MODULATION] Found measure info, calculated position:",c),c}console.warn("[MODULATION] Could not find measure info for index:",n);const a=n*s*4;return console.log("[MODULATION] Using improved fallback calculation:",a),a}function s0(n,e,s=null,i=null,r=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:n,ratio:e,active:!0,xPosition:s,columnIndex:i,macrobeatIndex:r}}function Ep(n){return Math.abs(n-Is.COMPRESSION_2_3)<.001?"2:3":Math.abs(n-Is.EXPANSION_3_2)<.001?"3:2":`${n}`}function Pp(n){return Math.abs(n-Is.COMPRESSION_2_3)<.001?"#dc3545":Math.abs(n-Is.EXPANSION_3_2)<.001?"#007bff":"#6c757d"}function xd(n){return{segments:[{startX:0,endX:1/0,scale:1,spacingPx:n}],microbeatToCanvasX(e){return e*n},canvasXToMicrobeat(e){return e/n},getSegmentAtX(e){return this.segments[0]},getGhostGridPositions(e,s){return[]}}}function kp(n,e,s=null){if(!n||n.length===0)return xd(e);const i=[...n.filter(h=>h.active)].sort((h,m)=>h.measureIndex-m.measureIndex);if(i.length===0)return xd(e);console.log("[MODULATION] Creating coordinate mapping for markers:",i);const r=i.map(h=>{let m;return h.xPosition!==null&&h.xPosition!==void 0?(m=h.xPosition,console.log(`[MODULATION] Marker at measure ${h.measureIndex}  using stored x=${m}`)):(m=e0(h.measureIndex,s),console.log(`[MODULATION] Marker at measure ${h.measureIndex}  calculated x=${m}`)),console.log("[MODULATION] Final marker position:",{id:h.id,measureIndex:h.measureIndex,canvasX:m,isStored:h.xPosition!==null&&h.xPosition!==void 0}),{...h,xCanvas:m}}),a=[];let c=1;(r.length===0||r[0].xCanvas>0)&&a.push({startX:0,endX:r.length>0?r[0].xCanvas:1/0,scale:1,spacingPx:e});for(let h=0;h<r.length;h++){const m=r[h],f=h+1<r.length?r[h+1].xCanvas:1/0;c*=m.ratio,a.push({startX:m.xCanvas,endX:f,scale:c,spacingPx:e*c,marker:m})}return{segments:a,microbeatToCanvasX(h){let m=0,f=0;for(const g of a){const w=(g.endX-g.startX)/g.spacingPx;if(f+w>=h){const C=h-f;return g.startX+C*g.spacingPx}f+=w,m=g.endX}return m},canvasXToMicrobeat(h){let m=0;for(const f of a){if(h>=f.startX&&h<f.endX){const w=(h-f.startX)/f.spacingPx;return m+w}const g=f.endX-f.startX;m+=g/f.spacingPx}return m},getSegmentAtX(h){return a.find(m=>h>=m.startX&&h<m.endX)||null},getGhostGridPositions(h,m){if(console.log("[GHOST-CALC] getGhostGridPositions called with:",{segment:h,hasMarker:!!h.marker,hasOptions:!!m}),!h.marker)return console.log("[GHOST-CALC] No marker on segment, returning empty array"),[];if(!m||!m.columnWidths)return console.warn("[GHOST-CALC] No grid options provided"),[];const f=[],{columnWidths:g,cellWidth:y}=m;if(console.log("[GHOST-CALC] Options check:",{hasColumnWidths:!!g,columnCount:g?g.length:0,cellWidth:y,segmentStartX:h.startX,segmentEndX:h.endX,segmentScale:h.scale}),!g||!y||y===0)return console.warn("[GHOST-CALC] Missing grid data"),[];let w=0;for(let C=0;C<g.length;C++){const A=w;if(h.endX===1/0?A>=h.startX:A>=h.startX&&A<h.endX){let O,P;if(h.endX===1/0){const R=g.reduce((q,G)=>q+G,0)*y;P=Math.max(R,h.startX+800),O=P-h.startX}else O=h.endX-h.startX,P=h.endX;if(O>0&&h.scale>0){const R=(A-h.startX)/O,q=O/h.scale,G=h.startX+R*q;!isNaN(G)&&isFinite(G)&&f.push(G)}}const E=g[C]||0;if(w+=E*y,h.endX!==1/0&&w>h.endX)break}return f}}}function n0(n,e,s){let i=0;for(const r of e.segments){if(n>=r.startX&&n<r.endX){const f=(n-r.startX)/r.spacingPx,g=s/r.scale;return i+f*g}const c=(r.endX-r.startX)/r.spacingPx,h=s/r.scale;i+=c*h}return i}const i0={setAnacrusis(n){if(this.state.hasAnacrusis===n)return;const e=this.state.macrobeatGroupings,s=n?op:sv,i=e.reduce((c,h)=>c+h,0),a=s.reduce((c,h)=>c+h,0)-i;if(this.state.hasAnacrusis=n,this.state.macrobeatGroupings=[...s],this.state.macrobeatBoundaryStyles=n?[...rp]:[...nv],a!==0){const c=[];this.state.placedNotes.forEach(f=>{if(f.startColumnIndex>=2){const y=f.startColumnIndex+a,w=f.endColumnIndex+a;y<2?c.push(f):(f.startColumnIndex=y,f.endColumnIndex=w)}}),c.forEach(f=>{const g=this.state.placedNotes.indexOf(f);g>-1&&this.state.placedNotes.splice(g,1)});const h=[];this.state.stampPlacements.forEach(f=>{if(f.startColumn>=2){const y=f.startColumn+a,w=f.endColumn+a;y<2?h.push(f):(f.startColumn=y,f.endColumn=w)}}),h.forEach(f=>{const g=this.state.stampPlacements.indexOf(f);g>-1&&this.state.stampPlacements.splice(g,1)});const m=[];this.state.tripletPlacements&&(this.state.tripletPlacements.forEach(f=>{const g=a/2,y=1;if(f.startCellIndex>=y){const w=f.startCellIndex+g;w<y?m.push(f):f.startCellIndex=w}}),m.forEach(f=>{const g=this.state.tripletPlacements.indexOf(f);g>-1&&this.state.tripletPlacements.splice(g,1)})),Object.values(this.state.tonicSignGroups).flat().forEach(f=>{f.preMacrobeatIndex>=0})}this.emit("anacrusisChanged",n),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(n){if(n===void 0||n<0||n>=this.state.macrobeatGroupings.length){T.error("rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${n}`,null,"state");return}const e=this.state.macrobeatGroupings[n],s=e===2?3:2,i=s-e;let r=2;const a=Object.values(this.state.tonicSignGroups).flat(),c=new Set(a.filter(h=>h.preMacrobeatIndex<n).map(h=>h.uuid)).size;r+=c;for(let h=0;h<=n;h++)r+=this.state.macrobeatGroupings[h];this.state.placedNotes.forEach(h=>{h.startColumnIndex>=r&&(h.startColumnIndex+=i,h.endColumnIndex+=i)}),this.state.macrobeatGroupings[n]=s,this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(n){if(n===void 0||n<0||n>=this.state.macrobeatBoundaryStyles.length){T.error("rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${n}`,null,"state");return}const e=this._isBoundaryInAnacrusis(n);let s;e?s=["dashed","solid","anacrusis"]:s=["dashed","solid"];const i=this.state.macrobeatBoundaryStyles[n],r=s.indexOf(i),a=r===-1?0:(r+1)%s.length;this.state.macrobeatBoundaryStyles[n]=s[a],this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(n){if(!this.state.hasAnacrusis)return!1;for(let e=0;e<=n;e++)if(this.state.macrobeatBoundaryStyles[e]==="solid")return e===n;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){this.state.macrobeatGroupings.length>1&&(this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),this.emit("rhythmStructureChanged"),this.recordState())},updateTimeSignature(n,e){if(!Array.isArray(e)||e.length===0){T.error("rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let s=0,i=0,r=0;for(let C=0;C<this.state.macrobeatGroupings.length;C++){if(r===n){s=C;break}const A=C===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[C]==="solid"||A)&&r++}r=0;for(let C=0;C<this.state.macrobeatGroupings.length;C++)if(r===n){const A=C===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[C]==="solid"||A){i=C;break}}else if(r<n){const A=C===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[C]==="solid"||A)&&r++}const a=i-s+1,c=e.length,h=e.reduce((C,A)=>C+A,0)-this.state.macrobeatGroupings.slice(s,i+1).reduce((C,A)=>C+A,0);let m=2;const f=Object.values(this.state.tonicSignGroups).flat(),g=new Set(f.filter(C=>C.preMacrobeatIndex<=i).map(C=>C.uuid)).size;m+=g;for(let C=0;C<=i;C++)m+=this.state.macrobeatGroupings[C];h!==0&&this.state.placedNotes.forEach(C=>{C.startColumnIndex>=m&&(C.startColumnIndex+=h,C.endColumnIndex+=h)});const y=[...e],w=new Array(c-1).fill("dashed");if(i<this.state.macrobeatBoundaryStyles.length){const C=this.state.macrobeatBoundaryStyles[i];c>0&&w.push(C)}this.state.macrobeatGroupings.splice(s,a,...y),this.state.macrobeatBoundaryStyles.splice(s,a-1,...w),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(n,e,s=null,i=null,r=null){if(!Object.values(Is).includes(e))return T.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state"),null;const a=this.state.modulationMarkers.findIndex(h=>h.measureIndex===n||r!==null&&h.macrobeatIndex===r||i!==null&&h.columnIndex===i);if(a!==-1){const h=this.state.modulationMarkers[a];return T.info("rhythmActions",`Replacing existing modulation marker ${h.id} at measure ${n} (old ratio: ${h.ratio}, new ratio: ${e})`,null,"state"),h.ratio=e,h.xPosition=s,i!==null&&(h.columnIndex=i),r!==null&&(h.macrobeatIndex=r),this.emit("modulationMarkersChanged"),this.recordState(),h.id}const c=s0(n,e,s,i,r);return this.state.modulationMarkers.push(c),this.state.modulationMarkers.sort((h,m)=>h.measureIndex-m.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Added modulation marker ${c.id} at measure ${n} with ratio=${e}, columnIndex=${i}`,null,"state"),console.log("[MODULATION] State after adding marker:",{markerCount:this.state.modulationMarkers.length,markers:this.state.modulationMarkers}),c.id},removeModulationMarker(n){const e=this.state.modulationMarkers.findIndex(s=>s.id===n);if(e===-1){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}this.state.modulationMarkers.splice(e,1),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Removed modulation marker ${n}`,null,"state")},setModulationRatio(n,e){if(!Object.values(Is).includes(e)){T.error("rhythmActions",`Invalid modulation ratio: ${e}`,null,"state");return}const s=this.state.modulationMarkers.find(i=>i.id===n);if(!s){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.ratio=e,this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Updated modulation marker ${n} ratio to ${e}`,null,"state")},moveModulationMarker(n,e){const s=this.state.modulationMarkers.find(i=>i.id===n);if(!s){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}s.measureIndex=e,this.state.modulationMarkers.sort((i,r)=>i.measureIndex-r.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Moved modulation marker ${n} to measure ${e}`,null,"state")},toggleModulationMarker(n){const e=this.state.modulationMarkers.find(s=>s.id===n);if(!e){T.warn("rhythmActions",`Modulation marker not found: ${n}`,null,"state");return}e.active=!e.active,this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Toggled modulation marker ${n} active state to ${e.active}`,null,"state")},clearModulationMarkers(){const n=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),T.info("rhythmActions",`Cleared ${n} modulation markers`,null,"state"),console.log("[MODULATION] All markers cleared")}};function o0(n,e,s){if(!n||typeof n!="object")return!0;const i=e.topIndex,r=s.topIndex,a=s.bottomIndex,c=a-r;let h=!1,m=!1;const f=g=>{if(typeof g!="number")return g;h=!0;const y=g+i;y>=r&&y<=a&&(m=!0);const w=y-r;return Math.max(0,Math.min(c,w))};if(typeof n.row=="number"&&(n.row=f(n.row)),typeof n.startRow=="number"&&(n.startRow=f(n.startRow)),typeof n.endRow=="number"&&(n.endRow=f(n.endRow)),typeof n.mouseRow=="number"&&(n.mouseRow=f(n.mouseRow)),typeof n.baseRow=="number"&&(n.baseRow=f(n.baseRow)),Array.isArray(n.path)){let g=!1;n.path.forEach(y=>{if(y&&typeof y.row=="number"){const w=y.row+i;w>=r&&w<=a&&(g=!0),y.row=Math.max(0,Math.min(c,w-r))}}),n.path.length>0&&(h=!0,g&&(m=!0))}if(Array.isArray(n.points)){let g=!1;n.points.forEach(y=>{if(y&&typeof y.row=="number"){const w=y.row+i;w>=r&&w<=a&&(g=!0),y.row=Math.max(0,Math.min(c,w-r))}}),n.points.length>0&&(h=!0,g&&(m=!0))}return n.data&&typeof n.data=="object"&&Object.entries(n.data).forEach(([g,y])=>{if(y&&typeof y=="object"){if(Array.isArray(y))y.forEach(w=>{if(w&&typeof w.row=="number"){const C=w.row+i;C>=r&&C<=a&&(m=!0),h=!0,w.row=Math.max(0,Math.min(c,C-r))}});else if(typeof y.row=="number"){const w=y.row+i;w>=r&&w<=a&&(m=!0),h=!0,y.row=Math.max(0,Math.min(c,w-r))}}}),!h||m}const r0={toggleAccidentalMode(n){this.state.accidentalMode.hasOwnProperty(n)&&(this.state.accidentalMode[n]=!this.state.accidentalMode[n],this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged"))},toggleFrequencyLabels(){this.state.showFrequencyLabels?(this.state.showFrequencyLabels=!1,this.state.accidentalMode={...this.state.savedAccidentalMode}):(this.state.savedAccidentalMode={...this.state.accidentalMode},this.state.showFrequencyLabels=!0,this.state.accidentalMode={sharp:!1,flat:!1}),this.emit("frequencyLabelsChanged",this.state.showFrequencyLabels),this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged")},toggleFocusColours(){this.state.focusColours=!this.state.focusColours,this.emit("focusColoursChanged",this.state.focusColours),this.emit("layoutConfigChanged")},setSnapZoomToRange(n){const e=!!n;this.state.snapZoomToRange!==e&&(this.state.snapZoomToRange=e,this.emit("snapZoomSettingChanged",e))},setDegreeDisplayMode(n){this.state.degreeDisplayMode,this.state.degreeDisplayMode=this.state.degreeDisplayMode===n?"off":n;const e=this.state.degreeDisplayMode;this.emit("layoutConfigChanged"),this.emit("degreeDisplayModeChanged",e)},setSelectedTool(n,e){if(this.state.selectedTool!==n||n==="tonicization"&&this.state.selectedToolTonicNumber!==e){const i=this.state.selectedTool;this.state.previousTool=i,this.state.selectedTool=n,n==="tonicization"&&e&&(this.state.selectedToolTonicNumber=parseInt(e,10)),this.emit("toolChanged",{newTool:n,oldTool:i})}},setSelectedNote(n,e){const s={...this.state.selectedNote};this.state.selectedNote={shape:n,color:e},this.emit("noteChanged",{newNote:this.state.selectedNote,oldNote:s})},setKeySignature(n){this.state.keySignature!==n&&(this.state.keySignature=n,this.emit("keySignatureChanged",n))},setTempo(n){this.state.tempo=n,this.emit("tempoChanged",n)},setLooping(n){this.state.isLooping=n,this.emit("loopingChanged",n)},setPlaybackState(n,e=!1){this.state.isPlaying=n,this.state.isPaused=e,this.emit("playbackStateChanged",{isPlaying:n,isPaused:e})},toggleWaveformExtendedView(){this.state.waveformExtendedView=!this.state.waveformExtendedView,this.emit("waveformExtendedViewChanged",this.state.waveformExtendedView)},setAdsrTimeAxisScale(n){const e=Math.max(.1,Math.min(5,n));this.state.adsrTimeAxisScale=e,this.emit("adsrTimeAxisScaleChanged",e)},setAdsrComponentWidth(n){const e=Math.max(50,Math.min(200,n));this.state.adsrComponentWidth=e,this.emit("adsrComponentWidthChanged",e)},setLayoutConfig(n){const e={cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]};let s=!1;if(n.cellWidth!==void 0&&this.state.cellWidth!==n.cellWidth&&(this.state.cellWidth=n.cellWidth,s=!0),n.cellHeight!==void 0&&this.state.cellHeight!==n.cellHeight&&(this.state.cellHeight=n.cellHeight,s=!0),n.columnWidths!==void 0){const i=JSON.stringify(this.state.columnWidths||[]),r=JSON.stringify(n.columnWidths);i!==r&&(this.state.columnWidths=[...n.columnWidths],s=!0)}s&&this.emit("layoutConfigChanged",{oldConfig:e,newConfig:{cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]}})},setGridPosition(n){const e=this.state.fullRowData.length-this.state.viewportRows*2,s=Math.max(0,Math.min(n,e));this.state.gridPosition!==s&&(this.state.gridPosition=s,this.emit("layoutConfigChanged"))},shiftGridUp(){this.setGridPosition(this.state.gridPosition-1)},shiftGridDown(){this.setGridPosition(this.state.gridPosition+1)},setPrintOptions(n){this.state.printOptions={...this.state.printOptions,...n},this.emit("printOptionsChanged",this.state.printOptions)},setPrintPreviewActive(n){this.state.isPrintPreviewActive,this.state.isPrintPreviewActive=n,this.emit("printPreviewStateChanged",n)},setPitchRange(n,e={}){const s=Xe.length,i=this.state.pitchRange||{topIndex:0,bottomIndex:s-1};if(!n||s===0)return;const r=n.topIndex??i.topIndex,a=n.bottomIndex??i.bottomIndex,c=Math.max(0,Math.min(s-1,r)),h=Math.max(c,Math.min(s-1,a));if(i.topIndex===c&&i.bottomIndex===h)return;const m=Xe.slice(c,h+1),f=m.length-1;let g=0,y=0,w=0;if(this.state.placedNotes=this.state.placedNotes.filter(I=>{if(I.isDrum)return!0;const E=I.row+i.topIndex;return E<c||E>h?(g+=1,!1):(I.row=E-c,!0)}),this.state.tonicSignGroups){const I={};Object.entries(this.state.tonicSignGroups).forEach(([E,O])=>{const P=O.map(R=>{if(typeof R.row!="number")return null;const q=R.row+i.topIndex;return q<c||q>h?null:{...R,row:q-c}}).filter(Boolean);P.length>0&&(I[E]=P)}),this.state.tonicSignGroups=I}if(Array.isArray(this.state.stampPlacements)&&(this.state.stampPlacements=this.state.stampPlacements.filter(I=>{const E=I.row+i.topIndex;return E<c||E>h?(y+=1,!1):(I.row=E-c,!0)})),Array.isArray(this.state.tripletPlacements)&&(this.state.tripletPlacements=this.state.tripletPlacements.filter(I=>{const E=I.row+i.topIndex;return E<c||E>h?(w+=1,!1):(I.row=E-c,!0)})),Array.isArray(this.state.annotations)&&this.state.annotations.length>0){const I={topIndex:c,bottomIndex:h};this.state.annotations=this.state.annotations.filter(E=>o0(E,i,I))}if(this.state.printOptions){const I=this.state.printOptions.topRow??0,E=this.state.printOptions.bottomRow??f,O=i.topIndex-c,P=Math.max(0,Math.min(f,I+O)),R=Math.max(P,Math.min(f,E+O));this.state.printOptions={...this.state.printOptions,topRow:P,bottomRow:R}}this.state.pitchRange={topIndex:c,bottomIndex:h},this.state.fullRowData=m;let C=null;if(typeof e.maintainGlobalStart=="number"&&Number.isFinite(e.maintainGlobalStart)){const I=Math.round(e.maintainGlobalStart-c);C=Math.max(0,Math.min(f,I))}const A={removedNotes:g,removedStamps:y,removedTriplets:w,maintainStartRow:C};this.emit("pitchRangeChanged",{topIndex:c,bottomIndex:h,metadata:A}),this.emit("layoutConfigChanged"),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("annotationsChanged"),this.recordState()}},a0={addChord(n){},updateChord(n,e){},deleteChord(n){},setActiveChord(n){},setRegionContext(n){},rebuildAllChords(n){},setActiveChordIntervals(n){this.state.activeChordIntervals=n,this.emit("activeChordIntervalsChanged",n)},setIntervalsInversion(n){this.state.isIntervalsInverted=n,this.emit("intervalsInversionChanged",n)},setChordPosition(n){this.state.chordPositionState=n,this.emit("chordPositionChanged",n)},openChordCandidateMenu(n,e,s){this.state.isChordCandidateMenuOpen=!0,this.state.activeMacrobeatIndex=n,this.state.chordCandidates=e,this.state.chordCandidateMenuPosition=s,this.emit("chordCandidateMenuStateChanged")},closeChordCandidateMenu(){this.state.isChordCandidateMenuOpen=!1,this.state.activeMacrobeatIndex=null,this.emit("chordCandidateMenuStateChanged")},applyChordCandidate(n){if(this.state.activeMacrobeatIndex===null)return;const{startColumn:e,endColumn:s}=cs(this.state,this.state.activeMacrobeatIndex);Jy(this.state,this.state.activeMacrobeatIndex);let i="C8";this.state.placedNotes.forEach(g=>{if(g.startColumnIndex>=e&&g.startColumnIndex<=s){const y=this.state.fullRowData[g.row].toneNote;on(y)<on(i)&&(i=y)}});const r=Py(i),c=`${Hc(n).tonic}${r}`,h=ba(n,c).notes.map(g=>or(g));this.state.placedNotes=this.state.placedNotes.filter(g=>g.startColumnIndex<e||g.startColumnIndex>s);const{shape:m,color:f}=this.state.selectedNote;h.forEach(g=>{const y=this.state.fullRowData.findIndex(w=>w.toneNote===g);if(y!==-1){const w={row:y,startColumnIndex:e,endColumnIndex:e,color:f,shape:m,isDrum:!1};this.addNote(w)}}),this.closeChordCandidateMenu(),this.recordState(),this.emit("notesChanged")}};T.moduleLoaded("paintActions","state");const l0={setMicPaintActive(n){this.state.paint.isMicPaintActive=n,T.debug("paintActions",`Mic Paint Active set to: ${n}`,null,"paint"),this.emit("micPaintStateChanged",n)},setPaintDetectionState(n){this.state.paint.isDetecting,this.state.paint.isDetecting=n,T.debug("paintActions",`Paint detection state set to: ${n}`,null,"paint"),this.emit("paintDetectionStateChanged",n)},setDetectedPitch(n){this.state.paint.detectedPitch=n,this.emit("pitchDetected",n)},addPaintPoint(n){this.state.paint.paintHistory.push(n)},clearPaintHistory(){this.state.paint.paintHistory=[],T.debug("paintActions","Paint history cleared",null,"paint"),this.emit("paintHistoryChanged"),this.recordState()},setPaintSettings(n){Object.assign(this.state.paint.paintSettings,n),T.debug("paintActions","Paint settings updated",{settings:this.state.paint.paintSettings},"paint"),this.emit("paintSettingsChanged",this.state.paint.paintSettings),this.recordState()}};T.moduleLoaded("StampActions","stamps");function c0(){return`stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const h0={addStampPlacement(n,e,s,i="#4a90e2"){const r=e+1,a=this.state.stampPlacements.find(h=>h.row===s&&h.startColumn<=r&&h.endColumn>=e);a&&this.removeStampPlacement(a.id);const c={id:c0(),stampId:n,startColumn:e,endColumn:r,row:s,color:i,timestamp:Date.now()};return this.state.stampPlacements.push(c),this.emit("stampPlacementsChanged"),T.debug("StampActions",`Added stamp ${n} at ${e}-${r},${s}`,{stampId:n,startColumn:e,endColumn:r,row:s,placementId:c.id},"stamps"),c},removeStampPlacement(n){const e=this.state.stampPlacements.findIndex(i=>i.id===n);if(e===-1)return!1;const s=this.state.stampPlacements.splice(e,1)[0];return this.emit("stampPlacementsChanged"),T.debug("StampActions",`Removed stamp ${s.stampId} at ${s.startColumn}-${s.endColumn},${s.row}`,{placementId:n,stampId:s.stampId,startColumn:s.startColumn,endColumn:s.endColumn,row:s.row},"stamps"),!0},eraseStampsInArea(n,e,s,i){const r=[];for(const c of this.state.stampPlacements){const h=c.startColumn<=e&&c.endColumn>=n,m=c.row>=s&&c.row<=i;h&&m&&r.push(c.id)}let a=!1;return r.forEach(c=>{this.removeStampPlacement(c)&&(a=!0)}),a},getAllStampPlacements(){return[...this.state.stampPlacements]},getStampAt(n,e){return this.state.stampPlacements.find(s=>s.row===e&&n>=s.startColumn&&n<=s.endColumn)||null},clearAllStamps(){const n=this.state.stampPlacements.length>0;this.state.stampPlacements=[],n&&(this.emit("stampPlacementsChanged"),T.info("StampActions","Cleared all stamp placements",null,"stamps"))},getStampPlaybackData(){return this.state.stampPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{stampId:n.stampId,column:n.startColumn,startColumn:n.startColumn,endColumn:n.endColumn,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,placement:n}}).filter(n=>n.pitch)},updateStampShapeOffset(n,e,s){const i=this.state.stampPlacements.find(r=>r.id===n);if(!i){console.warn("[STAMP SHAPE OFFSET] Placement not found:",n);return}i.shapeOffsets||(i.shapeOffsets={}),console.log("[STAMP SHAPE OFFSET] Updating shape offset:",{placementId:n,shapeKey:e,oldOffset:i.shapeOffsets[e]||0,newOffset:s,baseRow:i.row,targetRow:i.row+s}),i.shapeOffsets[e]=s,this.emit("stampPlacementsChanged")},getShapeRow(n,e){var i;const s=((i=n.shapeOffsets)==null?void 0:i[e])||0;return n.row+s}};T.moduleLoaded("TripletActions","triplets");function u0(){return`triplet-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const d0={addTripletPlacement(n){this.state.tripletPlacements||(this.state.tripletPlacements=[]);const e=this.state.tripletPlacements.find(i=>i.row===n.row&&!(i.startCellIndex+i.span<=n.startCellIndex||n.startCellIndex+n.span<=i.startCellIndex));e&&this.removeTripletPlacement(e.id),this.state.stampPlacements&&this.state.stampPlacements.filter(r=>{if(r.row!==n.row)return!1;const a=Math.floor(r.startColumn/2),c=Math.floor(r.endColumn/2),h=n.startCellIndex+n.span-1;return!(c<n.startCellIndex||a>h)}).forEach(r=>this.removeStampPlacement(r.id));const s={id:u0(),...n};return this.state.tripletPlacements.push(s),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),T.debug("TripletActions",`Added triplet ${n.stampId} at cell ${n.startCellIndex}, row ${n.row}`,{stampId:n.stampId,startCellIndex:n.startCellIndex,span:n.span,row:n.row,placementId:s.id},"triplets"),s},removeTripletPlacement(n){if(!this.state.tripletPlacements)return!1;const e=this.state.tripletPlacements.findIndex(i=>i.id===n);if(e===-1)return!1;const s=this.state.tripletPlacements.splice(e,1)[0];return this.emit("tripletPlacementsChanged"),T.debug("TripletActions",`Removed triplet ${s.stampId} at cell ${s.startCellIndex}, row ${s.row}`,{placementId:n,stampId:s.stampId,startCellIndex:s.startCellIndex,span:s.span,row:s.row},"triplets"),!0},eraseTripletsInArea(n,e,s,i){if(!this.state.tripletPlacements)return!1;const r=Math.floor(n/2),a=Math.floor(e/2),c=[];for(const m of this.state.tripletPlacements)m.row>=s&&m.row<=i&&(m.startCellIndex+m.span-1<r||m.startCellIndex>a||c.push(m.id));let h=!1;return c.forEach(m=>{this.removeTripletPlacement(m)&&(h=!0)}),h},getAllTripletPlacements(){return[...this.state.tripletPlacements||[]]},getTripletAt(n,e){return this.state.tripletPlacements&&this.state.tripletPlacements.find(s=>s.row===e&&n>=s.startCellIndex&&n<s.startCellIndex+s.span)||null},clearAllTripletPlacements(){if(!this.state.tripletPlacements)return;const n=this.state.tripletPlacements.length>0;this.state.tripletPlacements=[],n&&(this.emit("tripletPlacementsChanged"),T.info("TripletActions","Cleared all triplet placements",null,"triplets"))},getTripletPlaybackData(){return this.state.tripletPlacements?this.state.tripletPlacements.map(n=>{const e=this.state.fullRowData[n.row];return{startCellIndex:n.startCellIndex,stampId:n.stampId,row:n.row,pitch:e==null?void 0:e.toneNote,color:n.color,span:n.span,placement:n}}).filter(n=>n.pitch):[]},updateTripletShapeOffset(n,e,s){const i=this.state.tripletPlacements.find(r=>r.id===n);if(!i){console.warn("[TRIPLET SHAPE OFFSET] Placement not found:",n);return}i.shapeOffsets||(i.shapeOffsets={}),console.log("[TRIPLET SHAPE OFFSET] Updating shape offset:",{placementId:n,shapeKey:e,oldOffset:i.shapeOffsets[e]||0,newOffset:s,baseRow:i.row,targetRow:i.row+s}),i.shapeOffsets[e]=s,this.emit("tripletPlacementsChanged")},getTripletShapeRow(n,e){var i;const s=((i=n.shapeOffsets)==null?void 0:i[e])||0;return n.row+s}};T.moduleLoaded("Store","general");const Eh="studentNotationState";function p0(){var n;try{const e=localStorage.getItem(Eh);if(e===null)return;const s=JSON.parse(e);if(s.timbres)for(const i in s.timbres){const r=s.timbres[i];if(r.coeffs&&typeof r.coeffs=="object"){const a=Array.isArray(r.coeffs)?r.coeffs:Object.values(r.coeffs);r.coeffs=new Float32Array(a)}if(r.phases&&typeof r.phases=="object"){const a=Array.isArray(r.phases)?r.phases:Object.values(r.phases);r.phases=new Float32Array(a)}}if(s.paint){const i=hp.paint||{},r=s.paint;s.paint={...i,...r,paintSettings:{...i.paintSettings,...r.paintSettings||{}}}}if(s.pitchRange){const i=(Xe==null?void 0:Xe.length)||((n=s.fullRowData)==null?void 0:n.length)||0,r=Math.max(0,i-1),a=Math.max(0,Math.min(r,s.pitchRange.topIndex??0)),c=Math.max(a,Math.min(r,s.pitchRange.bottomIndex??r));s.pitchRange={topIndex:a,bottomIndex:c}}return s}catch(e){T.error("Store","Could not load state from localStorage",e,"general");return}}function Ip(n){try{const e=JSON.parse(JSON.stringify({placedNotes:n.placedNotes,placedChords:n.placedChords,tonicSignGroups:n.tonicSignGroups,stampPlacements:n.stampPlacements,tripletPlacements:n.tripletPlacements,timbres:n.timbres,macrobeatGroupings:n.macrobeatGroupings,macrobeatBoundaryStyles:n.macrobeatBoundaryStyles,hasAnacrusis:n.hasAnacrusis,baseMicrobeatPx:n.baseMicrobeatPx,modulationMarkers:n.modulationMarkers,tempo:n.tempo,activeChordIntervals:n.activeChordIntervals,selectedNote:n.selectedNote,annotations:n.annotations,pitchRange:n.pitchRange,snapZoomToRange:n.snapZoomToRange,paint:{paintHistory:n.paint.paintHistory,paintSettings:n.paint.paintSettings}}));if(n.timbres)for(const i in n.timbres)n.timbres[i].coeffs&&e.timbres[i]&&(e.timbres[i].coeffs=Array.from(n.timbres[i].coeffs)),n.timbres[i].phases&&e.timbres[i]&&(e.timbres[i].phases=Array.from(n.timbres[i].phases));const s=JSON.stringify(e);localStorage.setItem(Eh,s)}catch(e){T.error("Store","Could not save state to localStorage",e,"general")}}const Sd={...Av,...Ky,...t0,...i0,...r0,...a0,...l0,...h0,...d0,clearSavedState(){try{localStorage.removeItem(Eh),localStorage.removeItem("effectDialValues"),window.location.reload()}catch(n){T.error("Store","Could not clear state from localStorage",n,"general")}}},Go={},Rp=p0(),m0={...hp,...Rp},u={state:m0,on(n,e){Go[n]||(Go[n]=[]),Go[n].push(e)},emit(n,e){Go[n]&&Go[n].forEach(s=>{try{s(e)}catch(i){T.error("Store",`Error in listener for event "${n}"`,i,"general")}})}};for(const n in Sd)u[n]=Sd[n].bind(u);const f0=u.recordState;u.recordState=function(...n){f0.apply(this,n),Ip(this.state)};Rp||Ip(u.state);const g0=Object.freeze(Object.defineProperty({__proto__:null,default:u},Symbol.toStringTag,{value:"Module"}));let Mc=null,Ec=null;const Ph={setContexts({ctx:n,drumCtx:e}){Mc=n,Ec=e},getPitchContext(){return Mc||console.error("CanvasContextService: Pitch context requested before it was set."),Mc},getDrumContext(){return Ec||console.error("CanvasContextService: Drum context requested before it was set."),Ec}},oi=ro,Ks={blend:2,cutoff:31,resonance:0,type:"lowpass"};function Ar(){return{coeffs:new Float32Array(oi).fill(0),phases:new Float32Array(oi).fill(0)}}function v0(){const n=Ar();return n.coeffs[0]=1,n}function y0(){const n=Ar();for(let e=1;e<=oi;e+=2){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=0}return n}function b0(){const n=Ar();for(let e=1;e<=oi;e+=2){const s=e-1;n.coeffs[s]=1/(e*e),n.phases[s]=Math.PI/2}return n}function w0(){const n=Ar();for(let e=1;e<=oi;e++){const s=e-1;n.coeffs[s]=1/e,n.phases[s]=e&1?0:Math.PI}return n}const _0={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function oa(n){const e=Ar(),s=_0[n],i=Math.min(oi,s.amps.length);for(let r=0;r<i;r++)e.coeffs[r]=s.amps[r]||0,e.phases[r]=s.phases[r]||0;return e}const jo={attack:.1,decay:.2,sustain:.8,release:.3},x0={sine:{name:"sine",gain:1,adsr:jo,...v0(),filter:{...Ks}},triangle:{name:"triangle",gain:.81,adsr:jo,...b0(),filter:{...Ks}},square:{name:"square",gain:4/Math.PI,adsr:jo,...y0(),filter:{...Ks}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:jo,...w0(),filter:{...Ks}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:jo,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(oi).fill(0),filter:{...Ks}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...Ks}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...oa("strings"),filter:{...Ks,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...oa("piano"),filter:{...Ks,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...oa("marimba"),filter:{...Ks,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...oa("woodwind"),filter:{...Ks}}};function Hs(n,e){if(!n)return`rgba(204, 204, 204, ${e})`;const s=parseInt(n.slice(lp,id),ya),i=parseInt(n.slice(id,od),ya),r=parseInt(n.slice(od,bv),ya);return`rgba(${s}, ${i}, ${r}, ${e})`}function Va(n,e){if(!n||typeof n!="string")return yv;const s=parseInt(n.slice(lp),ya),i=e<0?wv:_v,r=e<0?e*-1:e,a=s>>16,c=s>>8&255,h=s&255;return"#"+(16777216+(Math.round((i-a)*r)+a)*65536+(Math.round((i-c)*r)+c)*256+(Math.round((i-h)*r)+h)).toString(16).slice(1)}const S0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,C0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,T0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,A0=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`;T.moduleLoaded("HarmonicBins with Columnar Structure");const xa={0:S0,90:C0,180:T0,270:A0},Ds=ro;let Ve,Me,we=new Float32Array(Ds).fill(0),Ft,ns=new Float32Array(Ds).fill(0);const kh=[],Qc=[];let Gi=!1,ks=null;const qi=new Array(Ds).fill(null);let ra=!1;function tr(n,e){const{blend:s,cutoff:i,resonance:r}=e,a=(i-1)/30,c=20,h=n-a,m=a-n;let f=1/(1+Math.pow(Math.max(0,h*c),2)),g=1/(1+Math.pow(Math.max(0,m*c),2));const y=.01;f<y&&(f=0),g<y&&(g=0);const w=f*g;let C;s<=1?C=g*(1-s)+w*s:C=w*(2-s)+f*(s-1);const A=1-(r||0)/105,I=Math.max(.01,.2*A*A),E=Math.exp(-Math.pow((n-a)/I,2)),O=(r||0)/100*.6,P=C+E*O,R=Math.max(0,Math.min(1,P));return R<y?0:R}function M0(n,e){const s=e/100;return 1-s+s*n}let aa=new Float32Array(Ds).fill(1);new Float32Array(Ds).fill(0);function yr(n,e){const s=e.mix||0;if(s===0)return new Float32Array(n);const i=new Float32Array(n.length),r=s/100;for(let a=0;a<n.length;a++){const c=n[a],h=(a+.5)/Ds,m=tr(h,e);if(m<c){const g=(c-m)*r;i[a]=c-g}else i[a]=c;i[a]=Math.max(0,i[a])}return i}function Oa(n){const e=u.state.timbres[n];if(!e)return new Float32Array(Ds);const s=e.filter;return s&&s.enabled!==!1&&(s.mix||0)>0?yr(e.coeffs,s):new Float32Array(e.coeffs)}function Jc(){var h;if((!Ve||!Me||!ks)&&(Ve=document.getElementById("filter-overlay-canvas"),ks=document.querySelector(".harmonic-bins-grid"),Ve&&(Me=Ve.getContext("2d"))),!Ve||!Me||!ks)return;ks.getBoundingClientRect();const{width:n,height:e}=Ve;Me.clearRect(0,0,n,e);const i=e*.95,r=e,a=(h=u.state.timbres[Ft])==null?void 0:h.filter,c=a&&a.enabled!==!1;if(a&&c){const m=a.mix||0;if(m===0){aa.fill(1);return}const f=[];for(let A=0;A<Ds;A++){const I=(A+.5)/Ds,E=tr(I,a);aa[A]=M0(E,m),f.push({bin:A+1,rawFilterAmp:E.toFixed(3),afterMix:aa[A].toFixed(3)})}Me.beginPath();const g=2;for(let A=0;A<=n;A+=g){const I=A/n,E=tr(I,a),O=r-E*i;A===0?Me.moveTo(A,O):Me.lineTo(A,O)}const w=.4+m/100*.6;Me.strokeStyle=Hs(Va(Ft,-.3),w),Me.lineWidth=2.5,Me.stroke();const C=m/100;if(C>0){Me.beginPath(),Me.moveTo(0,0),Me.lineTo(n,0);const A=tr(1,a),I=r-A*i;Me.lineTo(n,I);for(let E=n;E>=0;E-=2){const O=E/n,P=tr(O,a),R=r-P*i;Me.lineTo(E,R)}Me.closePath(),Me.fillStyle=`rgba(255, 255, 255, ${C})`,Me.fill()}}else aa.fill(1)}function cr(){kh.forEach((n,e)=>{const s=n.sliderTrack.querySelector(".slider-fill"),i=n.sliderTrack.querySelector(".harmonic-label-internal"),r=we[e];if(s.style.height=`${r*100}%`,r>0){const c=Va(Ft,-.1);s.style.backgroundColor=Hs(c,1)}else s.style.backgroundColor="transparent";const a=s.querySelector("canvas");a&&a.remove(),r>.1?(i.style.color="rgba(255, 255, 255, 0.35)",i.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(i.style.color="rgba(51, 51, 51, 0.5)",i.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),Jc()}function Pc(n,e=null){var m,f,g,y;if(console.log("[BINS DRAG] handleBinPointerEvent called",{clientX:n.clientX,clientY:n.clientY}),T.debug("HarmonicBins","handleBinPointerEvent called",{target:n.target.className},"filter"),n.target.classList.contains("phase-button")||n.target.closest(".phase-button")||n.target.tagName==="path"||n.target.tagName==="svg"){console.log("[BINS DRAG] Blocked - phase button element"),T.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(e===null){const w=ks.getBoundingClientRect(),C=n.clientX-w.left,A=w.width/Ds;e=Math.floor(C/A),e=Math.max(0,Math.min(Ds-1,e)),console.log("[BINS DRAG] Calculated binIndex:",e,"from x:",C,"binWidth:",A)}T.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:e},"filter");const i=kh[e].sliderTrack.getBoundingClientRect(),r=n.clientY-i.top,a=i.height;we[e];const c=(a-r)/a,h=Math.max(0,Math.min(1,c));if(console.log("[BINS DRAG] Setting bin",e+1,"value:",h.toFixed(3)),(((f=(m=u.state.timbres[Ft])==null?void 0:m.adsr)==null?void 0:f.release)||0)*1e3,h===0){T.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:e},"filter");const w=new Float32Array(u.state.timbres[Ft].coeffs);w[e]=0,we[e]=0,u.setHarmonicCoefficients(Ft,w),qi[e]&&(clearTimeout(qi[e]),qi[e]=null),Gi||(Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Gi=!0);const C=(g=u.state.timbres[Ft])==null?void 0:g.filter;C&&C.enabled!==!1&&(C.mix||0)>0&&yr(w,C),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),T.debug("HarmonicBins",`Set coefficient H${e+1} to 0 for color ${Ft}`,null,"filter")}else{qi[e]&&(clearTimeout(qi[e]),qi[e]=null),Gi||(Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Gi=!0),T.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:u.state.timbres[Ft].coeffs},"filter");const w=new Float32Array(u.state.timbres[Ft].coeffs);T.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:w},"filter"),w[e]=h,we[e]=h,T.debug("HarmonicBins",`AFTER setting newCoeffs[${e}] = ${h}`,{newCoeffs:w},"filter"),u.setHarmonicCoefficients(Ft,w);const C=(y=u.state.timbres[Ft])==null?void 0:y.filter;C&&C.enabled!==!1&&(C.mix||0)>0&&yr(w,C),window.staticWaveformVisualizer&&window.staticWaveformVisualizer.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),T.debug("HarmonicBins",`Updated coefficient H${e+1} to ${h} for color ${Ft}`,null,"filter"),T.debug("HarmonicBins","All coefficients",{newCoeffs:w},"filter")}cr()}function Kc(n,e,s,i){const r=s.coeffs,a=s.phases||new Float32Array(r.length).fill(0);let c=!0,h=!0;if(n.length!==r.length)c=!1;else for(let f=0;f<n.length;f++)if(Math.abs(n[f]-r[f])>.001){c=!1;break}if(e.length!==a.length)h=!1;else for(let f=0;f<e.length;f++)if(Math.abs(e[f]-a[f])>.001){h=!1;break}return c&&h}function Cd(n){if(!n)return;Ft=n;const e=u.state.timbres[n];e&&(e.filter?e.filter.enabled===void 0&&(e.filter.enabled=!0):e.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0},T.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:e.coeffs},"filter"),T.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:e.phases},"filter"),we&&Array.from(we),ns&&Array.from(ns),we=new Float32Array(e.coeffs),e.phases?ns=new Float32Array(e.phases):ns=new Float32Array(we.length).fill(0),Kc(we,ns,e),T.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:we},"filter"),T.debug("HarmonicBins","updateForNewColor - final phases",{phases:ns},"filter"),Qc.forEach(({phaseBtn:s},i)=>{if(!s)return;let a=(ns[i]||0)%(2*Math.PI);a<0&&(a+=2*Math.PI);const c=.1;let h=0;Math.abs(a-Math.PI/2)<c?h=90:Math.abs(a-Math.PI)<c?h=180:Math.abs(a-3*Math.PI/2)<c&&(h=270),s.innerHTML=xa[h]}),cr())}function E0(){var h;const n=document.querySelector(".filter-container"),e=n==null?void 0:n.querySelector(".filter-bins-wrapper"),s=n==null?void 0:n.querySelector(".filter-vertical-blend-wrapper");if(!n||!e||!s){console.error("[FILTER] Missing required elements - aborting init");return}ks=document.createElement("div"),ks.className="harmonic-bins-grid";for(let m=0;m<Ds;m++){const f=document.createElement("div");f.className="slider-column";const g=document.createElement("div");g.className="slider-track";const y=document.createElement("div");y.className="slider-fill",g.appendChild(y);const w=document.createElement("div");w.className="harmonic-label-internal",w.textContent=`${m+1}`,g.appendChild(w),f.appendChild(g);const C=document.createElement("button");C.className="phase-button",C.innerHTML=xa[0],C.dataset.binIndex=m,C.addEventListener("pointerenter",A=>{var I,E,O,P;if(ra){console.log("[SNAP-TO-ZERO]  Drag entered phase button for bin",m+1);const R=.015,q=J.now();if(u.state.timbres[Ft],(O=(E=(I=Gt.synths)==null?void 0:I[Ft])==null?void 0:E.activeNotes)!=null&&O.C4){const G=Gt.synths[Ft].activeNotes.C4;(P=G.oscillators)!=null&&P[m]&&(G.oscillators[m].volume.linearRampTo(-1/0,R,q),console.log("[SNAP-TO-ZERO] Applied smooth ramp for bin",m+1))}setTimeout(()=>{var j;const G=new Float32Array(u.state.timbres[Ft].coeffs);G[m]=0,we[m]=0,u.setHarmonicCoefficients(Ft,G);const U=(j=u.state.timbres[Ft])==null?void 0:j.filter;U&&U.enabled!==!1&&(U.mix||0)>0&&yr(G,U),cr(),console.log("[SNAP-TO-ZERO]  Bin",m+1,"snapped to ZERO via phase button drag")},R*1e3)}}),C.addEventListener("click",A=>{if(ra){console.log("[SNAP-TO-ZERO] Click blocked during drag"),A.preventDefault();return}T.debug("HarmonicBins","Phase button click handler started",null,"filter"),T.debug("HarmonicBins","Current coeffs before phase change",{coeffs:we},"filter"),A.preventDefault();const I=new Float32Array(ns),E=new Float32Array(ns);let P=(E[m]||0)%(2*Math.PI);P<0&&(P+=2*Math.PI);const R=.1;let q=0;Math.abs(P)<R?q=Math.PI/2:Math.abs(P-Math.PI/2)<R?q=Math.PI:Math.abs(P-Math.PI)<R?q=3*Math.PI/2:q=0,E[m]=q,ns=E,window.staticWaveformVisualizer&&window.staticWaveformVisualizer.startPhaseTransition&&window.staticWaveformVisualizer.startPhaseTransition(I,E,m),u.setHarmonicPhases(Ft,E);const G=q===0?0:Math.abs(q-Math.PI/2)<R?90:Math.abs(q-Math.PI)<R?180:270;C.innerHTML=xa[G],T.debug("HarmonicBins",`Phase button clicked for H${m+1}, new phase: ${G}`,null,"filter")}),f.appendChild(C),ks.appendChild(f),kh.push({column:f,label:w,sliderTrack:g,sliderFill:y,phaseBtn:C}),Qc.push({phaseBtn:C})}ks.addEventListener("pointerdown",m=>{if(console.log("[BINS DRAG] Pointerdown event fired",{target:m.target,className:m.target.className}),m.target.classList.contains("phase-button")||m.target.closest(".phase-button")){console.log("[BINS DRAG] Blocked - phase button clicked"),T.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}console.log("[BINS DRAG] Starting drag interaction"),T.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),m.preventDefault(),ra=!0,console.log("[SNAP-TO-ZERO] Drag started - isDraggingBin = true"),Gt.triggerAttack("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!0}),Gi=!0,Pc(m);const f=y=>Pc(y),g=()=>{var w;window.removeEventListener("pointermove",f),window.removeEventListener("pointerup",g),ra=!1,console.log("[SNAP-TO-ZERO] Drag ended - isDraggingBin = false");const y=!!((w=window.staticWaveformVisualizer)!=null&&w.generateWaveform);console.log("[HarmonicBins] stopDrag invoked",{waveformAvailable:y,hasChanges:typeof Pc=="function"}),u.recordState(),Gt.triggerRelease("C4",Ft),u.emit("spacebarPlayback",{color:Ft,isPlaying:!1}),Gi=!1,y?setTimeout(()=>{console.log("[HarmonicBins] Generating static waveform after drag"),window.staticWaveformVisualizer.generateWaveform()},0):console.warn("[HarmonicBins] Static waveform visualizer not ready when drag ended")};window.addEventListener("pointermove",f),window.addEventListener("pointerup",g)}),Ve=document.createElement("canvas"),Ve.id="filter-overlay-canvas",Ve.className="filter-overlay-canvas",Ve.style.pointerEvents="none",Me=Ve.getContext("2d"),ks.appendChild(Ve);const i=document.createElement("div");i.className="vertical-blend-wrapper";const r=document.createElement("div");r.id="vertical-blend-track";const a=document.createElement("div");a.id="vertical-blend-thumb",a.textContent="M",r.appendChild(a),i.appendChild(r),e.appendChild(ks),s.appendChild(i);const c=()=>{const m=Ve.getBoundingClientRect();(Ve.width!==m.width||Ve.height!==m.height)&&(Ve.width=m.width,Ve.height=m.height,Jc())};Ft=((h=u.state.selectedNote)==null?void 0:h.color)||"#4a90e2",Cd(Ft),u.on("timbreChanged",m=>{if(m===Ft){T.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const f=u.state.timbres[m],g=f.coeffs,y=f.phases;let w=!1;if(T.debug("HarmonicBins","Comparing coefficients...",null,"filter"),T.debug("HarmonicBins","Local coeffs",{coeffs:we},"filter"),T.debug("HarmonicBins","Store coeffs",{newCoeffs:g},"filter"),!we||we.length!==g.length)T.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),w=!0;else for(let C=0;C<g.length;C++){const A=Math.abs(we[C]-g[C]);if(A>.001){T.debug("HarmonicBins",`Coefficient ${C} changed: ${we[C]} -> ${g[C]} (diff: ${A})`,null,"filter"),w=!0;break}}T.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),Kc(we||new Float32Array(12),ns||new Float32Array(12),f),we=new Float32Array(g),y?ns=new Float32Array(y):ns=new Float32Array(we.length).fill(0),Kc(we,ns,f),w?(T.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),cr()):(T.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),Jc()),Qc.forEach(({phaseBtn:C},A)=>{if(!C)return;let E=(ns[A]||0)%(2*Math.PI);E<0&&(E+=2*Math.PI);const O=.1;let P=0;Math.abs(E-Math.PI/2)<O?P=90:Math.abs(E-Math.PI)<O?P=180:Math.abs(E-3*Math.PI/2)<O&&(P=270),C.innerHTML=xa[P]})}}),u.on("noteChanged",({newNote:m})=>{m.color&&m.color!==Ft&&Cd(m.color)}),u.on("filterChanged",m=>{if(m===Ft){cr();const f=u.state.timbres[Ft],g=f==null?void 0:f.filter;g&&g.enabled!==!1&&(g.mix||0)>0?yr(f.coeffs,g):new Float32Array(f.coeffs)}}),new ResizeObserver(c).observe(ks),c(),T.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}T.moduleLoaded("SynthEngine");const hr=8,Dp=1/Math.sqrt(hr),P0=200,k0=50;let tn={},Bn,zi,kc,la,Ic,es={},ji=0,Uo=hr;function I0(){if(!Bn)return;const n=J.now();if(ji===0){Uo=.01*hr+(1-.01)*Uo;return}const e=1-Math.exp(-.016/(P0/1e3)),s=Math.max(1,Math.min(hr,ji));Uo=e*s+(1-e)*Uo;const i=Math.sqrt(hr/Uo),r=Dp*i;Bn.gain.rampTo(r,k0/1e3,n)}class R0 extends J.Synth{constructor(e){super(e),this.presetGain=new J.Gain(e.gain||1),this.vibratoLFO=new J.LFO(0,0),this.vibratoDepth=new J.Scale(-1,1),this.vibratoGain=new J.Gain(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new J.LFO(0,0),this.tremoloDepth=new J.Scale(0,1),this.tremoloGain=new J.Gain(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new J.Filter({type:"highpass"}),this.lpFilterForBP=new J.Filter({type:"lowpass"}),this.lpFilterSolo=new J.Filter({type:"lowpass"}),this.hpOutput=new J.Gain,this.bpOutput=new J.Gain,this.lpOutput=new J.Gain,this.hp_bp_fade=new J.CrossFade(0),this.main_fade=new J.CrossFade(0),this.wetDryFade=new J.CrossFade(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),e.filter&&this._setFilter(e.filter),e.vibrato?this._setVibrato(e.vibrato):this._setVibrato({speed:0,span:0}),e.tremelo?this._setTremolo(e.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(e){this.presetGain&&(this.presetGain.gain.value=e)}_setVibrato(e,s=J.now()){if(this.vibratoLFO&&this.vibratoGain){const i=e.speed/100*16;if(e.speed===0||e.span===0){this.vibratoLFO.stop(s),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(s),this.vibratoLFO.frequency.value=i;const c=e.span/100*50/1200,f=440*(Math.pow(2,c)-1);this.vibratoGain.gain.value=f}}_setTremolo(e,s=J.now()){if(this.tremoloLFO&&this.tremoloGain){const i=e.speed/100*16;if(e.speed===0||e.span===0){this.tremoloLFO.stop(s),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(s),this.tremoloGain.gain.value=1;return}this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(s),this.tremoloLFO.frequency.value=i;const r=e.span/100,a=Math.max(0,1-r),c=1;this.tremoloDepth.min=a,this.tremoloDepth.max=c}}_setFilter(e){this.wetDryFade.fade.value=e.enabled?1:0;const s=J.Midi(e.cutoff+35).toFrequency(),i=e.resonance/100*12+.1;this.hpFilter.set({frequency:s,Q:i}),this.lpFilterForBP.set({frequency:s,Q:i}),this.lpFilterSolo.set({frequency:s,Q:i});const r=e.blend;r<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=r):(this.main_fade.fade.value=r-1,this.hp_bp_fade.fade.value=1)}}const Gt={init(){Bn=new J.Gain(Dp),zi=new J.Volume(0),kc=new J.Compressor({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),la=new J.Limiter(-3),Ic=new J.Meter,Bn.connect(zi),zi.connect(kc),kc.connect(la),la.toDestination(),la.connect(Ic),setInterval(()=>{Ic.getValue()},500);for(const e in u.state.timbres){const s=u.state.timbres[e],i=Oa(e),r=i.reduce((f,g)=>f+Math.abs(g),0),a=r>1?i.map(f=>f/r):i,c=s.gain||1,h=new J.PolySynth({polyphony:8,voice:R0,options:{oscillator:{type:"custom",partials:Array.from(a)},envelope:s.adsr,filter:s.filter,vibrato:s.vibrato,tremelo:s.tremelo,gain:c}}).connect(Bn);window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(h,e,Bn);const m=h.triggerAttack;h.triggerAttack=function(...f){const g=m.apply(this,f);return setTimeout(()=>{const y=this._activeVoices;window.audioEffectsManager?y&&y.size>0?y.forEach((w,C)=>{w.effectsApplied||(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,C)=>{w&&!w.effectsApplied&&(window.audioEffectsManager.applyEffectsToVoice(w,e),w.effectsApplied=!0)}):y&&y.size>0?y.forEach((w,C)=>{w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach((w,C)=>{w&&w._setVibrato&&w.vibratoApplied!==!0&&(w._setVibrato(this._currentVibrato),w.vibratoApplied=!0),w&&w._setTremolo&&w.tremoloApplied!==!0&&(w._setTremolo(this._currentTremolo),w.tremoloApplied=!0)})},10),g},h._currentVibrato=s.vibrato,h._currentTremolo=s.tremelo,h._currentFilter=s.filter,tn[e]=h,T.debug("SynthEngine",`Created filtered synth for color: ${e}`,null,"audio")}u.on("timbreChanged",e=>{this.updateSynthForColor(e)}),u.on("filterChanged",e=>{this.updateSynthForColor(e)}),u.on("audioEffectChanged",({effectType:e,parameter:s,value:i,color:r,effectParams:a})=>{this.updateSynthForColor(r)}),u.on("volumeChanged",e=>this.setVolume(e)),setInterval(()=>{I0()},16),T.info("SynthEngine","Initialized with multi-timbral support",null,"audio"),window.synthEngine=this},updateSynthForColor(n){const e=u.state.timbres[n],s=tn[n];if(!s||!e)return;e.vibrato||(e.vibrato={speed:0,span:0},T.debug("SynthEngine",`Initialized vibrato for color ${n}`,e.vibrato,"audio")),e.tremelo||(e.tremelo={speed:0,span:0},T.debug("SynthEngine",`Initialized tremolo for color ${n}`,e.tremelo,"audio")),T.debug("SynthEngine",`Updating timbre for color ${n}`,null,"audio");const i=Oa(n),r=i.reduce((h,m)=>h+Math.abs(m),0),a=r>1?i.map(h=>h/r):i;s.set({oscillator:{partials:Array.from(a)},envelope:e.adsr}),window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(s,n,Bn),s._currentVibrato=e.vibrato,s._currentTremolo=e.tremelo,s._currentFilter=e.filter;const c=s._activeVoices;c&&c.size>0?c.forEach((h,m)=>{if(h._setFilter&&h._setFilter(e.filter),h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}}):s._voices&&Array.isArray(s._voices)&&s._voices.forEach((h,m)=>{if(h&&h._setVibrato&&(h._setVibrato(e.vibrato),h.vibratoApplied=!0),h&&h._setTremolo&&(h._setTremolo(e.tremelo),h.tremoloApplied=!0),h&&h._setFilter&&h._setFilter(e.filter),h&&h._setPresetGain){const f=e.gain||1;h._setPresetGain(f)}})},setVolume(n){zi&&(zi.volume.value=n)},async playNote(n,e,s=J.now()){var c;await(window.initAudio||(()=>J.start()))();const r=(c=u.state.selectedNote)==null?void 0:c.color,a=r?tn[r]:null;a&&a.triggerAttackRelease(n,e,s)},triggerAttack(n,e,s=J.now(),i=!1){const r=tn[e];if(r)if(ji++,i&&window.getDrumVolume){const a=window.getDrumVolume(),c=r.volume.value,h=c+20*Math.log10(a);r.volume.value=h,r.triggerAttack(n,s),setTimeout(()=>{r&&r.volume&&(r.volume.value=c)},100)}else r.triggerAttack(n,s)},triggerRelease(n,e,s=J.now()){const i=tn[e];i&&(i.triggerRelease(n,s),ji=Math.max(0,ji-1))},releaseAll(){for(const n in tn)tn[n].releaseAll();ji=0},createWaveformAnalyzer(n){const e=tn[n];return e?(es[n]||(es[n]=new J.Analyser("waveform",1024),e.connect(es[n]),T.debug("SynthEngine",`Created waveform analyzer for color: ${n}`,null,"waveform")),es[n]):(T.warn("SynthEngine",`No synth found for color: ${n}`,null,"audio"),null)},getWaveformAnalyzer(n){return es[n]||null},getAllWaveformAnalyzers(){const n=new Map;for(const e in es)es[e]&&n.set(e,es[e]);return n},removeWaveformAnalyzer(n){es[n]&&(es[n].dispose(),delete es[n],T.debug("SynthEngine",`Removed waveform analyzer for color: ${n}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const n in es)es[n]&&es[n].dispose();es={},T.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(n){return tn[n]||null},getAllSynths(){return{...tn}},getMainVolumeNode(){return zi||null},getMasterGainNode(){return Bn||null}},xs={adsrComponent:null};class D0{constructor(){this.elements=new Map,this.initialized=!1}init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("pitchPaintCanvas","pitch-paint-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","frequency-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(e,s){const i=document.getElementById(s);i&&this.elements.set(e,i)}get(e){return this.initialized&&this.elements.get(e)||null}getMultiple(...e){const s={};return e.forEach(i=>{s[i]=this.get(i)}),s}has(e){return this.elements.has(e)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const e=this.elements.size,s=Array.from(this.elements.values()).filter(i=>i!==null).length;return{totalCached:e,foundElements:s,missingElements:e-s}}}const ri=new D0;u.on("modulationMarkersChanged",()=>{L0()});u.on("scrollChanged",()=>{ur=null,dr=null});u.on("zoomChanged",()=>{ur=null,dr=null});let er=null,th=null,ur=null,dr=null;function Op(n){const e=JSON.stringify({markers:n.modulationMarkers||[],baseMicrobeatPx:n.baseMicrobeatPx||n.cellWidth||40});if(er&&e===th)return er;const s=n.baseMicrobeatPx||n.cellWidth||40;return er=kp(n.modulationMarkers||[],s,n),th=e,er}function Np(){const n=performance.now();return(!ur||!dr||n-dr>1)&&(ur=xt.getViewportInfo(),dr=n),ur}function ft(n,e){let s=0;const i=Math.floor(n),r=n-i;for(let f=0;f<i;f++){const g=e.columnWidths[f]||0;s+=g*e.cellWidth}if(r>0&&i<e.columnWidths.length){const f=e.columnWidths[i]||0;s+=r*f*e.cellWidth}if(!e.modulationMarkers||e.modulationMarkers.length===0)return s;const a=Op(e),c=e.baseMicrobeatPx||e.cellWidth||40,h=s/c;return a.microbeatToCanvasX(h)}function Rt(n,e){const s=Np(),i=n-s.startRank,r=e.cellHeight/2;return i*r}function Sa(n){let e=(n||"").replace(/\d/g,"").trim();return e=e.replace(/b/g,"").replace(/#/g,""),e}function O0(n,e=1){switch(n){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"E/D":case"D/C":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function N0(){const n=xt.getViewportInfo(),{startRank:e,endRank:s}=n;return{startRow:e,endRow:s}}function L0(){er=null,th=null}function F0(n,e){if(e.modulationMarkers&&e.modulationMarkers.length>0){const a=Op(e),c=e.baseMicrobeatPx||e.cellWidth||40;return a.canvasXToMicrobeat(n)*c/e.cellWidth}let s=0;const{columnWidths:i,cellWidth:r}=e;if(r===0)return 0;for(let a=0;a<i.length;a++){const c=i[a]*r;if(n<s+c){const h=(n-s)/c;return a+h}s+=c}return i.length-1}function B0(n,e){const s=Np(),i=e.cellHeight/2;return n/i+s.startRank}class $0{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.activeAnimations=new Map,this.popDuration={scaleUp:100,scaleDown:300},this.popScale=1.5}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),u.on("tempoChanged",()=>this.invalidateTimeMap()))}handlePlaybackStateChange(){u.state.isPlaying&&!u.state.isPaused?this.startRendering():this.stopRendering()}invalidateTimeMap(){this._lastTempo=0}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.isPlaying||u.state.isPaused||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=this.calculateXFromTime(J.Transport.seconds);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0,this.animationFrameId=requestAnimationFrame(()=>this.render())}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let i=0;i<u.state.columnWidths.length;i++)this.timeMap[i]=e,e+=u.state.columnWidths[i]*s;this.timeMap.push(e)}getColumnX(e){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const i={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return ft(e,i)}else return xt.getColumnX(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const i=this.timeMap[s],r=this.timeMap[s+1]-i,a=e-i,c=this.getColumnX(s),h=this.getColumnX(s+1)-c;return c+(r>0?a/r*h:0)}return null}triggerNotePop(e,s){const i=`${e}-${s}`;this.activeAnimations.set(i,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(e,s){const i=`${e}-${s}`,r=this.activeAnimations.get(i);if(!r)return 1;const a=performance.now(),c=a-r.startTime;if(r.phase==="scaleUp"){if(c>=this.popDuration.scaleUp)return r.phase="scaleDown",r.startTime=a,this.popScale;{const h=c/this.popDuration.scaleUp;return 1+(this.popScale-1)*h}}else if(r.phase==="scaleDown"){if(c>=this.popDuration.scaleDown)return this.activeAnimations.delete(i),1;{const h=c/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*h}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const e=performance.now();for(const[s,i]of this.activeAnimations.entries()){const r=e-i.startTime,a=i.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;r>a&&this.activeAnimations.delete(s)}}}const Vn=new $0,eh=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function Ha(n){return eh.find(e=>e.id===n)}T.moduleLoaded("StampPlacements","stamps");function q0(n,e,s,i="#4a90e2"){return Ha(n)?u.addStampPlacement(n,e,s,i):(T.warn("StampPlacements",`Invalid stamp ID: ${n}`,{stampId:n},"stamps"),null)}function z0(n,e,s,i){return console.log("[STAMP ERASE] Function called with:",{eraseStartCol:n,eraseEndCol:e,eraseStartRow:s,eraseEndRow:i,totalStamps:u.state.stampPlacements.length,allStampPlacements:u.state.stampPlacements.map(r=>({id:r.id,startCol:r.startColumn,endCol:r.endColumn,row:r.row}))}),u.eraseStampsInArea(n,e,s,i)}function W0(){u.clearAllStamps()}function V0(){return u.getStampPlaybackData()}T.moduleLoaded("StampScheduler","stamps");const ca=["0","16n","8n",{"8n":1,"16n":1}];function Lp(n,e=null){const s=Ha(n);if(!s)return T.warn("StampScheduler",`Unknown stamp ID: ${n}`,{stampId:n},"stamps"),[];const i=[];return s.ovals.forEach(r=>{var h;const a=`oval_${r}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[a])||0;i.push({offset:ca[r],duration:"8n",type:"oval",slot:r,shapeKey:a,rowOffset:c}),console.log(`[STAMP DEBUG] Stamp ${n} oval at slot ${r} with offset "${ca[r]}", rowOffset: ${c}`)}),s.diamonds.forEach(r=>{var h;const a=`diamond_${r}`,c=((h=e==null?void 0:e.shapeOffsets)==null?void 0:h[a])||0;i.push({offset:ca[r],duration:"16n",type:"diamond",slot:r,shapeKey:a,rowOffset:c}),console.log(`[STAMP DEBUG] Stamp ${n} diamond at slot ${r} with offset "${ca[r]}", rowOffset: ${c}`)}),console.log(`[STAMP DEBUG] Total events for stamp ${n}:`,i.length,i),i}function Td(n,e,s){return[{id:e+0,span:n,hits:[0],label:`${s} [1]`},{id:e+1,span:n,hits:[1],label:`${s} [2]`},{id:e+2,span:n,hits:[2],label:`${s} [3]`},{id:e+3,span:n,hits:[0,1],label:`${s} [1 2]`},{id:e+4,span:n,hits:[1,2],label:`${s} [2 3]`},{id:e+5,span:n,hits:[0,2],label:`${s} [1 3]`},{id:e+6,span:n,hits:[0,1,2],label:`${s} [1 2 3]`}]}const sh=[...Td("eighth",1,"8th triplet"),...Td("quarter",8,"Quarter triplet")],Fp={eighth:1,quarter:2},Bp=[16.6667,50,83.3333];function ai(n){return sh.find(e=>e.id===n)}T.moduleLoaded("TripletPlacements","triplets");function H0(n,e,s,i="#4a90e2"){const r=ai(n);if(!r)return T.warn("TripletPlacements",`Invalid triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),null;const a=Fp[r.span];if(!G0(e,a,s))return T.debug("TripletPlacements",`Cannot place triplet at cell ${e}, row ${s} - collision detected`,{tripletStampId:n,startCellIndex:e,row:s,span:a},"triplets"),null;const c={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,stampId:n,startCellIndex:e,span:a,row:s,color:i,timestamp:Date.now()};return u.addTripletPlacement(c)}function G0(n,e,s){const i=u.state;if(i.stampPlacements){for(const r of i.stampPlacements)if(r.row===s){const a=Math.floor(r.startColumn/2),c=Math.floor(r.endColumn/2);for(let h=0;h<e;h++){const m=n+h;if(m>=a&&m<=c)return!1}}}if(i.tripletPlacements){for(const r of i.tripletPlacements)if(r.row===s){const a=r.startCellIndex+r.span-1;if(!(n+e-1<r.startCellIndex||n>a))return!1}}return!0}function j0(n,e,s,i){const r=u.state;if(!r.tripletPlacements)return!1;const a=Math.floor(n/2),c=Math.floor(e/2),h=[];for(const m of r.tripletPlacements)m.row>=s&&m.row<=i&&(m.startCellIndex+m.span-1<a||m.startCellIndex>c||h.push(m.id));return h.length>0?(h.forEach(m=>u.removeTripletPlacement(m)),T.debug("TripletPlacements",`Erased ${h.length} triplet groups`,{removedIds:h,eraseArea:{eraseStartCell:a,eraseEndCell:c,eraseStartRow:s,eraseEndRow:i}},"triplets"),!0):!1}function U0(){const n=u.state;return n.tripletPlacements?n.tripletPlacements.map(e=>({startCellIndex:e.startCellIndex,stampId:e.stampId,row:e.row,color:e.color,span:e.span,placement:e})):[]}function X0(){u.clearAllTripletPlacements(),T.info("TripletPlacements","Cleared all triplet placements",null,"triplets")}T.moduleLoaded("TripletScheduler","triplets");function Y0(n){return J.Time(`${n} * 4n`).toSeconds()}function $p(n,e=null){const s=ai(n);if(!s)return T.warn("TripletScheduler",`Unknown triplet stamp ID: ${n}`,{tripletStampId:n},"triplets"),[];const i=[],r=s.span==="eighth"?"8t":"4t",a=r;return s.hits.forEach(c=>{var g;const h=`triplet_${c}`,m=((g=e==null?void 0:e.shapeOffsets)==null?void 0:g[h])||0;let f;if(c===0)f="0";else if(c===1)f=r;else if(c===2){const y=J.Time(r).toSeconds();f=J.Time(y*2).toNotation()}else{const y=J.Time(r).toSeconds();f=J.Time(y*c).toNotation()}i.push({offset:f,duration:a,type:s.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:c,shapeKey:h,rowOffset:m}),T.debug("TripletScheduler",`Triplet stamp ${n} ${s.span} at slot ${c} with offset "${f}", rowOffset: ${m}`,"triplets")}),T.debug("TripletScheduler",`Total events for triplet stamp ${n}:`,i.length,"triplets"),i}function qp(n,e){const{startCellIndex:s,stampId:i,pitch:r}=n,a=ai(i);if(!a){T.warn("TripletScheduler",`Cannot schedule unknown triplet stamp ID: ${i}`,{stampId:i},"triplets");return}const c=Y0(s),h=a.span==="eighth"?"8t":"4t",m=J.Time(h).toSeconds();T.debug("TripletScheduler","Scheduling triplet group",{startCellIndex:s,stampId:i,pitch:r,groupStart:c,stepStr:h,stepSec:m,hits:a.hits},"triplets"),a.hits.forEach(f=>{const g=c+f*m;e.triggerAttackRelease(r,m,g),T.debug("TripletScheduler","Scheduled triplet note",{slot:f,triggerTime:g,duration:m,pitch:r},"triplets")})}function Z0(n){n.forEach(e=>{qp({startCellIndex:e.startCellIndex,stampId:e.stampId,pitch:e.pitch},e.synth)})}function nh(n){const e=ai(n);return e?Fp[e.span]:1}function Q0(n,e,s=[]){const i=nh(e);for(let r=0;r<i;r++){const a=n+r;if(s.some(h=>h.cellIndex===a||h.tripletGroup&&h.tripletGroup.startCellIndex<=a&&a<h.tripletGroup.startCellIndex+nh(h.tripletGroup.stampId)))return T.debug("TripletScheduler",`Triplet placement conflict at cell ${a}`,{startCellIndex:n,tripletStampId:e,span:i},"triplets"),!1}return!0}const J0=Object.freeze(Object.defineProperty({__proto__:null,canPlaceTripletGroup:Q0,getTripletGroupSpan:nh,getTripletScheduleEvents:$p,scheduleTripletGroup:qp,scheduleTripletGroups:Z0},Symbol.toStringTag,{value:"Module"}));function zp(n,e,s){const{cellWidth:i}=s,r=i*.25;if(!n.uuid)return 0;const a=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid);if(a.length===0)return 0;const c=[n,...a];return c.sort((m,f)=>{const g=parseInt(m.uuid.split("-")[1]),y=parseInt(f.uuid.split("-")[1]);return g-y}),c.findIndex(m=>m.uuid===n.uuid)*r}function Wp(n,e){const{cellHeight:s}=e;return(window.animationEffectsManager?window.animationEffectsManager.shouldAnimateNote(n):!1)?(window.animationEffectsManager?window.animationEffectsManager.getVibratoYOffset(n.color):0)*s:0}function Vp(n,e,s,i,r,a){if(!window.animationEffectsManager||!window.animationEffectsManager.shouldFillNote(e))return;const h=window.animationEffectsManager.getFillLevel(e);if(h<=0)return;n.save();const m=1-h,f=n.createRadialGradient(s,i,0,s,i,Math.max(r,a));f.addColorStop(0,"transparent"),f.addColorStop(Math.max(0,m-.05),"transparent"),f.addColorStop(m,e.color+"1F"),f.addColorStop(1,e.color+"BF"),n.beginPath(),n.ellipse(s,i,r,a,0,0,2*Math.PI),n.clip(),n.fillStyle=f,n.fillRect(s-r-10,i-a-10,(r+10)*2,(a+10)*2),n.restore()}function K0(n,e,s){const{cellHeight:i}=s,r=i/2*.12;if(!n.uuid)return 0;const a=e.filter(m=>!m.isDrum&&m.row===n.row&&m.startColumnIndex===n.startColumnIndex&&m.uuid&&m.uuid!==n.uuid&&m.endColumnIndex>m.startColumnIndex);if(a.length===0)return 0;const c=[n,...a];return c.sort((m,f)=>{const g=parseInt(m.uuid.split("-")[1]),y=parseInt(f.uuid.split("-")[1]);return g-y}),c.findIndex(m=>m.uuid===n.uuid)*r}function Hp(n,e,s,i,r,a){var m;console.log(" [SCALE/MODE] drawScaleDegreeText called:",{degreeDisplayMode:s.degreeDisplayMode,noteRow:e.row,noteStartCol:e.startColumnIndex,pitch:(m=s.fullRowData[e.row])==null?void 0:m.pitch});const c=Zc.getDegreeForNote(e,s);if(console.log(" [SCALE/MODE] TonalService returned:",{degreeStr:c,degreeDisplayMode:s.degreeDisplayMode}),!c)return;const h=(e.shape==="oval"?a*uv:a*dv)*s.zoomLevel;h<pv||(n.fillStyle="#212529",n.font=`bold ${h}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(c,i,r))}function Ih(n,e,s,i){const{cellWidth:r,cellHeight:a,zoomLevel:c}=e,h=Rt(i,e),m=Wp(s,e),f=h+m,g=ft(s.startColumnIndex,e);let y;e.modulationMarkers&&e.modulationMarkers.length>0?y=ft(s.startColumnIndex+1,e)-g:y=r;const w=zp(s,u.state.placedNotes,e),C=g+y+w,A=Math.max(mv,y*fv);if(s.endColumnIndex>s.startColumnIndex){const P=ft(s.endColumnIndex+1,e)+w-w,R=K0(s,u.state.placedNotes,e),q=f+R;n.beginPath(),n.moveTo(C,q),n.lineTo(P,q),n.strokeStyle=s.color,n.lineWidth=Math.max(vv,y*gv),n.stroke()}const I=y-A/2,E=a/2-A/2;n.save(),Vp(n,s,C,f,I,E),n.beginPath(),n.ellipse(C,f,I,E,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=ap,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Hp(n,s,e,C,f,a/2)}function Rh(n,e,s,i){const{columnWidths:r,cellWidth:a,cellHeight:c,zoomLevel:h}=e,m=Rt(i,e),f=Wp(s,e),g=m+f,y=ft(s.startColumnIndex,e);let w;e.modulationMarkers&&e.modulationMarkers.length>0?w=ft(s.startColumnIndex+1,e)-y:w=r[s.startColumnIndex]*a;const C=zp(s,u.state.placedNotes,e),A=Math.max(.5,w*.15),I=y+w/2+C,E=w/2-A/2,O=c/2-A/2;n.save(),Vp(n,s,I,g,E,O),n.beginPath(),n.ellipse(I,g,E,O,0,0,2*Math.PI),n.strokeStyle=s.color,n.lineWidth=A,n.shadowColor=s.color,n.shadowBlur=ap,n.stroke(),n.shadowBlur=0,n.shadowColor="transparent",n.restore(),e.degreeDisplayMode!=="off"&&Hp(n,s,e,I,g,c/2)}function Dh(n,e,s){const{cellWidth:i,cellHeight:r}=e,a=Rt(s.row,e),c=ft(s.columnIndex,e);let h;e.modulationMarkers&&e.modulationMarkers.length>0?h=ft(s.columnIndex+1,e)-c:h=i;const m=h*2,f=c+m/2,g=Math.min(m,r)/2*.9;if(g<2||(n.beginPath(),n.arc(f,a,g,0,2*Math.PI),n.strokeStyle="#212529",n.lineWidth=Math.max(.5,h*.05),n.stroke(),!s.tonicNumber))return;const y=s.tonicNumber.toString(),w=g*1.5;w<6||(n.fillStyle="#212529",n.font=`bold ${w}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillText(y,f,a))}function Rc(n){let e=0;for(let s=0;s<n;s++){const i=u.state.columnWidths[s]||0;e+=i*u.state.cellWidth}return e}function Dc(n){const e=u.state.fullRowData[n];return e?e.toneNote.replace("","b").replace("","#"):"C4"}T.moduleLoaded("TransportService");let zs,pr,ae=[];function Oh(){return 60/(u.state.tempo*2)}function tb(){if(!u.state.hasAnacrusis)return ae[2]||0;for(let n=0;n<u.state.macrobeatBoundaryStyles.length;n++)if(u.state.macrobeatBoundaryStyles[n]==="solid"){const e=cs(u.state,n+1);if(e)return ae[e.startColumn]||0}return ae[2]||0}function ih(){var r;T.debug("transportService","calculateTimeMap",{tempo:`${u.state.tempo} BPM`}),ae=[];const n=Oh(),{columnWidths:e,modulationMarkers:s}=u.state,i=an(u.state);s&&s.length>0,eb(n,e,i),T.timing("transportService","calculateTimeMap",{totalDuration:`${(r=ae[ae.length-1])==null?void 0:r.toFixed(2)}s`})}function eb(n,e,s){let i=0;for(let r=0;r<e.length;r++)ae[r]=i,s.some(c=>c.columnIndex===r)||(i+=e[r]*n);ae.push(i)}function sb(n,e,s){let i=0;for(let r=0;r<n;r++){const a=e[r]||0;i+=a*s}return i}function Ad(n){const{modulationMarkers:e}=u.state;if(!e||e.length===0)return ae[n];const s=Oh(),i=u.state.baseMicrobeatPx||u.state.cellWidth||40,r=kp(e,i,u.state),a=sb(n,u.state.columnWidths,i);return n0(a,r,s)}function nb(n){const e=u.state.fullRowData;return e&&e[n.row]?e[n.row].toneNote.replace("","b").replace("","#"):"C4"}function Oc(){var m,f;T.debug("transportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),J.Transport.cancel(),ih(),(m=xs.adsrComponent)==null||m.playheadManager.clearAll();const n=ae[2]||0,e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,s=(f=u.state.lassoSelection)==null?void 0:f.isActive,i=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="note").map(g=>g.id)):null;u.state.placedNotes.forEach(g=>{var E;if(s){const O=`note-${g.row}-${g.columnIndex}-${g.color}-${g.shape}`;if(!i.has(O))return}const y=ae[g.startColumnIndex];if(e&&Ad(g.startColumnIndex),y===void 0)return;if(y<n){T.debug("transportService",`Skipping note at column ${g.startColumnIndex} (regular time ${y}) - before anacrusis offset (${n})`);return}const w=y;let C;const A=ae[g.endColumnIndex+1];if(e&&Ad(g.endColumnIndex+1),A===void 0){T.warn("TransportService",`Skipping note with invalid endColumnIndex: ${g.endColumnIndex+1} (note ends at ${g.endColumnIndex})`,{noteId:g.uuid,startColumnIndex:g.startColumnIndex,endColumnIndex:g.endColumnIndex,lookupIndex:g.endColumnIndex+1,timeMapLength:ae.length,maxValidIndex:ae.length-1,noteShape:g.shape},"audio");return}const I=A-y;if(g.shape==="circle"?(C=I,Oh()):C=I,g.isDrum)J.Transport.schedule(O=>{var P;u.state.isPaused||((P=pr==null?void 0:pr.player(g.drumTrack))==null||P.start(O),Vn.triggerNotePop(g.startColumnIndex,g.drumTrack))},w);else{const O=nb(g),P=g.color,R=((E=u.state.fullRowData[g.row])==null?void 0:E.hex)||"#888888",q=g.uuid,G=u.state.timbres[P];if(!G){T.warn("TransportService",`Timbre not found for color ${P}. Skipping note ${q}`,null,"audio");return}J.Transport.schedule(j=>{var Y;u.state.isPaused||(Gt.triggerAttack(O,P,j),(Y=xs.adsrComponent)==null||Y.playheadManager.trigger(q,"attack",R,G.adsr),u.emit("noteAttack",{noteId:q,color:P}))},w);const U=w+C;J.Transport.schedule(j=>{var Y;Gt.triggerRelease(O,P,j),(Y=xs.adsrComponent)==null||Y.playheadManager.trigger(q,"release",R,G.adsr),u.emit("noteRelease",{noteId:q,color:P})},U)}});const r=V0(),a=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="stamp").map(g=>g.id)):null;r.forEach(g=>{var C;if(s){const A=`stamp-${g.row}-${g.column}-${g.stampId}`;if(!a.has(A))return}const y=ae[g.column];if(y===void 0)return;if(y<n){T.debug("TransportService",`Skipping stamp at column ${g.column} - before anacrusis offset`);return}const w=Lp(g.stampId,g.placement);w.forEach(A=>{const I=J.Time(A.offset).toSeconds(),E=J.Time(A.duration).toSeconds(),O=y+I,P=O+E,R=g.row+A.rowOffset,q=Dc(R);J.Transport.schedule(G=>{u.state.isPaused||Gt.triggerAttack(q,g.color,G)},O),J.Transport.schedule(G=>{u.state.isPaused||Gt.triggerRelease(q,g.color,G)},P)}),T.debug("TransportService",`Scheduled stamp ${g.stampId} with ${w.length} events at column ${g.column}`,{stampId:g.stampId,column:g.column,basePitch:g.pitch,baseRow:g.row,startTime:y,events:w.length,hasShapeOffsets:!!((C=g.placement)!=null&&C.shapeOffsets)},"audio")});const c=U0(),h=s?new Set(u.state.lassoSelection.selectedItems.filter(g=>g.type==="triplet").map(g=>g.id)):null;c.forEach(g=>{var A,I,E;if(s){const O=`triplet-${g.row}-${g.column}-${g.tripletId}`;if(!h.has(O))return}const y=g.startCellIndex*2,w=ae[y];if(w===void 0)return;if(w<n){T.debug("TransportService",`Skipping triplet at cell ${g.startCellIndex} - before anacrusis offset`);return}console.log("[TRANSPORT DEBUG] Scheduling triplet:",{stampId:g.stampId,baseRow:g.row,hasPlacement:!!g.placement,hasShapeOffsets:!!((A=g.placement)!=null&&A.shapeOffsets),shapeOffsets:(I=g.placement)==null?void 0:I.shapeOffsets});const C=$p(g.stampId,g.placement);C.forEach(O=>{const P=J.Time(O.offset).toSeconds(),R=J.Time(O.duration).toSeconds(),q=w+P,G=q+R,U=g.row+O.rowOffset,j=Dc(U);console.log("[TRANSPORT DEBUG] Scheduling shape:",{slot:O.slot,rowOffset:O.rowOffset,baseRow:g.row,shapeRow:U,shapePitch:j}),J.Transport.schedule(Y=>{u.state.isPaused||Gt.triggerAttack(j,g.color,Y)},q),J.Transport.schedule(Y=>{u.state.isPaused||Gt.triggerRelease(j,g.color,Y)},G)}),T.debug("TransportService",`Scheduled triplet ${g.stampId} with ${C.length} events at cell ${g.startCellIndex}`,{stampId:g.stampId,cellIndex:g.startCellIndex,basePitch:Dc(g.row),baseRow:g.row,startTime:w,events:C.length,hasShapeOffsets:!!((E=g.placement)!=null&&E.shapeOffsets)},"audio")}),T.debug("TransportService","scheduleNotes",`Finished scheduling ${u.state.placedNotes.length} notes, ${r.length} stamps, and ${c.length} triplets`,"audio")}function Nc(){const n=ri.get("playheadCanvas");if(!n)return;const e=n.getContext("2d"),s=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,i=Rc(u.state.columnWidths.length-2),r=ae[u.state.columnWidths.length-2]||0;let a=new Set;const c=u.state.tempo;let h=1;function m(){if(J.Transport.state!=="started"||!n)return;const f=u.state.isLooping,g=J.Transport.seconds;if(g>=r){T.info("TransportService","Playback reached end. Stopping playhead.",{currentTime:g,musicalDuration:r,isLooping:f},"transport"),Ui.stop();return}if(u.state.isPaused){zs=requestAnimationFrame(m);return}e.clearRect(0,0,n.width,n.height);let y=g;if(f){const A=J.Transport.loopEnd-J.Transport.loopStart;A>0&&(y=(g-J.Transport.loopStart)%A+J.Transport.loopStart)}let w=0;for(let A=0;A<ae.length-1;A++)if(ae[A]!==void 0&&y>=ae[A]&&y<ae[A+1]){const I=ae[A],O=ae[A+1]-I,P=y-I,R=Rc(A),q=Rc(A+1)-R,G=O>0?P/O:0;w=R+G*q;break}const C=Math.min(w,i);if(s&&u.state.modulationMarkers)for(const A of u.state.modulationMarkers){if(!A.active)continue;const I=A.xPosition||477.5;if(C>=I&&!a.has(A.id)){a.add(A.id);let E;Math.abs(A.ratio-2/3)<.001||Math.abs(A.ratio-3/2)<.001,E=1/A.ratio,h*=E;const O=c*h;J.Transport.bpm.value=O}}C>0&&(e.strokeStyle="rgba(255,0,0,0.8)",e.lineWidth=2,e.beginPath(),e.moveTo(C,0),e.lineTo(C,n.height),e.stroke()),zs=requestAnimationFrame(m)}m()}const Ui={init(){const n=new J.Volume(0);if(pr=new J.Players({H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"}).connect(n),window.synthEngine){const e=window.synthEngine.getMainVolumeNode&&window.synthEngine.getMainVolumeNode();e?n.connect(e):n.toDestination()}else n.toDestination();window.drumVolumeNode=n,window.transportService={drumPlayers:pr},J.Transport.bpm.value=u.state.tempo,u.on("rhythmStructureChanged",()=>this.handleStateChange()),u.on("notesChanged",()=>this.handleStateChange()),u.on("stampPlacementsChanged",()=>this.handleStateChange()),u.on("modulationMarkersChanged",()=>this.handleStateChange()),u.on("tempoChanged",e=>{if(T.event("TransportService",`tempoChanged triggered with new value: ${e} BPM`,null,"transport"),J.Transport.state==="started"){T.info("TransportService","Tempo changed WHILE PLAYING. Resynchronizing transport...",null,"transport");const s=J.Transport.position;T.debug("TransportService",`Saved musical position: ${s}`,null,"transport"),J.Transport.pause(),T.debug("TransportService","Transport paused",null,"transport"),zs&&(cancelAnimationFrame(zs),zs=null),J.Transport.bpm.value=e,T.debug("TransportService",`New BPM set to ${J.Transport.bpm.value}`,null,"transport"),Oc(),J.Transport.start(void 0,s),T.debug("TransportService",`Transport restarted at musical position ${s}`,null,"transport"),u.state.paint.isMicPaintActive||Nc()}else T.debug("TransportService","Tempo changed while stopped/paused. Updating BPM for next run",null,"transport"),J.Transport.bpm.value=e,ih()}),u.on("loopingChanged",e=>J.Transport.loop=e),J.Transport.on("stop",()=>{var e;T.event("TransportService","Tone.Transport 'stop' fired. Resetting playback state",null,"transport"),u.setPlaybackState(!1,!1),(e=xs.adsrComponent)==null||e.playheadManager.clearAll(),zs&&(cancelAnimationFrame(zs),zs=null)}),T.info("TransportService","Initialized",null,"transport")},handleStateChange(){if(J.Transport.state==="started"){T.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling",null,"transport");const n=J.Transport.position;J.Transport.pause(),Oc(),J.Transport.start(void 0,n)}else ih()},start(){T.info("TransportService","Starting playback",null,"transport"),(window.initAudio||(()=>J.start()))().then(()=>{Oc();const e=ae[u.state.columnWidths.length-2]||0,s=ae[2]||0,i=tb();J.Transport.loopStart=i,J.Transport.loopEnd=e,J.Transport.loop=u.state.isLooping,J.Transport.bpm.value=u.state.tempo,T.debug("TransportService",`Transport configured. Loop: ${J.Transport.loop}, BPM: ${J.Transport.bpm.value}, StartOffset: ${s}, LoopStart: ${i}`,null,"transport"),u.state.modulationMarkers&&u.state.modulationMarkers.length>0,J.Transport.start(J.now(),s),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive?(u.emit("playbackStateChanged",{isPlaying:!0,isPaused:!1}),T.debug("TransportService","Paint playhead is active, skipping regular playhead animation",null,"transport")):Nc(),u.emit("playbackStarted")})},resume(){T.info("TransportService","Resuming playback",null,"transport"),(window.initAudio||(()=>J.start()))().then(()=>{J.Transport.start(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStart&&window.PaintPlaybackService.onTransportStart(),u.state.paint.isMicPaintActive||Nc(),u.emit("playbackResumed")})},pause(){T.info("TransportService","Pausing playback",null,"transport"),J.Transport.pause(),zs&&(cancelAnimationFrame(zs),zs=null),u.emit("playbackPaused")},stop(){T.info("TransportService","Stopping playback and clearing visuals",null,"transport"),J.Transport.stop(),window.PaintPlaybackService&&window.PaintPlaybackService.onTransportStop&&window.PaintPlaybackService.onTransportStop(),J.Transport.cancel(),Gt.releaseAll();const n=ri.get("playheadCanvas");n&&n.getContext("2d").clearRect(0,0,n.width,n.height),u.state.paint.isMicPaintActive&&u.emit("playbackStateChanged",{isPlaying:!1,isPaused:!1}),u.emit("playbackStopped")}};let ha=!1,Wi="C4",Na=null,ls=[];function ib(n){const e=u.state.fullRowData[n.row];return e?e.toneNote:"C4"}function Md(){const n=u.state.placedNotes.slice().reverse().find(e=>!e.isDrum);Wi=n?ib(n):"C4"}function Ed(n){const{activeChordIntervals:e}=u.state;return!n||!e||!e.length?[]:e.map(s=>{const i=ir(n,s);return or(i)})}function ob(){Md(),u.on("notesChanged",Md),document.addEventListener("keydown",n=>{var h,m;if(n.code!=="Space"||ha)return;const e=document.activeElement,s=e.tagName.toLowerCase(),i=e.contentEditable==="true";if(["input","textarea"].includes(s)||i)return;n.preventDefault(),ha=!0;const r=(h=u.state.selectedNote)==null?void 0:h.color;let a,c=[];if(Na&&r){const f=u.state.fullRowData[Na.row];a=f?f.toneNote:Wi,u.state.selectedTool==="chord"?c=Ed(a):c=[a]}else r&&Wi&&(a=Wi,u.state.selectedTool==="chord"?c=Ed(Wi):c=[Wi]);if(c.length>0){ls={pitches:[...c],rootNote:a,color:r},c.forEach(C=>{Gt.triggerAttack(C,r)});const f=u.state.fullRowData.find(C=>C.toneNote===a),g=f?f.hex:"#888888",y=u.state.timbres[r].adsr;(m=xs.adsrComponent)==null||m.playheadManager.trigger("spacebar","attack",g,y),u.emit("spacebarPlayback",{note:a,color:r,isPlaying:!0});const w=`spacebar-${Date.now()}`;u.emit("noteAttack",{noteId:w,color:r}),ls.noteId=w}}),document.addEventListener("keyup",n=>{var e;if(!(n.code!=="Space"||!ha)&&(n.preventDefault(),ha=!1,ls.pitches&&ls.pitches.length>0)){ls.pitches.forEach(a=>{Gt.triggerRelease(a,ls.color)});const s=u.state.fullRowData.find(a=>a.toneNote===ls.rootNote),i=s?s.hex:"#888888",r=u.state.timbres[ls.color].adsr;(e=xs.adsrComponent)==null||e.playheadManager.trigger("spacebar","release",i,r),u.emit("spacebarPlayback",{note:ls.rootNote,color:ls.color,isPlaying:!1}),ls.noteId&&u.emit("noteRelease",{noteId:ls.noteId,color:ls.color}),ls=[]}})}function rb(n,e){var i;Na={col:n,row:e};const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&u.emit("ghostNoteUpdated",{color:s})}function Gp(){Na=null,u.emit("ghostNoteCleared")}let Ga=!1,Nh=[],Ca=null;function jp(){Ga=!0}function ab(){Ga=!1}function Up(n){try{return JSON.parse(JSON.stringify(n,(e,s)=>s instanceof Float32Array?{__type:"Float32Array",data:Array.from(s)}:s))}catch{return null}}function oh(n,e,s="root"){const i=[];if(!n||!e)return i;if(typeof n!=typeof e)return i.push({path:s,type:"type_change",oldValue:typeof n,newValue:typeof e,timestamp:Date.now()}),i;if(typeof n!="object")return n!==e&&i.push({path:s,type:"value_change",oldValue:n,newValue:e,timestamp:Date.now()}),i;if(Array.isArray(n)){if(!Array.isArray(e))return i.push({path:s,type:"array_to_non_array",oldLength:n.length,newType:typeof e,timestamp:Date.now()}),i;n.length!==e.length&&i.push({path:s,type:"array_length_change",oldLength:n.length,newLength:e.length,timestamp:Date.now()});const a=Math.max(n.length,e.length);for(let c=0;c<a;c++){const h=oh(n[c],e[c],`${s}[${c}]`);i.push(...h)}return i}const r=new Set([...Object.keys(n),...Object.keys(e)]);for(const a of r)if(!(a in n))i.push({path:`${s}.${a}`,type:"property_added",newValue:e[a],timestamp:Date.now()});else if(!(a in e))i.push({path:`${s}.${a}`,type:"property_removed",oldValue:n[a],timestamp:Date.now()});else{const c=oh(n[a],e[a],`${s}.${a}`);i.push(...c)}return i}function lb(n){Ga&&(Ca=Up(n))}function Pd(n,e="unknown"){if(!Ga||!Ca)return;const s=Up(n),i=oh(Ca,s);if(i.length>0){const r=i.filter(a=>!a.path.includes("paint.paintHistory")&&!a.path.includes("tempo")&&!a.path.includes("isPlaying")&&!a.path.includes("fullRowData")&&!a.path.includes("columnWidths"));r.length>0&&(console.error("[STATE GUARD] Unauthorized state mutations detected!",{action:e,mutations:r,totalMutations:i.length,criticalMutations:r.length}),r.forEach(a=>{console.error("[STATE MUTATION]",{path:a.path,type:a.type,oldValue:a.oldValue,newValue:a.newValue,action:e})}),Nh.push({action:e,mutations:r,timestamp:Date.now()}))}Ca=s}function cb(){return[...Nh]}function hb(){Nh=[]}window.stateGuard={enable:jp,disable:ab,getLog:cb,clearLog:hb};T.moduleLoaded("KeyboardHandler","keyboard");function ub(){document.addEventListener("keydown",n=>{var a,c,h;const e=document.activeElement,s=e.tagName.toLowerCase(),i=e.contentEditable==="true";if(["input","textarea"].includes(s)||i)return;if(n.ctrlKey&&n.key.toLowerCase()==="p"){n.preventDefault(),T.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),u.emit("printPreviewStateChanged",!0);return}if(n.ctrlKey&&n.key.toLowerCase()==="z"){n.preventDefault(),u.undo();return}if(n.ctrlKey&&n.key.toLowerCase()==="y"){n.preventDefault(),u.redo();return}let r=!1;switch(n.key){case"Escape":(a=u.state.lassoSelection)!=null&&a.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),r=!0,T.debug("KeyboardHandler","Lasso selection cleared (Escape)",null,"keyboard"));break;case"Enter":(c=u.state.lassoSelection)!=null&&c.isActive&&(u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.emit("lassoSelectionCleared"),u.emit("render"),r=!0,T.debug("KeyboardHandler","Lasso selection cleared (Enter)",null,"keyboard"));break;case"Backspace":case"Delete":if((h=u.state.lassoSelection)!=null&&h.isActive){const m=u.state.lassoSelection.selectedItems;m.filter(f=>f.type==="note").forEach(f=>{const g=u.state.placedNotes.findIndex(y=>y.row===f.data.row&&y.columnIndex===f.data.columnIndex&&y.color===f.data.color&&y.shape===f.data.shape);g!==-1&&u.state.placedNotes.splice(g,1)}),m.filter(f=>f.type==="stamp").forEach(f=>{const g=u.state.stampPlacements.findIndex(y=>y.row===f.data.row&&y.column===f.data.column&&y.stampId===f.data.stampId);g!==-1&&u.state.stampPlacements.splice(g,1)}),m.filter(f=>f.type==="triplet").forEach(f=>{const g=u.state.tripletPlacements.findIndex(y=>y.row===f.data.row&&y.column===f.data.column&&y.tripletId===f.data.tripletId);g!==-1&&u.state.tripletPlacements.splice(g,1)}),u.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},u.recordState(),u.emit("render"),r=!0,T.info("KeyboardHandler",`Deleted ${m.length} items from lasso selection`,null,"keyboard")}break;case"ArrowUp":u.shiftGridUp(),r=!0;break;case"ArrowDown":u.shiftGridDown(),r=!0;break;case"ArrowLeft":T.debug("KeyboardHandler","Emitting 'zoomOut' event",null,"keyboard"),u.emit("zoomOut"),r=!0;break;case"ArrowRight":T.debug("KeyboardHandler","Emitting 'zoomIn' event",null,"keyboard"),u.emit("zoomIn"),r=!0;break}r&&n.preventDefault()}),T.info("KeyboardHandler","Initialized",null,"keyboard")}class db{constructor(){this.canvasContainer=null,this.pitchGridWrapper=null,this.drumGridWrapper=null,this.isInitialized=!1,this.isScrolling=!1,this.lastScrollTime=0,this.pendingSync=null}init(){if(this.canvasContainer=document.getElementById("canvas-container"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),!this.canvasContainer||!this.pitchGridWrapper||!this.drumGridWrapper){console.error("ScrollSyncService: Required elements not found");return}this.setupScrollSynchronization(),this.isInitialized=!0}setupScrollSynchronization(){const e=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container")].filter(i=>i!==null),s=[...e,this.drumGridWrapper].filter(i=>i!==null);e.forEach(i=>{i.addEventListener("scroll",r=>{const a=Date.now();if(a-this.lastScrollTime<10)return;if(this.lastScrollTime=a,this.isScrolling){console.log(" ScrollSync: Ignoring scroll event - sync in progress");return}this.isScrolling=!0;const c=r.target.scrollLeft;console.log(` ScrollSync: ${r.target.id||r.target.className} scrolled to ${c}px`),this.pendingSync&&cancelAnimationFrame(this.pendingSync),this.syncAllTargets(r.target,c,s),this.isScrolling=!1})})}syncAllTargets(e,s,i){i.forEach(r=>{r!==e&&Math.abs(r.scrollLeft-s)>2&&(r.scrollLeft=s)})}syncScrollTo(e){if(!this.isInitialized)return;this.isScrolling=!0;const s=[this.canvasContainer,this.pitchGridWrapper,document.getElementById("pitch-grid-container"),this.drumGridWrapper].filter(i=>i!==null);this.syncAllTargets(null,e,s),setTimeout(()=>{this.isScrolling=!1},10)}}const pb=new db;function mb(){const n=document.getElementById("anacrusis-on-btn"),e=document.getElementById("anacrusis-off-btn");!n||!e||(n.addEventListener("click",()=>u.setAnacrusis(!0)),e.addEventListener("click",()=>u.setAnacrusis(!1)),u.on("anacrusisChanged",s=>{n.classList.toggle("active",s),e.classList.toggle("active",!s)}),n.classList.toggle("active",u.state.hasAnacrusis),e.classList.toggle("active",!u.state.hasAnacrusis))}function fb(){const n=document.getElementById("hide-drumgrid-toggle"),e=document.getElementById("drum-grid-wrapper");let s=!0;n&&e&&n.addEventListener("click",()=>{s=!s,e.style.display=s?"flex":"none",n.querySelector(".sidebar-button-text").textContent=s?"Hide Drum Grid":"Show Drum Grid",setTimeout(()=>xt.recalculateLayout(),10)})}function gb(){const n=document.getElementById("settings-button"),e=document.getElementById("sidebar"),s=document.getElementById("sidebar-overlay"),i=document.getElementById("volume-icon-button"),r=document.getElementById("volume-popup"),a=document.getElementById("vertical-volume-slider"),c=()=>document.body.classList.toggle("sidebar-open");n&&e&&s&&(n.addEventListener("click",c),s.addEventListener("click",c)),i&&r&&a&&(i.addEventListener("click",h=>{h.stopPropagation();const m=r.classList.toggle("visible");i.classList.toggle("active",m)}),a.addEventListener("input",function(){const h=parseInt(this.value,10),m=h===0?-1/0:h/100*37.5-50;u.emit("volumeChanged",m)}),document.addEventListener("click",h=>{!r.contains(h.target)&&h.target!==i&&(r.classList.remove("visible"),i.classList.remove("active"))}),a.dispatchEvent(new Event("input"))),mb(),fb()}function Xp(){const n=new Date,e=n.toLocaleDateString("en-US",{month:"long"}),s=n.getDate();return`SN-score-${e}${s}.csv`}async function vb(n){try{const e={suggestedName:Xp(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},i=await(await window.showSaveFilePicker(e)).createWritable();await i.write(n),await i.close()}catch(e){e.name!=="AbortError"&&console.error("Error saving file with picker:",e)}}function yb(n){const e=document.createElement("a"),s=URL.createObjectURL(n);e.setAttribute("href",s),e.setAttribute("download",Xp()),document.body.appendChild(e),e.click(),document.body.removeChild(e),URL.revokeObjectURL(s)}function bb(){return u.state.placedNotes.map(n=>[n.row,n.startColumnIndex,n.endColumnIndex,n.color,n.shape,n.tonicNumber||"",n.isDrum,n.drumTrack||""].join(",")).join(`
`)}function wb(){var n,e,s,i;(n=document.getElementById("save-as-button"))==null||n.addEventListener("click",async()=>{const r=bb(),a=new Blob([r],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await vb(a):yb(a)}),(e=document.getElementById("import-button"))==null||e.addEventListener("click",()=>{const r=document.createElement("input");r.type="file",r.accept=".csv,.txt",r.onchange=a=>{const c=a.target.files[0];if(!c)return;const h=new FileReader;h.onload=m=>{const g=m.target.result.split(`
`).filter(y=>y.trim()).map(y=>{const w=y.split(",");return{row:parseInt(w[0]),startColumnIndex:parseInt(w[1]),endColumnIndex:parseInt(w[2]),color:w[3],shape:w[4],tonicNumber:w[5]?parseInt(w[5]):null,isDrum:w[6]==="true",drumTrack:w[7]||null}});u.loadNotes(g)},h.readAsText(c)},r.click()}),(s=document.getElementById("print-button"))==null||s.addEventListener("click",()=>{document.body.classList.remove("sidebar-open"),u.emit("printPreviewStateChanged",!0)}),(i=document.getElementById("reset-canvas-button"))==null||i.addEventListener("click",()=>{window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&u.clearSavedState()})}class _b{constructor(){var e,s,i,r,a;this.overlay=document.getElementById("notification-overlay"),this.modal=(e=this.overlay)==null?void 0:e.querySelector(".notification-modal"),this.title=(s=this.overlay)==null?void 0:s.querySelector(".notification-title"),this.message=(i=this.overlay)==null?void 0:i.querySelector(".notification-message"),this.actionsContainer=(r=this.overlay)==null?void 0:r.querySelector(".notification-actions"),this.closeButton=(a=this.overlay)==null?void 0:a.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){var e;this.overlay&&((e=this.closeButton)==null||e.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",s=>{s.target===this.overlay&&this.hide()}),document.addEventListener("keydown",s=>{var i;s.key==="Escape"&&((i=this.overlay)!=null&&i.classList.contains("visible"))&&this.hide()}))}show(e={}){if(!this.overlay)return;const{title:s="Notice",message:i="",buttons:r=[{text:"OK",primary:!0,action:()=>this.hide()}]}=e;this.title&&(this.title.textContent=s),this.message&&(this.message.textContent=i),this.actionsContainer&&(this.actionsContainer.innerHTML="",r.forEach(a=>{const c=document.createElement("button");c.className=`notification-button ${a.primary?"":"secondary"}`,c.textContent=a.text,c.addEventListener("click",()=>{a.action?a.action():this.hide()}),this.actionsContainer.appendChild(c)})),this.overlay.classList.add("visible"),setTimeout(()=>{var c;const a=(c=this.actionsContainer)==null?void 0:c.querySelector(".notification-button");a==null||a.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(e,s="Notice"){this.show({title:s,message:e,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(e,s="Confirm"){return new Promise(i=>{this.show({title:s,message:e,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),i(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),i(!0)}}]})})}}const kd=new _b,rh=40,xb=rh;class Id{constructor(e,s,i,r){this.element=e,this.viewportEl=e==null?void 0:e.querySelector(".clef-wheel-viewport"),this.optionsEl=e==null?void 0:e.querySelector(".clef-wheel-options"),this.onChange=r,this.options=s,this.selectedIndex=0,this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.silent=!1,this.optionHeight=rh,this.resizeObserver=null,this.debugLabel=(e==null?void 0:e.id)||"clef-wheel",!(!e||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(i,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){this.optionsEl.innerHTML="",this.optionNodes=this.options.map((e,s)=>{const i=document.createElement("div");return i.className="clef-wheel-option",i.dataset.index=s.toString(),i.textContent=e.label,this.optionsEl.appendChild(i),i})}attachEvents(){this.element.addEventListener("wheel",s=>{s.preventDefault(),s.stopPropagation();const i=Math.sign(s.deltaY);i!==0&&this.increment(i)},{passive:!1}),this.element.addEventListener("keydown",s=>{s.key==="ArrowUp"?(s.preventDefault(),this.increment(-1)):s.key==="ArrowDown"?(s.preventDefault(),this.increment(1)):s.key==="Home"?(s.preventDefault(),this.setIndex(0)):s.key==="End"&&(s.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",s=>{if(this.pointerActive=!0,this.pointerId=s.pointerId,this.lastPointerY=s.clientY,this.deltaBuffer=0,typeof this.element.setPointerCapture=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",s=>{if(!this.pointerActive||s.pointerId!==this.pointerId)return;const i=s.clientY-this.lastPointerY;if(this.lastPointerY=s.clientY,i===0)return;this.deltaBuffer+=i;const r=this.optionHeight||xb;for(;Math.abs(this.deltaBuffer)>=r;){const a=Math.sign(this.deltaBuffer);this.increment(a),this.deltaBuffer-=a*r}});const e=s=>{this.pointerActive&&s.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element.hasPointerCapture(s.pointerId)&&this.element.releasePointerCapture(s.pointerId))};this.element.addEventListener("pointerup",e),this.element.addEventListener("pointercancel",e),this.element.addEventListener("pointerleave",s=>{this.pointerActive&&s.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element.hasPointerCapture(s.pointerId)&&this.element.releasePointerCapture(s.pointerId))})}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(e=>{for(const s of e)s.target===this.element&&s.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(e){if(e===0||!this.options||this.options.length===0)return;const s=this.selectedIndex+e;this.setIndex(s)}setIndex(e,{silent:s=!1}={}){if(!this.optionsEl)return;const i=Math.max(0,Math.min(this.options.length-1,e));if(i===this.selectedIndex){this.updateVisuals();return}this.selectedIndex=i,this.updateVisuals(),!s&&typeof this.onChange=="function"&&this.onChange(i,this.options[i])}updateVisuals(){var h,m;if(!this.optionsEl||!this.viewportEl)return;const e=this.viewportEl.clientHeight||0,s=(h=this.optionNodes)==null?void 0:h[this.selectedIndex],i=(m=this.optionNodes)==null?void 0:m[0],r=(s==null?void 0:s.offsetHeight)||(i==null?void 0:i.offsetHeight)||rh;if(this.optionHeight=r,this.optionNodes&&this.optionNodes.forEach((f,g)=>{const y=Math.abs(g-this.selectedIndex),w=Math.min(y,3);f.dataset.distance=String(w)}),e===0||r===0)return;const a=Math.max(0,(e-r)/2);this.optionsEl.style.paddingTop=`${a}px`,this.optionsEl.style.paddingBottom=`${a}px`;let c=0;if(s){const f=s.offsetTop+r/2;c=e/2-f}else c=e/2-(a+r/2);this.optionsEl.style.transform=`translateY(${c}px)`,console.log(`[ClefRangeController] ${this.debugLabel} update`,{viewportHeight:e,optionHeight:r,padding:a,selectedIndex:this.selectedIndex,centerOffset:s?s.offsetTop+r/2:null,offset:c})}}class Sb{constructor(){this.initialized=!1,this.topPicker=null,this.bottomPicker=null,this.suppressStoreSync=!1,this.snapToggle=null}init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),this.snapToggle=document.getElementById("clef-snap-zoom-toggle"),!this.topWheel||!this.bottomWheel){T.warn("ClefRangeController","Clef tab elements not found; skipping initialization",null,"ui");return}this.masterOptions=Xe.map((s,i)=>({index:i,label:s.pitch,toneNote:s.toneNote,frequency:s.frequency}));const e=this.normaliseRange(u.state.pitchRange,this.masterOptions.length);this.topPicker=new Id(this.topWheel,this.masterOptions,e.topIndex,s=>this.handleTopSelection(s)),this.bottomPicker=new Id(this.bottomWheel,this.masterOptions,e.bottomIndex,s=>this.handleBottomSelection(s)),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.setPresetRange("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.setPresetRange("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.setPresetRange("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.setPresetRange("bass")),this.snapToggle&&(this.snapToggle.checked=!!u.state.snapZoomToRange,this.snapToggle.addEventListener("change",()=>{const s=!!this.snapToggle.checked;u.setSnapZoomToRange(s),s&&xt&&typeof xt.snapZoomToCurrentRange=="function"&&xt.snapZoomToCurrentRange()})),u.on("pitchRangeChanged",s=>{this.syncFromStore(s)}),u.on("snapZoomSettingChanged",s=>{this.snapToggle&&this.snapToggle.checked!==s&&(this.snapToggle.checked=s)}),this.currentRange=e,this.lastTopIndex=e.topIndex,this.lastBottomIndex=e.bottomIndex,this.updateSummary(),this.initialized=!0,T.moduleLoaded("ClefRangeController","ui")}normaliseRange(e,s){const i={topIndex:0,bottomIndex:s-1};if(!e)return i;const r=Math.max(0,Math.min(s-1,e.topIndex)),a=Math.max(r,Math.min(s-1,e.bottomIndex));return{topIndex:r,bottomIndex:a}}handleTopSelection(e){const s=this.bottomPicker.getIndex(),i=Math.max(e,s);i!==s&&this.bottomPicker.setIndex(i,{silent:!0}),this.commitRangeChange(e,i)}handleBottomSelection(e){const s=this.topPicker.getIndex(),i=Math.min(e,s);i!==s&&this.topPicker.setIndex(i,{silent:!0}),this.commitRangeChange(i,e)}commitRangeChange(e,s){const i=this.currentRange||u.state.pitchRange||{topIndex:0},r=Math.max(0,Math.min(this.masterOptions.length-1,e)),a=Math.max(r,Math.min(this.masterOptions.length-1,s));if(this.currentRange&&this.currentRange.topIndex===r&&this.currentRange.bottomIndex===a)return;let c=null;if(xt!=null&&xt.getViewportInfo){const h=xt.getViewportInfo();h&&(c=(i.topIndex??0)+h.startRank)}this.currentRange={topIndex:r,bottomIndex:a},this.lastTopIndex=r,this.lastBottomIndex=a,this.updateSummary(),u.setPitchRange({topIndex:r,bottomIndex:a},{maintainGlobalStart:c}),xt&&typeof xt.snapZoomToCurrentRange=="function"&&u.state.snapZoomToRange?xt.snapZoomToCurrentRange():xt&&typeof xt.recalculateLayout=="function"&&xt.recalculateLayout()}syncFromStore(e){if(!this.initialized||!e)return;const s=this.normaliseRange(e,this.masterOptions.length);this.currentRange=s,this.topPicker&&this.topPicker.getIndex()!==s.topIndex&&this.topPicker.setIndex(s.topIndex,{silent:!0}),this.bottomPicker&&this.bottomPicker.getIndex()!==s.bottomIndex&&this.bottomPicker.setIndex(s.bottomIndex,{silent:!0}),this.updateSummary(e.metadata)}updateSummary(e){if(!this.currentRange)return;const s=this.masterOptions[this.currentRange.topIndex],i=this.masterOptions[this.currentRange.bottomIndex],r=this.currentRange.bottomIndex-this.currentRange.topIndex+1;if(this.rangeLabel&&(this.rangeLabel.textContent=`${s.label}  ${i.label}`),this.rangeCount&&(this.rangeCount.textContent=`${r} ${r===1?"pitch":"pitches"}`),e){const{removedNotes:a=0,removedStamps:c=0,removedTriplets:h=0}=e,m=a+c+h;m>0&&T.info("ClefRangeController",`Range change removed: ${m} items`,e,"ui")}}resetRange(){this.topPicker.setIndex(0,{silent:!0}),this.bottomPicker.setIndex(this.masterOptions.length-1,{silent:!0}),this.commitRangeChange(0,this.masterOptions.length-1)}findNoteIndex(e){return this.masterOptions.findIndex(s=>s.label===e)}animateWheelToIndex(e,s,i=300){const r=e.getIndex(),a=s-r,c=performance.now(),h=m=>{const f=m-c,g=Math.min(f/i,1),y=1-Math.pow(1-g,3),w=Math.round(r+a*y);e.setIndex(w,{silent:g<1}),g<1?requestAnimationFrame(h):e.setIndex(s)};requestAnimationFrame(h)}setPresetRange(e){let s,i;switch(e){case"full":this.animateWheelToIndex(this.topPicker,0),this.animateWheelToIndex(this.bottomPicker,this.masterOptions.length-0);return;case"treble":s="A/G5",i="C4";break;case"alto":s="B/A4",i="E3";break;case"bass":s="D/C4",i="F2";break;default:return}const r=this.findNoteIndex(s),a=this.findNoteIndex(i);if(r===-1||a===-1){T.warn("ClefRangeController",`Preset notes not found: ${s} or ${i}`,null,"ui");return}this.animateWheelToIndex(this.topPicker,r),this.animateWheelToIndex(this.bottomPicker,a)}}const Cb=new Sb,Tb={X:["1P","3M","5P"],x:["1P","3m","5P"],"x":["1P","3m","5d"],"X+":["1P","3M","6m"],X7:["1P","3M","5P","7m"],"x":["1P","3m","5P","7m"],"Xmaj":["1P","3M","5P","7M"],"":["1P","3m","5d","7m"],"x":["1P","3m","5d","6M"],"X":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},Ab={"xmaj":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x":["1P","3m","5P","7m","9M"],"x":["1P","3m","5P","6M"],"x":["1P","3m","5P","7m","9M","11P"],"Xmaj711":["1P","3M","5P","7M","11A"]},Yp={...Tb,...Ab},ah={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]};function Rd(){return Object.keys(u.state.tonicSignGroups).length>0}function Dd(){const n=document.getElementById("degree-mode-toggle");if(n){const e=u.state.degreeDisplayMode==="off";n.classList.toggle("disabled",e)}}function Od(){var e;const n=document.querySelector("#chords-panel .harmony-preset-grid");if(n&&n.querySelectorAll(".harmony-preset-button").forEach(s=>s.classList.remove("selected")),u.state.selectedTool==="chord"&&n){const s=u.state.activeChordIntervals.toString();for(const i of n.querySelectorAll(".harmony-preset-button"))if(((e=Yp[i.textContent.trim()])==null?void 0:e.toString())===s){i.classList.add("selected");return}}}function Nd(){const n=document.querySelector("#intervals-panel .harmony-preset-grid");if(n&&(n.querySelectorAll(".harmony-preset-button").forEach(e=>e.classList.remove("selected")),u.state.selectedTool==="chord"&&u.state.activeChordIntervals)){const e=u.state.activeChordIntervals;n.querySelectorAll(".harmony-preset-button").forEach(s=>{const i=s.textContent.trim(),r=ah[i];r&&e.includes(r[0])&&s.classList.add("selected")})}}const ua=(n,e=50)=>{const s=parseInt(n.slice(1,3),16),i=parseInt(n.slice(3,5),16),r=parseInt(n.slice(5,7),16),a=Math.min(255,Math.floor(s+(255-s)*(e/100))),c=Math.min(255,Math.floor(i+(255-i)*(e/100))),h=Math.min(255,Math.floor(r+(255-r)*(e/100)));return`#${a.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${h.toString(16).padStart(2,"0")}`};function Mb(){const{noteBankContainer:n,eraserButton:e,tonicModeGrid:s,degreeVisibilityToggle:i,degreeModeToggle:r,flatBtn:a,sharpBtn:c,frequencyBtn:h,focusColoursToggle:m}=ri.getMultiple("noteBankContainer","eraserButton","tonicModeGrid","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","focusColoursToggle"),f=document.querySelector(".pitch-tabs-container");document.querySelector(".harmony-preset-grid");const g=document.getElementById("inversion-toggle"),y=document.getElementById("chord-position-toggle-6");Cb.init(),n&&n.querySelectorAll(".note").forEach(j=>{j.addEventListener("click",()=>{u.setSelectedNote(j.dataset.type,j.closest(".note-pair").dataset.color),u.setSelectedTool("note")})}),e&&e.addEventListener("click",()=>u.setSelectedTool("eraser"));const w=s?Array.from(s.querySelectorAll(".tonic-sign-button")):[],C=(j=u.state.selectedToolTonicNumber)=>{if(!w.length)return;const Y=w[0]?parseInt(w[0].dataset.tonic,10):1,tt=parseInt(j,10),ot=Number.isNaN(tt)?Y:tt;w.forEach(dt=>{const Tt=parseInt(dt.dataset.tonic,10)===ot;dt.classList.toggle("selected",Tt),dt.setAttribute("aria-pressed",Tt?"true":"false")})};w.length&&(w.forEach(j=>{j.addEventListener("click",()=>{const Y=j.getAttribute("data-tonic");Y&&(u.setSelectedTool("tonicization",Y),C(parseInt(Y,10)))})}),C());const A=document.querySelector("#chords-panel .harmony-preset-grid");function I(j,Y,tt){j&&j.querySelectorAll(".harmony-preset-button").forEach(ot=>{ot.addEventListener("click",()=>{const dt=Y[ot.textContent];dt&&dt.length>0?(u.setActiveChordIntervals(dt),u.setSelectedTool("chord")):console.error(`Failed to retrieve valid intervals for ${tt} chord: "${ot.textContent}"`),ot.blur()}),ot.addEventListener("dblclick",()=>{ot.classList.contains("selected")&&u.setSelectedTool("note"),ot.blur()})})}I(A,Yp,"chords");const E=document.querySelectorAll(".pitch-tab-button"),O=document.querySelectorAll(".pitch-tab-panel");if(E.length>0&&E.forEach(j=>{j.addEventListener("click",()=>{const Y=j.dataset.pitchTab;E.forEach(ot=>ot.classList.remove("active")),j.classList.add("active"),O.forEach(ot=>ot.classList.remove("active"));const tt=document.getElementById(`${Y}-panel`);tt&&tt.classList.add("active"),Y==="chords"&&q()})}),g){g.addEventListener("click",()=>{const Y=!u.state.isIntervalsInverted;u.setIntervalsInversion(Y),g.blur()});const j=Y=>{g.classList.toggle("active",Y)};u.on("intervalsInversionChanged",j),j(u.state.isIntervalsInverted)}if(y){y.addEventListener("click",()=>{const Y=u.state.chordPositionState,tt=P(),ot=(Y+1)%tt;u.setChordPosition(ot),y.blur()});const j=Y=>{y.classList.remove("state-1","state-2","state-3","state-4","state-5"),Y===1?y.classList.add("state-1"):Y===2?y.classList.add("state-2"):Y===3?y.classList.add("state-3"):Y===4?y.classList.add("state-4"):Y===5&&y.classList.add("state-5")};u.on("chordPositionChanged",Y=>{j(Y)}),j(u.state.chordPositionState)}function P(){const j=u.state.activeChordIntervals;return!j||j.length===0?3:j.length}function R(){const j=u.state.activeChordIntervals;return!j||j.length===0?3:j.length}function q(){if(!y)return;const j=R();for(let tt=0;tt<=5;tt++)y.classList.remove(`disabled-state-${tt}`);j<4?y.classList.add("disabled-state-3","disabled-state-4","disabled-state-5"):j===4?y.classList.add("disabled-state-4","disabled-state-5"):j===5&&y.classList.add("disabled-state-5");const Y=j-1;u.state.chordPositionState>Y&&u.setChordPosition(0)}const G=document.querySelector("#intervals-panel .harmony-preset-grid");if(G&&G.querySelectorAll(".harmony-preset-button").forEach(j=>{j.addEventListener("click",()=>{const Y=j.textContent.trim(),tt=ah[Y];if(tt&&tt.length>0){const ot=["1P",tt[0]];u.setActiveChordIntervals(ot),u.setSelectedTool("chord"),console.log(`Interval ${Y} selected:`,ot)}else console.error(`Failed to retrieve valid interval for symbol: "${Y}"`),console.error("Available interval shapes:",Object.keys(ah));j.blur()}),j.addEventListener("dblclick",()=>{j.classList.contains("selected")&&u.setSelectedTool("note"),j.blur()})}),i&&i.addEventListener("click",()=>{if(u.state.degreeDisplayMode==="off"){if(!Rd()){kd.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}const tt=r.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(tt)}else u.setDegreeDisplayMode("off");i.blur()}),r&&r.addEventListener("click",()=>{if(r.classList.contains("disabled"))return;r.classList.toggle("active");const Y=r.classList.contains("active")?"modal":"diatonic";u.setDegreeDisplayMode(Y),r.blur()}),a&&a.addEventListener("click",()=>{if(u.state.showFrequencyLabels){u.toggleFrequencyLabels(),a.blur();return}u.toggleAccidentalMode("flat"),a.blur()}),c&&c.addEventListener("click",()=>{if(u.state.showFrequencyLabels){u.toggleFrequencyLabels(),c.blur();return}u.toggleAccidentalMode("sharp"),c.blur()}),h&&h.addEventListener("click",()=>{u.toggleFrequencyLabels(),h.blur()}),m&&m.addEventListener("change",()=>{if(!u.state.focusColours&&!Rd()){kd.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),m.checked=!1;return}u.toggleFocusColours()}),u.on("toolChanged",({newTool:j})=>{var ot;const Y=document.querySelector("#chords-panel .harmony-preset-grid");Y&&Y.querySelectorAll(".harmony-preset-button").forEach(dt=>dt.classList.remove("selected"));const tt=document.querySelector("#intervals-panel .harmony-preset-grid");if(tt&&tt.querySelectorAll(".harmony-preset-button").forEach(dt=>dt.classList.remove("selected")),e==null||e.classList.remove("selected"),f&&f.classList.remove("active-tool"),j==="eraser")e==null||e.classList.add("selected");else if(j!=="tonicization"){if(j==="chord")f==null||f.classList.add("active-tool"),Od(),Nd(),q();else if(j==="note"){const dt=u.state.selectedNote;if(dt){const yt=document.querySelector(`.note-pair[data-color='${dt.color}']`);yt==null||yt.classList.add("selected"),(ot=yt==null?void 0:yt.querySelector(`.note[data-type='${dt.shape}']`))==null||ot.classList.add("selected")}}}C()}),u.on("activeChordIntervalsChanged",()=>{u.state.selectedTool==="chord"&&(Od(),Nd(),q())}),u.on("noteChanged",({newNote:j})=>{var ot;document.querySelectorAll(".note, .note-pair").forEach(dt=>dt.classList.remove("selected"));const Y=document.querySelector(`.note-pair[data-color='${j.color}']`);if(Y==null||Y.classList.add("selected"),(ot=Y==null?void 0:Y.querySelector(`.note[data-type='${j.shape}']`))==null||ot.classList.add("selected"),f){const dt=ua(j.color,50),yt=ua(dt,60);f.style.setProperty("--c-accent",j.color),f.style.setProperty("--c-accent-light",yt)}const tt=document.querySelector(".tab-sidebar");tt&&tt.style.setProperty("--c-accent",j.color)}),u.on("degreeDisplayModeChanged",j=>{i&&i.classList.toggle("active",j!=="off"),r&&(r.classList.contains("active"),r.classList.toggle("active",j==="modal"),r.classList.contains("active")),Dd()}),u.on("accidentalModeChanged",({sharp:j,flat:Y})=>{c==null||c.classList.toggle("active",j),a==null||a.classList.toggle("active",Y)}),u.on("frequencyLabelsChanged",j=>{h==null||h.classList.toggle("active",j),a&&(a.style.opacity=j?"0.3":""),c&&(c.style.opacity=j?"0.3":""),a&&(a.style.pointerEvents=j?"none":""),c&&(c.style.pointerEvents=j?"none":"")}),f&&u.state.selectedNote){const j=u.state.selectedNote.color,Y=ua(j,50),tt=ua(Y,60);f.style.setProperty("--c-accent",j),f.style.setProperty("--c-accent-light",tt)}const U=document.querySelector(".tab-sidebar");U&&u.state.selectedNote&&U.style.setProperty("--c-accent",u.state.selectedNote.color),setTimeout(()=>q(),50),Dd()}function Eb(n){return`/Student-Notation/assets/${n}`}function Ld(n){return Eb(`icons/${n}`)}function Pb(){const n=document.getElementById("play-button"),e=document.getElementById("stop-button"),s=document.getElementById("clear-button"),i=document.getElementById("loop-button"),r=document.getElementById("undo-button"),a=document.getElementById("redo-button");n&&n.addEventListener("click",()=>{const{isPlaying:h,isPaused:m}=u.state;h&&m?(u.setPlaybackState(!0,!1),Ui.resume()):h&&!m?(u.setPlaybackState(!0,!0),Ui.pause()):(u.setPlaybackState(!0,!1),Ui.start()),n.blur()}),e&&e.addEventListener("click",()=>{u.setPlaybackState(!1,!1),Ui.stop(),e.blur()}),s&&s.addEventListener("click",()=>{s.classList.add("flash"),setTimeout(()=>s.classList.remove("flash"),300),u.clearAllNotes(),W0(),X0(),s.blur()}),i&&i.addEventListener("click",()=>{u.setLooping(!u.state.isLooping)}),r&&r.addEventListener("click",()=>{u.undo(),r.blur()}),a&&a.addEventListener("click",()=>{u.redo(),a.blur()}),u.on("playbackStateChanged",({isPlaying:h,isPaused:m})=>{if(n){const f=`<img src="${Ld("Play.svg")}" alt="Play">`,g=`<img src="${Ld("Pause.svg")}" alt="Pause">`;n.innerHTML=h&&!m?g:f}}),u.on("loopingChanged",h=>{i&&i.classList.toggle("active",h)});const c=()=>{r&&(r.disabled=u.state.historyIndex<=0),a&&(a.disabled=u.state.historyIndex>=u.state.history.length-1)};u.on("historyChanged",c),c()}class Lc{constructor(e,s={}){if(this.parent=typeof e=="string"?document.querySelector(e):e,!this.parent)throw new Error("DraggableNumber: parent element not found");const i={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"}};this.settings={...i,...s,colors:{...i.colors,...s.colors||{}}},this._em=new Ib,this._value=new kb(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[r,a]=this.settings.size;this._minDimension=Math.min(r,a),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${r}px`,`height:${a}px`,"background-color: var(--c-bg)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${r}px`,`height:${a}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),Db(this.element,c=>/^-?\d*\.?\d*$/.test(c)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=Fd(this._value.value,this.decimalPlaces),this._bind()}on(e,s){return this._em.on(e,s),()=>this._em.off(e,s)}emit(e,s){this._em.emit(e,s)}get value(){return this._value.value}set value(e){this._value.update(e),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(e){this._value.min=e,this._render()}get max(){return this._value.max}set max(e){this._value.max=e,this._render()}get step(){return this._value.step}set step(e){this._value.step=e,this._render()}passiveUpdate(e){this._value.update(e),this._render()}link(e){this.min=e.min,this.max=e.max,this.step=e.step,typeof e.on=="function"&&e.on("change",s=>this.passiveUpdate(s)),this.on("change",s=>{"value"in e&&(e.value=s)}),this.value=e.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-bg)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const e=parseFloat(this.element.value);!Number.isNaN(e)&&e!==this.value?this.value=e:this._render()}),this.element.addEventListener("keydown",e=>{if(e.key==="Enter"){this.element.blur();const s=parseFloat(this.element.value);Number.isNaN(s)||(this.value=s)}},!0),this.element.addEventListener("mousedown",e=>this._onMouseDown(e)),this.element.addEventListener("dragstart",e=>e.preventDefault())}_onMouseDown(e){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:e.clientY};const s=this.element.getBoundingClientRect(),i=(e.clientX-s.left)/s.width;this._changeFactor=Rb(i);const r=c=>this._onMouseMove(c),a=()=>this._onMouseUp(r,a);window.addEventListener("mousemove",r),window.addEventListener("mouseup",a)}_onMouseMove(e){if(!this.clicked)return;this.hasMoved=!0;const s=e.clientY-this._start.y,r=Lh(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),a=this.actual-s*r;this._value.update(a),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(e,s){this.clicked=!1,window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",s),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=Fd(this._value.value,this.decimalPlaces)}}class kb{constructor(e,s,i,r){this.min=Number(e),this.max=Number(s),this.step=Number(i)||1,this._value=0,this.changed=!1,this.update(r)}get value(){return this._value}update(e){const s=Lh(Number(e),this.min,this.max),i=this._stepTo(s),r=this._value;this._value=i,this.changed=i!==r}_stepTo(e){if(!isFinite(this.step)||this.step<=0)return e;const s=Math.round((e-this.min)/this.step);return this.min+s*this.step}}class Ib{constructor(){this._m=new Map}on(e,s){const i=this._m.get(e)||[];i.push(s),this._m.set(e,i)}off(e,s){const i=this._m.get(e);if(!i)return;const r=i.indexOf(s);r>=0&&i.splice(r,1)}emit(e,s){const i=this._m.get(e);if(i)for(const r of i.slice())r(s)}}function Lh(n,e,s){return Math.max(e,Math.min(s,n))}function Rb(n){return 1-Lh(n,0,1)}function Fd(n,e=2){return isFinite(n)?Number(n).toFixed(Math.max(0,e)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function Db(n,e){let s=n.value;n.addEventListener("input",()=>{e(n.value)?s=n.value:n.value=s})}class Ob{constructor(){this.isActive=!1,this.pulseIntervals=new Map,this.tempoElements=new Map,this.popDuration={scaleUp:40,scaleDown:80},this.popScale=1.4,this.activeAnimations=new Map,this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:s,containerId:i,bpmMultiplier:r})=>{const a=document.getElementById(i),c=a==null?void 0:a.parentElement,h=c==null?void 0:c.querySelector(".tempo-label-icon");a&&h?this.tempoElements.set(s,{container:a,icon:h,bpmMultiplier:r,originalTransform:a.style.transform||"",originalIconTransform:h.style.transform||""}):console.warn(`TempoVisualizer: Could not find elements for ${s} tempo`,{container:!!a,icon:!!h,tempoGroup:!!c})})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((e,s)=>{this.startPulseForType(s)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(e=>{clearInterval(e)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(e=>{e.container.style.transform=e.originalTransform,e.icon.style.transform=e.originalIconTransform}))}startPulseForType(e){const s=this.tempoElements.get(e);if(!s)return;const a=60/(u.state.tempo*s.bpmMultiplier)*1e3;this.triggerPulse(e);const c=setInterval(()=>{this.isActive&&this.triggerPulse(e)},a);this.pulseIntervals.set(e,c)}triggerPulse(e){this.activeAnimations.has(e);const i={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(e,i);const r=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),r||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const e=performance.now();this.activeAnimations.forEach((s,i)=>{const r=this.calculateScale(s,e);this.applyScale(i,r),r===1&&s.phase==="complete"&&this.activeAnimations.delete(i)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(e,s){const i=s-e.startTime;if(e.phase==="scaleUp"){if(i>=this.popDuration.scaleUp)return e.phase="scaleDown",e.startTime=s,this.popScale;{const r=Math.min(i/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*r}}else if(e.phase==="scaleDown"){if(i>=this.popDuration.scaleDown)return e.phase="complete",1;{const r=Math.min(i/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*r}}return 1}applyScale(e,s){const i=this.tempoElements.get(e);if(!i)return;const r=`scale(${s})`;i.container.style.transform=i.originalTransform+" "+r,i.icon.style.transform=i.originalIconTransform+" "+r;const a=s<this.popScale?"transform 0.08s ease-out":"none";i.container.style.transition=a,i.icon.style.transition=a}updateTempo(){this.isActive&&(this.stop(),this.start())}}const bs=new Ob;function Nb(){var O;const n=document.getElementById("tempo-slider");n||console.warn(" [AudioControls] Tempo slider not found during initial load - will retry when rhythm tab is accessed");const e={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0},s=new Lc("#eighth-note-tempo",{...e,value:180,min:60,max:480}),i=new Lc("#quarter-note-tempo",{...e,value:90,min:30,max:240}),r=new Lc("#dotted-quarter-tempo",{...e,value:60,min:20,max:160});function a(P){if(!P)return;const R=document.querySelector(".tempo-column");if(!R)return;const q=parseFloat(P.min),G=parseFloat(P.max),tt=-((parseFloat(P.value)-q)/(G-q)*150*.6);R.style.transform=`translateY(${tt}px)`,R.style.transition="transform 0.1s ease-out"}function c(P){const R=Math.round(P),q=n||document.getElementById("tempo-slider");q&&parseInt(q.value,10)!==R&&(q.value=R,a(q));const G=R*2,U=Math.round(R/1.5);s.value!==G&&s.passiveUpdate(G),i.value!==R&&i.passiveUpdate(R),r.value!==U&&r.passiveUpdate(U),u.state.tempo!==R&&(u.setTempo(R),bs.updateTempo())}let h=!1,m=0,f=!1,g=150;function y(){const P=document.getElementById("tempo-slider");if(!P)return console.warn(" [AudioControls] Tempo slider still not found during deferred initialization"),!1;P.addEventListener("mousedown",q=>{console.log(" Tempo slider mousedown - starting pulse visualization",{button:q.button,target:q.target.id,isSliderPressed:h}),h=!0,m=Date.now(),f=!1,setTimeout(()=>{h&&(console.log(" Starting pulse after delay - slider still pressed"),bs.start())},100)}),P.addEventListener("mousemove",q=>{h&&!f&&(f=!0,console.log(" Detected dragging - ensuring pulse is active"),bs.isActive||bs.start())}),P.addEventListener("touchstart",q=>{console.log(" Tempo slider touchstart - starting pulse visualization"),h=!0,bs.start()}),P.addEventListener("focus",()=>{console.log(" Tempo slider focused")}),P.addEventListener("input",q=>{const G=parseInt(q.target.value,10);c(G),a(P)}),P.addEventListener("mouseup",function(){this.blur()});const R=u.state.tempo;return P.value!==R.toString()&&(P.value=R),a(P),!0}if(n)n.addEventListener("mousedown",P=>{console.log(" Tempo slider mousedown - starting pulse visualization",{button:P.button,target:P.target.id,isSliderPressed:h}),h=!0,m=Date.now(),f=!1,setTimeout(()=>{h&&(console.log(" Starting pulse after delay - slider still pressed"),bs.start())},100)}),n.addEventListener("mousemove",P=>{h&&!f&&(f=!0,console.log(" Detected dragging - ensuring pulse is active"),bs.isActive||bs.start())}),n.addEventListener("touchstart",P=>{console.log(" Tempo slider touchstart - starting pulse visualization"),h=!0,bs.start()}),n.addEventListener("input",P=>c(parseInt(P.target.value,10))),n.addEventListener("mouseup",function(){this.blur()}),c(u.state.tempo);else{console.log(" [AudioControls] Setting up deferred tempo slider initialization..."),setTimeout(()=>{y()},100);const P=document.getElementById("rhythm-panel");if(P){const R=new MutationObserver(q=>{q.forEach(G=>{if(G.type==="attributes"&&G.attributeName==="class"){const U=G.target;(U.classList.contains("active")||U.style.display!=="none")&&(console.log(" [AudioControls] Rhythm tab became visible, trying to initialize tempo slider"),y()&&R.disconnect())}})});R.observe(P,{attributes:!0,attributeFilter:["class","style"]})}}s.on("change",P=>{!isNaN(P)&&P>0&&c(P/2)}),i.on("change",P=>{!isNaN(P)&&P>0&&c(P)}),r.on("change",P=>{!isNaN(P)&&P>0&&c(P*1.5)}),c(u.state.tempo),window.initTempoSliderIfNeeded=y,document.addEventListener("mouseup",P=>{if(h){const R=Date.now()-m;console.log(" Global mouseup - stopping pulse visualization",{target:P.target.tagName,id:P.target.id,isSliderPressed:h,holdTime:R,isDragging:f,wasLongEnough:R>g}),f||R>g?(h=!1,bs.stop()):(console.log(" Click too short, not stopping pulse yet"),setTimeout(()=>{h&&(h=!1,bs.stop(),console.log(" Delayed stop after quick click"))},50)),f=!1}}),document.addEventListener("touchend",P=>{h&&(console.log(" Global touchend - stopping pulse visualization",{target:P.target.tagName,id:P.target.id,isSliderPressed:h}),h=!1,bs.stop())}),document.addEventListener("touchcancel",P=>{h&&(console.log(" Touch cancelled - stopping pulse visualization",{target:P.target.tagName,id:P.target.id,isSliderPressed:h}),h=!1,bs.stop())});const w=document.querySelector(".preset-effects-container");document.querySelectorAll(".preset-button").forEach(P=>{const R=P.id.replace("preset-",""),q=x0[R];q&&P.addEventListener("click",()=>{var U;const G=(U=u.state.selectedNote)==null?void 0:U.color;G&&(u.applyPreset(G,q),setTimeout(()=>{try{I(G)}catch{}},10)),P.blur()})});const C=(P,R=20)=>{const q=parseInt(P.slice(1,3),16),G=parseInt(P.slice(3,5),16),U=parseInt(P.slice(5,7),16),j=Math.max(0,Math.floor(q*(1-R/100))),Y=Math.max(0,Math.floor(G*(1-R/100))),tt=Math.max(0,Math.floor(U*(1-R/100)));return`#${j.toString(16).padStart(2,"0")}${Y.toString(16).padStart(2,"0")}${tt.toString(16).padStart(2,"0")}`},A=(P,R=50)=>{const q=parseInt(P.slice(1,3),16),G=parseInt(P.slice(3,5),16),U=parseInt(P.slice(5,7),16),j=Math.min(255,Math.floor(q+(255-q)*(R/100))),Y=Math.min(255,Math.floor(G+(255-G)*(R/100))),tt=Math.min(255,Math.floor(U+(255-U)*(R/100)));return`#${j.toString(16).padStart(2,"0")}${Y.toString(16).padStart(2,"0")}${tt.toString(16).padStart(2,"0")}`},I=P=>{if(!P||!w)return;const R=u.state.timbres[P],q=u.state.colorPalette[P]||{primary:P,light:P},G=q.light,U=q.primary;document.querySelectorAll(".preset-button").forEach(Y=>{const tt=Y.id.replace("preset-",""),ot=R&&R.activePresetName===tt;Y.classList.toggle("selected",ot)});const j=A(G,60);w.style.setProperty("--c-accent",U),w.style.setProperty("--c-accent-light",j),w.style.setProperty("--c-accent-hover",C(U,20))};u.on("noteChanged",({newNote:P})=>{P.color?I(P.color):(document.querySelectorAll(".preset-button").forEach(R=>R.classList.remove("selected")),w&&(w.style.setProperty("--c-accent","#4A90E2"),w.style.setProperty("--c-accent-hover","#357ABD")))}),u.on("timbreChanged",P=>{var R;P===((R=u.state.selectedNote)==null?void 0:R.color)&&I(P)}),u.on("tempoChanged",P=>{c(P)});const E=(O=u.state.selectedNote)==null?void 0:O.color;E&&I(E)}function Lb(){const n=document.getElementById("grid-zoom-in"),e=document.getElementById("grid-zoom-out"),s=document.getElementById("macrobeat-increase"),i=document.getElementById("macrobeat-decrease");n&&n.addEventListener("click",()=>{u.emit("zoomIn"),n.blur()}),e&&e.addEventListener("click",()=>{u.emit("zoomOut"),e.blur()}),s&&s.addEventListener("click",()=>u.increaseMacrobeatCount()),i&&i.addEventListener("click",()=>u.decreaseMacrobeatCount())}function Fb(){document.querySelectorAll("button"),document.querySelector(".modulation-controls");const n=document.getElementById("modulation-2-3-btn"),e=document.getElementById("modulation-3-2-btn"),s=document.getElementById("modulation-clear-btn");if(!n||!e||!s){T.warn("ModulationInitializer","Modulation control buttons not found in DOM",null,"ui");return}let i=null;n.addEventListener("click",()=>{i===Is.COMPRESSION_2_3?(i=null,n.classList.remove("active"),u.setSelectedTool("note"),T.info("ModulationInitializer","2:3 modulation tool deactivated",null,"ui")):(i=Is.COMPRESSION_2_3,n.classList.add("active"),e.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=i,T.info("ModulationInitializer","2:3 modulation tool activated",null,"ui"))}),e.addEventListener("click",()=>{i===Is.EXPANSION_3_2?(i=null,e.classList.remove("active"),u.setSelectedTool("note"),T.info("ModulationInitializer","3:2 modulation tool deactivated",null,"ui")):(i=Is.EXPANSION_3_2,e.classList.add("active"),n.classList.remove("active"),u.setSelectedTool("modulation"),u.state.selectedModulationRatio=i,T.info("ModulationInitializer","3:2 modulation tool activated",null,"ui"))}),s.addEventListener("click",()=>{const a=(u.state.modulationMarkers||[]).length;if(a===0){T.info("ModulationInitializer","No modulation markers to clear",null,"ui");return}u.clearModulationMarkers(),T.info("ModulationInitializer",`Cleared ${a} modulation markers`,null,"ui")}),u.on("toolChanged",a=>{(a.newTool||a)!=="modulation"&&(i=null,n.classList.remove("active"),e.classList.remove("active"))}),u.on("modulationMarkersChanged",()=>{const a=(u.state.modulationMarkers||[]).length;a===0?(s.disabled=!0,s.style.opacity="0.5"):(s.disabled=!1,s.style.opacity="1"),s.textContent=a>0?`Clear (${a})`:"Clear"});const r=(u.state.modulationMarkers||[]).length;r===0&&(s.disabled=!0,s.style.opacity="0.5"),s.textContent=r>0?`Clear (${r})`:"Clear",T.info("ModulationInitializer","Modulation controls initialized",null,"ui")}T.moduleLoaded("ToolbarComponent","toolbar");const Bb={init(){gb(),wb(),Mb(),Pb(),Nb(),Lb(),Fb(),T.info("ToolbarComponent","All controls initialized",null,"toolbar")}};function Zp(n,e){return e.some(s=>s.columnIndex===n)}function $b(n,e){return e.some(s=>n===s.columnIndex||n===s.columnIndex+1)}function lh(n,e){const s=an(e);return!$b(n,s)}function Qp(n,e){for(const s of e)if(n===s.columnIndex+1)return!1;return e.some(s=>n===s.columnIndex+2),!0}function qb(n,e,s,i){const{sharp:r,flat:a}=e.accidentalMode,c=e.showFrequencyLabels||!1,h=r||a,m=!r&&!a;function f(w){const C=[];return Xe.forEach(A=>{Sa(A.pitch)===w&&(A.column==="A"||A.column==="B")&&(A.column==="A"?C.push(1,e.columnWidths.length-2):A.column==="B"&&C.push(0,e.columnWidths.length-1))}),[...new Set(C)]}function g(w){const C=[];return Xe.forEach(A=>{Sa(A.pitch)===w&&(A.column==="A"||A.column==="B")&&(A.column==="A"?C.push(0,e.columnWidths.length-1):A.column==="B"&&C.push(1,e.columnWidths.length-2))}),[...new Set(C)]}function y(){return[1,e.columnWidths.length-2]}for(let w=s;w<=i;w++){const C=e.fullRowData[w];if(!C)continue;const A=Rt(w,e);if(A<-10||A>e.viewportHeight+10)continue;const I=Sa(C.pitch),E=O0(I);if(I==="C"||I==="E"){const O=f(I),P=ft(0,e),R=ft(e.columnWidths.length,e);Fc(n,P,R,A,e,O,"stroke",E)}else if(I==="G"){const O=ft(2,e),R=ft(e.columnWidths.length-2,e)-O;if(n.fillStyle=E.color,n.fillRect(O,A-e.cellHeight/2,R,e.cellHeight),!c){const q=y();m?(n.fillStyle=E.color,Xo(n,A,e,q,"fill",E)):h&&Xo(n,A,e,q,"stroke",E)}}else if(["B","A","F"].includes(I))if(m){let P=g(I).filter(R=>R!==0&&R!==e.columnWidths.length-1);I==="A"&&(P=P.filter(R=>R!==1&&R!==e.columnWidths.length-2)),P.length>0&&Xo(n,A,e,P,"stroke",E)}else{const O=g(I);Xo(n,A,e,O,"stroke",E)}else if(["E/D","D/C"].includes(I)){const O=g(I);Xo(n,A,e,O,"stroke",E)}else if(I==="B/A")if(m){const O=ft(0,e),P=ft(e.columnWidths.length,e);n.beginPath(),n.moveTo(O,A),n.lineTo(P,A),n.lineWidth=E.lineWidth,n.strokeStyle=E.color,n.setLineDash(E.dash),n.stroke(),n.setLineDash([])}else{const O=f(I),P=ft(0,e),R=ft(e.columnWidths.length,e);Fc(n,P,R,A,e,O,"stroke",E)}else{const O=f(I),P=ft(0,e),R=ft(e.columnWidths.length,e);Fc(n,P,R,A,e,O,"stroke",E)}}}function Fc(n,e,s,i,r,a,c,h){const m=a.map(g=>({start:ft(g,r),end:ft(g+1,r)})).sort((g,y)=>g.start-y.start);let f=e;m.forEach(g=>{f<g.start&&ch(n,f,g.start,i,r,c,h),f=Math.max(f,g.end)}),f<s&&ch(n,f,s,i,r,c,h)}function ch(n,e,s,i,r,a,c){a==="fill"?n.fillRect(e,i-r.cellHeight/2,s-e,r.cellHeight):(n.beginPath(),n.moveTo(e,i),n.lineTo(s,i),n.lineWidth=c.lineWidth,n.strokeStyle=c.color,n.setLineDash(c.dash),n.stroke(),n.setLineDash([]))}function Xo(n,e,s,i,r,a){i.forEach(c=>{const h=ft(c,s),m=ft(c+1,s);ch(n,h,m,e,s,r||"stroke",a)})}function zb(n,e,s,i){qb(n,e,s,i)}function Wb(n,e){Vb(n,e)}function Vb(n,e){const{columnWidths:s,macrobeatGroupings:i,macrobeatBoundaryStyles:r,placedTonicSigns:a}=e,c=s.length;let h=[],m=2;for(let f=0;f<i.length;f++){for(;a.some(g=>g.columnIndex===m);)m+=2;m+=i[f],h.push(m)}for(let f=0;f<=c;f++){const g=ft(f,e);let y;const w=f===2||f===c-2,C=Zp(f,a),A=a.some(O=>f===O.columnIndex+2),I=h.includes(f);if(Qp(f,a)){if(w||C||A)y={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(I){const O=h.indexOf(f);if(O!==-1){const P=r[O];if(P==="anacrusis")continue;y={lineWidth:1,strokeStyle:"#adb5bd",dash:P==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(g,0),n.lineTo(g,n.canvas.height),n.lineWidth=y.lineWidth,n.strokeStyle=y.strokeStyle,n.setLineDash(y.dash),n.stroke()}}n.setLineDash([])}const Bd=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function Hb(n){const e=an(n);if(e.length===0)return{leftTonic:null,rightTonic:null};const s=e.reduce((r,a)=>a.columnIndex<r.columnIndex?a:r),i=e.reduce((r,a)=>a.columnIndex>r.columnIndex?a:r);return{leftTonic:s,rightTonic:e.length===1?s:i}}function $d(n,e){const s=e[n];if(!s)return null;const r=s.pitch.replace(/\d+$/,"");return(r.includes("/")?r.split("/")[0]:r).replace(//g,"b").replace(//g,"#")}function qd(n,e){if(!n||!e)return[];const s=e-1;if(s<0||s>=Bd.length)return console.warn(`Invalid tonic number: ${e}`),[];const i=Bd[s];try{const r=`${n} ${i}`,a=zy(r);return console.log(` Focus Colours: Generated ${r} scale:`,a.notes),a.notes||[]}catch(r){return console.warn(`Could not generate ${i} scale for tonic: ${n}`,r),[]}}function Gb(n,e){if(!n||!e.length)return!1;const s=n.replace(/\d+$/,"");return(s.includes("/")?s.split("/"):[s]).map(a=>a.replace(//g,"b").replace(//g,"#")).some(a=>e.some(c=>{try{return bn(a)===bn(c)||a===c}catch{return a===c}}))}function jb(n,e,s,i){const{fullRowData:r,columnWidths:a,cellWidth:c,cellHeight:h,colorMode:m}=e,{sharp:f,flat:g}=u.state.accidentalMode,{focusColours:y,showFrequencyLabels:w}=u.state;let C=[],A=[];if(y){const P=Hb(u.state);if(P.leftTonic){const R=$d(P.leftTonic.row,r);C=qd(R,P.leftTonic.tonicNumber)}if(P.rightTonic){const R=$d(P.rightTonic.row,r);A=qd(R,P.rightTonic.tonicNumber)}}const I=(P,R=[],q=null)=>{if(w)return q&&q.frequency?String(q.frequency):P;if(!P.includes("/"))return P;const G=P.slice(-1),U=P.substring(0,P.length-1),[j,Y]=U.split("/");if(y&&R.length>0){const tt=j.replace(//g,"b").replace(//g,"#"),ot=Y.replace(//g,"b").replace(//g,"#"),dt=R.some(Tt=>{try{return bn(Tt)===bn(tt)||Tt===tt}catch{return Tt===tt}}),yt=R.some(Tt=>{try{return bn(Tt)===bn(ot)||Tt===ot}catch{return Tt===ot}});if(!f&&!g){if(dt)return`${j}${G}`;if(yt)return`${Y}${G}`}else{if(f&&!g)return yt?`${Y}${G}`:null;if(!f&&g)return dt?`${j}${G}`:null;if(f&&g)return dt||yt?`${j}/${Y}${G}`:null}}return f&&g?`${j}/${Y}${G}`:f?`${Y}${G}`:g?`${j}${G}`:`${Y}${G}`},E=()=>!f&&!g;function O(P,R){const q=ft(P,e),G=a.slice(P,P+2).map(tt=>tt*c);let U=q;const Y=P===0?C:A;R.forEach((tt,ot)=>{const dt=G[ot];for(let yt=s;yt<=i;yt++){const Tt=r[yt];if(!(!Tt||Tt.isDummy)&&Tt.column===tt){const me=Rt(yt,e),Wt=Tt.pitch.includes("/"),Qt=!w&&Wt&&E();let it=m==="bw"?"#ffffff":Tt.hex||"#ffffff";const ht=I(Tt.pitch,Y,Tt),ut=ht===null;let Ct=Qt||ut;if(!w&&y&&Y.length>0&&!ut&&(Gb(Tt.pitch,Y)||(Ct=!0)),Ct){const $t=it.match(/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i);if($t){const _e=parseInt($t[1],16),je=parseInt($t[2],16),Ye=parseInt($t[3],16);it=`rgba(${_e}, ${je}, ${Ye}, 0)`}}if(n.fillStyle=it,n.fillRect(U,me-h/2,dt,h),Sa(Tt.pitch),ut)continue;const pt=ht.length<=3,Nt=Math.max(10,Math.min(c*1.2,h*1.2)),jt=pt?Nt:Nt*.7;n.font=`bold ${jt}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle";const Bt=U+dt/2,ee=me,Ge=Ct?"00":"FF";n.strokeStyle=`#212529${Ge}`,n.lineWidth=2.5,n.lineJoin="round",n.strokeText(ht,Bt,ee),n.fillStyle=`#ffffff${Ge}`,n.fillText(ht,Bt,ee)}}U+=dt})}O(0,["B","A"]),O(a.length-2,["A","B"])}function zd(n,e,s,i){const r=Math.sqrt(3)/2*s,a=Math.max(1,i-2*r),c=e-(a/2+r),h=c+r,m=h+a,f=m+r,g=n-s/2,y=n+s/2;return`M ${[`${n},${c}`,`${g},${h}`,`${g},${m}`,`${n},${f}`,`${y},${m}`,`${y},${h}`].join(" ")} Z`.replace(/,/g," ")}class Ub{constructor(e={}){this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...e}}renderToCanvas(e,s,i,r,a,c,h="#000",m=null,f=null){const g=Math.min(a/100,c/100)*.8,y=this.options.diamondW*g,w=this.options.diamondH*g,C=this.options.ovalRx*g,A=this.options.ovalRy*g,I=[.125,.375,.625,.875].map(O=>i+O*a),E=r+c/2;e.save(),e.strokeStyle=h,e.fillStyle=h,e.lineWidth=this.options.strokeWidth,e.lineCap="round",e.lineJoin="round",s.ovals.forEach(O=>{var q;const P=O===0?i+.25*a:i+.75*a;let R=E;if(m&&f){const G=`oval_${O}`,U=((q=m.shapeOffsets)==null?void 0:q[G])||0,j=m.row+U;R=f(j),U!==0&&console.log("[STAMP RENDER] Drawing oval with offset:",{shapeKey:G,rowOffset:U,baseRow:m.row,shapeRow:j,y:R})}e.beginPath(),e.ellipse(P,R,C,A,0,0,Math.PI*2),e.stroke()}),s.diamonds.forEach(O=>{var U;const P=I[O];let R=E;if(m&&f){const j=`diamond_${O}`,Y=((U=m.shapeOffsets)==null?void 0:U[j])||0,tt=m.row+Y;R=f(tt),Y!==0&&console.log("[STAMP RENDER] Drawing diamond with offset:",{slot:O,shapeKey:j,rowOffset:Y,baseRow:m.row,shapeRow:tt,y:R})}const q=zd(P,R,y,w),G=new Path2D(q);e.stroke(G)}),e.restore()}renderToSVG(e,s=100,i=100){const r=document.createElementNS("http://www.w3.org/2000/svg","svg");r.setAttribute("viewBox",`0 0 ${s} ${i}`),r.style.color="#000000";const a=Math.min(s/100,i/100)*.8,c=this.options.diamondW*a,h=this.options.diamondH*a,m=this.options.ovalRx*a,f=this.options.ovalRy*a,g=[12.5,37.5,62.5,87.5],y=i/2;return e.ovals.forEach(w=>{const C=w===0?25:75,A=document.createElementNS("http://www.w3.org/2000/svg","ellipse");A.setAttribute("cx",C),A.setAttribute("cy",y),A.setAttribute("rx",m),A.setAttribute("ry",f),A.setAttribute("fill","none"),A.setAttribute("stroke","currentColor"),A.setAttribute("stroke-width",this.options.strokeWidth*2),A.setAttribute("stroke-linecap","round"),r.appendChild(A)}),e.diamonds.forEach(w=>{const C=g[w],A=zd(C,y,c,h),I=document.createElementNS("http://www.w3.org/2000/svg","path");I.setAttribute("d",A),I.setAttribute("fill","none"),I.setAttribute("stroke","currentColor"),I.setAttribute("stroke-width",this.options.strokeWidth*2),I.setAttribute("stroke-linejoin","round"),I.setAttribute("stroke-linecap","round"),r.appendChild(I)}),r}}const Fh=new Ub;T.moduleLoaded("StampRenderer","stamps");function Xb(n,e){const s=u.getAllStampPlacements();s.length!==0&&(T.debug("StampRenderer",`Rendering ${s.length} stamps`,{count:s.length},"stamps"),s.forEach(i=>{Yb(n,i,e)}))}function Yb(n,e,s){const i=Ha(e.stampId);if(!i)return;const{startColumn:r,endColumn:a,row:c,color:h}=e,m=ft(r,s),g=Rt(c,s)-s.cellHeight/2,y=s.cellWidth*2,w=s.cellHeight;if(m+y<0||m>n.canvas.width)return;const C=A=>Rt(A,s);Fh.renderToCanvas(n,i,m,g,y,w,h,e,C),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(m+1,g+1,y-2,w-2),n.restore(),T.debug("StampRenderer",`Rendered stamp ${i.id} at ${r}-${a},${c}`,{stampId:i.id,startColumn:r,endColumn:a,row:c,stampX:m,stampY:g,hasOffsets:!!e.shapeOffsets},"stamps")}function Zb(n,e,s,i,r){if(!i)return;const a=ft(e,r),h=Rt(s,r)-r.cellHeight/2,m=r.cellWidth*2,f=r.cellHeight;n.save(),n.globalAlpha=.6,Fh.renderToCanvas(n,i,a,h,m,f,r.previewColor||"#4a90e2"),n.restore()}function Qb({kind:n,cx:e,cy:s,stroke:i="currentColor",strokeWidth:r=4,scale:a=1}){const c=20*a,h=60*a,m=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return m.setAttribute("cx",e),m.setAttribute("cy",s),m.setAttribute("fill","none"),m.setAttribute("stroke",i),m.setAttribute("stroke-width",r),m.setAttribute("stroke-linecap","round"),n==="circleWide"?(m.setAttribute("rx",c*2),m.setAttribute("ry",h)):(m.setAttribute("rx",c),m.setAttribute("ry",h)),m}function Jb(n,e=48,s=48){const i=document.createElementNS("http://www.w3.org/2000/svg","svg"),r=n.span==="quarter",a=r?200:100;i.setAttribute("viewBox",`0 0 ${a} 100`),i.setAttribute("width",e),i.setAttribute("height",s),i.setAttribute("aria-label",n.label),i.style.color="#000000";const c=50,h=n.span==="eighth"?"ovalWide":"circleWide";let m;return r?m=[33.33,100,166.67]:m=[16.67,50,83.33],n.hits.forEach(f=>{const g=Qb({kind:h,cx:m[f],cy:c,stroke:"currentColor",strokeWidth:3,scale:.8});i.appendChild(g)}),i}T.moduleLoaded("TripletRenderer","triplets");function Kb(n,e){const s=u.getAllTripletPlacements();s.length!==0&&(T.debug("TripletRenderer",`Rendering ${s.length} triplet groups`,{count:s.length},"triplets"),s.forEach(i=>{tw(n,i,e)}))}function tw(n,e,s){const i=ai(e.stampId);if(!i)return;const{startCellIndex:r,span:a,row:c,color:h}=e,m=r*2,f=ft(m,s),g=Rt(c,s),y=g-s.cellHeight/2,w=s.cellWidth*2*a,C=s.cellHeight;if(f+w<0||f>n.canvas.width)return;Jp(n,i,f,g,w,C,h,e,I=>Rt(I,s)),n.save(),n.globalAlpha=.1,n.fillStyle=h,n.fillRect(f+1,y+1,w-2,C-2),n.restore()}function Jp(n,e,s,i,r,a,c,h=null,m=null){const f=e.span==="eighth"?"ovalWide":"circleWide",g=Math.min(r/100,a/100)*.8,y=Math.max(1,3*g);e.hits.forEach(w=>{var E;const C=Bp[w],A=s+r*C/100;let I=i;if(h&&m){const O=`triplet_${w}`,P=((E=h.shapeOffsets)==null?void 0:E[O])||0,R=h.row+P;I=m(R),P!==0&&console.log("[TRIPLET RENDER] Drawing notehead with offset:",{slot:w,shapeKey:O,rowOffset:P,baseRow:h.row,shapeRow:R,y:I})}ew(n,f,A,I,c,y,g)})}function ew(n,e,s,i,r="currentColor",a=4,c=1){const h=20*c,m=60*c;if(n.strokeStyle=r,n.lineWidth=a,n.fillStyle="none",n.beginPath(),e==="circleWide"){const f=h*2,g=m;n.ellipse(s,i,f,g,0,0,2*Math.PI)}else{const f=h,g=m;n.ellipse(s,i,f,g,0,0,2*Math.PI)}n.stroke()}function sw(n,e,s,i,r){if(!i)return;const a=e*2,c=i.span==="eighth"?1:2,h=ft(a,r),m=Rt(s,r),f=r.cellWidth*2*c,g=r.cellHeight;n.save(),n.globalAlpha=.6;const y=r.previewColor||"#4a90e2";Jp(n,i,h,m,f,g,y),n.restore()}function nw(n,e){const s=e.cellWidth||40;if(n===0)return 2*s;const i=n-1,r=cs(e,i);return r?(r.endColumn+1)*s:(console.warn("[MODULATION] Could not find measure info for index:",n),n*200)}function Kp(n,e){const{modulationMarkers:s}=e;if(!s||s.length===0)return;const i=s.filter(r=>r.active).map(r=>{let a;if(r.columnIndex!==null&&r.columnIndex!==void 0)a=ft(r.columnIndex+1,e);else if(r.macrobeatIndex!==null&&r.macrobeatIndex!==void 0){const c=cs(e,r.macrobeatIndex);c?a=ft(c.endColumn+1,e):(console.warn(`[GRIDLINE-ALIGN] Could not find macrobeat info for index ${r.macrobeatIndex}`),a=r.xPosition||0)}else r.measureIndex!==null&&r.measureIndex!==void 0?a=nw(r.measureIndex,e):a=r.xPosition||0;return{...r,xCanvas:a}});n.save(),i.forEach(r=>{iw(n,r)}),n.restore()}function iw(n,e,s){const i=e.xCanvas,r=e.ratio,a=Pp(r),c=Ep(r);ow(n,i,a),rw(n,i,c,a)}function ow(n,e,s,i){const a=n.canvas.height;n.beginPath(),n.moveTo(e,0),n.lineTo(e,a),n.lineWidth=3,n.strokeStyle=s,n.setLineDash([]),n.stroke()}function rw(n,e,s,i,r){const c="Arial, sans-serif";n.font=`14px ${c}`,n.textAlign="center",n.textBaseline="middle";const y=n.measureText(s).width,w=14,C=y+6*2,A=w+6*2,I=e-C/2,E=20;aw(n,I,E,C,A,8,i),n.fillStyle="white",n.fillText(s,e,E+A/2)}function aw(n,e,s,i,r,a,c){n.beginPath(),n.moveTo(e+a,s),n.lineTo(e+i-a,s),n.quadraticCurveTo(e+i,s,e+i,s+a),n.lineTo(e+i,s+r-a),n.quadraticCurveTo(e+i,s+r,e+i-a,s+r),n.lineTo(e+a,s+r),n.quadraticCurveTo(e,s+r,e,s+r-a),n.lineTo(e,s+a),n.quadraticCurveTo(e,s,e+a,s),n.closePath(),n.fillStyle=c,n.fill(),n.strokeStyle="rgba(0, 0, 0, 0.2)",n.lineWidth=1,n.stroke()}function br(n,e){if(!e||e.length<3)return!1;const s=n.x!==void 0?n.x:n.col,i=n.y!==void 0?n.y:n.row;let r=!1;for(let a=0,c=e.length-1;a<e.length;c=a++){const h=e[a].x!==void 0?e[a].x:e[a].col,m=e[a].y!==void 0?e[a].y:e[a].row,f=e[c].x!==void 0?e[c].x:e[c].col,g=e[c].y!==void 0?e[c].y:e[c].row;m>i!=g>i&&s<(f-h)*(i-m)/(g-m)+h&&(r=!r)}return r}function da(n){if(!n||n.length<3)return n;const e=n.map(a=>({x:a.x!==void 0?a.x:a.col,y:a.y!==void 0?a.y:a.row}));let s=e[0];for(let a=1;a<e.length;a++)(e[a].y<s.y||e[a].y===s.y&&e[a].x<s.x)&&(s=e[a]);const i=e.filter(a=>a!==s);i.sort((a,c)=>{const h=Math.atan2(a.y-s.y,a.x-s.x),m=Math.atan2(c.y-s.y,c.x-s.x);if(h!==m)return h-m;const f=Math.hypot(a.x-s.x,a.y-s.y),g=Math.hypot(c.x-s.x,c.y-s.y);return f-g});const r=[s,i[0]];for(let a=1;a<i.length;a++){for(;r.length>1&&!lw(r[r.length-2],r[r.length-1],i[a]);)r.pop();r.push(i[a])}return r}function lw(n,e,s){return(e.x-n.x)*(s.y-n.y)-(e.y-n.y)*(s.x-n.x)>0}function cw(n,e,s,i=10){const r=n.x,a=n.y,c=e.x,h=e.y,m=s.x,f=s.y,g=m-c,y=f-h,w=g*g+y*y;if(w===0)return Math.hypot(r-c,a-h)<=i;let C=((r-c)*g+(a-h)*y)/w;C=Math.max(0,Math.min(1,C));const A=c+C*g,I=h+C*y;return Math.hypot(r-A,a-I)<=i}function Wd(n,e,s=10){if(!e||e.length<2)return!1;for(let i=0;i<e.length;i++){const r=e[i],a=e[(i+1)%e.length];if(cw(n,r,a,s))return!0}return!1}function hw(n,e){const{centerX:s,centerY:i,rx:r,ry:a}=e,c=16;for(let h=0;h<c;h++){const m=h/c*2*Math.PI,f=s+r*Math.cos(m),g=i+a*Math.sin(m);if(br({x:f,y:g},n))return!0}return!!br({x:s,y:i},n)}function Vd(n,e){const{x:s,y:i,width:r,height:a}=e,c=[{x:s,y:i},{x:s+r,y:i},{x:s+r,y:i+a},{x:s,y:i+a}];for(const h of c)if(br(h,n))return!0;for(const h of n){const m=h.x!==void 0?h.x:h.col,f=h.y!==void 0?h.y:h.row;if(m>=s&&m<=s+r&&f>=i&&f<=i+a)return!0}return!1}T.moduleLoaded("AnnotationService","annotation");class uw{constructor(){this.canvas=null,this.ctx=null,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null}initialize(){if(this.canvas=document.getElementById("notation-grid"),!this.canvas){T.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}this.ctx=this.canvas.getContext("2d"),this.setupEventListeners(),u.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),T.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("contextmenu",e=>e.preventDefault()),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(e){if(!this.selectedAnnotation)return;const s=document.activeElement,i=s.contentEditable==="true",r=s.tagName.toLowerCase();["input","textarea"].includes(r)||i||(e.key==="Delete"||e.key==="Backspace")&&(e.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const e=u.state.annotations.indexOf(this.selectedAnnotation);e>-1&&(u.state.annotations.splice(e,1),this.selectedAnnotation=null,u.recordState(),this.render(),T.log("AnnotationService","Deleted annotation","annotation"))}resize(){if(!this.canvas)return;const e=document.getElementById("notation-grid");e&&(this.canvas.width=e.width,this.canvas.height=e.height,this.render())}getRenderOptions(){return{columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth}}canvasToGrid(e,s){const i=this.getRenderOptions();return{col:F0(e,i),row:B0(s,i)}}gridToCanvas(e,s){const i=this.getRenderOptions();return{x:ft(e,i),y:Rt(s,i)}}setTool(e,s){if(this.currentTool=e,this.toolSettings=s,this.canvas)switch(e){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(e){var h,m;if(!this.currentTool||!this.toolSettings)return;const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,a=this.canvasToGrid(i,r);if(e.button===2){if(this.currentTool==="lasso"&&((h=u.state.lassoSelection)!=null&&h.isActive)){this.removeFromLassoSelection(i,r);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(i,r),this.showEraserCursor(i,r);return}if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const f=this.getResizeHandleAt(i,r,this.selectedAnnotation);if(f){this.isResizing=!0,this.resizeHandle=f,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:a.col,mouseRow:a.row};return}}if((m=u.state.lassoSelection)!=null&&m.isActive&&u.state.lassoSelection.convexHull){const f=Wd({x:i,y:r},u.state.lassoSelection.convexHull,10),g=br({x:i,y:r},u.state.lassoSelection.convexHull);if(f||g){this.isDraggingSelection=!0,this.selectionDragStart={canvasX:i,canvasY:r},this.selectionDragTotal={col:0,row:0};return}}const c=this.getAnnotationAt(i,r);if(c&&(c.type==="arrow"||c.type==="text")){if(this.selectedAnnotation===c){this.isDragging=!0,c.type==="arrow"?this.dragOffset={startCol:a.col-c.startCol,startRow:a.row-c.startRow,endCol:a.col-c.endCol,endRow:a.row-c.endRow}:c.type==="text"&&(this.dragOffset={col:a.col-c.col,row:a.row-c.row});return}this.selectedAnnotation=c,this.loadAnnotationSettings(c),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=a,this.currentPath=[a],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:a.col,startRow:a.row,endCol:a.col,endRow:a.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:a.col,startRow:a.row,endCol:a.col,endRow:a.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[a],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:i,y:r}]};break}}handleMouseMove(e){const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,a=this.canvasToGrid(i,r);if(this.tempEraserMode){this.eraseAtPoint(i,r),this.showEraserCursor(i,r);return}if(this.isResizing&&this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=a.col-this.resizeStartBounds.mouseCol,h=a.row-this.resizeStartBounds.mouseRow;let m=this.resizeStartBounds.col,f=this.resizeStartBounds.row,g=this.resizeStartBounds.widthCols,y=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+h,y=this.resizeStartBounds.heightRows-h),this.resizeHandle.includes("s")&&(y=this.resizeStartBounds.heightRows+h),this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+c,g=this.resizeStartBounds.widthCols-c),this.resizeHandle.includes("e")&&(g=this.resizeStartBounds.widthCols+c);const w=2,C=1;g<w&&(this.resizeHandle.includes("w")&&(m=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-w),g=w),y<C&&(this.resizeHandle.includes("n")&&(f=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-C),y=C),this.selectedAnnotation.col=m,this.selectedAnnotation.row=f,this.selectedAnnotation.widthCols=g,this.selectedAnnotation.heightRows=y,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart){const c=this.getRenderOptions(),h=i-this.selectionDragStart.canvasX,m=r-this.selectionDragStart.canvasY,f=Math.round(h/c.cellWidth),g=Math.round(m/(c.cellHeight/2)),y={col:f-this.selectionDragTotal.col,row:g-this.selectionDragTotal.row};if(y.col!==0||y.row!==0){u.state.lassoSelection.selectedItems.forEach(C=>{if(C.type==="note"){C.data.row+=y.row;const A=C.data.columnIndex!==void 0?"columnIndex":"startColumnIndex";C.data[A]+=y.col,C.data.endColumnIndex!==void 0&&(C.data.endColumnIndex+=y.col)}else C.type==="stamp"?(C.data.row+=y.row,C.data.startColumn+=y.col,C.data.endColumn+=y.col):C.type==="triplet"&&(C.data.row+=y.row,C.data.column+=y.col)}),this.selectionDragTotal.col=f,this.selectionDragTotal.row=g;const w=u.state.lassoSelection.selectedItems.map(C=>{const A=C.data.columnIndex!==void 0?C.data.columnIndex:C.data.startColumnIndex!==void 0?C.data.startColumnIndex:C.data.column,I=ft(A,c),E=Rt(C.data.row,c);return{x:I,y:E}});u.state.lassoSelection.convexHull=da(w),this.render()}return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=a.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=a.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=a.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=a.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=a.col-this.dragOffset.col,this.selectedAnnotation.row=a.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(i,r);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=a.col,this.tempAnnotation.endRow=a.row,this.render();break;case"text":this.tempAnnotation.endCol=a.col,this.tempAnnotation.endRow=a.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const c=this.tempAnnotation.path[this.tempAnnotation.path.length-1],h=this.interpolatePoints(c,a);this.tempAnnotation.path.push(...h)}else this.tempAnnotation.path.push(a);this.render();break;case"lasso":this.tempAnnotation.path.push({x:i,y:r}),this.render();break}}handleMouseUp(e){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,u.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,u.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,u.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:s,startRow:i,endCol:r,endRow:a}=this.tempAnnotation,c=Math.abs(r-s),h=Math.abs(a-i),m=Math.min(s,r),f=Math.min(i,a);c>.5&&h>.2&&this.createTextAnnotation(m,f,c,h),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection():(u.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),u.recordState()),this.tempAnnotation=null,this.render()}}}handleMouseLeave(e){this.isDrawing&&this.handleMouseUp(e)}handleDoubleClick(e){const s=this.canvas.getBoundingClientRect(),i=e.clientX-s.left,r=e.clientY-s.top,a=this.getAnnotationAt(i,r);a&&a.type==="text"&&this.editTextAnnotation(a)}editTextAnnotation(e){const{col:s,row:i,widthCols:r,heightRows:a,text:c,settings:h}=e,m=u.state.annotations.indexOf(e);m>-1&&(u.state.annotations.splice(m,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(s,i,r,a,c,h)}createTextAnnotation(e,s,i,r,a=null,c=null){this.isDrawing=!1;const h=this.gridToCanvas(e,s),m=this.gridToCanvas(e+i,s+r),f=h.x,g=h.y,y=m.x-f,w=m.y-g,A=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',I=c||this.toolSettings.text,E=document.createElement("div");E.contentEditable=!0,E.className="annotation-text-input",E.textContent=a||"Type here...";const O=I.size,P=O*1.2;E.style.width=`${y}px`,E.style.height=`${w}px`,E.style.padding=I.background?"4px 8px":"4px",E.style.border="2px dashed rgba(74, 144, 226, 0.5)",E.style.backgroundColor=I.background?"#ffffff":"transparent",E.style.color=I.color,E.style.fontSize=`${O}px`,E.style.lineHeight=`${P}px`,E.style.fontWeight=I.bold?"bold":"normal",E.style.fontStyle=I.italic?"italic":"normal",E.style.textDecoration=I.underline?"underline":"none",I.superscript?(E.style.fontSize=`${O*.6}px`,E.style.verticalAlign="super"):I.subscript&&(E.style.fontSize=`${O*.6}px`,E.style.verticalAlign="sub"),E.style.outline="none",E.style.zIndex="10000",E.style.position="fixed",E.style.cursor="text",E.style.pointerEvents="auto",E.style.fontFamily=A,E.style.whiteSpace="pre-wrap",E.style.wordWrap="break-word",E.style.overflow="hidden",E.style.boxSizing="border-box";const R=this.canvas.getBoundingClientRect();E.style.left=`${R.left+f}px`,E.style.top=`${R.top+g}px`,document.body.appendChild(E),E.focus();const q=document.createRange();q.selectNodeContents(E);const G=window.getSelection();G.removeAllRanges(),G.addRange(q);let U=!1;const j=()=>{if(U)return;U=!0;const tt=E.textContent.trim();if(tt&&tt!=="Type here..."){const ot={type:"text",col:e,row:s,widthCols:i,heightRows:r,text:tt,settings:{...I}};u.state.annotations.push(ot),this.selectedAnnotation=u.state.annotations[u.state.annotations.length-1],u.recordState(),this.render()}document.body.contains(E)&&document.body.removeChild(E)};let Y=!1;E.addEventListener("input",()=>{!Y&&E.textContent==="Type here..."&&(E.textContent="",Y=!0)}),setTimeout(()=>{E.addEventListener("blur",j)},100),E.addEventListener("keydown",tt=>{tt.key==="Enter"&&!tt.shiftKey&&(tt.preventDefault(),j()),tt.key==="Escape"&&(U=!0,document.body.contains(E)&&document.body.removeChild(E))})}handleLassoSelection(){if(!this.tempAnnotation||!this.tempAnnotation.path)return;const e=this.tempAnnotation.path,s=[],i=this.getRenderOptions();window.event&&window.event.shiftKey&&u.state.lassoSelection.selectedItems&&s.push(...u.state.lassoSelection.selectedItems),u.state.placedNotes.forEach((c,h)=>{if(c.isDrum)return;const m=c.columnIndex!==void 0?c.columnIndex:c.startColumnIndex,f=ft(m,i),g=Rt(c.row,i),{cellWidth:y,cellHeight:w}=i;let C=y;i.modulationMarkers&&i.modulationMarkers.length>0&&(C=ft(m+1,i)-f);const A=c.shape==="oval"?f+C:f+C/2,I=g,E=c.shape==="oval"?C:C/2,O=w/2;if(hw(e,{centerX:A,centerY:I,rx:E,ry:O})){const P=`note-${c.row}-${m}-${c.color}-${c.shape}`;s.find(R=>R.id===P)||s.push({type:"note",id:P,data:c,index:h})}}),u.state.stampPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=i,g=ft(c.startColumn,i),y=Rt(c.row,i)-f/2,w=m*2;if(Vd(e,{x:g,y,width:w,height:f})){const A=`stamp-${c.row}-${c.startColumn}-${c.stampId}`;s.find(I=>I.id===A)||s.push({type:"stamp",id:A,data:c,index:h})}}),u.state.tripletPlacements.forEach((c,h)=>{const{cellWidth:m,cellHeight:f}=i,g=ft(c.column,i),y=Rt(c.row,i)-f/2,w=m*2;if(Vd(e,{x:g,y,width:w,height:f})){const A=`triplet-${c.row}-${c.column}-${c.tripletId}`;s.find(I=>I.id===A)||s.push({type:"triplet",id:A,data:c,index:h})}});let a=null;if(s.length>0){const c=s.map(h=>{const m=h.data.columnIndex!==void 0?h.data.columnIndex:h.data.startColumnIndex!==void 0?h.data.startColumnIndex:h.data.column,f=ft(m,i),g=Rt(h.data.row,i);return{x:f,y:g}});a=da(c)}u.state.lassoSelection={selectedItems:s,convexHull:a,isActive:s.length>0},u.recordState(),T.log("AnnotationService",`Lasso selection completed: ${s.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){var i,r;if(!((i=u.state.lassoSelection)!=null&&i.isActive)||!((r=u.state.lassoSelection.selectedItems)!=null&&r.length))return;const e=this.getRenderOptions(),s=u.state.lassoSelection.selectedItems.map(a=>{const c=a.data.columnIndex!==void 0?a.data.columnIndex:a.data.startColumnIndex!==void 0?a.data.startColumnIndex:a.data.column,h=ft(c,e),m=Rt(a.data.row,e);return{x:h,y:m}});u.state.lassoSelection.convexHull=da(s)}removeFromLassoSelection(e,s){var c;if(!((c=u.state.lassoSelection)!=null&&c.isActive))return;const i=this.getRenderOptions(),r=15;let a=null;if(u.state.placedNotes.forEach(h=>{const m=ft(h.columnIndex,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=r&&(a=`note-${h.row}-${h.columnIndex}-${h.color}-${h.shape}`)}),a||u.state.stampPlacements.forEach(h=>{const m=ft(h.column,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=r&&(a=`stamp-${h.row}-${h.column}-${h.stampId}`)}),a||u.state.tripletPlacements.forEach(h=>{const m=ft(h.column,i),f=Rt(h.row,i);Math.hypot(e-m,s-f)<=r&&(a=`triplet-${h.row}-${h.column}-${h.tripletId}`)}),a){const h=u.state.lassoSelection.selectedItems.filter(f=>f.id!==a);let m=null;if(h.length>0){const f=h.map(g=>{const y=ft(g.data.columnIndex||g.data.column,i),w=Rt(g.data.row,i);return{x:y,y:w}});m=da(f)}u.state.lassoSelection={selectedItems:h,convexHull:m,isActive:h.length>0},u.recordState(),this.render(),T.log("AnnotationService",`Removed item from lasso selection. ${h.length} items remain.`,"annotation")}}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(e){const{startX:s,startY:i,endX:r,endY:a}=e,c=this.ctx,h=Math.min(s,r),m=Math.min(i,a),f=Math.abs(r-s),g=Math.abs(a-i);c.save(),c.strokeStyle="rgba(74, 144, 226, 0.6)",c.lineWidth=2,c.setLineDash([5,5]),c.strokeRect(h,m,f,g),this.toolSettings.text.background&&(c.fillStyle="rgba(255, 255, 255, 0.8)",c.fillRect(h,m,f,g)),c.restore()}render(){Yi.render()}drawArrow(e,s=!1,i=!1,r=!1){const{startX:a,startY:c,endX:h,endY:m,settings:f}=e,g=this.ctx;g.save(),i&&(g.strokeStyle="#4a90e2",g.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,g.globalAlpha=.3,g.setLineDash([]),g.beginPath(),g.moveTo(a,c),g.lineTo(h,m),g.stroke(),g.globalAlpha=1),r&&!i&&(g.strokeStyle="#4a90e2",g.lineWidth=this.getStrokeWidth(f.strokeWeight)+4,g.globalAlpha=.15,g.setLineDash([]),g.beginPath(),g.moveTo(a,c),g.lineTo(h,m),g.stroke(),g.globalAlpha=1),g.strokeStyle=s?"rgba(0, 0, 0, 0.5)":"#000000",g.lineWidth=this.getStrokeWidth(f.strokeWeight),g.setLineDash(this.getLineDash(f.lineStyle));const y=Math.atan2(m-c,h-a),w=f.arrowheadSize||12;let C=a,A=c,I=h,E=m;f.startArrowhead!=="none"&&(C=a+Math.cos(y)*w,A=c+Math.sin(y)*w),f.endArrowhead!=="none"&&(I=h-Math.cos(y)*w,E=m-Math.sin(y)*w),g.beginPath(),g.moveTo(C,A),g.lineTo(I,E),g.stroke(),f.startArrowhead!=="none"&&this.drawArrowhead(g,a,c,y+Math.PI,f.startArrowhead,w),f.endArrowhead!=="none"&&this.drawArrowhead(g,h,m,y,f.endArrowhead,w),g.restore()}drawArrowhead(e,s,i,r,a,c=12){switch(e.save(),e.translate(s,i),e.rotate(r),e.setLineDash([]),a){case"filled":case"filled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.fillStyle=e.strokeStyle,e.fill();break;case"unfilled":case"unfilled-arrow":e.beginPath(),e.moveTo(0,0),e.lineTo(-c,-c/2),e.lineTo(-c,c/2),e.closePath(),e.stroke();break;case"circle":e.beginPath(),e.arc(0,0,c/3,0,Math.PI*2),e.fillStyle=e.strokeStyle,e.fill();break}e.restore()}wrapText(e,s,i){const r=s.split(`
`),a=[];return r.forEach(c=>{if(!c.trim()){a.push("");return}const h=c.split(" ");let m="";h.forEach((f,g)=>{const y=m?m+" "+f:f;e.measureText(y).width>i&&m?(a.push(m),m=f):m=y}),m&&a.push(m)}),a}drawText(e,s=!1,i=!1){const{x:r,y:a,text:c,settings:h}=e,m=this.ctx;m.save();const g=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',y=this.getSizeValue(h.size);m.font=`${h.italic?"italic ":""}${h.bold?"bold ":""}${y} ${g}`,m.textBaseline="top";const w=parseInt(y)*1.2,C=e.width||0,A=e.height||0,I=h.background?16:8,E=C-I,O=this.wrapText(m,c,E);if(h.background){m.fillStyle="#ffffff";const R=8;m.fillRect(r-R/2,a-R/2,C+R,A+R/2)}if(i&&!s){m.fillStyle="rgba(74, 144, 226, 0.1)";const R=h.background?8:2;m.fillRect(r-R/2,a-R/2,C+R,A+R/2)}if(s){m.fillStyle="rgba(74, 144, 226, 0.2)";const R=h.background?8:2;m.fillRect(r-R/2,a-R/2,C+R,A+R/2)}m.fillStyle=h.color;const P=parseInt(y);O.forEach((R,q)=>{const G=a+q*w;this.drawTextWithSuperscripts(m,R,r,G,P,h,g)}),s&&this.drawResizeHandles(r,a,C,A),m.restore()}drawTextWithSuperscripts(e,s,i,r,a,c,h){if(c.superscript||c.subscript){e.save();const y=a*.6,w=c.superscript?-a*.4:a*.3;if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${y}px ${h}`,e.fillText(s,i,r+w),c.underline){const C=e.measureText(s);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(i,r+w+y*1.2-2),e.lineTo(i+C.width,r+w+y*1.2-2),e.stroke()}e.restore();return}let m=i;const f=this.parseFormattedText(s),g=(y,w)=>{if(y){if(e.save(),w==="superscript"){const C=a*.6,A=-a*.4;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${C}px ${h}`,e.fillText(y,m,r+A),m+=e.measureText(y).width}else if(w==="subscript"){const C=a*.6,A=a*.3;e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${C}px ${h}`,e.fillText(y,m,r+A),m+=e.measureText(y).width}else{if(e.font=`${c.italic?"italic ":""}${c.bold?"bold ":""}${a}px ${h}`,e.fillText(y,m,r),c.underline){const C=e.measureText(y);e.beginPath(),e.strokeStyle=c.color,e.lineWidth=1,e.moveTo(m,r+a*1.2-2),e.lineTo(m+C.width,r+a*1.2-2),e.stroke()}m+=e.measureText(y).width}e.restore()}};f.forEach(y=>{g(y.text,y.format)})}parseFormattedText(e){const s=[];let i=0,r="",a=!1;for(;i<e.length;){if(e.substr(i,5)==="<sup>"){r&&(s.push({text:r,format:"normal"}),r="");const c=e.indexOf("</sup>",i);if(c!==-1){const h=e.substring(i+5,c);s.push({text:h,format:"superscript"}),i=c+6;continue}}if(e.substr(i,5)==="<sub>"){r&&(s.push({text:r,format:"normal"}),r="");const c=e.indexOf("</sub>",i);if(c!==-1){const h=e.substring(i+5,c);s.push({text:h,format:"subscript"}),i=c+6;continue}}if(e[i]==="^"&&!a){r&&(s.push({text:r,format:"normal"}),r=""),a=!0,i++;continue}if(a&&e[i]===" "){r&&(s.push({text:r,format:"superscript"}),r=""),a=!1,s.push({text:" ",format:"normal"}),i++;continue}r+=e[i],i++}return r&&s.push({text:r,format:a?"superscript":"normal"}),s}drawResizeHandles(e,s,i,r){const a=this.ctx,c=8,h=[{pos:"nw",x:e,y:s},{pos:"n",x:e+i/2,y:s},{pos:"ne",x:e+i,y:s},{pos:"e",x:e+i,y:s+r/2},{pos:"se",x:e+i,y:s+r},{pos:"s",x:e+i/2,y:s+r},{pos:"sw",x:e,y:s+r},{pos:"w",x:e,y:s+r/2}];a.save(),h.forEach(m=>{a.fillStyle="#4a90e2",a.strokeStyle="#ffffff",a.lineWidth=2,a.fillRect(m.x-c/2,m.y-c/2,c,c),a.strokeRect(m.x-c/2,m.y-c/2,c,c)}),a.restore()}drawPath(e,s){const{path:i,settings:r}=e,a=this.ctx;if(!(i.length<2)){a.save(),s&&(a.globalAlpha=.3),a.strokeStyle=r.color,a.lineWidth=this.getStrokeWidth(r.size),a.lineCap="round",a.lineJoin="round",a.beginPath(),a.moveTo(i[0].x,i[0].y);for(let c=1;c<i.length;c++)a.lineTo(i[c].x,i[c].y);a.stroke(),a.restore()}}drawLassoPath(e){const{path:s}=e,i=this.ctx;if(!(s.length<2)){i.save(),i.strokeStyle="rgba(0, 100, 255, 0.8)",i.lineWidth=2,i.setLineDash([5,5]),i.beginPath(),i.moveTo(s[0].x,s[0].y);for(let r=1;r<s.length;r++)i.lineTo(s[r].x,s[r].y);i.lineTo(s[0].x,s[0].y),i.stroke(),i.restore()}}getStrokeWidth(e){if(typeof e=="number")return e;switch(e){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(e){switch(e){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(e){if(typeof e=="number")return`${e}px`;switch(e){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(e,s){var a;const i=this.hoverAnnotation;if(this.selectedAnnotation&&this.selectedAnnotation.type==="text"){const c=this.getResizeHandleAt(e,s,this.selectedAnnotation);if(c){const h={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=h[c];return}}if((a=u.state.lassoSelection)!=null&&a.isActive&&u.state.lassoSelection.convexHull){const c=Wd({x:e,y:s},u.state.lassoSelection.convexHull,10),h=br({x:e,y:s},u.state.lassoSelection.convexHull);if(c||h){this.canvas.style.cursor="move";return}}const r=this.getAnnotationAt(e,s);r&&(r.type==="arrow"||r.type==="text")?(this.canvas.style.cursor="move",this.hoverAnnotation=r):(this.setTool(this.currentTool,this.toolSettings),this.hoverAnnotation=null),i!==this.hoverAnnotation&&this.render()}getResizeHandleAt(e,s,i){if(!i||i.type!=="text")return null;const a=8/2+2,c=i.width||0,h=i.height||0,m=i.x,f=i.y,g=[{pos:"nw",x:m,y:f},{pos:"n",x:m+c/2,y:f},{pos:"ne",x:m+c,y:f},{pos:"e",x:m+c,y:f+h/2},{pos:"se",x:m+c,y:f+h},{pos:"s",x:m+c/2,y:f+h},{pos:"sw",x:m,y:f+h},{pos:"w",x:m,y:f+h/2}];for(const y of g)if(Math.sqrt(Math.pow(e-y.x,2)+Math.pow(s-y.y,2))<=a)return y.pos;return null}getAnnotationAt(e,s){for(let r=u.state.annotations.length-1;r>=0;r--){const a=u.state.annotations[r];if(a.type==="arrow"){if(this.distanceToLineSegment(e,s,a.startX,a.startY,a.endX,a.endY)<10)return a}else if(a.type==="text"){let c=a.width,h=a.height;if(!c||!h){const m=a.text.split(`
`),f=a.settings.size,g=f*1.2;this.ctx.font=`${f}px Arial`,c=0,m.forEach(y=>{const w=this.ctx.measureText(y);c=Math.max(c,w.width)}),h=m.length*g}if(e>=a.x&&e<=a.x+c&&s>=a.y&&s<=a.y+h)return a}}return null}showEraserCursor(e,s){this.render();const r=(u.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(e-r/2,s-r/2,r,r),this.ctx.restore()}loadAnnotationSettings(e){if(e.type==="arrow"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.arrow={...s},window.drawToolsController.renderArrowOptions()}else if(e.type==="text"&&window.drawToolsController){const s=e.settings;window.drawToolsController.settings.text={...s},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){u.state.annotations=[],this.render()}eraseAtPoint(e,s){let r=!1;return u.state.annotations=u.state.annotations.filter(a=>{let c=!0;if(a.type==="arrow"){const h=this.getRenderOptions(),m=ft(a.startCol,h),f=Rt(a.startRow,h),g=ft(a.endCol,h),y=Rt(a.endRow,h);this.distanceToLineSegment(e,s,m,f,g,y)<10&&(c=!1,r=!0)}else if(a.type==="text"){const h=this.getRenderOptions(),m=ft(a.col,h),f=Rt(a.row,h),g=ft(a.col+a.widthCols,h),y=Rt(a.row+a.heightRows,h);e>=m&&e<=g&&s>=f&&s<=y&&(c=!1,r=!0)}else if(a.type==="marker"||a.type==="highlighter"){const h=this.getRenderOptions();for(let m=0;m<a.path.length;m++){const f=ft(a.path[m].col,h),g=Rt(a.path[m].row,h),y=e-f,w=s-g;if(Math.sqrt(y*y+w*w)<10){c=!1,r=!0;break}}}return c}),r&&this.render(),r}interpolatePoints(e,s){const i=[],r=s.col-e.col,a=s.row-e.row,c=Math.sqrt(r*r+a*a),h=Math.max(1,Math.floor(c/.1));for(let m=1;m<=h;m++){const f=m/h;i.push({col:e.col+f*r,row:e.row+f*a})}return i}distanceToLineSegment(e,s,i,r,a,c){const h=a-i,m=c-r,f=h*h+m*m;if(f===0){const I=e-i,E=s-r;return Math.sqrt(I*I+E*E)}let g=((e-i)*h+(s-r)*m)/f;g=Math.max(0,Math.min(1,g));const y=i+g*h,w=r+g*m,C=e-y,A=s-w;return Math.sqrt(C*C+A*A)}deleteAnnotationAt(e,s){this.eraseAtPoint(e,s)}getAnnotations(){return u.state.annotations}loadAnnotations(e){u.state.annotations=e||[],this.render()}applyInlineFormatting(e){const s=document.querySelector(".annotation-text-input");if(!s)return;const i=window.getSelection();if(!i.rangeCount)return;const r=i.getRangeAt(0),a=r.toString();if(!a)return;let c;if(e==="superscript")c=`<sup>${a}</sup>`;else if(e==="subscript")c=`<sub>${a}</sub>`;else return;r.deleteContents();const h=document.createTextNode(c);r.insertNode(h),r.setStartAfter(h),r.setEndAfter(h),i.removeAllRanges(),i.addRange(r),s.focus()}}const Ut=new uw;function dw(n,e){var c;const s=u.state.annotations,i=Ut.tempAnnotation,r=Ut.selectedAnnotation,a=Ut.hoverAnnotation;if(s&&s.length>0&&s.forEach(h=>{const m=h===r,f=h===a;switch(h.type){case"arrow":Hd(n,h,m,f,e);break;case"text":pw(n,h,m,f,e);break;case"marker":pa(n,h,!1,e);break;case"highlighter":pa(n,h,!0,e);break}}),i)switch(i.type){case"arrow":Hd(n,i,!1,!1,e);break;case"text":yw(n,i,e);break;case"marker":pa(n,i,!1,e);break;case"highlighter":pa(n,i,!0,e);break;case"lasso":ww(n,i);break}(c=u.state.lassoSelection)!=null&&c.isActive&&u.state.lassoSelection.convexHull&&(Ut.updateLassoConvexHull(),_w(n,u.state.lassoSelection.convexHull))}function Hd(n,e,s=!1,i=!1,r){const{startCol:a,startRow:c,endCol:h,endRow:m,settings:f}=e,g=ft(a,r),y=Rt(c,r),w=ft(h,r),C=Rt(m,r);n.save(),n.strokeStyle=e.color||"#000000",n.lineWidth=hh(f.strokeWeight),n.setLineDash(bw(f.lineStyle));const A=Math.atan2(C-y,w-g),I=f.arrowheadSize||12;let E=g,O=y,P=w,R=C;f.startArrowhead!=="none"&&(E=g+Math.cos(A)*I,O=y+Math.sin(A)*I),f.endArrowhead!=="none"&&(P=w-Math.cos(A)*I,R=C-Math.sin(A)*I),n.beginPath(),n.moveTo(E,O),n.lineTo(P,R),n.stroke(),n.setLineDash([]),f.startArrowhead!=="none"&&Gd(n,g,y,A+Math.PI,f.startArrowhead,I),f.endArrowhead!=="none"&&Gd(n,w,C,A,f.endArrowhead,I),(s||i)&&(n.strokeStyle=s?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",n.lineWidth=hh(f.strokeWeight)+4,n.setLineDash([]),n.beginPath(),n.moveTo(g,y),n.lineTo(w,C),n.stroke()),n.restore()}function Gd(n,e,s,i,r,a){switch(n.save(),n.translate(e,s),n.rotate(i),r){case"filled":case"filled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-a,-a/2),n.lineTo(-a,a/2),n.closePath(),n.fillStyle=n.strokeStyle,n.fill();break;case"unfilled":case"unfilled-arrow":n.beginPath(),n.moveTo(0,0),n.lineTo(-a,-a/2),n.lineTo(-a,a/2),n.closePath(),n.stroke();break;case"circle":n.beginPath(),n.arc(0,0,a/3,0,Math.PI*2),n.fillStyle=n.strokeStyle,n.fill();break}n.restore()}function pw(n,e,s=!1,i=!1,r){const{col:a,row:c,text:h,settings:m,widthCols:f,heightRows:g}=e,y=ft(a,r),w=Rt(c,r),C=ft(a+f,r)-y,A=Rt(c+g,r)-w;n.save();const E=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',O=m.size,P=O*1.2,R=m.background?8:4,q=4,G=C-R*2,U=mw(n,h,G,O,m,E);m.background&&(n.fillStyle="#ffffff",n.fillRect(y,w,C,A)),i&&!s&&(n.fillStyle="rgba(74, 144, 226, 0.1)",n.fillRect(y,w,C,A)),s&&(n.fillStyle="rgba(74, 144, 226, 0.2)",n.fillRect(y,w,C,A)),n.fillStyle=m.color,U.forEach((j,Y)=>{const tt=w+q+Y*P;fw(n,j,y+R,tt,O,m,E)}),s&&vw(n,y,w,C,A),n.restore()}function mw(n,e,s,i,r,a){n.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${i}px ${a}`;const c=e.split(`
`),h=[];return c.forEach(m=>{if(!m.trim()){h.push("");return}const f=m.split(" ");let g="";f.forEach(y=>{const w=g?g+" "+y:y;n.measureText(w).width>s&&g?(h.push(g),g=y):g=w}),g&&h.push(g)}),h}function fw(n,e,s,i,r,a,c){if(a.superscript||a.subscript){n.save();const f=r*.6,g=a.superscript?-r*.4:r*.3;if(n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${f}px ${c}`,n.fillText(e,s,i+g),a.underline){const y=n.measureText(e);n.beginPath(),n.strokeStyle=a.color,n.lineWidth=1,n.moveTo(s,i+g+f*1.2-2),n.lineTo(s+y.width,i+g+f*1.2-2),n.stroke()}n.restore();return}const h=gw(e);let m=s;h.forEach(f=>{if(n.save(),f.format==="superscript"){const g=r*.6,y=-r*.4;n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${g}px ${c}`,n.fillText(f.text,m,i+y),m+=n.measureText(f.text).width}else if(f.format==="subscript"){const g=r*.6,y=r*.3;n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${g}px ${c}`,n.fillText(f.text,m,i+y),m+=n.measureText(f.text).width}else{if(n.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${r}px ${c}`,n.fillText(f.text,m,i),a.underline){const g=n.measureText(f.text);n.beginPath(),n.strokeStyle=a.color,n.lineWidth=1,n.moveTo(m,i+r*1.2-2),n.lineTo(m+g.width,i+r*1.2-2),n.stroke()}m+=n.measureText(f.text).width}n.restore()})}function gw(n){const e=[];let s=0,i="",r=!1;for(;s<n.length;){if(n.substr(s,5)==="<sup>"){i&&(e.push({text:i,format:"normal"}),i="");const a=n.indexOf("</sup>",s);if(a!==-1){const c=n.substring(s+5,a);e.push({text:c,format:"superscript"}),s=a+6;continue}}if(n.substr(s,5)==="<sub>"){i&&(e.push({text:i,format:"normal"}),i="");const a=n.indexOf("</sub>",s);if(a!==-1){const c=n.substring(s+5,a);e.push({text:c,format:"subscript"}),s=a+6;continue}}if(n[s]==="^"&&!r){i&&(e.push({text:i,format:"normal"}),i=""),r=!0,s++;continue}if(r&&n[s]===" "){i&&(e.push({text:i,format:"superscript"}),i=""),r=!1,e.push({text:" ",format:"normal"}),s++;continue}i+=n[s],s++}return i&&e.push({text:i,format:r?"superscript":"normal"}),e}function vw(n,e,s,i,r){const c=[{x:e,y:s},{x:e+i/2,y:s},{x:e+i,y:s},{x:e+i,y:s+r/2},{x:e+i,y:s+r},{x:e+i/2,y:s+r},{x:e,y:s+r},{x:e,y:s+r/2}];n.save(),c.forEach(h=>{n.fillStyle="#4a90e2",n.strokeStyle="#ffffff",n.lineWidth=2,n.fillRect(h.x-8/2,h.y-8/2,8,8),n.strokeRect(h.x-8/2,h.y-8/2,8,8)}),n.restore()}function yw(n,e,s){const{startCol:i,startRow:r,endCol:a,endRow:c}=e,h=ft(i,s),m=Rt(r,s),f=ft(a,s),g=Rt(c,s),y=Math.min(h,f),w=Math.min(m,g),C=Math.abs(f-h),A=Math.abs(g-m);n.save(),n.strokeStyle="rgba(74, 144, 226, 0.6)",n.lineWidth=2,n.setLineDash([5,5]),n.strokeRect(y,w,C,A),n.restore()}function pa(n,e,s,i){const{path:r,settings:a}=e;if(!r||r.length<2)return;const c=r.map(h=>({x:ft(h.col,i),y:Rt(h.row,i)}));n.save(),s&&(n.globalAlpha=.3),n.strokeStyle=a.color,n.lineWidth=typeof a.size=="number"?a.size:hh(a.size),n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(c[0].x,c[0].y);for(let h=1;h<c.length;h++)n.lineTo(c[h].x,c[h].y);n.stroke(),n.restore()}function hh(n){if(typeof n=="number")return n;switch(n){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function bw(n){switch(n){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function ww(n,e){if(!(!e.path||e.path.length<2)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([5,5]),n.globalAlpha=.7,n.beginPath(),n.moveTo(e.path[0].x,e.path[0].y);for(let s=1;s<e.path.length;s++)n.lineTo(e.path[s].x,e.path[s].y);e.path.length>2&&n.lineTo(e.path[0].x,e.path[0].y),n.stroke(),n.restore()}}function _w(n,e){if(!(!e||e.length<3)){n.save(),n.strokeStyle="#4a90e2",n.lineWidth=2,n.setLineDash([8,4]),n.globalAlpha=.8,n.beginPath(),n.moveTo(e[0].x,e[0].y);for(let s=1;s<e.length;s++)n.lineTo(e[s].x,e[s].y);n.closePath(),n.stroke(),n.fillStyle="rgba(74, 144, 226, 0.1)",n.fill(),n.restore()}}function tm(n,e){const s={...e,...u.state};s.modulationMarkers&&s.modulationMarkers.length>0,n.clearRect(0,0,n.canvas.width,n.canvas.height);const{startRow:i,endRow:r}=N0();jb(n,s,i,r),zb(n,s,i,r),Wb(n,s);const a=e.placedNotes.filter(h=>!h.isDrum&&h.row>=i&&h.row<=r),c=e.placedTonicSigns.filter(h=>h.row>=i&&h.row<=r);a.forEach(h=>{h.shape==="oval"?Rh(n,s,h,h.row):h.shape==="circle"&&Ih(n,s,h,h.row)}),c.forEach(h=>{Dh(n,s,h)}),Xb(n,s),Kb(n,s),Kp(n,s),dw(n,s)}const em={getTimeSignatureSegments(){const n=[];let e=u.state.hasAnacrusis,s=cs(u.state,0).startColumn,i=0,r=!1;return u.state.macrobeatGroupings.forEach((a,c)=>{i+=a,a===3&&(r=!0);const h=c===u.state.macrobeatGroupings.length-1,f=u.state.macrobeatBoundaryStyles[c]==="solid";if(f||h){const g=cs(u.state,c).endColumn+1,y=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;let w,C;if(y){const I={...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth};w=ft(s,I),C=ft(g,I)}else w=xt.getColumnX(s),C=xt.getColumnX(g);const A=r?`${i}/8`:`${i/2}/4`;n.push({label:A,centerX:(w+C)/2,startX:w,endX:C,isAnacrusis:e}),h||(s=g,i=0,r=!1,f&&(e=!1))}}),n},getRhythmUIButtons(){const n=[],e=u.state.modulationMarkers&&u.state.modulationMarkers.length>0,s=e?{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}:null;return u.state.macrobeatGroupings.forEach((i,r)=>{const{startColumn:a,endColumn:c}=cs(u.state,r),h=e?ft(a,s):xt.getColumnX(a),m=e?ft(c+1,s):xt.getColumnX(c+1),f=(h+m)/2;if(n.push({type:"grouping",content:i,x:f,y:20,index:r}),r<u.state.macrobeatGroupings.length-1){const g=u.state.macrobeatBoundaryStyles[r];let y;switch(g){case"solid":y="";break;case"anacrusis":y="x";break;default:y="";break}n.push({type:"boundary",content:y,x:m,y:35,index:r})}}),n}};function xw(){const n=document.getElementById("beat-line-button-layer");if(!n)return;n.innerHTML="";const e=document.getElementById("notation-grid");if(!e)return;const s=e.getBoundingClientRect(),i=n.getBoundingClientRect(),r=s.left-i.left;em.getRhythmUIButtons().forEach((c,h)=>{const m=document.createElement("button");m.type="button",m.textContent=c.content,m.className="rhythm-ui-button",m.dataset.type=c.type,m.classList.add(`rhythm-ui-button--${c.type}`),m.style.position="absolute";const f=r+c.x;m.style.left=`${f}px`,m.style.top=`${c.y}px`,m.style.transform="translateX(-50%)",c.type==="grouping"?m.addEventListener("click",()=>u.toggleMacrobeatGrouping(c.index)):m.addEventListener("click",()=>u.cycleMacrobeatBoundaryStyle(c.index)),n.appendChild(m)})}const Sw={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const n=this.getTimeSignatureOptions();let e='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(n).forEach(([s,i])=>{e+='<div class="dropdown-category">',e+=`<div class="dropdown-category-header">${s}</div>`,i.forEach((r,a)=>{const c=`${s}-${a}`;e+=`<div class="dropdown-option" data-groupings="${JSON.stringify(r.groupings)}" data-key="${c}">`,e+=`<span class="dropdown-label">${r.label}</span>`,e+=`<span class="dropdown-description">${r.description}</span>`,e+="</div>"}),e+="</div>"}),e+="</div>",e},getTimeSignatureLabel(n){const e=n.reduce((i,r)=>i+r,0);return n.includes(3)?`${e}/8`:`${e/2}/4`}};let Xi=null;function Cw(){const n=document.getElementById("beat-line-button-layer");if(!n)return;n.querySelectorAll(".time-signature-label").forEach(h=>h.remove());const s=document.getElementById("notation-grid");if(!s)return;const i=s.getBoundingClientRect(),r=n.getBoundingClientRect(),a=i.left-r.left;em.getTimeSignatureSegments().forEach((h,m)=>{const f=document.createElement("div");f.className="time-signature-label",h.isAnacrusis&&f.classList.add("anacrusis-label"),f.textContent=h.label,f.style.position="absolute",f.style.left=`${a+h.centerX}px`,f.style.transform="translateX(-50%)",f.addEventListener("click",g=>{g.stopPropagation(),Aw(f,m)}),n.appendChild(f)}),Tw()}function Tw(){if(!document.getElementById("time-signature-dropdown")){const n=Sw.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",n),document.getElementById("time-signature-dropdown").addEventListener("click",Ew)}}function Aw(n,e){const s=document.getElementById("time-signature-dropdown");if(!s)return;s.dataset.measureIndex=e;const i=n.getBoundingClientRect();s.style.left=`${i.left}px`,s.style.top=`${i.bottom+5}px`;const r=s.getBoundingClientRect(),a=window.innerWidth,c=window.innerHeight;i.left+r.width>a&&(s.style.left=`${a-r.width-10}px`),i.bottom+r.height>c&&(s.style.top=`${i.top-r.height-5}px`),s.classList.remove("hidden"),Xi={dropdown:s,measureIndex:e},setTimeout(()=>{document.addEventListener("click",Mw,{once:!0})},0)}function Mw(n){const e=document.getElementById("time-signature-dropdown");e&&!e.contains(n.target)&&(e.classList.add("hidden"),Xi=null)}function Ew(n){const e=n.target.closest(".dropdown-option");if(!e)return;const s=e.dataset.groupings,i=parseInt(Xi==null?void 0:Xi.measureIndex,10);if(!(!s||Number.isNaN(i)))try{const r=JSON.parse(s);u.updateTimeSignature(i,r),document.getElementById("time-signature-dropdown").classList.add("hidden"),Xi=null}catch{}}T.moduleLoaded("PitchGridController","grid");function Pw(){const n=Ph.getPitchContext();if(!n||!n.canvas){T.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const e={placedNotes:Xy(u.state),placedTonicSigns:an(u.state),fullRowData:u.state.fullRowData,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,rowHeight:u.state.cellHeight*.5,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,colorMode:"color",degreeDisplayMode:u.state.degreeDisplayMode,zoomLevel:xt.getViewportInfo().zoomLevel,viewportHeight:n.canvas.height};tm(n,e)}const Yi={render(){Pw()},renderMacrobeatTools(){xw(),Cw()}};let ma=null;const kw=()=>(ma||(ma=new Image,ma.src="/assets/icons/Volume.svg"),ma);function Fn(n,e){return e.modulationMarkers&&e.modulationMarkers.length>0?ft(n,e):xt.getColumnX(n)}function sm(n,e,s,i,r,a,c=1){const h=s+r/2,m=i+a/2,f=Math.min(r,a)*.4*c;if(n.beginPath(),e===0)n.moveTo(h,m-f),n.lineTo(h-f,m+f),n.lineTo(h+f,m+f),n.closePath();else if(e===1)n.moveTo(h,m-f),n.lineTo(h+f,m),n.lineTo(h,m+f),n.lineTo(h-f,m),n.closePath();else{for(let y=0;y<5;y++){const w=2*Math.PI/5*y-Math.PI/2,C=h+f*Math.cos(w),A=m+f*Math.sin(w);y===0?n.moveTo(C,A):n.lineTo(C,A)}n.closePath()}n.fill()}function Iw(n,e,s,i,r="normal"){const a=kw();if(r!=="normal"){const c=i*1.3;n.beginPath(),n.arc(e,s,c/2,0,Math.PI*2),r==="hover"?n.fillStyle="rgba(74, 144, 226, 0.2)":r==="active"&&(n.fillStyle="rgba(74, 144, 226, 0.4)"),n.fill()}if(a.complete&&a.naturalWidth>0)r==="hover"?n.filter="brightness(1.2)":r==="active"&&(n.filter="brightness(0.8)"),n.drawImage(a,e-i/2,s-i/2,i,i),n.filter="none";else{let c="#6c757d",h="#6c757d";r==="hover"?(c="#4a90e2",h="#4a90e2"):r==="active"&&(c="#357abd",h="#357abd"),n.fillStyle=c,n.strokeStyle=h,n.lineWidth=1;const m=i*.4,f=i*.6,g=i*.3;n.fillRect(e-m/2,s-f/2,m,f),n.beginPath(),n.moveTo(e+m/2,s-f/3),n.lineTo(e+m/2+g,s-f/2),n.lineTo(e+m/2+g,s+f/2),n.lineTo(e+m/2,s+f/3),n.closePath(),n.fill();for(let y=1;y<=2;y++)n.beginPath(),n.arc(e+m/2+g+i*.1,s,i*.2*y,-Math.PI/4,Math.PI/4,!1),n.stroke()}}function Rw(n,e){const{columnWidths:s,macrobeatGroupings:i,macrobeatBoundaryStyles:r,placedTonicSigns:a}=e,c=s.length-2;let h=[],m=2;for(let f=0;f<i.length;f++){for(;a.some(g=>g.columnIndex===m);)m+=2;m+=i[f],h.push(m)}for(let f=0;f<=c;f++){const g=Fn(f,e);if(g<0||g>n.canvas.width)continue;let y;const w=f===2||f===c,C=Zp(f,a),A=a.some(O=>f===O.columnIndex+2),I=h.includes(f);if(Qp(f,a)){if(w||C||A)y={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(I){const O=h.indexOf(f);if(O!==-1){const P=r[O];if(P==="anacrusis")continue;y={lineWidth:1,strokeStyle:"#adb5bd",dash:P==="solid"?[]:[5,5]}}else continue}else continue;n.beginPath(),n.moveTo(g,0),n.lineTo(g,n.canvas.height),n.lineWidth=y.lineWidth,n.strokeStyle=y.strokeStyle,n.setLineDash(y.dash),n.stroke()}}n.setLineDash([])}function nm(n,e){const{placedNotes:s,columnWidths:i,cellWidth:r,cellHeight:a,placedTonicSigns:c}=e;n.clearRect(0,0,n.canvas.width,n.canvas.height);const h=n.canvas;h.getBoundingClientRect(),window.getComputedStyle(h);const m=Math.max(Cr,Tr*a),f=i.length,g=["H","M","L"];n.font=`${Math.floor(m*.7)}px 'Atkinson Hyperlegible', sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillStyle="#6c757d";const y=Fn(1,e)+Fn(1,e)*.3;g.forEach((E,O)=>{n.fillText(E,y,O*m+m/2)});const w=Fn(1,e)-Fn(1,e)*.3,C=3*m/2,A=e.volumeIconState||"normal";Iw(n,w,C,m*.6,A);const I=Fn(2,e);for(let E=0;E<4;E++){const O=E*m;n.beginPath(),n.moveTo(I,O),n.lineTo(n.canvas.width,O),n.strokeStyle="#ced4da",n.lineWidth=1,n.stroke()}Rw(n,e);for(let E=2;E<f-2;E++){if(c.some(R=>R.columnIndex===E))continue;const O=Fn(E,e);let P;e.modulationMarkers&&e.modulationMarkers.length>0?P=Fn(E+1,e)-O:P=i[E]*r;for(let R=0;R<3;R++){const q=R*m,G=g[R],U=s.find(j=>j.isDrum&&j.drumTrack===G&&j.startColumnIndex===E);if(U){n.fillStyle=U.color;const j=Vn.getAnimationScale(E,G);sm(n,R,O,q,P,m,j)}else n.fillStyle="#ced4da",n.beginPath(),n.arc(O+P/2,q+m/2,2,0,Math.PI*2),n.fill()}}Kp(n,e)}const Gs={getColumnIndex(n){const{columnWidths:e,cellWidth:s,modulationMarkers:i}=u.state;if(s===0)return 0;if(i&&i.length>0){const a={...u.state,modulationMarkers:i,cellWidth:s,columnWidths:e,baseMicrobeatPx:s};for(let c=0;c<e.length;c++){const h=ft(c+1,a);if(n<h)return c}}else{let a=0;for(let c=0;c<e.length;c++)if(a+=e[c]*s,n<a)return c}return e.length-1},getPitchRowIndex(n){const e=xt.getViewportInfo();if(!e||!e.halfUnit||e.halfUnit===0)return-1;const s=Math.floor(n/e.halfUnit);return e.startRank+s},getDrumRowIndex(n){const e=Math.max(Cr,Tr*u.state.cellHeight);return e===0?-1:Math.floor(n/e)}};let pe,La=!1,wr=!1,Ta=1,yn=null,wn="normal",jd=0;const Dw=500;function lo(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s={modulationMarkers:u.state.modulationMarkers,columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,baseMicrobeatPx:u.state.baseMicrobeatPx||u.state.cellWidth||40};return ft(n,s)}else return xt.getColumnX(n)}function im(n){if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0){const s=lo(n);return lo(n+1)-s}else return u.state.columnWidths[n]*u.state.cellWidth}function uh(n,e,s){if(!pe)return;const i=lo(n),r=Math.max(Cr,Tr*u.state.cellHeight),a=e*r,c=im(n);pe.fillStyle=s,pe.fillRect(i,a,c,r)}function Ow(n,e){if(!pe)return;const s=lo(n),i=Math.max(Cr,Tr*u.state.cellHeight),r=e*i,a=im(n),c=["H","M","L"][e],h=Vn.getAnimationScale(n,c);pe.globalAlpha=.4,pe.fillStyle=u.state.selectedTool.color||"#212529",sm(pe,e,s,r,a,i,h),pe.globalAlpha=1}function Nw(n){const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=lo(2),a=s<r,c=wn;if(wn=a?"hover":"normal",c!==wn&&window.drumGridRenderer&&window.drumGridRenderer.render(),a){pe&&pe.clearRect(0,0,pe.canvas.width,pe.canvas.height);return}const h=document.getElementById("canvas-container").scrollLeft,m=Gs.getColumnIndex(s+h),f=Gs.getDrumRowIndex(i);if(!pe||m<2||m>=u.state.columnWidths.length-2||f<0||f>2){Bh();return}pe.clearRect(0,0,pe.canvas.width,pe.canvas.height);const g=["H","M","L"][f];La?(u.eraseDrumNoteAt(m,g,!1)&&(wr=!0),uh(m,f,"rgba(220, 53, 69, 0.3)")):(uh(m,f,"rgba(74, 144, 226, 0.2)"),Ow(m,f))}function Bh(){pe&&pe.clearRect(0,0,pe.canvas.width,pe.canvas.height),wn!=="normal"&&(wn="normal",window.drumGridRenderer&&window.drumGridRenderer.render())}function Lw(n){var f;n.preventDefault();const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=lo(2);if(s<r){wn="active",window.drumGridRenderer&&window.drumGridRenderer.render();const g=document.querySelector(".drum-volume-control");if(g){const y=g.style.display==="flex";g.style.display=y?"none":"flex"}return}const a=document.getElementById("canvas-container").scrollLeft,c=Gs.getColumnIndex(s+a);if(c<2||c>=u.state.columnWidths.length-2)return;const h=Gs.getDrumRowIndex(i);if(h<0||h>2)return;const m=["H","M","L"][h];if(n.button===2){La=!0,wr=!1,(f=document.getElementById("eraser-tool-button"))==null||f.classList.add("erasing-active"),u.eraseDrumNoteAt(c,m,!1)&&(wr=!0),pe.clearRect(0,0,pe.canvas.width,pe.canvas.height),uh(c,h,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const{color:g}=u.state.selectedTool,y={isDrum:!0,drumTrack:m,startColumnIndex:c,endColumnIndex:c,color:g||"#000000",shape:m==="H"?"triangle":m==="M"?"square":"pentagon"};u.toggleDrumNote(y),window.transportService&&window.transportService.drumPlayers&&(window.transportService.drumPlayers.player(m).start(),Vn.triggerNotePop(c,m))}}function Fw(){var n;La&&(wr&&u.recordState(),La=!1,wr=!1,(n=document.getElementById("eraser-tool-button"))==null||n.classList.remove("erasing-active")),wn==="active"&&(wn="normal",window.drumGridRenderer&&window.drumGridRenderer.render()),Bh()}function Bw(){const n=document.getElementById("drum-grid-wrapper");if(!n)return;const e=document.createElement("div");e.className="drum-volume-control",e.style.cssText=`
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(255, 255, 255, 0.9);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 8px;
        display: none;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        z-index: 10;
    `,yn=document.createElement("input"),yn.type="range",yn.min="0",yn.max="100",yn.value="100",yn.className="drum-volume-slider",yn.style.cssText="width: 80px; margin: 0;",yn.addEventListener("input",r=>{if(Ta=r.target.value/100,window.drumVolumeNode){const a=Ta===0?-60:20*Math.log10(Ta);window.drumVolumeNode.volume.value=a;const c=Date.now();window.transportService&&window.transportService.drumPlayers&&c-jd>=Dw&&(window.transportService.drumPlayers.player("M").start("+0.1"),jd=c)}}),e.appendChild(yn),n.appendChild(e);const s=()=>{e.style.display="flex"},i=()=>{e.style.display="none"};n.addEventListener("mouseenter",r=>{const a=n.getBoundingClientRect();r.clientX-a.left<60&&s()}),e.addEventListener("mouseenter",s),e.addEventListener("mouseleave",i),n.addEventListener("mouseleave",i)}function $w(){return Ta}function qw(){return wn}window.getDrumVolume=$w;function zw(){const n=document.getElementById("drum-grid"),e=document.getElementById("drum-hover-canvas");!n||!e||(pe=e.getContext("2d"),n.addEventListener("mousedown",Lw),n.addEventListener("mousemove",Nw),n.addEventListener("mouseleave",Bh),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",Fw),Bw())}function Ud(){const n=Ph.getDrumContext();if(!n||!n.canvas)return;const e={placedNotes:Yy(u.state),placedTonicSigns:an(u.state),columnWidths:u.state.columnWidths,cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,macrobeatGroupings:u.state.macrobeatGroupings,macrobeatBoundaryStyles:u.state.macrobeatBoundaryStyles,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.cellWidth,volumeIconState:qw()};nm(n,e)}const Ps={animationFrameId:null,render(){Ud(),Vn.hasActiveAnimations()?Ps.animationFrameId||Ps.startAnimationLoop():Ps.stopAnimationLoop()},startAnimationLoop(){if(Ps.animationFrameId)return;const n=()=>{Vn.cleanupAnimations(),Ud(),Vn.hasActiveAnimations()?Ps.animationFrameId=requestAnimationFrame(n):Ps.animationFrameId=null};Ps.animationFrameId=requestAnimationFrame(n)},stopAnimationLoop(){Ps.animationFrameId&&(cancelAnimationFrame(Ps.animationFrameId),Ps.animationFrameId=null)}};window.drumGridRenderer=Ps;T.moduleLoaded("RhythmPlaybackService");class Ww{constructor(){this.scheduledEvents=[],this.isInitialized=!1}async initialize(){this.isInitialized||(await J.start(),this.isInitialized=!0,T.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(e,s,i,r="oval",a=null){if(!this.isInitialized){T.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const c=Lp(e,a);if(!c||c.length===0){T.warn("RhythmPlaybackService",`No events found for stamp ${e}`);return}T.debug("RhythmPlaybackService",`Playing pattern for stamp ${e}: ${c.length} notes`,{stampId:e,basePitch:s,color:i,events:c,hasShapeOffsets:!!(a!=null&&a.shapeOffsets)});const h=J.now(),m=a==null?void 0:a.row;c.forEach((f,g)=>{try{const y=J.Time(f.offset).toSeconds(),w=h+y;let C=J.Time(f.duration).toSeconds();const A=r==="circle"?C*2:C,I=w+A;let E=s;if(m!==void 0&&f.rowOffset!==0){const O=m+f.rowOffset,P=u.state.fullRowData[O];P&&(E=P.toneNote.replace("","b").replace("","#"))}Gt.triggerAttack(E,i,w),Gt.triggerRelease(E,i,I),this.scheduledEvents.push({pitch:E,color:i,attackTime:w,releaseTime:I})}catch(y){T.warn("RhythmPlaybackService",`Error scheduling note ${g+1}`,y)}}),T.info("RhythmPlaybackService",`Scheduled ${c.length} notes for rhythm pattern ${e}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(T.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),Gt.releaseAll(),this.scheduledEvents=[])}getStampAtPosition(e,s){return u.state.stampPlacements&&u.state.stampPlacements.find(r=>{const a=r.row===s,c=e>=r.startColumn&&e<=r.endColumn;return a&&c})||null}playTripletPattern(e,s,i,r=null){if(!this.isInitialized){T.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}gr(()=>Promise.resolve().then(()=>J0),void 0).then(a=>{const{getTripletScheduleEvents:c}=a;this.stopCurrentPattern();const h=c(e,r);if(!h||h.length===0){T.warn("RhythmPlaybackService",`No events found for triplet ${e}`);return}T.debug("RhythmPlaybackService",`Playing triplet pattern ${e}: ${h.length} notes`,{tripletStampId:e,basePitch:s,color:i,events:h,hasShapeOffsets:!!(r!=null&&r.shapeOffsets)});const m=J.now(),f=r==null?void 0:r.row;h.forEach((g,y)=>{try{const w=J.Time(g.offset).toSeconds(),C=m+w,A=J.Time(g.duration).toSeconds(),I=C+A;let E=s;if(f!==void 0&&g.rowOffset!==0){const O=f+g.rowOffset,P=u.state.fullRowData[O];P&&(E=P.toneNote.replace("","b").replace("","#"))}Gt.triggerAttack(E,i,C),Gt.triggerRelease(E,i,I),this.scheduledEvents.push({pitch:E,color:i,attackTime:C,releaseTime:I})}catch(w){T.warn("RhythmPlaybackService",`Error scheduling triplet note ${y+1}`,w)}}),T.info("RhythmPlaybackService",`Scheduled ${h.length} notes for triplet pattern ${e}`)})}getTripletAtPosition(e,s){return u.state.tripletPlacements&&u.state.tripletPlacements.find(i=>i.row===s&&e>=i.startCellIndex&&e<i.startCellIndex+i.span)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,T.info("RhythmPlaybackService","Disposed")}}const sn=new Ww;T.moduleLoaded("StampsToolbar","stamps");const $h={selectedStampId:1,init(){this.render(),this.bindEvents(),T.info("StampsToolbar","Stamps toolbar initialized",null,"stamps")},render(){const n=document.getElementById("stamps-toolbar-container");if(!n){T.warn("StampsToolbar","Container not found",null,"stamps");return}n.innerHTML="";const e=document.createElement("div");e.className="stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((i,r)=>{const a=document.createElement("div");a.className=`stamps-row stamps-row-${r+1}`,i.forEach(c=>{const h=eh.find(m=>m.id===c);if(h){const m=this.createStampButton(h,c-1);a.appendChild(m)}}),e.appendChild(a)}),n.appendChild(e),this.setInitialSelection(this.selectedStampId)},createStampButton(n,e){const s=document.createElement("button");s.className="stamp-button",s.setAttribute("data-stamp-id",n.id),s.setAttribute("title",`${n.id}: ${n.label}`);const i=this.createStampPreview(n);return s.appendChild(i),s},createStampPreview(n){const e=Fh.renderToSVG(n,100,100);return e.setAttribute("width","40"),e.setAttribute("height","40"),e},bindEvents(){const n=document.getElementById("stamps-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const i=s.target.closest(".stamp-button");if(i){const r=parseInt(i.getAttribute("data-stamp-id"));this.selectStamp(r)}}),this.updateStampColors=s=>{if(!s||!n)return;const i=(f,g=50)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),C=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(y+(255-y)*(g/100))),I=Math.min(255,Math.floor(w+(255-w)*(g/100))),E=Math.min(255,Math.floor(C+(255-C)*(g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}`},r=(f,g=20)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),C=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(y*(1-g/100))),I=Math.max(0,Math.floor(w*(1-g/100))),E=Math.max(0,Math.floor(C*(1-g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}`},a=u.state.colorPalette[s]||{primary:s,light:s},c=i(a.light,60),h=a.primary,m=r(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),T.info("StampsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"stamps")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateStampColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateStampColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="stamp"&&this.clearSelection()}),u.on("tripletToolSelected",()=>{this.clearSelection()})},setInitialSelection(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),T.info("StampsToolbar",`Initial stamp selection set to ${n} (no tool change during init)`,{stampId:n},"stamps")},selectStamp(n){this.selectedStampId=n;const e=document.getElementById("stamps-toolbar-container");e&&e.querySelectorAll(".stamp-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-stamp-id"))===n)}),console.log(" [STAMPS] Selecting stamp tool via proper action"),u.setSelectedTool("stamp"),u.emit("stampSelected",n),u.emit("stampToolSelected"),T.info("StampsToolbar",`Selected stamp ${n} and switched to stamp tool`,{stampId:n},"stamps")},clearSelection(){this.selectedStampId=null;const n=document.getElementById("stamps-toolbar-container");n&&n.querySelectorAll(".stamp-button").forEach(e=>{e.classList.remove("active")})},getSelectedStamp(){return eh.find(n=>n.id===this.selectedStampId)}};T.moduleLoaded("TripletsToolbar","triplets");const ja={selectedTripletStampId:null,init(){this.render(),this.bindEvents(),T.info("TripletsToolbar","Triplets toolbar initialized",null,"triplets")},render(){const n=document.getElementById("triplets-toolbar-container");if(!n){T.warn("TripletsToolbar","Container not found",null,"triplets");return}n.innerHTML="";const e=document.createElement("div");e.className="triplets-main-container";const s=document.createElement("div");s.className="triplets-sections";const i=this.createSection("Eighth Triplets",sh.slice(0,7));s.appendChild(i);const r=this.createQuarterTripletsSection(sh.slice(7,14));s.appendChild(r),e.appendChild(s),n.appendChild(e)},createSection(n,e){const s=document.createElement("div");s.className="triplets-section";const i=document.createElement("div");return i.className="triplets-grid",e.forEach(r=>{const a=this.createTripletButton(r);i.appendChild(a)}),s.appendChild(i),s},createQuarterTripletsSection(n){const e=document.createElement("div");e.className="triplets-section";const s=document.createElement("div");s.className="triplets-grid triplets-quarter-row",[n[0],n[1],n[2]].forEach(r=>{const a=this.createTripletButton(r);s.appendChild(a)});const i=document.createElement("div");return i.className="triplets-grid triplets-quarter-row",[n[3],n[4],n[5],n[6]].forEach(r=>{const a=this.createTripletButton(r);i.appendChild(a)}),e.appendChild(s),e.appendChild(i),e},createTripletButton(n){const e=document.createElement("button");e.className="triplet-button",e.setAttribute("data-triplet-stamp-id",n.id),e.setAttribute("title",n.label),n.span==="quarter"&&e.classList.add("triplet-button-wide");const i=n.span==="quarter"?80:40,r=Jb(n,i,40);return e.appendChild(r),e},bindEvents(){const n=document.getElementById("triplets-toolbar-container");if(!n)return;n.addEventListener("click",s=>{const i=s.target.closest(".triplet-button");if(i){const r=parseInt(i.getAttribute("data-triplet-stamp-id"));this.selectTripletStamp(r)}}),this.updateTripletColors=s=>{if(!s||!n)return;const i=(f,g=50)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),C=parseInt(f.slice(5,7),16),A=Math.min(255,Math.floor(y+(255-y)*(g/100))),I=Math.min(255,Math.floor(w+(255-w)*(g/100))),E=Math.min(255,Math.floor(C+(255-C)*(g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}`},r=(f,g=20)=>{const y=parseInt(f.slice(1,3),16),w=parseInt(f.slice(3,5),16),C=parseInt(f.slice(5,7),16),A=Math.max(0,Math.floor(y*(1-g/100))),I=Math.max(0,Math.floor(w*(1-g/100))),E=Math.max(0,Math.floor(C*(1-g/100)));return`#${A.toString(16).padStart(2,"0")}${I.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}`},a=u.state.colorPalette[s]||{primary:s,light:s},c=i(a.light,60),h=a.primary,m=r(h,20);n.style.setProperty("--c-accent",h),n.style.setProperty("--c-accent-light",c),n.style.setProperty("--c-accent-hover",m),T.info("TripletsToolbar",`Updated colors for ${s}`,{primary:h,light:c,hover:m},"triplets")},u.on("noteChanged",({newNote:s})=>{s.color&&this.updateTripletColors(s.color)});const e=u.state.selectedNote;e&&e.color&&this.updateTripletColors(e.color),u.on("toolChanged",({newTool:s})=>{s!=="triplet"&&this.clearSelection()}),u.on("stampToolSelected",()=>{this.clearSelection()})},selectTripletStamp(n){this.selectedTripletStampId=n;const e=document.getElementById("triplets-toolbar-container");e&&e.querySelectorAll(".triplet-button").forEach(s=>{s.classList.toggle("active",parseInt(s.getAttribute("data-triplet-stamp-id"))===n)}),u.setSelectedTool("triplet"),u.emit("tripletStampSelected",n),u.emit("tripletToolSelected"),T.info("TripletsToolbar",`Selected triplet stamp ${n} and switched to triplet tool`,{stampId:n},"triplets")},clearSelection(){this.selectedTripletStampId=null;const n=document.getElementById("triplets-toolbar-container");n&&n.querySelectorAll(".triplet-button").forEach(e=>{e.classList.remove("active")})},getSelectedTripletStamp(){return this.selectedTripletStampId?ai(this.selectedTripletStampId):null}};function Vw(n,e,s,i){var g,y;const r=Ha(s.stampId);if(!r)return console.log("[STAMP HIT TEST] No stamp found for stampId:",s.stampId),null;const a=ft(s.startColumn,i),c=Rt(s.row,i)-i.cellHeight/2,h=i.cellWidth*2,m=i.cellHeight;console.log("[STAMP HIT TEST] Testing position:",{mouseX:n,mouseY:e,stampBounds:{x:a,y:c,width:h,height:m},stampId:s.stampId});const f=[.125,.375,.625,.875].map(w=>a+w*h);for(const w of r.diamonds){const C=`diamond_${w}`,A=((g=s.shapeOffsets)==null?void 0:g[C])||0,I=s.row+A,E=Rt(I,i),O=f[w],P=Math.sqrt(Math.pow(n-O,2)+Math.pow(e-E,2)),R=Math.min(h*.2,m*1);if(console.log(`[STAMP HIT TEST] Testing diamond slot ${w}:`,{cx:O,cy:E,distance:P,hitRadius:R,isHit:P<R}),P<R)return console.log("[STAMP HIT TEST]  Hit diamond:",{slot:w,shapeKey:C,rowOffset:A}),{type:"diamond",slot:w,shapeKey:C,cx:O,cy:E,placement:s}}for(const w of r.ovals){const C=`oval_${w}`,A=((y=s.shapeOffsets)==null?void 0:y[C])||0,I=s.row+A,E=Rt(I,i),O=w===0?a+.25*h:a+.75*h,P=Math.sqrt(Math.pow(n-O,2)+Math.pow(e-E,2)),R=Math.min(h*.25,m*1);if(console.log(`[STAMP HIT TEST] Testing oval slot ${w}:`,{cx:O,cy:E,distance:P,hitRadius:R,isHit:P<R}),P<R)return console.log("[STAMP HIT TEST]  Hit oval:",{slot:w,shapeKey:C,rowOffset:A}),{type:"oval",slot:w,shapeKey:C,cx:O,cy:E,placement:s}}return console.log("[STAMP HIT TEST] No shape hit"),null}function om(n,e,s,i){console.log("[STAMP HIT TEST] Testing against",s.length,"stamp placements");for(const r of s){const a=Vw(n,e,r,i);if(a)return a}return null}function Hw(n,e,s,i){var g;const r=ai(s.stampId);if(!r)return console.log("[TRIPLET HIT TEST] No stamp found for stampId:",s.stampId),null;const a=s.startCellIndex*2,c=ft(a,i),h=Rt(s.row,i)-i.cellHeight/2,m=i.cellWidth*2*s.span,f=i.cellHeight;console.log("[TRIPLET HIT TEST] Testing position:",{mouseX:n,mouseY:e,groupBounds:{x:c,y:h,width:m,height:f},stampId:s.stampId});for(const y of r.hits){const w=`triplet_${y}`,C=((g=s.shapeOffsets)==null?void 0:g[w])||0,A=s.row+C,I=Rt(A,i),E=Bp[y],O=c+m*E/100,P=Math.sqrt(Math.pow(n-O,2)+Math.pow(e-I,2)),R=Math.min(m*.15,f*1);if(console.log(`[TRIPLET HIT TEST] Testing slot ${y}:`,{cx:O,cy:I,distance:P,hitRadius:R,isHit:P<R}),P<R)return console.log("[TRIPLET HIT TEST]  Hit triplet notehead:",{slot:y,shapeKey:w,rowOffset:C}),{type:"triplet",slot:y,shapeKey:w,cx:O,cy:I,placement:s}}return console.log("[TRIPLET HIT TEST] No shape hit"),null}function rm(n,e,s,i){console.log("[TRIPLET HIT TEST] Testing against",s.length,"triplet placements");for(const r of s){const a=Hw(n,e,r,i);if(a)return a}return null}let Xt,to=!1,ne=null,Vs=[],Ue=[],_r=!1,Fa=!1,Aa=null,zn=null,ni=[],_s=!1,qn=null,ss=null,xr=!1,ws=null,Sr=!1;function He(n){const e=u.state.fullRowData[n];return e?e.toneNote:null}function Gw(n){const{macrobeatGroupings:e,columnWidths:s,macrobeatBoundaryStyles:i}=u.state;if(n<2||n>=s.length-2)return null;let r=-1;for(let m=0;m<e.length;m++){const{startColumn:f,endColumn:g}=cs(u.state,m);if(n>=f&&n<=g){r=m;break}}if(r===-1)return null;let a=0;for(let m=r-1;m>=0;m--)if(i[m]==="solid"){a=m+1;break}const c=a-1;return{drawColumn:cs(u.state,a).startColumn,preMacrobeatIndex:c}}function am(n,e){const{activeChordIntervals:s,isIntervalsInverted:i,chordPositionState:r}=u.state;if(!n||!s||s.length===0)return[];if(i&&s.length===2&&s[0]==="1P"){const h="-"+s[1],m=ir(n,h),f=or(m),g=f.includes("#")&&bn(f).includes("b")?bn(f):f;return[n,g]}const a=s.map(c=>{const h=ir(n,c),m=or(h);if(m.includes("#")){const f=bn(m);if(f.includes("b"))return f}return m});if(s.length>=3&&r>0){const c=[...a];for(let C=0;C<r;C++){const A=c.shift(),I=ir(A,"8P");c.push(or(I))}const h=c[0],m=n,f=on(h),g=on(m);let y=0,w=f;for(;w>g;)w-=12,y-=12;for(;w+12<=g;)w+=12,y+=12;return c.map(C=>{const A=on(C)+y;return ky(A)})}return a}function Ma(n,e,s){if(!Xt)return;const i={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel},r=ft(n,i),c=Rt(e,u.state)-u.state.cellHeight/2,h=u.state.selectedTool;let m;if(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+1,i)-r:m=u.state.columnWidths[n]*u.state.cellWidth,h==="eraser"||_r)u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2;else if(h==="note"&&u.state.selectedNote&&u.state.selectedNote.shape==="circle")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2;else if(h==="stamp")u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2;else if(h==="triplet"){const f=ja.getSelectedTripletStamp();if(f){const y=2*(f.span==="eighth"?1:2);u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+y,i)-r:m=u.state.cellWidth*y}else m=u.state.cellWidth*2}else h==="tonicization"&&(u.state.modulationMarkers&&u.state.modulationMarkers.length>0?m=ft(n+2,i)-r:m=u.state.cellWidth*2);Xt.fillStyle=s,Xt.fillRect(r,c,m,u.state.cellHeight)}function jw(n,e,s=!1){if(!Xt||!u.state.selectedNote)return;const i=u.state.selectedTool,{shape:r,color:a}=u.state.selectedNote;if(Xt.globalAlpha=s?.2:.4,i==="tonicization"){const c={row:e,columnIndex:n,tonicNumber:u.state.selectedToolTonicNumber},h={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};Dh(Xt,h,c)}else if(i==="note"){const c={row:e,startColumnIndex:n,endColumnIndex:n,color:a,shape:r,isDrum:!1},h={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};r==="oval"?Rh(Xt,h,c,e):Ih(Xt,h,c,e)}Xt.globalAlpha=1}function Uw(n){var f,g,y,w,C,A,I;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=document.getElementById("canvas-container").scrollLeft,a=Gs.getColumnIndex(s+r),c=Gs.getPitchRowIndex(i),m=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(!(a<2||a>=m||!He(c))){if(n.button===2){n.preventDefault(),_r=!0,_s=!1,u.state.selectedTool!=="eraser"&&(Aa=u.state.selectedTool,u.setSelectedTool("eraser")),(f=ri.get("eraserButton"))==null||f.classList.add("erasing-active"),u.eraseInPitchArea(a,c,2,!1)&&(_s=!0),u.eraseTonicSignAt(a,!1)&&(_s=!0);const E=a+2-1,O=c-1,P=c+1;u.eraseStampsInArea(a,E,O,P)&&(_s=!0),u.eraseTripletsInArea(a,E,O,P)&&(_s=!0);const R=n.target.getBoundingClientRect(),q=n.clientX-R.left,G=n.clientY-R.top;Ut.eraseAtPoint(q,G)&&(_s=!0),Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),Ma(a,c,"rgba(220, 53, 69, 0.3)");return}if(n.button===0){const E=s+r;({...u.state});for(const R of u.state.modulationMarkers||[]);const O=u.state.placedNotes.find(R=>!R.isDrum&&R.row===c&&a>=R.startColumnIndex&&a<=R.endColumnIndex);if(O&&u.state.selectedTool==="note"){const R=sn.getStampAtPosition(a,c),q=He(c);if(R&&q){const G=window.staticWaveformVisualizer;G&&(G.currentColor=O.color,G.generateWaveform(),G.startSingleNoteVisualization(O.color)),sn.playRhythmPattern(R.stampId,q,O.color,O.shape,R),Ue=[q],ne=O}else if(q){const G=window.staticWaveformVisualizer;G&&(G.currentColor=O.color,G.generateWaveform(),G.startSingleNoteVisualization(O.color)),Gt.triggerAttack(q,O.color);const U=((g=u.state.fullRowData[c])==null?void 0:g.hex)||"#888888";(y=xs.adsrComponent)==null||y.playheadManager.trigger(O.uuid,"attack",U,u.state.timbres[O.color].adsr),Ue=[q],ne=O}return}const P=u.state.selectedTool;if(P==="chord"){if(!lh(a,u.state))return;const R=He(c);if(!R)return;const q=am(R),{shape:G,color:U}=u.state.selectedNote;Ue=[...q],Ue.forEach(Y=>{Gt.triggerAttack(Y,U)});const j=((w=u.state.fullRowData[c])==null?void 0:w.hex)||"#888888";(C=xs.adsrComponent)==null||C.playheadManager.trigger("chord_preview","attack",j,u.state.timbres[U].adsr),Vs=[],q.forEach(Y=>{const tt=u.state.fullRowData.findIndex(ot=>ot.toneNote===Y);if(tt!==-1){const ot={row:tt,startColumnIndex:a,endColumnIndex:a,color:U,shape:G,isDrum:!1},dt=u.addNote(ot);dt&&(Vs.push(dt),dt.uuid&&u.emit("noteInteractionStart",{noteId:dt.uuid,color:dt.color}))}}),to=!0,qn=c;return}if(P==="tonicization"){if(zn&&ni.length>0){const R=ni.map(q=>({row:q,tonicNumber:u.state.selectedToolTonicNumber,preMacrobeatIndex:zn.preMacrobeatIndex,columnIndex:zn.drawColumn}));u.addTonicSignGroup(R),zn=null,ni=[]}return}if(P==="eraser"){Fa=!0,u.eraseInPitchArea(a,c,2,!1);const R=a+2-1,q=c-1,G=c+1;z0(a,R,q,G),j0(a,R,q,G);return}if(P==="stamp"){const R=u.getAllStampPlacements(),q=s+r,G={...u.state},U=om(q,i,R,G);if(U){console.log("[STAMP INTERACTION]  Hit detected, starting shape drag:",U),ss={...U,startRow:u.getShapeRow(U.placement,U.shapeKey),startMouseY:i},xr=!0,console.log("[STAMP INTERACTION] Drag state initialized:",{shapeKey:ss.shapeKey,startRow:ss.startRow,placementId:ss.placement.id});return}const j=sn.getStampAtPosition(a,c);if(j){console.log("[STAMP INTERACTION] Clicked existing stamp, replaying pattern:",j.stampId);const tt=He(c);if(tt){const ot=u.state.placedNotes.find(yt=>!yt.isDrum&&yt.row===c&&a>=yt.startColumnIndex&&a<=yt.endColumnIndex),dt=ot?ot.shape:"oval";sn.playRhythmPattern(j.stampId,tt,j.color,dt,j),Ue=[tt]}return}const Y=$h.getSelectedStamp();if(Y){console.log("[STAMP INTERACTION] Placing new stamp:",{stampId:Y.id,colIndex:a,rowIndex:c});const{color:tt,shape:ot}=u.state.selectedNote;q0(Y.id,a,c,tt);const dt=He(c);dt&&(sn.playRhythmPattern(Y.id,dt,tt,ot),Ue=[dt]),u.recordState()}return}if(P==="triplet"){const R=u.getAllTripletPlacements(),q=s+r,G={...u.state};console.log("[TRIPLET INTERACTION] Checking for shape hit at:",{actualX:q,y:i,numTriplets:R.length});const U=rm(q,i,R,G);if(U){console.log("[TRIPLET INTERACTION]  Hit detected, starting shape drag:",U),ws={...U,startRow:u.getTripletShapeRow(U.placement,U.shapeKey),startMouseY:i},Sr=!0;return}const j=Math.floor(a/2),Y=sn.getTripletAtPosition(j,c);if(Y){console.log("[TRIPLET INTERACTION] Clicked existing triplet, replaying pattern:",Y.stampId);const ot=He(c);ot&&(sn.playTripletPattern(Y.stampId,ot,Y.color,Y),Ue=[ot]);return}const tt=ja.getSelectedTripletStamp();if(tt&&u.state.selectedNote){console.log("[TRIPLET INTERACTION] Placing new triplet:",{stampId:tt.id,colIndex:a,rowIndex:c});const ot=H0(tt.id,j,c,u.state.selectedNote.color),dt=He(c);dt&&ot&&(sn.playTripletPattern(tt.id,dt,u.state.selectedNote.color,ot),Ue=[dt]),u.recordState()}return}if(P==="modulation"){const R=u.state.selectedModulationRatio;if(!R){console.warn("[MODULATION] No ratio selected - click 2:3 or 3:2 button first");return}const q=cm(E);if(!q){console.warn("[MODULATION] Click must be near a measure boundary");return}console.log("[MODULATION] Placing marker at measure boundary:",{measureIndex:q.measureIndex,ratio:R,clickX:E,boundaryX:q.xPosition});const G=u.addModulationMarker(q.measureIndex,R,q.xPosition,null,q.macrobeatIndex);console.log("[MODULATION] Marker placed successfully:",{markerId:G,measureIndex:q.measureIndex,ratio:R});return}if(P==="note"){if(!lh(a,u.state)||!u.state.selectedNote)return;const{shape:R,color:q}=u.state.selectedNote,G={row:c,startColumnIndex:a,endColumnIndex:a,color:q,shape:R,isDrum:!1},U=u.addNote(G);if(!U)return;ne=U,U.uuid&&u.emit("noteInteractionStart",{noteId:U.uuid,color:U.color}),to=R==="circle",qn=c,to||u.recordState();const j=He(c);if(j){Ue=[j],Gt.triggerAttack(j,ne.color);const Y=((A=u.state.fullRowData[c])==null?void 0:A.hex)||"#888888";(I=xs.adsrComponent)==null||I.playheadManager.trigger(ne.uuid,"attack",Y,u.state.timbres[ne.color].adsr);const tt=window.staticWaveformVisualizer;tt&&(tt.currentColor=ne.color,tt.generateWaveform(),tt.startSingleNoteVisualization(ne.color))}}}}}function Xw(n){var y,w,C,A;const e=n.target.getBoundingClientRect(),s=n.clientX-e.left,i=n.clientY-e.top,r=document.getElementById("canvas-container").scrollLeft,a=Gs.getColumnIndex(s+r),c=Gs.getPitchRowIndex(i);if(!Xt)return;if(Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),xr&&ss){const I=Gs.getPitchRowIndex(i),E=I-ss.placement.row;if(console.log("[STAMP DRAG] Mouse moved, updating shape position:",{mouseY:i,newRow:I,baseRow:ss.placement.row,rowOffset:E,shapeKey:ss.shapeKey}),u.updateStampShapeOffset(ss.placement.id,ss.shapeKey,E),I!==ss.startRow){const O=He(I);if(O){const P=ss.placement.color||((y=u.state.selectedNote)==null?void 0:y.color);Gt.triggerAttack(O,P),setTimeout(()=>Gt.triggerRelease(O,P),100)}ss.startRow=I}n.target.style.cursor="ns-resize";return}if(Sr&&ws){const I=Gs.getPitchRowIndex(i),E=I-ws.placement.row;if(console.log("[TRIPLET DRAG] Mouse moved, updating shape position:",{mouseY:i,newRow:I,baseRow:ws.placement.row,rowOffset:E,shapeKey:ws.shapeKey}),u.updateTripletShapeOffset(ws.placement.id,ws.shapeKey,E),I!==ws.startRow){const O=He(I);if(console.log("[TRIPLET DRAG] Row changed, playing audio:",{oldRow:ws.startRow,newRow:I,pitch:O,hasPitch:!!O}),O){const P=ws.placement.color||((w=u.state.selectedNote)==null?void 0:w.color);console.log("[TRIPLET DRAG] Triggering audio for pitch:",O,"color:",P),Gt.triggerAttack(O,P),setTimeout(()=>Gt.triggerRelease(O,P),100)}ws.startRow=I}n.target.style.cursor="ns-resize";return}const h=u.state.selectedTool;if(h==="stamp"&&!xr){const I=s+r,E=u.getAllStampPlacements(),O={...u.state};om(I,i,E,O)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}if(h==="triplet"&&!Sr){const I=s+r,E=u.getAllTripletPlacements(),O={...u.state};rm(I,i,E,O)?n.target.style.cursor="ns-resize":n.target.style.cursor="default"}const m=s+r;({...u.state});for(const I of u.state.modulationMarkers||[]);if(u.state.selectedTool==="modulation"){const I=cm(m);I&&Zw(Xt,I.xPosition,u.state.selectedModulationRatio)}n.target;const g=(u.state.selectedTool==="note"||u.state.selectedTool==="chord")&&u.state.selectedNote&&u.state.selectedNote.shape==="circle"?u.state.columnWidths.length-3:u.state.columnWidths.length-2;if(a<2||a>=g||He(c)===null){zn=null,ni=[],Gp();return}if(rb(a,c),to&&(ne||Vs.length>0)){const I=a,E=c;if(ne){if(I!==ne.endColumnIndex&&u.updateNoteTail(ne,I),E!==qn&&E!==ne.row){const O=He(E);if(O){const P=He(ne.row);P&&Gt.triggerRelease(P,ne.color),u.updateNoteRow(ne,E),Gt.triggerAttack(O,ne.color),Ue=[O];const R=((C=u.state.fullRowData[E])==null?void 0:C.hex)||"#888888";(A=xs.adsrComponent)==null||A.playheadManager.trigger(ne.uuid,"attack",R,u.state.timbres[ne.color].adsr),qn=E}}}else if(Vs.length>0){const O=Vs.filter(P=>I!==P.endColumnIndex);if(O.length>0&&u.updateMultipleNoteTails(O,I),E!==qn){const P=E-qn;Ue.forEach(G=>{Gt.triggerRelease(G,Vs[0].color)});const R=Vs.map(G=>G.row+P);if(R.every(G=>He(G)!==null)){u.updateMultipleNoteRows(Vs,R);const G=R.map(U=>He(U)).filter(U=>U);G.forEach(U=>{Gt.triggerAttack(U,Vs[0].color)}),Ue=G,qn=E}}}return}if(u.state.selectedTool==="chord"){const I=He(c);if(I){const E=am(I),{shape:O,color:P}=u.state.selectedNote;Xt.globalAlpha=.4,E.forEach(R=>{const q=u.state.fullRowData.findIndex(G=>G.toneNote===R);if(q>-1){const G={row:q,startColumnIndex:a,endColumnIndex:a,color:P,shape:O,isDrum:!1},U={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};O==="oval"?Rh(Xt,U,G,q):Ih(Xt,U,G,q)}}),Xt.globalAlpha=1}return}if(_r){u.eraseInPitchArea(a,c,2,!1)&&(_s=!0),u.eraseTonicSignAt(a,!1)&&(_s=!0);const I=a+2-1,E=c-1,O=c+1;u.eraseStampsInArea(a,I,E,O)&&(_s=!0),u.eraseTripletsInArea(a,I,E,O)&&(_s=!0);const P=n.target.getBoundingClientRect(),R=n.clientX-P.left,q=n.clientY-P.top;Ut.eraseAtPoint(R,q)&&(_s=!0),Ma(a,c,"rgba(220, 53, 69, 0.3)");return}if(Fa){u.eraseInPitchArea(a,c,2,!1);const I=a+2-1,E=c-1,O=c+1;u.eraseStampsInArea(a,I,E,O),u.eraseTripletsInArea(a,I,E,O),Ma(a,c,"rgba(220, 53, 69, 0.3)");return}if(u.state.selectedTool==="tonicization"){const I=Gw(a);if(I){const E=He(c);if(E){const O=u.state.fullRowData.map((R,q)=>({...R,index:q})).filter(R=>R.toneNote&&R.toneNote.replace(/\d+$/,"")===E.replace(/\d+$/,"")).map(R=>R.index);zn=I,ni=O,Xt.globalAlpha=.5;const P={...u.state,zoomLevel:xt.getViewportInfo().zoomLevel};O.forEach(R=>{const q={row:R,columnIndex:I.drawColumn,tonicNumber:u.state.selectedToolTonicNumber};Dh(Xt,P,q)}),Xt.globalAlpha=1}}else zn=null,ni=[]}else{const I=u.state.selectedTool==="note"||u.state.selectedTool==="chord"?lh(a,u.state):!0,E=u.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":I?"rgba(74, 144, 226, 0.2)":"rgba(220, 53, 69, 0.15)";if(Ma(a,c,E),u.state.selectedTool==="stamp"){const P=$h.getSelectedStamp();if(P){const R={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};Zb(Xt,a,c,P,R)}}else if(u.state.selectedTool==="triplet"){const P=ja.getSelectedTripletStamp();if(P){const R=Math.floor(a/2),q={cellWidth:u.state.cellWidth,cellHeight:u.state.cellHeight,columnWidths:u.state.columnWidths,previewColor:"#4a90e2"};sw(Xt,R,c,P,q)}}else I&&jw(a,c)}}function lm(){Xt&&Xt.clearRect(0,0,Xt.canvas.width,Xt.canvas.height),zn=null,ni=[],Gp()}function Yw(){var n,e,s,i,r;if(xr&&ss){console.log("[STAMP DRAG] Drag ended, saving state for undo/redo"),xr=!1,ss=null,u.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(Sr&&ws){console.log("[TRIPLET DRAG] Drag ended, saving state for undo/redo"),Sr=!1,ws=null,u.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(Ue.length>0){sn.stopCurrentPattern();const a=(n=u.state.selectedNote)==null?void 0:n.color;if(a&&Ue.forEach(m=>{Gt.triggerRelease(m,a)}),!!ne){const m=((e=u.state.fullRowData[ne.row])==null?void 0:e.hex)||"#888888";(s=xs.adsrComponent)==null||s.playheadManager.trigger(ne.uuid,"release",m,u.state.timbres[a].adsr)}else{const m=Ue[0],f=u.state.fullRowData.find(g=>g.toneNote===m);if(f){const g=f.hex;(i=xs.adsrComponent)==null||i.playheadManager.trigger("chord_preview","release",g,u.state.timbres[a].adsr)}}Ue=[];const h=window.staticWaveformVisualizer;h&&h.stopLiveVisualization()}to&&u.recordState(),to=!1,qn=null,ne&&ne.uuid&&u.emit("noteInteractionEnd",{noteId:ne.uuid}),Vs.forEach(a=>{a.uuid&&u.emit("noteInteractionEnd",{noteId:a.uuid})}),ne=null,Vs=[],Fa&&(u.recordState(),Fa=!1),_r&&(_s&&u.recordState(),_r=!1,_s=!1,Aa&&(u.setSelectedTool(Aa),Aa=null),(r=ri.get("eraserButton"))==null||r.classList.remove("erasing-active")),lm()}function cm(n,e){const{macrobeatGroupings:s,macrobeatBoundaryStyles:i}=u.state;an(u.state);const r=100,a=[],c=u.state.modulationMarkers&&u.state.modulationMarkers.length>0;console.log("[MODULATION] Boundary calculation - has modulation:",c);for(let g=0;g<i.length;g++)if(i[g]==="solid"){const y=cs(u.state,g);if(y){const w=c?ft(y.endColumn+1,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):xt.getColumnX(y.endColumn+1);console.log(`[MODULATION] Boundary ${g}: measureInfo.endColumn=${y.endColumn}, calculatedX=${w}, method=${c?"modulated":"base"}`),a.push({measureIndex:g+1,xPosition:w,macrobeatIndex:g})}}const h=c?ft(2,{...u.state,modulationMarkers:u.state.modulationMarkers,cellWidth:u.state.cellWidth,columnWidths:u.state.columnWidths,baseMicrobeatPx:u.state.cellWidth}):xt.getColumnX(2);console.log("[MODULATION] Start boundary: calculatedX=",h,", method=",c?"modulated":"base"),a.unshift({measureIndex:0,xPosition:h,macrobeatIndex:-1}),console.log("[MODULATION] Available measure boundaries:",a),console.log("[MODULATION] Click position:",n,"tolerance:",r);let m=null,f=1/0;return a.forEach(g=>{const y=Math.abs(n-g.xPosition);console.log(`[MODULATION] Boundary at x=${g.xPosition}, distance=${y}`),y<=r&&y<f&&(f=y,m=g)}),m?console.log("[MODULATION] Found closest boundary:",m,"distance:",f):console.log("[MODULATION] No boundary within tolerance"),m}function Zw(n,e,s){if(!s)return;const i=Pp(s),r=Ep(s);n.save();const a=3,c=2,h=n.canvas.height;n.strokeStyle=i,n.lineWidth=c,n.globalAlpha=.7,n.setLineDash([]);for(let m=-1;m<=1;m++){const f=e+m*a;n.beginPath(),n.moveTo(f,0),n.lineTo(f,h),n.stroke()}n.globalAlpha=.8,n.font="12px Arial, sans-serif",n.textAlign="center",n.textBaseline="top",n.fillStyle=i,n.fillText(`Preview: ${r}`,e,10),n.restore()}function Qw(){const n=document.getElementById("notation-grid"),e=document.getElementById("hover-canvas");if(!n||!e){console.error("PitchGridInteractor: Could not find required canvas elements.");return}Xt=e.getContext("2d"),n.addEventListener("mousedown",Uw),n.addEventListener("mousemove",Xw),n.addEventListener("mouseleave",lm),n.addEventListener("contextmenu",s=>s.preventDefault()),window.addEventListener("mouseup",Yw)}const Bc={init(){Qw(),zw(),document.addEventListener("canvasResized",n=>{this.renderPitchGrid(),this.renderDrumGrid()}),gr(async()=>{const{default:n}=await Promise.resolve().then(()=>g0);return{default:n}},void 0).then(({default:n})=>{n.on("animationUpdate",e=>{e.type==="vibrato"&&e.activeColors&&e.activeColors.length>0?this.renderPitchGrid():e.type==="envelopeFill"||e.hasEnvelopeFills?this.renderPitchGrid():e.type==="combined"&&e.vibratoColors&&e.vibratoColors.length>0&&this.renderPitchGrid()})})},renderPitchGrid:Yi.render,renderDrumGrid:Ps.render},qs={};function Jw(){return qs.container=document.querySelector("#adsr-envelope"),qs.parentContainer=qs.container.closest(".adsr-container"),qs.sustainTrack=document.getElementById("sustain-slider-track"),qs.sustainThumb=document.getElementById("sustain-slider-thumb"),qs.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),qs.thumbA=document.getElementById("thumb-a"),qs.thumbD=document.getElementById("thumb-d"),qs.thumbR=document.getElementById("thumb-r"),qs}const Kw={init:Jw,get elements(){return qs}};function hm(){return dm*u.state.adsrTimeAxisScale}function um(n,e){const{sustain:s}=u.state.timbres[e.currentColor].adsr,i=.01;n.d=Math.max(n.a+i,n.d),n.r=Math.max(n.d+i,n.r);const r=n.a,a=n.d-n.a,c=n.r-n.d;if(isNaN(r)||isNaN(a)||isNaN(c)){console.error("NaN value detected before setting ADSR. Aborting update.",{newAttack:r,newDecay:a,newRelease:c});return}u.setADSR(e.currentColor,{attack:r,decay:a,release:c,sustain:s})}function t_(n,e){let s=!1;const i=c=>{var C;if(!s)return;const h=n.sustainTrack.getBoundingClientRect();let f=100-(c.clientY-h.top)/h.height*100;f=Math.max(0,Math.min(100,f));const y=(((C=window.staticWaveformVisualizer)==null?void 0:C.getNormalizedAmplitude())||1)*100;f=Math.min(f,y);const w=u.state.timbres[e.currentColor];u.setADSR(e.currentColor,{...w.adsr,sustain:f/100})},r=c=>{s=!0,i(c)},a=()=>{s=!1};n.sustainTrack.addEventListener("pointerdown",r),document.addEventListener("pointermove",i),document.addEventListener("pointerup",a)}function e_(n,e){let s=null;const i=c=>{if(!s)return;const h=n.multiSliderContainer.getBoundingClientRect();let f=(c.clientX-h.left)/h.width*100;f=Math.max(0,Math.min(100,f));const g=f/100*hm(),{attack:y,decay:w,release:C}=u.state.timbres[e.currentColor].adsr,A={a:y,d:y+w,r:y+w+C};s.id==="thumb-a"&&(A.a=g),s.id==="thumb-d"&&(A.d=g),s.id==="thumb-r"&&(A.r=g),um(A,e)},r=c=>{c.target.classList.contains("time-slider-thumb")&&(s=c.target,i(c))},a=()=>{s=null};n.multiSliderContainer.addEventListener("pointerdown",r),document.addEventListener("pointermove",i),document.addEventListener("pointerup",a)}function s_(n,e){let s=null;const i=c=>{var q;if(!s)return;const h=e.svgContainer,m=h.createSVGPoint();m.x=c.clientX,m.y=c.clientY;const f=m.matrixTransform(h.getScreenCTM().inverse());let g=f.x/e.width*100,y=1-f.y/e.height;g=Math.max(0,Math.min(100,g)),y=Math.max(0,Math.min(1,y));const w=g/100*hm(),C=u.state.timbres[e.currentColor];let{attack:A,decay:I,release:E,sustain:O}=C.adsr;const P={a:A,d:A+I,r:A+I+E};switch(s.id){case"attack-node":P.a=w;break;case"decay-sustain-node":P.d=w;const G=((q=window.staticWaveformVisualizer)==null?void 0:q.getNormalizedAmplitude())||1;O=Math.min(y,G);break;case"release-node":P.r=w;break}const R=u.state.timbres[e.currentColor].adsr.sustain;O!==R&&u.setADSR(e.currentColor,{attack:A,decay:I,release:E,sustain:O}),um(P,e)},r=c=>{c.target.classList.contains("adsr-node")&&(s=c.target,s.style.cursor="grabbing",i(c))},a=()=>{s&&(s.style.cursor="grab",s=null)};e.nodeLayer.addEventListener("pointerdown",r),document.addEventListener("pointermove",i),document.addEventListener("pointerup",a)}function n_(n){const e=n.ui;t_(e,n),e_(e,n),s_(e,n)}function i_(n,{width:e,height:s},i){for(;n.firstChild;)n.removeChild(n.firstChild);if(i>0){for(let h=1;h<=5;h++)if(h<=i){const m=h/i*e,f=document.createElementNS("http://www.w3.org/2000/svg","text");f.setAttribute("x",m),f.setAttribute("y",s-5),f.setAttribute("fill","#d0d0d0"),f.setAttribute("font-size","24"),f.setAttribute("font-weight","bold"),f.setAttribute("text-anchor","middle"),f.setAttribute("dominant-baseline","auto"),f.setAttribute("opacity","0.3"),f.textContent=`${h}s`,n.appendChild(f)}}const r=u.state.tempo;if(r<=0||i<=0)return;const a=30/r;let c=0;for(let h=a;h<i;h+=a){const m=h/i*e,f=document.createElementNS("http://www.w3.org/2000/svg","line");f.setAttribute("x1",m),f.setAttribute("y1",0),f.setAttribute("x2",m),f.setAttribute("y2",s);const g=(c+1)%2===0;f.setAttribute("stroke",g?"#adb5bd":"#ced4da"),f.setAttribute("stroke-width",g?"1":"0.5"),f.setAttribute("stroke-dasharray","3,3"),n.appendChild(f),c++}}function o_(n,e,s,{height:i,width:r},a,c,h){for(;n.firstChild;)n.removeChild(n.firstChild);for(;e.firstChild;)e.removeChild(e.firstChild);if(s.length===0)return;const m=u.state.colorPalette[a]||{primary:a,light:a},f=m.primary,g=m.light;let y={time:0,feedback:0},w={decay:0,roomSize:0};window.effectsCoordinator&&(y=window.effectsCoordinator.getEffectParameters(a,"delay"),w=window.effectsCoordinator.getEffectParameters(a,"reverb")),h&&h.clearRect(0,0,r,i);const C=(U,j=1)=>{if(!h||w.decay===0||w.roomSize===0||!c)return;const Y=w.decay/100*5*(r/c),tt=w.roomSize/100*j;h.filter="blur(30px)";const ot=parseInt(g.slice(1,3),16),dt=parseInt(g.slice(3,5),16),yt=parseInt(g.slice(5,7),16),Tt=60;for(let me=0;me<Tt;me++){const Wt=me/Tt,Qt=(me+1)/Tt,it=U[1].y+(U[3].y-U[1].y)*Wt,ht=U[1].y+(U[3].y-U[1].y)*Qt,ut=U[1].x+(U[3].x-U[1].x)*Wt,Ct=U[1].x+(U[3].x-U[1].x)*Qt,pt=h.createLinearGradient(ut,it,ut+Y,it);pt.addColorStop(0,`rgba(${ot}, ${dt}, ${yt}, ${tt})`),pt.addColorStop(1,`rgba(${ot}, ${dt}, ${yt}, 0)`),h.fillStyle=pt,h.beginPath(),h.moveTo(ut,it),h.lineTo(ut+Y,it),h.lineTo(Ct+Y,ht),h.lineTo(Ct,ht),h.closePath(),h.fill()}h.filter="none"};if(C(s,1),y.time>0&&y.feedback>0&&c){const U=Math.max(.01,y.time/100*.5),j=Math.min(.95,y.feedback/100),Y=.05;let tt=j,ot=0;for(;tt>Y&&ot<10;){ot++;const dt=U*ot/c*r,yt=s.map(Tt=>({x:Tt.x+dt,y:Tt.y}));if(yt[0].x<r){C(yt,tt);const Tt=document.createElementNS("http://www.w3.org/2000/svg","polygon"),me=`${yt[0].x},${i} `+yt.map(Qt=>`${Qt.x},${Qt.y}`).join(" ")+` ${Math.min(yt[3].x,r)},${i}`;Tt.setAttribute("points",me),Tt.setAttribute("fill",Hs(g,.7*tt)),Tt.setAttribute("class","delay-echo"),n.appendChild(Tt);const Wt=document.createElementNS("http://www.w3.org/2000/svg","polyline");Wt.setAttribute("points",yt.map(Qt=>`${Qt.x},${Qt.y}`).join(" ")),Wt.setAttribute("stroke-width",2),Wt.setAttribute("fill","none"),Wt.setAttribute("stroke",Hs(f,tt)),Wt.setAttribute("class","delay-echo"),n.appendChild(Wt)}tt*=j}}const A=document.createElementNS("http://www.w3.org/2000/svg","polygon"),I=`0,${i} `+s.map(U=>`${U.x},${U.y}`).join(" ")+` ${r},${i}`;A.setAttribute("points",I),A.setAttribute("fill",Hs(g,.7)),n.appendChild(A);const E=document.createElementNS("http://www.w3.org/2000/svg","line");E.setAttribute("x1",s[0].x),E.setAttribute("y1",s[0].y),E.setAttribute("x2",s[1].x),E.setAttribute("y2",s[1].y),E.setAttribute("stroke",f),E.setAttribute("stroke-width",2),n.appendChild(E);const O=document.createElementNS("http://www.w3.org/2000/svg","line");O.setAttribute("x1",s[1].x),O.setAttribute("y1",s[1].y),O.setAttribute("x2",s[2].x),O.setAttribute("y2",s[2].y),O.setAttribute("stroke",f),O.setAttribute("stroke-width",2),n.appendChild(O);const P=w.decay>0&&w.roomSize>0?Math.max(.3,1-w.decay/100*(w.roomSize/100)*.7):1,R=document.createElementNS("http://www.w3.org/2000/svg","line");R.setAttribute("x1",s[2].x),R.setAttribute("y1",s[2].y),R.setAttribute("x2",s[3].x),R.setAttribute("y2",s[3].y),R.setAttribute("stroke",Hs(f,P)),R.setAttribute("stroke-width",2),n.appendChild(R);const q=["attack-node","decay-sustain-node","release-node"];[s[1],s[2],s[3]].forEach((U,j)=>{const Y=document.createElementNS("http://www.w3.org/2000/svg","circle");Y.setAttribute("id",q[j]),Y.setAttribute("class","adsr-node"),Y.setAttribute("cx",U.x),Y.setAttribute("cy",U.y),Y.setAttribute("r",8),Y.setAttribute("fill",f),Y.setAttribute("stroke",Va(f,-.3)),Y.setAttribute("stroke-width",2),Y.style.cursor="grab";const tt=document.createElementNS("http://www.w3.org/2000/svg","title");Y.appendChild(tt),e.appendChild(Y)})}function r_(n,e){const s=Va(e,-.2);n.style.setProperty("--c-accent",e),n.style.setProperty("--c-accent-hover",s)}const Se={};let _n=null,li=!1;function a_(n,e){const s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("data-playhead-id",n);const i=document.createElementNS("http://www.w3.org/2000/svg","line");i.setAttribute("stroke",e),i.setAttribute("stroke-width",2),i.setAttribute("stroke-dasharray","3,3"),s.appendChild(i);const r=document.createElementNS("http://www.w3.org/2000/svg","circle");return r.setAttribute("r",5),r.setAttribute("fill",e),s.appendChild(r),s}function l_(n,e,s,i=null){if(!(!_n||!i)){if(e==="attack"){Se[n]&&(cancelAnimationFrame(Se[n].requestId),Se[n].group.remove());const r=a_(n,s);_n.playheadLayer.appendChild(r),Se[n]={group:r,phase:e,color:s,adsr:i,requestId:null,startTimestamp:J.now(),elapsed:0},qh(n)}else if(e==="release"){if(li)return;const r=Se[n];if(!r)return;cancelAnimationFrame(r.requestId),r.phase="release",r.adsr=i,r.startTimestamp=J.now(),r.elapsed=0,Wh(n)}}}function qh(n){if(!Se[n]||li)return;const e=Se[n];if(!e.adsr)return;const{attack:s,decay:i}=e.adsr,r=_n.calculateEnvelopePoints(e.adsr);if(r.length<4)return;const[a,c,h]=r,m=J.now()-e.startTimestamp;e.elapsed=m;const f=s+i,g=Math.min(m,f);let y,w;if(g<=s){const I=s>0?g/s:1;y=a.x+I*(c.x-a.x),w=a.y+I*(c.y-a.y)}else{const I=g-s,E=i>0?I/i:1;y=c.x+E*(h.x-c.x),w=c.y+E*(h.y-c.y)}const[C,A]=e.group.children;C.setAttribute("x1",y),C.setAttribute("y1",0),C.setAttribute("x2",y),C.setAttribute("y2",_n.height),A.setAttribute("cx",y),A.setAttribute("cy",w),g<f?e.requestId=requestAnimationFrame(()=>qh(n)):(e.phase="sustain",zh(n))}function zh(n){if(!Se[n]||li)return;const e=Se[n];if(!e.adsr)return;const s=_n.calculateEnvelopePoints(e.adsr);if(s.length<4)return;const[,,i]=s,[r,a]=e.group.children;r.setAttribute("x1",i.x),r.setAttribute("y1",0),r.setAttribute("x2",i.x),r.setAttribute("y2",_n.height),a.setAttribute("cx",i.x),a.setAttribute("cy",i.y),e.requestId=requestAnimationFrame(()=>zh(n))}function Wh(n){if(!Se[n]||li)return;const e=Se[n];if(!e.adsr)return;const{release:s}=e.adsr,i=_n.calculateEnvelopePoints(e.adsr);if(i.length<4)return;const[,,r,a]=i,c=J.now()-e.startTimestamp;e.elapsed=c;const h=Math.min(c,s),m=s>0?h/s:1,f=r.x+m*(a.x-r.x),g=r.y+m*(a.y-r.y),[y,w]=e.group.children;y.setAttribute("x1",f),y.setAttribute("y1",0),y.setAttribute("x2",f),y.setAttribute("y2",_n.height),w.setAttribute("cx",f),w.setAttribute("cy",g),h<s?e.requestId=requestAnimationFrame(()=>Wh(n)):(e.group.remove(),delete Se[n])}function c_(){li=!0;for(const n in Se){const e=Se[n];e.requestId&&(cancelAnimationFrame(e.requestId),e.requestId=null)}}function h_(){li=!1;for(const n in Se){const e=Se[n];e.startTimestamp=J.now()-e.elapsed,e.phase==="attack"?qh(n):e.phase==="sustain"?zh(n):e.phase==="release"&&Wh(n)}}function u_(){li=!1;for(const n in Se){const e=Se[n];cancelAnimationFrame(e.requestId),e.group.remove()}for(const n in Se)delete Se[n]}function d_(n){return _n=n,{trigger:l_,pause:c_,resume:h_,clearAll:u_}}const dm=2.5;class p_{constructor(){var e;this.ui=Kw.init(),this.currentColor=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=d_(this),xs.adsrComponent=this,n_(this),this.listenForStoreChanges(),this.initControls(),this.ui.container&&new ResizeObserver(()=>this.resize()).observe(this.ui.container),this.updateFromStore(),this.updateComponentWidth(u.state.adsrComponentWidth),T.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const e=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*e,this.reverbCanvas.height=this.height*e,this.reverbCtx.scale(e,e)}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const e=u.state.timbres[this.currentColor];e&&({attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release}=e.adsr,this.render(),this.updateControls())}getCurrentMaxTime(){return dm*u.state.adsrTimeAxisScale}updateComponentWidth(e){if(this.ui.parentContainer){const i=.5+u.state.adsrTimeAxisScale*.2,r=e*i;this.ui.parentContainer.style.setProperty("width",`${r}%`,"important"),this.resize()}}updateTimeScaleWidth(){const e=u.state.adsrComponentWidth;this.updateComponentWidth(e)}initControls(){const e=document.getElementById("adsr-time-scale"),s=document.getElementById("adsr-time-scale-value");e&&s&&(e.value=u.state.adsrTimeAxisScale,s.textContent=`${u.state.adsrTimeAxisScale}x`,e.addEventListener("input",a=>{const c=parseFloat(a.target.value);u.setAdsrTimeAxisScale(c),s.textContent=`${c}x`}));const i=document.getElementById("adsr-width-scale"),r=document.getElementById("adsr-width-scale-value");i&&r&&(i.value=u.state.adsrComponentWidth,r.textContent=`${u.state.adsrComponentWidth}%`,i.addEventListener("input",a=>{const c=parseInt(a.target.value);u.setAdsrComponentWidth(c),r.textContent=`${c}%`}))}listenForStoreChanges(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.updateFromStore())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.updateFromStore()}),u.on("tempoChanged",()=>this.render()),u.on("adsrTimeAxisScaleChanged",e=>{this.render(),this.updateSliders(),this.updateTimeScaleWidth()}),u.on("adsrComponentWidthChanged",e=>{this.updateComponentWidth(e)}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{e&&e.includes(this.currentColor)&&this.render()}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e?s?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),u.on("audioEffectChanged",({effectType:e,color:s})=>{s===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(e=this){var A;const{attack:s,decay:i,sustain:r,release:a}=e;if(!this.width||!this.height)return[];const c=I=>I/this.getCurrentMaxTime()*this.width;let h=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(h=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const m=((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)??1,f=m*h;console.log("[ADSR] Amplitude calculation:",{originalAmplitude:m,tremoloMultiplier:h,normalizedAmplitude:f});const g={x:0,y:this.height},y={x:c(s),y:this.height*(1-f)},w={x:c(s+i),y:this.height*(1-Math.min(r*f,f))},C={x:c(s+i+a),y:this.height};return[g,y,w,C]}render(){if(!this.ui||!this.width||!this.height)return;const e={width:this.width,height:this.height},s=this.calculateEnvelopePoints(),i=this.getCurrentMaxTime();i_(this.gridLayer,e,i),o_(this.envelopeLayer,this.nodeLayer,s,e,this.currentColor,i,this.reverbCtx),r_(this.ui.parentContainer,this.currentColor)}updateControls(){var I;if(!this.ui.sustainThumb)return;let e=1;window.animationEffectsManager&&window.animationEffectsManager.shouldTremoloBeRunning()&&(e=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor));const i=(((I=window.staticWaveformVisualizer)==null?void 0:I.calculatedAmplitude)||1)*e,r=i*100;if(this.sustain>i){const E=u.state.timbres[this.currentColor];u.setADSR(this.currentColor,{...E.adsr,sustain:i}),this.sustain=i}const a=this.sustain*100;this.ui.sustainThumb.style.bottom=`${a}%`,this.ui.sustainTrack.style.setProperty("--sustain-progress",`${a}%`);const c=100-r;this.ui.sustainTrack.style.setProperty("--ineligible-height",`${c}%`);const h=this.attack/this.getCurrentMaxTime()*100,m=(this.attack+this.decay)/this.getCurrentMaxTime()*100,f=(this.attack+this.decay+this.release)/this.getCurrentMaxTime()*100;this.ui.thumbA.style.left=`${h}%`,this.ui.thumbD.style.left=`${m}%`,this.ui.thumbR.style.left=`${f}%`,this.ui.multiSliderContainer.style.setProperty("--adr-progress",`${f}%`);const g=E=>`${E.toFixed(3)}s`,y=E=>`${(E*100).toFixed(0)}%`;this.ui.thumbA.title=`Attack: ${g(this.attack)}`,this.ui.thumbD.title=`Decay: ${g(this.decay)}`,this.ui.thumbR.title=`Release: ${g(this.release)}`,this.ui.sustainThumb.title=`Sustain: ${y(this.sustain)}`;const w=this.nodeLayer.querySelector("#attack-node > title");w&&(w.textContent=`Attack: ${g(this.attack)}`);const C=this.nodeLayer.querySelector("#decay-sustain-node > title");C&&(C.textContent=`Decay: ${g(this.decay)}
Sustain: ${y(this.sustain)}`);const A=this.nodeLayer.querySelector("#release-node > title");A&&(A.textContent=`Release: ${g(this.release)}`)}}function m_(){return document.getElementById("adsr-envelope")?new p_:null}let Zi,eo,Wn,so,Ws,Qi,si,dh=!1,ph=!1,mh=!1,js;const Ba=1,pm=31,mm=0,$a=2;function $c(){if(!js)return;const n=u.state.timbres[js];if(!n)return;n.filter?n.filter.enabled===void 0&&(n.filter.enabled=!0):n.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0};const{cutoff:e,blend:s,mix:i}=n.filter;if(Zi&&eo){const r=($a-s)/($a-mm);Zi.style.left=`${r*100}%`,eo.style.setProperty("--progress",`${r*100}%`)}if(Qi&&si){const r=(i||0)/100;Qi.style.bottom=`${r*100}%`,si.style.setProperty("--blend-progress",`${r*100}%`)}if(Wn&&so){const r=(e-Ba)/(pm-Ba);Wn.style.left=`${r*100}%`,Wn.style.top="50%",Wn.style.transform="translate(-50%, -50%)",so.style.setProperty("--progress",`${r*100}%`)}Ws&&Ws.style.setProperty("--c-accent",js)}function f_(n){if(!dh)return;const e=so.getBoundingClientRect(),s=n.clientX-e.left,i=e.width;let r=s/i;r=Math.max(0,Math.min(1,r));const a=r*(pm-Ba)+Ba;u.setFilterSettings(js,{cutoff:a})}function g_(n){if(!ph)return;const e=eo.getBoundingClientRect(),s=n.clientX-e.left,i=e.width;let r=s/i;r=Math.max(0,Math.min(1,r));const a=$a-r*($a-mm);u.setFilterSettings(js,{blend:a})}function v_(n){if(!mh)return;const e=si.getBoundingClientRect(),s=n.clientY-e.top,i=e.height;let r=1-s/i;r=Math.max(0,Math.min(1,r));const a=r*100;u.setFilterSettings(js,{mix:a})}function y_(){var e;if(Ws=document.querySelector(".filter-container"),Zi=document.getElementById("thumb-b"),eo=document.getElementById("blend-slider-container"),Wn=document.getElementById("thumb-c"),so=document.getElementById("cutoff-slider-container"),!Ws||!Zi||!Wn){console.error("[FILTER CONTROLS] Missing required elements",{container:Ws,blendThumb:Zi,cutoffThumb:Wn});return}const n=Ws==null?void 0:Ws.querySelector(".blend-slider-container");n&&eo&&(n.getBoundingClientRect(),eo.getBoundingClientRect()),so&&so.getBoundingClientRect(),b_(),Zi.addEventListener("pointerdown",s=>{console.log("[BLEND SLIDER] Pointerdown on blend thumb"),s.preventDefault(),ph=!0,document.body.style.cursor="ew-resize";const i=a=>{console.log("[BLEND SLIDER] Moving",{clientX:a.clientX}),g_(a)},r=()=>{console.log("[BLEND SLIDER] Pointerup"),ph=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",i),window.removeEventListener("pointerup",r),u.recordState()};window.addEventListener("pointermove",i),window.addEventListener("pointerup",r)}),Wn.addEventListener("pointerdown",s=>{console.log("[CUTOFF SLIDER] Pointerdown on cutoff thumb"),s.preventDefault(),dh=!0,document.body.style.cursor="ew-resize";const i=a=>{console.log("[CUTOFF SLIDER] Moving",{clientX:a.clientX}),f_(a)},r=()=>{console.log("[CUTOFF SLIDER] Pointerup"),dh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",i),window.removeEventListener("pointerup",r),u.recordState()};window.addEventListener("pointermove",i),window.addEventListener("pointerup",r)}),u.on("noteChanged",({newNote:s})=>{s.color&&s.color!==js&&(js=s.color,$c())}),u.on("timbreChanged",s=>{s===js&&$c()}),js=((e=u.state.selectedNote)==null?void 0:e.color)||"#4a90e2",$c(),setTimeout(()=>{const s=Ws==null?void 0:Ws.querySelector(".blend-slider-container");s&&s.getBoundingClientRect()},100)}function b_(){if(si=document.getElementById("vertical-blend-track"),Qi=document.getElementById("vertical-blend-thumb"),!si||!Qi){console.error("[FILTER CONTROLS] Vertical blend slider elements not found");return}Qi.addEventListener("pointerdown",n=>{console.log("[VERTICAL BLEND] Pointerdown on M thumb"),n.preventDefault(),mh=!0,document.body.style.cursor="ns-resize";const e=i=>{console.log("[VERTICAL BLEND] Moving",{clientY:i.clientY}),v_(i)},s=()=>{console.log("[VERTICAL BLEND] Pointerup"),mh=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",s),u.recordState()};window.addEventListener("pointermove",e),window.addEventListener("pointerup",s)}),si.addEventListener("click",n=>{if(n.target===Qi)return;const e=si.getBoundingClientRect(),s=n.clientY-e.top,i=e.height;let r=1-s/i;r=Math.max(0,Math.min(1,r));const a=r*100;u.setFilterSettings(js,{mix:a}),u.recordState()})}function w_(n,e,s){if(!(e.length<2)){n.globalAlpha=s.opacity;for(let i=1;i<e.length;i++){const r=e[i-1],a=e[i];if(a.timestamp-r.timestamp>200)continue;const c=n.createLinearGradient(r.x,r.y,a.x,a.y);c.addColorStop(0,`rgb(${r.color.join(",")})`),c.addColorStop(1,`rgb(${a.color.join(",")})`),n.strokeStyle=c,n.lineWidth=(r.thickness+a.thickness)/2,n.lineCap="round",n.lineJoin="round",n.beginPath(),n.moveTo(r.x,r.y),n.lineTo(a.x,a.y),n.stroke()}n.globalAlpha=1}}function __(n,e){const s=u.state,i=an(u.state),r=s.fullRowData.slice(n.topRow,n.bottomRow+1);let a=s.placedNotes.filter(G=>!G.isDrum&&G.row>=n.topRow&&G.row<=n.bottomRow).map(G=>({...G,row:G.row-n.topRow})),c=n.includeDrums?s.placedNotes.filter(G=>G.isDrum):[];if(n.colorMode==="bw"){const G=U=>U.map(j=>({...j,color:"#212529"}));a=G(a),c=G(c)}const h=s.columnWidths.reduce((G,U)=>G+U,0),m=50,f=m*2,g=f/2,y=h*m,w=r.length*g,C=n.includeDrums?3*.5*f:0,A=C>0?30:0,I=w+A+C,E=Math.min(e.width/y,e.height/I),O=document.createElement("canvas");O.width=y*E,O.height=I*E;const P=O.getContext("2d");P.scale(E,E),P.fillStyle="#FFF",P.fillRect(0,0,y,I);const R={placedNotes:a,placedTonicSigns:i,fullRowData:r,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles,colorMode:n.colorMode,degreeDisplayMode:"off"},q=document.createElement("canvas");if(q.width=y,q.height=w,tm(q.getContext("2d"),R),P.drawImage(q,0,0),s.paint&&s.paint.paintHistory.length>0){console.log(`[PrintService] Found ${s.paint.paintHistory.length} paint points to print.`);const G=document.createElement("canvas");G.width=y,G.height=w;const U=G.getContext("2d"),j=document.getElementById("notation-grid"),Y=y/j.width,tt=w/(j.height*(r.length/s.fullRowData.length)),ot=n.topRow*g,dt=s.paint.paintHistory.map(yt=>({...yt,x:yt.x*Y,y:yt.y*tt-ot,thickness:yt.thickness*Math.min(Y,tt)}));w_(U,dt,{opacity:s.paint.paintSettings.opacity/100}),P.drawImage(G,0,0),console.log("[PrintService] Paint trail has been rendered for printing.")}if(n.includeDrums){const G={placedNotes:c,placedTonicSigns:i,columnWidths:s.columnWidths,cellWidth:m,cellHeight:f,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles},U=document.createElement("canvas");U.width=y,U.height=C,nm(U.getContext("2d"),G),P.drawImage(U,0,w+A)}return O}const Xd={generateScoreCanvas:__,generateAndPrint(){const n=u.state.printOptions,e=300,s=(n.orientation==="landscape"?10.5:8)*e,i=(n.orientation==="landscape"?8:10.5)*e,r=this.generateScoreCanvas(n,{width:s,height:i}),a=document.getElementById("print-staging-area");a.innerHTML="";const c=document.getElementById("print-style-rules");c.textContent=`@page { size: ${n.orientation}; margin: 0.25in; }`;const h=document.createElement("img");h.src=r.toDataURL("image/png"),h.style.width="100%",h.style.height="auto",a.appendChild(h),setTimeout(()=>window.print(),100)}},x_={init(){this.overlay=document.getElementById("print-preview-overlay"),this.overlay&&(this.canvas=document.getElementById("print-preview-canvas"),this.ctx=this.canvas.getContext("2d"),this.canvasWrapper=this.canvas.parentElement,this.topRowSlider=document.getElementById("print-top-row-slider"),this.bottomRowSlider=document.getElementById("print-bottom-row-slider"),this.topRowLabel=document.getElementById("print-top-row-label"),this.bottomRowLabel=document.getElementById("print-bottom-row-label"),this.orientationBtn=document.getElementById("print-orientation-toggle"),this.colorBtn=document.getElementById("print-color-mode-toggle"),this.drumsBtn=document.getElementById("print-drums-toggle"),document.getElementById("print-close-button").addEventListener("click",()=>this.hide()),document.getElementById("print-confirm-button").addEventListener("click",()=>{Xd.generateAndPrint(),this.hide()}),this.topRowSlider.addEventListener("input",n=>u.setPrintOptions({topRow:parseInt(n.target.value)})),this.bottomRowSlider.addEventListener("input",n=>u.setPrintOptions({bottomRow:parseInt(n.target.value)})),this.orientationBtn.addEventListener("click",()=>this.handleToggle("orientation",["landscape","portrait"])),this.colorBtn.addEventListener("click",()=>this.handleToggle("colorMode",["color","bw"])),this.drumsBtn.addEventListener("click",()=>this.handleToggle("includeDrums",[!0,!1])),u.on("printPreviewStateChanged",n=>n?this.show():this.hide()),u.on("printOptionsChanged",()=>this.render()),u.on("notesChanged",()=>{u.state.isPrintPreviewActive&&this.render()}),new ResizeObserver(()=>{u.state.isPrintPreviewActive&&this.render()}).observe(this.canvasWrapper))},show(){console.log(" [PRINT PREVIEW] Showing preview"),u.state.isPrintPreviewActive||u.setPrintPreviewActive(!0),this.overlay.classList.remove("hidden");const n=u.state.placedNotes.filter(c=>!c.isDrum);let e=n.length>0?1/0:34,s=n.length>0?-1/0:54;n.forEach(c=>{e=Math.min(e,c.row),s=Math.max(s,c.row)});const i=2,r=Math.max(0,e-i),a=Math.min(u.state.fullRowData.length-1,s+i);this.topRowSlider.max=u.state.fullRowData.length-1,this.bottomRowSlider.max=u.state.fullRowData.length-1,u.setPrintOptions({...u.state.printOptions,topRow:r,bottomRow:a})},hide(){console.log(" [PRINT PREVIEW] Hiding preview"),u.state.isPrintPreviewActive&&u.setPrintPreviewActive(!1),this.overlay.classList.add("hidden")},handleToggle(n,e){const i=u.state.printOptions[n]===e[0]?e[1]:e[0];u.setPrintOptions({[n]:i})},updateControls(){var a,c;const{topRow:n,bottomRow:e,orientation:s,colorMode:i,includeDrums:r}=u.state.printOptions;this.topRowSlider.value=n,this.bottomRowSlider.value=e,this.topRowLabel.textContent=((a=u.state.fullRowData[n])==null?void 0:a.pitch)||"N/A",this.bottomRowLabel.textContent=((c=u.state.fullRowData[e])==null?void 0:c.pitch)||"N/A",this.orientationBtn.textContent=s.charAt(0).toUpperCase()+s.slice(1),this.colorBtn.textContent=i==="color"?"Color":"B&W",this.drumsBtn.textContent=r?"Yes":"No",this.drumsBtn.classList.toggle("active",r),this.colorBtn.classList.toggle("active",i==="color")},render(){if(!u.state.isPrintPreviewActive)return;this.updateControls();const n=this.canvasWrapper.clientWidth,e=this.canvasWrapper.clientHeight;if(n===0||e===0)return;const i=u.state.printOptions.orientation==="landscape"?10.5/8:8/10.5;let r=n,a=e;n/e>i?r=e*i:a=n/i;const c=Xd.generateScoreCanvas(u.state.printOptions,{width:r,height:a});c&&(this.canvas.width=c.width,this.canvas.height=c.height,this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(c,0,0))}};T.moduleLoaded("DynamicWaveformVisualizer");class S_{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.isPlaybackActive=!1,this.liveAnalysers=new Map,this.liveWaveforms=new Map,this.playbackAnimationId=null,this.animationSpeed=100,this.frameSkipCounter=0,T.info("DynamicWaveformVisualizer","Initialized for live waveform visualization",null,"waveform")}initialize(e,s){var i;return this.canvas=e,this.ctx=s,this.currentColor=((i=u.state.selectedNote)==null?void 0:i.color)||"#4a90e2",this.setupEventListeners(),T.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color)}),u.on("playbackStateChanged",({isPlaying:e,isPaused:s})=>{e&&!s?this.startLiveVisualization():this.stopLiveVisualization()}),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.startSingleNoteVisualization(e):this.stopLiveVisualization()}),u.on("tremoloAmplitudeUpdate",({activeColors:e})=>{this.isPlaybackActive&&e&&e.some(s=>this.liveWaveforms.has(s))&&T.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",e,"waveform")}),T.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),T.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(e){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(e),this.updateContainerState(!0),this.animateLiveWaveforms(),T.debug("DynamicWaveformVisualizer",`Started single note visualization for ${e}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1,this.liveAnalysers.forEach((e,s)=>{window.synthEngine&&window.synthEngine.removeWaveformAnalyzer(s)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),T.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(e){var i;const s=(i=this.canvas)==null?void 0:i.parentElement;s&&(e?(s.classList.add("live-mode"),u.state.isPlaying&&!u.state.isPaused&&s.classList.add("pulsing")):s.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const e=window.synthEngine;if(!e){T.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(i=>{const r=e.createWaveformAnalyzer(i);r&&(this.liveAnalysers.set(i,r),this.liveWaveforms.set(i,new Float32Array(1024)),T.debug("DynamicWaveformVisualizer",`Created analyser for ${i}`,null,"waveform"))})}setupSingleAnalyser(e){const s=window.synthEngine;if(!s)return;const i=s.createWaveformAnalyzer(e);i&&(this.liveAnalysers.set(e,i),this.liveWaveforms.set(e,new Float32Array(1024)),T.debug("DynamicWaveformVisualizer",`Created single analyser for ${e}`,null,"waveform"))}getActivePlayingColors(){const e=new Set;u.state.isPlaying&&u.state.placedNotes.forEach(i=>{!i.isDrum&&i.color&&e.add(i.color)}),e.size===0&&this.currentColor&&e.add(this.currentColor);const s=Array.from(e);return T.debug("DynamicWaveformVisualizer","Active playing colors detected",s,"waveform"),s}animateLiveWaveforms(){if(!this.isPlaybackActive)return;this.frameSkipCounter++;const e=Math.floor(100/this.animationSpeed);if(this.frameSkipCounter%e!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((s,i)=>{const r=s.getValue();this.liveWaveforms.set(i,r)}),this.onWaveformUpdate&&this.onWaveformUpdate(),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(e,s,i){const r=Array.from(this.liveWaveforms.keys());if(r.length===1){const a=r[0],c=this.liveWaveforms.get(a);this.drawSingleLiveWaveform(c,a,e,s,i)}else r.length>1&&r.forEach((a,c)=>{const h=this.liveWaveforms.get(a);this.drawLayeredLiveWaveform(h,a,e,s,i,r.length)})}drawSingleLiveWaveform(e,s,i,r,a){if(!e||e.length===0)return;let c=a,h=1;window.animationEffectsManager&&s&&(h=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s),c=c*h);let m=0;for(let y=0;y<e.length;y++)m=Math.max(m,Math.abs(e[y]));const f=m>1?1/m:1;this.ctx.strokeStyle=s,this.ctx.lineWidth=2,this.ctx.beginPath();const g=e.length/i;for(let y=0;y<i;y++){const w=Math.floor(y*g),C=(e[w]||0)*f,A=r-C*c;y===0?this.ctx.moveTo(y,A):this.ctx.lineTo(y,A)}this.ctx.stroke(),T.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${s} with tremolo`,{tremoloMultiplier:c/a},"waveform")}drawLayeredLiveWaveform(e,s,i,r,a,c){if(!e||e.length===0)return;let h=a;if(window.animationEffectsManager&&s){const C=window.animationEffectsManager.getTremoloAmplitudeMultiplier(s);h=h*C}let m=0;for(let C=0;C<e.length;C++)m=Math.max(m,Math.abs(e[C]));const f=m>1?1/m:1,g=Math.max(.4,1/c),y=Hs(s,g*2);Hs(s,g*.5),this.ctx.strokeStyle=y,this.ctx.lineWidth=1.5,this.ctx.beginPath();const w=e.length/i;for(let C=0;C<i;C++){const A=Math.floor(C*w),I=(e[A]||0)*f,E=r-I*h*.7;C===0?this.ctx.moveTo(C,E):this.ctx.lineTo(C,E)}this.ctx.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),T.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}T.moduleLoaded("StaticWaveformVisualizer");class C_{constructor(){this.canvas=null,this.ctx=null,this.currentColor=null,this.animationFrameId=null,this.waveformData=new Float32Array(512),this.isInitialized=!1,this.isTransitioning=!1,this.transitionStartTime=0,this.transitionDuration=300,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null,this.dynamicVisualizer=new S_,this.animationSpeed=100,this.frameSkipCounter=0,T.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){var s;if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;this.ctx=this.canvas.getContext("2d"),this.currentColor=((s=u.state.selectedNote)==null?void 0:s.color)||"#4a90e2";const e=this.canvas.parentElement;return e&&new ResizeObserver(()=>this.resize()).observe(e),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const e=this.canvas.parentElement;if(!e)return;const{clientWidth:s,clientHeight:i}=e,r=this.canvas.width,a=this.canvas.height;if((s===0||i===0)&&this.canvas.width>0&&this.canvas.height>0)return;const h=Math.abs(s-r),m=Math.abs(i-a);(h>2||m>2)&&(this.canvas.width=s,this.canvas.height=i,this.draw())}setupEventListeners(){u.on("noteChanged",({newNote:e})=>{e.color&&e.color!==this.currentColor&&(this.currentColor=e.color,this.generateWaveform())}),u.on("timbreChanged",e=>{e===this.currentColor&&this.generateWaveform()}),u.on("waveformExtendedViewChanged",e=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>{this.resize()},100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const e=document.querySelectorAll(".waveform-speed-btn");e.forEach(s=>{s.addEventListener("click",()=>{const i=parseInt(s.dataset.speed);s.classList.contains("active")?(s.classList.remove("active"),this.setAnimationSpeed(100)):(e.forEach(r=>r.classList.remove("active")),s.classList.add("active"),this.setAnimationSpeed(i))})})}setAnimationSpeed(e){this.animationSpeed=e,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(e)}setupExtendToggle(){const e=document.getElementById("waveform-extend-toggle");e&&(e.addEventListener("click",()=>{u.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const e=document.getElementById("waveform-extend-toggle");if(e){const s=u.state.waveformExtendedView;e.classList.toggle("extended",s),e.textContent=s?"480 View":"360 View",e.title=s?"Switch to 360 waveform view":"Switch to 480 waveform view (shows extra 120)"}}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const e=u.state.timbres[this.currentColor];if(!e||!e.coeffs)return;const s=Oa(this.currentColor),i=e.phases||[],r=this.waveformData.length,a=1,c=[];for(let m=0;m<s.length;m++)s[m]>.001&&c.push(`${m===0?"F0":"H"+(m+1)}: ${s[m].toFixed(3)}`);this.waveformData.fill(0);let h=0;for(let m=0;m<r;m++){const g=(u.state.waveformExtendedView?480:360)/360,y=m/r*g*2*Math.PI;let w=0;for(let C=0;C<ro;C++){const A=s[C]||0;if(A>.001){const I=i[C]||0,E=C+1;w+=A*Math.sin(E*y+I)}}this.waveformData[m]=w*a,h=Math.max(h,Math.abs(w*a))}if(this.calculatedAmplitude=Math.min(1,h),h>1){const m=1/h;for(let f=0;f<this.waveformData.length;f++)this.waveformData[f]*=m}this.draw()}startPhaseTransition(e,s,i){this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(s),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition()}generateTargetWaveform(e){if(!this.currentColor)return;const s=u.state.timbres[this.currentColor];if(!s||!s.coeffs)return;const i=Oa(this.currentColor),r=this.waveformData.length,a=1;this.waveformData.fill(0);let c=0;for(let h=0;h<r;h++){const f=(u.state.waveformExtendedView?480:360)/360,g=h/r*f*2*Math.PI;let y=0;for(let w=0;w<ro;w++){const C=i[w]||0;if(C>.001){const A=e[w]||0,I=w+1;y+=C*Math.sin(I*g+A)}}this.waveformData[h]=y*a,c=Math.max(c,Math.abs(y*a))}if(this.calculatedAmplitude=Math.min(1,c),c>1){const h=1/c;for(let m=0;m<this.waveformData.length;m++)this.waveformData[m]*=h}}animateTransition(){if(!this.isTransitioning)return;const e=performance.now()-this.transitionStartTime,s=Math.min(e/this.transitionDuration,1),i=1-Math.pow(1-s,3);for(let r=0;r<this.waveformData.length;r++)this.waveformData[r]=this.fromWaveform[r]+(this.toWaveform[r]-this.fromWaveform[r])*i;this.draw(),s>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let e=0;for(let s=0;s<this.waveformData.length;s++)e=Math.max(e,Math.abs(this.waveformData[s]));if(e>0){const s=.9/e;for(let i=0;i<this.waveformData.length;i++)this.waveformData[i]*=s}}draw(){if(!this.ctx||!this.canvas)return;const{width:e,height:s}=this.canvas,i=s/2,r=s/2;this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,e,s),this.drawGrid(e,s,i,r),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(e,i,r):this.drawWaveform(e,i,r),e>200&&s>100&&this.drawLabels(e,s)}drawGrid(e,s,i,r){this.ctx.strokeStyle="#ced4da",this.ctx.lineWidth=1,this.ctx.setLineDash([2,2]),this.ctx.beginPath(),this.ctx.moveTo(0,i),this.ctx.lineTo(e,i),this.ctx.stroke();const a=u.state.waveformExtendedView?480:360;if((u.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(g=>{const y=e/a*g;this.ctx.beginPath(),this.ctx.moveTo(y,0),this.ctx.lineTo(y,s),this.ctx.stroke()}),u.state.waveformExtendedView){const g=e/480*360;this.ctx.fillStyle="rgba(128, 128, 128, 0.15)",this.ctx.fillRect(g,0,e-g,s)}[.5].forEach(g=>{const y=i-r*g,w=i+r*g;this.ctx.beginPath(),this.ctx.moveTo(0,y),this.ctx.lineTo(e,y),this.ctx.moveTo(0,w),this.ctx.lineTo(e,w),this.ctx.stroke()}),this.ctx.setLineDash([]),this.ctx.strokeStyle="#999999",this.ctx.lineWidth=1;const m=i-r,f=i+r;this.ctx.beginPath(),this.ctx.moveTo(0,m),this.ctx.lineTo(e,m),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(0,f),this.ctx.lineTo(e,f),this.ctx.stroke()}drawWaveform(e,s,i){if(this.waveformData.length===0)return;const r=this.currentColor||"#4A90E2";this.ctx.strokeStyle=r,this.ctx.lineWidth=2,this.ctx.beginPath();const a=this.waveformData.length/e;for(let h=0;h<e;h++){const m=Math.floor(h*a),f=this.waveformData[m]||0,g=s-f*i;h===0?this.ctx.moveTo(h,g):this.ctx.lineTo(h,g)}this.ctx.stroke(),this.ctx.lineTo(e,s),this.ctx.lineTo(0,s),this.ctx.closePath();const c=this.ctx.createLinearGradient(0,s-i,0,s+i);c.addColorStop(0,Hs(r,.3)),c.addColorStop(.5,Hs(r,.1)),c.addColorStop(1,Hs(r,.3)),this.ctx.fillStyle=c,this.ctx.fill()}drawLabels(e,s){this.ctx.fillStyle="#666666",this.ctx.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',this.ctx.textAlign="center";const i=u.state.waveformExtendedView?480:360,r=u.state.waveformExtendedView?["0","90","180","270","360","450"]:["0","90","180","270","360"],a=u.state.waveformExtendedView?[0,90,180,270,360,450]:[0,90,180,270,360];r.forEach((c,h)=>{const m=e/i*a[h]+10;this.ctx.fillText(c,m,s/2+4)}),this.ctx.textAlign="left",this.ctx.fillText("+1.0",5,15),this.ctx.fillText("-1.0",5,s-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const e=this.calculatedAmplitude||0;if(window.animationEffectsManager&&this.currentColor){const s=window.animationEffectsManager.getADSRTremoloAmplitudeMultiplier(this.currentColor);return e*s}return e}startSingleNoteVisualization(e){return this.dynamicVisualizer.startSingleNoteVisualization(e)}stopLiveVisualization(){return this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){return this.dynamicVisualizer.startLiveVisualization()}dispose(){this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const fm=new C_;window.staticWaveformVisualizer=fm;function T_(){return fm.initialize()}class gm{constructor(e){this.effectName=e,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,T.info(`${e}AnimationEffect`,"Base initialized",null,"animation")}initBase(){u.on("visualEffectChanged",({effectType:e,parameter:s,value:i,color:r,effectParams:a})=>{e===this.effectName.toLowerCase()&&this.updateAnimationParameters(r,a)}),u.on("playbackStarted",()=>{this.isPlaybackActive=!0,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteInteractionStart",({noteId:e,color:s})=>this.onNoteInteractionStart(e,s)),u.on("noteInteractionEnd",({noteId:e})=>this.onNoteInteractionEnd(e)),u.on("ghostNoteUpdated",({color:e})=>this.onGhostNoteUpdated(e)),u.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),u.on("spacebarPlayback",({color:e,isPlaying:s})=>{s?this.isPlaybackActive=!0:this.isPlaybackActive=!1,window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteAttack",({noteId:e,color:s})=>this.onNoteAttack(e,s)),u.on("noteRelease",({noteId:e,color:s})=>this.onNoteRelease(e,s)),u.on("effectDialInteractionStart",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionStart(s)}),u.on("effectDialInteractionEnd",({effectType:e,color:s})=>{e===this.effectName.toLowerCase()&&this.onDialInteractionEnd(s)}),T.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}updateAnimationParameters(e,s){throw new Error("updateAnimationParameters must be implemented by subclass")}updateAnimationPhases(e){throw new Error("updateAnimationPhases must be implemented by subclass")}shouldAnimateColor(e){return!!this.animations.get(e)}shouldAnimateNote(e){if(!this.shouldAnimateColor(e.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const i=this.activeNoteAnimations.get("dial-preview");if(e.color===i)return!0}return!!(this.isPlaybackActive&&e.uuid&&this.activeSoundingNotes.has(e.uuid)||this.hasActiveInteraction&&e.uuid&&this.activeNoteAnimations.has(e.uuid)||!e.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===e.color&&this.isPlaybackActive)}shouldBeRunning(){const e=this.animations.size>0;return e?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||e:!1}onNoteInteractionStart(e,s){this.shouldAnimateColor(s)&&(this.activeNoteAnimations.set(e,s),this.hasActiveInteraction=!0,T.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${e} (${s})`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteInteractionEnd(e){this.activeNoteAnimations.delete(e),this.hasActiveInteraction=this.activeNoteAnimations.size>0,T.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onGhostNoteUpdated(e){this.shouldAnimateColor(e)?(this.ghostNoteAnimation={color:e,active:!0},T.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${e}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,T.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(e,s){this.shouldAnimateColor(s)&&(this.activeSoundingNotes.set(e,s),T.debug(`${this.effectName}AnimationEffect`,`Note attack: ${e} (${s}) added to active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onNoteRelease(e,s){this.activeSoundingNotes.delete(e),T.debug(`${this.effectName}AnimationEffect`,`Note release: ${e} (${s}) removed from active sounding notes`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}onDialInteractionStart(e){this.shouldAnimateColor(e)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",e),T.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState())}onDialInteractionEnd(e){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),T.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}getActiveColors(){const e=new Set;for(const[s,i]of this.activeSoundingNotes.entries())this.shouldAnimateColor(i)&&e.add(i);for(const[s,i]of this.activeNoteAnimations.entries())this.shouldAnimateColor(i)&&e.add(i);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&e.add(this.ghostNoteAnimation.color),Array.from(e)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,T.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}}T.moduleLoaded("VibratoCanvasEffect");class A_ extends gm{constructor(){super("Vibrato"),T.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),T.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(e,s){const{speed:i,span:r}=s;if(i===0||r===0)this.animations.delete(e),T.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${e}`,null,"animation");else{const a=this.animations.get(e),c=i/100*16,h=r/100*.5,m={frequency:c,amplitude:h,phase:(a==null?void 0:a.phase)||Math.PI/2,lastUpdate:performance.now()};this.animations.set(e,m),T.debug("VibratoCanvasEffect",`Updated vibrato animation for ${e}`,{frequency:c,amplitude:h,preservedPhase:!!a},"animation")}}updateAnimationPhases(e){this.animations.forEach((s,i)=>{const r=(e-s.lastUpdate)/1e3;s.phase+=s.frequency*r*2*Math.PI,s.lastUpdate=e,s.phase>4*Math.PI&&(s.phase-=4*Math.PI)})}getVibratoYOffset(e){const s=this.animations.get(e);return!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning()?0:Math.sin(s.phase)*s.amplitude}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.amplitude>0:!1}dispose(){this.disposeBase(),T.info("VibratoCanvasEffect","Disposed",null,"animation")}}T.moduleLoaded("TremoloWaveformEffect");class M_ extends gm{constructor(){super("Tremolo"),T.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),T.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(e,s){var a;const{speed:i,span:r}=s;if(i===0||r===0)this.animations.delete(e),T.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${e}`,null,"animation");else{const c=this.animations.get(e),h=i/100*16,m=r/100,f={frequency:h,span:m,phase:(c==null?void 0:c.phase)||0,lastUpdate:(a=window.Tone)!=null&&a.now?window.Tone.now()*1e3:performance.now()};this.animations.set(e,f),T.debug("TremoloWaveformEffect",`Updated tremolo animation for ${e}`,{frequency:h,span:m,preservedPhase:!!c},"animation")}}updateAnimationPhases(e){var r,a,c;let s=0;const i=(r=window.Tone)!=null&&r.now?window.Tone.now()*1e3:e;if(this.animations.forEach((h,m)=>{const f=(i-h.lastUpdate)/1e3,g=h.phase;h.phase+=h.frequency*f*2*Math.PI,h.lastUpdate=i,s++,Math.abs(h.phase-g)<.001&&T.warn("TremoloWaveformEffect",`Phase not advancing for ${m}`,{deltaSeconds:Number(f.toFixed(4)),frequency:h.frequency},"animation"),h.phase>4*Math.PI&&(h.phase-=4*Math.PI)}),s>0&&Math.random()<.05){const h=(a=window.Tone)!=null&&a.now?"Tone.js":"performance";T.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!((c=window.Tone)!=null&&c.now),toneTime:i,currentTime:e,timingSource:h},"animation")}}getTremoloAmplitudeMultiplier(e){var A,I;const s=this.animations.get(e);if(!s||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const i=((A=window.staticWaveformVisualizer)==null?void 0:A.calculatedAmplitude)||1,r=Math.sin(s.phase),a=s.span,c=i,h=i*(1-a),m=(c+h)/2,f=(c-h)/2,y=(m+r*f)/i,C=(((I=window.Tone)==null?void 0:I.now())*1e3||performance.now())-s.lastUpdate;if(C>100&&s.span>0){const E=s.frequency*(C/1e3)*2*Math.PI;E>.1&&T.warn("TremoloWaveformEffect",`Phase stagnation detected for ${e}`,{phase:Number(s.phase.toFixed(3)),millisecondsSinceUpdate:Number(C.toFixed(1)),expectedAdvancement:Number(E.toFixed(3))},"animation")}return Math.max(0,Math.min(1,y))}getADSRTremoloAmplitudeMultiplier(e){return this.getTremoloAmplitudeMultiplier(e)}shouldAnimateColor(e){const s=this.animations.get(e);return s?s.frequency>0&&s.span>0:!1}dispose(){this.disposeBase(),T.info("TremoloWaveformEffect","Disposed",null,"animation")}}T.moduleLoaded("EnvelopeFillEffect");class E_{constructor(){this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),T.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){u.on("noteAttack",({noteId:e,color:s})=>{const i=u.state.timbres[s];if(!i){console.warn("[ENVELOPE FILL]  No timbre found for color:",s);return}this.activeFills.set(e,{fillLevel:0,color:s,startTime:J.now(),adsr:i.adsr,phase:"attack"}),T.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}),u.on("noteRelease",({noteId:e,color:s})=>{const i=this.activeFills.get(e);i?(i.phase="release",i.releaseStartTime=J.now(),i.releaseStartLevel=i.fillLevel,T.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):console.warn("[ENVELOPE FILL]  No fill data found for release:",e)}),u.on("playbackStopped",()=>{this.activeFills.clear(),window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState(),u.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),T.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(e){const s=J.now();for(const[i,r]of this.activeFills.entries()){const{adsr:a,startTime:c,phase:h,releaseStartTime:m,releaseStartLevel:f}=r,g=s-c;if(h==="attack"){const y=a.attack||.01;g<y?r.fillLevel=g/y:(r.phase="decay",r.decayStartTime=s)}else if(h==="decay"){const y=a.decay||.1,w=s-r.decayStartTime,C=a.sustain!==void 0?a.sustain:.5;if(w<y){const A=w/y;r.fillLevel=1-A*(1-C)}else r.phase="sustain",r.fillLevel=C}else if(h==="sustain"){const y=a.sustain!==void 0?a.sustain:.5;r.fillLevel=y}else if(h==="release"){const y=a.release||.5,w=s-m;if(w<y){const C=w/y;r.fillLevel=f*(1-C)}else this.activeFills.delete(i),T.debug("EnvelopeFillEffect",`Completed fill animation for note ${i}`,null,"animation"),this.activeFills.size===0&&window.animationEffectsManager&&window.animationEffectsManager.updateAnimationState&&window.animationEffectsManager.updateAnimationState()}}}getFillLevel(e){if(!e.uuid)return 0;const s=this.activeFills.get(e.uuid);return s?s.fillLevel:0}shouldFillNote(e){return e.uuid?this.activeFills.has(e.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),T.info("EnvelopeFillEffect","Disposed",null,"animation")}}T.moduleLoaded("AnimationEffectsManager");class P_{constructor(){this.vibratoEffect=new A_,this.tremoloEffect=new M_,this.envelopeFillEffect=new E_,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,T.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),u.on("visualEffectChanged",({effectType:e,parameter:s,value:i,color:r})=>{(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),T.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(e){this.isRunning&&(this.lastTime=e,this.vibratoEffect.updateAnimationPhases(e),this.tremoloEffect.updateAnimationPhases(e),this.envelopeFillEffect.updateAnimationPhases(e),this.triggerVisualUpdates(e),this.animationFrameId=requestAnimationFrame(s=>this.animate(s)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)),T.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),T.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const s=this.tremoloEffect.activeSoundingNotes.size>0,i=this.tremoloEffect.hasDialInteraction;return s||i}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const e=this.shouldVibratoBeRunning(),s=this.shouldTremoloBeRunning(),i=this.shouldEnvelopeFillBeRunning(),r=e||s||i;r&&!this.isRunning?this.start():!r&&this.isRunning&&this.stop()}triggerVisualUpdates(e){if(!this.lastRenderTrigger||e-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=e;const s=this.vibratoEffect.getActiveColors(),i=this.tremoloEffect.getActiveColors(),r=this.envelopeFillEffect.activeFills.size>0;(s.length>0||r)&&u.emit("animationUpdate",{type:s.length>0?"vibrato":"envelopeFill",activeColors:s,hasEnvelopeFills:r}),i.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:i})}}triggerFinalUpdates(){const e=Array.from(this.vibratoEffect.animations.keys());e.length>0&&u.emit("animationUpdate",{type:"vibrato",activeColors:e});const s=Array.from(this.tremoloEffect.animations.keys());s.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:s})}shouldAnimateNote(e){return this.vibratoEffect.shouldAnimateNote(e)}getVibratoYOffset(e){return this.vibratoEffect.getVibratoYOffset(e)}getTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getTremoloAmplitudeMultiplier(e)}getADSRTremoloAmplitudeMultiplier(e){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(e)}getFillLevel(e){return this.envelopeFillEffect.getFillLevel(e)}shouldFillNote(e){return this.envelopeFillEffect.shouldFillNote(e)}triggerTremoloAmplitudeUpdate(){const e=this.tremoloEffect.getActiveColors();e.length>0&&u.emit("tremoloAmplitudeUpdate",{activeColors:e})}getAllActiveColors(){const e=this.vibratoEffect.getActiveColors(),s=this.tremoloEffect.getActiveColors();return[...new Set([...e,...s])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),T.info("AnimationEffectsManager","Disposed",null,"animation")}}const Yd=new P_;T.moduleLoaded("VibratoAudioEffect");class k_{constructor(){this.currentSettings=new Map,T.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return T.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:i,span:r}=e;this.currentSettings.set(s,{speed:i,span:r}),T.debug("VibratoAudioEffect",`Updated parameters for ${s}`,{speed:i,span:r},"audio")}applyToVoice(e,s){if(!e||!e._setVibrato)return;const i=this.currentSettings.get(s);if(!i){T.debug("VibratoAudioEffect",`No vibrato settings found for color ${s}`,null,"audio");return}try{e._setVibrato(i),e.vibratoApplied=!0,T.debug("VibratoAudioEffect",`Applied vibrato to voice for ${s}`,i,"audio")}catch(r){T.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createVibratoSettings(e,s){if(e===0||s===0)return null;const i=e/100*16,r=s/100*50;return{frequency:i,depth:r}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),T.info("VibratoAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("TremoloAudioEffect");class I_{constructor(){this.currentSettings=new Map,T.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return T.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{speed:i,span:r}=e;this.currentSettings.set(s,{speed:i,span:r}),T.debug("TremoloAudioEffect",`Updated parameters for ${s}`,{speed:i,span:r},"audio")}applyToVoice(e,s){if(!e||!e._setTremolo)return;const i=this.currentSettings.get(s);if(!i){T.debug("TremoloAudioEffect",`No tremolo settings found for color ${s}`,null,"audio");return}try{e._setTremolo(i),e.tremoloApplied=!0,T.debug("TremoloAudioEffect",`Applied tremolo to voice for ${s}`,i,"audio")}catch(r){T.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{speed:0,span:0}}getEffectInstance(e){return null}createTremoloSettings(e,s){if(e===0||s===0)return null;const i=e/100*16,r=s/100;return{frequency:i,depth:r}}disableForColor(e){this.updateParameters({speed:0,span:0},e)}dispose(){this.currentSettings.clear(),T.info("TremoloAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("ReverbAudioEffect");class R_{constructor(){this.currentSettings=new Map,this.reverbInstances=new Map,T.info("ReverbAudioEffect","Initialized",null,"audio")}init(){return T.info("ReverbAudioEffect","Ready for audio processing",null,"audio"),!0}async updateParameters(e,s){const{decay:i,roomSize:r,wet:a=10}=e;this.currentSettings.set(s,{decay:i,roomSize:r,wet:a}),T.debug("ReverbAudioEffect",`Updated parameters for ${s}`,{decay:i,roomSize:r,wet:a},"audio");let c=this.reverbInstances.get(s);c?this.updateReverbInstance(c,i,r,a):(i>0||r>0)&&(c=await this.createReverbInstance(i,r,a),c&&(this.reverbInstances.set(s,c),T.debug("ReverbAudioEffect",`Created new reverb instance for ${s}`,{decay:i,roomSize:r,wet:a},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}async applyToVoice(e,s){if(!e)return;const i=this.currentSettings.get(s);if(!(!i||i.decay===0&&i.roomSize===0))try{let r=this.reverbInstances.get(s);if(r||(r=await this.createReverbInstance(i.decay,i.roomSize,i.wet),this.reverbInstances.set(s,r)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(r)}catch{e.output&&e.output.connect(r)}T.debug("ReverbAudioEffect",`Applied reverb to voice for ${s}`,i,"audio")}catch(r){T.warn("ReverbAudioEffect",`Failed to apply reverb to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{decay:0,roomSize:0}}getEffectInstance(e){return this.getCurrentSettings(e).wet>0?this.reverbInstances.get(e):null}async createReverbInstance(e,s,i=10){if(e===0&&s===0)return null;const r=Math.max(.1,e/100*8),a=1+s/100*1.5,c=r*a,h=i/100,m=new J.Reverb({decay:c,wet:h});return m._wetAmount=h,await m.ready,T.debug("ReverbAudioEffect","Created reverb instance",{decayTime:c,wetAmount:h,roomSize:s},"audio"),m}updateReverbInstance(e,s,i,r=10){if(e)try{const a=Math.max(.1,s/100*8),c=1+i/100*1.5,h=a*c,m=r/100;e.decay=h,e._crossFade&&(e._crossFade.fade.value=m),e._wetAmount=m,T.debug("ReverbAudioEffect","Updated reverb instance",{decayTime:h,wetAmount:m,roomSize:i},"audio")}catch(a){T.warn("ReverbAudioEffect","Failed to update reverb instance",a,"audio")}}createReverbSettings(e,s,i=25){if(e===0&&s===0)return null;const r=Math.max(.1,e/100*10),a=i/100;return{decay:r,roomSize:s/100,wet:a}}disableForColor(e){this.updateParameters({decay:0,roomSize:0,wet:0},e);const s=this.reverbInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.reverbInstances.delete(e))}dispose(){this.reverbInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(i){T.warn("ReverbAudioEffect",`Failed to dispose reverb for ${s}`,i,"audio")}}),this.currentSettings.clear(),this.reverbInstances.clear(),T.info("ReverbAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("DelayAudioEffect");class D_{constructor(){this.currentSettings=new Map,this.delayInstances=new Map,T.info("DelayAudioEffect","Initialized",null,"audio")}init(){return T.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(e,s){const{time:i,feedback:r,wet:a=15}=e;this.currentSettings.set(s,{time:i,feedback:r,wet:a}),T.debug("DelayAudioEffect",`Updated parameters for ${s}`,{time:i,feedback:r,wet:a},"audio");let c=this.delayInstances.get(s);c?this.updateDelayInstance(c,i,r,a):(i>0||r>0)&&(c=this.createDelayInstance(i,r,a),c&&(this.delayInstances.set(s,c),T.debug("DelayAudioEffect",`Created new delay instance for ${s}`,{time:i,feedback:r,wet:a},"audio"),window.synthEngine&&window.synthEngine.updateSynthForColor(s)))}applyToVoice(e,s){if(!e)return;const i=this.currentSettings.get(s);if(!(!i||i.time===0&&i.feedback===0))try{let r=this.delayInstances.get(s);if(r||(r=this.createDelayInstance(i.time,i.feedback,i.wet),this.delayInstances.set(s,r)),e&&e.output&&(typeof e.isDisposed!="function"||!e.isDisposed()))try{e.connect(r)}catch{e.output&&e.output.connect(r)}T.debug("DelayAudioEffect",`Applied delay to voice for ${s}`,i,"audio")}catch(r){T.warn("DelayAudioEffect",`Failed to apply delay to voice for ${s}`,r,"audio")}}getCurrentSettings(e){return this.currentSettings.get(e)||{time:0,feedback:0}}getEffectInstance(e){const s=this.getCurrentSettings(e);return s.time>0&&s.wet>0?this.delayInstances.get(e):null}createDelayInstance(e,s,i=30){if(e===0&&s===0)return null;const r=Math.max(.01,e/100*.5),a=Math.min(.95,s/100),c=i/100,h=new J.FeedbackDelay({delayTime:r,feedback:a,wet:c});return h._wetAmount=c,T.debug("DelayAudioEffect","Created delay instance",{delayTime:r,feedbackAmount:a,wetAmount:c},"audio"),h}updateDelayInstance(e,s,i,r=15){if(e)try{const a=Math.max(.01,s/100*.5),c=Math.min(.95,i/100),h=r/100;e.delayTime.value=a,e.feedback.value=c,e._crossFade&&(e._crossFade.fade.value=h),e._wetAmount=h,T.debug("DelayAudioEffect","Updated delay instance",{delayTime:a,feedbackAmount:c,wetAmount:h},"audio")}catch(a){T.warn("DelayAudioEffect","Failed to update delay instance",a,"audio")}}createDelaySettings(e,s,i=30){if(e===0&&s===0)return null;const r=Math.max(.01,e/100*.5),a=Math.min(.95,s/100),c=i/100;return{delayTime:r,feedback:a,wet:c}}disableForColor(e){this.updateParameters({time:0,feedback:0,wet:0},e);const s=this.delayInstances.get(e);s&&(s._crossFade&&s._crossFade.dispose(),s.dispose(),this.delayInstances.delete(e))}dispose(){this.delayInstances.forEach((e,s)=>{try{e._crossFade&&e._crossFade.dispose(),e.dispose()}catch(i){T.warn("DelayAudioEffect",`Failed to dispose delay for ${s}`,i,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),T.info("DelayAudioEffect","Disposed",null,"audio")}}T.moduleLoaded("AudioEffectsManager");class O_{constructor(){this.vibratoEffect=new k_,this.tremoloEffect=new I_,this.reverbEffect=new R_,this.delayEffect=new D_,T.info("AudioEffectsManager","Initialized with audio effect handlers",null,"audio")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.reverbEffect.init(),this.delayEffect.init(),u.on("audioEffectChanged",({effectType:e,parameter:s,value:i,color:r,effectParams:a})=>{this.handleAudioEffectChange(e,s,i,r,a)}),T.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(e,s,i,r,a){switch(T.debug("AudioEffectsManager",`Processing audio effect: ${e}.${s} = ${i} for ${r}`,null,"audio"),e){case"vibrato":this.vibratoEffect.updateParameters(a,r);break;case"tremolo":this.tremoloEffect.updateParameters(a,r);break;case"reverb":this.reverbEffect.updateParameters(a,r);break;case"delay":this.delayEffect.updateParameters(a,r);break;default:T.debug("AudioEffectsManager",`Effect type ${e} not handled by audio system`,null,"audio")}}getEffectHandler(e){switch(e){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"reverb":return this.reverbEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(e,s,i){const r=this.reverbEffect.getEffectInstance(s),a=this.delayEffect.getEffectInstance(s);this.reverbEffect.getCurrentSettings(s),this.delayEffect.getCurrentSettings(s);try{e.disconnect()}catch{}let c=e;if(r)try{r.disconnect(),c.connect(r),c=r}catch{}if(a)try{a.disconnect(),c.connect(a),c=a}catch{}try{if(c.connect(i),window.synthEngine){const h=window.synthEngine.getWaveformAnalyzer(s);h&&e.connect(h)}}catch{}}applyEffectsToVoice(e,s){this.vibratoEffect.applyToVoice(e,s),this.tremoloEffect.applyToVoice(e,s)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.reverbEffect.dispose(),this.delayEffect.dispose(),T.info("AudioEffectsManager","Disposed",null,"audio")}}const Zd=new O_;T.moduleLoaded("EffectsCoordinator");class N_{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0},tremolo:{speed:0,span:0},reverb:{decay:0,roomSize:0},delay:{time:0,feedback:0}},T.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(u.state.timbres).forEach(e=>{this.initializeColorEffects(e)}),u.on("timbreCreated",({color:e})=>{this.initializeColorEffects(e)}),this.loadSavedValues(),T.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(e){if(!this.effectParameters.has(e)){const s={};Object.entries(this.defaultEffects).forEach(([r,a])=>{s[r]={...a}}),this.effectParameters.set(e,s);const i=u.state.timbres[e];i&&(i.vibrato&&(s.vibrato={...i.vibrato}),i.tremelo&&(s.tremolo={...i.tremelo})),T.debug("EffectsCoordinator",`Initialized effects for color ${e}`,s,"effects")}}updateParameter(e,s,i,r){if(!r){T.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:e,parameter:s,value:i},"effects");return}this.initializeColorEffects(r);const a=this.effectParameters.get(r);a[e]||(a[e]={...this.defaultEffects[e]}),a[e][s],a[e][s]=i,this.notifyAudioSystem(e,s,i,r,a[e]),this.notifyAnimationSystem(e,s,i,r,a[e]),this.updateTimbreState(e,a[e],r),this.saveValues()}notifyAudioSystem(e,s,i,r,a){u.emit("audioEffectChanged",{effectType:e,parameter:s,value:i,color:r,effectParams:{...a}}),T.debug("EffectsCoordinator",`Notified audio system: ${e}.${s} = ${i} for ${r}`,null,"effects")}notifyAnimationSystem(e,s,i,r,a){(e==="vibrato"||e==="tremolo")&&(u.emit("visualEffectChanged",{effectType:e,parameter:s,value:i,color:r,effectParams:{...a}}),T.debug("EffectsCoordinator",`Notified animation system: ${e}.${s} = ${i} for ${r}`,null,"effects"))}updateTimbreState(e,s,i){const r=u.state.timbres[i];if(!r)return;const c={vibrato:"vibrato",tremolo:"tremelo"}[e];c&&(r[c]||(r[c]={}),Object.assign(r[c],s),u.recordState())}getEffectParameters(e,s){const i=this.effectParameters.get(e);return!i||!i[s]?{...this.defaultEffects[s]}:{...i[s]}}getAllEffectParameters(e){const s=this.effectParameters.get(e);return s?{...s}:{...this.defaultEffects}}resetColorEffects(e){const s={};Object.entries(this.defaultEffects).forEach(([i,r])=>{s[i]={...r}}),this.effectParameters.set(e,s),Object.keys(s).forEach(i=>{Object.keys(s[i]).forEach(r=>{this.notifyAudioSystem(i,r,s[i][r],e,s[i]),this.notifyAnimationSystem(i,r,s[i][r],e,s[i])})}),T.info("EffectsCoordinator",`Reset all effects for color ${e}`,s,"effects")}saveValues(){const e={};Object.keys(u.state.timbres).forEach(s=>{const i=this.effectParameters.get(s);i&&(e[s]={vibrato:i.vibrato||{speed:0,span:0},tremelo:i.tremolo||{speed:0,span:0},reverb:i.reverb||{decay:0,roomSize:0},delay:i.delay||{time:0,feedback:0}})});try{localStorage.setItem("effectDialValues",JSON.stringify(e)),T.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(s){T.warn("EffectsCoordinator","Failed to save effect values to localStorage",s,"effects")}}loadSavedValues(){try{const e=localStorage.getItem("effectDialValues");if(!e){T.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const s=JSON.parse(e);T.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(s).forEach(i=>{const r=u.state.timbres[i],a=s[i];r&&a&&(a.vibrato&&Object.entries(a.vibrato).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("vibrato",c,h,i)}),a.tremelo&&Object.entries(a.tremelo).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("tremolo",c,h,i)}),a.reverb&&Object.entries(a.reverb).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("reverb",c,h,i)}),a.delay&&Object.entries(a.delay).forEach(([c,h])=>{typeof h=="number"&&this.updateParameter("delay",c,h,i)}))}),T.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(s).forEach(i=>{const r=s[i];(r.reverb&&(r.reverb.decay>0||r.reverb.roomSize>0)||r.delay&&(r.delay.time>0||r.delay.feedback>0))&&(window.synthEngine.updateSynthForColor(i),T.debug("EffectsCoordinator",`Re-applied effects to synth for ${i}`,null,"effects"))})}catch(e){T.warn("EffectsCoordinator","Failed to load saved effect values",e,"effects")}}dispose(){this.effectParameters.clear(),T.info("EffectsCoordinator","Disposed",null,"effects")}}const Ea=new N_,L_=Object.freeze(Object.defineProperty({__proto__:null,default:Ea},Symbol.toStringTag,{value:"Module"}));class F_{constructor(){this.currentEffect=null,this.effectControlsContainer=null,this.effectButtons=[],this.dials=[],this.currentColor=null,this.isDialInteractionActive=!1,this.effectConfigs={reverb:{name:"Reverb",controls:{decay:{label:"Time",min:0,max:100,default:0,unit:"%"},roomSize:{label:"Size",min:0,max:100,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:10,unit:"%"}}},delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}}}init(){return T.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),!this.effectControlsContainer||this.effectButtons.length===0?(T.initFailed("Effects Controller","Required DOM elements not found"),!1):(this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),T.initSuccess("Effects Controller"),!0)}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(e=>{e.addEventListener("click",s=>{const i=s.target.dataset.effect;this.selectEffect(i)})})}selectEffect(e){if(T.debug("Effects",`Selecting effect: ${e}`,null,"ui"),!this.effectConfigs[e]){T.info("Effects",`Effect ${e} not configured`,null,"ui");return}if(this.effectButtons.forEach(s=>{s.classList.remove("active"),s.dataset.effect===e&&s.classList.add("active")}),this.currentEffect===e){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=e,this.showEffectControls(e)}showEffectControls(e){const s=this.effectConfigs[e];if(!s){T.warn("Effects",`No configuration found for effect: ${e}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const i=this.effectControlsContainer.querySelector(".effect-controls");Object.entries(s.controls).forEach(([r,a])=>{const c=this.currentColor?Ea.getEffectParameters(this.currentColor,e):null,h=(c==null?void 0:c[r])||0,m=document.createElement("div");m.className="effect-slider-group",m.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",i.appendChild(m);const f=document.createElement("label");f.className="effect-slider-label",f.textContent=a.label,f.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",m.appendChild(f);const g=document.createElement("input");g.type="range",g.min=a.min,g.max=a.max,g.value=h,g.className="effect-slider",g.style.cssText="width: 100%; margin: 5px 0;",m.appendChild(g);const y=document.createElement("div");y.className="effect-slider-value";const w=a.unit?`${Math.round(h)}${a.unit}`:Math.round(h);y.textContent=w,y.style.cssText="text-align: center; font-size: 12px; color: #666;",m.appendChild(y),this.dials.push({dial:{element:g,value:h,destroy:()=>{}},control:r,effectType:e,valueDisplay:y,controlConfig:a});const C=A=>{const I=parseFloat(A.target.value),E=a.unit?`${Math.round(I)}${a.unit}`:Math.round(I);y.textContent=E,T.debug("Effects",`${e} ${r}: ${I}`,null,"audio"),this.onEffectParameterChange(e,r,I)};g.addEventListener("mousedown",A=>{this.onDialInteractionStart(e)}),g.addEventListener("mouseup",A=>{this.onDialInteractionEnd(e)}),g.addEventListener("mouseleave",A=>{A.buttons}),g.addEventListener("touchstart",A=>{this.onDialInteractionStart(e)}),g.addEventListener("touchend",A=>{this.onDialInteractionEnd(e)}),g.addEventListener("input",C),g.addEventListener("change",C)}),this.effectControlsContainer.classList.add("active")}hideEffectControls(){this.clearControls(),this.effectControlsContainer.classList.remove("active"),this.effectControlsContainer.innerHTML="",this.effectButtons.forEach(e=>e.classList.remove("active"))}clearControls(){this.dials.forEach(({dial:e})=>{e.destroy&&e.destroy()}),this.dials=[]}onEffectParameterChange(e,s,i){var a;T.debug("Effects",`Effect parameter changed: ${e}.${s} = ${i}`,null,"audio");const r=(a=u.state.selectedNote)==null?void 0:a.color;if(!r){T.warn("Effects","Cannot update effect parameter: no color selected",{effectType:e,parameter:s,value:i},"audio");return}Ea.updateParameter(e,s,i,r),u.emit("effectParameterChanged",{effectType:e,parameter:s,value:i,color:r})}onDialInteractionStart(e){var i;if(this.isDialInteractionActive||e!=="vibrato"&&e!=="tremolo")return;this.isDialInteractionActive=!0;const s=(i=u.state.selectedNote)==null?void 0:i.color;if(!s){T.debug("Effects","Dial interaction started but no color selected",null,"ui");return}u.emit("effectDialInteractionStart",{effectType:e,color:s}),T.debug("Effects",`Dial interaction started for ${e} on ${s}`,null,"ui")}onDialInteractionEnd(e){var i;if(!this.isDialInteractionActive)return;this.isDialInteractionActive=!1;const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&(u.emit("effectDialInteractionEnd",{effectType:e,color:s}),T.debug("Effects",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}getCurrentEffect(){return this.currentEffect}getEffectParameters(e){var r;if(!this.effectConfigs[e])return null;const s=(r=u.state.selectedNote)==null?void 0:r.color;if(!s)return null;if(window.effectsCoordinator)return window.effectsCoordinator.getEffectParameters(s,e);const i={};return this.dials.forEach(({dial:a,control:c,effectType:h})=>{h===e&&(i[c]=parseFloat(a.element.value))}),i}initializeSelectedColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("selectedNoteChanged",()=>{var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s!==this.currentColor&&(this.currentColor=s,this.updateEffectButtonIndicators())}),u.on("audioEffectChanged",()=>{this.updateEffectButtonIndicators()}),this.updateEffectButtonIndicators()}updateEffectButtonIndicators(){!this.effectButtons||!this.currentColor||this.effectButtons.forEach(e=>{const s=e.getAttribute("data-effect");let i=!1;const r=Ea.getEffectParameters(this.currentColor,s);switch(s){case"vibrato":i=r.speed>0&&r.span>0;break;case"tremolo":i=r.speed>0&&r.span>0;break;case"reverb":i=r.roomSize>0||r.decay>0||r.wet>0&&(r.roomSize>0||r.decay>0);break;case"delay":i=r.time>0||r.feedback>0||r.wet>0&&(r.time>0||r.feedback>0);break}i?(e.style.backgroundColor=this.currentColor,e.style.color="white",e.classList.add("effect-active")):(e.style.backgroundColor="",e.style.color="",e.classList.remove("effect-active"))})}}const $n=new F_;class B_{constructor(e,s={}){if(this._root=typeof e=="string"?document.querySelector(e):e,!this._root)throw new Error("Position: target not found");const{size:i=[200,200],mode:r="absolute",x:a=.5,minX:c=0,maxX:h=1,stepX:m=0,y:f=.5,minY:g=0,maxY:y=1,stepY:w=0}=s;this._events=new Map,this._emit=(O,P)=>{const R=this._events.get(O);if(R)for(const q of R)q(P)};class C{constructor(P,R,q,G){this.min=P,this.max=R,this.step=q,this.value=0,this.update(G)}update(P){const R=Math.min(this.max,Math.max(this.min,P));if(!this.step||this.step<=0)return this.value=R,this.value;const q=Math.round((R-this.min)/this.step)*this.step+this.min;return this.value=Math.min(this.max,Math.max(this.min,parseFloat(q.toFixed(12)))),this.value}updateNormal(P){const R=this.max-this.min||1;return this.update(this.min+R*Math.min(1,Math.max(0,P)))}get normalized(){const P=this.max-this.min||1;return(this.value-this.min)/P}}class A{constructor(P,R,q,G){this.mode=P,this.orient=R,this._xr=q.slice(),this._yr=G.slice(),this.value=.5,this._anchorN=.5}resize(P,R){this._xr=P.slice(),this._yr=R.slice()}set anchor(P){this._anchorN=this._posToNorm(P)}update(P){if(this.mode==="absolute")this.value=this._posToNorm(P);else{const R=this._posToNorm(P),q=R-this._anchorN;this.value=I(this.value+q),this._anchorN=R}this.value=I(this.value)}_posToNorm(P){if(this.orient==="horizontal"){const R=this._xr[1]-this._xr[0]||1;return I((P.x-this._xr[0])/R)}else{const R=this._yr[1]-this._yr[0]||1;return I(1-(P.y-this._yr[0])/R)}}}const I=O=>Math.min(1,Math.max(0,O));this._x=new C(c,h,m,a),this._y=new C(g,y,w,f),this._w=Math.max(10,Math.floor(i[0])),this._h=Math.max(10,Math.floor(i[1])),this._mode=r==="relative"?"relative":"absolute",this._hX=new A(this._mode,"horizontal",[0,this._w],[0,this._h]),this._hY=new A(this._mode,"vertical",[0,this._w],[0,this._h]),this._hX.value=this._x.normalized,this._hY.value=this._y.normalized,this._style={bg:"rgba(74, 144, 226, 0.1)",grid:"#dee2e6",cross:"#6c757d",handle:"#4A90E2",text:"#212529"},this._svg=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._svg.style.display="block",this._svg.style.touchAction="none",this._root.innerHTML="",this._root.appendChild(this._svg),this._bg=document.createElementNS(this._svg.namespaceURI,"rect"),this._bg.setAttribute("x",0),this._bg.setAttribute("y",0),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h),this._bg.setAttribute("fill",this._style.bg),this._svg.appendChild(this._bg),this._grid=document.createElementNS(this._svg.namespaceURI,"g"),this._grid.setAttribute("stroke",this._style.grid),this._grid.setAttribute("stroke-width","1");const E=[.25,.5,.75];for(const O of E){const P=document.createElementNS(this._svg.namespaceURI,"line");P.setAttribute("x1",this._w*O),P.setAttribute("y1",0),P.setAttribute("x2",this._w*O),P.setAttribute("y2",this._h),this._grid.appendChild(P);const R=document.createElementNS(this._svg.namespaceURI,"line");R.setAttribute("x1",0),R.setAttribute("y1",this._h*O),R.setAttribute("x2",this._w),R.setAttribute("y2",this._h*O),this._grid.appendChild(R)}this._svg.appendChild(this._grid),this._xh=document.createElementNS(this._svg.namespaceURI,"line"),this._yh=document.createElementNS(this._svg.namespaceURI,"line");for(const O of[this._xh,this._yh])O.setAttribute("stroke",this._style.cross),O.setAttribute("stroke-width","2"),this._svg.appendChild(O);this._knob=document.createElementNS(this._svg.namespaceURI,"circle"),this._knob.setAttribute("r",Math.max(4,Math.min(this._w,this._h)*.04)),this._knob.setAttribute("fill",this._style.handle),this._svg.appendChild(this._knob),this._clicked=!1,this._onDown=this._onDown.bind(this),this._onMove=this._onMove.bind(this),this._onUp=this._onUp.bind(this),this._svg.addEventListener("pointerdown",this._onDown),window.addEventListener("pointerup",this._onUp),window.addEventListener("pointercancel",this._onUp),this._draw()}on(e,s){return this._events.has(e)||this._events.set(e,new Set),this._events.get(e).add(s),()=>this.off(e,s)}off(e,s){const i=this._events.get(e);i&&i.delete(s)}get x(){return this._x.value}set x(e){const s=this._x.value;this._x.update(e),this._hX.value=this._x.normalized,this._x.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get y(){return this._y.value}set y(e){const s=this._y.value;this._y.update(e),this._hY.value=this._y.normalized,this._y.value!==s&&(this._emit("change",{x:this._x.value,y:this._y.value}),this._draw())}get minX(){return this._x.min}set minX(e){this._x.min=e,this.x=this._x.value}get maxX(){return this._x.max}set maxX(e){this._x.max=e,this.x=this._x.value}get stepX(){return this._x.step}set stepX(e){this._x.step=e,this.x=this._x.value}get minY(){return this._y.min}set minY(e){this._y.min=e,this.y=this._y.value}get maxY(){return this._y.max}set maxY(e){this._y.max=e,this.y=this._y.value}get stepY(){return this._y.step}set stepY(e){this._y.step=e,this.y=this._y.value}get mode(){return this._mode}set mode(e){this._mode=e==="relative"?"relative":"absolute",this._hX.mode=this._mode,this._hY.mode=this._mode}get normalized(){return{x:this._x.normalized,y:this._y.normalized}}resize(e,s){for(this._w=Math.max(10,Math.floor(e)),this._h=Math.max(10,Math.floor(s)),this._svg.setAttribute("width",this._w),this._svg.setAttribute("height",this._h),this._svg.setAttribute("viewBox",`0 0 ${this._w} ${this._h}`),this._hX.resize([0,this._w],[0,this._h]),this._hY.resize([0,this._w],[0,this._h]),this._bg.setAttribute("width",this._w),this._bg.setAttribute("height",this._h);this._grid.firstChild;)this._grid.removeChild(this._grid.firstChild);const i=[.25,.5,.75];for(const r of i){const a=document.createElementNS(this._svg.namespaceURI,"line");a.setAttribute("x1",this._w*r),a.setAttribute("y1",0),a.setAttribute("x2",this._w*r),a.setAttribute("y2",this._h),this._grid.appendChild(a);const c=document.createElementNS(this._svg.namespaceURI,"line");c.setAttribute("x1",0),c.setAttribute("y1",this._h*r),c.setAttribute("x2",this._w),c.setAttribute("y2",this._h*r),this._grid.appendChild(c)}this._draw()}destroy(){this._svg.removeEventListener("pointerdown",this._onDown),window.removeEventListener("pointerup",this._onUp),window.removeEventListener("pointercancel",this._onUp),window.removeEventListener("pointermove",this._onMove),this._root&&this._root.contains(this._svg)&&this._root.removeChild(this._svg),this._events.clear()}colorize(e){Object.assign(this._style,e||{}),this._bg.setAttribute("fill",this._style.bg),this._xh.setAttribute("stroke",this._style.cross),this._yh.setAttribute("stroke",this._style.cross),this._knob.setAttribute("fill",this._style.handle),this._label&&this._label.setAttribute("fill",this._style.text),this._grid.setAttribute("stroke",this._style.grid),this._draw()}_localPoint(e){const s=this._svg.getBoundingClientRect();return{x:e.clientX-s.left,y:e.clientY-s.top}}_onDown(e){var i,r;(r=(i=this._svg).setPointerCapture)==null||r.call(i,e.pointerId),this._clicked=!0;const s=this._localPoint(e);this._mode==="absolute"?(this._hX.update(s),this._hY.update(s),this._batchSetFromHandles()):(this._hX.anchor=s,this._hY.anchor=s),window.addEventListener("pointermove",this._onMove,{passive:!1}),this._emit("down",{x:this._x.value,y:this._y.value}),e.preventDefault()}_onMove(e){if(!this._clicked)return;const s=this._localPoint(e);this._hX.update(s),this._hY.update(s),this._batchSetFromHandles(),e.preventDefault()}_onUp(){this._clicked&&(this._clicked=!1,window.removeEventListener("pointermove",this._onMove),this._emit("up",{x:this._x.value,y:this._y.value}))}_batchSetFromHandles(){const e=this._hX.value,s=this._hY.value,i=this._x.updateNormal(e),r=this._y.updateNormal(s);(i!==void 0||r!==void 0)&&this._emit("change",{x:this._x.value,y:this._y.value}),this._draw()}_draw(){const e=(this._w-1)*this._x.normalized,s=(this._h-1)*(1-this._y.normalized);this._xh.setAttribute("x1",e),this._xh.setAttribute("y1",0),this._xh.setAttribute("x2",e),this._xh.setAttribute("y2",this._h),this._yh.setAttribute("x1",0),this._yh.setAttribute("y1",s),this._yh.setAttribute("x2",this._w),this._yh.setAttribute("y2",s),this._knob.setAttribute("cx",e),this._knob.setAttribute("cy",s)}}T.moduleLoaded("PositionEffectsController");class $_{constructor(){this.positions={},this.currentColor=null,this.resizeObservers=[],this.effectConfigs={reverb:{containerId:"reverb-position",xParam:"decay",yParam:"roomSize",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1}},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}}},this.colorMappings={"#4a90e2":{bg:"rgba(74, 144, 226, 0.1)",handle:"#4a90e2",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#2d2d2d":{bg:"rgba(45, 45, 45, 0.1)",handle:"#2d2d2d",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#d66573":{bg:"rgba(214, 101, 115, 0.1)",handle:"#d66573",grid:"#dee2e6",cross:"#6c757d",text:"#212529"},"#68a03f":{bg:"rgba(104, 160, 63, 0.1)",handle:"#68a03f",grid:"#dee2e6",cross:"#6c757d",text:"#212529"}},T.info("PositionEffectsController","Initialized",null,"ui")}init(){return T.initStart("Position Effects Controller"),Object.entries(this.effectConfigs).forEach(([e,s])=>{this.createPositionComponent(e,s)}),this.initializeColorTracking(),this.updateColorsForCurrentSelection(),T.initSuccess("Position Effects Controller"),!0}createPositionComponent(e,s){const i=document.getElementById(s.containerId);if(!i){T.warn("PositionEffectsController",`Container not found for ${e}`,{containerId:s.containerId},"ui");return}try{const[r,a]=this.getPositionComponentSize(i),c=new B_(i,{size:[r,a],mode:"absolute",x:s.xRange.min,minX:s.xRange.min,maxX:s.xRange.max,stepX:s.xRange.step,y:s.yRange.min,minY:s.yRange.min,maxY:s.yRange.max,stepY:s.yRange.step});this.positions[e]=c,this.observePositionResize(i,c,r,a),c.on("change",({x:h,y:m})=>{this.onPositionChange(e,s.xParam,h,s.yParam,m)}),c.on("down",()=>{this.onDialInteractionStart(e)}),c.on("up",()=>{this.onDialInteractionEnd(e)}),this.loadInitialValues(e,s,c),T.debug("PositionEffectsController",`Created Position component for ${e}`,null,"ui")}catch(r){T.error("PositionEffectsController",`Failed to create Position component for ${e}`,r,"ui")}}getPositionComponentSize(e){const i=e.getBoundingClientRect();let r=(i==null?void 0:i.width)||e.clientWidth||e.offsetWidth||120,a=(i==null?void 0:i.height)||e.clientHeight||e.offsetHeight||r;return(!r||r<10)&&(r=120),(!a||a<10)&&(a=r),[Math.round(r),Math.round(a)]}observePositionResize(e,s,i,r){if(typeof ResizeObserver>"u")return;const a={currentWidth:Math.round(i)||0,currentHeight:Math.round(r)||0},c=new ResizeObserver(h=>{for(const m of h){const{width:f,height:g}=m.contentRect,y=Math.round(f),w=Math.round(g||f);!y||!w||y===a.currentWidth&&w===a.currentHeight||(a.currentWidth=y,a.currentHeight=w,s.resize(y,w))}});c.observe(e),this.resizeObservers.push(c)}loadInitialValues(e,s,i){var c;const r=(c=u.state.selectedNote)==null?void 0:c.color;if(!r){const h=s.xRange.min,m=s.yRange.min;i.x=h,i.y=m,T.debug("PositionEffectsController",`Set default values for ${e} (no color selected)`,{x:h,y:m},"ui");return}const a=$n.getEffectParameters?$n.getEffectParameters(e):null;if(a){const h=a[s.xParam]!==void 0?a[s.xParam]:s.xRange.min,m=a[s.yParam]!==void 0?a[s.yParam]:s.yRange.min;i.x=h,i.y=m,T.debug("PositionEffectsController",`Loaded values for ${e} color ${r}`,{x:h,y:m},"ui")}else{const h=s.xRange.min,m=s.yRange.min;i.x=h,i.y=m,T.debug("PositionEffectsController",`Set default values for ${e} (no effect params)`,{x:h,y:m},"ui")}}transformValue(e){return e<=1,e}isInOffZone(e,s){return e<=1&&s<=1}transformPositionValues(e,s){if(this.isInOffZone(e,s))return{x:e,y:s};const i=e<=1?Math.max(1,e):e,r=s<=1?Math.max(1,s):s;return{x:i,y:r}}onPositionChange(e,s,i,r,a){var m;if(!((m=u.state.selectedNote)==null?void 0:m.color)){T.warn("PositionEffectsController","No color selected for position change",{effectType:e,xParam:s,xValue:i,yParam:r,yValue:a},"ui");return}const h=this.transformPositionValues(i,a);T.debug("PositionEffectsController",`Position changed: ${e} ${s}=${i}->${h.x}, ${r}=${a}->${h.y}`,null,"ui"),$n.onEffectParameterChange(e,s,h.x),$n.onEffectParameterChange(e,r,h.y)}initializeColorTracking(){var e;this.currentColor=(e=u.state.selectedNote)==null?void 0:e.color,u.on("noteChanged",()=>{var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s!==this.currentColor&&(this.currentColor=s,this.updateColorsForCurrentSelection(),this.updatePositionValuesForColor())}),u.on("effectParameterChanged",({effectType:s,parameter:i,value:r,color:a})=>{T.debug("PositionEffectsController",`Effect parameter changed: ${s}.${i} = ${r} for ${a}`,null,"ui"),a===this.currentColor&&this.syncPositionFromEffects(s,i,r)}),u.on("audioEffectChanged",({effectType:s,parameter:i,value:r,color:a})=>{T.debug("PositionEffectsController",`Audio effect changed: ${s}.${i} = ${r} for ${a}`,null,"ui"),a===this.currentColor&&this.syncPositionFromEffects(s,i,r)})}updateColorsForCurrentSelection(){if(!this.currentColor||!this.colorMappings[this.currentColor])return;const e=this.colorMappings[this.currentColor];Object.values(this.positions).forEach(s=>{s&&s.colorize&&s.colorize(e)}),T.debug("PositionEffectsController",`Applied color theme for ${this.currentColor}`,e,"ui")}updatePositionValuesForColor(){this.currentColor&&Object.entries(this.effectConfigs).forEach(([e,s])=>{const i=this.positions[e];if(!i)return;const r=$n.getEffectParameters?$n.getEffectParameters(e):null;if(r){const a=r[s.xParam]!==void 0?r[s.xParam]:s.xRange.min,c=r[s.yParam]!==void 0?r[s.yParam]:s.yRange.min;i.x=a,i.y=c}})}syncPositionFromEffects(e,s,i){const r=this.positions[e],a=this.effectConfigs[e];!r||!a||(s===a.xParam?r.x=i:s===a.yParam&&(r.y=i),T.debug("PositionEffectsController",`Synced ${e}.${s} = ${i} from effects`,null,"ui"))}getPositionValues(e){const s=this.positions[e];return s?{x:s.x,y:s.y,normalized:s.normalized}:null}testPositionComponents(){T.info("PositionEffectsController","Testing Position components...",null,"ui"),Object.entries(this.positions).forEach(([e,s])=>{s?T.info("PositionEffectsController",`${e} Position component:`,{x:s.x,y:s.y,normalized:s.normalized},"ui"):T.warn("PositionEffectsController",`${e} Position component not found`,null,"ui")}),T.info("PositionEffectsController",`Current color: ${this.currentColor}`,null,"ui"),this.positions.vibrato&&(T.info("PositionEffectsController","Testing vibrato position change...",null,"ui"),this.positions.vibrato.x=75,this.positions.vibrato.y=50)}testDeadZoneElimination(){T.info("PositionEffectsController","Testing dead zone elimination...",null,"ui"),[{x:0,y:0,description:"Origin (should stay 0,0 - effect off)"},{x:.5,y:.5,description:"Inside off zone (should stay 0.5,0.5 - effect off)"},{x:1,y:1,description:"Edge of off zone (should stay 1,1 - effect off)"},{x:0,y:50,description:"X in dead zone (should become 1,50 - effect on)"},{x:50,y:0,description:"Y in dead zone (should become 50,1 - effect on)"},{x:.5,y:75,description:"X in dead zone (should become 1,75 - effect on)"},{x:25,y:.8,description:"Y in dead zone (should become 25,1 - effect on)"},{x:50,y:75,description:"Both normal (should stay 50,75 - effect on)"}].forEach(s=>{const i=this.transformPositionValues(s.x,s.y),r=this.isInOffZone(s.x,s.y);T.info("PositionEffectsController",`Test: ${s.description}`,{input:{x:s.x,y:s.y},output:i,inOffZone:r},"ui")})}onDialInteractionStart(e){var i;if(e!=="vibrato"&&e!=="tremolo")return;const s=(i=u.state.selectedNote)==null?void 0:i.color;if(!s){console.warn(" Position dial interaction started but no color selected");return}console.log(` Position dial interaction START: ${e} on ${s}`),u.emit("effectDialInteractionStart",{effectType:e,color:s}),T.debug("PositionEffectsController",`Dial interaction started for ${e} on ${s}`,null,"ui")}onDialInteractionEnd(e){var i;const s=(i=u.state.selectedNote)==null?void 0:i.color;s&&(console.log(` Position dial interaction END: ${e} on ${s}`),u.emit("effectDialInteractionEnd",{effectType:e,color:s}),T.debug("PositionEffectsController",`Dial interaction ended for ${e} on ${s}`,null,"ui"))}destroy(){Object.values(this.positions).forEach(e=>{e&&e.destroy&&e.destroy()}),this.positions={},this.resizeObservers.forEach(e=>e.disconnect()),this.resizeObservers=[],T.info("PositionEffectsController","Destroyed",null,"ui")}}const Qd=new $_,q_=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Echo Card",selector:"#timbre-panel #reverb-delay-panel .effects-content-box, #timbre-panel #echo-panel .effects-content-box"},{label:"Shake Card",selector:"#timbre-panel #vibrato-tremolo-panel .effects-content-box, #timbre-panel #shake-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],fh=new Map;let gh,qc,zc=null,Yo="",Ji=!1;function fa(n){return Number.isFinite(n)?Number(n.toFixed(1)):n}function z_(n){const e=n.getBoundingClientRect(),s=window.getComputedStyle(n);return{tag:n.tagName.toLowerCase(),id:n.id||null,class:n.className||null,top:fa(e.top),left:fa(e.left),width:fa(e.width),height:fa(e.height),offsetWidth:n.offsetWidth,offsetHeight:n.offsetHeight,scrollWidth:n.scrollWidth,scrollHeight:n.scrollHeight,clientWidth:n.clientWidth,clientHeight:n.clientHeight,display:s.display,position:s.position,overflowX:s.overflowX,overflowY:s.overflowY,transform:s.transform!=="none"?s.transform:void 0}}function vm(n="manual"){const e=window.__uiDiagnosticsTrackedElements;if(!e)return[];if(!Ji&&n!=="manual")return[];Pa();const s=[];return console.groupCollapsed(`[UI Diagnostics] ${n}`),e.forEach(i=>{const r=Array.from(document.querySelectorAll(i.selector));if(!r.length){console.warn(`${i.label}: selector "${i.selector}" not found`);return}r.forEach((a,c)=>{const h=r.length>1?`${i.label} [${c}]`:i.label,m=z_(a);console.log(h,m),s.push({label:h,selector:i.selector,info:m})})}),console.groupEnd(),window.__uiDiagnosticsLastSnapshot=s,s}function Vi(n){Ji&&(Yo=Yo?`${Yo}; ${n}`:n,zc===null&&(zc=requestAnimationFrame(()=>{const e=Yo||"auto";zc=null,Yo="",vm(e)})))}function Pa(){const n=window.__uiDiagnosticsTrackedElements;!n||!gh||n.forEach(e=>{document.querySelectorAll(e.selector).forEach(i=>{fh.has(i)||(fh.set(i,e.label),gh.observe(i),i.addEventListener("scroll",()=>Vi(`${e.label} scroll`),{passive:!0}))})})}function W_(n={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:e,autoLog:s=!1}=n;Ji=!!s,window.__uiDiagnosticsAutoLog=Ji;const i=e||q_;window.__uiDiagnosticsTrackedElements=i,gh=new ResizeObserver(r=>{const a=r.map(c=>fh.get(c.target)||c.target.id||c.target.tagName.toLowerCase()).filter(Boolean);a.length&&Vi(`Resize: ${a.join(", ")}`)}),qc=new MutationObserver(()=>Pa()),document.body?qc.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{qc.observe(document.body,{childList:!0,subtree:!0}),Pa(),Vi("init")},{once:!0}),window.addEventListener("resize",()=>Vi("window resize")),Pa(),Vi("init"),window.logUIState=(r="manual")=>vm(r),window.enableUIDiagnosticsAutoLog=()=>{Ji=!0,window.__uiDiagnosticsAutoLog=!0,Vi("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{Ji=!1,window.__uiDiagnosticsAutoLog=!1}}const vh=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function V_(n){if(n===0||!n)return"#888888";const e=Math.round(n)%12;return vh[e]}function H_(n){if(n===0||!n)return no("#888888");const e=Math.floor(n),s=n-e;if(s<0||s>=1)return V_(n);const i=e%12,r=(i+1)%12,a=no(vh[i]),c=no(vh[r]);return G_(a,c,s)}function no(n){const e=parseInt(n.slice(1),16);return[e>>16&255,e>>8&255,e&255]}function G_(n,e,s){return n.map((i,r)=>Math.round(i+s*(e[r]-i)))}function ka(n,e,s){return n===0||!n?no("#888888"):e==="shapenote"?no(s||"#4A90E2"):H_(n)}class j_{constructor(){this.canvas=null,this.ctx=null,this.animationFrameId=null,this.timeMap=[],this._lastTempo=0,this.lastValidPitch=null,this.lastValidPitchTime=0,this.fadeOutDurationMs=100,this.isFading=!1}initialize(){this.canvas=document.getElementById("playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),u.on("micPaintStateChanged",e=>this.handlePaintStateChange(e)),u.on("pitchDetected",e=>this.handlePitchDetection(e)),u.on("playbackStateChanged",()=>{u.state.paint.isMicPaintActive}))}handlePaintStateChange(e){const s=document.getElementById("hover-canvas");s&&(s.style.display=e?"none":"block"),e?this.startRendering():this.stopRendering()}handlePitchDetection(e){u.state.paint.isMicPaintActive&&u.state.isPlaying&&!u.state.isPaused&&this.addPaintAtPlayhead(e)}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}render(){if(!u.state.paint.isMicPaintActive||!this.ctx){this.animationFrameId=null;return}this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),u.state.isPlaying,u.state.isPaused,u.state.isPlaying&&u.state.isPaused,u.state.isPlaying&&!u.state.isPaused?this.renderMovingPlayhead():this.renderStationaryPlayhead(),this.animationFrameId=requestAnimationFrame(()=>this.render())}renderStationaryPlayhead(){var h,m;const{detectedPitch:e}=u.state.paint,s=performance.now();this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const i=this.midiToY(e.midi),r=i!==null,a=xt.getColumnX(2),c=xt.getCanvasWidth();if(r){this.lastValidPitch=e,this.lastValidPitchTime=s,this.isFading=!1;const{colorMode:f}=u.state.paint.paintSettings,g=(h=u.state.selectedNote)==null?void 0:h.color,y=ka(e.midi,f,g),w=`rgb(${y[0]}, ${y[1]}, ${y[2]})`;this.ctx.strokeStyle=w,this.ctx.globalAlpha=Math.min(e.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=w,this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(a,i),this.ctx.lineTo(c,i),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}else if(this.lastValidPitch&&s-this.lastValidPitchTime<this.fadeOutDurationMs){this.isFading=!0;const f=(s-this.lastValidPitchTime)/this.fadeOutDurationMs,g=this.easeOutCubic(1-f),y=this.midiToY(this.lastValidPitch.midi);if(y!==null){const{colorMode:w}=u.state.paint.paintSettings,C=(m=u.state.selectedNote)==null?void 0:m.color,A=ka(this.lastValidPitch.midi,w,C),I=`rgb(${A[0]}, ${A[1]}, ${A[2]})`;this.ctx.strokeStyle=I,this.ctx.globalAlpha=g*Math.min(this.lastValidPitch.clarity*1.2,1),this.ctx.lineWidth=4,this.ctx.shadowColor=I,this.ctx.shadowBlur=6*g,this.ctx.beginPath(),this.ctx.moveTo(a,y),this.ctx.lineTo(c,y),this.ctx.stroke(),this.ctx.shadowBlur=0,this.ctx.globalAlpha=1}}else this.isFading=!1,this.lastValidPitch=null}easeOutCubic(e){return 1-Math.pow(1-e,3)}renderMovingPlayhead(){var r;const e=this.calculateXFromTime(J.Transport.seconds);if(e===null)return;this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,this.canvas.height),this.ctx.stroke(),this.ctx.shadowBlur=0;const{detectedPitch:s}=u.state.paint,i=this.midiToY(s.midi);if(i!==null){const{colorMode:a}=u.state.paint.paintSettings,c=(r=u.state.selectedNote)==null?void 0:r.color,h=ka(s.midi,a,c),m=`rgb(${h[0]}, ${h[1]}, ${h[2]})`;this.ctx.fillStyle=m,this.ctx.strokeStyle="white",this.ctx.lineWidth=2,this.ctx.shadowColor=m,this.ctx.shadowBlur=4,this.ctx.beginPath(),this.ctx.arc(e,i,8,0,2*Math.PI),this.ctx.fill(),this.ctx.stroke(),this.ctx.shadowBlur=0}}addPaintAtPlayhead(e){if(e.midi===0)return;const s=J.Transport.seconds;Vh.addPaintPoint(s,e.midi)}buildTimeMap(){this.timeMap=[];let e=0;const s=30/u.state.tempo;for(let i=0;i<u.state.columnWidths.length;i++)this.timeMap[i]=e,e+=u.state.columnWidths[i]*s;this.timeMap.push(e)}calculateXFromTime(e){u.state.tempo!==this._lastTempo&&(this.buildTimeMap(),this._lastTempo=u.state.tempo);for(let s=0;s<this.timeMap.length-1;s++)if(e>=this.timeMap[s]&&e<this.timeMap[s+1]){const i=this.timeMap[s],r=this.timeMap[s+1]-i,a=e-i,c=xt.getColumnX(s),h=xt.getColumnX(s+1)-c;return c+(r>0?a/r*h:0)}return null}midiToY(e){if(e===0)return null;const{fullRowData:s}=u.state;if(!s||s.length===0)return null;const i=Math.min(...s.map(w=>on(w.toneNote))),r=Math.max(...s.map(w=>on(w.toneNote)));if(e<24||e>96||e<i||e>r)return null;let a=-1,c=-1,h=-999,m=999;for(let w=0;w<s.length;w++){const C=on(s[w].toneNote);C<=e&&C>h&&(a=w,h=C),C>=e&&C<m&&(c=w,m=C)}if(h===e){const w=Rt(a,u.state);return Math.max(0,Math.min(w,this.canvas.height))}if(a>=0&&c>=0&&h!==m){const w=Rt(a,u.state),C=Rt(c,u.state),A=(e-h)/(m-h),I=w+(C-w)*A;return Math.max(0,Math.min(I,this.canvas.height))}let f=0,g=Math.abs(on(s[0].toneNote)-e);for(let w=1;w<s.length;w++){const C=on(s[w].toneNote),A=Math.abs(C-e);A<g&&(g=A,f=w)}const y=Rt(f,u.state);return Math.max(0,Math.min(y,this.canvas.height))}canvasYToViewportY(e){const s=xt.getViewportInfo();return Gs.canvasToViewportY(e,s)}isCanvasYVisible(e){const s=this.canvasYToViewportY(e),i=xt.getViewportInfo();return s>=0&&s<=i.viewportHeight}}const yh=new j_;class U_{constructor(){this.canvas=null,this.ctx=null,this.isInitialized=!1,this.animationFrameId=null,this.lastHistoryLength=0}initialize(){if(this.canvas=document.getElementById("pitch-paint-canvas"),!this.canvas){T.error("PaintCanvas","Could not find #pitch-paint-canvas element",null,"paint");return}if(this.ctx=this.canvas.getContext("2d"),!document.getElementById("pitch-canvas-wrapper")){T.error("PaintCanvas","Could not find #pitch-canvas-wrapper element",null,"paint");return}u.on("paintHistoryChanged",()=>this.render()),u.on("layoutConfigChanged",()=>this.resize()),u.on("micPaintStateChanged",s=>{s?this.startRendering():this.stopRendering()}),this.resize(),this.isInitialized=!0}startRendering(){this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>this.animationLoop()))}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animationLoop(){u.state.paint.paintHistory.length!==this.lastHistoryLength&&(this.render(),this.lastHistoryLength=u.state.paint.paintHistory.length),this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}resize(){if(!this.canvas)return;const e=document.getElementById("pitch-canvas-wrapper");setTimeout(()=>{document.getElementById("pitch-grid-container");const s=68,i=u.state.cellHeight||18.35,a=s*(i/2);(this.canvas.width!==e.clientWidth||this.canvas.height!==a)&&(T.debug("PaintCanvas",`Setting pitch-paint-canvas height (DEFERRED): ${this.canvas.height}  ${a}`,null,"paint"),this.canvas.width=e.clientWidth,this.canvas.height=a,this.render())},30)}render(){if(!this.ctx)return;this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height);const e=u.state.paint.paintHistory;e.length!==0&&this.renderPaintTrail(e)}renderPaintTrail(e){if(e.length<2)return;const s=e.map(r=>{const a=yh.calculateXFromTime(r.musicalTime),c=yh.midiToY(r.midi);return a===null||c===null?null:{...r,x:a,y:c}}).filter(r=>r!==null);if(s.length<2)return;const i=u.state.paint.paintSettings.opacity/100;this.ctx.globalAlpha=i,this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let r=1;r<s.length;r++){const a=s[r-1],c=s[r];c.timestamp-a.timestamp>200||this.drawPaintSegment(a,c)}this.ctx.globalAlpha=1}drawPaintSegment(e,s){const i=this.ctx.createLinearGradient(e.x,e.y,s.x,s.y);i.addColorStop(0,`rgb(${e.color.join(",")})`),i.addColorStop(1,`rgb(${s.color.join(",")})`),this.ctx.strokeStyle=i,this.ctx.lineWidth=(e.thickness+s.thickness)/2,this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(s.x,s.y),this.ctx.stroke()}addPaintPoint(e,s){var h;const{colorMode:i}=u.state.paint.paintSettings,r=(h=u.state.selectedNote)==null?void 0:h.color,a=ka(s,i,r),c={musicalTime:e,midi:s,color:a,timestamp:performance.now(),thickness:u.state.paint.paintSettings.thickness};u.addPaintPoint(c)}clear(){u.clearPaintHistory()}}const Vh=new U_;var Wc,Jd;function X_(){if(Jd)return Wc;Jd=1;function n(e){if(this.size=e|0,this.size<=1||this.size&this.size-1)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=e<<1;for(var s=new Array(this.size*2),i=0;i<s.length;i+=2){const f=Math.PI*i/this.size;s[i]=Math.cos(f),s[i+1]=-Math.sin(f)}this.table=s;for(var r=0,a=1;this.size>a;a<<=1)r++;this._width=r%2===0?r-1:r,this._bitrev=new Array(1<<this._width);for(var c=0;c<this._bitrev.length;c++){this._bitrev[c]=0;for(var h=0;h<this._width;h+=2){var m=this._width-h-2;this._bitrev[c]|=(c>>>h&3)<<m}}this._out=null,this._data=null,this._inv=0}return Wc=n,n.prototype.fromComplexArray=function(s,i){for(var r=i||new Array(s.length>>>1),a=0;a<s.length;a+=2)r[a>>>1]=s[a];return r},n.prototype.createComplexArray=function(){const s=new Array(this._csize);for(var i=0;i<s.length;i++)s[i]=0;return s},n.prototype.toComplexArray=function(s,i){for(var r=i||this.createComplexArray(),a=0;a<r.length;a+=2)r[a]=s[a>>>1],r[a+1]=0;return r},n.prototype.completeSpectrum=function(s){for(var i=this._csize,r=i>>>1,a=2;a<r;a+=2)s[i-a]=s[a],s[i-a+1]=-s[a+1]},n.prototype.transform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._transform4(),this._out=null,this._data=null},n.prototype.realTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=0,this._realTransform4(),this._out=null,this._data=null},n.prototype.inverseTransform=function(s,i){if(s===i)throw new Error("Input and output buffers must be different");this._out=s,this._data=i,this._inv=1,this._transform4();for(var r=0;r<s.length;r++)s[r]/=this.size;this._out=null,this._data=null},n.prototype._transform4=function(){var s=this._out,i=this._csize,r=this._width,a=1<<r,c=i/a<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<i;h+=c,m++){const E=f[m];this._singleTransform2(h,E,a)}else for(h=0,m=0;h<i;h+=c,m++){const E=f[m];this._singleTransform4(h,E,a)}var g=this._inv?-1:1,y=this.table;for(a>>=2;a>=2;a>>=2){c=i/a<<1;var w=c>>>2;for(h=0;h<i;h+=c)for(var C=h+w,A=h,I=0;A<C;A+=2,I+=a){const E=A,O=E+w,P=O+w,R=P+w,q=s[E],G=s[E+1],U=s[O],j=s[O+1],Y=s[P],tt=s[P+1],ot=s[R],dt=s[R+1],yt=q,Tt=G,me=y[I],Wt=g*y[I+1],Qt=U*me-j*Wt,it=U*Wt+j*me,ht=y[2*I],ut=g*y[2*I+1],Ct=Y*ht-tt*ut,pt=Y*ut+tt*ht,Nt=y[3*I],jt=g*y[3*I+1],Bt=ot*Nt-dt*jt,ee=ot*jt+dt*Nt,Ge=yt+Ct,$t=Tt+pt,_e=yt-Ct,je=Tt-pt,Ye=Qt+Bt,Pe=it+ee,Ze=g*(Qt-Bt),Ce=g*(it-ee),Ss=Ge+Ye,ln=$t+Pe,De=Ge-Ye,xn=$t-Pe,ci=_e+Ce,hi=je-Ze,ui=_e-Ce,Sn=je+Ze;s[E]=Ss,s[E+1]=ln,s[O]=ci,s[O+1]=hi,s[P]=De,s[P+1]=xn,s[R]=ui,s[R+1]=Sn}}},n.prototype._singleTransform2=function(s,i,r){const a=this._out,c=this._data,h=c[i],m=c[i+1],f=c[i+r],g=c[i+r+1],y=h+f,w=m+g,C=h-f,A=m-g;a[s]=y,a[s+1]=w,a[s+2]=C,a[s+3]=A},n.prototype._singleTransform4=function(s,i,r){const a=this._out,c=this._data,h=this._inv?-1:1,m=r*2,f=r*3,g=c[i],y=c[i+1],w=c[i+r],C=c[i+r+1],A=c[i+m],I=c[i+m+1],E=c[i+f],O=c[i+f+1],P=g+A,R=y+I,q=g-A,G=y-I,U=w+E,j=C+O,Y=h*(w-E),tt=h*(C-O),ot=P+U,dt=R+j,yt=q+tt,Tt=G-Y,me=P-U,Wt=R-j,Qt=q-tt,it=G+Y;a[s]=ot,a[s+1]=dt,a[s+2]=yt,a[s+3]=Tt,a[s+4]=me,a[s+5]=Wt,a[s+6]=Qt,a[s+7]=it},n.prototype._realTransform4=function(){var s=this._out,i=this._csize,r=this._width,a=1<<r,c=i/a<<1,h,m,f=this._bitrev;if(c===4)for(h=0,m=0;h<i;h+=c,m++){const mi=f[m];this._singleRealTransform2(h,mi>>>1,a>>>1)}else for(h=0,m=0;h<i;h+=c,m++){const mi=f[m];this._singleRealTransform4(h,mi>>>1,a>>>1)}var g=this._inv?-1:1,y=this.table;for(a>>=2;a>=2;a>>=2){c=i/a<<1;var w=c>>>1,C=w>>>1,A=C>>>1;for(h=0;h<i;h+=c)for(var I=0,E=0;I<=A;I+=2,E+=a){var O=h+I,P=O+C,R=P+C,q=R+C,G=s[O],U=s[O+1],j=s[P],Y=s[P+1],tt=s[R],ot=s[R+1],dt=s[q],yt=s[q+1],Tt=G,me=U,Wt=y[E],Qt=g*y[E+1],it=j*Wt-Y*Qt,ht=j*Qt+Y*Wt,ut=y[2*E],Ct=g*y[2*E+1],pt=tt*ut-ot*Ct,Nt=tt*Ct+ot*ut,jt=y[3*E],Bt=g*y[3*E+1],ee=dt*jt-yt*Bt,Ge=dt*Bt+yt*jt,$t=Tt+pt,_e=me+Nt,je=Tt-pt,Ye=me-Nt,Pe=it+ee,Ze=ht+Ge,Ce=g*(it-ee),Ss=g*(ht-Ge),ln=$t+Pe,De=_e+Ze,xn=je+Ss,ci=Ye-Ce;if(s[O]=ln,s[O+1]=De,s[P]=xn,s[P+1]=ci,I===0){var hi=$t-Pe,ui=_e-Ze;s[R]=hi,s[R+1]=ui;continue}if(I!==A){var Sn=je,Jt=-Ye,Hn=$t,cn=-_e,di=-g*Ss,Mr=-g*Ce,co=-g*Ze,pi=-g*Pe,Ua=Sn+di,ho=Jt+Mr,uo=Hn+pi,Er=cn-co,Pr=h+C-I,Gn=h+w-I;s[Pr]=Ua,s[Pr+1]=ho,s[Gn]=uo,s[Gn+1]=Er}}}},n.prototype._singleRealTransform2=function(s,i,r){const a=this._out,c=this._data,h=c[i],m=c[i+r],f=h+m,g=h-m;a[s]=f,a[s+1]=0,a[s+2]=g,a[s+3]=0},n.prototype._singleRealTransform4=function(s,i,r){const a=this._out,c=this._data,h=this._inv?-1:1,m=r*2,f=r*3,g=c[i],y=c[i+r],w=c[i+m],C=c[i+f],A=g+w,I=g-w,E=y+C,O=h*(y-C),P=A+E,R=I,q=-O,G=A-E,U=I,j=O;a[s]=P,a[s+1]=0,a[s+2]=R,a[s+3]=q,a[s+4]=G,a[s+5]=0,a[s+6]=U,a[s+7]=j},Wc}var Y_=X_();const Z_=Kg(Y_);class mr{constructor(e,s){Es(this,"_inputLength");Es(this,"_fft");Es(this,"_bufferSupplier");Es(this,"_paddedInputBuffer");Es(this,"_transformBuffer");Es(this,"_inverseBuffer");if(e<1)throw new Error("Input length must be at least one");this._inputLength=e,this._fft=new Z_(K_(2*e)),this._bufferSupplier=s,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(e){return new mr(e,s=>new Float32Array(s))}static forFloat64Array(e){return new mr(e,s=>new Float64Array(s))}static forNumberArray(e){return new mr(e,s=>Array(s))}get inputLength(){return this._inputLength}autocorrelate(e,s=this._bufferSupplier(e.length)){if(e.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${e.length}`);for(let r=0;r<e.length;r++)this._paddedInputBuffer[r]=e[r];for(let r=e.length;r<this._paddedInputBuffer.length;r++)this._paddedInputBuffer[r]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const i=this._transformBuffer;for(let r=0;r<i.length;r+=2)i[r]=i[r]*i[r]+i[r+1]*i[r+1],i[r+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let r=0;r<e.length;r++)s[r]=this._inverseBuffer[2*r];return s}}function Q_(n){const e=[];let s=!1,i=-1/0,r=-1;for(let a=1;a<n.length-1;a++)n[a-1]<=0&&n[a]>0?(s=!0,r=a,i=n[a]):n[a-1]>0&&n[a]<=0?(s=!1,r!==-1&&e.push(r)):s&&n[a]>i&&(i=n[a],r=a);return e}function J_(n,e){const[s,i,r]=[n-1,n,n+1],[a,c,h]=[e[s],e[i],e[r]],m=a/2-c+h/2,f=-(a/2)*(i+r)+c*(s+r)-h/2*(s+i),g=a*i*r/2-c*s*r+h*s*i/2,y=-f/(2*m),w=m*y*y+f*y+g;return[y,w]}class fr{constructor(e,s){Es(this,"_autocorrelator");Es(this,"_nsdfBuffer");Es(this,"_clarityThreshold",.9);Es(this,"_minVolumeAbsolute",0);Es(this,"_maxInputAmplitude",1);this._autocorrelator=new mr(e,s),this._nsdfBuffer=s(e)}static forFloat32Array(e){return new fr(e,s=>new Float32Array(s))}static forFloat64Array(e){return new fr(e,s=>new Float64Array(s))}static forNumberArray(e){return new fr(e,s=>Array(s))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(e){if(!Number.isFinite(e)||e<=0||e>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=e}set minVolumeAbsolute(e){if(!Number.isFinite(e)||e<0||e>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=e}set minVolumeDecibels(e){if(!Number.isFinite(e)||e>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(e/10)}set maxInputAmplitude(e){if(!Number.isFinite(e)||e<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=e}findPitch(e,s){if(this._belowMinimumVolume(e))return[0,0];this._nsdf(e);const i=Q_(this._nsdfBuffer);if(i.length===0)return[0,0];const r=Math.max(...i.map(m=>this._nsdfBuffer[m])),a=i.find(m=>this._nsdfBuffer[m]>=this._clarityThreshold*r),[c,h]=J_(a,this._nsdfBuffer);return[s/c,Math.min(h,1)]}_belowMinimumVolume(e){if(this._minVolumeAbsolute===0)return!1;let s=0;for(let i=0;i<e.length;i++)s+=e[i]**2;return Math.sqrt(s/e.length)<this._minVolumeAbsolute}_nsdf(e){this._autocorrelator.autocorrelate(e,this._nsdfBuffer);let s=2*this._nsdfBuffer[0],i;for(i=0;i<this._nsdfBuffer.length&&s>0;i++)this._nsdfBuffer[i]=2*this._nsdfBuffer[i]/s,s-=e[i]**2+e[e.length-i-1]**2;for(;i<this._nsdfBuffer.length;i++)this._nsdfBuffer[i]=0}}function K_(n){return n--,n|=n>>1,n|=n>>2,n|=n>>4,n|=n>>8,n|=n>>16,n++,n}class tx{constructor(){this.mic=null,this.analyser=null,this.detector=null,this.animationFrameId=null,this.isInitialized=!1,this.lastLogTime=0,this.logThrottleMs=5e3,this.pitchHistory=[],this.maxHistoryLength=3,this.maxPitchJumpSemitones=24,this.maxJumpTimeMs=20,this.config={FFT_SIZE:2048,MIN_PITCH_HZ:75,MAX_PITCH_HZ:1300,MIN_VOLUME_DB:-50}}async initialize(){if(!this.isInitialized)try{await(window.initAudio||(()=>J.start()))(),this.mic=new J.UserMedia,this.analyser=new J.Analyser("waveform",this.config.FFT_SIZE),this.micGain=new J.Gain(2),this.detector=fr.forFloat32Array(this.analyser.size),this.micSplitter=new J.Gain(1),await this.mic.open(),this.mic.connect(this.micGain),this.micGain.connect(this.micSplitter),this.micSplitter.connect(this.analyser),this.isInitialized=!0}catch(e){throw console.error("PitchPaintService: Failed to initialize microphone:",e),u.setMicPaintActive(!1),e}}startDetection(){!this.isInitialized||u.state.paint.isDetecting||(u.setPaintDetectionState(!0),this.animationLoop())}stopDetection(){u.state.paint.isDetecting&&(u.setPaintDetectionState(!1),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}animationLoop(){if(!u.state.paint.isDetecting){this.animationFrameId=null;return}const e=this.analyser.getValue(),s=Math.sqrt(e.reduce((m,f)=>m+f*f,0)/e.length),i=performance.now();let r=null,a=0;if(s>1e-5)try{[r,a]=this.detector.findPitch(e,J.context.sampleRate),r==null&&(r=null),a==null&&(a=0),r&&a>.1&&i-this.lastLogTime>this.logThrottleMs&&(this.lastLogTime=i)}catch{r=null,a=0}const c=u.state.paint.paintSettings.minClarity;if(r&&a>c&&r>this.config.MIN_PITCH_HZ&&r<this.config.MAX_PITCH_HZ){const m=this.frequencyToMidi(r);if(this.isPitchJumpValid(m,i)){this.addPitchToHistory(m,i);const f=this.getSmoothedPitch(),g={frequency:r,clarity:a,midi:f,pitchClass:Math.round(f)%12,timestamp:i};u.setDetectedPitch(g)}else{const f=this.getSmoothedPitch();if(f!==null){const g={frequency:r,clarity:a,midi:f,pitchClass:Math.round(f)%12,timestamp:i};u.setDetectedPitch(g)}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i})}}else u.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i});this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}frequencyToMidi(e){return 12*Math.log2(e/440)+69}addPitchToHistory(e,s){this.pitchHistory.push({midi:e,timestamp:s}),this.pitchHistory.length>this.maxHistoryLength&&this.pitchHistory.shift()}isPitchJumpValid(e,s){if(this.pitchHistory.length===0)return!0;const i=this.pitchHistory[this.pitchHistory.length-1],r=s-i.timestamp,a=Math.abs(e-i.midi);return r>this.maxJumpTimeMs?!0:a>this.maxPitchJumpSemitones?(console.log(" [Filter] Pitch jump rejected:",a.toFixed(1),"semitones in",r.toFixed(0)+"ms"),!1):!0}getSmoothedPitch(){return this.pitchHistory.length<3?this.pitchHistory.length>0?this.pitchHistory[this.pitchHistory.length-1].midi:null:this.pitchHistory.slice(-3).map(s=>s.midi).sort((s,i)=>s-i)[1]}testMicrophoneInput(){if(!this.isInitialized)return!1;const e=this.analyser.getValue();return Math.sqrt(e.reduce((i,r)=>i+r*r,0)/e.length)>1e-4}async dispose(){this.stopDetection(),this.mic&&(this.mic.close(),this.mic=null),this.micGain&&(this.micGain.dispose(),this.micGain=null),this.micSplitter&&(this.micSplitter.dispose(),this.micSplitter=null),this.analyser=null,this.detector=null,this.isInitialized=!1}}const Ia=new tx,ex=Object.freeze(Object.defineProperty({__proto__:null,default:Ia},Symbol.toStringTag,{value:"Module"}));class sx{constructor(){this.elements={}}initialize(){this.cacheDOMElements(),this.elements.toggleBtn&&(this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",()=>this.updateUI()),u.on("paintHistoryChanged",()=>this.updateUI()),u.on("paintSettingsChanged",()=>this.updateUI()))}cacheDOMElements(){this.elements.toggleBtn=document.getElementById("mic-paint-toggle"),this.elements.clearBtn=document.getElementById("paint-clear-btn"),this.elements.thicknessSelect=document.getElementById("sidebar-trail-thickness"),this.elements.opacitySelect=document.getElementById("sidebar-trail-opacity"),this.elements.colorToggle=document.getElementById("paint-color-toggle"),this.elements.playbackToggle=document.getElementById("paint-playback-toggle")}setupEventListeners(){this.elements.toggleBtn.addEventListener("click",()=>this.handleMicPaintToggle()),this.elements.clearBtn.addEventListener("click",()=>this.handleClearPaint()),this.elements.thicknessSelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({thickness:s})}),this.elements.opacitySelect.addEventListener("change",e=>{const s=parseInt(e.target.value,10);u.setPaintSettings({opacity:s})}),this.elements.colorToggle.addEventListener("click",()=>this.handleColorToggle()),this.elements.playbackToggle.addEventListener("click",()=>this.handlePlaybackToggle())}async handleMicPaintToggle(){const e=u.state.paint.isMicPaintActive;if(this.elements.toggleBtn.disabled=!0,e)Ia.stopDetection(),u.setMicPaintActive(!1);else try{await Ia.initialize(),u.setMicPaintActive(!0),Ia.startDetection()}catch{alert("Microphone access is required for Pitch Painting. Please check your browser permissions and try again."),u.setMicPaintActive(!1)}this.elements.toggleBtn.disabled=!1}handleClearPaint(){confirm("Are you sure you want to clear the painted pitch trail? This cannot be undone.")&&Vh.clear()}handleColorToggle(){const s=u.state.paint.paintSettings.colorMode==="chromatic"?"shapenote":"chromatic";u.setPaintSettings({colorMode:s})}handlePlaybackToggle(){const e=u.state.paint.paintSettings.playbackEnabled;u.setPaintSettings({playbackEnabled:!e})}updateUI(){const{isMicPaintActive:e,paintHistory:s,paintSettings:i}=u.state.paint;if(this.elements.toggleBtn.textContent=e?"Mic Paint (ON)":"Mic Paint (OFF)",this.elements.toggleBtn.classList.toggle("active",e),this.elements.clearBtn.disabled=s.length===0,this.elements.thicknessSelect&&this.elements.thicknessSelect.value!==i.thickness.toString()&&(this.elements.thicknessSelect.value=i.thickness.toString()),this.elements.opacitySelect&&this.elements.opacitySelect.value!==i.opacity.toString()&&(this.elements.opacitySelect.value=i.opacity.toString()),this.elements.colorToggle){const r=i.colorMode==="shapenote";this.elements.colorToggle.classList.toggle("active",r)}this.elements.playbackToggle&&this.elements.playbackToggle.classList.toggle("active",i.playbackEnabled)}}const nx=new sx;T.moduleLoaded("PaintPlaybackService");class ix{constructor(){this.paintSynth=null,this.scheduledEvents=[],this.isInitialized=!1}async initialize(){if(!this.isInitialized)try{if(this.paintSynth=new J.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:0,release:.1}}),this.paintGain=new J.Gain(.3),this.paintSynth.connect(this.paintGain),window.synthEngine&&window.synthEngine.getMainVolumeNode){const e=window.synthEngine.getMainVolumeNode();e?(this.paintGain.connect(e),T.info("PaintPlaybackService","Connected to SynthEngine master chain (with limiter)")):(this.paintGain.toDestination(),T.warn("PaintPlaybackService","SynthEngine main volume node not found, connecting directly to destination"))}else this.paintGain.toDestination(),T.warn("PaintPlaybackService","SynthEngine not available, connecting directly to destination");this.isInitialized=!0,T.info("PaintPlaybackService","Initialized with sine wave synthesis")}catch(e){throw T.error("PaintPlaybackService","Failed to initialize",e),e}}midiToFrequency(e){return 440*Math.pow(2,(e-69)/12)}schedulePaintPlayback(){if(!this.isInitialized||!u.state.paint.paintSettings.playbackEnabled)return;this.clearScheduledEvents();const e=u.state.paint.paintHistory;if(!e||e.length===0){T.debug("PaintPlaybackService","No paint history to schedule");return}T.info("PaintPlaybackService",`Scheduling ${e.length} paint points for playback`),e.forEach((s,i)=>{const r=this.midiToFrequency(s.midi),a=.2,c=J.Transport.schedule(h=>{this.paintSynth&&u.state.paint.paintSettings.playbackEnabled&&(this.paintSynth.triggerAttackRelease(r,a,h),T.debug("PaintPlaybackService",`Playing paint point ${i}: ${s.midi.toFixed(2)} MIDI (${r.toFixed(1)}Hz) at time ${s.musicalTime.toFixed(2)}s`))},s.musicalTime);this.scheduledEvents.push(c)}),T.info("PaintPlaybackService",`Scheduled ${this.scheduledEvents.length} paint events`)}clearScheduledEvents(){this.scheduledEvents.forEach(e=>{J.Transport.clear(e)}),this.scheduledEvents=[],T.debug("PaintPlaybackService","Cleared all scheduled paint events")}onTransportStart(){u.state.paint.paintSettings.playbackEnabled&&this.schedulePaintPlayback()}onTransportStop(){this.clearScheduledEvents()}setPaintVolume(e){this.paintGain&&(this.paintGain.gain.value=Math.max(0,Math.min(1,e)))}getPaintVolume(){return this.paintGain?this.paintGain.gain.value:.3}async dispose(){this.clearScheduledEvents(),this.paintSynth&&(this.paintSynth.dispose(),this.paintSynth=null),this.paintGain&&(this.paintGain.dispose(),this.paintGain=null),this.isInitialized=!1,T.info("PaintPlaybackService","Disposed")}}const Kd=new ix;class ox{constructor(){this.currentTool=null,this.toolButtons=null,this.optionsContainer=null,this.lastSelectedNote=null,this.settings={arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}}}initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.optionsContainer=document.getElementById("draw-tool-options"),!this.toolButtons.length||!this.optionsContainer){console.warn("[DrawTools] Could not find draw tool elements");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),u.on("noteChanged",({newNote:e})=>{this.lastSelectedNote=e,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(e=>{e.addEventListener("click",()=>{const s=e.dataset.drawTool;this.selectTool(s)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(s=>{s.addEventListener("click",()=>{s.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(u.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),u.setSelectedTool("note")):u.state.selectedNote&&(u.setSelectedNote(u.state.selectedNote.shape,u.state.selectedNote.color),u.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(e=>e.classList.remove("active")),this.currentTool=null,this.optionsContainer.innerHTML="",Ut.setTool(null,null)}selectTool(e){this.toolButtons.forEach(i=>i.classList.remove("active"));const s=Array.from(this.toolButtons).find(i=>i.dataset.drawTool===e);s&&s.classList.add("active"),this.currentTool=e,this.renderToolOptions(e),Ut.setTool(e,this.settings),u.state.selectedNote=null}renderToolOptions(e){switch(e){case"arrow":this.renderArrowOptions();break;case"text":this.renderTextOptions();break;case"marker":this.renderMarkerOptions();break;case"highlighter":this.renderHighlighterOptions();break;case"lasso":this.renderLassoOptions();break;default:this.optionsContainer.innerHTML=""}}renderArrowOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="stroke-weight" title="Stroke Weight">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${Math.min(this.settings.arrow.strokeWeight,5)}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="line-style" title="Line Style">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="${this.getLineDashArray()}">
                        <line x1="4" y1="12" x2="20" y2="12"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="start-arrowhead" title="Start Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.startArrowhead,"left")}
                </button>
                <button class="draw-toolbar-button draw-swap-button" data-action="swap-endpoints" title="Swap endpoints">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="17,1 21,5 17,9"></polyline>
                        <path d="M3,11V9A4,4 0 0,1 7,5H21"></path>
                        <polyline points="7,23 3,19 7,15"></polyline>
                        <path d="M21,13v2a4,4 0 0,1 -4,4H3"></path>
                    </svg>
                </button>
                <button class="draw-toolbar-button" data-popup="end-arrowhead" title="End Arrowhead">
                    ${this.getArrowheadIcon(this.settings.arrow.endArrowhead,"right")}
                </button>
            </div>
        `,this.attachArrowToolbarListeners()}getLineDashArray(){switch(this.settings.arrow.lineStyle){case"solid":return"0";case"dashed-big":return"8,4";case"dashed-small":return"4,2";case"dotted":return"1,2";default:return"0"}}getArrowheadIcon(e,s){const i=s==="left";switch(e){case"none":return`<svg width="20" height="20" viewBox="0 0 24 24"><line x1="${i?20:4}" y1="12" x2="${i?4:20}" y2="12" stroke="currentColor" stroke-width="2"/></svg>`;case"unfilled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?4:20}" y2="12"/>
                    <polyline points="${i?"10,6 4,12 10,18":"14,6 20,12 14,18"}"/>
                </svg>`;case"filled-arrow":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?8:16}" y2="12"/>
                    <polygon points="${i?"4,12 10,6 10,18":"20,12 14,6 14,18"}"/>
                </svg>`;case"circle":return`<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="${i?20:4}" y1="12" x2="${i?8:16}" y2="12"/>
                    <circle cx="${i?4:20}" cy="12" r="3"/>
                </svg>`;default:return""}}attachArrowToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(i=>{i.addEventListener("click",r=>{const a=i.dataset.popup;this.showPopupMenu(a,i)})});const s=this.optionsContainer.querySelector('[data-action="swap-endpoints"]');s&&s.addEventListener("click",()=>{const i=this.settings.arrow.startArrowhead;this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=i,this.renderArrowOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()})}showPopupMenu(e,s){const i=document.querySelector(".draw-popup-menu");i&&i.remove();const r=document.createElement("div");r.className="draw-popup-menu";let a="";switch(e){case"stroke-weight":const f=this.settings.arrow.strokeWeight,g=2,y=4,w=7;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-stroke-slider"
                            min="1"
                            max="10"
                            value="${f}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${f===g?"active":""}" data-value="${g}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===y?"active":""}" data-value="${y}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="4"/></svg>
                            </button>
                            <button class="draw-popup-option ${f===w?"active":""}" data-value="${w}">
                                <svg width="30" height="30" viewBox="0 0 30 30"><circle cx="15" cy="15" r="12" fill="none" stroke="currentColor" stroke-width="6"/></svg>
                            </button>
                        </div>
                    </div>
                `;break;case"line-style":a=`
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="solid"?"active":""}" data-value="solid">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-big"?"active":""}" data-value="dashed-big">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="6,3"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dashed-small"?"active":""}" data-value="dashed-small">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="3,2"/></svg>
                    </button>
                    <button class="draw-popup-option ${this.settings.arrow.lineStyle==="dotted"?"active":""}" data-value="dotted">
                        <svg width="30" height="20" viewBox="0 0 30 20"><line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2" stroke-dasharray="1,2"/></svg>
                    </button>
                `;break;case"start-arrowhead":case"end-arrowhead":const C=e==="start-arrowhead",A=C?this.settings.arrow.startArrowhead:this.settings.arrow.endArrowhead;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <div style="margin-bottom: 8px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Size
                        </div>
                        <input type="range"
                            class="draw-arrowhead-size-slider"
                            min="8"
                            max="24"
                            value="${this.settings.arrow.arrowheadSize}"
                            style="width: 100%; margin-bottom: 12px;">
                        <div style="margin-bottom: 6px; font-size: 0.85em; color: var(--c-text);">
                            Arrowhead Style
                        </div>
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${A==="none"?"active":""}" data-value="none">
                                <svg width="30" height="20" viewBox="0 0 30 20"><line x1="5" y1="10" x2="25" y2="10" stroke="currentColor" stroke-width="2"/></svg>
                            </button>
                            <button class="draw-popup-option ${A==="unfilled-arrow"?"active":""}" data-value="unfilled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${C?25:5}" y1="10" x2="${C?10:20}" y2="10"/>
                                    <polyline points="${C?"10,5 5,10 10,15":"20,5 25,10 20,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="filled-arrow"?"active":""}" data-value="filled-arrow">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="currentColor" stroke="currentColor" stroke-width="2">
                                    <line x1="${C?25:5}" y1="10" x2="${C?12:18}" y2="10"/>
                                    <polygon points="${C?"5,10 12,5 12,15":"25,10 18,5 18,15"}"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${A==="circle"?"active":""}" data-value="circle">
                                <svg width="30" height="20" viewBox="0 0 30 20" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="${C?25:5}" y1="10" x2="${C?10:20}" y2="10"/>
                                    <circle cx="${C?5:25}" cy="10" r="4"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;break}r.innerHTML=a,document.body.appendChild(r);const c=s.getBoundingClientRect();r.style.position="absolute",r.style.top=`${c.bottom+5}px`,r.style.left=`${c.left}px`;const h=r.querySelector(".draw-stroke-slider");h&&h.addEventListener("input",f=>{const g=Number(f.target.value);this.settings.arrow.strokeWeight=g,this.renderArrowOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()});const m=r.querySelector(".draw-arrowhead-size-slider");m&&m.addEventListener("input",f=>{const g=Number(f.target.value);this.settings.arrow.arrowheadSize=g,Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()}),r.querySelectorAll(".draw-popup-option").forEach(f=>{f.addEventListener("click",()=>{const g=f.dataset.value;e==="stroke-weight"?(this.settings.arrow.strokeWeight=Number(g),h&&(h.value=g)):e==="line-style"?this.settings.arrow.lineStyle=g:e==="start-arrowhead"?this.settings.arrow.startArrowhead=g:e==="end-arrowhead"&&(this.settings.arrow.endArrowhead=g),this.renderArrowOptions(),r.remove(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()})}),setTimeout(()=>{const f=g=>{!r.contains(g.target)&&!s.contains(g.target)&&(r.remove(),document.removeEventListener("click",f))};document.addEventListener("click",f)},0)}renderTextOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="text-color" title="Text Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.text.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-action="decrease-size" title="Decrease Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;"></span>
                </button>
                <div style="min-width: 35px; text-align: center; font-size: 0.85em; color: var(--c-text);">
                    ${this.settings.text.size}px
                </div>
                <button class="draw-toolbar-button" data-action="increase-size" title="Increase Font Size">
                    <span style="font-weight: bold; font-size: 1.2em;">+</span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.background?"active":""}" data-action="toggle-background" title="Background Fill">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="${this.settings.text.background?"currentColor":"none"}" stroke="currentColor" stroke-width="2">
                        <rect x="4" y="4" width="16" height="16" rx="2"/>
                    </svg>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.superscript?"active":""}" data-action="toggle-superscript" title="Superscript">
                    <span style="font-size: 0.85em;">x<sup style="font-size: 0.7em;">2</sup></span>
                </button>
                <button class="draw-toolbar-button ${this.settings.text.subscript?"active":""}" data-action="toggle-subscript" title="Subscript">
                    <span style="font-size: 0.85em;">x<sub style="font-size: 0.7em;">2</sub></span>
                </button>
            </div>
        `,this.attachCommonToolbarListeners();const e=this.optionsContainer.querySelector('[data-action="decrease-size"]');e&&e.addEventListener("click",()=>{const c=Math.max(8,this.settings.text.size-2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected())});const s=this.optionsContainer.querySelector('[data-action="increase-size"]');s&&s.addEventListener("click",()=>{const c=Math.min(72,this.settings.text.size+2);c!==this.settings.text.size&&(this.settings.text.size=c,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected())});const i=this.optionsContainer.querySelector('[data-action="toggle-background"]');i&&i.addEventListener("click",()=>{this.settings.text.background=!this.settings.text.background,this.renderTextOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()});const r=this.optionsContainer.querySelector('[data-action="toggle-superscript"]');r&&(r.addEventListener("mousedown",c=>{c.preventDefault()}),r.addEventListener("click",()=>{Ut.applyInlineFormatting("superscript")}));const a=this.optionsContainer.querySelector('[data-action="toggle-subscript"]');a&&(a.addEventListener("mousedown",c=>{c.preventDefault()}),a.addEventListener("click",()=>{Ut.applyInlineFormatting("subscript")}))}renderMarkerOptions(){this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="marker-color" title="Marker Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${this.settings.marker.color}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="marker-size" title="Marker Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.marker.size==="small"?"1":this.settings.marker.size==="medium"?"3":"5"}">
                        <circle cx="12" cy="12" r="8"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderHighlighterOptions(){const e=(s,i)=>{const r=parseInt(s.slice(1,3),16),a=parseInt(s.slice(3,5),16),c=parseInt(s.slice(5,7),16);return`rgba(${r}, ${a}, ${c}, ${i})`};this.optionsContainer.innerHTML=`
            <div class="draw-toolbar-row">
                <button class="draw-toolbar-button" data-popup="highlighter-color" title="Highlighter Color">
                    <div style="width: 16px; height: 16px; border-radius: 50%; background-color: ${e(this.settings.highlighter.color,.4)}; border: 2px solid var(--c-border);"></div>
                </button>
                <button class="draw-toolbar-button" data-popup="highlighter-size" title="Highlighter Size">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${this.settings.highlighter.size==="small"?"2":this.settings.highlighter.size==="medium"?"4":"6"}">
                        <rect x="6" y="8" width="12" height="8" rx="1"/>
                    </svg>
                </button>
            </div>
        `,this.attachCommonToolbarListeners()}renderLassoOptions(){this.optionsContainer.innerHTML=`
            <div style="padding: var(--space-2); text-align: center;">
                <p style="color: var(--c-text-muted); font-size: var(--font-size-sm); margin: 0;">
                    Draw around notes to select and drag them as a group.
                </p>
            </div>
        `}attachCommonToolbarListeners(){this.optionsContainer.querySelectorAll("[data-popup]").forEach(s=>{s.addEventListener("click",()=>{const i=s.dataset.popup;this.showCommonPopupMenu(i,s)})})}showCommonPopupMenu(e,s){const i=document.querySelector(".draw-popup-menu");i&&i.remove();const r=document.createElement("div");r.className="draw-popup-menu";let a="",c="",h="";if(e.startsWith("text-")?(c="text",h=e.replace("text-","")):e.startsWith("marker-")?(c="marker",h=e.replace("marker-","")):e.startsWith("highlighter-")&&(c="highlighter",h=e.replace("highlighter-","")),h==="color"){const g=c==="text"?["#4a90e2","#2d2d2d","#d66573","#68a03f"]:["#4a90e2","#2d2d2d","#d66573","#68a03f","#ffc107"],y=c==="highlighter";a=g.map(w=>{const C=y?this.hexToRgba(w,.4):w;return`
                    <button class="draw-popup-option ${this.settings[c].color===w?"active":""}" data-value="${w}">
                        <div style="width: 24px; height: 24px; border-radius: 50%; background-color: ${C};"></div>
                    </button>
                `}).join("")}else if(h==="size")if(c==="text")a=`
                    <button class="draw-popup-option ${this.settings.text.size===12?"active":""}" data-value="12">
                        <span style="font-size: 0.8em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===16?"active":""}" data-value="16">
                        <span style="font-size: 1em; font-weight: bold;">A</span>
                    </button>
                    <button class="draw-popup-option ${this.settings.text.size===20?"active":""}" data-value="20">
                        <span style="font-size: 1.2em; font-weight: bold;">A</span>
                    </button>
                `;else{const g=c==="marker"?1:5,y=c==="marker"?15:30,w=this.settings[c].size,C=c==="marker"?3:8,A=c==="marker"?6:15,I=c==="marker"?10:22;a=`
                    <div style="padding: 8px; min-width: 180px;">
                        <input type="range"
                            class="draw-size-slider"
                            min="${g}"
                            max="${y}"
                            value="${w}"
                            style="width: 100%; margin-bottom: 8px;">
                        <div style="display: flex; gap: 4px; justify-content: center;">
                            <button class="draw-popup-option ${w===C?"active":""}" data-value="${C}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===A?"active":""}" data-value="${A}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="4"/>
                                </svg>
                            </button>
                            <button class="draw-popup-option ${w===I?"active":""}" data-value="${I}">
                                <svg width="30" height="20" viewBox="0 0 30 20">
                                    <line x1="2" y1="10" x2="28" y2="10" stroke="currentColor" stroke-width="6"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `}r.innerHTML=a,document.body.appendChild(r);const m=s.getBoundingClientRect();r.style.position="absolute",r.style.top=`${m.bottom+5}px`,r.style.left=`${m.left}px`;const f=r.querySelector(".draw-size-slider");f&&f.addEventListener("input",g=>{const y=Number(g.target.value);this.settings[c].size=y,c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected()}),r.querySelectorAll(".draw-popup-option").forEach(g=>{g.addEventListener("click",()=>{const y=g.dataset.value;h==="color"?this.settings[c].color=y:h==="size"&&(this.settings[c].size=Number(y),f&&(f.value=y)),c==="text"?this.renderTextOptions():c==="marker"?this.renderMarkerOptions():c==="highlighter"&&this.renderHighlighterOptions(),Ut.setTool(this.currentTool,this.settings),Ut.applyCurrentSettingsToSelected(),r.remove()})}),setTimeout(()=>{const g=y=>{!r.contains(y.target)&&!s.contains(y.target)&&(r.remove(),document.removeEventListener("click",g))};document.addEventListener("click",g)},0)}hexToRgba(e,s){const i=parseInt(e.slice(1,3),16),r=parseInt(e.slice(3,5),16),a=parseInt(e.slice(5,7),16);return`rgba(${i}, ${r}, ${a}, ${s})`}getCurrentTool(){return this.currentTool}getCurrentSettings(){return this.currentTool?this.settings[this.currentTool]:null}}const tp=new ox;class rx{constructor(){this.meter=null,this.isInitialized=!1,this.meterWrapper=null,this.meterPlaceholder=null,this.meterSource=null,this.settingsPanel=null,this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.permissionState="unknown",this.errorMessage=null}initialize(){this.isInitialized||(this.cacheDOMElements(),this.setupEventListeners(),this.updateUI(),u.on("micPaintStateChanged",e=>this.handlePitchPaintingToggle(e)),this.isInitialized=!0)}cacheDOMElements(){this.meterWrapper=document.getElementById("mic-meter-wrapper"),this.meterPlaceholder=document.getElementById("meter-placeholder"),this.settingsPanel=document.getElementById("meter-settings-panel"),this.settingsBtn=document.getElementById("meter-settings-btn"),this.sizeSelect=document.getElementById("meter-size-select"),this.fpsSelect=document.getElementById("meter-fps-select"),this.batterySaverCheckbox=document.getElementById("meter-battery-saver"),this.calibrateBtn=document.getElementById("meter-calibrate-btn"),this.resetBtn=document.getElementById("meter-reset-btn"),this.meterWrapper}setupEventListeners(){this.settingsBtn&&this.settingsBtn.addEventListener("click",()=>this.toggleSettingsPanel()),this.sizeSelect&&this.sizeSelect.addEventListener("change",e=>this.handleSizeChange(e.target.value)),this.fpsSelect&&this.fpsSelect.addEventListener("change",e=>this.handleFpsChange(parseInt(e.target.value))),this.batterySaverCheckbox&&this.batterySaverCheckbox.addEventListener("change",e=>this.handleBatterySaverChange(e.target.checked)),this.calibrateBtn&&this.calibrateBtn.addEventListener("click",()=>this.handleAutoCalibrate()),this.resetBtn&&this.resetBtn.addEventListener("click",()=>this.handleReset())}async handlePitchPaintingToggle(e){e?await this.startMeter():this.stopMeter()}async startMeter(){if(!this.meter)try{await this.ensureMicrophoneAccess();const e=J.context;if(!e||e.state==="suspended")throw new Error("Audio context not available or suspended");await this.createMeterFromExistingMic(),this.updateUI()}catch(e){this.handleMeterError(e)}}async ensureMicrophoneAccess(){this.permissionState="pending",this.updateUI();try{this.permissionState="granted"}catch{throw this.permissionState="denied",new Error("Microphone access denied. Please check your browser permissions.")}}async createMeterFromExistingMic(){if(!this.meterWrapper)throw new Error("Meter wrapper not found - cannot create meter");this.meterWrapper.innerHTML="";const e=this.getMeterDimensions(),s=(await gr(async()=>{const{default:r}=await import("./Meter-Ccaw6VeE.js");return{default:r}},[])).default,i=(await gr(async()=>{const{default:r}=await Promise.resolve().then(()=>ex);return{default:r}},void 0)).default;if(!i||!i.micSplitter)throw new Error("PitchPaintService microphone splitter not available");try{this.meter=new s({target:this.meterWrapper,size:e,fps:this.settings.fps,colors:{fill:"#1a1a1a",accent:"#00ff88"},floorDb:this.settings.noiseFloor,ceilingDb:5})}catch(r){throw r}try{this.meter.connect(i.micSplitter),this.meterSource=i.micSplitter}catch(r){throw r}this.meterWrapper.classList.add("active"),this.meterWrapper.classList.remove("error")}stopMeter(){this.meter&&(this.meter.disconnect(),this.meter.destroy(),this.meter=null),this.meterSource&&(this.meterSource=null),this.meterWrapper.innerHTML=`
      <div class="meter-placeholder" id="meter-placeholder">
      </div>
    `,this.meterPlaceholder=document.getElementById("meter-placeholder"),this.meterWrapper.classList.remove("active"),this.updateUI()}getMeterDimensions(){const e=this.meterWrapper.clientWidth||200,s=this.meterWrapper.clientHeight||100;if(this.meterWrapper.classList.contains("mic-meter-wrapper-inline"))return[e,36];if(this.meterWrapper.classList.contains("mic-meter-wrapper-vertical"))return[e,s];const a=this.settings.size==="compact"?48:72;return[e,a]}updateUI(){if(this.meterWrapper){if(this.meterWrapper.classList.remove("compact","wide"),this.meterWrapper.classList.add(this.settings.size),this.updateAccessibilityAttributes(),this.meterPlaceholder){let e="",s="";const i=this.meterWrapper.classList.contains("mic-meter-wrapper-inline");this.permissionState==="denied"?(e=i?"Mic access denied":"Microphone access denied. Click to retry.",s="error"):this.permissionState==="pending"?(e=i?"Requesting access...":"Requesting microphone access...",s="pending"):u.state.paint.isMicPaintActive?this.meter?(e="",s="active"):(e=i?"Starting...":"Starting meter...",s="pending"):(e="",s="disabled");const r=this.meterPlaceholder.querySelector(".meter-status-text");r&&(r.textContent=e),this.meterWrapper.classList.remove("error","pending","disabled"),s&&this.meterWrapper.classList.add(s)}this.updateSettingsUI()}}updateAccessibilityAttributes(){this.meterWrapper&&(this.meterWrapper.setAttribute("role","meter"),this.meterWrapper.setAttribute("aria-label","Microphone Level Meter"),this.meter&&this.meter.active?(this.meterWrapper.setAttribute("aria-valuenow","0"),this.meterWrapper.setAttribute("aria-valuemin",this.settings.noiseFloor.toString()),this.meterWrapper.setAttribute("aria-valuemax","5"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level active")):(this.meterWrapper.removeAttribute("aria-valuenow"),this.meterWrapper.removeAttribute("aria-valuemin"),this.meterWrapper.removeAttribute("aria-valuemax"),this.meterWrapper.setAttribute("aria-valuetext","Microphone level inactive")),window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches&&this.meterWrapper.setAttribute("data-reduced-motion","true"))}updateSettingsUI(){this.sizeSelect&&(this.sizeSelect.value=this.settings.size),this.fpsSelect&&(this.fpsSelect.value=this.settings.fps),this.batterySaverCheckbox&&(this.batterySaverCheckbox.checked=this.settings.batterySaver)}toggleSettingsPanel(){this.settingsPanel&&this.settingsPanel.classList.toggle("hidden")}handleSizeChange(e){if(this.settings.size=e,this.meter){const s=this.getMeterDimensions();this.meter.resize(s[0],s[1])}this.updateUI()}handleFpsChange(e){this.settings.fps=e}handleBatterySaverChange(e){this.settings.batterySaver=e}async handleAutoCalibrate(){if(this.meter){this.calibrateBtn.disabled=!0,this.calibrateBtn.textContent="Stay quiet...";try{await new Promise(e=>setTimeout(e,2e3)),this.settings.noiseFloor=-65,this.settings.autoCalibrated=!0,this.calibrateBtn.textContent="Calibrated ",setTimeout(()=>{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1},1500)}catch{this.calibrateBtn.textContent="Auto-Calibrate",this.calibrateBtn.disabled=!1}}}handleReset(){if(this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.updateSettingsUI(),this.meter){const e=this.getMeterDimensions();this.meter.resize(e[0],e[1])}}handleMeterError(e){this.errorMessage=e.message,this.meterWrapper.classList.add("error"),(e.message.includes("denied")||e.message.includes("permission"))&&this.showPermissionRetryPrompt(),this.updateUI()}showPermissionRetryPrompt(){let e=this.meterWrapper.querySelector(".meter-permission-prompt");if(!e){e=document.createElement("div"),e.className="meter-permission-prompt",e.innerHTML=`
        <p>Microphone access is required for the level meter.</p>
        <button class="meter-retry-btn">Grant Permission</button>
        <button class="meter-help-btn">Help</button>
      `,this.meterWrapper.appendChild(e);const s=e.querySelector(".meter-retry-btn"),i=e.querySelector(".meter-help-btn");s.addEventListener("click",()=>this.retryPermission()),i.addEventListener("click",()=>this.showPermissionHelp())}}async retryPermission(){try{const e=this.meterWrapper.querySelector(".meter-permission-prompt");e&&e.remove(),this.permissionState="unknown",this.meterWrapper.classList.remove("error"),u.state.paint.isMicPaintActive&&await this.startMeter()}catch(e){this.handleMeterError(e)}}showPermissionHelp(){alert(`
To enable the microphone level meter:

1. Look for a microphone icon in your browser's address bar
2. Click it and select "Allow"
3. If you don't see the icon, go to your browser settings:
   - Chrome: Settings > Privacy and security > Site Settings > Microphone
   - Firefox: Settings > Privacy & Security > Permissions > Microphone
   - Safari: Settings > Websites > Microphone

4. Find this website and set it to "Allow"
5. Refresh the page if needed
    `)}dispose(){this.stopMeter(),this.isInitialized=!1}}const ax=new rx;class lx{constructor(){this.element=null,this.isVisible=!1,this.hideTimeout=null}initialize(){this.element=document.createElement("div"),this.element.className="zoom-indicator",this.element.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        `,document.body.appendChild(this.element),u.on("zoomIn",()=>this.show()),u.on("zoomOut",()=>this.show())}show(){if(!this.element)return;let e=100,s="";if(xt.getViewportInfo){const i=xt.getViewportInfo();if(e=Math.round(i.zoomLevel*100),i.canSeeFullRange)s=" (Full Range)";else{const r=i.startRank||i.startRow,a=i.endRank||i.endRow;s=` (~${Math.floor(a-r+1)} semitones)`}}this.element.textContent=`Zoom: ${e}%${s}`,this.element.style.opacity="1",this.isVisible=!0,clearTimeout(this.hideTimeout),this.hideTimeout=setTimeout(()=>this.hide(),2e3)}hide(){!this.element||!this.isVisible||(this.element.style.opacity="0",this.isVisible=!1,clearTimeout(this.hideTimeout))}dispose(){this.element&&(document.body.removeChild(this.element),this.element=null),clearTimeout(this.hideTimeout)}}const cx=new lx,ym={enableModulationTool(){u.setSelectedTool("modulation"),console.log("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),console.log("[MODULATION TEST] Click marker labels to toggle 2:3  3:2"),console.log("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const e=this.findNearestGridLine(200),s=this.findMeasureIndexForX(e.x),i=u.addModulationMarker(s,Is.COMPRESSION_2_3,e.x,e.columnIndex);return console.log("[MODULATION TEST] Added test marker at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",200,")"),i},addTestMarker2(){const e=this.findNearestGridLine(400),s=this.findMeasureIndexForX(e.x),i=u.addModulationMarker(s,Is.EXPANSION_3_2,e.x,e.columnIndex);return console.log("[MODULATION TEST] Added test marker 2 at measure",s,"columnIndex=",e.columnIndex,"x=",e.x,"(snapped from",400,")"),i},findNearestGridLine(n){const e=u.state;let s=0,i=0,r=1/0,a=0;for(let c=0;c<e.columnWidths.length;c++){const h=Math.abs(a-n);h<r&&(r=h,i=a,s=c);const m=e.columnWidths[c]||0;a+=m*e.cellWidth}return console.log("[MODULATION TEST] findNearestGridLine:",{targetX:n,closestColumnIndex:s,closestX:i,minDistance:r}),{columnIndex:s,x:i}},findMeasureIndexForX(n){const e=u.state.cellWidth||40,s=5,i=Math.round(n/e);return Math.max(1,Math.round(i/s))},clearAllMarkers(){[...u.state.modulationMarkers||[]].forEach(e=>{u.removeModulationMarker(e.id)}),console.log("[MODULATION TEST] Cleared all markers")},testMapping(){const n=u.state.baseMicrobeatPx||u.state.cellWidth||40;if(console.log("[MODULATION TEST] Base microbeat pixels:",n),console.log("[MODULATION TEST] Modulation markers:",u.state.modulationMarkers),window.getModulationMapping){const e=window.getModulationMapping();console.log("[MODULATION TEST] Coordinate mapping:",e),[0,100,200,300,400,500].forEach(i=>{const r=e.canvasXToMicrobeat(i),a=e.microbeatToCanvasX(r);console.log(`[MODULATION TEST] x=${i}  microbeat=${r.toFixed(3)}  x=${a.toFixed(1)}`)})}},testVisualExpansion(){console.log("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const n=this.addTestMarker2();console.log("[MODULATION TEST] Added 3:2 expansion marker:",n),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show expansion after x=400"),console.log("[MODULATION TEST] Container should be wider to accommodate expansion"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){console.log("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const n=this.addTestMarker();console.log("[MODULATION TEST] Added 2:3 compression marker:",n),typeof window<"u"&&window.LayoutService&&(console.log("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{console.log("[MODULATION TEST] Grid should now show compression after x=200"),console.log("[MODULATION TEST] Container should adjust to accommodate compression"),console.log("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){console.log("[MODULATION TEST] Current state:",{selectedTool:u.state.selectedTool,modulationMarkers:u.state.modulationMarkers,baseMicrobeatPx:u.state.baseMicrobeatPx,cellWidth:u.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=ym);function hx(){cx.initialize(),document.addEventListener("keydown",n=>{const e=document.activeElement.tagName.toLowerCase();["input","textarea"].includes(e)||((n.ctrlKey||n.metaKey)&&(n.key==="+"||n.key==="=")&&(n.preventDefault(),u.emit("zoomIn")),(n.ctrlKey||n.metaKey)&&n.key==="-"&&(n.preventDefault(),u.emit("zoomOut")),(n.ctrlKey||n.metaKey)&&n.key==="0"&&(n.preventDefault(),xt.resetZoom&&xt.resetZoom()))})}function ux(){window.debugZoom={info:()=>xt.getViewportInfo?xt.getViewportInfo():"Viewport info not available",zoomTo:n=>{T.debug("Debug Tools",`Setting zoom to ${n}`,null,"zoom")},scrollTo:n=>{if(T.debug("Debug Tools",`Scrolling to position ${n}`,null,"scroll"),xt.scroll){const s=xt.getViewportInfo().scrollPosition*(u.state.fullRowData.length*u.state.cellHeight*.5),i=n*(u.state.fullRowData.length*u.state.cellHeight*.5);xt.scroll(i-s)}},goToNote:n=>{xt.scrollToNote?xt.scrollToNote(n):T.warn("Debug Tools",`scrollToNote not available. Requested: ${n}`,null,"debug")}}}let ep=!1,Zo=null;window.initAudio=async()=>ep?!0:Zo||(Zo=(async()=>{try{return J.context.state!=="running"&&(await J.start(),T.info("Main.js","AudioContext started successfully")),ep=!0,!0}catch(n){return T.error("Main.js","Could not start AudioContext",n),Zo=null,!1}})(),Zo);let sp=!1;const io=()=>{sp||(sp=!0,window.initAudio().catch(n=>console.warn("Failed to initialize audio:",n)),document.removeEventListener("click",io,!0),document.removeEventListener("keydown",io,!0),document.removeEventListener("touchstart",io,!0))};document.addEventListener("click",io,!0);document.addEventListener("keydown",io,!0);document.addEventListener("touchstart",io,!0);const oo={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,initialized:!1};function en(n){oo[n]=!0}function Qo(n,e=5e3){return new Promise((s,i)=>{if(oo[n]){s();return}const r=Date.now(),a=()=>{oo[n]?s():Date.now()-r>e?i(new Error(`Component ${n} not ready within ${e}ms`)):setTimeout(a,50)};a()})}document.addEventListener("DOMContentLoaded",async()=>{window.initStartTime=Date.now(),T.info("Main.js","DOMContentLoaded event fired"),T.section("STARTING INITIALIZATION");try{(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&jp(),ri.init(),en("domCache"),(()=>{const h=ri.get("appContainer")||document.getElementById("app-container");h&&["click","keydown","touchstart"].forEach(f=>{h.addEventListener(f,window.initAudio,{once:!0})})})(),lb(u.state);const e=u.state.pitchRange||{topIndex:0,bottomIndex:Xe.length-1},s=Math.max(0,Math.min(Xe.length-1,e.topIndex??0)),i=Math.max(s,Math.min(Xe.length-1,e.bottomIndex??Xe.length-1));u.state.pitchRange={topIndex:s,bottomIndex:i},u.state.fullRowData=Xe.slice(s,i+1);const r=xt.init();en("layoutService"),Ph.setContexts(r),en("canvasContextService"),Gt.init(),en("synthEngine"),sn.initialize().catch(h=>{console.warn("[INIT] RhythmPlaybackService initialization deferred (needs user interaction):",h)}),en("rhythmPlaybackService"),Ui.init(),en("transportService"),ob(),ub(),await Qo("layoutService"),await Qo("canvasContextService"),pb.init(),en("scrollSync"),Pd(u.state,"core-services-initialization"),await Qo("scrollSync"),Bb.init(),Bc.init(),x_.init(),$h.init(),ja.init(),en("uiComponents"),await Qo("uiComponents"),m_(),E0(),y_(),en("audioComponents"),Pd(u.state,"audio-components-initialization"),dx(),T.initStart("Static Waveform Visualizer"),T_()?T.initSuccess("Static Waveform Visualizer"):T.initFailed("Static Waveform Visualizer");const{default:a}=await gr(async()=>{const{default:h}=await Promise.resolve().then(()=>L_);return{default:h}},void 0);window.effectsCoordinator=a,T.initStart("Effects Managers"),Yd.init(),Zd.init(),a.init(),$n.init(),Qd.init(),window.animationEffectsManager=Yd,window.audioEffectsManager=Zd,window.effectsController=$n,window.positionEffectsController=Qd,T.initSuccess("Effects Managers"),T.initStart("Paint components"),Vh.initialize(),yh.initialize(),nx.initialize(),await Kd.initialize(),window.PaintPlaybackService=Kd,ax.initialize(),T.initSuccess("Paint components"),T.initStart("Draw Tools"),Ut.initialize(),tp.initialize(),window.drawToolsController=tp,window.annotationService=Ut,T.initSuccess("Draw Tools"),T.initStart("Drum components"),Vn.initialize(),T.initSuccess("Drum components"),hx(),ux(),await Qo("audioComponents"),T.section("SETTING UP STATE SUBSCRIPTIONS");const c=()=>{oo.uiComponents&&(Bc.renderPitchGrid(),Bc.renderDrumGrid(),Ut.resize())};u.on("notesChanged",()=>{c()}),u.on("stampPlacementsChanged",()=>{c()}),u.on("tripletPlacementsChanged",()=>{c()}),u.on("modulationMarkersChanged",()=>{if(T.event("Main","modulationMarkersChanged event received, recalculating layout",null,"state"),!oo.layoutService){T.warn("Main","LayoutService not ready, skipping layout recalculation");return}xt.recalculateLayout(),T.debug("Main","Layout recalculated for modulation, calling renderAll()",null,"state"),c(),T.debug("Main","renderAll() completed, calling renderMacrobeatTools() for modulation",null,"state"),Yi.renderMacrobeatTools(),T.debug("Main","modulationMarkersChanged handling complete",null,"state")}),u.on("rhythmStructureChanged",()=>{T.event("Main","rhythmStructureChanged event received, recalculating layout",null,"state"),xt.recalculateLayout(),T.debug("Main","Layout recalculated, calling renderAll()",null,"state"),c(),T.debug("Main","renderAll() completed, calling renderMacrobeatTools()",null,"state"),Yi.renderMacrobeatTools(),T.debug("Main","rhythmStructureChanged handling complete",null,"state")}),u.on("layoutConfigChanged",()=>{c(),Yi.renderMacrobeatTools()}),u.on("zoomIn",()=>{T.event("Main","Zoom in event received",null,"zoom"),xt.zoomIn()}),u.on("zoomOut",()=>{T.event("Main","Zoom out event received",null,"zoom"),xt.zoomOut()}),T.section("PERFORMING INITIAL RENDER"),u.setSelectedTool("note"),u.setSelectedNote("circle","#4a90e2"),c(),Yi.renderMacrobeatTools(),W_(),en("initialized"),T.section("INITIALIZATION COMPLETE"),window.ModulationTest=ym,setTimeout(()=>{xt.getViewportInfo},1e3)}catch(n){console.error("[INIT]  INITIALIZATION FAILED:",n),console.error("[INIT] Error stack:",n.stack),console.error("[INIT] Component readiness at failure:",oo),T.error("Main.js","Initialization failed",n);const e=document.createElement("div");e.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,e.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${n.message}</pre>
                <pre>Stack: ${n.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(e)}});function dx(){const n=document.querySelector(".rhythm-stamps-container"),e=document.querySelector(".rhythm-tab-sidebar");document.querySelector(".rhythm-tab-content");const s=document.querySelectorAll(".rhythm-tab-button"),i=document.querySelectorAll(".rhythm-tab-panel");n&&window.getComputedStyle(n),e&&window.getComputedStyle(e),!(!s.length||!i.length)&&s.forEach((r,a)=>{r.addEventListener("click",c=>{const h=r.getAttribute("data-rhythm-tab");s.forEach(f=>f.classList.remove("active")),i.forEach(f=>f.classList.remove("active")),r.classList.add("active");const m=document.getElementById(`${h}-panel`);m&&m.classList.add("active")})})}
