var yb=Object.defineProperty;var Cb=(s,t,e)=>t in s?yb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var Q=(s,t,e)=>Cb(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const A of document.querySelectorAll('link[rel="modulepreload"]'))i(A);new MutationObserver(A=>{for(const r of A)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&i(a)}).observe(document,{childList:!0,subtree:!0});function e(A){const r={};return A.integrity&&(r.integrity=A.integrity),A.referrerPolicy&&(r.referrerPolicy=A.referrerPolicy),A.crossOrigin==="use-credentials"?r.credentials="include":A.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(A){if(A.ep)return;A.ep=!0;const r=e(A);fetch(A.href,r)}})();function bb(s){return s&&s.__esModule&&Object.prototype.hasOwnProperty.call(s,"default")?s.default:s}var Rl={exports:{}};/*! For license information please see Tone.js.LICENSE.txt */var _b=Rl.exports,Qm;function xb(){return Qm||(Qm=1,(function(s,t){(function(e,i){s.exports=i()})(typeof self<"u"?self:_b,(()=>(()=>{var e={871:function(a,l,u){(function(h,m,g,w){var C=function(J,st,At){return{endTime:st,insertTime:At,type:"exponentialRampToValue",value:J}},y=function(J,st,At){return{endTime:st,insertTime:At,type:"linearRampToValue",value:J}},E=function(J,st){return{startTime:st,type:"setValue",value:J}},x=function(J,st,At){return{duration:At,startTime:st,type:"setValueCurve",values:J}},T=function(J,st,At){var vt=At.startTime,ft=At.target,Mt=At.timeConstant;return ft+(st-ft)*Math.exp((vt-J)/Mt)},U=function(J){return J.type==="exponentialRampToValue"},H=function(J){return J.type==="linearRampToValue"},R=function(J){return U(J)||H(J)},D=function(J){return J.type==="setValue"},P=function(J){return J.type==="setValueCurve"},G=function J(st,At,vt,ft){var Mt=st[At];return Mt===void 0?ft:R(Mt)||D(Mt)?Mt.value:P(Mt)?Mt.values[Mt.values.length-1]:T(vt,J(st,At-1,Mt.startTime,ft),Mt)},Y=function(J,st,At,vt,ft){return At===void 0?[vt.insertTime,ft]:R(At)?[At.endTime,At.value]:D(At)?[At.startTime,At.value]:P(At)?[At.startTime+At.duration,At.values[At.values.length-1]]:[At.startTime,G(J,st-1,At.startTime,ft)]},W=function(J){return J.type==="cancelAndHold"},at=function(J){return J.type==="cancelScheduledValues"},Bt=function(J){return W(J)||at(J)?J.cancelTime:U(J)||H(J)?J.endTime:J.startTime},dt=function(J,st,At,vt){var ft=vt.endTime,Mt=vt.value;return At===Mt?Mt:0<At&&0<Mt||At<0&&Mt<0?At*Math.pow(Mt/At,(J-st)/(ft-st)):0},X=function(J,st,At,vt){return At+(J-st)/(vt.endTime-st)*(vt.value-At)},nt=function(J,st){var At=st.duration,vt=st.startTime,ft=st.values;return(function(Mt,Pt){var Nt=Math.floor(Pt),Wt=Math.ceil(Pt);return Nt===Wt?Mt[Nt]:(1-(Pt-Nt))*Mt[Nt]+(1-(Wt-Pt))*Mt[Wt]})(ft,(J-vt)/At*(ft.length-1))},mt=function(J){return J.type==="setTarget"},ct=(function(){return w((function J(st){g(this,J),this._automationEvents=[],this._currenTime=0,this._defaultValue=st}),[{key:Symbol.iterator,value:function(){return this._automationEvents[Symbol.iterator]()}},{key:"add",value:function(J){var st=Bt(J);if(W(J)||at(J)){var At=this._automationEvents.findIndex((function($t){return at(J)&&P($t)?$t.startTime+$t.duration>=st:Bt($t)>=st})),vt=this._automationEvents[At];if(At!==-1&&(this._automationEvents=this._automationEvents.slice(0,At)),W(J)){var ft=this._automationEvents[this._automationEvents.length-1];if(vt!==void 0&&R(vt)){if(ft!==void 0&&mt(ft))throw new Error("The internal list is malformed.");var Mt=ft===void 0?vt.insertTime:P(ft)?ft.startTime+ft.duration:Bt(ft),Pt=ft===void 0?this._defaultValue:P(ft)?ft.values[ft.values.length-1]:ft.value,Nt=U(vt)?dt(st,Mt,Pt,vt):X(st,Mt,Pt,vt),Wt=U(vt)?C(Nt,st,this._currenTime):y(Nt,st,this._currenTime);this._automationEvents.push(Wt)}if(ft!==void 0&&mt(ft)&&this._automationEvents.push(E(this.getValue(st),st)),ft!==void 0&&P(ft)&&ft.startTime+ft.duration>st){var Qt=st-ft.startTime,Et=(ft.values.length-1)/ft.duration,zt=Math.max(2,1+Math.ceil(Qt*Et)),oe=Qt/(zt-1)*Et,ge=ft.values.slice(0,zt);if(oe<1)for(var re=1;re<zt;re+=1){var Re=oe*re%1;ge[re]=ft.values[re-1]*(1-Re)+ft.values[re]*Re}this._automationEvents[this._automationEvents.length-1]=x(ge,ft.startTime,Qt)}}}else{var ae=this._automationEvents.findIndex((function($t){return Bt($t)>st})),bs=ae===-1?this._automationEvents[this._automationEvents.length-1]:this._automationEvents[ae-1];if(bs!==void 0&&P(bs)&&Bt(bs)+bs.duration>st)return!1;var Qn=U(J)?C(J.value,J.endTime,this._currenTime):H(J)?y(J.value,st,this._currenTime):J;if(ae===-1)this._automationEvents.push(Qn);else{if(P(J)&&st+J.duration>Bt(this._automationEvents[ae]))return!1;this._automationEvents.splice(ae,0,Qn)}}return!0}},{key:"flush",value:function(J){var st=this._automationEvents.findIndex((function(ft){return Bt(ft)>J}));if(st>1){var At=this._automationEvents.slice(st-1),vt=At[0];mt(vt)&&At.unshift(E(G(this._automationEvents,st-2,vt.startTime,this._defaultValue),vt.startTime)),this._automationEvents=At}}},{key:"getValue",value:function(J){if(this._automationEvents.length===0)return this._defaultValue;var st=this._automationEvents.findIndex((function(ge){return Bt(ge)>J})),At=this._automationEvents[st],vt=(st===-1?this._automationEvents.length:st)-1,ft=this._automationEvents[vt];if(ft!==void 0&&mt(ft)&&(At===void 0||!R(At)||At.insertTime>J))return T(J,G(this._automationEvents,vt-1,ft.startTime,this._defaultValue),ft);if(ft!==void 0&&D(ft)&&(At===void 0||!R(At)))return ft.value;if(ft!==void 0&&P(ft)&&(At===void 0||!R(At)||ft.startTime+ft.duration>J))return J<ft.startTime+ft.duration?nt(J,ft):ft.values[ft.values.length-1];if(ft!==void 0&&R(ft)&&(At===void 0||!R(At)))return ft.value;if(At!==void 0&&U(At)){var Mt=Y(this._automationEvents,vt,ft,At,this._defaultValue),Pt=m(Mt,2),Nt=Pt[0],Wt=Pt[1];return dt(J,Nt,Wt,At)}if(At!==void 0&&H(At)){var Qt=Y(this._automationEvents,vt,ft,At,this._defaultValue),Et=m(Qt,2),zt=Et[0],oe=Et[1];return X(J,zt,oe,At)}return this._defaultValue}}])})();h.AutomationEventList=ct,h.createCancelAndHoldAutomationEvent=function(J){return{cancelTime:J,type:"cancelAndHold"}},h.createCancelScheduledValuesAutomationEvent=function(J){return{cancelTime:J,type:"cancelScheduledValues"}},h.createExponentialRampToValueAutomationEvent=function(J,st){return{endTime:st,type:"exponentialRampToValue",value:J}},h.createLinearRampToValueAutomationEvent=function(J,st){return{endTime:st,type:"linearRampToValue",value:J}},h.createSetTargetAutomationEvent=function(J,st,At){return{startTime:st,target:J,timeConstant:At,type:"setTarget"}},h.createSetValueAutomationEvent=E,h.createSetValueCurveAutomationEvent=x})(l,u(821),u(805),u(989))},113:a=>{a.exports=function(l,u){(u==null||u>l.length)&&(u=l.length);for(var h=0,m=new Array(u);h<u;h++)m[h]=l[h];return m},a.exports.__esModule=!0,a.exports.default=a.exports},569:a=>{a.exports=function(l){if(Array.isArray(l))return l},a.exports.__esModule=!0,a.exports.default=a.exports},805:a=>{a.exports=function(l,u){if(!(l instanceof u))throw new TypeError("Cannot call a class as a function")},a.exports.__esModule=!0,a.exports.default=a.exports},989:(a,l,u)=>{var h=u(498);function m(g,w){for(var C=0;C<w.length;C++){var y=w[C];y.enumerable=y.enumerable||!1,y.configurable=!0,"value"in y&&(y.writable=!0),Object.defineProperty(g,h(y.key),y)}}a.exports=function(g,w,C){return w&&m(g.prototype,w),C&&m(g,C),Object.defineProperty(g,"prototype",{writable:!1}),g},a.exports.__esModule=!0,a.exports.default=a.exports},474:a=>{a.exports=function(l,u){var h=l==null?null:typeof Symbol<"u"&&l[Symbol.iterator]||l["@@iterator"];if(h!=null){var m,g,w,C,y=[],E=!0,x=!1;try{if(w=(h=h.call(l)).next,u===0){if(Object(h)!==h)return;E=!1}else for(;!(E=(m=w.call(h)).done)&&(y.push(m.value),y.length!==u);E=!0);}catch(T){x=!0,g=T}finally{try{if(!E&&h.return!=null&&(C=h.return(),Object(C)!==C))return}finally{if(x)throw g}}return y}},a.exports.__esModule=!0,a.exports.default=a.exports},18:a=>{a.exports=function(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)},a.exports.__esModule=!0,a.exports.default=a.exports},821:(a,l,u)=>{var h=u(569),m=u(474),g=u(744),w=u(18);a.exports=function(C,y){return h(C)||m(C,y)||g(C,y)||w()},a.exports.__esModule=!0,a.exports.default=a.exports},327:(a,l,u)=>{var h=u(564).default;a.exports=function(m,g){if(h(m)!="object"||!m)return m;var w=m[Symbol.toPrimitive];if(w!==void 0){var C=w.call(m,g||"default");if(h(C)!="object")return C;throw new TypeError("@@toPrimitive must return a primitive value.")}return(g==="string"?String:Number)(m)},a.exports.__esModule=!0,a.exports.default=a.exports},498:(a,l,u)=>{var h=u(564).default,m=u(327);a.exports=function(g){var w=m(g,"string");return h(w)=="symbol"?w:w+""},a.exports.__esModule=!0,a.exports.default=a.exports},564:a=>{function l(u){return a.exports=l=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(h){return typeof h}:function(h){return h&&typeof Symbol=="function"&&h.constructor===Symbol&&h!==Symbol.prototype?"symbol":typeof h},a.exports.__esModule=!0,a.exports.default=a.exports,l(u)}a.exports=l,a.exports.__esModule=!0,a.exports.default=a.exports},744:(a,l,u)=>{var h=u(113);a.exports=function(m,g){if(m){if(typeof m=="string")return h(m,g);var w=Object.prototype.toString.call(m).slice(8,-1);return w==="Object"&&m.constructor&&(w=m.constructor.name),w==="Map"||w==="Set"?Array.from(m):w==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(w)?h(m,g):void 0}},a.exports.__esModule=!0,a.exports.default=a.exports}},i={};function A(a){var l=i[a];if(l!==void 0)return l.exports;var u=i[a]={exports:{}};return e[a].call(u.exports,u,u.exports,A),u.exports}A.d=(a,l)=>{for(var u in l)A.o(l,u)&&!A.o(a,u)&&Object.defineProperty(a,u,{enumerable:!0,get:l[u]})},A.o=(a,l)=>Object.prototype.hasOwnProperty.call(a,l),A.r=a=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(a,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(a,"__esModule",{value:!0})};var r={};return(()=>{A.r(r),A.d(r,{AMOscillator:()=>Kr,AMSynth:()=>Uu,Abs:()=>mm,Add:()=>Ji,AmplitudeEnvelope:()=>zA,Analyser:()=>ao,AudioToGain:()=>Wa,AutoFilter:()=>Gu,AutoPanner:()=>qu,AutoWah:()=>zu,BaseContext:()=>yu,BiquadFilter:()=>$r,BitCrusher:()=>$u,Buffer:()=>gb,BufferSource:()=>vb,Buffers:()=>wb,Channel:()=>sA,Chebyshev:()=>Yu,Chorus:()=>Ju,Clock:()=>HA,Compressor:()=>ni,Context:()=>UA,Convolver:()=>Ch,CrossFade:()=>$A,DCMeter:()=>dh,Delay:()=>zs,Destination:()=>ab,Distortion:()=>Zu,Draw:()=>db,DuoSynth:()=>Pu,EQ3:()=>yh,Emitter:()=>MA,Envelope:()=>hs,FFT:()=>hh,FMOscillator:()=>KA,FMSynth:()=>Du,FatOscillator:()=>Gr,FeedbackCombFilter:()=>jr,FeedbackDelay:()=>th,Filter:()=>Xs,Follower:()=>Ao,Freeverb:()=>sh,Frequency:()=>HC,FrequencyClass:()=>xs,FrequencyEnvelope:()=>Xr,FrequencyShifter:()=>eh,Gain:()=>Tt,GainToAudio:()=>gm,Gate:()=>gh,GrainPlayer:()=>Qu,GreaterThan:()=>qa,GreaterThanZero:()=>Ga,IntervalTimeline:()=>hm,JCReverb:()=>nh,LFO:()=>Ss,Limiter:()=>wh,Listener:()=>ub,Loop:()=>eo,LowpassCombFilter:()=>Zr,Master:()=>lb,MembraneSynth:()=>Yr,Merge:()=>bi,MetalSynth:()=>ku,Meter:()=>uh,MidSideCompressor:()=>vh,MidSideMerge:()=>oo,MidSideSplit:()=>ro,Midi:()=>KC,MidiClass:()=>OA,Mono:()=>ph,MonoSynth:()=>tA,MultibandCompressor:()=>Bh,MultibandSplit:()=>lo,Multiply:()=>Fe,Negate:()=>Mu,Noise:()=>yi,NoiseSynth:()=>Lu,Offline:()=>WC,OfflineContext:()=>PA,OmniOscillator:()=>ti,OnePoleFilter:()=>Jr,Oscillator:()=>Se,PWMOscillator:()=>qr,PanVol:()=>ja,Panner:()=>io,Panner3D:()=>mh,Param:()=>Lt,Part:()=>so,Pattern:()=>Wu,Phaser:()=>rh,PingPongDelay:()=>ih,PitchShift:()=>Ah,Player:()=>qA,Players:()=>Iu,PluckSynth:()=>Ou,PolySynth:()=>Vu,Pow:()=>VA,PulseOscillator:()=>GA,Recorder:()=>Ja,Reverb:()=>oh,Sampler:()=>to,Scale:()=>ei,ScaleExp:()=>za,Sequence:()=>Ku,Signal:()=>Dt,Solo:()=>Ne,Split:()=>eA,StateTimeline:()=>LA,StereoWidener:()=>ah,Subtract:()=>Zi,SyncedSignal:()=>XC,Synth:()=>Ci,Ticks:()=>GC,TicksClass:()=>Ee,Time:()=>kC,TimeClass:()=>Gs,Timeline:()=>Ks,ToneAudioBuffer:()=>te,ToneAudioBuffers:()=>NA,ToneAudioNode:()=>ht,ToneBufferSource:()=>Bi,ToneEvent:()=>Pn,ToneOscillatorNode:()=>Wr,Transport:()=>rb,TransportTime:()=>NC,TransportTimeClass:()=>qe,Tremolo:()=>lh,Unit:()=>l,UserMedia:()=>Vr,Vibrato:()=>ch,Volume:()=>Jn,WaveShaper:()=>Bn,Waveform:()=>fh,Zero:()=>Ka,connect:()=>Es,connectSeries:()=>qs,connectSignal:()=>Or,context:()=>pb,dbToGain:()=>DA,debug:()=>a,defaultArg:()=>sn,disconnect:()=>_u,fanIn:()=>OC,ftom:()=>wi,gainToDb:()=>Nr,getContext:()=>Be,getDestination:()=>cb,getDraw:()=>fb,getListener:()=>hb,getTransport:()=>ob,immediate:()=>Ab,intervalToFrequencyRatio:()=>kA,isArray:()=>ls,isBoolean:()=>pu,isDefined:()=>Kt,isFunction:()=>nm,isNote:()=>Lr,isNumber:()=>Vs,isObject:()=>Yn,isString:()=>gn,isUndef:()=>Ps,loaded:()=>mb,mtof:()=>Cu,now:()=>ib,optionsFromArguments:()=>rt,setContext:()=>Ha,start:()=>DC,supported:()=>IC,version:()=>u});var a={};A.r(a),A.d(a,{assert:()=>It,assertContextRunning:()=>mu,assertRange:()=>cs,assertUsedScheduleTime:()=>rm,enterScheduledCallback:()=>gu,log:()=>om,setLogger:()=>QC,warn:()=>TA});var l={};A.r(l);const u="15.0.4";var h=A(871);const m=new WeakSet,g=new WeakMap,w=new WeakMap,C=new WeakMap,y=new WeakMap,E=new WeakMap,x=new WeakMap,T=new WeakMap,U=new WeakMap,H=new WeakMap,R={construct:()=>R},D=/^import(?:(?:[\s]+[\w]+|(?:[\s]+[\w]+[\s]*,)?[\s]*\{[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?(?:[\s]*,[\s]*[\w]+(?:[\s]+as[\s]+[\w]+)?)*[\s]*}|(?:[\s]+[\w]+[\s]*,)?[\s]*\*[\s]+as[\s]+[\w]+)[\s]+from)?(?:[\s]*)("([^"\\]|\\.)+"|'([^'\\]|\\.)+')(?:[\s]*);?/,P=(p,n)=>{const o=[];let c=p.replace(/^[\s]+/,""),f=c.match(D);for(;f!==null;){const v=f[1].slice(1,-1),B=f[0].replace(/([\s]+)?;?$/,"").replace(v,new URL(v,n).toString());o.push(B),c=c.slice(f[0].length).replace(/^[\s]+/,""),f=c.match(D)}return[o.join(";"),c]},G=p=>{if(p!==void 0&&!Array.isArray(p))throw new TypeError("The parameterDescriptors property of given value for processorCtor is not an array.")},Y=p=>{if(!(n=>{try{new new Proxy(n,R)}catch{return!1}return!0})(p))throw new TypeError("The given value for processorCtor should be a constructor.");if(p.prototype===null||typeof p.prototype!="object")throw new TypeError("The given value for processorCtor should have a prototype.")},W=(p,n)=>{const o=p.get(n);if(o===void 0)throw new Error("A value with the given key could not be found.");return o},at=(p,n)=>{const o=Array.from(p).filter(n);if(o.length>1)throw Error("More than one element was found.");if(o.length===0)throw Error("No element was found.");const[c]=o;return p.delete(c),c},Bt=(p,n,o,c)=>{const f=W(p,n),v=at(f,(B=>B[0]===o&&B[1]===c));return f.size===0&&p.delete(n),v},dt=p=>W(x,p),X=p=>{if(m.has(p))throw new Error("The AudioNode is already stored.");m.add(p),dt(p).forEach((n=>n(!0)))},nt=p=>"port"in p,mt=p=>{if(!m.has(p))throw new Error("The AudioNode is not stored.");m.delete(p),dt(p).forEach((n=>n(!1)))},ct=(p,n)=>{!nt(p)&&n.every((o=>o.size===0))&&mt(p)},J={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",fftSize:2048,maxDecibels:-30,minDecibels:-100,smoothingTimeConstant:.8},st=(p,n)=>p.context===n,At=p=>{try{p.copyToChannel(new Float32Array(1),0,-1)}catch{return!1}return!0},vt=()=>new DOMException("","IndexSizeError"),ft=p=>{var n;p.getChannelData=(n=p.getChannelData,o=>{try{return n.call(p,o)}catch(c){throw c.code===12?vt():c}})},Mt={numberOfChannels:1},Pt=-34028234663852886e22,Nt=-Pt,Wt=p=>m.has(p),Qt={buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1},Et=p=>W(g,p),zt=p=>W(C,p),oe=(p,n)=>{const{activeInputs:o}=Et(p);o.forEach((f=>f.forEach((([v])=>{n.includes(p)||oe(v,[...n,p])}))));const c=(f=>"playbackRate"in f)(p)?[p.playbackRate]:nt(p)?Array.from(p.parameters.values()):(f=>"frequency"in f&&"gain"in f)(p)?[p.Q,p.detune,p.frequency,p.gain]:(f=>"offset"in f)(p)?[p.offset]:(f=>!("frequency"in f)&&"gain"in f)(p)?[p.gain]:(f=>"detune"in f&&"frequency"in f)(p)?[p.detune,p.frequency]:(f=>"pan"in f)(p)?[p.pan]:[];for(const f of c){const v=zt(f);v!==void 0&&v.activeInputs.forEach((([B])=>oe(B,n)))}Wt(p)&&mt(p)},ge=p=>{oe(p.destination,[])},re=p=>"context"in p,Re=p=>re(p[0]),ae=(p,n,o,c)=>{for(const f of p)if(o(f)){if(c)return!1;throw Error("The set contains at least one similar element.")}return p.add(n),!0},bs=(p,n,[o,c],f)=>{ae(p,[n,o,c],(v=>v[0]===n&&v[1]===o),f)},Qn=(p,[n,o,c],f)=>{const v=p.get(n);v===void 0?p.set(n,new Set([[o,c]])):ae(v,[o,c],(B=>B[0]===o),f)},$t=p=>"inputs"in p,Me=(p,n,o,c)=>{if($t(n)){const f=n.inputs[c];return p.connect(f,o,0),[f,o,0]}return p.connect(n,o,c),[n,o,c]},Ms=(p,n,o)=>{for(const c of p)if(c[0]===n&&c[1]===o)return p.delete(c),c;return null},os=(p,n)=>{if(!dt(p).delete(n))throw new Error("Missing the expected event listener.")},BA=(p,n,o)=>{const c=W(p,n),f=at(c,(v=>v[0]===o));return c.size===0&&p.delete(n),f},di=(p,n,o,c)=>{$t(n)?p.disconnect(n.inputs[c],o,0):p.disconnect(n,o,c)},de=p=>W(w,p),qi=p=>W(y,p),Xn=p=>T.has(p),yA=p=>!m.has(p),xa=(p,n)=>new Promise((o=>{if(n!==null)o(!0);else{const c=p.createScriptProcessor(256,1,1),f=p.createGain(),v=p.createBuffer(1,2,44100),B=v.getChannelData(0);B[0]=1,B[1]=1;const _=p.createBufferSource();_.buffer=v,_.loop=!0,_.connect(c).connect(p.destination),_.connect(f),_.disconnect(f),c.onaudioprocess=S=>{const F=S.inputBuffer.getChannelData(0);Array.prototype.some.call(F,(I=>I===1))?o(!0):o(!1),_.stop(),c.onaudioprocess=null,_.disconnect(c),c.disconnect(p.destination)},_.start()}})),Tr=(p,n)=>{const o=new Map;for(const c of p)for(const f of c){const v=o.get(f);o.set(f,v===void 0?1:v+1)}o.forEach(((c,f)=>n(f,c)))},CA=p=>"context"in p,eu=p=>{const n=new Map;p.connect=(o=>(c,f=0,v=0)=>{const B=CA(c)?o(c,f,v):o(c,f),_=n.get(c);return _===void 0?n.set(c,[{input:v,output:f}]):_.every((S=>S.input!==v||S.output!==f))&&_.push({input:v,output:f}),B})(p.connect.bind(p)),p.disconnect=(o=>(c,f,v)=>{if(o.apply(p),c===void 0)n.clear();else if(typeof c=="number")for(const[B,_]of n){const S=_.filter((F=>F.output!==c));S.length===0?n.delete(B):n.set(B,S)}else if(n.has(c))if(f===void 0)n.delete(c);else{const B=n.get(c);if(B!==void 0){const _=B.filter((S=>S.output!==f&&(S.input!==v||v===void 0)));_.length===0?n.delete(c):n.set(c,_)}}for(const[B,_]of n)_.forEach((S=>{CA(B)?p.connect(B,S.output,S.input):p.connect(B,S.output)}))})(p.disconnect)},Ir=(p,n,o,c,f)=>{const[v,B]=((_,S,F,I)=>{const{activeInputs:M,passiveInputs:k}=Et(S),L=Ms(M[I],_,F);return L===null?[Bt(k,_,F,I)[2],!1]:[L[2],!0]})(p,o,c,f);if(v!==null&&(os(p,v),!B||n||Xn(p)||di(de(p),de(o),c,f)),Wt(o)){const{activeInputs:_}=Et(o);ct(o,_)}},Qr=(p,n,o,c)=>{const[f,v]=((B,_,S)=>{const{activeInputs:F,passiveInputs:I}=zt(_),M=Ms(F,B,S);return M===null?[BA(I,B,S)[1],!1]:[M[2],!0]})(p,o,c);f!==null&&(os(p,f),!v||n||Xn(p)||de(p).disconnect(qi(o),c))};class Ea{constructor(n){this._map=new Map(n)}get size(){return this._map.size}entries(){return this._map.entries()}forEach(n,o=null){return this._map.forEach(((c,f)=>n.call(o,c,f,this)))}get(n){return this._map.get(n)}has(n){return this._map.has(n)}keys(){return this._map.keys()}values(){return this._map.values()}}const Sa={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:1,numberOfOutputs:1,parameterData:{},processorOptions:{}};function zi(p,n,o,c,f){if(typeof p.copyFromChannel=="function")n[o].byteLength===0&&(n[o]=new Float32Array(128)),p.copyFromChannel(n[o],c,f);else{const v=p.getChannelData(c);if(n[o].byteLength===0)n[o]=v.slice(f,f+128);else{const B=new Float32Array(v.buffer,f*Float32Array.BYTES_PER_ELEMENT,128);n[o].set(B)}}}const bA=(p,n,o,c,f)=>{typeof p.copyToChannel=="function"?n[o].byteLength!==0&&p.copyToChannel(n[o],c,f):n[o].byteLength!==0&&p.getChannelData(c).set(n[o],f)},Fa=(p,n)=>{const o=[];for(let c=0;c<p;c+=1){const f=[],v=typeof n=="number"?n:n[c];for(let B=0;B<v;B+=1)f.push(new Float32Array(128));o.push(f)}return o},qy=async(p,n,o,c,f,v,B)=>{const _=n===null?128*Math.ceil(p.context.length/128):n.length,S=c.channelCount*c.numberOfInputs,F=f.reduce(((N,z)=>N+z),0),I=F===0?null:o.createBuffer(F,_,o.sampleRate);if(v===void 0)throw new Error("Missing the processor constructor.");const M=Et(p),k=await((N,z)=>{const q=W(H,N),O=de(z);return W(q,O)})(o,p),L=Fa(c.numberOfInputs,c.channelCount),K=Fa(c.numberOfOutputs,f),V=Array.from(p.parameters.keys()).reduce(((N,z)=>({...N,[z]:new Float32Array(128)})),{});for(let N=0;N<_;N+=128){if(c.numberOfInputs>0&&n!==null)for(let z=0;z<c.numberOfInputs;z+=1)for(let q=0;q<c.channelCount;q+=1)zi(n,L[z],q,q,N);v.parameterDescriptors!==void 0&&n!==null&&v.parameterDescriptors.forEach((({name:z},q)=>{zi(n,V,z,S+q,N)}));for(let z=0;z<c.numberOfInputs;z+=1)for(let q=0;q<f[z];q+=1)K[z][q].byteLength===0&&(K[z][q]=new Float32Array(128));try{const z=L.map(((O,it)=>M.activeInputs[it].size===0?[]:O)),q=B(N/o.sampleRate,o.sampleRate,(()=>k.process(z,K,V)));if(I!==null)for(let O=0,it=0;O<c.numberOfOutputs;O+=1){for(let lt=0;lt<f[O];lt+=1)bA(I,K[O],lt,it+lt,N);it+=f[O]}if(!q)break}catch(z){p.dispatchEvent(new ErrorEvent("processorerror",{colno:z.colno,filename:z.filename,lineno:z.lineno,message:z.message}));break}}return I},zy={Q:1,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:350,gain:0,type:"lowpass"},$y={channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6},Xy={channelCount:6,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:6},Yy={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",offset:1},jy={buffer:null,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",disableNormalization:!1},vp=p=>{const{port1:n,port2:o}=new MessageChannel;return new Promise((c=>{const f=()=>{o.onmessage=null,n.close(),o.close(),c()};o.onmessage=()=>f();try{n.postMessage(p,[p])}catch{}finally{f()}}))},Jy={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",delayTime:0,maxDelayTime:1},Ta=(p,n,o)=>{const c=n[o];if(c===void 0)throw p();return c},Zy={attack:.003,channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",knee:30,ratio:12,release:.25,threshold:-24},t0={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",gain:1},ts=()=>new DOMException("","InvalidStateError"),Ia=()=>new DOMException("","InvalidAccessError"),e0={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers"},Bp=(p,n,o,c,f,v,B,_,S,F,I)=>{const M=F.length;let k=_;for(let L=0;L<M;L+=1){let K=o[0]*F[L];for(let V=1;V<f;V+=1){const N=k-V&S-1;K+=o[V]*v[N],K-=p[V]*B[N]}for(let V=f;V<c;V+=1)K+=o[V]*v[k-V&S-1];for(let V=f;V<n;V+=1)K-=p[V]*B[k-V&S-1];v[k]=F[L],B[k]=K,k=k+1&S-1,I[L]=K}return k},s0={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers"},Mr=p=>{const n=new Uint32Array([1179011410,40,1163280727,544501094,16,131073,44100,176400,1048580,1635017060,4,0]);try{const o=p.decodeAudioData(n.buffer,(()=>{}));return o!==void 0&&(o.catch((()=>{})),!0)}catch{}return!1},xe=(p,n,o)=>{const c=n[o];c!==void 0&&c!==p[o]&&(p[o]=c)},$e=(p,n)=>{xe(p,n,"channelCount"),xe(p,n,"channelCountMode"),xe(p,n,"channelInterpretation")},yp=p=>typeof p.getFloatTimeDomainData=="function",Ue=(p,n,o)=>{const c=n[o];c!==void 0&&c!==p[o].value&&(p[o].value=c)},su=p=>{p.start=(n=>(o=0,c=0,f)=>{if(typeof f=="number"&&f<0||c<0||o<0)throw new RangeError("The parameters can't be negative.");n.call(p,o,c,f)})(p.start)},nu=p=>{var n;p.stop=(n=p.stop,(o=0)=>{if(o<0)throw new RangeError("The parameter can't be negative.");n.call(p,o)})},Cp=(p,n)=>p===null?512:Math.max(512,Math.min(16384,Math.pow(2,Math.round(Math.log2(p*n))))),bp=(p,n)=>{const o=p.createBiquadFilter();return $e(o,n),Ue(o,n,"Q"),Ue(o,n,"detune"),Ue(o,n,"frequency"),Ue(o,n,"gain"),xe(o,n,"type"),o},Ur=(p,n)=>{const o=p.createChannelSplitter(n.numberOfOutputs);return $e(o,n),(c=>{const f=c.numberOfOutputs;Object.defineProperty(c,"channelCount",{get:()=>f,set:v=>{if(v!==f)throw ts()}}),Object.defineProperty(c,"channelCountMode",{get:()=>"explicit",set:v=>{if(v!=="explicit")throw ts()}}),Object.defineProperty(c,"channelInterpretation",{get:()=>"discrete",set:v=>{if(v!=="discrete")throw ts()}})})(o),o},_A=(p,n)=>(p.connect=n.connect.bind(n),p.disconnect=n.disconnect.bind(n),p),_p=(p,n)=>{const o=p.createDelay(n.maxDelayTime);return $e(o,n),Ue(o,n,"delayTime"),o},Us=(p,n)=>{const o=p.createGain();return $e(o,n),Ue(o,n,"gain"),o};function n0(p,n){const o=n[0]*n[0]+n[1]*n[1];return[(p[0]*n[0]+p[1]*n[1])/o,(p[1]*n[0]-p[0]*n[1])/o]}function xp(p,n){let o=[0,0];for(let v=p.length-1;v>=0;v-=1)f=n,o=[(c=o)[0]*f[0]-c[1]*f[1],c[0]*f[1]+c[1]*f[0]],o[0]+=p[v];var c,f;return o}const Pr=(p,n,o,c)=>p.createScriptProcessor(n,o,c),_s=()=>new DOMException("","NotSupportedError"),i0={numberOfChannels:1},A0={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",detune:0,frequency:440,periodicWave:void 0,type:"sine"},r0={channelCount:2,channelCountMode:"clamped-max",channelInterpretation:"speakers",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:1,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1},o0={disableNormalization:!1},a0={channelCount:2,channelCountMode:"explicit",channelInterpretation:"speakers",pan:0},l0=()=>new DOMException("","UnknownError"),c0={channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",curve:null,oversample:"none"},Ep=(p,n,o)=>p.copyFromChannel===void 0?p.getChannelData(o)[0]:(p.copyFromChannel(n,o),n[0]),Sp=p=>{if(p===null)return!1;const n=p.length;return n%2!=0?p[Math.floor(n/2)]!==0:p[n/2-1]+p[n/2]!==0},Dr=(p,n,o,c)=>{let f=p;for(;!f.hasOwnProperty(n);)f=Object.getPrototypeOf(f);const{get:v,set:B}=Object.getOwnPropertyDescriptor(f,n);Object.defineProperty(p,n,{get:o(v),set:c(B)})},Fp=(p,n,o)=>{try{p.setValueAtTime(n,o)}catch(c){if(c.code!==9)throw c;Fp(p,n,o+1e-7)}},iu=p=>{const n=p.createOscillator();try{n.start(-1)}catch(o){return o instanceof RangeError}return!1},Tp=p=>{const n=p.createBuffer(1,1,44100),o=p.createBufferSource();o.buffer=n,o.start(),o.stop();try{return o.stop(),!0}catch{return!1}},Au=p=>{const n=p.createOscillator();try{n.stop(-1)}catch(o){return o instanceof RangeError}return!1},u0=()=>{try{new DOMException}catch{return!1}return!0},h0=()=>new Promise((p=>{const n=new ArrayBuffer(0),{port1:o,port2:c}=new MessageChannel;o.onmessage=({data:f})=>p(f!==null),c.postMessage(n,[n])})),Ip=(p,n)=>{const o=n.createGain();p.connect(o);const c=(f=>()=>{f.call(p,o),p.removeEventListener("ended",c)})(p.disconnect);p.addEventListener("ended",c),_A(p,o),p.stop=(f=>{let v=!1;return(B=0)=>{if(v)try{f.call(p,B)}catch{o.gain.setValueAtTime(0,B)}else f.call(p,B),v=!0}})(p.stop)},xA=(p,n)=>o=>{const c={value:p};return Object.defineProperties(o,{currentTarget:c,target:c}),typeof n=="function"?n.call(p,o):n.handleEvent.call(p,o)},d0=(p=>(n,o,[c,f,v],B)=>{p(n[f],[o,c,v],(_=>_[0]===o&&_[1]===c),B)})(ae),f0=(p=>(n,o,[c,f,v],B)=>{const _=n.get(c);_===void 0?n.set(c,new Set([[f,o,v]])):p(_,[f,o,v],(S=>S[0]===f&&S[1]===o),B)})(ae),p0=(p=>(n,o,c,f)=>p(n[f],(v=>v[0]===o&&v[1]===c)))(at),Qp=new WeakMap,m0=(p=>n=>{var o;return(o=p.get(n))!==null&&o!==void 0?o:0})(Qp),tn=(Qa=new Map,kr=new WeakMap,(p,n)=>{const o=kr.get(p);if(o!==void 0)return o;const c=Qa.get(p);if(c!==void 0)return c;try{const f=n();return f instanceof Promise?(Qa.set(p,f),f.catch((()=>!1)).then((v=>(Qa.delete(p),kr.set(p,v),v)))):(kr.set(p,f),f)}catch{return kr.set(p,!1),!1}});var Qa,kr;const pn=typeof window>"u"?null:window,Mp=((p,n)=>(o,c)=>{const f=o.createAnalyser();if($e(f,c),!(c.maxDecibels>c.minDecibels))throw n();return xe(f,c,"fftSize"),xe(f,c,"maxDecibels"),xe(f,c,"minDecibels"),xe(f,c,"smoothingTimeConstant"),p(yp,(()=>yp(f)))||(v=>{v.getFloatTimeDomainData=B=>{const _=new Uint8Array(B.length);v.getByteTimeDomainData(_);const S=Math.max(_.length,v.fftSize);for(let F=0;F<S;F+=1)B[F]=.0078125*(_[F]-128);return B}})(f),f})(tn,vt),ru=(p=>n=>{const o=p(n);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioNode in the audio graph.");return o.renderer})(Et),as=((p,n,o)=>async(c,f,v)=>{const B=p(c);await Promise.all(B.activeInputs.map(((_,S)=>Array.from(_).map((async([F,I])=>{const M=n(F),k=await M.render(F,f),L=c.context.destination;o(F)||c===L&&o(c)||k.connect(v,I,S)})))).reduce(((_,S)=>[..._,...S]),[]))})(Et,ru,Xn),g0=((p,n,o)=>()=>{const c=new WeakMap;return{render(f,v){const B=c.get(v);return B!==void 0?Promise.resolve(B):(async(_,S)=>{let F=n(_);if(!st(F,S)){const I={channelCount:F.channelCount,channelCountMode:F.channelCountMode,channelInterpretation:F.channelInterpretation,fftSize:F.fftSize,maxDecibels:F.maxDecibels,minDecibels:F.minDecibels,smoothingTimeConstant:F.smoothingTimeConstant};F=p(S,I)}return c.set(S,F),await o(_,S,F),F})(f,v)}}})(Mp,de,as),we=(Up=E,p=>{const n=Up.get(p);if(n===void 0)throw ts();return n});var Up;const es=(p=>p===null?null:p.hasOwnProperty("OfflineAudioContext")?p.OfflineAudioContext:p.hasOwnProperty("webkitOfflineAudioContext")?p.webkitOfflineAudioContext:null)(pn),ue=(p=>n=>p!==null&&n instanceof p)(es),Pp=new WeakMap,Dp=(p=>class{constructor(n){this._nativeEventTarget=n,this._listeners=new WeakMap}addEventListener(n,o,c){if(o!==null){let f=this._listeners.get(o);f===void 0&&(f=p(this,o),typeof o=="function"&&this._listeners.set(o,f)),this._nativeEventTarget.addEventListener(n,f,c)}}dispatchEvent(n){return this._nativeEventTarget.dispatchEvent(n)}removeEventListener(n,o,c){const f=o===null?void 0:this._listeners.get(o);this._nativeEventTarget.removeEventListener(n,f===void 0?null:f,c)}})(xA),fi=(p=>p===null?null:p.hasOwnProperty("AudioContext")?p.AudioContext:p.hasOwnProperty("webkitAudioContext")?p.webkitAudioContext:null)(pn),ou=(p=>n=>p!==null&&n instanceof p)(fi),au=(p=>n=>p!==null&&typeof p.AudioNode=="function"&&n instanceof p.AudioNode)(pn),kp=(p=>n=>p!==null&&typeof p.AudioParam=="function"&&n instanceof p.AudioParam)(pn),EA=(p=>p===null?null:p.hasOwnProperty("AudioWorkletNode")?p.AudioWorkletNode:null)(pn),He=((p,n,o,c,f,v,B,_,S,F,I,M,k,L,K,V)=>class extends F{constructor(N,z,q,O){super(q),this._context=N,this._nativeAudioNode=q;const it=I(N);M(it)&&o(xa,(()=>xa(it,V)))!==!0&&eu(q),w.set(this,q),x.set(this,new Set),N.state!=="closed"&&z&&X(this),p(this,O,q)}get channelCount(){return this._nativeAudioNode.channelCount}set channelCount(N){this._nativeAudioNode.channelCount=N}get channelCountMode(){return this._nativeAudioNode.channelCountMode}set channelCountMode(N){this._nativeAudioNode.channelCountMode=N}get channelInterpretation(){return this._nativeAudioNode.channelInterpretation}set channelInterpretation(N){this._nativeAudioNode.channelInterpretation=N}get context(){return this._context}get numberOfInputs(){return this._nativeAudioNode.numberOfInputs}get numberOfOutputs(){return this._nativeAudioNode.numberOfOutputs}connect(N,z=0,q=0){if(z<0||z>=this._nativeAudioNode.numberOfOutputs)throw f();const O=I(this._context),it=K(O);if(k(N)||L(N))throw v();if(re(N)){const j=de(N);try{const et=Me(this._nativeAudioNode,j,z,q),$=yA(this);(it||$)&&this._nativeAudioNode.disconnect(...et),this.context.state!=="closed"&&!$&&yA(N)&&X(N)}catch(et){throw et.code===12?v():et}if(n(this,N,z,q,it)){const et=S([this],N);Tr(et,c(it))}return N}const lt=qi(N);if(lt.name==="playbackRate"&&lt.maxValue===1024)throw B();try{this._nativeAudioNode.connect(lt,z),(it||yA(this))&&this._nativeAudioNode.disconnect(lt,z)}catch(j){throw j.code===12?v():j}if(((j,et,$,ut)=>{const{activeInputs:tt,passiveInputs:ot}=zt(et),{outputs:gt}=Et(j),wt=dt(j),kt=Ft=>{const St=de(j),Rt=qi(et);if(Ft){const bt=BA(ot,j,$);bs(tt,j,bt,!1),ut||Xn(j)||St.connect(Rt,$)}else{const bt=((Vt,jt,se)=>at(Vt,(ye=>ye[0]===jt&&ye[1]===se)))(tt,j,$);Qn(ot,bt,!1),ut||Xn(j)||St.disconnect(Rt,$)}};return!!ae(gt,[et,$],(Ft=>Ft[0]===et&&Ft[1]===$),!0)&&(wt.add(kt),Wt(j)?bs(tt,j,[$,kt],!0):Qn(ot,[j,$,kt],!0),!0)})(this,N,z,it)){const j=S([this],N);Tr(j,c(it))}}disconnect(N,z,q){let O;const it=I(this._context),lt=K(it);if(N===void 0)O=((j,et)=>{const $=Et(j),ut=[];for(const tt of $.outputs)Re(tt)?Ir(j,et,...tt):Qr(j,et,...tt),ut.push(tt[0]);return $.outputs.clear(),ut})(this,lt);else if(typeof N=="number"){if(N<0||N>=this.numberOfOutputs)throw f();O=((j,et,$)=>{const ut=Et(j),tt=[];for(const ot of ut.outputs)ot[1]===$&&(Re(ot)?Ir(j,et,...ot):Qr(j,et,...ot),tt.push(ot[0]),ut.outputs.delete(ot));return tt})(this,lt,N)}else{if(z!==void 0&&(z<0||z>=this.numberOfOutputs)||re(N)&&q!==void 0&&(q<0||q>=N.numberOfInputs))throw f();if(O=((j,et,$,ut,tt)=>{const ot=Et(j);return Array.from(ot.outputs).filter((gt=>!(gt[0]!==$||ut!==void 0&&gt[1]!==ut||tt!==void 0&&gt[2]!==tt))).map((gt=>(Re(gt)?Ir(j,et,...gt):Qr(j,et,...gt),ot.outputs.delete(gt),gt[0])))})(this,lt,N,z,q),O.length===0)throw v()}for(const j of O){const et=S([this],j);Tr(et,_)}}})((Lp=g,(p,n,o)=>{const c=[];for(let f=0;f<o.numberOfInputs;f+=1)c.push(new Set);Lp.set(p,{activeInputs:c,outputs:new Set,passiveInputs:new WeakMap,renderer:n})}),((p,n,o,c,f,v,B,_,S,F,I,M,k)=>{const L=new WeakMap;return(K,V,N,z,q)=>{const{activeInputs:O,passiveInputs:it}=v(V),{outputs:lt}=v(K),j=_(K),et=$=>{const ut=S(V),tt=S(K);if($){const ot=Bt(it,K,N,z);p(O,K,ot,!1),q||M(K)||o(tt,ut,N,z),k(V)&&X(V)}else{const ot=c(O,K,N,z);n(it,z,ot,!1),q||M(K)||f(tt,ut,N,z);const gt=B(V);if(gt===0)I(V)&&ct(V,O);else{const wt=L.get(V);wt!==void 0&&clearTimeout(wt),L.set(V,setTimeout((()=>{I(V)&&ct(V,O)}),1e3*gt))}}};return!!F(lt,[V,N,z],($=>$[0]===V&&$[1]===N&&$[2]===z),!0)&&(j.add(et),I(K)?p(O,K,[N,z,et],!0):n(it,z,[K,N,et],!0),!0)}})(d0,f0,Me,p0,di,Et,m0,dt,de,ae,Wt,Xn,yA),tn,((p,n,o,c,f,v)=>B=>(_,S)=>{const F=p.get(_);if(F===void 0){if(!B&&v(_)){const I=c(_),{outputs:M}=o(_);for(const k of M)if(Re(k)){const L=c(k[0]);n(I,L,k[1],k[2])}else{const L=f(k[0]);I.disconnect(L,k[1])}}p.set(_,S)}else p.set(_,F+S)})(T,di,Et,de,qi,Wt),vt,Ia,_s,((p,n,o,c,f,v,B,_)=>(S,F)=>{const I=n.get(S);if(I===void 0)throw new Error("Missing the expected cycle count.");const M=v(S.context),k=_(M);if(I===F){if(n.delete(S),!k&&B(S)){const L=c(S),{outputs:K}=o(S);for(const V of K)if(Re(V)){const N=c(V[0]);p(L,N,V[1],V[2])}else{const N=f(V[0]);L.connect(N,V[1])}}}else n.set(S,I-F)})(Me,T,Et,de,qi,we,Wt,ue),((p,n,o)=>function c(f,v){const B=re(v)?v:o(p,v);if((S=>"delayTime"in S)(B))return[];if(f[0]===B)return[f];if(f.includes(B))return[];const{outputs:_}=n(B);return Array.from(_).map((S=>c([...f,B],S[0]))).reduce(((S,F)=>S.concat(F)),[])})(Pp,Et,W),Dp,we,ou,au,kp,ue,EA);var Lp;const w0=((p,n,o,c,f,v)=>class extends p{constructor(B,_){const S=f(B),F={...J,..._},I=c(S,F);super(B,!1,I,v(S)?n():null),this._nativeAnalyserNode=I}get fftSize(){return this._nativeAnalyserNode.fftSize}set fftSize(B){this._nativeAnalyserNode.fftSize=B}get frequencyBinCount(){return this._nativeAnalyserNode.frequencyBinCount}get maxDecibels(){return this._nativeAnalyserNode.maxDecibels}set maxDecibels(B){const _=this._nativeAnalyserNode.maxDecibels;if(this._nativeAnalyserNode.maxDecibels=B,!(B>this._nativeAnalyserNode.minDecibels))throw this._nativeAnalyserNode.maxDecibels=_,o()}get minDecibels(){return this._nativeAnalyserNode.minDecibels}set minDecibels(B){const _=this._nativeAnalyserNode.minDecibels;if(this._nativeAnalyserNode.minDecibels=B,!(this._nativeAnalyserNode.maxDecibels>B))throw this._nativeAnalyserNode.minDecibels=_,o()}get smoothingTimeConstant(){return this._nativeAnalyserNode.smoothingTimeConstant}set smoothingTimeConstant(B){this._nativeAnalyserNode.smoothingTimeConstant=B}getByteFrequencyData(B){this._nativeAnalyserNode.getByteFrequencyData(B)}getByteTimeDomainData(B){this._nativeAnalyserNode.getByteTimeDomainData(B)}getFloatFrequencyData(B){this._nativeAnalyserNode.getFloatFrequencyData(B)}getFloatTimeDomainData(B){this._nativeAnalyserNode.getFloatTimeDomainData(B)}})(He,g0,vt,Mp,we,ue),lu=new WeakSet,Rp=(p=>p===null?null:p.hasOwnProperty("AudioBuffer")?p.AudioBuffer:null)(pn),Hp=(cu=new Uint32Array(1),p=>(cu[0]=p,cu[0]));var cu;const uu=((p,n)=>o=>{o.copyFromChannel=(c,f,v=0)=>{const B=p(v),_=p(f);if(_>=o.numberOfChannels)throw n();const S=o.length,F=o.getChannelData(_),I=c.length;for(let M=B<0?-B:0;M+B<S&&M<I;M+=1)c[M]=F[M+B]},o.copyToChannel=(c,f,v=0)=>{const B=p(v),_=p(f);if(_>=o.numberOfChannels)throw n();const S=o.length,F=o.getChannelData(_),I=c.length;for(let M=B<0?-B:0;M+B<S&&M<I;M+=1)F[M+B]=c[M]}})(Hp,vt),hu=(p=>n=>{n.copyFromChannel=(o=>(c,f,v=0)=>{const B=p(v),_=p(f);if(B<n.length)return o.call(n,c,_,B)})(n.copyFromChannel),n.copyToChannel=(o=>(c,f,v=0)=>{const B=p(v),_=p(f);if(B<n.length)return o.call(n,c,_,B)})(n.copyToChannel)})(Hp),Np=((p,n,o,c,f,v,B,_)=>{let S=null;return class Zw{constructor(I){if(f===null)throw new Error("Missing the native OfflineAudioContext constructor.");const{length:M,numberOfChannels:k,sampleRate:L}={...Mt,...I};S===null&&(S=new f(1,1,44100));const K=c!==null&&n(v,v)?new c({length:M,numberOfChannels:k,sampleRate:L}):S.createBuffer(k,M,L);if(K.numberOfChannels===0)throw o();return typeof K.copyFromChannel!="function"?(B(K),ft(K)):n(At,(()=>At(K)))||_(K),p.add(K),K}static[Symbol.hasInstance](I){return I!==null&&typeof I=="object"&&Object.getPrototypeOf(I)===Zw.prototype||p.has(I)}}})(lu,tn,_s,Rp,es,(p=>()=>{if(p===null)return!1;try{new p({length:1,sampleRate:44100})}catch{return!1}return!0})(Rp),uu,hu),Ma=(p=>(n,o)=>{const c=p(n,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});o.connect(c).connect(n.destination);const f=()=>{o.removeEventListener("ended",f),o.disconnect(c),c.disconnect()};o.addEventListener("ended",f)})(Us),Op=((p,n,o)=>async(c,f,v)=>{const B=n(c);await Promise.all(Array.from(B.activeInputs).map((async([_,S])=>{const F=p(_),I=await F.render(_,f);o(_)||I.connect(v,S)})))})(ru,zt,Xn),Mn=(p=>(n,o,c)=>p(o,n,c))(Op),SA=((p,n,o,c,f,v,B,_,S,F,I)=>(M,k)=>{const L=M.createBufferSource();return $e(L,k),Ue(L,k,"playbackRate"),xe(L,k,"buffer"),xe(L,k,"loop"),xe(L,k,"loopEnd"),xe(L,k,"loopStart"),n(o,(()=>o(M)))||(K=>{K.start=(V=>{let N=!1;return(z=0,q=0,O)=>{if(N)throw ts();V.call(K,z,q,O),N=!0}})(K.start)})(L),n(c,(()=>c(M)))||(K=>{K.start=(V=>(N=0,z=0,q)=>{const O=K.buffer,it=O===null?z:Math.min(O.duration,z);O!==null&&it>O.duration-.5/K.context.sampleRate?V.call(K,N,0,0):V.call(K,N,it,q)})(K.start)})(L),n(f,(()=>f(M)))||F(L,M),n(v,(()=>v(M)))||su(L),n(B,(()=>B(M)))||I(L,M),n(_,(()=>_(M)))||nu(L),p(M,L),L})(Ma,tn,(p=>{const n=p.createBufferSource();n.start();try{n.start()}catch{return!0}return!1}),(p=>{const n=p.createBufferSource(),o=p.createBuffer(1,1,44100);n.buffer=o;try{n.start(0,1)}catch{return!1}return!0}),(p=>{const n=p.createBufferSource();n.start();try{n.stop()}catch{return!1}return!0}),iu,Tp,Au,0,(p=>(n,o)=>{const c=o.createBuffer(1,1,44100);n.buffer===null&&(n.buffer=c),p(n,"buffer",(f=>()=>{const v=f.call(n);return v===c?null:v}),(f=>v=>f.call(n,v===null?c:v)))})(Dr),Ip),Un=((p,n)=>(o,c,f)=>(p(c).replay(f),n(c,o,f)))((p=>n=>{const o=p(n);if(o.renderer===null)throw new Error("Missing the renderer of the given AudioParam in the audio graph.");return o.renderer})(zt),Op),v0=((p,n,o,c,f)=>()=>{const v=new WeakMap;let B=null,_=null;return{set start(S){B=S},set stop(S){_=S},render(S,F){const I=v.get(F);return I!==void 0?Promise.resolve(I):(async(M,k)=>{let L=o(M);const K=st(L,k);if(!K){const V={buffer:L.buffer,channelCount:L.channelCount,channelCountMode:L.channelCountMode,channelInterpretation:L.channelInterpretation,loop:L.loop,loopEnd:L.loopEnd,loopStart:L.loopStart,playbackRate:L.playbackRate.value};L=n(k,V),B!==null&&L.start(...B),_!==null&&L.stop(_)}return v.set(k,L),K?await p(k,M.playbackRate,L.playbackRate):await c(k,M.playbackRate,L.playbackRate),await f(M,k,L),L})(S,F)}}})(Mn,SA,de,Un,as),mn=((p,n,o,c,f,v,B,_,S,F,I,M,k)=>(L,K,V,N=null,z=null)=>{const q=V.value,O=new h.AutomationEventList(q),it=K?(j=>({replay(et){for(const $ of j)if($.type==="exponentialRampToValue"){const{endTime:ut,value:tt}=$;et.exponentialRampToValueAtTime(tt,ut)}else if($.type==="linearRampToValue"){const{endTime:ut,value:tt}=$;et.linearRampToValueAtTime(tt,ut)}else if($.type==="setTarget"){const{startTime:ut,target:tt,timeConstant:ot}=$;et.setTargetAtTime(tt,ut,ot)}else if($.type==="setValue"){const{startTime:ut,value:tt}=$;et.setValueAtTime(tt,ut)}else{if($.type!=="setValueCurve")throw new Error("Can't apply an unknown automation.");{const{duration:ut,startTime:tt,values:ot}=$;et.setValueCurveAtTime(ot,tt,ut)}}}}))(O):null,lt={get defaultValue(){return q},get maxValue(){return N===null?V.maxValue:N},get minValue(){return z===null?V.minValue:z},get value(){return V.value},set value(j){V.value=j,lt.setValueAtTime(j,L.context.currentTime)},cancelAndHoldAtTime(j){if(typeof V.cancelAndHoldAtTime=="function")it===null&&O.flush(L.context.currentTime),O.add(f(j)),V.cancelAndHoldAtTime(j);else{const et=Array.from(O).pop();it===null&&O.flush(L.context.currentTime),O.add(f(j));const $=Array.from(O).pop();V.cancelScheduledValues(j),et!==$&&$!==void 0&&($.type==="exponentialRampToValue"?V.exponentialRampToValueAtTime($.value,$.endTime):$.type==="linearRampToValue"?V.linearRampToValueAtTime($.value,$.endTime):$.type==="setValue"?V.setValueAtTime($.value,$.startTime):$.type==="setValueCurve"&&V.setValueCurveAtTime($.values,$.startTime,$.duration))}return lt},cancelScheduledValues:j=>(it===null&&O.flush(L.context.currentTime),O.add(v(j)),V.cancelScheduledValues(j),lt),exponentialRampToValueAtTime(j,et){if(j===0)throw new RangeError;if(!Number.isFinite(et)||et<0)throw new RangeError;const $=L.context.currentTime;return it===null&&O.flush($),Array.from(O).length===0&&(O.add(F(q,$)),V.setValueAtTime(q,$)),O.add(B(j,et)),V.exponentialRampToValueAtTime(j,et),lt},linearRampToValueAtTime(j,et){const $=L.context.currentTime;return it===null&&O.flush($),Array.from(O).length===0&&(O.add(F(q,$)),V.setValueAtTime(q,$)),O.add(_(j,et)),V.linearRampToValueAtTime(j,et),lt},setTargetAtTime:(j,et,$)=>(it===null&&O.flush(L.context.currentTime),O.add(S(j,et,$)),V.setTargetAtTime(j,et,$),lt),setValueAtTime:(j,et)=>(it===null&&O.flush(L.context.currentTime),O.add(F(j,et)),V.setValueAtTime(j,et),lt),setValueCurveAtTime(j,et,$){const ut=j instanceof Float32Array?j:new Float32Array(j);if(M!==null&&M.name==="webkitAudioContext"){const tt=et+$,ot=L.context.sampleRate,gt=Math.ceil(et*ot),wt=Math.floor(tt*ot),kt=wt-gt,Ft=new Float32Array(kt);for(let Rt=0;Rt<kt;Rt+=1){const bt=(ut.length-1)/$*((gt+Rt)/ot-et),Vt=Math.floor(bt),jt=Math.ceil(bt);Ft[Rt]=Vt===jt?ut[Vt]:(1-(bt-Vt))*ut[Vt]+(1-(jt-bt))*ut[jt]}it===null&&O.flush(L.context.currentTime),O.add(I(Ft,et,$)),V.setValueCurveAtTime(Ft,et,$);const St=wt/ot;St<tt&&k(lt,Ft[Ft.length-1],St),k(lt,ut[ut.length-1],tt)}else it===null&&O.flush(L.context.currentTime),O.add(I(ut,et,$)),V.setValueCurveAtTime(ut,et,$);return lt}};return o.set(lt,V),n.set(lt,L),p(lt,it),lt})((Vp=C,(p,n)=>{Vp.set(p,{activeInputs:new Set,passiveInputs:new WeakMap,renderer:n})}),Pp,y,0,h.createCancelAndHoldAutomationEvent,h.createCancelScheduledValuesAutomationEvent,h.createExponentialRampToValueAutomationEvent,h.createLinearRampToValueAutomationEvent,h.createSetTargetAutomationEvent,h.createSetValueAutomationEvent,h.createSetValueCurveAutomationEvent,fi,Fp);var Vp;const B0=((p,n,o,c,f,v,B,_)=>class extends p{constructor(S,F){const I=v(S),M={...Qt,...F},k=f(I,M),L=B(I),K=L?n():null;super(S,!1,k,K),this._audioBufferSourceNodeRenderer=K,this._isBufferNullified=!1,this._isBufferSet=M.buffer!==null,this._nativeAudioBufferSourceNode=k,this._onended=null,this._playbackRate=o(this,L,k.playbackRate,Nt,Pt)}get buffer(){return this._isBufferNullified?null:this._nativeAudioBufferSourceNode.buffer}set buffer(S){if(this._nativeAudioBufferSourceNode.buffer=S,S!==null){if(this._isBufferSet)throw c();this._isBufferSet=!0}}get loop(){return this._nativeAudioBufferSourceNode.loop}set loop(S){this._nativeAudioBufferSourceNode.loop=S}get loopEnd(){return this._nativeAudioBufferSourceNode.loopEnd}set loopEnd(S){this._nativeAudioBufferSourceNode.loopEnd=S}get loopStart(){return this._nativeAudioBufferSourceNode.loopStart}set loopStart(S){this._nativeAudioBufferSourceNode.loopStart=S}get onended(){return this._onended}set onended(S){const F=typeof S=="function"?_(this,S):null;this._nativeAudioBufferSourceNode.onended=F;const I=this._nativeAudioBufferSourceNode.onended;this._onended=I!==null&&I===F?S:I}get playbackRate(){return this._playbackRate}start(S=0,F=0,I){if(this._nativeAudioBufferSourceNode.start(S,F,I),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.start=I===void 0?[S,F]:[S,F,I]),this.context.state!=="closed"){X(this);const M=()=>{this._nativeAudioBufferSourceNode.removeEventListener("ended",M),Wt(this)&&mt(this)};this._nativeAudioBufferSourceNode.addEventListener("ended",M)}}stop(S=0){this._nativeAudioBufferSourceNode.stop(S),this._audioBufferSourceNodeRenderer!==null&&(this._audioBufferSourceNodeRenderer.stop=S)}})(He,v0,mn,ts,SA,we,ue,xA),y0=((p,n,o,c,f,v,B,_)=>class extends p{constructor(S,F){const I=v(S),M=B(I),k=f(I,F,M);super(S,!1,k,M?(L=>{const K=new WeakMap;return{render(V,N){const z=K.get(N);return z!==void 0?Promise.resolve(z):(async(q,O)=>{const it=O.destination;return K.set(O,it),await L(q,O,it),it})(V,N)}}})(_):null),this._isNodeOfNativeOfflineAudioContext=M,this._nativeAudioDestinationNode=k}get channelCount(){return this._nativeAudioDestinationNode.channelCount}set channelCount(S){if(this._isNodeOfNativeOfflineAudioContext)throw c();if(S>this._nativeAudioDestinationNode.maxChannelCount)throw o();this._nativeAudioDestinationNode.channelCount=S}get channelCountMode(){return this._nativeAudioDestinationNode.channelCountMode}set channelCountMode(S){if(this._isNodeOfNativeOfflineAudioContext)throw c();this._nativeAudioDestinationNode.channelCountMode=S}get maxChannelCount(){return this._nativeAudioDestinationNode.maxChannelCount}})(He,0,vt,ts,((p,n)=>(o,c,f)=>{const v=o.destination;if(v.channelCount!==c)try{v.channelCount=c}catch{}f&&v.channelCountMode!=="explicit"&&(v.channelCountMode="explicit"),v.maxChannelCount===0&&Object.defineProperty(v,"maxChannelCount",{value:c});const B=p(o,{channelCount:c,channelCountMode:v.channelCountMode,channelInterpretation:v.channelInterpretation,gain:1});return n(B,"channelCount",(_=>()=>_.call(B)),(_=>S=>{_.call(B,S);try{v.channelCount=S}catch(F){if(S>v.maxChannelCount)throw F}})),n(B,"channelCountMode",(_=>()=>_.call(B)),(_=>S=>{_.call(B,S),v.channelCountMode=S})),n(B,"channelInterpretation",(_=>()=>_.call(B)),(_=>S=>{_.call(B,S),v.channelInterpretation=S})),Object.defineProperty(B,"maxChannelCount",{get:()=>v.maxChannelCount}),B.connect(v),B})(Us,Dr),we,ue,as),C0=((p,n,o,c,f)=>()=>{const v=new WeakMap;return{render(B,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(F,I)=>{let M=o(F);const k=st(M,I);if(!k){const L={Q:M.Q.value,channelCount:M.channelCount,channelCountMode:M.channelCountMode,channelInterpretation:M.channelInterpretation,detune:M.detune.value,frequency:M.frequency.value,gain:M.gain.value,type:M.type};M=n(I,L)}return v.set(I,M),k?(await p(I,F.Q,M.Q),await p(I,F.detune,M.detune),await p(I,F.frequency,M.frequency),await p(I,F.gain,M.gain)):(await c(I,F.Q,M.Q),await c(I,F.detune,M.detune),await c(I,F.frequency,M.frequency),await c(I,F.gain,M.gain)),await f(F,I,M),M})(B,_)}}})(Mn,bp,de,Un,as),$i=(p=>(n,o)=>p.set(n,o))(Qp),b0=((p,n,o,c,f,v,B,_)=>class extends p{constructor(S,F){const I=v(S),M={...zy,...F},k=f(I,M),L=B(I);super(S,!1,k,L?o():null),this._Q=n(this,L,k.Q,Nt,Pt),this._detune=n(this,L,k.detune,1200*Math.log2(Nt),-1200*Math.log2(Nt)),this._frequency=n(this,L,k.frequency,S.sampleRate/2,0),this._gain=n(this,L,k.gain,40*Math.log10(Nt),Pt),this._nativeBiquadFilterNode=k,_(this,1)}get detune(){return this._detune}get frequency(){return this._frequency}get gain(){return this._gain}get Q(){return this._Q}get type(){return this._nativeBiquadFilterNode.type}set type(S){this._nativeBiquadFilterNode.type=S}getFrequencyResponse(S,F,I){try{this._nativeBiquadFilterNode.getFrequencyResponse(S,F,I)}catch(M){throw M.code===11?c():M}if(S.length!==F.length||F.length!==I.length)throw c()}})(He,mn,C0,Ia,bp,we,ue,$i),pi=((p,n)=>(o,c,f)=>{const v=new Set;return o.connect=(B=>(_,S=0,F=0)=>{const I=v.size===0;if(n(_))return B.call(o,_,S,F),p(v,[_,S,F],(M=>M[0]===_&&M[1]===S&&M[2]===F),!0),I&&c(),_;B.call(o,_,S),p(v,[_,S],(M=>M[0]===_&&M[1]===S),!0),I&&c()})(o.connect),o.disconnect=(B=>(_,S,F)=>{const I=v.size>0;if(_===void 0)B.apply(o),v.clear();else if(typeof _=="number"){B.call(o,_);for(const k of v)k[1]===_&&v.delete(k)}else{n(_)?B.call(o,_,S,F):B.call(o,_,S);for(const k of v)k[0]!==_||S!==void 0&&k[1]!==S||F!==void 0&&k[2]!==F||v.delete(k)}const M=v.size===0;I&&M&&f()})(o.disconnect),o})(ae,au),_0=((p,n)=>(o,c)=>{c.channelCount=1,c.channelCountMode="explicit",Object.defineProperty(c,"channelCount",{get:()=>1,set:()=>{throw p()}}),Object.defineProperty(c,"channelCountMode",{get:()=>"explicit",set:()=>{throw p()}});const f=o.createBufferSource();n(c,(()=>{const v=c.numberOfInputs;for(let B=0;B<v;B+=1)f.connect(c,0,B)}),(()=>f.disconnect(c)))})(ts,pi),mi=((p,n)=>(o,c)=>{const f=o.createChannelMerger(c.numberOfInputs);return p!==null&&p.name==="webkitAudioContext"&&n(o,f),$e(f,c),f})(fi,_0),x0=((p,n,o)=>()=>{const c=new WeakMap;return{render(f,v){const B=c.get(v);return B!==void 0?Promise.resolve(B):(async(_,S)=>{let F=n(_);if(!st(F,S)){const I={channelCount:F.channelCount,channelCountMode:F.channelCountMode,channelInterpretation:F.channelInterpretation,numberOfInputs:F.numberOfInputs};F=p(S,I)}return c.set(S,F),await o(_,S,F),F})(f,v)}}})(mi,de,as),E0=((p,n,o,c,f)=>class extends p{constructor(v,B){const _=c(v),S={...$y,...B};super(v,!1,o(_,S),f(_)?n():null)}})(He,x0,mi,we,ue),S0=((p,n,o)=>()=>{const c=new WeakMap;return{render(f,v){const B=c.get(v);return B!==void 0?Promise.resolve(B):(async(_,S)=>{let F=n(_);if(!st(F,S)){const I={channelCount:F.channelCount,channelCountMode:F.channelCountMode,channelInterpretation:F.channelInterpretation,numberOfOutputs:F.numberOfOutputs};F=p(S,I)}return c.set(S,F),await o(_,S,F),F})(f,v)}}})(Ur,de,as),F0=((p,n,o,c,f,v)=>class extends p{constructor(B,_){const S=c(B),F=(I=>({...I,channelCount:I.numberOfOutputs}))({...Xy,..._});super(B,!1,o(S,F),f(S)?n():null)}})(He,S0,Ur,we,ue),T0=((p,n,o,c)=>(f,{offset:v,...B})=>{const _=f.createBuffer(1,2,44100),S=n(f,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),F=o(f,{...B,gain:v}),I=_.getChannelData(0);I[0]=1,I[1]=1,S.buffer=_,S.loop=!0;const M={get bufferSize(){},get channelCount(){return F.channelCount},set channelCount(k){F.channelCount=k},get channelCountMode(){return F.channelCountMode},set channelCountMode(k){F.channelCountMode=k},get channelInterpretation(){return F.channelInterpretation},set channelInterpretation(k){F.channelInterpretation=k},get context(){return F.context},get inputs(){return[]},get numberOfInputs(){return S.numberOfInputs},get numberOfOutputs(){return F.numberOfOutputs},get offset(){return F.gain},get onended(){return S.onended},set onended(k){S.onended=k},addEventListener:(...k)=>S.addEventListener(k[0],k[1],k[2]),dispatchEvent:(...k)=>S.dispatchEvent(k[0]),removeEventListener:(...k)=>S.removeEventListener(k[0],k[1],k[2]),start(k=0){S.start.call(S,k)},stop(k=0){S.stop.call(S,k)}};return p(f,S),c(_A(M,F),(()=>S.connect(F)),(()=>S.disconnect(F)))})(Ma,SA,Us,pi),FA=((p,n,o,c,f)=>(v,B)=>{if(v.createConstantSource===void 0)return o(v,B);const _=v.createConstantSource();return $e(_,B),Ue(_,B,"offset"),n(c,(()=>c(v)))||su(_),n(f,(()=>f(v)))||nu(_),p(v,_),_})(Ma,tn,T0,iu,Au),I0=((p,n,o,c,f)=>()=>{const v=new WeakMap;let B=null,_=null;return{set start(S){B=S},set stop(S){_=S},render(S,F){const I=v.get(F);return I!==void 0?Promise.resolve(I):(async(M,k)=>{let L=o(M);const K=st(L,k);if(!K){const V={channelCount:L.channelCount,channelCountMode:L.channelCountMode,channelInterpretation:L.channelInterpretation,offset:L.offset.value};L=n(k,V),B!==null&&L.start(B),_!==null&&L.stop(_)}return v.set(k,L),K?await p(k,M.offset,L.offset):await c(k,M.offset,L.offset),await f(M,k,L),L})(S,F)}}})(Mn,FA,de,Un,as),Q0=((p,n,o,c,f,v,B)=>class extends p{constructor(_,S){const F=f(_),I={...Yy,...S},M=c(F,I),k=v(F),L=k?o():null;super(_,!1,M,L),this._constantSourceNodeRenderer=L,this._nativeConstantSourceNode=M,this._offset=n(this,k,M.offset,Nt,Pt),this._onended=null}get offset(){return this._offset}get onended(){return this._onended}set onended(_){const S=typeof _=="function"?B(this,_):null;this._nativeConstantSourceNode.onended=S;const F=this._nativeConstantSourceNode.onended;this._onended=F!==null&&F===S?_:F}start(_=0){if(this._nativeConstantSourceNode.start(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.start=_),this.context.state!=="closed"){X(this);const S=()=>{this._nativeConstantSourceNode.removeEventListener("ended",S),Wt(this)&&mt(this)};this._nativeConstantSourceNode.addEventListener("ended",S)}}stop(_=0){this._nativeConstantSourceNode.stop(_),this._constantSourceNodeRenderer!==null&&(this._constantSourceNodeRenderer.stop=_)}})(He,mn,I0,FA,we,ue,xA),Wp=((p,n)=>(o,c)=>{const f=o.createConvolver();if($e(f,c),c.disableNormalization===f.normalize&&(f.normalize=!c.disableNormalization),xe(f,c,"buffer"),c.channelCount>2||(n(f,"channelCount",(v=>()=>v.call(f)),(v=>B=>{if(B>2)throw p();return v.call(f,B)})),c.channelCountMode==="max"))throw p();return n(f,"channelCountMode",(v=>()=>v.call(f)),(v=>B=>{if(B==="max")throw p();return v.call(f,B)})),f})(_s,Dr),M0=((p,n,o)=>()=>{const c=new WeakMap;return{render(f,v){const B=c.get(v);return B!==void 0?Promise.resolve(B):(async(_,S)=>{let F=n(_);if(!st(F,S)){const I={buffer:F.buffer,channelCount:F.channelCount,channelCountMode:F.channelCountMode,channelInterpretation:F.channelInterpretation,disableNormalization:!F.normalize};F=p(S,I)}return c.set(S,F),$t(F)?await o(_,S,F.inputs[0]):await o(_,S,F),F})(f,v)}}})(Wp,de,as),U0=((p,n,o,c,f,v)=>class extends p{constructor(B,_){const S=c(B),F={...jy,..._},I=o(S,F);super(B,!1,I,f(S)?n():null),this._isBufferNullified=!1,this._nativeConvolverNode=I,F.buffer!==null&&v(this,F.buffer.duration)}get buffer(){return this._isBufferNullified?null:this._nativeConvolverNode.buffer}set buffer(B){if(this._nativeConvolverNode.buffer=B,B===null&&this._nativeConvolverNode.buffer!==null){const _=this._nativeConvolverNode.context;this._nativeConvolverNode.buffer=_.createBuffer(1,1,_.sampleRate),this._isBufferNullified=!0,v(this,0)}else this._isBufferNullified=!1,v(this,this._nativeConvolverNode.buffer===null?0:this._nativeConvolverNode.buffer.duration)}get normalize(){return this._nativeConvolverNode.normalize}set normalize(B){this._nativeConvolverNode.normalize=B}})(He,M0,Wp,we,ue,$i),P0=((p,n,o,c,f)=>v=>{const B=new WeakMap;return{render(_,S){const F=B.get(S);return F!==void 0?Promise.resolve(F):(async(I,M)=>{let k=o(I);const L=st(k,M);if(!L){const K={channelCount:k.channelCount,channelCountMode:k.channelCountMode,channelInterpretation:k.channelInterpretation,delayTime:k.delayTime.value,maxDelayTime:v};k=n(M,K)}return B.set(M,k),L?await p(M,I.delayTime,k.delayTime):await c(M,I.delayTime,k.delayTime),await f(I,M,k),k})(_,S)}}})(Mn,_p,de,Un,as),D0=((p,n,o,c,f,v,B)=>class extends p{constructor(_,S){const F=f(_),I={...Jy,...S},M=c(F,I),k=v(F);super(_,!1,M,k?o(I.maxDelayTime):null),this._delayTime=n(this,k,M.delayTime),B(this,I.maxDelayTime)}get delayTime(){return this._delayTime}})(He,mn,P0,_p,we,ue,$i),Kp=(p=>(n,o)=>{const c=n.createDynamicsCompressor();if($e(c,o),o.channelCount>2||o.channelCountMode==="max")throw p();return Ue(c,o,"attack"),Ue(c,o,"knee"),Ue(c,o,"ratio"),Ue(c,o,"release"),Ue(c,o,"threshold"),c})(_s),k0=((p,n,o,c,f)=>()=>{const v=new WeakMap;return{render(B,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(F,I)=>{let M=o(F);const k=st(M,I);if(!k){const L={attack:M.attack.value,channelCount:M.channelCount,channelCountMode:M.channelCountMode,channelInterpretation:M.channelInterpretation,knee:M.knee.value,ratio:M.ratio.value,release:M.release.value,threshold:M.threshold.value};M=n(I,L)}return v.set(I,M),k?(await p(I,F.attack,M.attack),await p(I,F.knee,M.knee),await p(I,F.ratio,M.ratio),await p(I,F.release,M.release),await p(I,F.threshold,M.threshold)):(await c(I,F.attack,M.attack),await c(I,F.knee,M.knee),await c(I,F.ratio,M.ratio),await c(I,F.release,M.release),await c(I,F.threshold,M.threshold)),await f(F,I,M),M})(B,_)}}})(Mn,Kp,de,Un,as),L0=((p,n,o,c,f,v,B,_)=>class extends p{constructor(S,F){const I=v(S),M={...Zy,...F},k=c(I,M),L=B(I);super(S,!1,k,L?o():null),this._attack=n(this,L,k.attack),this._knee=n(this,L,k.knee),this._nativeDynamicsCompressorNode=k,this._ratio=n(this,L,k.ratio),this._release=n(this,L,k.release),this._threshold=n(this,L,k.threshold),_(this,.006)}get attack(){return this._attack}get channelCount(){return this._nativeDynamicsCompressorNode.channelCount}set channelCount(S){const F=this._nativeDynamicsCompressorNode.channelCount;if(this._nativeDynamicsCompressorNode.channelCount=S,S>2)throw this._nativeDynamicsCompressorNode.channelCount=F,f()}get channelCountMode(){return this._nativeDynamicsCompressorNode.channelCountMode}set channelCountMode(S){const F=this._nativeDynamicsCompressorNode.channelCountMode;if(this._nativeDynamicsCompressorNode.channelCountMode=S,S==="max")throw this._nativeDynamicsCompressorNode.channelCountMode=F,f()}get knee(){return this._knee}get ratio(){return this._ratio}get reduction(){return typeof this._nativeDynamicsCompressorNode.reduction.value=="number"?this._nativeDynamicsCompressorNode.reduction.value:this._nativeDynamicsCompressorNode.reduction}get release(){return this._release}get threshold(){return this._threshold}})(He,mn,k0,Kp,_s,we,ue,$i),R0=((p,n,o,c,f)=>()=>{const v=new WeakMap;return{render(B,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(F,I)=>{let M=o(F);const k=st(M,I);if(!k){const L={channelCount:M.channelCount,channelCountMode:M.channelCountMode,channelInterpretation:M.channelInterpretation,gain:M.gain.value};M=n(I,L)}return v.set(I,M),k?await p(I,F.gain,M.gain):await c(I,F.gain,M.gain),await f(F,I,M),M})(B,_)}}})(Mn,Us,de,Un,as),H0=((p,n,o,c,f,v)=>class extends p{constructor(B,_){const S=f(B),F={...t0,..._},I=c(S,F),M=v(S);super(B,!1,I,M?o():null),this._gain=n(this,M,I.gain,Nt,Pt)}get gain(){return this._gain}})(He,mn,R0,Us,we,ue),N0=((p,n,o,c)=>(f,v,{channelCount:B,channelCountMode:_,channelInterpretation:S,feedback:F,feedforward:I})=>{const M=Cp(v,f.sampleRate),k=F instanceof Float64Array?F:new Float64Array(F),L=I instanceof Float64Array?I:new Float64Array(I),K=k.length,V=L.length,N=Math.min(K,V);if(K===0||K>20)throw c();if(k[0]===0)throw n();if(V===0||V>20)throw c();if(L[0]===0)throw n();if(k[0]!==1){for(let j=0;j<V;j+=1)L[j]/=k[0];for(let j=1;j<K;j+=1)k[j]/=k[0]}const z=o(f,M,B,B);z.channelCount=B,z.channelCountMode=_,z.channelInterpretation=S;const q=[],O=[],it=[];for(let j=0;j<B;j+=1){q.push(0);const et=new Float32Array(32),$=new Float32Array(32);et.fill(0),$.fill(0),O.push(et),it.push($)}z.onaudioprocess=j=>{const et=j.inputBuffer,$=j.outputBuffer,ut=et.numberOfChannels;for(let tt=0;tt<ut;tt+=1){const ot=et.getChannelData(tt),gt=$.getChannelData(tt);q[tt]=Bp(k,K,L,V,N,O[tt],it[tt],q[tt],32,ot,gt)}};const lt=f.sampleRate/2;return _A({get bufferSize(){return M},get channelCount(){return z.channelCount},set channelCount(j){z.channelCount=j},get channelCountMode(){return z.channelCountMode},set channelCountMode(j){z.channelCountMode=j},get channelInterpretation(){return z.channelInterpretation},set channelInterpretation(j){z.channelInterpretation=j},get context(){return z.context},get inputs(){return[z]},get numberOfInputs(){return z.numberOfInputs},get numberOfOutputs(){return z.numberOfOutputs},addEventListener:(...j)=>z.addEventListener(j[0],j[1],j[2]),dispatchEvent:(...j)=>z.dispatchEvent(j[0]),getFrequencyResponse(j,et,$){if(j.length!==et.length||et.length!==$.length)throw p();const ut=j.length;for(let tt=0;tt<ut;tt+=1){const ot=-Math.PI*(j[tt]/lt),gt=[Math.cos(ot),Math.sin(ot)],wt=n0(xp(L,gt),xp(k,gt));et[tt]=Math.sqrt(wt[0]*wt[0]+wt[1]*wt[1]),$[tt]=Math.atan2(wt[1],wt[0])}},removeEventListener:(...j)=>z.removeEventListener(j[0],j[1],j[2])},z)})(Ia,ts,Pr,_s),Ua=((p,n,o,c)=>f=>p(Mr,(()=>Mr(f)))?Promise.resolve(p(c,c)).then((v=>{if(!v){const B=o(f,512,0,1);f.oncomplete=()=>{B.onaudioprocess=null,B.disconnect()},B.onaudioprocess=()=>f.currentTime,B.connect(f.destination)}return f.startRendering()})):new Promise((v=>{const B=n(f,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});f.oncomplete=_=>{B.disconnect(),v(_.renderedBuffer)},B.connect(f.destination),f.startRendering()})))(tn,Us,Pr,((p,n)=>()=>{if(n===null)return Promise.resolve(!1);const o=new n(1,1,44100),c=p(o,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return new Promise((f=>{o.oncomplete=()=>{c.disconnect(),f(o.currentTime!==0)},o.startRendering()}))})(Us,es)),O0=((p,n,o,c,f)=>(v,B)=>{const _=new WeakMap;let S=null;return{render(F,I){const M=_.get(I);return M!==void 0?Promise.resolve(M):(async(k,L)=>{let K=null,V=n(k);const N=st(V,L);if(L.createIIRFilter===void 0?K=p(L,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}):N||(V=L.createIIRFilter(B,v)),_.set(L,K===null?V:K),K!==null){if(S===null){if(o===null)throw new Error("Missing the native OfflineAudioContext constructor.");const q=new o(k.context.destination.channelCount,k.context.length,L.sampleRate);S=(async()=>(await c(k,q,q.destination),((O,it,lt,j)=>{const et=lt instanceof Float64Array?lt:new Float64Array(lt),$=j instanceof Float64Array?j:new Float64Array(j),ut=et.length,tt=$.length,ot=Math.min(ut,tt);if(et[0]!==1){for(let St=0;St<ut;St+=1)$[St]/=et[0];for(let St=1;St<tt;St+=1)et[St]/=et[0]}const gt=new Float32Array(32),wt=new Float32Array(32),kt=it.createBuffer(O.numberOfChannels,O.length,O.sampleRate),Ft=O.numberOfChannels;for(let St=0;St<Ft;St+=1){const Rt=O.getChannelData(St),bt=kt.getChannelData(St);gt.fill(0),wt.fill(0),Bp(et,ut,$,tt,ot,gt,wt,0,32,Rt,bt)}return kt})(await f(q),L,v,B)))()}const z=await S;return K.buffer=z,K.start(0),K}return await c(k,L,V),V})(F,I)}}})(SA,de,es,as,Ua),V0=(p=>(n,o,c)=>{if(n.createIIRFilter===void 0)return p(n,o,c);const f=n.createIIRFilter(c.feedforward,c.feedback);return $e(f,c),f})(N0),W0=((p,n,o,c,f,v)=>class extends p{constructor(B,_){const S=c(B),F=f(S),I={...e0,..._},M=n(S,F?null:B.baseLatency,I);super(B,!1,M,F?o(I.feedback,I.feedforward):null),(k=>{var L;k.getFrequencyResponse=(L=k.getFrequencyResponse,(K,V,N)=>{if(K.length!==V.length||V.length!==N.length)throw Ia();return L.call(k,K,V,N)})})(M),this._nativeIIRFilterNode=M,v(this,1)}getFrequencyResponse(B,_,S){return this._nativeIIRFilterNode.getFrequencyResponse(B,_,S)}})(He,V0,O0,we,ue,$i),K0=((p,n,o,c,f,v,B,_)=>(S,F)=>{const I=F.listener,{forwardX:M,forwardY:k,forwardZ:L,positionX:K,positionY:V,positionZ:N,upX:z,upY:q,upZ:O}=I.forwardX===void 0?(()=>{const it=new Float32Array(1),lt=n(F,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:9}),j=B(F);let et=!1,$=[0,0,-1,0,1,0],ut=[0,0,0];const tt=()=>{if(et)return;et=!0;const kt=c(F,256,9,0);kt.onaudioprocess=({inputBuffer:Ft})=>{const St=[v(Ft,it,0),v(Ft,it,1),v(Ft,it,2),v(Ft,it,3),v(Ft,it,4),v(Ft,it,5)];St.some(((bt,Vt)=>bt!==$[Vt]))&&(I.setOrientation(...St),$=St);const Rt=[v(Ft,it,6),v(Ft,it,7),v(Ft,it,8)];Rt.some(((bt,Vt)=>bt!==ut[Vt]))&&(I.setPosition(...Rt),ut=Rt)},lt.connect(kt)},ot=kt=>Ft=>{Ft!==$[kt]&&($[kt]=Ft,I.setOrientation(...$))},gt=kt=>Ft=>{Ft!==ut[kt]&&(ut[kt]=Ft,I.setPosition(...ut))},wt=(kt,Ft,St)=>{const Rt=o(F,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Ft});Rt.connect(lt,0,kt),Rt.start(),Object.defineProperty(Rt.offset,"defaultValue",{get:()=>Ft});const bt=p({context:S},j,Rt.offset,Nt,Pt);var Vt,jt,se,ye,De,Ds,Yt;return _(bt,"value",(yt=>()=>yt.call(bt)),(yt=>pe=>{try{yt.call(bt,pe)}catch(ce){if(ce.code!==9)throw ce}tt(),j&&St(pe)})),bt.cancelAndHoldAtTime=(Vt=bt.cancelAndHoldAtTime,j?()=>{throw f()}:(...yt)=>{const pe=Vt.apply(bt,yt);return tt(),pe}),bt.cancelScheduledValues=(jt=bt.cancelScheduledValues,j?()=>{throw f()}:(...yt)=>{const pe=jt.apply(bt,yt);return tt(),pe}),bt.exponentialRampToValueAtTime=(se=bt.exponentialRampToValueAtTime,j?()=>{throw f()}:(...yt)=>{const pe=se.apply(bt,yt);return tt(),pe}),bt.linearRampToValueAtTime=(ye=bt.linearRampToValueAtTime,j?()=>{throw f()}:(...yt)=>{const pe=ye.apply(bt,yt);return tt(),pe}),bt.setTargetAtTime=(De=bt.setTargetAtTime,j?()=>{throw f()}:(...yt)=>{const pe=De.apply(bt,yt);return tt(),pe}),bt.setValueAtTime=(Ds=bt.setValueAtTime,j?()=>{throw f()}:(...yt)=>{const pe=Ds.apply(bt,yt);return tt(),pe}),bt.setValueCurveAtTime=(Yt=bt.setValueCurveAtTime,j?()=>{throw f()}:(...yt)=>{const pe=Yt.apply(bt,yt);return tt(),pe}),bt};return{forwardX:wt(0,0,ot(0)),forwardY:wt(1,0,ot(1)),forwardZ:wt(2,-1,ot(2)),positionX:wt(6,0,gt(0)),positionY:wt(7,0,gt(1)),positionZ:wt(8,0,gt(2)),upX:wt(3,0,ot(3)),upY:wt(4,1,ot(4)),upZ:wt(5,0,ot(5))}})():I;return{get forwardX(){return M},get forwardY(){return k},get forwardZ(){return L},get positionX(){return K},get positionY(){return V},get positionZ(){return N},get upX(){return z},get upY(){return q},get upZ(){return O}}})(mn,mi,FA,Pr,_s,Ep,ue,Dr),Gp=new WeakMap,G0=((p,n,o,c,f,v)=>class extends o{constructor(B,_){super(B),this._nativeContext=B,E.set(this,B),c(B)&&f.set(B,new Set),this._destination=new p(this,_),this._listener=n(this,B),this._onstatechange=null}get currentTime(){return this._nativeContext.currentTime}get destination(){return this._destination}get listener(){return this._listener}get onstatechange(){return this._onstatechange}set onstatechange(B){const _=typeof B=="function"?v(this,B):null;this._nativeContext.onstatechange=_;const S=this._nativeContext.onstatechange;this._onstatechange=S!==null&&S===_?B:S}get sampleRate(){return this._nativeContext.sampleRate}get state(){return this._nativeContext.state}})(y0,K0,Dp,ue,Gp,xA),qp=((p,n,o,c,f,v)=>(B,_)=>{const S=B.createOscillator();return $e(S,_),Ue(S,_,"detune"),Ue(S,_,"frequency"),_.periodicWave!==void 0?S.setPeriodicWave(_.periodicWave):xe(S,_,"type"),n(o,(()=>o(B)))||su(S),n(c,(()=>c(B)))||v(S,B),n(f,(()=>f(B)))||nu(S),p(B,S),S})(Ma,tn,iu,Tp,Au,Ip),q0=((p,n,o,c,f)=>()=>{const v=new WeakMap;let B=null,_=null,S=null;return{set periodicWave(F){B=F},set start(F){_=F},set stop(F){S=F},render(F,I){const M=v.get(I);return M!==void 0?Promise.resolve(M):(async(k,L)=>{let K=o(k);const V=st(K,L);if(!V){const N={channelCount:K.channelCount,channelCountMode:K.channelCountMode,channelInterpretation:K.channelInterpretation,detune:K.detune.value,frequency:K.frequency.value,periodicWave:B===null?void 0:B,type:K.type};K=n(L,N),_!==null&&K.start(_),S!==null&&K.stop(S)}return v.set(L,K),V?(await p(L,k.detune,K.detune),await p(L,k.frequency,K.frequency)):(await c(L,k.detune,K.detune),await c(L,k.frequency,K.frequency)),await f(k,L,K),K})(F,I)}}})(Mn,qp,de,Un,as),z0=((p,n,o,c,f,v,B)=>class extends p{constructor(_,S){const F=f(_),I={...A0,...S},M=o(F,I),k=v(F),L=k?c():null,K=_.sampleRate/2;super(_,!1,M,L),this._detune=n(this,k,M.detune,153600,-153600),this._frequency=n(this,k,M.frequency,K,-K),this._nativeOscillatorNode=M,this._onended=null,this._oscillatorNodeRenderer=L,this._oscillatorNodeRenderer!==null&&I.periodicWave!==void 0&&(this._oscillatorNodeRenderer.periodicWave=I.periodicWave)}get detune(){return this._detune}get frequency(){return this._frequency}get onended(){return this._onended}set onended(_){const S=typeof _=="function"?B(this,_):null;this._nativeOscillatorNode.onended=S;const F=this._nativeOscillatorNode.onended;this._onended=F!==null&&F===S?_:F}get type(){return this._nativeOscillatorNode.type}set type(_){this._nativeOscillatorNode.type=_,this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=null)}setPeriodicWave(_){this._nativeOscillatorNode.setPeriodicWave(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.periodicWave=_)}start(_=0){if(this._nativeOscillatorNode.start(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.start=_),this.context.state!=="closed"){X(this);const S=()=>{this._nativeOscillatorNode.removeEventListener("ended",S),Wt(this)&&mt(this)};this._nativeOscillatorNode.addEventListener("ended",S)}}stop(_=0){this._nativeOscillatorNode.stop(_),this._oscillatorNodeRenderer!==null&&(this._oscillatorNodeRenderer.stop=_)}})(He,mn,qp,q0,we,ue,xA),zp=(p=>(n,o)=>{const c=p(n,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),f=n.createBuffer(1,2,44100);return c.buffer=f,c.loop=!0,c.connect(o),c.start(),()=>{c.stop(),c.disconnect(o)}})(SA),$0=((p,n,o,c,f)=>(v,{curve:B,oversample:_,...S})=>{const F=v.createWaveShaper(),I=v.createWaveShaper();$e(F,S),$e(I,S);const M=o(v,{...S,gain:1}),k=o(v,{...S,gain:-1}),L=o(v,{...S,gain:1}),K=o(v,{...S,gain:-1});let V=null,N=!1,z=null;const q={get bufferSize(){},get channelCount(){return F.channelCount},set channelCount(O){M.channelCount=O,k.channelCount=O,F.channelCount=O,L.channelCount=O,I.channelCount=O,K.channelCount=O},get channelCountMode(){return F.channelCountMode},set channelCountMode(O){M.channelCountMode=O,k.channelCountMode=O,F.channelCountMode=O,L.channelCountMode=O,I.channelCountMode=O,K.channelCountMode=O},get channelInterpretation(){return F.channelInterpretation},set channelInterpretation(O){M.channelInterpretation=O,k.channelInterpretation=O,F.channelInterpretation=O,L.channelInterpretation=O,I.channelInterpretation=O,K.channelInterpretation=O},get context(){return F.context},get curve(){return z},set curve(O){if(O!==null&&O.length<2)throw n();if(O===null)F.curve=O,I.curve=O;else{const it=O.length,lt=new Float32Array(it+2-it%2),j=new Float32Array(it+2-it%2);lt[0]=O[0],j[0]=-O[it-1];const et=Math.ceil((it+1)/2),$=(it+1)/2-1;for(let ut=1;ut<et;ut+=1){const tt=ut/et*$,ot=Math.floor(tt),gt=Math.ceil(tt);lt[ut]=ot===gt?O[ot]:(1-(tt-ot))*O[ot]+(1-(gt-tt))*O[gt],j[ut]=ot===gt?-O[it-1-ot]:-(1-(tt-ot))*O[it-1-ot]-(1-(gt-tt))*O[it-1-gt]}lt[et]=it%2==1?O[et-1]:(O[et-2]+O[et-1])/2,F.curve=lt,I.curve=j}z=O,N&&(c(z)&&V===null?V=p(v,M):V!==null&&(V(),V=null))},get inputs(){return[M]},get numberOfInputs(){return F.numberOfInputs},get numberOfOutputs(){return F.numberOfOutputs},get oversample(){return F.oversample},set oversample(O){F.oversample=O,I.oversample=O},addEventListener:(...O)=>M.addEventListener(O[0],O[1],O[2]),dispatchEvent:(...O)=>M.dispatchEvent(O[0]),removeEventListener:(...O)=>M.removeEventListener(O[0],O[1],O[2])};return B!==null&&(q.curve=B instanceof Float32Array?B:new Float32Array(B)),_!==q.oversample&&(q.oversample=_),f(_A(q,L),(()=>{M.connect(F).connect(L),M.connect(k).connect(I).connect(K).connect(L),N=!0,c(z)&&(V=p(v,M))}),(()=>{M.disconnect(F),F.disconnect(L),M.disconnect(k),k.disconnect(I),I.disconnect(K),K.disconnect(L),N=!1,V!==null&&(V(),V=null)}))})(zp,ts,Us,Sp,pi),Pa=((p,n,o,c,f,v,B)=>(_,S)=>{const F=_.createWaveShaper();if(v!==null&&v.name==="webkitAudioContext"&&_.createGain().gain.automationRate===void 0)return o(_,S);$e(F,S);const I=S.curve===null||S.curve instanceof Float32Array?S.curve:new Float32Array(S.curve);if(I!==null&&I.length<2)throw n();xe(F,{curve:I},"curve"),xe(F,S,"oversample");let M=null,k=!1;return B(F,"curve",(L=>()=>L.call(F)),(L=>K=>(L.call(F,K),k&&(c(K)&&M===null?M=p(_,F):c(K)||M===null||(M(),M=null)),K))),f(F,(()=>{k=!0,c(F.curve)&&(M=p(_,F))}),(()=>{k=!1,M!==null&&(M(),M=null)}))})(zp,ts,$0,Sp,pi,fi,Dr),X0=((p,n,o,c,f,v,B,_,S,F)=>(I,{coneInnerAngle:M,coneOuterAngle:k,coneOuterGain:L,distanceModel:K,maxDistance:V,orientationX:N,orientationY:z,orientationZ:q,panningModel:O,positionX:it,positionY:lt,positionZ:j,refDistance:et,rolloffFactor:$,...ut})=>{const tt=I.createPanner();if(ut.channelCount>2||ut.channelCountMode==="max")throw B();$e(tt,ut);const ot={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},gt=o(I,{...ot,channelInterpretation:"speakers",numberOfInputs:6}),wt=c(I,{...ut,gain:1}),kt=c(I,{...ot,gain:1}),Ft=c(I,{...ot,gain:0}),St=c(I,{...ot,gain:0}),Rt=c(I,{...ot,gain:0}),bt=c(I,{...ot,gain:0}),Vt=c(I,{...ot,gain:0}),jt=f(I,256,6,1),se=v(I,{...ot,curve:new Float32Array([1,1]),oversample:"none"});let ye=[N,z,q],De=[it,lt,j];const Ds=new Float32Array(1);jt.onaudioprocess=({inputBuffer:yt})=>{const pe=[S(yt,Ds,0),S(yt,Ds,1),S(yt,Ds,2)];pe.some(((fs,xi)=>fs!==ye[xi]))&&(tt.setOrientation(...pe),ye=pe);const ce=[S(yt,Ds,3),S(yt,Ds,4),S(yt,Ds,5)];ce.some(((fs,xi)=>fs!==De[xi]))&&(tt.setPosition(...ce),De=ce)},Object.defineProperty(Ft.gain,"defaultValue",{get:()=>0}),Object.defineProperty(St.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Rt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(bt.gain,"defaultValue",{get:()=>0}),Object.defineProperty(Vt.gain,"defaultValue",{get:()=>0});const Yt={get bufferSize(){},get channelCount(){return tt.channelCount},set channelCount(yt){if(yt>2)throw B();wt.channelCount=yt,tt.channelCount=yt},get channelCountMode(){return tt.channelCountMode},set channelCountMode(yt){if(yt==="max")throw B();wt.channelCountMode=yt,tt.channelCountMode=yt},get channelInterpretation(){return tt.channelInterpretation},set channelInterpretation(yt){wt.channelInterpretation=yt,tt.channelInterpretation=yt},get coneInnerAngle(){return tt.coneInnerAngle},set coneInnerAngle(yt){tt.coneInnerAngle=yt},get coneOuterAngle(){return tt.coneOuterAngle},set coneOuterAngle(yt){tt.coneOuterAngle=yt},get coneOuterGain(){return tt.coneOuterGain},set coneOuterGain(yt){if(yt<0||yt>1)throw n();tt.coneOuterGain=yt},get context(){return tt.context},get distanceModel(){return tt.distanceModel},set distanceModel(yt){tt.distanceModel=yt},get inputs(){return[wt]},get maxDistance(){return tt.maxDistance},set maxDistance(yt){if(yt<0)throw new RangeError;tt.maxDistance=yt},get numberOfInputs(){return tt.numberOfInputs},get numberOfOutputs(){return tt.numberOfOutputs},get orientationX(){return kt.gain},get orientationY(){return Ft.gain},get orientationZ(){return St.gain},get panningModel(){return tt.panningModel},set panningModel(yt){tt.panningModel=yt},get positionX(){return Rt.gain},get positionY(){return bt.gain},get positionZ(){return Vt.gain},get refDistance(){return tt.refDistance},set refDistance(yt){if(yt<0)throw new RangeError;tt.refDistance=yt},get rolloffFactor(){return tt.rolloffFactor},set rolloffFactor(yt){if(yt<0)throw new RangeError;tt.rolloffFactor=yt},addEventListener:(...yt)=>wt.addEventListener(yt[0],yt[1],yt[2]),dispatchEvent:(...yt)=>wt.dispatchEvent(yt[0]),removeEventListener:(...yt)=>wt.removeEventListener(yt[0],yt[1],yt[2])};return M!==Yt.coneInnerAngle&&(Yt.coneInnerAngle=M),k!==Yt.coneOuterAngle&&(Yt.coneOuterAngle=k),L!==Yt.coneOuterGain&&(Yt.coneOuterGain=L),K!==Yt.distanceModel&&(Yt.distanceModel=K),V!==Yt.maxDistance&&(Yt.maxDistance=V),N!==Yt.orientationX.value&&(Yt.orientationX.value=N),z!==Yt.orientationY.value&&(Yt.orientationY.value=z),q!==Yt.orientationZ.value&&(Yt.orientationZ.value=q),O!==Yt.panningModel&&(Yt.panningModel=O),it!==Yt.positionX.value&&(Yt.positionX.value=it),lt!==Yt.positionY.value&&(Yt.positionY.value=lt),j!==Yt.positionZ.value&&(Yt.positionZ.value=j),et!==Yt.refDistance&&(Yt.refDistance=et),$!==Yt.rolloffFactor&&(Yt.rolloffFactor=$),ye[0]===1&&ye[1]===0&&ye[2]===0||tt.setOrientation(...ye),De[0]===0&&De[1]===0&&De[2]===0||tt.setPosition(...De),F(_A(Yt,tt),(()=>{wt.connect(tt),p(wt,se,0,0),se.connect(kt).connect(gt,0,0),se.connect(Ft).connect(gt,0,1),se.connect(St).connect(gt,0,2),se.connect(Rt).connect(gt,0,3),se.connect(bt).connect(gt,0,4),se.connect(Vt).connect(gt,0,5),gt.connect(jt).connect(I.destination)}),(()=>{wt.disconnect(tt),_(wt,se,0,0),se.disconnect(kt),kt.disconnect(gt),se.disconnect(Ft),Ft.disconnect(gt),se.disconnect(St),St.disconnect(gt),se.disconnect(Rt),Rt.disconnect(gt),se.disconnect(bt),bt.disconnect(gt),se.disconnect(Vt),Vt.disconnect(gt),gt.disconnect(jt),jt.disconnect(I.destination)}))})(Me,ts,mi,Us,Pr,Pa,_s,di,Ep,pi),$p=(p=>(n,o)=>{const c=n.createPanner();return c.orientationX===void 0?p(n,o):($e(c,o),Ue(c,o,"orientationX"),Ue(c,o,"orientationY"),Ue(c,o,"orientationZ"),Ue(c,o,"positionX"),Ue(c,o,"positionY"),Ue(c,o,"positionZ"),xe(c,o,"coneInnerAngle"),xe(c,o,"coneOuterAngle"),xe(c,o,"coneOuterGain"),xe(c,o,"distanceModel"),xe(c,o,"maxDistance"),xe(c,o,"panningModel"),xe(c,o,"refDistance"),xe(c,o,"rolloffFactor"),c)})(X0),Y0=((p,n,o,c,f,v,B,_,S,F)=>()=>{const I=new WeakMap;let M=null;return{render(k,L){const K=I.get(L);return K!==void 0?Promise.resolve(K):(async(V,N)=>{let z=null,q=v(V);const O={channelCount:q.channelCount,channelCountMode:q.channelCountMode,channelInterpretation:q.channelInterpretation},it={...O,coneInnerAngle:q.coneInnerAngle,coneOuterAngle:q.coneOuterAngle,coneOuterGain:q.coneOuterGain,distanceModel:q.distanceModel,maxDistance:q.maxDistance,panningModel:q.panningModel,refDistance:q.refDistance,rolloffFactor:q.rolloffFactor},lt=st(q,N);if("bufferSize"in q)z=c(N,{...O,gain:1});else if(!lt){const j={...it,orientationX:q.orientationX.value,orientationY:q.orientationY.value,orientationZ:q.orientationZ.value,positionX:q.positionX.value,positionY:q.positionY.value,positionZ:q.positionZ.value};q=f(N,j)}if(I.set(N,z===null?q:z),z!==null){if(M===null){if(B===null)throw new Error("Missing the native OfflineAudioContext constructor.");const wt=new B(6,V.context.length,N.sampleRate),kt=n(wt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:6});kt.connect(wt.destination),M=(async()=>{const Ft=await Promise.all([V.orientationX,V.orientationY,V.orientationZ,V.positionX,V.positionY,V.positionZ].map((async(St,Rt)=>{const bt=o(wt,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:Rt===0?1:0});return await _(wt,St,bt.offset),bt})));for(let St=0;St<6;St+=1)Ft[St].connect(kt,0,St),Ft[St].start(0);return F(wt)})()}const j=await M,et=c(N,{...O,gain:1});await S(V,N,et);const $=[];for(let wt=0;wt<j.numberOfChannels;wt+=1)$.push(j.getChannelData(wt));let ut=[$[0][0],$[1][0],$[2][0]],tt=[$[3][0],$[4][0],$[5][0]],ot=c(N,{...O,gain:1}),gt=f(N,{...it,orientationX:ut[0],orientationY:ut[1],orientationZ:ut[2],positionX:tt[0],positionY:tt[1],positionZ:tt[2]});et.connect(ot).connect(gt.inputs[0]),gt.connect(z);for(let wt=128;wt<j.length;wt+=128){const kt=[$[0][wt],$[1][wt],$[2][wt]],Ft=[$[3][wt],$[4][wt],$[5][wt]];if(kt.some(((St,Rt)=>St!==ut[Rt]))||Ft.some(((St,Rt)=>St!==tt[Rt]))){ut=kt,tt=Ft;const St=wt/N.sampleRate;ot.gain.setValueAtTime(0,St),ot=c(N,{...O,gain:0}),gt=f(N,{...it,orientationX:ut[0],orientationY:ut[1],orientationZ:ut[2],positionX:tt[0],positionY:tt[1],positionZ:tt[2]}),ot.gain.setValueAtTime(1,St),et.connect(ot).connect(gt.inputs[0]),gt.connect(z)}}return z}return lt?(await p(N,V.orientationX,q.orientationX),await p(N,V.orientationY,q.orientationY),await p(N,V.orientationZ,q.orientationZ),await p(N,V.positionX,q.positionX),await p(N,V.positionY,q.positionY),await p(N,V.positionZ,q.positionZ)):(await _(N,V.orientationX,q.orientationX),await _(N,V.orientationY,q.orientationY),await _(N,V.orientationZ,q.orientationZ),await _(N,V.positionX,q.positionX),await _(N,V.positionY,q.positionY),await _(N,V.positionZ,q.positionZ)),$t(q)?await S(V,N,q.inputs[0]):await S(V,N,q),q})(k,L)}}})(Mn,mi,FA,Us,$p,de,es,Un,as,Ua),j0=((p,n,o,c,f,v,B)=>class extends p{constructor(_,S){const F=f(_),I={...r0,...S},M=o(F,I),k=v(F);super(_,!1,M,k?c():null),this._nativePannerNode=M,this._orientationX=n(this,k,M.orientationX,Nt,Pt),this._orientationY=n(this,k,M.orientationY,Nt,Pt),this._orientationZ=n(this,k,M.orientationZ,Nt,Pt),this._positionX=n(this,k,M.positionX,Nt,Pt),this._positionY=n(this,k,M.positionY,Nt,Pt),this._positionZ=n(this,k,M.positionZ,Nt,Pt),B(this,1)}get coneInnerAngle(){return this._nativePannerNode.coneInnerAngle}set coneInnerAngle(_){this._nativePannerNode.coneInnerAngle=_}get coneOuterAngle(){return this._nativePannerNode.coneOuterAngle}set coneOuterAngle(_){this._nativePannerNode.coneOuterAngle=_}get coneOuterGain(){return this._nativePannerNode.coneOuterGain}set coneOuterGain(_){this._nativePannerNode.coneOuterGain=_}get distanceModel(){return this._nativePannerNode.distanceModel}set distanceModel(_){this._nativePannerNode.distanceModel=_}get maxDistance(){return this._nativePannerNode.maxDistance}set maxDistance(_){this._nativePannerNode.maxDistance=_}get orientationX(){return this._orientationX}get orientationY(){return this._orientationY}get orientationZ(){return this._orientationZ}get panningModel(){return this._nativePannerNode.panningModel}set panningModel(_){this._nativePannerNode.panningModel=_}get positionX(){return this._positionX}get positionY(){return this._positionY}get positionZ(){return this._positionZ}get refDistance(){return this._nativePannerNode.refDistance}set refDistance(_){this._nativePannerNode.refDistance=_}get rolloffFactor(){return this._nativePannerNode.rolloffFactor}set rolloffFactor(_){this._nativePannerNode.rolloffFactor=_}})(He,mn,$p,Y0,we,ue,$i),J0=(p=>(n,{disableNormalization:o,imag:c,real:f})=>{const v=c instanceof Float32Array?c:new Float32Array(c),B=f instanceof Float32Array?f:new Float32Array(f),_=n.createPeriodicWave(B,v,{disableNormalization:o});if(Array.from(c).length<2)throw p();return _})(vt),Z0=((p,n,o,c)=>class tv{constructor(v,B){const _=n(v),S=(I=>{const{imag:M,real:k}=I;return M===void 0?k===void 0?{...I,imag:[0,0],real:[0,0]}:{...I,imag:Array.from(k,(()=>0)),real:k}:k===void 0?{...I,imag:M,real:Array.from(M,(()=>0))}:{...I,imag:M,real:k}})({...o0,...B}),F=p(_,S);return o.add(F),F}static[Symbol.hasInstance](v){return v!==null&&typeof v=="object"&&Object.getPrototypeOf(v)===tv.prototype||o.has(v)}})(J0,we,new WeakSet),tC=((p,n,o,c,f,v)=>{const _=new Float32Array([1,1]),S=Math.PI/2,F={channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete"},I={...F,oversample:"none"},M=(k,L,K,V,N)=>{if(L===1)return((z,q,O,it)=>{const lt=new Float32Array(16385),j=new Float32Array(16385);for(let gt=0;gt<16385;gt+=1){const wt=gt/16384*S;lt[gt]=Math.cos(wt),j[gt]=Math.sin(wt)}const et=o(z,{...F,gain:0}),$=c(z,{...I,curve:lt}),ut=c(z,{...I,curve:_}),tt=o(z,{...F,gain:0}),ot=c(z,{...I,curve:j});return{connectGraph(){q.connect(et),q.connect(ut.inputs===void 0?ut:ut.inputs[0]),q.connect(tt),ut.connect(O),O.connect($.inputs===void 0?$:$.inputs[0]),O.connect(ot.inputs===void 0?ot:ot.inputs[0]),$.connect(et.gain),ot.connect(tt.gain),et.connect(it,0,0),tt.connect(it,0,1)},disconnectGraph(){q.disconnect(et),q.disconnect(ut.inputs===void 0?ut:ut.inputs[0]),q.disconnect(tt),ut.disconnect(O),O.disconnect($.inputs===void 0?$:$.inputs[0]),O.disconnect(ot.inputs===void 0?ot:ot.inputs[0]),$.disconnect(et.gain),ot.disconnect(tt.gain),et.disconnect(it,0,0),tt.disconnect(it,0,1)}}})(k,K,V,N);if(L===2)return((z,q,O,it)=>{const lt=new Float32Array(16385),j=new Float32Array(16385),et=new Float32Array(16385),$=new Float32Array(16385),ut=Math.floor(8192.5);for(let jt=0;jt<16385;jt+=1)if(jt>ut){const se=(jt-ut)/(16384-ut)*S;lt[jt]=Math.cos(se),j[jt]=Math.sin(se),et[jt]=0,$[jt]=1}else{const se=jt/(16384-ut)*S;lt[jt]=1,j[jt]=0,et[jt]=Math.cos(se),$[jt]=Math.sin(se)}const tt=n(z,{channelCount:2,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:2}),ot=o(z,{...F,gain:0}),gt=c(z,{...I,curve:lt}),wt=o(z,{...F,gain:0}),kt=c(z,{...I,curve:j}),Ft=c(z,{...I,curve:_}),St=o(z,{...F,gain:0}),Rt=c(z,{...I,curve:et}),bt=o(z,{...F,gain:0}),Vt=c(z,{...I,curve:$});return{connectGraph(){q.connect(tt),q.connect(Ft.inputs===void 0?Ft:Ft.inputs[0]),tt.connect(ot,0),tt.connect(wt,0),tt.connect(St,1),tt.connect(bt,1),Ft.connect(O),O.connect(gt.inputs===void 0?gt:gt.inputs[0]),O.connect(kt.inputs===void 0?kt:kt.inputs[0]),O.connect(Rt.inputs===void 0?Rt:Rt.inputs[0]),O.connect(Vt.inputs===void 0?Vt:Vt.inputs[0]),gt.connect(ot.gain),kt.connect(wt.gain),Rt.connect(St.gain),Vt.connect(bt.gain),ot.connect(it,0,0),St.connect(it,0,0),wt.connect(it,0,1),bt.connect(it,0,1)},disconnectGraph(){q.disconnect(tt),q.disconnect(Ft.inputs===void 0?Ft:Ft.inputs[0]),tt.disconnect(ot,0),tt.disconnect(wt,0),tt.disconnect(St,1),tt.disconnect(bt,1),Ft.disconnect(O),O.disconnect(gt.inputs===void 0?gt:gt.inputs[0]),O.disconnect(kt.inputs===void 0?kt:kt.inputs[0]),O.disconnect(Rt.inputs===void 0?Rt:Rt.inputs[0]),O.disconnect(Vt.inputs===void 0?Vt:Vt.inputs[0]),gt.disconnect(ot.gain),kt.disconnect(wt.gain),Rt.disconnect(St.gain),Vt.disconnect(bt.gain),ot.disconnect(it,0,0),St.disconnect(it,0,0),wt.disconnect(it,0,1),bt.disconnect(it,0,1)}}})(k,K,V,N);throw f()};return(k,{channelCount:L,channelCountMode:K,pan:V,...N})=>{if(K==="max")throw f();const z=p(k,{...N,channelCount:1,channelCountMode:K,numberOfInputs:2}),q=o(k,{...N,channelCount:L,channelCountMode:K,gain:1}),O=o(k,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:V});let{connectGraph:it,disconnectGraph:lt}=M(k,L,q,O,z);Object.defineProperty(O.gain,"defaultValue",{get:()=>0}),Object.defineProperty(O.gain,"maxValue",{get:()=>1}),Object.defineProperty(O.gain,"minValue",{get:()=>-1});const j={get bufferSize(){},get channelCount(){return q.channelCount},set channelCount($){q.channelCount!==$&&(et&&lt(),{connectGraph:it,disconnectGraph:lt}=M(k,$,q,O,z),et&&it()),q.channelCount=$},get channelCountMode(){return q.channelCountMode},set channelCountMode($){if($==="clamped-max"||$==="max")throw f();q.channelCountMode=$},get channelInterpretation(){return q.channelInterpretation},set channelInterpretation($){q.channelInterpretation=$},get context(){return q.context},get inputs(){return[q]},get numberOfInputs(){return q.numberOfInputs},get numberOfOutputs(){return q.numberOfOutputs},get pan(){return O.gain},addEventListener:(...$)=>q.addEventListener($[0],$[1],$[2]),dispatchEvent:(...$)=>q.dispatchEvent($[0]),removeEventListener:(...$)=>q.removeEventListener($[0],$[1],$[2])};let et=!1;return v(_A(j,z),(()=>{it(),et=!0}),(()=>{lt(),et=!1}))}})(mi,Ur,Us,Pa,_s,pi),Xp=((p,n)=>(o,c)=>{const f=c.channelCountMode;if(f==="clamped-max")throw n();if(o.createStereoPanner===void 0)return p(o,c);const v=o.createStereoPanner();return $e(v,c),Ue(v,c,"pan"),Object.defineProperty(v,"channelCountMode",{get:()=>f,set:B=>{if(B!==f)throw n()}}),v})(tC,_s),eC=((p,n,o,c,f)=>()=>{const v=new WeakMap;return{render(B,_){const S=v.get(_);return S!==void 0?Promise.resolve(S):(async(F,I)=>{let M=o(F);const k=st(M,I);if(!k){const L={channelCount:M.channelCount,channelCountMode:M.channelCountMode,channelInterpretation:M.channelInterpretation,pan:M.pan.value};M=n(I,L)}return v.set(I,M),k?await p(I,F.pan,M.pan):await c(I,F.pan,M.pan),$t(M)?await f(F,I,M.inputs[0]):await f(F,I,M),M})(B,_)}}})(Mn,Xp,de,Un,as),sC=((p,n,o,c,f,v)=>class extends p{constructor(B,_){const S=f(B),F={...a0,..._},I=o(S,F),M=v(S);super(B,!1,I,M?c():null),this._pan=n(this,M,I.pan)}get pan(){return this._pan}})(He,mn,Xp,eC,we,ue),nC=((p,n,o)=>()=>{const c=new WeakMap;return{render(f,v){const B=c.get(v);return B!==void 0?Promise.resolve(B):(async(_,S)=>{let F=n(_);if(!st(F,S)){const I={channelCount:F.channelCount,channelCountMode:F.channelCountMode,channelInterpretation:F.channelInterpretation,curve:F.curve,oversample:F.oversample};F=p(S,I)}return c.set(S,F),$t(F)?await o(_,S,F.inputs[0]):await o(_,S,F),F})(f,v)}}})(Pa,de,as),iC=((p,n,o,c,f,v,B)=>class extends p{constructor(_,S){const F=f(_),I={...c0,...S},M=o(F,I);super(_,!0,M,v(F)?c():null),this._isCurveNullified=!1,this._nativeWaveShaperNode=M,B(this,1)}get curve(){return this._isCurveNullified?null:this._nativeWaveShaperNode.curve}set curve(_){if(_===null)this._isCurveNullified=!0,this._nativeWaveShaperNode.curve=new Float32Array([0,0]);else{if(_.length<2)throw n();this._isCurveNullified=!1,this._nativeWaveShaperNode.curve=_}}get oversample(){return this._nativeWaveShaperNode.oversample}set oversample(_){this._nativeWaveShaperNode.oversample=_}})(He,ts,Pa,nC,we,ue,$i),Yp=(p=>p!==null&&p.isSecureContext)(pn),du=(p=>(n,o,c)=>{Object.defineProperties(p,{currentFrame:{configurable:!0,get:()=>Math.round(n*o)},currentTime:{configurable:!0,get:()=>n}});try{return c()}finally{p!==null&&(delete p.currentFrame,delete p.currentTime)}})(pn),jp=new WeakMap,AC=((p,n)=>o=>{let c=p.get(o);if(c!==void 0)return c;if(n===null)throw new Error("Missing the native OfflineAudioContext constructor.");return c=new n(1,1,44100),p.set(o,c),c})(jp,es),rC=Yp?((p,n,o,c,f,v,B,_,S,F,I,M,k)=>{let L=0;return(K,V,N={credentials:"omit"})=>{const z=I.get(K);if(z!==void 0&&z.has(V))return Promise.resolve();const q=F.get(K);if(q!==void 0){const lt=q.get(V);if(lt!==void 0)return lt}const O=v(K),it=O.audioWorklet===void 0?f(V).then((([lt,j])=>{const[et,$]=P(lt,j);return o(`${et};((a,b)=>{(a[b]=a[b]||[]).push((AudioWorkletProcessor,global,registerProcessor,sampleRate,self,window)=>{${$}
})})(window,'_AWGS')`)})).then((()=>{const lt=k._AWGS.pop();if(lt===void 0)throw new SyntaxError;c(O.currentTime,O.sampleRate,(()=>lt(class{},void 0,((j,et)=>{if(j.trim()==="")throw n();const $=U.get(O);if($!==void 0){if($.has(j))throw n();Y(et),G(et.parameterDescriptors),$.set(j,et)}else Y(et),G(et.parameterDescriptors),U.set(O,new Map([[j,et]]))}),O.sampleRate,void 0,void 0)))})):Promise.all([f(V),Promise.resolve(p(M,M))]).then((([[lt,j],et])=>{const $=L+1;L=$;const[ut,tt]=P(lt,j),ot=new Blob([`${ut};((AudioWorkletProcessor,registerProcessor)=>{${tt}
})(${et?"AudioWorkletProcessor":"class extends AudioWorkletProcessor {__b=new WeakSet();constructor(){super();(p=>p.postMessage=(q=>(m,t)=>q.call(p,m,t?t.filter(u=>!this.__b.has(u)):t))(p.postMessage))(this.port)}}"},(n,p)=>registerProcessor(n,class extends p{${et?"":"__c = (a) => a.forEach(e=>this.__b.add(e.buffer));"}process(i,o,p){${et?"":"i.forEach(this.__c);o.forEach(this.__c);this.__c(Object.values(p));"}return super.process(i.map(j=>j.some(k=>k.length===0)?[]:j),o,p)}}));registerProcessor('__sac${$}',class extends AudioWorkletProcessor{process(){return !1}})`],{type:"application/javascript; charset=utf-8"}),gt=URL.createObjectURL(ot);return O.audioWorklet.addModule(gt,N).then((()=>{if(_(O))return O;const wt=B(O);return wt.audioWorklet.addModule(gt,N).then((()=>wt))})).then((wt=>{if(S===null)throw new SyntaxError;try{new S(wt,`__sac${$}`)}catch{throw new SyntaxError}})).finally((()=>URL.revokeObjectURL(gt)))}));return q===void 0?F.set(K,new Map([[V,it]])):q.set(V,it),it.then((()=>{const lt=I.get(K);lt===void 0?I.set(K,new Set([V])):lt.add(V)})).finally((()=>{const lt=F.get(K);lt!==void 0&&lt.delete(V)})),it}})(tn,_s,(p=>n=>new Promise(((o,c)=>{if(p===null)return void c(new SyntaxError);const f=p.document.head;if(f===null)c(new SyntaxError);else{const v=p.document.createElement("script"),B=new Blob([n],{type:"application/javascript"}),_=URL.createObjectURL(B),S=p.onerror,F=()=>{p.onerror=S,URL.revokeObjectURL(_)};p.onerror=(I,M,k,L,K)=>M===_||M===p.location.href&&k===1&&L===1?(F(),c(K),!1):S!==null?S(I,M,k,L,K):void 0,v.onerror=()=>{F(),c(new SyntaxError)},v.onload=()=>{F(),o()},v.src=_,v.type="module",f.appendChild(v)}})))(pn),du,(async p=>{try{const n=await fetch(p);if(n.ok)return[await n.text(),n.url]}catch{}throw new DOMException("","AbortError")}),we,AC,ue,EA,new WeakMap,new WeakMap,((p,n)=>async()=>{if(p===null)return!0;if(n===null)return!1;const o=new Blob(['class A extends AudioWorkletProcessor{process(i){this.port.postMessage(i,[i[0][0].buffer])}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),c=new n(1,128,44100),f=URL.createObjectURL(o);let v=!1,B=!1;try{await c.audioWorklet.addModule(f);const _=new p(c,"a",{numberOfOutputs:0}),S=c.createOscillator();_.port.onmessage=()=>v=!0,_.onprocessorerror=()=>B=!0,S.connect(_),S.start(0),await c.startRendering(),await new Promise((F=>setTimeout(F)))}catch{}finally{URL.revokeObjectURL(f)}return v&&!B})(EA,es),pn):void 0,oC=((p,n)=>o=>p(o)||n(o))(ou,ue),aC=((p,n,o,c,f,v,B,_,S,F,I)=>(M,k)=>{const L=B(M)?M:v(M);if(f.has(k)){const K=new DOMException("","DataCloneError");return Promise.reject(K)}try{f.add(k)}catch{}return n(S,(()=>S(L)))?L.decodeAudioData(k).then((K=>(vp(k).catch((()=>{})),n(_,(()=>_(K)))||I(K),p.add(K),K))):new Promise(((K,V)=>{const N=async()=>{try{await vp(k)}catch{}},z=q=>{V(q),N()};try{L.decodeAudioData(k,(q=>{typeof q.copyFromChannel!="function"&&(F(q),ft(q)),p.add(q),N().then((()=>K(q)))}),(q=>{z(q===null?new DOMException("","EncodingError"):q)}))}catch(q){z(q)}}))})(lu,tn,0,0,new WeakSet,we,oC,At,Mr,uu,hu),Jp=((p,n,o,c,f,v,B,_,S,F,I,M,k,L,K,V,N,z,q,O)=>class extends K{constructor(it,lt){super(it,lt),this._nativeContext=it,this._audioWorklet=p===void 0?void 0:{addModule:(j,et)=>p(this,j,et)}}get audioWorklet(){return this._audioWorklet}createAnalyser(){return new n(this)}createBiquadFilter(){return new f(this)}createBuffer(it,lt,j){return new o({length:lt,numberOfChannels:it,sampleRate:j})}createBufferSource(){return new c(this)}createChannelMerger(it=6){return new v(this,{numberOfInputs:it})}createChannelSplitter(it=6){return new B(this,{numberOfOutputs:it})}createConstantSource(){return new _(this)}createConvolver(){return new S(this)}createDelay(it=1){return new I(this,{maxDelayTime:it})}createDynamicsCompressor(){return new M(this)}createGain(){return new k(this)}createIIRFilter(it,lt){return new L(this,{feedback:lt,feedforward:it})}createOscillator(){return new V(this)}createPanner(){return new N(this)}createPeriodicWave(it,lt,j={disableNormalization:!1}){return new z(this,{...j,imag:lt,real:it})}createStereoPanner(){return new q(this)}createWaveShaper(){return new O(this)}decodeAudioData(it,lt,j){return F(this._nativeContext,it).then((et=>(typeof lt=="function"&&lt(et),et)),(et=>{throw typeof j=="function"&&j(et),et}))}})(rC,w0,Np,B0,b0,E0,F0,Q0,U0,aC,D0,L0,H0,W0,G0,z0,j0,Z0,sC,iC),lC=((p,n,o,c)=>class extends p{constructor(f,v){const B=o(f),_=((S,F)=>S.createMediaElementSource(F.mediaElement))(B,v);if(c(B))throw TypeError();super(f,!0,_,null),this._nativeMediaElementAudioSourceNode=_}get mediaElement(){return this._nativeMediaElementAudioSourceNode.mediaElement}})(He,0,we,ue),cC=((p,n,o,c)=>class extends p{constructor(f,v){const B=o(f);if(c(B))throw new TypeError;const _=((S,F)=>{const I=S.createMediaStreamDestination();return $e(I,F),I.numberOfOutputs===1&&Object.defineProperty(I,"numberOfOutputs",{get:()=>0}),I})(B,{...s0,...v});super(f,!1,_,null),this._nativeMediaStreamAudioDestinationNode=_}get stream(){return this._nativeMediaStreamAudioDestinationNode.stream}})(He,0,we,ue),uC=((p,n,o,c)=>class extends p{constructor(f,v){const B=o(f),_=((S,{mediaStream:F})=>{const I=F.getAudioTracks();I.sort(((L,K)=>L.id<K.id?-1:L.id>K.id?1:0));const M=I.slice(0,1),k=S.createMediaStreamSource(new MediaStream(M));return Object.defineProperty(k,"mediaStream",{value:F}),k})(B,v);if(c(B))throw new TypeError;super(f,!0,_,null),this._nativeMediaStreamAudioSourceNode=_}get mediaStream(){return this._nativeMediaStreamAudioSourceNode.mediaStream}})(He,0,we,ue),hC=((p,n)=>(o,{mediaStreamTrack:c})=>{if(typeof o.createMediaStreamTrackSource=="function")return o.createMediaStreamTrackSource(c);const f=new MediaStream([c]),v=o.createMediaStreamSource(f);if(c.kind!=="audio")throw p();if(n(o))throw new TypeError;return v})(ts,ue),dC=((p,n,o)=>class extends p{constructor(c,f){const v=o(c);super(c,!0,n(v,f),null)}})(He,hC,we),fC=((p,n,o,c,f,v,B,_,S)=>class extends p{constructor(F={}){if(S===null)throw new Error("Missing the native AudioContext constructor.");let I;try{I=new S(F)}catch(L){throw L.code===12&&L.message==="sampleRate is not in range"?o():L}if(I===null)throw c();if(!(L=>L===void 0||typeof L=="number"||typeof L=="string"&&(L==="balanced"||L==="interactive"||L==="playback"))(F.latencyHint))throw new TypeError(`The provided value '${F.latencyHint}' is not a valid enum value of type AudioContextLatencyCategory.`);if(F.sampleRate!==void 0&&I.sampleRate!==F.sampleRate)throw o();super(I,2);const{latencyHint:M}=F,{sampleRate:k}=I;if(this._baseLatency=typeof I.baseLatency=="number"?I.baseLatency:M==="balanced"?512/k:M==="interactive"||M===void 0?256/k:M==="playback"?1024/k:128*Math.max(2,Math.min(128,Math.round(M*k/128)))/k,this._nativeAudioContext=I,S.name==="webkitAudioContext"?(this._nativeGainNode=I.createGain(),this._nativeOscillatorNode=I.createOscillator(),this._nativeGainNode.gain.value=1e-37,this._nativeOscillatorNode.connect(this._nativeGainNode).connect(I.destination),this._nativeOscillatorNode.start()):(this._nativeGainNode=null,this._nativeOscillatorNode=null),this._state=null,I.state==="running"){this._state="suspended";const L=()=>{this._state==="suspended"&&(this._state=null),I.removeEventListener("statechange",L)};I.addEventListener("statechange",L)}}get baseLatency(){return this._baseLatency}get state(){return this._state!==null?this._state:this._nativeAudioContext.state}close(){return this.state==="closed"?this._nativeAudioContext.close().then((()=>{throw n()})):(this._state==="suspended"&&(this._state=null),this._nativeAudioContext.close().then((()=>{this._nativeGainNode!==null&&this._nativeOscillatorNode!==null&&(this._nativeOscillatorNode.stop(),this._nativeGainNode.disconnect(),this._nativeOscillatorNode.disconnect()),ge(this)})))}createMediaElementSource(F){return new f(this,{mediaElement:F})}createMediaStreamDestination(){return new v(this)}createMediaStreamSource(F){return new B(this,{mediaStream:F})}createMediaStreamTrackSource(F){return new _(this,{mediaStreamTrack:F})}resume(){return this._state==="suspended"?new Promise(((F,I)=>{const M=()=>{this._nativeAudioContext.removeEventListener("statechange",M),this._nativeAudioContext.state==="running"?F():this.resume().then(F,I)};this._nativeAudioContext.addEventListener("statechange",M)})):this._nativeAudioContext.resume().catch((F=>{throw F===void 0||F.code===15?n():F}))}suspend(){return this._nativeAudioContext.suspend().catch((F=>{throw F===void 0?n():F}))}})(Jp,ts,_s,l0,lC,cC,uC,dC,fi),fu=(p=>n=>{const o=p.get(n);if(o===void 0)throw new Error("The context has no set of AudioWorkletNodes.");return o})(Gp),pC=(p=>(n,o)=>{p(n).add(o)})(fu),Zp=(p=>(n,o,c=0,f=0)=>{const v=n[c];if(v===void 0)throw p();return CA(o)?v.connect(o,0,f):v.connect(o,0)})(vt),mC=(p=>(n,o)=>{p(n).delete(o)})(fu),tm=(p=>(n,o=void 0,c=void 0,f=0)=>o===void 0?n.forEach((v=>v.disconnect())):typeof o=="number"?Ta(p,n,o).disconnect():CA(o)?c===void 0?n.forEach((v=>v.disconnect(o))):f===void 0?Ta(p,n,c).disconnect(o,0):Ta(p,n,c).disconnect(o,0,f):c===void 0?n.forEach((v=>v.disconnect(o))):Ta(p,n,c).disconnect(o,0))(vt),em=new WeakMap,gC=((p,n)=>o=>n(p,o))(em,W),wC=((p,n,o,c,f,v,B,_,S,F,I,M,k)=>(L,K,V,N)=>{if(N.numberOfInputs===0&&N.numberOfOutputs===0)throw S();const z=Array.isArray(N.outputChannelCount)?N.outputChannelCount:Array.from(N.outputChannelCount);if(z.some((pt=>pt<1)))throw S();if(z.length!==N.numberOfOutputs)throw n();if(N.channelCountMode!=="explicit")throw S();const q=N.channelCount*N.numberOfInputs,O=z.reduce(((pt,ne)=>pt+ne),0),it=V.parameterDescriptors===void 0?0:V.parameterDescriptors.length;if(q+it>6||O>6)throw S();const lt=new MessageChannel,j=[],et=[];for(let pt=0;pt<N.numberOfInputs;pt+=1)j.push(B(L,{channelCount:N.channelCount,channelCountMode:N.channelCountMode,channelInterpretation:N.channelInterpretation,gain:1})),et.push(f(L,{channelCount:N.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:N.channelCount}));const $=[];if(V.parameterDescriptors!==void 0)for(const{defaultValue:pt,maxValue:ne,minValue:ps,name:Te}of V.parameterDescriptors){const ee=v(L,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:N.parameterData[Te]!==void 0?N.parameterData[Te]:pt===void 0?0:pt});Object.defineProperties(ee.offset,{defaultValue:{get:()=>pt===void 0?0:pt},maxValue:{get:()=>ne===void 0?Nt:ne},minValue:{get:()=>ps===void 0?Pt:ps}}),$.push(ee)}const ut=c(L,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,q+it)}),tt=Cp(K,L.sampleRate),ot=_(L,tt,q+it,Math.max(1,O)),gt=f(L,{channelCount:Math.max(1,O),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,O)}),wt=[];for(let pt=0;pt<N.numberOfOutputs;pt+=1)wt.push(c(L,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:z[pt]}));for(let pt=0;pt<N.numberOfInputs;pt+=1){j[pt].connect(et[pt]);for(let ne=0;ne<N.channelCount;ne+=1)et[pt].connect(ut,ne,pt*N.channelCount+ne)}const kt=new Ea(V.parameterDescriptors===void 0?[]:V.parameterDescriptors.map((({name:pt},ne)=>{const ps=$[ne];return ps.connect(ut,0,q+ne),ps.start(0),[pt,ps.offset]})));ut.connect(ot);let Ft=N.channelInterpretation,St=null;const Rt=N.numberOfOutputs===0?[ot]:wt,bt={get bufferSize(){return tt},get channelCount(){return N.channelCount},set channelCount(pt){throw o()},get channelCountMode(){return N.channelCountMode},set channelCountMode(pt){throw o()},get channelInterpretation(){return Ft},set channelInterpretation(pt){for(const ne of j)ne.channelInterpretation=pt;Ft=pt},get context(){return ot.context},get inputs(){return j},get numberOfInputs(){return N.numberOfInputs},get numberOfOutputs(){return N.numberOfOutputs},get onprocessorerror(){return St},set onprocessorerror(pt){typeof St=="function"&&bt.removeEventListener("processorerror",St),St=typeof pt=="function"?pt:null,typeof St=="function"&&bt.addEventListener("processorerror",St)},get parameters(){return kt},get port(){return lt.port2},addEventListener:(...pt)=>ot.addEventListener(pt[0],pt[1],pt[2]),connect:p.bind(null,Rt),disconnect:F.bind(null,Rt),dispatchEvent:(...pt)=>ot.dispatchEvent(pt[0]),removeEventListener:(...pt)=>ot.removeEventListener(pt[0],pt[1],pt[2])},Vt=new Map;var jt,se;lt.port1.addEventListener=(jt=lt.port1.addEventListener,(...pt)=>{if(pt[0]==="message"){const ne=typeof pt[1]=="function"?pt[1]:typeof pt[1]=="object"&&pt[1]!==null&&typeof pt[1].handleEvent=="function"?pt[1].handleEvent:null;if(ne!==null){const ps=Vt.get(pt[1]);ps!==void 0?pt[1]=ps:(pt[1]=Te=>{I(L.currentTime,L.sampleRate,(()=>ne(Te)))},Vt.set(ne,pt[1]))}}return jt.call(lt.port1,pt[0],pt[1],pt[2])}),lt.port1.removeEventListener=(se=lt.port1.removeEventListener,(...pt)=>{if(pt[0]==="message"){const ne=Vt.get(pt[1]);ne!==void 0&&(Vt.delete(pt[1]),pt[1]=ne)}return se.call(lt.port1,pt[0],pt[1],pt[2])});let ye=null;Object.defineProperty(lt.port1,"onmessage",{get:()=>ye,set:pt=>{typeof ye=="function"&&lt.port1.removeEventListener("message",ye),ye=typeof pt=="function"?pt:null,typeof ye=="function"&&(lt.port1.addEventListener("message",ye),lt.port1.start())}}),V.prototype.port=lt.port1;let De=null;((pt,ne,ps,Te)=>{let ee=H.get(pt);ee===void 0&&(ee=new WeakMap,H.set(pt,ee));const Ce=(async(ks,kn)=>{const Ln=await(xh=>new Promise(((Eh,Bb)=>{const{port1:Za,port2:Sh}=new MessageChannel;Za.onmessage=({data:Fh})=>{Za.close(),Sh.close(),Eh(Fh)},Za.onmessageerror=({data:Fh})=>{Za.close(),Sh.close(),Bb(Fh)},Sh.postMessage(xh)})))(kn);return new ks(Ln)})(ps,Te);return ee.set(ne,Ce),Ce})(L,bt,V,N).then((pt=>De=pt));const Yt=Fa(N.numberOfInputs,N.channelCount),yt=Fa(N.numberOfOutputs,z),pe=V.parameterDescriptors===void 0?[]:V.parameterDescriptors.reduce(((pt,{name:ne})=>({...pt,[ne]:new Float32Array(128)})),{});let ce=!0;const fs=()=>{N.numberOfOutputs>0&&ot.disconnect(gt);for(let pt=0,ne=0;pt<N.numberOfOutputs;pt+=1){const ps=wt[pt];for(let Te=0;Te<z[pt];Te+=1)gt.disconnect(ps,ne+Te,Te);ne+=z[pt]}},xi=new Map;ot.onaudioprocess=({inputBuffer:pt,outputBuffer:ne})=>{if(De!==null){const ps=M(bt);for(let Te=0;Te<tt;Te+=128){for(let ee=0;ee<N.numberOfInputs;ee+=1)for(let Ce=0;Ce<N.channelCount;Ce+=1)zi(pt,Yt[ee],Ce,Ce,Te);V.parameterDescriptors!==void 0&&V.parameterDescriptors.forEach((({name:ee},Ce)=>{zi(pt,pe,ee,q+Ce,Te)}));for(let ee=0;ee<N.numberOfInputs;ee+=1)for(let Ce=0;Ce<z[ee];Ce+=1)yt[ee][Ce].byteLength===0&&(yt[ee][Ce]=new Float32Array(128));try{const ee=Yt.map(((ks,kn)=>{if(ps[kn].size>0)return xi.set(kn,tt/128),ks;const Ln=xi.get(kn);return Ln===void 0?[]:(ks.every((xh=>xh.every((Eh=>Eh===0))))&&(Ln===1?xi.delete(kn):xi.set(kn,Ln-1)),ks)}));ce=I(L.currentTime+Te/L.sampleRate,L.sampleRate,(()=>De.process(ee,yt,pe)));for(let ks=0,kn=0;ks<N.numberOfOutputs;ks+=1){for(let Ln=0;Ln<z[ks];Ln+=1)bA(ne,yt[ks],Ln,kn+Ln,Te);kn+=z[ks]}}catch(ee){ce=!1,bt.dispatchEvent(new ErrorEvent("processorerror",{colno:ee.colno,filename:ee.filename,lineno:ee.lineno,message:ee.message}))}if(!ce){for(let ee=0;ee<N.numberOfInputs;ee+=1){j[ee].disconnect(et[ee]);for(let Ce=0;Ce<N.channelCount;Ce+=1)et[Te].disconnect(ut,Ce,ee*N.channelCount+Ce)}if(V.parameterDescriptors!==void 0){const ee=V.parameterDescriptors.length;for(let Ce=0;Ce<ee;Ce+=1){const ks=$[Ce];ks.disconnect(ut,0,q+Ce),ks.stop()}}ut.disconnect(ot),ot.onaudioprocess=null,bh?fs():Im();break}}}};let bh=!1;const _h=B(L,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0}),Tm=()=>ot.connect(_h).connect(L.destination),Im=()=>{ot.disconnect(_h),_h.disconnect()};return Tm(),k(bt,(()=>{if(ce){Im(),N.numberOfOutputs>0&&ot.connect(gt);for(let pt=0,ne=0;pt<N.numberOfOutputs;pt+=1){const ps=wt[pt];for(let Te=0;Te<z[pt];Te+=1)gt.connect(ps,ne+Te,Te);ne+=z[pt]}}bh=!0}),(()=>{ce&&(Tm(),fs()),bh=!1}))})(Zp,vt,ts,mi,Ur,FA,Us,Pr,_s,tm,du,gC,pi),vC=((p,n,o,c,f)=>(v,B,_,S,F,I)=>{if(_!==null)try{const L=new _(v,S,I),K=new Map;let V=null;if(Object.defineProperties(L,{channelCount:{get:()=>I.channelCount,set:()=>{throw p()}},channelCountMode:{get:()=>"explicit",set:()=>{throw p()}},onprocessorerror:{get:()=>V,set:N=>{typeof V=="function"&&L.removeEventListener("processorerror",V),V=typeof N=="function"?N:null,typeof V=="function"&&L.addEventListener("processorerror",V)}}}),L.addEventListener=(k=L.addEventListener,(...N)=>{if(N[0]==="processorerror"){const z=typeof N[1]=="function"?N[1]:typeof N[1]=="object"&&N[1]!==null&&typeof N[1].handleEvent=="function"?N[1].handleEvent:null;if(z!==null){const q=K.get(N[1]);q!==void 0?N[1]=q:(N[1]=O=>{O.type==="error"?(Object.defineProperties(O,{type:{value:"processorerror"}}),z(O)):z(new ErrorEvent(N[0],{...O}))},K.set(z,N[1]))}}return k.call(L,"error",N[1],N[2]),k.call(L,...N)}),L.removeEventListener=(M=L.removeEventListener,(...N)=>{if(N[0]==="processorerror"){const z=K.get(N[1]);z!==void 0&&(K.delete(N[1]),N[1]=z)}return M.call(L,"error",N[1],N[2]),M.call(L,N[0],N[1],N[2])}),I.numberOfOutputs!==0){const N=o(v,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",gain:0});return L.connect(N).connect(v.destination),f(L,(()=>N.disconnect()),(()=>N.connect(v.destination)))}return L}catch(L){throw L.code===11?c():L}var M,k;if(F===void 0)throw c();return(L=>{const{port1:K}=new MessageChannel;try{K.postMessage(L)}finally{K.close()}})(I),n(v,B,F,I)})(ts,wC,Us,_s,pi),BC=((p,n,o,c,f,v,B,_,S,F,I,M,k,L,K,V)=>(N,z,q)=>{const O=new WeakMap;let it=null;return{render(lt,j){_(j,lt);const et=O.get(j);return et!==void 0?Promise.resolve(et):(async($,ut)=>{let tt=I($),ot=null;const gt=st(tt,ut),wt=Array.isArray(z.outputChannelCount)?z.outputChannelCount:Array.from(z.outputChannelCount);if(M===null){const kt=wt.reduce(((bt,Vt)=>bt+Vt),0),Ft=f(ut,{channelCount:Math.max(1,kt),channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:Math.max(1,kt)}),St=[];for(let bt=0;bt<$.numberOfOutputs;bt+=1)St.push(c(ut,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:wt[bt]}));const Rt=B(ut,{channelCount:z.channelCount,channelCountMode:z.channelCountMode,channelInterpretation:z.channelInterpretation,gain:1});Rt.connect=n.bind(null,St),Rt.disconnect=S.bind(null,St),ot=[Ft,St,Rt]}else gt||(tt=new M(ut,N));if(O.set(ut,ot===null?tt:ot[2]),ot!==null){if(it===null){if(q===void 0)throw new Error("Missing the processor constructor.");if(k===null)throw new Error("Missing the native OfflineAudioContext constructor.");const Vt=$.channelCount*$.numberOfInputs,jt=q.parameterDescriptors===void 0?0:q.parameterDescriptors.length,se=Vt+jt;it=qy($,se===0?null:await(async()=>{const De=new k(se,128*Math.ceil($.context.length/128),ut.sampleRate),Ds=[],Yt=[];for(let ce=0;ce<z.numberOfInputs;ce+=1)Ds.push(B(De,{channelCount:z.channelCount,channelCountMode:z.channelCountMode,channelInterpretation:z.channelInterpretation,gain:1})),Yt.push(f(De,{channelCount:z.channelCount,channelCountMode:"explicit",channelInterpretation:"discrete",numberOfOutputs:z.channelCount}));const yt=await Promise.all(Array.from($.parameters.values()).map((async ce=>{const fs=v(De,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"discrete",offset:ce.value});return await L(De,ce,fs.offset),fs}))),pe=c(De,{channelCount:1,channelCountMode:"explicit",channelInterpretation:"speakers",numberOfInputs:Math.max(1,Vt+jt)});for(let ce=0;ce<z.numberOfInputs;ce+=1){Ds[ce].connect(Yt[ce]);for(let fs=0;fs<z.channelCount;fs+=1)Yt[ce].connect(pe,fs,ce*z.channelCount+fs)}for(const[ce,fs]of yt.entries())fs.connect(pe,0,Vt+ce),fs.start(0);return pe.connect(De.destination),await Promise.all(Ds.map((ce=>K($,De,ce)))),V(De)})(),ut,z,wt,q,F)}const kt=await it,Ft=o(ut,{buffer:null,channelCount:2,channelCountMode:"max",channelInterpretation:"speakers",loop:!1,loopEnd:0,loopStart:0,playbackRate:1}),[St,Rt,bt]=ot;kt!==null&&(Ft.buffer=kt,Ft.start(0)),Ft.connect(St);for(let Vt=0,jt=0;Vt<$.numberOfOutputs;Vt+=1){const se=Rt[Vt];for(let ye=0;ye<wt[Vt];ye+=1)St.connect(se,jt+ye,ye);jt+=wt[Vt]}return bt}if(gt)for(const[kt,Ft]of $.parameters.entries())await p(ut,Ft,tt.parameters.get(kt));else for(const[kt,Ft]of $.parameters.entries())await L(ut,Ft,tt.parameters.get(kt));return await K($,ut,tt),tt})(lt,j)}}})(Mn,Zp,SA,mi,Ur,FA,Us,mC,tm,du,de,EA,es,Un,as,Ua),yC=(p=>n=>p.get(n))(jp),CC=(p=>(n,o)=>{p.set(n,o)})(em),sm=Yp?((p,n,o,c,f,v,B,_,S,F,I,M,k,L)=>class extends n{constructor(K,V,N){var z;const q=_(K),O=S(q),it=(ot=>({...ot,outputChannelCount:ot.outputChannelCount!==void 0?ot.outputChannelCount:ot.numberOfInputs===1&&ot.numberOfOutputs===1?[ot.channelCount]:Array.from({length:ot.numberOfOutputs},(()=>1))}))({...Sa,...N});(ot=>{const{port1:gt,port2:wt}=new MessageChannel;try{gt.postMessage(ot)}finally{gt.close(),wt.close()}})(it);const lt=U.get(q),j=lt==null?void 0:lt.get(V),et=O||q.state!=="closed"?q:(z=B(q))!==null&&z!==void 0?z:q,$=f(et,O?null:K.baseLatency,F,V,j,it);super(K,!0,$,O?c(V,it,j):null);const ut=[];$.parameters.forEach(((ot,gt)=>{const wt=o(this,O,ot);ut.push([gt,wt])})),this._nativeAudioWorkletNode=$,this._onprocessorerror=null,this._parameters=new Ea(ut),O&&p(q,this);const{activeInputs:tt}=v(this);M($,tt)}get onprocessorerror(){return this._onprocessorerror}set onprocessorerror(K){const V=typeof K=="function"?L(this,K):null;this._nativeAudioWorkletNode.onprocessorerror=V;const N=this._nativeAudioWorkletNode.onprocessorerror;this._onprocessorerror=N!==null&&N===V?K:N}get parameters(){return this._parameters===null?this._nativeAudioWorkletNode.parameters:this._parameters}get port(){return this._nativeAudioWorkletNode.port}})(pC,He,mn,BC,vC,Et,yC,we,ue,EA,0,CC,0,xA):void 0,bC=((p,n)=>(o,c,f)=>{if(n===null)throw new Error("Missing the native OfflineAudioContext constructor.");try{return new n(o,c,f)}catch(v){throw v.name==="SyntaxError"?p():v}})(_s,es),_C=((p,n,o,c,f,v,B,_)=>(S,F)=>o(S).render(S,F).then((()=>Promise.all(Array.from(c(F)).map((I=>o(I).render(I,F)))))).then((()=>f(F))).then((I=>(typeof I.copyFromChannel!="function"?(B(I),ft(I)):n(v,(()=>v(I)))||_(I),p.add(I),I))))(lu,tn,ru,fu,Ua,At,uu,hu),xC=((p,n,o,c,f)=>class extends p{constructor(v,B,_){let S;if(typeof v=="number"&&B!==void 0&&_!==void 0)S={length:B,numberOfChannels:v,sampleRate:_};else{if(typeof v!="object")throw new Error("The given parameters are not valid.");S=v}const{length:F,numberOfChannels:I,sampleRate:M}={...i0,...S},k=c(I,F,M);n(Mr,(()=>Mr(k)))||k.addEventListener("statechange",(()=>{let L=0;const K=V=>{this._state==="running"&&(L>0?(k.removeEventListener("statechange",K),V.stopImmediatePropagation(),this._waitForThePromiseToSettle(V)):L+=1)};return K})()),super(k,I),this._length=F,this._nativeOfflineAudioContext=k,this._state=null}get length(){return this._nativeOfflineAudioContext.length===void 0?this._length:this._nativeOfflineAudioContext.length}get state(){return this._state===null?this._nativeOfflineAudioContext.state:this._state}startRendering(){return this._state==="running"?Promise.reject(o()):(this._state="running",f(this.destination,this._nativeOfflineAudioContext).finally((()=>{this._state=null,ge(this)})))}_waitForThePromiseToSettle(v){this._state===null?this._nativeOfflineAudioContext.dispatchEvent(v):setTimeout((()=>this._waitForThePromiseToSettle(v)))}})(Jp,tn,ts,bC,_C),EC=((p,n)=>o=>{const c=p.get(o);return n(c)||n(o)})(E,ou),SC=((p,n)=>o=>p.has(o)||n(o))(w,au),FC=((p,n)=>o=>p.has(o)||n(o))(y,kp),TC=((p,n)=>o=>{const c=p.get(o);return n(c)||n(o)})(E,ue),IC=()=>(async(p,n,o,c,f,v,B,_,S,F,I,M,k,L,K,V)=>!!(p(n,n)&&p(o,o)&&p(f,f)&&p(v,v)&&p(_,_)&&p(S,S)&&p(F,F)&&p(I,I)&&p(M,M)&&p(k,k)&&p(L,L))&&(await Promise.all([p(c,c),p(B,B),p(K,K),p(V,V)])).every((N=>N)))(tn,(p=>()=>{if(p===null)return!1;const n=new p(1,1,44100).createBuffer(1,1,44100);if(n.copyToChannel===void 0)return!0;const o=new Float32Array(2);try{n.copyFromChannel(o,0,0)}catch{return!1}return!0})(es),(p=>()=>{if(p===null)return!1;if(p.prototype!==void 0&&p.prototype.close!==void 0)return!0;const n=new p,o=n.close!==void 0;try{n.close()}catch{}return o})(fi),(p=>()=>{if(p===null)return Promise.resolve(!1);const n=new p(1,1,44100);return new Promise((o=>{let c=!0;const f=B=>{c&&(c=!1,n.startRendering(),o(B instanceof TypeError))};let v;try{v=n.decodeAudioData(null,(()=>{}),f)}catch(B){f(B)}v!==void 0&&v.catch(f)}))})(es),(p=>()=>{if(p===null)return!1;let n;try{n=new p({latencyHint:"balanced"})}catch{return!1}return n.close(),!0})(fi),(p=>()=>{if(p===null)return!1;const n=new p(1,1,44100).createGain(),o=n.connect(n)===n;return n.disconnect(n),o})(es),((p,n)=>async()=>{if(p===null)return!0;if(n===null)return!1;const o=new Blob(['let c,p;class A extends AudioWorkletProcessor{constructor(){super();this.port.onmessage=(e)=>{p=e.data;p.onmessage=()=>{p.postMessage(c);p.close()};this.port.postMessage(0)}}process(){c=1}}registerProcessor("a",A)'],{type:"application/javascript; charset=utf-8"}),c=new MessageChannel,f=new n(1,128,44100),v=URL.createObjectURL(o);let B=!1;try{await f.audioWorklet.addModule(v);const _=new p(f,"a",{numberOfOutputs:0}),S=f.createOscillator();await new Promise((F=>{_.port.onmessage=()=>F(),_.port.postMessage(c.port2,[c.port2])})),_.port.onmessage=()=>B=!0,S.connect(_),S.start(0),await f.startRendering(),B=await new Promise((F=>{c.port1.onmessage=({data:I})=>F(I===1),c.port1.postMessage(0)}))}catch{}finally{c.port1.close(),URL.revokeObjectURL(v)}return B})(EA,es),(p=>()=>{if(p===null)return!1;const n=new p(1,1,44100).createChannelMerger();if(n.channelCountMode==="max")return!0;try{n.channelCount=2}catch{return!0}return!1})(es),(p=>()=>{if(p===null)return!1;const n=new p(1,1,44100);return n.createConstantSource===void 0||n.createConstantSource().offset.maxValue!==Number.POSITIVE_INFINITY})(es),(p=>()=>{if(p===null)return!1;const n=new p(1,1,44100),o=n.createConvolver();o.buffer=n.createBuffer(1,1,n.sampleRate);try{o.buffer=n.createBuffer(1,1,n.sampleRate)}catch{return!1}return!0})(es),(p=>()=>{if(p===null)return!1;const n=new p(1,1,44100).createConvolver();try{n.channelCount=1}catch{return!1}return!0})(es),u0,(p=>()=>p!==null&&p.hasOwnProperty("isSecureContext"))(pn),(p=>()=>{if(p===null)return!1;const n=new p;try{return n.createMediaStreamSource(new MediaStream),!1}catch{return!0}finally{n.close()}})(fi),(p=>()=>{if(p===null)return Promise.resolve(!1);const n=new p(1,1,44100);if(n.createStereoPanner===void 0||n.createConstantSource===void 0)return Promise.resolve(!0);const o=n.createConstantSource(),c=n.createStereoPanner();return o.channelCount=1,o.offset.value=1,c.channelCount=1,o.start(),o.connect(c).connect(n.destination),n.startRendering().then((f=>f.getChannelData(0)[0]!==1))})(es),h0);function Ps(p){return p===void 0}function Kt(p){return p!==void 0}function nm(p){return typeof p=="function"}function Vs(p){return typeof p=="number"}function Yn(p){return Object.prototype.toString.call(p)==="[object Object]"&&p.constructor===Object}function pu(p){return typeof p=="boolean"}function ls(p){return Array.isArray(p)}function gn(p){return typeof p=="string"}function Lr(p){return gn(p)&&/^([a-g]{1}(?:b|#|x|bb)?)(-?[0-9]+)/i.test(p)}function It(p,n){if(!p)throw new Error(n)}function cs(p,n,o=1/0){if(!(n<=p&&p<=o))throw new RangeError(`Value must be within [${n}, ${o}], got: ${p}`)}function mu(p){p.isOffline||p.state==="running"||TA('The AudioContext is "suspended". Invoke Tone.start() from a user action to start the audio.')}let im=!1,Am=!1;function gu(p){im=p}function rm(p){Ps(p)&&im&&!Am&&(Am=!0,TA("Events scheduled inside of scheduled callbacks should use the passed in scheduling time. See https://github.com/Tonejs/Tone.js/wiki/Accurate-Timing"))}let wu=console;function QC(p){wu=p}function om(...p){wu.log(...p)}function TA(...p){wu.warn(...p)}const Ws=typeof self=="object"?self:null,MC=Ws&&(Ws.hasOwnProperty("AudioContext")||Ws.hasOwnProperty("webkitAudioContext"));function wn(p,n,o,c){var f,v=arguments.length,B=v<3?n:c;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")B=Reflect.decorate(p,n,o,c);else for(var _=p.length-1;_>=0;_--)(f=p[_])&&(B=(v<3?f(B):v>3?f(n,o,B):f(n,o))||B);return v>3&&B&&Object.defineProperty(n,o,B),B}function fe(p,n,o,c){return new(o||(o=Promise))((function(f,v){function B(F){try{S(c.next(F))}catch(I){v(I)}}function _(F){try{S(c.throw(F))}catch(I){v(I)}}function S(F){var I;F.done?f(F.value):(I=F.value,I instanceof o?I:new o((function(M){M(I)}))).then(B,_)}S((c=c.apply(p,n||[])).next())}))}typeof SuppressedError=="function"&&SuppressedError;class UC{constructor(n,o,c,f){this._callback=n,this._type=o,this._minimumUpdateInterval=Math.max(128/(f||44100),.001),this.updateInterval=c,this._createClock()}_createWorker(){const n=new Blob([`
			// the initial timeout time
			let timeoutTime =  ${(1e3*this._updateInterval).toFixed(1)};
			// onmessage callback
			self.onmessage = function(msg){
				timeoutTime = parseInt(msg.data);
			};
			// the tick function which posts a message
			// and schedules a new tick
			function tick(){
				setTimeout(tick, timeoutTime);
				self.postMessage('tick');
			}
			// call tick initially
			tick();
			`],{type:"text/javascript"}),o=URL.createObjectURL(n),c=new Worker(o);c.onmessage=this._callback.bind(this),this._worker=c}_createTimeout(){this._timeout=setTimeout((()=>{this._createTimeout(),this._callback()}),1e3*this._updateInterval)}_createClock(){if(this._type==="worker")try{this._createWorker()}catch{this._type="timeout",this._createClock()}else this._type==="timeout"&&this._createTimeout()}_disposeClock(){this._timeout&&clearTimeout(this._timeout),this._worker&&(this._worker.terminate(),this._worker.onmessage=null)}get updateInterval(){return this._updateInterval}set updateInterval(n){var o;this._updateInterval=Math.max(n,this._minimumUpdateInterval),this._type==="worker"&&((o=this._worker)===null||o===void 0||o.postMessage(1e3*this._updateInterval))}get type(){return this._type}set type(n){this._disposeClock(),this._type=n,this._createClock()}dispose(){this._disposeClock()}}function Xi(p){return FC(p)}function gi(p){return SC(p)}function Da(p){return TC(p)}function IA(p){return EC(p)}function PC(p,n){return p==="value"||Xi(n)||gi(n)||(function(o){return o instanceof Np})(n)}function en(p,...n){if(!n.length)return p;const o=n.shift();if(Yn(p)&&Yn(o))for(const c in o)PC(c,o[c])?p[c]=o[c]:Yn(o[c])?(p[c]||Object.assign(p,{[c]:{}}),en(p[c],o[c])):Object.assign(p,{[c]:o[c]});return en(p,...n)}function rt(p,n,o=[],c){const f={},v=Array.from(n);if(Yn(v[0])&&c&&!Reflect.has(v[0],c)&&(Object.keys(v[0]).some((B=>Reflect.has(p,B)))||(en(f,{[c]:v[0]}),o.splice(o.indexOf(c),1),v.shift())),v.length===1&&Yn(v[0]))en(f,v[0]);else for(let B=0;B<o.length;B++)Kt(v[B])&&(f[o[B]]=v[B]);return en(p,f)}function sn(p,n){return Ps(p)?n:p}function us(p,n){return n.forEach((o=>{Reflect.has(p,o)&&delete p[o]})),p}class jn{constructor(){this.debug=!1,this._wasDisposed=!1}static getDefaults(){return{}}log(...n){(this.debug||Ws&&this.toString()===Ws.TONE_DEBUG_CLASS)&&om(this,...n)}dispose(){return this._wasDisposed=!0,this}get disposed(){return this._wasDisposed}toString(){return this.name}}jn.version=u;const vu=1e-6;function QA(p,n){return p>n+vu}function Bu(p,n){return QA(p,n)||vn(p,n)}function ka(p,n){return p+vu<n}function vn(p,n){return Math.abs(p-n)<vu}function Yi(p,n,o){return Math.max(Math.min(p,o),n)}class Ks extends jn{constructor(){super(),this.name="Timeline",this._timeline=[];const n=rt(Ks.getDefaults(),arguments,["memory"]);this.memory=n.memory,this.increasing=n.increasing}static getDefaults(){return{memory:1/0,increasing:!1}}get length(){return this._timeline.length}add(n){if(It(Reflect.has(n,"time"),"Timeline: events must have a time attribute"),n.time=n.time.valueOf(),this.increasing&&this.length){const o=this._timeline[this.length-1];It(Bu(n.time,o.time),"The time must be greater than or equal to the last scheduled time"),this._timeline.push(n)}else{const o=this._search(n.time);this._timeline.splice(o+1,0,n)}if(this.length>this.memory){const o=this.length-this.memory;this._timeline.splice(0,o)}return this}remove(n){const o=this._timeline.indexOf(n);return o!==-1&&this._timeline.splice(o,1),this}get(n,o="time"){const c=this._search(n,o);return c!==-1?this._timeline[c]:null}peek(){return this._timeline[0]}shift(){return this._timeline.shift()}getAfter(n,o="time"){const c=this._search(n,o);return c+1<this._timeline.length?this._timeline[c+1]:null}getBefore(n){const o=this._timeline.length;if(o>0&&this._timeline[o-1].time<n)return this._timeline[o-1];const c=this._search(n);return c-1>=0?this._timeline[c-1]:null}cancel(n){if(this._timeline.length>1){let o=this._search(n);if(o>=0)if(vn(this._timeline[o].time,n)){for(let c=o;c>=0&&vn(this._timeline[c].time,n);c--)o=c;this._timeline=this._timeline.slice(0,o)}else this._timeline=this._timeline.slice(0,o+1);else this._timeline=[]}else this._timeline.length===1&&Bu(this._timeline[0].time,n)&&(this._timeline=[]);return this}cancelBefore(n){const o=this._search(n);return o>=0&&(this._timeline=this._timeline.slice(o+1)),this}previousEvent(n){const o=this._timeline.indexOf(n);return o>0?this._timeline[o-1]:null}_search(n,o="time"){if(this._timeline.length===0)return-1;let c=0;const f=this._timeline.length;let v=f;if(f>0&&this._timeline[f-1][o]<=n)return f-1;for(;c<v;){let B=Math.floor(c+(v-c)/2);const _=this._timeline[B],S=this._timeline[B+1];if(vn(_[o],n)){for(let F=B;F<this._timeline.length&&vn(this._timeline[F][o],n);F++)B=F;return B}if(ka(_[o],n)&&QA(S[o],n))return B;QA(_[o],n)?v=B:c=B+1}return-1}_iterate(n,o=0,c=this._timeline.length-1){this._timeline.slice(o,c+1).forEach(n)}forEach(n){return this._iterate(n),this}forEachBefore(n,o){const c=this._search(n);return c!==-1&&this._iterate(o,0,c),this}forEachAfter(n,o){const c=this._search(n);return this._iterate(o,c+1),this}forEachBetween(n,o,c){let f=this._search(n),v=this._search(o);return f!==-1&&v!==-1?(this._timeline[f].time!==n&&(f+=1),this._timeline[v].time===o&&(v-=1),this._iterate(c,f,v)):f===-1&&this._iterate(c,0,v),this}forEachFrom(n,o){let c=this._search(n);for(;c>=0&&this._timeline[c].time>=n;)c--;return this._iterate(o,c+1),this}forEachAtTime(n,o){const c=this._search(n);if(c!==-1&&vn(this._timeline[c].time,n)){let f=c;for(let v=c;v>=0&&vn(this._timeline[v].time,n);v--)f=v;this._iterate((v=>{o(v)}),f,c)}return this}dispose(){return super.dispose(),this._timeline=[],this}}const am=[];function La(p){am.push(p)}const lm=[];function Ra(p){lm.push(p)}class MA extends jn{constructor(){super(...arguments),this.name="Emitter"}on(n,o){return n.split(/\W+/).forEach((c=>{Ps(this._events)&&(this._events={}),this._events.hasOwnProperty(c)||(this._events[c]=[]),this._events[c].push(o)})),this}once(n,o){const c=(...f)=>{o(...f),this.off(n,c)};return this.on(n,c),this}off(n,o){return n.split(/\W+/).forEach((c=>{if(Ps(this._events)&&(this._events={}),this._events.hasOwnProperty(c))if(Ps(o))this._events[c]=[];else{const f=this._events[c];for(let v=f.length-1;v>=0;v--)f[v]===o&&f.splice(v,1)}})),this}emit(n,...o){if(this._events&&this._events.hasOwnProperty(n)){const c=this._events[n].slice(0);for(let f=0,v=c.length;f<v;f++)c[f].apply(this,o)}return this}static mixin(n){["on","once","off","emit"].forEach((o=>{const c=Object.getOwnPropertyDescriptor(MA.prototype,o);Object.defineProperty(n.prototype,o,c)}))}dispose(){return super.dispose(),this._events=void 0,this}}class yu extends MA{constructor(){super(...arguments),this.isOffline=!1}toJSON(){return{}}}class UA extends yu{constructor(){var n,o;super(),this.name="Context",this._constants=new Map,this._timeouts=new Ks,this._timeoutIds=0,this._initialized=!1,this._closeStarted=!1,this.isOffline=!1,this._workletPromise=null;const c=rt(UA.getDefaults(),arguments,["context"]);c.context?(this._context=c.context,this._latencyHint=((n=arguments[0])===null||n===void 0?void 0:n.latencyHint)||""):(this._context=(function(f){return new fC(f)})({latencyHint:c.latencyHint}),this._latencyHint=c.latencyHint),this._ticker=new UC(this.emit.bind(this,"tick"),c.clockSource,c.updateInterval,this._context.sampleRate),this.on("tick",this._timeoutLoop.bind(this)),this._context.onstatechange=()=>{this.emit("statechange",this.state)},this[!((o=arguments[0])===null||o===void 0)&&o.hasOwnProperty("updateInterval")?"_lookAhead":"lookAhead"]=c.lookAhead}static getDefaults(){return{clockSource:"worker",latencyHint:"interactive",lookAhead:.1,updateInterval:.05}}initialize(){var n;return this._initialized||(n=this,am.forEach((o=>o(n))),this._initialized=!0),this}createAnalyser(){return this._context.createAnalyser()}createOscillator(){return this._context.createOscillator()}createBufferSource(){return this._context.createBufferSource()}createBiquadFilter(){return this._context.createBiquadFilter()}createBuffer(n,o,c){return this._context.createBuffer(n,o,c)}createChannelMerger(n){return this._context.createChannelMerger(n)}createChannelSplitter(n){return this._context.createChannelSplitter(n)}createConstantSource(){return this._context.createConstantSource()}createConvolver(){return this._context.createConvolver()}createDelay(n){return this._context.createDelay(n)}createDynamicsCompressor(){return this._context.createDynamicsCompressor()}createGain(){return this._context.createGain()}createIIRFilter(n,o){return this._context.createIIRFilter(n,o)}createPanner(){return this._context.createPanner()}createPeriodicWave(n,o,c){return this._context.createPeriodicWave(n,o,c)}createStereoPanner(){return this._context.createStereoPanner()}createWaveShaper(){return this._context.createWaveShaper()}createMediaStreamSource(n){return It(IA(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamSource(n)}createMediaElementSource(n){return It(IA(this._context),"Not available if OfflineAudioContext"),this._context.createMediaElementSource(n)}createMediaStreamDestination(){return It(IA(this._context),"Not available if OfflineAudioContext"),this._context.createMediaStreamDestination()}decodeAudioData(n){return this._context.decodeAudioData(n)}get currentTime(){return this._context.currentTime}get state(){return this._context.state}get sampleRate(){return this._context.sampleRate}get listener(){return this.initialize(),this._listener}set listener(n){It(!this._initialized,"The listener cannot be set after initialization."),this._listener=n}get transport(){return this.initialize(),this._transport}set transport(n){It(!this._initialized,"The transport cannot be set after initialization."),this._transport=n}get draw(){return this.initialize(),this._draw}set draw(n){It(!this._initialized,"Draw cannot be set after initialization."),this._draw=n}get destination(){return this.initialize(),this._destination}set destination(n){It(!this._initialized,"The destination cannot be set after initialization."),this._destination=n}createAudioWorkletNode(n,o){return(function(c,f,v){return It(Kt(sm),"AudioWorkletNode only works in a secure context (https or localhost)"),new(c instanceof(Ws==null?void 0:Ws.BaseAudioContext)?Ws==null?void 0:Ws.AudioWorkletNode:sm)(c,f,v)})(this.rawContext,n,o)}addAudioWorkletModule(n){return fe(this,void 0,void 0,(function*(){It(Kt(this.rawContext.audioWorklet),"AudioWorkletNode is only available in a secure context (https or localhost)"),this._workletPromise||(this._workletPromise=this.rawContext.audioWorklet.addModule(n)),yield this._workletPromise}))}workletsAreReady(){return fe(this,void 0,void 0,(function*(){(yield this._workletPromise)?this._workletPromise:Promise.resolve()}))}get updateInterval(){return this._ticker.updateInterval}set updateInterval(n){this._ticker.updateInterval=n}get clockSource(){return this._ticker.type}set clockSource(n){this._ticker.type=n}get lookAhead(){return this._lookAhead}set lookAhead(n){this._lookAhead=n,this.updateInterval=n?n/2:.01}get latencyHint(){return this._latencyHint}get rawContext(){return this._context}now(){return this._context.currentTime+this._lookAhead}immediate(){return this._context.currentTime}resume(){return IA(this._context)?this._context.resume():Promise.resolve()}close(){return fe(this,void 0,void 0,(function*(){var n;IA(this._context)&&this.state!=="closed"&&!this._closeStarted&&(this._closeStarted=!0,yield this._context.close()),this._initialized&&(n=this,lm.forEach((o=>o(n))))}))}getConstant(n){if(this._constants.has(n))return this._constants.get(n);{const o=this._context.createBuffer(1,128,this._context.sampleRate),c=o.getChannelData(0);for(let v=0;v<c.length;v++)c[v]=n;const f=this._context.createBufferSource();return f.channelCount=1,f.channelCountMode="explicit",f.buffer=o,f.loop=!0,f.start(0),this._constants.set(n,f),f}}dispose(){return super.dispose(),this._ticker.dispose(),this._timeouts.dispose(),Object.keys(this._constants).map((n=>this._constants[n].disconnect())),this.close(),this}_timeoutLoop(){const n=this.now();let o=this._timeouts.peek();for(;this._timeouts.length&&o&&o.time<=n;)o.callback(),this._timeouts.shift(),o=this._timeouts.peek()}setTimeout(n,o){this._timeoutIds++;const c=this.now();return this._timeouts.add({callback:n,id:this._timeoutIds,time:c+o}),this._timeoutIds}clearTimeout(n){return this._timeouts.forEach((o=>{o.id===n&&this._timeouts.remove(o)})),this}clearInterval(n){return this.clearTimeout(n)}setInterval(n,o){const c=++this._timeoutIds,f=()=>{const v=this.now();this._timeouts.add({callback:()=>{n(),f()},id:c,time:v+o})};return f(),c}}function Ut(p,n){ls(n)?n.forEach((o=>Ut(p,o))):Object.defineProperty(p,n,{enumerable:!0,writable:!1})}function Rr(p,n){ls(n)?n.forEach((o=>Rr(p,o))):Object.defineProperty(p,n,{writable:!0})}const Xt=()=>{};class te extends jn{constructor(){super(),this.name="ToneAudioBuffer",this.onload=Xt;const n=rt(te.getDefaults(),arguments,["url","onload","onerror"]);this.reverse=n.reverse,this.onload=n.onload,gn(n.url)?this.load(n.url).catch(n.onerror):n.url&&this.set(n.url)}static getDefaults(){return{onerror:Xt,onload:Xt,reverse:!1}}get sampleRate(){return this._buffer?this._buffer.sampleRate:Be().sampleRate}set(n){return n instanceof te?n.loaded?this._buffer=n.get():n.onload=()=>{this.set(n),this.onload(this)}:this._buffer=n,this._reversed&&this._reverse(),this}get(){return this._buffer}load(n){return fe(this,void 0,void 0,(function*(){const o=te.load(n).then((c=>{this.set(c),this.onload(this)}));te.downloads.push(o);try{yield o}finally{const c=te.downloads.indexOf(o);te.downloads.splice(c,1)}return this}))}dispose(){return super.dispose(),this._buffer=void 0,this}fromArray(n){const o=ls(n)&&n[0].length>0,c=o?n.length:1,f=o?n[0].length:n.length,v=Be(),B=v.createBuffer(c,f,v.sampleRate),_=o||c!==1?n:[n];for(let S=0;S<c;S++)B.copyToChannel(_[S],S);return this._buffer=B,this}toMono(n){if(Vs(n))this.fromArray(this.toArray(n));else{let o=new Float32Array(this.length);const c=this.numberOfChannels;for(let f=0;f<c;f++){const v=this.toArray(f);for(let B=0;B<v.length;B++)o[B]+=v[B]}o=o.map((f=>f/c)),this.fromArray(o)}return this}toArray(n){if(Vs(n))return this.getChannelData(n);if(this.numberOfChannels===1)return this.toArray(0);{const o=[];for(let c=0;c<this.numberOfChannels;c++)o[c]=this.getChannelData(c);return o}}getChannelData(n){return this._buffer?this._buffer.getChannelData(n):new Float32Array(0)}slice(n,o=this.duration){It(this.loaded,"Buffer is not loaded");const c=Math.floor(n*this.sampleRate),f=Math.floor(o*this.sampleRate);It(c<f,"The start time must be less than the end time");const v=f-c,B=Be().createBuffer(this.numberOfChannels,v,this.sampleRate);for(let _=0;_<this.numberOfChannels;_++)B.copyToChannel(this.getChannelData(_).subarray(c,f),_);return new te(B)}_reverse(){if(this.loaded)for(let n=0;n<this.numberOfChannels;n++)this.getChannelData(n).reverse();return this}get loaded(){return this.length>0}get duration(){return this._buffer?this._buffer.duration:0}get length(){return this._buffer?this._buffer.length:0}get numberOfChannels(){return this._buffer?this._buffer.numberOfChannels:0}get reverse(){return this._reversed}set reverse(n){this._reversed!==n&&(this._reversed=n,this._reverse())}static fromArray(n){return new te().fromArray(n)}static fromUrl(n){return fe(this,void 0,void 0,(function*(){return yield new te().load(n)}))}static load(n){return fe(this,void 0,void 0,(function*(){const o=n.match(/\[([^\]\[]+\|.+)\]$/);if(o){const _=o[1].split("|");let S=_[0];for(const F of _)if(te.supportsType(F)){S=F;break}n=n.replace(o[0],S)}const c=te.baseUrl===""||te.baseUrl.endsWith("/")?te.baseUrl:te.baseUrl+"/",f=document.createElement("a");f.href=c+n,f.pathname=(f.pathname+f.hash).split("/").map(encodeURIComponent).join("/");const v=yield fetch(f.href);if(!v.ok)throw new Error(`could not load url: ${n}`);const B=yield v.arrayBuffer();return yield Be().decodeAudioData(B)}))}static supportsType(n){const o=n.split("."),c=o[o.length-1];return document.createElement("audio").canPlayType("audio/"+c)!==""}static loaded(){return fe(this,void 0,void 0,(function*(){for(yield Promise.resolve();te.downloads.length;)yield te.downloads[0]}))}}te.baseUrl="",te.downloads=[];class PA extends UA{constructor(){var n,o,c;super({clockSource:"offline",context:Da(arguments[0])?arguments[0]:(n=arguments[0],o=arguments[1]*arguments[2],c=arguments[2],new xC(n,o,c)),lookAhead:0,updateInterval:Da(arguments[0])?128/arguments[0].sampleRate:128/arguments[2]}),this.name="OfflineContext",this._currentTime=0,this.isOffline=!0,this._duration=Da(arguments[0])?arguments[0].length/arguments[0].sampleRate:arguments[1]}now(){return this._currentTime}get currentTime(){return this._currentTime}_renderClock(n){return fe(this,void 0,void 0,(function*(){let o=0;for(;this._duration-this._currentTime>=0;){this.emit("tick"),this._currentTime+=128/this.sampleRate,o++;const c=Math.floor(this.sampleRate/128);n&&o%c==0&&(yield new Promise((f=>setTimeout(f,1))))}}))}render(){return fe(this,arguments,void 0,(function*(n=!0){yield this.workletsAreReady(),yield this._renderClock(n);const o=yield this._context.startRendering();return new te(o)}))}close(){return Promise.resolve()}}const cm=new class extends yu{constructor(){super(...arguments),this.lookAhead=0,this.latencyHint=0,this.isOffline=!1}createAnalyser(){return{}}createOscillator(){return{}}createBufferSource(){return{}}createBiquadFilter(){return{}}createBuffer(p,n,o){return{}}createChannelMerger(p){return{}}createChannelSplitter(p){return{}}createConstantSource(){return{}}createConvolver(){return{}}createDelay(p){return{}}createDynamicsCompressor(){return{}}createGain(){return{}}createIIRFilter(p,n){return{}}createPanner(){return{}}createPeriodicWave(p,n,o){return{}}createStereoPanner(){return{}}createWaveShaper(){return{}}createMediaStreamSource(p){return{}}createMediaElementSource(p){return{}}createMediaStreamDestination(){return{}}decodeAudioData(p){return Promise.resolve({})}createAudioWorkletNode(p,n){return{}}get rawContext(){return{}}addAudioWorkletModule(p){return fe(this,void 0,void 0,(function*(){return Promise.resolve()}))}resume(){return Promise.resolve()}setTimeout(p,n){return 0}clearTimeout(p){return this}setInterval(p,n){return 0}clearInterval(p){return this}getConstant(p){return{}}get currentTime(){return 0}get state(){return{}}get sampleRate(){return 0}get listener(){return{}}get transport(){return{}}get draw(){return{}}set draw(p){}get destination(){return{}}set destination(p){}now(){return 0}immediate(){return 0}};let Hr=cm;function Be(){return Hr===cm&&MC&&Ha(new UA),Hr}function Ha(p,n=!1){n&&Hr.dispose(),Hr=IA(p)?new UA(p):Da(p)?new PA(p):p}function DC(){return Hr.resume()}if(Ws&&!Ws.TONE_SILENCE_LOGGING){const n=` * Tone.js v${u} * `;console.log(`%c${n}`,"background: #000; color: #fff")}function DA(p){return Math.pow(10,p/20)}function Nr(p){return Math.log(p)/Math.LN10*20}function kA(p){return Math.pow(2,p/12)}let Na=440;function wi(p){return Math.round(um(p))}function um(p){return 69+12*Math.log2(p/Na)}function Cu(p){return Na*Math.pow(2,(p-69)/12)}class bu extends jn{constructor(n,o,c){super(),this.defaultUnits="s",this._val=o,this._units=c,this.context=n,this._expressions=this._getExpressions()}_getExpressions(){return{hz:{method:n=>this._frequencyToUnits(parseFloat(n)),regexp:/^(\d+(?:\.\d+)?)hz$/i},i:{method:n=>this._ticksToUnits(parseInt(n,10)),regexp:/^(\d+)i$/i},m:{method:n=>this._beatsToUnits(parseInt(n,10)*this._getTimeSignature()),regexp:/^(\d+)m$/i},n:{method:(n,o)=>{const c=parseInt(n,10),f=o==="."?1.5:1;return c===1?this._beatsToUnits(this._getTimeSignature())*f:this._beatsToUnits(4/c)*f},regexp:/^(\d+)n(\.?)$/i},number:{method:n=>this._expressions[this.defaultUnits].method.call(this,n),regexp:/^(\d+(?:\.\d+)?)$/},s:{method:n=>this._secondsToUnits(parseFloat(n)),regexp:/^(\d+(?:\.\d+)?)s$/},samples:{method:n=>parseInt(n,10)/this.context.sampleRate,regexp:/^(\d+)samples$/},t:{method:n=>{const o=parseInt(n,10);return this._beatsToUnits(8/(3*Math.floor(o)))},regexp:/^(\d+)t$/i},tr:{method:(n,o,c)=>{let f=0;return n&&n!=="0"&&(f+=this._beatsToUnits(this._getTimeSignature()*parseFloat(n))),o&&o!=="0"&&(f+=this._beatsToUnits(parseFloat(o))),c&&c!=="0"&&(f+=this._beatsToUnits(parseFloat(c)/4)),f},regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?$/}}}valueOf(){if(this._val instanceof bu&&this.fromType(this._val),Ps(this._val))return this._noArg();if(gn(this._val)&&Ps(this._units)){for(const n in this._expressions)if(this._expressions[n].regexp.test(this._val.trim())){this._units=n;break}}else if(Yn(this._val)){let n=0;for(const o in this._val)if(Kt(this._val[o])){const c=this._val[o];n+=new this.constructor(this.context,o).valueOf()*c}return n}if(Kt(this._units)){const n=this._expressions[this._units],o=this._val.toString().trim().match(n.regexp);return o?n.method.apply(this,o.slice(1)):n.method.call(this,this._val)}return gn(this._val)?parseFloat(this._val):this._val}_frequencyToUnits(n){return 1/n}_beatsToUnits(n){return 60/this._getBpm()*n}_secondsToUnits(n){return n}_ticksToUnits(n){return n*this._beatsToUnits(1)/this._getPPQ()}_noArg(){return this._now()}_getBpm(){return this.context.transport.bpm.value}_getTimeSignature(){return this.context.transport.timeSignature}_getPPQ(){return this.context.transport.PPQ}fromType(n){switch(this._units=void 0,this.defaultUnits){case"s":this._val=n.toSeconds();break;case"i":this._val=n.toTicks();break;case"hz":this._val=n.toFrequency();break;case"midi":this._val=n.toMidi()}return this}toFrequency(){return 1/this.toSeconds()}toSamples(){return this.toSeconds()*this.context.sampleRate}toMilliseconds(){return 1e3*this.toSeconds()}}class Gs extends bu{constructor(){super(...arguments),this.name="TimeClass"}_getExpressions(){return Object.assign(super._getExpressions(),{now:{method:n=>this._now()+new this.constructor(this.context,n).valueOf(),regexp:/^\+(.+)/},quantize:{method:n=>{const o=new Gs(this.context,n).valueOf();return this._secondsToUnits(this.context.transport.nextSubdivision(o))},regexp:/^@(.+)/}})}quantize(n,o=1){const c=new this.constructor(this.context,n).valueOf(),f=this.valueOf();return f+(Math.round(f/c)*c-f)*o}toNotation(){const n=this.toSeconds(),o=["1m"];for(let v=1;v<9;v++){const B=Math.pow(2,v);o.push(B+"n."),o.push(B+"n"),o.push(B+"t")}o.push("0");let c=o[0],f=new Gs(this.context,o[0]).toSeconds();return o.forEach((v=>{const B=new Gs(this.context,v).toSeconds();Math.abs(B-n)<Math.abs(f-n)&&(c=v,f=B)})),c}toBarsBeatsSixteenths(){const n=this._beatsToUnits(1);let o=this.valueOf()/n;o=parseFloat(o.toFixed(4));const c=Math.floor(o/this._getTimeSignature());let f=o%1*4;o=Math.floor(o)%this._getTimeSignature();const v=f.toString();return v.length>3&&(f=parseFloat(parseFloat(v).toFixed(3))),[c,o,f].join(":")}toTicks(){const n=this._beatsToUnits(1);return this.valueOf()/n*this._getPPQ()}toSeconds(){return this.valueOf()}toMidi(){return wi(this.toFrequency())}_now(){return this.context.now()}}function kC(p,n){return new Gs(Be(),p,n)}class xs extends Gs{constructor(){super(...arguments),this.name="Frequency",this.defaultUnits="hz"}static get A4(){return Na}static set A4(n){(function(o){Na=o})(n)}_getExpressions(){return Object.assign({},super._getExpressions(),{midi:{regexp:/^(\d+(?:\.\d+)?midi)/,method(n){return this.defaultUnits==="midi"?n:xs.mtof(n)}},note:{regexp:/^([a-g]{1}(?:b|#|##|x|bb|###|#x|x#|bbb)?)(-?[0-9]+)/i,method(n,o){const c=LC[n.toLowerCase()]+12*(parseInt(o,10)+1);return this.defaultUnits==="midi"?c:xs.mtof(c)}},tr:{regexp:/^(\d+(?:\.\d+)?):(\d+(?:\.\d+)?):?(\d+(?:\.\d+)?)?/,method(n,o,c){let f=1;return n&&n!=="0"&&(f*=this._beatsToUnits(this._getTimeSignature()*parseFloat(n))),o&&o!=="0"&&(f*=this._beatsToUnits(parseFloat(o))),c&&c!=="0"&&(f*=this._beatsToUnits(parseFloat(c)/4)),f}}})}transpose(n){return new xs(this.context,this.valueOf()*kA(n))}harmonize(n){return n.map((o=>this.transpose(o)))}toMidi(){return wi(this.valueOf())}toNote(){const n=this.toFrequency(),o=Math.log2(n/xs.A4);let c=Math.round(12*o)+57;const f=Math.floor(c/12);return f<0&&(c+=-12*f),RC[c%12]+f.toString()}toSeconds(){return 1/super.toSeconds()}toTicks(){const n=this._beatsToUnits(1),o=this.valueOf()/n;return Math.floor(o*this._getPPQ())}_noArg(){return 0}_frequencyToUnits(n){return n}_ticksToUnits(n){return 1/(60*n/(this._getBpm()*this._getPPQ()))}_beatsToUnits(n){return 1/super._beatsToUnits(n)}_secondsToUnits(n){return 1/n}static mtof(n){return Cu(n)}static ftom(n){return wi(n)}}const LC={cbbb:-3,cbb:-2,cb:-1,c:0,"c#":1,cx:2,"c##":2,"c###":3,"cx#":3,"c#x":3,dbbb:-1,dbb:0,db:1,d:2,"d#":3,dx:4,"d##":4,"d###":5,"dx#":5,"d#x":5,ebbb:1,ebb:2,eb:3,e:4,"e#":5,ex:6,"e##":6,"e###":7,"ex#":7,"e#x":7,fbbb:2,fbb:3,fb:4,f:5,"f#":6,fx:7,"f##":7,"f###":8,"fx#":8,"f#x":8,gbbb:4,gbb:5,gb:6,g:7,"g#":8,gx:9,"g##":9,"g###":10,"gx#":10,"g#x":10,abbb:6,abb:7,ab:8,a:9,"a#":10,ax:11,"a##":11,"a###":12,"ax#":12,"a#x":12,bbbb:8,bbb:9,bb:10,b:11,"b#":12,bx:13,"b##":13,"b###":14,"bx#":14,"b#x":14},RC=["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"];function HC(p,n){return new xs(Be(),p,n)}class qe extends Gs{constructor(){super(...arguments),this.name="TransportTime"}_now(){return this.context.transport.seconds}}function NC(p,n){return new qe(Be(),p,n)}class ss extends jn{constructor(){super();const n=rt(ss.getDefaults(),arguments,["context"]);this.defaultContext?this.context=this.defaultContext:this.context=n.context}static getDefaults(){return{context:Be()}}now(){return this.context.currentTime+this.context.lookAhead}immediate(){return this.context.currentTime}get sampleTime(){return 1/this.context.sampleRate}get blockTime(){return 128/this.context.sampleRate}toSeconds(n){return rm(n),new Gs(this.context,n).toSeconds()}toFrequency(n){return new xs(this.context,n).toFrequency()}toTicks(n){return new qe(this.context,n).toTicks()}_getPartialProperties(n){const o=this.get();return Object.keys(o).forEach((c=>{Ps(n[c])&&delete o[c]})),o}get(){const n=this.constructor.getDefaults();return Object.keys(n).forEach((o=>{if(Reflect.has(this,o)){const c=this[o];Kt(c)&&Kt(c.value)&&Kt(c.setValueAtTime)?n[o]=c.value:c instanceof ss?n[o]=c._getPartialProperties(n[o]):ls(c)||Vs(c)||gn(c)||pu(c)?n[o]=c:delete n[o]}})),n}set(n){return Object.keys(n).forEach((o=>{Reflect.has(this,o)&&Kt(this[o])&&(this[o]&&Kt(this[o].value)&&Kt(this[o].setValueAtTime)?this[o].value!==n[o]&&(this[o].value=n[o]):this[o]instanceof ss?this[o].set(n[o]):this[o]=n[o])})),this}}class LA extends Ks{constructor(n="stopped"){super(),this.name="StateTimeline",this._initial=n,this.setStateAtTime(this._initial,0)}getValueAtTime(n){const o=this.get(n);return o!==null?o.state:this._initial}setStateAtTime(n,o,c){return cs(o,0),this.add(Object.assign({},c,{state:n,time:o})),this}getLastState(n,o){for(let c=this._search(o);c>=0;c--){const f=this._timeline[c];if(f.state===n)return f}}getNextState(n,o){const c=this._search(o);if(c!==-1)for(let f=c;f<this._timeline.length;f++){const v=this._timeline[f];if(v.state===n)return v}}}class Lt extends ss{constructor(){const n=rt(Lt.getDefaults(),arguments,["param","units","convert"]);for(super(n),this.name="Param",this.overridden=!1,this._minOutput=1e-7,It(Kt(n.param)&&(Xi(n.param)||n.param instanceof Lt),"param must be an AudioParam");!Xi(n.param);)n.param=n.param._param;this._swappable=!!Kt(n.swappable)&&n.swappable,this._swappable?(this.input=this.context.createGain(),this._param=n.param,this.input.connect(this._param)):this._param=this.input=n.param,this._events=new Ks(1e3),this._initialValue=this._param.defaultValue,this.units=n.units,this.convert=n.convert,this._minValue=n.minValue,this._maxValue=n.maxValue,Kt(n.value)&&n.value!==this._toType(this._initialValue)&&this.setValueAtTime(n.value,0)}static getDefaults(){return Object.assign(ss.getDefaults(),{convert:!0,units:"number"})}get value(){const n=this.now();return this.getValueAtTime(n)}set value(n){this.cancelScheduledValues(this.now()),this.setValueAtTime(n,this.now())}get minValue(){return Kt(this._minValue)?this._minValue:this.units==="time"||this.units==="frequency"||this.units==="normalRange"||this.units==="positive"||this.units==="transportTime"||this.units==="ticks"||this.units==="bpm"||this.units==="hertz"||this.units==="samples"?0:this.units==="audioRange"?-1:this.units==="decibels"?-1/0:this._param.minValue}get maxValue(){return Kt(this._maxValue)?this._maxValue:this.units==="normalRange"||this.units==="audioRange"?1:this._param.maxValue}_is(n,o){return this.units===o}_assertRange(n){return Kt(this.maxValue)&&Kt(this.minValue)&&cs(n,this._fromType(this.minValue),this._fromType(this.maxValue)),n}_fromType(n){return this.convert&&!this.overridden?this._is(n,"time")?this.toSeconds(n):this._is(n,"decibels")?DA(n):this._is(n,"frequency")?this.toFrequency(n):n:this.overridden?0:n}_toType(n){return this.convert&&this.units==="decibels"?Nr(n):n}setValueAtTime(n,o){const c=this.toSeconds(o),f=this._fromType(n);return It(isFinite(f)&&isFinite(c),`Invalid argument(s) to setValueAtTime: ${JSON.stringify(n)}, ${JSON.stringify(o)}`),this._assertRange(f),this.log(this.units,"setValueAtTime",n,c),this._events.add({time:c,type:"setValueAtTime",value:f}),this._param.setValueAtTime(f,c),this}getValueAtTime(n){const o=Math.max(this.toSeconds(n),0),c=this._events.getAfter(o),f=this._events.get(o);let v=this._initialValue;if(f===null)v=this._initialValue;else if(f.type!=="setTargetAtTime"||c!==null&&c.type!=="setValueAtTime")if(c===null)v=f.value;else if(c.type==="linearRampToValueAtTime"||c.type==="exponentialRampToValueAtTime"){let B=f.value;if(f.type==="setTargetAtTime"){const _=this._events.getBefore(f.time);B=_===null?this._initialValue:_.value}v=c.type==="linearRampToValueAtTime"?this._linearInterpolate(f.time,B,c.time,c.value,o):this._exponentialInterpolate(f.time,B,c.time,c.value,o)}else v=f.value;else{const B=this._events.getBefore(f.time);let _;_=B===null?this._initialValue:B.value,f.type==="setTargetAtTime"&&(v=this._exponentialApproach(f.time,_,f.value,f.constant,o))}return this._toType(v)}setRampPoint(n){n=this.toSeconds(n);let o=this.getValueAtTime(n);return this.cancelAndHoldAtTime(n),this._fromType(o)===0&&(o=this._toType(this._minOutput)),this.setValueAtTime(o,n),this}linearRampToValueAtTime(n,o){const c=this._fromType(n),f=this.toSeconds(o);return It(isFinite(c)&&isFinite(f),`Invalid argument(s) to linearRampToValueAtTime: ${JSON.stringify(n)}, ${JSON.stringify(o)}`),this._assertRange(c),this._events.add({time:f,type:"linearRampToValueAtTime",value:c}),this.log(this.units,"linearRampToValueAtTime",n,f),this._param.linearRampToValueAtTime(c,f),this}exponentialRampToValueAtTime(n,o){let c=this._fromType(n);c=vn(c,0)?this._minOutput:c,this._assertRange(c);const f=this.toSeconds(o);return It(isFinite(c)&&isFinite(f),`Invalid argument(s) to exponentialRampToValueAtTime: ${JSON.stringify(n)}, ${JSON.stringify(o)}`),this._events.add({time:f,type:"exponentialRampToValueAtTime",value:c}),this.log(this.units,"exponentialRampToValueAtTime",n,f),this._param.exponentialRampToValueAtTime(c,f),this}exponentialRampTo(n,o,c){return c=this.toSeconds(c),this.setRampPoint(c),this.exponentialRampToValueAtTime(n,c+this.toSeconds(o)),this}linearRampTo(n,o,c){return c=this.toSeconds(c),this.setRampPoint(c),this.linearRampToValueAtTime(n,c+this.toSeconds(o)),this}targetRampTo(n,o,c){return c=this.toSeconds(c),this.setRampPoint(c),this.exponentialApproachValueAtTime(n,c,o),this}exponentialApproachValueAtTime(n,o,c){o=this.toSeconds(o),c=this.toSeconds(c);const f=Math.log(c+1)/Math.log(200);return this.setTargetAtTime(n,o,f),this.cancelAndHoldAtTime(o+.9*c),this.linearRampToValueAtTime(n,o+c),this}setTargetAtTime(n,o,c){const f=this._fromType(n);It(isFinite(c)&&c>0,"timeConstant must be a number greater than 0");const v=this.toSeconds(o);return this._assertRange(f),It(isFinite(f)&&isFinite(v),`Invalid argument(s) to setTargetAtTime: ${JSON.stringify(n)}, ${JSON.stringify(o)}`),this._events.add({constant:c,time:v,type:"setTargetAtTime",value:f}),this.log(this.units,"setTargetAtTime",n,v,c),this._param.setTargetAtTime(f,v,c),this}setValueCurveAtTime(n,o,c,f=1){c=this.toSeconds(c),o=this.toSeconds(o);const v=this._fromType(n[0])*f;this.setValueAtTime(this._toType(v),o);const B=c/(n.length-1);for(let _=1;_<n.length;_++){const S=this._fromType(n[_])*f;this.linearRampToValueAtTime(this._toType(S),o+_*B)}return this}cancelScheduledValues(n){const o=this.toSeconds(n);return It(isFinite(o),`Invalid argument to cancelScheduledValues: ${JSON.stringify(n)}`),this._events.cancel(o),this._param.cancelScheduledValues(o),this.log(this.units,"cancelScheduledValues",o),this}cancelAndHoldAtTime(n){const o=this.toSeconds(n),c=this._fromType(this.getValueAtTime(o));It(isFinite(o),`Invalid argument to cancelAndHoldAtTime: ${JSON.stringify(n)}`),this.log(this.units,"cancelAndHoldAtTime",o,"value="+c);const f=this._events.get(o),v=this._events.getAfter(o);return f&&vn(f.time,o)?v?(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time)):(this._param.cancelAndHoldAtTime(o),this._events.cancel(o+this.sampleTime)):v&&(this._param.cancelScheduledValues(v.time),this._events.cancel(v.time),v.type==="linearRampToValueAtTime"?this.linearRampToValueAtTime(this._toType(c),o):v.type==="exponentialRampToValueAtTime"&&this.exponentialRampToValueAtTime(this._toType(c),o)),this._events.add({time:o,type:"setValueAtTime",value:c}),this._param.setValueAtTime(c,o),this}rampTo(n,o=.1,c){return this.units==="frequency"||this.units==="bpm"||this.units==="decibels"?this.exponentialRampTo(n,o,c):this.linearRampTo(n,o,c),this}apply(n){const o=this.context.currentTime;n.setValueAtTime(this.getValueAtTime(o),o);const c=this._events.get(o);if(c&&c.type==="setTargetAtTime"){const f=this._events.getAfter(c.time),v=f?f.time:o+2,B=(v-o)/10;for(let _=o;_<v;_+=B)n.linearRampToValueAtTime(this.getValueAtTime(_),_)}return this._events.forEachAfter(this.context.currentTime,(f=>{f.type==="cancelScheduledValues"?n.cancelScheduledValues(f.time):f.type==="setTargetAtTime"?n.setTargetAtTime(f.value,f.time,f.constant):n[f.type](f.value,f.time)})),this}setParam(n){It(this._swappable,"The Param must be assigned as 'swappable' in the constructor");const o=this.input;return o.disconnect(this._param),this.apply(n),this._param=n,o.connect(this._param),this}dispose(){return super.dispose(),this._events.dispose(),this}get defaultValue(){return this._toType(this._param.defaultValue)}_exponentialApproach(n,o,c,f,v){return c+(o-c)*Math.exp(-(v-n)/f)}_linearInterpolate(n,o,c,f,v){return o+(v-n)/(c-n)*(f-o)}_exponentialInterpolate(n,o,c,f,v){return o*Math.pow(f/o,(v-n)/(c-n))}}class ht extends ss{constructor(){super(...arguments),this._internalChannels=[]}get numberOfInputs(){return Kt(this.input)?Xi(this.input)||this.input instanceof Lt?1:this.input.numberOfInputs:0}get numberOfOutputs(){return Kt(this.output)?this.output.numberOfOutputs:0}_isAudioNode(n){return Kt(n)&&(n instanceof ht||gi(n))}_getInternalNodes(){const n=this._internalChannels.slice(0);return this._isAudioNode(this.input)&&n.push(this.input),this._isAudioNode(this.output)&&this.input!==this.output&&n.push(this.output),n}_setChannelProperties(n){this._getInternalNodes().forEach((o=>{o.channelCount=n.channelCount,o.channelCountMode=n.channelCountMode,o.channelInterpretation=n.channelInterpretation}))}_getChannelProperties(){const n=this._getInternalNodes();It(n.length>0,"ToneAudioNode does not have any internal nodes");const o=n[0];return{channelCount:o.channelCount,channelCountMode:o.channelCountMode,channelInterpretation:o.channelInterpretation}}get channelCount(){return this._getChannelProperties().channelCount}set channelCount(n){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCount:n}))}get channelCountMode(){return this._getChannelProperties().channelCountMode}set channelCountMode(n){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelCountMode:n}))}get channelInterpretation(){return this._getChannelProperties().channelInterpretation}set channelInterpretation(n){const o=this._getChannelProperties();this._setChannelProperties(Object.assign(o,{channelInterpretation:n}))}connect(n,o=0,c=0){return Es(this,n,o,c),this}toDestination(){return this.connect(this.context.destination),this}toMaster(){return TA("toMaster() has been renamed toDestination()"),this.toDestination()}disconnect(n,o=0,c=0){return _u(this,n,o,c),this}chain(...n){return qs(this,...n),this}fan(...n){return n.forEach((o=>this.connect(o))),this}dispose(){return super.dispose(),Kt(this.input)&&(this.input instanceof ht?this.input.dispose():gi(this.input)&&this.input.disconnect()),Kt(this.output)&&(this.output instanceof ht?this.output.dispose():gi(this.output)&&this.output.disconnect()),this._internalChannels=[],this}}function qs(...p){const n=p.shift();p.reduce(((o,c)=>(o instanceof ht?o.connect(c):gi(o)&&Es(o,c),c)),n)}function Es(p,n,o=0,c=0){for(It(Kt(p),"Cannot connect from undefined node"),It(Kt(n),"Cannot connect to undefined node"),(n instanceof ht||gi(n))&&It(n.numberOfInputs>0,"Cannot connect to node with no inputs"),It(p.numberOfOutputs>0,"Cannot connect from node with no outputs");n instanceof ht||n instanceof Lt;)Kt(n.input)&&(n=n.input);for(;p instanceof ht;)Kt(p.output)&&(p=p.output);Xi(n)?p.connect(n,o):p.connect(n,o,c)}function _u(p,n,o=0,c=0){if(Kt(n))for(;n instanceof ht;)n=n.input;for(;!gi(p);)Kt(p.output)&&(p=p.output);Xi(n)?p.disconnect(n,o):gi(n)?p.disconnect(n,o,c):p.disconnect()}function OC(...p){const n=p.pop();Kt(n)&&p.forEach((o=>Es(o,n)))}class Tt extends ht{constructor(){const n=rt(Tt.getDefaults(),arguments,["gain","units"]);super(n),this.name="Gain",this._gainNode=this.context.createGain(),this.input=this._gainNode,this.output=this._gainNode,this.gain=new Lt({context:this.context,convert:n.convert,param:this._gainNode.gain,units:n.units,value:n.gain,minValue:n.minValue,maxValue:n.maxValue}),Ut(this,"gain")}static getDefaults(){return Object.assign(ht.getDefaults(),{convert:!0,gain:1,units:"gain"})}dispose(){return super.dispose(),this._gainNode.disconnect(),this.gain.dispose(),this}}class RA extends ht{constructor(n){super(n),this.onended=Xt,this._startTime=-1,this._stopTime=-1,this._timeout=-1,this.output=new Tt({context:this.context,gain:0}),this._gainNode=this.output,this.getStateAtTime=function(o){const c=this.toSeconds(o);return this._startTime!==-1&&c>=this._startTime&&(this._stopTime===-1||c<=this._stopTime)?"started":"stopped"},this._fadeIn=n.fadeIn,this._fadeOut=n.fadeOut,this._curve=n.curve,this.onended=n.onended}static getDefaults(){return Object.assign(ht.getDefaults(),{curve:"linear",fadeIn:0,fadeOut:0,onended:Xt})}_startGain(n,o=1){It(this._startTime===-1,"Source cannot be started more than once");const c=this.toSeconds(this._fadeIn);return this._startTime=n+c,this._startTime=Math.max(this._startTime,this.context.currentTime),c>0?(this._gainNode.gain.setValueAtTime(0,n),this._curve==="linear"?this._gainNode.gain.linearRampToValueAtTime(o,n+c):this._gainNode.gain.exponentialApproachValueAtTime(o,n,c)):this._gainNode.gain.setValueAtTime(o,n),this}stop(n){return this.log("stop",n),this._stopGain(this.toSeconds(n)),this}_stopGain(n){It(this._startTime!==-1,"'start' must be called before 'stop'"),this.cancelStop();const o=this.toSeconds(this._fadeOut);return this._stopTime=this.toSeconds(n)+o,this._stopTime=Math.max(this._stopTime,this.now()),o>0?this._curve==="linear"?this._gainNode.gain.linearRampTo(0,o,n):this._gainNode.gain.targetRampTo(0,o,n):(this._gainNode.gain.cancelAndHoldAtTime(n),this._gainNode.gain.setValueAtTime(0,n)),this.context.clearTimeout(this._timeout),this._timeout=this.context.setTimeout((()=>{const c=this._curve==="exponential"?2*o:0;this._stopSource(this.now()+c),this._onended()}),this._stopTime-this.context.currentTime),this}_onended(){if(this.onended!==Xt&&(this.onended(this),this.onended=Xt,!this.context.isOffline)){const n=()=>this.dispose();window.requestIdleCallback!==void 0?window.requestIdleCallback(n):setTimeout(n,1e3)}}get state(){return this.getStateAtTime(this.now())}cancelStop(){return this.log("cancelStop"),It(this._startTime!==-1,"Source is not started"),this._gainNode.gain.cancelScheduledValues(this._startTime+this.sampleTime),this.context.clearTimeout(this._timeout),this._stopTime=-1,this}dispose(){return super.dispose(),this._gainNode.dispose(),this.onended=Xt,this}}class Oa extends RA{constructor(){const n=rt(Oa.getDefaults(),arguments,["offset"]);super(n),this.name="ToneConstantSource",this._source=this.context.createConstantSource(),Es(this._source,this._gainNode),this.offset=new Lt({context:this.context,convert:n.convert,param:this._source.offset,units:n.units,value:n.offset,minValue:n.minValue,maxValue:n.maxValue})}static getDefaults(){return Object.assign(RA.getDefaults(),{convert:!0,offset:1,units:"number"})}start(n){const o=this.toSeconds(n);return this.log("start",o),this._startGain(o),this._source.start(o),this}_stopSource(n){this._source.stop(n)}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._source.disconnect(),this.offset.dispose(),this}}class Dt extends ht{constructor(){const n=rt(Dt.getDefaults(),arguments,["value","units"]);super(n),this.name="Signal",this.override=!0,this.output=this._constantSource=new Oa({context:this.context,convert:n.convert,offset:n.value,units:n.units,minValue:n.minValue,maxValue:n.maxValue}),this._constantSource.start(0),this.input=this._param=this._constantSource.offset}static getDefaults(){return Object.assign(ht.getDefaults(),{convert:!0,units:"number",value:0})}connect(n,o=0,c=0){return Or(this,n,o,c),this}dispose(){return super.dispose(),this._param.dispose(),this._constantSource.dispose(),this}setValueAtTime(n,o){return this._param.setValueAtTime(n,o),this}getValueAtTime(n){return this._param.getValueAtTime(n)}setRampPoint(n){return this._param.setRampPoint(n),this}linearRampToValueAtTime(n,o){return this._param.linearRampToValueAtTime(n,o),this}exponentialRampToValueAtTime(n,o){return this._param.exponentialRampToValueAtTime(n,o),this}exponentialRampTo(n,o,c){return this._param.exponentialRampTo(n,o,c),this}linearRampTo(n,o,c){return this._param.linearRampTo(n,o,c),this}targetRampTo(n,o,c){return this._param.targetRampTo(n,o,c),this}exponentialApproachValueAtTime(n,o,c){return this._param.exponentialApproachValueAtTime(n,o,c),this}setTargetAtTime(n,o,c){return this._param.setTargetAtTime(n,o,c),this}setValueCurveAtTime(n,o,c,f){return this._param.setValueCurveAtTime(n,o,c,f),this}cancelScheduledValues(n){return this._param.cancelScheduledValues(n),this}cancelAndHoldAtTime(n){return this._param.cancelAndHoldAtTime(n),this}rampTo(n,o,c){return this._param.rampTo(n,o,c),this}get value(){return this._param.value}set value(n){this._param.value=n}get convert(){return this._param.convert}set convert(n){this._param.convert=n}get units(){return this._param.units}get overridden(){return this._param.overridden}set overridden(n){this._param.overridden=n}get maxValue(){return this._param.maxValue}get minValue(){return this._param.minValue}apply(n){return this._param.apply(n),this}}function Or(p,n,o,c){(n instanceof Lt||Xi(n)||n instanceof Dt&&n.override)&&(n.cancelScheduledValues(0),n.setValueAtTime(0,0),n instanceof Dt&&(n.overridden=!0)),Es(p,n,o,c)}class xu extends Lt{constructor(){const n=rt(xu.getDefaults(),arguments,["value"]);super(n),this.name="TickParam",this._events=new Ks(1/0),this._multiplier=1,this._multiplier=n.multiplier,this._events.cancel(0),this._events.add({ticks:0,time:0,type:"setValueAtTime",value:this._fromType(n.value)}),this.setValueAtTime(n.value,0)}static getDefaults(){return Object.assign(Lt.getDefaults(),{multiplier:1,units:"hertz",value:1})}setTargetAtTime(n,o,c){o=this.toSeconds(o),this.setRampPoint(o);const f=this._fromType(n),v=this._events.get(o),B=Math.round(Math.max(1/c,1));for(let _=0;_<=B;_++){const S=c*_+o,F=this._exponentialApproach(v.time,v.value,f,c,S);this.linearRampToValueAtTime(this._toType(F),S)}return this}setValueAtTime(n,o){const c=this.toSeconds(o);super.setValueAtTime(n,o);const f=this._events.get(c),v=this._events.previousEvent(f),B=this._getTicksUntilEvent(v,c);return f.ticks=Math.max(B,0),this}linearRampToValueAtTime(n,o){const c=this.toSeconds(o);super.linearRampToValueAtTime(n,o);const f=this._events.get(c),v=this._events.previousEvent(f),B=this._getTicksUntilEvent(v,c);return f.ticks=Math.max(B,0),this}exponentialRampToValueAtTime(n,o){o=this.toSeconds(o);const c=this._fromType(n),f=this._events.get(o),v=Math.round(Math.max(10*(o-f.time),1)),B=(o-f.time)/v;for(let _=0;_<=v;_++){const S=B*_+f.time,F=this._exponentialInterpolate(f.time,f.value,o,c,S);this.linearRampToValueAtTime(this._toType(F),S)}return this}_getTicksUntilEvent(n,o){if(n===null)n={ticks:0,time:0,type:"setValueAtTime",value:0};else if(Ps(n.ticks)){const B=this._events.previousEvent(n);n.ticks=this._getTicksUntilEvent(B,n.time)}const c=this._fromType(this.getValueAtTime(n.time));let f=this._fromType(this.getValueAtTime(o));const v=this._events.get(o);return v&&v.time===o&&v.type==="setValueAtTime"&&(f=this._fromType(this.getValueAtTime(o-this.sampleTime))),.5*(o-n.time)*(c+f)+n.ticks}getTicksAtTime(n){const o=this.toSeconds(n),c=this._events.get(o);return Math.max(this._getTicksUntilEvent(c,o),0)}getDurationOfTicks(n,o){const c=this.toSeconds(o),f=this.getTicksAtTime(o);return this.getTimeOfTick(f+n)-c}getTimeOfTick(n){const o=this._events.get(n,"ticks"),c=this._events.getAfter(n,"ticks");if(o&&o.ticks===n)return o.time;if(o&&c&&c.type==="linearRampToValueAtTime"&&o.value!==c.value){const f=this._fromType(this.getValueAtTime(o.time)),v=(this._fromType(this.getValueAtTime(c.time))-f)/(c.time-o.time),B=Math.sqrt(Math.pow(f,2)-2*v*(o.ticks-n)),_=(-f+B)/v;return(_>0?_:(-f-B)/v)+o.time}return o?o.value===0?1/0:o.time+(n-o.ticks)/o.value:n/this._initialValue}ticksToTime(n,o){return this.getDurationOfTicks(n,o)}timeToTicks(n,o){const c=this.toSeconds(o),f=this.toSeconds(n),v=this.getTicksAtTime(c);return this.getTicksAtTime(c+f)-v}_fromType(n){return this.units==="bpm"&&this.multiplier?1/(60/n/this.multiplier):super._fromType(n)}_toType(n){return this.units==="bpm"&&this.multiplier?n/this.multiplier*60:super._toType(n)}get multiplier(){return this._multiplier}set multiplier(n){const o=this.value;this._multiplier=n,this.cancelScheduledValues(0),this.setValueAtTime(o,0)}}class Eu extends Dt{constructor(){const n=rt(Eu.getDefaults(),arguments,["value"]);super(n),this.name="TickSignal",this.input=this._param=new xu({context:this.context,convert:n.convert,multiplier:n.multiplier,param:this._constantSource.offset,units:n.units,value:n.value})}static getDefaults(){return Object.assign(Dt.getDefaults(),{multiplier:1,units:"hertz",value:1})}ticksToTime(n,o){return this._param.ticksToTime(n,o)}timeToTicks(n,o){return this._param.timeToTicks(n,o)}getTimeOfTick(n){return this._param.getTimeOfTick(n)}getDurationOfTicks(n,o){return this._param.getDurationOfTicks(n,o)}getTicksAtTime(n){return this._param.getTicksAtTime(n)}get multiplier(){return this._param.multiplier}set multiplier(n){this._param.multiplier=n}dispose(){return super.dispose(),this._param.dispose(),this}}class Su extends ss{constructor(){const n=rt(Su.getDefaults(),arguments,["frequency"]);super(n),this.name="TickSource",this._state=new LA,this._tickOffset=new Ks,this._ticksAtTime=new Ks,this._secondsAtTime=new Ks,this.frequency=new Eu({context:this.context,units:n.units,value:n.frequency}),Ut(this,"frequency"),this._state.setStateAtTime("stopped",0),this.setTicksAtTime(0,0)}static getDefaults(){return Object.assign({frequency:1,units:"hertz"},ss.getDefaults())}get state(){return this.getStateAtTime(this.now())}start(n,o){const c=this.toSeconds(n);return this._state.getValueAtTime(c)!=="started"&&(this._state.setStateAtTime("started",c),Kt(o)&&this.setTicksAtTime(o,c),this._ticksAtTime.cancel(c),this._secondsAtTime.cancel(c)),this}stop(n){const o=this.toSeconds(n);if(this._state.getValueAtTime(o)==="stopped"){const c=this._state.get(o);c&&c.time>0&&(this._tickOffset.cancel(c.time),this._state.cancel(c.time))}return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this.setTicksAtTime(0,o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}pause(n){const o=this.toSeconds(n);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o)),this}cancel(n){return n=this.toSeconds(n),this._state.cancel(n),this._tickOffset.cancel(n),this._ticksAtTime.cancel(n),this._secondsAtTime.cancel(n),this}getTicksAtTime(n){const o=this.toSeconds(n),c=this._state.getLastState("stopped",o),f=this._ticksAtTime.get(o),v={state:"paused",time:o};this._state.add(v);let B=f||c,_=f?f.ticks:0,S=null;return this._state.forEachBetween(B.time,o+this.sampleTime,(F=>{let I=B.time;const M=this._tickOffset.get(F.time);M&&M.time>=B.time&&(_=M.ticks,I=M.time),B.state==="started"&&F.state!=="started"&&(_+=this.frequency.getTicksAtTime(F.time)-this.frequency.getTicksAtTime(I),F.time!==v.time&&(S={state:F.state,time:F.time,ticks:_})),B=F})),this._state.remove(v),S&&this._ticksAtTime.add(S),_}get ticks(){return this.getTicksAtTime(this.now())}set ticks(n){this.setTicksAtTime(n,this.now())}get seconds(){return this.getSecondsAtTime(this.now())}set seconds(n){const o=this.now(),c=this.frequency.timeToTicks(n,o);this.setTicksAtTime(c,o)}getSecondsAtTime(n){n=this.toSeconds(n);const o=this._state.getLastState("stopped",n),c={state:"paused",time:n};this._state.add(c);const f=this._secondsAtTime.get(n);let v=f||o,B=f?f.seconds:0,_=null;return this._state.forEachBetween(v.time,n+this.sampleTime,(S=>{let F=v.time;const I=this._tickOffset.get(S.time);I&&I.time>=v.time&&(B=I.seconds,F=I.time),v.state==="started"&&S.state!=="started"&&(B+=S.time-F,S.time!==c.time&&(_={state:S.state,time:S.time,seconds:B})),v=S})),this._state.remove(c),_&&this._secondsAtTime.add(_),B}setTicksAtTime(n,o){return o=this.toSeconds(o),this._tickOffset.cancel(o),this._tickOffset.add({seconds:this.frequency.getDurationOfTicks(n,o),ticks:n,time:o}),this._ticksAtTime.cancel(o),this._secondsAtTime.cancel(o),this}getStateAtTime(n){return n=this.toSeconds(n),this._state.getValueAtTime(n)}getTimeOfTick(n,o=this.now()){const c=this._tickOffset.get(o),f=this._state.get(o),v=Math.max(c.time,f.time),B=this.frequency.getTicksAtTime(v)+n-c.ticks;return this.frequency.getTimeOfTick(B)}forEachTickBetween(n,o,c){let f=this._state.get(n);this._state.forEachBetween(n,o,(B=>{f&&f.state==="started"&&B.state!=="started"&&this.forEachTickBetween(Math.max(f.time,n),B.time-this.sampleTime,c),f=B}));let v=null;if(f&&f.state==="started"){const B=Math.max(f.time,n),_=this.frequency.getTicksAtTime(B),S=_-this.frequency.getTicksAtTime(f.time);let F=Math.ceil(S)-S;F=vn(F,1)?0:F;let I=this.frequency.getTimeOfTick(_+F);for(;I<o;){try{c(I,Math.round(this.getTicksAtTime(I)))}catch(M){v=M;break}I+=this.frequency.getDurationOfTicks(1,I)}}if(v)throw v;return this}dispose(){return super.dispose(),this._state.dispose(),this._tickOffset.dispose(),this._ticksAtTime.dispose(),this._secondsAtTime.dispose(),this.frequency.dispose(),this}}class HA extends ss{constructor(){const n=rt(HA.getDefaults(),arguments,["callback","frequency"]);super(n),this.name="Clock",this.callback=Xt,this._lastUpdate=0,this._state=new LA("stopped"),this._boundLoop=this._loop.bind(this),this.callback=n.callback,this._tickSource=new Su({context:this.context,frequency:n.frequency,units:n.units}),this._lastUpdate=0,this.frequency=this._tickSource.frequency,Ut(this,"frequency"),this._state.setStateAtTime("stopped",0),this.context.on("tick",this._boundLoop)}static getDefaults(){return Object.assign(ss.getDefaults(),{callback:Xt,frequency:1,units:"hertz"})}get state(){return this._state.getValueAtTime(this.now())}start(n,o){mu(this.context);const c=this.toSeconds(n);return this.log("start",c),this._state.getValueAtTime(c)!=="started"&&(this._state.setStateAtTime("started",c),this._tickSource.start(c,o),c<this._lastUpdate&&this.emit("start",c,o)),this}stop(n){const o=this.toSeconds(n);return this.log("stop",o),this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._tickSource.stop(o),o<this._lastUpdate&&this.emit("stop",o),this}pause(n){const o=this.toSeconds(n);return this._state.getValueAtTime(o)==="started"&&(this._state.setStateAtTime("paused",o),this._tickSource.pause(o),o<this._lastUpdate&&this.emit("pause",o)),this}get ticks(){return Math.ceil(this.getTicksAtTime(this.now()))}set ticks(n){this._tickSource.ticks=n}get seconds(){return this._tickSource.seconds}set seconds(n){this._tickSource.seconds=n}getSecondsAtTime(n){return this._tickSource.getSecondsAtTime(n)}setTicksAtTime(n,o){return this._tickSource.setTicksAtTime(n,o),this}getTimeOfTick(n,o=this.now()){return this._tickSource.getTimeOfTick(n,o)}getTicksAtTime(n){return this._tickSource.getTicksAtTime(n)}nextTickTime(n,o){const c=this.toSeconds(o),f=this.getTicksAtTime(c);return this._tickSource.getTimeOfTick(f+n,c)}_loop(){const n=this._lastUpdate,o=this.now();this._lastUpdate=o,this.log("loop",n,o),n!==o&&(this._state.forEachBetween(n,o,(c=>{switch(c.state){case"started":const f=this._tickSource.getTicksAtTime(c.time);this.emit("start",c.time,f);break;case"stopped":c.time!==0&&this.emit("stop",c.time);break;case"paused":this.emit("pause",c.time)}})),this._tickSource.forEachTickBetween(n,o,((c,f)=>{this.callback(c,f)})))}getStateAtTime(n){const o=this.toSeconds(n);return this._state.getValueAtTime(o)}dispose(){return super.dispose(),this.context.off("tick",this._boundLoop),this._tickSource.dispose(),this._state.dispose(),this}}MA.mixin(HA);class zs extends ht{constructor(){const n=rt(zs.getDefaults(),arguments,["delayTime","maxDelay"]);super(n),this.name="Delay";const o=this.toSeconds(n.maxDelay);this._maxDelay=Math.max(o,this.toSeconds(n.delayTime)),this._delayNode=this.input=this.output=this.context.createDelay(o),this.delayTime=new Lt({context:this.context,param:this._delayNode.delayTime,units:"time",value:n.delayTime,minValue:0,maxValue:this.maxDelay}),Ut(this,"delayTime")}static getDefaults(){return Object.assign(ht.getDefaults(),{delayTime:0,maxDelay:1})}get maxDelay(){return this._maxDelay}dispose(){return super.dispose(),this._delayNode.disconnect(),this.delayTime.dispose(),this}}class Jn extends ht{constructor(){const n=rt(Jn.getDefaults(),arguments,["volume"]);super(n),this.name="Volume",this.input=this.output=new Tt({context:this.context,gain:n.volume,units:"decibels"}),this.volume=this.output.gain,Ut(this,"volume"),this._unmutedVolume=n.volume,this.mute=n.mute}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,volume:0})}get mute(){return this.volume.value===-1/0}set mute(n){!this.mute&&n?(this._unmutedVolume=this.volume.value,this.volume.value=-1/0):this.mute&&!n&&(this.volume.value=this._unmutedVolume)}dispose(){return super.dispose(),this.input.dispose(),this.volume.dispose(),this}}class Fu extends ht{constructor(){const n=rt(Fu.getDefaults(),arguments);super(n),this.name="Destination",this.input=new Jn({context:this.context}),this.output=new Tt({context:this.context}),this.volume=this.input.volume,qs(this.input,this.output,this.context.rawContext.destination),this.mute=n.mute,this._internalChannels=[this.input,this.context.rawContext.destination,this.output]}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,volume:0})}get mute(){return this.input.mute}set mute(n){this.input.mute=n}chain(...n){return this.input.disconnect(),n.unshift(this.input),n.push(this.output),qs(...n),this}get maxChannelCount(){return this.context.rawContext.destination.maxChannelCount}dispose(){return super.dispose(),this.volume.dispose(),this}}La((p=>{p.destination=new Fu({context:p})})),Ra((p=>{p.destination.dispose()}));class VC extends ht{constructor(){super(...arguments),this.name="Listener",this.positionX=new Lt({context:this.context,param:this.context.rawContext.listener.positionX}),this.positionY=new Lt({context:this.context,param:this.context.rawContext.listener.positionY}),this.positionZ=new Lt({context:this.context,param:this.context.rawContext.listener.positionZ}),this.forwardX=new Lt({context:this.context,param:this.context.rawContext.listener.forwardX}),this.forwardY=new Lt({context:this.context,param:this.context.rawContext.listener.forwardY}),this.forwardZ=new Lt({context:this.context,param:this.context.rawContext.listener.forwardZ}),this.upX=new Lt({context:this.context,param:this.context.rawContext.listener.upX}),this.upY=new Lt({context:this.context,param:this.context.rawContext.listener.upY}),this.upZ=new Lt({context:this.context,param:this.context.rawContext.listener.upZ})}static getDefaults(){return Object.assign(ht.getDefaults(),{positionX:0,positionY:0,positionZ:0,forwardX:0,forwardY:0,forwardZ:-1,upX:0,upY:1,upZ:0})}dispose(){return super.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this.forwardX.dispose(),this.forwardY.dispose(),this.forwardZ.dispose(),this.upX.dispose(),this.upY.dispose(),this.upZ.dispose(),this}}function WC(p,n){return fe(this,arguments,void 0,(function*(o,c,f=2,v=Be().sampleRate){const B=Be(),_=new PA(f,c,v);Ha(_),yield o(_);const S=_.render();Ha(B);const F=yield S;return new te(F)}))}La((p=>{p.listener=new VC({context:p})})),Ra((p=>{p.listener.dispose()}));class NA extends jn{constructor(){super(),this.name="ToneAudioBuffers",this._buffers=new Map,this._loadingCount=0;const n=rt(NA.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");this.baseUrl=n.baseUrl,Object.keys(n.urls).forEach((o=>{this._loadingCount++;const c=n.urls[o];this.add(o,c,this._bufferLoaded.bind(this,n.onload),n.onerror)}))}static getDefaults(){return{baseUrl:"",onerror:Xt,onload:Xt,urls:{}}}has(n){return this._buffers.has(n.toString())}get(n){return It(this.has(n),`ToneAudioBuffers has no buffer named: ${n}`),this._buffers.get(n.toString())}_bufferLoaded(n){this._loadingCount--,this._loadingCount===0&&n&&n()}get loaded(){return Array.from(this._buffers).every((([n,o])=>o.loaded))}add(n,o,c=Xt,f=Xt){return gn(o)?(this.baseUrl&&o.trim().substring(0,11).toLowerCase()==="data:audio/"&&(this.baseUrl=""),this._buffers.set(n.toString(),new te(this.baseUrl+o,c,f))):this._buffers.set(n.toString(),new te(o,c,f)),this}dispose(){return super.dispose(),this._buffers.forEach((n=>n.dispose())),this._buffers.clear(),this}}class OA extends xs{constructor(){super(...arguments),this.name="MidiClass",this.defaultUnits="midi"}_frequencyToUnits(n){return wi(super._frequencyToUnits(n))}_ticksToUnits(n){return wi(super._ticksToUnits(n))}_beatsToUnits(n){return wi(super._beatsToUnits(n))}_secondsToUnits(n){return wi(super._secondsToUnits(n))}toMidi(){return this.valueOf()}toFrequency(){return Cu(this.toMidi())}transpose(n){return new OA(this.context,this.toMidi()+n)}}function KC(p,n){return new OA(Be(),p,n)}class Ee extends qe{constructor(){super(...arguments),this.name="Ticks",this.defaultUnits="i"}_now(){return this.context.transport.ticks}_beatsToUnits(n){return this._getPPQ()*n}_secondsToUnits(n){return Math.floor(n/(60/this._getBpm())*this._getPPQ())}_ticksToUnits(n){return n}toTicks(){return this.valueOf()}toSeconds(){return this.valueOf()/this._getPPQ()*(60/this._getBpm())}}function GC(p,n){return new Ee(Be(),p,n)}class qC extends ss{constructor(){super(...arguments),this.name="Draw",this.expiration=.25,this.anticipation=.008,this._events=new Ks,this._boundDrawLoop=this._drawLoop.bind(this),this._animationFrame=-1}schedule(n,o){return this._events.add({callback:n,time:this.toSeconds(o)}),this._events.length===1&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop)),this}cancel(n){return this._events.cancel(this.toSeconds(n)),this}_drawLoop(){const n=this.context.currentTime;for(;this._events.length&&this._events.peek().time-this.anticipation<=n;){const o=this._events.shift();o&&n-o.time<=this.expiration&&o.callback()}this._events.length>0&&(this._animationFrame=requestAnimationFrame(this._boundDrawLoop))}dispose(){return super.dispose(),this._events.dispose(),cancelAnimationFrame(this._animationFrame),this}}La((p=>{p.draw=new qC({context:p})})),Ra((p=>{p.draw.dispose()}));class hm extends jn{constructor(){super(...arguments),this.name="IntervalTimeline",this._root=null,this._length=0}add(n){It(Kt(n.time),"Events must have a time property"),It(Kt(n.duration),"Events must have a duration parameter"),n.time=n.time.valueOf();let o=new zC(n.time,n.time+n.duration,n);for(this._root===null?this._root=o:this._root.insert(o),this._length++;o!==null;)o.updateHeight(),o.updateMax(),this._rebalance(o),o=o.parent;return this}remove(n){if(this._root!==null){const o=[];this._root.search(n.time,o);for(const c of o)if(c.event===n){this._removeNode(c),this._length--;break}}return this}get length(){return this._length}cancel(n){return this.forEachFrom(n,(o=>this.remove(o))),this}_setRoot(n){this._root=n,this._root!==null&&(this._root.parent=null)}_replaceNodeInParent(n,o){n.parent!==null?(n.isLeftChild()?n.parent.left=o:n.parent.right=o,this._rebalance(n.parent)):this._setRoot(o)}_removeNode(n){if(n.left===null&&n.right===null)this._replaceNodeInParent(n,null);else if(n.right===null)this._replaceNodeInParent(n,n.left);else if(n.left===null)this._replaceNodeInParent(n,n.right);else{let o,c=null;if(n.getBalance()>0)if(n.left.right===null)o=n.left,o.right=n.right,c=o;else{for(o=n.left.right;o.right!==null;)o=o.right;o.parent&&(o.parent.right=o.left,c=o.parent,o.left=n.left,o.right=n.right)}else if(n.right.left===null)o=n.right,o.left=n.left,c=o;else{for(o=n.right.left;o.left!==null;)o=o.left;o.parent&&(o.parent.left=o.right,c=o.parent,o.left=n.left,o.right=n.right)}n.parent!==null?n.isLeftChild()?n.parent.left=o:n.parent.right=o:this._setRoot(o),c&&this._rebalance(c)}n.dispose()}_rotateLeft(n){const o=n.parent,c=n.isLeftChild(),f=n.right;f&&(n.right=f.left,f.left=n),o!==null?c?o.left=f:o.right=f:this._setRoot(f)}_rotateRight(n){const o=n.parent,c=n.isLeftChild(),f=n.left;f&&(n.left=f.right,f.right=n),o!==null?c?o.left=f:o.right=f:this._setRoot(f)}_rebalance(n){const o=n.getBalance();o>1&&n.left?n.left.getBalance()<0?this._rotateLeft(n.left):this._rotateRight(n):o<-1&&n.right&&(n.right.getBalance()>0?this._rotateRight(n.right):this._rotateLeft(n))}get(n){if(this._root!==null){const o=[];if(this._root.search(n,o),o.length>0){let c=o[0];for(let f=1;f<o.length;f++)o[f].low>c.low&&(c=o[f]);return c.event}}return null}forEach(n){if(this._root!==null){const o=[];this._root.traverse((c=>o.push(c))),o.forEach((c=>{c.event&&n(c.event)}))}return this}forEachAtTime(n,o){if(this._root!==null){const c=[];this._root.search(n,c),c.forEach((f=>{f.event&&o(f.event)}))}return this}forEachFrom(n,o){if(this._root!==null){const c=[];this._root.searchAfter(n,c),c.forEach((f=>{f.event&&o(f.event)}))}return this}dispose(){return super.dispose(),this._root!==null&&this._root.traverse((n=>n.dispose())),this._root=null,this}}class zC{constructor(n,o,c){this._left=null,this._right=null,this.parent=null,this.height=0,this.event=c,this.low=n,this.high=o,this.max=this.high}insert(n){n.low<=this.low?this.left===null?this.left=n:this.left.insert(n):this.right===null?this.right=n:this.right.insert(n)}search(n,o){n>this.max||(this.left!==null&&this.left.search(n,o),this.low<=n&&this.high>n&&o.push(this),this.low>n||this.right!==null&&this.right.search(n,o))}searchAfter(n,o){this.low>=n&&(o.push(this),this.left!==null&&this.left.searchAfter(n,o)),this.right!==null&&this.right.searchAfter(n,o)}traverse(n){n(this),this.left!==null&&this.left.traverse(n),this.right!==null&&this.right.traverse(n)}updateHeight(){this.left!==null&&this.right!==null?this.height=Math.max(this.left.height,this.right.height)+1:this.right!==null?this.height=this.right.height+1:this.left!==null?this.height=this.left.height+1:this.height=0}updateMax(){this.max=this.high,this.left!==null&&(this.max=Math.max(this.max,this.left.max)),this.right!==null&&(this.max=Math.max(this.max,this.right.max))}getBalance(){let n=0;return this.left!==null&&this.right!==null?n=this.left.height-this.right.height:this.left!==null?n=this.left.height+1:this.right!==null&&(n=-(this.right.height+1)),n}isLeftChild(){return this.parent!==null&&this.parent.left===this}get left(){return this._left}set left(n){this._left=n,n!==null&&(n.parent=this),this.updateHeight(),this.updateMax()}get right(){return this._right}set right(n){this._right=n,n!==null&&(n.parent=this),this.updateHeight(),this.updateMax()}dispose(){this.parent=null,this._left=null,this._right=null,this.event=null}}class $C extends jn{constructor(n){super(),this.name="TimelineValue",this._timeline=new Ks({memory:10}),this._initialValue=n}set(n,o){return this._timeline.add({value:n,time:o}),this}get(n){const o=this._timeline.get(n);return o?o.value:this._initialValue}}class $s extends ht{constructor(){super(rt($s.getDefaults(),arguments,["context"]))}connect(n,o=0,c=0){return Or(this,n,o,c),this}}class Bn extends $s{constructor(){const n=rt(Bn.getDefaults(),arguments,["mapping","length"]);super(n),this.name="WaveShaper",this._shaper=this.context.createWaveShaper(),this.input=this._shaper,this.output=this._shaper,ls(n.mapping)||n.mapping instanceof Float32Array?this.curve=Float32Array.from(n.mapping):nm(n.mapping)&&this.setMap(n.mapping,n.length)}static getDefaults(){return Object.assign(Dt.getDefaults(),{length:1024})}setMap(n,o=1024){const c=new Float32Array(o);for(let f=0,v=o;f<v;f++){const B=f/(v-1)*2-1;c[f]=n(B,f)}return this.curve=c,this}get curve(){return this._shaper.curve}set curve(n){this._shaper.curve=n}get oversample(){return this._shaper.oversample}set oversample(n){It(["none","2x","4x"].some((o=>o.includes(n))),"oversampling must be either 'none', '2x', or '4x'"),this._shaper.oversample=n}dispose(){return super.dispose(),this._shaper.disconnect(),this}}class VA extends $s{constructor(){const n=rt(VA.getDefaults(),arguments,["value"]);super(n),this.name="Pow",this._exponentScaler=this.input=this.output=new Bn({context:this.context,mapping:this._expFunc(n.value),length:8192}),this._exponent=n.value}static getDefaults(){return Object.assign($s.getDefaults(),{value:1})}_expFunc(n){return o=>Math.pow(Math.abs(o),n)}get value(){return this._exponent}set value(n){this._exponent=n,this._exponentScaler.setMap(this._expFunc(this._exponent))}dispose(){return super.dispose(),this._exponentScaler.dispose(),this}}class vi{constructor(n,o){this.id=vi._eventId++,this._remainderTime=0;const c=Object.assign(vi.getDefaults(),o);this.transport=n,this.callback=c.callback,this._once=c.once,this.time=Math.floor(c.time),this._remainderTime=c.time-this.time}static getDefaults(){return{callback:Xt,once:!1,time:0}}get floatTime(){return this.time+this._remainderTime}invoke(n){if(this.callback){const o=this.transport.bpm.getDurationOfTicks(1,n);this.callback(n+this._remainderTime*o),this._once&&this.transport.clear(this.id)}}dispose(){return this.callback=void 0,this}}vi._eventId=0;class Tu extends vi{constructor(n,o){super(n,o),this._currentId=-1,this._nextId=-1,this._nextTick=this.time,this._boundRestart=this._restart.bind(this);const c=Object.assign(Tu.getDefaults(),o);this.duration=c.duration,this._interval=c.interval,this._nextTick=c.time,this.transport.on("start",this._boundRestart),this.transport.on("loopStart",this._boundRestart),this.transport.on("ticks",this._boundRestart),this.context=this.transport.context,this._restart()}static getDefaults(){return Object.assign({},vi.getDefaults(),{duration:1/0,interval:1,once:!1})}invoke(n){this._createEvents(n),super.invoke(n)}_createEvent(){return ka(this._nextTick,this.floatTime+this.duration)?this.transport.scheduleOnce(this.invoke.bind(this),new Ee(this.context,this._nextTick).toSeconds()):-1}_createEvents(n){ka(this._nextTick+this._interval,this.floatTime+this.duration)&&(this._nextTick+=this._interval,this._currentId=this._nextId,this._nextId=this.transport.scheduleOnce(this.invoke.bind(this),new Ee(this.context,this._nextTick).toSeconds()))}_restart(n){this.transport.clear(this._currentId),this.transport.clear(this._nextId),this._nextTick=this.floatTime;const o=this.transport.getTicksAtTime(n);QA(o,this.time)&&(this._nextTick=this.floatTime+Math.ceil((o-this.floatTime)/this._interval)*this._interval),this._currentId=this._createEvent(),this._nextTick+=this._interval,this._nextId=this._createEvent()}dispose(){return super.dispose(),this.transport.clear(this._currentId),this.transport.clear(this._nextId),this.transport.off("start",this._boundRestart),this.transport.off("loopStart",this._boundRestart),this.transport.off("ticks",this._boundRestart),this}}class Va extends ss{constructor(){const n=rt(Va.getDefaults(),arguments);super(n),this.name="Transport",this._loop=new $C(!1),this._loopStart=0,this._loopEnd=0,this._scheduledEvents={},this._timeline=new Ks,this._repeatedEvents=new hm,this._syncedSignals=[],this._swingAmount=0,this._ppq=n.ppq,this._clock=new HA({callback:this._processTick.bind(this),context:this.context,frequency:0,units:"bpm"}),this._bindClockEvents(),this.bpm=this._clock.frequency,this._clock.frequency.multiplier=n.ppq,this.bpm.setValueAtTime(n.bpm,0),Ut(this,"bpm"),this._timeSignature=n.timeSignature,this._swingTicks=n.ppq/2}static getDefaults(){return Object.assign(ss.getDefaults(),{bpm:120,loopEnd:"4m",loopStart:0,ppq:192,swing:0,swingSubdivision:"8n",timeSignature:4})}_processTick(n,o){if(this._loop.get(n)&&o>=this._loopEnd&&(this.emit("loopEnd",n),this._clock.setTicksAtTime(this._loopStart,n),o=this._loopStart,this.emit("loopStart",n,this._clock.getSecondsAtTime(n)),this.emit("loop",n)),this._swingAmount>0&&o%this._ppq!=0&&o%(2*this._swingTicks)!=0){const c=o%(2*this._swingTicks)/(2*this._swingTicks),f=Math.sin(c*Math.PI)*this._swingAmount;n+=new Ee(this.context,2*this._swingTicks/3).toSeconds()*f}gu(!0),this._timeline.forEachAtTime(o,(c=>c.invoke(n))),gu(!1)}schedule(n,o){const c=new vi(this,{callback:n,time:new qe(this.context,o).toTicks()});return this._addEvent(c,this._timeline)}scheduleRepeat(n,o,c,f=1/0){const v=new Tu(this,{callback:n,duration:new Gs(this.context,f).toTicks(),interval:new Gs(this.context,o).toTicks(),time:new qe(this.context,c).toTicks()});return this._addEvent(v,this._repeatedEvents)}scheduleOnce(n,o){const c=new vi(this,{callback:n,once:!0,time:new qe(this.context,o).toTicks()});return this._addEvent(c,this._timeline)}clear(n){if(this._scheduledEvents.hasOwnProperty(n)){const o=this._scheduledEvents[n.toString()];o.timeline.remove(o.event),o.event.dispose(),delete this._scheduledEvents[n.toString()]}return this}_addEvent(n,o){return this._scheduledEvents[n.id.toString()]={event:n,timeline:o},o.add(n),n.id}cancel(n=0){const o=this.toTicks(n);return this._timeline.forEachFrom(o,(c=>this.clear(c.id))),this._repeatedEvents.forEachFrom(o,(c=>this.clear(c.id))),this}_bindClockEvents(){this._clock.on("start",((n,o)=>{o=new Ee(this.context,o).toSeconds(),this.emit("start",n,o)})),this._clock.on("stop",(n=>{this.emit("stop",n)})),this._clock.on("pause",(n=>{this.emit("pause",n)}))}get state(){return this._clock.getStateAtTime(this.now())}start(n,o){let c;return this.context.resume(),Kt(o)&&(c=this.toTicks(o)),this._clock.start(n,c),this}stop(n){return this._clock.stop(n),this}pause(n){return this._clock.pause(n),this}toggle(n){return n=this.toSeconds(n),this._clock.getStateAtTime(n)!=="started"?this.start(n):this.stop(n),this}get timeSignature(){return this._timeSignature}set timeSignature(n){ls(n)&&(n=n[0]/n[1]*4),this._timeSignature=n}get loopStart(){return new Gs(this.context,this._loopStart,"i").toSeconds()}set loopStart(n){this._loopStart=this.toTicks(n)}get loopEnd(){return new Gs(this.context,this._loopEnd,"i").toSeconds()}set loopEnd(n){this._loopEnd=this.toTicks(n)}get loop(){return this._loop.get(this.now())}set loop(n){this._loop.set(n,this.now())}setLoopPoints(n,o){return this.loopStart=n,this.loopEnd=o,this}get swing(){return this._swingAmount}set swing(n){this._swingAmount=n}get swingSubdivision(){return new Ee(this.context,this._swingTicks).toNotation()}set swingSubdivision(n){this._swingTicks=this.toTicks(n)}get position(){const n=this.now(),o=this._clock.getTicksAtTime(n);return new Ee(this.context,o).toBarsBeatsSixteenths()}set position(n){const o=this.toTicks(n);this.ticks=o}get seconds(){return this._clock.seconds}set seconds(n){const o=this.now(),c=this._clock.frequency.timeToTicks(n,o);this.ticks=c}get progress(){if(this.loop){const n=this.now();return(this._clock.getTicksAtTime(n)-this._loopStart)/(this._loopEnd-this._loopStart)}return 0}get ticks(){return this._clock.ticks}set ticks(n){if(this._clock.ticks!==n){const o=this.now();if(this.state==="started"){const c=this._clock.getTicksAtTime(o),f=o+this._clock.frequency.getDurationOfTicks(Math.ceil(c)-c,o);this.emit("stop",f),this._clock.setTicksAtTime(n,f),this.emit("start",f,this._clock.getSecondsAtTime(f))}else this.emit("ticks",o),this._clock.setTicksAtTime(n,o)}}getTicksAtTime(n){return this._clock.getTicksAtTime(n)}getSecondsAtTime(n){return this._clock.getSecondsAtTime(n)}get PPQ(){return this._clock.frequency.multiplier}set PPQ(n){this._clock.frequency.multiplier=n}nextSubdivision(n){if(n=this.toTicks(n),this.state!=="started")return 0;{const o=this.now(),c=n-this.getTicksAtTime(o)%n;return this._clock.nextTickTime(c,o)}}syncSignal(n,o){const c=this.now();let f=this.bpm,v=1/(60/f.getValueAtTime(c)/this.PPQ),B=[];if(n.units==="time"){const S=.015625/v,F=new Tt(S),I=new VA(-1),M=new Tt(S);f.chain(F,I,M),f=M,v=1/v,B=[F,I,M]}o||(o=n.getValueAtTime(c)!==0?n.getValueAtTime(c)/v:0);const _=new Tt(o);return f.connect(_),_.connect(n._param),B.push(_),this._syncedSignals.push({initial:n.value,nodes:B,signal:n}),n.value=0,this}unsyncSignal(n){for(let o=this._syncedSignals.length-1;o>=0;o--){const c=this._syncedSignals[o];c.signal===n&&(c.nodes.forEach((f=>f.dispose())),c.signal.value=c.initial,this._syncedSignals.splice(o,1))}return this}dispose(){return super.dispose(),this._clock.dispose(),Rr(this,"bpm"),this._timeline.dispose(),this._repeatedEvents.dispose(),this}}MA.mixin(Va),La((p=>{p.transport=new Va({context:p})})),Ra((p=>{p.transport.dispose()}));class Pe extends ht{constructor(n){super(n),this.input=void 0,this._state=new LA("stopped"),this._synced=!1,this._scheduled=[],this._syncedStart=Xt,this._syncedStop=Xt,this._state.memory=100,this._state.increasing=!0,this._volume=this.output=new Jn({context:this.context,mute:n.mute,volume:n.volume}),this.volume=this._volume.volume,Ut(this,"volume"),this.onstop=n.onstop}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,onstop:Xt,volume:0})}get state(){return this._synced?this.context.transport.state==="started"?this._state.getValueAtTime(this.context.transport.seconds):"stopped":this._state.getValueAtTime(this.now())}get mute(){return this._volume.mute}set mute(n){this._volume.mute=n}_clampToCurrentTime(n){return this._synced?n:Math.max(n,this.context.currentTime)}start(n,o,c){let f=Ps(n)&&this._synced?this.context.transport.seconds:this.toSeconds(n);if(f=this._clampToCurrentTime(f),this._synced||this._state.getValueAtTime(f)!=="started")if(this.log("start",f),this._state.setStateAtTime("started",f),this._synced){const v=this._state.get(f);v&&(v.offset=this.toSeconds(sn(o,0)),v.duration=c?this.toSeconds(c):void 0);const B=this.context.transport.schedule((_=>{this._start(_,o,c)}),f);this._scheduled.push(B),this.context.transport.state==="started"&&this.context.transport.getSecondsAtTime(this.immediate())>f&&this._syncedStart(this.now(),this.context.transport.seconds)}else mu(this.context),this._start(f,o,c);else It(QA(f,this._state.get(f).time),"Start time must be strictly greater than previous start time"),this._state.cancel(f),this._state.setStateAtTime("started",f),this.log("restart",f),this.restart(f,o,c);return this}stop(n){let o=Ps(n)&&this._synced?this.context.transport.seconds:this.toSeconds(n);if(o=this._clampToCurrentTime(o),this._state.getValueAtTime(o)==="started"||Kt(this._state.getNextState("started",o))){if(this.log("stop",o),this._synced){const c=this.context.transport.schedule(this._stop.bind(this),o);this._scheduled.push(c)}else this._stop(o);this._state.cancel(o),this._state.setStateAtTime("stopped",o)}return this}restart(n,o,c){return n=this.toSeconds(n),this._state.getValueAtTime(n)==="started"&&(this._state.cancel(n),this._restart(n,o,c)),this}sync(){return this._synced||(this._synced=!0,this._syncedStart=(n,o)=>{if(QA(o,0)){const c=this._state.get(o);if(c&&c.state==="started"&&c.time!==o){const f=o-this.toSeconds(c.time);let v;c.duration&&(v=this.toSeconds(c.duration)-f),this._start(n,this.toSeconds(c.offset)+f,v)}}},this._syncedStop=n=>{const o=this.context.transport.getSecondsAtTime(Math.max(n-this.sampleTime,0));this._state.getValueAtTime(o)==="started"&&this._stop(n)},this.context.transport.on("start",this._syncedStart),this.context.transport.on("loopStart",this._syncedStart),this.context.transport.on("stop",this._syncedStop),this.context.transport.on("pause",this._syncedStop),this.context.transport.on("loopEnd",this._syncedStop)),this}unsync(){return this._synced&&(this.context.transport.off("stop",this._syncedStop),this.context.transport.off("pause",this._syncedStop),this.context.transport.off("loopEnd",this._syncedStop),this.context.transport.off("start",this._syncedStart),this.context.transport.off("loopStart",this._syncedStart)),this._synced=!1,this._scheduled.forEach((n=>this.context.transport.clear(n))),this._scheduled=[],this._state.cancel(0),this._stop(0),this}dispose(){return super.dispose(),this.onstop=Xt,this.unsync(),this._volume.dispose(),this._state.dispose(),this}}class Bi extends RA{constructor(){const n=rt(Bi.getDefaults(),arguments,["url","onload"]);super(n),this.name="ToneBufferSource",this._source=this.context.createBufferSource(),this._internalChannels=[this._source],this._sourceStarted=!1,this._sourceStopped=!1,Es(this._source,this._gainNode),this._source.onended=()=>this._stopSource(),this.playbackRate=new Lt({context:this.context,param:this._source.playbackRate,units:"positive",value:n.playbackRate}),this.loop=n.loop,this.loopStart=n.loopStart,this.loopEnd=n.loopEnd,this._buffer=new te(n.url,n.onload,n.onerror),this._internalChannels.push(this._source)}static getDefaults(){return Object.assign(RA.getDefaults(),{url:new te,loop:!1,loopEnd:0,loopStart:0,onload:Xt,onerror:Xt,playbackRate:1})}get fadeIn(){return this._fadeIn}set fadeIn(n){this._fadeIn=n}get fadeOut(){return this._fadeOut}set fadeOut(n){this._fadeOut=n}get curve(){return this._curve}set curve(n){this._curve=n}start(n,o,c,f=1){It(this.buffer.loaded,"buffer is either not set or not loaded");const v=this.toSeconds(n);this._startGain(v,f),o=this.loop?sn(o,this.loopStart):sn(o,0);let B=Math.max(this.toSeconds(o),0);if(this.loop){const _=this.toSeconds(this.loopEnd)||this.buffer.duration,S=this.toSeconds(this.loopStart),F=_-S;Bu(B,_)&&(B=(B-S)%F+S),vn(B,this.buffer.duration)&&(B=0)}if(this._source.buffer=this.buffer.get(),this._source.loopEnd=this.toSeconds(this.loopEnd)||this.buffer.duration,ka(B,this.buffer.duration)&&(this._sourceStarted=!0,this._source.start(v,B)),Kt(c)){let _=this.toSeconds(c);_=Math.max(_,0),this.stop(v+_)}return this}_stopSource(n){!this._sourceStopped&&this._sourceStarted&&(this._sourceStopped=!0,this._source.stop(this.toSeconds(n)),this._onended())}get loopStart(){return this._source.loopStart}set loopStart(n){this._source.loopStart=this.toSeconds(n)}get loopEnd(){return this._source.loopEnd}set loopEnd(n){this._source.loopEnd=this.toSeconds(n)}get buffer(){return this._buffer}set buffer(n){this._buffer.set(n)}get loop(){return this._source.loop}set loop(n){this._source.loop=n,this._sourceStarted&&this.cancelStop()}dispose(){return super.dispose(),this._source.onended=null,this._source.disconnect(),this._buffer.dispose(),this.playbackRate.dispose(),this}}class yi extends Pe{constructor(){const n=rt(yi.getDefaults(),arguments,["type"]);super(n),this.name="Noise",this._source=null,this._playbackRate=n.playbackRate,this.type=n.type,this._fadeIn=n.fadeIn,this._fadeOut=n.fadeOut}static getDefaults(){return Object.assign(Pe.getDefaults(),{fadeIn:0,fadeOut:0,playbackRate:1,type:"white"})}get type(){return this._type}set type(n){if(It(n in dm,"Noise: invalid type: "+n),this._type!==n&&(this._type=n,this.state==="started")){const o=this.now();this._stop(o),this._start(o)}}get playbackRate(){return this._playbackRate}set playbackRate(n){this._playbackRate=n,this._source&&(this._source.playbackRate.value=n)}_start(n){const o=dm[this._type];this._source=new Bi({url:o,context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,loop:!0,onended:()=>this.onstop(this),playbackRate:this._playbackRate}).connect(this.output),this._source.start(this.toSeconds(n),Math.random()*(o.duration-.001))}_stop(n){this._source&&(this._source.stop(this.toSeconds(n)),this._source=null)}get fadeIn(){return this._fadeIn}set fadeIn(n){this._fadeIn=n,this._source&&(this._source.fadeIn=this._fadeIn)}get fadeOut(){return this._fadeOut}set fadeOut(n){this._fadeOut=n,this._source&&(this._source.fadeOut=this._fadeOut)}_restart(n){this._stop(n),this._start(n)}dispose(){return super.dispose(),this._source&&this._source.disconnect(),this}}const WA=220500,Zn={brown:null,pink:null,white:null},dm={get brown(){if(!Zn.brown){const p=[];for(let n=0;n<2;n++){const o=new Float32Array(WA);p[n]=o;let c=0;for(let f=0;f<WA;f++){const v=2*Math.random()-1;o[f]=(c+.02*v)/1.02,c=o[f],o[f]*=3.5}}Zn.brown=new te().fromArray(p)}return Zn.brown},get pink(){if(!Zn.pink){const p=[];for(let n=0;n<2;n++){const o=new Float32Array(WA);let c,f,v,B,_,S,F;p[n]=o,c=f=v=B=_=S=F=0;for(let I=0;I<WA;I++){const M=2*Math.random()-1;c=.99886*c+.0555179*M,f=.99332*f+.0750759*M,v=.969*v+.153852*M,B=.8665*B+.3104856*M,_=.55*_+.5329522*M,S=-.7616*S-.016898*M,o[I]=c+f+v+B+_+S+F+.5362*M,o[I]*=.11,F=.115926*M}}Zn.pink=new te().fromArray(p)}return Zn.pink},get white(){if(!Zn.white){const p=[];for(let n=0;n<2;n++){const o=new Float32Array(WA);p[n]=o;for(let c=0;c<WA;c++)o[c]=2*Math.random()-1}Zn.white=new te().fromArray(p)}return Zn.white}};class Vr extends ht{constructor(){const n=rt(Vr.getDefaults(),arguments,["volume"]);super(n),this.name="UserMedia",this._volume=this.output=new Jn({context:this.context,volume:n.volume}),this.volume=this._volume.volume,Ut(this,"volume"),this.mute=n.mute}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,volume:0})}open(n){return fe(this,void 0,void 0,(function*(){It(Vr.supported,"UserMedia is not supported"),this.state==="started"&&this.close();const o=yield Vr.enumerateDevices();Vs(n)?this._device=o[n]:(this._device=o.find((v=>v.label===n||v.deviceId===n)),!this._device&&o.length>0&&(this._device=o[0]),It(Kt(this._device),`No matching device ${n}`));const c={audio:{echoCancellation:!1,sampleRate:this.context.sampleRate,noiseSuppression:!1,mozNoiseSuppression:!1}};this._device&&(c.audio.deviceId=this._device.deviceId);const f=yield navigator.mediaDevices.getUserMedia(c);if(!this._stream){this._stream=f;const v=this.context.createMediaStreamSource(f);Es(v,this.output),this._mediaStream=v}return this}))}close(){return this._stream&&this._mediaStream&&(this._stream.getAudioTracks().forEach((n=>{n.stop()})),this._stream=void 0,this._mediaStream.disconnect(),this._mediaStream=void 0),this._device=void 0,this}static enumerateDevices(){return fe(this,void 0,void 0,(function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter((n=>n.kind==="audioinput"))}))}get state(){return this._stream&&this._stream.active?"started":"stopped"}get deviceId(){return this._device?this._device.deviceId:void 0}get groupId(){return this._device?this._device.groupId:void 0}get label(){return this._device?this._device.label:void 0}get mute(){return this._volume.mute}set mute(n){this._volume.mute=n}dispose(){return super.dispose(),this.close(),this._volume.dispose(),this.volume.dispose(),this}static get supported(){return Kt(navigator.mediaDevices)&&Kt(navigator.mediaDevices.getUserMedia)}}function ji(p,n){return fe(this,void 0,void 0,(function*(){const o=n/p.context.sampleRate,c=new PA(1,o,p.context.sampleRate);return new p.constructor(Object.assign(p.get(),{frequency:2/o,detune:0,context:c})).toDestination().start(0),(yield c.render()).getChannelData(0)}))}class Wr extends RA{constructor(){const n=rt(Wr.getDefaults(),arguments,["frequency","type"]);super(n),this.name="ToneOscillatorNode",this._oscillator=this.context.createOscillator(),this._internalChannels=[this._oscillator],Es(this._oscillator,this._gainNode),this.type=n.type,this.frequency=new Lt({context:this.context,param:this._oscillator.frequency,units:"frequency",value:n.frequency}),this.detune=new Lt({context:this.context,param:this._oscillator.detune,units:"cents",value:n.detune}),Ut(this,["frequency","detune"])}static getDefaults(){return Object.assign(RA.getDefaults(),{detune:0,frequency:440,type:"sine"})}start(n){const o=this.toSeconds(n);return this.log("start",o),this._startGain(o),this._oscillator.start(o),this}_stopSource(n){this._oscillator.stop(n)}setPeriodicWave(n){return this._oscillator.setPeriodicWave(n),this}get type(){return this._oscillator.type}set type(n){this._oscillator.type=n}dispose(){return super.dispose(),this.state==="started"&&this.stop(),this._oscillator.disconnect(),this.frequency.dispose(),this.detune.dispose(),this}}class Se extends Pe{constructor(){const n=rt(Se.getDefaults(),arguments,["frequency","type"]);super(n),this.name="Oscillator",this._oscillator=null,this.frequency=new Dt({context:this.context,units:"frequency",value:n.frequency}),Ut(this,"frequency"),this.detune=new Dt({context:this.context,units:"cents",value:n.detune}),Ut(this,"detune"),this._partials=n.partials,this._partialCount=n.partialCount,this._type=n.type,n.partialCount&&n.type!=="custom"&&(this._type=this.baseType+n.partialCount.toString()),this.phase=n.phase}static getDefaults(){return Object.assign(Pe.getDefaults(),{detune:0,frequency:440,partialCount:0,partials:[],phase:0,type:"sine"})}_start(n){const o=this.toSeconds(n),c=new Wr({context:this.context,onended:()=>this.onstop(this)});this._oscillator=c,this._wave?this._oscillator.setPeriodicWave(this._wave):this._oscillator.type=this._type,this._oscillator.connect(this.output),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.start(o)}_stop(n){const o=this.toSeconds(n);this._oscillator&&this._oscillator.stop(o)}_restart(n){const o=this.toSeconds(n);return this.log("restart",o),this._oscillator&&this._oscillator.cancelStop(),this._state.cancel(o),this}syncFrequency(){return this.context.transport.syncSignal(this.frequency),this}unsyncFrequency(){return this.context.transport.unsyncSignal(this.frequency),this}_getCachedPeriodicWave(){if(this._type==="custom")return Se._periodicWaveCache.find((n=>{return n.phase===this._phase&&(o=n.partials,c=this._partials,o.length===c.length&&o.every(((f,v)=>c[v]===f)));var o,c}));{const n=Se._periodicWaveCache.find((o=>o.type===this._type&&o.phase===this._phase));return this._partialCount=n?n.partialCount:this._partialCount,n}}get type(){return this._type}set type(n){this._type=n;const o=["sine","square","sawtooth","triangle"].indexOf(n)!==-1;if(this._phase===0&&o)this._wave=void 0,this._partialCount=0,this._oscillator!==null&&(this._oscillator.type=n);else{const c=this._getCachedPeriodicWave();if(Kt(c)){const{partials:f,wave:v}=c;this._wave=v,this._partials=f,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave)}else{const[f,v]=this._getRealImaginary(n,this._phase),B=this.context.createPeriodicWave(f,v);this._wave=B,this._oscillator!==null&&this._oscillator.setPeriodicWave(this._wave),Se._periodicWaveCache.push({imag:v,partialCount:this._partialCount,partials:this._partials,phase:this._phase,real:f,type:this._type,wave:this._wave}),Se._periodicWaveCache.length>100&&Se._periodicWaveCache.shift()}}}get baseType(){return this._type.replace(this.partialCount.toString(),"")}set baseType(n){this.partialCount&&this._type!=="custom"&&n!=="custom"?this.type=n+this.partialCount:this.type=n}get partialCount(){return this._partialCount}set partialCount(n){cs(n,0);let o=this._type;const c=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(this._type);if(c&&(o=c[1]),this._type!=="custom")this.type=n===0?o:o+n.toString();else{const f=new Float32Array(n);this._partials.forEach(((v,B)=>f[B]=v)),this._partials=Array.from(f),this.type=this._type}}_getRealImaginary(n,o){let c=2048;const f=new Float32Array(c),v=new Float32Array(c);let B=1;if(n==="custom"){if(B=this._partials.length+1,this._partialCount=this._partials.length,c=B,this._partials.length===0)return[f,v]}else{const _=/^(sine|triangle|square|sawtooth)(\d+)$/.exec(n);_?(B=parseInt(_[2],10)+1,this._partialCount=parseInt(_[2],10),n=_[1],B=Math.max(B,2),c=B):this._partialCount=0,this._partials=[]}for(let _=1;_<c;++_){const S=2/(_*Math.PI);let F;switch(n){case"sine":F=_<=B?1:0,this._partials[_-1]=F;break;case"square":F=1&_?2*S:0,this._partials[_-1]=F;break;case"sawtooth":F=S*(1&_?1:-1),this._partials[_-1]=F;break;case"triangle":F=1&_?S*S*2*(_-1>>1&1?-1:1):0,this._partials[_-1]=F;break;case"custom":F=this._partials[_-1];break;default:throw new TypeError("Oscillator: invalid type: "+n)}F!==0?(f[_]=-F*Math.sin(o*_),v[_]=F*Math.cos(o*_)):(f[_]=0,v[_]=0)}return[f,v]}_inverseFFT(n,o,c){let f=0;const v=n.length;for(let B=0;B<v;B++)f+=n[B]*Math.cos(B*c)+o[B]*Math.sin(B*c);return f}getInitialValue(){const[n,o]=this._getRealImaginary(this._type,0);let c=0;const f=2*Math.PI;for(let v=0;v<32;v++)c=Math.max(this._inverseFFT(n,o,v/32*f),c);return Yi(-this._inverseFFT(n,o,this._phase)/c,-1,1)}get partials(){return this._partials.slice(0,this.partialCount)}set partials(n){this._partials=n,this._partialCount=this._partials.length,n.length&&(this.type="custom")}get phase(){return this._phase*(180/Math.PI)}set phase(n){this._phase=n*Math.PI/180,this.type=this._type}asArray(){return fe(this,arguments,void 0,(function*(n=1024){return ji(this,n)}))}dispose(){return super.dispose(),this._oscillator!==null&&this._oscillator.dispose(),this._wave=void 0,this.frequency.dispose(),this.detune.dispose(),this}}Se._periodicWaveCache=[];class Wa extends $s{constructor(){super(...arguments),this.name="AudioToGain",this._norm=new Bn({context:this.context,mapping:n=>(n+1)/2}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Fe extends Dt{constructor(){const n=rt(Fe.getDefaults(),arguments,["value"]);super(n),this.name="Multiply",this.override=!1,this._mult=this.input=this.output=new Tt({context:this.context,minValue:n.minValue,maxValue:n.maxValue}),this.factor=this._param=this._mult.gain,this.factor.setValueAtTime(n.value,0)}static getDefaults(){return Object.assign(Dt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._mult.dispose(),this}}class Kr extends Pe{constructor(){const n=rt(Kr.getDefaults(),arguments,["frequency","type","modulationType"]);super(n),this.name="AMOscillator",this._modulationScale=new Wa({context:this.context}),this._modulationNode=new Tt({context:this.context}),this._carrier=new Se({context:this.context,detune:n.detune,frequency:n.frequency,onstop:()=>this.onstop(this),phase:n.phase,type:n.type}),this.frequency=this._carrier.frequency,this.detune=this._carrier.detune,this._modulator=new Se({context:this.context,phase:n.phase,type:n.modulationType}),this.harmonicity=new Fe({context:this.context,units:"positive",value:n.harmonicity}),this.frequency.chain(this.harmonicity,this._modulator.frequency),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output),Ut(this,["frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Se.getDefaults(),{harmonicity:1,modulationType:"square"})}_start(n){this._modulator.start(n),this._carrier.start(n)}_stop(n){this._modulator.stop(n),this._carrier.stop(n)}_restart(n){this._modulator.restart(n),this._carrier.restart(n)}get type(){return this._carrier.type}set type(n){this._carrier.type=n}get baseType(){return this._carrier.baseType}set baseType(n){this._carrier.baseType=n}get partialCount(){return this._carrier.partialCount}set partialCount(n){this._carrier.partialCount=n}get modulationType(){return this._modulator.type}set modulationType(n){this._modulator.type=n}get phase(){return this._carrier.phase}set phase(n){this._carrier.phase=n,this._modulator.phase=n}get partials(){return this._carrier.partials}set partials(n){this._carrier.partials=n}asArray(){return fe(this,arguments,void 0,(function*(n=1024){return ji(this,n)}))}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this._modulationScale.dispose(),this}}class KA extends Pe{constructor(){const n=rt(KA.getDefaults(),arguments,["frequency","type","modulationType"]);super(n),this.name="FMOscillator",this._modulationNode=new Tt({context:this.context,gain:0}),this._carrier=new Se({context:this.context,detune:n.detune,frequency:0,onstop:()=>this.onstop(this),phase:n.phase,type:n.type}),this.detune=this._carrier.detune,this.frequency=new Dt({context:this.context,units:"frequency",value:n.frequency}),this._modulator=new Se({context:this.context,phase:n.phase,type:n.modulationType}),this.harmonicity=new Fe({context:this.context,units:"positive",value:n.harmonicity}),this.modulationIndex=new Fe({context:this.context,units:"positive",value:n.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output),this.detune.connect(this._modulator.detune),Ut(this,["modulationIndex","frequency","detune","harmonicity"])}static getDefaults(){return Object.assign(Se.getDefaults(),{harmonicity:1,modulationIndex:2,modulationType:"square"})}_start(n){this._modulator.start(n),this._carrier.start(n)}_stop(n){this._modulator.stop(n),this._carrier.stop(n)}_restart(n){return this._modulator.restart(n),this._carrier.restart(n),this}get type(){return this._carrier.type}set type(n){this._carrier.type=n}get baseType(){return this._carrier.baseType}set baseType(n){this._carrier.baseType=n}get partialCount(){return this._carrier.partialCount}set partialCount(n){this._carrier.partialCount=n}get modulationType(){return this._modulator.type}set modulationType(n){this._modulator.type=n}get phase(){return this._carrier.phase}set phase(n){this._carrier.phase=n,this._modulator.phase=n}get partials(){return this._carrier.partials}set partials(n){this._carrier.partials=n}asArray(){return fe(this,arguments,void 0,(function*(n=1024){return ji(this,n)}))}dispose(){return super.dispose(),this.frequency.dispose(),this.harmonicity.dispose(),this._carrier.dispose(),this._modulator.dispose(),this._modulationNode.dispose(),this.modulationIndex.dispose(),this}}class GA extends Pe{constructor(){const n=rt(GA.getDefaults(),arguments,["frequency","width"]);super(n),this.name="PulseOscillator",this._widthGate=new Tt({context:this.context,gain:0}),this._thresh=new Bn({context:this.context,mapping:o=>o<=0?-1:1}),this.width=new Dt({context:this.context,units:"audioRange",value:n.width}),this._triangle=new Se({context:this.context,detune:n.detune,frequency:n.frequency,onstop:()=>this.onstop(this),phase:n.phase,type:"triangle"}),this.frequency=this._triangle.frequency,this.detune=this._triangle.detune,this._triangle.chain(this._thresh,this.output),this.width.chain(this._widthGate,this._thresh),Ut(this,["width","frequency","detune"])}static getDefaults(){return Object.assign(Pe.getDefaults(),{detune:0,frequency:440,phase:0,type:"pulse",width:.2})}_start(n){n=this.toSeconds(n),this._triangle.start(n),this._widthGate.gain.setValueAtTime(1,n)}_stop(n){n=this.toSeconds(n),this._triangle.stop(n),this._widthGate.gain.cancelScheduledValues(n),this._widthGate.gain.setValueAtTime(0,n)}_restart(n){this._triangle.restart(n),this._widthGate.gain.cancelScheduledValues(n),this._widthGate.gain.setValueAtTime(1,n)}get phase(){return this._triangle.phase}set phase(n){this._triangle.phase=n}get type(){return"pulse"}get baseType(){return"pulse"}get partials(){return[]}get partialCount(){return 0}set carrierType(n){this._triangle.type=n}asArray(){return fe(this,arguments,void 0,(function*(n=1024){return ji(this,n)}))}dispose(){return super.dispose(),this._triangle.dispose(),this.width.dispose(),this._widthGate.dispose(),this._thresh.dispose(),this}}class Gr extends Pe{constructor(){const n=rt(Gr.getDefaults(),arguments,["frequency","type","spread"]);super(n),this.name="FatOscillator",this._oscillators=[],this.frequency=new Dt({context:this.context,units:"frequency",value:n.frequency}),this.detune=new Dt({context:this.context,units:"cents",value:n.detune}),this._spread=n.spread,this._type=n.type,this._phase=n.phase,this._partials=n.partials,this._partialCount=n.partialCount,this.count=n.count,Ut(this,["frequency","detune"])}static getDefaults(){return Object.assign(Se.getDefaults(),{count:3,spread:20,type:"sawtooth"})}_start(n){n=this.toSeconds(n),this._forEach((o=>o.start(n)))}_stop(n){n=this.toSeconds(n),this._forEach((o=>o.stop(n)))}_restart(n){this._forEach((o=>o.restart(n)))}_forEach(n){for(let o=0;o<this._oscillators.length;o++)n(this._oscillators[o],o)}get type(){return this._type}set type(n){this._type=n,this._forEach((o=>o.type=n))}get spread(){return this._spread}set spread(n){if(this._spread=n,this._oscillators.length>1){const o=-n/2,c=n/(this._oscillators.length-1);this._forEach(((f,v)=>f.detune.value=o+c*v))}}get count(){return this._oscillators.length}set count(n){if(cs(n,1),this._oscillators.length!==n){this._forEach((o=>o.dispose())),this._oscillators=[];for(let o=0;o<n;o++){const c=new Se({context:this.context,volume:-6-1.1*n,type:this._type,phase:this._phase+o/n*360,partialCount:this._partialCount,onstop:o===0?()=>this.onstop(this):Xt});this.type==="custom"&&(c.partials=this._partials),this.frequency.connect(c.frequency),this.detune.connect(c.detune),c.detune.overridden=!1,c.connect(this.output),this._oscillators[o]=c}this.spread=this._spread,this.state==="started"&&this._forEach((o=>o.start()))}}get phase(){return this._phase}set phase(n){this._phase=n,this._forEach(((o,c)=>o.phase=this._phase+c/this.count*360))}get baseType(){return this._oscillators[0].baseType}set baseType(n){this._forEach((o=>o.baseType=n)),this._type=this._oscillators[0].type}get partials(){return this._oscillators[0].partials}set partials(n){this._partials=n,this._partialCount=this._partials.length,n.length&&(this._type="custom",this._forEach((o=>o.partials=n)))}get partialCount(){return this._oscillators[0].partialCount}set partialCount(n){this._partialCount=n,this._forEach((o=>o.partialCount=n)),this._type=this._oscillators[0].type}asArray(){return fe(this,arguments,void 0,(function*(n=1024){return ji(this,n)}))}dispose(){return super.dispose(),this.frequency.dispose(),this.detune.dispose(),this._forEach((n=>n.dispose())),this}}class qr extends Pe{constructor(){const n=rt(qr.getDefaults(),arguments,["frequency","modulationFrequency"]);super(n),this.name="PWMOscillator",this.sourceType="pwm",this._scale=new Fe({context:this.context,value:2}),this._pulse=new GA({context:this.context,frequency:n.modulationFrequency}),this._pulse.carrierType="sine",this.modulationFrequency=this._pulse.frequency,this._modulator=new Se({context:this.context,detune:n.detune,frequency:n.frequency,onstop:()=>this.onstop(this),phase:n.phase}),this.frequency=this._modulator.frequency,this.detune=this._modulator.detune,this._modulator.chain(this._scale,this._pulse.width),this._pulse.connect(this.output),Ut(this,["modulationFrequency","frequency","detune"])}static getDefaults(){return Object.assign(Pe.getDefaults(),{detune:0,frequency:440,modulationFrequency:.4,phase:0,type:"pwm"})}_start(n){n=this.toSeconds(n),this._modulator.start(n),this._pulse.start(n)}_stop(n){n=this.toSeconds(n),this._modulator.stop(n),this._pulse.stop(n)}_restart(n){this._modulator.restart(n),this._pulse.restart(n)}get type(){return"pwm"}get baseType(){return"pwm"}get partials(){return[]}get partialCount(){return 0}get phase(){return this._modulator.phase}set phase(n){this._modulator.phase=n}asArray(){return fe(this,arguments,void 0,(function*(n=1024){return ji(this,n)}))}dispose(){return super.dispose(),this._pulse.dispose(),this._scale.dispose(),this._modulator.dispose(),this}}const fm={am:Kr,fat:Gr,fm:KA,oscillator:Se,pulse:GA,pwm:qr};class ti extends Pe{constructor(){const n=rt(ti.getDefaults(),arguments,["frequency","type"]);super(n),this.name="OmniOscillator",this.frequency=new Dt({context:this.context,units:"frequency",value:n.frequency}),this.detune=new Dt({context:this.context,units:"cents",value:n.detune}),Ut(this,["frequency","detune"]),this.set(n)}static getDefaults(){return Object.assign(Se.getDefaults(),KA.getDefaults(),Kr.getDefaults(),Gr.getDefaults(),GA.getDefaults(),qr.getDefaults())}_start(n){this._oscillator.start(n)}_stop(n){this._oscillator.stop(n)}_restart(n){return this._oscillator.restart(n),this}get type(){let n="";return["am","fm","fat"].some((o=>this._sourceType===o))&&(n=this._sourceType),n+this._oscillator.type}set type(n){n.substr(0,2)==="fm"?(this._createNewOscillator("fm"),this._oscillator=this._oscillator,this._oscillator.type=n.substr(2)):n.substr(0,2)==="am"?(this._createNewOscillator("am"),this._oscillator=this._oscillator,this._oscillator.type=n.substr(2)):n.substr(0,3)==="fat"?(this._createNewOscillator("fat"),this._oscillator=this._oscillator,this._oscillator.type=n.substr(3)):n==="pwm"?(this._createNewOscillator("pwm"),this._oscillator=this._oscillator):n==="pulse"?this._createNewOscillator("pulse"):(this._createNewOscillator("oscillator"),this._oscillator=this._oscillator,this._oscillator.type=n)}get partials(){return this._oscillator.partials}set partials(n){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partials=n)}get partialCount(){return this._oscillator.partialCount}set partialCount(n){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||(this._oscillator.partialCount=n)}set(n){return Reflect.has(n,"type")&&n.type&&(this.type=n.type),super.set(n),this}_createNewOscillator(n){if(n!==this._sourceType){this._sourceType=n;const o=fm[n],c=this.now();if(this._oscillator){const f=this._oscillator;f.stop(c),this.context.setTimeout((()=>f.dispose()),this.blockTime)}this._oscillator=new o({context:this.context}),this.frequency.connect(this._oscillator.frequency),this.detune.connect(this._oscillator.detune),this._oscillator.connect(this.output),this._oscillator.onstop=()=>this.onstop(this),this.state==="started"&&this._oscillator.start(c)}}get phase(){return this._oscillator.phase}set phase(n){this._oscillator.phase=n}get sourceType(){return this._sourceType}set sourceType(n){let o="sine";this._oscillator.type!=="pwm"&&this._oscillator.type!=="pulse"&&(o=this._oscillator.type),n==="fm"?this.type="fm"+o:n==="am"?this.type="am"+o:n==="fat"?this.type="fat"+o:n==="oscillator"?this.type=o:n==="pulse"?this.type="pulse":n==="pwm"&&(this.type="pwm")}_getOscType(n,o){return n instanceof fm[o]}get baseType(){return this._oscillator.baseType}set baseType(n){this._getOscType(this._oscillator,"pulse")||this._getOscType(this._oscillator,"pwm")||n==="pulse"||n==="pwm"||(this._oscillator.baseType=n)}get width(){return this._getOscType(this._oscillator,"pulse")?this._oscillator.width:void 0}get count(){return this._getOscType(this._oscillator,"fat")?this._oscillator.count:void 0}set count(n){this._getOscType(this._oscillator,"fat")&&Vs(n)&&(this._oscillator.count=n)}get spread(){return this._getOscType(this._oscillator,"fat")?this._oscillator.spread:void 0}set spread(n){this._getOscType(this._oscillator,"fat")&&Vs(n)&&(this._oscillator.spread=n)}get modulationType(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.modulationType:void 0}set modulationType(n){(this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am"))&&gn(n)&&(this._oscillator.modulationType=n)}get modulationIndex(){return this._getOscType(this._oscillator,"fm")?this._oscillator.modulationIndex:void 0}get harmonicity(){return this._getOscType(this._oscillator,"fm")||this._getOscType(this._oscillator,"am")?this._oscillator.harmonicity:void 0}get modulationFrequency(){return this._getOscType(this._oscillator,"pwm")?this._oscillator.modulationFrequency:void 0}asArray(){return fe(this,arguments,void 0,(function*(n=1024){return ji(this,n)}))}dispose(){return super.dispose(),this.detune.dispose(),this.frequency.dispose(),this._oscillator.dispose(),this}}class Ji extends Dt{constructor(){super(rt(Ji.getDefaults(),arguments,["value"])),this.override=!1,this.name="Add",this._sum=new Tt({context:this.context}),this.input=this._sum,this.output=this._sum,this.addend=this._param,qs(this._constantSource,this._sum)}static getDefaults(){return Object.assign(Dt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._sum.dispose(),this}}class ei extends $s{constructor(){const n=rt(ei.getDefaults(),arguments,["min","max"]);super(n),this.name="Scale",this._mult=this.input=new Fe({context:this.context,value:n.max-n.min}),this._add=this.output=new Ji({context:this.context,value:n.min}),this._min=n.min,this._max=n.max,this.input.connect(this.output)}static getDefaults(){return Object.assign($s.getDefaults(),{max:1,min:0})}get min(){return this._min}set min(n){this._min=n,this._setRange()}get max(){return this._max}set max(n){this._max=n,this._setRange()}_setRange(){this._add.value=this._min,this._mult.value=this._max-this._min}dispose(){return super.dispose(),this._add.dispose(),this._mult.dispose(),this}}class Ka extends $s{constructor(){super(rt(Ka.getDefaults(),arguments)),this.name="Zero",this._gain=new Tt({context:this.context}),this.output=this._gain,this.input=void 0,Es(this.context.getConstant(0),this._gain)}dispose(){return super.dispose(),_u(this.context.getConstant(0),this._gain),this}}class Ss extends ht{constructor(){const n=rt(Ss.getDefaults(),arguments,["frequency","min","max"]);super(n),this.name="LFO",this._stoppedValue=0,this._units="number",this.convert=!0,this._fromType=Lt.prototype._fromType,this._toType=Lt.prototype._toType,this._is=Lt.prototype._is,this._clampValue=Lt.prototype._clampValue,this._oscillator=new Se(n),this.frequency=this._oscillator.frequency,this._amplitudeGain=new Tt({context:this.context,gain:n.amplitude,units:"normalRange"}),this.amplitude=this._amplitudeGain.gain,this._stoppedSignal=new Dt({context:this.context,units:"audioRange",value:0}),this._zeros=new Ka({context:this.context}),this._a2g=new Wa({context:this.context}),this._scaler=this.output=new ei({context:this.context,max:n.max,min:n.min}),this.units=n.units,this.min=n.min,this.max=n.max,this._oscillator.chain(this._amplitudeGain,this._a2g,this._scaler),this._zeros.connect(this._a2g),this._stoppedSignal.connect(this._a2g),Ut(this,["amplitude","frequency"]),this.phase=n.phase}static getDefaults(){return Object.assign(Se.getDefaults(),{amplitude:1,frequency:"4n",max:1,min:0,type:"sine",units:"number"})}start(n){return n=this.toSeconds(n),this._stoppedSignal.setValueAtTime(0,n),this._oscillator.start(n),this}stop(n){return n=this.toSeconds(n),this._stoppedSignal.setValueAtTime(this._stoppedValue,n),this._oscillator.stop(n),this}sync(){return this._oscillator.sync(),this._oscillator.syncFrequency(),this}unsync(){return this._oscillator.unsync(),this._oscillator.unsyncFrequency(),this}_setStoppedValue(){this._stoppedValue=this._oscillator.getInitialValue(),this._stoppedSignal.value=this._stoppedValue}get min(){return this._toType(this._scaler.min)}set min(n){n=this._fromType(n),this._scaler.min=n}get max(){return this._toType(this._scaler.max)}set max(n){n=this._fromType(n),this._scaler.max=n}get type(){return this._oscillator.type}set type(n){this._oscillator.type=n,this._setStoppedValue()}get partials(){return this._oscillator.partials}set partials(n){this._oscillator.partials=n,this._setStoppedValue()}get phase(){return this._oscillator.phase}set phase(n){this._oscillator.phase=n,this._setStoppedValue()}get units(){return this._units}set units(n){const o=this.min,c=this.max;this._units=n,this.min=o,this.max=c}get state(){return this._oscillator.state}connect(n,o,c){return(n instanceof Lt||n instanceof Dt)&&(this.convert=n.convert,this.units=n.units),Or(this,n,o,c),this}dispose(){return super.dispose(),this._oscillator.dispose(),this._stoppedSignal.dispose(),this._zeros.dispose(),this._scaler.dispose(),this._a2g.dispose(),this._amplitudeGain.dispose(),this.amplitude.dispose(),this}}function pm(p,n=1/0){const o=new WeakMap;return function(c,f){Reflect.defineProperty(c,f,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(v){cs(v,p,n),o.set(this,v)}})}}function si(p,n=1/0){const o=new WeakMap;return function(c,f){Reflect.defineProperty(c,f,{configurable:!0,enumerable:!0,get:function(){return o.get(this)},set:function(v){cs(this.toSeconds(v),p,n),o.set(this,v)}})}}class qA extends Pe{constructor(){const n=rt(qA.getDefaults(),arguments,["url","onload"]);super(n),this.name="Player",this._activeSources=new Set,this._buffer=new te({onload:this._onload.bind(this,n.onload),onerror:n.onerror,reverse:n.reverse,url:n.url}),this.autostart=n.autostart,this._loop=n.loop,this._loopStart=n.loopStart,this._loopEnd=n.loopEnd,this._playbackRate=n.playbackRate,this.fadeIn=n.fadeIn,this.fadeOut=n.fadeOut}static getDefaults(){return Object.assign(Pe.getDefaults(),{autostart:!1,fadeIn:0,fadeOut:0,loop:!1,loopEnd:0,loopStart:0,onload:Xt,onerror:Xt,playbackRate:1,reverse:!1})}load(n){return fe(this,void 0,void 0,(function*(){return yield this._buffer.load(n),this._onload(),this}))}_onload(n=Xt){n(),this.autostart&&this.start()}_onSourceEnd(n){this.onstop(this),this._activeSources.delete(n),this._activeSources.size!==0||this._synced||this._state.getValueAtTime(this.now())!=="started"||(this._state.cancel(this.now()),this._state.setStateAtTime("stopped",this.now()))}start(n,o,c){return super.start(n,o,c),this}_start(n,o,c){o=this._loop?sn(o,this._loopStart):sn(o,0);const f=this.toSeconds(o),v=c;c=sn(c,Math.max(this._buffer.duration-f,0));let B=this.toSeconds(c);B/=this._playbackRate,n=this.toSeconds(n);const _=new Bi({url:this._buffer,context:this.context,fadeIn:this.fadeIn,fadeOut:this.fadeOut,loop:this._loop,loopEnd:this._loopEnd,loopStart:this._loopStart,onended:this._onSourceEnd.bind(this),playbackRate:this._playbackRate}).connect(this.output);this._loop||this._synced||(this._state.cancel(n+B),this._state.setStateAtTime("stopped",n+B,{implicitEnd:!0})),this._activeSources.add(_),this._loop&&Ps(v)?_.start(n,f):_.start(n,f,B-this.toSeconds(this.fadeOut))}_stop(n){const o=this.toSeconds(n);this._activeSources.forEach((c=>c.stop(o)))}restart(n,o,c){return super.restart(n,o,c),this}_restart(n,o,c){var f;(f=[...this._activeSources].pop())===null||f===void 0||f.stop(n),this._start(n,o,c)}seek(n,o){const c=this.toSeconds(o);if(this._state.getValueAtTime(c)==="started"){const f=this.toSeconds(n);this._stop(c),this._start(c,f)}return this}setLoopPoints(n,o){return this.loopStart=n,this.loopEnd=o,this}get loopStart(){return this._loopStart}set loopStart(n){this._loopStart=n,this.buffer.loaded&&cs(this.toSeconds(n),0,this.buffer.duration),this._activeSources.forEach((o=>{o.loopStart=n}))}get loopEnd(){return this._loopEnd}set loopEnd(n){this._loopEnd=n,this.buffer.loaded&&cs(this.toSeconds(n),0,this.buffer.duration),this._activeSources.forEach((o=>{o.loopEnd=n}))}get buffer(){return this._buffer}set buffer(n){this._buffer.set(n)}get loop(){return this._loop}set loop(n){if(this._loop!==n&&(this._loop=n,this._activeSources.forEach((o=>{o.loop=n})),n)){const o=this._state.getNextState("stopped",this.now());o&&this._state.cancel(o.time)}}get playbackRate(){return this._playbackRate}set playbackRate(n){this._playbackRate=n;const o=this.now(),c=this._state.getNextState("stopped",o);c&&c.implicitEnd&&(this._state.cancel(c.time),this._activeSources.forEach((f=>f.cancelStop()))),this._activeSources.forEach((f=>{f.playbackRate.setValueAtTime(n,o)}))}get reverse(){return this._buffer.reverse}set reverse(n){this._buffer.reverse=n}get loaded(){return this._buffer.loaded}dispose(){return super.dispose(),this._activeSources.forEach((n=>n.dispose())),this._activeSources.clear(),this._buffer.dispose(),this}}wn([si(0)],qA.prototype,"fadeIn",void 0),wn([si(0)],qA.prototype,"fadeOut",void 0);class Iu extends ht{constructor(){const n=rt(Iu.getDefaults(),arguments,["urls","onload"],"urls");super(n),this.name="Players",this.input=void 0,this._players=new Map,this._volume=this.output=new Jn({context:this.context,volume:n.volume}),this.volume=this._volume.volume,Ut(this,"volume"),this._buffers=new NA({urls:n.urls,onload:n.onload,baseUrl:n.baseUrl,onerror:n.onerror}),this.mute=n.mute,this._fadeIn=n.fadeIn,this._fadeOut=n.fadeOut}static getDefaults(){return Object.assign(Pe.getDefaults(),{baseUrl:"",fadeIn:0,fadeOut:0,mute:!1,onload:Xt,onerror:Xt,urls:{},volume:0})}get mute(){return this._volume.mute}set mute(n){this._volume.mute=n}get fadeIn(){return this._fadeIn}set fadeIn(n){this._fadeIn=n,this._players.forEach((o=>{o.fadeIn=n}))}get fadeOut(){return this._fadeOut}set fadeOut(n){this._fadeOut=n,this._players.forEach((o=>{o.fadeOut=n}))}get state(){return Array.from(this._players).some((([n,o])=>o.state==="started"))?"started":"stopped"}has(n){return this._buffers.has(n)}player(n){if(It(this.has(n),`No Player with the name ${n} exists on this object`),!this._players.has(n)){const o=new qA({context:this.context,fadeIn:this._fadeIn,fadeOut:this._fadeOut,url:this._buffers.get(n)}).connect(this.output);this._players.set(n,o)}return this._players.get(n)}get loaded(){return this._buffers.loaded}add(n,o,c){return It(!this._buffers.has(n),"A buffer with that name already exists on this object"),this._buffers.add(n,o,c),this}stopAll(n){return this._players.forEach((o=>o.stop(n))),this}dispose(){return super.dispose(),this._volume.dispose(),this.volume.dispose(),this._players.forEach((n=>n.dispose())),this._buffers.dispose(),this}}class Qu extends Pe{constructor(){const n=rt(Qu.getDefaults(),arguments,["url","onload"]);super(n),this.name="GrainPlayer",this._loopStart=0,this._loopEnd=0,this._activeSources=[],this.buffer=new te({onload:n.onload,onerror:n.onerror,reverse:n.reverse,url:n.url}),this._clock=new HA({context:this.context,callback:this._tick.bind(this),frequency:1/n.grainSize}),this._playbackRate=n.playbackRate,this._grainSize=n.grainSize,this._overlap=n.overlap,this.detune=n.detune,this.overlap=n.overlap,this.loop=n.loop,this.playbackRate=n.playbackRate,this.grainSize=n.grainSize,this.loopStart=n.loopStart,this.loopEnd=n.loopEnd,this.reverse=n.reverse,this._clock.on("stop",this._onstop.bind(this))}static getDefaults(){return Object.assign(Pe.getDefaults(),{onload:Xt,onerror:Xt,overlap:.1,grainSize:.2,playbackRate:1,detune:0,loop:!1,loopStart:0,loopEnd:0,reverse:!1})}_start(n,o,c){o=sn(o,0),o=this.toSeconds(o),n=this.toSeconds(n);const f=1/this._clock.frequency.getValueAtTime(n);this._clock.start(n,o/f),c&&this.stop(n+this.toSeconds(c))}restart(n,o,c){return super.restart(n,o,c),this}_restart(n,o,c){this._stop(n),this._start(n,o,c)}_stop(n){this._clock.stop(n)}_onstop(n){this._activeSources.forEach((o=>{o.fadeOut=0,o.stop(n)})),this.onstop(this)}_tick(n){const o=this._clock.getTicksAtTime(n),c=o*this._grainSize;if(this.log("offset",c),!this.loop&&c>this.buffer.duration)return void this.stop(n);const f=c<this._overlap?0:this._overlap,v=new Bi({context:this.context,url:this.buffer,fadeIn:f,fadeOut:this._overlap,loop:this.loop,loopStart:this._loopStart,loopEnd:this._loopEnd,playbackRate:kA(this.detune/100)}).connect(this.output);v.start(n,this._grainSize*o),v.stop(n+this._grainSize/this.playbackRate),this._activeSources.push(v),v.onended=()=>{const B=this._activeSources.indexOf(v);B!==-1&&this._activeSources.splice(B,1)}}get playbackRate(){return this._playbackRate}set playbackRate(n){cs(n,.001),this._playbackRate=n,this.grainSize=this._grainSize}get loopStart(){return this._loopStart}set loopStart(n){this.buffer.loaded&&cs(this.toSeconds(n),0,this.buffer.duration),this._loopStart=this.toSeconds(n)}get loopEnd(){return this._loopEnd}set loopEnd(n){this.buffer.loaded&&cs(this.toSeconds(n),0,this.buffer.duration),this._loopEnd=this.toSeconds(n)}get reverse(){return this.buffer.reverse}set reverse(n){this.buffer.reverse=n}get grainSize(){return this._grainSize}set grainSize(n){this._grainSize=this.toSeconds(n),this._clock.frequency.setValueAtTime(this._playbackRate/this._grainSize,this.now())}get overlap(){return this._overlap}set overlap(n){const o=this.toSeconds(n);cs(o,0),this._overlap=o}get loaded(){return this.buffer.loaded}dispose(){return super.dispose(),this.buffer.dispose(),this._clock.dispose(),this._activeSources.forEach((n=>n.dispose())),this}}class mm extends $s{constructor(){super(...arguments),this.name="Abs",this._abs=new Bn({context:this.context,mapping:n=>Math.abs(n)<.001?0:Math.abs(n)}),this.input=this._abs,this.output=this._abs}dispose(){return super.dispose(),this._abs.dispose(),this}}class gm extends $s{constructor(){super(...arguments),this.name="GainToAudio",this._norm=new Bn({context:this.context,mapping:n=>2*Math.abs(n)-1}),this.input=this._norm,this.output=this._norm}dispose(){return super.dispose(),this._norm.dispose(),this}}class Mu extends $s{constructor(){super(...arguments),this.name="Negate",this._multiply=new Fe({context:this.context,value:-1}),this.input=this._multiply,this.output=this._multiply}dispose(){return super.dispose(),this._multiply.dispose(),this}}class Zi extends Dt{constructor(){super(rt(Zi.getDefaults(),arguments,["value"])),this.override=!1,this.name="Subtract",this._sum=new Tt({context:this.context}),this.input=this._sum,this.output=this._sum,this._neg=new Mu({context:this.context}),this.subtrahend=this._param,qs(this._constantSource,this._neg,this._sum)}static getDefaults(){return Object.assign(Dt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._neg.dispose(),this._sum.dispose(),this}}class Ga extends $s{constructor(){super(rt(Ga.getDefaults(),arguments)),this.name="GreaterThanZero",this._thresh=this.output=new Bn({context:this.context,length:127,mapping:n=>n<=0?0:1}),this._scale=this.input=new Fe({context:this.context,value:1e4}),this._scale.connect(this._thresh)}dispose(){return super.dispose(),this._scale.dispose(),this._thresh.dispose(),this}}class qa extends Dt{constructor(){const n=rt(qa.getDefaults(),arguments,["value"]);super(n),this.name="GreaterThan",this.override=!1,this._subtract=this.input=new Zi({context:this.context,value:n.value}),this._gtz=this.output=new Ga({context:this.context}),this.comparator=this._param=this._subtract.subtrahend,Ut(this,"comparator"),this._subtract.connect(this._gtz)}static getDefaults(){return Object.assign(Dt.getDefaults(),{value:0})}dispose(){return super.dispose(),this._gtz.dispose(),this._subtract.dispose(),this.comparator.dispose(),this}}class za extends ei{constructor(){const n=rt(za.getDefaults(),arguments,["min","max","exponent"]);super(n),this.name="ScaleExp",this.input=this._exp=new VA({context:this.context,value:n.exponent}),this._exp.connect(this._mult)}static getDefaults(){return Object.assign(ei.getDefaults(),{exponent:1})}get exponent(){return this._exp.value}set exponent(n){this._exp.value=n}dispose(){return super.dispose(),this._exp.dispose(),this}}class XC extends Dt{constructor(){const n=rt(Dt.getDefaults(),arguments,["value","units"]);super(n),this.name="SyncedSignal",this.override=!1,this._lastVal=n.value,this._synced=this.context.transport.scheduleRepeat(this._onTick.bind(this),"1i"),this._syncedCallback=this._anchorValue.bind(this),this.context.transport.on("start",this._syncedCallback),this.context.transport.on("pause",this._syncedCallback),this.context.transport.on("stop",this._syncedCallback),this._constantSource.disconnect(),this._constantSource.stop(0),this._constantSource=this.output=new Oa({context:this.context,offset:n.value,units:n.units}).start(0),this.setValueAtTime(n.value,0)}_onTick(n){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal!==o&&(this._lastVal=o,this._constantSource.offset.setValueAtTime(o,n))}_anchorValue(n){const o=super.getValueAtTime(this.context.transport.seconds);this._lastVal=o,this._constantSource.offset.cancelAndHoldAtTime(n),this._constantSource.offset.setValueAtTime(o,n)}getValueAtTime(n){const o=new qe(this.context,n).toSeconds();return super.getValueAtTime(o)}setValueAtTime(n,o){const c=new qe(this.context,o).toSeconds();return super.setValueAtTime(n,c),this}linearRampToValueAtTime(n,o){const c=new qe(this.context,o).toSeconds();return super.linearRampToValueAtTime(n,c),this}exponentialRampToValueAtTime(n,o){const c=new qe(this.context,o).toSeconds();return super.exponentialRampToValueAtTime(n,c),this}setTargetAtTime(n,o,c){const f=new qe(this.context,o).toSeconds();return super.setTargetAtTime(n,f,c),this}cancelScheduledValues(n){const o=new qe(this.context,n).toSeconds();return super.cancelScheduledValues(o),this}setValueCurveAtTime(n,o,c,f){const v=new qe(this.context,o).toSeconds();return c=this.toSeconds(c),super.setValueCurveAtTime(n,v,c,f),this}cancelAndHoldAtTime(n){const o=new qe(this.context,n).toSeconds();return super.cancelAndHoldAtTime(o),this}setRampPoint(n){const o=new qe(this.context,n).toSeconds();return super.setRampPoint(o),this}exponentialRampTo(n,o,c){const f=new qe(this.context,c).toSeconds();return super.exponentialRampTo(n,o,f),this}linearRampTo(n,o,c){const f=new qe(this.context,c).toSeconds();return super.linearRampTo(n,o,f),this}targetRampTo(n,o,c){const f=new qe(this.context,c).toSeconds();return super.targetRampTo(n,o,f),this}dispose(){return super.dispose(),this.context.transport.clear(this._synced),this.context.transport.off("start",this._syncedCallback),this.context.transport.off("pause",this._syncedCallback),this.context.transport.off("stop",this._syncedCallback),this._constantSource.dispose(),this}}class hs extends ht{constructor(){const n=rt(hs.getDefaults(),arguments,["attack","decay","sustain","release"]);super(n),this.name="Envelope",this._sig=new Dt({context:this.context,value:0}),this.output=this._sig,this.input=void 0,this.attack=n.attack,this.decay=n.decay,this.sustain=n.sustain,this.release=n.release,this.attackCurve=n.attackCurve,this.releaseCurve=n.releaseCurve,this.decayCurve=n.decayCurve}static getDefaults(){return Object.assign(ht.getDefaults(),{attack:.01,attackCurve:"linear",decay:.1,decayCurve:"exponential",release:1,releaseCurve:"exponential",sustain:.5})}get value(){return this.getValueAtTime(this.now())}_getCurve(n,o){if(gn(n))return n;{let c;for(c in $a)if($a[c][o]===n)return c;return n}}_setCurve(n,o,c){if(gn(c)&&Reflect.has($a,c)){const f=$a[c];Yn(f)?n!=="_decayCurve"&&(this[n]=f[o]):this[n]=f}else{if(!ls(c)||n==="_decayCurve")throw new Error("Envelope: invalid curve: "+c);this[n]=c}}get attackCurve(){return this._getCurve(this._attackCurve,"In")}set attackCurve(n){this._setCurve("_attackCurve","In",n)}get releaseCurve(){return this._getCurve(this._releaseCurve,"Out")}set releaseCurve(n){this._setCurve("_releaseCurve","Out",n)}get decayCurve(){return this._getCurve(this._decayCurve,"Out")}set decayCurve(n){this._setCurve("_decayCurve","Out",n)}triggerAttack(n,o=1){this.log("triggerAttack",n,o),n=this.toSeconds(n);let c=this.toSeconds(this.attack);const f=this.toSeconds(this.decay),v=this.getValueAtTime(n);if(v>0&&(c=(1-v)/(1/c)),c<this.sampleTime)this._sig.cancelScheduledValues(n),this._sig.setValueAtTime(o,n);else if(this._attackCurve==="linear")this._sig.linearRampTo(o,c,n);else if(this._attackCurve==="exponential")this._sig.targetRampTo(o,c,n);else{this._sig.cancelAndHoldAtTime(n);let B=this._attackCurve;for(let _=1;_<B.length;_++)if(B[_-1]<=v&&v<=B[_]){B=this._attackCurve.slice(_),B[0]=v;break}this._sig.setValueCurveAtTime(B,n,c,o)}if(f&&this.sustain<1){const B=o*this.sustain,_=n+c;this.log("decay",_),this._decayCurve==="linear"?this._sig.linearRampToValueAtTime(B,f+_):this._sig.exponentialApproachValueAtTime(B,_,f)}return this}triggerRelease(n){this.log("triggerRelease",n),n=this.toSeconds(n);const o=this.getValueAtTime(n);if(o>0){const c=this.toSeconds(this.release);c<this.sampleTime?this._sig.setValueAtTime(0,n):this._releaseCurve==="linear"?this._sig.linearRampTo(0,c,n):this._releaseCurve==="exponential"?this._sig.targetRampTo(0,c,n):(It(ls(this._releaseCurve),"releaseCurve must be either 'linear', 'exponential' or an array"),this._sig.cancelAndHoldAtTime(n),this._sig.setValueCurveAtTime(this._releaseCurve,n,c,o))}return this}getValueAtTime(n){return this._sig.getValueAtTime(n)}triggerAttackRelease(n,o,c=1){return o=this.toSeconds(o),this.triggerAttack(o,c),this.triggerRelease(o+this.toSeconds(n)),this}cancel(n){return this._sig.cancelScheduledValues(this.toSeconds(n)),this}connect(n,o=0,c=0){return Or(this,n,o,c),this}asArray(){return fe(this,arguments,void 0,(function*(n=1024){const o=n/this.context.sampleRate,c=new PA(1,o,this.context.sampleRate),f=this.toSeconds(this.attack)+this.toSeconds(this.decay),v=f+this.toSeconds(this.release),B=.1*v,_=v+B,S=new this.constructor(Object.assign(this.get(),{attack:o*this.toSeconds(this.attack)/_,decay:o*this.toSeconds(this.decay)/_,release:o*this.toSeconds(this.release)/_,context:c}));return S._sig.toDestination(),S.triggerAttackRelease(o*(f+B)/_,0),(yield c.render()).getChannelData(0)}))}dispose(){return super.dispose(),this._sig.dispose(),this}}wn([si(0)],hs.prototype,"attack",void 0),wn([si(0)],hs.prototype,"decay",void 0),wn([pm(0,1)],hs.prototype,"sustain",void 0),wn([si(0)],hs.prototype,"release",void 0);const $a=(()=>{let n,o;const c=[];for(n=0;n<128;n++)c[n]=Math.sin(n/127*(Math.PI/2));const f=[];for(n=0;n<127;n++){o=n/127;const I=Math.sin(o*(2*Math.PI)*6.4-Math.PI/2)+1;f[n]=I/10+.83*o}f[127]=1;const v=[];for(n=0;n<128;n++)v[n]=Math.ceil(n/127*5)/5;const B=[];for(n=0;n<128;n++)o=n/127,B[n]=.5*(1-Math.cos(Math.PI*o));const _=[];for(n=0;n<128;n++){o=n/127;const I=4*Math.pow(o,3)+.2,M=Math.cos(I*Math.PI*2*o);_[n]=Math.abs(M*(1-o))}function S(I){const M=new Array(I.length);for(let k=0;k<I.length;k++)M[k]=1-I[k];return M}return{bounce:{In:S(_),Out:_},cosine:{In:c,Out:(F=c,F.slice(0).reverse())},exponential:"exponential",linear:"linear",ripple:{In:f,Out:S(f)},sine:{In:B,Out:S(B)},step:{In:v,Out:S(v)}};var F})();class nn extends ht{constructor(){const n=rt(nn.getDefaults(),arguments);super(n),this._scheduledEvents=[],this._synced=!1,this._original_triggerAttack=this.triggerAttack,this._original_triggerRelease=this.triggerRelease,this._syncedRelease=o=>this._original_triggerRelease(o),this._volume=this.output=new Jn({context:this.context,volume:n.volume}),this.volume=this._volume.volume,Ut(this,"volume")}static getDefaults(){return Object.assign(ht.getDefaults(),{volume:0})}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",0),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}_syncState(){let n=!1;return this._synced||(this._synced=!0,n=!0),n}_syncMethod(n,o){const c=this["_original_"+n]=this[n];this[n]=(...f)=>{const v=f[o],B=this.context.transport.schedule((_=>{f[o]=_,c.apply(this,f)}),v);this._scheduledEvents.push(B)}}unsync(){return this._scheduledEvents.forEach((n=>this.context.transport.clear(n))),this._scheduledEvents=[],this._synced&&(this._synced=!1,this.triggerAttack=this._original_triggerAttack,this.triggerRelease=this._original_triggerRelease,this.context.transport.off("stop",this._syncedRelease),this.context.transport.off("pause",this._syncedRelease),this.context.transport.off("loopEnd",this._syncedRelease)),this}triggerAttackRelease(n,o,c,f){const v=this.toSeconds(c),B=this.toSeconds(o);return this.triggerAttack(n,v,f),this.triggerRelease(v+B),this}dispose(){return super.dispose(),this._volume.dispose(),this.unsync(),this._scheduledEvents=[],this}}class ds extends nn{constructor(){const n=rt(ds.getDefaults(),arguments);super(n),this.portamento=n.portamento,this.onsilence=n.onsilence}static getDefaults(){return Object.assign(nn.getDefaults(),{detune:0,onsilence:Xt,portamento:0})}triggerAttack(n,o,c=1){this.log("triggerAttack",n,o,c);const f=this.toSeconds(o);return this._triggerEnvelopeAttack(f,c),this.setNote(n,f),this}triggerRelease(n){this.log("triggerRelease",n);const o=this.toSeconds(n);return this._triggerEnvelopeRelease(o),this}setNote(n,o){const c=this.toSeconds(o),f=n instanceof xs?n.toFrequency():n;if(this.portamento>0&&this.getLevelAtTime(c)>.05){const v=this.toSeconds(this.portamento);this.frequency.exponentialRampTo(f,v,c)}else this.frequency.setValueAtTime(f,c);return this}}wn([si(0)],ds.prototype,"portamento",void 0);class zA extends hs{constructor(){super(rt(zA.getDefaults(),arguments,["attack","decay","sustain","release"])),this.name="AmplitudeEnvelope",this._gainNode=new Tt({context:this.context,gain:0}),this.output=this._gainNode,this.input=this._gainNode,this._sig.connect(this._gainNode.gain),this.output=this._gainNode,this.input=this._gainNode}dispose(){return super.dispose(),this._gainNode.dispose(),this}}class Ci extends ds{constructor(){const n=rt(Ci.getDefaults(),arguments);super(n),this.name="Synth",this.oscillator=new ti(Object.assign({context:this.context,detune:n.detune,onstop:()=>this.onsilence(this)},n.oscillator)),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.envelope=new zA(Object.assign({context:this.context},n.envelope)),this.oscillator.chain(this.envelope,this.output),Ut(this,["oscillator","frequency","detune","envelope"])}static getDefaults(){return Object.assign(ds.getDefaults(),{envelope:Object.assign(us(hs.getDefaults(),Object.keys(ht.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.3}),oscillator:Object.assign(us(ti.getDefaults(),[...Object.keys(Pe.getDefaults()),"frequency","detune"]),{type:"triangle"})})}_triggerEnvelopeAttack(n,o){if(this.envelope.triggerAttack(n,o),this.oscillator.start(n),this.envelope.sustain===0){const c=this.toSeconds(this.envelope.attack),f=this.toSeconds(this.envelope.decay);this.oscillator.stop(n+c+f)}}_triggerEnvelopeRelease(n){this.envelope.triggerRelease(n),this.oscillator.stop(n+this.toSeconds(this.envelope.release))}getLevelAtTime(n){return n=this.toSeconds(n),this.envelope.getValueAtTime(n)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this}}class zr extends ds{constructor(){const n=rt(zr.getDefaults(),arguments);super(n),this.name="ModulationSynth",this._carrier=new Ci({context:this.context,oscillator:n.oscillator,envelope:n.envelope,onsilence:()=>this.onsilence(this),volume:-10}),this._modulator=new Ci({context:this.context,oscillator:n.modulation,envelope:n.modulationEnvelope,volume:-10}),this.oscillator=this._carrier.oscillator,this.envelope=this._carrier.envelope,this.modulation=this._modulator.oscillator,this.modulationEnvelope=this._modulator.envelope,this.frequency=new Dt({context:this.context,units:"frequency"}),this.detune=new Dt({context:this.context,value:n.detune,units:"cents"}),this.harmonicity=new Fe({context:this.context,value:n.harmonicity,minValue:0}),this._modulationNode=new Tt({context:this.context,gain:0}),Ut(this,["frequency","harmonicity","oscillator","envelope","modulation","modulationEnvelope","detune"])}static getDefaults(){return Object.assign(ds.getDefaults(),{harmonicity:3,oscillator:Object.assign(us(ti.getDefaults(),[...Object.keys(Pe.getDefaults()),"frequency","detune"]),{type:"sine"}),envelope:Object.assign(us(hs.getDefaults(),Object.keys(ht.getDefaults())),{attack:.01,decay:.01,sustain:1,release:.5}),modulation:Object.assign(us(ti.getDefaults(),[...Object.keys(Pe.getDefaults()),"frequency","detune"]),{type:"square"}),modulationEnvelope:Object.assign(us(hs.getDefaults(),Object.keys(ht.getDefaults())),{attack:.5,decay:0,sustain:1,release:.5})})}_triggerEnvelopeAttack(n,o){this._carrier._triggerEnvelopeAttack(n,o),this._modulator._triggerEnvelopeAttack(n,o)}_triggerEnvelopeRelease(n){return this._carrier._triggerEnvelopeRelease(n),this._modulator._triggerEnvelopeRelease(n),this}getLevelAtTime(n){return n=this.toSeconds(n),this.envelope.getValueAtTime(n)}dispose(){return super.dispose(),this._carrier.dispose(),this._modulator.dispose(),this.frequency.dispose(),this.detune.dispose(),this.harmonicity.dispose(),this._modulationNode.dispose(),this}}class Uu extends zr{constructor(){super(rt(Uu.getDefaults(),arguments)),this.name="AMSynth",this._modulationScale=new Wa({context:this.context}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.chain(this._modulationScale,this._modulationNode.gain),this._carrier.chain(this._modulationNode,this.output)}dispose(){return super.dispose(),this._modulationScale.dispose(),this}}class $r extends ht{constructor(){const n=rt($r.getDefaults(),arguments,["frequency","type"]);super(n),this.name="BiquadFilter",this._filter=this.context.createBiquadFilter(),this.input=this.output=this._filter,this.Q=new Lt({context:this.context,units:"number",value:n.Q,param:this._filter.Q}),this.frequency=new Lt({context:this.context,units:"frequency",value:n.frequency,param:this._filter.frequency}),this.detune=new Lt({context:this.context,units:"cents",value:n.detune,param:this._filter.detune}),this.gain=new Lt({context:this.context,units:"decibels",convert:!1,value:n.gain,param:this._filter.gain}),this.type=n.type}static getDefaults(){return Object.assign(ht.getDefaults(),{Q:1,type:"lowpass",frequency:350,detune:0,gain:0})}get type(){return this._filter.type}set type(n){It(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(n)!==-1,`Invalid filter type: ${n}`),this._filter.type=n}getFrequencyResponse(n=128){const o=new Float32Array(n);for(let B=0;B<n;B++){const _=19980*Math.pow(B/n,2)+20;o[B]=_}const c=new Float32Array(n),f=new Float32Array(n),v=this.context.createBiquadFilter();return v.type=this.type,v.Q.value=this.Q.value,v.frequency.value=this.frequency.value,v.gain.value=this.gain.value,v.getFrequencyResponse(o,c,f),c}dispose(){return super.dispose(),this._filter.disconnect(),this.Q.dispose(),this.frequency.dispose(),this.gain.dispose(),this.detune.dispose(),this}}class Xs extends ht{constructor(){const n=rt(Xs.getDefaults(),arguments,["frequency","type","rolloff"]);super(n),this.name="Filter",this.input=new Tt({context:this.context}),this.output=new Tt({context:this.context}),this._filters=[],this._filters=[],this.Q=new Dt({context:this.context,units:"positive",value:n.Q}),this.frequency=new Dt({context:this.context,units:"frequency",value:n.frequency}),this.detune=new Dt({context:this.context,units:"cents",value:n.detune}),this.gain=new Dt({context:this.context,units:"decibels",convert:!1,value:n.gain}),this._type=n.type,this.rolloff=n.rolloff,Ut(this,["detune","frequency","gain","Q"])}static getDefaults(){return Object.assign(ht.getDefaults(),{Q:1,detune:0,frequency:350,gain:0,rolloff:-12,type:"lowpass"})}get type(){return this._type}set type(n){It(["lowpass","highpass","bandpass","lowshelf","highshelf","notch","allpass","peaking"].indexOf(n)!==-1,`Invalid filter type: ${n}`),this._type=n,this._filters.forEach((o=>o.type=n))}get rolloff(){return this._rolloff}set rolloff(n){const o=Vs(n)?n:parseInt(n,10),c=[-12,-24,-48,-96];let f=c.indexOf(o);It(f!==-1,`rolloff can only be ${c.join(", ")}`),f+=1,this._rolloff=o,this.input.disconnect(),this._filters.forEach((v=>v.disconnect())),this._filters=new Array(f);for(let v=0;v<f;v++){const B=new $r({context:this.context});B.type=this._type,this.frequency.connect(B.frequency),this.detune.connect(B.detune),this.Q.connect(B.Q),this.gain.connect(B.gain),this._filters[v]=B}this._internalChannels=this._filters,qs(this.input,...this._internalChannels,this.output)}getFrequencyResponse(n=128){const o=new $r({frequency:this.frequency.value,gain:this.gain.value,Q:this.Q.value,type:this._type,detune:this.detune.value}),c=new Float32Array(n).map((()=>1));return this._filters.forEach((()=>{o.getFrequencyResponse(n).forEach(((f,v)=>c[v]*=f))})),o.dispose(),c}dispose(){return super.dispose(),this._filters.forEach((n=>{n.dispose()})),Rr(this,["detune","frequency","gain","Q"]),this.frequency.dispose(),this.Q.dispose(),this.detune.dispose(),this.gain.dispose(),this}}class Xr extends hs{constructor(){const n=rt(Xr.getDefaults(),arguments,["attack","decay","sustain","release"]);super(n),this.name="FrequencyEnvelope",this._octaves=n.octaves,this._baseFrequency=this.toFrequency(n.baseFrequency),this._exponent=this.input=new VA({context:this.context,value:n.exponent}),this._scale=this.output=new ei({context:this.context,min:this._baseFrequency,max:this._baseFrequency*Math.pow(2,this._octaves)}),this._sig.chain(this._exponent,this._scale)}static getDefaults(){return Object.assign(hs.getDefaults(),{baseFrequency:200,exponent:1,octaves:4})}get baseFrequency(){return this._baseFrequency}set baseFrequency(n){const o=this.toFrequency(n);cs(o,0),this._baseFrequency=o,this._scale.min=this._baseFrequency,this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(n){this._octaves=n,this._scale.max=this._baseFrequency*Math.pow(2,n)}get exponent(){return this._exponent.value}set exponent(n){this._exponent.value=n}dispose(){return super.dispose(),this._exponent.dispose(),this._scale.dispose(),this}}class tA extends ds{constructor(){const n=rt(tA.getDefaults(),arguments);super(n),this.name="MonoSynth",this.oscillator=new ti(Object.assign(n.oscillator,{context:this.context,detune:n.detune,onstop:()=>this.onsilence(this)})),this.frequency=this.oscillator.frequency,this.detune=this.oscillator.detune,this.filter=new Xs(Object.assign(n.filter,{context:this.context})),this.filterEnvelope=new Xr(Object.assign(n.filterEnvelope,{context:this.context})),this.envelope=new zA(Object.assign(n.envelope,{context:this.context})),this.oscillator.chain(this.filter,this.envelope,this.output),this.filterEnvelope.connect(this.filter.frequency),Ut(this,["oscillator","frequency","detune","filter","filterEnvelope","envelope"])}static getDefaults(){return Object.assign(ds.getDefaults(),{envelope:Object.assign(us(hs.getDefaults(),Object.keys(ht.getDefaults())),{attack:.005,decay:.1,release:1,sustain:.9}),filter:Object.assign(us(Xs.getDefaults(),Object.keys(ht.getDefaults())),{Q:1,rolloff:-12,type:"lowpass"}),filterEnvelope:Object.assign(us(Xr.getDefaults(),Object.keys(ht.getDefaults())),{attack:.6,baseFrequency:200,decay:.2,exponent:2,octaves:3,release:2,sustain:.5}),oscillator:Object.assign(us(ti.getDefaults(),Object.keys(Pe.getDefaults())),{type:"sawtooth"})})}_triggerEnvelopeAttack(n,o=1){if(this.envelope.triggerAttack(n,o),this.filterEnvelope.triggerAttack(n),this.oscillator.start(n),this.envelope.sustain===0){const c=this.toSeconds(this.envelope.attack),f=this.toSeconds(this.envelope.decay);this.oscillator.stop(n+c+f)}}_triggerEnvelopeRelease(n){this.envelope.triggerRelease(n),this.filterEnvelope.triggerRelease(n),this.oscillator.stop(n+this.toSeconds(this.envelope.release))}getLevelAtTime(n){return n=this.toSeconds(n),this.envelope.getValueAtTime(n)}dispose(){return super.dispose(),this.oscillator.dispose(),this.envelope.dispose(),this.filterEnvelope.dispose(),this.filter.dispose(),this}}class Pu extends ds{constructor(){const n=rt(Pu.getDefaults(),arguments);super(n),this.name="DuoSynth",this.voice0=new tA(Object.assign(n.voice0,{context:this.context,onsilence:()=>this.onsilence(this)})),this.voice1=new tA(Object.assign(n.voice1,{context:this.context})),this.harmonicity=new Fe({context:this.context,units:"positive",value:n.harmonicity}),this._vibrato=new Ss({frequency:n.vibratoRate,context:this.context,min:-50,max:50}),this._vibrato.start(),this.vibratoRate=this._vibrato.frequency,this._vibratoGain=new Tt({context:this.context,units:"normalRange",gain:n.vibratoAmount}),this.vibratoAmount=this._vibratoGain.gain,this.frequency=new Dt({context:this.context,units:"frequency",value:440}),this.detune=new Dt({context:this.context,units:"cents",value:n.detune}),this.frequency.connect(this.voice0.frequency),this.frequency.chain(this.harmonicity,this.voice1.frequency),this._vibrato.connect(this._vibratoGain),this._vibratoGain.fan(this.voice0.detune,this.voice1.detune),this.detune.fan(this.voice0.detune,this.voice1.detune),this.voice0.connect(this.output),this.voice1.connect(this.output),Ut(this,["voice0","voice1","frequency","vibratoAmount","vibratoRate"])}getLevelAtTime(n){return n=this.toSeconds(n),this.voice0.envelope.getValueAtTime(n)+this.voice1.envelope.getValueAtTime(n)}static getDefaults(){return en(ds.getDefaults(),{vibratoAmount:.5,vibratoRate:5,harmonicity:1.5,voice0:en(us(tA.getDefaults(),Object.keys(ds.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}}),voice1:en(us(tA.getDefaults(),Object.keys(ds.getDefaults())),{filterEnvelope:{attack:.01,decay:0,sustain:1,release:.5},envelope:{attack:.01,decay:0,sustain:1,release:.5}})})}_triggerEnvelopeAttack(n,o){this.voice0._triggerEnvelopeAttack(n,o),this.voice1._triggerEnvelopeAttack(n,o)}_triggerEnvelopeRelease(n){return this.voice0._triggerEnvelopeRelease(n),this.voice1._triggerEnvelopeRelease(n),this}dispose(){return super.dispose(),this.voice0.dispose(),this.voice1.dispose(),this.frequency.dispose(),this.detune.dispose(),this._vibrato.dispose(),this.vibratoRate.dispose(),this._vibratoGain.dispose(),this.harmonicity.dispose(),this}}class Du extends zr{constructor(){const n=rt(Du.getDefaults(),arguments);super(n),this.name="FMSynth",this.modulationIndex=new Fe({context:this.context,value:n.modulationIndex}),this.frequency.connect(this._carrier.frequency),this.frequency.chain(this.harmonicity,this._modulator.frequency),this.frequency.chain(this.modulationIndex,this._modulationNode),this.detune.fan(this._carrier.detune,this._modulator.detune),this._modulator.connect(this._modulationNode.gain),this._modulationNode.connect(this._carrier.frequency),this._carrier.connect(this.output)}static getDefaults(){return Object.assign(zr.getDefaults(),{modulationIndex:10})}dispose(){return super.dispose(),this.modulationIndex.dispose(),this}}const wm=[1,1.483,1.932,2.546,2.63,3.897];class ku extends ds{constructor(){const n=rt(ku.getDefaults(),arguments);super(n),this.name="MetalSynth",this._oscillators=[],this._freqMultipliers=[],this.detune=new Dt({context:this.context,units:"cents",value:n.detune}),this.frequency=new Dt({context:this.context,units:"frequency"}),this._amplitude=new Tt({context:this.context,gain:0}).connect(this.output),this._highpass=new Xs({Q:0,context:this.context,type:"highpass"}).connect(this._amplitude);for(let o=0;o<wm.length;o++){const c=new KA({context:this.context,harmonicity:n.harmonicity,modulationIndex:n.modulationIndex,modulationType:"square",onstop:o===0?()=>this.onsilence(this):Xt,type:"square"});c.connect(this._highpass),this._oscillators[o]=c;const f=new Fe({context:this.context,value:wm[o]});this._freqMultipliers[o]=f,this.frequency.chain(f,c.frequency),this.detune.connect(c.detune)}this._filterFreqScaler=new ei({context:this.context,max:7e3,min:this.toFrequency(n.resonance)}),this.envelope=new hs({attack:n.envelope.attack,attackCurve:"linear",context:this.context,decay:n.envelope.decay,release:n.envelope.release,sustain:0}),this.envelope.chain(this._filterFreqScaler,this._highpass.frequency),this.envelope.connect(this._amplitude.gain),this._octaves=n.octaves,this.octaves=n.octaves}static getDefaults(){return en(ds.getDefaults(),{envelope:Object.assign(us(hs.getDefaults(),Object.keys(ht.getDefaults())),{attack:.001,decay:1.4,release:.2}),harmonicity:5.1,modulationIndex:32,octaves:1.5,resonance:4e3})}_triggerEnvelopeAttack(n,o=1){return this.envelope.triggerAttack(n,o),this._oscillators.forEach((c=>c.start(n))),this.envelope.sustain===0&&this._oscillators.forEach((c=>{c.stop(n+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay))})),this}_triggerEnvelopeRelease(n){return this.envelope.triggerRelease(n),this._oscillators.forEach((o=>o.stop(n+this.toSeconds(this.envelope.release)))),this}getLevelAtTime(n){return n=this.toSeconds(n),this.envelope.getValueAtTime(n)}get modulationIndex(){return this._oscillators[0].modulationIndex.value}set modulationIndex(n){this._oscillators.forEach((o=>o.modulationIndex.value=n))}get harmonicity(){return this._oscillators[0].harmonicity.value}set harmonicity(n){this._oscillators.forEach((o=>o.harmonicity.value=n))}get resonance(){return this._filterFreqScaler.min}set resonance(n){this._filterFreqScaler.min=this.toFrequency(n),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(n){this._octaves=n,this._filterFreqScaler.max=this._filterFreqScaler.min*Math.pow(2,n)}dispose(){return super.dispose(),this._oscillators.forEach((n=>n.dispose())),this._freqMultipliers.forEach((n=>n.dispose())),this.frequency.dispose(),this.detune.dispose(),this._filterFreqScaler.dispose(),this._amplitude.dispose(),this.envelope.dispose(),this._highpass.dispose(),this}}class Yr extends Ci{constructor(){const n=rt(Yr.getDefaults(),arguments);super(n),this.name="MembraneSynth",this.portamento=0,this.pitchDecay=n.pitchDecay,this.octaves=n.octaves,Ut(this,["oscillator","envelope"])}static getDefaults(){return en(ds.getDefaults(),Ci.getDefaults(),{envelope:{attack:.001,attackCurve:"exponential",decay:.4,release:1.4,sustain:.01},octaves:10,oscillator:{type:"sine"},pitchDecay:.05})}setNote(n,o){const c=this.toSeconds(o),f=this.toFrequency(n instanceof xs?n.toFrequency():n),v=f*this.octaves;return this.oscillator.frequency.setValueAtTime(v,c),this.oscillator.frequency.exponentialRampToValueAtTime(f,c+this.toSeconds(this.pitchDecay)),this}dispose(){return super.dispose(),this}}wn([pm(0)],Yr.prototype,"octaves",void 0),wn([si(0)],Yr.prototype,"pitchDecay",void 0);class Lu extends nn{constructor(){const n=rt(Lu.getDefaults(),arguments);super(n),this.name="NoiseSynth",this.noise=new yi(Object.assign({context:this.context},n.noise)),this.envelope=new zA(Object.assign({context:this.context},n.envelope)),this.noise.chain(this.envelope,this.output)}static getDefaults(){return Object.assign(nn.getDefaults(),{envelope:Object.assign(us(hs.getDefaults(),Object.keys(ht.getDefaults())),{decay:.1,sustain:0}),noise:Object.assign(us(yi.getDefaults(),Object.keys(Pe.getDefaults())),{type:"white"})})}triggerAttack(n,o=1){return n=this.toSeconds(n),this.envelope.triggerAttack(n,o),this.noise.start(n),this.envelope.sustain===0&&this.noise.stop(n+this.toSeconds(this.envelope.attack)+this.toSeconds(this.envelope.decay)),this}triggerRelease(n){return n=this.toSeconds(n),this.envelope.triggerRelease(n),this.noise.stop(n+this.toSeconds(this.envelope.release)),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",0),this._syncMethod("triggerRelease",0)),this}triggerAttackRelease(n,o,c=1){return o=this.toSeconds(o),n=this.toSeconds(n),this.triggerAttack(o,c),this.triggerRelease(o+n),this}dispose(){return super.dispose(),this.noise.dispose(),this.envelope.dispose(),this}}const Ru=new Set;function Hu(p){Ru.add(p)}function vm(p,n){const o=`registerProcessor("${p}", ${n})`;Ru.add(o)}class Nu extends ht{constructor(n){super(n),this.name="ToneAudioWorklet",this.workletOptions={},this.onprocessorerror=Xt;const o=URL.createObjectURL(new Blob([Array.from(Ru).join(`
`)],{type:"text/javascript"})),c=this._audioWorkletName();this._dummyGain=this.context.createGain(),this._dummyParam=this._dummyGain.gain,this.context.addAudioWorkletModule(o).then((()=>{this.disposed||(this._worklet=this.context.createAudioWorkletNode(c,this.workletOptions),this._worklet.onprocessorerror=this.onprocessorerror.bind(this),this.onReady(this._worklet))}))}dispose(){return super.dispose(),this._dummyGain.disconnect(),this._worklet&&(this._worklet.port.postMessage("dispose"),this._worklet.disconnect()),this}}Hu(`
	/**
	 * The base AudioWorkletProcessor for use in Tone.js. Works with the {@link ToneAudioWorklet}. 
	 */
	class ToneAudioWorkletProcessor extends AudioWorkletProcessor {

		constructor(options) {
			
			super(options);
			/**
			 * If the processor was disposed or not. Keep alive until it's disposed.
			 */
			this.disposed = false;
		   	/** 
			 * The number of samples in the processing block
			 */
			this.blockSize = 128;
			/**
			 * the sample rate
			 */
			this.sampleRate = sampleRate;

			this.port.onmessage = (event) => {
				// when it receives a dispose 
				if (event.data === "dispose") {
					this.disposed = true;
				}
			};
		}
	}
`),Hu(`
	/**
	 * Abstract class for a single input/output processor. 
	 * has a 'generate' function which processes one sample at a time
	 */
	class SingleIOProcessor extends ToneAudioWorkletProcessor {

		constructor(options) {
			super(Object.assign(options, {
				numberOfInputs: 1,
				numberOfOutputs: 1
			}));
			/**
			 * Holds the name of the parameter and a single value of that
			 * parameter at the current sample
			 * @type { [name: string]: number }
			 */
			this.params = {}
		}

		/**
		 * Generate an output sample from the input sample and parameters
		 * @abstract
		 * @param input number
		 * @param channel number
		 * @param parameters { [name: string]: number }
		 * @returns number
		 */
		generate(){}

		/**
		 * Update the private params object with the 
		 * values of the parameters at the given index
		 * @param parameters { [name: string]: Float32Array },
		 * @param index number
		 */
		updateParams(parameters, index) {
			for (const paramName in parameters) {
				const param = parameters[paramName];
				if (param.length > 1) {
					this.params[paramName] = parameters[paramName][index];
				} else {
					this.params[paramName] = parameters[paramName][0];
				}
			}
		}

		/**
		 * Process a single frame of the audio
		 * @param inputs Float32Array[][]
		 * @param outputs Float32Array[][]
		 */
		process(inputs, outputs, parameters) {
			const input = inputs[0];
			const output = outputs[0];
			// get the parameter values
			const channelCount = Math.max(input && input.length || 0, output.length);
			for (let sample = 0; sample < this.blockSize; sample++) {
				this.updateParams(parameters, sample);
				for (let channel = 0; channel < channelCount; channel++) {
					const inputSample = input && input.length ? input[channel][sample] : 0;
					output[channel][sample] = this.generate(inputSample, channel, this.params);
				}
			}
			return !this.disposed;
		}
	};
`),Hu(`
	/**
	 * A multichannel buffer for use within an AudioWorkletProcessor as a delay line
	 */
	class DelayLine {
		
		constructor(size, channels) {
			this.buffer = [];
			this.writeHead = []
			this.size = size;

			// create the empty channels
			for (let i = 0; i < channels; i++) {
				this.buffer[i] = new Float32Array(this.size);
				this.writeHead[i] = 0;
			}
		}

		/**
		 * Push a value onto the end
		 * @param channel number
		 * @param value number
		 */
		push(channel, value) {
			this.writeHead[channel] += 1;
			if (this.writeHead[channel] > this.size) {
				this.writeHead[channel] = 0;
			}
			this.buffer[channel][this.writeHead[channel]] = value;
		}

		/**
		 * Get the recorded value of the channel given the delay
		 * @param channel number
		 * @param delay number delay samples
		 */
		get(channel, delay) {
			let readHead = this.writeHead[channel] - Math.floor(delay);
			if (readHead < 0) {
				readHead += this.size;
			}
			return this.buffer[channel][readHead];
		}
	}
`);const Bm="feedback-comb-filter";vm(Bm,`
	class FeedbackCombFilterWorklet extends SingleIOProcessor {

		constructor(options) {
			super(options);
			this.delayLine = new DelayLine(this.sampleRate, options.channelCount || 2);
		}

		static get parameterDescriptors() {
			return [{
				name: "delayTime",
				defaultValue: 0.1,
				minValue: 0,
				maxValue: 1,
				automationRate: "k-rate"
			}, {
				name: "feedback",
				defaultValue: 0.5,
				minValue: 0,
				maxValue: 0.9999,
				automationRate: "k-rate"
			}];
		}

		generate(input, channel, parameters) {
			const delayedSample = this.delayLine.get(channel, parameters.delayTime * this.sampleRate);
			this.delayLine.push(channel, input + delayedSample * parameters.feedback);
			return delayedSample;
		}
	}
`);class jr extends Nu{constructor(){const n=rt(jr.getDefaults(),arguments,["delayTime","resonance"]);super(n),this.name="FeedbackCombFilter",this.input=new Tt({context:this.context}),this.output=new Tt({context:this.context}),this.delayTime=new Lt({context:this.context,value:n.delayTime,units:"time",minValue:0,maxValue:1,param:this._dummyParam,swappable:!0}),this.resonance=new Lt({context:this.context,value:n.resonance,units:"normalRange",param:this._dummyParam,swappable:!0}),Ut(this,["resonance","delayTime"])}_audioWorkletName(){return Bm}static getDefaults(){return Object.assign(ht.getDefaults(),{delayTime:.1,resonance:.5})}onReady(n){qs(this.input,n,this.output);const o=n.parameters.get("delayTime");this.delayTime.setParam(o);const c=n.parameters.get("feedback");this.resonance.setParam(c)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.delayTime.dispose(),this.resonance.dispose(),this}}class Jr extends ht{constructor(){const n=rt(Jr.getDefaults(),arguments,["frequency","type"]);super(n),this.name="OnePoleFilter",this._frequency=n.frequency,this._type=n.type,this.input=new Tt({context:this.context}),this.output=new Tt({context:this.context}),this._createFilter()}static getDefaults(){return Object.assign(ht.getDefaults(),{frequency:880,type:"lowpass"})}_createFilter(){const n=this._filter,o=this.toFrequency(this._frequency),c=1/(2*Math.PI*o);if(this._type==="lowpass"){const f=1/(c*this.context.sampleRate),v=f-1;this._filter=this.context.createIIRFilter([f,0],[1,v])}else{const f=1/(c*this.context.sampleRate)-1;this._filter=this.context.createIIRFilter([1,-1],[1,f])}this.input.chain(this._filter,this.output),n&&this.context.setTimeout((()=>{this.disposed||(this.input.disconnect(n),n.disconnect())}),this.blockTime)}get frequency(){return this._frequency}set frequency(n){this._frequency=n,this._createFilter()}get type(){return this._type}set type(n){this._type=n,this._createFilter()}getFrequencyResponse(n=128){const o=new Float32Array(n);for(let v=0;v<n;v++){const B=19980*Math.pow(v/n,2)+20;o[v]=B}const c=new Float32Array(n),f=new Float32Array(n);return this._filter.getFrequencyResponse(o,c,f),c}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this._filter.disconnect(),this}}class Zr extends ht{constructor(){const n=rt(Zr.getDefaults(),arguments,["delayTime","resonance","dampening"]);super(n),this.name="LowpassCombFilter",this._combFilter=this.output=new jr({context:this.context,delayTime:n.delayTime,resonance:n.resonance}),this.delayTime=this._combFilter.delayTime,this.resonance=this._combFilter.resonance,this._lowpass=this.input=new Jr({context:this.context,frequency:n.dampening,type:"lowpass"}),this._lowpass.connect(this._combFilter)}static getDefaults(){return Object.assign(ht.getDefaults(),{dampening:3e3,delayTime:.1,resonance:.5})}get dampening(){return this._lowpass.frequency}set dampening(n){this._lowpass.frequency=n}dispose(){return super.dispose(),this._combFilter.dispose(),this._lowpass.dispose(),this}}class Ou extends nn{constructor(){const n=rt(Ou.getDefaults(),arguments);super(n),this.name="PluckSynth",this._noise=new yi({context:this.context,type:"pink"}),this.attackNoise=n.attackNoise,this._lfcf=new Zr({context:this.context,dampening:n.dampening,resonance:n.resonance}),this.resonance=n.resonance,this.release=n.release,this._noise.connect(this._lfcf),this._lfcf.connect(this.output)}static getDefaults(){return en(nn.getDefaults(),{attackNoise:1,dampening:4e3,resonance:.7,release:1})}get dampening(){return this._lfcf.dampening}set dampening(n){this._lfcf.dampening=n}triggerAttack(n,o){const c=this.toFrequency(n);o=this.toSeconds(o);const f=1/c;return this._lfcf.delayTime.setValueAtTime(f,o),this._noise.start(o),this._noise.stop(o+f*this.attackNoise),this._lfcf.resonance.cancelScheduledValues(o),this._lfcf.resonance.setValueAtTime(this.resonance,o),this}triggerRelease(n){return this._lfcf.resonance.linearRampTo(0,this.release,n),this}dispose(){return super.dispose(),this._noise.dispose(),this._lfcf.dispose(),this}}class Vu extends nn{constructor(){const n=rt(Vu.getDefaults(),arguments,["voice","options"]);super(n),this.name="PolySynth",this._availableVoices=[],this._activeVoices=[],this._voices=[],this._gcTimeout=-1,this._averageActiveVoices=0,this._syncedRelease=f=>this.releaseAll(f),It(!Vs(n.voice),"DEPRECATED: The polyphony count is no longer the first argument.");const o=n.voice.getDefaults();this.options=Object.assign(o,n.options),this.voice=n.voice,this.maxPolyphony=n.maxPolyphony,this._dummyVoice=this._getNextAvailableVoice();const c=this._voices.indexOf(this._dummyVoice);this._voices.splice(c,1),this._gcTimeout=this.context.setInterval(this._collectGarbage.bind(this),1)}static getDefaults(){return Object.assign(nn.getDefaults(),{maxPolyphony:32,options:{},voice:Ci})}get activeVoices(){return this._activeVoices.length}_makeVoiceAvailable(n){this._availableVoices.push(n);const o=this._activeVoices.findIndex((c=>c.voice===n));this._activeVoices.splice(o,1)}_getNextAvailableVoice(){if(this._availableVoices.length)return this._availableVoices.shift();if(this._voices.length<this.maxPolyphony){const n=new this.voice(Object.assign(this.options,{context:this.context,onsilence:this._makeVoiceAvailable.bind(this)}));return It(n instanceof ds,"Voice must extend Monophonic class"),n.connect(this.output),this._voices.push(n),n}TA("Max polyphony exceeded. Note dropped.")}_collectGarbage(){if(this._averageActiveVoices=Math.max(.95*this._averageActiveVoices,this.activeVoices),this._availableVoices.length&&this._voices.length>Math.ceil(this._averageActiveVoices+1)){const n=this._availableVoices.shift(),o=this._voices.indexOf(n);this._voices.splice(o,1),this.context.isOffline||n.dispose()}}_triggerAttack(n,o,c){n.forEach((f=>{const v=new OA(this.context,f).toMidi(),B=this._getNextAvailableVoice();B&&(B.triggerAttack(f,o,c),this._activeVoices.push({midi:v,voice:B,released:!1}),this.log("triggerAttack",f,o))}))}_triggerRelease(n,o){n.forEach((c=>{const f=new OA(this.context,c).toMidi(),v=this._activeVoices.find((({midi:B,released:_})=>B===f&&!_));v&&(v.voice.triggerRelease(o),v.released=!0,this.log("triggerRelease",c,o))}))}_scheduleEvent(n,o,c,f){It(!this.disposed,"Synth was already disposed"),c<=this.now()?n==="attack"?this._triggerAttack(o,c,f):this._triggerRelease(o,c):this.context.setTimeout((()=>{this.disposed||this._scheduleEvent(n,o,c,f)}),c-this.now())}triggerAttack(n,o,c){Array.isArray(n)||(n=[n]);const f=this.toSeconds(o);return this._scheduleEvent("attack",n,f,c),this}triggerRelease(n,o){Array.isArray(n)||(n=[n]);const c=this.toSeconds(o);return this._scheduleEvent("release",n,c),this}triggerAttackRelease(n,o,c,f){const v=this.toSeconds(c);if(this.triggerAttack(n,v,f),ls(o)){It(ls(n),"If the duration is an array, the notes must also be an array");for(let B=0;B<n.length;B++){const _=o[Math.min(B,o.length-1)],S=this.toSeconds(_);It(S>0,"The duration must be greater than 0"),this.triggerRelease(n[B],v+S)}}else{const B=this.toSeconds(o);It(B>0,"The duration must be greater than 0"),this.triggerRelease(n,v+B)}return this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1),this.context.transport.on("stop",this._syncedRelease),this.context.transport.on("pause",this._syncedRelease),this.context.transport.on("loopEnd",this._syncedRelease)),this}set(n){const o=us(n,["onsilence","context"]);return this.options=en(this.options,o),this._voices.forEach((c=>c.set(o))),this._dummyVoice.set(o),this}get(){return this._dummyVoice.get()}releaseAll(n){const o=this.toSeconds(n);return this._activeVoices.forEach((({voice:c})=>{c.triggerRelease(o)})),this}dispose(){return super.dispose(),this._dummyVoice.dispose(),this._voices.forEach((n=>n.dispose())),this._activeVoices=[],this._availableVoices=[],this.context.clearInterval(this._gcTimeout),this}}class to extends nn{constructor(){const n=rt(to.getDefaults(),arguments,["urls","onload","baseUrl"],"urls");super(n),this.name="Sampler",this._activeSources=new Map;const o={};Object.keys(n.urls).forEach((c=>{const f=parseInt(c,10);if(It(Lr(c)||Vs(f)&&isFinite(f),`url key is neither a note or midi pitch: ${c}`),Lr(c)){const v=new xs(this.context,c).toMidi();o[v]=n.urls[c]}else Vs(f)&&isFinite(f)&&(o[f]=n.urls[f])})),this._buffers=new NA({urls:o,onload:n.onload,baseUrl:n.baseUrl,onerror:n.onerror}),this.attack=n.attack,this.release=n.release,this.curve=n.curve,this._buffers.loaded&&Promise.resolve().then(n.onload)}static getDefaults(){return Object.assign(nn.getDefaults(),{attack:0,baseUrl:"",curve:"exponential",onload:Xt,onerror:Xt,release:.1,urls:{}})}_findClosest(n){let o=0;for(;o<96;){if(this._buffers.has(n+o))return-o;if(this._buffers.has(n-o))return o;o++}throw new Error(`No available buffers for note: ${n}`)}triggerAttack(n,o,c=1){return this.log("triggerAttack",n,o,c),Array.isArray(n)||(n=[n]),n.forEach((f=>{const v=um(new xs(this.context,f).toFrequency()),B=Math.round(v),_=v-B,S=this._findClosest(B),F=B-S,I=this._buffers.get(F),M=kA(S+_),k=new Bi({url:I,context:this.context,curve:this.curve,fadeIn:this.attack,fadeOut:this.release,playbackRate:M}).connect(this.output);k.start(o,0,I.duration/M,c),ls(this._activeSources.get(B))||this._activeSources.set(B,[]),this._activeSources.get(B).push(k),k.onended=()=>{if(this._activeSources&&this._activeSources.has(B)){const L=this._activeSources.get(B),K=L.indexOf(k);K!==-1&&L.splice(K,1)}}})),this}triggerRelease(n,o){return this.log("triggerRelease",n,o),Array.isArray(n)||(n=[n]),n.forEach((c=>{const f=new xs(this.context,c).toMidi();if(this._activeSources.has(f)&&this._activeSources.get(f).length){const v=this._activeSources.get(f);o=this.toSeconds(o),v.forEach((B=>{B.stop(o)})),this._activeSources.set(f,[])}})),this}releaseAll(n){const o=this.toSeconds(n);return this._activeSources.forEach((c=>{for(;c.length;)c.shift().stop(o)})),this}sync(){return this._syncState()&&(this._syncMethod("triggerAttack",1),this._syncMethod("triggerRelease",1)),this}triggerAttackRelease(n,o,c,f=1){const v=this.toSeconds(c);return this.triggerAttack(n,v,f),ls(o)?(It(ls(n),"notes must be an array when duration is array"),n.forEach(((B,_)=>{const S=o[Math.min(_,o.length-1)];this.triggerRelease(B,v+this.toSeconds(S))}))):this.triggerRelease(n,v+this.toSeconds(o)),this}add(n,o,c){if(It(Lr(n)||isFinite(n),`note must be a pitch or midi: ${n}`),Lr(n)){const f=new xs(this.context,n).toMidi();this._buffers.add(f,o,c)}else this._buffers.add(n,o,c);return this}get loaded(){return this._buffers.loaded}dispose(){return super.dispose(),this._buffers.dispose(),this._activeSources.forEach((n=>{n.forEach((o=>o.dispose()))})),this._activeSources.clear(),this}}wn([si(0)],to.prototype,"attack",void 0),wn([si(0)],to.prototype,"release",void 0);class Pn extends ss{constructor(){const n=rt(Pn.getDefaults(),arguments,["callback","value"]);super(n),this.name="ToneEvent",this._state=new LA("stopped"),this._startOffset=0,this._loop=n.loop,this.callback=n.callback,this.value=n.value,this._loopStart=this.toTicks(n.loopStart),this._loopEnd=this.toTicks(n.loopEnd),this._playbackRate=n.playbackRate,this._probability=n.probability,this._humanize=n.humanize,this.mute=n.mute,this._playbackRate=n.playbackRate,this._state.increasing=!0,this._rescheduleEvents()}static getDefaults(){return Object.assign(ss.getDefaults(),{callback:Xt,humanize:!1,loop:!1,loopEnd:"1m",loopStart:0,mute:!1,playbackRate:1,probability:1,value:null})}_rescheduleEvents(n=-1){this._state.forEachFrom(n,(o=>{let c;if(o.state==="started"){o.id!==-1&&this.context.transport.clear(o.id);const f=o.time+Math.round(this.startOffset/this._playbackRate);if(this._loop===!0||Vs(this._loop)&&this._loop>1){c=1/0,Vs(this._loop)&&(c=this._loop*this._getLoopDuration());const v=this._state.getAfter(f);v!==null&&(c=Math.min(c,v.time-f)),c!==1/0&&(c=new Ee(this.context,c));const B=new Ee(this.context,this._getLoopDuration());o.id=this.context.transport.scheduleRepeat(this._tick.bind(this),B,new Ee(this.context,f),c)}else o.id=this.context.transport.schedule(this._tick.bind(this),new Ee(this.context,f))}}))}get state(){return this._state.getValueAtTime(this.context.transport.ticks)}get startOffset(){return this._startOffset}set startOffset(n){this._startOffset=n}get probability(){return this._probability}set probability(n){this._probability=n}get humanize(){return this._humanize}set humanize(n){this._humanize=n}start(n){const o=this.toTicks(n);return this._state.getValueAtTime(o)==="stopped"&&(this._state.add({id:-1,state:"started",time:o}),this._rescheduleEvents(o)),this}stop(n){this.cancel(n);const o=this.toTicks(n);if(this._state.getValueAtTime(o)==="started"){this._state.setStateAtTime("stopped",o,{id:-1});const c=this._state.getBefore(o);let f=o;c!==null&&(f=c.time),this._rescheduleEvents(f)}return this}cancel(n){n=sn(n,-1/0);const o=this.toTicks(n);return this._state.forEachFrom(o,(c=>{this.context.transport.clear(c.id)})),this._state.cancel(o),this}_tick(n){const o=this.context.transport.getTicksAtTime(n);if(!this.mute&&this._state.getValueAtTime(o)==="started"){if(this.probability<1&&Math.random()>this.probability)return;if(this.humanize){let c=.02;pu(this.humanize)||(c=this.toSeconds(this.humanize)),n+=(2*Math.random()-1)*c}this.callback(n,this.value)}}_getLoopDuration(){return(this._loopEnd-this._loopStart)/this._playbackRate}get loop(){return this._loop}set loop(n){this._loop=n,this._rescheduleEvents()}get playbackRate(){return this._playbackRate}set playbackRate(n){this._playbackRate=n,this._rescheduleEvents()}get loopEnd(){return new Ee(this.context,this._loopEnd).toSeconds()}set loopEnd(n){this._loopEnd=this.toTicks(n),this._loop&&this._rescheduleEvents()}get loopStart(){return new Ee(this.context,this._loopStart).toSeconds()}set loopStart(n){this._loopStart=this.toTicks(n),this._loop&&this._rescheduleEvents()}get progress(){if(this._loop){const n=this.context.transport.ticks,o=this._state.get(n);if(o!==null&&o.state==="started"){const c=this._getLoopDuration();return(n-o.time)%c/c}return 0}return 0}dispose(){return super.dispose(),this.cancel(),this._state.dispose(),this}}class eo extends ss{constructor(){const n=rt(eo.getDefaults(),arguments,["callback","interval"]);super(n),this.name="Loop",this._event=new Pn({context:this.context,callback:this._tick.bind(this),loop:!0,loopEnd:n.interval,playbackRate:n.playbackRate,probability:n.probability,humanize:n.humanize}),this.callback=n.callback,this.iterations=n.iterations}static getDefaults(){return Object.assign(ss.getDefaults(),{interval:"4n",callback:Xt,playbackRate:1,iterations:1/0,probability:1,mute:!1,humanize:!1})}start(n){return this._event.start(n),this}stop(n){return this._event.stop(n),this}cancel(n){return this._event.cancel(n),this}_tick(n){this.callback(n)}get state(){return this._event.state}get progress(){return this._event.progress}get interval(){return this._event.loopEnd}set interval(n){this._event.loopEnd=n}get playbackRate(){return this._event.playbackRate}set playbackRate(n){this._event.playbackRate=n}get humanize(){return this._event.humanize}set humanize(n){this._event.humanize=n}get probability(){return this._event.probability}set probability(n){this._event.probability=n}get mute(){return this._event.mute}set mute(n){this._event.mute=n}get iterations(){return this._event.loop===!0?1/0:this._event.loop}set iterations(n){this._event.loop=n===1/0||n}dispose(){return super.dispose(),this._event.dispose(),this}}class so extends Pn{constructor(){const n=rt(so.getDefaults(),arguments,["callback","events"]);super(n),this.name="Part",this._state=new LA("stopped"),this._events=new Set,this._state.increasing=!0,n.events.forEach((o=>{ls(o)?this.add(o[0],o[1]):this.add(o)}))}static getDefaults(){return Object.assign(Pn.getDefaults(),{events:[]})}start(n,o){const c=this.toTicks(n);if(this._state.getValueAtTime(c)!=="started"){o=sn(o,this._loop?this._loopStart:0),o=this._loop?sn(o,this._loopStart):sn(o,0);const f=this.toTicks(o);this._state.add({id:-1,offset:f,state:"started",time:c}),this._forEach((v=>{this._startNote(v,c,f)}))}return this}_startNote(n,o,c){o-=c,this._loop?n.startOffset>=this._loopStart&&n.startOffset<this._loopEnd?(n.startOffset<c&&(o+=this._getLoopDuration()),n.start(new Ee(this.context,o))):n.startOffset<this._loopStart&&n.startOffset>=c&&(n.loop=!1,n.start(new Ee(this.context,o))):n.startOffset>=c&&n.start(new Ee(this.context,o))}get startOffset(){return this._startOffset}set startOffset(n){this._startOffset=n,this._forEach((o=>{o.startOffset+=this._startOffset}))}stop(n){const o=this.toTicks(n);return this._state.cancel(o),this._state.setStateAtTime("stopped",o),this._forEach((c=>{c.stop(n)})),this}at(n,o){const c=new qe(this.context,n).toTicks(),f=new Ee(this.context,1).toSeconds(),v=this._events.values();let B=v.next();for(;!B.done;){const _=B.value;if(Math.abs(c-_.startOffset)<f)return Kt(o)&&(_.value=o),_;B=v.next()}return Kt(o)?(this.add(n,o),this.at(n)):null}add(n,o){n instanceof Object&&Reflect.has(n,"time")&&(n=(o=n).time);const c=this.toTicks(n);let f;return o instanceof Pn?(f=o,f.callback=this._tick.bind(this)):f=new Pn({callback:this._tick.bind(this),context:this.context,value:o}),f.startOffset=c,f.set({humanize:this.humanize,loop:this.loop,loopEnd:this.loopEnd,loopStart:this.loopStart,playbackRate:this.playbackRate,probability:this.probability}),this._events.add(f),this._restartEvent(f),this}_restartEvent(n){this._state.forEach((o=>{o.state==="started"?this._startNote(n,o.time,o.offset):n.stop(new Ee(this.context,o.time))}))}remove(n,o){return Yn(n)&&n.hasOwnProperty("time")&&(n=(o=n).time),n=this.toTicks(n),this._events.forEach((c=>{c.startOffset===n&&(Ps(o)||Kt(o)&&c.value===o)&&(this._events.delete(c),c.dispose())})),this}clear(){return this._forEach((n=>n.dispose())),this._events.clear(),this}cancel(n){return this._forEach((o=>o.cancel(n))),this._state.cancel(this.toTicks(n)),this}_forEach(n){return this._events&&this._events.forEach((o=>{o instanceof so?o._forEach(n):n(o)})),this}_setAll(n,o){this._forEach((c=>{c[n]=o}))}_tick(n,o){this.mute||this.callback(n,o)}_testLoopBoundries(n){this._loop&&(n.startOffset<this._loopStart||n.startOffset>=this._loopEnd)?n.cancel(0):n.state==="stopped"&&this._restartEvent(n)}get probability(){return this._probability}set probability(n){this._probability=n,this._setAll("probability",n)}get humanize(){return this._humanize}set humanize(n){this._humanize=n,this._setAll("humanize",n)}get loop(){return this._loop}set loop(n){this._loop=n,this._forEach((o=>{o.loopStart=this.loopStart,o.loopEnd=this.loopEnd,o.loop=n,this._testLoopBoundries(o)}))}get loopEnd(){return new Ee(this.context,this._loopEnd).toSeconds()}set loopEnd(n){this._loopEnd=this.toTicks(n),this._loop&&this._forEach((o=>{o.loopEnd=n,this._testLoopBoundries(o)}))}get loopStart(){return new Ee(this.context,this._loopStart).toSeconds()}set loopStart(n){this._loopStart=this.toTicks(n),this._loop&&this._forEach((o=>{o.loopStart=this.loopStart,this._testLoopBoundries(o)}))}get playbackRate(){return this._playbackRate}set playbackRate(n){this._playbackRate=n,this._setAll("playbackRate",n)}get length(){return this._events.size}dispose(){return super.dispose(),this.clear(),this}}function*YC(p){let n=0;for(;n<p;)n=Yi(n,0,p-1),yield n,n++}function*jC(p){let n=p-1;for(;n>=0;)n=Yi(n,0,p-1),yield n,n--}function*no(p,n){for(;;)yield*n(p)}function*ym(p,n){let o=n?0:p-1;for(;;)o=Yi(o,0,p-1),yield o,n?(o++,o>=p-1&&(n=!1)):(o--,o<=0&&(n=!0))}function*JC(p){let n=0,o=0;for(;n<p;)n=Yi(n,0,p-1),yield n,o++,n+=o%2?2:-1}function*ZC(p){let n=p-1,o=0;for(;n>=0;)n=Yi(n,0,p-1),yield n,o++,n+=o%2?-2:1}function*tb(p){const n=[];for(let o=0;o<p;o++)n.push(o);for(;n.length>0;)yield Yi(n.splice(Math.floor(n.length*Math.random()),1)[0],0,p-1)}function*Cm(p,n="up",o=0){switch(It(p>=1,"The number of values must be at least one"),n){case"up":yield*no(p,YC);case"down":yield*no(p,jC);case"upDown":yield*ym(p,!0);case"downUp":yield*ym(p,!1);case"alternateUp":yield*no(p,JC);case"alternateDown":yield*no(p,ZC);case"random":yield*(function*(c){for(;;)yield Math.floor(Math.random()*c)})(p);case"randomOnce":yield*no(p,tb);case"randomWalk":yield*(function*(c){let f=Math.floor(Math.random()*c);for(;;)f===0?f++:f===c-1||Math.random()<.5?f--:f++,yield f})(p)}}class Wu extends eo{constructor(){const n=rt(Wu.getDefaults(),arguments,["callback","values","pattern"]);super(n),this.name="Pattern",this.callback=n.callback,this._values=n.values,this._pattern=Cm(n.values.length,n.pattern),this._type=n.pattern}static getDefaults(){return Object.assign(eo.getDefaults(),{pattern:"up",values:[],callback:Xt})}_tick(n){const o=this._pattern.next();this._index=o.value,this._value=this._values[o.value],this.callback(n,this._value)}get values(){return this._values}set values(n){this._values=n,this.pattern=this._type}get value(){return this._value}get index(){return this._index}get pattern(){return this._type}set pattern(n){this._type=n,this._pattern=Cm(this._values.length,this._type)}}class Ku extends Pn{constructor(){const n=rt(Ku.getDefaults(),arguments,["callback","events","subdivision"]);super(n),this.name="Sequence",this._part=new so({callback:this._seqCallback.bind(this),context:this.context}),this._events=[],this._eventsArray=[],this._subdivision=this.toTicks(n.subdivision),this.events=n.events,this.loop=n.loop,this.loopStart=n.loopStart,this.loopEnd=n.loopEnd,this.playbackRate=n.playbackRate,this.probability=n.probability,this.humanize=n.humanize,this.mute=n.mute,this.playbackRate=n.playbackRate}static getDefaults(){return Object.assign(us(Pn.getDefaults(),["value"]),{events:[],loop:!0,loopEnd:0,loopStart:0,subdivision:"8n"})}_seqCallback(n,o){o===null||this.mute||this.callback(n,o)}get events(){return this._events}set events(n){this.clear(),this._eventsArray=n,this._events=this._createSequence(this._eventsArray),this._eventsUpdated()}start(n,o){return this._part.start(n,o&&this._indexTime(o)),this}stop(n){return this._part.stop(n),this}get subdivision(){return new Ee(this.context,this._subdivision).toSeconds()}_createSequence(n){return new Proxy(n,{get:(o,c)=>o[c],set:(o,c,f)=>(gn(c)&&isFinite(parseInt(c,10))&&ls(f)?o[c]=this._createSequence(f):o[c]=f,this._eventsUpdated(),!0)})}_eventsUpdated(){this._part.clear(),this._rescheduleSequence(this._eventsArray,this._subdivision,this.startOffset),this.loopEnd=this.loopEnd}_rescheduleSequence(n,o,c){n.forEach(((f,v)=>{const B=v*o+c;if(ls(f))this._rescheduleSequence(f,o/f.length,B);else{const _=new Ee(this.context,B,"i").toSeconds();this._part.add(_,f)}}))}_indexTime(n){return new Ee(this.context,n*this._subdivision+this.startOffset).toSeconds()}clear(){return this._part.clear(),this}dispose(){return super.dispose(),this._part.dispose(),this}get loop(){return this._part.loop}set loop(n){this._part.loop=n}get loopStart(){return this._loopStart}set loopStart(n){this._loopStart=n,this._part.loopStart=this._indexTime(n)}get loopEnd(){return this._loopEnd}set loopEnd(n){this._loopEnd=n,this._part.loopEnd=n===0?this._indexTime(this._eventsArray.length):this._indexTime(n)}get startOffset(){return this._part.startOffset}set startOffset(n){this._part.startOffset=n}get playbackRate(){return this._part.playbackRate}set playbackRate(n){this._part.playbackRate=n}get probability(){return this._part.probability}set probability(n){this._part.probability=n}get progress(){return this._part.progress}get humanize(){return this._part.humanize}set humanize(n){this._part.humanize=n}get length(){return this._part.length}}class $A extends ht{constructor(){const n=rt($A.getDefaults(),arguments,["fade"]);super(n),this.name="CrossFade",this._panner=this.context.createStereoPanner(),this._split=this.context.createChannelSplitter(2),this._g2a=new gm({context:this.context}),this.a=new Tt({context:this.context,gain:0}),this.b=new Tt({context:this.context,gain:0}),this.output=new Tt({context:this.context}),this._internalChannels=[this.a,this.b],this.fade=new Dt({context:this.context,units:"normalRange",value:n.fade}),Ut(this,"fade"),this.context.getConstant(1).connect(this._panner),this._panner.connect(this._split),this._panner.channelCount=1,this._panner.channelCountMode="explicit",Es(this._split,this.a.gain,0),Es(this._split,this.b.gain,1),this.fade.chain(this._g2a,this._panner.pan),this.a.connect(this.output),this.b.connect(this.output)}static getDefaults(){return Object.assign(ht.getDefaults(),{fade:.5})}dispose(){return super.dispose(),this.a.dispose(),this.b.dispose(),this.output.dispose(),this.fade.dispose(),this._g2a.dispose(),this._panner.disconnect(),this._split.disconnect(),this}}class Xe extends ht{constructor(n){super(n),this.name="Effect",this._dryWet=new $A({context:this.context}),this.wet=this._dryWet.fade,this.effectSend=new Tt({context:this.context}),this.effectReturn=new Tt({context:this.context}),this.input=new Tt({context:this.context}),this.output=this._dryWet,this.input.fan(this._dryWet.a,this.effectSend),this.effectReturn.connect(this._dryWet.b),this.wet.setValueAtTime(n.wet,0),this._internalChannels=[this.effectReturn,this.effectSend],Ut(this,"wet")}static getDefaults(){return Object.assign(ht.getDefaults(),{wet:1})}connectEffect(n){return this._internalChannels.push(n),this.effectSend.chain(n,this.effectReturn),this}dispose(){return super.dispose(),this._dryWet.dispose(),this.effectSend.dispose(),this.effectReturn.dispose(),this.wet.dispose(),this}}class Xa extends Xe{constructor(n){super(n),this.name="LFOEffect",this._lfo=new Ss({context:this.context,frequency:n.frequency,amplitude:n.depth}),this.depth=this._lfo.amplitude,this.frequency=this._lfo.frequency,this.type=n.type,Ut(this,["frequency","depth"])}static getDefaults(){return Object.assign(Xe.getDefaults(),{frequency:1,type:"sine",depth:1})}start(n){return this._lfo.start(n),this}stop(n){return this._lfo.stop(n),this}sync(){return this._lfo.sync(),this}unsync(){return this._lfo.unsync(),this}get type(){return this._lfo.type}set type(n){this._lfo.type=n}dispose(){return super.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class Gu extends Xa{constructor(){const n=rt(Gu.getDefaults(),arguments,["frequency","baseFrequency","octaves"]);super(n),this.name="AutoFilter",this.filter=new Xs(Object.assign(n.filter,{context:this.context})),this.connectEffect(this.filter),this._lfo.connect(this.filter.frequency),this.octaves=n.octaves,this.baseFrequency=n.baseFrequency}static getDefaults(){return Object.assign(Xa.getDefaults(),{baseFrequency:200,octaves:2.6,filter:{type:"lowpass",rolloff:-12,Q:1}})}get baseFrequency(){return this._lfo.min}set baseFrequency(n){this._lfo.min=this.toFrequency(n),this.octaves=this._octaves}get octaves(){return this._octaves}set octaves(n){this._octaves=n,this._lfo.max=this._lfo.min*Math.pow(2,n)}dispose(){return super.dispose(),this.filter.dispose(),this}}class io extends ht{constructor(){const n=rt(io.getDefaults(),arguments,["pan"]);super(n),this.name="Panner",this._panner=this.context.createStereoPanner(),this.input=this._panner,this.output=this._panner,this.pan=new Lt({context:this.context,param:this._panner.pan,value:n.pan,minValue:-1,maxValue:1}),this._panner.channelCount=n.channelCount,this._panner.channelCountMode="explicit",Ut(this,"pan")}static getDefaults(){return Object.assign(ht.getDefaults(),{pan:0,channelCount:1})}dispose(){return super.dispose(),this._panner.disconnect(),this.pan.dispose(),this}}class qu extends Xa{constructor(){const n=rt(qu.getDefaults(),arguments,["frequency"]);super(n),this.name="AutoPanner",this._panner=new io({context:this.context,channelCount:n.channelCount}),this.connectEffect(this._panner),this._lfo.connect(this._panner.pan),this._lfo.min=-1,this._lfo.max=1}static getDefaults(){return Object.assign(Xa.getDefaults(),{channelCount:1})}dispose(){return super.dispose(),this._panner.dispose(),this}}class Ao extends ht{constructor(){const n=rt(Ao.getDefaults(),arguments,["smoothing"]);super(n),this.name="Follower",this._abs=this.input=new mm({context:this.context}),this._lowpass=this.output=new Jr({context:this.context,frequency:1/this.toSeconds(n.smoothing),type:"lowpass"}),this._abs.connect(this._lowpass),this._smoothing=n.smoothing}static getDefaults(){return Object.assign(ht.getDefaults(),{smoothing:.05})}get smoothing(){return this._smoothing}set smoothing(n){this._smoothing=n,this._lowpass.frequency=1/this.toSeconds(this.smoothing)}dispose(){return super.dispose(),this._abs.dispose(),this._lowpass.dispose(),this}}class zu extends Xe{constructor(){const n=rt(zu.getDefaults(),arguments,["baseFrequency","octaves","sensitivity"]);super(n),this.name="AutoWah",this._follower=new Ao({context:this.context,smoothing:n.follower}),this._sweepRange=new za({context:this.context,min:0,max:1,exponent:.5}),this._baseFrequency=this.toFrequency(n.baseFrequency),this._octaves=n.octaves,this._inputBoost=new Tt({context:this.context}),this._bandpass=new Xs({context:this.context,rolloff:-48,frequency:0,Q:n.Q}),this._peaking=new Xs({context:this.context,type:"peaking"}),this._peaking.gain.value=n.gain,this.gain=this._peaking.gain,this.Q=this._bandpass.Q,this.effectSend.chain(this._inputBoost,this._follower,this._sweepRange),this._sweepRange.connect(this._bandpass.frequency),this._sweepRange.connect(this._peaking.frequency),this.effectSend.chain(this._bandpass,this._peaking,this.effectReturn),this._setSweepRange(),this.sensitivity=n.sensitivity,Ut(this,["gain","Q"])}static getDefaults(){return Object.assign(Xe.getDefaults(),{baseFrequency:100,octaves:6,sensitivity:0,Q:2,gain:2,follower:.2})}get octaves(){return this._octaves}set octaves(n){this._octaves=n,this._setSweepRange()}get follower(){return this._follower.smoothing}set follower(n){this._follower.smoothing=n}get baseFrequency(){return this._baseFrequency}set baseFrequency(n){this._baseFrequency=this.toFrequency(n),this._setSweepRange()}get sensitivity(){return Nr(1/this._inputBoost.gain.value)}set sensitivity(n){this._inputBoost.gain.value=1/DA(n)}_setSweepRange(){this._sweepRange.min=this._baseFrequency,this._sweepRange.max=Math.min(this._baseFrequency*Math.pow(2,this._octaves),this.context.sampleRate/2)}dispose(){return super.dispose(),this._follower.dispose(),this._sweepRange.dispose(),this._bandpass.dispose(),this._peaking.dispose(),this._inputBoost.dispose(),this}}const bm="bit-crusher";vm(bm,`
	class BitCrusherWorklet extends SingleIOProcessor {

		static get parameterDescriptors() {
			return [{
				name: "bits",
				defaultValue: 12,
				minValue: 1,
				maxValue: 16,
				automationRate: 'k-rate'
			}];
		}

		generate(input, _channel, parameters) {
			const step = Math.pow(0.5, parameters.bits - 1);
			const val = step * Math.floor(input / step + 0.5);
			return val;
		}
	}
`);class $u extends Xe{constructor(){const n=rt($u.getDefaults(),arguments,["bits"]);super(n),this.name="BitCrusher",this._bitCrusherWorklet=new Xu({context:this.context,bits:n.bits}),this.connectEffect(this._bitCrusherWorklet),this.bits=this._bitCrusherWorklet.bits}static getDefaults(){return Object.assign(Xe.getDefaults(),{bits:4})}dispose(){return super.dispose(),this._bitCrusherWorklet.dispose(),this}}class Xu extends Nu{constructor(){const n=rt(Xu.getDefaults(),arguments);super(n),this.name="BitCrusherWorklet",this.input=new Tt({context:this.context}),this.output=new Tt({context:this.context}),this.bits=new Lt({context:this.context,value:n.bits,units:"positive",minValue:1,maxValue:16,param:this._dummyParam,swappable:!0})}static getDefaults(){return Object.assign(Nu.getDefaults(),{bits:12})}_audioWorkletName(){return bm}onReady(n){qs(this.input,n,this.output);const o=n.parameters.get("bits");this.bits.setParam(o)}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.bits.dispose(),this}}class Yu extends Xe{constructor(){const n=rt(Yu.getDefaults(),arguments,["order"]);super(n),this.name="Chebyshev",this._shaper=new Bn({context:this.context,length:4096}),this._order=n.order,this.connectEffect(this._shaper),this.order=n.order,this.oversample=n.oversample}static getDefaults(){return Object.assign(Xe.getDefaults(),{order:1,oversample:"none"})}_getCoefficient(n,o,c){return c.has(o)||(o===0?c.set(o,0):o===1?c.set(o,n):c.set(o,2*n*this._getCoefficient(n,o-1,c)-this._getCoefficient(n,o-2,c))),c.get(o)}get order(){return this._order}set order(n){It(Number.isInteger(n),"'order' must be an integer"),this._order=n,this._shaper.setMap((o=>this._getCoefficient(o,n,new Map)))}get oversample(){return this._shaper.oversample}set oversample(n){this._shaper.oversample=n}dispose(){return super.dispose(),this._shaper.dispose(),this}}class eA extends ht{constructor(){const n=rt(eA.getDefaults(),arguments,["channels"]);super(n),this.name="Split",this._splitter=this.input=this.output=this.context.createChannelSplitter(n.channels),this._internalChannels=[this._splitter]}static getDefaults(){return Object.assign(ht.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._splitter.disconnect(),this}}class bi extends ht{constructor(){const n=rt(bi.getDefaults(),arguments,["channels"]);super(n),this.name="Merge",this._merger=this.output=this.input=this.context.createChannelMerger(n.channels)}static getDefaults(){return Object.assign(ht.getDefaults(),{channels:2})}dispose(){return super.dispose(),this._merger.disconnect(),this}}class Dn extends ht{constructor(n){super(n),this.name="StereoEffect",this.input=new Tt({context:this.context}),this.input.channelCount=2,this.input.channelCountMode="explicit",this._dryWet=this.output=new $A({context:this.context,fade:n.wet}),this.wet=this._dryWet.fade,this._split=new eA({context:this.context,channels:2}),this._merge=new bi({context:this.context,channels:2}),this.input.connect(this._split),this.input.connect(this._dryWet.a),this._merge.connect(this._dryWet.b),Ut(this,["wet"])}connectEffectLeft(...n){this._split.connect(n[0],0,0),qs(...n),Es(n[n.length-1],this._merge,0,0)}connectEffectRight(...n){this._split.connect(n[0],1,0),qs(...n),Es(n[n.length-1],this._merge,0,1)}static getDefaults(){return Object.assign(ht.getDefaults(),{wet:1})}dispose(){return super.dispose(),this._dryWet.dispose(),this._split.dispose(),this._merge.dispose(),this}}class ju extends Dn{constructor(n){super(n),this.feedback=new Dt({context:this.context,value:n.feedback,units:"normalRange"}),this._feedbackL=new Tt({context:this.context}),this._feedbackR=new Tt({context:this.context}),this._feedbackSplit=new eA({context:this.context,channels:2}),this._feedbackMerge=new bi({context:this.context,channels:2}),this._merge.connect(this._feedbackSplit),this._feedbackMerge.connect(this._split),this._feedbackSplit.connect(this._feedbackL,0,0),this._feedbackL.connect(this._feedbackMerge,0,0),this._feedbackSplit.connect(this._feedbackR,1,0),this._feedbackR.connect(this._feedbackMerge,0,1),this.feedback.fan(this._feedbackL.gain,this._feedbackR.gain),Ut(this,["feedback"])}static getDefaults(){return Object.assign(Dn.getDefaults(),{feedback:.5})}dispose(){return super.dispose(),this.feedback.dispose(),this._feedbackL.dispose(),this._feedbackR.dispose(),this._feedbackSplit.dispose(),this._feedbackMerge.dispose(),this}}class Ju extends ju{constructor(){const n=rt(Ju.getDefaults(),arguments,["frequency","delayTime","depth"]);super(n),this.name="Chorus",this._depth=n.depth,this._delayTime=n.delayTime/1e3,this._lfoL=new Ss({context:this.context,frequency:n.frequency,min:0,max:1}),this._lfoR=new Ss({context:this.context,frequency:n.frequency,min:0,max:1,phase:180}),this._delayNodeL=new zs({context:this.context}),this._delayNodeR=new zs({context:this.context}),this.frequency=this._lfoL.frequency,Ut(this,["frequency"]),this._lfoL.frequency.connect(this._lfoR.frequency),this.connectEffectLeft(this._delayNodeL),this.connectEffectRight(this._delayNodeR),this._lfoL.connect(this._delayNodeL.delayTime),this._lfoR.connect(this._delayNodeR.delayTime),this.depth=this._depth,this.type=n.type,this.spread=n.spread}static getDefaults(){return Object.assign(ju.getDefaults(),{frequency:1.5,delayTime:3.5,depth:.7,type:"sine",spread:180,feedback:0,wet:.5})}get depth(){return this._depth}set depth(n){this._depth=n;const o=this._delayTime*n;this._lfoL.min=Math.max(this._delayTime-o,0),this._lfoL.max=this._delayTime+o,this._lfoR.min=Math.max(this._delayTime-o,0),this._lfoR.max=this._delayTime+o}get delayTime(){return 1e3*this._delayTime}set delayTime(n){this._delayTime=n/1e3,this.depth=this._depth}get type(){return this._lfoL.type}set type(n){this._lfoL.type=n,this._lfoR.type=n}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(n){this._lfoL.phase=90-n/2,this._lfoR.phase=n/2+90}start(n){return this._lfoL.start(n),this._lfoR.start(n),this}stop(n){return this._lfoL.stop(n),this._lfoR.stop(n),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._delayNodeL.dispose(),this._delayNodeR.dispose(),this.frequency.dispose(),this}}class Zu extends Xe{constructor(){const n=rt(Zu.getDefaults(),arguments,["distortion"]);super(n),this.name="Distortion",this._shaper=new Bn({context:this.context,length:4096}),this._distortion=n.distortion,this.connectEffect(this._shaper),this.distortion=n.distortion,this.oversample=n.oversample}static getDefaults(){return Object.assign(Xe.getDefaults(),{distortion:.4,oversample:"none"})}get distortion(){return this._distortion}set distortion(n){this._distortion=n;const o=100*n,c=Math.PI/180;this._shaper.setMap((f=>Math.abs(f)<.001?0:(3+o)*f*20*c/(Math.PI+o*Math.abs(f))))}get oversample(){return this._shaper.oversample}set oversample(n){this._shaper.oversample=n}dispose(){return super.dispose(),this._shaper.dispose(),this}}class Ya extends Xe{constructor(n){super(n),this.name="FeedbackEffect",this._feedbackGain=new Tt({context:this.context,gain:n.feedback,units:"normalRange"}),this.feedback=this._feedbackGain.gain,Ut(this,"feedback"),this.effectReturn.chain(this._feedbackGain,this.effectSend)}static getDefaults(){return Object.assign(Xe.getDefaults(),{feedback:.125})}dispose(){return super.dispose(),this._feedbackGain.dispose(),this.feedback.dispose(),this}}class th extends Ya{constructor(){const n=rt(th.getDefaults(),arguments,["delayTime","feedback"]);super(n),this.name="FeedbackDelay",this._delayNode=new zs({context:this.context,delayTime:n.delayTime,maxDelay:n.maxDelay}),this.delayTime=this._delayNode.delayTime,this.connectEffect(this._delayNode),Ut(this,"delayTime")}static getDefaults(){return Object.assign(Ya.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._delayNode.dispose(),this.delayTime.dispose(),this}}class eb extends ht{constructor(n){super(n),this.name="PhaseShiftAllpass",this.input=new Tt({context:this.context}),this.output=new Tt({context:this.context}),this.offset90=new Tt({context:this.context}),this._bank0=this._createAllPassFilterBank([.6923878,.9360654322959,.988229522686,.9987488452737]),this._bank1=this._createAllPassFilterBank([.4021921162426,.856171088242,.9722909545651,.9952884791278]),this._oneSampleDelay=this.context.createIIRFilter([0,1],[1,0]),qs(this.input,...this._bank0,this._oneSampleDelay,this.output),qs(this.input,...this._bank1,this.offset90)}_createAllPassFilterBank(n){return n.map((o=>{const c=[[o*o,0,-1],[1,0,-o*o]];return this.context.createIIRFilter(c[0],c[1])}))}dispose(){return super.dispose(),this.input.dispose(),this.output.dispose(),this.offset90.dispose(),this._bank0.forEach((n=>n.disconnect())),this._bank1.forEach((n=>n.disconnect())),this._oneSampleDelay.disconnect(),this}}class eh extends Xe{constructor(){const n=rt(eh.getDefaults(),arguments,["frequency"]);super(n),this.name="FrequencyShifter",this.frequency=new Dt({context:this.context,units:"frequency",value:n.frequency,minValue:-this.context.sampleRate/2,maxValue:this.context.sampleRate/2}),this._sine=new Wr({context:this.context,type:"sine"}),this._cosine=new Se({context:this.context,phase:-90,type:"sine"}),this._sineMultiply=new Fe({context:this.context}),this._cosineMultiply=new Fe({context:this.context}),this._negate=new Mu({context:this.context}),this._add=new Ji({context:this.context}),this._phaseShifter=new eb({context:this.context}),this.effectSend.connect(this._phaseShifter),this.frequency.fan(this._sine.frequency,this._cosine.frequency),this._phaseShifter.offset90.connect(this._cosineMultiply),this._cosine.connect(this._cosineMultiply.factor),this._phaseShifter.connect(this._sineMultiply),this._sine.connect(this._sineMultiply.factor),this._sineMultiply.connect(this._negate),this._cosineMultiply.connect(this._add),this._negate.connect(this._add.addend),this._add.connect(this.effectReturn);const o=this.immediate();this._sine.start(o),this._cosine.start(o)}static getDefaults(){return Object.assign(Xe.getDefaults(),{frequency:0})}dispose(){return super.dispose(),this.frequency.dispose(),this._add.dispose(),this._cosine.dispose(),this._cosineMultiply.dispose(),this._negate.dispose(),this._phaseShifter.dispose(),this._sine.dispose(),this._sineMultiply.dispose(),this}}const _m=[1557/44100,1617/44100,1491/44100,1422/44100,1277/44100,1356/44100,1188/44100,1116/44100],xm=[225,556,441,341];class sh extends Dn{constructor(){const n=rt(sh.getDefaults(),arguments,["roomSize","dampening"]);super(n),this.name="Freeverb",this._combFilters=[],this._allpassFiltersL=[],this._allpassFiltersR=[],this.roomSize=new Dt({context:this.context,value:n.roomSize,units:"normalRange"}),this._allpassFiltersL=xm.map((o=>{const c=this.context.createBiquadFilter();return c.type="allpass",c.frequency.value=o,c})),this._allpassFiltersR=xm.map((o=>{const c=this.context.createBiquadFilter();return c.type="allpass",c.frequency.value=o,c})),this._combFilters=_m.map(((o,c)=>{const f=new Zr({context:this.context,dampening:n.dampening,delayTime:o});return c<_m.length/2?this.connectEffectLeft(f,...this._allpassFiltersL):this.connectEffectRight(f,...this._allpassFiltersR),this.roomSize.connect(f.resonance),f})),Ut(this,["roomSize"])}static getDefaults(){return Object.assign(Dn.getDefaults(),{roomSize:.7,dampening:3e3})}get dampening(){return this._combFilters[0].dampening}set dampening(n){this._combFilters.forEach((o=>o.dampening=n))}dispose(){return super.dispose(),this._allpassFiltersL.forEach((n=>n.disconnect())),this._allpassFiltersR.forEach((n=>n.disconnect())),this._combFilters.forEach((n=>n.dispose())),this.roomSize.dispose(),this}}const Em=[.06748,.06404,.08212,.09004],sb=[.773,.802,.753,.733],nb=[347,113,37];class nh extends Dn{constructor(){const n=rt(nh.getDefaults(),arguments,["roomSize"]);super(n),this.name="JCReverb",this._allpassFilters=[],this._feedbackCombFilters=[],this.roomSize=new Dt({context:this.context,value:n.roomSize,units:"normalRange"}),this._scaleRoomSize=new ei({context:this.context,min:-.733,max:.197}),this._allpassFilters=nb.map((o=>{const c=this.context.createBiquadFilter();return c.type="allpass",c.frequency.value=o,c})),this._feedbackCombFilters=Em.map(((o,c)=>{const f=new jr({context:this.context,delayTime:o});return this._scaleRoomSize.connect(f.resonance),f.resonance.value=sb[c],c<Em.length/2?this.connectEffectLeft(...this._allpassFilters,f):this.connectEffectRight(...this._allpassFilters,f),f})),this.roomSize.connect(this._scaleRoomSize),Ut(this,["roomSize"])}static getDefaults(){return Object.assign(Dn.getDefaults(),{roomSize:.5})}dispose(){return super.dispose(),this._allpassFilters.forEach((n=>n.disconnect())),this._feedbackCombFilters.forEach((n=>n.dispose())),this.roomSize.dispose(),this._scaleRoomSize.dispose(),this}}class Sm extends ju{constructor(n){super(n),this._feedbackL.disconnect(),this._feedbackL.connect(this._feedbackMerge,0,1),this._feedbackR.disconnect(),this._feedbackR.connect(this._feedbackMerge,0,0),Ut(this,["feedback"])}}class ih extends Sm{constructor(){const n=rt(ih.getDefaults(),arguments,["delayTime","feedback"]);super(n),this.name="PingPongDelay",this._leftDelay=new zs({context:this.context,maxDelay:n.maxDelay}),this._rightDelay=new zs({context:this.context,maxDelay:n.maxDelay}),this._rightPreDelay=new zs({context:this.context,maxDelay:n.maxDelay}),this.delayTime=new Dt({context:this.context,units:"time",value:n.delayTime}),this.connectEffectLeft(this._leftDelay),this.connectEffectRight(this._rightPreDelay,this._rightDelay),this.delayTime.fan(this._leftDelay.delayTime,this._rightDelay.delayTime,this._rightPreDelay.delayTime),this._feedbackL.disconnect(),this._feedbackL.connect(this._rightDelay),Ut(this,["delayTime"])}static getDefaults(){return Object.assign(Sm.getDefaults(),{delayTime:.25,maxDelay:1})}dispose(){return super.dispose(),this._leftDelay.dispose(),this._rightDelay.dispose(),this._rightPreDelay.dispose(),this.delayTime.dispose(),this}}class Ah extends Ya{constructor(){const n=rt(Ah.getDefaults(),arguments,["pitch"]);super(n),this.name="PitchShift",this._frequency=new Dt({context:this.context}),this._delayA=new zs({maxDelay:1,context:this.context}),this._lfoA=new Ss({context:this.context,min:0,max:.1,type:"sawtooth"}).connect(this._delayA.delayTime),this._delayB=new zs({maxDelay:1,context:this.context}),this._lfoB=new Ss({context:this.context,min:0,max:.1,type:"sawtooth",phase:180}).connect(this._delayB.delayTime),this._crossFade=new $A({context:this.context}),this._crossFadeLFO=new Ss({context:this.context,min:0,max:1,type:"triangle",phase:90}).connect(this._crossFade.fade),this._feedbackDelay=new zs({delayTime:n.delayTime,context:this.context}),this.delayTime=this._feedbackDelay.delayTime,Ut(this,"delayTime"),this._pitch=n.pitch,this._windowSize=n.windowSize,this._delayA.connect(this._crossFade.a),this._delayB.connect(this._crossFade.b),this._frequency.fan(this._lfoA.frequency,this._lfoB.frequency,this._crossFadeLFO.frequency),this.effectSend.fan(this._delayA,this._delayB),this._crossFade.chain(this._feedbackDelay,this.effectReturn);const o=this.now();this._lfoA.start(o),this._lfoB.start(o),this._crossFadeLFO.start(o),this.windowSize=this._windowSize}static getDefaults(){return Object.assign(Ya.getDefaults(),{pitch:0,windowSize:.1,delayTime:0,feedback:0})}get pitch(){return this._pitch}set pitch(n){this._pitch=n;let o=0;n<0?(this._lfoA.min=0,this._lfoA.max=this._windowSize,this._lfoB.min=0,this._lfoB.max=this._windowSize,o=kA(n-1)+1):(this._lfoA.min=this._windowSize,this._lfoA.max=0,this._lfoB.min=this._windowSize,this._lfoB.max=0,o=kA(n)-1),this._frequency.value=o*(1.2/this._windowSize)}get windowSize(){return this._windowSize}set windowSize(n){this._windowSize=this.toSeconds(n),this.pitch=this._pitch}dispose(){return super.dispose(),this._frequency.dispose(),this._delayA.dispose(),this._delayB.dispose(),this._lfoA.dispose(),this._lfoB.dispose(),this._crossFade.dispose(),this._crossFadeLFO.dispose(),this._feedbackDelay.dispose(),this}}class rh extends Dn{constructor(){const n=rt(rh.getDefaults(),arguments,["frequency","octaves","baseFrequency"]);super(n),this.name="Phaser",this._lfoL=new Ss({context:this.context,frequency:n.frequency,min:0,max:1}),this._lfoR=new Ss({context:this.context,frequency:n.frequency,min:0,max:1,phase:180}),this._baseFrequency=this.toFrequency(n.baseFrequency),this._octaves=n.octaves,this.Q=new Dt({context:this.context,value:n.Q,units:"positive"}),this._filtersL=this._makeFilters(n.stages,this._lfoL),this._filtersR=this._makeFilters(n.stages,this._lfoR),this.frequency=this._lfoL.frequency,this.frequency.value=n.frequency,this.connectEffectLeft(...this._filtersL),this.connectEffectRight(...this._filtersR),this._lfoL.frequency.connect(this._lfoR.frequency),this.baseFrequency=n.baseFrequency,this.octaves=n.octaves,this._lfoL.start(),this._lfoR.start(),Ut(this,["frequency","Q"])}static getDefaults(){return Object.assign(Dn.getDefaults(),{frequency:.5,octaves:3,stages:10,Q:10,baseFrequency:350})}_makeFilters(n,o){const c=[];for(let f=0;f<n;f++){const v=this.context.createBiquadFilter();v.type="allpass",this.Q.connect(v.Q),o.connect(v.frequency),c.push(v)}return c}get octaves(){return this._octaves}set octaves(n){this._octaves=n;const o=this._baseFrequency*Math.pow(2,n);this._lfoL.max=o,this._lfoR.max=o}get baseFrequency(){return this._baseFrequency}set baseFrequency(n){this._baseFrequency=this.toFrequency(n),this._lfoL.min=this._baseFrequency,this._lfoR.min=this._baseFrequency,this.octaves=this._octaves}dispose(){return super.dispose(),this.Q.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._filtersL.forEach((n=>n.disconnect())),this._filtersR.forEach((n=>n.disconnect())),this.frequency.dispose(),this}}class oh extends Xe{constructor(){const n=rt(oh.getDefaults(),arguments,["decay"]);super(n),this.name="Reverb",this._convolver=this.context.createConvolver(),this.ready=Promise.resolve(),this._decay=n.decay,this._preDelay=n.preDelay,this.generate(),this.connectEffect(this._convolver)}static getDefaults(){return Object.assign(Xe.getDefaults(),{decay:1.5,preDelay:.01})}get decay(){return this._decay}set decay(n){cs(n=this.toSeconds(n),.001),this._decay=n,this.generate()}get preDelay(){return this._preDelay}set preDelay(n){cs(n=this.toSeconds(n),0),this._preDelay=n,this.generate()}generate(){return fe(this,void 0,void 0,(function*(){const n=this.ready,o=new PA(2,this._decay+this._preDelay,this.context.sampleRate),c=new yi({context:o}),f=new yi({context:o}),v=new bi({context:o});c.connect(v,0,0),f.connect(v,0,1);const B=new Tt({context:o}).toDestination();v.connect(B),c.start(0),f.start(0),B.gain.setValueAtTime(0,0),B.gain.setValueAtTime(1,this._preDelay),B.gain.exponentialApproachValueAtTime(0,this._preDelay,this.decay);const _=o.render();return this.ready=_.then(Xt),yield n,this._convolver.buffer=(yield _).get(),this}))}dispose(){return super.dispose(),this._convolver.disconnect(),this}}class ro extends ht{constructor(){super(rt(ro.getDefaults(),arguments)),this.name="MidSideSplit",this._split=this.input=new eA({channels:2,context:this.context}),this._midAdd=new Ji({context:this.context}),this.mid=new Fe({context:this.context,value:Math.SQRT1_2}),this._sideSubtract=new Zi({context:this.context}),this.side=new Fe({context:this.context,value:Math.SQRT1_2}),this._split.connect(this._midAdd,0),this._split.connect(this._midAdd.addend,1),this._split.connect(this._sideSubtract,0),this._split.connect(this._sideSubtract.subtrahend,1),this._midAdd.connect(this.mid),this._sideSubtract.connect(this.side)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midAdd.dispose(),this._sideSubtract.dispose(),this._split.dispose(),this}}class oo extends ht{constructor(){super(rt(oo.getDefaults(),arguments)),this.name="MidSideMerge",this.mid=new Tt({context:this.context}),this.side=new Tt({context:this.context}),this._left=new Ji({context:this.context}),this._leftMult=new Fe({context:this.context,value:Math.SQRT1_2}),this._right=new Zi({context:this.context}),this._rightMult=new Fe({context:this.context,value:Math.SQRT1_2}),this._merge=this.output=new bi({context:this.context}),this.mid.fan(this._left),this.side.connect(this._left.addend),this.mid.connect(this._right),this.side.connect(this._right.subtrahend),this._left.connect(this._leftMult),this._right.connect(this._rightMult),this._leftMult.connect(this._merge,0,0),this._rightMult.connect(this._merge,0,1)}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._leftMult.dispose(),this._rightMult.dispose(),this._left.dispose(),this._right.dispose(),this}}class Fm extends Xe{constructor(n){super(n),this.name="MidSideEffect",this._midSideMerge=new oo({context:this.context}),this._midSideSplit=new ro({context:this.context}),this._midSend=this._midSideSplit.mid,this._sideSend=this._midSideSplit.side,this._midReturn=this._midSideMerge.mid,this._sideReturn=this._midSideMerge.side,this.effectSend.connect(this._midSideSplit),this._midSideMerge.connect(this.effectReturn)}connectEffectMid(...n){this._midSend.chain(...n,this._midReturn)}connectEffectSide(...n){this._sideSend.chain(...n,this._sideReturn)}dispose(){return super.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this._midSend.dispose(),this._sideSend.dispose(),this._midReturn.dispose(),this._sideReturn.dispose(),this}}class ah extends Fm{constructor(){const n=rt(ah.getDefaults(),arguments,["width"]);super(n),this.name="StereoWidener",this.width=new Dt({context:this.context,value:n.width,units:"normalRange"}),Ut(this,["width"]),this._twoTimesWidthMid=new Fe({context:this.context,value:2}),this._twoTimesWidthSide=new Fe({context:this.context,value:2}),this._midMult=new Fe({context:this.context}),this._twoTimesWidthMid.connect(this._midMult.factor),this.connectEffectMid(this._midMult),this._oneMinusWidth=new Zi({context:this.context}),this._oneMinusWidth.connect(this._twoTimesWidthMid),Es(this.context.getConstant(1),this._oneMinusWidth),this.width.connect(this._oneMinusWidth.subtrahend),this._sideMult=new Fe({context:this.context}),this.width.connect(this._twoTimesWidthSide),this._twoTimesWidthSide.connect(this._sideMult.factor),this.connectEffectSide(this._sideMult)}static getDefaults(){return Object.assign(Fm.getDefaults(),{width:.5})}dispose(){return super.dispose(),this.width.dispose(),this._midMult.dispose(),this._sideMult.dispose(),this._twoTimesWidthMid.dispose(),this._twoTimesWidthSide.dispose(),this._oneMinusWidth.dispose(),this}}class lh extends Dn{constructor(){const n=rt(lh.getDefaults(),arguments,["frequency","depth"]);super(n),this.name="Tremolo",this._lfoL=new Ss({context:this.context,type:n.type,min:1,max:0}),this._lfoR=new Ss({context:this.context,type:n.type,min:1,max:0}),this._amplitudeL=new Tt({context:this.context}),this._amplitudeR=new Tt({context:this.context}),this.frequency=new Dt({context:this.context,value:n.frequency,units:"frequency"}),this.depth=new Dt({context:this.context,value:n.depth,units:"normalRange"}),Ut(this,["frequency","depth"]),this.connectEffectLeft(this._amplitudeL),this.connectEffectRight(this._amplitudeR),this._lfoL.connect(this._amplitudeL.gain),this._lfoR.connect(this._amplitudeR.gain),this.frequency.fan(this._lfoL.frequency,this._lfoR.frequency),this.depth.fan(this._lfoR.amplitude,this._lfoL.amplitude),this.spread=n.spread}static getDefaults(){return Object.assign(Dn.getDefaults(),{frequency:10,type:"sine",depth:.5,spread:180})}start(n){return this._lfoL.start(n),this._lfoR.start(n),this}stop(n){return this._lfoL.stop(n),this._lfoR.stop(n),this}sync(){return this._lfoL.sync(),this._lfoR.sync(),this.context.transport.syncSignal(this.frequency),this}unsync(){return this._lfoL.unsync(),this._lfoR.unsync(),this.context.transport.unsyncSignal(this.frequency),this}get type(){return this._lfoL.type}set type(n){this._lfoL.type=n,this._lfoR.type=n}get spread(){return this._lfoR.phase-this._lfoL.phase}set spread(n){this._lfoL.phase=90-n/2,this._lfoR.phase=n/2+90}dispose(){return super.dispose(),this._lfoL.dispose(),this._lfoR.dispose(),this._amplitudeL.dispose(),this._amplitudeR.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class ch extends Xe{constructor(){const n=rt(ch.getDefaults(),arguments,["frequency","depth"]);super(n),this.name="Vibrato",this._delayNode=new zs({context:this.context,delayTime:0,maxDelay:n.maxDelay}),this._lfo=new Ss({context:this.context,type:n.type,min:0,max:n.maxDelay,frequency:n.frequency,phase:-90}).start().connect(this._delayNode.delayTime),this.frequency=this._lfo.frequency,this.depth=this._lfo.amplitude,this.depth.value=n.depth,Ut(this,["frequency","depth"]),this.effectSend.chain(this._delayNode,this.effectReturn)}static getDefaults(){return Object.assign(Xe.getDefaults(),{maxDelay:.005,frequency:5,depth:.1,type:"sine"})}get type(){return this._lfo.type}set type(n){this._lfo.type=n}dispose(){return super.dispose(),this._delayNode.dispose(),this._lfo.dispose(),this.frequency.dispose(),this.depth.dispose(),this}}class ao extends ht{constructor(){const n=rt(ao.getDefaults(),arguments,["type","size"]);super(n),this.name="Analyser",this._analysers=[],this._buffers=[],this.input=this.output=this._gain=new Tt({context:this.context}),this._split=new eA({context:this.context,channels:n.channels}),this.input.connect(this._split),cs(n.channels,1);for(let o=0;o<n.channels;o++)this._analysers[o]=this.context.createAnalyser(),this._split.connect(this._analysers[o],o,0);this.size=n.size,this.type=n.type,this.smoothing=n.smoothing}static getDefaults(){return Object.assign(ht.getDefaults(),{size:1024,smoothing:.8,type:"fft",channels:1})}getValue(){return this._analysers.forEach(((n,o)=>{const c=this._buffers[o];this._type==="fft"?n.getFloatFrequencyData(c):this._type==="waveform"&&n.getFloatTimeDomainData(c)})),this.channels===1?this._buffers[0]:this._buffers}get size(){return this._analysers[0].frequencyBinCount}set size(n){this._analysers.forEach(((o,c)=>{o.fftSize=2*n,this._buffers[c]=new Float32Array(n)}))}get channels(){return this._analysers.length}get type(){return this._type}set type(n){It(n==="waveform"||n==="fft",`Analyser: invalid type: ${n}`),this._type=n}get smoothing(){return this._analysers[0].smoothingTimeConstant}set smoothing(n){this._analysers.forEach((o=>o.smoothingTimeConstant=n))}dispose(){return super.dispose(),this._analysers.forEach((n=>n.disconnect())),this._split.dispose(),this._gain.dispose(),this}}class _i extends ht{constructor(){super(rt(_i.getDefaults(),arguments)),this.name="MeterBase",this.input=this.output=this._analyser=new ao({context:this.context,size:256,type:"waveform"})}dispose(){return super.dispose(),this._analyser.dispose(),this}}class uh extends _i{constructor(){const n=rt(uh.getDefaults(),arguments,["smoothing"]);super(n),this.name="Meter",this.input=this.output=this._analyser=new ao({context:this.context,size:256,type:"waveform",channels:n.channelCount}),this.smoothing=n.smoothing,this.normalRange=n.normalRange,this._rms=new Array(n.channelCount),this._rms.fill(0)}static getDefaults(){return Object.assign(_i.getDefaults(),{smoothing:.8,normalRange:!1,channelCount:1})}getLevel(){return TA("'getLevel' has been changed to 'getValue'"),this.getValue()}getValue(){const n=this._analyser.getValue(),o=(this.channels===1?[n]:n).map(((c,f)=>{const v=c.reduce(((_,S)=>_+S*S),0),B=Math.sqrt(v/c.length);return this._rms[f]=Math.max(B,this._rms[f]*this.smoothing),this.normalRange?this._rms[f]:Nr(this._rms[f])}));return this.channels===1?o[0]:o}get channels(){return this._analyser.channels}dispose(){return super.dispose(),this._analyser.dispose(),this}}class hh extends _i{constructor(){const n=rt(hh.getDefaults(),arguments,["size"]);super(n),this.name="FFT",this.normalRange=n.normalRange,this._analyser.type="fft",this.size=n.size}static getDefaults(){return Object.assign(ht.getDefaults(),{normalRange:!1,size:1024,smoothing:.8})}getValue(){return this._analyser.getValue().map((n=>this.normalRange?DA(n):n))}get size(){return this._analyser.size}set size(n){this._analyser.size=n}get smoothing(){return this._analyser.smoothing}set smoothing(n){this._analyser.smoothing=n}getFrequencyOfIndex(n){return It(0<=n&&n<this.size,`index must be greater than or equal to 0 and less than ${this.size}`),n*this.context.sampleRate/(2*this.size)}}class dh extends _i{constructor(){super(rt(dh.getDefaults(),arguments)),this.name="DCMeter",this._analyser.type="waveform",this._analyser.size=256}getValue(){return this._analyser.getValue()[0]}}class fh extends _i{constructor(){const n=rt(fh.getDefaults(),arguments,["size"]);super(n),this.name="Waveform",this._analyser.type="waveform",this.size=n.size}static getDefaults(){return Object.assign(_i.getDefaults(),{size:1024})}getValue(){return this._analyser.getValue()}get size(){return this._analyser.size}set size(n){this._analyser.size=n}}class Ne extends ht{constructor(){const n=rt(Ne.getDefaults(),arguments,["solo"]);super(n),this.name="Solo",this.input=this.output=new Tt({context:this.context}),Ne._allSolos.has(this.context)||Ne._allSolos.set(this.context,new Set),Ne._allSolos.get(this.context).add(this),this.solo=n.solo}static getDefaults(){return Object.assign(ht.getDefaults(),{solo:!1})}get solo(){return this._isSoloed()}set solo(n){n?this._addSolo():this._removeSolo(),Ne._allSolos.get(this.context).forEach((o=>o._updateSolo()))}get muted(){return this.input.gain.value===0}_addSolo(){Ne._soloed.has(this.context)||Ne._soloed.set(this.context,new Set),Ne._soloed.get(this.context).add(this)}_removeSolo(){Ne._soloed.has(this.context)&&Ne._soloed.get(this.context).delete(this)}_isSoloed(){return Ne._soloed.has(this.context)&&Ne._soloed.get(this.context).has(this)}_noSolos(){return!Ne._soloed.has(this.context)||Ne._soloed.has(this.context)&&Ne._soloed.get(this.context).size===0}_updateSolo(){this._isSoloed()||this._noSolos()?this.input.gain.value=1:this.input.gain.value=0}dispose(){return super.dispose(),Ne._allSolos.get(this.context).delete(this),this._removeSolo(),this}}Ne._allSolos=new Map,Ne._soloed=new Map;class ja extends ht{constructor(){const n=rt(ja.getDefaults(),arguments,["pan","volume"]);super(n),this.name="PanVol",this._panner=this.input=new io({context:this.context,pan:n.pan,channelCount:n.channelCount}),this.pan=this._panner.pan,this._volume=this.output=new Jn({context:this.context,volume:n.volume}),this.volume=this._volume.volume,this._panner.connect(this._volume),this.mute=n.mute,Ut(this,["pan","volume"])}static getDefaults(){return Object.assign(ht.getDefaults(),{mute:!1,pan:0,volume:0,channelCount:1})}get mute(){return this._volume.mute}set mute(n){this._volume.mute=n}dispose(){return super.dispose(),this._panner.dispose(),this.pan.dispose(),this._volume.dispose(),this.volume.dispose(),this}}class sA extends ht{constructor(){const n=rt(sA.getDefaults(),arguments,["volume","pan"]);super(n),this.name="Channel",this._solo=this.input=new Ne({solo:n.solo,context:this.context}),this._panVol=this.output=new ja({context:this.context,pan:n.pan,volume:n.volume,mute:n.mute,channelCount:n.channelCount}),this.pan=this._panVol.pan,this.volume=this._panVol.volume,this._solo.connect(this._panVol),Ut(this,["pan","volume"])}static getDefaults(){return Object.assign(ht.getDefaults(),{pan:0,volume:0,mute:!1,solo:!1,channelCount:1})}get solo(){return this._solo.solo}set solo(n){this._solo.solo=n}get muted(){return this._solo.muted||this.mute}get mute(){return this._panVol.mute}set mute(n){this._panVol.mute=n}_getBus(n){return sA.buses.has(n)||sA.buses.set(n,new Tt({context:this.context})),sA.buses.get(n)}send(n,o=0){const c=this._getBus(n),f=new Tt({context:this.context,units:"decibels",gain:o});return this.connect(f),f.connect(c),f}receive(n){return this._getBus(n).connect(this),this}dispose(){return super.dispose(),this._panVol.dispose(),this.pan.dispose(),this.volume.dispose(),this._solo.dispose(),this}}sA.buses=new Map;class ph extends ht{constructor(){super(rt(ph.getDefaults(),arguments)),this.name="Mono",this.input=new Tt({context:this.context}),this._merge=this.output=new bi({channels:2,context:this.context}),this.input.connect(this._merge,0,0),this.input.connect(this._merge,0,1)}dispose(){return super.dispose(),this._merge.dispose(),this.input.dispose(),this}}class lo extends ht{constructor(){const n=rt(lo.getDefaults(),arguments,["lowFrequency","highFrequency"]);super(n),this.name="MultibandSplit",this.input=new Tt({context:this.context}),this.output=void 0,this.low=new Xs({context:this.context,frequency:0,type:"lowpass"}),this._lowMidFilter=new Xs({context:this.context,frequency:0,type:"highpass"}),this.mid=new Xs({context:this.context,frequency:0,type:"lowpass"}),this.high=new Xs({context:this.context,frequency:0,type:"highpass"}),this._internalChannels=[this.low,this.mid,this.high],this.lowFrequency=new Dt({context:this.context,units:"frequency",value:n.lowFrequency}),this.highFrequency=new Dt({context:this.context,units:"frequency",value:n.highFrequency}),this.Q=new Dt({context:this.context,units:"positive",value:n.Q}),this.input.fan(this.low,this.high),this.input.chain(this._lowMidFilter,this.mid),this.lowFrequency.fan(this.low.frequency,this._lowMidFilter.frequency),this.highFrequency.fan(this.mid.frequency,this.high.frequency),this.Q.connect(this.low.Q),this.Q.connect(this._lowMidFilter.Q),this.Q.connect(this.mid.Q),this.Q.connect(this.high.Q),Ut(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(ht.getDefaults(),{Q:1,highFrequency:2500,lowFrequency:400})}dispose(){return super.dispose(),Rr(this,["high","mid","low","highFrequency","lowFrequency"]),this.low.dispose(),this._lowMidFilter.dispose(),this.mid.dispose(),this.high.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this.Q.dispose(),this}}class mh extends ht{constructor(){const n=rt(mh.getDefaults(),arguments,["positionX","positionY","positionZ"]);super(n),this.name="Panner3D",this._panner=this.input=this.output=this.context.createPanner(),this.panningModel=n.panningModel,this.maxDistance=n.maxDistance,this.distanceModel=n.distanceModel,this.coneOuterGain=n.coneOuterGain,this.coneOuterAngle=n.coneOuterAngle,this.coneInnerAngle=n.coneInnerAngle,this.refDistance=n.refDistance,this.rolloffFactor=n.rolloffFactor,this.positionX=new Lt({context:this.context,param:this._panner.positionX,value:n.positionX}),this.positionY=new Lt({context:this.context,param:this._panner.positionY,value:n.positionY}),this.positionZ=new Lt({context:this.context,param:this._panner.positionZ,value:n.positionZ}),this.orientationX=new Lt({context:this.context,param:this._panner.orientationX,value:n.orientationX}),this.orientationY=new Lt({context:this.context,param:this._panner.orientationY,value:n.orientationY}),this.orientationZ=new Lt({context:this.context,param:this._panner.orientationZ,value:n.orientationZ})}static getDefaults(){return Object.assign(ht.getDefaults(),{coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0,distanceModel:"inverse",maxDistance:1e4,orientationX:0,orientationY:0,orientationZ:0,panningModel:"equalpower",positionX:0,positionY:0,positionZ:0,refDistance:1,rolloffFactor:1})}setPosition(n,o,c){return this.positionX.value=n,this.positionY.value=o,this.positionZ.value=c,this}setOrientation(n,o,c){return this.orientationX.value=n,this.orientationY.value=o,this.orientationZ.value=c,this}get panningModel(){return this._panner.panningModel}set panningModel(n){this._panner.panningModel=n}get refDistance(){return this._panner.refDistance}set refDistance(n){this._panner.refDistance=n}get rolloffFactor(){return this._panner.rolloffFactor}set rolloffFactor(n){this._panner.rolloffFactor=n}get distanceModel(){return this._panner.distanceModel}set distanceModel(n){this._panner.distanceModel=n}get coneInnerAngle(){return this._panner.coneInnerAngle}set coneInnerAngle(n){this._panner.coneInnerAngle=n}get coneOuterAngle(){return this._panner.coneOuterAngle}set coneOuterAngle(n){this._panner.coneOuterAngle=n}get coneOuterGain(){return this._panner.coneOuterGain}set coneOuterGain(n){this._panner.coneOuterGain=n}get maxDistance(){return this._panner.maxDistance}set maxDistance(n){this._panner.maxDistance=n}dispose(){return super.dispose(),this._panner.disconnect(),this.orientationX.dispose(),this.orientationY.dispose(),this.orientationZ.dispose(),this.positionX.dispose(),this.positionY.dispose(),this.positionZ.dispose(),this}}class Ja extends ht{constructor(){const n=rt(Ja.getDefaults(),arguments);super(n),this.name="Recorder",this.input=new Tt({context:this.context}),It(Ja.supported,"Media Recorder API is not available"),this._stream=this.context.createMediaStreamDestination(),this.input.connect(this._stream),this._recorder=new MediaRecorder(this._stream.stream,{mimeType:n.mimeType})}static getDefaults(){return ht.getDefaults()}get mimeType(){return this._recorder.mimeType}static get supported(){return Ws!==null&&Reflect.has(Ws,"MediaRecorder")}get state(){return this._recorder.state==="inactive"?"stopped":this._recorder.state==="paused"?"paused":"started"}start(){return fe(this,void 0,void 0,(function*(){It(this.state!=="started","Recorder is already started");const n=new Promise((o=>{const c=()=>{this._recorder.removeEventListener("start",c,!1),o()};this._recorder.addEventListener("start",c,!1)}));return this._recorder.start(),yield n}))}stop(){return fe(this,void 0,void 0,(function*(){It(this.state!=="stopped","Recorder is not started");const n=new Promise((o=>{const c=f=>{this._recorder.removeEventListener("dataavailable",c,!1),o(f.data)};this._recorder.addEventListener("dataavailable",c,!1)}));return this._recorder.stop(),yield n}))}pause(){return It(this.state==="started","Recorder must be started"),this._recorder.pause(),this}dispose(){return super.dispose(),this.input.dispose(),this._stream.disconnect(),this}}class ni extends ht{constructor(){const n=rt(ni.getDefaults(),arguments,["threshold","ratio"]);super(n),this.name="Compressor",this._compressor=this.context.createDynamicsCompressor(),this.input=this._compressor,this.output=this._compressor,this.threshold=new Lt({minValue:this._compressor.threshold.minValue,maxValue:this._compressor.threshold.maxValue,context:this.context,convert:!1,param:this._compressor.threshold,units:"decibels",value:n.threshold}),this.attack=new Lt({minValue:this._compressor.attack.minValue,maxValue:this._compressor.attack.maxValue,context:this.context,param:this._compressor.attack,units:"time",value:n.attack}),this.release=new Lt({minValue:this._compressor.release.minValue,maxValue:this._compressor.release.maxValue,context:this.context,param:this._compressor.release,units:"time",value:n.release}),this.knee=new Lt({minValue:this._compressor.knee.minValue,maxValue:this._compressor.knee.maxValue,context:this.context,convert:!1,param:this._compressor.knee,units:"decibels",value:n.knee}),this.ratio=new Lt({minValue:this._compressor.ratio.minValue,maxValue:this._compressor.ratio.maxValue,context:this.context,convert:!1,param:this._compressor.ratio,units:"positive",value:n.ratio}),Ut(this,["knee","release","attack","ratio","threshold"])}static getDefaults(){return Object.assign(ht.getDefaults(),{attack:.003,knee:30,ratio:12,release:.25,threshold:-24})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.disconnect(),this.attack.dispose(),this.release.dispose(),this.threshold.dispose(),this.ratio.dispose(),this.knee.dispose(),this}}class gh extends ht{constructor(){const n=rt(gh.getDefaults(),arguments,["threshold","smoothing"]);super(n),this.name="Gate",this._follower=new Ao({context:this.context,smoothing:n.smoothing}),this._gt=new qa({context:this.context,value:DA(n.threshold)}),this.input=new Tt({context:this.context}),this._gate=this.output=new Tt({context:this.context}),this.input.connect(this._gate),this.input.chain(this._follower,this._gt,this._gate.gain)}static getDefaults(){return Object.assign(ht.getDefaults(),{smoothing:.1,threshold:-40})}get threshold(){return Nr(this._gt.value)}set threshold(n){this._gt.value=DA(n)}get smoothing(){return this._follower.smoothing}set smoothing(n){this._follower.smoothing=n}dispose(){return super.dispose(),this.input.dispose(),this._follower.dispose(),this._gt.dispose(),this._gate.dispose(),this}}class wh extends ht{constructor(){const n=rt(wh.getDefaults(),arguments,["threshold"]);super(n),this.name="Limiter",this._compressor=this.input=this.output=new ni({context:this.context,ratio:20,attack:.003,release:.01,threshold:n.threshold}),this.threshold=this._compressor.threshold,Ut(this,"threshold")}static getDefaults(){return Object.assign(ht.getDefaults(),{threshold:-12})}get reduction(){return this._compressor.reduction}dispose(){return super.dispose(),this._compressor.dispose(),this.threshold.dispose(),this}}class vh extends ht{constructor(){const n=rt(vh.getDefaults(),arguments);super(n),this.name="MidSideCompressor",this._midSideSplit=this.input=new ro({context:this.context}),this._midSideMerge=this.output=new oo({context:this.context}),this.mid=new ni(Object.assign(n.mid,{context:this.context})),this.side=new ni(Object.assign(n.side,{context:this.context})),this._midSideSplit.mid.chain(this.mid,this._midSideMerge.mid),this._midSideSplit.side.chain(this.side,this._midSideMerge.side),Ut(this,["mid","side"])}static getDefaults(){return Object.assign(ht.getDefaults(),{mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},side:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10}})}dispose(){return super.dispose(),this.mid.dispose(),this.side.dispose(),this._midSideSplit.dispose(),this._midSideMerge.dispose(),this}}class Bh extends ht{constructor(){const n=rt(Bh.getDefaults(),arguments);super(n),this.name="MultibandCompressor",this._splitter=this.input=new lo({context:this.context,lowFrequency:n.lowFrequency,highFrequency:n.highFrequency}),this.lowFrequency=this._splitter.lowFrequency,this.highFrequency=this._splitter.highFrequency,this.output=new Tt({context:this.context}),this.low=new ni(Object.assign(n.low,{context:this.context})),this.mid=new ni(Object.assign(n.mid,{context:this.context})),this.high=new ni(Object.assign(n.high,{context:this.context})),this._splitter.low.chain(this.low,this.output),this._splitter.mid.chain(this.mid,this.output),this._splitter.high.chain(this.high,this.output),Ut(this,["high","mid","low","highFrequency","lowFrequency"])}static getDefaults(){return Object.assign(ht.getDefaults(),{lowFrequency:250,highFrequency:2e3,low:{ratio:6,threshold:-30,release:.25,attack:.03,knee:10},mid:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16},high:{ratio:3,threshold:-24,release:.03,attack:.02,knee:16}})}dispose(){return super.dispose(),this._splitter.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.output.dispose(),this}}class yh extends ht{constructor(){const n=rt(yh.getDefaults(),arguments,["low","mid","high"]);super(n),this.name="EQ3",this.output=new Tt({context:this.context}),this._internalChannels=[],this.input=this._multibandSplit=new lo({context:this.context,highFrequency:n.highFrequency,lowFrequency:n.lowFrequency}),this._lowGain=new Tt({context:this.context,gain:n.low,units:"decibels"}),this._midGain=new Tt({context:this.context,gain:n.mid,units:"decibels"}),this._highGain=new Tt({context:this.context,gain:n.high,units:"decibels"}),this.low=this._lowGain.gain,this.mid=this._midGain.gain,this.high=this._highGain.gain,this.Q=this._multibandSplit.Q,this.lowFrequency=this._multibandSplit.lowFrequency,this.highFrequency=this._multibandSplit.highFrequency,this._multibandSplit.low.chain(this._lowGain,this.output),this._multibandSplit.mid.chain(this._midGain,this.output),this._multibandSplit.high.chain(this._highGain,this.output),Ut(this,["low","mid","high","lowFrequency","highFrequency"]),this._internalChannels=[this._multibandSplit]}static getDefaults(){return Object.assign(ht.getDefaults(),{high:0,highFrequency:2500,low:0,lowFrequency:400,mid:0})}dispose(){return super.dispose(),Rr(this,["low","mid","high","lowFrequency","highFrequency"]),this._multibandSplit.dispose(),this.lowFrequency.dispose(),this.highFrequency.dispose(),this._lowGain.dispose(),this._midGain.dispose(),this._highGain.dispose(),this.low.dispose(),this.mid.dispose(),this.high.dispose(),this.Q.dispose(),this}}class Ch extends ht{constructor(){const n=rt(Ch.getDefaults(),arguments,["url","onload"]);super(n),this.name="Convolver",this._convolver=this.context.createConvolver(),this._buffer=new te(n.url,(o=>{this.buffer=o,n.onload()})),this.input=new Tt({context:this.context}),this.output=new Tt({context:this.context}),this._buffer.loaded&&(this.buffer=this._buffer),this.normalize=n.normalize,this.input.chain(this._convolver,this.output)}static getDefaults(){return Object.assign(ht.getDefaults(),{normalize:!0,onload:Xt})}load(n){return fe(this,void 0,void 0,(function*(){this.buffer=yield this._buffer.load(n)}))}get buffer(){return this._buffer.length?this._buffer:null}set buffer(n){n&&this._buffer.set(n),this._convolver.buffer&&(this.input.disconnect(),this._convolver.disconnect(),this._convolver=this.context.createConvolver(),this.input.chain(this._convolver,this.output));const o=this._buffer.get();this._convolver.buffer=o||null}get normalize(){return this._convolver.normalize}set normalize(n){this._convolver.normalize=n}dispose(){return super.dispose(),this._buffer.dispose(),this._convolver.disconnect(),this}}function ib(){return Be().now()}function Ab(){return Be().immediate()}const rb=Be().transport;function ob(){return Be().transport}const ab=Be().destination,lb=Be().destination;function cb(){return Be().destination}const ub=Be().listener;function hb(){return Be().listener}const db=Be().draw;function fb(){return Be().draw}const pb=Be();function mb(){return te.loaded()}const gb=te,wb=NA,vb=Bi})(),r})()))})(Rl)),Rl.exports}var Z=xb();const Mm=new Array(19).fill(2),Eb=["anacrusis","anacrusis","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid"],Cd=new Array(16).fill(2),ev=["dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed","solid","dashed","dashed","dashed"];function Sb(){return{hasAnacrusis:!1,macrobeatGroupings:[...Cd],macrobeatBoundaryStyles:[...ev],baseMicrobeatPx:40,modulationMarkers:[]}}const uA=12,Fb=50,Tb=.52,Ib=.5,tl=3,el=1,na=30,ia=.5,Um=3,co=8,mr=.25,Qb=1.25,Pm=.8,Mb=.7,Ub=.9,Pb=4,Db=1.5,kb=.15,Lb=.2,Rb=1,sv=1.5,Hb="#CCCCCC",nv=1,Dm=3,km=5,Nb=7,Hl=16,Ob=0,Vb=255,iv=()=>({enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0}),Wb=()=>({speed:0,span:0}),Kb=()=>({speed:0,span:0}),Gb={"#4a90e2":{primary:"#4a90e2",light:"#63a9fd"},"#68a03f":{primary:"#68a03f",light:"#80b958"},"#d66573":{primary:"#d66573",light:"#f27e8b"},"#2d2d2d":{primary:"#2d2d2d",light:"#424242"}};function Lm(){const s=t=>{const e=new Float32Array(uA).fill(0),i=new Float32Array(uA).fill(0);return e[0]=1,{name:t,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},coeffs:e,phases:i,activePresetName:"sine",gain:1,filter:iv(),vibrato:Wb(),tremelo:Kb()}};return{timbres:{"#4a90e2":s("Blue"),"#2d2d2d":s("Black"),"#d66573":s("Red"),"#68a03f":s("Green")},colorPalette:Gb}}function qb(){return{isMicPaintActive:!1,isDetecting:!1,detectedPitch:{frequency:0,clarity:0,midi:0,pitchClass:0},paintHistory:[],paintSettings:{thickness:6,opacity:80,minClarity:.1,colorMode:"chromatic",playbackEnabled:!0}}}const me=[{pitch:"C8",flatName:"C8",sharpName:"C8",toneNote:"C8",frequency:4186.01,column:"A",hex:"#fef1f5",isAccidental:!1},{pitch:"B7",flatName:"B7",sharpName:"B7",toneNote:"B7",frequency:3951.07,column:"B",hex:"#fbf2fa",isAccidental:!1},{pitch:"B/A7",flatName:"B7",sharpName:"A7",toneNote:"Bb7",frequency:3729.31,column:"A",hex:"#f6f3fd",isAccidental:!0},{pitch:"A7",flatName:"A7",sharpName:"A7",toneNote:"A7",frequency:3520,column:"B",hex:"#f1f5ff",isAccidental:!1},{pitch:"A/G7",flatName:"A7",sharpName:"G7",toneNote:"Ab7",frequency:3322.44,column:"A",hex:"#edf7fe",isAccidental:!0},{pitch:"G7",flatName:"G7",sharpName:"G7",toneNote:"G7",frequency:3135.96,column:"B",hex:"#ebf8fa",isAccidental:!1},{pitch:"G/F7",flatName:"G7",sharpName:"F7",toneNote:"Gb7",frequency:2959.96,column:"A",hex:"#ecf8f5",isAccidental:!0},{pitch:"F7",flatName:"F7",sharpName:"F7",toneNote:"F7",frequency:2793.83,column:"B",hex:"#eff8f0",isAccidental:!1},{pitch:"E7",flatName:"E7",sharpName:"E7",toneNote:"E7",frequency:2637.02,column:"A",hex:"#f4f7ec",isAccidental:!1},{pitch:"E/D7",flatName:"E7",sharpName:"D7",toneNote:"Eb7",frequency:2489.02,column:"B",hex:"#f9f5eb",isAccidental:!0},{pitch:"D7",flatName:"D7",sharpName:"D7",toneNote:"D7",frequency:2349.32,column:"A",hex:"#fdf3ec",isAccidental:!1},{pitch:"D/C7",flatName:"D7",sharpName:"C7",toneNote:"Db7",frequency:2217.46,column:"B",hex:"#fef2f0",isAccidental:!0},{pitch:"C7",flatName:"C7",sharpName:"C7",toneNote:"C7",frequency:2093,column:"A",hex:"#fef1f5",isAccidental:!1},{pitch:"B6",flatName:"B6",sharpName:"B6",toneNote:"B6",frequency:1975.53,column:"B",hex:"#f0d1ec",isAccidental:!1},{pitch:"B/A6",flatName:"B6",sharpName:"A6",toneNote:"Bb6",frequency:1864.66,column:"A",hex:"#e1d6f9",isAccidental:!0},{pitch:"A6",flatName:"A6",sharpName:"A6",toneNote:"A6",frequency:1760,column:"B",hex:"#cfdcff",isAccidental:!1},{pitch:"A/G6",flatName:"A6",sharpName:"G6",toneNote:"Ab6",frequency:1661.22,column:"A",hex:"#bfe2fb",isAccidental:!0},{pitch:"G6",flatName:"G6",sharpName:"G6",toneNote:"G6",frequency:1567.94,column:"B",hex:"#b7e6ef",isAccidental:!1},{pitch:"G/F6",flatName:"G6",sharpName:"F6",toneNote:"Gb6",frequency:1479.98,column:"A",hex:"#b9e8dd",isAccidental:!0},{pitch:"F6",flatName:"F6",sharpName:"F6",toneNote:"F6",frequency:1396.91,column:"B",hex:"#c6e6cb",isAccidental:!1},{pitch:"E6",flatName:"E6",sharpName:"E6",toneNote:"E6",frequency:1318.51,column:"A",hex:"#d8e2bd",isAccidental:!1},{pitch:"E/D6",flatName:"E6",sharpName:"D6",toneNote:"Eb6",frequency:1244.51,column:"B",hex:"#e9dcb7",isAccidental:!0},{pitch:"D6",flatName:"D6",sharpName:"D6",toneNote:"D6",frequency:1174.66,column:"A",hex:"#f6d5bc",isAccidental:!1},{pitch:"D/C6",flatName:"D6",sharpName:"C6",toneNote:"Db6",frequency:1108.73,column:"B",hex:"#fcd1c9",isAccidental:!0},{pitch:"C6",flatName:"C6",sharpName:"C6",toneNote:"C6",frequency:1046.5,column:"A",hex:"#facfdb",isAccidental:!1},{pitch:"B5",flatName:"B5",sharpName:"B5",toneNote:"B5",frequency:987.77,column:"B",hex:"#e6b2e1",isAccidental:!1},{pitch:"B/A5",flatName:"B5",sharpName:"A5",toneNote:"Bb5",frequency:932.33,column:"A",hex:"#cebaf6",isAccidental:!0},{pitch:"A5",flatName:"A5",sharpName:"A5",toneNote:"A5",frequency:880,column:"B",hex:"#b0c4fe",isAccidental:!1},{pitch:"A/G5",flatName:"A5",sharpName:"G5",toneNote:"Ab5",frequency:830.61,column:"A",hex:"#92cef8",isAccidental:!0},{pitch:"G5",flatName:"G5",sharpName:"G5",toneNote:"G5",frequency:783.99,column:"B",hex:"#7fd5e5",isAccidental:!1},{pitch:"G/F5",flatName:"G5",sharpName:"F5",toneNote:"Gb5",frequency:739.99,column:"A",hex:"#84d8c8",isAccidental:!0},{pitch:"F5",flatName:"F5",sharpName:"F5",toneNote:"F5",frequency:698.46,column:"B",hex:"#9ed6a8",isAccidental:!1},{pitch:"E5",flatName:"E5",sharpName:"E5",toneNote:"E5",frequency:659.25,column:"A",hex:"#bece8f",isAccidental:!1},{pitch:"E/D5",flatName:"E5",sharpName:"D5",toneNote:"Eb5",frequency:622.25,column:"B",hex:"#dbc484",isAccidental:!0},{pitch:"D5",flatName:"D5",sharpName:"D5",toneNote:"D5",frequency:587.33,column:"A",hex:"#f0b98d",isAccidental:!1},{pitch:"D/C5",flatName:"D5",sharpName:"C5",toneNote:"Db5",frequency:554.37,column:"B",hex:"#f9b1a5",isAccidental:!0},{pitch:"C5",flatName:"C5",sharpName:"C5",toneNote:"C5",frequency:523.25,column:"A",hex:"#f5afc3",isAccidental:!1},{pitch:"B4",flatName:"B4",sharpName:"B4",toneNote:"B4",frequency:493.88,column:"B",hex:"#db8fd4",isAccidental:!1},{pitch:"B/A4",flatName:"B4",sharpName:"A4",toneNote:"Bb4",frequency:466.16,column:"A",hex:"#ba9bf2",isAccidental:!0},{pitch:"A4",flatName:"A4",sharpName:"A4",toneNote:"A4",frequency:440,column:"B",hex:"#8fa9ff",isAccidental:!1},{pitch:"A/G4",flatName:"A4",sharpName:"G4",toneNote:"Ab4",frequency:415.3,column:"A",hex:"#58b8f6",isAccidental:!0},{pitch:"G4",flatName:"G4",sharpName:"G4",toneNote:"G4",frequency:392,column:"B",hex:"#16c3da",isAccidental:!1},{pitch:"G/F4",flatName:"G4",sharpName:"F4",toneNote:"Gb4",frequency:369.99,column:"A",hex:"#2dc8b1",isAccidental:!0},{pitch:"F4",flatName:"F4",sharpName:"F4",toneNote:"F4",frequency:349.23,column:"B",hex:"#6ec482",isAccidental:!1},{pitch:"E4",flatName:"E4",sharpName:"E4",toneNote:"E4",frequency:329.63,column:"A",hex:"#a4ba57",isAccidental:!1},{pitch:"E/D4",flatName:"E4",sharpName:"D4",toneNote:"Eb4",frequency:311.13,column:"B",hex:"#cdaa42",isAccidental:!0},{pitch:"D4",flatName:"D4",sharpName:"D4",toneNote:"D4",frequency:293.66,column:"A",hex:"#e89955",isAccidental:!1},{pitch:"D/C4",flatName:"D4",sharpName:"C4",toneNote:"Db4",frequency:277.18,column:"B",hex:"#f48e7d",isAccidental:!0},{pitch:"C4",flatName:"C4",sharpName:"C4",toneNote:"C4",frequency:261.63,column:"A",hex:"#ef8aab",isAccidental:!1},{pitch:"B3",flatName:"B3",sharpName:"B3",toneNote:"B3",frequency:246.94,column:"B",hex:"#be7cb8",isAccidental:!1},{pitch:"B/A3",flatName:"B3",sharpName:"A3",toneNote:"Bb3",frequency:233.08,column:"A",hex:"#a286d2",isAccidental:!0},{pitch:"A3",flatName:"A3",sharpName:"A3",toneNote:"A3",frequency:220,column:"B",hex:"#7b93dd",isAccidental:!1},{pitch:"A/G3",flatName:"A3",sharpName:"G3",toneNote:"Ab3",frequency:207.65,column:"A",hex:"#4c9fd6",isAccidental:!0},{pitch:"G3",flatName:"G3",sharpName:"G3",toneNote:"G3",frequency:196,column:"B",hex:"#13a9bd",isAccidental:!1},{pitch:"G/F3",flatName:"G3",sharpName:"F3",toneNote:"Gb3",frequency:185,column:"A",hex:"#27ad99",isAccidental:!0},{pitch:"F3",flatName:"F3",sharpName:"F3",toneNote:"F3",frequency:174.61,column:"B",hex:"#5faa71",isAccidental:!1},{pitch:"E3",flatName:"E3",sharpName:"E3",toneNote:"E3",frequency:164.81,column:"A",hex:"#8ea14b",isAccidental:!1},{pitch:"E/D3",flatName:"E3",sharpName:"D3",toneNote:"Eb3",frequency:155.56,column:"B",hex:"#b29338",isAccidental:!0},{pitch:"D3",flatName:"D3",sharpName:"D3",toneNote:"D3",frequency:146.83,column:"A",hex:"#ca8549",isAccidental:!1},{pitch:"D/C3",flatName:"D3",sharpName:"C3",toneNote:"Db3",frequency:138.59,column:"B",hex:"#d47a6c",isAccidental:!0},{pitch:"C3",flatName:"C3",sharpName:"C3",toneNote:"C3",frequency:130.81,column:"A",hex:"#cf7894",isAccidental:!1},{pitch:"B2",flatName:"B2",sharpName:"B2",toneNote:"B2",frequency:123.47,column:"B",hex:"#a46b9f",isAccidental:!1},{pitch:"B/A2",flatName:"B2",sharpName:"A2",toneNote:"Bb2",frequency:116.54,column:"A",hex:"#8b73b6",isAccidental:!0},{pitch:"A2",flatName:"A2",sharpName:"A2",toneNote:"A2",frequency:110,column:"B",hex:"#6a7ebf",isAccidental:!1},{pitch:"A/G2",flatName:"A2",sharpName:"G2",toneNote:"Ab2",frequency:103.83,column:"A",hex:"#4189b8",isAccidental:!0},{pitch:"G2",flatName:"G2",sharpName:"G2",toneNote:"G2",frequency:98,column:"B",hex:"#1092a3",isAccidental:!1},{pitch:"G/F2",flatName:"G2",sharpName:"F2",toneNote:"Gb2",frequency:92.5,column:"A",hex:"#219584",isAccidental:!0},{pitch:"F2",flatName:"F2",sharpName:"F2",toneNote:"F2",frequency:87.31,column:"B",hex:"#519360",isAccidental:!1},{pitch:"E2",flatName:"E2",sharpName:"E2",toneNote:"E2",frequency:82.41,column:"A",hex:"#7a8b40",isAccidental:!1},{pitch:"E/D2",flatName:"E2",sharpName:"D2",toneNote:"Eb2",frequency:77.78,column:"B",hex:"#997f30",isAccidental:!0},{pitch:"D2",flatName:"D2",sharpName:"D2",toneNote:"D2",frequency:73.42,column:"A",hex:"#ae723e",isAccidental:!1},{pitch:"D/C2",flatName:"D2",sharpName:"C2",toneNote:"Db2",frequency:69.3,column:"B",hex:"#b7695d",isAccidental:!0},{pitch:"C2",flatName:"C2",sharpName:"C2",toneNote:"C2",frequency:65.41,column:"A",hex:"#b3677f",isAccidental:!1},{pitch:"B1",flatName:"B1",sharpName:"B1",toneNote:"B1",frequency:61.74,column:"B",hex:"#6f466b",isAccidental:!1},{pitch:"B/A1",flatName:"B1",sharpName:"A1",toneNote:"Bb1",frequency:58.27,column:"A",hex:"#5d4c7b",isAccidental:!0},{pitch:"A1",flatName:"A1",sharpName:"A1",toneNote:"A1",frequency:55,column:"B",hex:"#465482",isAccidental:!1},{pitch:"A/G1",flatName:"A1",sharpName:"G1",toneNote:"Ab1",frequency:51.91,column:"A",hex:"#295c7d",isAccidental:!0},{pitch:"G1",flatName:"G1",sharpName:"G1",toneNote:"G1",frequency:49,column:"B",hex:"#06626e",isAccidental:!1},{pitch:"G/F1",flatName:"G1",sharpName:"F1",toneNote:"Gb1",frequency:46.25,column:"A",hex:"#126458",isAccidental:!0},{pitch:"F1",flatName:"F1",sharpName:"F1",toneNote:"F1",frequency:43.65,column:"B",hex:"#34633f",isAccidental:!1},{pitch:"E1",flatName:"E1",sharpName:"E1",toneNote:"E1",frequency:41.2,column:"A",hex:"#515d28",isAccidental:!1},{pitch:"E/D1",flatName:"E1",sharpName:"D1",toneNote:"Eb1",frequency:38.89,column:"B",hex:"#67541d",isAccidental:!0},{pitch:"D1",flatName:"D1",sharpName:"D1",toneNote:"D1",frequency:36.71,column:"A",hex:"#764c27",isAccidental:!1},{pitch:"D/C1",flatName:"D1",sharpName:"C1",toneNote:"Db1",frequency:34.65,column:"B",hex:"#7c453d",isAccidental:!0},{pitch:"C1",flatName:"C1",sharpName:"C1",toneNote:"C1",frequency:32.7,column:"A",hex:"#794455",isAccidental:!1}],bd={placedNotes:[],parkedNotes:[],placedChords:[],tonicSignGroups:{},stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1},history:[{notes:[],parkedNotes:[],tonicSignGroups:{},timbres:Lm().timbres,placedChords:[],stampPlacements:[],tripletPlacements:[],annotations:[],lassoSelection:{selectedItems:[],convexHull:null,isActive:!1}}],historyIndex:0,fullRowData:[],pitchRange:{topIndex:0,bottomIndex:Math.max(0,((me==null?void 0:me.length)||1)-1)},...Sb(),selectedModulationRatio:null,...Lm(),paint:qb(),selectedTool:"note",previousTool:"note",selectedToolTonicNumber:1,selectedNote:{shape:"circle",color:"#4a90e2"},deviceProfile:{isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0},activeChordId:null,activeChordIntervals:["1P"],isIntervalsInverted:!1,chordPositionState:0,gridPosition:0,viewportRows:0,logicRows:0,cellWidth:0,cellHeight:0,columnWidths:[],musicalColumnWidths:[],degreeDisplayMode:"off",accidentalMode:{sharp:!0,flat:!0},showFrequencyLabels:!1,focusColours:!1,snapZoomToRange:!1,isPitchRangeLocked:!1,isPlaying:!1,isPaused:!1,isLooping:!1,tempo:90,waveformExtendedView:!1,adsrTimeAxisScale:1,isPrintPreviewActive:!1,printOptions:{includeButtonGrid:!0,includeDrums:!0,includeLeftLegend:!0,includeRightLegend:!0,orientation:"landscape",colorMode:"color",cropTop:0,cropBottom:1,cropLeft:0,cropRight:1}};function Rm(s){const t=JSON.parse(JSON.stringify(s));for(const e in t){const i=t[e];i.coeffs&&typeof i.coeffs=="object"&&!Array.isArray(i.coeffs)?i.coeffs=new Float32Array(Object.values(i.coeffs)):Array.isArray(i.coeffs)&&(i.coeffs=new Float32Array(i.coeffs))}return t}const zb={recordState(){this.state.history=this.state.history.slice(0,this.state.historyIndex+1);const s=JSON.parse(JSON.stringify(this.state.timbres)),t={notes:JSON.parse(JSON.stringify(this.state.placedNotes)),parkedNotes:JSON.parse(JSON.stringify(this.state.parkedNotes||[])),tonicSignGroups:JSON.parse(JSON.stringify(this.state.tonicSignGroups)),placedChords:JSON.parse(JSON.stringify(this.state.placedChords)),stampPlacements:JSON.parse(JSON.stringify(this.state.stampPlacements)),tripletPlacements:JSON.parse(JSON.stringify(this.state.tripletPlacements||[])),timbres:s,annotations:this.state.annotations?JSON.parse(JSON.stringify(this.state.annotations)):[],lassoSelection:JSON.parse(JSON.stringify(this.state.lassoSelection))};this.state.history.push(t),this.state.historyIndex++,this.emit("historyChanged")},undo(){var s;if(this.state.historyIndex>0){this.state.historyIndex--;const t=this.state.history[this.state.historyIndex];if(!t)return;this.state.placedNotes=JSON.parse(JSON.stringify(t.notes)),this.state.parkedNotes=JSON.parse(JSON.stringify(t.parkedNotes||[])),this.state.tonicSignGroups=JSON.parse(JSON.stringify(t.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(t.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(t.tripletPlacements||[])),this.state.timbres=Rm(t.timbres),this.state.annotations=t.annotations?JSON.parse(JSON.stringify(t.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(s=this.state.selectedNote)!=null&&s.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}},redo(){var s;if(this.state.historyIndex<this.state.history.length-1){this.state.historyIndex++;const t=this.state.history[this.state.historyIndex];if(!t)return;this.state.placedNotes=JSON.parse(JSON.stringify(t.notes)),this.state.parkedNotes=JSON.parse(JSON.stringify(t.parkedNotes||[])),this.state.tonicSignGroups=JSON.parse(JSON.stringify(t.tonicSignGroups)),this.state.stampPlacements=JSON.parse(JSON.stringify(t.stampPlacements||[])),this.state.tripletPlacements=JSON.parse(JSON.stringify(t.tripletPlacements||[])),this.state.timbres=Rm(t.timbres),this.state.annotations=t.annotations?JSON.parse(JSON.stringify(t.annotations)):[],this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),(s=this.state.selectedNote)!=null&&s.color&&this.emit("timbreChanged",this.state.selectedNote.color),this.emit("annotationsChanged"),this.emit("historyChanged")}}};function kf(s){return s!==null&&typeof s=="object"&&"name"in s&&typeof s.name=="string"}function Lf(s){return s!==null&&typeof s=="object"&&"step"in s&&typeof s.step=="number"&&"alt"in s&&typeof s.alt=="number"&&!isNaN(s.step)&&!isNaN(s.alt)}var Av=[0,2,4,-1,1,3,5],rv=Av.map(s=>Math.floor(s*7/12));function ov(s){const{step:t,alt:e,oct:i,dir:A=1}=s,r=Av[t]+7*e;if(i===void 0)return[A*r];const a=i-rv[t]-4*e;return[A*r,A*a]}var $b=[3,0,4,1,5,2,6];function av(s){const[t,e,i]=s,A=$b[Xb(t)],r=Math.floor((t+1)/7);if(e===void 0)return{step:A,alt:r,dir:i};const a=e+4*r+rv[A];return{step:A,alt:r,oct:a,dir:i}}function Xb(s){const t=(s+1)%7;return t<0?7+t:t}var Hm=(s,t)=>Array(Math.abs(t)+1).join(s),_d=Object.freeze({empty:!0,name:"",num:NaN,q:"",type:"",step:NaN,alt:NaN,dir:NaN,simple:NaN,semitones:NaN,chroma:NaN,coord:[],oct:NaN}),Yb="([-+]?\\d+)(d{1,4}|m|M|P|A{1,4})",jb="(AA|A|P|M|m|d|dd)([-+]?\\d+)",Jb=new RegExp("^"+Yb+"|"+jb+"$");function Zb(s){const t=Jb.exec(`${s}`);return t===null?["",""]:t[1]?[t[1],t[2]]:[t[4],t[3]]}var Nm={};function dn(s){return typeof s=="string"?Nm[s]||(Nm[s]=t_(s)):Lf(s)?dn(s_(s)):kf(s)?dn(s.name):_d}var Om=[0,2,4,5,7,9,11],lv="PMMPPMM";function t_(s){const t=Zb(s);if(t[0]==="")return _d;const e=+t[0],i=t[1],A=(Math.abs(e)-1)%7,r=lv[A];if(r==="M"&&i==="P")return _d;const a=r==="M"?"majorable":"perfectable",l=""+e+i,u=e<0?-1:1,h=e===8||e===-8?e:u*(A+1),m=e_(a,i),g=Math.floor((Math.abs(e)-1)/7),w=u*(Om[A]+m+12*g),C=(u*(Om[A]+m)%12+12)%12,y=ov({step:A,alt:m,oct:g,dir:u});return{empty:!1,name:l,num:e,q:i,step:A,alt:m,dir:u,type:a,simple:h,semitones:w,chroma:C,coord:y,oct:g}}function cv(s,t){const[e,i=0]=s,A=e*7+i*12<0,r=t||A?[-e,-i,-1]:[e,i,1];return dn(av(r))}function e_(s,t){return t==="M"&&s==="majorable"||t==="P"&&s==="perfectable"?0:t==="m"&&s==="majorable"?-1:/^A+$/.test(t)?t.length:/^d+$/.test(t)?-1*(s==="perfectable"?t.length:t.length+1):0}function s_(s){const{step:t,alt:e,oct:i=0,dir:A}=s;if(!A)return"";const r=t+1+7*i,a=r===0?t+1:r,l=A<0?"-":"",u=lv[t]==="M"?"majorable":"perfectable";return l+a+n_(u,e)}function n_(s,t){return t===0?s==="majorable"?"M":"P":t===-1&&s==="majorable"?"m":t>0?Hm("A",t):Hm("d",s==="perfectable"?t:t+1)}var Vm=(s,t)=>Array(Math.abs(t)+1).join(s),uv=Object.freeze({empty:!0,name:"",letter:"",acc:"",pc:"",step:NaN,alt:NaN,chroma:NaN,height:NaN,coord:[],midi:null,freq:null}),Wm=new Map,i_=s=>"CDEFGAB".charAt(s),hv=s=>s<0?Vm("b",-s):Vm("#",s),dv=s=>s[0]==="b"?-s.length:s.length;function Ze(s){const t=JSON.stringify(s),e=Wm.get(t);if(e)return e;const i=typeof s=="string"?a_(s):Lf(s)?Ze(l_(s)):kf(s)?Ze(s.name):uv;return Wm.set(t,i),i}var A_=/^([a-gA-G]?)(#{1,}|b{1,}|x{1,}|)(-?\d*)\s*(.*)$/;function Rf(s){const t=A_.exec(s);return t?[t[1].toUpperCase(),t[2].replace(/x/g,"##"),t[3],t[4]]:["","","",""]}function r_(s){return Ze(av(s))}var o_=(s,t)=>(s%t+t)%t,Th=[0,2,4,5,7,9,11];function a_(s){const t=Rf(s);if(t[0]===""||t[3]!=="")return uv;const e=t[0],i=t[1],A=t[2],r=(e.charCodeAt(0)+3)%7,a=dv(i),l=A.length?+A:void 0,u=ov({step:r,alt:a,oct:l}),h=e+i+A,m=e+i,g=(Th[r]+a+120)%12,w=l===void 0?o_(Th[r]+a,12)-1188:Th[r]+a+12*(l+1),C=w>=0&&w<=127?w:null,y=l===void 0?null:Math.pow(2,(w-69)/12)*440;return{empty:!1,acc:i,alt:a,chroma:g,coord:u,freq:y,height:w,letter:e,midi:C,name:h,oct:l,pc:m,step:r}}function l_(s){const{step:t,alt:e,oct:i}=s,A=i_(t);if(!A)return"";const r=A+hv(e);return i||i===0?r+i:r}function Pc(s,t){const e=Ze(s),i=Array.isArray(t)?t:dn(t).coord;if(e.empty||!i||i.length<2)return"";const A=e.coord,r=A.length===1?[A[0]+i[0]]:[A[0]+i[0],A[1]+i[1]];return r_(r).name}function ac(s,t){const e=Ze(s),i=Ze(t);if(e.empty||i.empty)return"";const A=e.coord,r=i.coord,a=r[0]-A[0],l=A.length===2&&r.length===2?r[1]-A[1]:-Math.floor(a*7/12),u=i.height===e.height&&i.midi!==null&&e.oct===i.oct&&e.step>i.step;return cv([a,l],u).name}function Hf(s,t){const e=t.length,i=(s%e+e)%e;return t.slice(i,e).concat(t.slice(0,i))}function c_(s){return s.filter(t=>t===0||t)}var mA={empty:!0,name:"",setNum:0,chroma:"000000000000",normalized:"000000000000",intervals:[]},fv=s=>Number(s).toString(2).padStart(12,"0"),Km=s=>parseInt(s,2),u_=/^[01]{12}$/;function pv(s){return u_.test(s)}var h_=s=>typeof s=="number"&&s>=0&&s<=4095,d_=s=>s&&pv(s.chroma),Gm={[mA.chroma]:mA};function Nf(s){const t=pv(s)?s:h_(s)?fv(s):Array.isArray(s)?v_(s):d_(s)?s.chroma:mA.chroma;return Gm[t]=Gm[t]||w_(t)}var f_=["1P","2m","2M","3m","3M","4P","5d","5P","6m","6M","7m","7M"];function p_(s){const t=[];for(let e=0;e<12;e++)s.charAt(e)==="1"&&t.push(f_[e]);return t}function m_(s,t=!0){const i=Nf(s).chroma.split("");return c_(i.map((A,r)=>{const a=Hf(r,i);return t&&a[0]==="0"?null:a.join("")}))}function g_(s){const t=s.split("");return t.map((e,i)=>Hf(i,t).join(""))}function w_(s){const t=Km(s),e=g_(s).map(Km).filter(r=>r>=2048).sort()[0],i=fv(e),A=p_(s);return{empty:!1,name:"",setNum:t,chroma:s,normalized:i,intervals:A}}function v_(s){if(s.length===0)return mA.chroma;let t;const e=[0,0,0,0,0,0,0,0,0,0,0,0];for(let i=0;i<s.length;i++)t=Ze(s[i]),t.empty&&(t=dn(s[i])),t.empty||(e[t.chroma]=1);return e.join("")}var B_=[["1P 3M 5P","major","M ^  maj"],["1P 3M 5P 7M","major seventh","maj7  ma7 M7 Maj7 ^7"],["1P 3M 5P 7M 9M","major ninth","maj9 9 ^9"],["1P 3M 5P 7M 9M 13M","major thirteenth","maj13 Maj13 ^13"],["1P 3M 5P 6M","sixth","6 add6 add13 M6"],["1P 3M 5P 6M 9M","sixth added ninth","6add9 6/9 69 M69"],["1P 3M 6m 7M","major seventh flat sixth","M7b6 ^7b6"],["1P 3M 5P 7M 11A","major seventh sharp eleventh","maj#4 #4 #11 M7#11 ^7#11 maj7#11"],["1P 3m 5P","minor","m min -"],["1P 3m 5P 7m","minor seventh","m7 min7 mi7 -7"],["1P 3m 5P 7M","minor/major seventh","m/ma7 m/maj7 mM7 mMaj7 m/M7 -7 m -^7 -maj7"],["1P 3m 5P 6M","minor sixth","m6 -6"],["1P 3m 5P 7m 9M","minor ninth","m9 -9"],["1P 3m 5P 7M 9M","minor/major ninth","mM9 mMaj9 -^9"],["1P 3m 5P 7m 9M 11P","minor eleventh","m11 -11"],["1P 3m 5P 7m 9M 13M","minor thirteenth","m13 -13"],["1P 3m 5d","diminished","dim  o"],["1P 3m 5d 7d","diminished seventh","dim7 7 o7"],["1P 3m 5d 7m","half-diminished","m7b5  -7b5 h7 h"],["1P 3M 5P 7m","dominant seventh","7 dom"],["1P 3M 5P 7m 9M","dominant ninth","9"],["1P 3M 5P 7m 9M 13M","dominant thirteenth","13"],["1P 3M 5P 7m 11A","lydian dominant seventh","7#11 7#4"],["1P 3M 5P 7m 9m","dominant flat ninth","7b9"],["1P 3M 5P 7m 9A","dominant sharp ninth","7#9"],["1P 3M 7m 9m","altered","alt7"],["1P 4P 5P","suspended fourth","sus4 sus"],["1P 2M 5P","suspended second","sus2"],["1P 4P 5P 7m","suspended fourth seventh","7sus4 7sus"],["1P 5P 7m 9M 11P","eleventh","11"],["1P 4P 5P 7m 9m","suspended fourth flat ninth","b9sus phryg 7b9sus 7b9sus4"],["1P 5P","fifth","5"],["1P 3M 5A","augmented","aug + +5 ^#5"],["1P 3m 5A","minor augmented","m#5 -#5 m+"],["1P 3M 5A 7M","augmented seventh","maj7#5 maj7+5 +maj7 ^7#5"],["1P 3M 5P 7M 9M 11A","major sharp eleventh (lydian)","maj9#11 9#11 ^9#11"],["1P 2M 4P 5P","","sus24 sus4add9"],["1P 3M 5A 7M 9M","","maj9#5 Maj9#5"],["1P 3M 5A 7m","","7#5 +7 7+ 7aug aug7"],["1P 3M 5A 7m 9A","","7#5#9 7#9#5 7alt"],["1P 3M 5A 7m 9M","","9#5 9+"],["1P 3M 5A 7m 9M 11A","","9#5#11"],["1P 3M 5A 7m 9m","","7#5b9 7b9#5"],["1P 3M 5A 7m 9m 11A","","7#5b9#11"],["1P 3M 5A 9A","","+add#9"],["1P 3M 5A 9M","","M#5add9 +add9"],["1P 3M 5P 6M 11A","","M6#11 M6b5 6#11 6b5"],["1P 3M 5P 6M 7M 9M","","M7add13"],["1P 3M 5P 6M 9M 11A","","69#11"],["1P 3m 5P 6M 9M","","m69 -69"],["1P 3M 5P 6m 7m","","7b6"],["1P 3M 5P 7M 9A 11A","","maj7#9#11"],["1P 3M 5P 7M 9M 11A 13M","","M13#11 maj13#11 M13+4 M13#4"],["1P 3M 5P 7M 9m","","M7b9"],["1P 3M 5P 7m 11A 13m","","7#11b13 7b5b13"],["1P 3M 5P 7m 13M","","7add6 67 7add13"],["1P 3M 5P 7m 9A 11A","","7#9#11 7b5#9 7#9b5"],["1P 3M 5P 7m 9A 11A 13M","","13#9#11"],["1P 3M 5P 7m 9A 11A 13m","","7#9#11b13"],["1P 3M 5P 7m 9A 13M","","13#9"],["1P 3M 5P 7m 9A 13m","","7#9b13"],["1P 3M 5P 7m 9M 11A","","9#11 9+4 9#4"],["1P 3M 5P 7m 9M 11A 13M","","13#11 13+4 13#4"],["1P 3M 5P 7m 9M 11A 13m","","9#11b13 9b5b13"],["1P 3M 5P 7m 9m 11A","","7b9#11 7b5b9 7b9b5"],["1P 3M 5P 7m 9m 11A 13M","","13b9#11"],["1P 3M 5P 7m 9m 11A 13m","","7b9b13#11 7b9#11b13 7b5b9b13"],["1P 3M 5P 7m 9m 13M","","13b9"],["1P 3M 5P 7m 9m 13m","","7b9b13"],["1P 3M 5P 7m 9m 9A","","7b9#9"],["1P 3M 5P 9M","","Madd9 2 add9 add2"],["1P 3M 5P 9m","","Maddb9"],["1P 3M 5d","","Mb5"],["1P 3M 5d 6M 7m 9M","","13b5"],["1P 3M 5d 7M","","M7b5"],["1P 3M 5d 7M 9M","","M9b5"],["1P 3M 5d 7m","","7b5"],["1P 3M 5d 7m 9M","","9b5"],["1P 3M 7m","","7no5"],["1P 3M 7m 13m","","7b13"],["1P 3M 7m 9M","","9no5"],["1P 3M 7m 9M 13M","","13no5"],["1P 3M 7m 9M 13m","","9b13"],["1P 3m 4P 5P","","madd4"],["1P 3m 5P 6m 7M","","mMaj7b6"],["1P 3m 5P 6m 7M 9M","","mMaj9b6"],["1P 3m 5P 7m 11P","","m7add11 m7add4"],["1P 3m 5P 9M","","madd9"],["1P 3m 5d 6M 7M","","o7M7"],["1P 3m 5d 7M","","oM7"],["1P 3m 6m 7M","","mb6M7"],["1P 3m 6m 7m","","m7#5"],["1P 3m 6m 7m 9M","","m9#5"],["1P 3m 5A 7m 9M 11P","","m11A"],["1P 3m 6m 9m","","mb6b9"],["1P 2M 3m 5d 7m","","m9b5"],["1P 4P 5A 7M","","M7#5sus4"],["1P 4P 5A 7M 9M","","M9#5sus4"],["1P 4P 5A 7m","","7#5sus4"],["1P 4P 5P 7M","","M7sus4"],["1P 4P 5P 7M 9M","","M9sus4"],["1P 4P 5P 7m 9M","","9sus4 9sus"],["1P 4P 5P 7m 9M 13M","","13sus4 13sus"],["1P 4P 5P 7m 9m 13m","","7sus4b9b13 7b9b13sus4"],["1P 4P 7m 10m","","4 quartal"],["1P 5P 7m 9m 11P","","11b9"]],y_=B_,C_={...mA,name:"",quality:"Unknown",intervals:[],aliases:[]},Of=[],Do={};function b_(s){return Do[s]||C_}function __(){return Of.slice()}function x_(s,t,e){const i=S_(s),A={...Nf(s),name:e||"",quality:i,intervals:s,aliases:t};Of.push(A),A.name&&(Do[A.name]=A),Do[A.setNum]=A,Do[A.chroma]=A,A.aliases.forEach(r=>E_(A,r))}function E_(s,t){Do[t]=s}function S_(s){const t=e=>s.indexOf(e)!==-1;return t("5A")?"Augmented":t("3M")?"Major":t("5d")?"Diminished":t("3m")?"Minor":"Unknown"}y_.forEach(([s,t,e])=>x_(s.split(" "),e.split(" "),t));Of.sort((s,t)=>s.setNum-t.setNum);var F_=s=>{const t=s.reduce((e,i)=>{const A=Ze(i).chroma;return A!==void 0&&(e[A]=e[A]||Ze(i).name),e},{});return e=>t[e]};function T_(s,t={}){const e=s.map(A=>Ze(A).pc).filter(A=>A);return Ze.length===0?[]:k_(e,1,t).filter(A=>A.weight).sort((A,r)=>r.weight-A.weight).map(A=>A.name)}var Dc={anyThirds:384,perfectFifth:16,nonPerfectFifths:40,anySeventh:3},kc=s=>t=>!!(t&s),I_=kc(Dc.anyThirds),Q_=kc(Dc.perfectFifth),M_=kc(Dc.anySeventh),U_=kc(Dc.nonPerfectFifths);function P_(s){const t=parseInt(s.chroma,2);return I_(t)&&Q_(t)&&M_(t)}function D_(s){const t=parseInt(s,2);return U_(t)?s:(t|16).toString(2)}function k_(s,t,e){const i=s[0],A=Ze(i).chroma,r=F_(s),a=m_(s,!1),l=[];return a.forEach((u,h)=>{const m=e.assumePerfectFifth&&D_(u);__().filter(w=>e.assumePerfectFifth&&P_(w)?w.chroma===m:w.chroma===u).forEach(w=>{const C=w.aliases[0],y=r(h);h!==A?l.push({weight:.5*t,name:`${y}${C}/${i}`}):l.push({weight:1*t,name:`${y}${C}`})})}),l}var L_=dn;function R_(s){const t=dn(s);if(t.empty)return"";const e=(7-t.step)%7,i=t.type==="perfectable"?-t.alt:-(t.alt+1);return dn({step:e,alt:i,oct:t.oct,dir:t.dir}).name}var qm=ac,H_=N_((s,t)=>[s[0]-t[0],s[1]-t[1]]);function N_(s){return(t,e)=>{const i=dn(t).coord,A=dn(e).coord;if(i&&A){const r=s(i,A);return cv(r).name}}}var O_=[["1P 2M 3M 5P 6M","major pentatonic","pentatonic"],["1P 2M 3M 4P 5P 6M 7M","major","ionian"],["1P 2M 3m 4P 5P 6m 7m","minor","aeolian"],["1P 2M 3m 3M 5P 6M","major blues"],["1P 3m 4P 5d 5P 7m","minor blues","blues"],["1P 2M 3m 4P 5P 6M 7M","melodic minor"],["1P 2M 3m 4P 5P 6m 7M","harmonic minor"],["1P 2M 3M 4P 5P 6M 7m 7M","bebop"],["1P 2M 3m 4P 5d 6m 6M 7M","diminished","whole-half diminished"],["1P 2M 3m 4P 5P 6M 7m","dorian"],["1P 2M 3M 4A 5P 6M 7M","lydian"],["1P 2M 3M 4P 5P 6M 7m","mixolydian","dominant"],["1P 2m 3m 4P 5P 6m 7m","phrygian"],["1P 2m 3m 4P 5d 6m 7m","locrian"],["1P 3M 4P 5P 7M","ionian pentatonic"],["1P 3M 4P 5P 7m","mixolydian pentatonic","indian"],["1P 2M 4P 5P 6M","ritusen"],["1P 2M 4P 5P 7m","egyptian"],["1P 3M 4P 5d 7m","neopolitan major pentatonic"],["1P 3m 4P 5P 6m","vietnamese 1"],["1P 2m 3m 5P 6m","pelog"],["1P 2m 4P 5P 6m","kumoijoshi"],["1P 2M 3m 5P 6m","hirajoshi"],["1P 2m 4P 5d 7m","iwato"],["1P 2m 4P 5P 7m","in-sen"],["1P 3M 4A 5P 7M","lydian pentatonic","chinese"],["1P 3m 4P 6m 7m","malkos raga"],["1P 3m 4P 5d 7m","locrian pentatonic","minor seven flat five pentatonic"],["1P 3m 4P 5P 7m","minor pentatonic","vietnamese 2"],["1P 3m 4P 5P 6M","minor six pentatonic"],["1P 2M 3m 5P 6M","flat three pentatonic","kumoi"],["1P 2M 3M 5P 6m","flat six pentatonic"],["1P 2m 3M 5P 6M","scriabin"],["1P 3M 5d 6m 7m","whole tone pentatonic"],["1P 3M 4A 5A 7M","lydian #5P pentatonic"],["1P 3M 4A 5P 7m","lydian dominant pentatonic"],["1P 3m 4P 5P 7M","minor #7M pentatonic"],["1P 3m 4d 5d 7m","super locrian pentatonic"],["1P 2M 3m 4P 5P 7M","minor hexatonic"],["1P 2A 3M 5P 5A 7M","augmented"],["1P 2M 4P 5P 6M 7m","piongio"],["1P 2m 3M 4A 6M 7m","prometheus neopolitan"],["1P 2M 3M 4A 6M 7m","prometheus"],["1P 2m 3M 5d 6m 7m","mystery #1"],["1P 2m 3M 4P 5A 6M","six tone symmetric"],["1P 2M 3M 4A 5A 6A","whole tone","messiaen's mode #1"],["1P 2m 4P 4A 5P 7M","messiaen's mode #5"],["1P 2M 3M 4P 5d 6m 7m","locrian major","arabian"],["1P 2m 3M 4A 5P 6m 7M","double harmonic lydian"],["1P 2m 2A 3M 4A 6m 7m","altered","super locrian","diminished whole tone","pomeroy"],["1P 2M 3m 4P 5d 6m 7m","locrian #2","half-diminished","aeolian b5"],["1P 2M 3M 4P 5P 6m 7m","mixolydian b6","melodic minor fifth mode","hindu"],["1P 2M 3M 4A 5P 6M 7m","lydian dominant","lydian b7","overtone"],["1P 2M 3M 4A 5A 6M 7M","lydian augmented"],["1P 2m 3m 4P 5P 6M 7m","dorian b2","phrygian #6","melodic minor second mode"],["1P 2m 3m 4d 5d 6m 7d","ultralocrian","superlocrian bb7","superlocrian diminished"],["1P 2m 3m 4P 5d 6M 7m","locrian 6","locrian natural 6","locrian sharp 6"],["1P 2A 3M 4P 5P 5A 7M","augmented heptatonic"],["1P 2M 3m 4A 5P 6M 7m","dorian #4","ukrainian dorian","romanian minor","altered dorian"],["1P 2M 3m 4A 5P 6M 7M","lydian diminished"],["1P 2M 3M 4A 5A 7m 7M","leading whole tone"],["1P 2M 3M 4A 5P 6m 7m","lydian minor"],["1P 2m 3M 4P 5P 6m 7m","phrygian dominant","spanish","phrygian major"],["1P 2m 3m 4P 5P 6m 7M","balinese"],["1P 2m 3m 4P 5P 6M 7M","neopolitan major"],["1P 2M 3M 4P 5P 6m 7M","harmonic major"],["1P 2m 3M 4P 5P 6m 7M","double harmonic major","gypsy"],["1P 2M 3m 4A 5P 6m 7M","hungarian minor"],["1P 2A 3M 4A 5P 6M 7m","hungarian major"],["1P 2m 3M 4P 5d 6M 7m","oriental"],["1P 2m 3m 3M 4A 5P 7m","flamenco"],["1P 2m 3m 4A 5P 6m 7M","todi raga"],["1P 2m 3M 4P 5d 6m 7M","persian"],["1P 2m 3M 5d 6m 7m 7M","enigmatic"],["1P 2M 3M 4P 5A 6M 7M","major augmented","major #5","ionian augmented","ionian #5"],["1P 2A 3M 4A 5P 6M 7M","lydian #9"],["1P 2m 2M 4P 4A 5P 6m 7M","messiaen's mode #4"],["1P 2m 3M 4P 4A 5P 6m 7M","purvi raga"],["1P 2m 3m 3M 4P 5P 6m 7m","spanish heptatonic"],["1P 2M 3m 3M 4P 5P 6M 7m","bebop minor"],["1P 2M 3M 4P 5P 5A 6M 7M","bebop major"],["1P 2m 3m 4P 5d 5P 6m 7m","bebop locrian"],["1P 2M 3m 4P 5P 6m 7m 7M","minor bebop"],["1P 2M 3M 4P 5d 5P 6M 7M","ichikosucho"],["1P 2M 3m 4P 5P 6m 6M 7M","minor six diminished"],["1P 2m 3m 3M 4A 5P 6M 7m","half-whole diminished","dominant diminished","messiaen's mode #2"],["1P 3m 3M 4P 5P 6M 7m 7M","kafi raga"],["1P 2M 3M 4P 4A 5A 6A 7M","messiaen's mode #6"],["1P 2M 3m 3M 4P 5d 5P 6M 7m","composite blues"],["1P 2M 3m 3M 4A 5P 6m 7m 7M","messiaen's mode #3"],["1P 2m 2M 3m 4P 4A 5P 6m 6M 7M","messiaen's mode #7"],["1P 2m 2M 3m 3M 4P 5d 5P 6m 6M 7m 7M","chromatic"]],V_=O_,W_={...mA,intervals:[],aliases:[]},ko={};function mv(s){return ko[s]||W_}function K_(s,t,e=[]){const i={...Nf(s),name:t,intervals:s,aliases:e};return ko[i.name]=i,ko[i.setNum]=i,ko[i.chroma]=i,i.aliases.forEach(A=>G_(i,A)),i}function G_(s,t){ko[t]=s}V_.forEach(([s,t,...e])=>K_(s.split(" "),t,e));var gv={empty:!0,name:"",symbol:"",root:"",bass:"",rootDegree:0,type:"",tonic:null,setNum:NaN,quality:"Unknown",chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function wv(s){const[t,e,i,A]=Rf(s);return t===""?Ih("",s):t==="A"&&A==="ug"?Ih("","aug"):Ih(t+e,i+A)}function Ih(s,t){const e=t.split("/");if(e.length===1)return[s,e[0],""];const[i,A,r,a]=Rf(e[1]);return i!==""&&r===""&&a===""?[s,e[0],i+A]:[s,t,""]}function q_(s){if(Array.isArray(s))return Qh(s[1]||"",s[0],s[2]);if(s==="")return gv;{const[t,e,i]=wv(s),A=Qh(e,t,i);return A.empty?Qh(s):A}}function Qh(s,t,e){const i=b_(s),A=Ze(t||""),r=Ze(e||"");if(i.empty||t&&A.empty||e&&r.empty)return gv;const a=ac(A.pc,r.pc),l=i.intervals.indexOf(a),u=l>=0,h=u?r:Ze(""),m=l===-1?NaN:l+1,g=r.pc&&r.pc!==A.pc,w=Array.from(i.intervals);if(u)for(let x=1;x<m;x++){const T=w[0][0],U=w[0][1],H=parseInt(T,10)+7;w.push(`${H}${U}`),w.shift()}else if(g){const x=H_(ac(A.pc,r.pc),"8P");x&&w.unshift(x)}const C=A.empty?[]:w.map(x=>Pc(A.pc,x));s=i.aliases.indexOf(s)!==-1?s:i.aliases[0];const y=`${A.empty?"":A.pc}${s}${u&&m>1?"/"+h.pc:g?"/"+r.pc:""}`,E=`${t?A.pc+" ":""}${i.name}${u&&m>1?" over "+h.pc:g?" over "+r.pc:""}`;return{...i,name:E,symbol:y,tonic:A.pc,type:i.name,root:h.pc,bass:g?r.pc:"",intervals:w,rootDegree:m,notes:C}}var z_=[[.125,"dl",["large","duplex longa","maxima","octuple","octuple whole"]],[.25,"l",["long","longa"]],[.5,"d",["double whole","double","breve"]],[1,"w",["whole","semibreve"]],[2,"h",["half","minim"]],[4,"q",["quarter","crotchet"]],[8,"e",["eighth","quaver"]],[16,"s",["sixteenth","semiquaver"]],[32,"t",["thirty-second","demisemiquaver"]],[64,"sf",["sixty-fourth","hemidemisemiquaver"]],[128,"h",["hundred twenty-eighth"]],[256,"th",["two hundred fifty-sixth"]]],$_=z_;$_.forEach(([s,t,e])=>void 0);var X_="C C# D D# E F F# G G# A A# B".split(" "),Y_="C Db D Eb E F Gb G Ab A Bb B".split(" ");function Vf(s,t={}){if(isNaN(s)||s===-1/0||s===1/0)return"";s=Math.round(s);const i=(t.sharps===!0?X_:Y_)[s%12];if(t.pitchClass)return i;const A=Math.floor(s/12)-1;return i+A}var Aa=Ze,xd=s=>Aa(s).pc,oA=s=>Aa(s).midi;function j_(s){return Vf(s)}var gr=Pc,Lo=s=>{const t=Aa(s);return t.empty?"":Vf(t.midi||t.chroma,{sharps:t.alt>0,pitchClass:t.midi===null})};function li(s,t){const e=Aa(s);if(e.empty)return"";const i=Aa(t||Vf(e.midi||e.chroma,{sharps:e.alt<0,pitchClass:!0}));if(i.empty||i.chroma!==e.chroma)return"";if(e.oct===void 0)return i.pc;const A=e.chroma-e.alt,r=i.chroma-i.alt,a=A>11||r<0?-1:A<0||r>11?1:0,l=e.oct+a;return i.pc+l}var vv={empty:!0,name:"",chordType:""},zm={};function ra(s){return typeof s=="string"?zm[s]||(zm[s]=sx(s)):typeof s=="number"?ra(Wf[s]||""):Lf(s)?J_(s):kf(s)?ra(s.name):vv}function J_(s){return ra(hv(s.alt)+Wf[s.step])}var Z_=/^(#{1,}|b{1,}|x{1,}|)(IV|I{1,3}|VI{0,2}|iv|i{1,3}|vi{0,2})([^IViv]*)$/;function tx(s){return Z_.exec(s)||["","","",""]}var ex="I II III IV V VI VII",Wf=ex.split(" ");function sx(s){const[t,e,i,A]=tx(s);if(!i)return vv;const r=i.toUpperCase(),a=Wf.indexOf(r),l=dv(e),u=1;return{empty:!1,name:t,roman:i,interval:dn({step:a,alt:l,dir:u}).name,acc:e,chordType:A,alt:l,step:a,major:i===r,oct:0,dir:u}}var Kf=[[0,2773,0,"ionian","","Maj7","major"],[1,2902,2,"dorian","m","m7"],[2,3418,4,"phrygian","m","m7"],[3,2741,-1,"lydian","","Maj7"],[4,2774,1,"mixolydian","","7"],[5,2906,3,"aeolian","m","m7","minor"],[6,3434,5,"locrian","dim","m7b5"]],$m={...mA,name:"",alt:0,modeNum:NaN,triad:"",seventh:"",aliases:[]},nx=Kf.map(ix),Ed={};nx.forEach(s=>{Ed[s.name]=s,s.aliases.forEach(t=>{Ed[t]=s})});function Bv(s){return typeof s=="string"?Ed[s.toLowerCase()]||$m:s&&s.name?Bv(s.name):$m}function ix(s){const[t,e,i,A,r,a,l]=s,u=l?[l]:[],h=Number(e).toString(2);return{empty:!1,intervals:mv(A).intervals,modeNum:t,chroma:h,normalized:h,name:A,setNum:e,alt:i,triad:r,seventh:a,aliases:u}}function yv(s){return(t,e)=>{const i=Bv(t);if(i.empty)return[];const A=Hf(i.modeNum,s),r=i.intervals.map(a=>Pc(e,a));return A.map((a,l)=>r[l]+a)}}yv(Kf.map(s=>s[4]));yv(Kf.map(s=>s[5]));function Ax(s,t){return t.map(e=>{const[i,A]=wv(e),r=ac(s,i);return ra(dn(r)).name+A})}var rx={empty:!0,name:"",type:"",tonic:null,setNum:NaN,chroma:"",normalized:"",aliases:[],notes:[],intervals:[]};function ox(s){if(typeof s!="string")return["",""];const t=s.indexOf(" "),e=Ze(s.substring(0,t));if(e.empty){const A=Ze(s);return A.empty?["",s.toLowerCase()]:[A.name,""]}const i=s.substring(e.name.length+1).toLowerCase();return[e.name,i.length?i:""]}function ax(s){const t=Array.isArray(s)?s:ox(s),e=Ze(t[0]).name,i=mv(t[1]);if(i.empty)return rx;const A=i.name,r=e?i.intervals.map(l=>Pc(e,l)):[],a=e?e+" "+A:A;return{...i,name:a,type:A,tonic:e,notes:r}}const lx=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"],hi=s=>s.tonicSignGroups?Object.values(s.tonicSignGroups).flat():[],Os=(s,t)=>{let e=0;const{macrobeatGroupings:i}=s,A=hi(s);A.some(u=>u.preMacrobeatIndex===-1)&&(e+=2);for(let u=0;u<t;u++)e+=i[u]??0,A.some(h=>h.preMacrobeatIndex===u)&&(e+=2);const r=e,a=i[t]??0,l=r+a-1;return{startColumn:r,endColumn:l,grouping:a}},cx=s=>s.placedNotes.filter(t=>!t.isDrum),ux=s=>s.placedNotes.filter(t=>t.isDrum),hx=(s,t)=>{const i=hi(s).filter(u=>u.columnIndex<=t);if(i.length===0)return{keyTonic:"C",keyMode:"major"};const A=i.reduce((u,h)=>h.columnIndex>u.columnIndex?h:u),r=s.fullRowData[A.row];if(!r)return{keyTonic:"C",keyMode:"major"};const a=xd(r.toneNote),l=lx[A.tonicNumber-1]||"major";return{keyTonic:a,keyMode:l}};let dx=class{constructor(){Q(this,"logLevel");Q(this,"enabledLevels");Q(this,"categories");this.logLevel="ERROR",this.enabledLevels={DEBUG:!1,INFO:!1,WARN:!1,ERROR:!0},this.categories={general:!1,state:!1,canvas:!1,audio:!1,ui:!1,layout:!1,harmony:!1,paint:!1,performance:!1,initialization:!1,transport:!1,grid:!1,toolbar:!1,zoom:!1,scroll:!1,keyboard:!1,mouse:!1,adsr:!1,filter:!1,waveform:!1,debug:!1}}enable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!0)})}disable(...t){t.forEach(e=>{Object.prototype.hasOwnProperty.call(this.categories,e)&&(this.categories[e]=!1)})}enableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!0}),this.setLevel("DEBUG")}disableAll(){Object.keys(this.categories).forEach(t=>{this.categories[t]=!1}),this.setLevel("ERROR")}isCategoryEnabled(t){return this.categories[t]===!0}setLevel(t){const i=["DEBUG","INFO","WARN","ERROR"].indexOf(t);i!==-1&&(this.logLevel=t,this.enabledLevels={DEBUG:i<=0,INFO:i<=1,WARN:i<=2,ERROR:i<=3})}logWithConsole(t,e,i,A=null){if(typeof console<"u"&&console[t]){const r=A!==null?[e,i,A]:[e,i];console[t](...r)}}event(t,e,i="",A="ui"){!this.enabledLevels.INFO||this.isCategoryEnabled(A)}state(t,e,i=null,A="state"){!this.enabledLevels.INFO||this.isCategoryEnabled(A)}debug(t,e,i=null,A="debug"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(A)||this.logWithConsole("debug",t,e,i)}timing(t,e,i,A="performance"){!this.enabledLevels.DEBUG||!this.isCategoryEnabled(A)||this.logWithConsole("debug",t,e,i)}warn(t,e,i=null,A="general"){!this.enabledLevels.WARN||!this.isCategoryEnabled(A)||this.logWithConsole("warn",t,e,i)}error(t,e,i=null,A="general"){this.enabledLevels.ERROR&&this.logWithConsole("error",t,e,i)}info(t,e,i=null,A="general"){!this.enabledLevels.INFO||!this.isCategoryEnabled(A)||this.logWithConsole("info",t,e,i)}getConfig(){return{logLevel:this.logLevel,enabledLevels:{...this.enabledLevels},enabledCategories:Object.entries(this.categories).filter(([,t])=>t).map(([t])=>t)}}getAvailableCategories(){return Object.keys(this.categories)}section(t){this.enabledLevels.INFO&&this.info("Logger",`===== ${t} =====`,null,"general")}initStart(t){this.enabledLevels.INFO&&this.info(t,"init start",null,"initialization")}initSuccess(t){this.enabledLevels.INFO&&this.info(t,"init success",null,"initialization")}initFailed(t,e){if(this.enabledLevels.ERROR){const i=e?`init failed: ${e}`:"init failed";this.error(t,i,null,"initialization")}}moduleLoaded(t,e="initialization"){this.isCategoryEnabled(e)&&this.enabledLevels.INFO&&this.info(t,"loaded",null,e)}log(t,e,i=null){this.info(t,e,i,"general")}};const b=new dx;typeof window<"u"&&(window.logger=b);const fx={0:{degree:1,alt:0},1:{degree:2,alt:-1},2:{degree:2,alt:0},3:{degree:3,alt:-1},4:{degree:3,alt:0},5:{degree:4,alt:0},6:{degree:5,alt:-1},7:{degree:5,alt:0},8:{degree:6,alt:-1},9:{degree:6,alt:0},10:{degree:7,alt:-1},11:{degree:7,alt:0}};function px(s){if(Math.abs(s.num)!==8||s.alt>=0)return null;const e=(s.semitones%12+12)%12;return fx[e]||null}function Xm(s){if(!s)return null;const t=L_(s);if((t==null?void 0:t.num)===void 0)return null;const e=px(t),i=e?e.degree:Math.abs(t.num),A=e?e.alt:t.alt;let r="";return A<0?r="".repeat(Math.abs(A)):A>0&&(r="".repeat(A)),`${r}${i}`}function Ym(s){return s&&{"1":"2","2":"1","2":"3","3":"2","4":"5","5":"4","5":"6","6":"5","6":"7","7":"6"}[s]||null}function jm(s){return!!(s&&(s.includes("")||s.includes("")))}const Ro={getEnharmonicDegree:Ym,hasAccidental:jm,getDegreeForNote(s,t){var m;if(!s||!t)return null;const{keyTonic:e,keyMode:i}=hx(t,s.startColumnIndex);if(!e)return null;const A=(m=t.fullRowData[s.row])==null?void 0:m.toneNote;if(!A)return null;const r=xd(A)||A;let a=e;if(t.degreeDisplayMode!=="modal"&&i!=="major"){const w=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"].indexOf(i);if(w>0){const y=["1P","2M","3M","4P","5P","6M","7M"][w];if(y){const E=R_(y);a=gr(e,E)||a}}}const u=qm(a,r),h=Xm(u);if(s.enharmonicPreference&&h&&jm(h)){const g=Ym(h);if(g)return g}return h},getDegreesForNotes(s,t){return!s||s.length===0?[]:s.map(e=>{const i=xd(e)||e,A=qm(t,i);return Xm(A)}).filter(e=>e!==null)},getRomanNumeralForNotes(s,t){if(!s||s.length<2)return null;const[e]=T_(s);if(!e)return null;const i=q_(e),A=i==null?void 0:i.symbol;if(!A)return null;const[r]=Ax(t,[A]);if(!r)return null;const a=ra(r),l=a==null?void 0:a.roman;if(!l)return null;let u=a.name.replace(l,"");const h=(i==null?void 0:i.tonic)||t;return u==="6"&&(u="add6"),{roman:l,ext:u,root:h}}};function lc(s){if(!(!s||s.isDrum)&&s.shape==="circle"&&typeof s.startColumnIndex=="number"){const t=s.startColumnIndex+1;(typeof s.endColumnIndex!="number"||s.endColumnIndex<t)&&(s.endColumnIndex=t)}}function sl(s,t){var i;if(typeof s.row!="number")return;const e=((i=t.pitchRange)==null?void 0:i.topIndex)??0;s.globalRow=s.row+e}function nl(){return`uuid-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const mx={addNote(s){const t=this.state.placedNotes.find(i=>!i.isDrum&&i.row===s.row&&i.startColumnIndex===s.startColumnIndex&&i.color===s.color);if(t){if(this.state.degreeDisplayMode!=="off"){const i=Ro.getDegreeForNote(t,this.state);if(i&&Ro.hasAccidental(i))return t.enharmonicPreference=!t.enharmonicPreference,b.debug("NoteActions","[ENHARMONIC] Toggled enharmonic preference for note",{noteUuid:t.uuid,currentDegree:i,enharmonicPreference:t.enharmonicPreference},"notes"),this.emit("notesChanged"),t}return null}const e={...s,uuid:nl()};return lc(e),sl(e,this.state),this.state.placedNotes.push(e),this.emit("notesChanged"),e},updateNoteTail(s,t){let e=t;s.shape==="circle"&&(e=Math.max(s.startColumnIndex+1,t)),s.endColumnIndex=e,this.emit("notesChanged")},updateMultipleNoteTails(s,t){s.forEach(e=>{let i=t;e.shape==="circle"&&(i=Math.max(e.startColumnIndex+1,t)),e.endColumnIndex=i}),this.emit("notesChanged")},updateNoteRow(s,t){s.row=t,sl(s,this.state),this.emit("notesChanged")},updateMultipleNoteRows(s,t){s.forEach((e,i)=>{const A=t[i];A!==void 0&&(e.row=A,sl(e,this.state))}),this.emit("notesChanged")},updateNotePosition(s,t){s.startColumnIndex=t,s.endColumnIndex=s.shape==="circle"?t+1:t,this.emit("notesChanged")},updateMultipleNotePositions(s,t){s.forEach(e=>{e.startColumnIndex=t,e.endColumnIndex=e.shape==="circle"?t+1:t}),this.emit("notesChanged")},eraseInPitchArea(s,t,e=1,i=!0){const A=s+e-1,r=t-1,a=t+1;let l=!1;const u=this.state.placedNotes.length;return this.state.placedNotes=this.state.placedNotes.filter(h=>{if(h.isDrum)return!0;if(h.shape==="circle"){const m=h.startColumnIndex+1,g=typeof h.endColumnIndex=="number"?Math.max(m,h.endColumnIndex):m,w=h.startColumnIndex<=A&&g>=s,C=h.row>=r&&h.row<=a;if(w&&C)return!1}else if(h.row>=r&&h.row<=a&&h.startColumnIndex<=A&&h.endColumnIndex>=s)return!1;return!0}),this.state.placedNotes.length<u&&(l=!0),l&&(this.emit("notesChanged"),i&&this.recordState()),l},eraseDrumNoteAt(s,t,e=!0){const i=this.state.placedNotes.length;this.state.placedNotes=this.state.placedNotes.filter(r=>!(r.isDrum&&r.drumTrack===t&&r.startColumnIndex===s));const A=this.state.placedNotes.length<i;return A&&(this.emit("notesChanged"),e&&this.recordState()),A},addTonicSignGroup(s){b.debug("TonicPlacement","Starting addTonicSignGroup",{tonicSignGroup:s},"state");const t=s[0];if(!t)return;const{preMacrobeatIndex:e}=t;if(b.debug("TonicPlacement","preMacrobeatIndex",{preMacrobeatIndex:e},"state"),Object.values(this.state.tonicSignGroups).flat().some(l=>l.preMacrobeatIndex===e)){b.debug("TonicPlacement","Tonic already exists at this preMacrobeatIndex, returning",null,"state");return}const i=Os(this.state,e+1).startColumn;b.debug("TonicPlacement","Boundary column (canvas-space) for shifting notes",{boundaryColumn:i},"state");const A=this.state.placedNotes.filter(l=>l.startColumnIndex>=i);b.debug("TonicPlacement","Notes that will be shifted",{noteRanges:A.map(l=>`${l.startColumnIndex}-${l.endColumnIndex}`)},"state"),this.state.placedNotes.forEach(l=>{if(l.startColumnIndex>=i){const u=l.startColumnIndex,h=l.endColumnIndex;l.startColumnIndex=l.startColumnIndex+2,l.endColumnIndex=l.endColumnIndex+2,b.debug("TonicPlacement",`Shifted note from ${u}-${h} to ${l.startColumnIndex}-${l.endColumnIndex}`,null,"state")}});const r=nl(),a=s.map(l=>({...l,uuid:r}));this.state.tonicSignGroups[r]=a,b.debug("TonicPlacement","Added tonic group",{uuid:r,columns:a.map(l=>l.columnIndex)},"state"),b.debug("TonicPlacement","Emitting events: notesChanged, rhythmStructureChanged",null,"state"),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},eraseTonicSignAt(s,t=!0){const e=Object.entries(this.state.tonicSignGroups).find(([,u])=>u.some(h=>h.columnIndex===s));if(!e)return!1;const[i,A]=e,r=A[0];if(!r)return!1;const a=r.preMacrobeatIndex,l=Os(this.state,a+1).startColumn;return delete this.state.tonicSignGroups[i],this.state.placedNotes.forEach(u=>{u.startColumnIndex>=l&&(u.startColumnIndex=u.startColumnIndex-2,u.endColumnIndex=u.endColumnIndex-2)}),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),t&&this.recordState(),!0},toggleDrumNote(s){const t=this.state.placedNotes.findIndex(e=>e.isDrum&&e.drumTrack===s.drumTrack&&e.startColumnIndex===s.startColumnIndex);if(t>=0)this.state.placedNotes.splice(t,1);else{const e={...s,uuid:nl()};this.state.placedNotes.push(e)}this.emit("notesChanged"),this.recordState()},clearAllNotes(){this.state.placedNotes=[],this.state.parkedNotes=[],this.state.tonicSignGroups={},this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},loadNotes(s){const t=(s||[]).map(e=>{const i={...e,uuid:(e==null?void 0:e.uuid)??nl()};return lc(i),sl(i,this.state),i});this.state.placedNotes=t,this.emit("notesChanged"),this.recordState()}},gx={setADSR(s,t){this.state.timbres[s]&&(this.state.timbres[s].adsr=t,this.state.timbres[s].activePresetName=null,this.emit("timbreChanged",s))},setFilterSettings(s,t){if(this.state.timbres[s]){b.debug("TimbreActions","setFilterSettings called",{color:s,newSettings:t,activePresetName:this.state.timbres[s].activePresetName},"timbre"),b.debug("TimbreActions","setFilterSettings call stack",{stack:new Error().stack},"timbre"),Object.assign(this.state.timbres[s].filter,t);const e=this.state.timbres[s].filter.blend;e<=0?this.state.timbres[s].filter.type="highpass":e>=2?this.state.timbres[s].filter.type="lowpass":this.state.timbres[s].filter.type="bandpass",t.enabled===void 0&&(b.debug("TimbreActions","Clearing activePresetName because enabled is undefined",{color:s},"timbre"),this.state.timbres[s].activePresetName=null),this.emit("timbreChanged",s)}},setHarmonicCoefficients(s,t){this.state.timbres[s]&&(this.state.timbres[s].coeffs=t,this.state.timbres[s].activePresetName=null,this.emit("timbreChanged",s))},setHarmonicPhases(s,t){this.state.timbres[s]&&(b.debug("TimbreActions",`setHarmonicPhases called for ${s}`,null,"state"),b.debug("TimbreActions","Old phases",{phases:this.state.timbres[s].phases},"state"),b.debug("TimbreActions","New phases",{phases:t},"state"),b.debug("TimbreActions","Coefficients before phase change",{coeffs:this.state.timbres[s].coeffs},"state"),this.state.timbres[s].phases=t,this.state.timbres[s].activePresetName=null,b.debug("TimbreActions","Coefficients after phase change",{coeffs:this.state.timbres[s].coeffs},"state"),b.debug("TimbreActions","Emitting timbreChanged for phase change",null,"state"),this.emit("timbreChanged",s))},applyPreset(s,t){!t||!this.state.timbres[s]||(b.debug("TimbreActions",`applyPreset called for ${s}`,null,"state"),b.debug("TimbreActions","Preset name",{name:t.name},"state"),b.debug("TimbreActions","Preset coeffs",{coeffs:t.coeffs},"state"),b.debug("TimbreActions","Old timbre coeffs",{coeffs:this.state.timbres[s].coeffs},"state"),this.state.timbres[s].adsr=t.adsr,this.state.timbres[s].coeffs=new Float32Array(t.coeffs),t.phases?this.state.timbres[s].phases=new Float32Array(t.phases):this.state.timbres[s].phases=new Float32Array(this.state.timbres[s].coeffs.length).fill(0),this.state.timbres[s].activePresetName=t.name,this.state.timbres[s].gain=t.gain||1,t.filter?this.state.timbres[s].filter=JSON.parse(JSON.stringify(t.filter)):this.state.timbres[s].filter=iv(),b.debug("TimbreActions","Applied preset - new coeffs",{coeffs:this.state.timbres[s].coeffs},"state"),this.emit("timbreChanged",s),this.recordState())}};function Sd(s,...t){}const an={COMPRESSION_2_3:2/3,EXPANSION_3_2:3/2};function wx(s,t){if(!t||!t.macrobeatGroupings)return s*4;if(s===0)return 0;const e=s-1,i=Os(t,e);if(i){const r=i.endColumn+1;return Sd("log","[MODULATION] Found measure info, canvas-space endColumn:",i.endColumn,"first column after:",r),r}return s*4}function vx(s,t,e=null,i=null,A=null){return{id:`mod_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,measureIndex:s,ratio:t,active:!0,xPosition:e,columnIndex:i,macrobeatIndex:A}}function Cv(s){return Math.abs(s-an.COMPRESSION_2_3)<.001?"2:3":Math.abs(s-an.EXPANSION_3_2)<.001?"3:2":`${s}`}function bv(s){return Math.abs(s-an.COMPRESSION_2_3)<.001?"#dc3545":Math.abs(s-an.EXPANSION_3_2)<.001?"#007bff":"#6c757d"}function Jm(){const s=[{startColumn:0,endColumn:1/0,scale:1}];return{segments:s,getScaleForColumn(t){return 1},microbeatToCanvasX(){return 0},canvasXToMicrobeat(){return 0},getSegmentAtX(){return s[0]||null},getGhostGridPositions(){return[]}}}function Bx(s,t,e=null){if(!s||s.length===0)return Jm();const i=[...s.filter(h=>h.active)].sort((h,m)=>h.measureIndex-m.measureIndex);if(i.length===0)return Jm();const A=i.map(h=>{const m=wx(h.measureIndex,e);return Sd("log",`[MODULATION] Marker at measure ${h.measureIndex} calculated column=${m}`),Sd("log","[MODULATION] Final marker position:",{id:h.id,measureIndex:h.measureIndex,columnIndex:m}),{...h,columnIndex:m}}),r=[];let a=1;const l=A[0];if(A.length===0||l&&l.columnIndex>0){const h=l?l.columnIndex:1/0;r.push({startColumn:0,endColumn:h,scale:1})}for(let h=0;h<A.length;h++){const m=A[h],g=A[h+1],w=g?g.columnIndex:1/0;a*=m.ratio,r.push({startColumn:m.columnIndex,endColumn:w,scale:a,marker:m})}return{segments:r,getScaleForColumn(h){for(const m of r)if(h>=m.startColumn&&h<m.endColumn)return m.scale;return 1},microbeatToCanvasX(h){return 0},canvasXToMicrobeat(h){return 0},getSegmentAtX(h){return r[0]||null},getGhostGridPositions(h,m){return[]}}}function Zm(s){if(s)return s.uuid}function _v(s,t=null){const e=Array.isArray(t)?t:s.macrobeatGroupings||[],A=[...hi(s)].sort((m,g)=>m.preMacrobeatIndex-g.preMacrobeatIndex);let r=0;const a=[];let l=0;const u=m=>{a.push({visualIndex:a.length,type:`legend-${m}`,timeIndex:null})},h=m=>{for(;r<A.length;){const g=A[r];if((g==null?void 0:g.preMacrobeatIndex)!==m)break;a.push({visualIndex:a.length,type:"tonic",timeIndex:null}),a.push({visualIndex:a.length,type:"tonic",timeIndex:null});const w=Zm(g);if(w)do r++;while(r<A.length&&Zm(A[r])===w);else r++}};return u("left"),u("left"),h(-1),e.forEach((m,g)=>{for(let w=0;w<m;w++)a.push({visualIndex:a.length,type:"time",timeIndex:l++});h(g)}),u("right"),u("right"),{entries:a,totalTimeColumns:l}}function Rn(s,t,e=null){const{entries:i}=_v(s,e),A=i[t];return A?A.timeIndex:null}function rn(s,t,e=null){const{entries:i,totalTimeColumns:A}=_v(s,e);if(t==null||t<0||t>=A)return null;const r=i.find(a=>a.timeIndex===t);return r?r.visualIndex:null}function Mh(s,t,e=null){const i=Array.isArray(e)?e:s.macrobeatGroupings||[];if(t==null)return 0;let A=0;for(let r=0;r<=t&&r<i.length;r++){const a=i[r];typeof a=="number"&&(A+=a)}return A}const yx={setAnacrusis(s){var u,h,m;if(this.state.hasAnacrusis===s)return;const t=[...this.state.macrobeatGroupings],e=[...this.state.macrobeatBoundaryStyles],i=t.reduce((g,w)=>g+w,0);let A,r;if(s){const g=this._anacrusisCache,w=Mm.length-Cd.length,C=Mm.slice(0,w),y=Eb.slice(0,w),E=(u=g==null?void 0:g.groupings)!=null&&u.length?[...g.groupings]:[...C],x=(h=g==null?void 0:g.boundaryStyles)!=null&&h.length?[...g.boundaryStyles]:[...y];if(A=[...E,...t],r=[...x,...e],!((m=g==null?void 0:g.boundaryStyles)!=null&&m.length))for(let T=0;T<x.length;T++)r[T]=T<x.length-1?"anacrusis":"solid";this._anacrusisCache=null,b.debug("rhythmActions","Enabled anacrusis",{insertedCount:E.length,insertedColumns:E.reduce((T,U)=>T+U,0)},"state")}else{const g=e.findIndex(E=>E==="solid");let w=0;if(g!==-1)w=g+1;else for(;w<e.length&&e[w]==="anacrusis";)w++;w=Math.min(w,t.length);const C=t.slice(0,w),y=e.slice(0,w);w>0?this._anacrusisCache={groupings:C,boundaryStyles:y}:this._anacrusisCache=null,A=t.slice(w),r=e.slice(w).map(E=>E==="anacrusis"?"dashed":E),A.length===0&&(A=[...Cd],r=[...ev]),b.debug("rhythmActions","Disabled anacrusis",{removalCount:w,removedColumns:C.reduce((E,x)=>E+x,0)},"state")}const l=A.reduce((g,w)=>g+w,0)-i;if(this.state.hasAnacrusis=s,this.state.macrobeatGroupings=[...A],this.state.macrobeatBoundaryStyles=[...r],l!==0){const g=[];this.state.placedNotes.forEach(x=>{const T=Rn(this.state,x.startColumnIndex,t),U=Rn(this.state,x.endColumnIndex,t);if(T===null||U===null)return;const H=T+l,R=U+l;if(H<0){g.push(x);return}const D=rn(this.state,H,A),P=rn(this.state,R,A);if(D===null||P===null){g.push(x);return}x.startColumnIndex=D,x.endColumnIndex=P}),g.forEach(x=>{const T=this.state.placedNotes.indexOf(x);T>-1&&this.state.placedNotes.splice(T,1)});const w=[];this.state.stampPlacements.forEach(x=>{const T=Rn(this.state,x.startColumn,t),U=Rn(this.state,x.endColumn,t);if(T===null||U===null)return;const H=T+l,R=U+l;if(H<0){w.push(x);return}const D=rn(this.state,H,A),P=rn(this.state,R,A);if(D===null||P===null){w.push(x);return}x.startColumn=D,x.endColumn=P}),w.forEach(x=>{const T=this.state.stampPlacements.indexOf(x);T>-1&&this.state.stampPlacements.splice(T,1)});const C=[];this.state.tripletPlacements&&(this.state.tripletPlacements.forEach(x=>{const T=l/2,U=1;if(x.startCellIndex>=U){const H=x.startCellIndex+T;H<U?C.push(x):x.startCellIndex=H}}),C.forEach(x=>{const T=this.state.tripletPlacements.indexOf(x);T>-1&&this.state.tripletPlacements.splice(T,1)})),Object.values(this.state.tonicSignGroups).flat().forEach(x=>{x.preMacrobeatIndex>=0});const y=[],E=s?A.length-t.length:-(t.length-A.length);this.state.modulationMarkers.forEach(x=>{const T=x.measureIndex+E;if(T<0){y.push(x);return}x.measureIndex=T,x.columnIndex=null,x.xPosition=null,x.macrobeatIndex=null}),y.forEach(x=>{const T=this.state.modulationMarkers.indexOf(x);T>-1&&this.state.modulationMarkers.splice(T,1)})}this.emit("anacrusisChanged",s),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("modulationMarkersChanged"),this.emit("rhythmStructureChanged"),this.recordState()},toggleMacrobeatGrouping(s){if(s===void 0||s<0||s>=this.state.macrobeatGroupings.length){b.error("rhythmActions",`Invalid index for toggleMacrobeatGrouping: ${s}`,null,"state");return}const t=[...this.state.macrobeatGroupings],e=t[s],i=e===2?3:2,A=i-e,r=[...t];r[s]=i;const a=Mh(this.state,s,t),l=[];this.state.placedNotes.forEach(u=>{const h=Rn(this.state,u.startColumnIndex,t),m=Rn(this.state,u.endColumnIndex,t);if(!(h===null||m===null)&&h>=a){const g=h+A,w=m+A,C=rn(this.state,g,r),y=rn(this.state,w,r);C!==null&&y!==null?(u.startColumnIndex=C,u.endColumnIndex=y):l.push(u)}}),l.length&&l.forEach(u=>{const h=this.state.placedNotes.indexOf(u);h>-1&&this.state.placedNotes.splice(h,1)}),this.state.macrobeatGroupings=r,this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},cycleMacrobeatBoundaryStyle(s){if(s===void 0||s<0||s>=this.state.macrobeatBoundaryStyles.length){b.error("rhythmActions",`Invalid index for cycleMacrobeatBoundaryStyle: ${s}`,null,"state");return}const t=this._isBoundaryInAnacrusis(s);let e;t?e=["dashed","solid","anacrusis"]:e=["dashed","solid"];const i=this.state.macrobeatBoundaryStyles[s]??"dashed",A=e.indexOf(i),r=A===-1?0:(A+1)%e.length,a=e[r]??"dashed";this.state.macrobeatBoundaryStyles[s]=a,this.emit("rhythmStructureChanged"),this.recordState()},_isBoundaryInAnacrusis(s){if(!this.state.hasAnacrusis)return!1;for(let t=0;t<=s;t++)if(this.state.macrobeatBoundaryStyles[t]==="solid")return t===s;return!0},increaseMacrobeatCount(){this.state.macrobeatGroupings.push(2),this.state.macrobeatBoundaryStyles.push("dashed"),this.emit("rhythmStructureChanged"),this.recordState()},decreaseMacrobeatCount(){if(this.state.macrobeatGroupings.length>1){const s=this.state.macrobeatGroupings.length-1,t=Mh(this.state,s-1,this.state.macrobeatGroupings),e=[];this.state.placedNotes.forEach(r=>{const a=Rn(this.state,r.startColumnIndex,this.state.macrobeatGroupings);a!==null&&a>=t&&e.push(r)}),e.forEach(r=>{const a=this.state.placedNotes.indexOf(r);a>-1&&this.state.placedNotes.splice(a,1)});const i=[];this.state.stampPlacements.forEach(r=>{const a=Rn(this.state,r.startColumn,this.state.macrobeatGroupings);a!==null&&a>=t&&i.push(r)}),i.forEach(r=>{const a=this.state.stampPlacements.indexOf(r);a>-1&&this.state.stampPlacements.splice(a,1)});const A=[];if(this.state.tripletPlacements){const r=t/2;this.state.tripletPlacements.forEach(a=>{a.startCellIndex>=r&&A.push(a)}),A.forEach(a=>{const l=this.state.tripletPlacements.indexOf(a);l>-1&&this.state.tripletPlacements.splice(l,1)})}this.state.macrobeatGroupings.pop(),this.state.macrobeatBoundaryStyles.pop(),e.length>0&&this.emit("notesChanged"),i.length>0&&this.emit("stampPlacementsChanged"),A.length>0&&this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),this.recordState()}},updateTimeSignature(s,t){if(!Array.isArray(t)||t.length===0){b.error("rhythmActions","Invalid groupings provided to updateTimeSignature",null,"state");return}let e=0,i=0,A=0;for(let C=0;C<this.state.macrobeatGroupings.length;C++){if(A===s){e=C;break}const y=C===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[C]==="solid"||y)&&A++}A=0;for(let C=0;C<this.state.macrobeatGroupings.length;C++)if(A===s){const y=C===this.state.macrobeatGroupings.length-1;if(this.state.macrobeatBoundaryStyles[C]==="solid"||y){i=C;break}}else if(A<s){const y=C===this.state.macrobeatGroupings.length-1;(this.state.macrobeatBoundaryStyles[C]==="solid"||y)&&A++}const r=i-e+1,a=t.length,l=this.state.macrobeatGroupings.slice(e,i+1).reduce((C,y)=>C+y,0),h=t.reduce((C,y)=>C+y,0)-l,m=Mh(this.state,i,this.state.macrobeatGroupings);if(h!==0){const C=(()=>{const E=[...this.state.macrobeatGroupings];return E.splice(e,r,...t),E})(),y=[];this.state.placedNotes.forEach(E=>{const x=Rn(this.state,E.startColumnIndex,this.state.macrobeatGroupings),T=Rn(this.state,E.endColumnIndex,this.state.macrobeatGroupings);if(!(x===null||T===null)&&x>=m){const U=x+h,H=T+h,R=rn(this.state,U,C),D=rn(this.state,H,C);R!==null&&D!==null?(E.startColumnIndex=R,E.endColumnIndex=D):y.push(E)}}),y.length&&y.forEach(E=>{const x=this.state.placedNotes.indexOf(E);x>-1&&this.state.placedNotes.splice(x,1)})}const g=[...t],w=new Array(Math.max(a-1,0)).fill("dashed");if(i<this.state.macrobeatBoundaryStyles.length){const C=this.state.macrobeatBoundaryStyles[i]??"dashed";w.push(C)}this.state.macrobeatGroupings.splice(e,r,...g),this.state.macrobeatBoundaryStyles.splice(e,r-1,...w),this.emit("notesChanged"),this.emit("rhythmStructureChanged"),this.recordState()},addModulationMarker(s,t,e=null,i=null,A=null){if(!Object.values(an).includes(t))return b.error("rhythmActions",`Invalid modulation ratio: ${t}`,null,"state"),null;const r=this.state.modulationMarkers.findIndex(l=>l.measureIndex===s||A!==null&&l.macrobeatIndex===A||i!==null&&l.columnIndex===i);if(r!==-1){const l=this.state.modulationMarkers[r];return b.info("rhythmActions",`Replacing existing modulation marker ${l.id} at measure ${s} (old ratio: ${l.ratio}, new ratio: ${t})`,null,"state"),l.ratio=t,l.xPosition=e,i!==null&&(l.columnIndex=i),A!==null&&(l.macrobeatIndex=A),this.emit("modulationMarkersChanged"),this.recordState(),l.id}const a=vx(s,t,e,i,A);return this.state.modulationMarkers.push(a),this.state.modulationMarkers.sort((l,u)=>l.measureIndex-u.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),b.info("rhythmActions",`Added modulation marker ${a.id} at measure ${s} with ratio=${t}, columnIndex=${i}`,null,"state"),a.id},removeModulationMarker(s){const t=this.state.modulationMarkers.findIndex(e=>e.id===s);if(t===-1){b.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}this.state.modulationMarkers.splice(t,1),this.emit("modulationMarkersChanged"),this.recordState(),b.info("rhythmActions",`Removed modulation marker ${s}`,null,"state")},setModulationRatio(s,t){if(!Object.values(an).includes(t)){b.error("rhythmActions",`Invalid modulation ratio: ${t}`,null,"state");return}const e=this.state.modulationMarkers.find(i=>i.id===s);if(!e){b.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}e.ratio=t,this.emit("modulationMarkersChanged"),this.recordState(),b.info("rhythmActions",`Updated modulation marker ${s} ratio to ${t}`,null,"state")},moveModulationMarker(s,t){const e=this.state.modulationMarkers.find(i=>i.id===s);if(!e){b.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}e.measureIndex=t,this.state.modulationMarkers.sort((i,A)=>i.measureIndex-A.measureIndex),this.emit("modulationMarkersChanged"),this.recordState(),b.info("rhythmActions",`Moved modulation marker ${s} to measure ${t}`,null,"state")},toggleModulationMarker(s){const t=this.state.modulationMarkers.find(e=>e.id===s);if(!t){b.warn("rhythmActions",`Modulation marker not found: ${s}`,null,"state");return}t.active=!t.active,this.emit("modulationMarkersChanged"),this.recordState(),b.info("rhythmActions",`Toggled modulation marker ${s} active state to ${t.active}`,null,"state")},clearModulationMarkers(){const s=this.state.modulationMarkers.length;this.state.modulationMarkers=[],this.emit("modulationMarkersChanged"),this.recordState(),b.info("rhythmActions",`Cleared ${s} modulation markers`,null,"state")}};function tg(s,t,e){if(!s||typeof s!="object")return!0;const i=t.topIndex,A=e.topIndex,r=e.bottomIndex,a=r-A;let l=!1,u=!1;const h=m=>{if(typeof m!="number")return m;l=!0;const g=m+i;g>=A&&g<=r&&(u=!0);const w=g-A;return Math.max(0,Math.min(a,w))};if(typeof s.row=="number"&&(s.row=h(s.row)),typeof s.startRow=="number"&&(s.startRow=h(s.startRow)),typeof s.endRow=="number"&&(s.endRow=h(s.endRow)),typeof s.mouseRow=="number"&&(s.mouseRow=h(s.mouseRow)),typeof s.baseRow=="number"&&(s.baseRow=h(s.baseRow)),Array.isArray(s.path)){let m=!1;s.path.forEach(g=>{if(g&&typeof g.row=="number"){const w=g,C=w.row+i;C>=A&&C<=r&&(m=!0),w.row=Math.max(0,Math.min(a,C-A))}}),s.path.length>0&&(l=!0,m&&(u=!0))}if(Array.isArray(s.points)){let m=!1;s.points.forEach(g=>{if(g&&typeof g.row=="number"){const w=g,C=w.row+i;C>=A&&C<=r&&(m=!0),w.row=Math.max(0,Math.min(a,C-A))}}),s.points.length>0&&(l=!0,m&&(u=!0))}return s.data&&typeof s.data=="object"&&Object.entries(s.data).forEach(([,m])=>{if(m&&typeof m=="object"){if(Array.isArray(m))m.forEach(g=>{if(g&&typeof g.row=="number"){const w=g,C=w.row+i;C>=A&&C<=r&&(u=!0),l=!0,w.row=Math.max(0,Math.min(a,C-A))}});else if(typeof m.row=="number"){const g=m,w=g.row+i;w>=A&&w<=r&&(u=!0),l=!0,g.row=Math.max(0,Math.min(a,w-A))}}}),!l||u}const Fd={toggleAccidentalMode(s){if(!Object.prototype.hasOwnProperty.call(this.state.accidentalMode||{},s))return;const t={...this.state.accidentalMode},e=t[s],i=s==="flat"?"sharp":"flat",A=t[i];b.debug("ViewActions",`toggleAccidentalMode(${s})`,{previousState:t,requestedType:s,requestedValue:!e,pairedType:i,pairedValue:A},"state"),e&&!A?(this.state.accidentalMode[i]=!0,this.state.accidentalMode[s]=!1,b.warn("ViewActions",`Prevented both accidentals from being disabled (enabling ${i})`,{enforcedType:i,toggledType:s},"state")):this.state.accidentalMode[s]=!e,b.debug("ViewActions",`toggleAccidentalMode(${s}) result`,{newState:{...this.state.accidentalMode}},"state"),this.emit("accidentalModeChanged",this.state.accidentalMode),this.emit("layoutConfigChanged")},toggleFrequencyLabels(){const s=this.state.showFrequencyLabels;this.state.showFrequencyLabels=!this.state.showFrequencyLabels,b.debug("ViewActions","toggleFrequencyLabels",{previous:s,next:this.state.showFrequencyLabels,accidentalMode:{...this.state.accidentalMode}},"state"),this.emit("frequencyLabelsChanged",this.state.showFrequencyLabels),this.emit("layoutConfigChanged")},toggleFocusColours(){this.state.focusColours=!this.state.focusColours;const s=this.state.focusColours;this.emit("focusColoursChanged",s),s&&!this.state.showFrequencyLabels&&(this.state.showFrequencyLabels=!0,this.emit("frequencyLabelsChanged",!0)),this.emit("layoutConfigChanged")},setSnapZoomToRange(s){const t=!!s;this.state.snapZoomToRange!==t&&(this.state.snapZoomToRange=t,this.emit("snapZoomSettingChanged",t))},setPitchRangeLock(s){const t=!!s;this.state.isPitchRangeLocked!==t&&(this.state.isPitchRangeLocked=t,this.emit("pitchRangeLockChanged",t))},setDegreeDisplayMode(s){const t=this.state.degreeDisplayMode;this.state.degreeDisplayMode=this.state.degreeDisplayMode===s?"off":s;const e=this.state.degreeDisplayMode;b.debug("ViewActions","setDegreeDisplayMode",{oldMode:t,newMode:e},"state"),this.emit("layoutConfigChanged"),this.emit("degreeDisplayModeChanged",e)},setSelectedTool(s,t){if(this.state.selectedTool!==s||s==="tonicization"&&this.state.selectedToolTonicNumber!==t){const i=this.state.selectedTool;this.state.previousTool=i,this.state.selectedTool=s,s==="tonicization"&&t&&(this.state.selectedToolTonicNumber=parseInt(String(t),10)),this.emit("toolChanged",{newTool:s,oldTool:i})}},setSelectedNote(s,t){const e={...this.state.selectedNote};this.state.selectedNote={shape:s,color:t},this.emit("noteChanged",{newNote:this.state.selectedNote,oldNote:e})},setKeySignature(s){this.state.keySignature!==s&&(this.state.keySignature=s,this.emit("keySignatureChanged",s))},setTempo(s){this.state.tempo=s,this.emit("tempoChanged",s)},setLooping(s){this.state.isLooping=s,this.emit("loopingChanged",s)},setPlaybackState(s,t=!1){this.state.isPlaying=s,this.state.isPaused=t,this.emit("playbackStateChanged",{isPlaying:s,isPaused:t})},toggleWaveformExtendedView(){this.state.waveformExtendedView=!this.state.waveformExtendedView,this.emit("waveformExtendedViewChanged",this.state.waveformExtendedView)},setAdsrTimeAxisScale(s){const t=Math.max(.1,Math.min(5,s));this.state.adsrTimeAxisScale=t,this.emit("adsrTimeAxisScaleChanged",t)},setLayoutConfig(s){const t={cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]]};let e=!1;if(s.cellWidth!==void 0&&this.state.cellWidth!==s.cellWidth&&(this.state.cellWidth=s.cellWidth,e=!0),s.cellHeight!==void 0&&this.state.cellHeight!==s.cellHeight&&(this.state.cellHeight=s.cellHeight,e=!0),s.columnWidths!==void 0){const i=JSON.stringify(this.state.columnWidths||[]),A=JSON.stringify(s.columnWidths);i!==A&&(this.state.columnWidths=[...s.columnWidths],this.state.musicalColumnWidths=s.columnWidths.slice(2,-2),e=!0)}e&&this.emit("layoutConfigChanged",{oldConfig:t,newConfig:{cellWidth:this.state.cellWidth,cellHeight:this.state.cellHeight,columnWidths:[...this.state.columnWidths||[]],musicalColumnWidths:[...this.state.musicalColumnWidths||[]]}})},setGridPosition(s){const t=this.state.fullRowData.length-this.state.viewportRows*2,e=Math.max(0,Math.min(s,t));this.state.gridPosition!==e&&(this.state.gridPosition=e,this.emit("layoutConfigChanged"))},shiftGridUp(){Fd.setGridPosition.call(this,this.state.gridPosition-1)},shiftGridDown(){Fd.setGridPosition.call(this,this.state.gridPosition+1)},setPrintOptions(s){this.state.printOptions={...this.state.printOptions,...s},this.emit("printOptionsChanged",this.state.printOptions)},setPrintPreviewActive(s){this.state.isPrintPreviewActive=s,this.emit("printPreviewStateChanged",s)},setPitchRange(s,t={}){const{trimOutsideRange:e=!0,preserveContent:i=!1}=t,A=e&&!i,r=me.length,a=this.state.pitchRange||{topIndex:0,bottomIndex:r-1};if(!s||r===0)return;const l=s.topIndex??a.topIndex,u=s.bottomIndex??a.bottomIndex,h=Math.max(0,Math.min(r-1,l)),m=Math.max(h,Math.min(r-1,u));if(a.topIndex===h&&a.bottomIndex===m)return;const g=me.slice(h,m+1),w=g.length-1;let C=0,y=0,E=0;const x=[...this.state.placedNotes||[],...this.state.parkedNotes||[]],T=[],U=[];if(x.forEach(D=>{if(D.isDrum){T.push(D);return}const P=typeof D.globalRow=="number"?D.globalRow:D.row+a.topIndex;D.globalRow=P;const G=P-h,Y=Math.max(0,Math.min(w,G)),W=P<h||P>m;if(W&&A){C+=1;return}if(W){U.push(D);return}D.row=Y,T.push(D)}),this.state.placedNotes=T,this.state.parkedNotes=U,this.state.tonicSignGroups){const D={};Object.entries(this.state.tonicSignGroups).forEach(([P,G])=>{const Y=G.map(W=>{if(typeof W.row!="number")return null;const at=W.row+a.topIndex,Bt=Math.max(0,Math.min(w,at-h));return(at<h||at>m)&&A?null:{...W,row:Bt}}).filter(Boolean);Y.length>0&&(D[P]=Y)}),this.state.tonicSignGroups=D}if(Array.isArray(this.state.stampPlacements)&&(this.state.stampPlacements.length>0&&this.state.stampPlacements[0],this.state.stampPlacements=this.state.stampPlacements.filter((D,P)=>{const G=typeof D.globalRow=="number"?D.globalRow:D.row+a.topIndex;D.globalRow=G;const Y=G-h;return(G<h||G>m)&&A?(y+=1,!1):(D.row=Y,!0)}),this.state.stampPlacements.length>0&&this.state.stampPlacements[0]),Array.isArray(this.state.tripletPlacements)&&(this.state.tripletPlacements=this.state.tripletPlacements.filter(D=>{const P=typeof D.globalRow=="number"?D.globalRow:D.row+a.topIndex;D.globalRow=P;const G=P-h;return(P<h||P>m)&&A?(E+=1,!1):(D.row=G,!0)})),Array.isArray(this.state.annotations)&&this.state.annotations.length>0){const D={topIndex:h,bottomIndex:m};A?this.state.annotations=this.state.annotations.filter(P=>tg(P,a,D)):this.state.annotations.forEach(P=>tg(P,a,D))}if(this.state.printOptions){const D=this.state.printOptions.topRow??0,P=this.state.printOptions.bottomRow??w,G=a.topIndex-h,Y=Math.max(0,Math.min(w,D+G)),W=Math.max(Y,Math.min(w,P+G));this.state.printOptions={...this.state.printOptions,topRow:Y,bottomRow:W}}this.state.pitchRange={topIndex:h,bottomIndex:m},this.state.fullRowData=g;let H=null;if(typeof t.maintainGlobalStart=="number"&&Number.isFinite(t.maintainGlobalStart)){const D=Math.round(t.maintainGlobalStart-h);H=Math.max(0,Math.min(w,D))}const R={removedNotes:C,removedStamps:y,removedTriplets:E,maintainStartRow:H};this.emit("pitchRangeChanged",{topIndex:h,bottomIndex:m,metadata:R}),this.emit("layoutConfigChanged"),this.emit("notesChanged"),this.emit("stampPlacementsChanged"),this.emit("tripletPlacementsChanged"),this.emit("annotationsChanged"),this.recordState()},setDeviceProfile(s={}){const t=this.state.deviceProfile||{},e={isMobile:s.isMobile??t.isMobile??!1,isTouch:s.isTouch??t.isTouch??!1,isCoarsePointer:s.isCoarsePointer??t.isCoarsePointer??!1,orientation:s.orientation??t.orientation??"landscape",width:s.width??t.width??0,height:s.height??t.height??0},i=Object.keys(e).some(A=>e[A]!==t[A]);this.state.deviceProfile=e,i&&this.emit("deviceProfileChanged",e)}},Cx={setActiveChordIntervals(s){this.state.activeChordIntervals=s,this.emit("activeChordIntervalsChanged",s)},setIntervalsInversion(s){this.state.isIntervalsInverted=s,this.emit("intervalsInversionChanged",s)},setChordPosition(s){this.state.chordPositionState=s,this.emit("chordPositionChanged",s)}};b.moduleLoaded("paintActions","state");const bx={setMicPaintActive(s){this.state.paint.isMicPaintActive=s,b.debug("paintActions",`Mic Paint Active set to: ${s}`,null,"paint"),this.emit("micPaintStateChanged",s)},setPaintDetectionState(s){this.state.paint.isDetecting=s,b.debug("paintActions",`Paint detection state set to: ${s}`,null,"paint"),this.emit("paintDetectionStateChanged",s)},setDetectedPitch(s){this.state.paint.detectedPitch=s,this.emit("pitchDetected",s)},addPaintPoint(s){this.state.paint.paintHistory.push(s)},clearPaintHistory(){this.state.paint.paintHistory=[],b.debug("paintActions","Paint history cleared",null,"paint"),this.emit("paintHistoryChanged"),this.recordState()},setPaintSettings(s){Object.assign(this.state.paint.paintSettings,s),b.debug("paintActions","Paint settings updated",{settings:this.state.paint.paintSettings},"paint"),this.emit("paintSettingsChanged",this.state.paint.paintSettings),this.recordState()}};b.moduleLoaded("StampActions","stamps");function _x(){return`stamp-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const Td={addStampPlacement(s,t,e,i="#4a90e2"){const A=t+2,r=this.state.stampPlacements.find(h=>h.row===e&&h.startColumn<=A&&h.endColumn>=t);r&&Td.removeStampPlacement.call(this,r.id);const a=this.state.pitchRange||{topIndex:0,bottomIndex:this.state.fullRowData.length-1},l=e+a.topIndex,u={id:_x(),stampId:s,startColumn:t,endColumn:A,row:e,globalRow:l,color:i,timestamp:Date.now()};return this.state.stampPlacements.push(u),this.emit("stampPlacementsChanged"),b.debug("StampActions",`Added stamp ${s} at canvas-space ${t}-${A},${e}`,{stampId:s,startColumn:t,endColumn:A,row:e,placementId:u.id},"stamps"),u},removeStampPlacement(s){const t=this.state.stampPlacements.findIndex(i=>i.id===s);if(t===-1)return!1;const e=this.state.stampPlacements.splice(t,1)[0];return e?(this.emit("stampPlacementsChanged"),b.debug("StampActions",`Removed stamp ${e.stampId} at ${e.startColumn}-${e.endColumn},${e.row}`,{placementId:s,stampId:e.stampId,startColumn:e.startColumn,endColumn:e.endColumn,row:e.row},"stamps"),!0):!1},eraseStampsInArea(s,t,e,i){const A=[];for(const a of this.state.stampPlacements){const l=a.startColumn<=t&&a.endColumn>=s,u=a.row>=e&&a.row<=i;l&&u&&A.push(a.id)}let r=!1;return A.forEach(a=>{Td.removeStampPlacement.call(this,a)&&(r=!0)}),r},getAllStampPlacements(){return[...this.state.stampPlacements]},getStampAt(s,t){return this.state.stampPlacements.find(e=>e.row===t&&s>=e.startColumn&&s<=e.endColumn)||null},clearAllStamps(){const s=this.state.stampPlacements.length>0;this.state.stampPlacements=[],s&&(this.emit("stampPlacementsChanged"),b.info("StampActions","Cleared all stamp placements",null,"stamps"))},getStampPlaybackData(){return this.state.stampPlacements.map(s=>{const t=this.state.fullRowData[s.row];return{stampId:s.stampId,column:s.startColumn,startColumn:s.startColumn,endColumn:s.endColumn,row:s.row,pitch:t==null?void 0:t.toneNote,color:s.color,placement:s}}).filter(s=>s.pitch)},updateStampShapeOffset(s,t,e){const i=this.state.stampPlacements.find(A=>A.id===s);if(!i){b.warn("StampActions","[STAMP SHAPE OFFSET] Placement not found",{placementId:s},"stamps");return}i.shapeOffsets||(i.shapeOffsets={}),b.debug("StampActions","[STAMP SHAPE OFFSET] Updating shape offset",{placementId:s,shapeKey:t,oldOffset:i.shapeOffsets[t]||0,newOffset:e,baseRow:i.row,targetRow:i.row+e},"stamps"),i.shapeOffsets[t]=e,this.emit("stampPlacementsChanged")},getShapeRow(s,t){var i;const e=((i=s.shapeOffsets)==null?void 0:i[t])||0;return s.row+e}};b.moduleLoaded("TripletActions","triplets");function xx(){return`triplet-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}const Id={addTripletPlacement(s){this.state.tripletPlacements||(this.state.tripletPlacements=[]);const t=this.state.tripletPlacements.find(i=>i.row===s.row&&!(i.startCellIndex+i.span<=s.startCellIndex||s.startCellIndex+s.span<=i.startCellIndex));t&&Id.removeTripletPlacement.call(this,t.id),this.state.stampPlacements&&this.state.stampPlacements.filter(A=>{if(A.row!==s.row)return!1;const r=Math.floor(A.startColumn/2),a=Math.floor(A.endColumn/2),l=s.startCellIndex+s.span-1;return!(a<s.startCellIndex||r>l)}).forEach(A=>this.removeStampPlacement(A.id));const e={id:xx(),...s};return this.state.tripletPlacements.push(e),this.emit("tripletPlacementsChanged"),this.emit("rhythmStructureChanged"),b.debug("TripletActions",`Added triplet ${s.stampId} at cell ${s.startCellIndex}, row ${s.row}`,{stampId:s.stampId,startCellIndex:s.startCellIndex,span:s.span,row:s.row,placementId:e.id},"triplets"),e},removeTripletPlacement(s){if(!this.state.tripletPlacements)return!1;const t=this.state.tripletPlacements.findIndex(i=>i.id===s);if(t===-1)return!1;const e=this.state.tripletPlacements.splice(t,1)[0];return e?(this.emit("tripletPlacementsChanged"),b.debug("TripletActions",`Removed triplet ${e.stampId} at cell ${e.startCellIndex}, row ${e.row}`,{placementId:s,stampId:e.stampId,startCellIndex:e.startCellIndex,span:e.span,row:e.row},"triplets"),!0):!1},eraseTripletsInArea(s,t,e,i){if(!this.state.tripletPlacements)return!1;const A=Math.floor(s/2),r=Math.floor(t/2),a=[];for(const u of this.state.tripletPlacements)u.row>=e&&u.row<=i&&(u.startCellIndex+u.span-1<A||u.startCellIndex>r||a.push(u.id));let l=!1;return a.forEach(u=>{Id.removeTripletPlacement.call(this,u)&&(l=!0)}),l},getAllTripletPlacements(){return[...this.state.tripletPlacements||[]]},getTripletAt(s,t){return this.state.tripletPlacements&&this.state.tripletPlacements.find(e=>e.row===t&&s>=e.startCellIndex&&s<e.startCellIndex+e.span)||null},clearAllTripletPlacements(){if(!this.state.tripletPlacements)return;const s=this.state.tripletPlacements.length>0;this.state.tripletPlacements=[],s&&(this.emit("tripletPlacementsChanged"),b.info("TripletActions","Cleared all triplet placements",null,"triplets"))},getTripletPlaybackData(){return this.state.tripletPlacements?this.state.tripletPlacements.map(s=>{const t=this.state.fullRowData[s.row];return{startCellIndex:s.startCellIndex,stampId:s.stampId,row:s.row,pitch:(t==null?void 0:t.toneNote)??"",color:s.color,span:s.span,placement:s}}).filter(s=>s.pitch):[]},updateTripletShapeOffset(s,t,e){var A;const i=(A=this.state.tripletPlacements)==null?void 0:A.find(r=>r.id===s);if(!i){b.warn("TripletActions","[TRIPLET SHAPE OFFSET] Placement not found",{placementId:s},"triplets");return}i.shapeOffsets||(i.shapeOffsets={}),b.debug("TripletActions","[TRIPLET SHAPE OFFSET] Updating shape offset",{placementId:s,shapeKey:t,oldOffset:i.shapeOffsets[t]||0,newOffset:e,baseRow:i.row,targetRow:i.row+e},"triplets"),i.shapeOffsets[t]=e,this.emit("tripletPlacementsChanged")},getTripletShapeRow(s,t){var i;const e=((i=s.shapeOffsets)==null?void 0:i[t])||0;return s.row+e}};b.moduleLoaded("Store","general");const Gf="studentNotationState";function Ex(){var s,t,e;try{const i=localStorage.getItem(Gf);if(i===null)return;const A=JSON.parse(i);if(A.timbres)for(const r in A.timbres){const a=A.timbres[r];if(a.coeffs&&typeof a.coeffs=="object"){const l=Array.isArray(a.coeffs)?a.coeffs:Object.values(a.coeffs);a.coeffs=new Float32Array(l)}if(a.phases&&typeof a.phases=="object"){const l=Array.isArray(a.phases)?a.phases:Object.values(a.phases);a.phases=new Float32Array(l)}}if(A.paint){const r=bd.paint||{},a=A.paint;A.paint={...r,...a,paintSettings:{...r.paintSettings,...a.paintSettings||{}}}}if(A.printOptions&&(A.printOptions={...bd.printOptions,...A.printOptions}),A.pitchRange){const r=(me==null?void 0:me.length)||((s=A.fullRowData)==null?void 0:s.length)||0,a=Math.max(0,r-1),l=Math.max(0,Math.min(a,A.pitchRange.topIndex??0)),u=Math.max(l,Math.min(a,A.pitchRange.bottomIndex??a));A.pitchRange={topIndex:l,bottomIndex:u}}return Array.isArray(A.parkedNotes)||(A.parkedNotes=[]),(t=A.placedNotes)!=null&&t.length&&A.placedNotes.forEach(lc),(e=A.parkedNotes)!=null&&e.length&&A.parkedNotes.forEach(lc),A}catch(i){b.error("Store","Could not load state from localStorage",i,"general");return}}function Lc(s){var t;try{const e=JSON.parse(JSON.stringify({placedNotes:s.placedNotes,parkedNotes:s.parkedNotes,placedChords:s.placedChords,tonicSignGroups:s.tonicSignGroups,stampPlacements:s.stampPlacements,tripletPlacements:s.tripletPlacements,timbres:s.timbres,macrobeatGroupings:s.macrobeatGroupings,macrobeatBoundaryStyles:s.macrobeatBoundaryStyles,hasAnacrusis:s.hasAnacrusis,baseMicrobeatPx:s.baseMicrobeatPx,modulationMarkers:s.modulationMarkers,tempo:s.tempo,activeChordIntervals:s.activeChordIntervals,selectedNote:s.selectedNote,annotations:s.annotations,pitchRange:s.pitchRange,snapZoomToRange:s.snapZoomToRange,isPitchRangeLocked:s.isPitchRangeLocked,degreeDisplayMode:s.degreeDisplayMode,paint:{paintHistory:s.paint.paintHistory,paintSettings:s.paint.paintSettings}}));if(s.timbres)for(const A in s.timbres){const r=s.timbres[A],a=(t=e.timbres)==null?void 0:t[A];r!=null&&r.coeffs&&a&&(a.coeffs=Array.from(r.coeffs)),r!=null&&r.phases&&a&&(a.phases=Array.from(r.phases))}const i=JSON.stringify(e);localStorage.setItem(Gf,i)}catch(e){b.error("Store","Could not save state to localStorage",e,"general")}}const eg={...zb,...mx,...gx,...yx,...Fd,...Cx,...bx,...Td,...Id,clearSavedState(){try{localStorage.removeItem(Gf),localStorage.removeItem("effectDialValues"),window.location.reload()}catch(s){b.error("Store","Could not clear state from localStorage",s,"general")}}},uo={},qf=Ex(),Sx=!qf,Fx={...bd,...qf},d={state:Fx,on(s,t){uo[s]||(uo[s]=[]),uo[s].push(t)},emit(s,t){uo[s]&&uo[s].forEach(e=>{try{e(t)}catch(i){b.error("Store",`Error in listener for event "${s}"`,i,"general")}})},_isBoundaryInAnacrusis:()=>!1,addNote:()=>null,updateNoteTail:()=>{},updateMultipleNoteTails:()=>{},updateNoteRow:()=>{},updateMultipleNoteRows:()=>{},removeNote:()=>{},removeMultipleNotes:()=>{},clearAllNotes:()=>{},loadNotes:()=>{},recordState:()=>{},undo:()=>{},redo:()=>{},clearSavedState:()=>{},setPlaybackState:()=>{},setLooping:()=>{},setADSR:()=>{},setAdsrTimeAxisScale:()=>{},setAdsrComponentWidth:()=>{},setPaintSettings:()=>{},setMicPaintActive:()=>{},addPaintPoint:()=>{},clearPaintHistory:()=>{},setPaintDetectionState:()=>{},setDetectedPitch:()=>{},increaseMacrobeatCount:()=>{},decreaseMacrobeatCount:()=>{},updateTimeSignature:()=>{},setAnacrusis:()=>{},addModulationMarker:()=>null,removeModulationMarker:()=>{},setModulationRatio:()=>{},clearModulationMarkers:()=>{},addStampPlacement:()=>({}),removeStampPlacement:()=>!1,eraseStampsInArea:()=>!1,getAllStampPlacements:()=>[],getStampAt:()=>null,clearAllStamps:()=>{},getStampPlaybackData:()=>[],addTripletPlacement:()=>({}),removeTripletPlacement:()=>!1,eraseTripletsInArea:()=>!1,getAllTripletPlacements:()=>[],getTripletAt:()=>null,clearAllTripletPlacements:()=>{},getTripletPlaybackData:()=>[],setSelectedTool:()=>{},setSelectedNote:()=>{},setTempo:()=>{},applyPreset:()=>{},setPitchRange:()=>{},setLayoutConfig:()=>{},setSnapZoomToRange:()=>{},setActiveChordIntervals:()=>{},setIntervalsInversion:()=>{},setChordPosition:()=>{},toggleAccidentalMode:()=>{},toggleFrequencyLabels:()=>{},toggleFocusColours:()=>{},setDegreeDisplayMode:()=>{},toggleWaveformExtendedView:()=>{},shiftGridUp:()=>{},shiftGridDown:()=>{},toggleMacrobeatGrouping:()=>{},cycleMacrobeatBoundaryStyle:()=>{},setFilterSettings:()=>{},setDeviceProfile:()=>{},setPrintPreviewActive:()=>{},setPrintOptions:()=>{}};d.isColdStart=Sx;for(const s in eg)d[s]=eg[s];d.on("tempoChanged",()=>{Lc(d.state)});d.on("degreeDisplayModeChanged",()=>{Lc(d.state)});const Tx=d.recordState;d.recordState=function(){Tx.call(this),Lc(this.state)};qf||Lc(d.state);let bo=null,Qd=null,Ho=null,No=null;d.on("modulationMarkersChanged",()=>{Px()});d.on("scrollChanged",()=>{Ho=null,No=null});d.on("zoomChanged",()=>{Ho=null,No=null});function Ix(s){const t=JSON.stringify({markers:s.modulationMarkers||[],baseMicrobeatPx:s.baseMicrobeatPx??s.cellWidth??40});if(bo&&t===Qd)return bo;const e=s.baseMicrobeatPx??s.cellWidth??40;return bo=Bx(s.modulationMarkers||[],e,s),Qd=t,bo}function xv(){const s=performance.now();return(!Ho||!No||s-No>1)&&(Ho=Ot.getViewportInfo(),No=s),Ho}function _t(s,t){const i=t.musicalColumnWidths&&t.musicalColumnWidths.length>0?t.musicalColumnWidths:t.columnWidths||[],A=t.cellWidth;s<3&&typeof window<"u"&&!window.__columnXDebugLogged&&s===2&&(window.__columnXDebugLogged=!0);const r=Math.floor(s),a=s-r,l=t.modulationMarkers&&t.modulationMarkers.length>0?Ix(t):null;let u=0;for(let h=0;h<r;h++){const g=(i[h]!==void 0?i[h]:1)*A,w=l?l.getScaleForColumn(h):1,C=g*w;u+=C}if(a>0&&r<i.length){const m=(i[r]!==void 0?i[r]:1)*A,g=l?l.getScaleForColumn(r):1,w=m*g;u+=a*w}return u}function qt(s,t){const e=xv(),i=s-e.startRank,A=t.cellHeight/2;return i*A}function Qx(s){let t=(s||"").replace(/\d/g,"").trim();return t=t.replace(/b/g,"b-").replace(/#/g,"b_"),t}function Mx(s){switch(s){case"C":return{lineWidth:3.33,dash:[],color:"#adb5bd"};case"E":return{lineWidth:1,dash:[5,5],color:"#adb5bd"};case"G":return{lineWidth:1,dash:[],color:"#dee2e6"};case"B":case"A":case"F":case"Eb/Db":case"Db/C#":return{lineWidth:1,dash:[],color:"#ced4da"};default:return{lineWidth:1,dash:[],color:"#ced4da"}}}function Ux(){const s=Ot.getViewportInfo(),{startRank:t,endRank:e}=s;return{startRow:t,endRow:e}}function Px(){bo=null,Qd=null}function Ev(s,t){const e=t.musicalColumnWidths||t.columnWidths||[];if(t.cellWidth===0)return 0;for(let A=0;A<e.length;A++){const r=_t(A,t),a=_t(A+1,t);if(s>=r&&s<a){const l=a-r;if(l>0){const u=(s-r)/l;return A+u}return A}}return e.length>0?e.length-1:0}function Dx(s,t){const e=xv(),i=t.cellHeight/2;return s/i+e.startRank}function kx(s){const{macrobeatGroupings:t}=s,e=hi(s),i=[...s.columnWidths||[]],A=[tl,tl];b.debug("Columns Layout","Starting column width calculation",null,"layout"),b.debug("Columns Layout","Placed tonic signs",e.map(u=>`col:${u.columnIndex},mb:${u.preMacrobeatIndex}`),"layout"),b.debug("Columns Layout","Old columnWidths",i,"layout"),b.debug("Columns Layout","Macrobeat groupings",t,"layout");const r=[...e].sort((u,h)=>u.preMacrobeatIndex-h.preMacrobeatIndex);let a=0;const l=u=>{var h;for(;a<r.length;){const m=r[a];if((m==null?void 0:m.preMacrobeatIndex)!==u)break;b.debug("Columns Layout",`Adding tonic columns for mbIndex ${u}, tonic at column ${m.columnIndex}`,null,"layout");const g=A.length;A.push(el),A.push(el),b.debug("Columns Layout",`Added 2 columns (width=${el} each), total columns: ${g} -> ${A.length}`,null,"layout");const w=m.uuid;for(;a<r.length&&((h=r[a])==null?void 0:h.uuid)===w;)a++}};return l(-1),t.forEach((u,h)=>{for(let m=0;m<u;m++)A.push(el);l(h)}),A.push(tl,tl),b.debug("Columns Layout","Final newColumnWidths",A,"layout"),b.debug("Columns Layout","Width change",`${i.length} -> ${A.length} columns`,"layout"),b.debug("Columns Layout","Old total width units",i.reduce((u,h)=>u+h,0),"layout"),b.debug("Columns Layout","New total width units",A.reduce((u,h)=>u+h,0),"layout"),A}function Lx(s,t,e){let i=0;for(let r=0;r<s;r++)i+=(t[r]||0)*e;const A=((t[0]||0)+(t[1]||0))*e;return i-A}function Rx(s,t){return s.reduce((e,i)=>e+i,0)*t}const wr=30;let ke=1,Pi=Tb,Gn=0,AA,Nl,Md,_o,xo,ai,Eo,Ud,Sv,Fv,Tv,Iv,Qv,Cn,aA,Pd,Uh=null,Ol=!1,Ys=!1,Ph=!1,Dh=!1,Dd=!1,Vl=null;const Hx=new Promise(s=>{Vl=()=>s()});let kh=0,Lh=0,Oo=!1,Vo=null;function kd(){var a;const s=((a=d.state.fullRowData)==null?void 0:a.length)||0;if(s===0)return mr;const t=document.getElementById("pitch-grid-container"),e=Gn||window.innerHeight||0,i=(t==null?void 0:t.clientHeight)||(e?e*.7:0);if(!i||i<=0)return mr;const A=2*i/(s*wr);return Math.max(mr,A)}function Nx(){const s=(window==null?void 0:window.devicePixelRatio)??1;return!Number.isFinite(s)||s<=0?1:s}function ho(s,t,e,i,A){if(!s)return!1;const r=Number.isFinite(i)&&i>0?i:1;s.dataset.pixelRatio=`${r}`;let a=!1;if(typeof t=="number"){const l=Math.max(1,Math.round(t*r));Math.abs(s.width-l)>.5&&(s.width=l,a=!0),s.style.width=`${t}px`,s.dataset.logicalWidth=`${t}`}if(typeof e=="number"){const l=Math.max(1,Math.round(e*r));Math.abs(s.height-l)>.5&&(s.height=l,a=!0),s.style.height=`${e}px`,s.dataset.logicalHeight=`${e}`}if(a){const l=A||s.getContext("2d");l&&l.setTransform(r,0,0,r,0,0)}return a}function Ox(){AA=document.getElementById("pitch-grid-wrapper"),Nl=document.getElementById("notation-grid"),_o=document.getElementById("legend-left-canvas"),xo=document.getElementById("legend-right-canvas"),ai=document.getElementById("drum-grid-wrapper"),Eo=document.getElementById("drum-grid"),Sv=document.getElementById("drum-playhead-canvas"),Fv=document.getElementById("playhead-canvas"),Tv=document.getElementById("hover-canvas"),Iv=document.getElementById("drum-hover-canvas"),Qv=document.getElementById("pitch-paint-canvas"),Cn=document.getElementById("button-grid"),aA=document.getElementById("grid-scrollbar-proxy"),Pd=(aA==null?void 0:aA.querySelector(".grid-scrollbar-inner"))||null;const s=document.getElementById("canvas-container");if(!AA||!Nl||!s)return{};Md=Nl.getContext("2d"),Ud=(Eo==null?void 0:Eo.getContext("2d"))||null;const t=(_o==null?void 0:_o.getContext("2d"))||null,e=(xo==null?void 0:xo.getContext("2d"))||null;return{ctx:Md,drumCtx:Ud,legendLeftCtx:t,legendRightCtx:e,canvasContainer:s}}function Vx(){var e;if(Dd)return;const s=(((e=d.state.columnWidths)==null?void 0:e.length)||0)>0,t=!!(d.state.cellWidth&&d.state.cellWidth>0);!s||!t||(Dd=!0,Vl==null||Vl())}function Vn(){var Nt,Wt;if(!AA||AA.clientHeight===0){Ph||(b.warn("LayoutService","Pitch grid wrapper not ready for layout (height=0). Retrying on next frame.",null,"layout"),Ph=!0),requestAnimationFrame(Vn);return}if(Ph=!1,Ol)return;Ol=!0;const s=document.getElementById("pitch-grid-container");AA.clientWidth;const t=window.innerHeight;(Math.abs(t-Gn)>3||Gn===0)&&(Gn=t);const i=kd();ke<i&&(ke=i,b.debug("LayoutService",`[Zoom] Enforcing minimum zoom to maintain grid height: ${Math.round(ke*100)}%`,null,"layout"));const A=wr,r=A*Ib,a=A*ke,l=r*ke;d.setLayoutConfig({cellHeight:a,cellWidth:l});const u=kx(d.state);d.setLayoutConfig({columnWidths:u}),Vx(),(!d.state.cellWidth||!u.length)&&b.warn("LayoutService","Unexpected layout configuration",{cellWidth:d.state.cellWidth,columnCount:u.length},"layout");const m=u.reduce((Qt,Et)=>Qt+Et,0)*d.state.cellWidth,g=Ot.getModulatedCanvasWidth(),w=d.state.modulationMarkers&&d.state.modulationMarkers.length>0,y=Math.round(w?g:m),E=Nx();document.getElementById("drum-grid-wrapper");const x=document.getElementById("grids-wrapper"),T=y+"px";if(s&&(s.style.width=T),AA&&(AA.style.width=T),ai&&(ai.style.width=T),Pd&&aA){Pd.style.width=T;const Qt=(x==null?void 0:x.getBoundingClientRect().width)||0;y>Qt?aA.style.display="":aA.style.display="none"}const U=Math.max(na,ia*d.state.cellHeight),H=Um*U,R=`${H}px`,D=((Nt=d.state.columnWidths)==null?void 0:Nt.length)??0,P=2,G=D-2;let Y=0;if(w){const Qt=d.state.musicalColumnWidths||[],Et={...d.state,columnWidths:d.state.columnWidths,musicalColumnWidths:Qt,cellWidth:d.state.cellWidth,modulationMarkers:d.state.modulationMarkers};Y=_t(Qt.length,Et)}else for(let Qt=P;Qt<G;Qt++)Y+=(d.state.columnWidths[Qt]||0)*d.state.cellWidth;if(D<=4&&b.warn("LayoutService","Column widths array does not contain interior columns.",{columnWidthsCount:D,columnWidths:d.state.columnWidths},"layout"),Y<50&&D>4&&b.warn("LayoutService","Computed button-grid middle cell width is unexpectedly small.",{middleCellWidth:Y,columnWidthsSample:(Wt=d.state.columnWidths)==null?void 0:Wt.slice(0,10),cellWidth:d.state.cellWidth,macrobeatGroupings:d.state.macrobeatGroupings},"layout"),Cn){const Qt=Cn.querySelector(".button-grid-left-cell"),Et=Cn.querySelector(".button-grid-middle-cell"),zt=Cn.querySelector(".button-grid-right-cell"),oe=d.state.columnWidths.slice(0,2).reduce(($t,Me)=>$t+Me*d.state.cellWidth,0),ge=d.state.columnWidths.slice(-2).reduce(($t,Me)=>$t+Me*d.state.cellWidth,0);(Math.abs(Lh-H)>5||Lh===0)&&(Cn.style.height=R,Lh=H);const ae=($t,Me)=>{if(!$t)return;const Ms=`${Math.max(0,Me)}px`;$t.style.width=Ms,$t.style.flex=`0 0 ${Ms}`,$t.style.maxWidth=Ms,$t.style.minWidth=Ms,$t.style.height=R};if(Qt){ae(Qt,oe);const $t=Qt.getBoundingClientRect();oe>0&&$t.width===0&&b.warn("LayoutService","Left button-grid cell measured width is 0 after assignment.",{assignedWidth:oe,measuredWidth:$t.width,computedDisplay:window.getComputedStyle(Qt).display},"layout")}if(Et){Y===0&&b.warn("LayoutService","Calculated middle button-grid width is 0. Check column width data.",{columnWidths:d.state.columnWidths,cellWidth:d.state.cellWidth},"layout"),ae(Et,Y);const $t=Et.getBoundingClientRect();if(Y>0&&$t.width===0&&b.warn("LayoutService","Middle button-grid cell assigned width but still measures 0.",{assignedWidth:Y,measuredWidth:$t.width,computedStyles:window.getComputedStyle(Et)},"layout"),Math.abs($t.width-Y)>5&&(b.warn("LayoutService","Middle cell measured width does not match assigned width.",{assignedWidth:Y,measuredWidth:$t.width,styleWidth:Et.style.width,cellWidth:d.state.cellWidth},"layout"),requestAnimationFrame(()=>{const Me=Et.getBoundingClientRect();Math.abs(Me.width-Y)>5&&b.warn("LayoutService","Middle cell still mismatched after RAF.",{assignedWidth:Y,measuredWidth:Me.width,delta:Me.width-Y,computedStyles:window.getComputedStyle(Et)},"layout")})),!Dh){const Me=Et.querySelector("#beat-line-button-layer");if(Me){const Ms=Me.getBoundingClientRect();if(Ms.width===0){const os=window.getComputedStyle(Me);b.warn("LayoutService","#beat-line-button-layer width is 0 despite middle cell sizing.",{beatLineRect:Ms,beatLineStyles:{display:os.display,position:os.position,flex:{direction:os.flexDirection,grow:os.flexGrow,shrink:os.flexShrink,basis:os.flexBasis},width:os.width,minWidth:os.minWidth,maxWidth:os.maxWidth},middleRect:$t,middleCellComputedWidth:os.width},"layout"),Dh=!0}}else b.warn("LayoutService","Could not find #beat-line-button-layer inside middle cell to measure.",null,"layout"),Dh=!0}}if(zt){ae(zt,ge);const $t=zt.getBoundingClientRect();ge>0&&$t.width===0&&b.warn("LayoutService","Right button-grid cell measured width is 0 after assignment.",{assignedWidth:ge,measuredWidth:$t.width,computedDisplay:window.getComputedStyle(zt).display},"layout")}const bs=oe+Y+ge;Number.isFinite(bs)&&bs>0&&(Cn.style.width=T,Cn.style.maxWidth=T,Cn.style.minWidth=T),Cn.getBoundingClientRect().width===0&&b.warn("LayoutService","Entire button grid wrapper width is 0 after layout pass.",{leftCellWidth:oe,middleCellWidth:Y,rightCellWidth:ge,wrapperStyles:window.getComputedStyle(Cn)},"layout")}const W=Math.max(na,ia*d.state.cellHeight),at=Um*W,Bt=`${at}px`,dt=(s==null?void 0:s.clientHeight)||0,X=((u[0]||0)+(u[1]||0))*d.state.cellWidth,nt=((u[u.length-2]||0)+(u[u.length-1]||0))*d.state.cellWidth,mt=Math.round(y-X-nt),ct=Math.round(X),J=Math.round(nt),st=[{element:Nl,context:Md},{element:Fv},{element:Tv},{element:Qv}];if(st.forEach(({element:Qt,context:Et})=>{ho(Qt,mt,void 0,E,Et),Qt&&(Qt.style.left=`${ct}px`)}),ho(_o,ct,dt,E,null),ho(xo,J,dt,E,null),[{element:Eo,context:Ud},{element:Sv},{element:Iv}].forEach(({element:Qt,context:Et})=>{ho(Qt,mt,at,E,Et)}),ai){const Qt=ai.querySelector(".drum-grid-left-cell"),Et=ai.querySelector(".drum-grid-middle-cell"),zt=ai.querySelector(".drum-grid-right-cell"),oe=(re,Re)=>{if(!re)return;const ae=`${Math.max(0,Math.round(Re))}px`;re.style.width=ae,re.style.flex=`0 0 ${ae}`,re.style.maxWidth=ae,re.style.minWidth=ae,re.style.height=Bt};oe(Qt,ct),oe(Et,mt),oe(zt,J);const ge=Et==null?void 0:Et.querySelector("#drum-canvas-wrapper");ge&&(ge.style.width="100%",ge.style.height=Bt)}const vt=Math.abs(kh-at)>5;ai&&(vt||kh===0)&&(ai.style.height=Bt,kh=at);const Mt=E,Pt=mt;if(setTimeout(()=>{const Qt=document.getElementById("pitch-grid-container"),Et=(Qt==null?void 0:Qt.clientHeight)||0;st.forEach(({element:zt,context:oe})=>{ho(zt,Pt,Et,Mt,oe),zt&&(zt.style.left=`${ct}px`)}),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"layoutService-deferred"}}))}),Vo!==null){const Qt=d.state.fullRowData.length;if(Qt<=0)Pi=0;else{const Et=Math.max(0,Math.min(Qt-1,Vo)),zt=document.getElementById("pitch-grid-container"),oe=(zt==null?void 0:zt.clientHeight)||Gn*.7,re=(d.state.cellHeight||wr)/2,Re=Math.max(0,Qt*re-oe);if(Re<=0)Pi=0;else{const ae=Et*re;Pi=Math.max(0,Math.min(1,ae/Re))}}Vo=null}d.emit("layoutConfigChanged"),Ol=!1,Oo&&(Oo=!1,Ot.snapZoomToCurrentRange())}const Ot={init(){const{ctx:s,drumCtx:t,legendLeftCtx:e,legendRightCtx:i,canvasContainer:A}=Ox();requestAnimationFrame(Vn),this.initScrollHandler();const r=()=>{Ol||(Uh!==null&&clearTimeout(Uh),Uh=setTimeout(()=>{Vn()},Fb))};return window.addEventListener("resize",r),d.on("zoomIn",()=>{this.zoomIn()}),d.on("zoomOut",()=>{this.zoomOut()}),{ctx:s,drumCtx:t,legendLeftCtx:e,legendRightCtx:i}},waitForInitialLayout(){return Dd?Promise.resolve():Hx},getCurrentZoomLevel(){return ke},setZoomLevel(s){ke=s,Vn()},_canScrollRange(s){const t=d.state.pitchRange;if(!t||!me||me.length===0)return!1;const e=me.length-1,i=typeof s=="string"?s==="up"?-1:1:s,A=i<0&&t.topIndex>0,r=i>0&&t.bottomIndex<e;return A||r},initScrollHandler(){const s=document.getElementById("pitch-grid-wrapper");s&&s.addEventListener("wheel",t=>{if(t.preventDefault(),t.ctrlKey||t.metaKey)t.deltaY<0?this.zoomIn():this.zoomOut();else{const e=t.deltaY>0?1:-1;d.state.isPitchRangeLocked?this.scrollByPixels(t.deltaY):this._canScrollRange(e)?this.scrollByUnits(e):this.scrollByPixels(t.deltaY)}},{passive:!1})},zoomIn(){Ys||(d.state.snapZoomToRange&&d.setSnapZoomToRange(!1),Ys=!0,ke=Math.min(co,ke*Qb),b.debug("LayoutService",`[Zoom] Zoom level: ${Math.round(ke*100)}%`,null,"layout"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Vn(),Ys=!1})}))},zoomOut(){if(!Ys){if(d.state.snapZoomToRange&&d.setSnapZoomToRange(!1),Ys=!0,d.state.isPitchRangeLocked){const s=Math.max(mr,ke*Pm),t=kd(),e=Math.max(t,s);e!==s&&b.debug("LayoutService",`[Zoom] Minimum zoom reached (locked); clamping to ${Math.round(e*100)}%`,null,"layout"),ke=e,b.debug("LayoutService",`[Zoom] Zoom level: ${Math.round(ke*100)}%`,null,"layout")}else{const s=d.state.pitchRange||{topIndex:0,bottomIndex:me.length-1},t=2,e=2,i=Math.max(0,s.topIndex-t),A=Math.min(me.length-1,s.bottomIndex+e);if(i!==s.topIndex||A!==s.bottomIndex){s.bottomIndex-s.topIndex+1;const a=A-i+1;d.setPitchRange({topIndex:i,bottomIndex:A},{trimOutsideRange:!1,preserveContent:!0});const l=document.getElementById("pitch-grid-container"),h=2*((l==null?void 0:l.clientHeight)||Gn*.7)/(a*wr);ke=Math.max(mr,Math.min(co,h))}else ke=Math.max(mr,ke*Pm)}requestAnimationFrame(()=>{requestAnimationFrame(()=>{Vn(),Ys=!1})})}},resetZoom(){Ys||(d.state.snapZoomToRange&&d.setSnapZoomToRange(!1),Ys=!0,ke=1,b.debug("LayoutService","[Zoom] Zoom level reset to 100%",null,"layout"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Vn(),Ys=!1})}))},snapZoomToCurrentRange(){if(Ys){Oo=!0;return}const s=kd(),t=Math.min(co,s);if(!isFinite(t)||t<=0)return;const e=Math.abs(ke-t)>1e-4;Ys=!0,ke=t,s>co+1e-4?b.debug("LayoutService",`[Zoom] Snap zoom limited by MAX_ZOOM_LEVEL (${Math.round(co*100)}%)`,null,"layout"):e&&b.debug("LayoutService",`[Zoom] Snap zoom to range: ${Math.round(ke*100)}%`,null,"layout"),requestAnimationFrame(()=>{requestAnimationFrame(()=>{Vn(),Ys=!1,Oo&&(Oo=!1,this.snapZoomToCurrentRange())})})},setPendingStartRow(s){typeof s=="number"&&Number.isFinite(s)?Vo=Math.max(0,s):Vo=null},scroll(s){const t=s/Gn/4;Pi=Math.max(0,Math.min(1,Pi+t)),d.emit("layoutConfigChanged")},scrollByUnits(s){const t=d.state.pitchRange;if(!t||!me||me.length===0||d.state.isPitchRangeLocked)return;const e=t.topIndex+s,i=t.bottomIndex+s,A=me.length-1;e<0||i>A||d.setPitchRange({topIndex:e,bottomIndex:i},{trimOutsideRange:!1,preserveContent:!0})},scrollByPixels(s,t=0){const e=d.state.fullRowData.length,A=(d.state.cellHeight||wr)*ke,a=e*A,l=Math.max(0,a-Gn);if(l>0){const u=s/l;Pi=Math.max(0,Math.min(1,Pi+u))}d.emit("layoutConfigChanged")},getViewportInfo(){const s=d.state.fullRowData.length,t=document.getElementById("pitch-grid-container"),e=(t==null?void 0:t.clientHeight)||Gn*.7,i=d.state.cellHeight||wr,A=i/2,a=s*A,u=Math.max(0,a-e)*Pi,h=Math.max(0,Math.floor(u/A)),m=e/A,g=Math.min(s,Math.ceil(h+m));return{zoomLevel:ke,viewportHeight:Gn,containerHeight:e,cellHeight:i,halfUnit:A,startRank:h,endRank:g,scrollOffset:u}},getMacrobeatWidthPx(s,t){return t*s.cellWidth},getColumnX(s){return Lx(s,d.state.columnWidths,d.state.cellWidth)},getCanvasWidth(){return Rx(d.state.columnWidths,d.state.cellWidth)},getModulatedCanvasWidth(){const s=this.getCanvasWidth();if(!d.state.modulationMarkers||d.state.modulationMarkers.length===0)return s;try{const t=d.state.cellWidth||40,e=d.state.columnWidths||[],i=d.state.musicalColumnWidths||[],A={...d.state,columnWidths:e,musicalColumnWidths:i,cellWidth:t,modulationMarkers:d.state.modulationMarkers},r=_t(i.length,A),a=((e[0]||0)+(e[1]||0))*t,l=((e[e.length-2]||0)+(e[e.length-1]||0))*t;return a+r+l}catch{return s}},recalculateLayout(){Vn()},reflow(){Vn()},get isZooming(){return Ys}};let Rh=null,Hh=null,Nh=null,Oh=null;const oa={setContexts({ctx:s,drumCtx:t,legendLeftCtx:e,legendRightCtx:i}){Rh=s??null,Hh=t??null,Nh=e??null,Oh=i??null},getPitchContext(){return Rh||b.error("CanvasContextService","Pitch context requested before it was set.",null,"canvas"),Rh},getDrumContext(){return Hh||b.error("CanvasContextService","Drum context requested before it was set.",null,"canvas"),Hh},getLegendLeftContext(){return Nh||b.error("CanvasContextService","Legend left context requested before it was set.",null,"canvas"),Nh},getLegendRightContext(){return Oh||b.error("CanvasContextService","Legend right context requested before it was set.",null,"canvas"),Oh}};function Mv(s,t){return t.some(e=>e.columnIndex===s)}function Wx(s,t){return t.some(e=>s===e.columnIndex||s===e.columnIndex+1)}function zf(s,t){const e=hi(t);return!Wx(s,e)}function Uv(s,t){for(const e of t)if(s===e.columnIndex+1)return!1;return t.some(e=>s===e.columnIndex+2),!0}function rs(s){var i;if(!s)return 0;const t=(i=s.dataset)==null?void 0:i.logicalWidth,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:s.width||0}function _e(s){var i;if(!s)return 0;const t=(i=s.dataset)==null?void 0:i.logicalHeight,e=t!==void 0?Number(t):NaN;return Number.isFinite(e)?e:s.height||0}function Kx(s,t,e,i){var A;for(let r=e;r<=i;r++){const a=t.fullRowData[r];if(!a)continue;const l=qt(r,t);if(l<-10||l>t.viewportHeight+10)continue;const u=Qx(a.pitch);if(["B","A","F","E/D","D/C"].includes(u))continue;const m=Mx(u),g=t.musicalColumnWidths||((A=t.columnWidths)==null?void 0:A.slice(2,-2))||[],w=_t(0,t),C=_t(g.length,t);u==="G"?(s.fillStyle=m.color,s.fillRect(w,l-t.cellHeight/2,C-w,t.cellHeight)):(s.beginPath(),s.moveTo(w,l),s.lineTo(C,l),s.lineWidth=m.lineWidth,s.strokeStyle=m.color,s.setLineDash(m.dash),s.stroke(),s.setLineDash([]))}}function Gx(s,t,e,i){Kx(s,t,e,i)}function qx(s,t){zx(s,t)}function zx(s,t){const{columnWidths:e,macrobeatGroupings:i,macrobeatBoundaryStyles:A,placedTonicSigns:r}=t,a=t.musicalColumnWidths||e.slice(2,-2),l=e.length,u=[];let h=2;for(let m=0;m<i.length;m++){for(;r.some(w=>w.columnIndex===h);)h+=2;const g=i[m]??0;h+=g,u.push(h)}for(let m=0;m<=l;m++){let g;const w=m===2||m===l-2,C=Mv(m,r),y=r.some(R=>m===R.columnIndex+2),E=u.includes(m);if(!Uv(m,r))continue;if(w||C||y)g={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(E){const R=u.indexOf(m);if(R!==-1){const D=A[R]??"dashed";if(D==="anacrusis")continue;g={lineWidth:1,strokeStyle:"#adb5bd",dash:D==="solid"?[]:[5,5]};const P=m-2;_t(P,t)}else continue}else continue;if(!g)continue;const T=m-2;if(T<0||T>a.length)continue;const U=_t(T,t),H=g;s.beginPath(),s.moveTo(U,0),s.lineTo(U,_e(s.canvas)),s.lineWidth=H.lineWidth,s.strokeStyle=H.strokeStyle,s.setLineDash(H.dash),s.stroke()}s.setLineDash([])}const sg=["major","dorian","phrygian","lydian","mixolydian","minor","locrian"];function $x(s){const t=hi(s);if(t.length===0)return{leftTonic:null,rightTonic:null};const e=t.reduce((A,r)=>r.columnIndex<A.columnIndex?r:A),i=t.reduce((A,r)=>r.columnIndex>A.columnIndex?r:A);return{leftTonic:e,rightTonic:t.length===1?e:i}}function ng(s,t){const e=t[s];if(!e)return null;const A=e.pitch.replace(/\d+$/,"");return(A.includes("/")?A.split("/")[0]??A:A).replace(//g,"b").replace(//g,"#")}function ig(s,t){if(!s||!t)return[];const e=t-1;if(e<0||e>=sg.length)return b.warn("LegendRenderer",`Invalid tonic number: ${t}`,null,"grid"),[];const i=sg[e];try{const A=`${s} ${i}`;return ax(A).notes||[]}catch(A){return b.warn("LegendRenderer",`Could not generate ${i} scale`,{tonic:s,error:A},"grid"),[]}}function Ag(s,t){if(!s||!t.length)return!1;const e=s.replace(/\d+$/,"");return(e.includes("/")?e.split("/"):[e]).map(r=>r.replace(//g,"b").replace(//g,"#")).some(r=>t.some(a=>{try{return li(r)===li(a)||r===a}catch{return r===a}}))}function Xx(s,t,e,i,A){const{fullRowData:r,columnWidths:a,cellWidth:l,cellHeight:u,colorMode:h}=e,m=h??"color",{sharp:g,flat:w}=d.state.accidentalMode,{focusColours:C,showFrequencyLabels:y}=d.state;let E=[],x=[];if(C){const R=$x(d.state);if(R.leftTonic){const D=ng(R.leftTonic.row,r);E=ig(D,R.leftTonic.tonicNumber)}if(R.rightTonic){const D=ng(R.rightTonic.row,r);x=ig(D,R.rightTonic.tonicNumber)}}const T=(R,D=[],P=null)=>{if(y){const dt=C&&Array.isArray(D)&&D.length>0,X=P?Ag(P.pitch,D):!1;return dt&&P&&!X?null:P&&P.frequency?String(P.frequency):R}if(!P){const dt=R.match(/^([A-G][#b]*)(\d+)$/);if(!dt)return R;const X=dt[1]??"",nt=dt[2]??"",mt=X.replace(//g,"").replace(//,"#")||X,ct=X.replace(//g,"").replace(/#/g,"b")||X;return g&&w?`${ct}/${mt}${nt}`:g&&!w?`${mt}${nt}`:w&&!g?`${ct}${nt}`:`${mt}${nt}`}const G=P.sharpName||P.pitch,Y=P.flatName||P.pitch,W=G.replace(//g,"#").replace(/\d+$/,""),at=Y.replace(//g,"b").replace(/\d+$/,"");if(C&&D.length>0){const dt=D.some(nt=>{try{return li(nt)===li(at)||nt===at}catch{return nt===at}}),X=D.some(nt=>{try{return li(nt)===li(W)||nt===W}catch{return nt===W}});if(!g&&!w){if(dt)return Y;if(X)return G}else{if(g&&!w)return X?G:null;if(!g&&w)return dt?Y:null;if(g&&w)return dt||X?P.pitch:null}}let Bt;return g&&w?Bt=P.pitch:g&&!w?Bt=G:w&&!g?Bt=Y:Bt=G,Bt},U=()=>!g&&!w;function H(R,D,P,G){const Y=a.slice(D,D+2).map(at=>at*l);let W=0;P.forEach((at,Bt)=>{const dt=Y[Bt]??0;for(let X=i;X<=A;X++){const nt=r[X];if(!(!nt||nt.isDummy)&&nt.column===at){const mt=qt(X,e),ct=nt.isAccidental??nt.pitch.includes("/"),J=!y&&ct&&U();let st=m==="bw"?"#ffffff":nt.hex||"#ffffff";const At=T(nt.pitch,G,nt),vt=At===null;let ft=J||vt;if(!y&&C&&G.length>0&&!vt&&(Ag(nt.pitch,G)||(ft=!0)),ft){const zt=/^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(st);if((zt==null?void 0:zt.length)===4){const oe=parseInt(zt[1]??"00",16),ge=parseInt(zt[2]??"00",16),re=parseInt(zt[3]??"00",16);st=`rgba(${oe}, ${ge}, ${re}, 0)`}}if(R.fillStyle=st,R.fillRect(W,mt-u/2,dt,u),vt)continue;const Mt=At.length<=3,Pt=Math.max(10,Math.min(l*1.2,u*1.2)),Nt=Mt?Pt:Pt*.7;R.font=`bold ${Nt}px 'Atkinson Hyperlegible', sans-serif`,R.textAlign="center",R.textBaseline="middle";const Wt=W+dt/2,Qt=mt,Et=ft?"00":"FF";R.strokeStyle=`#212529${Et}`,R.lineWidth=2.5,R.lineJoin="round",R.strokeText(At,Wt,Qt),R.fillStyle=`#ffffff${Et}`,R.fillText(At,Wt,Qt)}}W+=dt})}s&&H(s,0,["B","A"],E),t&&H(t,a.length-2,["A","B"],x)}const Ld="",Rd="",cc="/",Pv=()=>window.animationEffectsManager,Hd=()=>d.state.placedNotes,uc=s=>{const t=s==null?void 0:s.split("-")[1];return Number.parseInt(t??"0",10)};function Dv(s){if(!s||typeof s.startColumnIndex!="number"||typeof s.endColumnIndex!="number")return!1;const t=s.shape==="circle"?s.startColumnIndex+1:s.startColumnIndex;return s.endColumnIndex>t}function kv(s,t,e){const{cellWidth:i}=e,A=i*.25,r=s.uuid;if(!r)return 0;const a=t.filter(h=>!h.isDrum&&h.row===s.row&&h.startColumnIndex===s.startColumnIndex&&h.uuid&&h.uuid!==r);if(a.length===0)return 0;const l=[s,...a];return l.sort((h,m)=>uc(h.uuid)-uc(m.uuid)),l.findIndex(h=>h.uuid===r)*A}function Lv(s,t){const{cellHeight:e}=t,i=Pv();return i!=null&&i.shouldAnimateNote(s)?i.getVibratoYOffset(s.color)*e:0}function Rv(s,t,e,i,A,r){const a=Pv();if(!(a!=null&&a.shouldFillNote(t)))return;const l=a.getFillLevel(t);if(l<=0)return;s.save();const u=1-l,h=s.createRadialGradient(e,i,0,e,i,Math.max(A,r));h.addColorStop(0,"transparent"),h.addColorStop(Math.max(0,u-.05),"transparent"),h.addColorStop(u,`${t.color}1F`),h.addColorStop(1,`${t.color}BF`),s.beginPath(),s.ellipse(e,i,A,r,0,0,2*Math.PI),s.clip(),s.fillStyle=h,s.fillRect(e-A-10,i-r-10,(A+10)*2,(r+10)*2),s.restore()}function Yx(s,t,e){const{cellHeight:i}=e,A=i/2*.12,r=s.uuid;if(!r)return 0;const a=t.filter(h=>!h.isDrum&&h.row===s.row&&h.startColumnIndex===s.startColumnIndex&&h.uuid&&h.uuid!==r&&Dv(h));if(a.length===0)return 0;const l=[s,...a];return l.sort((h,m)=>uc(h.uuid)-uc(m.uuid)),l.findIndex(h=>h.uuid===r)*A}function jx(s,t){const e=Ro.getDegreeForNote(s,t);if(!e)return{label:null,isAccidental:!1};if(!Ro.hasAccidental(e))return{label:e,isAccidental:!1};const A=d.state.accidentalMode||{},r=A.sharp??!0,a=A.flat??!0;if(!r&&!a)return{label:null,isAccidental:!0};let l=e.includes(Ld)?e:null,u=e.includes(Rd)?e:null;const h=Ro.getEnharmonicDegree(e);h&&(h.includes(Ld)&&!l&&(l=h),h.includes(Rd)&&!u&&(u=h));let m=null;if(r&&a){const g=[];l&&g.push(l),u&&(!l||u!==l)&&g.push(u),m=g.join(cc),m||(m=e)}else r?m=l||e:a&&(m=u||e);return{label:m,isAccidental:!0}}function Jx(s){if(!s)return{multiplier:1,category:"natural"};const t=s.includes(Rd),e=s.includes(Ld),i=s.includes(cc);return!t&&!e?{multiplier:1,category:"natural"}:i?{multiplier:.75,category:"both-accidentals"}:{multiplier:.88,category:"single-accidental"}}function Hv(s,t,e,i,A,r,a){const{label:l}=jx(t,e);if(!l)return;const{multiplier:u,category:h}=Jx(l);let m;if(t.shape==="circle"){const w=r*2*Ub;switch(h){case"natural":m=w;break;case"single-accidental":m=w*.8;break;case"both-accidentals":m=w*.4;break;default:m=w*u}}else{const w=r*2*Mb;switch(h){case"natural":m=w*1.5;break;case"single-accidental":m=w*1.2;break;case"both-accidentals":m=w;break;default:m=w*u}}const g=m;if(!(g<Pb))if(s.fillStyle="#212529",s.font=`bold ${g}px 'Atkinson Hyperlegible', sans-serif`,s.textAlign="center",s.textBaseline="middle",t.shape==="oval"&&h==="both-accidentals"&&l.includes(cc)){const w=l.split(cc),C=g*1.1,y=C*(w.length-1),E=A-y/2;w.forEach((x,T)=>{const U=E+T*C,H=g*.08;s.fillText(x.trim(),i,U+H)})}else{const w=g*.08;s.fillText(l,i,A+w)}}function hc(s,t){return Number.isFinite(s)&&s>0&&Number.isFinite(t)&&t>0}function $f(s,t,e,i){const{cellWidth:A,cellHeight:r,modulationMarkers:a}=t,l=qt(i,t),u=Lv(e,t),h=l+u,m=_t(e.startColumnIndex,t);let g;if(a&&a.length>0?g=_t(e.startColumnIndex+1,t)-m:g=A,!hc(g,r))return;const w=kv(e,Hd(),t),C=m+g+w,y=Math.max(Db,g*kb);if(Dv(e)){const T=_t(e.endColumnIndex+1,t),U=Yx(e,Hd(),t),H=h+U;s.beginPath(),s.moveTo(C,H),s.lineTo(T,H),s.strokeStyle=e.color,s.lineWidth=Math.max(Rb,g*Lb),s.stroke()}const E=g-y/2,x=r/2-y/2;hc(E,x)&&(s.save(),Rv(s,e,C,h,E,x),s.beginPath(),s.ellipse(C,h,E,x,0,0,2*Math.PI),s.strokeStyle=e.color,s.lineWidth=y,s.shadowColor=e.color,s.shadowBlur=sv,s.stroke(),s.shadowBlur=0,s.shadowColor="transparent",s.restore(),t.degreeDisplayMode!=="off"&&Hv(s,e,t,C,h,E))}function Xf(s,t,e,i){const{columnWidths:A,cellWidth:r,cellHeight:a,modulationMarkers:l}=t,u=qt(i,t),h=Lv(e,t),m=u+h,g=_t(e.startColumnIndex,t);let w;if(l&&l.length>0?w=_t(e.startColumnIndex+1,t)-g:w=((t.musicalColumnWidths||A.slice(2,-2))[e.startColumnIndex]??0)*r,!hc(w,a))return;const C=kv(e,Hd(),t),y=Math.max(.5,w*.15),E=g+w/2+C,x=w/2-y/2,T=a/2-y/2;hc(x,T)&&(s.save(),Rv(s,e,E,m,x,T),s.beginPath(),s.ellipse(E,m,x,T,0,0,2*Math.PI),s.strokeStyle=e.color,s.lineWidth=y,s.shadowColor=e.color,s.shadowBlur=sv,s.stroke(),s.shadowBlur=0,s.shadowColor="transparent",s.restore(),t.degreeDisplayMode!=="off"&&Hv(s,e,t,E,m,x))}function Yf(s,t,e){const{cellWidth:i,cellHeight:A,modulationMarkers:r}=t,a=qt(e.row,t),l=e.columnIndex-2,u=_t(l,t);let h;r&&r.length>0?h=_t(l+1,t)-u:h=i;const m=h*2,g=u+m/2,w=Math.min(m,A)/2*.9;if(w<2||(s.beginPath(),s.arc(g,a,w,0,2*Math.PI),s.strokeStyle="#212529",s.lineWidth=Math.max(.5,h*.05),s.stroke(),e.tonicNumber==null))return;const C=e.tonicNumber.toString(),y=w*1.5;y<6||(s.fillStyle="#212529",s.font=`bold ${y}px 'Atkinson Hyperlegible', sans-serif`,s.textAlign="center",s.textBaseline="middle",s.fillText(C,g,a))}const Nd=[{id:1,diamonds:[0],ovals:[],label:"left 8th"},{id:2,diamonds:[1],ovals:[],label:"e"},{id:3,diamonds:[2],ovals:[],label:"right 8th"},{id:4,diamonds:[3],ovals:[],label:"a"},{id:5,diamonds:[0,1],ovals:[],label:"1 e"},{id:6,diamonds:[1,2],ovals:[],label:"e &"},{id:7,diamonds:[2,3],ovals:[],label:"& a"},{id:8,diamonds:[0,2],ovals:[],label:"two 8ths"},{id:9,diamonds:[1,3],ovals:[],label:"e a"},{id:10,diamonds:[0,1,2],ovals:[],label:"1 e + right 8th"},{id:11,diamonds:[1,2,3],ovals:[],label:"e & a"},{id:12,diamonds:[0,1,3],ovals:[],label:"1 e a"},{id:13,diamonds:[0,2,3],ovals:[],label:"left 8th + & a"},{id:14,diamonds:[0,3],ovals:[],label:"left 8th + a"},{id:15,diamonds:[0,1,2,3],ovals:[],label:"1 e & a"}];function Rc(s){return Nd.find(t=>t.id===s)}function rg(s,t,e,i){const A=Math.sqrt(3)/2*e,r=Math.max(1,i-2*A),a=t-(r/2+A),l=a+A,u=l+r,h=u+A,m=s-e/2,g=s+e/2;return`M ${[`${s},${a}`,`${m},${l}`,`${m},${u}`,`${s},${h}`,`${g},${u}`,`${g},${l}`].join(" ")} Z`.replace(/,/g," ")}class Zx{constructor(t={}){Q(this,"options");this.options={diamondW:30,diamondH:120,ovalRx:30,ovalRy:60,strokeWidth:2,...t}}renderToCanvas(t,e,i,A,r,a,l="#000",u=null,h=null){const m=r/100*.8,g=a/100*.8,w=this.options.diamondW*m,C=this.options.diamondH*g,y=this.options.ovalRx*m,E=this.options.ovalRy*g,x=[.125,.375,.625,.875].map(U=>i+U*r),T=A+a/2;t.save(),t.strokeStyle=l,t.fillStyle=l,t.lineWidth=this.options.strokeWidth,t.lineCap="round",t.lineJoin="round",e.ovals.forEach(U=>{var D;const H=U===0?i+.25*r:i+.75*r;let R=T;if(u&&h){const P=`oval_${U}`,G=((D=u.shapeOffsets)==null?void 0:D[P])||0,Y=u.row+G;R=h(Y)}t.beginPath(),t.ellipse(H,R,y,E,0,0,Math.PI*2),t.stroke()}),e.diamonds.forEach(U=>{var G;const H=x[U];if(H===void 0)return;let R=T;if(u&&h){const Y=`diamond_${U}`,W=((G=u.shapeOffsets)==null?void 0:G[Y])||0,at=u.row+W;R=h(at)}const D=rg(H,R,w,C),P=new Path2D(D);t.stroke(P)}),t.restore()}renderToSVG(t,e=100,i=100){const A=document.createElementNS("http://www.w3.org/2000/svg","svg");A.setAttribute("viewBox",`0 0 ${e} ${i}`),A.style.color="#000000";const r=Math.min(e/100,i/100)*.8,a=this.options.diamondW*r,l=this.options.diamondH*r,u=this.options.ovalRx*r,h=this.options.ovalRy*r,m=[12.5,37.5,62.5,87.5],g=i/2;return t.ovals.forEach(w=>{const C=w===0?25:75,y=document.createElementNS("http://www.w3.org/2000/svg","ellipse");y.setAttribute("cx",String(C)),y.setAttribute("cy",String(g)),y.setAttribute("rx",String(u)),y.setAttribute("ry",String(h)),y.setAttribute("fill","none"),y.setAttribute("stroke","currentColor"),y.setAttribute("stroke-width",String(this.options.strokeWidth*2)),y.setAttribute("stroke-linecap","round"),A.appendChild(y)}),t.diamonds.forEach(w=>{const C=m[w];if(C===void 0)return;const y=rg(C,g,a,l),E=document.createElementNS("http://www.w3.org/2000/svg","path");E.setAttribute("d",y),E.setAttribute("fill","none"),E.setAttribute("stroke","currentColor"),E.setAttribute("stroke-width",String(this.options.strokeWidth*2)),E.setAttribute("stroke-linejoin","round"),E.setAttribute("stroke-linecap","round"),A.appendChild(E)}),A}}const jf=new Zx;b.moduleLoaded("StampRenderer","stamps");function tE(s,t){var i,A,r,a;const e=((i=d.getAllStampPlacements)==null?void 0:i.call(d))??((A=d.state)==null?void 0:A.stampPlacements)??[];if(e.length!==0){if(e.length>0){const l=e[0];console.log(`[renderStamps] Rendering ${e.length} stamps`),console.log(`[renderStamps] First stamp: column=${l==null?void 0:l.startColumn}, row=${l==null?void 0:l.row}, globalRow=${l==null?void 0:l.globalRow}`),console.log(`[renderStamps] musicalColumnWidths length: ${((r=t.musicalColumnWidths)==null?void 0:r.length)||0}`),console.log(`[renderStamps] columnWidths length: ${((a=t.columnWidths)==null?void 0:a.length)||0}`)}b.debug("StampRenderer",`Rendering ${e.length} stamps`,{count:e.length},"stamps"),e.forEach(l=>{eE(s,l,t)})}}function eE(s,t,e){const i=Rc(t.stampId);if(!i)return;const{startColumn:A,endColumn:r,row:a,color:l}=t,u=_t(A,e),m=qt(a,e)-e.cellHeight/2,g=r??A+2,C=_t(g,e)-u,y=e.cellHeight,E=rs(s.canvas);if(u+C<0||u>E)return;const x=T=>qt(T,e);jf.renderToCanvas(s,i,u,m,C,y,l,t,x),s.save(),s.globalAlpha=.1,s.fillStyle=l,s.fillRect(u+1,m+1,C-2,y-2),s.restore(),b.debug("StampRenderer",`Rendered stamp ${t.stampId} at ${A}-${r},${a}`,{stampId:t.stampId,startColumn:A,endColumn:r,row:a,stampX:u,stampY:m,hasOffsets:!!t.shapeOffsets},"stamps")}function sE(s,t,e,i,A){if(!i)return;const r=_t(t,A),l=qt(e,A)-A.cellHeight/2,h=_t(t+2,A)-r,m=A.cellHeight;s.save(),s.globalAlpha=.6,jf.renderToCanvas(s,i,r,l,h,m,A.previewColor||"#4a90e2"),s.restore()}function og(s,t,e){return[{id:t+0,span:s,hits:[0],label:`${e} [1]`},{id:t+1,span:s,hits:[1],label:`${e} [2]`},{id:t+2,span:s,hits:[2],label:`${e} [3]`},{id:t+3,span:s,hits:[0,1],label:`${e} [1 2]`},{id:t+4,span:s,hits:[1,2],label:`${e} [2 3]`},{id:t+5,span:s,hits:[0,2],label:`${e} [1 3]`},{id:t+6,span:s,hits:[0,1,2],label:`${e} [1 2 3]`}]}const Wl=[...og("eighth",1,"8th triplet"),...og("quarter",8,"Quarter triplet")],nE={eighth:1,quarter:2},Nv=[16.6667,50,83.3333];function Hc(s){return Wl.find(t=>t.id===s)}b.moduleLoaded("TripletRenderer","triplets");function iE(s,t){var i,A;const e=((i=d.getAllTripletPlacements)==null?void 0:i.call(d))??((A=d.state)==null?void 0:A.tripletPlacements)??[];e.length!==0&&(b.debug("TripletRenderer",`Rendering ${e.length} triplet groups`,{count:e.length},"triplets"),e.forEach(r=>{AE(s,r,t)}))}function AE(s,t,e){const i=Hc(t.stampId);if(!i)return;const{startCellIndex:A,span:r,row:a,color:l}=t,u=A*2,h=(A+r)*2,m=rn(d.state,u),g=rn(d.state,h);if(m===null||g===null){b.warn("TripletRenderer","Failed to convert time index to visual column",{startCellIndex:A,span:r,startTimeIndex:u,endTimeIndex:h},"triplets");return}const w=m-2,C=g-2,y=_t(w,e),E=qt(a,e),x=E-e.cellHeight/2,U=_t(C,e)-y,H=e.cellHeight,R=rs(s.canvas);if(y+U<0||y>R)return;Ov(s,i,y,E,U,H,l,t,P=>qt(P,e)),s.save(),s.globalAlpha=.1,s.fillStyle=l,s.fillRect(y+1,x+1,U-2,H-2),s.restore()}function Ov(s,t,e,i,A,r,a,l=null,u=null){const h=t.span==="eighth"?"ovalWide":"circleWide",m=A/100*.8,g=r/100*.8,w=Math.max(1,3*g);t.hits.forEach(C=>{var T;const y=Nv[C]??50,E=e+A*y/100;let x=i;if(l&&u){const U=`triplet_${C}`,H=((T=l.shapeOffsets)==null?void 0:T[U])||0,R=l.row+H;x=u(R),H!==0&&b.debug("TripletRenderer","Drawing notehead with offset",{slot:C,shapeKey:U,rowOffset:H,baseRow:l.row,shapeRow:R,y:x},"triplets")}rE(s,h,E,x,a,w,m,g)})}function rE(s,t,e,i,A="currentColor",r=4,a=1,l=1){const u=20*a,h=60*l;if(s.strokeStyle=A,s.lineWidth=r,s.fillStyle="none",s.beginPath(),t==="circleWide"){const m=u*2,g=h;s.ellipse(e,i,m,g,0,0,2*Math.PI)}else{const m=u,g=h;s.ellipse(e,i,m,g,0,0,2*Math.PI)}s.stroke()}function oE(s,t,e,i,A){if(!i)return;const r=i.span==="eighth"?1:2,a=t*2,l=(t+r)*2,u=rn(d.state,a),h=rn(d.state,l);if(u===null||h===null)return;const m=u-2,g=h-2,w=_t(m,A),C=qt(e,A),E=_t(g,A)-w,x=A.cellHeight;s.save(),s.globalAlpha=.6;const T=A.previewColor||"#4a90e2";Ov(s,i,w,C,E,x,T),s.restore()}function aE(s,t){if(t.cellWidth,s===0)return _t(2,t);const e=s-1,i=Os(t,e);return i?_t(i.endColumn+1,t):(b.warn("ModulationRenderer","Could not find measure info for index",{measureIndex:s},"grid"),s*200)}function Vv(s,t){const{modulationMarkers:e}=t;if(!e||e.length===0)return;const i=e.filter(A=>A.active).map(A=>{let r;if(A.columnIndex!==null&&A.columnIndex!==void 0)r=_t(A.columnIndex+1,t);else if(A.macrobeatIndex!==null&&A.macrobeatIndex!==void 0){const a=Os(t,A.macrobeatIndex);a?r=_t(a.endColumn+1,t):(b.warn("ModulationRenderer","Could not find macrobeat info for index",{macrobeatIndex:A.macrobeatIndex},"grid"),r=A.xPosition??0)}else A.measureIndex!==null&&A.measureIndex!==void 0?r=aE(A.measureIndex,t):r=A.xPosition??0;return{...A,xCanvas:r}});s.save(),i.forEach(A=>{lE(s,A)}),s.restore()}function lE(s,t){const e=t.xCanvas,i=t.ratio,A=bv(i),r=Cv(i);cE(s,e,A),uE(s,e,r,A)}function cE(s,t,e){const A=_e(s.canvas);s.beginPath(),s.moveTo(t,0),s.lineTo(t,A),s.lineWidth=3,s.strokeStyle=e,s.setLineDash([]),s.stroke()}function uE(s,t,e,i){const r="Arial, sans-serif";s.font=`14px ${r}`,s.textAlign="center",s.textBaseline="middle";const m=s.measureText(e).width,g=14,w=m+12,C=g+12,y=t-w/2,E=20;hE(s,y,E,w,C,8,i),s.fillStyle="white",s.fillText(e,t,E+C/2)}function hE(s,t,e,i,A,r,a){s.beginPath(),s.moveTo(t+r,e),s.lineTo(t+i-r,e),s.quadraticCurveTo(t+i,e,t+i,e+r),s.lineTo(t+i,e+A-r),s.quadraticCurveTo(t+i,e+A,t+i-r,e+A),s.lineTo(t+r,e+A),s.quadraticCurveTo(t,e+A,t,e+A-r),s.lineTo(t,e+r),s.quadraticCurveTo(t,e,t+r,e),s.closePath(),s.fillStyle=a,s.fill(),s.strokeStyle="rgba(0, 0, 0, 0.2)",s.lineWidth=1,s.stroke()}function Fn(s){return s.x??s.col??0}function Tn(s){return s.y??s.row??0}function aa(s,t){if(!t||t.length<3)return!1;const e=Fn(s),i=Tn(s);let A=!1;for(let r=0,a=t.length-1;r<t.length;a=r++){const l=Fn(t[r]),u=Tn(t[r]),h=Fn(t[a]),m=Tn(t[a]);u>i!=m>i&&e<(h-l)*(i-u)/(m-u)+l&&(A=!A)}return A}function il(s){if(!s||s.length<3)return s;const t=s.map(r=>({x:Fn(r),y:Tn(r)}));if(t.length===0)return[];let e=t[0];for(let r=1;r<t.length;r++){const a=t[r];(a.y<e.y||a.y===e.y&&a.x<e.x)&&(e=a)}const i=t.filter(r=>r!==e);if(i.sort((r,a)=>{const l=Math.atan2(r.y-e.y,r.x-e.x),u=Math.atan2(a.y-e.y,a.x-e.x);if(l!==u)return l-u;const h=Math.hypot(r.x-e.x,r.y-e.y),m=Math.hypot(a.x-e.x,a.y-e.y);return h-m}),i.length===0)return[e];const A=[e,i[0]];for(let r=1;r<i.length;r++){const a=i[r];for(;A.length>1&&!dE(A[A.length-2],A[A.length-1],a);)A.pop();A.push(a)}return A}function dE(s,t,e){const i=Fn(s),A=Tn(s),r=Fn(t),a=Tn(t),l=Fn(e),u=Tn(e);return(r-i)*(u-A)-(a-A)*(l-i)>0}function fE(s,t,e,i=10){const A=Fn(s),r=Tn(s),a=Fn(t),l=Tn(t),u=Fn(e),h=Tn(e),m=u-a,g=h-l,w=m*m+g*g;if(w===0)return Math.hypot(A-a,r-l)<=i;let C=((A-a)*m+(r-l)*g)/w;C=Math.max(0,Math.min(1,C));const y=a+C*m,E=l+C*g;return Math.hypot(A-y,r-E)<=i}function ag(s,t,e=10){if(!t||t.length<2)return!1;for(let i=0;i<t.length;i++){const A=t[i],r=t[(i+1)%t.length];if(fE(s,A,r,e))return!0}return!1}function pE(s,t){const{centerX:e,centerY:i,rx:A,ry:r}=t,a=16;for(let l=0;l<a;l++){const u=l/a*2*Math.PI,h=e+A*Math.cos(u),m=i+r*Math.sin(u);if(aa({x:h,y:m},s))return!0}return!!aa({x:e,y:i},s)}function lg(s,t){const{x:e,y:i,width:A,height:r}=t,a=[{x:e,y:i},{x:e+A,y:i},{x:e+A,y:i+r},{x:e,y:i+r}];for(const l of a)if(aa(l,s))return!0;for(const l of s){const u=Fn(l),h=Tn(l);if(u>=e&&u<=e+A&&h>=i&&h<=i+r)return!0}return!1}b.moduleLoaded("AnnotationService","annotation");class mE{constructor(){Q(this,"canvas");Q(this,"ctx");Q(this,"currentTool");Q(this,"isDrawing");Q(this,"currentPath");Q(this,"startPoint");Q(this,"tempAnnotation");Q(this,"selectedAnnotation");Q(this,"hoverAnnotation");Q(this,"eraserCursor");Q(this,"isDragging");Q(this,"dragOffset");Q(this,"isResizing");Q(this,"resizeHandle");Q(this,"resizeStartBounds");Q(this,"isDraggingSelection");Q(this,"selectionDragStart");Q(this,"selectionDragTotal");this.canvas=null,this.ctx=null,this.currentTool=null,this.isDrawing=!1,this.currentPath=[],this.startPoint=null,this.tempAnnotation=null,this.selectedAnnotation=null,this.hoverAnnotation=null,this.eraserCursor=null,this.isDragging=!1,this.dragOffset=null,this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null}initialize(){if(this.canvas=document.getElementById("notation-grid"),!this.canvas){b.error("AnnotationService","Pitch grid canvas not found",null,"annotation");return}this.ctx=this.canvas.getContext("2d"),this.setupEventListeners(),d.on("annotationsChanged",()=>{this.selectedAnnotation=null,this.render()}),b.initSuccess("AnnotationService")}setupEventListeners(){this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this)),this.canvas.addEventListener("mouseleave",this.handleMouseLeave.bind(this)),this.canvas.addEventListener("dblclick",this.handleDoubleClick.bind(this)),this.canvas.addEventListener("contextmenu",t=>t.preventDefault()),document.addEventListener("keydown",this.handleKeyDown.bind(this))}handleKeyDown(t){if(!this.selectedAnnotation)return;const e=document.activeElement,i=e.contentEditable==="true",A=e.tagName.toLowerCase();["input","textarea"].includes(A)||i||(t.key==="Delete"||t.key==="Backspace")&&(t.preventDefault(),this.deleteSelectedAnnotation())}deleteSelectedAnnotation(){if(!this.selectedAnnotation)return;const t=d.state.annotations.indexOf(this.selectedAnnotation);t>-1&&(d.state.annotations.splice(t,1),this.selectedAnnotation=null,d.recordState(),this.render(),b.log("AnnotationService","Deleted annotation","annotation"))}resize(){if(!this.canvas)return;const t=document.getElementById("notation-grid");t&&(this.canvas.width=t.width,this.canvas.height=t.height,this.render())}getRenderOptions(){return{columnWidths:d.state.columnWidths,cellWidth:d.state.cellWidth,cellHeight:d.state.cellHeight,modulationMarkers:d.state.modulationMarkers,baseMicrobeatPx:d.state.cellWidth}}canvasToGrid(t,e){const i=this.getRenderOptions();return{col:Ev(t,i),row:Dx(e,i)}}gridToCanvas(t,e){const i=this.getRenderOptions();return{x:_t(t,i),y:qt(e,i)}}setTool(t,e){if(this.currentTool=t,this.toolSettings=e,this.canvas)switch(t){case"arrow":case"text":this.canvas.style.cursor="crosshair";break;case"marker":case"highlighter":this.canvas.style.cursor=`url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='16' height='16'><circle cx='8' cy='8' r='4' fill='rgba(0,0,0,0.5)'/></svg>") 8 8, crosshair`;break;case"lasso":this.canvas.style.cursor="crosshair";break;default:this.canvas.style.cursor="default"}}handleMouseDown(t){var l,u,h;if(!this.currentTool||!this.toolSettings)return;const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,A=t.clientY-e.top,r=this.canvasToGrid(i,A);if(t.button===2){if(this.currentTool==="lasso"&&((l=d.state.lassoSelection)!=null&&l.isActive)){this.removeFromLassoSelection(i,A);return}this.tempEraserMode=!0,this.isDrawing=!0,this.eraseAtPoint(i,A),this.showEraserCursor(i,A);return}if(((u=this.selectedAnnotation)==null?void 0:u.type)==="text"){const m=this.getResizeHandleAt(i,A,this.selectedAnnotation);if(m){this.isResizing=!0,this.resizeHandle=m,this.resizeStartBounds={col:this.selectedAnnotation.col,row:this.selectedAnnotation.row,widthCols:this.selectedAnnotation.widthCols,heightRows:this.selectedAnnotation.heightRows,mouseCol:r.col,mouseRow:r.row};return}}if((h=d.state.lassoSelection)!=null&&h.isActive&&d.state.lassoSelection.convexHull){const m=ag({x:i,y:A},d.state.lassoSelection.convexHull,10),g=aa({x:i,y:A},d.state.lassoSelection.convexHull);if(m||g){this.isDraggingSelection=!0,this.selectionDragStart={canvasX:i,canvasY:A},this.selectionDragTotal={col:0,row:0};return}}const a=this.getAnnotationAt(i,A);if(a&&(a.type==="arrow"||a.type==="text")){if(this.selectedAnnotation===a){this.isDragging=!0,a.type==="arrow"?this.dragOffset={startCol:r.col-a.startCol,startRow:r.row-a.startRow,endCol:r.col-a.endCol,endRow:r.row-a.endRow}:a.type==="text"&&(this.dragOffset={col:r.col-a.col,row:r.row-a.row});return}this.selectedAnnotation=a,this.loadAnnotationSettings(a),this.render();return}else this.selectedAnnotation=null;switch(this.isDrawing=!0,this.startPoint=r,this.currentPath=[r],this.currentTool){case"arrow":this.tempAnnotation={type:"arrow",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row,settings:{...this.toolSettings.arrow}};break;case"text":this.tempAnnotation={type:"text",startCol:r.col,startRow:r.row,endCol:r.col,endRow:r.row};break;case"marker":case"highlighter":this.tempAnnotation={type:this.currentTool,path:[r],settings:{...this.toolSettings[this.currentTool]}};break;case"lasso":this.tempAnnotation={type:"lasso",path:[{x:i,y:A}]};break}}handleMouseMove(t){var a;const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,A=t.clientY-e.top,r=this.canvasToGrid(i,A);if(this.tempEraserMode){this.eraseAtPoint(i,A),this.showEraserCursor(i,A);return}if(this.isResizing&&((a=this.selectedAnnotation)==null?void 0:a.type)==="text"){const l=r.col-this.resizeStartBounds.mouseCol,u=r.row-this.resizeStartBounds.mouseRow;let h=this.resizeStartBounds.col,m=this.resizeStartBounds.row,g=this.resizeStartBounds.widthCols,w=this.resizeStartBounds.heightRows;this.resizeHandle.includes("n")&&(m=this.resizeStartBounds.row+u,w=this.resizeStartBounds.heightRows-u),this.resizeHandle.includes("s")&&(w=this.resizeStartBounds.heightRows+u),this.resizeHandle.includes("w")&&(h=this.resizeStartBounds.col+l,g=this.resizeStartBounds.widthCols-l),this.resizeHandle.includes("e")&&(g=this.resizeStartBounds.widthCols+l);const C=2,y=1;g<C&&(this.resizeHandle.includes("w")&&(h=this.resizeStartBounds.col+this.resizeStartBounds.widthCols-C),g=C),w<y&&(this.resizeHandle.includes("n")&&(m=this.resizeStartBounds.row+this.resizeStartBounds.heightRows-y),w=y),this.selectedAnnotation.col=h,this.selectedAnnotation.row=m,this.selectedAnnotation.widthCols=g,this.selectedAnnotation.heightRows=w,this.render();return}if(this.isDraggingSelection&&this.selectionDragStart){const l=this.getRenderOptions(),u=i-this.selectionDragStart.canvasX,h=A-this.selectionDragStart.canvasY,m=Math.round(u/l.cellWidth),g=Math.round(h/(l.cellHeight/2)),w={col:m-this.selectionDragTotal.col,row:g-this.selectionDragTotal.row};if(w.col!==0||w.row!==0){d.state.lassoSelection.selectedItems.forEach(y=>{if(y.type==="note"){y.data.row+=w.row;const E=y.data.columnIndex!==void 0?"columnIndex":"startColumnIndex";y.data[E]+=w.col,y.data.endColumnIndex!==void 0&&(y.data.endColumnIndex+=w.col)}else y.type==="stamp"?(y.data.row+=w.row,y.data.startColumn+=w.col,y.data.endColumn+=w.col):y.type==="triplet"&&(y.data.row+=w.row,y.data.column+=w.col)}),this.selectionDragTotal.col=m,this.selectionDragTotal.row=g;const C=d.state.lassoSelection.selectedItems.map(y=>{const E=y.data.columnIndex!==void 0?y.data.columnIndex:y.data.startColumnIndex!==void 0?y.data.startColumnIndex:y.data.column,x=_t(E,l),T=qt(y.data.row,l);return{x,y:T}});d.state.lassoSelection.convexHull=il(C),this.render()}return}if(this.isDragging&&this.selectedAnnotation){this.selectedAnnotation.type==="arrow"?(this.selectedAnnotation.startCol=r.col-this.dragOffset.startCol,this.selectedAnnotation.startRow=r.row-this.dragOffset.startRow,this.selectedAnnotation.endCol=r.col-this.dragOffset.endCol,this.selectedAnnotation.endRow=r.row-this.dragOffset.endRow):this.selectedAnnotation.type==="text"&&(this.selectedAnnotation.col=r.col-this.dragOffset.col,this.selectedAnnotation.row=r.row-this.dragOffset.row),this.render();return}if(!this.isDrawing){this.updateHover(i,A);return}if(this.tempAnnotation)switch(this.currentTool){case"arrow":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"text":this.tempAnnotation.endCol=r.col,this.tempAnnotation.endRow=r.row,this.render();break;case"marker":case"highlighter":if(this.tempAnnotation.path.length>0){const l=this.tempAnnotation.path[this.tempAnnotation.path.length-1],u=this.interpolatePoints(l,r);this.tempAnnotation.path.push(...u)}else this.tempAnnotation.path.push(r);this.render();break;case"lasso":this.tempAnnotation.path.push({x:i,y:A}),this.render();break}}handleMouseUp(t){if(this.isResizing){this.isResizing=!1,this.resizeHandle=null,this.resizeStartBounds=null,d.recordState();return}if(this.isDraggingSelection){this.isDraggingSelection=!1,this.selectionDragStart=null,this.selectionDragTotal=null,d.recordState();return}if(this.isDragging){this.isDragging=!1,this.dragOffset=null,d.recordState();return}if(this.isDrawing){if(this.isDrawing=!1,this.tempEraserMode){this.tempEraserMode=!1,this.render();return}if(this.tempAnnotation){if(this.currentTool==="text"){const{startCol:e,startRow:i,endCol:A,endRow:r}=this.tempAnnotation,a=Math.abs(A-e),l=Math.abs(r-i),u=Math.min(e,A),h=Math.min(i,r);a>.5&&l>.2&&this.createTextAnnotation(u,h,a,l),this.tempAnnotation=null,this.render();return}this.currentTool==="lasso"?this.handleLassoSelection():(d.state.annotations.push(this.tempAnnotation),this.currentTool==="arrow"&&(this.selectedAnnotation=this.tempAnnotation),d.recordState()),this.tempAnnotation=null,this.render()}}}handleMouseLeave(t){this.isDrawing&&this.handleMouseUp(t)}handleDoubleClick(t){const e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,A=t.clientY-e.top,r=this.getAnnotationAt(i,A);(r==null?void 0:r.type)==="text"&&this.editTextAnnotation(r)}editTextAnnotation(t){const{col:e,row:i,widthCols:A,heightRows:r,text:a,settings:l}=t,u=d.state.annotations.indexOf(t);u>-1&&(d.state.annotations.splice(u,1),this.selectedAnnotation=null,this.render()),this.createTextAnnotation(e,i,A,r,a,l)}createTextAnnotation(t,e,i,A,r=null,a=null){this.isDrawing=!1;const l=this.gridToCanvas(t,e),u=this.gridToCanvas(t+i,e+A),h=l.x,m=l.y,g=u.x-h,w=u.y-m,y=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',E=a||this.toolSettings.text,x=document.createElement("div");x.contentEditable=!0,x.className="annotation-text-input",x.textContent=r||"Type here...";const T=E.size,U=T*1.2;x.style.width=`${g}px`,x.style.height=`${w}px`,x.style.padding=E.background?"4px 8px":"4px",x.style.border="2px dashed rgba(74, 144, 226, 0.5)",x.style.backgroundColor=E.background?"#ffffff":"transparent",x.style.color=E.color,x.style.fontSize=`${T}px`,x.style.lineHeight=`${U}px`,x.style.fontWeight=E.bold?"bold":"normal",x.style.fontStyle=E.italic?"italic":"normal",x.style.textDecoration=E.underline?"underline":"none",E.superscript?(x.style.fontSize=`${T*.6}px`,x.style.verticalAlign="super"):E.subscript&&(x.style.fontSize=`${T*.6}px`,x.style.verticalAlign="sub"),x.style.outline="none",x.style.zIndex="10000",x.style.position="fixed",x.style.cursor="text",x.style.pointerEvents="auto",x.style.fontFamily=y,x.style.whiteSpace="pre-wrap",x.style.wordWrap="break-word",x.style.overflow="hidden",x.style.boxSizing="border-box";const H=this.canvas.getBoundingClientRect();x.style.left=`${H.left+h}px`,x.style.top=`${H.top+m}px`,document.body.appendChild(x),x.focus();const R=document.createRange();R.selectNodeContents(x);const D=window.getSelection();D.removeAllRanges(),D.addRange(R);let P=!1;const G=()=>{if(P)return;P=!0;const W=x.textContent.trim();if(W&&W!=="Type here..."){const at={type:"text",col:t,row:e,widthCols:i,heightRows:A,text:W,settings:{...E}};d.state.annotations.push(at),this.selectedAnnotation=d.state.annotations[d.state.annotations.length-1],d.recordState(),this.render()}document.body.contains(x)&&document.body.removeChild(x)};let Y=!1;x.addEventListener("input",()=>{!Y&&x.textContent==="Type here..."&&(x.textContent="",Y=!0)}),setTimeout(()=>{x.addEventListener("blur",G)},100),x.addEventListener("keydown",W=>{W.key==="Enter"&&!W.shiftKey&&(W.preventDefault(),G()),W.key==="Escape"&&(P=!0,document.body.contains(x)&&document.body.removeChild(x))})}handleLassoSelection(){var a,l;if(!((a=this.tempAnnotation)!=null&&a.path))return;const t=this.tempAnnotation.path,e=[],i=this.getRenderOptions();((l=window.event)==null?void 0:l.shiftKey)&&d.state.lassoSelection.selectedItems&&e.push(...d.state.lassoSelection.selectedItems),d.state.placedNotes.forEach((u,h)=>{if(u.isDrum)return;const m=u.columnIndex!==void 0?u.columnIndex:u.startColumnIndex,g=_t(m,i),w=qt(u.row,i),{cellWidth:C,cellHeight:y}=i;let E=C;i.modulationMarkers&&i.modulationMarkers.length>0&&(E=_t(m+1,i)-g);const x=u.shape==="oval"?g+E:g+E/2,T=w,U=u.shape==="oval"?E:E/2,H=y/2;if(pE(t,{centerX:x,centerY:T,rx:U,ry:H})){const R=`note-${u.row}-${m}-${u.color}-${u.shape}`;e.find(D=>D.id===R)||e.push({type:"note",id:R,data:u,index:h})}}),d.state.stampPlacements.forEach((u,h)=>{const{cellWidth:m,cellHeight:g}=i,w=_t(u.startColumn,i),C=qt(u.row,i)-g/2,y=m*2;if(lg(t,{x:w,y:C,width:y,height:g})){const x=`stamp-${u.row}-${u.startColumn}-${u.stampId}`;e.find(T=>T.id===x)||e.push({type:"stamp",id:x,data:u,index:h})}}),d.state.tripletPlacements.forEach((u,h)=>{const{cellWidth:m,cellHeight:g}=i,w=_t(u.column,i),C=qt(u.row,i)-g/2,y=m*2;if(lg(t,{x:w,y:C,width:y,height:g})){const x=`triplet-${u.row}-${u.column}-${u.tripletId}`;e.find(T=>T.id===x)||e.push({type:"triplet",id:x,data:u,index:h})}});let r=null;if(e.length>0){const u=e.map(h=>{const m=h.data.columnIndex!==void 0?h.data.columnIndex:h.data.startColumnIndex!==void 0?h.data.startColumnIndex:h.data.column,g=_t(m,i),w=qt(h.data.row,i);return{x:g,y:w}});r=il(u)}d.state.lassoSelection={selectedItems:e,convexHull:r,isActive:e.length>0},d.recordState(),b.log("AnnotationService",`Lasso selection completed: ${e.length} items selected`,"annotation"),this.render()}updateLassoConvexHull(){var i,A;if(!((i=d.state.lassoSelection)!=null&&i.isActive)||!((A=d.state.lassoSelection.selectedItems)!=null&&A.length))return;const t=this.getRenderOptions(),e=d.state.lassoSelection.selectedItems.map(r=>{const a=r.data.columnIndex!==void 0?r.data.columnIndex:r.data.startColumnIndex!==void 0?r.data.startColumnIndex:r.data.column,l=_t(a,t),u=qt(r.data.row,t);return{x:l,y:u}});d.state.lassoSelection.convexHull=il(e)}removeFromLassoSelection(t,e){var a;if(!((a=d.state.lassoSelection)!=null&&a.isActive))return;const i=this.getRenderOptions(),A=15;let r=null;if(d.state.placedNotes.forEach(l=>{const u=_t(l.columnIndex,i),h=qt(l.row,i);Math.hypot(t-u,e-h)<=A&&(r=`note-${l.row}-${l.columnIndex}-${l.color}-${l.shape}`)}),r||d.state.stampPlacements.forEach(l=>{const u=_t(l.column,i),h=qt(l.row,i);Math.hypot(t-u,e-h)<=A&&(r=`stamp-${l.row}-${l.column}-${l.stampId}`)}),r||d.state.tripletPlacements.forEach(l=>{const u=_t(l.column,i),h=qt(l.row,i);Math.hypot(t-u,e-h)<=A&&(r=`triplet-${l.row}-${l.column}-${l.tripletId}`)}),r){const l=d.state.lassoSelection.selectedItems.filter(h=>h.id!==r);let u=null;if(l.length>0){const h=l.map(m=>{const g=_t(m.data.columnIndex||m.data.column,i),w=qt(m.data.row,i);return{x:g,y:w}});u=il(h)}d.state.lassoSelection={selectedItems:l,convexHull:u,isActive:l.length>0},d.recordState(),this.render(),b.log("AnnotationService",`Removed item from lasso selection. ${l.length} items remain.`,"annotation")}}drawTempAnnotation(){if(this.tempAnnotation)switch(this.tempAnnotation.type){case"arrow":this.drawArrow(this.tempAnnotation,!0);break;case"text":this.drawTextBoxPreview(this.tempAnnotation);break;case"marker":this.drawPath(this.tempAnnotation,!1);break;case"highlighter":this.drawPath(this.tempAnnotation,!0);break;case"lasso":this.drawLassoPath(this.tempAnnotation);break}}drawTextBoxPreview(t){const{startX:e,startY:i,endX:A,endY:r}=t,a=this.ctx,l=Math.min(e,A),u=Math.min(i,r),h=Math.abs(A-e),m=Math.abs(r-i);a.save(),a.strokeStyle="rgba(74, 144, 226, 0.6)",a.lineWidth=2,a.setLineDash([5,5]),a.strokeRect(l,u,h,m),this.toolSettings.text.background&&(a.fillStyle="rgba(255, 255, 255, 0.8)",a.fillRect(l,u,h,m)),a.restore()}render(){la.render()}drawArrow(t,e=!1,i=!1,A=!1){const{startX:r,startY:a,endX:l,endY:u,settings:h}=t,m=this.ctx;m.save(),i&&(m.strokeStyle="#4a90e2",m.lineWidth=this.getStrokeWidth(h.strokeWeight)+4,m.globalAlpha=.3,m.setLineDash([]),m.beginPath(),m.moveTo(r,a),m.lineTo(l,u),m.stroke(),m.globalAlpha=1),A&&!i&&(m.strokeStyle="#4a90e2",m.lineWidth=this.getStrokeWidth(h.strokeWeight)+4,m.globalAlpha=.15,m.setLineDash([]),m.beginPath(),m.moveTo(r,a),m.lineTo(l,u),m.stroke(),m.globalAlpha=1),m.strokeStyle=e?"rgba(0, 0, 0, 0.5)":"#000000",m.lineWidth=this.getStrokeWidth(h.strokeWeight),m.setLineDash(this.getLineDash(h.lineStyle));const g=Math.atan2(u-a,l-r),w=h.arrowheadSize||12;let C=r,y=a,E=l,x=u;h.startArrowhead!=="none"&&(C=r+Math.cos(g)*w,y=a+Math.sin(g)*w),h.endArrowhead!=="none"&&(E=l-Math.cos(g)*w,x=u-Math.sin(g)*w),m.beginPath(),m.moveTo(C,y),m.lineTo(E,x),m.stroke(),h.startArrowhead!=="none"&&this.drawArrowhead(m,r,a,g+Math.PI,h.startArrowhead,w),h.endArrowhead!=="none"&&this.drawArrowhead(m,l,u,g,h.endArrowhead,w),m.restore()}drawArrowhead(t,e,i,A,r,a=12){switch(t.save(),t.translate(e,i),t.rotate(A),t.setLineDash([]),r){case"filled":case"filled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a/2),t.lineTo(-a,a/2),t.closePath(),t.fillStyle=t.strokeStyle,t.fill();break;case"unfilled":case"unfilled-arrow":t.beginPath(),t.moveTo(0,0),t.lineTo(-a,-a/2),t.lineTo(-a,a/2),t.closePath(),t.stroke();break;case"circle":t.beginPath(),t.arc(0,0,a/3,0,Math.PI*2),t.fillStyle=t.strokeStyle,t.fill();break}t.restore()}wrapText(t,e,i){const A=e.split(`
`),r=[];return A.forEach(a=>{if(!a.trim()){r.push("");return}const l=a.split(" ");let u="";l.forEach((h,m)=>{const g=u?u+" "+h:h;t.measureText(g).width>i&&u?(r.push(u),u=h):u=g}),u&&r.push(u)}),r}drawText(t,e=!1,i=!1){const{x:A,y:r,text:a,settings:l}=t,u=this.ctx;u.save();const m=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',g=this.getSizeValue(l.size);u.font=`${l.italic?"italic ":""}${l.bold?"bold ":""}${g} ${m}`,u.textBaseline="top";const w=parseInt(g)*1.2,C=t.width||0,y=t.height||0,E=l.background?16:8,x=C-E,T=this.wrapText(u,a,x);if(l.background){u.fillStyle="#ffffff";const H=8;u.fillRect(A-H/2,r-H/2,C+H,y+H/2)}if(i&&!e){u.fillStyle="rgba(74, 144, 226, 0.1)";const H=l.background?8:2;u.fillRect(A-H/2,r-H/2,C+H,y+H/2)}if(e){u.fillStyle="rgba(74, 144, 226, 0.2)";const H=l.background?8:2;u.fillRect(A-H/2,r-H/2,C+H,y+H/2)}u.fillStyle=l.color;const U=parseInt(g);T.forEach((H,R)=>{const D=r+R*w;this.drawTextWithSuperscripts(u,H,A,D,U,l,m)}),e&&this.drawResizeHandles(A,r,C,y),u.restore()}drawTextWithSuperscripts(t,e,i,A,r,a,l){if(a.superscript||a.subscript){t.save();const g=r*.6,w=a.superscript?-r*.4:r*.3;if(t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${g}px ${l}`,t.fillText(e,i,A+w),a.underline){const C=t.measureText(e);t.beginPath(),t.strokeStyle=a.color,t.lineWidth=1,t.moveTo(i,A+w+g*1.2-2),t.lineTo(i+C.width,A+w+g*1.2-2),t.stroke()}t.restore();return}let u=i;const h=this.parseFormattedText(e),m=(g,w)=>{if(g){if(t.save(),w==="superscript"){const C=r*.6,y=-r*.4;t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${C}px ${l}`,t.fillText(g,u,A+y),u+=t.measureText(g).width}else if(w==="subscript"){const C=r*.6,y=r*.3;t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${C}px ${l}`,t.fillText(g,u,A+y),u+=t.measureText(g).width}else{if(t.font=`${a.italic?"italic ":""}${a.bold?"bold ":""}${r}px ${l}`,t.fillText(g,u,A),a.underline){const C=t.measureText(g);t.beginPath(),t.strokeStyle=a.color,t.lineWidth=1,t.moveTo(u,A+r*1.2-2),t.lineTo(u+C.width,A+r*1.2-2),t.stroke()}u+=t.measureText(g).width}t.restore()}};h.forEach(g=>{m(g.text,g.format)})}parseFormattedText(t){const e=[];let i=0,A="",r=!1;for(;i<t.length;){if(t.substr(i,5)==="<sup>"){A&&(e.push({text:A,format:"normal"}),A="");const a=t.indexOf("</sup>",i);if(a!==-1){const l=t.substring(i+5,a);e.push({text:l,format:"superscript"}),i=a+6;continue}}if(t.substr(i,5)==="<sub>"){A&&(e.push({text:A,format:"normal"}),A="");const a=t.indexOf("</sub>",i);if(a!==-1){const l=t.substring(i+5,a);e.push({text:l,format:"subscript"}),i=a+6;continue}}if(t[i]==="^"&&!r){A&&(e.push({text:A,format:"normal"}),A=""),r=!0,i++;continue}if(r&&t[i]===" "){A&&(e.push({text:A,format:"superscript"}),A=""),r=!1,e.push({text:" ",format:"normal"}),i++;continue}A+=t[i],i++}return A&&e.push({text:A,format:r?"superscript":"normal"}),e}drawResizeHandles(t,e,i,A){const r=this.ctx,a=8,l=[{pos:"nw",x:t,y:e},{pos:"n",x:t+i/2,y:e},{pos:"ne",x:t+i,y:e},{pos:"e",x:t+i,y:e+A/2},{pos:"se",x:t+i,y:e+A},{pos:"s",x:t+i/2,y:e+A},{pos:"sw",x:t,y:e+A},{pos:"w",x:t,y:e+A/2}];r.save(),l.forEach(u=>{r.fillStyle="#4a90e2",r.strokeStyle="#ffffff",r.lineWidth=2,r.fillRect(u.x-a/2,u.y-a/2,a,a),r.strokeRect(u.x-a/2,u.y-a/2,a,a)}),r.restore()}drawPath(t,e){const{path:i,settings:A}=t,r=this.ctx;if(!(i.length<2)){r.save(),e&&(r.globalAlpha=.3),r.strokeStyle=A.color,r.lineWidth=this.getStrokeWidth(A.size),r.lineCap="round",r.lineJoin="round",r.beginPath(),r.moveTo(i[0].x,i[0].y);for(let a=1;a<i.length;a++)r.lineTo(i[a].x,i[a].y);r.stroke(),r.restore()}}drawLassoPath(t){const{path:e}=t,i=this.ctx;if(!(e.length<2)){i.save(),i.strokeStyle="rgba(0, 100, 255, 0.8)",i.lineWidth=2,i.setLineDash([5,5]),i.beginPath(),i.moveTo(e[0].x,e[0].y);for(let A=1;A<e.length;A++)i.lineTo(e[A].x,e[A].y);i.lineTo(e[0].x,e[0].y),i.stroke(),i.restore()}}getStrokeWidth(t){if(typeof t=="number")return t;switch(t){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 2}}getLineDash(t){switch(t){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}getSizeValue(t){if(typeof t=="number")return`${t}px`;switch(t){case"small":return"14px";case"medium":return"18px";case"large":return"24px";default:return"16px"}}updateHover(t,e){var r,a;const i=this.hoverAnnotation;if(((r=this.selectedAnnotation)==null?void 0:r.type)==="text"){const l=this.getResizeHandleAt(t,e,this.selectedAnnotation);if(l){const u={nw:"nwse-resize",n:"ns-resize",ne:"nesw-resize",e:"ew-resize",se:"nwse-resize",s:"ns-resize",sw:"nesw-resize",w:"ew-resize"};this.canvas.style.cursor=u[l];return}}if((a=d.state.lassoSelection)!=null&&a.isActive&&d.state.lassoSelection.convexHull){const l=ag({x:t,y:e},d.state.lassoSelection.convexHull,10),u=aa({x:t,y:e},d.state.lassoSelection.convexHull);if(l||u){this.canvas.style.cursor="move";return}}const A=this.getAnnotationAt(t,e);A&&(A.type==="arrow"||A.type==="text")?(this.canvas.style.cursor="move",this.hoverAnnotation=A):(this.setTool(this.currentTool,this.toolSettings),this.hoverAnnotation=null),i!==this.hoverAnnotation&&this.render()}getResizeHandleAt(t,e,i){if((i==null?void 0:i.type)!=="text")return null;const r=8/2+2,a=i.width||0,l=i.height||0,u=i.x,h=i.y,m=[{pos:"nw",x:u,y:h},{pos:"n",x:u+a/2,y:h},{pos:"ne",x:u+a,y:h},{pos:"e",x:u+a,y:h+l/2},{pos:"se",x:u+a,y:h+l},{pos:"s",x:u+a/2,y:h+l},{pos:"sw",x:u,y:h+l},{pos:"w",x:u,y:h+l/2}];for(const g of m)if(Math.sqrt(Math.pow(t-g.x,2)+Math.pow(e-g.y,2))<=r)return g.pos;return null}getAnnotationAt(t,e){for(let A=d.state.annotations.length-1;A>=0;A--){const r=d.state.annotations[A];if(r.type==="arrow"){if(this.distanceToLineSegment(t,e,r.startX,r.startY,r.endX,r.endY)<10)return r}else if(r.type==="text"){let a=r.width,l=r.height;if(!a||!l){const u=r.text.split(`
`),h=r.settings.size,m=h*1.2;this.ctx.font=`${h}px Arial`,a=0,u.forEach(g=>{const w=this.ctx.measureText(g);a=Math.max(a,w.width)}),l=u.length*m}if(t>=r.x&&t<=r.x+a&&e>=r.y&&e<=r.y+l)return r}}return null}showEraserCursor(t,e){this.render();const A=(d.state.cellWidth||40)*2;this.ctx.save(),this.ctx.fillStyle="rgba(220, 53, 69, 0.3)",this.ctx.fillRect(t-A/2,e-A/2,A,A),this.ctx.restore()}loadAnnotationSettings(t){if(t.type==="arrow"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.arrow={...e},window.drawToolsController.renderArrowOptions()}else if(t.type==="text"&&window.drawToolsController){const e=t.settings;window.drawToolsController.settings.text={...e},window.drawToolsController.renderTextOptions()}}applyCurrentSettingsToSelected(){this.selectedAnnotation&&(this.selectedAnnotation.type==="arrow"&&this.toolSettings.arrow?(this.selectedAnnotation.settings={...this.toolSettings.arrow},this.render()):this.selectedAnnotation.type==="text"&&this.toolSettings.text&&(this.selectedAnnotation.settings={...this.toolSettings.text},this.render()))}clearAnnotations(){d.state.annotations=[],this.render()}eraseAtPoint(t,e){let A=!1;return d.state.annotations=d.state.annotations.filter(r=>{let a=!0;if(r.type==="arrow"){const l=this.getRenderOptions(),u=_t(r.startCol,l),h=qt(r.startRow,l),m=_t(r.endCol,l),g=qt(r.endRow,l);this.distanceToLineSegment(t,e,u,h,m,g)<10&&(a=!1,A=!0)}else if(r.type==="text"){const l=this.getRenderOptions(),u=_t(r.col,l),h=qt(r.row,l),m=_t(r.col+r.widthCols,l),g=qt(r.row+r.heightRows,l);t>=u&&t<=m&&e>=h&&e<=g&&(a=!1,A=!0)}else if(r.type==="marker"||r.type==="highlighter"){const l=this.getRenderOptions();for(let u=0;u<r.path.length;u++){const h=_t(r.path[u].col,l),m=qt(r.path[u].row,l),g=t-h,w=e-m;if(Math.sqrt(g*g+w*w)<10){a=!1,A=!0;break}}}return a}),A&&this.render(),A}interpolatePoints(t,e){const i=[],A=e.col-t.col,r=e.row-t.row,a=Math.sqrt(A*A+r*r),l=Math.max(1,Math.floor(a/.1));for(let u=1;u<=l;u++){const h=u/l;i.push({col:t.col+h*A,row:t.row+h*r})}return i}distanceToLineSegment(t,e,i,A,r,a){const l=r-i,u=a-A,h=l*l+u*u;if(h===0){const E=t-i,x=e-A;return Math.sqrt(E*E+x*x)}let m=((t-i)*l+(e-A)*u)/h;m=Math.max(0,Math.min(1,m));const g=i+m*l,w=A+m*u,C=t-g,y=e-w;return Math.sqrt(C*C+y*y)}deleteAnnotationAt(t,e){this.eraseAtPoint(t,e)}getAnnotations(){return d.state.annotations}loadAnnotations(t){d.state.annotations=t||[],this.render()}applyInlineFormatting(t){const e=document.querySelector(".annotation-text-input");if(!e)return;const i=window.getSelection();if(!i.rangeCount)return;const A=i.getRangeAt(0),r=A.toString();if(!r)return;let a;if(t==="superscript")a=`<sup>${r}</sup>`;else if(t==="subscript")a=`<sub>${r}</sub>`;else return;A.deleteContents();const l=document.createTextNode(a);A.insertNode(l),A.setStartAfter(l),A.setEndAfter(l),i.removeAllRanges(),i.addRange(A),e.focus()}}const be=new mE;function cg(s){if((s==null?void 0:s.type)!=="arrow")return!1;const t=s,e=t.settings;return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!!e&&typeof e.strokeWeight=="number"&&typeof e.lineStyle=="string"}function ug(s){if((s==null?void 0:s.type)!=="text")return!1;const t=s,e=t.settings;return typeof t.col=="number"&&typeof t.row=="number"&&typeof t.widthCols=="number"&&typeof t.heightRows=="number"&&typeof t.text=="string"&&!!e&&typeof e.size=="number"&&typeof e.color=="string"}function gE(s){if((s==null?void 0:s.type)!=="text")return!1;const t=s,e=typeof s.col=="number";return typeof t.startCol=="number"&&typeof t.startRow=="number"&&typeof t.endCol=="number"&&typeof t.endRow=="number"&&!e}function hg(s){if(!s||s.type!=="marker"&&s.type!=="highlighter")return!1;const t=s,e=t.settings;return Array.isArray(t.path)&&!!e&&typeof e.color=="string"&&(typeof e.size=="number"||e.size==="small"||e.size==="medium"||e.size==="large")}function wE(s){return(s==null?void 0:s.type)==="lasso"&&Array.isArray(s.path)}function vE(s,t){const e=d.state.annotations,i=be.tempAnnotation,A=be.selectedAnnotation,r=be.hoverAnnotation;if(e&&e.length>0&&e.forEach(l=>{const u=l===A,h=l===r;switch(l.type){case"arrow":cg(l)&&dg(s,l,u,h,t);break;case"text":ug(l)&&pg(s,l,u,h,t);break;case"marker":case"highlighter":hg(l)&&mg(s,l,t);break}}),i)switch(i.type){case"arrow":cg(i)&&dg(s,i,!1,!1,t);break;case"text":gE(i)?_E(s,i,t):ug(i)&&pg(s,i,!1,!1,t);break;case"marker":case"highlighter":hg(i)&&mg(s,i,t);break;case"lasso":wE(i)&&EE(s,i);break}const a=d.state.lassoSelection;a!=null&&a.isActive&&Array.isArray(a.convexHull)&&(be.updateLassoConvexHull(),SE(s,a.convexHull))}function dg(s,t,e=!1,i=!1,A){const{startCol:r,startRow:a,endCol:l,endRow:u,settings:h}=t,m=_t(r,A),g=qt(a,A),w=_t(l,A),C=qt(u,A);s.save(),s.strokeStyle=t.color||"#000000",s.lineWidth=Od(h.strokeWeight),s.setLineDash(xE(h.lineStyle));const y=Math.atan2(C-g,w-m),E=h.arrowheadSize||12;let x=m,T=g,U=w,H=C;h.startArrowhead&&h.startArrowhead!=="none"&&(x=m+Math.cos(y)*E,T=g+Math.sin(y)*E),h.endArrowhead&&h.endArrowhead!=="none"&&(U=w-Math.cos(y)*E,H=C-Math.sin(y)*E),s.beginPath(),s.moveTo(x,T),s.lineTo(U,H),s.stroke(),s.setLineDash([]),h.startArrowhead&&h.startArrowhead!=="none"&&fg(s,m,g,y+Math.PI,h.startArrowhead,E),h.endArrowhead&&h.endArrowhead!=="none"&&fg(s,w,C,y,h.endArrowhead,E),(e||i)&&(s.strokeStyle=e?"rgba(74, 144, 226, 0.6)":"rgba(74, 144, 226, 0.3)",s.lineWidth=Od(h.strokeWeight)+4,s.setLineDash([]),s.beginPath(),s.moveTo(m,g),s.lineTo(w,C),s.stroke()),s.restore()}function fg(s,t,e,i,A,r){switch(s.save(),s.translate(t,e),s.rotate(i),A){case"filled":case"filled-arrow":s.beginPath(),s.moveTo(0,0),s.lineTo(-r,-r/2),s.lineTo(-r,r/2),s.closePath(),s.fillStyle=s.strokeStyle,s.fill();break;case"unfilled":case"unfilled-arrow":s.beginPath(),s.moveTo(0,0),s.lineTo(-r,-r/2),s.lineTo(-r,r/2),s.closePath(),s.stroke();break;case"circle":s.beginPath(),s.arc(0,0,r/3,0,Math.PI*2),s.fillStyle=s.strokeStyle,s.fill();break}s.restore()}function pg(s,t,e=!1,i=!1,A){const{col:r,row:a,text:l,widthCols:u,heightRows:h,settings:m}=t,g=_t(r,A),w=qt(a,A),C=_t(r+(typeof u=="number"?u:2),A)-g,y=qt(a+(typeof h=="number"?h:1),A)-w;s.save();const x=window.getComputedStyle(document.documentElement).getPropertyValue("--main-font").trim()||'"Atkinson Hyperlegible", Arial, sans-serif',T=m.size,U=T*1.2,H=m.background?8:4,R=4,D=C-H*2,P=BE(s,l,D,T,m,x);m.background&&(s.fillStyle="#ffffff",s.fillRect(g,w,C,y)),i&&!e&&(s.fillStyle="rgba(74, 144, 226, 0.1)",s.fillRect(g,w,C,y)),e&&(s.fillStyle="rgba(74, 144, 226, 0.2)",s.fillRect(g,w,C,y)),s.fillStyle=m.color,P.forEach((G,Y)=>{const W=w+R+Y*U;yE(s,G,g+H,W,T,m,x)}),e&&bE(s,g,w,C,y),s.restore()}function BE(s,t,e,i,A,r){s.font=`${A.italic?"italic ":""}${A.bold?"bold ":""}${i}px ${r}`;const a=t.split(`
`),l=[];return a.forEach(u=>{if(!u.trim()){l.push("");return}const h=u.split(" ");let m="";h.forEach(g=>{const w=m?m+" "+g:g;s.measureText(w).width>e&&m?(l.push(m),m=g):m=w}),m&&l.push(m)}),l}function yE(s,t,e,i,A,r,a){if(r.superscript||r.subscript){s.save();const h=A*.6,m=r.superscript?-A*.4:A*.3;if(s.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${h}px ${a}`,s.fillText(t,e,i+m),r.underline){const g=s.measureText(t);s.beginPath(),s.strokeStyle=r.color,s.lineWidth=1,s.moveTo(e,i+m+h*1.2-2),s.lineTo(e+g.width,i+m+h*1.2-2),s.stroke()}s.restore();return}const l=CE(t);let u=e;l.forEach(h=>{if(s.save(),h.format==="superscript"){const m=A*.6,g=-A*.4;s.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${m}px ${a}`,s.fillText(h.text,u,i+g),u+=s.measureText(h.text).width}else if(h.format==="subscript"){const m=A*.6,g=A*.3;s.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${m}px ${a}`,s.fillText(h.text,u,i+g),u+=s.measureText(h.text).width}else{if(s.font=`${r.italic?"italic ":""}${r.bold?"bold ":""}${A}px ${a}`,s.fillText(h.text,u,i),r.underline){const m=s.measureText(h.text);s.beginPath(),s.strokeStyle=r.color,s.lineWidth=1,s.moveTo(u,i+A*1.2-2),s.lineTo(u+m.width,i+A*1.2-2),s.stroke()}u+=s.measureText(h.text).width}s.restore()})}function CE(s){const t=[];let e=0,i="",A=!1;for(;e<s.length;){if(s.substr(e,5)==="<sup>"){i&&(t.push({text:i,format:"normal"}),i="");const r=s.indexOf("</sup>",e);if(r!==-1){const a=s.substring(e+5,r);t.push({text:a,format:"superscript"}),e=r+6;continue}}if(s.substr(e,5)==="<sub>"){i&&(t.push({text:i,format:"normal"}),i="");const r=s.indexOf("</sub>",e);if(r!==-1){const a=s.substring(e+5,r);t.push({text:a,format:"subscript"}),e=r+6;continue}}if(s[e]==="^"&&!A){i&&(t.push({text:i,format:"normal"}),i=""),A=!0,e++;continue}if(A&&s[e]===" "){i&&(t.push({text:i,format:"superscript"}),i=""),A=!1,t.push({text:" ",format:"normal"}),e++;continue}i+=s[e],e++}return i&&t.push({text:i,format:A?"superscript":"normal"}),t}function bE(s,t,e,i,A){const a=[{x:t,y:e},{x:t+i/2,y:e},{x:t+i,y:e},{x:t+i,y:e+A/2},{x:t+i,y:e+A},{x:t+i/2,y:e+A},{x:t,y:e+A},{x:t,y:e+A/2}];s.save(),a.forEach(l=>{s.fillStyle="#4a90e2",s.strokeStyle="#ffffff",s.lineWidth=2,s.fillRect(l.x-8/2,l.y-8/2,8,8),s.strokeRect(l.x-8/2,l.y-8/2,8,8)}),s.restore()}function _E(s,t,e){const{startCol:i,startRow:A,endCol:r,endRow:a}=t,l=_t(i,e),u=qt(A,e),h=_t(r,e),m=qt(a,e),g=Math.min(l,h),w=Math.min(u,m),C=Math.abs(h-l),y=Math.abs(m-u);s.save(),s.strokeStyle="rgba(74, 144, 226, 0.6)",s.lineWidth=2,s.setLineDash([5,5]),s.strokeRect(g,w,C,y),s.restore()}function mg(s,t,e){const{path:i,settings:A,type:r}=t;if(!i||i.length<2)return;const a=i.map(u=>({x:_t(u.col,e),y:qt(u.row,e)}));s.save(),r==="highlighter"&&(s.globalAlpha=.3),s.strokeStyle=A.color,s.lineWidth=typeof A.size=="number"?A.size:Od(A.size),s.lineCap="round",s.lineJoin="round",s.beginPath();const l=a[0];if(!l){s.restore();return}s.moveTo(l.x,l.y);for(let u=1;u<a.length;u++){const h=a[u];h&&s.lineTo(h.x,h.y)}s.stroke(),s.restore()}function Od(s){if(typeof s=="number")return s;switch(s){case"small":return 2;case"medium":return 4;case"large":return 6;default:return 4}}function xE(s){switch(s){case"solid":return[];case"dashed-big":return[10,5];case"dashed-small":return[5,3];case"dotted":return[2,3];default:return[]}}function EE(s,t){const e=t.path;if(!e||e.length<2)return;const i=e[0];if(i){s.save(),s.strokeStyle="#4a90e2",s.lineWidth=2,s.setLineDash([5,5]),s.globalAlpha=.7,s.beginPath(),s.moveTo(i.x,i.y);for(let A=1;A<e.length;A++){const r=e[A];r&&s.lineTo(r.x,r.y)}e.length>2&&s.lineTo(i.x,i.y),s.stroke(),s.restore()}}function SE(s,t){if(!t||t.length<3)return;const e=t[0];if(e){s.save(),s.strokeStyle="#4a90e2",s.lineWidth=2,s.setLineDash([8,4]),s.globalAlpha=.8,s.beginPath(),s.moveTo(e.x,e.y);for(let i=1;i<t.length;i++){const A=t[i];A&&s.lineTo(A.x,A.y)}s.closePath(),s.stroke(),s.fillStyle="rgba(74, 144, 226, 0.1)",s.fill(),s.restore()}}function FE(s,t){var h,m;const e={...d.state,...t};!((h=e.columnWidths)!=null&&h.length)||(m=e.fullRowData)!=null&&m.length,s.clearRect(0,0,rs(s.canvas),_e(s.canvas));const{startRow:i,endRow:A}=Ux(),r=oa.getLegendLeftContext(),a=oa.getLegendRightContext();Xx(r,a,e,i,A),Gx(s,e,i,A),qx(s,e);const l=t.placedNotes.filter(g=>!g.isDrum&&g.row>=i&&g.row<=A),u=t.placedTonicSigns.filter(g=>g.row>=i&&g.row<=A);l.forEach(g=>{g.shape==="oval"?Xf(s,e,g,g.row):g.shape==="circle"&&$f(s,e,g,g.row)}),u.forEach(g=>{Yf(s,e,g)}),tE(s,e),iE(s,e),Vv(s,e),vE(s,e)}const Wv={getTimeSignatureSegments(){const s=d.state,t=s.macrobeatGroupings??[],e=s.macrobeatBoundaryStyles??[],i=[];let A=!!s.hasAnacrusis,r=Os(s,0).startColumn,a=0,l=!1;return t.forEach((u,h)=>{a+=u,u===3&&(l=!0);const m=h===t.length-1,w=e[h]==="solid";if(w||m){const y=Os(s,h).endColumn+1,E=Array.isArray(s.modulationMarkers)&&s.modulationMarkers.length>0;let x,T;const U={...s,modulationMarkers:E?s.modulationMarkers:[],cellWidth:s.cellWidth,columnWidths:s.columnWidths,musicalColumnWidths:s.musicalColumnWidths,baseMicrobeatPx:s.cellWidth};x=_t(r,U),T=_t(y,U);const H=l?`${a}/8`:`${a/2}/4`;i.push({label:H,centerX:(x+T)/2,startX:x,endX:T,isAnacrusis:A}),m||(r=y,a=0,l=!1,w&&(A=!1))}}),i},getRhythmUIButtons(){const s=d.state,t=s.macrobeatGroupings??[],e=s.macrobeatBoundaryStyles??[],i=[];return t.forEach((A,r)=>{const a=Os(s,r),{startColumn:l,endColumn:u}=a,h={...s,modulationMarkers:s.modulationMarkers||[],cellWidth:s.cellWidth,columnWidths:s.columnWidths,musicalColumnWidths:s.musicalColumnWidths||s.columnWidths.slice(2,-2),baseMicrobeatPx:s.cellWidth},m=_t(l,h),g=_t(u+1,h),w=(m+g)/2,C=e[r]??null;i.push({type:"grouping",content:A,x:w,startX:m,endX:g,index:r,nextBoundaryStyle:C}),r<t.length-1&&i.push({type:"boundary",boundaryStyle:C,x:g,index:r})}),i}},TE="data-rhythm-ui-element",Vd=s=>`${Math.round(s*100)/100}px`,IE=s=>{s.querySelectorAll(`[${TE}]`).forEach(t=>t.remove())},QE=s=>{const t=document.getElementById("notation-grid");if(!t)return null;const e=t.getBoundingClientRect(),i=s.getBoundingClientRect();return e.width===0?null:e.left-i.left},ME=(s,t)=>{const e=document.createElement("button");return e.type="button",e.className="grouping-segment",e.dataset.rhythmUiElement="grouping",e.dataset.index=`${s.index}`,e.textContent=`${s.content}`,e.style.left=Vd(t+s.startX),e.style.width=Vd(Math.max(0,s.endX-s.startX)),e.dataset.nextBoundaryStyle=`${s.nextBoundaryStyle??""}`,e.setAttribute("aria-label",`Toggle macrobeat grouping (${s.content}) at position ${s.index+1}`),e.addEventListener("click",i=>{i.stopPropagation(),d.toggleMacrobeatGrouping(s.index)}),e},UE=(s,t)=>{const e=document.createElement("button");e.type="button",e.className="rhythm-ui-button rhythm-ui-button--boundary",e.dataset.rhythmUiElement="boundary",e.dataset.index=`${s.index}`,e.style.left=Vd(t+s.x),e.setAttribute("aria-label","Cycle boundary style");const i=document.createElement("span");return i.className="boundary-diamond",i.dataset.style=s.boundaryStyle||"dashed",e.appendChild(i),e.addEventListener("click",A=>{A.stopPropagation(),d.cycleMacrobeatBoundaryStyle(s.index)}),e};function Kv(){const s=document.getElementById("beat-line-button-layer");if(!s){b.warn("rhythmUI","Cannot render rhythm UI without beat-line container",null,"ui");return}const t=QE(s);if(t===null)return;const e=s.querySelector("#grouping-buttons-row"),i=s.querySelector("#boundary-buttons-row");IE(s);const A=Wv.getRhythmUIButtons();if(!Array.isArray(A)||A.length===0)return;const r=document.createDocumentFragment(),a=document.createDocumentFragment();A.forEach(l=>{l.type==="grouping"?r.appendChild(ME(l,t)):l.type==="boundary"&&a.appendChild(UE(l,t))}),e?e.appendChild(r):s.appendChild(r),i?i.appendChild(a):s.appendChild(a)}const PE={init:DE};function DE(){Kv()}const kE={getTimeSignatureOptions(){return{"Single Macrobeat":[{label:"1/4",groupings:[2],description:"one 2-beat"},{label:"2/8",groupings:[2],description:"one 2-beat"},{label:"3/8",groupings:[3],description:"one 3-beat"}],"Two Macrobeats":[{label:"2/4",groupings:[2,2],description:"two 2-beats"},{label:"4/8",groupings:[2,2],description:"two 2-beats"},{label:"5/8",groupings:[2,3],description:"2+3"},{label:"5/8",groupings:[3,2],description:"3+2"},{label:"6/8",groupings:[3,3],description:"two 3-beats"}],"Three Macrobeats":[{label:"3/4",groupings:[2,2,2],description:"three 2-beats"},{label:"7/8",groupings:[2,2,3],description:"2+2+3"},{label:"7/8",groupings:[3,2,2],description:"3+2+2"},{label:"7/8",groupings:[2,3,2],description:"2+3+2"},{label:"8/8",groupings:[3,3,2],description:"3+3+2"},{label:"8/8",groupings:[3,2,3],description:"3+2+3"},{label:"8/8",groupings:[2,3,3],description:"2+3+3"},{label:"9/8",groupings:[3,3,3],description:"three 3-beats"}],"Four Macrobeats":[{label:"4/4",groupings:[2,2,2,2],description:"four 2-beats"},{label:"10/8",groupings:[2,2,3,3],description:"2+2+3+3"},{label:"10/8",groupings:[2,3,2,3],description:"2+3+2+3"},{label:"10/8",groupings:[2,3,3,2],description:"2+3+3+2"},{label:"10/8",groupings:[3,2,3,2],description:"3+2+3+2"},{label:"10/8",groupings:[3,3,2,2],description:"3+3+2+2"},{label:"10/8",groupings:[3,2,2,3],description:"3+2+2+3"},{label:"11/8",groupings:[3,3,3,2],description:"3+3+3+2"},{label:"11/8",groupings:[3,3,2,3],description:"3+3+2+3"},{label:"11/8",groupings:[3,2,3,3],description:"3+2+3+3"},{label:"11/8",groupings:[2,3,3,3],description:"2+3+3+3"},{label:"12/8",groupings:[3,3,3,3],description:"four 3-beats"}],"Five Macrobeats":[{label:"5/4",groupings:[2,2,2,2,2],description:"five 2-beats"},{label:"11/8",groupings:[2,2,2,2,3],description:"2+2+2+2+3"},{label:"11/8",groupings:[2,2,2,3,2],description:"2+2+2+3+2"},{label:"11/8",groupings:[2,2,3,2,2],description:"2+2+3+2+2"},{label:"11/8",groupings:[2,3,2,2,2],description:"2+3+2+2+2"},{label:"11/8",groupings:[3,2,2,2,2],description:"3+2+2+2+2"},{label:"12/8",groupings:[2,2,2,3,3],description:"2+2+2+3+3"},{label:"12/8",groupings:[2,2,3,2,3],description:"2+2+3+2+3"},{label:"12/8",groupings:[2,2,3,3,2],description:"2+2+3+3+2"},{label:"12/8",groupings:[2,3,2,2,3],description:"2+3+2+2+3"},{label:"12/8",groupings:[2,3,2,3,2],description:"2+3+2+3+2"},{label:"12/8",groupings:[2,3,3,2,2],description:"2+3+3+2+2"},{label:"12/8",groupings:[3,2,2,2,3],description:"3+2+2+2+3"},{label:"12/8",groupings:[3,2,2,3,2],description:"3+2+2+3+2"},{label:"12/8",groupings:[3,2,3,2,2],description:"3+2+3+2+2"},{label:"12/8",groupings:[3,3,2,2,2],description:"3+3+2+2+2"},{label:"13/8",groupings:[3,2,2,3,3],description:"3+2+2+3+3"},{label:"13/8",groupings:[3,3,2,3,2],description:"3+3+2+3+2"},{label:"13/8",groupings:[3,3,3,2,2],description:"3+3+3+2+2"},{label:"15/8",groupings:[3,3,3,3,3],description:"five 3-beats"}]}},generateDropdownHTML(){const s=this.getTimeSignatureOptions();let t='<div id="time-signature-dropdown" class="time-signature-dropdown hidden">';return Object.entries(s).forEach(([e,i])=>{t+='<div class="dropdown-category">',t+=`<div class="dropdown-category-header">${e}</div>`,i.forEach((A,r)=>{const a=`${e}-${r}`;t+=`<div class="dropdown-option" data-groupings="${JSON.stringify(A.groupings)}" data-key="${a}">`,t+=`<span class="dropdown-label">${A.label}</span>`,t+=`<span class="dropdown-description">${A.description}</span>`,t+="</div>"}),t+="</div>"}),t+="</div>",t},getTimeSignatureLabel(s){const t=s.reduce((i,A)=>i+A,0);return s.includes(3)?`${t}/8`:`${t/2}/4`}};let lr=null;function LE(){const s=document.getElementById("beat-line-button-layer");if(!s)return;const t=s.querySelector("#time-signature-row")||s;s.querySelectorAll(".time-signature-label").forEach(u=>u.remove());const i=document.getElementById("notation-grid");if(!i)return;const A=i.getBoundingClientRect(),r=s.getBoundingClientRect(),a=A.left-r.left;Wv.getTimeSignatureSegments().forEach((u,h)=>{const m=document.createElement("div");m.className="time-signature-label",u.isAnacrusis&&m.classList.add("anacrusis-label"),m.textContent=u.label,m.style.position="absolute",m.style.left=`${a+u.centerX}px`,m.style.transform="translateX(-50%)",m.style.pointerEvents="auto",m.addEventListener("click",g=>{g.stopPropagation(),HE(m,h)}),t.appendChild(m)}),RE()}function RE(){if(!document.getElementById("time-signature-dropdown")){const s=kE.generateDropdownHTML();document.body.insertAdjacentHTML("beforeend",s);const t=document.getElementById("time-signature-dropdown");t==null||t.addEventListener("click",OE)}}function HE(s,t){const e=document.getElementById("time-signature-dropdown");if(!e)return;e.dataset.measureIndex=String(t);const i=s.getBoundingClientRect();e.style.left=`${i.left}px`,e.style.top=`${i.bottom+5}px`;const A=e.getBoundingClientRect(),r=window.innerWidth,a=window.innerHeight;i.left+A.width>r&&(e.style.left=`${r-A.width-10}px`),i.bottom+A.height>a&&(e.style.top=`${i.top-A.height-5}px`),e.classList.remove("hidden"),lr={dropdown:e,measureIndex:t},setTimeout(()=>{document.addEventListener("click",NE,{once:!0})},0)}function NE(s){const t=document.getElementById("time-signature-dropdown"),e=s.target;t&&e&&!t.contains(e)&&(t.classList.add("hidden"),lr=null)}function OE(s){const t=s.target,e=t==null?void 0:t.closest(".dropdown-option");if(!e)return;const i=e.dataset.groupings,A=(lr==null?void 0:lr.measureIndex)??NaN;if(!(!i||Number.isNaN(A)))try{const r=JSON.parse(i);d.updateTimeSignature(A,r);const a=document.getElementById("time-signature-dropdown");a==null||a.classList.add("hidden"),lr=null}catch{}}b.moduleLoaded("PitchGridController","grid");function VE(){var i,A;const s=oa.getPitchContext();if(!(s!=null&&s.canvas)){b.error("PitchGridController","Pitch grid context not available for rendering",null,"grid");return}const t=Ot.getViewportInfo(),e={placedNotes:cx(d.state),placedTonicSigns:hi(d.state),fullRowData:d.state.fullRowData,columnWidths:d.state.columnWidths,cellWidth:d.state.cellWidth,cellHeight:d.state.cellHeight,rowHeight:d.state.cellHeight*.5,macrobeatGroupings:d.state.macrobeatGroupings,macrobeatBoundaryStyles:d.state.macrobeatBoundaryStyles,accidentalMode:d.state.accidentalMode,showFrequencyLabels:d.state.showFrequencyLabels,colorMode:"color",degreeDisplayMode:d.state.degreeDisplayMode,zoomLevel:t.zoomLevel,viewportHeight:t.containerHeight,modulationMarkers:d.state.modulationMarkers};b.debug("PitchGridController","renderPitchGrid options",{columns:(i=e.columnWidths)==null?void 0:i.length,rows:(A=e.fullRowData)==null?void 0:A.length,placedNotes:e.placedNotes.length,tonicSigns:e.placedTonicSigns.length,zoomLevel:e.zoomLevel,viewportHeight:e.viewportHeight},"grid"),FE(s,e)}const la={render(){VE()},renderMacrobeatTools(){Kv(),LE()}};/*!
 * html2canvas 1.4.1 <https://html2canvas.hertzen.com>
 * Copyright (c) 2022 Niklas von Hertzen <https://hertzen.com>
 * Released under MIT License
 *//*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var Wd=function(s,t){return Wd=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,i){e.__proto__=i}||function(e,i){for(var A in i)Object.prototype.hasOwnProperty.call(i,A)&&(e[A]=i[A])},Wd(s,t)};function In(s,t){if(typeof t!="function"&&t!==null)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");Wd(s,t);function e(){this.constructor=s}s.prototype=t===null?Object.create(t):(e.prototype=t.prototype,new e)}var Kd=function(){return Kd=Object.assign||function(t){for(var e,i=1,A=arguments.length;i<A;i++){e=arguments[i];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},Kd.apply(this,arguments)};function Is(s,t,e,i){function A(r){return r instanceof e?r:new e(function(a){a(r)})}return new(e||(e=Promise))(function(r,a){function l(m){try{h(i.next(m))}catch(g){a(g)}}function u(m){try{h(i.throw(m))}catch(g){a(g)}}function h(m){m.done?r(m.value):A(m.value).then(l,u)}h((i=i.apply(s,[])).next())})}function Bs(s,t){var e={label:0,sent:function(){if(r[0]&1)throw r[1];return r[1]},trys:[],ops:[]},i,A,r,a;return a={next:l(0),throw:l(1),return:l(2)},typeof Symbol=="function"&&(a[Symbol.iterator]=function(){return this}),a;function l(h){return function(m){return u([h,m])}}function u(h){if(i)throw new TypeError("Generator is already executing.");for(;e;)try{if(i=1,A&&(r=h[0]&2?A.return:h[0]?A.throw||((r=A.return)&&r.call(A),0):A.next)&&!(r=r.call(A,h[1])).done)return r;switch(A=0,r&&(h=[h[0]&2,r.value]),h[0]){case 0:case 1:r=h;break;case 4:return e.label++,{value:h[1],done:!1};case 5:e.label++,A=h[1],h=[0];continue;case 7:h=e.ops.pop(),e.trys.pop();continue;default:if(r=e.trys,!(r=r.length>0&&r[r.length-1])&&(h[0]===6||h[0]===2)){e=0;continue}if(h[0]===3&&(!r||h[1]>r[0]&&h[1]<r[3])){e.label=h[1];break}if(h[0]===6&&e.label<r[1]){e.label=r[1],r=h;break}if(r&&e.label<r[2]){e.label=r[2],e.ops.push(h);break}r[2]&&e.ops.pop(),e.trys.pop();continue}h=t.call(s,e)}catch(m){h=[6,m],A=0}finally{i=r=0}if(h[0]&5)throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}}function Al(s,t,e){if(arguments.length===2)for(var i=0,A=t.length,r;i<A;i++)(r||!(i in t))&&(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return s.concat(r||t)}var ui=(function(){function s(t,e,i,A){this.left=t,this.top=e,this.width=i,this.height=A}return s.prototype.add=function(t,e,i,A){return new s(this.left+t,this.top+e,this.width+i,this.height+A)},s.fromClientRect=function(t,e){return new s(e.left+t.windowBounds.left,e.top+t.windowBounds.top,e.width,e.height)},s.fromDOMRectList=function(t,e){var i=Array.from(e).find(function(A){return A.width!==0});return i?new s(i.left+t.windowBounds.left,i.top+t.windowBounds.top,i.width,i.height):s.EMPTY},s.EMPTY=new s(0,0,0,0),s})(),Nc=function(s,t){return ui.fromClientRect(s,t.getBoundingClientRect())},WE=function(s){var t=s.body,e=s.documentElement;if(!t||!e)throw new Error("Unable to get document size");var i=Math.max(Math.max(t.scrollWidth,e.scrollWidth),Math.max(t.offsetWidth,e.offsetWidth),Math.max(t.clientWidth,e.clientWidth)),A=Math.max(Math.max(t.scrollHeight,e.scrollHeight),Math.max(t.offsetHeight,e.offsetHeight),Math.max(t.clientHeight,e.clientHeight));return new ui(0,0,i,A)},Oc=function(s){for(var t=[],e=0,i=s.length;e<i;){var A=s.charCodeAt(e++);if(A>=55296&&A<=56319&&e<i){var r=s.charCodeAt(e++);(r&64512)===56320?t.push(((A&1023)<<10)+(r&1023)+65536):(t.push(A),e--)}else t.push(A)}return t},We=function(){for(var s=[],t=0;t<arguments.length;t++)s[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,s);var e=s.length;if(!e)return"";for(var i=[],A=-1,r="";++A<e;){var a=s[A];a<=65535?i.push(a):(a-=65536,i.push((a>>10)+55296,a%1024+56320)),(A+1===e||i.length>16384)&&(r+=String.fromCharCode.apply(String,i),i.length=0)}return r},gg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",KE=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var rl=0;rl<gg.length;rl++)KE[gg.charCodeAt(rl)]=rl;var wg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",So=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var ol=0;ol<wg.length;ol++)So[wg.charCodeAt(ol)]=ol;var GE=function(s){var t=s.length*.75,e=s.length,i,A=0,r,a,l,u;s[s.length-1]==="="&&(t--,s[s.length-2]==="="&&t--);var h=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(t):new Array(t),m=Array.isArray(h)?h:new Uint8Array(h);for(i=0;i<e;i+=4)r=So[s.charCodeAt(i)],a=So[s.charCodeAt(i+1)],l=So[s.charCodeAt(i+2)],u=So[s.charCodeAt(i+3)],m[A++]=r<<2|a>>4,m[A++]=(a&15)<<4|l>>2,m[A++]=(l&3)<<6|u&63;return h},qE=function(s){for(var t=s.length,e=[],i=0;i<t;i+=2)e.push(s[i+1]<<8|s[i]);return e},zE=function(s){for(var t=s.length,e=[],i=0;i<t;i+=4)e.push(s[i+3]<<24|s[i+2]<<16|s[i+1]<<8|s[i]);return e},hA=5,Jf=11,Vh=2,$E=Jf-hA,Gv=65536>>hA,XE=1<<hA,Wh=XE-1,YE=1024>>hA,jE=Gv+YE,JE=jE,ZE=32,tS=JE+ZE,eS=65536>>Jf,sS=1<<$E,nS=sS-1,vg=function(s,t,e){return s.slice?s.slice(t,e):new Uint16Array(Array.prototype.slice.call(s,t,e))},iS=function(s,t,e){return s.slice?s.slice(t,e):new Uint32Array(Array.prototype.slice.call(s,t,e))},AS=function(s,t){var e=GE(s),i=Array.isArray(e)?zE(e):new Uint32Array(e),A=Array.isArray(e)?qE(e):new Uint16Array(e),r=24,a=vg(A,r/2,i[4]/2),l=i[5]===2?vg(A,(r+i[4])/2):iS(i,Math.ceil((r+i[4])/4));return new rS(i[0],i[1],i[2],i[3],a,l)},rS=(function(){function s(t,e,i,A,r,a){this.initialValue=t,this.errorValue=e,this.highStart=i,this.highValueIndex=A,this.index=r,this.data=a}return s.prototype.get=function(t){var e;if(t>=0){if(t<55296||t>56319&&t<=65535)return e=this.index[t>>hA],e=(e<<Vh)+(t&Wh),this.data[e];if(t<=65535)return e=this.index[Gv+(t-55296>>hA)],e=(e<<Vh)+(t&Wh),this.data[e];if(t<this.highStart)return e=tS-eS+(t>>Jf),e=this.index[e],e+=t>>hA&nS,e=this.index[e],e=(e<<Vh)+(t&Wh),this.data[e];if(t<=1114111)return this.data[this.highValueIndex]}return this.errorValue},s})(),Bg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",oS=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var al=0;al<Bg.length;al++)oS[Bg.charCodeAt(al)]=al;var aS="KwAAAAAAAAAACA4AUD0AADAgAAACAAAAAAAIABAAGABAAEgAUABYAGAAaABgAGgAYgBqAF8AZwBgAGgAcQB5AHUAfQCFAI0AlQCdAKIAqgCyALoAYABoAGAAaABgAGgAwgDKAGAAaADGAM4A0wDbAOEA6QDxAPkAAQEJAQ8BFwF1AH0AHAEkASwBNAE6AUIBQQFJAVEBWQFhAWgBcAF4ATAAgAGGAY4BlQGXAZ8BpwGvAbUBvQHFAc0B0wHbAeMB6wHxAfkBAQIJAvEBEQIZAiECKQIxAjgCQAJGAk4CVgJeAmQCbAJ0AnwCgQKJApECmQKgAqgCsAK4ArwCxAIwAMwC0wLbAjAA4wLrAvMC+AIAAwcDDwMwABcDHQMlAy0DNQN1AD0DQQNJA0kDSQNRA1EDVwNZA1kDdQB1AGEDdQBpA20DdQN1AHsDdQCBA4kDkQN1AHUAmQOhA3UAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AKYDrgN1AHUAtgO+A8YDzgPWAxcD3gPjA+sD8wN1AHUA+wMDBAkEdQANBBUEHQQlBCoEFwMyBDgEYABABBcDSARQBFgEYARoBDAAcAQzAXgEgASIBJAEdQCXBHUAnwSnBK4EtgS6BMIEyAR1AHUAdQB1AHUAdQCVANAEYABgAGAAYABgAGAAYABgANgEYADcBOQEYADsBPQE/AQEBQwFFAUcBSQFLAU0BWQEPAVEBUsFUwVbBWAAYgVgAGoFcgV6BYIFigWRBWAAmQWfBaYFYABgAGAAYABgAKoFYACxBbAFuQW6BcEFwQXHBcEFwQXPBdMF2wXjBeoF8gX6BQIGCgYSBhoGIgYqBjIGOgZgAD4GRgZMBmAAUwZaBmAAYABgAGAAYABgAGAAYABgAGAAYABgAGIGYABpBnAGYABgAGAAYABgAGAAYABgAGAAYAB4Bn8GhQZgAGAAYAB1AHcDFQSLBmAAYABgAJMGdQA9A3UAmwajBqsGqwaVALMGuwbDBjAAywbSBtIG1QbSBtIG0gbSBtIG0gbdBuMG6wbzBvsGAwcLBxMHAwcbByMHJwcsBywHMQcsB9IGOAdAB0gHTgfSBkgHVgfSBtIG0gbSBtIG0gbSBtIG0gbSBiwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdgAGAALAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAdbB2MHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB2kH0gZwB64EdQB1AHUAdQB1AHUAdQB1AHUHfQdgAIUHjQd1AHUAlQedB2AAYAClB6sHYACzB7YHvgfGB3UAzgfWBzMB3gfmB1EB7gf1B/0HlQENAQUIDQh1ABUIHQglCBcDLQg1CD0IRQhNCEEDUwh1AHUAdQBbCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIaQhjCGQIZQhmCGcIaAhpCGMIZAhlCGYIZwhoCGkIYwhkCGUIZghnCGgIcAh3CHoIMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIgggwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAALAcsBywHLAcsBywHLAcsBywHLAcsB4oILAcsB44I0gaWCJ4Ipgh1AHUAqgiyCHUAdQB1AHUAdQB1AHUAdQB1AHUAtwh8AXUAvwh1AMUIyQjRCNkI4AjoCHUAdQB1AO4I9gj+CAYJDgkTCS0HGwkjCYIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiCCIIIggiAAIAAAAFAAYABgAGIAXwBgAHEAdQBFAJUAogCyAKAAYABgAEIA4ABGANMA4QDxAMEBDwE1AFwBLAE6AQEBUQF4QkhCmEKoQrhCgAHIQsAB0MLAAcABwAHAAeDC6ABoAHDCwMMAAcABwAHAAdDDGMMAAcAB6MM4wwjDWMNow3jDaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAGgAaABoAEjDqABWw6bDqABpg6gAaABoAHcDvwOPA+gAaABfA/8DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DvwO/A78DpcPAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcAB9cPKwkyCToJMAB1AHUAdQBCCUoJTQl1AFUJXAljCWcJawkwADAAMAAwAHMJdQB2CX4JdQCECYoJjgmWCXUAngkwAGAAYABxAHUApgn3A64JtAl1ALkJdQDACTAAMAAwADAAdQB1AHUAdQB1AHUAdQB1AHUAowYNBMUIMAAwADAAMADICcsJ0wnZCRUE4QkwAOkJ8An4CTAAMAB1AAAKvwh1AAgKDwoXCh8KdQAwACcKLgp1ADYKqAmICT4KRgowADAAdQB1AE4KMAB1AFYKdQBeCnUAZQowADAAMAAwADAAMAAwADAAMAAVBHUAbQowADAAdQC5CXUKMAAwAHwBxAijBogEMgF9CoQKiASMCpQKmgqIBKIKqgquCogEDQG2Cr4KxgrLCjAAMADTCtsKCgHjCusK8Qr5CgELMAAwADAAMAB1AIsECQsRC3UANAEZCzAAMAAwADAAMAB1ACELKQswAHUANAExCzkLdQBBC0kLMABRC1kLMAAwADAAMAAwADAAdQBhCzAAMAAwAGAAYABpC3ELdwt/CzAAMACHC4sLkwubC58Lpwt1AK4Ltgt1APsDMAAwADAAMAAwADAAMAAwAL4LwwvLC9IL1wvdCzAAMADlC+kL8Qv5C/8LSQswADAAMAAwADAAMAAwADAAMAAHDDAAMAAwADAAMAAODBYMHgx1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1ACYMMAAwADAAdQB1AHUALgx1AHUAdQB1AHUAdQA2DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AD4MdQBGDHUAdQB1AHUAdQB1AEkMdQB1AHUAdQB1AFAMMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQBYDHUAdQB1AF8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUA+wMVBGcMMAAwAHwBbwx1AHcMfwyHDI8MMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAYABgAJcMMAAwADAAdQB1AJ8MlQClDDAAMACtDCwHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsB7UMLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHdQB1AHUAdQB1AHUAdQB1AHUAdQB1AHUAdQB1AA0EMAC9DDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAsBywHLAcsBywHLAcsBywHLQcwAMEMyAwsBywHLAcsBywHLAcsBywHLAcsBywHzAwwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwAHUAdQB1ANQM2QzhDDAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMABgAGAAYABgAGAAYABgAOkMYADxDGAA+AwADQYNYABhCWAAYAAODTAAMAAwADAAFg1gAGAAHg37AzAAMAAwADAAYABgACYNYAAsDTQNPA1gAEMNPg1LDWAAYABgAGAAYABgAGAAYABgAGAAUg1aDYsGVglhDV0NcQBnDW0NdQ15DWAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAlQCBDZUAiA2PDZcNMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAnw2nDTAAMAAwADAAMAAwAHUArw23DTAAMAAwADAAMAAwADAAMAAwADAAMAB1AL8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAB1AHUAdQB1AHUAdQDHDTAAYABgAM8NMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA1w11ANwNMAAwAD0B5A0wADAAMAAwADAAMADsDfQN/A0EDgwOFA4wABsOMAAwADAAMAAwADAAMAAwANIG0gbSBtIG0gbSBtIG0gYjDigOwQUuDsEFMw7SBjoO0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGQg5KDlIOVg7SBtIGXg5lDm0OdQ7SBtIGfQ6EDooOjQ6UDtIGmg6hDtIG0gaoDqwO0ga0DrwO0gZgAGAAYADEDmAAYAAkBtIGzA5gANIOYADaDokO0gbSBt8O5w7SBu8O0gb1DvwO0gZgAGAAxA7SBtIG0gbSBtIGYABgAGAAYAAED2AAsAUMD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHJA8sBywHLAcsBywHLAccDywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywPLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAc0D9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAccD9IG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIGFA8sBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHLAcsBywHPA/SBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gbSBtIG0gYUD0QPlQCVAJUAMAAwADAAMACVAJUAlQCVAJUAlQCVAEwPMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAA//8EAAQABAAEAAQABAAEAAQABAANAAMAAQABAAIABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQACgATABcAHgAbABoAHgAXABYAEgAeABsAGAAPABgAHABLAEsASwBLAEsASwBLAEsASwBLABgAGAAeAB4AHgATAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABYAGwASAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWAA0AEQAeAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAFAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJABYAGgAbABsAGwAeAB0AHQAeAE8AFwAeAA0AHgAeABoAGwBPAE8ADgBQAB0AHQAdAE8ATwAXAE8ATwBPABYAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AHgAeAFAATwBAAE8ATwBPAEAATwBQAFAATwBQAB4AHgAeAB4AHgAeAB0AHQAdAB0AHgAdAB4ADgBQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgBQAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAJAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAkACQAJAAkACQAJAAkABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAFAAHgAeAB4AKwArAFAAUABQAFAAGABQACsAKwArACsAHgAeAFAAHgBQAFAAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUAAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAYAA0AKwArAB4AHgAbACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAB4ABAAEAB4ABAAEABMABAArACsAKwArACsAKwArACsAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAKwArACsAKwBWAFYAVgBWAB4AHgArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AGgAaABoAGAAYAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQAEwAEACsAEwATAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABLAEsASwBLAEsASwBLAEsASwBLABoAGQAZAB4AUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQABMAUAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABABQAFAABAAEAB4ABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUAAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAFAABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQAUABQAB4AHgAYABMAUAArACsABAAbABsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAFAABAAEAAQABAAEAFAABAAEAAQAUAAEAAQABAAEAAQAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArACsAHgArAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAUAAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEAA0ADQBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUAArACsAKwBQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABABQACsAKwArACsAKwArACsAKwAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUAAaABoAUABQAFAAUABQAEwAHgAbAFAAHgAEACsAKwAEAAQABAArAFAAUABQAFAAUABQACsAKwArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQACsAUABQACsAKwAEACsABAAEAAQABAAEACsAKwArACsABAAEACsAKwAEAAQABAArACsAKwAEACsAKwArACsAKwArACsAUABQAFAAUAArAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLAAQABABQAFAAUAAEAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsAKwAEAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAArACsAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AGwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAKwArACsAKwArAAQABAAEACsAKwArACsAUABQACsAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAAQAUAArAFAAUABQAFAAUABQACsAKwArAFAAUABQACsAUABQAFAAUAArACsAKwBQAFAAKwBQACsAUABQACsAKwArAFAAUAArACsAKwBQAFAAUAArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArAAQABAAEAAQABAArACsAKwAEAAQABAArAAQABAAEAAQAKwArAFAAKwArACsAKwArACsABAArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAHgAeAB4AHgAeAB4AGwAeACsAKwArACsAKwAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAUABQAFAAKwArACsAKwArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwAOAFAAUABQAFAAUABQAFAAHgBQAAQABAAEAA4AUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAKwArAAQAUAAEAAQABAAEAAQABAAEACsABAAEAAQAKwAEAAQABAAEACsAKwArACsAKwArACsABAAEACsAKwArACsAKwArACsAUAArAFAAUAAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAFAABAAEAAQABAAEAAQABAArAAQABAAEACsABAAEAAQABABQAB4AKwArACsAKwBQAFAAUAAEAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQABoAUABQAFAAUABQAFAAKwAEAAQABAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQACsAUAArACsAUABQAFAAUABQAFAAUAArACsAKwAEACsAKwArACsABAAEAAQABAAEAAQAKwAEACsABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArAAQABAAeACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAXAAqACoAKgAqACoAKgAqACsAKwArACsAGwBcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAeAEsASwBLAEsASwBLAEsASwBLAEsADQANACsAKwArACsAKwBcAFwAKwBcACsAXABcAFwAXABcACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAXAArAFwAXABcAFwAXABcAFwAXABcAFwAKgBcAFwAKgAqACoAKgAqACoAKgAqACoAXAArACsAXABcAFwAXABcACsAXAArACoAKgAqACoAKgAqACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwBcAFwAXABcAFAADgAOAA4ADgAeAA4ADgAJAA4ADgANAAkAEwATABMAEwATAAkAHgATAB4AHgAeAAQABAAeAB4AHgAeAB4AHgBLAEsASwBLAEsASwBLAEsASwBLAFAAUABQAFAAUABQAFAAUABQAFAADQAEAB4ABAAeAAQAFgARABYAEQAEAAQAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQADQAEAAQABAAEAAQADQAEAAQAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAA0ADQAeAB4AHgAeAB4AHgAEAB4AHgAeAB4AHgAeACsAHgAeAA4ADgANAA4AHgAeAB4AHgAeAAkACQArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgBcAEsASwBLAEsASwBLAEsASwBLAEsADQANAB4AHgAeAB4AXABcAFwAXABcAFwAKgAqACoAKgBcAFwAXABcACoAKgAqAFwAKgAqACoAXABcACoAKgAqACoAKgAqACoAXABcAFwAKgAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKgAqAFwAKgBLAEsASwBLAEsASwBLAEsASwBLACoAKgAqACoAKgAqAFAAUABQAFAAUABQACsAUAArACsAKwArACsAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAKwBQACsAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsABAAEAAQAHgANAB4AHgAeAB4AHgAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUAArACsADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAWABEAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQANAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAANAA0AKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUAArAAQABAArACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqAA0ADQAVAFwADQAeAA0AGwBcACoAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwAeAB4AEwATAA0ADQAOAB4AEwATAB4ABAAEAAQACQArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAHgArACsAKwATABMASwBLAEsASwBLAEsASwBLAEsASwBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAXABcAFwAXABcACsAKwArACsAKwArACsAKwArACsAKwBcAFwAXABcAFwAXABcAFwAXABcAFwAXAArACsAKwArAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAXAArACsAKwAqACoAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAArACsAHgAeAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcACoAKgAqACoAKgAqACoAKgAqACoAKwAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKwArAAQASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACoAKgAqACoAKgAqACoAXAAqACoAKgAqACoAKgArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABABQAFAAUABQAFAAUABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwANAA0AHgANAA0ADQANAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAEAAQABAAEAAQAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwAeAB4AHgAeAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArAA0ADQANAA0ADQBLAEsASwBLAEsASwBLAEsASwBLACsAKwArAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAA0ADQBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUAAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArAAQABAAEAB4ABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAAQAUABQAFAAUABQAFAABABQAFAABAAEAAQAUAArACsAKwArACsABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQACsAUAArAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAFAAUABQACsAHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQACsAKwAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQACsAHgAeAB4AHgAeAB4AHgAOAB4AKwANAA0ADQANAA0ADQANAAkADQANAA0ACAAEAAsABAAEAA0ACQANAA0ADAAdAB0AHgAXABcAFgAXABcAFwAWABcAHQAdAB4AHgAUABQAFAANAAEAAQAEAAQABAAEAAQACQAaABoAGgAaABoAGgAaABoAHgAXABcAHQAVABUAHgAeAB4AHgAeAB4AGAAWABEAFQAVABUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ADQAeAA0ADQANAA0AHgANAA0ADQAHAB4AHgAeAB4AKwAEAAQABAAEAAQABAAEAAQABAAEAFAAUAArACsATwBQAFAAUABQAFAAHgAeAB4AFgARAE8AUABPAE8ATwBPAFAAUABQAFAAUAAeAB4AHgAWABEAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArABsAGwAbABsAGwAbABsAGgAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGgAbABsAGwAbABoAGwAbABoAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbABsAGwAbAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAHgAeAFAAGgAeAB0AHgBQAB4AGgAeAB4AHgAeAB4AHgAeAB4AHgBPAB4AUAAbAB4AHgBQAFAAUABQAFAAHgAeAB4AHQAdAB4AUAAeAFAAHgBQAB4AUABPAFAAUAAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAHgBQAFAAUABQAE8ATwBQAFAAUABQAFAATwBQAFAATwBQAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAUABQAFAATwBPAE8ATwBPAE8ATwBPAE8ATwBQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABPAB4AHgArACsAKwArAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHQAdAB4AHgAeAB0AHQAeAB4AHQAeAB4AHgAdAB4AHQAbABsAHgAdAB4AHgAeAB4AHQAeAB4AHQAdAB0AHQAeAB4AHQAeAB0AHgAdAB0AHQAdAB0AHQAeAB0AHgAeAB4AHgAeAB0AHQAdAB0AHgAeAB4AHgAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB4AHgAeAB0AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAeAB0AHQAdAB0AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAdAB4AHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAWABEAHgAeAB4AHgAeAB4AHQAeAB4AHgAeAB4AHgAeACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAWABEAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAFAAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAeAB4AHQAdAB0AHQAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB0AHQAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB0AHQAeAB4AHQAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AHQAdAB0AHgAeAB0AHgAeAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlAB4AHQAdAB4AHgAdAB4AHgAeAB4AHQAdAB4AHgAeAB4AJQAlAB0AHQAlAB4AJQAlACUAIAAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAeAB4AHgAeAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHgAdAB0AHQAeAB0AJQAdAB0AHgAdAB0AHgAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHQAdAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAdAB0AHQAdACUAHgAlACUAJQAdACUAJQAdAB0AHQAlACUAHQAdACUAHQAdACUAJQAlAB4AHQAeAB4AHgAeAB0AHQAlAB0AHQAdAB0AHQAdACUAJQAlACUAJQAdACUAJQAgACUAHQAdACUAJQAlACUAJQAlACUAJQAeAB4AHgAlACUAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB0AHgAeAB4AFwAXABcAFwAXABcAHgATABMAJQAeAB4AHgAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARABYAEQAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAWABEAFgARABYAEQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAWABEAFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AFgARAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAdAB0AHQAdAB0AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAFAAUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAEAAQABAAeAB4AKwArACsAKwArABMADQANAA0AUAATAA0AUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUAANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAA0ADQANAA0ADQANAA0ADQAeAA0AFgANAB4AHgAXABcAHgAeABcAFwAWABEAFgARABYAEQAWABEADQANAA0ADQATAFAADQANAB4ADQANAB4AHgAeAB4AHgAMAAwADQANAA0AHgANAA0AFgANAA0ADQANAA0ADQANAA0AHgANAB4ADQANAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArACsAKwArACsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArAA0AEQARACUAJQBHAFcAVwAWABEAFgARABYAEQAWABEAFgARACUAJQAWABEAFgARABYAEQAWABEAFQAWABEAEQAlAFcAVwBXAFcAVwBXAFcAVwBXAAQABAAEAAQABAAEACUAVwBXAFcAVwA2ACUAJQBXAFcAVwBHAEcAJQAlACUAKwBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBRAFcAUQBXAFEAVwBXAFcAVwBXAFcAUQBXAFcAVwBXAFcAVwBRAFEAKwArAAQABAAVABUARwBHAFcAFQBRAFcAUQBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFEAVwBRAFcAUQBXAFcAVwBXAFcAVwBRAFcAVwBXAFcAVwBXAFEAUQBXAFcAVwBXABUAUQBHAEcAVwArACsAKwArACsAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwAlACUAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACsAKwArACsAKwArACsAKwArACsAKwArAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAUQBRAFEAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBPAE8ATwBPAE8ATwBPAE8AJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADQATAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABLAEsASwBLAEsASwBLAEsASwBLAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAABAAEAAQABAAeAAQABAAEAAQABAAEAAQABAAEAAQAHgBQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUABQAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAeAA0ADQANAA0ADQArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AUAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAB4AHgAeAB4AHgAeAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AUABQAFAAUABQAFAAUABQAFAAUABQAAQAUABQAFAABABQAFAAUABQAAQAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAeAB4AHgAeAAQAKwArACsAUABQAFAAUABQAFAAHgAeABoAHgArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAADgAOABMAEwArACsAKwArACsAKwArACsABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwANAA0ASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUAAeAB4AHgBQAA4AUABQAAQAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArAB4AWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYAFgAWABYACsAKwArAAQAHgAeAB4AHgAeAB4ADQANAA0AHgAeAB4AHgArAFAASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArAB4AHgBcAFwAXABcAFwAKgBcAFwAXABcAFwAXABcAFwAXABcAEsASwBLAEsASwBLAEsASwBLAEsAXABcAFwAXABcACsAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAFAAUABQAAQAUABQAFAAUABQAFAAUABQAAQABAArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAHgANAA0ADQBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKgAqACoAXAAqACoAKgBcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXAAqAFwAKgAqACoAXABcACoAKgBcAFwAXABcAFwAKgAqAFwAKgBcACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFwAXABcACoAKgBQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAA0ADQBQAFAAUAAEAAQAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQADQAEAAQAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAVABVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBUAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVAFUAVQBVACsAKwArACsAKwArACsAKwArACsAKwArAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAWQBZAFkAKwArACsAKwBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAWgBaAFoAKwArACsAKwAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYABgAGAAYAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAKwArACsAKwArAFYABABWAFYAVgBWAFYAVgBWAFYAVgBWAB4AVgBWAFYAVgBWAFYAVgBWAFYAVgBWAFYAVgArAFYAVgBWAFYAVgArAFYAKwBWAFYAKwBWAFYAKwBWAFYAVgBWAFYAVgBWAFYAVgBWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAEQAWAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAaAB4AKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAGAARABEAGAAYABMAEwAWABEAFAArACsAKwArACsAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACUAJQAlACUAJQAWABEAFgARABYAEQAWABEAFgARABYAEQAlACUAFgARACUAJQAlACUAJQAlACUAEQAlABEAKwAVABUAEwATACUAFgARABYAEQAWABEAJQAlACUAJQAlACUAJQAlACsAJQAbABoAJQArACsAKwArAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAcAKwATACUAJQAbABoAJQAlABYAEQAlACUAEQAlABEAJQBXAFcAVwBXAFcAVwBXAFcAVwBXABUAFQAlACUAJQATACUAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXABYAJQARACUAJQAlAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAWACUAEQAlABYAEQARABYAEQARABUAVwBRAFEAUQBRAFEAUQBRAFEAUQBRAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAEcARwArACsAVwBXAFcAVwBXAFcAKwArAFcAVwBXAFcAVwBXACsAKwBXAFcAVwBXAFcAVwArACsAVwBXAFcAKwArACsAGgAbACUAJQAlABsAGwArAB4AHgAeAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwAEAAQABAAQAB0AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsADQANAA0AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAA0AUABQAFAAUAArACsAKwArAFAAUABQAFAAUABQAFAAUAANAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwArAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwBQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwANAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAB4AUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAUABQAFAAUABQAAQABAAEACsABAAEACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAKwBQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAA0ADQANAA0ADQANAA0ADQAeACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAArACsAKwArAFAAUABQAFAAUAANAA0ADQANAA0ADQAUACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsADQANAA0ADQANAA0ADQBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAB4AHgAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArAAQABAANACsAKwBQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAB4AHgAeAB4AHgArACsAKwArACsAKwAEAAQABAAEAAQABAAEAA0ADQAeAB4AHgAeAB4AKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwAeACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEACsASwBLAEsASwBLAEsASwBLAEsASwANAA0ADQANAFAABAAEAFAAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAeAA4AUAArACsAKwArACsAKwArACsAKwAEAFAAUABQAFAADQANAB4ADQAEAAQABAAEAB4ABAAEAEsASwBLAEsASwBLAEsASwBLAEsAUAAOAFAADQANAA0AKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAANAA0AHgANAA0AHgAEACsAUABQAFAAUABQAFAAUAArAFAAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAA0AKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsABAAEAAQABAArAFAAUABQAFAAUABQAFAAUAArACsAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQACsABAAEAFAABAAEAAQABAAEAAQABAArACsABAAEACsAKwAEAAQABAArACsAUAArACsAKwArACsAKwAEACsAKwArACsAKwBQAFAAUABQAFAABAAEACsAKwAEAAQABAAEAAQABAAEACsAKwArAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsABAAEAAQABAAEAAQABABQAFAAUABQAA0ADQANAA0AHgBLAEsASwBLAEsASwBLAEsASwBLAA0ADQArAB4ABABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAFAAUAAeAFAAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABAAEAAQADgANAA0AEwATAB4AHgAeAA0ADQANAA0ADQANAA0ADQANAA0ADQANAA0ADQANAFAAUABQAFAABAAEACsAKwAEAA0ADQAeAFAAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAFAAKwArACsAKwArACsAKwBLAEsASwBLAEsASwBLAEsASwBLACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAXABcAFwAKwArACoAKgAqACoAKgAqACoAKgAqACoAKgAqACoAKgAqACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBcAFwADQANAA0AKgBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAKwArAFAAKwArAFAAUABQAFAAUABQAFAAUAArAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQAKwAEAAQAKwArAAQABAAEAAQAUAAEAFAABAAEAA0ADQANACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAArACsABAAEAAQABAAEAAQABABQAA4AUAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAABAAEAAQABAAEAAQABAAEAAQABABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAFAABAAEAAQABAAOAB4ADQANAA0ADQAOAB4ABAArACsAKwArACsAKwArACsAUAAEAAQABAAEAAQABAAEAAQABAAEAAQAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAA0ADQANAFAADgAOAA4ADQANACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAEAAQABAAEACsABAAEAAQABAAEAAQABAAEAFAADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAOABMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQACsAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAArACsAKwAEACsABAAEACsABAAEAAQABAAEAAQABABQAAQAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAUABQAFAAUABQAFAAKwBQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAUAArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAABAAEAAQABAAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAaABoAGgAaAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArAA0AUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsADQANAA0ADQANACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABIAEgAQwBDAEMAUABQAFAAUABDAFAAUABQAEgAQwBIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAASABDAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwAJAAkACQAJAAkACQAJABYAEQArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABIAEMAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwANAA0AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArAAQABAAEAAQABAANACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEAA0ADQANAB4AHgAeAB4AHgAeAFAAUABQAFAADQAeACsAKwArACsAKwArACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAANAA0AHgAeACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwAEAFAABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwAEAAQABAAEAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAARwBHABUARwAJACsAKwArACsAKwArACsAKwArACsAKwAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUQBRAFEAKwArACsAKwArACsAKwArACsAKwArACsAKwBRAFEAUQBRACsAKwArACsAKwArACsAKwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUAArACsAHgAEAAQADQAEAAQABAAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAAQABAAEAAQABAAeAB4AHgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAB4AHgAEAAQABAAEAAQABAAEAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4ABAAEAAQAHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwArACsAKwArACsAKwArACsAKwArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAKwArAFAAKwArAFAAUAArACsAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACsAUAArAFAAUABQAFAAUABQAFAAKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwBQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAHgAeAFAAUABQAFAAUAArAFAAKwArACsAUABQAFAAUABQAFAAUAArAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAB4AHgAeAB4AHgAeAB4AHgAeACsAKwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAEsASwBLAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAeAB4AHgAeAB4AHgAeAB4ABAAeAB4AHgAeAB4AHgAeAB4AHgAeAAQAHgAeAA0ADQANAA0AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQAKwAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArAAQABAAEAAQABAAEAAQAKwAEAAQAKwAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwAEAAQABAAEAAQABAAEAFAAUABQAFAAUABQAFAAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwBQAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArABsAUABQAFAAUABQACsAKwBQAFAAUABQAFAAUABQAFAAUAAEAAQABAAEAAQABAAEACsAKwArACsAKwArACsAKwArAB4AHgAeAB4ABAAEAAQABAAEAAQABABQACsAKwArACsASwBLAEsASwBLAEsASwBLAEsASwArACsAKwArABYAFgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAGgBQAFAAUAAaAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAeAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQACsAKwBQAFAAUABQACsAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUAArACsAKwArACsAKwBQACsAKwArACsAUAArAFAAKwBQACsAUABQAFAAKwBQAFAAKwBQACsAKwBQACsAUAArAFAAKwBQACsAUAArAFAAUAArAFAAKwArAFAAUABQAFAAKwBQAFAAUABQAFAAUABQACsAUABQAFAAUAArAFAAUABQAFAAKwBQACsAUABQAFAAUABQAFAAUABQAFAAUAArAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAArACsAKwArACsAUABQAFAAKwBQAFAAUABQAFAAKwBQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwAeAB4AKwArACsAKwArACsAKwArACsAKwArACsAKwArAE8ATwBPAE8ATwBPAE8ATwBPAE8ATwBPAE8AJQAlACUAHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHgAeAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB4AHgAeACUAJQAlAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAdAB0AHQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAKQApACkAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAlACUAJQAlACUAHgAlACUAJQAlACUAIAAgACAAJQAlACAAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACEAIQAhACEAIQAlACUAIAAgACUAJQAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlACUAIAAlACUAJQAlACAAIAAgACUAIAAgACAAJQAlACUAJQAlACUAJQAgACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAlAB4AJQAeACUAJQAlACUAJQAgACUAJQAlACUAHgAlAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAgACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACAAIAAgACAAIAAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeABcAFwAXABUAFQAVAB4AHgAeAB4AJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAgACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlACUAJQAeAB4AHgAeAB4AHgAeAB4AHgAeACUAJQAlACUAJQAlAB4AHgAeAB4AHgAeAB4AHgAlACUAJQAlACUAJQAlACUAHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAgACUAJQAgACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAJQAlACUAJQAlACUAIAAlACUAJQAlACUAJQAlACUAJQAgACAAIAAgACAAIAAgACAAIAAgACUAJQAgACAAIAAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACAAIAAlACAAIAAlACAAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAgACAAIAAlACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJQAlAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AKwAeAB4AHgAeAB4AHgAeAB4AHgAeAB4AHgArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAEsASwBLAEsASwBLAEsASwBLAEsAKwArACsAKwArACsAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwArAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwAlACUAJQAlACUAJQAlACUAJQAlACUAVwBXACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQBXAFcAVwBXAFcAVwBXAFcAVwBXAFcAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAJQAlACUAKwAEACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArACsAKwArAA==",yg=50,lS=1,qv=2,zv=3,cS=4,uS=5,Cg=7,$v=8,bg=9,ki=10,Gd=11,_g=12,qd=13,hS=14,Fo=15,zd=16,ll=17,fo=18,dS=19,xg=20,$d=21,po=22,Kh=23,XA=24,js=25,To=26,Io=27,YA=28,fS=29,rA=30,pS=31,cl=32,ul=33,Xd=34,Yd=35,jd=36,ca=37,Jd=38,Kl=39,Gl=40,Gh=41,Xv=42,mS=43,gS=[9001,65288],Yv="!",Jt="",hl="",Zd=AS(aS),ii=[rA,jd],tf=[lS,qv,zv,uS],jv=[ki,$v],Eg=[Io,To],wS=tf.concat(jv),Sg=[Jd,Kl,Gl,Xd,Yd],vS=[Fo,qd],BS=function(s,t){t===void 0&&(t="strict");var e=[],i=[],A=[];return s.forEach(function(r,a){var l=Zd.get(r);if(l>yg?(A.push(!0),l-=yg):A.push(!1),["normal","auto","loose"].indexOf(t)!==-1&&[8208,8211,12316,12448].indexOf(r)!==-1)return i.push(a),e.push(zd);if(l===cS||l===Gd){if(a===0)return i.push(a),e.push(rA);var u=e[a-1];return wS.indexOf(u)===-1?(i.push(i[a-1]),e.push(u)):(i.push(a),e.push(rA))}if(i.push(a),l===pS)return e.push(t==="strict"?$d:ca);if(l===Xv||l===fS)return e.push(rA);if(l===mS)return r>=131072&&r<=196605||r>=196608&&r<=262141?e.push(ca):e.push(rA);e.push(l)}),[i,e,A]},qh=function(s,t,e,i){var A=i[e];if(Array.isArray(s)?s.indexOf(A)!==-1:s===A)for(var r=e;r<=i.length;){r++;var a=i[r];if(a===t)return!0;if(a!==ki)break}if(A===ki)for(var r=e;r>0;){r--;var l=i[r];if(Array.isArray(s)?s.indexOf(l)!==-1:s===l)for(var u=e;u<=i.length;){u++;var a=i[u];if(a===t)return!0;if(a!==ki)break}if(l!==ki)break}return!1},Fg=function(s,t){for(var e=s;e>=0;){var i=t[e];if(i===ki)e--;else return i}return 0},yS=function(s,t,e,i,A){if(e[i]===0)return Jt;var r=i-1;if(Array.isArray(A)&&A[r]===!0)return Jt;var a=r-1,l=r+1,u=t[r],h=a>=0?t[a]:0,m=t[l];if(u===qv&&m===zv)return Jt;if(tf.indexOf(u)!==-1)return Yv;if(tf.indexOf(m)!==-1||jv.indexOf(m)!==-1)return Jt;if(Fg(r,t)===$v)return hl;if(Zd.get(s[r])===Gd||(u===cl||u===ul)&&Zd.get(s[l])===Gd||u===Cg||m===Cg||u===bg||[ki,qd,Fo].indexOf(u)===-1&&m===bg||[ll,fo,dS,XA,YA].indexOf(m)!==-1||Fg(r,t)===po||qh(Kh,po,r,t)||qh([ll,fo],$d,r,t)||qh(_g,_g,r,t))return Jt;if(u===ki)return hl;if(u===Kh||m===Kh)return Jt;if(m===zd||u===zd)return hl;if([qd,Fo,$d].indexOf(m)!==-1||u===hS||h===jd&&vS.indexOf(u)!==-1||u===YA&&m===jd||m===xg||ii.indexOf(m)!==-1&&u===js||ii.indexOf(u)!==-1&&m===js||u===Io&&[ca,cl,ul].indexOf(m)!==-1||[ca,cl,ul].indexOf(u)!==-1&&m===To||ii.indexOf(u)!==-1&&Eg.indexOf(m)!==-1||Eg.indexOf(u)!==-1&&ii.indexOf(m)!==-1||[Io,To].indexOf(u)!==-1&&(m===js||[po,Fo].indexOf(m)!==-1&&t[l+1]===js)||[po,Fo].indexOf(u)!==-1&&m===js||u===js&&[js,YA,XA].indexOf(m)!==-1)return Jt;if([js,YA,XA,ll,fo].indexOf(m)!==-1)for(var g=r;g>=0;){var w=t[g];if(w===js)return Jt;if([YA,XA].indexOf(w)!==-1)g--;else break}if([Io,To].indexOf(m)!==-1)for(var g=[ll,fo].indexOf(u)!==-1?a:r;g>=0;){var w=t[g];if(w===js)return Jt;if([YA,XA].indexOf(w)!==-1)g--;else break}if(Jd===u&&[Jd,Kl,Xd,Yd].indexOf(m)!==-1||[Kl,Xd].indexOf(u)!==-1&&[Kl,Gl].indexOf(m)!==-1||[Gl,Yd].indexOf(u)!==-1&&m===Gl||Sg.indexOf(u)!==-1&&[xg,To].indexOf(m)!==-1||Sg.indexOf(m)!==-1&&u===Io||ii.indexOf(u)!==-1&&ii.indexOf(m)!==-1||u===XA&&ii.indexOf(m)!==-1||ii.concat(js).indexOf(u)!==-1&&m===po&&gS.indexOf(s[l])===-1||ii.concat(js).indexOf(m)!==-1&&u===fo)return Jt;if(u===Gh&&m===Gh){for(var C=e[r],y=1;C>0&&(C--,t[C]===Gh);)y++;if(y%2!==0)return Jt}return u===cl&&m===ul?Jt:hl},CS=function(s,t){t||(t={lineBreak:"normal",wordBreak:"normal"});var e=BS(s,t.lineBreak),i=e[0],A=e[1],r=e[2];(t.wordBreak==="break-all"||t.wordBreak==="break-word")&&(A=A.map(function(l){return[js,rA,Xv].indexOf(l)!==-1?ca:l}));var a=t.wordBreak==="keep-all"?r.map(function(l,u){return l&&s[u]>=19968&&s[u]<=40959}):void 0;return[i,A,a]},bS=(function(){function s(t,e,i,A){this.codePoints=t,this.required=e===Yv,this.start=i,this.end=A}return s.prototype.slice=function(){return We.apply(void 0,this.codePoints.slice(this.start,this.end))},s})(),_S=function(s,t){var e=Oc(s),i=CS(e,t),A=i[0],r=i[1],a=i[2],l=e.length,u=0,h=0;return{next:function(){if(h>=l)return{done:!0,value:null};for(var m=Jt;h<l&&(m=yS(e,r,A,++h,a))===Jt;);if(m!==Jt||h===l){var g=new bS(e,m,u,h);return u=h,{value:g,done:!1}}return{done:!0,value:null}}}},xS=1,ES=2,Ca=4,Tg=8,dc=10,Ig=47,Wo=92,SS=9,FS=32,dl=34,mo=61,TS=35,IS=36,QS=37,fl=39,pl=40,go=41,MS=95,Rs=45,US=33,PS=60,DS=62,kS=64,LS=91,RS=93,HS=61,NS=123,ml=63,OS=125,Qg=124,VS=126,WS=128,Mg=65533,zh=42,lA=43,KS=44,GS=58,qS=59,ua=46,zS=0,$S=8,XS=11,YS=14,jS=31,JS=127,Hn=-1,Jv=48,Zv=97,tB=101,ZS=102,t1=117,e1=122,eB=65,sB=69,nB=70,s1=85,n1=90,ys=function(s){return s>=Jv&&s<=57},i1=function(s){return s>=55296&&s<=57343},jA=function(s){return ys(s)||s>=eB&&s<=nB||s>=Zv&&s<=ZS},A1=function(s){return s>=Zv&&s<=e1},r1=function(s){return s>=eB&&s<=n1},o1=function(s){return A1(s)||r1(s)},a1=function(s){return s>=WS},gl=function(s){return s===dc||s===SS||s===FS},fc=function(s){return o1(s)||a1(s)||s===MS},Ug=function(s){return fc(s)||ys(s)||s===Rs},l1=function(s){return s>=zS&&s<=$S||s===XS||s>=YS&&s<=jS||s===JS},Ti=function(s,t){return s!==Wo?!1:t!==dc},wl=function(s,t,e){return s===Rs?fc(t)||Ti(t,e):fc(s)?!0:!!(s===Wo&&Ti(s,t))},$h=function(s,t,e){return s===lA||s===Rs?ys(t)?!0:t===ua&&ys(e):ys(s===ua?t:s)},c1=function(s){var t=0,e=1;(s[t]===lA||s[t]===Rs)&&(s[t]===Rs&&(e=-1),t++);for(var i=[];ys(s[t]);)i.push(s[t++]);var A=i.length?parseInt(We.apply(void 0,i),10):0;s[t]===ua&&t++;for(var r=[];ys(s[t]);)r.push(s[t++]);var a=r.length,l=a?parseInt(We.apply(void 0,r),10):0;(s[t]===sB||s[t]===tB)&&t++;var u=1;(s[t]===lA||s[t]===Rs)&&(s[t]===Rs&&(u=-1),t++);for(var h=[];ys(s[t]);)h.push(s[t++]);var m=h.length?parseInt(We.apply(void 0,h),10):0;return e*(A+l*Math.pow(10,-a))*Math.pow(10,u*m)},u1={type:2},h1={type:3},d1={type:4},f1={type:13},p1={type:8},m1={type:21},g1={type:9},w1={type:10},v1={type:11},B1={type:12},y1={type:14},vl={type:23},C1={type:1},b1={type:25},_1={type:24},x1={type:26},E1={type:27},S1={type:28},F1={type:29},T1={type:31},ef={type:32},iB=(function(){function s(){this._value=[]}return s.prototype.write=function(t){this._value=this._value.concat(Oc(t))},s.prototype.read=function(){for(var t=[],e=this.consumeToken();e!==ef;)t.push(e),e=this.consumeToken();return t},s.prototype.consumeToken=function(){var t=this.consumeCodePoint();switch(t){case dl:return this.consumeStringToken(dl);case TS:var e=this.peekCodePoint(0),i=this.peekCodePoint(1),A=this.peekCodePoint(2);if(Ug(e)||Ti(i,A)){var r=wl(e,i,A)?ES:xS,a=this.consumeName();return{type:5,value:a,flags:r}}break;case IS:if(this.peekCodePoint(0)===mo)return this.consumeCodePoint(),f1;break;case fl:return this.consumeStringToken(fl);case pl:return u1;case go:return h1;case zh:if(this.peekCodePoint(0)===mo)return this.consumeCodePoint(),y1;break;case lA:if($h(t,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(t),this.consumeNumericToken();break;case KS:return d1;case Rs:var l=t,u=this.peekCodePoint(0),h=this.peekCodePoint(1);if($h(l,u,h))return this.reconsumeCodePoint(t),this.consumeNumericToken();if(wl(l,u,h))return this.reconsumeCodePoint(t),this.consumeIdentLikeToken();if(u===Rs&&h===DS)return this.consumeCodePoint(),this.consumeCodePoint(),_1;break;case ua:if($h(t,this.peekCodePoint(0),this.peekCodePoint(1)))return this.reconsumeCodePoint(t),this.consumeNumericToken();break;case Ig:if(this.peekCodePoint(0)===zh)for(this.consumeCodePoint();;){var m=this.consumeCodePoint();if(m===zh&&(m=this.consumeCodePoint(),m===Ig))return this.consumeToken();if(m===Hn)return this.consumeToken()}break;case GS:return x1;case qS:return E1;case PS:if(this.peekCodePoint(0)===US&&this.peekCodePoint(1)===Rs&&this.peekCodePoint(2)===Rs)return this.consumeCodePoint(),this.consumeCodePoint(),b1;break;case kS:var g=this.peekCodePoint(0),w=this.peekCodePoint(1),C=this.peekCodePoint(2);if(wl(g,w,C)){var a=this.consumeName();return{type:7,value:a}}break;case LS:return S1;case Wo:if(Ti(t,this.peekCodePoint(0)))return this.reconsumeCodePoint(t),this.consumeIdentLikeToken();break;case RS:return F1;case HS:if(this.peekCodePoint(0)===mo)return this.consumeCodePoint(),p1;break;case NS:return v1;case OS:return B1;case t1:case s1:var y=this.peekCodePoint(0),E=this.peekCodePoint(1);return y===lA&&(jA(E)||E===ml)&&(this.consumeCodePoint(),this.consumeUnicodeRangeToken()),this.reconsumeCodePoint(t),this.consumeIdentLikeToken();case Qg:if(this.peekCodePoint(0)===mo)return this.consumeCodePoint(),g1;if(this.peekCodePoint(0)===Qg)return this.consumeCodePoint(),m1;break;case VS:if(this.peekCodePoint(0)===mo)return this.consumeCodePoint(),w1;break;case Hn:return ef}return gl(t)?(this.consumeWhiteSpace(),T1):ys(t)?(this.reconsumeCodePoint(t),this.consumeNumericToken()):fc(t)?(this.reconsumeCodePoint(t),this.consumeIdentLikeToken()):{type:6,value:We(t)}},s.prototype.consumeCodePoint=function(){var t=this._value.shift();return typeof t>"u"?-1:t},s.prototype.reconsumeCodePoint=function(t){this._value.unshift(t)},s.prototype.peekCodePoint=function(t){return t>=this._value.length?-1:this._value[t]},s.prototype.consumeUnicodeRangeToken=function(){for(var t=[],e=this.consumeCodePoint();jA(e)&&t.length<6;)t.push(e),e=this.consumeCodePoint();for(var i=!1;e===ml&&t.length<6;)t.push(e),e=this.consumeCodePoint(),i=!0;if(i){var A=parseInt(We.apply(void 0,t.map(function(u){return u===ml?Jv:u})),16),r=parseInt(We.apply(void 0,t.map(function(u){return u===ml?nB:u})),16);return{type:30,start:A,end:r}}var a=parseInt(We.apply(void 0,t),16);if(this.peekCodePoint(0)===Rs&&jA(this.peekCodePoint(1))){this.consumeCodePoint(),e=this.consumeCodePoint();for(var l=[];jA(e)&&l.length<6;)l.push(e),e=this.consumeCodePoint();var r=parseInt(We.apply(void 0,l),16);return{type:30,start:a,end:r}}else return{type:30,start:a,end:a}},s.prototype.consumeIdentLikeToken=function(){var t=this.consumeName();return t.toLowerCase()==="url"&&this.peekCodePoint(0)===pl?(this.consumeCodePoint(),this.consumeUrlToken()):this.peekCodePoint(0)===pl?(this.consumeCodePoint(),{type:19,value:t}):{type:20,value:t}},s.prototype.consumeUrlToken=function(){var t=[];if(this.consumeWhiteSpace(),this.peekCodePoint(0)===Hn)return{type:22,value:""};var e=this.peekCodePoint(0);if(e===fl||e===dl){var i=this.consumeStringToken(this.consumeCodePoint());return i.type===0&&(this.consumeWhiteSpace(),this.peekCodePoint(0)===Hn||this.peekCodePoint(0)===go)?(this.consumeCodePoint(),{type:22,value:i.value}):(this.consumeBadUrlRemnants(),vl)}for(;;){var A=this.consumeCodePoint();if(A===Hn||A===go)return{type:22,value:We.apply(void 0,t)};if(gl(A))return this.consumeWhiteSpace(),this.peekCodePoint(0)===Hn||this.peekCodePoint(0)===go?(this.consumeCodePoint(),{type:22,value:We.apply(void 0,t)}):(this.consumeBadUrlRemnants(),vl);if(A===dl||A===fl||A===pl||l1(A))return this.consumeBadUrlRemnants(),vl;if(A===Wo)if(Ti(A,this.peekCodePoint(0)))t.push(this.consumeEscapedCodePoint());else return this.consumeBadUrlRemnants(),vl;else t.push(A)}},s.prototype.consumeWhiteSpace=function(){for(;gl(this.peekCodePoint(0));)this.consumeCodePoint()},s.prototype.consumeBadUrlRemnants=function(){for(;;){var t=this.consumeCodePoint();if(t===go||t===Hn)return;Ti(t,this.peekCodePoint(0))&&this.consumeEscapedCodePoint()}},s.prototype.consumeStringSlice=function(t){for(var e=5e4,i="";t>0;){var A=Math.min(e,t);i+=We.apply(void 0,this._value.splice(0,A)),t-=A}return this._value.shift(),i},s.prototype.consumeStringToken=function(t){var e="",i=0;do{var A=this._value[i];if(A===Hn||A===void 0||A===t)return e+=this.consumeStringSlice(i),{type:0,value:e};if(A===dc)return this._value.splice(0,i),C1;if(A===Wo){var r=this._value[i+1];r!==Hn&&r!==void 0&&(r===dc?(e+=this.consumeStringSlice(i),i=-1,this._value.shift()):Ti(A,r)&&(e+=this.consumeStringSlice(i),e+=We(this.consumeEscapedCodePoint()),i=-1))}i++}while(!0)},s.prototype.consumeNumber=function(){var t=[],e=Ca,i=this.peekCodePoint(0);for((i===lA||i===Rs)&&t.push(this.consumeCodePoint());ys(this.peekCodePoint(0));)t.push(this.consumeCodePoint());i=this.peekCodePoint(0);var A=this.peekCodePoint(1);if(i===ua&&ys(A))for(t.push(this.consumeCodePoint(),this.consumeCodePoint()),e=Tg;ys(this.peekCodePoint(0));)t.push(this.consumeCodePoint());i=this.peekCodePoint(0),A=this.peekCodePoint(1);var r=this.peekCodePoint(2);if((i===sB||i===tB)&&((A===lA||A===Rs)&&ys(r)||ys(A)))for(t.push(this.consumeCodePoint(),this.consumeCodePoint()),e=Tg;ys(this.peekCodePoint(0));)t.push(this.consumeCodePoint());return[c1(t),e]},s.prototype.consumeNumericToken=function(){var t=this.consumeNumber(),e=t[0],i=t[1],A=this.peekCodePoint(0),r=this.peekCodePoint(1),a=this.peekCodePoint(2);if(wl(A,r,a)){var l=this.consumeName();return{type:15,number:e,flags:i,unit:l}}return A===QS?(this.consumeCodePoint(),{type:16,number:e,flags:i}):{type:17,number:e,flags:i}},s.prototype.consumeEscapedCodePoint=function(){var t=this.consumeCodePoint();if(jA(t)){for(var e=We(t);jA(this.peekCodePoint(0))&&e.length<6;)e+=We(this.consumeCodePoint());gl(this.peekCodePoint(0))&&this.consumeCodePoint();var i=parseInt(e,16);return i===0||i1(i)||i>1114111?Mg:i}return t===Hn?Mg:t},s.prototype.consumeName=function(){for(var t="";;){var e=this.consumeCodePoint();if(Ug(e))t+=We(e);else if(Ti(e,this.peekCodePoint(0)))t+=We(this.consumeEscapedCodePoint());else return this.reconsumeCodePoint(e),t}},s})(),AB=(function(){function s(t){this._tokens=t}return s.create=function(t){var e=new iB;return e.write(t),new s(e.read())},s.parseValue=function(t){return s.create(t).parseComponentValue()},s.parseValues=function(t){return s.create(t).parseComponentValues()},s.prototype.parseComponentValue=function(){for(var t=this.consumeToken();t.type===31;)t=this.consumeToken();if(t.type===32)throw new SyntaxError("Error parsing CSS component value, unexpected EOF");this.reconsumeToken(t);var e=this.consumeComponentValue();do t=this.consumeToken();while(t.type===31);if(t.type===32)return e;throw new SyntaxError("Error parsing CSS component value, multiple values found when expecting only one")},s.prototype.parseComponentValues=function(){for(var t=[];;){var e=this.consumeComponentValue();if(e.type===32)return t;t.push(e),t.push()}},s.prototype.consumeComponentValue=function(){var t=this.consumeToken();switch(t.type){case 11:case 28:case 2:return this.consumeSimpleBlock(t.type);case 19:return this.consumeFunction(t)}return t},s.prototype.consumeSimpleBlock=function(t){for(var e={type:t,values:[]},i=this.consumeToken();;){if(i.type===32||Q1(i,t))return e;this.reconsumeToken(i),e.values.push(this.consumeComponentValue()),i=this.consumeToken()}},s.prototype.consumeFunction=function(t){for(var e={name:t.value,values:[],type:18};;){var i=this.consumeToken();if(i.type===32||i.type===3)return e;this.reconsumeToken(i),e.values.push(this.consumeComponentValue())}},s.prototype.consumeToken=function(){var t=this._tokens.shift();return typeof t>"u"?ef:t},s.prototype.reconsumeToken=function(t){this._tokens.unshift(t)},s})(),ba=function(s){return s.type===15},Sr=function(s){return s.type===17},he=function(s){return s.type===20},I1=function(s){return s.type===0},sf=function(s,t){return he(s)&&s.value===t},rB=function(s){return s.type!==31},_r=function(s){return s.type!==31&&s.type!==4},zn=function(s){var t=[],e=[];return s.forEach(function(i){if(i.type===4){if(e.length===0)throw new Error("Error parsing function args, zero tokens for arg");t.push(e),e=[];return}i.type!==31&&e.push(i)}),e.length&&t.push(e),t},Q1=function(s,t){return t===11&&s.type===12||t===28&&s.type===29?!0:t===2&&s.type===3},Gi=function(s){return s.type===17||s.type===15},ze=function(s){return s.type===16||Gi(s)},oB=function(s){return s.length>1?[s[0],s[1]]:[s[0]]},ws={type:17,number:0,flags:Ca},Zf={type:16,number:50,flags:Ca},Li={type:16,number:100,flags:Ca},Qo=function(s,t,e){var i=s[0],A=s[1];return[ve(i,t),ve(typeof A<"u"?A:i,e)]},ve=function(s,t){if(s.type===16)return s.number/100*t;if(ba(s))switch(s.unit){case"rem":case"em":return 16*s.number;case"px":default:return s.number}return s.number},aB="deg",lB="grad",cB="rad",uB="turn",Vc={name:"angle",parse:function(s,t){if(t.type===15)switch(t.unit){case aB:return Math.PI*t.number/180;case lB:return Math.PI/200*t.number;case cB:return t.number;case uB:return Math.PI*2*t.number}throw new Error("Unsupported angle type")}},hB=function(s){return s.type===15&&(s.unit===aB||s.unit===lB||s.unit===cB||s.unit===uB)},dB=function(s){var t=s.filter(he).map(function(e){return e.value}).join(" ");switch(t){case"to bottom right":case"to right bottom":case"left top":case"top left":return[ws,ws];case"to top":case"bottom":return ln(0);case"to bottom left":case"to left bottom":case"right top":case"top right":return[ws,Li];case"to right":case"left":return ln(90);case"to top left":case"to left top":case"right bottom":case"bottom right":return[Li,Li];case"to bottom":case"top":return ln(180);case"to top right":case"to right top":case"left bottom":case"bottom left":return[Li,ws];case"to left":case"right":return ln(270)}return 0},ln=function(s){return Math.PI*s/180},Oi={name:"color",parse:function(s,t){if(t.type===18){var e=M1[t.name];if(typeof e>"u")throw new Error('Attempting to parse an unsupported color function "'+t.name+'"');return e(s,t.values)}if(t.type===5){if(t.value.length===3){var i=t.value.substring(0,1),A=t.value.substring(1,2),r=t.value.substring(2,3);return Ri(parseInt(i+i,16),parseInt(A+A,16),parseInt(r+r,16),1)}if(t.value.length===4){var i=t.value.substring(0,1),A=t.value.substring(1,2),r=t.value.substring(2,3),a=t.value.substring(3,4);return Ri(parseInt(i+i,16),parseInt(A+A,16),parseInt(r+r,16),parseInt(a+a,16)/255)}if(t.value.length===6){var i=t.value.substring(0,2),A=t.value.substring(2,4),r=t.value.substring(4,6);return Ri(parseInt(i,16),parseInt(A,16),parseInt(r,16),1)}if(t.value.length===8){var i=t.value.substring(0,2),A=t.value.substring(2,4),r=t.value.substring(4,6),a=t.value.substring(6,8);return Ri(parseInt(i,16),parseInt(A,16),parseInt(r,16),parseInt(a,16)/255)}}if(t.type===20){var l=ci[t.value.toUpperCase()];if(typeof l<"u")return l}return ci.TRANSPARENT}},Vi=function(s){return(255&s)===0},ns=function(s){var t=255&s,e=255&s>>8,i=255&s>>16,A=255&s>>24;return t<255?"rgba("+A+","+i+","+e+","+t/255+")":"rgb("+A+","+i+","+e+")"},Ri=function(s,t,e,i){return(s<<24|t<<16|e<<8|Math.round(i*255)<<0)>>>0},Pg=function(s,t){if(s.type===17)return s.number;if(s.type===16){var e=t===3?1:255;return t===3?s.number/100*e:Math.round(s.number/100*e)}return 0},Dg=function(s,t){var e=t.filter(_r);if(e.length===3){var i=e.map(Pg),A=i[0],r=i[1],a=i[2];return Ri(A,r,a,1)}if(e.length===4){var l=e.map(Pg),A=l[0],r=l[1],a=l[2],u=l[3];return Ri(A,r,a,u)}return 0};function Xh(s,t,e){return e<0&&(e+=1),e>=1&&(e-=1),e<1/6?(t-s)*e*6+s:e<1/2?t:e<2/3?(t-s)*6*(2/3-e)+s:s}var kg=function(s,t){var e=t.filter(_r),i=e[0],A=e[1],r=e[2],a=e[3],l=(i.type===17?ln(i.number):Vc.parse(s,i))/(Math.PI*2),u=ze(A)?A.number/100:0,h=ze(r)?r.number/100:0,m=typeof a<"u"&&ze(a)?ve(a,1):1;if(u===0)return Ri(h*255,h*255,h*255,1);var g=h<=.5?h*(u+1):h+u-h*u,w=h*2-g,C=Xh(w,g,l+1/3),y=Xh(w,g,l),E=Xh(w,g,l-1/3);return Ri(C*255,y*255,E*255,m)},M1={hsl:kg,hsla:kg,rgb:Dg,rgba:Dg},Ko=function(s,t){return Oi.parse(s,AB.create(t).parseComponentValue())},ci={ALICEBLUE:4042850303,ANTIQUEWHITE:4209760255,AQUA:16777215,AQUAMARINE:2147472639,AZURE:4043309055,BEIGE:4126530815,BISQUE:4293182719,BLACK:255,BLANCHEDALMOND:4293643775,BLUE:65535,BLUEVIOLET:2318131967,BROWN:2771004159,BURLYWOOD:3736635391,CADETBLUE:1604231423,CHARTREUSE:2147418367,CHOCOLATE:3530104575,CORAL:4286533887,CORNFLOWERBLUE:1687547391,CORNSILK:4294499583,CRIMSON:3692313855,CYAN:16777215,DARKBLUE:35839,DARKCYAN:9145343,DARKGOLDENROD:3095837695,DARKGRAY:2846468607,DARKGREEN:6553855,DARKGREY:2846468607,DARKKHAKI:3182914559,DARKMAGENTA:2332068863,DARKOLIVEGREEN:1433087999,DARKORANGE:4287365375,DARKORCHID:2570243327,DARKRED:2332033279,DARKSALMON:3918953215,DARKSEAGREEN:2411499519,DARKSLATEBLUE:1211993087,DARKSLATEGRAY:793726975,DARKSLATEGREY:793726975,DARKTURQUOISE:13554175,DARKVIOLET:2483082239,DEEPPINK:4279538687,DEEPSKYBLUE:12582911,DIMGRAY:1768516095,DIMGREY:1768516095,DODGERBLUE:512819199,FIREBRICK:2988581631,FLORALWHITE:4294635775,FORESTGREEN:579543807,FUCHSIA:4278255615,GAINSBORO:3705462015,GHOSTWHITE:4177068031,GOLD:4292280575,GOLDENROD:3668254975,GRAY:2155905279,GREEN:8388863,GREENYELLOW:2919182335,GREY:2155905279,HONEYDEW:4043305215,HOTPINK:4285117695,INDIANRED:3445382399,INDIGO:1258324735,IVORY:4294963455,KHAKI:4041641215,LAVENDER:3873897215,LAVENDERBLUSH:4293981695,LAWNGREEN:2096890111,LEMONCHIFFON:4294626815,LIGHTBLUE:2916673279,LIGHTCORAL:4034953471,LIGHTCYAN:3774873599,LIGHTGOLDENRODYELLOW:4210742015,LIGHTGRAY:3553874943,LIGHTGREEN:2431553791,LIGHTGREY:3553874943,LIGHTPINK:4290167295,LIGHTSALMON:4288707327,LIGHTSEAGREEN:548580095,LIGHTSKYBLUE:2278488831,LIGHTSLATEGRAY:2005441023,LIGHTSLATEGREY:2005441023,LIGHTSTEELBLUE:2965692159,LIGHTYELLOW:4294959359,LIME:16711935,LIMEGREEN:852308735,LINEN:4210091775,MAGENTA:4278255615,MAROON:2147483903,MEDIUMAQUAMARINE:1724754687,MEDIUMBLUE:52735,MEDIUMORCHID:3126187007,MEDIUMPURPLE:2473647103,MEDIUMSEAGREEN:1018393087,MEDIUMSLATEBLUE:2070474495,MEDIUMSPRINGGREEN:16423679,MEDIUMTURQUOISE:1221709055,MEDIUMVIOLETRED:3340076543,MIDNIGHTBLUE:421097727,MINTCREAM:4127193855,MISTYROSE:4293190143,MOCCASIN:4293178879,NAVAJOWHITE:4292783615,NAVY:33023,OLDLACE:4260751103,OLIVE:2155872511,OLIVEDRAB:1804477439,ORANGE:4289003775,ORANGERED:4282712319,ORCHID:3664828159,PALEGOLDENROD:4008225535,PALEGREEN:2566625535,PALETURQUOISE:2951671551,PALEVIOLETRED:3681588223,PAPAYAWHIP:4293907967,PEACHPUFF:4292524543,PERU:3448061951,PINK:4290825215,PLUM:3718307327,POWDERBLUE:2967529215,PURPLE:2147516671,REBECCAPURPLE:1714657791,RED:4278190335,ROSYBROWN:3163525119,ROYALBLUE:1097458175,SADDLEBROWN:2336560127,SALMON:4202722047,SANDYBROWN:4104413439,SEAGREEN:780883967,SEASHELL:4294307583,SIENNA:2689740287,SILVER:3233857791,SKYBLUE:2278484991,SLATEBLUE:1784335871,SLATEGRAY:1887473919,SLATEGREY:1887473919,SNOW:4294638335,SPRINGGREEN:16744447,STEELBLUE:1182971135,TAN:3535047935,TEAL:8421631,THISTLE:3636451583,TOMATO:4284696575,TRANSPARENT:0,TURQUOISE:1088475391,VIOLET:4001558271,WHEAT:4125012991,WHITE:4294967295,WHITESMOKE:4126537215,YELLOW:4294902015,YELLOWGREEN:2597139199},U1={name:"background-clip",initialValue:"border-box",prefix:!1,type:1,parse:function(s,t){return t.map(function(e){if(he(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},P1={name:"background-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},Wc=function(s,t){var e=Oi.parse(s,t[0]),i=t[1];return i&&ze(i)?{color:e,stop:i}:{color:e,stop:null}},Lg=function(s,t){var e=s[0],i=s[s.length-1];e.stop===null&&(e.stop=ws),i.stop===null&&(i.stop=Li);for(var A=[],r=0,a=0;a<s.length;a++){var l=s[a].stop;if(l!==null){var u=ve(l,t);u>r?A.push(u):A.push(r),r=u}else A.push(null)}for(var h=null,a=0;a<A.length;a++){var m=A[a];if(m===null)h===null&&(h=a);else if(h!==null){for(var g=a-h,w=A[h-1],C=(m-w)/(g+1),y=1;y<=g;y++)A[h+y-1]=C*y;h=null}}return s.map(function(E,x){var T=E.color;return{color:T,stop:Math.max(Math.min(1,A[x]/t),0)}})},D1=function(s,t,e){var i=t/2,A=e/2,r=ve(s[0],t)-i,a=A-ve(s[1],e);return(Math.atan2(a,r)+Math.PI*2)%(Math.PI*2)},k1=function(s,t,e){var i=typeof s=="number"?s:D1(s,t,e),A=Math.abs(t*Math.sin(i))+Math.abs(e*Math.cos(i)),r=t/2,a=e/2,l=A/2,u=Math.sin(i-Math.PI/2)*l,h=Math.cos(i-Math.PI/2)*l;return[A,r-h,r+h,a-u,a+u]},bn=function(s,t){return Math.sqrt(s*s+t*t)},Rg=function(s,t,e,i,A){var r=[[0,0],[0,t],[s,0],[s,t]];return r.reduce(function(a,l){var u=l[0],h=l[1],m=bn(e-u,i-h);return(A?m<a.optimumDistance:m>a.optimumDistance)?{optimumCorner:l,optimumDistance:m}:a},{optimumDistance:A?1/0:-1/0,optimumCorner:null}).optimumCorner},L1=function(s,t,e,i,A){var r=0,a=0;switch(s.size){case 0:s.shape===0?r=a=Math.min(Math.abs(t),Math.abs(t-i),Math.abs(e),Math.abs(e-A)):s.shape===1&&(r=Math.min(Math.abs(t),Math.abs(t-i)),a=Math.min(Math.abs(e),Math.abs(e-A)));break;case 2:if(s.shape===0)r=a=Math.min(bn(t,e),bn(t,e-A),bn(t-i,e),bn(t-i,e-A));else if(s.shape===1){var l=Math.min(Math.abs(e),Math.abs(e-A))/Math.min(Math.abs(t),Math.abs(t-i)),u=Rg(i,A,t,e,!0),h=u[0],m=u[1];r=bn(h-t,(m-e)/l),a=l*r}break;case 1:s.shape===0?r=a=Math.max(Math.abs(t),Math.abs(t-i),Math.abs(e),Math.abs(e-A)):s.shape===1&&(r=Math.max(Math.abs(t),Math.abs(t-i)),a=Math.max(Math.abs(e),Math.abs(e-A)));break;case 3:if(s.shape===0)r=a=Math.max(bn(t,e),bn(t,e-A),bn(t-i,e),bn(t-i,e-A));else if(s.shape===1){var l=Math.max(Math.abs(e),Math.abs(e-A))/Math.max(Math.abs(t),Math.abs(t-i)),g=Rg(i,A,t,e,!1),h=g[0],m=g[1];r=bn(h-t,(m-e)/l),a=l*r}break}return Array.isArray(s.size)&&(r=ve(s.size[0],i),a=s.size.length===2?ve(s.size[1],A):r),[r,a]},R1=function(s,t){var e=ln(180),i=[];return zn(t).forEach(function(A,r){if(r===0){var a=A[0];if(a.type===20&&a.value==="to"){e=dB(A);return}else if(hB(a)){e=Vc.parse(s,a);return}}var l=Wc(s,A);i.push(l)}),{angle:e,stops:i,type:1}},Bl=function(s,t){var e=ln(180),i=[];return zn(t).forEach(function(A,r){if(r===0){var a=A[0];if(a.type===20&&["top","left","right","bottom"].indexOf(a.value)!==-1){e=dB(A);return}else if(hB(a)){e=(Vc.parse(s,a)+ln(270))%ln(360);return}}var l=Wc(s,A);i.push(l)}),{angle:e,stops:i,type:1}},H1=function(s,t){var e=ln(180),i=[],A=1,r=0,a=3,l=[];return zn(t).forEach(function(u,h){var m=u[0];if(h===0){if(he(m)&&m.value==="linear"){A=1;return}else if(he(m)&&m.value==="radial"){A=2;return}}if(m.type===18){if(m.name==="from"){var g=Oi.parse(s,m.values[0]);i.push({stop:ws,color:g})}else if(m.name==="to"){var g=Oi.parse(s,m.values[0]);i.push({stop:Li,color:g})}else if(m.name==="color-stop"){var w=m.values.filter(_r);if(w.length===2){var g=Oi.parse(s,w[1]),C=w[0];Sr(C)&&i.push({stop:{type:16,number:C.number*100,flags:C.flags},color:g})}}}}),A===1?{angle:(e+ln(180))%ln(360),stops:i,type:A}:{size:a,shape:r,stops:i,position:l,type:A}},fB="closest-side",pB="farthest-side",mB="closest-corner",gB="farthest-corner",wB="circle",vB="ellipse",BB="cover",yB="contain",N1=function(s,t){var e=0,i=3,A=[],r=[];return zn(t).forEach(function(a,l){var u=!0;if(l===0){var h=!1;u=a.reduce(function(g,w){if(h)if(he(w))switch(w.value){case"center":return r.push(Zf),g;case"top":case"left":return r.push(ws),g;case"right":case"bottom":return r.push(Li),g}else(ze(w)||Gi(w))&&r.push(w);else if(he(w))switch(w.value){case wB:return e=0,!1;case vB:return e=1,!1;case"at":return h=!0,!1;case fB:return i=0,!1;case BB:case pB:return i=1,!1;case yB:case mB:return i=2,!1;case gB:return i=3,!1}else if(Gi(w)||ze(w))return Array.isArray(i)||(i=[]),i.push(w),!1;return g},u)}if(u){var m=Wc(s,a);A.push(m)}}),{size:i,shape:e,stops:A,position:r,type:2}},yl=function(s,t){var e=0,i=3,A=[],r=[];return zn(t).forEach(function(a,l){var u=!0;if(l===0?u=a.reduce(function(m,g){if(he(g))switch(g.value){case"center":return r.push(Zf),!1;case"top":case"left":return r.push(ws),!1;case"right":case"bottom":return r.push(Li),!1}else if(ze(g)||Gi(g))return r.push(g),!1;return m},u):l===1&&(u=a.reduce(function(m,g){if(he(g))switch(g.value){case wB:return e=0,!1;case vB:return e=1,!1;case yB:case fB:return i=0,!1;case pB:return i=1,!1;case mB:return i=2,!1;case BB:case gB:return i=3,!1}else if(Gi(g)||ze(g))return Array.isArray(i)||(i=[]),i.push(g),!1;return m},u)),u){var h=Wc(s,a);A.push(h)}}),{size:i,shape:e,stops:A,position:r,type:2}},O1=function(s){return s.type===1},V1=function(s){return s.type===2},tp={name:"image",parse:function(s,t){if(t.type===22){var e={url:t.value,type:0};return s.cache.addImage(t.value),e}if(t.type===18){var i=CB[t.name];if(typeof i>"u")throw new Error('Attempting to parse an unsupported image function "'+t.name+'"');return i(s,t.values)}throw new Error("Unsupported image type "+t.type)}};function W1(s){return!(s.type===20&&s.value==="none")&&(s.type!==18||!!CB[s.name])}var CB={"linear-gradient":R1,"-moz-linear-gradient":Bl,"-ms-linear-gradient":Bl,"-o-linear-gradient":Bl,"-webkit-linear-gradient":Bl,"radial-gradient":N1,"-moz-radial-gradient":yl,"-ms-radial-gradient":yl,"-o-radial-gradient":yl,"-webkit-radial-gradient":yl,"-webkit-gradient":H1},K1={name:"background-image",initialValue:"none",type:1,prefix:!1,parse:function(s,t){if(t.length===0)return[];var e=t[0];return e.type===20&&e.value==="none"?[]:t.filter(function(i){return _r(i)&&W1(i)}).map(function(i){return tp.parse(s,i)})}},G1={name:"background-origin",initialValue:"border-box",prefix:!1,type:1,parse:function(s,t){return t.map(function(e){if(he(e))switch(e.value){case"padding-box":return 1;case"content-box":return 2}return 0})}},q1={name:"background-position",initialValue:"0% 0%",type:1,prefix:!1,parse:function(s,t){return zn(t).map(function(e){return e.filter(ze)}).map(oB)}},z1={name:"background-repeat",initialValue:"repeat",prefix:!1,type:1,parse:function(s,t){return zn(t).map(function(e){return e.filter(he).map(function(i){return i.value}).join(" ")}).map($1)}},$1=function(s){switch(s){case"no-repeat":return 1;case"repeat-x":case"repeat no-repeat":return 2;case"repeat-y":case"no-repeat repeat":return 3;case"repeat":default:return 0}},vr;(function(s){s.AUTO="auto",s.CONTAIN="contain",s.COVER="cover"})(vr||(vr={}));var X1={name:"background-size",initialValue:"0",prefix:!1,type:1,parse:function(s,t){return zn(t).map(function(e){return e.filter(Y1)})}},Y1=function(s){return he(s)||ze(s)},Kc=function(s){return{name:"border-"+s+"-color",initialValue:"transparent",prefix:!1,type:3,format:"color"}},j1=Kc("top"),J1=Kc("right"),Z1=Kc("bottom"),tF=Kc("left"),Gc=function(s){return{name:"border-radius-"+s,initialValue:"0 0",prefix:!1,type:1,parse:function(t,e){return oB(e.filter(ze))}}},eF=Gc("top-left"),sF=Gc("top-right"),nF=Gc("bottom-right"),iF=Gc("bottom-left"),qc=function(s){return{name:"border-"+s+"-style",initialValue:"solid",prefix:!1,type:2,parse:function(t,e){switch(e){case"none":return 0;case"dashed":return 2;case"dotted":return 3;case"double":return 4}return 1}}},AF=qc("top"),rF=qc("right"),oF=qc("bottom"),aF=qc("left"),zc=function(s){return{name:"border-"+s+"-width",initialValue:"0",type:0,prefix:!1,parse:function(t,e){return ba(e)?e.number:0}}},lF=zc("top"),cF=zc("right"),uF=zc("bottom"),hF=zc("left"),dF={name:"color",initialValue:"transparent",prefix:!1,type:3,format:"color"},fF={name:"direction",initialValue:"ltr",prefix:!1,type:2,parse:function(s,t){switch(t){case"rtl":return 1;case"ltr":default:return 0}}},pF={name:"display",initialValue:"inline-block",prefix:!1,type:1,parse:function(s,t){return t.filter(he).reduce(function(e,i){return e|mF(i.value)},0)}},mF=function(s){switch(s){case"block":case"-webkit-box":return 2;case"inline":return 4;case"run-in":return 8;case"flow":return 16;case"flow-root":return 32;case"table":return 64;case"flex":case"-webkit-flex":return 128;case"grid":case"-ms-grid":return 256;case"ruby":return 512;case"subgrid":return 1024;case"list-item":return 2048;case"table-row-group":return 4096;case"table-header-group":return 8192;case"table-footer-group":return 16384;case"table-row":return 32768;case"table-cell":return 65536;case"table-column-group":return 131072;case"table-column":return 262144;case"table-caption":return 524288;case"ruby-base":return 1048576;case"ruby-text":return 2097152;case"ruby-base-container":return 4194304;case"ruby-text-container":return 8388608;case"contents":return 16777216;case"inline-block":return 33554432;case"inline-list-item":return 67108864;case"inline-table":return 134217728;case"inline-flex":return 268435456;case"inline-grid":return 536870912}return 0},gF={name:"float",initialValue:"none",prefix:!1,type:2,parse:function(s,t){switch(t){case"left":return 1;case"right":return 2;case"inline-start":return 3;case"inline-end":return 4}return 0}},wF={name:"letter-spacing",initialValue:"0",prefix:!1,type:0,parse:function(s,t){return t.type===20&&t.value==="normal"?0:t.type===17||t.type===15?t.number:0}},pc;(function(s){s.NORMAL="normal",s.STRICT="strict"})(pc||(pc={}));var vF={name:"line-break",initialValue:"normal",prefix:!1,type:2,parse:function(s,t){switch(t){case"strict":return pc.STRICT;case"normal":default:return pc.NORMAL}}},BF={name:"line-height",initialValue:"normal",prefix:!1,type:4},Hg=function(s,t){return he(s)&&s.value==="normal"?1.2*t:s.type===17?t*s.number:ze(s)?ve(s,t):t},yF={name:"list-style-image",initialValue:"none",type:0,prefix:!1,parse:function(s,t){return t.type===20&&t.value==="none"?null:tp.parse(s,t)}},CF={name:"list-style-position",initialValue:"outside",prefix:!1,type:2,parse:function(s,t){switch(t){case"inside":return 0;case"outside":default:return 1}}},nf={name:"list-style-type",initialValue:"none",prefix:!1,type:2,parse:function(s,t){switch(t){case"disc":return 0;case"circle":return 1;case"square":return 2;case"decimal":return 3;case"cjk-decimal":return 4;case"decimal-leading-zero":return 5;case"lower-roman":return 6;case"upper-roman":return 7;case"lower-greek":return 8;case"lower-alpha":return 9;case"upper-alpha":return 10;case"arabic-indic":return 11;case"armenian":return 12;case"bengali":return 13;case"cambodian":return 14;case"cjk-earthly-branch":return 15;case"cjk-heavenly-stem":return 16;case"cjk-ideographic":return 17;case"devanagari":return 18;case"ethiopic-numeric":return 19;case"georgian":return 20;case"gujarati":return 21;case"gurmukhi":return 22;case"hebrew":return 22;case"hiragana":return 23;case"hiragana-iroha":return 24;case"japanese-formal":return 25;case"japanese-informal":return 26;case"kannada":return 27;case"katakana":return 28;case"katakana-iroha":return 29;case"khmer":return 30;case"korean-hangul-formal":return 31;case"korean-hanja-formal":return 32;case"korean-hanja-informal":return 33;case"lao":return 34;case"lower-armenian":return 35;case"malayalam":return 36;case"mongolian":return 37;case"myanmar":return 38;case"oriya":return 39;case"persian":return 40;case"simp-chinese-formal":return 41;case"simp-chinese-informal":return 42;case"tamil":return 43;case"telugu":return 44;case"thai":return 45;case"tibetan":return 46;case"trad-chinese-formal":return 47;case"trad-chinese-informal":return 48;case"upper-armenian":return 49;case"disclosure-open":return 50;case"disclosure-closed":return 51;case"none":default:return-1}}},$c=function(s){return{name:"margin-"+s,initialValue:"0",prefix:!1,type:4}},bF=$c("top"),_F=$c("right"),xF=$c("bottom"),EF=$c("left"),SF={name:"overflow",initialValue:"visible",prefix:!1,type:1,parse:function(s,t){return t.filter(he).map(function(e){switch(e.value){case"hidden":return 1;case"scroll":return 2;case"clip":return 3;case"auto":return 4;case"visible":default:return 0}})}},FF={name:"overflow-wrap",initialValue:"normal",prefix:!1,type:2,parse:function(s,t){switch(t){case"break-word":return"break-word";case"normal":default:return"normal"}}},Xc=function(s){return{name:"padding-"+s,initialValue:"0",prefix:!1,type:3,format:"length-percentage"}},TF=Xc("top"),IF=Xc("right"),QF=Xc("bottom"),MF=Xc("left"),UF={name:"text-align",initialValue:"left",prefix:!1,type:2,parse:function(s,t){switch(t){case"right":return 2;case"center":case"justify":return 1;case"left":default:return 0}}},PF={name:"position",initialValue:"static",prefix:!1,type:2,parse:function(s,t){switch(t){case"relative":return 1;case"absolute":return 2;case"fixed":return 3;case"sticky":return 4}return 0}},DF={name:"text-shadow",initialValue:"none",type:1,prefix:!1,parse:function(s,t){return t.length===1&&sf(t[0],"none")?[]:zn(t).map(function(e){for(var i={color:ci.TRANSPARENT,offsetX:ws,offsetY:ws,blur:ws},A=0,r=0;r<e.length;r++){var a=e[r];Gi(a)?(A===0?i.offsetX=a:A===1?i.offsetY=a:i.blur=a,A++):i.color=Oi.parse(s,a)}return i})}},kF={name:"text-transform",initialValue:"none",prefix:!1,type:2,parse:function(s,t){switch(t){case"uppercase":return 2;case"lowercase":return 1;case"capitalize":return 3}return 0}},LF={name:"transform",initialValue:"none",prefix:!0,type:0,parse:function(s,t){if(t.type===20&&t.value==="none")return null;if(t.type===18){var e=NF[t.name];if(typeof e>"u")throw new Error('Attempting to parse an unsupported transform function "'+t.name+'"');return e(t.values)}return null}},RF=function(s){var t=s.filter(function(e){return e.type===17}).map(function(e){return e.number});return t.length===6?t:null},HF=function(s){var t=s.filter(function(u){return u.type===17}).map(function(u){return u.number}),e=t[0],i=t[1];t[2],t[3];var A=t[4],r=t[5];t[6],t[7],t[8],t[9],t[10],t[11];var a=t[12],l=t[13];return t[14],t[15],t.length===16?[e,i,A,r,a,l]:null},NF={matrix:RF,matrix3d:HF},Ng={type:16,number:50,flags:Ca},OF=[Ng,Ng],VF={name:"transform-origin",initialValue:"50% 50%",prefix:!0,type:1,parse:function(s,t){var e=t.filter(ze);return e.length!==2?OF:[e[0],e[1]]}},WF={name:"visible",initialValue:"none",prefix:!1,type:2,parse:function(s,t){switch(t){case"hidden":return 1;case"collapse":return 2;case"visible":default:return 0}}},Go;(function(s){s.NORMAL="normal",s.BREAK_ALL="break-all",s.KEEP_ALL="keep-all"})(Go||(Go={}));var KF={name:"word-break",initialValue:"normal",prefix:!1,type:2,parse:function(s,t){switch(t){case"break-all":return Go.BREAK_ALL;case"keep-all":return Go.KEEP_ALL;case"normal":default:return Go.NORMAL}}},GF={name:"z-index",initialValue:"auto",prefix:!1,type:0,parse:function(s,t){if(t.type===20)return{auto:!0,order:0};if(Sr(t))return{auto:!1,order:t.number};throw new Error("Invalid z-index number parsed")}},bB={name:"time",parse:function(s,t){if(t.type===15)switch(t.unit.toLowerCase()){case"s":return 1e3*t.number;case"ms":return t.number}throw new Error("Unsupported time type")}},qF={name:"opacity",initialValue:"1",type:0,prefix:!1,parse:function(s,t){return Sr(t)?t.number:1}},zF={name:"text-decoration-color",initialValue:"transparent",prefix:!1,type:3,format:"color"},$F={name:"text-decoration-line",initialValue:"none",prefix:!1,type:1,parse:function(s,t){return t.filter(he).map(function(e){switch(e.value){case"underline":return 1;case"overline":return 2;case"line-through":return 3;case"none":return 4}return 0}).filter(function(e){return e!==0})}},XF={name:"font-family",initialValue:"",prefix:!1,type:1,parse:function(s,t){var e=[],i=[];return t.forEach(function(A){switch(A.type){case 20:case 0:e.push(A.value);break;case 17:e.push(A.number.toString());break;case 4:i.push(e.join(" ")),e.length=0;break}}),e.length&&i.push(e.join(" ")),i.map(function(A){return A.indexOf(" ")===-1?A:"'"+A+"'"})}},YF={name:"font-size",initialValue:"0",prefix:!1,type:3,format:"length"},jF={name:"font-weight",initialValue:"normal",type:0,prefix:!1,parse:function(s,t){if(Sr(t))return t.number;if(he(t))switch(t.value){case"bold":return 700;case"normal":default:return 400}return 400}},JF={name:"font-variant",initialValue:"none",type:1,prefix:!1,parse:function(s,t){return t.filter(he).map(function(e){return e.value})}},ZF={name:"font-style",initialValue:"normal",prefix:!1,type:2,parse:function(s,t){switch(t){case"oblique":return"oblique";case"italic":return"italic";case"normal":default:return"normal"}}},Je=function(s,t){return(s&t)!==0},tT={name:"content",initialValue:"none",type:1,prefix:!1,parse:function(s,t){if(t.length===0)return[];var e=t[0];return e.type===20&&e.value==="none"?[]:t}},eT={name:"counter-increment",initialValue:"none",prefix:!0,type:1,parse:function(s,t){if(t.length===0)return null;var e=t[0];if(e.type===20&&e.value==="none")return null;for(var i=[],A=t.filter(rB),r=0;r<A.length;r++){var a=A[r],l=A[r+1];if(a.type===20){var u=l&&Sr(l)?l.number:1;i.push({counter:a.value,increment:u})}}return i}},sT={name:"counter-reset",initialValue:"none",prefix:!0,type:1,parse:function(s,t){if(t.length===0)return[];for(var e=[],i=t.filter(rB),A=0;A<i.length;A++){var r=i[A],a=i[A+1];if(he(r)&&r.value!=="none"){var l=a&&Sr(a)?a.number:0;e.push({counter:r.value,reset:l})}}return e}},nT={name:"duration",initialValue:"0s",prefix:!1,type:1,parse:function(s,t){return t.filter(ba).map(function(e){return bB.parse(s,e)})}},iT={name:"quotes",initialValue:"none",prefix:!0,type:1,parse:function(s,t){if(t.length===0)return null;var e=t[0];if(e.type===20&&e.value==="none")return null;var i=[],A=t.filter(I1);if(A.length%2!==0)return null;for(var r=0;r<A.length;r+=2){var a=A[r].value,l=A[r+1].value;i.push({open:a,close:l})}return i}},Og=function(s,t,e){if(!s)return"";var i=s[Math.min(t,s.length-1)];return i?e?i.open:i.close:""},AT={name:"box-shadow",initialValue:"none",type:1,prefix:!1,parse:function(s,t){return t.length===1&&sf(t[0],"none")?[]:zn(t).map(function(e){for(var i={color:255,offsetX:ws,offsetY:ws,blur:ws,spread:ws,inset:!1},A=0,r=0;r<e.length;r++){var a=e[r];sf(a,"inset")?i.inset=!0:Gi(a)?(A===0?i.offsetX=a:A===1?i.offsetY=a:A===2?i.blur=a:i.spread=a,A++):i.color=Oi.parse(s,a)}return i})}},rT={name:"paint-order",initialValue:"normal",prefix:!1,type:1,parse:function(s,t){var e=[0,1,2],i=[];return t.filter(he).forEach(function(A){switch(A.value){case"stroke":i.push(1);break;case"fill":i.push(0);break;case"markers":i.push(2);break}}),e.forEach(function(A){i.indexOf(A)===-1&&i.push(A)}),i}},oT={name:"-webkit-text-stroke-color",initialValue:"currentcolor",prefix:!1,type:3,format:"color"},aT={name:"-webkit-text-stroke-width",initialValue:"0",type:0,prefix:!1,parse:function(s,t){return ba(t)?t.number:0}},lT=(function(){function s(t,e){var i,A;this.animationDuration=xt(t,nT,e.animationDuration),this.backgroundClip=xt(t,U1,e.backgroundClip),this.backgroundColor=xt(t,P1,e.backgroundColor),this.backgroundImage=xt(t,K1,e.backgroundImage),this.backgroundOrigin=xt(t,G1,e.backgroundOrigin),this.backgroundPosition=xt(t,q1,e.backgroundPosition),this.backgroundRepeat=xt(t,z1,e.backgroundRepeat),this.backgroundSize=xt(t,X1,e.backgroundSize),this.borderTopColor=xt(t,j1,e.borderTopColor),this.borderRightColor=xt(t,J1,e.borderRightColor),this.borderBottomColor=xt(t,Z1,e.borderBottomColor),this.borderLeftColor=xt(t,tF,e.borderLeftColor),this.borderTopLeftRadius=xt(t,eF,e.borderTopLeftRadius),this.borderTopRightRadius=xt(t,sF,e.borderTopRightRadius),this.borderBottomRightRadius=xt(t,nF,e.borderBottomRightRadius),this.borderBottomLeftRadius=xt(t,iF,e.borderBottomLeftRadius),this.borderTopStyle=xt(t,AF,e.borderTopStyle),this.borderRightStyle=xt(t,rF,e.borderRightStyle),this.borderBottomStyle=xt(t,oF,e.borderBottomStyle),this.borderLeftStyle=xt(t,aF,e.borderLeftStyle),this.borderTopWidth=xt(t,lF,e.borderTopWidth),this.borderRightWidth=xt(t,cF,e.borderRightWidth),this.borderBottomWidth=xt(t,uF,e.borderBottomWidth),this.borderLeftWidth=xt(t,hF,e.borderLeftWidth),this.boxShadow=xt(t,AT,e.boxShadow),this.color=xt(t,dF,e.color),this.direction=xt(t,fF,e.direction),this.display=xt(t,pF,e.display),this.float=xt(t,gF,e.cssFloat),this.fontFamily=xt(t,XF,e.fontFamily),this.fontSize=xt(t,YF,e.fontSize),this.fontStyle=xt(t,ZF,e.fontStyle),this.fontVariant=xt(t,JF,e.fontVariant),this.fontWeight=xt(t,jF,e.fontWeight),this.letterSpacing=xt(t,wF,e.letterSpacing),this.lineBreak=xt(t,vF,e.lineBreak),this.lineHeight=xt(t,BF,e.lineHeight),this.listStyleImage=xt(t,yF,e.listStyleImage),this.listStylePosition=xt(t,CF,e.listStylePosition),this.listStyleType=xt(t,nf,e.listStyleType),this.marginTop=xt(t,bF,e.marginTop),this.marginRight=xt(t,_F,e.marginRight),this.marginBottom=xt(t,xF,e.marginBottom),this.marginLeft=xt(t,EF,e.marginLeft),this.opacity=xt(t,qF,e.opacity);var r=xt(t,SF,e.overflow);this.overflowX=r[0],this.overflowY=r[r.length>1?1:0],this.overflowWrap=xt(t,FF,e.overflowWrap),this.paddingTop=xt(t,TF,e.paddingTop),this.paddingRight=xt(t,IF,e.paddingRight),this.paddingBottom=xt(t,QF,e.paddingBottom),this.paddingLeft=xt(t,MF,e.paddingLeft),this.paintOrder=xt(t,rT,e.paintOrder),this.position=xt(t,PF,e.position),this.textAlign=xt(t,UF,e.textAlign),this.textDecorationColor=xt(t,zF,(i=e.textDecorationColor)!==null&&i!==void 0?i:e.color),this.textDecorationLine=xt(t,$F,(A=e.textDecorationLine)!==null&&A!==void 0?A:e.textDecoration),this.textShadow=xt(t,DF,e.textShadow),this.textTransform=xt(t,kF,e.textTransform),this.transform=xt(t,LF,e.transform),this.transformOrigin=xt(t,VF,e.transformOrigin),this.visibility=xt(t,WF,e.visibility),this.webkitTextStrokeColor=xt(t,oT,e.webkitTextStrokeColor),this.webkitTextStrokeWidth=xt(t,aT,e.webkitTextStrokeWidth),this.wordBreak=xt(t,KF,e.wordBreak),this.zIndex=xt(t,GF,e.zIndex)}return s.prototype.isVisible=function(){return this.display>0&&this.opacity>0&&this.visibility===0},s.prototype.isTransparent=function(){return Vi(this.backgroundColor)},s.prototype.isTransformed=function(){return this.transform!==null},s.prototype.isPositioned=function(){return this.position!==0},s.prototype.isPositionedWithZIndex=function(){return this.isPositioned()&&!this.zIndex.auto},s.prototype.isFloating=function(){return this.float!==0},s.prototype.isInlineLevel=function(){return Je(this.display,4)||Je(this.display,33554432)||Je(this.display,268435456)||Je(this.display,536870912)||Je(this.display,67108864)||Je(this.display,134217728)},s})(),cT=(function(){function s(t,e){this.content=xt(t,tT,e.content),this.quotes=xt(t,iT,e.quotes)}return s})(),Vg=(function(){function s(t,e){this.counterIncrement=xt(t,eT,e.counterIncrement),this.counterReset=xt(t,sT,e.counterReset)}return s})(),xt=function(s,t,e){var i=new iB,A=e!==null&&typeof e<"u"?e.toString():t.initialValue;i.write(A);var r=new AB(i.read());switch(t.type){case 2:var a=r.parseComponentValue();return t.parse(s,he(a)?a.value:t.initialValue);case 0:return t.parse(s,r.parseComponentValue());case 1:return t.parse(s,r.parseComponentValues());case 4:return r.parseComponentValue();case 3:switch(t.format){case"angle":return Vc.parse(s,r.parseComponentValue());case"color":return Oi.parse(s,r.parseComponentValue());case"image":return tp.parse(s,r.parseComponentValue());case"length":var l=r.parseComponentValue();return Gi(l)?l:ws;case"length-percentage":var u=r.parseComponentValue();return ze(u)?u:ws;case"time":return bB.parse(s,r.parseComponentValue())}break}},uT="data-html2canvas-debug",hT=function(s){var t=s.getAttribute(uT);switch(t){case"all":return 1;case"clone":return 2;case"parse":return 3;case"render":return 4;default:return 0}},Af=function(s,t){var e=hT(s);return e===1||t===e},$n=(function(){function s(t,e){if(this.context=t,this.textNodes=[],this.elements=[],this.flags=0,Af(e,3))debugger;this.styles=new lT(t,window.getComputedStyle(e,null)),af(e)&&(this.styles.animationDuration.some(function(i){return i>0})&&(e.style.animationDuration="0s"),this.styles.transform!==null&&(e.style.transform="none")),this.bounds=Nc(this.context,e),Af(e,4)&&(this.flags|=16)}return s})(),dT="AAAAAAAAAAAAEA4AGBkAAFAaAAACAAAAAAAIABAAGAAwADgACAAQAAgAEAAIABAACAAQAAgAEAAIABAACAAQAAgAEAAIABAAQABIAEQATAAIABAACAAQAAgAEAAIABAAVABcAAgAEAAIABAACAAQAGAAaABwAHgAgACIAI4AlgAIABAAmwCjAKgAsAC2AL4AvQDFAMoA0gBPAVYBWgEIAAgACACMANoAYgFkAWwBdAF8AX0BhQGNAZUBlgGeAaMBlQGWAasBswF8AbsBwwF0AcsBYwHTAQgA2wG/AOMBdAF8AekB8QF0AfkB+wHiAHQBfAEIAAMC5gQIAAsCEgIIAAgAFgIeAggAIgIpAggAMQI5AkACygEIAAgASAJQAlgCYAIIAAgACAAKBQoFCgUTBRMFGQUrBSsFCAAIAAgACAAIAAgACAAIAAgACABdAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABoAmgCrwGvAQgAbgJ2AggAHgEIAAgACADnAXsCCAAIAAgAgwIIAAgACAAIAAgACACKAggAkQKZAggAPADJAAgAoQKkAqwCsgK6AsICCADJAggA0AIIAAgACAAIANYC3gIIAAgACAAIAAgACABAAOYCCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAkASoB+QIEAAgACAA8AEMCCABCBQgACABJBVAFCAAIAAgACAAIAAgACAAIAAgACABTBVoFCAAIAFoFCABfBWUFCAAIAAgACAAIAAgAbQUIAAgACAAIAAgACABzBXsFfQWFBYoFigWKBZEFigWKBYoFmAWfBaYFrgWxBbkFCAAIAAgACAAIAAgACAAIAAgACAAIAMEFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAMgFCADQBQgACAAIAAgACAAIAAgACAAIAAgACAAIAO4CCAAIAAgAiQAIAAgACABAAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAD0AggACAD8AggACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIANYFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAMDvwAIAAgAJAIIAAgACAAIAAgACAAIAAgACwMTAwgACAB9BOsEGwMjAwgAKwMyAwsFYgE3A/MEPwMIAEUDTQNRAwgAWQOsAGEDCAAIAAgACAAIAAgACABpAzQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFOgU0BTUFNgU3BTgFOQU6BTQFNQU2BTcFOAU5BToFNAU1BTYFNwU4BTkFIQUoBSwFCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABtAwgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABMAEwACAAIAAgACAAIABgACAAIAAgACAC/AAgACAAyAQgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACAAIAAwAAgACAAIAAgACAAIAAgACAAIAAAARABIAAgACAAIABQASAAIAAgAIABwAEAAjgCIABsAqAC2AL0AigDQAtwC+IJIQqVAZUBWQqVAZUBlQGVAZUBlQGrC5UBlQGVAZUBlQGVAZUBlQGVAXsKlQGVAbAK6wsrDGUMpQzlDJUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAZUBlQGVAfAKAAuZA64AtwCJALoC6ADwAAgAuACgA/oEpgO6AqsD+AAIAAgAswMIAAgACAAIAIkAuwP5AfsBwwPLAwgACAAIAAgACADRA9kDCAAIAOED6QMIAAgACAAIAAgACADuA/YDCAAIAP4DyQAIAAgABgQIAAgAXQAOBAgACAAIAAgACAAIABMECAAIAAgACAAIAAgACAD8AAQBCAAIAAgAGgQiBCoECAExBAgAEAEIAAgACAAIAAgACAAIAAgACAAIAAgACAA4BAgACABABEYECAAIAAgATAQYAQgAVAQIAAgACAAIAAgACAAIAAgACAAIAFoECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAOQEIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAB+BAcACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAEABhgSMBAgACAAIAAgAlAQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAwAEAAQABAADAAMAAwADAAQABAAEAAQABAAEAAQABHATAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAdQMIAAgACAAIAAgACAAIAMkACAAIAAgAfQMIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACACFA4kDCAAIAAgACAAIAOcBCAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAIcDCAAIAAgACAAIAAgACAAIAAgACAAIAJEDCAAIAAgACADFAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABgBAgAZgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAbAQCBXIECAAIAHkECAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACABAAJwEQACjBKoEsgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAC6BMIECAAIAAgACAAIAAgACABmBAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAxwQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAGYECAAIAAgAzgQIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBd0FXwUIAOIF6gXxBYoF3gT5BQAGCAaKBYoFigWKBYoFigWKBYoFigWKBYoFigXWBIoFigWKBYoFigWKBYoFigWKBYsFEAaKBYoFigWKBYoFigWKBRQGCACKBYoFigWKBQgACAAIANEECAAIABgGigUgBggAJgYIAC4GMwaKBYoF0wQ3Bj4GigWKBYoFigWKBYoFigWKBYoFigWKBYoFigUIAAgACAAIAAgACAAIAAgAigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWKBYoFigWLBf///////wQABAAEAAQABAAEAAQABAAEAAQAAwAEAAQAAgAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAQADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUAAAAFAAUAAAAFAAUAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUAAQAAAAUABQAFAAUABQAFAAAAAAAFAAUAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAFAAUAAQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAAABwAHAAcAAAAHAAcABwAFAAEAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAcABwAFAAUAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAAAAQABAAAAAAAAAAAAAAAFAAUABQAFAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAHAAcAAAAHAAcAAAAAAAUABQAHAAUAAQAHAAEABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwABAAUABQAFAAUAAAAAAAAAAAAAAAEAAQABAAEAAQABAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABQANAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAEAAQABAAEAAQABAAEAAQABAAEAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAABQAHAAUABQAFAAAAAAAAAAcABQAFAAUABQAFAAQABAAEAAQABAAEAAQABAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAEAAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUAAAAFAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAUAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAcABwAFAAcABwAAAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUABwAHAAUABQAFAAUAAAAAAAcABwAAAAAABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAABQAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAAAAAAAAAAABQAFAAAAAAAFAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAFAAUABQAFAAUAAAAFAAUABwAAAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABwAFAAUABQAFAAAAAAAHAAcAAAAAAAcABwAFAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAAAAAAAAAHAAcABwAAAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAABQAHAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAUABQAFAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAHAAcABQAHAAcAAAAFAAcABwAAAAcABwAFAAUAAAAAAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAFAAcABwAFAAUABQAAAAUAAAAHAAcABwAHAAcABwAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAHAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAABwAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAUAAAAFAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABwAFAAUABQAFAAUAAAAFAAUAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABwAFAAUABQAFAAUABQAAAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABQAFAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABQAFAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAHAAUABQAFAAUABQAFAAUABwAHAAcABwAHAAcABwAHAAUABwAHAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABwAHAAcABwAFAAUABwAHAAcAAAAAAAAAAAAHAAcABQAHAAcABwAHAAcABwAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAcABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAUABQAFAAUABQAFAAUAAAAFAAAABQAAAAAABQAFAAUABQAFAAUABQAFAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAFAAUAAAAAAAUABQAFAAUABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABwAFAAcABwAHAAcABwAFAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAUABQAFAAUABwAHAAUABQAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABQAFAAcABwAHAAUABwAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAcABQAFAAUABQAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAAAAAABwAFAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAAAAAAAAAFAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAUABQAHAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAUABQAFAAUABQAHAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAcABwAFAAUABQAFAAcABwAFAAUABwAHAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAFAAcABwAFAAUABwAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAFAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAFAAUABQAAAAAABQAFAAAAAAAAAAAAAAAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAcABwAAAAAAAAAAAAAABwAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAcABwAFAAcABwAAAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAFAAUABQAAAAUABQAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABwAFAAUABQAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAUABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAHAAcABQAHAAUABQAAAAAAAAAAAAAAAAAFAAAABwAHAAcABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAHAAcABwAAAAAABwAHAAAAAAAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABwAHAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAFAAUABwAFAAcABwAFAAcABQAFAAcABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAHAAcABQAFAAUABQAAAAAABwAHAAcABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAHAAUABQAFAAUABQAFAAUABQAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABwAFAAcABwAFAAUABQAFAAUABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAcABwAFAAUABQAFAAcABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAUABQAFAAUABQAHAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAFAAUABQAFAAAAAAAFAAUABwAHAAcABwAFAAAAAAAAAAcAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABwAHAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAcABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUAAAAHAAUABQAFAAUABQAFAAUABwAFAAUABwAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUAAAAAAAAABQAAAAUABQAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAHAAcABwAHAAcAAAAFAAUAAAAHAAcABQAHAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAAAAUABQAFAAAAAAAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAFAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAFAAUABQAAAAAABQAFAAUABQAFAAUABQAAAAUABQAAAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFAAUABQAFAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABQAFAAUABQAFAAUABQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAFAAUABQAFAAUADgAOAA4ADgAOAA4ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAA8ADwAPAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAcABwAHAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAMAAwADAAMAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkACQAJAAkAAAAAAAAAAAAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAKAAoACgAAAAAAAAAAAAsADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwACwAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAMAAwADAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAADgAOAA4AAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAAAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4AAAAOAAAAAAAAAAAAAAAAAA4AAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAAAAAAAAAAAA4AAAAOAAAAAAAAAAAADgAOAA4AAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAA4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4AAAAAAA4ADgAOAA4ADgAOAA4ADgAOAAAADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4ADgAOAAAAAAAAAAAAAAAAAAAAAAAAAAAADgAOAA4ADgAOAA4AAAAAAAAAAAAAAAAAAAAAAA4ADgAOAA4ADgAOAA4ADgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAOAA4ADgAOAA4ADgAAAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4ADgAOAA4AAAAAAAAAAAA=",Wg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Mo=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var Cl=0;Cl<Wg.length;Cl++)Mo[Wg.charCodeAt(Cl)]=Cl;var fT=function(s){var t=s.length*.75,e=s.length,i,A=0,r,a,l,u;s[s.length-1]==="="&&(t--,s[s.length-2]==="="&&t--);var h=typeof ArrayBuffer<"u"&&typeof Uint8Array<"u"&&typeof Uint8Array.prototype.slice<"u"?new ArrayBuffer(t):new Array(t),m=Array.isArray(h)?h:new Uint8Array(h);for(i=0;i<e;i+=4)r=Mo[s.charCodeAt(i)],a=Mo[s.charCodeAt(i+1)],l=Mo[s.charCodeAt(i+2)],u=Mo[s.charCodeAt(i+3)],m[A++]=r<<2|a>>4,m[A++]=(a&15)<<4|l>>2,m[A++]=(l&3)<<6|u&63;return h},pT=function(s){for(var t=s.length,e=[],i=0;i<t;i+=2)e.push(s[i+1]<<8|s[i]);return e},mT=function(s){for(var t=s.length,e=[],i=0;i<t;i+=4)e.push(s[i+3]<<24|s[i+2]<<16|s[i+1]<<8|s[i]);return e},dA=5,ep=11,Yh=2,gT=ep-dA,_B=65536>>dA,wT=1<<dA,jh=wT-1,vT=1024>>dA,BT=_B+vT,yT=BT,CT=32,bT=yT+CT,_T=65536>>ep,xT=1<<gT,ET=xT-1,Kg=function(s,t,e){return s.slice?s.slice(t,e):new Uint16Array(Array.prototype.slice.call(s,t,e))},ST=function(s,t,e){return s.slice?s.slice(t,e):new Uint32Array(Array.prototype.slice.call(s,t,e))},FT=function(s,t){var e=fT(s),i=Array.isArray(e)?mT(e):new Uint32Array(e),A=Array.isArray(e)?pT(e):new Uint16Array(e),r=24,a=Kg(A,r/2,i[4]/2),l=i[5]===2?Kg(A,(r+i[4])/2):ST(i,Math.ceil((r+i[4])/4));return new TT(i[0],i[1],i[2],i[3],a,l)},TT=(function(){function s(t,e,i,A,r,a){this.initialValue=t,this.errorValue=e,this.highStart=i,this.highValueIndex=A,this.index=r,this.data=a}return s.prototype.get=function(t){var e;if(t>=0){if(t<55296||t>56319&&t<=65535)return e=this.index[t>>dA],e=(e<<Yh)+(t&jh),this.data[e];if(t<=65535)return e=this.index[_B+(t-55296>>dA)],e=(e<<Yh)+(t&jh),this.data[e];if(t<this.highStart)return e=bT-_T+(t>>ep),e=this.index[e],e+=t>>dA&ET,e=this.index[e],e=(e<<Yh)+(t&jh),this.data[e];if(t<=1114111)return this.data[this.highValueIndex]}return this.errorValue},s})(),Gg="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",IT=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(var bl=0;bl<Gg.length;bl++)IT[Gg.charCodeAt(bl)]=bl;var QT=1,Jh=2,Zh=3,qg=4,zg=5,MT=7,$g=8,td=9,ed=10,Xg=11,Yg=12,jg=13,Jg=14,sd=15,UT=function(s){for(var t=[],e=0,i=s.length;e<i;){var A=s.charCodeAt(e++);if(A>=55296&&A<=56319&&e<i){var r=s.charCodeAt(e++);(r&64512)===56320?t.push(((A&1023)<<10)+(r&1023)+65536):(t.push(A),e--)}else t.push(A)}return t},PT=function(){for(var s=[],t=0;t<arguments.length;t++)s[t]=arguments[t];if(String.fromCodePoint)return String.fromCodePoint.apply(String,s);var e=s.length;if(!e)return"";for(var i=[],A=-1,r="";++A<e;){var a=s[A];a<=65535?i.push(a):(a-=65536,i.push((a>>10)+55296,a%1024+56320)),(A+1===e||i.length>16384)&&(r+=String.fromCharCode.apply(String,i),i.length=0)}return r},DT=FT(dT),An="",nd="",kT=function(s){return DT.get(s)},LT=function(s,t,e){var i=e-2,A=t[i],r=t[e-1],a=t[e];if(r===Jh&&a===Zh)return An;if(r===Jh||r===Zh||r===qg||a===Jh||a===Zh||a===qg)return nd;if(r===$g&&[$g,td,Xg,Yg].indexOf(a)!==-1||(r===Xg||r===td)&&(a===td||a===ed)||(r===Yg||r===ed)&&a===ed||a===jg||a===zg||a===MT||r===QT)return An;if(r===jg&&a===Jg){for(;A===zg;)A=t[--i];if(A===Jg)return An}if(r===sd&&a===sd){for(var l=0;A===sd;)l++,A=t[--i];if(l%2===0)return An}return nd},RT=function(s){var t=UT(s),e=t.length,i=0,A=0,r=t.map(kT);return{next:function(){if(i>=e)return{done:!0,value:null};for(var a=An;i<e&&(a=LT(t,r,++i))===An;);if(a!==An||i===e){var l=PT.apply(null,t.slice(A,i));return A=i,{value:l,done:!1}}return{done:!0,value:null}}}},HT=function(s){for(var t=RT(s),e=[],i;!(i=t.next()).done;)i.value&&e.push(i.value.slice());return e},NT=function(s){var t=123;if(s.createRange){var e=s.createRange();if(e.getBoundingClientRect){var i=s.createElement("boundtest");i.style.height=t+"px",i.style.display="block",s.body.appendChild(i),e.selectNode(i);var A=e.getBoundingClientRect(),r=Math.round(A.height);if(s.body.removeChild(i),r===t)return!0}}return!1},OT=function(s){var t=s.createElement("boundtest");t.style.width="50px",t.style.display="block",t.style.fontSize="12px",t.style.letterSpacing="0px",t.style.wordSpacing="0px",s.body.appendChild(t);var e=s.createRange();t.innerHTML=typeof"".repeat=="function"?"&#128104;".repeat(10):"";var i=t.firstChild,A=Oc(i.data).map(function(u){return We(u)}),r=0,a={},l=A.every(function(u,h){e.setStart(i,r),e.setEnd(i,r+u.length);var m=e.getBoundingClientRect();r+=u.length;var g=m.x>a.x||m.y>a.y;return a=m,h===0?!0:g});return s.body.removeChild(t),l},VT=function(){return typeof new Image().crossOrigin<"u"},WT=function(){return typeof new XMLHttpRequest().responseType=="string"},KT=function(s){var t=new Image,e=s.createElement("canvas"),i=e.getContext("2d");if(!i)return!1;t.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{i.drawImage(t,0,0),e.toDataURL()}catch{return!1}return!0},Zg=function(s){return s[0]===0&&s[1]===255&&s[2]===0&&s[3]===255},GT=function(s){var t=s.createElement("canvas"),e=100;t.width=e,t.height=e;var i=t.getContext("2d");if(!i)return Promise.reject(!1);i.fillStyle="rgb(0, 255, 0)",i.fillRect(0,0,e,e);var A=new Image,r=t.toDataURL();A.src=r;var a=rf(e,e,0,0,A);return i.fillStyle="red",i.fillRect(0,0,e,e),tw(a).then(function(l){i.drawImage(l,0,0);var u=i.getImageData(0,0,e,e).data;i.fillStyle="red",i.fillRect(0,0,e,e);var h=s.createElement("div");return h.style.backgroundImage="url("+r+")",h.style.height=e+"px",Zg(u)?tw(rf(e,e,0,0,h)):Promise.reject(!1)}).then(function(l){return i.drawImage(l,0,0),Zg(i.getImageData(0,0,e,e).data)}).catch(function(){return!1})},rf=function(s,t,e,i,A){var r="http://www.w3.org/2000/svg",a=document.createElementNS(r,"svg"),l=document.createElementNS(r,"foreignObject");return a.setAttributeNS(null,"width",s.toString()),a.setAttributeNS(null,"height",t.toString()),l.setAttributeNS(null,"width","100%"),l.setAttributeNS(null,"height","100%"),l.setAttributeNS(null,"x",e.toString()),l.setAttributeNS(null,"y",i.toString()),l.setAttributeNS(null,"externalResourcesRequired","true"),a.appendChild(l),l.appendChild(A),a},tw=function(s){return new Promise(function(t,e){var i=new Image;i.onload=function(){return t(i)},i.onerror=e,i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(s))})},gs={get SUPPORT_RANGE_BOUNDS(){var s=NT(document);return Object.defineProperty(gs,"SUPPORT_RANGE_BOUNDS",{value:s}),s},get SUPPORT_WORD_BREAKING(){var s=gs.SUPPORT_RANGE_BOUNDS&&OT(document);return Object.defineProperty(gs,"SUPPORT_WORD_BREAKING",{value:s}),s},get SUPPORT_SVG_DRAWING(){var s=KT(document);return Object.defineProperty(gs,"SUPPORT_SVG_DRAWING",{value:s}),s},get SUPPORT_FOREIGNOBJECT_DRAWING(){var s=typeof Array.from=="function"&&typeof window.fetch=="function"?GT(document):Promise.resolve(!1);return Object.defineProperty(gs,"SUPPORT_FOREIGNOBJECT_DRAWING",{value:s}),s},get SUPPORT_CORS_IMAGES(){var s=VT();return Object.defineProperty(gs,"SUPPORT_CORS_IMAGES",{value:s}),s},get SUPPORT_RESPONSE_TYPE(){var s=WT();return Object.defineProperty(gs,"SUPPORT_RESPONSE_TYPE",{value:s}),s},get SUPPORT_CORS_XHR(){var s="withCredentials"in new XMLHttpRequest;return Object.defineProperty(gs,"SUPPORT_CORS_XHR",{value:s}),s},get SUPPORT_NATIVE_TEXT_SEGMENTATION(){var s=!!(typeof Intl<"u"&&Intl.Segmenter);return Object.defineProperty(gs,"SUPPORT_NATIVE_TEXT_SEGMENTATION",{value:s}),s}},qo=(function(){function s(t,e){this.text=t,this.bounds=e}return s})(),qT=function(s,t,e,i){var A=XT(t,e),r=[],a=0;return A.forEach(function(l){if(e.textDecorationLine.length||l.trim().length>0)if(gs.SUPPORT_RANGE_BOUNDS){var u=ew(i,a,l.length).getClientRects();if(u.length>1){var h=sp(l),m=0;h.forEach(function(w){r.push(new qo(w,ui.fromDOMRectList(s,ew(i,m+a,w.length).getClientRects()))),m+=w.length})}else r.push(new qo(l,ui.fromDOMRectList(s,u)))}else{var g=i.splitText(l.length);r.push(new qo(l,zT(s,i))),i=g}else gs.SUPPORT_RANGE_BOUNDS||(i=i.splitText(l.length));a+=l.length}),r},zT=function(s,t){var e=t.ownerDocument;if(e){var i=e.createElement("html2canvaswrapper");i.appendChild(t.cloneNode(!0));var A=t.parentNode;if(A){A.replaceChild(i,t);var r=Nc(s,i);return i.firstChild&&A.replaceChild(i.firstChild,i),r}}return ui.EMPTY},ew=function(s,t,e){var i=s.ownerDocument;if(!i)throw new Error("Node has no owner document");var A=i.createRange();return A.setStart(s,t),A.setEnd(s,t+e),A},sp=function(s){if(gs.SUPPORT_NATIVE_TEXT_SEGMENTATION){var t=new Intl.Segmenter(void 0,{granularity:"grapheme"});return Array.from(t.segment(s)).map(function(e){return e.segment})}return HT(s)},$T=function(s,t){if(gs.SUPPORT_NATIVE_TEXT_SEGMENTATION){var e=new Intl.Segmenter(void 0,{granularity:"word"});return Array.from(e.segment(s)).map(function(i){return i.segment})}return jT(s,t)},XT=function(s,t){return t.letterSpacing!==0?sp(s):$T(s,t)},YT=[32,160,4961,65792,65793,4153,4241],jT=function(s,t){for(var e=_S(s,{lineBreak:t.lineBreak,wordBreak:t.overflowWrap==="break-word"?"break-word":t.wordBreak}),i=[],A,r=function(){if(A.value){var a=A.value.slice(),l=Oc(a),u="";l.forEach(function(h){YT.indexOf(h)===-1?u+=We(h):(u.length&&i.push(u),i.push(We(h)),u="")}),u.length&&i.push(u)}};!(A=e.next()).done;)r();return i},JT=(function(){function s(t,e,i){this.text=ZT(e.data,i.textTransform),this.textBounds=qT(t,this.text,i,e)}return s})(),ZT=function(s,t){switch(t){case 1:return s.toLowerCase();case 3:return s.replace(tI,eI);case 2:return s.toUpperCase();default:return s}},tI=/(^|\s|:|-|\(|\))([a-z])/g,eI=function(s,t,e){return s.length>0?t+e.toUpperCase():s},xB=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;return A.src=i.currentSrc||i.src,A.intrinsicWidth=i.naturalWidth,A.intrinsicHeight=i.naturalHeight,A.context.cache.addImage(A.src),A}return t})($n),EB=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;return A.canvas=i,A.intrinsicWidth=i.width,A.intrinsicHeight=i.height,A}return t})($n),SB=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this,r=new XMLSerializer,a=Nc(e,i);return i.setAttribute("width",a.width+"px"),i.setAttribute("height",a.height+"px"),A.svg="data:image/svg+xml,"+encodeURIComponent(r.serializeToString(i)),A.intrinsicWidth=i.width.baseVal.value,A.intrinsicHeight=i.height.baseVal.value,A.context.cache.addImage(A.svg),A}return t})($n),FB=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;return A.value=i.value,A}return t})($n),of=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;return A.start=i.start,A.reversed=typeof i.reversed=="boolean"&&i.reversed===!0,A}return t})($n),sI=[{type:15,flags:0,unit:"px",number:3}],nI=[{type:16,flags:0,number:50}],iI=function(s){return s.width>s.height?new ui(s.left+(s.width-s.height)/2,s.top,s.height,s.height):s.width<s.height?new ui(s.left,s.top+(s.height-s.width)/2,s.width,s.width):s},AI=function(s){var t=s.type===rI?new Array(s.value.length+1).join(""):s.value;return t.length===0?s.placeholder||"":t},mc="checkbox",gc="radio",rI="password",sw=707406591,np=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;switch(A.type=i.type.toLowerCase(),A.checked=i.checked,A.value=AI(i),(A.type===mc||A.type===gc)&&(A.styles.backgroundColor=3739148031,A.styles.borderTopColor=A.styles.borderRightColor=A.styles.borderBottomColor=A.styles.borderLeftColor=2779096575,A.styles.borderTopWidth=A.styles.borderRightWidth=A.styles.borderBottomWidth=A.styles.borderLeftWidth=1,A.styles.borderTopStyle=A.styles.borderRightStyle=A.styles.borderBottomStyle=A.styles.borderLeftStyle=1,A.styles.backgroundClip=[0],A.styles.backgroundOrigin=[0],A.bounds=iI(A.bounds)),A.type){case mc:A.styles.borderTopRightRadius=A.styles.borderTopLeftRadius=A.styles.borderBottomRightRadius=A.styles.borderBottomLeftRadius=sI;break;case gc:A.styles.borderTopRightRadius=A.styles.borderTopLeftRadius=A.styles.borderBottomRightRadius=A.styles.borderBottomLeftRadius=nI;break}return A}return t})($n),TB=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this,r=i.options[i.selectedIndex||0];return A.value=r&&r.text||"",A}return t})($n),IB=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;return A.value=i.value,A}return t})($n),QB=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;A.src=i.src,A.width=parseInt(i.width,10)||0,A.height=parseInt(i.height,10)||0,A.backgroundColor=A.styles.backgroundColor;try{if(i.contentWindow&&i.contentWindow.document&&i.contentWindow.document.documentElement){A.tree=UB(e,i.contentWindow.document.documentElement);var r=i.contentWindow.document.documentElement?Ko(e,getComputedStyle(i.contentWindow.document.documentElement).backgroundColor):ci.TRANSPARENT,a=i.contentWindow.document.body?Ko(e,getComputedStyle(i.contentWindow.document.body).backgroundColor):ci.TRANSPARENT;A.backgroundColor=Vi(r)?Vi(a)?A.styles.backgroundColor:a:r}}catch{}return A}return t})($n),oI=["OL","UL","MENU"],ql=function(s,t,e,i){for(var A=t.firstChild,r=void 0;A;A=r)if(r=A.nextSibling,PB(A)&&A.data.trim().length>0)e.textNodes.push(new JT(s,A,e.styles));else if(cr(A))if(RB(A)&&A.assignedNodes)A.assignedNodes().forEach(function(l){return ql(s,l,e,i)});else{var a=MB(s,A);a.styles.isVisible()&&(aI(A,a,i)?a.flags|=4:lI(a.styles)&&(a.flags|=2),oI.indexOf(A.tagName)!==-1&&(a.flags|=8),e.elements.push(a),A.slot,A.shadowRoot?ql(s,A.shadowRoot,a,i):!wc(A)&&!DB(A)&&!vc(A)&&ql(s,A,a,i))}},MB=function(s,t){return lf(t)?new xB(s,t):kB(t)?new EB(s,t):DB(t)?new SB(s,t):cI(t)?new FB(s,t):uI(t)?new of(s,t):hI(t)?new np(s,t):vc(t)?new TB(s,t):wc(t)?new IB(s,t):LB(t)?new QB(s,t):new $n(s,t)},UB=function(s,t){var e=MB(s,t);return e.flags|=4,ql(s,t,e,e),e},aI=function(s,t,e){return t.styles.isPositionedWithZIndex()||t.styles.opacity<1||t.styles.isTransformed()||ip(s)&&e.styles.isTransparent()},lI=function(s){return s.isPositioned()||s.isFloating()},PB=function(s){return s.nodeType===Node.TEXT_NODE},cr=function(s){return s.nodeType===Node.ELEMENT_NODE},af=function(s){return cr(s)&&typeof s.style<"u"&&!zl(s)},zl=function(s){return typeof s.className=="object"},cI=function(s){return s.tagName==="LI"},uI=function(s){return s.tagName==="OL"},hI=function(s){return s.tagName==="INPUT"},dI=function(s){return s.tagName==="HTML"},DB=function(s){return s.tagName==="svg"},ip=function(s){return s.tagName==="BODY"},kB=function(s){return s.tagName==="CANVAS"},nw=function(s){return s.tagName==="VIDEO"},lf=function(s){return s.tagName==="IMG"},LB=function(s){return s.tagName==="IFRAME"},iw=function(s){return s.tagName==="STYLE"},fI=function(s){return s.tagName==="SCRIPT"},wc=function(s){return s.tagName==="TEXTAREA"},vc=function(s){return s.tagName==="SELECT"},RB=function(s){return s.tagName==="SLOT"},Aw=function(s){return s.tagName.indexOf("-")>0},pI=(function(){function s(){this.counters={}}return s.prototype.getCounterValue=function(t){var e=this.counters[t];return e&&e.length?e[e.length-1]:1},s.prototype.getCounterValues=function(t){var e=this.counters[t];return e||[]},s.prototype.pop=function(t){var e=this;t.forEach(function(i){return e.counters[i].pop()})},s.prototype.parse=function(t){var e=this,i=t.counterIncrement,A=t.counterReset,r=!0;i!==null&&i.forEach(function(l){var u=e.counters[l.counter];u&&l.increment!==0&&(r=!1,u.length||u.push(1),u[Math.max(0,u.length-1)]+=l.increment)});var a=[];return r&&A.forEach(function(l){var u=e.counters[l.counter];a.push(l.counter),u||(u=e.counters[l.counter]=[]),u.push(l.reset)}),a},s})(),rw={integers:[1e3,900,500,400,100,90,50,40,10,9,5,4,1],values:["M","CM","D","CD","C","XC","L","XL","X","IX","V","IV","I"]},ow={integers:[9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},mI={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,400,300,200,100,90,80,70,60,50,40,30,20,19,18,17,16,15,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},gI={integers:[1e4,9e3,8e3,7e3,6e3,5e3,4e3,3e3,2e3,1e3,900,800,700,600,500,400,300,200,100,90,80,70,60,50,40,30,20,10,9,8,7,6,5,4,3,2,1],values:["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","",""]},JA=function(s,t,e,i,A,r){return s<t||s>e?ha(s,A,r.length>0):i.integers.reduce(function(a,l,u){for(;s>=l;)s-=l,a+=i.values[u];return a},"")+r},HB=function(s,t,e,i){var A="";do e||s--,A=i(s)+A,s/=t;while(s*t>=t);return A},Oe=function(s,t,e,i,A){var r=e-t+1;return(s<0?"-":"")+(HB(Math.abs(s),r,i,function(a){return We(Math.floor(a%r)+t)})+A)},nA=function(s,t,e){e===void 0&&(e=". ");var i=t.length;return HB(Math.abs(s),i,!1,function(A){return t[Math.floor(A%i)]})+e},Ar=1,Si=2,Fi=4,Uo=8,Ai=function(s,t,e,i,A,r){if(s<-9999||s>9999)return ha(s,4,A.length>0);var a=Math.abs(s),l=A;if(a===0)return t[0]+l;for(var u=0;a>0&&u<=4;u++){var h=a%10;h===0&&Je(r,Ar)&&l!==""?l=t[h]+l:h>1||h===1&&u===0||h===1&&u===1&&Je(r,Si)||h===1&&u===1&&Je(r,Fi)&&s>100||h===1&&u>1&&Je(r,Uo)?l=t[h]+(u>0?e[u-1]:"")+l:h===1&&u>0&&(l=e[u-1]+l),a=Math.floor(a/10)}return(s<0?i:"")+l},aw="",lw="",cw="",id="",ha=function(s,t,e){var i=e?". ":"",A=e?"":"",r=e?", ":"",a=e?" ":"";switch(t){case 0:return""+a;case 1:return""+a;case 2:return""+a;case 5:var l=Oe(s,48,57,!0,i);return l.length<4?"0"+l:l;case 4:return nA(s,"",A);case 6:return JA(s,1,3999,rw,3,i).toLowerCase();case 7:return JA(s,1,3999,rw,3,i);case 8:return Oe(s,945,969,!1,i);case 9:return Oe(s,97,122,!1,i);case 10:return Oe(s,65,90,!1,i);case 11:return Oe(s,1632,1641,!0,i);case 12:case 49:return JA(s,1,9999,ow,3,i);case 35:return JA(s,1,9999,ow,3,i).toLowerCase();case 13:return Oe(s,2534,2543,!0,i);case 14:case 30:return Oe(s,6112,6121,!0,i);case 15:return nA(s,"",A);case 16:return nA(s,"",A);case 17:case 48:return Ai(s,"",aw,"",A,Si|Fi|Uo);case 47:return Ai(s,"",lw,"",A,Ar|Si|Fi|Uo);case 42:return Ai(s,"",aw,"",A,Si|Fi|Uo);case 41:return Ai(s,"",lw,"",A,Ar|Si|Fi|Uo);case 26:return Ai(s,"","",cw,A,0);case 25:return Ai(s,"","",cw,A,Ar|Si|Fi);case 31:return Ai(s,"","",id,r,Ar|Si|Fi);case 33:return Ai(s,"","",id,r,0);case 32:return Ai(s,"","",id,r,Ar|Si|Fi);case 18:return Oe(s,2406,2415,!0,i);case 20:return JA(s,1,19999,gI,3,i);case 21:return Oe(s,2790,2799,!0,i);case 22:return Oe(s,2662,2671,!0,i);case 22:return JA(s,1,10999,mI,3,i);case 23:return nA(s,"");case 24:return nA(s,"");case 27:return Oe(s,3302,3311,!0,i);case 28:return nA(s,"",A);case 29:return nA(s,"",A);case 34:return Oe(s,3792,3801,!0,i);case 37:return Oe(s,6160,6169,!0,i);case 38:return Oe(s,4160,4169,!0,i);case 39:return Oe(s,2918,2927,!0,i);case 40:return Oe(s,1776,1785,!0,i);case 43:return Oe(s,3046,3055,!0,i);case 44:return Oe(s,3174,3183,!0,i);case 45:return Oe(s,3664,3673,!0,i);case 46:return Oe(s,3872,3881,!0,i);case 3:default:return Oe(s,48,57,!0,i)}},NB="data-html2canvas-ignore",uw=(function(){function s(t,e,i){if(this.context=t,this.options=i,this.scrolledElements=[],this.referenceElement=e,this.counters=new pI,this.quoteDepth=0,!e.ownerDocument)throw new Error("Cloned element does not have an owner document");this.documentElement=this.cloneNode(e.ownerDocument.documentElement,!1)}return s.prototype.toIFrame=function(t,e){var i=this,A=wI(t,e);if(!A.contentWindow)return Promise.reject("Unable to find iframe window");var r=t.defaultView.pageXOffset,a=t.defaultView.pageYOffset,l=A.contentWindow,u=l.document,h=yI(A).then(function(){return Is(i,void 0,void 0,function(){var m,g;return Bs(this,function(w){switch(w.label){case 0:return this.scrolledElements.forEach(xI),l&&(l.scrollTo(e.left,e.top),/(iPad|iPhone|iPod)/g.test(navigator.userAgent)&&(l.scrollY!==e.top||l.scrollX!==e.left)&&(this.context.logger.warn("Unable to restore scroll position for cloned document"),this.context.windowBounds=this.context.windowBounds.add(l.scrollX-e.left,l.scrollY-e.top,0,0))),m=this.options.onclone,g=this.clonedReferenceElement,typeof g>"u"?[2,Promise.reject("Error finding the "+this.referenceElement.nodeName+" in the cloned document")]:u.fonts&&u.fonts.ready?[4,u.fonts.ready]:[3,2];case 1:w.sent(),w.label=2;case 2:return/(AppleWebKit)/g.test(navigator.userAgent)?[4,BI(u)]:[3,4];case 3:w.sent(),w.label=4;case 4:return typeof m=="function"?[2,Promise.resolve().then(function(){return m(u,g)}).then(function(){return A})]:[2,A]}})})});return u.open(),u.write(bI(document.doctype)+"<html></html>"),_I(this.referenceElement.ownerDocument,r,a),u.replaceChild(u.adoptNode(this.documentElement),u.documentElement),u.close(),h},s.prototype.createElementClone=function(t){if(Af(t,2))debugger;if(kB(t))return this.createCanvasClone(t);if(nw(t))return this.createVideoClone(t);if(iw(t))return this.createStyleClone(t);var e=t.cloneNode(!1);return lf(e)&&(lf(t)&&t.currentSrc&&t.currentSrc!==t.src&&(e.src=t.currentSrc,e.srcset=""),e.loading==="lazy"&&(e.loading="eager")),Aw(e)?this.createCustomElementClone(e):e},s.prototype.createCustomElementClone=function(t){var e=document.createElement("html2canvascustomelement");return Ad(t.style,e),e},s.prototype.createStyleClone=function(t){try{var e=t.sheet;if(e&&e.cssRules){var i=[].slice.call(e.cssRules,0).reduce(function(r,a){return a&&typeof a.cssText=="string"?r+a.cssText:r},""),A=t.cloneNode(!1);return A.textContent=i,A}}catch(r){if(this.context.logger.error("Unable to access cssRules property",r),r.name!=="SecurityError")throw r}return t.cloneNode(!1)},s.prototype.createCanvasClone=function(t){var e;if(this.options.inlineImages&&t.ownerDocument){var i=t.ownerDocument.createElement("img");try{return i.src=t.toDataURL(),i}catch{this.context.logger.info("Unable to inline canvas contents, canvas is tainted",t)}}var A=t.cloneNode(!1);try{A.width=t.width,A.height=t.height;var r=t.getContext("2d"),a=A.getContext("2d");if(a)if(!this.options.allowTaint&&r)a.putImageData(r.getImageData(0,0,t.width,t.height),0,0);else{var l=(e=t.getContext("webgl2"))!==null&&e!==void 0?e:t.getContext("webgl");if(l){var u=l.getContextAttributes();(u==null?void 0:u.preserveDrawingBuffer)===!1&&this.context.logger.warn("Unable to clone WebGL context as it has preserveDrawingBuffer=false",t)}a.drawImage(t,0,0)}return A}catch{this.context.logger.info("Unable to clone canvas as it is tainted",t)}return A},s.prototype.createVideoClone=function(t){var e=t.ownerDocument.createElement("canvas");e.width=t.offsetWidth,e.height=t.offsetHeight;var i=e.getContext("2d");try{return i&&(i.drawImage(t,0,0,e.width,e.height),this.options.allowTaint||i.getImageData(0,0,e.width,e.height)),e}catch{this.context.logger.info("Unable to clone video as it is tainted",t)}var A=t.ownerDocument.createElement("canvas");return A.width=t.offsetWidth,A.height=t.offsetHeight,A},s.prototype.appendChildNode=function(t,e,i){(!cr(e)||!fI(e)&&!e.hasAttribute(NB)&&(typeof this.options.ignoreElements!="function"||!this.options.ignoreElements(e)))&&(!this.options.copyStyles||!cr(e)||!iw(e))&&t.appendChild(this.cloneNode(e,i))},s.prototype.cloneChildNodes=function(t,e,i){for(var A=this,r=t.shadowRoot?t.shadowRoot.firstChild:t.firstChild;r;r=r.nextSibling)if(cr(r)&&RB(r)&&typeof r.assignedNodes=="function"){var a=r.assignedNodes();a.length&&a.forEach(function(l){return A.appendChildNode(e,l,i)})}else this.appendChildNode(e,r,i)},s.prototype.cloneNode=function(t,e){if(PB(t))return document.createTextNode(t.data);if(!t.ownerDocument)return t.cloneNode(!1);var i=t.ownerDocument.defaultView;if(i&&cr(t)&&(af(t)||zl(t))){var A=this.createElementClone(t);A.style.transitionProperty="none";var r=i.getComputedStyle(t),a=i.getComputedStyle(t,":before"),l=i.getComputedStyle(t,":after");this.referenceElement===t&&af(A)&&(this.clonedReferenceElement=A),ip(A)&&FI(A);var u=this.counters.parse(new Vg(this.context,r)),h=this.resolvePseudoContent(t,A,a,zo.BEFORE);Aw(t)&&(e=!0),nw(t)||this.cloneChildNodes(t,A,e),h&&A.insertBefore(h,A.firstChild);var m=this.resolvePseudoContent(t,A,l,zo.AFTER);return m&&A.appendChild(m),this.counters.pop(u),(r&&(this.options.copyStyles||zl(t))&&!LB(t)||e)&&Ad(r,A),(t.scrollTop!==0||t.scrollLeft!==0)&&this.scrolledElements.push([A,t.scrollLeft,t.scrollTop]),(wc(t)||vc(t))&&(wc(A)||vc(A))&&(A.value=t.value),A}return t.cloneNode(!1)},s.prototype.resolvePseudoContent=function(t,e,i,A){var r=this;if(i){var a=i.content,l=e.ownerDocument;if(!(!l||!a||a==="none"||a==="-moz-alt-content"||i.display==="none")){this.counters.parse(new Vg(this.context,i));var u=new cT(this.context,i),h=l.createElement("html2canvaspseudoelement");Ad(i,h),u.content.forEach(function(g){if(g.type===0)h.appendChild(l.createTextNode(g.value));else if(g.type===22){var w=l.createElement("img");w.src=g.value,w.style.opacity="1",h.appendChild(w)}else if(g.type===18){if(g.name==="attr"){var C=g.values.filter(he);C.length&&h.appendChild(l.createTextNode(t.getAttribute(C[0].value)||""))}else if(g.name==="counter"){var y=g.values.filter(_r),E=y[0],x=y[1];if(E&&he(E)){var T=r.counters.getCounterValue(E.value),U=x&&he(x)?nf.parse(r.context,x.value):3;h.appendChild(l.createTextNode(ha(T,U,!1)))}}else if(g.name==="counters"){var H=g.values.filter(_r),E=H[0],R=H[1],x=H[2];if(E&&he(E)){var D=r.counters.getCounterValues(E.value),P=x&&he(x)?nf.parse(r.context,x.value):3,G=R&&R.type===0?R.value:"",Y=D.map(function(Bt){return ha(Bt,P,!1)}).join(G);h.appendChild(l.createTextNode(Y))}}}else if(g.type===20)switch(g.value){case"open-quote":h.appendChild(l.createTextNode(Og(u.quotes,r.quoteDepth++,!0)));break;case"close-quote":h.appendChild(l.createTextNode(Og(u.quotes,--r.quoteDepth,!1)));break;default:h.appendChild(l.createTextNode(g.value))}}),h.className=cf+" "+uf;var m=A===zo.BEFORE?" "+cf:" "+uf;return zl(e)?e.className.baseValue+=m:e.className+=m,h}}},s.destroy=function(t){return t.parentNode?(t.parentNode.removeChild(t),!0):!1},s})(),zo;(function(s){s[s.BEFORE=0]="BEFORE",s[s.AFTER=1]="AFTER"})(zo||(zo={}));var wI=function(s,t){var e=s.createElement("iframe");return e.className="html2canvas-container",e.style.visibility="hidden",e.style.position="fixed",e.style.left="-10000px",e.style.top="0px",e.style.border="0",e.width=t.width.toString(),e.height=t.height.toString(),e.scrolling="no",e.setAttribute(NB,"true"),s.body.appendChild(e),e},vI=function(s){return new Promise(function(t){if(s.complete){t();return}if(!s.src){t();return}s.onload=t,s.onerror=t})},BI=function(s){return Promise.all([].slice.call(s.images,0).map(vI))},yI=function(s){return new Promise(function(t,e){var i=s.contentWindow;if(!i)return e("No window assigned for iframe");var A=i.document;i.onload=s.onload=function(){i.onload=s.onload=null;var r=setInterval(function(){A.body.childNodes.length>0&&A.readyState==="complete"&&(clearInterval(r),t(s))},50)}})},CI=["all","d","content"],Ad=function(s,t){for(var e=s.length-1;e>=0;e--){var i=s.item(e);CI.indexOf(i)===-1&&t.style.setProperty(i,s.getPropertyValue(i))}return t},bI=function(s){var t="";return s&&(t+="<!DOCTYPE ",s.name&&(t+=s.name),s.internalSubset&&(t+=s.internalSubset),s.publicId&&(t+='"'+s.publicId+'"'),s.systemId&&(t+='"'+s.systemId+'"'),t+=">"),t},_I=function(s,t,e){s&&s.defaultView&&(t!==s.defaultView.pageXOffset||e!==s.defaultView.pageYOffset)&&s.defaultView.scrollTo(t,e)},xI=function(s){var t=s[0],e=s[1],i=s[2];t.scrollLeft=e,t.scrollTop=i},EI=":before",SI=":after",cf="___html2canvas___pseudoelement_before",uf="___html2canvas___pseudoelement_after",hw=`{
    content: "" !important;
    display: none !important;
}`,FI=function(s){TI(s,"."+cf+EI+hw+`
         .`+uf+SI+hw)},TI=function(s,t){var e=s.ownerDocument;if(e){var i=e.createElement("style");i.textContent=t,s.appendChild(i)}},OB=(function(){function s(){}return s.getOrigin=function(t){var e=s._link;return e?(e.href=t,e.href=e.href,e.protocol+e.hostname+e.port):"about:blank"},s.isSameOrigin=function(t){return s.getOrigin(t)===s._origin},s.setContext=function(t){s._link=t.document.createElement("a"),s._origin=s.getOrigin(t.location.href)},s._origin="about:blank",s})(),II=(function(){function s(t,e){this.context=t,this._options=e,this._cache={}}return s.prototype.addImage=function(t){var e=Promise.resolve();return this.has(t)||(od(t)||PI(t))&&(this._cache[t]=this.loadImage(t)).catch(function(){}),e},s.prototype.match=function(t){return this._cache[t]},s.prototype.loadImage=function(t){return Is(this,void 0,void 0,function(){var e,i,A,r,a=this;return Bs(this,function(l){switch(l.label){case 0:return e=OB.isSameOrigin(t),i=!rd(t)&&this._options.useCORS===!0&&gs.SUPPORT_CORS_IMAGES&&!e,A=!rd(t)&&!e&&!od(t)&&typeof this._options.proxy=="string"&&gs.SUPPORT_CORS_XHR&&!i,!e&&this._options.allowTaint===!1&&!rd(t)&&!od(t)&&!A&&!i?[2]:(r=t,A?[4,this.proxy(r)]:[3,2]);case 1:r=l.sent(),l.label=2;case 2:return this.context.logger.debug("Added image "+t.substring(0,256)),[4,new Promise(function(u,h){var m=new Image;m.onload=function(){return u(m)},m.onerror=h,(DI(r)||i)&&(m.crossOrigin="anonymous"),m.src=r,m.complete===!0&&setTimeout(function(){return u(m)},500),a._options.imageTimeout>0&&setTimeout(function(){return h("Timed out ("+a._options.imageTimeout+"ms) loading image")},a._options.imageTimeout)})];case 3:return[2,l.sent()]}})})},s.prototype.has=function(t){return typeof this._cache[t]<"u"},s.prototype.keys=function(){return Promise.resolve(Object.keys(this._cache))},s.prototype.proxy=function(t){var e=this,i=this._options.proxy;if(!i)throw new Error("No proxy defined");var A=t.substring(0,256);return new Promise(function(r,a){var l=gs.SUPPORT_RESPONSE_TYPE?"blob":"text",u=new XMLHttpRequest;u.onload=function(){if(u.status===200)if(l==="text")r(u.response);else{var g=new FileReader;g.addEventListener("load",function(){return r(g.result)},!1),g.addEventListener("error",function(w){return a(w)},!1),g.readAsDataURL(u.response)}else a("Failed to proxy resource "+A+" with status code "+u.status)},u.onerror=a;var h=i.indexOf("?")>-1?"&":"?";if(u.open("GET",""+i+h+"url="+encodeURIComponent(t)+"&responseType="+l),l!=="text"&&u instanceof XMLHttpRequest&&(u.responseType=l),e._options.imageTimeout){var m=e._options.imageTimeout;u.timeout=m,u.ontimeout=function(){return a("Timed out ("+m+"ms) proxying "+A)}}u.send()})},s})(),QI=/^data:image\/svg\+xml/i,MI=/^data:image\/.*;base64,/i,UI=/^data:image\/.*/i,PI=function(s){return gs.SUPPORT_SVG_DRAWING||!kI(s)},rd=function(s){return UI.test(s)},DI=function(s){return MI.test(s)},od=function(s){return s.substr(0,4)==="blob"},kI=function(s){return s.substr(-3).toLowerCase()==="svg"||QI.test(s)},Ct=(function(){function s(t,e){this.type=0,this.x=t,this.y=e}return s.prototype.add=function(t,e){return new s(this.x+t,this.y+e)},s})(),ZA=function(s,t,e){return new Ct(s.x+(t.x-s.x)*e,s.y+(t.y-s.y)*e)},_l=(function(){function s(t,e,i,A){this.type=1,this.start=t,this.startControl=e,this.endControl=i,this.end=A}return s.prototype.subdivide=function(t,e){var i=ZA(this.start,this.startControl,t),A=ZA(this.startControl,this.endControl,t),r=ZA(this.endControl,this.end,t),a=ZA(i,A,t),l=ZA(A,r,t),u=ZA(a,l,t);return e?new s(this.start,i,a,u):new s(u,l,r,this.end)},s.prototype.add=function(t,e){return new s(this.start.add(t,e),this.startControl.add(t,e),this.endControl.add(t,e),this.end.add(t,e))},s.prototype.reverse=function(){return new s(this.end,this.endControl,this.startControl,this.start)},s})(),on=function(s){return s.type===1},LI=(function(){function s(t){var e=t.styles,i=t.bounds,A=Qo(e.borderTopLeftRadius,i.width,i.height),r=A[0],a=A[1],l=Qo(e.borderTopRightRadius,i.width,i.height),u=l[0],h=l[1],m=Qo(e.borderBottomRightRadius,i.width,i.height),g=m[0],w=m[1],C=Qo(e.borderBottomLeftRadius,i.width,i.height),y=C[0],E=C[1],x=[];x.push((r+u)/i.width),x.push((y+g)/i.width),x.push((a+E)/i.height),x.push((h+w)/i.height);var T=Math.max.apply(Math,x);T>1&&(r/=T,a/=T,u/=T,h/=T,g/=T,w/=T,y/=T,E/=T);var U=i.width-u,H=i.height-w,R=i.width-g,D=i.height-E,P=e.borderTopWidth,G=e.borderRightWidth,Y=e.borderBottomWidth,W=e.borderLeftWidth,at=ve(e.paddingTop,t.bounds.width),Bt=ve(e.paddingRight,t.bounds.width),dt=ve(e.paddingBottom,t.bounds.width),X=ve(e.paddingLeft,t.bounds.width);this.topLeftBorderDoubleOuterBox=r>0||a>0?Ie(i.left+W/3,i.top+P/3,r-W/3,a-P/3,le.TOP_LEFT):new Ct(i.left+W/3,i.top+P/3),this.topRightBorderDoubleOuterBox=r>0||a>0?Ie(i.left+U,i.top+P/3,u-G/3,h-P/3,le.TOP_RIGHT):new Ct(i.left+i.width-G/3,i.top+P/3),this.bottomRightBorderDoubleOuterBox=g>0||w>0?Ie(i.left+R,i.top+H,g-G/3,w-Y/3,le.BOTTOM_RIGHT):new Ct(i.left+i.width-G/3,i.top+i.height-Y/3),this.bottomLeftBorderDoubleOuterBox=y>0||E>0?Ie(i.left+W/3,i.top+D,y-W/3,E-Y/3,le.BOTTOM_LEFT):new Ct(i.left+W/3,i.top+i.height-Y/3),this.topLeftBorderDoubleInnerBox=r>0||a>0?Ie(i.left+W*2/3,i.top+P*2/3,r-W*2/3,a-P*2/3,le.TOP_LEFT):new Ct(i.left+W*2/3,i.top+P*2/3),this.topRightBorderDoubleInnerBox=r>0||a>0?Ie(i.left+U,i.top+P*2/3,u-G*2/3,h-P*2/3,le.TOP_RIGHT):new Ct(i.left+i.width-G*2/3,i.top+P*2/3),this.bottomRightBorderDoubleInnerBox=g>0||w>0?Ie(i.left+R,i.top+H,g-G*2/3,w-Y*2/3,le.BOTTOM_RIGHT):new Ct(i.left+i.width-G*2/3,i.top+i.height-Y*2/3),this.bottomLeftBorderDoubleInnerBox=y>0||E>0?Ie(i.left+W*2/3,i.top+D,y-W*2/3,E-Y*2/3,le.BOTTOM_LEFT):new Ct(i.left+W*2/3,i.top+i.height-Y*2/3),this.topLeftBorderStroke=r>0||a>0?Ie(i.left+W/2,i.top+P/2,r-W/2,a-P/2,le.TOP_LEFT):new Ct(i.left+W/2,i.top+P/2),this.topRightBorderStroke=r>0||a>0?Ie(i.left+U,i.top+P/2,u-G/2,h-P/2,le.TOP_RIGHT):new Ct(i.left+i.width-G/2,i.top+P/2),this.bottomRightBorderStroke=g>0||w>0?Ie(i.left+R,i.top+H,g-G/2,w-Y/2,le.BOTTOM_RIGHT):new Ct(i.left+i.width-G/2,i.top+i.height-Y/2),this.bottomLeftBorderStroke=y>0||E>0?Ie(i.left+W/2,i.top+D,y-W/2,E-Y/2,le.BOTTOM_LEFT):new Ct(i.left+W/2,i.top+i.height-Y/2),this.topLeftBorderBox=r>0||a>0?Ie(i.left,i.top,r,a,le.TOP_LEFT):new Ct(i.left,i.top),this.topRightBorderBox=u>0||h>0?Ie(i.left+U,i.top,u,h,le.TOP_RIGHT):new Ct(i.left+i.width,i.top),this.bottomRightBorderBox=g>0||w>0?Ie(i.left+R,i.top+H,g,w,le.BOTTOM_RIGHT):new Ct(i.left+i.width,i.top+i.height),this.bottomLeftBorderBox=y>0||E>0?Ie(i.left,i.top+D,y,E,le.BOTTOM_LEFT):new Ct(i.left,i.top+i.height),this.topLeftPaddingBox=r>0||a>0?Ie(i.left+W,i.top+P,Math.max(0,r-W),Math.max(0,a-P),le.TOP_LEFT):new Ct(i.left+W,i.top+P),this.topRightPaddingBox=u>0||h>0?Ie(i.left+Math.min(U,i.width-G),i.top+P,U>i.width+G?0:Math.max(0,u-G),Math.max(0,h-P),le.TOP_RIGHT):new Ct(i.left+i.width-G,i.top+P),this.bottomRightPaddingBox=g>0||w>0?Ie(i.left+Math.min(R,i.width-W),i.top+Math.min(H,i.height-Y),Math.max(0,g-G),Math.max(0,w-Y),le.BOTTOM_RIGHT):new Ct(i.left+i.width-G,i.top+i.height-Y),this.bottomLeftPaddingBox=y>0||E>0?Ie(i.left+W,i.top+Math.min(D,i.height-Y),Math.max(0,y-W),Math.max(0,E-Y),le.BOTTOM_LEFT):new Ct(i.left+W,i.top+i.height-Y),this.topLeftContentBox=r>0||a>0?Ie(i.left+W+X,i.top+P+at,Math.max(0,r-(W+X)),Math.max(0,a-(P+at)),le.TOP_LEFT):new Ct(i.left+W+X,i.top+P+at),this.topRightContentBox=u>0||h>0?Ie(i.left+Math.min(U,i.width+W+X),i.top+P+at,U>i.width+W+X?0:u-W+X,h-(P+at),le.TOP_RIGHT):new Ct(i.left+i.width-(G+Bt),i.top+P+at),this.bottomRightContentBox=g>0||w>0?Ie(i.left+Math.min(R,i.width-(W+X)),i.top+Math.min(H,i.height+P+at),Math.max(0,g-(G+Bt)),w-(Y+dt),le.BOTTOM_RIGHT):new Ct(i.left+i.width-(G+Bt),i.top+i.height-(Y+dt)),this.bottomLeftContentBox=y>0||E>0?Ie(i.left+W+X,i.top+D,Math.max(0,y-(W+X)),E-(Y+dt),le.BOTTOM_LEFT):new Ct(i.left+W+X,i.top+i.height-(Y+dt))}return s})(),le;(function(s){s[s.TOP_LEFT=0]="TOP_LEFT",s[s.TOP_RIGHT=1]="TOP_RIGHT",s[s.BOTTOM_RIGHT=2]="BOTTOM_RIGHT",s[s.BOTTOM_LEFT=3]="BOTTOM_LEFT"})(le||(le={}));var Ie=function(s,t,e,i,A){var r=4*((Math.sqrt(2)-1)/3),a=e*r,l=i*r,u=s+e,h=t+i;switch(A){case le.TOP_LEFT:return new _l(new Ct(s,h),new Ct(s,h-l),new Ct(u-a,t),new Ct(u,t));case le.TOP_RIGHT:return new _l(new Ct(s,t),new Ct(s+a,t),new Ct(u,h-l),new Ct(u,h));case le.BOTTOM_RIGHT:return new _l(new Ct(u,t),new Ct(u,t+l),new Ct(s+a,h),new Ct(s,h));case le.BOTTOM_LEFT:default:return new _l(new Ct(u,h),new Ct(u-a,h),new Ct(s,t+l),new Ct(s,t))}},Bc=function(s){return[s.topLeftBorderBox,s.topRightBorderBox,s.bottomRightBorderBox,s.bottomLeftBorderBox]},RI=function(s){return[s.topLeftContentBox,s.topRightContentBox,s.bottomRightContentBox,s.bottomLeftContentBox]},yc=function(s){return[s.topLeftPaddingBox,s.topRightPaddingBox,s.bottomRightPaddingBox,s.bottomLeftPaddingBox]},HI=(function(){function s(t,e,i){this.offsetX=t,this.offsetY=e,this.matrix=i,this.type=0,this.target=6}return s})(),xl=(function(){function s(t,e){this.path=t,this.target=e,this.type=1}return s})(),NI=(function(){function s(t){this.opacity=t,this.type=2,this.target=6}return s})(),OI=function(s){return s.type===0},VB=function(s){return s.type===1},VI=function(s){return s.type===2},dw=function(s,t){return s.length===t.length?s.some(function(e,i){return e===t[i]}):!1},WI=function(s,t,e,i,A){return s.map(function(r,a){switch(a){case 0:return r.add(t,e);case 1:return r.add(t+i,e);case 2:return r.add(t+i,e+A);case 3:return r.add(t,e+A)}return r})},WB=(function(){function s(t){this.element=t,this.inlineLevel=[],this.nonInlineLevel=[],this.negativeZIndex=[],this.zeroOrAutoZIndexOrTransformedOrOpacity=[],this.positiveZIndex=[],this.nonPositionedFloats=[],this.nonPositionedInlineLevel=[]}return s})(),KB=(function(){function s(t,e){if(this.container=t,this.parent=e,this.effects=[],this.curves=new LI(this.container),this.container.styles.opacity<1&&this.effects.push(new NI(this.container.styles.opacity)),this.container.styles.transform!==null){var i=this.container.bounds.left+this.container.styles.transformOrigin[0].number,A=this.container.bounds.top+this.container.styles.transformOrigin[1].number,r=this.container.styles.transform;this.effects.push(new HI(i,A,r))}if(this.container.styles.overflowX!==0){var a=Bc(this.curves),l=yc(this.curves);dw(a,l)?this.effects.push(new xl(a,6)):(this.effects.push(new xl(a,2)),this.effects.push(new xl(l,4)))}}return s.prototype.getEffects=function(t){for(var e=[2,3].indexOf(this.container.styles.position)===-1,i=this.parent,A=this.effects.slice(0);i;){var r=i.effects.filter(function(u){return!VB(u)});if(e||i.container.styles.position!==0||!i.parent){if(A.unshift.apply(A,r),e=[2,3].indexOf(i.container.styles.position)===-1,i.container.styles.overflowX!==0){var a=Bc(i.curves),l=yc(i.curves);dw(a,l)||A.unshift(new xl(l,6))}}else A.unshift.apply(A,r);i=i.parent}return A.filter(function(u){return Je(u.target,t)})},s})(),hf=function(s,t,e,i){s.container.elements.forEach(function(A){var r=Je(A.flags,4),a=Je(A.flags,2),l=new KB(A,s);Je(A.styles.display,2048)&&i.push(l);var u=Je(A.flags,8)?[]:i;if(r||a){var h=r||A.styles.isPositioned()?e:t,m=new WB(l);if(A.styles.isPositioned()||A.styles.opacity<1||A.styles.isTransformed()){var g=A.styles.zIndex.order;if(g<0){var w=0;h.negativeZIndex.some(function(y,E){return g>y.element.container.styles.zIndex.order?(w=E,!1):w>0}),h.negativeZIndex.splice(w,0,m)}else if(g>0){var C=0;h.positiveZIndex.some(function(y,E){return g>=y.element.container.styles.zIndex.order?(C=E+1,!1):C>0}),h.positiveZIndex.splice(C,0,m)}else h.zeroOrAutoZIndexOrTransformedOrOpacity.push(m)}else A.styles.isFloating()?h.nonPositionedFloats.push(m):h.nonPositionedInlineLevel.push(m);hf(l,m,r?m:e,u)}else A.styles.isInlineLevel()?t.inlineLevel.push(l):t.nonInlineLevel.push(l),hf(l,t,e,u);Je(A.flags,8)&&GB(A,u)})},GB=function(s,t){for(var e=s instanceof of?s.start:1,i=s instanceof of?s.reversed:!1,A=0;A<t.length;A++){var r=t[A];r.container instanceof FB&&typeof r.container.value=="number"&&r.container.value!==0&&(e=r.container.value),r.listValue=ha(e,r.container.styles.listStyleType,!0),e+=i?-1:1}},KI=function(s){var t=new KB(s,null),e=new WB(t),i=[];return hf(t,e,e,i),GB(t.container,i),e},fw=function(s,t){switch(t){case 0:return cn(s.topLeftBorderBox,s.topLeftPaddingBox,s.topRightBorderBox,s.topRightPaddingBox);case 1:return cn(s.topRightBorderBox,s.topRightPaddingBox,s.bottomRightBorderBox,s.bottomRightPaddingBox);case 2:return cn(s.bottomRightBorderBox,s.bottomRightPaddingBox,s.bottomLeftBorderBox,s.bottomLeftPaddingBox);case 3:default:return cn(s.bottomLeftBorderBox,s.bottomLeftPaddingBox,s.topLeftBorderBox,s.topLeftPaddingBox)}},GI=function(s,t){switch(t){case 0:return cn(s.topLeftBorderBox,s.topLeftBorderDoubleOuterBox,s.topRightBorderBox,s.topRightBorderDoubleOuterBox);case 1:return cn(s.topRightBorderBox,s.topRightBorderDoubleOuterBox,s.bottomRightBorderBox,s.bottomRightBorderDoubleOuterBox);case 2:return cn(s.bottomRightBorderBox,s.bottomRightBorderDoubleOuterBox,s.bottomLeftBorderBox,s.bottomLeftBorderDoubleOuterBox);case 3:default:return cn(s.bottomLeftBorderBox,s.bottomLeftBorderDoubleOuterBox,s.topLeftBorderBox,s.topLeftBorderDoubleOuterBox)}},qI=function(s,t){switch(t){case 0:return cn(s.topLeftBorderDoubleInnerBox,s.topLeftPaddingBox,s.topRightBorderDoubleInnerBox,s.topRightPaddingBox);case 1:return cn(s.topRightBorderDoubleInnerBox,s.topRightPaddingBox,s.bottomRightBorderDoubleInnerBox,s.bottomRightPaddingBox);case 2:return cn(s.bottomRightBorderDoubleInnerBox,s.bottomRightPaddingBox,s.bottomLeftBorderDoubleInnerBox,s.bottomLeftPaddingBox);case 3:default:return cn(s.bottomLeftBorderDoubleInnerBox,s.bottomLeftPaddingBox,s.topLeftBorderDoubleInnerBox,s.topLeftPaddingBox)}},zI=function(s,t){switch(t){case 0:return El(s.topLeftBorderStroke,s.topRightBorderStroke);case 1:return El(s.topRightBorderStroke,s.bottomRightBorderStroke);case 2:return El(s.bottomRightBorderStroke,s.bottomLeftBorderStroke);case 3:default:return El(s.bottomLeftBorderStroke,s.topLeftBorderStroke)}},El=function(s,t){var e=[];return on(s)?e.push(s.subdivide(.5,!1)):e.push(s),on(t)?e.push(t.subdivide(.5,!0)):e.push(t),e},cn=function(s,t,e,i){var A=[];return on(s)?A.push(s.subdivide(.5,!1)):A.push(s),on(e)?A.push(e.subdivide(.5,!0)):A.push(e),on(i)?A.push(i.subdivide(.5,!0).reverse()):A.push(i),on(t)?A.push(t.subdivide(.5,!1).reverse()):A.push(t),A},qB=function(s){var t=s.bounds,e=s.styles;return t.add(e.borderLeftWidth,e.borderTopWidth,-(e.borderRightWidth+e.borderLeftWidth),-(e.borderTopWidth+e.borderBottomWidth))},Cc=function(s){var t=s.styles,e=s.bounds,i=ve(t.paddingLeft,e.width),A=ve(t.paddingRight,e.width),r=ve(t.paddingTop,e.width),a=ve(t.paddingBottom,e.width);return e.add(i+t.borderLeftWidth,r+t.borderTopWidth,-(t.borderRightWidth+t.borderLeftWidth+i+A),-(t.borderTopWidth+t.borderBottomWidth+r+a))},$I=function(s,t){return s===0?t.bounds:s===2?Cc(t):qB(t)},XI=function(s,t){return s===0?t.bounds:s===2?Cc(t):qB(t)},ad=function(s,t,e){var i=$I(rr(s.styles.backgroundOrigin,t),s),A=XI(rr(s.styles.backgroundClip,t),s),r=YI(rr(s.styles.backgroundSize,t),e,i),a=r[0],l=r[1],u=Qo(rr(s.styles.backgroundPosition,t),i.width-a,i.height-l),h=jI(rr(s.styles.backgroundRepeat,t),u,r,i,A),m=Math.round(i.left+u[0]),g=Math.round(i.top+u[1]);return[h,m,g,a,l]},tr=function(s){return he(s)&&s.value===vr.AUTO},Sl=function(s){return typeof s=="number"},YI=function(s,t,e){var i=t[0],A=t[1],r=t[2],a=s[0],l=s[1];if(!a)return[0,0];if(ze(a)&&l&&ze(l))return[ve(a,e.width),ve(l,e.height)];var u=Sl(r);if(he(a)&&(a.value===vr.CONTAIN||a.value===vr.COVER)){if(Sl(r)){var h=e.width/e.height;return h<r!=(a.value===vr.COVER)?[e.width,e.width/r]:[e.height*r,e.height]}return[e.width,e.height]}var m=Sl(i),g=Sl(A),w=m||g;if(tr(a)&&(!l||tr(l))){if(m&&g)return[i,A];if(!u&&!w)return[e.width,e.height];if(w&&u){var C=m?i:A*r,y=g?A:i/r;return[C,y]}var E=m?i:e.width,x=g?A:e.height;return[E,x]}if(u){var T=0,U=0;return ze(a)?T=ve(a,e.width):ze(l)&&(U=ve(l,e.height)),tr(a)?T=U*r:(!l||tr(l))&&(U=T/r),[T,U]}var H=null,R=null;if(ze(a)?H=ve(a,e.width):l&&ze(l)&&(R=ve(l,e.height)),H!==null&&(!l||tr(l))&&(R=m&&g?H/i*A:e.height),R!==null&&tr(a)&&(H=m&&g?R/A*i:e.width),H!==null&&R!==null)return[H,R];throw new Error("Unable to calculate background-size for element")},rr=function(s,t){var e=s[t];return typeof e>"u"?s[0]:e},jI=function(s,t,e,i,A){var r=t[0],a=t[1],l=e[0],u=e[1];switch(s){case 2:return[new Ct(Math.round(i.left),Math.round(i.top+a)),new Ct(Math.round(i.left+i.width),Math.round(i.top+a)),new Ct(Math.round(i.left+i.width),Math.round(u+i.top+a)),new Ct(Math.round(i.left),Math.round(u+i.top+a))];case 3:return[new Ct(Math.round(i.left+r),Math.round(i.top)),new Ct(Math.round(i.left+r+l),Math.round(i.top)),new Ct(Math.round(i.left+r+l),Math.round(i.height+i.top)),new Ct(Math.round(i.left+r),Math.round(i.height+i.top))];case 1:return[new Ct(Math.round(i.left+r),Math.round(i.top+a)),new Ct(Math.round(i.left+r+l),Math.round(i.top+a)),new Ct(Math.round(i.left+r+l),Math.round(i.top+a+u)),new Ct(Math.round(i.left+r),Math.round(i.top+a+u))];default:return[new Ct(Math.round(A.left),Math.round(A.top)),new Ct(Math.round(A.left+A.width),Math.round(A.top)),new Ct(Math.round(A.left+A.width),Math.round(A.height+A.top)),new Ct(Math.round(A.left),Math.round(A.height+A.top))]}},JI="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",pw="Hidden Text",ZI=(function(){function s(t){this._data={},this._document=t}return s.prototype.parseMetrics=function(t,e){var i=this._document.createElement("div"),A=this._document.createElement("img"),r=this._document.createElement("span"),a=this._document.body;i.style.visibility="hidden",i.style.fontFamily=t,i.style.fontSize=e,i.style.margin="0",i.style.padding="0",i.style.whiteSpace="nowrap",a.appendChild(i),A.src=JI,A.width=1,A.height=1,A.style.margin="0",A.style.padding="0",A.style.verticalAlign="baseline",r.style.fontFamily=t,r.style.fontSize=e,r.style.margin="0",r.style.padding="0",r.appendChild(this._document.createTextNode(pw)),i.appendChild(r),i.appendChild(A);var l=A.offsetTop-r.offsetTop+2;i.removeChild(r),i.appendChild(this._document.createTextNode(pw)),i.style.lineHeight="normal",A.style.verticalAlign="super";var u=A.offsetTop-i.offsetTop+2;return a.removeChild(i),{baseline:l,middle:u}},s.prototype.getMetrics=function(t,e){var i=t+" "+e;return typeof this._data[i]>"u"&&(this._data[i]=this.parseMetrics(t,e)),this._data[i]},s})(),zB=(function(){function s(t,e){this.context=t,this.options=e}return s})(),tQ=1e4,eQ=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;return A._activeEffects=[],A.canvas=i.canvas?i.canvas:document.createElement("canvas"),A.ctx=A.canvas.getContext("2d"),i.canvas||(A.canvas.width=Math.floor(i.width*i.scale),A.canvas.height=Math.floor(i.height*i.scale),A.canvas.style.width=i.width+"px",A.canvas.style.height=i.height+"px"),A.fontMetrics=new ZI(document),A.ctx.scale(A.options.scale,A.options.scale),A.ctx.translate(-i.x,-i.y),A.ctx.textBaseline="bottom",A._activeEffects=[],A.context.logger.debug("Canvas renderer initialized ("+i.width+"x"+i.height+") with scale "+i.scale),A}return t.prototype.applyEffects=function(e){for(var i=this;this._activeEffects.length;)this.popEffect();e.forEach(function(A){return i.applyEffect(A)})},t.prototype.applyEffect=function(e){this.ctx.save(),VI(e)&&(this.ctx.globalAlpha=e.opacity),OI(e)&&(this.ctx.translate(e.offsetX,e.offsetY),this.ctx.transform(e.matrix[0],e.matrix[1],e.matrix[2],e.matrix[3],e.matrix[4],e.matrix[5]),this.ctx.translate(-e.offsetX,-e.offsetY)),VB(e)&&(this.path(e.path),this.ctx.clip()),this._activeEffects.push(e)},t.prototype.popEffect=function(){this._activeEffects.pop(),this.ctx.restore()},t.prototype.renderStack=function(e){return Is(this,void 0,void 0,function(){var i;return Bs(this,function(A){switch(A.label){case 0:return i=e.element.container.styles,i.isVisible()?[4,this.renderStackContent(e)]:[3,2];case 1:A.sent(),A.label=2;case 2:return[2]}})})},t.prototype.renderNode=function(e){return Is(this,void 0,void 0,function(){return Bs(this,function(i){switch(i.label){case 0:if(Je(e.container.flags,16))debugger;return e.container.styles.isVisible()?[4,this.renderNodeBackgroundAndBorders(e)]:[3,3];case 1:return i.sent(),[4,this.renderNodeContent(e)];case 2:i.sent(),i.label=3;case 3:return[2]}})})},t.prototype.renderTextWithLetterSpacing=function(e,i,A){var r=this;if(i===0)this.ctx.fillText(e.text,e.bounds.left,e.bounds.top+A);else{var a=sp(e.text);a.reduce(function(l,u){return r.ctx.fillText(u,l,e.bounds.top+A),l+r.ctx.measureText(u).width},e.bounds.left)}},t.prototype.createFontStyle=function(e){var i=e.fontVariant.filter(function(a){return a==="normal"||a==="small-caps"}).join(""),A=rQ(e.fontFamily).join(", "),r=ba(e.fontSize)?""+e.fontSize.number+e.fontSize.unit:e.fontSize.number+"px";return[[e.fontStyle,i,e.fontWeight,r,A].join(" "),A,r]},t.prototype.renderTextNode=function(e,i){return Is(this,void 0,void 0,function(){var A,r,a,l,u,h,m,g,w=this;return Bs(this,function(C){return A=this.createFontStyle(i),r=A[0],a=A[1],l=A[2],this.ctx.font=r,this.ctx.direction=i.direction===1?"rtl":"ltr",this.ctx.textAlign="left",this.ctx.textBaseline="alphabetic",u=this.fontMetrics.getMetrics(a,l),h=u.baseline,m=u.middle,g=i.paintOrder,e.textBounds.forEach(function(y){g.forEach(function(E){switch(E){case 0:w.ctx.fillStyle=ns(i.color),w.renderTextWithLetterSpacing(y,i.letterSpacing,h);var x=i.textShadow;x.length&&y.text.trim().length&&(x.slice(0).reverse().forEach(function(T){w.ctx.shadowColor=ns(T.color),w.ctx.shadowOffsetX=T.offsetX.number*w.options.scale,w.ctx.shadowOffsetY=T.offsetY.number*w.options.scale,w.ctx.shadowBlur=T.blur.number,w.renderTextWithLetterSpacing(y,i.letterSpacing,h)}),w.ctx.shadowColor="",w.ctx.shadowOffsetX=0,w.ctx.shadowOffsetY=0,w.ctx.shadowBlur=0),i.textDecorationLine.length&&(w.ctx.fillStyle=ns(i.textDecorationColor||i.color),i.textDecorationLine.forEach(function(T){switch(T){case 1:w.ctx.fillRect(y.bounds.left,Math.round(y.bounds.top+h),y.bounds.width,1);break;case 2:w.ctx.fillRect(y.bounds.left,Math.round(y.bounds.top),y.bounds.width,1);break;case 3:w.ctx.fillRect(y.bounds.left,Math.ceil(y.bounds.top+m),y.bounds.width,1);break}}));break;case 1:i.webkitTextStrokeWidth&&y.text.trim().length&&(w.ctx.strokeStyle=ns(i.webkitTextStrokeColor),w.ctx.lineWidth=i.webkitTextStrokeWidth,w.ctx.lineJoin=window.chrome?"miter":"round",w.ctx.strokeText(y.text,y.bounds.left,y.bounds.top+h)),w.ctx.strokeStyle="",w.ctx.lineWidth=0,w.ctx.lineJoin="miter";break}})}),[2]})})},t.prototype.renderReplacedElement=function(e,i,A){if(A&&e.intrinsicWidth>0&&e.intrinsicHeight>0){var r=Cc(e),a=yc(i);this.path(a),this.ctx.save(),this.ctx.clip(),this.ctx.drawImage(A,0,0,e.intrinsicWidth,e.intrinsicHeight,r.left,r.top,r.width,r.height),this.ctx.restore()}},t.prototype.renderNodeContent=function(e){return Is(this,void 0,void 0,function(){var i,A,r,a,l,u,U,U,h,m,g,w,R,C,y,D,E,x,T,U,H,R,D;return Bs(this,function(P){switch(P.label){case 0:this.applyEffects(e.getEffects(4)),i=e.container,A=e.curves,r=i.styles,a=0,l=i.textNodes,P.label=1;case 1:return a<l.length?(u=l[a],[4,this.renderTextNode(u,r)]):[3,4];case 2:P.sent(),P.label=3;case 3:return a++,[3,1];case 4:if(!(i instanceof xB))return[3,8];P.label=5;case 5:return P.trys.push([5,7,,8]),[4,this.context.cache.match(i.src)];case 6:return U=P.sent(),this.renderReplacedElement(i,A,U),[3,8];case 7:return P.sent(),this.context.logger.error("Error loading image "+i.src),[3,8];case 8:if(i instanceof EB&&this.renderReplacedElement(i,A,i.canvas),!(i instanceof SB))return[3,12];P.label=9;case 9:return P.trys.push([9,11,,12]),[4,this.context.cache.match(i.svg)];case 10:return U=P.sent(),this.renderReplacedElement(i,A,U),[3,12];case 11:return P.sent(),this.context.logger.error("Error loading svg "+i.svg.substring(0,255)),[3,12];case 12:return i instanceof QB&&i.tree?(h=new t(this.context,{scale:this.options.scale,backgroundColor:i.backgroundColor,x:0,y:0,width:i.width,height:i.height}),[4,h.render(i.tree)]):[3,14];case 13:m=P.sent(),i.width&&i.height&&this.ctx.drawImage(m,0,0,i.width,i.height,i.bounds.left,i.bounds.top,i.bounds.width,i.bounds.height),P.label=14;case 14:if(i instanceof np&&(g=Math.min(i.bounds.width,i.bounds.height),i.type===mc?i.checked&&(this.ctx.save(),this.path([new Ct(i.bounds.left+g*.39363,i.bounds.top+g*.79),new Ct(i.bounds.left+g*.16,i.bounds.top+g*.5549),new Ct(i.bounds.left+g*.27347,i.bounds.top+g*.44071),new Ct(i.bounds.left+g*.39694,i.bounds.top+g*.5649),new Ct(i.bounds.left+g*.72983,i.bounds.top+g*.23),new Ct(i.bounds.left+g*.84,i.bounds.top+g*.34085),new Ct(i.bounds.left+g*.39363,i.bounds.top+g*.79)]),this.ctx.fillStyle=ns(sw),this.ctx.fill(),this.ctx.restore()):i.type===gc&&i.checked&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(i.bounds.left+g/2,i.bounds.top+g/2,g/4,0,Math.PI*2,!0),this.ctx.fillStyle=ns(sw),this.ctx.fill(),this.ctx.restore())),sQ(i)&&i.value.length){switch(w=this.createFontStyle(r),R=w[0],C=w[1],y=this.fontMetrics.getMetrics(R,C).baseline,this.ctx.font=R,this.ctx.fillStyle=ns(r.color),this.ctx.textBaseline="alphabetic",this.ctx.textAlign=iQ(i.styles.textAlign),D=Cc(i),E=0,i.styles.textAlign){case 1:E+=D.width/2;break;case 2:E+=D.width;break}x=D.add(E,0,0,-D.height/2+1),this.ctx.save(),this.path([new Ct(D.left,D.top),new Ct(D.left+D.width,D.top),new Ct(D.left+D.width,D.top+D.height),new Ct(D.left,D.top+D.height)]),this.ctx.clip(),this.renderTextWithLetterSpacing(new qo(i.value,x),r.letterSpacing,y),this.ctx.restore(),this.ctx.textBaseline="alphabetic",this.ctx.textAlign="left"}if(!Je(i.styles.display,2048))return[3,20];if(i.styles.listStyleImage===null)return[3,19];if(T=i.styles.listStyleImage,T.type!==0)return[3,18];U=void 0,H=T.url,P.label=15;case 15:return P.trys.push([15,17,,18]),[4,this.context.cache.match(H)];case 16:return U=P.sent(),this.ctx.drawImage(U,i.bounds.left-(U.width+10),i.bounds.top),[3,18];case 17:return P.sent(),this.context.logger.error("Error loading list-style-image "+H),[3,18];case 18:return[3,20];case 19:e.listValue&&i.styles.listStyleType!==-1&&(R=this.createFontStyle(r)[0],this.ctx.font=R,this.ctx.fillStyle=ns(r.color),this.ctx.textBaseline="middle",this.ctx.textAlign="right",D=new ui(i.bounds.left,i.bounds.top+ve(i.styles.paddingTop,i.bounds.width),i.bounds.width,Hg(r.lineHeight,r.fontSize.number)/2+1),this.renderTextWithLetterSpacing(new qo(e.listValue,D),r.letterSpacing,Hg(r.lineHeight,r.fontSize.number)/2+2),this.ctx.textBaseline="bottom",this.ctx.textAlign="left"),P.label=20;case 20:return[2]}})})},t.prototype.renderStackContent=function(e){return Is(this,void 0,void 0,function(){var i,A,T,r,a,T,l,u,T,h,m,T,g,w,T,C,y,T,E,x,T;return Bs(this,function(U){switch(U.label){case 0:if(Je(e.element.container.flags,16))debugger;return[4,this.renderNodeBackgroundAndBorders(e.element)];case 1:U.sent(),i=0,A=e.negativeZIndex,U.label=2;case 2:return i<A.length?(T=A[i],[4,this.renderStack(T)]):[3,5];case 3:U.sent(),U.label=4;case 4:return i++,[3,2];case 5:return[4,this.renderNodeContent(e.element)];case 6:U.sent(),r=0,a=e.nonInlineLevel,U.label=7;case 7:return r<a.length?(T=a[r],[4,this.renderNode(T)]):[3,10];case 8:U.sent(),U.label=9;case 9:return r++,[3,7];case 10:l=0,u=e.nonPositionedFloats,U.label=11;case 11:return l<u.length?(T=u[l],[4,this.renderStack(T)]):[3,14];case 12:U.sent(),U.label=13;case 13:return l++,[3,11];case 14:h=0,m=e.nonPositionedInlineLevel,U.label=15;case 15:return h<m.length?(T=m[h],[4,this.renderStack(T)]):[3,18];case 16:U.sent(),U.label=17;case 17:return h++,[3,15];case 18:g=0,w=e.inlineLevel,U.label=19;case 19:return g<w.length?(T=w[g],[4,this.renderNode(T)]):[3,22];case 20:U.sent(),U.label=21;case 21:return g++,[3,19];case 22:C=0,y=e.zeroOrAutoZIndexOrTransformedOrOpacity,U.label=23;case 23:return C<y.length?(T=y[C],[4,this.renderStack(T)]):[3,26];case 24:U.sent(),U.label=25;case 25:return C++,[3,23];case 26:E=0,x=e.positiveZIndex,U.label=27;case 27:return E<x.length?(T=x[E],[4,this.renderStack(T)]):[3,30];case 28:U.sent(),U.label=29;case 29:return E++,[3,27];case 30:return[2]}})})},t.prototype.mask=function(e){this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo(this.canvas.width,0),this.ctx.lineTo(this.canvas.width,this.canvas.height),this.ctx.lineTo(0,this.canvas.height),this.ctx.lineTo(0,0),this.formatPath(e.slice(0).reverse()),this.ctx.closePath()},t.prototype.path=function(e){this.ctx.beginPath(),this.formatPath(e),this.ctx.closePath()},t.prototype.formatPath=function(e){var i=this;e.forEach(function(A,r){var a=on(A)?A.start:A;r===0?i.ctx.moveTo(a.x,a.y):i.ctx.lineTo(a.x,a.y),on(A)&&i.ctx.bezierCurveTo(A.startControl.x,A.startControl.y,A.endControl.x,A.endControl.y,A.end.x,A.end.y)})},t.prototype.renderRepeat=function(e,i,A,r){this.path(e),this.ctx.fillStyle=i,this.ctx.translate(A,r),this.ctx.fill(),this.ctx.translate(-A,-r)},t.prototype.resizeImage=function(e,i,A){var r;if(e.width===i&&e.height===A)return e;var a=(r=this.canvas.ownerDocument)!==null&&r!==void 0?r:document,l=a.createElement("canvas");l.width=Math.max(1,i),l.height=Math.max(1,A);var u=l.getContext("2d");return u.drawImage(e,0,0,e.width,e.height,0,0,i,A),l},t.prototype.renderBackgroundImage=function(e){return Is(this,void 0,void 0,function(){var i,A,r,a,l,u;return Bs(this,function(h){switch(h.label){case 0:i=e.styles.backgroundImage.length-1,A=function(m){var g,w,C,at,ct,J,X,nt,Y,y,at,ct,J,X,nt,E,x,T,U,H,R,D,P,G,Y,W,at,Bt,dt,X,nt,mt,ct,J,st,At,vt,ft,Mt,Pt,Nt,Wt;return Bs(this,function(Qt){switch(Qt.label){case 0:if(m.type!==0)return[3,5];g=void 0,w=m.url,Qt.label=1;case 1:return Qt.trys.push([1,3,,4]),[4,r.context.cache.match(w)];case 2:return g=Qt.sent(),[3,4];case 3:return Qt.sent(),r.context.logger.error("Error loading background-image "+w),[3,4];case 4:return g&&(C=ad(e,i,[g.width,g.height,g.width/g.height]),at=C[0],ct=C[1],J=C[2],X=C[3],nt=C[4],Y=r.ctx.createPattern(r.resizeImage(g,X,nt),"repeat"),r.renderRepeat(at,Y,ct,J)),[3,6];case 5:O1(m)?(y=ad(e,i,[null,null,null]),at=y[0],ct=y[1],J=y[2],X=y[3],nt=y[4],E=k1(m.angle,X,nt),x=E[0],T=E[1],U=E[2],H=E[3],R=E[4],D=document.createElement("canvas"),D.width=X,D.height=nt,P=D.getContext("2d"),G=P.createLinearGradient(T,H,U,R),Lg(m.stops,x).forEach(function(Et){return G.addColorStop(Et.stop,ns(Et.color))}),P.fillStyle=G,P.fillRect(0,0,X,nt),X>0&&nt>0&&(Y=r.ctx.createPattern(D,"repeat"),r.renderRepeat(at,Y,ct,J))):V1(m)&&(W=ad(e,i,[null,null,null]),at=W[0],Bt=W[1],dt=W[2],X=W[3],nt=W[4],mt=m.position.length===0?[Zf]:m.position,ct=ve(mt[0],X),J=ve(mt[mt.length-1],nt),st=L1(m,ct,J,X,nt),At=st[0],vt=st[1],At>0&&vt>0&&(ft=r.ctx.createRadialGradient(Bt+ct,dt+J,0,Bt+ct,dt+J,At),Lg(m.stops,At*2).forEach(function(Et){return ft.addColorStop(Et.stop,ns(Et.color))}),r.path(at),r.ctx.fillStyle=ft,At!==vt?(Mt=e.bounds.left+.5*e.bounds.width,Pt=e.bounds.top+.5*e.bounds.height,Nt=vt/At,Wt=1/Nt,r.ctx.save(),r.ctx.translate(Mt,Pt),r.ctx.transform(1,0,0,Nt,0,0),r.ctx.translate(-Mt,-Pt),r.ctx.fillRect(Bt,Wt*(dt-Pt)+Pt,X,nt*Wt),r.ctx.restore()):r.ctx.fill())),Qt.label=6;case 6:return i--,[2]}})},r=this,a=0,l=e.styles.backgroundImage.slice(0).reverse(),h.label=1;case 1:return a<l.length?(u=l[a],[5,A(u)]):[3,4];case 2:h.sent(),h.label=3;case 3:return a++,[3,1];case 4:return[2]}})})},t.prototype.renderSolidBorder=function(e,i,A){return Is(this,void 0,void 0,function(){return Bs(this,function(r){return this.path(fw(A,i)),this.ctx.fillStyle=ns(e),this.ctx.fill(),[2]})})},t.prototype.renderDoubleBorder=function(e,i,A,r){return Is(this,void 0,void 0,function(){var a,l;return Bs(this,function(u){switch(u.label){case 0:return i<3?[4,this.renderSolidBorder(e,A,r)]:[3,2];case 1:return u.sent(),[2];case 2:return a=GI(r,A),this.path(a),this.ctx.fillStyle=ns(e),this.ctx.fill(),l=qI(r,A),this.path(l),this.ctx.fill(),[2]}})})},t.prototype.renderNodeBackgroundAndBorders=function(e){return Is(this,void 0,void 0,function(){var i,A,r,a,l,u,h,m,g=this;return Bs(this,function(w){switch(w.label){case 0:return this.applyEffects(e.getEffects(2)),i=e.container.styles,A=!Vi(i.backgroundColor)||i.backgroundImage.length,r=[{style:i.borderTopStyle,color:i.borderTopColor,width:i.borderTopWidth},{style:i.borderRightStyle,color:i.borderRightColor,width:i.borderRightWidth},{style:i.borderBottomStyle,color:i.borderBottomColor,width:i.borderBottomWidth},{style:i.borderLeftStyle,color:i.borderLeftColor,width:i.borderLeftWidth}],a=nQ(rr(i.backgroundClip,0),e.curves),A||i.boxShadow.length?(this.ctx.save(),this.path(a),this.ctx.clip(),Vi(i.backgroundColor)||(this.ctx.fillStyle=ns(i.backgroundColor),this.ctx.fill()),[4,this.renderBackgroundImage(e.container)]):[3,2];case 1:w.sent(),this.ctx.restore(),i.boxShadow.slice(0).reverse().forEach(function(C){g.ctx.save();var y=Bc(e.curves),E=C.inset?0:tQ,x=WI(y,-E+(C.inset?1:-1)*C.spread.number,(C.inset?1:-1)*C.spread.number,C.spread.number*(C.inset?-2:2),C.spread.number*(C.inset?-2:2));C.inset?(g.path(y),g.ctx.clip(),g.mask(x)):(g.mask(y),g.ctx.clip(),g.path(x)),g.ctx.shadowOffsetX=C.offsetX.number+E,g.ctx.shadowOffsetY=C.offsetY.number,g.ctx.shadowColor=ns(C.color),g.ctx.shadowBlur=C.blur.number,g.ctx.fillStyle=C.inset?ns(C.color):"rgba(0,0,0,1)",g.ctx.fill(),g.ctx.restore()}),w.label=2;case 2:l=0,u=0,h=r,w.label=3;case 3:return u<h.length?(m=h[u],m.style!==0&&!Vi(m.color)&&m.width>0?m.style!==2?[3,5]:[4,this.renderDashedDottedBorder(m.color,m.width,l,e.curves,2)]:[3,11]):[3,13];case 4:return w.sent(),[3,11];case 5:return m.style!==3?[3,7]:[4,this.renderDashedDottedBorder(m.color,m.width,l,e.curves,3)];case 6:return w.sent(),[3,11];case 7:return m.style!==4?[3,9]:[4,this.renderDoubleBorder(m.color,m.width,l,e.curves)];case 8:return w.sent(),[3,11];case 9:return[4,this.renderSolidBorder(m.color,l,e.curves)];case 10:w.sent(),w.label=11;case 11:l++,w.label=12;case 12:return u++,[3,3];case 13:return[2]}})})},t.prototype.renderDashedDottedBorder=function(e,i,A,r,a){return Is(this,void 0,void 0,function(){var l,u,h,m,g,w,C,y,E,x,T,U,H,R,D,P,D,P;return Bs(this,function(G){return this.ctx.save(),l=zI(r,A),u=fw(r,A),a===2&&(this.path(u),this.ctx.clip()),on(u[0])?(h=u[0].start.x,m=u[0].start.y):(h=u[0].x,m=u[0].y),on(u[1])?(g=u[1].end.x,w=u[1].end.y):(g=u[1].x,w=u[1].y),A===0||A===2?C=Math.abs(h-g):C=Math.abs(m-w),this.ctx.beginPath(),a===3?this.formatPath(l):this.formatPath(u.slice(0,2)),y=i<3?i*3:i*2,E=i<3?i*2:i,a===3&&(y=i,E=i),x=!0,C<=y*2?x=!1:C<=y*2+E?(T=C/(2*y+E),y*=T,E*=T):(U=Math.floor((C+E)/(y+E)),H=(C-U*y)/(U-1),R=(C-(U+1)*y)/U,E=R<=0||Math.abs(E-H)<Math.abs(E-R)?H:R),x&&(a===3?this.ctx.setLineDash([0,y+E]):this.ctx.setLineDash([y,E])),a===3?(this.ctx.lineCap="round",this.ctx.lineWidth=i):this.ctx.lineWidth=i*2+1.1,this.ctx.strokeStyle=ns(e),this.ctx.stroke(),this.ctx.setLineDash([]),a===2&&(on(u[0])&&(D=u[3],P=u[0],this.ctx.beginPath(),this.formatPath([new Ct(D.end.x,D.end.y),new Ct(P.start.x,P.start.y)]),this.ctx.stroke()),on(u[1])&&(D=u[1],P=u[2],this.ctx.beginPath(),this.formatPath([new Ct(D.end.x,D.end.y),new Ct(P.start.x,P.start.y)]),this.ctx.stroke())),this.ctx.restore(),[2]})})},t.prototype.render=function(e){return Is(this,void 0,void 0,function(){var i;return Bs(this,function(A){switch(A.label){case 0:return this.options.backgroundColor&&(this.ctx.fillStyle=ns(this.options.backgroundColor),this.ctx.fillRect(this.options.x,this.options.y,this.options.width,this.options.height)),i=KI(e),[4,this.renderStack(i)];case 1:return A.sent(),this.applyEffects([]),[2,this.canvas]}})})},t})(zB),sQ=function(s){return s instanceof IB||s instanceof TB?!0:s instanceof np&&s.type!==gc&&s.type!==mc},nQ=function(s,t){switch(s){case 0:return Bc(t);case 2:return RI(t);case 1:default:return yc(t)}},iQ=function(s){switch(s){case 1:return"center";case 2:return"right";case 0:default:return"left"}},AQ=["-apple-system","system-ui"],rQ=function(s){return/iPhone OS 15_(0|1)/.test(window.navigator.userAgent)?s.filter(function(t){return AQ.indexOf(t)===-1}):s},oQ=(function(s){In(t,s);function t(e,i){var A=s.call(this,e,i)||this;return A.canvas=i.canvas?i.canvas:document.createElement("canvas"),A.ctx=A.canvas.getContext("2d"),A.options=i,A.canvas.width=Math.floor(i.width*i.scale),A.canvas.height=Math.floor(i.height*i.scale),A.canvas.style.width=i.width+"px",A.canvas.style.height=i.height+"px",A.ctx.scale(A.options.scale,A.options.scale),A.ctx.translate(-i.x,-i.y),A.context.logger.debug("EXPERIMENTAL ForeignObject renderer initialized ("+i.width+"x"+i.height+" at "+i.x+","+i.y+") with scale "+i.scale),A}return t.prototype.render=function(e){return Is(this,void 0,void 0,function(){var i,A;return Bs(this,function(r){switch(r.label){case 0:return i=rf(this.options.width*this.options.scale,this.options.height*this.options.scale,this.options.scale,this.options.scale,e),[4,aQ(i)];case 1:return A=r.sent(),this.options.backgroundColor&&(this.ctx.fillStyle=ns(this.options.backgroundColor),this.ctx.fillRect(0,0,this.options.width*this.options.scale,this.options.height*this.options.scale)),this.ctx.drawImage(A,-this.options.x*this.options.scale,-this.options.y*this.options.scale),[2,this.canvas]}})})},t})(zB),aQ=function(s){return new Promise(function(t,e){var i=new Image;i.onload=function(){t(i)},i.onerror=e,i.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(new XMLSerializer().serializeToString(s))})},lQ=(function(){function s(t){var e=t.id,i=t.enabled;this.id=e,this.enabled=i,this.start=Date.now()}return s.prototype.debug=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.debug=="function"?console.debug.apply(console,Al([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},s.prototype.getTime=function(){return Date.now()-this.start},s.prototype.info=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&typeof window<"u"&&window.console&&typeof console.info=="function"&&console.info.apply(console,Al([this.id,this.getTime()+"ms"],t))},s.prototype.warn=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.warn=="function"?console.warn.apply(console,Al([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},s.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];this.enabled&&(typeof window<"u"&&window.console&&typeof console.error=="function"?console.error.apply(console,Al([this.id,this.getTime()+"ms"],t)):this.info.apply(this,t))},s.instances={},s})(),cQ=(function(){function s(t,e){var i;this.windowBounds=e,this.instanceName="#"+s.instanceCount++,this.logger=new lQ({id:this.instanceName,enabled:t.logging}),this.cache=(i=t.cache)!==null&&i!==void 0?i:new II(this,t)}return s.instanceCount=1,s})(),uQ=function(s,t){return t===void 0&&(t={}),hQ(s,t)};typeof window<"u"&&OB.setContext(window);var hQ=function(s,t){return Is(void 0,void 0,void 0,function(){var e,i,A,r,a,l,u,h,m,g,w,C,y,E,x,T,U,H,R,D,G,P,G,Y,W,at,Bt,dt,X,nt,mt,ct,J,st,At,vt,ft,Mt,Pt,Nt;return Bs(this,function(Wt){switch(Wt.label){case 0:if(!s||typeof s!="object")return[2,Promise.reject("Invalid element provided as first argument")];if(e=s.ownerDocument,!e)throw new Error("Element is not attached to a Document");if(i=e.defaultView,!i)throw new Error("Document is not attached to a Window");return A={allowTaint:(Y=t.allowTaint)!==null&&Y!==void 0?Y:!1,imageTimeout:(W=t.imageTimeout)!==null&&W!==void 0?W:15e3,proxy:t.proxy,useCORS:(at=t.useCORS)!==null&&at!==void 0?at:!1},r=Kd({logging:(Bt=t.logging)!==null&&Bt!==void 0?Bt:!0,cache:t.cache},A),a={windowWidth:(dt=t.windowWidth)!==null&&dt!==void 0?dt:i.innerWidth,windowHeight:(X=t.windowHeight)!==null&&X!==void 0?X:i.innerHeight,scrollX:(nt=t.scrollX)!==null&&nt!==void 0?nt:i.pageXOffset,scrollY:(mt=t.scrollY)!==null&&mt!==void 0?mt:i.pageYOffset},l=new ui(a.scrollX,a.scrollY,a.windowWidth,a.windowHeight),u=new cQ(r,l),h=(ct=t.foreignObjectRendering)!==null&&ct!==void 0?ct:!1,m={allowTaint:(J=t.allowTaint)!==null&&J!==void 0?J:!1,onclone:t.onclone,ignoreElements:t.ignoreElements,inlineImages:h,copyStyles:h},u.logger.debug("Starting document clone with size "+l.width+"x"+l.height+" scrolled to "+-l.left+","+-l.top),g=new uw(u,s,m),w=g.clonedReferenceElement,w?[4,g.toIFrame(e,l)]:[2,Promise.reject("Unable to find element in cloned iframe")];case 1:return C=Wt.sent(),y=ip(w)||dI(w)?WE(w.ownerDocument):Nc(u,w),E=y.width,x=y.height,T=y.left,U=y.top,H=dQ(u,w,t.backgroundColor),R={canvas:t.canvas,backgroundColor:H,scale:(At=(st=t.scale)!==null&&st!==void 0?st:i.devicePixelRatio)!==null&&At!==void 0?At:1,x:((vt=t.x)!==null&&vt!==void 0?vt:0)+T,y:((ft=t.y)!==null&&ft!==void 0?ft:0)+U,width:(Mt=t.width)!==null&&Mt!==void 0?Mt:Math.ceil(E),height:(Pt=t.height)!==null&&Pt!==void 0?Pt:Math.ceil(x)},h?(u.logger.debug("Document cloned, using foreign object rendering"),G=new oQ(u,R),[4,G.render(w)]):[3,3];case 2:return D=Wt.sent(),[3,5];case 3:return u.logger.debug("Document cloned, element located at "+T+","+U+" with size "+E+"x"+x+" using computed rendering"),u.logger.debug("Starting DOM parsing"),P=UB(u,w),H===P.styles.backgroundColor&&(P.styles.backgroundColor=ci.TRANSPARENT),u.logger.debug("Starting renderer for element at "+R.x+","+R.y+" with size "+R.width+"x"+R.height),G=new eQ(u,R),[4,G.render(P)];case 4:D=Wt.sent(),Wt.label=5;case 5:return(!((Nt=t.removeContainer)!==null&&Nt!==void 0)||Nt)&&(uw.destroy(C)||u.logger.error("Cannot detach cloned iframe as it is not in the DOM anymore")),u.logger.debug("Finished rendering"),[2,D]}})})},dQ=function(s,t,e){var i=t.ownerDocument,A=i.documentElement?Ko(s,getComputedStyle(i.documentElement).backgroundColor):ci.TRANSPARENT,r=i.body?Ko(s,getComputedStyle(i.body).backgroundColor):ci.TRANSPARENT,a=typeof e=="string"?Ko(s,e):e===null?ci.TRANSPARENT:4294967295;return t===i.documentElement?Vi(A)?Vi(r)?a:r:A:a};const $o={},Ii={},fQ=600;async function pQ(s,t){const e=document.getElementById("button-grid");if(!e)return b.warn("PrintService","Button grid element not found",null,"print"),null;const i=e.querySelector(".button-grid-left-cell"),A=e.querySelector(".button-grid-right-cell"),r=[],a=(l,u)=>{!l||!u||(r.push({el:l,display:l.style.display}),l.style.display="none")};a(i,!s),a(A,!t);try{const l=Math.min(window.devicePixelRatio||1,2),u=await uQ(e,{scale:l,backgroundColor:"#ffffff",logging:!1,useCORS:!0}),h=BQ(u);return b.debug("PrintService",`Captured button grid: ${h.width}x${h.height}`,null,"print"),h}catch(l){return b.error("PrintService","Failed to capture button grid",l,"print"),null}finally{r.forEach(({el:l,display:u})=>{l.style.display=u})}}function mQ(s,t){const e=document.getElementById("notation-grid"),i=document.getElementById("pitch-paint-canvas"),A=document.getElementById("legend-left-canvas"),r=document.getElementById("legend-right-canvas");if(!e)return b.warn("PrintService","Notation grid canvas not found",null,"print"),null;const a=s&&A?A.width:0,l=t&&r?r.width:0,u=a+e.width+l,h=a,m=document.createElement("canvas");m.width=u,m.height=e.height;const g=m.getContext("2d");return s&&A&&a>0&&g.drawImage(A,0,0),g.drawImage(e,h,0),i&&i.width>0&&i.height>0&&(g.drawImage(i,h,0),b.debug("PrintService","Included paint layer in capture",null,"print")),t&&r&&l>0&&g.drawImage(r,h+e.width,0),b.debug("PrintService",`Captured pitch grid: ${m.width}x${m.height}`,null,"print"),m}function gQ(s,t){const e=document.getElementById("drum-grid"),i=document.querySelector(".drum-grid-left-cell"),A=document.querySelector(".drum-grid-right-cell");if(!e||e.width===0)return b.debug("PrintService","Drum grid not found or empty",null,"print"),null;const r=e.offsetWidth?e.width/e.offsetWidth:1,a=s?Math.max(0,Math.round(((i==null?void 0:i.offsetWidth)||0)*r)):0,l=t?Math.max(0,Math.round(((A==null?void 0:A.offsetWidth)||0)*r)):0,u=a+e.width+l,h=getComputedStyle(document.documentElement).getPropertyValue("--c-surface")||"#ffffff",m=document.createElement("canvas");m.width=u,m.height=e.height;const g=m.getContext("2d");return g.fillStyle=h.trim()||"#ffffff",g.fillRect(0,0,u,e.height),g.drawImage(e,a,0),b.debug("PrintService",`Captured drum grid: ${m.width}x${m.height}`,null,"print"),m}function wQ(s){const t=document.createElement("canvas");t.width=s.width,t.height=s.height;const e=t.getContext("2d");e.drawImage(s,0,0);const i=e.getImageData(0,0,t.width,t.height),A=i.data;for(let r=0;r<A.length;r+=4){const a=A[r]*.299+A[r+1]*.587+A[r+2]*.114;A[r]=a,A[r+1]=a,A[r+2]=a}return e.putImageData(i,0,0),t}async function vQ(s,t){b.debug("PrintService","Generating score canvas...",{printOptions:s,targetDimensions:t},"print");const e=[],i=await $B(s.includeLeftLegend,s.includeRightLegend);i&&e.push({canvas:i,name:"buttons"});const A=mQ(s.includeLeftLegend,s.includeRightLegend);A&&e.push({canvas:A,name:"pitch"});const r=gQ(s.includeLeftLegend,s.includeRightLegend);if(r&&e.push({canvas:r,name:"drums"}),e.length===0)return b.warn("PrintService","No content captured for printing",null,"print"),null;s.colorMode==="bw"&&(e.forEach(P=>{P.canvas=wQ(P.canvas)}),b.debug("PrintService","Applied black & white filter",null,"print"));const a=Math.max(...e.map(P=>P.canvas.width)),l=e.reduce((P,G)=>P+G.canvas.height,0),u=s.cropTop||0,h=s.cropBottom||1,m=s.cropLeft||0,g=s.cropRight||1,w=l*(h-u),C=a*(g-m),y=l*u,E=a*m;b.debug("PrintService",`Applying crop: top=${u.toFixed(2)}, bottom=${h.toFixed(2)}, left=${m.toFixed(2)}, right=${g.toFixed(2)}`,null,"print");const x=Math.min(t.width/C,t.height/w),T=document.createElement("canvas");T.width=C*x,T.height=w*x;const U=T.getContext("2d");U.fillStyle="#FFFFFF",U.fillRect(0,0,T.width,T.height);const H=document.createElement("canvas");H.width=a,H.height=l;const R=H.getContext("2d");let D=0;return e.forEach(({canvas:P,name:G})=>{R.drawImage(P,0,D),b.debug("PrintService",`Drew ${G} at y=${D}, height=${P.height}`,null,"print"),D+=P.height}),U.drawImage(H,E,y,C,w,0,0,T.width,T.height),b.debug("PrintService",`Generated composite canvas: ${T.width}x${T.height}`,null,"print"),T}const $l={generateScoreCanvas:vQ,async generateAndPrint(){const s=d.state.printOptions,t=300,e=(s.orientation==="landscape"?10.5:8)*t,i=(s.orientation==="landscape"?8:10.5)*t;b.info("PrintService","Generating print canvas at high resolution",{width:e,height:i,options:s},"print");const A=await this.generateScoreCanvas(s,{width:e,height:i});if(!A){b.error("PrintService","Failed to generate print canvas",null,"print");return}const r=document.getElementById("print-staging-area");r.innerHTML="";const a=document.getElementById("print-style-rules");a.textContent=`@page { size: ${s.orientation}; margin: 0.25in; }`;const l=document.createElement("img");l.src=A.toDataURL("image/png"),l.style.width="100%",l.style.height="auto",r.appendChild(l),b.info("PrintService","Opening print dialog",null,"print"),setTimeout(()=>window.print(),100)},async prefetchButtonGridSnapshot(s=!0,t=!0){try{await $B(s,t)}catch(e){b.warn("PrintService","Button grid prefetch failed",e,"print")}},invalidateButtonGridSnapshot(){XB()}};function BQ(s){if(!s)return s;const t=document.getElementById("notation-grid"),e=(t==null?void 0:t.width)||s.width;if(!e||e===s.width)return s;const i=e/s.width,A=Math.max(1,Math.round(s.height*i)),r=document.createElement("canvas");return r.width=e,r.height=A,(r.getContext("2d",{willReadFrequently:!0})||r.getContext("2d")).drawImage(s,0,0,r.width,r.height),r}async function $B(s,t){const e=`${s}-${t}`;return $o[e]!==void 0?$o[e]??null:(Ii[e]||(Ii[e]=(async()=>{await yQ();const i=await pQ(s,t);return $o[e]=i,Ii[e]=null,i})().catch(i=>{throw Ii[e]=null,i})),Ii[e])}function yQ(){return new Promise(s=>{typeof window.requestIdleCallback=="function"?requestIdleCallback(()=>s(),{timeout:fQ}):requestAnimationFrame(()=>s())})}function XB(){Object.keys($o).forEach(s=>{delete $o[s]}),Object.keys(Ii).forEach(s=>{delete Ii[s]})}typeof window<"u"&&window.addEventListener("resize",()=>XB());function qn(s,t){if(!s)return`rgba(204, 204, 204, ${t})`;const e=parseInt(s.slice(nv,Dm),Hl),i=parseInt(s.slice(Dm,km),Hl),A=parseInt(s.slice(km,Nb),Hl);return`rgba(${e}, ${i}, ${A}, ${t})`}function Yc(s,t){if(!s||typeof s!="string")return Hb;const e=parseInt(s.slice(nv),Hl),i=t<0?Ob:Vb,A=t<0?t*-1:t,r=e>>16,a=e>>8&255,l=e&255;return"#"+(16777216+(Math.round((i-r)*A)+r)*65536+(Math.round((i-a)*A)+a)*256+(Math.round((i-l)*A)+l)).toString(16).slice(1)}const CQ=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor"/>\r
</svg>`,bQ=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(90, 12, 12)"/>\r
</svg>`,_Q=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(180, 12, 12)"/>\r
</svg>`,xQ=`<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">\r
  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="1.5" fill="none"/>\r
  <path d="M 12 12 L 22 12 A 10 10 0 0 0 12 2 Z" fill="currentColor" transform="rotate(270, 12, 12)"/>\r
</svg>`;b.moduleLoaded("HarmonicBins with Columnar Structure");function df(s,...t){}const Xl={0:CQ,90:bQ,180:_Q,270:xQ},fn=uA;let ms,Ye,is=new Float32Array(fn).fill(0),ie,Js=new Float32Array(fn).fill(0);const Ap=[],ff=[];let ur=!1,Sn=null;const er=new Array(fn).fill(null);let Fl=!1;function Po(s,t){const{blend:e,cutoff:i,resonance:A}=t,r=(i-1)/30,a=20,l=s-r,u=r-s;let h=1/(1+Math.pow(Math.max(0,l*a),2)),m=1/(1+Math.pow(Math.max(0,u*a),2));const g=.01;h<g&&(h=0),m<g&&(m=0);const w=h*m;let C;e<=1?C=m*(1-e)+w*e:C=w*(2-e)+h*(e-1);const y=1-(A||0)/105,E=Math.max(.01,.2*y*y),x=Math.exp(-Math.pow((s-r)/E,2)),T=(A||0)/100*.6,U=C+x*T,H=Math.max(0,Math.min(1,U));return H<g?0:H}function EQ(s,t){const e=t/100;return 1-e+e*s}const Tl=new Float32Array(fn).fill(1);new Float32Array(fn).fill(0);function da(s,t){const e=t.mix||0;if(e===0)return new Float32Array(s);const i=new Float32Array(s.length),A=e/100;for(let r=0;r<s.length;r++){const a=s[r],l=(r+.5)/fn,u=Po(l,t);if(u<a){const m=(a-u)*A;i[r]=a-m}else i[r]=a;i[r]=Math.max(0,i[r])}return i}function bc(s){const t=d.state.timbres[s];if(!t)return new Float32Array(fn);const e=t.filter;return e&&e.enabled!==!1&&(e.mix||0)>0?da(t.coeffs,e):new Float32Array(t.coeffs)}function pf(){var l;if((!ms||!Ye||!Sn)&&(ms=document.getElementById("filter-overlay-canvas"),Sn=document.querySelector(".harmonic-bins-grid"),ms&&(Ye=ms.getContext("2d"))),!ms||!Ye||!Sn)return;const{width:s,height:t}=ms;Ye.clearRect(0,0,s,t);const i=t*.95,A=t,r=(l=d.state.timbres[ie])==null?void 0:l.filter,a=r&&r.enabled!==!1;if(r&&a){const u=r.mix||0;if(u===0){Tl.fill(1);return}const h=[];for(let y=0;y<fn;y++){const E=(y+.5)/fn,x=Po(E,r);Tl[y]=EQ(x,u),h.push({bin:y+1,rawFilterAmp:x.toFixed(3),afterMix:Tl[y].toFixed(3)})}Ye.beginPath();const m=2;for(let y=0;y<=s;y+=m){const E=y/s,x=Po(E,r),T=A-x*i;y===0?Ye.moveTo(y,T):Ye.lineTo(y,T)}const w=.4+u/100*.6;Ye.strokeStyle=qn(Yc(ie,-.3),w),Ye.lineWidth=2.5,Ye.stroke();const C=u/100;if(C>0){Ye.beginPath(),Ye.moveTo(0,0),Ye.lineTo(s,0);const y=Po(1,r),E=A-y*i;Ye.lineTo(s,E);for(let x=s;x>=0;x-=2){const T=x/s,U=Po(T,r),H=A-U*i;Ye.lineTo(x,H)}Ye.closePath(),Ye.fillStyle=`rgba(255, 255, 255, ${C})`,Ye.fill()}}else Tl.fill(1)}function Xo(){Ap.forEach((s,t)=>{const e=s.sliderTrack.querySelector(".slider-fill"),i=s.sliderTrack.querySelector(".harmonic-label-internal"),A=is[t];if(e.style.height=`${A*100}%`,A>0){const a=Yc(ie,-.1);e.style.backgroundColor=qn(a,1)}else e.style.backgroundColor="transparent";const r=e.querySelector("canvas");r&&r.remove(),A>.1?(i.style.color="rgba(255, 255, 255, 0.35)",i.style.textShadow="0 0 2px rgba(0,0,0,0.3)"):(i.style.color="rgba(51, 51, 51, 0.5)",i.style.textShadow="0 0 1px rgba(255,255,255,0.3)")}),pf()}function mw(s,t=null){var u,h,m,g;if(df("log","[BINS DRAG] handleBinPointerEvent called",{clientX:s.clientX,clientY:s.clientY}),b.debug("HarmonicBins","handleBinPointerEvent called",{target:s.target.className},"filter"),s.target.classList.contains("phase-button")||s.target.closest(".phase-button")||s.target.tagName==="path"||s.target.tagName==="svg"){b.debug("HarmonicBins","Blocking phase button interaction in handleBinPointerEvent",null,"filter");return}if(t===null){const w=Sn.getBoundingClientRect(),C=s.clientX-w.left,y=w.width/fn;t=Math.floor(C/y),t=Math.max(0,Math.min(fn-1,t))}b.debug("HarmonicBins","handleBinPointerEvent - binIndex",{binIndex:t},"filter");const i=Ap[t].sliderTrack.getBoundingClientRect(),A=s.clientY-i.top,r=i.height,a=(r-A)/r,l=Math.max(0,Math.min(1,a));if(df("log","[BINS DRAG] Setting bin",t+1,"value:",l.toFixed(3)),l===0){b.debug("HarmonicBins","Setting coefficient to zero immediately for bin",{binIndex:t},"filter");const w=new Float32Array(d.state.timbres[ie].coeffs);w[t]=0,is[t]=0,d.setHarmonicCoefficients(ie,w),er[t]&&(clearTimeout(er[t]),er[t]=null),ur||(Gt.triggerAttack("C4",ie),d.emit("spacebarPlayback",{color:ie,isPlaying:!0}),ur=!0);const C=(u=d.state.timbres[ie])==null?void 0:u.filter;C&&C.enabled!==!1&&(C.mix||0)>0&&da(w,C),(h=window.staticWaveformVisualizer)!=null&&h.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),b.debug("HarmonicBins",`Set coefficient H${t+1} to 0 for color ${ie}`,null,"filter")}else{er[t]&&(clearTimeout(er[t]),er[t]=null),ur||(Gt.triggerAttack("C4",ie),d.emit("spacebarPlayback",{color:ie,isPlaying:!0}),ur=!0),b.debug("HarmonicBins","BEFORE creating newCoeffs - store coeffs",{coeffs:d.state.timbres[ie].coeffs},"filter");const w=new Float32Array(d.state.timbres[ie].coeffs);b.debug("HarmonicBins","AFTER copying to newCoeffs",{newCoeffs:w},"filter"),w[t]=l,is[t]=l,b.debug("HarmonicBins",`AFTER setting newCoeffs[${t}] = ${l}`,{newCoeffs:w},"filter"),d.setHarmonicCoefficients(ie,w);const C=(m=d.state.timbres[ie])==null?void 0:m.filter;C&&C.enabled!==!1&&(C.mix||0)>0&&da(w,C),(g=window.staticWaveformVisualizer)!=null&&g.generateWaveform&&window.staticWaveformVisualizer.generateWaveform(),b.debug("HarmonicBins",`Updated coefficient H${t+1} to ${l} for color ${ie}`,null,"filter"),b.debug("HarmonicBins","All coefficients",{newCoeffs:w},"filter")}Xo()}function mf(s,t,e){const i=e.coeffs,A=e.phases||new Float32Array(i.length).fill(0);let r=!0,a=!0;if(s.length!==i.length)r=!1;else for(let u=0;u<s.length;u++)if(Math.abs(s[u]-i[u])>.001){r=!1;break}if(t.length!==A.length)a=!1;else for(let u=0;u<t.length;u++)if(Math.abs(t[u]-A[u])>.001){a=!1;break}return r&&a}function gw(s){if(!s)return;ie=s;const t=d.state.timbres[s];t&&(t.filter?t.filter.enabled===void 0&&(t.filter.enabled=!0):t.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0},b.debug("HarmonicBins","updateForNewColor - timbre.coeffs",{coeffs:t.coeffs},"filter"),b.debug("HarmonicBins","updateForNewColor - timbre.phases",{phases:t.phases},"filter"),is=new Float32Array(t.coeffs),t.phases?Js=new Float32Array(t.phases):Js=new Float32Array(is.length).fill(0),mf(is,Js,t),b.debug("HarmonicBins","updateForNewColor - final coeffs",{coeffs:is},"filter"),b.debug("HarmonicBins","updateForNewColor - final phases",{phases:Js},"filter"),ff.forEach(({phaseBtn:e},i)=>{if(!e)return;let r=(Js[i]||0)%(2*Math.PI);r<0&&(r+=2*Math.PI);const a=.1;let l=0;Math.abs(r-Math.PI/2)<a?l=90:Math.abs(r-Math.PI)<a?l=180:Math.abs(r-3*Math.PI/2)<a&&(l=270),e.innerHTML=Xl[l]}),Xo())}function SQ(){var l;const s=document.querySelector(".filter-container"),t=s==null?void 0:s.querySelector(".filter-bins-wrapper"),e=s==null?void 0:s.querySelector(".filter-vertical-blend-wrapper");if(!s||!t||!e){b.error("HarmonicBins","Missing required elements - aborting init",null,"audio");return}Sn=document.createElement("div"),Sn.className="harmonic-bins-grid";for(let u=0;u<fn;u++){const h=document.createElement("div");h.className="slider-column";const m=document.createElement("div");m.className="slider-track";const g=document.createElement("div");g.className="slider-fill",m.appendChild(g);const w=document.createElement("div");w.className="harmonic-label-internal",w.textContent=`${u+1}`,m.appendChild(w),h.appendChild(m);const C=document.createElement("button");C.className="phase-button",C.innerHTML=Xl[0],C.dataset.binIndex=u,C.addEventListener("pointerenter",()=>{var y,E,x,T;if(Fl){const H=Z.now();if((x=(E=(y=Gt.synths)==null?void 0:y[ie])==null?void 0:E.activeNotes)!=null&&x.C4){const R=Gt.synths[ie].activeNotes.C4;(T=R.oscillators)!=null&&T[u]&&R.oscillators[u].volume.linearRampTo(-1/0,.015,H)}setTimeout(()=>{var P;const R=new Float32Array(d.state.timbres[ie].coeffs);R[u]=0,is[u]=0,d.setHarmonicCoefficients(ie,R);const D=(P=d.state.timbres[ie])==null?void 0:P.filter;D&&D.enabled!==!1&&(D.mix||0)>0&&da(R,D),Xo()},.015*1e3)}}),C.addEventListener("click",y=>{var P;if(Fl){y.preventDefault();return}b.debug("HarmonicBins","Phase button click handler started",null,"filter"),b.debug("HarmonicBins","Current coeffs before phase change",{coeffs:is},"filter"),y.preventDefault();const E=new Float32Array(Js),x=new Float32Array(Js);let U=(x[u]||0)%(2*Math.PI);U<0&&(U+=2*Math.PI);const H=.1;let R=0;Math.abs(U)<H?R=Math.PI/2:Math.abs(U-Math.PI/2)<H?R=Math.PI:Math.abs(U-Math.PI)<H?R=3*Math.PI/2:R=0,x[u]=R,Js=x,(P=window.staticWaveformVisualizer)!=null&&P.startPhaseTransition&&window.staticWaveformVisualizer.startPhaseTransition(E,x,u),d.setHarmonicPhases(ie,x);const D=R===0?0:Math.abs(R-Math.PI/2)<H?90:Math.abs(R-Math.PI)<H?180:270;C.innerHTML=Xl[D],b.debug("HarmonicBins",`Phase button clicked for H${u+1}, new phase: ${D}`,null,"filter")}),h.appendChild(C),Sn.appendChild(h),Ap.push({column:h,label:w,sliderTrack:m,sliderFill:g,phaseBtn:C}),ff.push({phaseBtn:C})}Sn.addEventListener("pointerdown",u=>{if(df("log","[BINS DRAG] Pointerdown event fired",{target:u.target,className:u.target.className}),u.target.classList.contains("phase-button")||u.target.closest(".phase-button")){b.debug("HarmonicBins","Pointerdown blocked - phase button clicked",null,"filter");return}b.debug("HarmonicBins","Pointerdown - handling bin interaction",null,"filter"),u.preventDefault(),Fl=!0,Gt.triggerAttack("C4",ie),d.emit("spacebarPlayback",{color:ie,isPlaying:!0}),ur=!0,mw(u);const h=g=>mw(g),m=()=>{var w;window.removeEventListener("pointermove",h),window.removeEventListener("pointerup",m),Fl=!1;const g=!!((w=window.staticWaveformVisualizer)!=null&&w.generateWaveform);d.recordState(),Gt.triggerRelease("C4",ie),d.emit("spacebarPlayback",{color:ie,isPlaying:!1}),ur=!1,g?setTimeout(()=>{window.staticWaveformVisualizer.generateWaveform()},0):b.warn("HarmonicBins","Static waveform visualizer not ready when drag ended",null,"audio")};window.addEventListener("pointermove",h),window.addEventListener("pointerup",m)}),ms=document.createElement("canvas"),ms.id="filter-overlay-canvas",ms.className="filter-overlay-canvas",ms.style.pointerEvents="none",Ye=ms.getContext("2d"),Sn.appendChild(ms);const i=document.createElement("div");i.className="vertical-blend-wrapper";const A=document.createElement("div");A.id="vertical-blend-track";const r=document.createElement("div");r.id="vertical-blend-thumb",r.textContent="M",A.appendChild(r),i.appendChild(A),t.appendChild(Sn),e.appendChild(i);const a=()=>{const u=ms.getBoundingClientRect();(ms.width!==u.width||ms.height!==u.height)&&(ms.width=u.width,ms.height=u.height,pf())};ie=((l=d.state.selectedNote)==null?void 0:l.color)||"#4a90e2",gw(ie),d.on("timbreChanged",u=>{if(u===ie){b.debug("HarmonicBins","timbreChanged event - checking what changed",null,"filter");const h=d.state.timbres[u],m=h.coeffs,g=h.phases;let w=!1;if(b.debug("HarmonicBins","Comparing coefficients...",null,"filter"),b.debug("HarmonicBins","Local coeffs",{coeffs:is},"filter"),b.debug("HarmonicBins","Store coeffs",{newCoeffs:m},"filter"),!is||is.length!==m.length)b.debug("HarmonicBins","Array length mismatch - coeffsChanged = true",null,"filter"),w=!0;else for(let C=0;C<m.length;C++){const y=Math.abs(is[C]-m[C]);if(y>.001){b.debug("HarmonicBins",`Coefficient ${C} changed: ${is[C]} -> ${m[C]} (diff: ${y})`,null,"filter"),w=!0;break}}b.debug("HarmonicBins","Force syncing local coeffs with store",null,"filter"),mf(is||new Float32Array(12),Js||new Float32Array(12),h),is=new Float32Array(m),g?Js=new Float32Array(g):Js=new Float32Array(is.length).fill(0),mf(is,Js,h),w?(b.debug("HarmonicBins","Coefficients changed - updating visuals",null,"filter"),Xo()):(b.debug("HarmonicBins","No coefficient changes detected - but local coeffs synced",null,"filter"),pf()),ff.forEach(({phaseBtn:C},y)=>{if(!C)return;let x=(Js[y]||0)%(2*Math.PI);x<0&&(x+=2*Math.PI);const T=.1;let U=0;Math.abs(x-Math.PI/2)<T?U=90:Math.abs(x-Math.PI)<T?U=180:Math.abs(x-3*Math.PI/2)<T&&(U=270),C.innerHTML=Xl[U]})}}),d.on("noteChanged",({newNote:u})=>{u.color&&u.color!==ie&&gw(u.color)}),d.on("filterChanged",u=>{if(u===ie){Xo();const h=d.state.timbres[ie],m=h==null?void 0:h.filter;m&&m.enabled!==!1&&(m.mix||0)>0?da(h.coeffs,m):new Float32Array(h.coeffs)}}),new ResizeObserver(a).observe(Sn),a(),b.info("HarmonicBins","Initialized with columnar div structure and perfect alignment",null,"filter")}b.moduleLoaded("SynthEngine");const _c=32,YB=1/Math.sqrt(_c),FQ=200,TQ=50,IQ=16,QQ=-3,MQ=500,UQ=2e3,yn={};let Qi=null,sr=null,ld=null,Il=null,Yo=null,Fs={},Ls=0,wo=_c,Yl=null,jl=null,cd=0;function Ei(s,t,e){var i,A;e&&(((i=e._activeVoices)==null?void 0:i.size)??((A=e._voices)==null||A.length))}function PQ(){if(!Qi)return;const s=Z.now();if(Ls===0){wo=.01*_c+(1-.01)*wo;return}const t=1-Math.exp(-.016/(FQ/1e3)),e=Math.max(1,Ls);wo=t*e+(1-t)*wo;const i=Math.sqrt(_c/wo),A=YB*i;Qi.gain.rampTo(A,TQ/1e3,s)}function jB(){Yl!==null&&(clearInterval(Yl),Yl=null)}function DQ(){jB(),Yl=setInterval(()=>PQ(),IQ)}function JB(){jl!==null&&(clearInterval(jl),jl=null)}function kQ(){JB(),Yo&&(cd=0,jl=setInterval(()=>{if(!Yo)return;const s=Yo.getValue(),t=Array.isArray(s)?s[0]:s;if(t!==void 0&&t>QQ){const e=Date.now();e-cd>=UQ&&(cd=e,b.warn("SynthEngine","Limiter input approaching clipping threshold",{level:t},"audio"))}},MQ))}class LQ extends Z.Synth{constructor(e){super(e);Q(this,"presetGain");Q(this,"vibratoLFO");Q(this,"vibratoDepth");Q(this,"vibratoGain");Q(this,"tremoloLFO");Q(this,"tremoloDepth");Q(this,"tremoloGain");Q(this,"hpFilter");Q(this,"lpFilterForBP");Q(this,"lpFilterSolo");Q(this,"hpOutput");Q(this,"bpOutput");Q(this,"lpOutput");Q(this,"hp_bp_fade");Q(this,"main_fade");Q(this,"wetDryFade");this.presetGain=new Z.Gain(e.gain||1),this.vibratoLFO=new Z.LFO(0,0),this.vibratoDepth=new Z.Scale(-1,1),this.vibratoGain=new Z.Gain(0),this.vibratoLFO.connect(this.vibratoDepth),this.vibratoDepth.connect(this.vibratoGain),this.vibratoGain.connect(this.oscillator.frequency),this.tremoloLFO=new Z.LFO(0,0),this.tremoloDepth=new Z.Scale(0,1),this.tremoloGain=new Z.Gain(1),this.tremoloLFO.connect(this.tremoloDepth),this.tremoloDepth.connect(this.tremoloGain.gain),this.hpFilter=new Z.Filter({type:"highpass"}),this.lpFilterForBP=new Z.Filter({type:"lowpass"}),this.lpFilterSolo=new Z.Filter({type:"lowpass"}),this.hpOutput=new Z.Gain,this.bpOutput=new Z.Gain,this.lpOutput=new Z.Gain,this.hp_bp_fade=new Z.CrossFade(0),this.main_fade=new Z.CrossFade(0),this.wetDryFade=new Z.CrossFade(0),this.oscillator.connect(this.presetGain),this.presetGain.connect(this.wetDryFade.a),this.presetGain.connect(this.hpFilter),this.hpFilter.connect(this.hpOutput),this.hpFilter.connect(this.lpFilterForBP),this.lpFilterForBP.connect(this.bpOutput),this.presetGain.connect(this.lpFilterSolo),this.lpFilterSolo.connect(this.lpOutput),this.hpOutput.connect(this.hp_bp_fade.a),this.bpOutput.connect(this.hp_bp_fade.b),this.lpOutput.connect(this.main_fade.b),this.hp_bp_fade.connect(this.main_fade.a),this.main_fade.connect(this.wetDryFade.b),this.wetDryFade.connect(this.tremoloGain),this.tremoloGain.connect(this.envelope),e.filter&&this._setFilter(e.filter),e.vibrato?this._setVibrato(e.vibrato):this._setVibrato({speed:0,span:0}),e.tremelo?this._setTremolo(e.tremelo):this._setTremolo({speed:0,span:0})}_setPresetGain(e){this.presetGain&&(this.presetGain.gain.value=e)}_setVibrato(e,i=Z.now()){if(this.vibratoLFO&&this.vibratoGain){const A=e.speed/100*16;if(e.speed===0||e.span===0){this.vibratoLFO.stop(i),this.vibratoLFO.frequency.value=0,this.vibratoGain.gain.value=0;return}this.vibratoLFO.state!=="started"&&this.vibratoLFO.start(i),this.vibratoLFO.frequency.value=A;const a=e.span/100*50,l=a/1200,m=440*(Math.pow(2,l)-1);this.vibratoGain.gain.value=m,b.debug("SynthEngine","Audio vibrato gain set",{hzDeviation:m,centsAmplitude:a},"audio")}}_setTremolo(e,i=Z.now()){if(this.tremoloLFO&&this.tremoloGain){const A=e.speed/100*16;if(e.speed===0||e.span===0){this.tremoloLFO.stop(i),this.tremoloLFO.frequency.value=0,this.tremoloGain.gain.cancelScheduledValues(i),this.tremoloGain.gain.value=1;return}this.tremoloLFO.state!=="started"&&this.tremoloLFO.start(i),this.tremoloLFO.frequency.value=A;const r=e.span/100,a=Math.max(0,1-r),l=1;this.tremoloDepth.min=a,this.tremoloDepth.max=l}}_setFilter(e){this.wetDryFade.fade.value=e.enabled?1:0;const i=Z.Midi(e.cutoff+35).toFrequency(),A=e.resonance/100*12+.1;this.hpFilter.set({frequency:i,Q:A}),this.lpFilterForBP.set({frequency:i,Q:A}),this.lpFilterSolo.set({frequency:i,Q:A});const r=e.blend;r<=1?(this.main_fade.fade.value=0,this.hp_bp_fade.fade.value=r):(this.main_fade.fade.value=r-1,this.hp_bp_fade.fade.value=1)}}const Gt={init(){typeof this.stopBackgroundMonitors=="function"&&this.stopBackgroundMonitors(),Qi=new Z.Gain(YB),sr=new Z.Volume(0),ld=new Z.Compressor({threshold:-12,ratio:3,attack:.01,release:.1,knee:6}),Il=new Z.Limiter(-3),Yo=new Z.Meter,Qi.connect(sr),sr.connect(ld),ld.connect(Il),Il.toDestination(),Il.connect(Yo),kQ();for(const s in d.state.timbres){const t=d.state.timbres[s];if(!t)continue;const e=bc(s),i=e.reduce((u,h)=>u+Math.abs(h),0),A=i>1?e.map(u=>u/i):e,r=t.gain||1,a=new Z.PolySynth({maxPolyphony:48,voice:LQ,options:{oscillator:{type:"custom",partials:Array.from(A)},envelope:t.adsr,filter:t.filter,vibrato:t.vibrato,tremelo:t.tremelo,gain:r}}).connect(Qi);window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(a,s,Qi);const l=a.triggerAttack;a.triggerAttack=function(...u){const h=l.apply(this,u);return setTimeout(()=>{const m=this._activeVoices;window.audioEffectsManager?m&&m.size>0?m.forEach(g=>{g.effectsApplied||(window.audioEffectsManager.applyEffectsToVoice(g,s),g.effectsApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(g=>{g&&!g.effectsApplied&&(window.audioEffectsManager.applyEffectsToVoice(g,s),g.effectsApplied=!0)}):m&&m.size>0?m.forEach(g=>{g._setVibrato&&g.vibratoApplied!==!0&&(g._setVibrato(this._currentVibrato),g.vibratoApplied=!0),g._setTremolo&&g.tremoloApplied!==!0&&(g._setTremolo(this._currentTremolo),g.tremoloApplied=!0)}):this._voices&&Array.isArray(this._voices)&&this._voices.forEach(g=>{g!=null&&g._setVibrato&&g.vibratoApplied!==!0&&(g._setVibrato(this._currentVibrato),g.vibratoApplied=!0),g!=null&&g._setTremolo&&g.tremoloApplied!==!0&&(g._setTremolo(this._currentTremolo),g.tremoloApplied=!0)})},10),h},a._currentVibrato=t.vibrato,a._currentTremolo=t.tremelo,a._currentFilter=t.filter,yn[s]=a,b.debug("SynthEngine",`Created filtered synth for color: ${s}`,null,"audio")}d.on("timbreChanged",s=>{this.updateSynthForColor(s)}),d.on("filterChanged",s=>{this.updateSynthForColor(s)}),d.on("audioEffectChanged",({color:s})=>{this.updateSynthForColor(s)}),d.on("volumeChanged",s=>this.setVolume(s)),DQ(),b.info("SynthEngine","Initialized with multi-timbral support",null,"audio"),window.synthEngine=this},updateSynthForColor(s){const t=d.state.timbres[s],e=yn[s];if(!e||!t)return;t.vibrato||(t.vibrato={speed:0,span:0},b.debug("SynthEngine",`Initialized vibrato for color ${s}`,t.vibrato,"audio")),t.tremelo||(t.tremelo={speed:0,span:0},b.debug("SynthEngine",`Initialized tremolo for color ${s}`,t.tremelo,"audio")),b.debug("SynthEngine",`Updating timbre for color ${s}`,null,"audio");const i=bc(s),A=i.reduce((l,u)=>l+Math.abs(u),0),r=A>1?i.map(l=>l/A):i;e.set({oscillator:{partials:Array.from(r)},envelope:t.adsr}),window.audioEffectsManager&&window.audioEffectsManager.applySynthEffects(e,s,Qi),e._currentVibrato=t.vibrato,e._currentTremolo=t.tremelo,e._currentFilter=t.filter;const a=e._activeVoices;a&&a.size>0?a.forEach(l=>{if(l._setFilter&&l._setFilter(t.filter),l._setVibrato&&(l._setVibrato(t.vibrato),l.vibratoApplied=!0),l._setTremolo&&(l._setTremolo(t.tremelo),l.tremoloApplied=!0),l._setPresetGain){const u=t.gain||1;l._setPresetGain(u)}}):e._voices&&Array.isArray(e._voices)&&e._voices.forEach(l=>{if(l!=null&&l._setVibrato&&(l._setVibrato(t.vibrato),l.vibratoApplied=!0),l!=null&&l._setTremolo&&(l._setTremolo(t.tremelo),l.tremoloApplied=!0),l!=null&&l._setFilter&&l._setFilter(t.filter),l!=null&&l._setPresetGain){const u=t.gain||1;l._setPresetGain(u)}})},setBpm(s){var t;try{(t=Z.Transport)!=null&&t.bpm&&(Z.Transport.bpm.value=s,b.debug("SynthEngine",`Tone.Transport BPM updated to ${s}`,null,"audio"))}catch(e){b.warn("SynthEngine","Unable to update BPM on Tone.Transport",{tempo:s,error:e},"audio")}},setVolume(s){sr&&(sr.volume.value=s)},async playNote(s,t,e=Z.now()){var a;await(window.initAudio||(()=>Z.start()))();const A=(a=d.state.selectedNote)==null?void 0:a.color,r=A?yn[A]:null;r&&r.triggerAttackRelease(s,t,e)},triggerAttack(s,t,e=Z.now(),i=!1){var r,a,l,u;const A=yn[t];if(A){const h=A.maxPolyphony??48;if((((r=A._activeVoices)==null?void 0:r.size)??((a=A._voices)==null?void 0:a.length)??0)>=h-1&&(Ei("attack-pre-reset",t,A),A.releaseAll(),Ls=0),Ls++,Ei("attack++",t,A),(((l=A._activeVoices)==null?void 0:l.size)??((u=A._voices)==null?void 0:u.length)??0)>=h-4&&Ei("attack-near-maxpoly",t,A),i&&window.getDrumVolume){const w=window.getDrumVolume(),C=A.volume.value,y=C+20*Math.log10(w);A.volume.value=y,A.triggerAttack(s,e),setTimeout(()=>{A!=null&&A.volume&&(A.volume.value=C)},100)}else A.triggerAttack(s,e)}},quickReleasePitches(s,t){var A,r,a;const e=yn[t];if(!e||!s||s.length===0)return;let i;try{const l=typeof e.get=="function"?e.get():null;i=(A=l==null?void 0:l.envelope)==null?void 0:A.release,e.set({envelope:{release:.01}}),Ei("quickRelease:before",t,e),s.forEach(m=>e.triggerRelease(m,Z.now())),Ei("quickRelease:after",t,e);const u=((r=e._activeVoices)==null?void 0:r.size)??((a=e._voices)==null?void 0:a.length)??Ls;Ls=Math.max(0,Math.min(Ls,u));const h=e.maxPolyphony??48;u>h*.75&&(Ei("quickRelease:hard-reset",t,e),e.releaseAll(),Ls=0),Ei("quickRelease:clamped",t,e)}catch(l){b.warn("SynthEngine","quickReleasePitches failed",{err:l,color:t,pitches:s},"audio")}finally{if(i!==void 0)try{e.set({envelope:{release:i}})}catch{}}},triggerRelease(s,t,e=Z.now()){var A,r;const i=yn[t];if(i){i.triggerRelease(s,e),Ls=Math.max(0,Ls-1);const a=((A=i._activeVoices)==null?void 0:A.size)??((r=i._voices)==null?void 0:r.length)??Ls;Ls=Math.max(0,Math.min(Ls,a)),Ei("release--",t,i)}},releaseAll(){var s;for(const t in yn)(s=yn[t])==null||s.releaseAll();Ls=0},createWaveformAnalyzer(s){const t=yn[s];return t?(Fs[s]||(Fs[s]=new Z.Analyser("waveform",1024),t.connect(Fs[s]),b.debug("SynthEngine",`Created waveform analyzer for color: ${s}`,null,"waveform")),Fs[s]):(b.warn("SynthEngine",`No synth found for color: ${s}`,null,"audio"),null)},getWaveformAnalyzer(s){return Fs[s]||null},getAllWaveformAnalyzers(){const s=new Map;for(const t in Fs)Fs[t]&&s.set(t,Fs[t]);return s},removeWaveformAnalyzer(s){Fs[s]&&(Fs[s].dispose(),delete Fs[s],b.debug("SynthEngine",`Removed waveform analyzer for color: ${s}`,null,"waveform"))},disposeAllWaveformAnalyzers(){for(const s in Fs)Fs[s]&&Fs[s].dispose();Fs={},b.debug("SynthEngine","Disposed all waveform analyzers",null,"waveform")},getSynth(s){return yn[s]||null},getAllSynths(){return{...yn}},getMainVolumeNode(){return sr||null},getMasterGainNode(){return Qi||null},stopBackgroundMonitors(){JB(),jB()},teardown(){this.stopBackgroundMonitors(),this.disposeAllWaveformAnalyzers(),b.debug("SynthEngine","Stopped SynthEngine background monitors",null,"audio")}},Cs={adsrComponent:null};class RQ{constructor(){Q(this,"elements",new Map);Q(this,"initialized",!1)}init(){this.initialized||(this.cacheElement("notationGrid","notation-grid"),this.cacheElement("playheadCanvas","playhead-canvas"),this.cacheElement("hoverCanvas","hover-canvas"),this.cacheElement("drumGrid","drum-grid"),this.cacheElement("drumHoverCanvas","drum-hover-canvas"),this.cacheElement("pitchPaintCanvas","pitch-paint-canvas"),this.cacheElement("appContainer","app-container"),this.cacheElement("pitchGridWrapper","pitch-grid-wrapper"),this.cacheElement("drumGridWrapper","drum-grid-wrapper"),this.cacheElement("eraserButton","eraser-tool-button"),this.cacheElement("playButton","play-button"),this.cacheElement("stopButton","stop-button"),this.cacheElement("clearButton","clear-button"),this.cacheElement("loopButton","loop-button"),this.cacheElement("undoButton","undo-button"),this.cacheElement("redoButton","redo-button"),this.cacheElement("noteBankContainer","note-bank-container"),this.cacheElement("tonicModeGrid","tonic-mode-grid"),this.cacheElement("degreeVisibilityToggle","degree-visibility-toggle"),this.cacheElement("degreeModeToggle","degree-mode-toggle"),this.cacheElement("flatBtn","flat-toggle-btn"),this.cacheElement("sharpBtn","sharp-toggle-btn"),this.cacheElement("frequencyBtn","hz-toggle-btn"),this.cacheElement("focusColoursToggle","focus-colours-toggle"),this.cacheElement("harmonyContainerMain","chordShape-container"),this.cacheElement("tempoSlider","tempo-slider"),this.cacheElement("volumeSlider","vertical-volume-slider"),this.initialized=!0)}cacheElement(t,e){const i=document.getElementById(e);i&&this.elements.set(t,i)}get(t){return this.initialized?this.elements.get(t)??null:null}getMultiple(...t){const e={};return t.forEach(i=>{e[i]=this.get(i)}),e}has(t){return this.elements.has(t)}refresh(){this.elements.clear(),this.initialized=!1,this.init()}getStats(){const t=this.elements.size,e=Array.from(this.elements.values()).filter(i=>i!==null).length;return{totalCached:t,foundElements:e,missingElements:t-e}}}const gA=new RQ;let ZB=[],ty=0,xn=[0],ey=0,ww=0;function HQ(s=[],t=0){xn=[0],ww=0;for(let r=0;r<2&&r<s.length;r++)ww+=(s[r]||0)*t;let e=0;const i=2,A=Math.max(2,s.length-2);for(let r=i;r<A;r++)xn[r-i]=e,e+=(s[r]||0)*t;xn[A-i]=e,ey=A-i}function NQ({timeMap:s=[],musicalEndTime:t=0,columnWidths:e=[],cellWidth:i=0}={}){ZB=Array.isArray(s)?[...s]:[],ty=Number(t)||0,HQ(e,i)}function gf(){return ZB}function OQ(){return ty}function xr(s){return!Array.isArray(xn)||xn.length===0||s<=0?0:s>=xn.length?xn[xn.length-1]??0:xn[s]??xn[xn.length-1]??0}function rp(s){return xr(s+1)-xr(s)}function VQ(){return ey}class WQ{constructor(){Q(this,"canvas",null);Q(this,"ctx",null);Q(this,"animationFrameId",null);Q(this,"_lastColumnIndex",null);Q(this,"_lastColumnProgress",0);Q(this,"_lastDebugLogTime",0);Q(this,"activeAnimations",new Map);Q(this,"popDuration",{scaleUp:100,scaleDown:300});Q(this,"popScale",1.5)}initialize(){this.canvas=document.getElementById("drum-playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),d.on("playbackStateChanged",()=>this.handlePlaybackStateChange()),d.on("tempoChanged",()=>this.invalidateTimeMap()))}handlePlaybackStateChange(){d.state.isPlaying&&!d.state.isPaused?this.startRendering():this.stopRendering()}invalidateTimeMap(){}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.canvas&&this.ctx.clearRect(0,0,rs(this.canvas),_e(this.canvas))}render(){if(!d.state.isPlaying||d.state.isPaused||!this.ctx||!this.canvas){this.animationFrameId=null;return}this.ctx.clearRect(0,0,rs(this.canvas),_e(this.canvas));const t=Number(Z.Transport.seconds||0),e=this.calculateXFromTime(t);if(e===null){this.animationFrameId=requestAnimationFrame(()=>this.render());return}this.ctx.strokeStyle="#FF6B35",this.ctx.lineWidth=3,this.ctx.shadowColor="#FF6B35",this.ctx.shadowBlur=6,this.ctx.beginPath(),this.ctx.moveTo(e,0),this.ctx.lineTo(e,_e(this.canvas)),this.ctx.stroke(),this.ctx.shadowBlur=0,this.debugPlayhead(Z.Transport.seconds,e),this.animationFrameId=requestAnimationFrame(()=>this.render())}calculateXFromTime(t){this._lastColumnIndex=null,this._lastColumnProgress=0;const e=gf();if(!Array.isArray(e)||e.length<2)return null;for(let i=0;i<e.length-1;i++){const A=e[i],r=e[i+1];if(!(typeof A!="number"||typeof r!="number")&&t>=A&&t<r){const a=r-A,l=t-A,u=xr(i)??0,h=rp(i)??0;return this._lastColumnIndex=i,this._lastColumnProgress=a>0?l/a:0,u+(a>0?l/a*h:0)}}return null}debugPlayhead(t,e){if(!window.__DEBUG_PLAYHEAD_SYNC__)return;const i=performance.now();if(i-this._lastDebugLogTime<250)return;this._lastDebugLogTime=i;const A=gf(),r=this._lastColumnIndex,a=Array.isArray(A)&&r!==null&&r>=0?A[r]:void 0,l=Array.isArray(A)&&r!==null&&r+1<A.length?A[r+1]:void 0,u=Array.isArray(A)?A[A.length-1]??0:0,h=OQ(),m={transportSeconds:Number(t.toFixed(3)),drumX:Number((e??0).toFixed(2)),columnIndex:r,columnProgress:Number(this._lastColumnProgress.toFixed(3)),drumStartTime:Number((a==null?void 0:a.toFixed(3))??NaN),transportStartTime:Number((a==null?void 0:a.toFixed(3))??NaN),startDelta:0,drumEndTime:Number((l==null?void 0:l.toFixed(3))??NaN),transportEndTime:Number((l==null?void 0:l.toFixed(3))??NaN),endDelta:0,drumTimelineEnd:Number(u.toFixed(3)),transportTimelineEnd:Number((h??0).toFixed(3)),timelineDelta:Number((u-(h??0)).toFixed(3)),toneLoopStart:Number(Number(Z.Transport.loopStart??0).toFixed(3)),toneLoopEnd:Number(Number(Z.Transport.loopEnd??0).toFixed(3)),storeLooping:d.state.isLooping};b.debug("DrumPlayheadRenderer","Playhead diagnostics",m,"canvas")}triggerNotePop(t,e){const i=`${t}-${e}`;this.activeAnimations.set(i,{startTime:performance.now(),phase:"scaleUp"}),window.drumGridRenderer&&window.drumGridRenderer.render()}getAnimationScale(t,e){const i=`${t}-${e}`,A=this.activeAnimations.get(i);if(!A)return 1;const r=performance.now(),a=r-A.startTime;if(A.phase==="scaleUp"){if(a>=this.popDuration.scaleUp)return A.phase="scaleDown",A.startTime=r,this.popScale;{const l=a/this.popDuration.scaleUp;return 1+(this.popScale-1)*l}}else if(A.phase==="scaleDown"){if(a>=this.popDuration.scaleDown)return this.activeAnimations.delete(i),1;{const l=a/this.popDuration.scaleDown;return this.popScale-(this.popScale-1)*l}}return 1}hasActiveAnimations(){return this.activeAnimations.size>0}cleanupAnimations(){const t=performance.now();for(const[e,i]of this.activeAnimations.entries()){const A=t-i.startTime,r=i.phase==="scaleUp"?this.popDuration.scaleUp:this.popDuration.scaleUp+this.popDuration.scaleDown;A>r&&this.activeAnimations.delete(e)}}}const fA=new WQ;b.moduleLoaded("StampPlacements","stamps");function KQ(s,t,e,i="#4a90e2"){return Rc(s)?d.addStampPlacement(s,t,e,i):(b.warn("StampPlacements",`Invalid stamp ID: ${s}`,{stampId:s},"stamps"),null)}function GQ(s,t,e,i){return d.eraseStampsInArea(s,t,e,i)}function qQ(){d.clearAllStamps()}function sy(){return d.getStampPlaybackData()}b.moduleLoaded("StampScheduler","stamps");const vw=["0","16n","8n",{"8n":1,"16n":1}];function ny(s,t=null){const e=Rc(s);if(!e)return b.warn("StampScheduler",`Unknown stamp ID: ${s}`,{stampId:s},"stamps"),[];const i=[];return e.ovals.forEach(A=>{var l;const r=`oval_${A}`,a=((l=t==null?void 0:t.shapeOffsets)==null?void 0:l[r])||0;i.push({offset:vw[A],duration:"8n",type:"oval",slot:A,shapeKey:r,rowOffset:a})}),e.diamonds.forEach(A=>{var l;const r=`diamond_${A}`,a=((l=t==null?void 0:t.shapeOffsets)==null?void 0:l[r])||0;i.push({offset:vw[A],duration:"16n",type:"diamond",slot:A,shapeKey:r,rowOffset:a})}),i}b.moduleLoaded("TripletPlacements","triplets");function zQ(s,t,e,i="#4a90e2"){const A=Hc(s);if(!A)return b.warn("TripletPlacements",`Invalid triplet stamp ID: ${s}`,{tripletStampId:s},"triplets"),null;const r=nE[A.span]??1;if(!$Q(t,r,e))return b.debug("TripletPlacements",`Cannot place triplet at cell ${t}, row ${e} - collision detected`,{tripletStampId:s,startCellIndex:t,row:e,span:r},"triplets"),null;const a=d.state.pitchRange||{topIndex:0,bottomIndex:d.state.fullRowData.length-1},l=e+a.topIndex,u={id:`triplet_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,stampId:s,startCellIndex:t,span:r,row:e,globalRow:l,color:i,timestamp:Date.now()};return d.addTripletPlacement(u)}function $Q(s,t,e){const i=d.state;if(i.stampPlacements){for(const A of i.stampPlacements)if(A.row===e){const r=Math.floor(A.startColumn/2),a=Math.floor(A.endColumn/2);for(let l=0;l<t;l++){const u=s+l;if(u>=r&&u<=a)return!1}}}if(i.tripletPlacements){for(const A of i.tripletPlacements)if(A.row===e){const r=A.startCellIndex+A.span-1;if(!(s+t-1<A.startCellIndex||s>r))return!1}}return!0}function XQ(s,t,e,i){const A=d.state;if(!A.tripletPlacements)return!1;const r=Math.floor(s/2),a=Math.floor(t/2),l=[];for(const u of A.tripletPlacements)u.row>=e&&u.row<=i&&(u.startCellIndex+u.span-1<r||u.startCellIndex>a||l.push(u.id));return l.length>0?(l.forEach(u=>d.removeTripletPlacement(u)),b.debug("TripletPlacements",`Erased ${l.length} triplet groups`,{removedIds:l,eraseArea:{eraseStartCell:r,eraseEndCell:a,eraseStartRow:e,eraseEndRow:i}},"triplets"),!0):!1}function iy(){const s=d.state;return s.tripletPlacements?s.tripletPlacements.map(t=>({startCellIndex:t.startCellIndex,stampId:t.stampId,row:t.row,color:t.color,span:t.span,placement:t})):[]}function YQ(){d.clearAllTripletPlacements(),b.info("TripletPlacements","Cleared all triplet placements",null,"triplets")}b.moduleLoaded("TripletScheduler","triplets");function Ay(s,t=null){const e=Hc(s);if(!e)return b.warn("TripletScheduler",`Unknown triplet stamp ID: ${s}`,{tripletStampId:s},"triplets"),[];const i=[],A=e.span==="eighth"?"8t":"4t",r=A;return e.hits.forEach(a=>{var m;const l=`triplet_${a}`,u=((m=t==null?void 0:t.shapeOffsets)==null?void 0:m[l])||0;let h;if(a===0)h="0";else if(a===1)h=A;else if(a===2){const g=Z.Time(A).toSeconds();h=Z.Time(g*2).toNotation()}else{const g=Z.Time(A).toSeconds();h=Z.Time(g*a).toNotation()}i.push({offset:h,duration:r,type:e.span==="eighth"?"triplet-eighth":"triplet-quarter",slot:a,shapeKey:l,rowOffset:u}),b.debug("TripletScheduler",`Triplet stamp ${s} ${e.span} at slot ${a} with offset "${h}", rowOffset: ${u}`,"triplets")}),b.debug("TripletScheduler",`Total events for triplet stamp ${s}:`,i.length,"triplets"),i}const ry="",oy="",Bw=1e-4;function ud(s){const t=d.state.fullRowData[s];return t?t.toneNote.replace(ry,"b").replace(oy,"#"):"C4"}b.moduleLoaded("TransportService");let Ts=null,jo=null,Ae=[],Jl=0,Br=0,Wi=0;const jQ=1e-4,wf=new Map;let vf=!1;function Di(...s){}function ay(){wf.clear()}function JQ(s,t){let e=Number.isFinite(t)?t:Z.now();const i=wf.get(s)??-1/0;return e>i||(e=i+jQ),wf.set(s,e),e}function yr(){if(Wi>Br){const s=Math.abs(Z.Transport.loopStart-Br),t=Math.abs(Z.Transport.loopEnd-Wi);(s>Bw||t>Bw)&&(Z.Transport.loopStart=Br,Z.Transport.loopEnd=Wi),Z.Transport.loop!==d.state.isLooping&&(Z.Transport.loop=d.state.isLooping)}}function ly(s,t){const e=Math.max(op(),.001),i=Number.isFinite(s)?s:0;let A=Number.isFinite(t)?t:i+e;A<=i&&(A=i+e),Br=i,Wi=A,Z.Transport&&(Z.Transport.loopStart=i,Z.Transport.loopEnd=A),yr()}function ZQ(){const s=cy(),t=jc();ly(s,t)}function op(){return 60/(d.state.tempo*2)}function cy(){if(!d.state.hasAnacrusis)return b.debug("TransportService","[ANACRUSIS] No anacrusis, starting from time 0"),0;for(let s=0;s<d.state.macrobeatBoundaryStyles.length;s++)if(d.state.macrobeatBoundaryStyles[s]==="solid"){const t=Os(d.state,s+1);if(t){const e=Ae[t.startColumn]||0;return b.debug("TransportService",`[ANACRUSIS] Found solid boundary at macrobeat ${s}, non-anacrusis starts at column ${t.startColumn}, time ${e.toFixed(3)}s`),e}}return b.debug("TransportService","[ANACRUSIS] No solid boundary found, starting from time 0"),0}function Zl(){var r;b.debug("transportService","calculateTimeMap",{tempo:`${d.state.tempo} BPM`}),Ae=[];const s=op(),{columnWidths:t}=d.state,e=hi(d.state),i=t.slice(2,-2);tM(s,i,e),b.timing("transportService","calculateTimeMap",{totalDuration:`${(r=Ae[Ae.length-1])==null?void 0:r.toFixed(2)}s`}),uy();const A=jc();NQ({timeMap:Ae,musicalEndTime:A,columnWidths:d.state.columnWidths,cellWidth:d.state.cellWidth}),ZQ(),typeof window<"u"&&(window.__transportTimeMap=[...Ae],window.__transportMusicalEnd=A.toString())}function uy(){var r;const s=Ae.length>0?Ae[Ae.length-1]:0;if(!Number.isFinite(s)||s===0){Jl=0;return}const t=((r=d.state.modulationMarkers)==null?void 0:r.filter(a=>a.active))||[];if(t.length===0){Jl=s;return}const e=[...t].sort((a,l)=>a.measureIndex-l.measureIndex);let i=s,A=1;for(const a of e){const l=Os(d.state,a.measureIndex);if(l){const u=l.endColumn-1,h=Ae[u]!==void 0?Ae[u]:s,m=s-h,g=m*a.ratio;i=i-m+g,A*=a.ratio}}Jl=i}function jc(){return Jl}function tM(s,t,e){let i=0;b.debug("TransportService","[TIMEMAP] Building timeMap",{columnCount:t.length,tonicSignCount:e.length,microbeatDuration:s});for(let A=0;A<t.length;A++){Ae[A]=i;const r=e.some(a=>a.columnIndex===A);r?b.debug("TransportService",`[TIMEMAP] Column ${A} is tonic, not advancing time`):i+=(t[A]||0)*s,A<5&&b.debug("TransportService",`[TIMEMAP] timeMap[${A}] = ${Ae[A].toFixed(3)}s (isTonic: ${r})`)}b.debug("TransportService",`[TIMEMAP] Complete. Total columns: ${Ae.length}, Final time: ${i.toFixed(3)}s`)}function eM(s){const t=d.state.fullRowData;return t!=null&&t[s.row]?t[s.row].toneNote.replace(ry,"b").replace(oy,"#"):"C4"}function yw(s,t){var r;const e=((r=d.state.modulationMarkers)==null?void 0:r.filter(a=>a.active))||[];if(e.length===0)return s;const i=[...e].sort((a,l)=>a.measureIndex-l.measureIndex);let A=s;t<5&&b.debug("TransportService",`[MODULATION] Column ${t}: baseTime ${s.toFixed(3)}s, ${i.length} active markers`);for(const a of i){const l=Os(d.state,a.measureIndex);if(l){const u=l.endColumn;if(t>u){const h=Ae[u]!==void 0?Ae[u]:0,m=s-h,g=m*a.ratio;A=A-m+g,t<5&&b.debug("TransportService",`[MODULATION] Column ${t}: Applied marker at measure ${a.measureIndex} (col ${u}), ratio ${a.ratio}, adjustedTime ${A.toFixed(3)}s`)}}}return A}function hd(){var u,h,m;b.debug("transportService","scheduleNotes","Clearing previous transport events and rescheduling all notes"),Z.Transport.cancel(),ay(),Zl(),(u=Cs.adsrComponent)==null||u.playheadManager.clearAll();const s=cy(),t=d.state.modulationMarkers&&d.state.modulationMarkers.length>0;b.debug("TransportService",`[ANACRUSIS] hasAnacrusis: ${d.state.hasAnacrusis}, anacrusisOffset: ${s.toFixed(3)}s`),Di("scheduleNotes:start",{anacrusisOffset:s,noteCount:d.state.placedNotes.length,hasModulation:t,lassoActive:!!((h=d.state.lassoSelection)!=null&&h.isActive),hasAnacrusis:d.state.hasAnacrusis});const e=(m=d.state.lassoSelection)==null?void 0:m.isActive,i=e?new Set(d.state.lassoSelection.selectedItems.filter(g=>g.type==="note").map(g=>g.id)):null;d.state.placedNotes.forEach((g,w)=>{var D;if(e){const P=`note-${g.row}-${g.columnIndex}-${g.color}-${g.shape}`;if(!i.has(P))return}const C=g.startColumnIndex,y=g.endColumnIndex,E=Ae[C];if(E===void 0){b.warn("TransportService",`[NOTE SCHEDULE] Note ${w}: timeMap[${C}] undefined, skipping`);return}if(E<s){b.debug("transportService",`Skipping note at canvas column ${C}, time ${E.toFixed(3)}s - before anacrusis offset (${s.toFixed(3)}s)`);return}const x=yw(E,C);w<3&&b.debug("TransportService",`[NOTE SCHEDULE] Note ${w}: canvas cols [${C}-${y}], startTime ${E.toFixed(3)}s, scheduleTime ${x.toFixed(3)}s`);let T;const U=Ae[y+1];if(U===void 0){b.warn("TransportService",`Skipping note with invalid endColumnIndex: ${g.endColumnIndex+1} (note ends at ${g.endColumnIndex})`,{noteId:g.uuid,startColumnIndex:g.startColumnIndex,endColumnIndex:g.endColumnIndex,lookupIndex:g.endColumnIndex+1,timeMapLength:Ae.length,maxValidIndex:Ae.length-1,noteShape:g.shape},"audio");return}const R=yw(U,y+1)-x;if(g.shape,T=R,g.isDrum)Z.Transport.schedule(P=>{var Y;if(d.state.isPaused)return;const G=JQ(g.drumTrack,P);(Y=jo==null?void 0:jo.player(g.drumTrack))==null||Y.start(G),fA.triggerNotePop(g.startColumnIndex,g.drumTrack)},x);else{const P=eM(g),G=g.color,Y=((D=d.state.fullRowData[g.row])==null?void 0:D.hex)||"#888888",W=g.uuid,at=d.state.timbres[G];if(!at){b.warn("TransportService",`Timbre not found for color ${G}. Skipping note ${W}`,null,"audio");return}let Bt=x+T;const X=Wi-.001;Bt>=Wi&&(Bt=Math.max(x+.001,X)),Z.Transport.schedule(mt=>{var ct;d.state.isPaused||(Gt.triggerAttack(P,G,mt),(ct=Cs.adsrComponent)==null||ct.playheadManager.trigger(W,"attack",Y,at.adsr),d.emit("noteAttack",{noteId:W,color:G}))},x),Z.Transport.schedule(mt=>{var ct;Gt.triggerRelease(P,G,mt),(ct=Cs.adsrComponent)==null||ct.playheadManager.trigger(W,"release",Y,at.adsr),d.emit("noteRelease",{noteId:W,color:G})},Bt)}});const A=sy(),r=e?new Set(d.state.lassoSelection.selectedItems.filter(g=>g.type==="stamp").map(g=>g.id)):null;A.forEach(g=>{var E;if(e){const x=`stamp-${g.row}-${g.column}-${g.stampId}`;if(!r.has(x))return}const w=g.column,C=Ae[w];if(C===void 0)return;if(w<5&&b.debug("TransportService",`[STAMP SCHEDULE] Stamp at column ${w}: cellStartTime ${C.toFixed(3)}s, anacrusisOffset ${s.toFixed(3)}s`),C<s){b.debug("TransportService",`Skipping stamp at column ${g.column} - before anacrusis offset`);return}const y=ny(g.stampId,g.placement);y.forEach(x=>{const T=Z.Time(x.offset).toSeconds(),U=Z.Time(x.duration).toSeconds(),H=C+T,R=H+U,D=g.row+x.rowOffset,P=ud(D);Z.Transport.schedule(G=>{d.state.isPaused||Gt.triggerAttack(P,g.color,G)},H),Z.Transport.schedule(G=>{d.state.isPaused||Gt.triggerRelease(P,g.color,G)},R)}),b.debug("TransportService",`Scheduled stamp ${g.stampId} with ${y.length} events at column ${g.column}`,{stampId:g.stampId,column:g.column,basePitch:g.pitch,baseRow:g.row,startTime:C,events:y.length,hasShapeOffsets:!!((E=g.placement)!=null&&E.shapeOffsets)},"audio")});const a=iy(),l=e?new Set(d.state.lassoSelection.selectedItems.filter(g=>g.type==="triplet").map(g=>g.id)):null;a.forEach(g=>{var E,x,T;if(e){const U=`triplet-${g.row}-${g.column}-${g.tripletId}`;if(!l.has(U))return}const w=g.startCellIndex*2,C=Ae[w];if(C===void 0)return;if(C<s){b.debug("TransportService",`Skipping triplet at cell ${g.startCellIndex} - before anacrusis offset`);return}b.debug("TransportService","[TRANSPORT DEBUG] Scheduling triplet",{stampId:g.stampId,baseRow:g.row,hasPlacement:!!g.placement,hasShapeOffsets:!!((E=g.placement)!=null&&E.shapeOffsets),shapeOffsets:(x=g.placement)==null?void 0:x.shapeOffsets});const y=Ay(g.stampId,g.placement);y.forEach(U=>{const H=Z.Time(U.offset).toSeconds(),R=Z.Time(U.duration).toSeconds(),D=C+H,P=D+R,G=g.row+U.rowOffset,Y=ud(G);b.debug("TransportService","[TRANSPORT DEBUG] Scheduling shape",{slot:U.slot,rowOffset:U.rowOffset,baseRow:g.row,shapeRow:G,shapePitch:Y}),Z.Transport.schedule(W=>{d.state.isPaused||Gt.triggerAttack(Y,g.color,W)},D),Z.Transport.schedule(W=>{d.state.isPaused||Gt.triggerRelease(Y,g.color,W)},P)}),b.debug("TransportService",`Scheduled triplet ${g.stampId} with ${y.length} events at cell ${g.startCellIndex}`,{stampId:g.stampId,cellIndex:g.startCellIndex,basePitch:ud(g.row),baseRow:g.row,startTime:C,events:y.length,hasShapeOffsets:!!((T=g.placement)!=null&&T.shapeOffsets)},"audio")}),b.debug("TransportService","scheduleNotes",`Finished scheduling ${d.state.placedNotes.length} notes, ${A.length} stamps, and ${a.length} triplets`,"audio"),Di("scheduleNotes:complete",{noteCount:d.state.placedNotes.length,stampCount:A.length,tripletCount:a.length,hasModulation:t})}function dd(){var h,m;const s=gA.get("playheadCanvas");if(!s)return;const t=s.getContext("2d"),e=d.state.tempo,i=1e-4,A=.5,r=g=>(g==null?void 0:g.xPosition)??477.5,a=typeof((m=(h=Z.Transport)==null?void 0:h.bpm)==null?void 0:m.value)=="number"?Z.Transport.bpm.value:e;let l=e!==0?a/e:1;vf=!0;function u(){if(!vf||!s)return;if(Z.Transport.state==="stopped"){Ts=requestAnimationFrame(u);return}const g=Z.Transport.loopEnd??0,w=d.state.isLooping,C=jc(),y=w&&g>0?g:C,E=Z.Transport.seconds,x=E>=y-.001;if(!w&&x){b.info("TransportService","Playback reached end. Stopping playhead.",{currentTime:E,playbackEnd:y,isLooping:w},"transport"),Di("animate:stop-guard",{currentTime:E,playbackEnd:y,isLooping:w,loopStart:Z.Transport.loopStart,loopEnd:Z.Transport.loopEnd}),hr.stop();return}if(d.state.isPaused){Ts=requestAnimationFrame(u);return}const T=rs(s),U=_e(s);t.clearRect(0,0,T,U);let H=E;if(w){const W=Z.Transport.loopEnd-Z.Transport.loopStart;W>0&&(H=(E-Z.Transport.loopStart)%W+Z.Transport.loopStart)}const R=xr(VQ());let D=0;for(let W=0;W<Ae.length-1;W++)if(Ae[W]!==void 0&&H>=Ae[W]&&H<Ae[W+1]){const at=Ae[W],dt=Ae[W+1]-at,X=H-at,nt=xr(W),mt=rp(W),ct=dt>0?X/dt:0;D=nt+ct*mt;break}const P=Math.min(D,R),Y=(Array.isArray(d.state.modulationMarkers)?d.state.modulationMarkers:[]).filter(W=>(W==null?void 0:W.active)&&typeof W.ratio=="number"&&W.ratio!==0).sort((W,at)=>r(W)-r(at));if(Y.length>0){let W=1;for(const at of Y){const Bt=r(at);if(P+A>=Bt)W*=1/at.ratio;else break}if((!Number.isFinite(W)||W<=0)&&(W=1),Math.abs(W-l)>i){const at=e*W;Z.Transport.bpm.value=at,yr(),l=W;const Bt={targetMultiplier:Number(W.toFixed(6)),newTempo:Number(at.toFixed(3)),markerCount:Y.length,finalXPos:Number(P.toFixed(2))};b.debug("TransportService",`Tempo multiplier updated to ${W.toFixed(3)} (${at.toFixed(2)} BPM)`,Bt,"transport")}}else if(Math.abs(l-1)>i){Z.Transport.bpm.value=e,yr(),l=1;const W={targetMultiplier:1,newTempo:Number(e.toFixed(3)),markerCount:Y.length,finalXPos:Number(P.toFixed(2))};b.debug("TransportService",`Tempo reset to base ${e} BPM`,W,"transport")}if(P>=0){const W=P;t.strokeStyle="rgba(255,0,0,0.8)",t.lineWidth=2,t.beginPath(),t.moveTo(W,0);const at=_e(s);t.lineTo(W,at),t.stroke()}Ts=requestAnimationFrame(u)}u()}const hr={init(){var t,e;const s=new Z.Volume(0);if(jo=new Z.Players({H:"https://tonejs.github.io/audio/drum-samples/CR78/hihat.mp3",M:"https://tonejs.github.io/audio/drum-samples/CR78/snare.mp3",L:"https://tonejs.github.io/audio/drum-samples/CR78/kick.mp3"}).connect(s),window.synthEngine){const i=(e=(t=window.synthEngine).getMainVolumeNode)==null?void 0:e.call(t);i?s.connect(i):s.toDestination()}else s.toDestination();window.drumVolumeNode=s,window.transportService={drumPlayers:jo},Z.Transport.bpm.value=d.state.tempo,d.on("rhythmStructureChanged",()=>this.handleStateChange()),d.on("notesChanged",()=>this.handleStateChange()),d.on("stampPlacementsChanged",()=>this.handleStateChange()),d.on("modulationMarkersChanged",()=>{Ae.length>0&&uy(),this.handleStateChange()}),d.on("layoutConfigChanged",i=>{var l,u;const A=((l=i==null?void 0:i.oldConfig)==null?void 0:l.columnWidths)||[],r=((u=i==null?void 0:i.newConfig)==null?void 0:u.columnWidths)||[];A.length!==r.length&&Zl()}),d.on("tempoChanged",i=>{if(b.event("TransportService",`tempoChanged triggered with new value: ${i} BPM`,null,"transport"),Z.Transport.state==="started"){b.info("TransportService","Tempo changed WHILE PLAYING. Resynchronizing transport...",null,"transport");const A=Z.Transport.position;b.debug("TransportService",`Saved musical position: ${A}`,null,"transport"),Z.Transport.pause(),b.debug("TransportService","Transport paused",null,"transport"),Ts&&(cancelAnimationFrame(Ts),Ts=null),Z.Transport.bpm.value=i,yr(),b.debug("TransportService",`New BPM set to ${Z.Transport.bpm.value}`,null,"transport"),hd(),Z.Transport.start(void 0,A),b.debug("TransportService",`Transport restarted at musical position ${A}`,null,"transport"),d.state.paint.isMicPaintActive||dd()}else b.debug("TransportService","Tempo changed while stopped/paused. Updating BPM for next run",null,"transport"),Z.Transport.bpm.value=i,yr(),Zl()}),d.on("loopingChanged",i=>{Z.Transport.loop=i,i&&Z.Transport.loopEnd<=Z.Transport.loopStart&&(Z.Transport.loopEnd=Z.Transport.loopStart+Math.max(op(),.001)),i?(Br=Z.Transport.loopStart,Wi=Z.Transport.loopEnd):(Br=0,Wi=0),Di("loopingChanged:event",{isLooping:i,loopStart:Z.Transport.loopStart,loopEnd:Z.Transport.loopEnd})}),Z.Transport.on("stop",()=>{var i;b.event("TransportService","Tone.Transport 'stop' fired. Resetting playback state",null,"transport"),d.setPlaybackState(!1,!1),(i=Cs.adsrComponent)==null||i.playheadManager.clearAll(),Ts&&(cancelAnimationFrame(Ts),Ts=null)}),b.info("TransportService","Initialized",null,"transport")},handleStateChange(){if(Z.Transport.state==="started"){b.debug("TransportService","handleStateChange: Notes or rhythm changed during playback. Rescheduling",null,"transport");const t=Z.Transport.position;Z.Transport.pause(),hd(),Z.Transport.start(void 0,t)}else Zl()},start(){b.info("TransportService","Starting playback",null,"transport"),Di("start:requested",{requestedTempo:d.state.tempo,isLooping:d.state.isLooping,placedNotes:d.state.placedNotes.length}),(window.initAudio||(()=>Z.start()))().then(()=>{var A;hd(),Di("start:after-schedule",{scheduledNotes:d.state.placedNotes.length,scheduledStamps:sy().length,scheduledTriplets:iy().length});const t=Ae.length>0?Ae[Ae.length-1]:0,e=jc();ly(0,e),Z.Transport.bpm.value=d.state.tempo,b.debug("TransportService",`Transport configured. Loop: ${Z.Transport.loop}, BPM: ${Z.Transport.bpm.value}`,null,"transport"),Di("start:configured",{loopStart:Z.Transport.loopStart,loopEnd:Z.Transport.loopEnd,timelineEnd:t,musicalDuration:e});const i=Z.now()+.1;Z.Transport.start(i,0),(A=window.PaintPlaybackService)!=null&&A.onTransportStart&&window.PaintPlaybackService.onTransportStart(),d.state.paint.isMicPaintActive?(d.emit("playbackStateChanged",{isPlaying:!0,isPaused:!1}),b.debug("TransportService","Paint playhead is active, skipping regular playhead animation",null,"transport")):dd(),d.emit("playbackStarted")})},resume(){b.info("TransportService","Resuming playback",null,"transport"),(window.initAudio||(()=>Z.start()))().then(()=>{var t;Z.Transport.start(),(t=window.PaintPlaybackService)!=null&&t.onTransportStart&&window.PaintPlaybackService.onTransportStart(),d.state.paint.isMicPaintActive||dd(),d.emit("playbackResumed")})},pause(){b.info("TransportService","Pausing playback",null,"transport"),Z.Transport.pause(),Ts&&(cancelAnimationFrame(Ts),Ts=null),d.emit("playbackPaused")},stop(){var t;b.info("TransportService","Stopping playback and clearing visuals",null,"transport"),vf=!1,Ts&&(cancelAnimationFrame(Ts),Ts=null),Z.Transport.stop(),(t=window.PaintPlaybackService)!=null&&t.onTransportStop&&window.PaintPlaybackService.onTransportStop(),Z.Transport.cancel(),ay(),Z.Transport.bpm.value=d.state.tempo,yr(),Di("stop:transport-reset",{tempoResetTo:d.state.tempo}),Gt.releaseAll();const s=gA.get("playheadCanvas");s&&s.getContext("2d").clearRect(0,0,rs(s),_e(s)),d.state.paint.isMicPaintActive&&d.emit("playbackStateChanged",{isPlaying:!1,isPaused:!1}),d.emit("playbackStopped")}},sM=/(Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini)/i,hy=900;let Cw=!1,tc=hy,fd=!1;const nM=Object.freeze({isMobile:!1,isTouch:!1,isCoarsePointer:!1,orientation:"landscape",width:0,height:0});function ap(){return typeof window<"u"?window:null}function iM(){const s=ap();if(!s)return{...nM};const{innerWidth:t=0,innerHeight:e=0}=s,i=s.matchMedia?s.matchMedia("(orientation: portrait)"):null,A=i?i.matches?"portrait":"landscape":e>=t?"portrait":"landscape",r=!!(s.matchMedia&&s.matchMedia("(pointer: coarse)").matches),a=!!(s.matchMedia&&s.matchMedia("(hover: none)").matches),l=typeof navigator<"u"?navigator:null,u=(l==null?void 0:l.maxTouchPoints)??(l==null?void 0:l.msMaxTouchPoints)??0,h="ontouchstart"in s||u>0,m=l!=null&&l.userAgent?sM.test(l.userAgent):!1,g=t>0?t<=tc:!1;return{isMobile:!!(m||h&&(r||a||g)),isTouch:h,isCoarsePointer:r,orientation:A,width:t,height:e}}function AM(s){if(typeof document>"u")return;[document.documentElement,document.body].filter(Boolean).forEach(e=>{e.classList.toggle("is-mobile",!!s.isMobile),e.classList.toggle("is-touch",!!s.isTouch),e.classList.toggle("orientation-portrait",s.orientation==="portrait"),e.classList.toggle("orientation-landscape",s.orientation==="landscape")})}function Ql(){if(fd)return;const s=ap();s&&(fd=!0,s.requestAnimationFrame(()=>{fd=!1;const t=iM();d.setDeviceProfile(t),AM(t)}))}function rM(s,t){return s?typeof s.addEventListener=="function"?(s.addEventListener("change",t),()=>s.removeEventListener("change",t)):typeof s.addListener=="function"?(s.addListener(t),()=>s.removeListener(t)):()=>{}:()=>{}}function oM(s={}){const t=ap();if(!t||Cw)return;tc=s.maxMobileWidth??hy,Cw=!0;const e=()=>Ql(),i=()=>Ql();t.addEventListener("resize",e),t.addEventListener("orientationchange",i),[t.matchMedia&&t.matchMedia("(pointer: coarse)"),t.matchMedia&&t.matchMedia("(hover: none)"),t.matchMedia&&t.matchMedia(`(max-width: ${tc}px)`),t.matchMedia&&t.matchMedia("(orientation: portrait)")].filter(Boolean).forEach(r=>{rM(r,Ql)}),Ql(),b.debug("DeviceProfileService",`Initialized (breakpoint <= ${tc}px)`,null,"ui")}const aM=()=>{const s="/Student-Notation/";return s.endsWith("/")?s:`${s}/`},lM=`${aM()}assets/`;function cM(s=""){const t=s.replace(/^\/+/,"");return`${lM}${t}`}function Bf(s){return cM(`icons/${s}`)}class uM{constructor(){Q(this,"tasks",[]);Q(this,"completedTasks",0);Q(this,"totalTasks",0);Q(this,"startTime",null);Q(this,"loadingScreen",null);Q(this,"progressBar",null);Q(this,"progressText",null);Q(this,"statusText",null);Q(this,"initialized",!1);Q(this,"cache",{fonts:new Map,icons:new Map,modules:new Map});Q(this,"diagnostics",[])}createLoadingScreen(){this.loadingScreen||(this.loadingScreen=document.createElement("div"),this.loadingScreen.id="app-loading-screen",this.loadingScreen.innerHTML=`
            <div class="loading-container">
                <div class="loading-logo">
                    <svg viewBox="0 0 100 100" class="logo-svg">
                        <circle cx="50" cy="50" r="45" class="logo-circle" />
                        <path d="M 30 50 Q 50 30, 70 50 T 70 70" class="logo-path" />
                    </svg>
                </div>
                <h1 class="loading-title">Student Notation</h1>
                <div class="loading-progress-container">
                    <div class="loading-progress-bar">
                        <div class="loading-progress-fill" id="loading-progress-fill"></div>
                    </div>
                    <div class="loading-progress-text" id="loading-progress-text">0%</div>
                </div>
                <div class="loading-status" id="loading-status">Initializing...</div>
            </div>
        `,document.body.appendChild(this.loadingScreen),this.progressBar=document.getElementById("loading-progress-fill"),this.progressText=document.getElementById("loading-progress-text"),this.statusText=document.getElementById("loading-status"))}registerTask(t,e=1){this.tasks.push({name:t,weight:e,completed:!1}),this.totalTasks+=e}completeTask(t){const e=this.tasks.find(i=>i.name===t&&!i.completed);e&&(e.completed=!0,this.completedTasks+=e.weight,this.updateProgress())}updateProgress(){if(!this.progressBar||!this.progressText)return;const t=this.totalTasks>0?this.completedTasks/this.totalTasks*100:0;this.progressBar.style.width=`${t}%`,this.progressText.textContent=`${Math.floor(t)}%`,t>=100&&this.completeLoading()}setStatus(t){this.statusText&&(this.statusText.textContent=t)}start(){this.initialized||(this.initialized=!0,this.startTime=performance.now())}completeLoading(){this.loadingScreen&&(this.loadingScreen.classList.add("fade-out"),setTimeout(()=>{var t;(t=this.loadingScreen)==null||t.remove(),this.loadingScreen=null},400))}showError(t){if(this.statusText){const e=t instanceof Error?t.message:String(t);this.statusText.textContent=`Error: ${e}`,this.statusText.style.color="#ff4444"}}init(){this.createLoadingScreen(),this.start()}updateStatus(t){this.setStatus(t)}async complete(){this.completeLoading()}async preloadIcon(t){if(this.cache.icons.has(t))return this.cache.icons.get(t);const e=Bf(t);return this.cache.icons.set(t,e),e}getDiagnostics(){return[...this.diagnostics]}}const vs=new uM;let lp=!1,cp=[],ec=null;function dy(){lp=!0}function hM(){lp=!1}function fy(s){try{return JSON.parse(JSON.stringify(s,(t,e)=>e instanceof Float32Array?{__type:"Float32Array",data:Array.from(e)}:e))}catch{return null}}function yf(s,t,e="root"){const i=[];if(!s||!t)return i;if(typeof s!=typeof t)return i.push({path:e,type:"type_change",oldValue:typeof s,newValue:typeof t,timestamp:Date.now()}),i;if(typeof s!="object")return s!==t&&i.push({path:e,type:"value_change",oldValue:s,newValue:t,timestamp:Date.now()}),i;if(Array.isArray(s)){if(!Array.isArray(t))return i.push({path:e,type:"array_to_non_array",oldLength:s.length,newType:typeof t,timestamp:Date.now()}),i;s.length!==t.length&&i.push({path:e,type:"array_length_change",oldLength:s.length,newLength:t.length,timestamp:Date.now()});const r=Math.max(s.length,t.length);for(let a=0;a<r;a++){const l=yf(s[a],t[a],`${e}[${a}]`);i.push(...l)}return i}const A=new Set([...Object.keys(s),...Object.keys(t)]);for(const r of A)if(!(r in s))i.push({path:`${e}.${String(r)}`,type:"property_added",newValue:t[r],timestamp:Date.now()});else if(!(r in t))i.push({path:`${e}.${String(r)}`,type:"property_removed",oldValue:s[r],timestamp:Date.now()});else{const a=yf(s[r],t[r],`${e}.${String(r)}`);i.push(...a)}return i}function dM(s){ec=fy(s)}function fM(s,t="unknown"){if(!lp||!ec)return;const e=fy(s),i=yf(ec,e);if(i.length>0){const A=i.filter(r=>!r.path.includes("paint.paintHistory")&&!r.path.includes("tempo")&&!r.path.includes("isPlaying")&&!r.path.includes("fullRowData")&&!r.path.includes("columnWidths"));A.length>0&&cp.push({action:t,mutations:A,timestamp:Date.now()})}ec=e}function pM(){return[...cp]}function mM(){cp=[]}typeof window<"u"&&(window.stateGuard={enable:dy,disable:hM,getLog:pM,clearLog:mM});b.moduleLoaded("RhythmPlaybackService");class gM{constructor(){Q(this,"scheduledEvents",[]);Q(this,"isInitialized",!1);this.scheduledEvents=[],this.isInitialized=!1}init(){return this.initialize()}refresh(){this.stopCurrentPattern()}async initialize(){this.isInitialized||(await Z.start(),this.isInitialized=!0,b.info("RhythmPlaybackService","Initialized"),window.rhythmPlaybackService=this)}playRhythmPattern(t,e,i,A="oval",r=null){if(!this.isInitialized){b.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const a=ny(t,r);if(!a||a.length===0){b.warn("RhythmPlaybackService",`No events found for stamp ${t}`);return}b.debug("RhythmPlaybackService",`Playing pattern for stamp ${t}: ${a.length} notes`,{stampId:t,basePitch:e,color:i,events:a,hasShapeOffsets:!!(r!=null&&r.shapeOffsets)});const l=Z.now(),u=r==null?void 0:r.row;a.forEach((h,m)=>{try{const g=Z.Time(String(h.offset)).toSeconds(),w=l+g,C=Z.Time(String(h.duration)).toSeconds(),y=A==="circle"?C*2:C,E=w+y;let x=e;if(u!==void 0&&h.rowOffset!==0){const T=u+h.rowOffset,U=d.state.fullRowData[T];U&&(x=U.toneNote.replace("","b").replace("","#"))}Gt.triggerAttack(x,i,w),Gt.triggerRelease(x,i,E),this.scheduledEvents.push({pitch:x,color:i,attackTime:w,releaseTime:E})}catch(g){b.warn("RhythmPlaybackService",`Error scheduling note ${m+1}`,g)}}),b.info("RhythmPlaybackService",`Scheduled ${a.length} notes for rhythm pattern ${t}`)}stopCurrentPattern(){this.scheduledEvents.length!==0&&(b.debug("RhythmPlaybackService",`Clearing ${this.scheduledEvents.length} scheduled events`),Gt.releaseAll(),this.scheduledEvents=[])}getStampAtPosition(t,e){return d.state.stampPlacements&&d.state.stampPlacements.find(A=>{const r=A.row===e,a=t>=A.startColumn&&t<=A.endColumn;return r&&a})||null}playTripletPattern(t,e,i,A=null){if(!this.isInitialized){b.warn("RhythmPlaybackService","Not initialized, call initialize() first");return}this.stopCurrentPattern();const r=Ay(t,A);if(!r||r.length===0){b.warn("RhythmPlaybackService",`No events found for triplet ${t}`);return}b.debug("RhythmPlaybackService",`Playing triplet pattern ${t}: ${r.length} notes`,{tripletStampId:t,basePitch:e,color:i,events:r,hasShapeOffsets:!!(A!=null&&A.shapeOffsets)});const a=Z.now(),l=A==null?void 0:A.row;r.forEach((u,h)=>{try{const m=Z.Time(u.offset).toSeconds(),g=a+m,w=Z.Time(u.duration).toSeconds(),C=g+w;let y=e;if(l!==void 0&&u.rowOffset!==0){const E=l+u.rowOffset,x=d.state.fullRowData[E];x&&(y=x.toneNote.replace("?T-","b").replace("?T_","#"))}Gt.triggerAttack(y,i,g),Gt.triggerRelease(y,i,C),this.scheduledEvents.push({pitch:y,color:i,attackTime:g,releaseTime:C})}catch(m){b.warn("RhythmPlaybackService",`Error scheduling triplet note ${h+1}`,m)}}),b.info("RhythmPlaybackService",`Scheduled ${r.length} notes for triplet pattern ${t}`)}getTripletAtPosition(t,e){return d.state.tripletPlacements&&d.state.tripletPlacements.find(i=>i.row===e&&t>=i.startCellIndex&&t<i.startCellIndex+i.span)||null}dispose(){this.stopCurrentPattern(),this.isInitialized=!1,b.info("RhythmPlaybackService","Disposed")}}const As=new gM,py=[];function Qe(...s){py.push(s)}const my={enableModulationTool(){d.setSelectedTool("modulation"),Qe("[MODULATION TEST] Modulation tool enabled. Click on the grid to place markers."),Qe("[MODULATION TEST] Click marker labels to toggle 2:3  3:2"),Qe("[MODULATION TEST] Drag marker barlines to move them")},addTestMarker(){const t=this.findNearestGridLine(200),e=this.findMeasureIndexForX(t.x),i=d.addModulationMarker(e,an.COMPRESSION_2_3,t.x,t.columnIndex);return Qe("[MODULATION TEST] Added test marker at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",200,")"),i},addTestMarker2(){const t=this.findNearestGridLine(400),e=this.findMeasureIndexForX(t.x),i=d.addModulationMarker(e,an.EXPANSION_3_2,t.x,t.columnIndex);return Qe("[MODULATION TEST] Added test marker 2 at measure",e,"columnIndex=",t.columnIndex,"x=",t.x,"(snapped from",400,")"),i},findNearestGridLine(s){const t=d.state;let e=0,i=0,A=1/0,r=0;for(let a=0;a<t.columnWidths.length;a++){const l=Math.abs(r-s);l<A&&(A=l,i=r,e=a);const u=t.columnWidths[a]||0;r+=u*t.cellWidth}return Qe("[MODULATION TEST] findNearestGridLine:",{targetX:s,closestColumnIndex:e,closestX:i,minDistance:A}),{columnIndex:e,x:i}},findMeasureIndexForX(s){const t=d.state.cellWidth||40,e=5,i=Math.round(s/t);return Math.max(1,Math.round(i/e))},clearAllMarkers(){[...d.state.modulationMarkers||[]].forEach(t=>{d.removeModulationMarker(t.id)}),Qe("[MODULATION TEST] Cleared all markers")},testMapping(){var e;const s=d.state.baseMicrobeatPx||d.state.cellWidth||40;Qe("[MODULATION TEST] Base microbeat pixels:",s),Qe("[MODULATION TEST] Modulation markers:",d.state.modulationMarkers);const t=typeof window<"u"?(e=window.getModulationMapping)==null?void 0:e.call(window):void 0;t&&(Qe("[MODULATION TEST] Coordinate mapping:",t),[0,100,200,300,400,500].forEach(A=>{const r=t.canvasXToMicrobeat(A),a=t.microbeatToCanvasX(r);Qe(`[MODULATION TEST] x=${A}  microbeat=${r.toFixed(3)}  x=${a.toFixed(1)}`)}))},testVisualExpansion(){var t;Qe("[MODULATION TEST] Testing visual grid expansion..."),this.clearAllMarkers();const s=this.addTestMarker2();Qe("[MODULATION TEST] Added 3:2 expansion marker:",s),typeof window<"u"&&((t=window.LayoutService)!=null&&t.recalculateLayout)&&(Qe("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{Qe("[MODULATION TEST] Grid should now show expansion after x=400"),Qe("[MODULATION TEST] Container should be wider to accommodate expansion"),Qe("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},testVisualCompression(){var t;Qe("[MODULATION TEST] Testing visual grid compression..."),this.clearAllMarkers();const s=this.addTestMarker();Qe("[MODULATION TEST] Added 2:3 compression marker:",s),typeof window<"u"&&((t=window.LayoutService)!=null&&t.recalculateLayout)&&(Qe("[MODULATION TEST] Manually triggering layout recalculation..."),window.LayoutService.recalculateLayout()),setTimeout(()=>{Qe("[MODULATION TEST] Grid should now show compression after x=200"),Qe("[MODULATION TEST] Container should adjust to accommodate compression"),Qe("[MODULATION TEST] Check console for [LAYOUT], [GETCOLX], [GRIDLINES], and [NOTES] logs")},100)},logState(){Qe("[MODULATION TEST] Current state:",{selectedTool:d.state.selectedTool,modulationMarkers:d.state.modulationMarkers,baseMicrobeatPx:d.state.baseMicrobeatPx,cellWidth:d.state.cellWidth})}};typeof window<"u"&&(window.ModulationTest=my,window.ModulationTestLogs=py);function wM(){const s=document.getElementById("anacrusis-on-btn"),t=document.getElementById("anacrusis-off-btn");!s||!t||(s.addEventListener("click",()=>d.setAnacrusis(!0)),t.addEventListener("click",()=>d.setAnacrusis(!1)),d.on("anacrusisChanged",e=>{const i=e;s.classList.toggle("active",i),t.classList.toggle("active",!i)}),s.classList.toggle("active",d.state.hasAnacrusis),t.classList.toggle("active",!d.state.hasAnacrusis))}function vM(){const s=document.getElementById("hide-drumgrid-toggle"),t=document.getElementById("drum-grid-wrapper");let e=!0;s&&t&&s.addEventListener("click",()=>{e=!e,t.style.display=e?"flex":"none";const i=s.querySelector(".sidebar-button-text");i&&(i.textContent=e?"Hide Drum Grid":"Show Drum Grid"),setTimeout(()=>Ot.recalculateLayout(),10)})}function BM(){const s=document.getElementById("settings-button"),t=document.getElementById("sidebar"),e=document.getElementById("sidebar-overlay"),i=document.getElementById("volume-icon-button"),A=document.getElementById("volume-popup"),r=document.getElementById("vertical-volume-slider"),a=()=>{document.body.classList.toggle("sidebar-open")};if(s&&t&&e&&(s.addEventListener("click",a),e.addEventListener("click",a)),i&&A&&r){const l="app.volumeSliderValue",u=w=>Math.min(100,Math.max(0,w)),h=()=>{try{const w=window.localStorage.getItem(l);if(w!==null){const C=Number(w);if(!Number.isNaN(C))return u(C)}}catch{}return 70},m=w=>{try{window.localStorage.setItem(l,String(u(w)))}catch{}},g=h();r.value=String(g),i.addEventListener("click",w=>{w.stopPropagation();const C=A.classList.toggle("visible");i.classList.toggle("active",C)}),r.addEventListener("input",function(){const w=parseInt(this.value,10),C=w===0?-1/0:w/100*37.5-50;d.emit("volumeChanged",C),m(w)}),document.addEventListener("click",w=>{!A.contains(w.target)&&w.target!==i&&(A.classList.remove("visible"),i.classList.remove("active"))}),r.dispatchEvent(new Event("input"))}wM(),vM()}function gy(){const s=new Date,t=s.toLocaleDateString("en-US",{month:"long"}),e=s.getDate();return`SN-score-${t}${e}.csv`}async function yM(s){try{const t={suggestedName:gy(),types:[{description:"Student Notation CSV File",accept:{"text/csv":[".csv"]}}]},i=await(await window.showSaveFilePicker(t)).createWritable();await i.write(s),await i.close()}catch(t){t.name!=="AbortError"&&b.error("FileActionsInitializer","Error saving file with picker",t,"toolbar")}}function CM(s){const t=document.createElement("a"),e=URL.createObjectURL(s);t.setAttribute("href",e),t.setAttribute("download",gy()),document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}function bM(){return d.state.placedNotes.map(s=>[s.row,s.startColumnIndex,s.endColumnIndex,s.color,s.shape,s.tonicNumber||"",s.isDrum,s.drumTrack||""].join(",")).join(`
`)}function _M(){var s,t,e,i;(s=document.getElementById("save-as-button"))==null||s.addEventListener("click",()=>void(async()=>{const A=bM(),r=new Blob([A],{type:"text/csv;charset=utf-8;"});window.showSaveFilePicker?await yM(r):CM(r)})()),(t=document.getElementById("import-button"))==null||t.addEventListener("click",()=>{const A=document.createElement("input");A.type="file",A.accept=".csv,.txt",A.onchange=r=>{var h;const l=(h=r.target.files)==null?void 0:h[0];if(!l)return;const u=new FileReader;u.onload=m=>{var y;const g=(y=m.target)==null?void 0:y.result;if(!g){b.warn("FileActionsInitializer","Imported file was empty",null,"toolbar");return}const w=new Set(["circle","oval","diamond"]),C=[];if(g.split(`
`).map(E=>E.trim()).filter(E=>E.length>0).forEach(E=>{const x=E.split(",");if(x.length<7){b.warn("FileActionsInitializer","Skipping invalid note row",{line:E},"toolbar");return}const T=Number.parseInt(x[0]??"",10),U=Number.parseInt(x[1]??"",10),H=Number.parseInt(x[2]??"",10),R=(x[3]??"").trim(),D=(x[4]??"").trim().toLowerCase(),P=x[5]?Number.parseInt(x[5],10):null,G=(x[6]??"").trim().toLowerCase()==="true",Y=x[7]?Number.parseInt(x[7],10):null,W=typeof Y=="number"&&Number.isFinite(Y)?Y:void 0;if(!R){b.warn("FileActionsInitializer","Skipping note with missing color",{line:E},"toolbar");return}if(!Number.isFinite(T)||!Number.isFinite(U)||!Number.isFinite(H)){b.warn("FileActionsInitializer","Skipping note with invalid coordinates",{line:E},"toolbar");return}const at=w.has(D)?D:"circle";w.has(D)||b.warn("FileActionsInitializer",`Unknown shape "${D}", defaulting to circle`,null,"toolbar"),C.push({row:T,startColumnIndex:U,endColumnIndex:H,color:R,shape:at,tonicNumber:P,isDrum:G,drumTrack:W})}),C.length===0){b.warn("FileActionsInitializer","No valid notes found in imported file",null,"toolbar");return}d.loadNotes(C)},u.readAsText(l)},A.click()}),(e=document.getElementById("print-button"))==null||e.addEventListener("click",()=>{document.body.classList.remove("sidebar-open"),d.emit("printPreviewStateChanged",!0)}),(i=document.getElementById("reset-canvas-button"))==null||i.addEventListener("click",()=>{window.confirm("Are you sure you want to reset the canvas? This will clear all your work and cannot be undone.")&&d.clearSavedState()})}const Jc={selectedStampId:1,updateStampColors:s=>{},init(){this.render(),this.bindEvents(),b.info("StampsToolbar","Stamps toolbar initialized",null,"stamps")},render(){const s=document.getElementById("stamps-toolbar-container");if(!s){b.warn("StampsToolbar","Container not found",null,"stamps");return}s.innerHTML="";const t=document.createElement("div");t.className="stamps-grid",[[1,2,3,4],[5,8,14,6,9,7],[10,13,12,11,15]].forEach((i,A)=>{const r=document.createElement("div");r.className=`stamps-row stamps-row-${A+1}`,i.forEach(a=>{const l=Nd.find(u=>u.id===a);if(l){const u=this.createStampButton(l);r.appendChild(u)}}),t.appendChild(r)}),s.appendChild(t),this.setInitialSelection(this.selectedStampId)},createStampButton(s){const t=document.createElement("button");t.className="stamp-button",t.dataset.stampId=`${s.id}`,t.setAttribute("title",`${s.id}: ${s.label}`);const e=this.createStampPreview(s);return t.appendChild(e),t},createStampPreview(s){const t=jf.renderToSVG(s,100,100);return t.setAttribute("width","40"),t.setAttribute("height","40"),t},bindEvents(){const s=document.getElementById("stamps-toolbar-container");if(!s)return;s.addEventListener("click",e=>{var A;const i=(A=e.target)==null?void 0:A.closest(".stamp-button");if(i){const r=parseInt(i.dataset.stampId||"",10);Number.isNaN(r)||this.selectStamp(r)}}),this.updateStampColors=e=>{if(!e||!s)return;const i=(h,m=50)=>{const g=parseInt(h.slice(1,3),16),w=parseInt(h.slice(3,5),16),C=parseInt(h.slice(5,7),16),y=Math.min(255,Math.floor(g+(255-g)*(m/100))),E=Math.min(255,Math.floor(w+(255-w)*(m/100))),x=Math.min(255,Math.floor(C+(255-C)*(m/100)));return`#${y.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}${x.toString(16).padStart(2,"0")}`},A=(h,m=20)=>{const g=parseInt(h.slice(1,3),16),w=parseInt(h.slice(3,5),16),C=parseInt(h.slice(5,7),16),y=Math.max(0,Math.floor(g*(1-m/100))),E=Math.max(0,Math.floor(w*(1-m/100))),x=Math.max(0,Math.floor(C*(1-m/100)));return`#${y.toString(16).padStart(2,"0")}${E.toString(16).padStart(2,"0")}${x.toString(16).padStart(2,"0")}`},r=d.state.colorPalette[e]||{primary:e,light:e},a=i(r.light,60),l=r.primary,u=A(l,20);s.style.setProperty("--c-accent",l),s.style.setProperty("--c-accent-light",a),s.style.setProperty("--c-accent-hover",u)},d.on("noteChanged",({newNote:e})=>{e.color&&this.updateStampColors(e.color)});const t=d.state.selectedNote;t!=null&&t.color&&this.updateStampColors(t.color),d.on("toolChanged",({newTool:e})=>{e!=="stamp"&&this.clearSelection()}),d.on("tripletToolSelected",()=>{this.clearSelection()})},setInitialSelection(s){this.selectedStampId=s;const t=document.getElementById("stamps-toolbar-container");t&&t.querySelectorAll(".stamp-button").forEach(e=>{const i=e;i.classList.toggle("active",parseInt(i.dataset.stampId||"",10)===s)})},selectStamp(s){this.selectedStampId=s;const t=document.getElementById("stamps-toolbar-container");t&&t.querySelectorAll(".stamp-button").forEach(e=>{const i=e;i.classList.toggle("active",parseInt(i.dataset.stampId||"",10)===s)}),d.setSelectedTool("stamp"),d.emit("stampSelected",s),d.emit("stampToolSelected")},clearSelection(){const s=document.getElementById("stamps-toolbar-container");s&&s.querySelectorAll(".stamp-button").forEach(t=>{t.classList.remove("active")})},getSelectedStamp(){return Nd.find(t=>t.id===this.selectedStampId)}};class xM{constructor(){Q(this,"overlay");Q(this,"modal");Q(this,"title");Q(this,"message");Q(this,"actionsContainer");Q(this,"closeButton");var t,e,i,A,r;this.overlay=document.getElementById("notification-overlay"),this.modal=(t=this.overlay)==null?void 0:t.querySelector(".notification-modal"),this.title=(e=this.overlay)==null?void 0:e.querySelector(".notification-title"),this.message=(i=this.overlay)==null?void 0:i.querySelector(".notification-message"),this.actionsContainer=(A=this.overlay)==null?void 0:A.querySelector(".notification-actions"),this.closeButton=(r=this.overlay)==null?void 0:r.querySelector(".notification-close"),this.setupEventListeners()}setupEventListeners(){var t;this.overlay&&((t=this.closeButton)==null||t.addEventListener("click",()=>this.hide()),this.overlay.addEventListener("click",e=>{e.target===this.overlay&&this.hide()}),document.addEventListener("keydown",e=>{var i;e.key==="Escape"&&((i=this.overlay)!=null&&i.classList.contains("visible"))&&this.hide()}))}show(t={}){const e=this.overlay;if(!e)return;const{title:i="Notice",message:A="",buttons:r=[{text:"OK",primary:!0,action:()=>this.hide()}]}=t;this.title&&(this.title.textContent=i),this.message&&(this.message.textContent=A);const a=this.actionsContainer;a&&(a.innerHTML="",r.forEach(l=>{const u=document.createElement("button");u.className=`notification-button ${l.primary?"":"secondary"}`,u.textContent=l.text,u.addEventListener("click",()=>{l.action?l.action():this.hide()}),a.appendChild(u)})),e.classList.add("visible"),setTimeout(()=>{var u;const l=(u=this.actionsContainer)==null?void 0:u.querySelector(".notification-button");l==null||l.focus()},100)}hide(){this.overlay&&this.overlay.classList.remove("visible")}alert(t,e="Notice"){this.show({title:e,message:t,buttons:[{text:"OK",primary:!0,action:()=>this.hide()}]})}confirm(t,e="Confirm"){return new Promise(i=>{this.show({title:e,message:t,buttons:[{text:"Cancel",primary:!1,action:()=>{this.hide(),i(!1)}},{text:"OK",primary:!0,action:()=>{this.hide(),i(!0)}}]})})}}const bw=new xM;function Ml(s,...t){}const Cf=40,EM=Cf;class _w{constructor(t,e,i,A){Q(this,"element");Q(this,"viewportEl");Q(this,"optionsEl");Q(this,"onChange");Q(this,"options");Q(this,"optionNodes",[]);Q(this,"selectedIndex",0);Q(this,"pointerActive",!1);Q(this,"pointerId",null);Q(this,"lastPointerY",0);Q(this,"deltaBuffer",0);Q(this,"silent",!1);Q(this,"optionHeight",Cf);Q(this,"resizeObserver",null);Q(this,"debugLabel");this.element=t,this.viewportEl=t==null?void 0:t.querySelector(".clef-wheel-viewport"),this.optionsEl=t==null?void 0:t.querySelector(".clef-wheel-options"),this.onChange=A,this.options=e,this.debugLabel=(t==null?void 0:t.id)||"clef-wheel",!(!t||!this.viewportEl||!this.optionsEl)&&(this.renderOptions(),this.setIndex(i,{silent:!0}),this.attachEvents(),this.observeSize())}renderOptions(){this.optionsEl&&(this.optionsEl.innerHTML="",this.optionNodes=this.options.map((t,e)=>{const i=document.createElement("div");return i.className="clef-wheel-option",i.dataset.index=e.toString(),i.textContent=t.label,this.optionsEl.appendChild(i),i}))}attachEvents(){if(!this.element)return;this.element.addEventListener("wheel",e=>{e.preventDefault(),e.stopPropagation();const i=Math.sign(e.deltaY);i!==0&&this.increment(i)},{passive:!1}),this.element.addEventListener("keydown",e=>{e.key==="ArrowUp"?(e.preventDefault(),this.increment(-1)):e.key==="ArrowDown"?(e.preventDefault(),this.increment(1)):e.key==="Home"?(e.preventDefault(),this.setIndex(0)):e.key==="End"&&(e.preventDefault(),this.setIndex(this.options.length-1))}),this.element.addEventListener("pointerdown",e=>{if(this.pointerActive=!0,this.pointerId=e.pointerId,this.lastPointerY=e.clientY,this.deltaBuffer=0,typeof this.element.setPointerCapture=="function")try{this.element.setPointerCapture(this.pointerId)}catch{}}),this.element.addEventListener("pointermove",e=>{if(!this.pointerActive||e.pointerId!==this.pointerId)return;const i=e.clientY-this.lastPointerY;if(this.lastPointerY=e.clientY,i===0)return;this.deltaBuffer+=i;const A=this.optionHeight||EM;for(;Math.abs(this.deltaBuffer)>=A;){const r=-Math.sign(this.deltaBuffer);this.increment(r),this.deltaBuffer-=Math.sign(this.deltaBuffer)*A}});const t=e=>{this.pointerActive&&e.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,this.element.hasPointerCapture(e.pointerId)&&this.element.releasePointerCapture(e.pointerId))};this.element.addEventListener("pointerup",t),this.element.addEventListener("pointercancel",t),this.element.addEventListener("pointerleave",e=>{var i,A;this.pointerActive&&e.pointerId===this.pointerId&&(this.pointerActive=!1,this.pointerId=null,this.deltaBuffer=0,(A=(i=this.element)==null?void 0:i.hasPointerCapture)!=null&&A.call(i,e.pointerId)&&this.element.releasePointerCapture(e.pointerId))})}observeSize(){this.element&&(typeof ResizeObserver=="function"?(this.resizeObserver=new ResizeObserver(t=>{for(const e of t)e.target===this.element&&e.contentRect.height>0&&this.updateVisuals()}),this.resizeObserver.observe(this.element)):window.addEventListener("resize",()=>this.updateVisuals()))}getIndex(){return this.selectedIndex}increment(t){if(t===0||!this.options||this.options.length===0)return;const e=this.selectedIndex+t;this.setIndex(e)}setIndex(t,{silent:e=!1}={}){if(!this.optionsEl)return;const i=Math.max(0,Math.min(this.options.length-1,t));if(i===this.selectedIndex){this.updateVisuals();return}this.selectedIndex=i,this.updateVisuals(),!e&&typeof this.onChange=="function"&&this.onChange(i,this.options[i])}updateVisuals(){var l,u;if(!this.optionsEl||!this.viewportEl)return;const t=this.viewportEl.clientHeight||0,e=(l=this.optionNodes)==null?void 0:l[this.selectedIndex],i=(u=this.optionNodes)==null?void 0:u[0],A=(e==null?void 0:e.offsetHeight)||(i==null?void 0:i.offsetHeight)||Cf;if(this.optionHeight=A,this.optionNodes&&this.optionNodes.forEach((h,m)=>{const g=Math.abs(m-this.selectedIndex),w=Math.min(g,3);h.dataset.distance=String(w)}),t===0||A===0)return;const r=Math.max(0,(t-A)/2);this.optionsEl.style.paddingTop=`${r}px`,this.optionsEl.style.paddingBottom=`${r}px`;let a=0;if(e){const h=e.offsetTop+A/2;a=t/2-h}else a=t/2-(r+A/2);this.optionsEl.style.transform=`translateY(${a}px)`}}class SM{constructor(){Q(this,"initialized",!1);Q(this,"topPicker",null);Q(this,"bottomPicker",null);Q(this,"suppressStoreSync",!1);Q(this,"snapToggle",null);Q(this,"lockToggle",null);Q(this,"presetContainer",null);Q(this,"presetButtons",[]);Q(this,"activePresetId",null);Q(this,"presetRanges",{});Q(this,"topWheel",null);Q(this,"bottomWheel",null);Q(this,"rangeLabel",null);Q(this,"rangeCount",null);Q(this,"fullRangeButton",null);Q(this,"trebleButton",null);Q(this,"altoButton",null);Q(this,"bassButton",null);Q(this,"masterOptions",[]);Q(this,"currentRange",null);Q(this,"lastTopIndex",0);Q(this,"lastBottomIndex",0)}init(){if(this.initialized)return;if(this.topWheel=document.getElementById("clef-top-wheel"),this.bottomWheel=document.getElementById("clef-bottom-wheel"),this.rangeLabel=document.getElementById("clef-range-label"),this.rangeCount=document.getElementById("clef-range-count"),this.fullRangeButton=document.getElementById("clef-full-range-button"),this.trebleButton=document.getElementById("clef-treble-button"),this.altoButton=document.getElementById("clef-alto-button"),this.bassButton=document.getElementById("clef-bass-button"),this.lockToggle=document.getElementById("clef-lock-toggle"),this.lockToggle?b.info("ClefRangeController","Lock Range toggle found",{checked:this.lockToggle.checked},"ui"):b.warn("ClefRangeController","Lock Range toggle not found in DOM",null,"ui"),this.presetContainer=document.querySelector(".clef-preset-buttons"),this.presetButtons=Array.from(document.querySelectorAll(".clef-preset-button")),!this.topWheel||!this.bottomWheel){b.warn("ClefRangeController","Clef tab elements not found; skipping initialization",null,"ui");return}this.calculateAndSetWheelHeight(),window.addEventListener("resize",()=>this.calculateAndSetWheelHeight()),this.masterOptions=me.map((e,i)=>({index:i,label:e.pitch,toneNote:e.toneNote,frequency:e.frequency}));const t=this.normaliseRange(d.state.pitchRange,this.masterOptions.length);if(this.topPicker=new _w(this.topWheel,this.masterOptions,t.topIndex,e=>this.handleTopSelection(e)),this.bottomPicker=new _w(this.bottomWheel,this.masterOptions,t.bottomIndex,e=>this.handleBottomSelection(e)),this.fullRangeButton&&this.fullRangeButton.addEventListener("click",()=>this.setPresetRange("full")),this.trebleButton&&this.trebleButton.addEventListener("click",()=>this.setPresetRange("treble")),this.altoButton&&this.altoButton.addEventListener("click",()=>this.setPresetRange("alto")),this.bassButton&&this.bassButton.addEventListener("click",()=>this.setPresetRange("bass")),this.lockToggle){const e=d.state.isPitchRangeLocked!==!1;this.lockToggle.checked=e,this.lockToggle.addEventListener("change",()=>{this.handleLockToggle(this.lockToggle.checked)})}d.on("pitchRangeChanged",e=>{this.syncFromStore(e)}),d.on("pitchRangeLockChanged",e=>{this.lockToggle&&(this.lockToggle.checked=e),this.updatePresetStyles()}),this.computePresetRanges(),this.currentRange=t,this.lastTopIndex=t.topIndex,this.lastBottomIndex=t.bottomIndex,this.updatePresetHighlightFromRange(t),this.updateSummary(),this.initialized=!0,b.moduleLoaded("ClefRangeController","ui")}normaliseRange(t,e){const i={topIndex:0,bottomIndex:e-1};if(!t)return i;const A=Math.max(0,Math.min(e-1,t.topIndex)),r=Math.max(A,Math.min(e-1,t.bottomIndex));return{topIndex:A,bottomIndex:r}}handleTopSelection(t){const e=this.bottomPicker.getIndex(),i=Math.max(t,e);i!==e&&this.bottomPicker.setIndex(i,{silent:!0}),this.commitRangeChange(t,i)}handleBottomSelection(t){const e=this.topPicker.getIndex(),i=Math.min(t,e);i!==e&&this.topPicker.setIndex(i,{silent:!0}),this.commitRangeChange(i,t)}computePresetRanges(){const t={};t.full={topIndex:0,bottomIndex:this.masterOptions.length>0?this.masterOptions.length-1:0};const e=(i,A)=>{const r=this.findNoteIndex(i),a=this.findNoteIndex(A);return r===-1||a===-1?null:{topIndex:Math.min(r,a),bottomIndex:Math.max(r,a)}};t.treble=e("A/G5","C4"),t.alto=e("B/A4","D3"),t.bass=e("D/C4","F2"),this.presetRanges=t}updatePresetHighlightFromRange(t){if(!t)return;let e=null;Object.entries(this.presetRanges||{}).forEach(([i,A])=>{A&&A.topIndex===t.topIndex&&A.bottomIndex===t.bottomIndex&&(e=i)}),this.activePresetId=e,this.updatePresetStyles()}updatePresetStyles(){var e;const t=d.state.isPitchRangeLocked!==!1;this.presetContainer&&this.presetContainer.classList.toggle("locked",t),(e=this.presetButtons)!=null&&e.length&&this.presetButtons.forEach(i=>{var a;const A=(a=i.dataset)!=null&&a.preset?i.dataset.preset:(i.id||"").replace(/^clef-/,"").replace(/-button$/,"").replace(/-range$/,"").replace(/-/g,""),r=this.activePresetId&&A===this.activePresetId;i.classList.toggle("active",!!r)})}commitRangeChange(t,e){var h;const i=this.currentRange||d.state.pitchRange||{topIndex:0},A=Math.max(0,Math.min(this.masterOptions.length-1,t)),r=Math.max(A,Math.min(this.masterOptions.length-1,e));if(Ml("log","[CommitRange] Current range:",this.currentRange),((h=this.currentRange)==null?void 0:h.topIndex)===A&&this.currentRange.bottomIndex===r)return;let a=null;if(Ot!=null&&Ot.getViewportInfo){const m=Ot.getViewportInfo();m&&(a=(i.topIndex??0)+m.startRank)}this.currentRange={topIndex:A,bottomIndex:r},this.lastTopIndex=A,this.lastBottomIndex=r,this.updateSummary(),this.updatePresetHighlightFromRange(this.currentRange);const l=d.state.isPitchRangeLocked!==!1,u=l;!l&&d.state.snapZoomToRange&&d.setSnapZoomToRange(!1),d.setPitchRange({topIndex:A,bottomIndex:r},{maintainGlobalStart:a,trimOutsideRange:u,preserveContent:!u}),l?(Ml("log",`[CommitRange] Snap zoom currently: ${d.state.snapZoomToRange}`),d.state.snapZoomToRange||d.setSnapZoomToRange(!0),Ml("log",`[CommitRange] Snap zoom now: ${d.state.snapZoomToRange}`),Ot&&typeof Ot.snapZoomToCurrentRange=="function"&&d.state.snapZoomToRange?Ot.snapZoomToCurrentRange():Ot&&typeof Ot.recalculateLayout=="function"&&Ot.recalculateLayout()):Ot&&typeof Ot.recalculateLayout=="function"&&Ot.recalculateLayout()}handleLockToggle(t){var A;const e=!!t;d.setPitchRangeLock(e);const i=this.currentRange||this.normaliseRange(d.state.pitchRange,this.masterOptions.length);e?this.commitRangeChange(i.topIndex,i.bottomIndex):(d.setSnapZoomToRange(!1),(A=Ot.recalculateLayout)==null||A.call(Ot))}syncFromStore(t){if(!this.initialized||!t)return;const e=this.normaliseRange(t,this.masterOptions.length);this.currentRange=e,this.topPicker&&this.topPicker.getIndex()!==e.topIndex&&this.topPicker.setIndex(e.topIndex,{silent:!0}),this.bottomPicker&&this.bottomPicker.getIndex()!==e.bottomIndex&&this.bottomPicker.setIndex(e.bottomIndex,{silent:!0}),this.updateSummary(t.metadata),this.updatePresetHighlightFromRange(e)}updateSummary(t){if(!this.currentRange)return;const e=this.masterOptions[this.currentRange.topIndex],i=this.masterOptions[this.currentRange.bottomIndex],A=this.currentRange.bottomIndex-this.currentRange.topIndex+1;if(this.rangeLabel&&(this.rangeLabel.textContent=`${i.label}  ${e.label}`),this.rangeCount&&(this.rangeCount.textContent=`${A} ${A===1?"pitch":"pitches"}`),t){const{removedNotes:r=0,removedStamps:a=0,removedTriplets:l=0}=t,u=r+a+l;u>0&&b.info("ClefRangeController",`Range change removed: ${u} items`,t,"ui")}}resetRange(){this.topPicker.setIndex(0,{silent:!0}),this.bottomPicker.setIndex(this.masterOptions.length-1,{silent:!0}),this.commitRangeChange(0,this.masterOptions.length-1)}findNoteIndex(t){return this.masterOptions.findIndex(e=>e.label===t)}animateWheelToIndex(t,e,i=300){const A=t.getIndex(),r=e-A,a=performance.now(),l=u=>{const h=u-a,m=Math.min(h/i,1),g=1-Math.pow(1-m,3),w=Math.round(A+r*g);t.setIndex(w,{silent:m<1}),m<1?requestAnimationFrame(l):(t.selectedIndex=e,t.updateVisuals(),typeof t.onChange=="function"&&t.onChange(e,t.options[e]))};requestAnimationFrame(l)}setPresetRange(t){let e,i;switch(t){case"full":this.activePresetId=t,this.updatePresetStyles(),this.animateRangeTransition(0,this.masterOptions.length-1);return;case"treble":e="A/G5",i="C4";break;case"alto":e="B/A4",i="D3";break;case"bass":e="D/C4",i="F2";break;default:return}const A=this.findNoteIndex(e),r=this.findNoteIndex(i);if(A===-1||r===-1){b.warn("ClefRangeController",`Preset notes not found: ${e} or ${i}`,null,"ui");return}this.activePresetId=t,this.updatePresetStyles(),this.animateRangeTransition(A,r)}animateRangeTransition(t,e,i=500){const A=this.topPicker.getIndex(),r=this.bottomPicker.getIndex(),a=t-A,l=e-r,u=performance.now();let h=0;d.state.snapZoomToRange&&d.setSnapZoomToRange(!1);const g=Ot.getCurrentZoomLevel?Ot.getCurrentZoomLevel():1,C=this.calculateTargetZoom(t,e)-g,y=d.state.isPitchRangeLocked!==!1,E=x=>{const T=x-u,U=Math.min(T/i,1),H=U<.5?4*U*U*U:1-Math.pow(-2*U+2,3)/2,R=Math.round(A+a*H),D=Math.round(r+l*H),P=g+C*H;h++,(h%10===0||U===1)&&Ml("log",`[AnimateRange] Frame ${h}: progress=${(U*100).toFixed(1)}%, top=${R}, bottom=${D}, zoom=${Math.round(P*100)}%`),this.topPicker.setIndex(R,{silent:!0}),this.bottomPicker.setIndex(D,{silent:!0}),d.state.pitchRange={topIndex:R,bottomIndex:D},me&&me.length>0&&(d.state.fullRowData=me.slice(R,D+1)),this.currentRange={topIndex:R,bottomIndex:D},this.updateSummary(),Ot.setZoomLevel&&Ot.setZoomLevel(P),document.dispatchEvent(new CustomEvent("canvasResized",{detail:{source:"clefRangeAnimation"}})),U<1?requestAnimationFrame(E):(this.topPicker.selectedIndex=t,this.bottomPicker.selectedIndex=e,this.topPicker.updateVisuals(),this.bottomPicker.updateVisuals(),this.currentRange={topIndex:t,bottomIndex:e},this.lastTopIndex=t,this.lastBottomIndex=e,this.updateSummary(),this.updatePresetHighlightFromRange(this.currentRange),y?(d.setPitchRange({topIndex:t,bottomIndex:e}),d.setSnapZoomToRange(!0)):(d.setSnapZoomToRange(!1),d.setPitchRange({topIndex:t,bottomIndex:e},{trimOutsideRange:!1,preserveContent:!0})))};requestAnimationFrame(E)}calculateTargetZoom(t,e){const i=e-t+1;if(i===0)return 1;const A=document.getElementById("pitch-grid-container"),r=(A==null?void 0:A.clientHeight)||window.innerHeight*.7;if(!r||r<=0)return 1;const l=2*r/(i*30);return Math.max(.1,Math.min(5,l))}applyViewPresetRange(t,e){const i=this.calculateTargetZoom(t,e);Ot.setPendingStartRow&&Ot.setPendingStartRow(t),Ot.setZoomLevel?Ot.setZoomLevel(i):Ot.recalculateLayout&&Ot.recalculateLayout()}refreshWheelVisuals(){this.topPicker&&this.topPicker.updateVisuals(),this.bottomPicker&&this.bottomPicker.updateVisuals()}calculateAndSetWheelHeight(){const t=document.querySelector(".range-panel-section.wheels-section"),e=t==null?void 0:t.querySelector(".panel-section-title");if(!t||!this.topWheel||!this.bottomWheel)return;const i=t.clientHeight,A=(e==null?void 0:e.offsetHeight)||0,a=i-A-15,l=Math.max(120,Math.min(a,300));this.topWheel.style.setProperty("--clef-wheel-height",`${l}px`),this.bottomWheel.style.setProperty("--clef-wheel-height",`${l}px`),setTimeout(()=>{var u,h;(u=this.topPicker)==null||u.updateVisuals(),(h=this.bottomPicker)==null||h.updateVisuals()},0)}}const xw=new SM,FM={X:["1P","3M","5P"],x:["1P","3m","5P"],"x":["1P","3m","5d"],"X+":["1P","3M","5A"],"X":["1P","3M","5P","7m"],"x":["1P","3m","5P","7m"],"Xmaj":["1P","3M","5P","7M"],"":["1P","3m","5d","7m"],"x":["1P","3m","5d","6M"],"X":["1P","3M","5P","6M"],Xsus2:["1P","2M","5P"],Xsus4:["1P","4P","5P"]},TM={"xmaj":["1P","3m","5P","7M"],Xadd9:["1P","3M","5P","9M"],xadd9:["1P","3m","5P","9M"],"X6/9":["1P","3M","5P","6M","9M"],X9:["1P","3M","5P","7m","9M"],X11:["1P","3M","5P","7m","9M","11P"],X13:["1P","3M","5P","7m","9M","13M"],Xmaj9:["1P","3M","5P","7M","9M"],"x":["1P","3m","5P","7m","9M"],"x":["1P","3m","5P","6M"],"x":["1P","3m","5P","7m","9M","11P"],"Xmaj711":["1P","3M","5P","7M","11A"]},wy={...FM,...TM},bf={M6:["6M"],A6:["6A"],m7:["7m"],M7:["7M"],d5:["5d"],P5:["5P"],A5:["5A"],m6:["6m"],m3:["3m"],M3:["3M"],P4:["4P"],A4:["4A"],U:["1P"],m2:["2m"],M2:["2M"],A2:["2A"]},IM={"9m":"2m","9M":"2M","9A":"2A","11P":"4P","11A":"4A","13m":"6m","13M":"6M","13A":"6A"},Ew=15;function _f(s){return IM[s]??s}function Sw(){return Object.keys(d.state.tonicSignGroups).length>0}function Fw(){const s=document.getElementById("degree-mode-toggle");if(s){const t=d.state.degreeDisplayMode==="off";s.classList.toggle("disabled",t)}}function Tw(){var t;const s=document.querySelector("#chords-panel .chords-grid");if(s&&s.querySelectorAll(".harmony-preset-button").forEach(e=>{e.classList.remove("selected","partial-match")}),d.state.activeChordIntervals&&s){const e=d.state.activeChordIntervals,i=e.toString(),A=e.map(_f),r=s.querySelectorAll(".harmony-preset-button");for(const a of r){const l=((t=a.textContent)==null?void 0:t.trim())??"",u=wy[l];if(!u)continue;const h=u.toString(),m=u.map(_f);if(h===i){a.classList.add("selected");continue}A.every(w=>m.includes(w))&&a.classList.add("partial-match")}}}function Iw(){const s=document.querySelector("#chords-panel .intervals-4x4-grid");if(s&&(s.querySelectorAll(".harmony-preset-button").forEach(t=>t.classList.remove("selected")),d.state.activeChordIntervals)){const e=d.state.activeChordIntervals.map(_f);s.querySelectorAll(".harmony-preset-button").forEach(i=>{var a;const A=((a=i.textContent)==null?void 0:a.trim())??"",r=bf[A];r&&e.includes(r[0])&&i.classList.add("selected")})}}const Qw=(s,t=50)=>{const e=parseInt(s.slice(1,3),16),i=parseInt(s.slice(3,5),16),A=parseInt(s.slice(5,7),16),r=Math.min(255,Math.floor(e+(255-e)*(t/100))),a=Math.min(255,Math.floor(i+(255-i)*(t/100))),l=Math.min(255,Math.floor(A+(255-A)*(t/100)));return`#${r.toString(16).padStart(2,"0")}${a.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`},Ul=(s,t=1)=>{const e=s.startsWith("#")?s.slice(1):s;if(e.length!==6)return s;const i=parseInt(e.slice(0,2),16),A=parseInt(e.slice(2,4),16),r=parseInt(e.slice(4,6),16);return`rgba(${i}, ${A}, ${r}, ${t})`},Mw=(s,t)=>{if(!s)return;const e=Qw(t,50),i=Qw(e,60);s.style.setProperty("--c-accent",t),s.style.setProperty("--c-accent-light",i),s.style.setProperty("--harmony-partial-bg",Ul(i,.25)),s.style.setProperty("--harmony-partial-border",Ul(t,.4)),s.style.setProperty("--harmony-partial-bg-hover",Ul(i,.4)),s.style.setProperty("--harmony-partial-border-hover",Ul(t,.6))};function QM(){const s=gA.getMultiple("noteBankContainer","eraserButton","degreeVisibilityToggle","degreeModeToggle","flatBtn","sharpBtn","frequencyBtn","focusColoursToggle"),t=s.noteBankContainer,e=s.eraserButton,i=s.degreeVisibilityToggle,A=s.degreeModeToggle,r=s.flatBtn,a=s.sharpBtn,l=s.frequencyBtn,u=s.focusColoursToggle,h=document.querySelector(".pitch-tabs-container"),m=document.getElementById("inversion-toggle"),g=document.getElementById("chord-position-toggle-6");xw.init();const w=()=>{const X=document.querySelector('[data-tab="rhythm"]');X&&!X.classList.contains("active")&&X.click();const nt=document.querySelector('[data-rhythm-tab="stamps"]');nt&&!nt.classList.contains("active")&&nt.click()};t&&t.querySelectorAll(".note").forEach(X=>{X.addEventListener("click",()=>{const nt=X.dataset.type,mt=X.closest(".note-pair"),ct=mt==null?void 0:mt.dataset.color;if(!(!nt||!ct)){if(nt==="diamond"){d.setSelectedNote("diamond",ct);const J=document.querySelector(".stamp-button.active"),st=J?parseInt(J.dataset.stampId??"",10):NaN;if(d.state.selectedTool==="stamp"&&J&&!Number.isNaN(st)&&st!==Ew)return;w(),Jc.selectStamp(Ew);return}d.setSelectedNote(nt,ct),d.setSelectedTool("note")}})}),e&&e.addEventListener("click",()=>d.setSelectedTool("eraser"));const C=Array.from(document.querySelectorAll(".tonic-mode-button")),y=(X=d.state.selectedToolTonicNumber)=>{if(!C.length)return;const nt=C[0]?parseInt(C[0].dataset.tonic??"1",10):1,mt=typeof X=="number"?X:parseInt(String(X??""),10),ct=Number.isNaN(mt)?nt:mt;C.forEach(J=>{const st=J.dataset.tonic,vt=(st?parseInt(st,10):NaN)===ct;J.classList.toggle("selected",vt),J.setAttribute("aria-pressed",vt?"true":"false")})};C.length&&(C.forEach(X=>{X.addEventListener("click",()=>{const nt=X.getAttribute("data-tonic");if(!nt)return;const mt=parseInt(nt,10);d.setSelectedTool("tonicization",mt),y(mt)})}),y());const E=document.querySelector("#chords-panel .chords-grid");function x(X,nt,mt){X&&X.querySelectorAll(".harmony-preset-button").forEach(ct=>{ct.addEventListener("click",()=>{var At;const J=((At=ct.textContent)==null?void 0:At.trim())??"",st=nt[J];st&&st.length>0?(d.setActiveChordIntervals(st),d.setSelectedTool("chord")):b.error("ToolSelector",`Failed to retrieve valid intervals for ${mt} chord: "${J}"`,null,"toolbar"),ct.blur()}),ct.addEventListener("dblclick",()=>{ct.classList.contains("selected")&&d.setSelectedTool("note"),ct.blur()})})}x(E,wy,"chords");const T=document.querySelectorAll(".pitch-tab-button"),U=document.querySelectorAll(".pitch-tab-panel");if(T.length>0){T.forEach(ct=>{ct.addEventListener("click",()=>{const J=ct.dataset.pitchTab;if(!J)return;const st=J;T.forEach(vt=>vt.classList.remove("active")),ct.classList.add("active"),U.forEach(vt=>vt.classList.remove("active"));const At=document.getElementById(`${st}-panel`);At&&At.classList.add("active"),localStorage.setItem("selectedPitchTab",st),J==="chords"&&G(),J==="range"&&setTimeout(()=>{xw.refreshWheelVisuals()},0)})});const X=localStorage.getItem("selectedPitchTab")||"chords",nt=document.querySelector(`[data-pitch-tab="${X}"]`),mt=document.getElementById(`${X}-panel`);nt&&mt&&(T.forEach(ct=>ct.classList.remove("active")),U.forEach(ct=>ct.classList.remove("active")),nt.classList.add("active"),mt.classList.add("active"))}const H=document.querySelectorAll(".rhythm-tab-button"),R=document.querySelectorAll(".rhythm-tab-panel");if(H.length>0){H.forEach(ct=>{ct.addEventListener("click",()=>{const J=ct.dataset.rhythmTab;if(!J)return;const st=J;H.forEach(vt=>vt.classList.remove("active")),ct.classList.add("active"),R.forEach(vt=>vt.classList.remove("active"));const At=document.getElementById(`${st}-panel`);At&&At.classList.add("active"),localStorage.setItem("selectedRhythmTab",st)})});const X=localStorage.getItem("selectedRhythmTab")||"controls",nt=document.querySelector(`[data-rhythm-tab="${X}"]`),mt=document.getElementById(`${X}-panel`);nt&&mt&&(H.forEach(ct=>ct.classList.remove("active")),R.forEach(ct=>ct.classList.remove("active")),nt.classList.add("active"),mt.classList.add("active"))}if(m){m.addEventListener("click",()=>{const nt=!d.state.isIntervalsInverted;d.setIntervalsInversion(nt),m.blur()});const X=nt=>{m.classList.toggle("active",nt)};d.on("intervalsInversionChanged",nt=>{X(nt)}),X(d.state.isIntervalsInverted)}if(g){g.addEventListener("click",()=>{const nt=d.state.chordPositionState,mt=D(),ct=(nt+1)%mt;d.setChordPosition(ct),g.blur()});const X=nt=>{g.classList.remove("state-1","state-2","state-3","state-4","state-5"),nt===1?g.classList.add("state-1"):nt===2?g.classList.add("state-2"):nt===3?g.classList.add("state-3"):nt===4?g.classList.add("state-4"):nt===5&&g.classList.add("state-5")};d.on("chordPositionChanged",nt=>{X(nt)}),X(d.state.chordPositionState)}function D(){const X=d.state.activeChordIntervals;return!X||X.length===0?3:X.length}function P(){const X=d.state.activeChordIntervals;return!X||X.length===0?3:X.length}function G(){if(!g)return;const X=P();for(let mt=0;mt<=5;mt++)g.classList.remove(`disabled-state-${mt}`);X<4?g.classList.add("disabled-state-3","disabled-state-4","disabled-state-5"):X===4?g.classList.add("disabled-state-4","disabled-state-5"):X===5&&g.classList.add("disabled-state-5");const nt=X-1;d.state.chordPositionState>nt&&d.setChordPosition(0)}const Y=document.querySelector("#chords-panel .intervals-4x4-grid");Y&&Y.querySelectorAll(".harmony-preset-button").forEach(X=>{X.addEventListener("click",()=>{var ct;const nt=((ct=X.textContent)==null?void 0:ct.trim())??"",mt=bf[nt];if(mt&&mt.length>0){const J=mt[0];let st=d.state.selectedTool==="chord"&&d.state.activeChordIntervals?[...d.state.activeChordIntervals]:["1P"];st.includes(J)?J!=="1P"&&(st=st.filter(vt=>vt!==J)):st.push(J),st.includes("1P")||st.unshift("1P");const At=["1P","2m","2M","2A","3m","3M","4P","4A","5d","5P","5A","6m","6M","6A","7m","7M","9M","11P","11A","13M"];st.sort((vt,ft)=>{const Mt=At.indexOf(vt),Pt=At.indexOf(ft);return Mt-Pt}),d.setActiveChordIntervals(st),d.setSelectedTool("chord"),b.debug("ToolSelector",`Interval ${nt} toggled`,st,"toolbar")}else b.error("ToolSelector",`Failed to retrieve valid interval for symbol: "${nt}"`,null,"toolbar"),b.error("ToolSelector","Available interval shapes",Object.keys(bf),"toolbar");X.blur()}),X.addEventListener("dblclick",()=>{d.setActiveChordIntervals(["1P"]),d.setSelectedTool("chord"),X.blur()})}),i&&i.addEventListener("click",()=>{if(d.state.degreeDisplayMode==="off"){if(!Sw()){bw.alert("Please place a tonal center on the canvas before showing degrees.","Tonal Center Required");return}const mt=A!=null&&A.classList.contains("active")?"modal":"diatonic";d.setDegreeDisplayMode(mt)}else d.setDegreeDisplayMode("off");i.blur()}),A&&A.addEventListener("click",()=>{if(A.classList.contains("disabled"))return;A.classList.toggle("active");const nt=A.classList.contains("active")?"modal":"diatonic";d.setDegreeDisplayMode(nt),A.blur()}),r&&r.addEventListener("click",()=>{d.state.showFrequencyLabels&&d.toggleFrequencyLabels(),d.toggleAccidentalMode("flat"),r.blur()}),a&&a.addEventListener("click",()=>{d.state.showFrequencyLabels&&d.toggleFrequencyLabels(),d.toggleAccidentalMode("sharp"),a.blur()}),l&&l.addEventListener("click",()=>{d.toggleFrequencyLabels(),l.blur()});const W=X=>{[r,a].forEach(nt=>{nt&&(nt.classList.toggle("accidental-btn--disabled",X),nt.setAttribute("aria-disabled",X?"true":"false"))})},at=X=>{l&&(l.classList.toggle("active",X),l.setAttribute("aria-pressed",X?"true":"false")),W(X)};if(u&&u.addEventListener("change",()=>{if(!d.state.focusColours&&!Sw()){bw.alert("Please place a tonal center on the canvas before enabling focus colours.","Tonal Center Required"),u.checked=!1;return}d.toggleFocusColours()}),d.on("toolChanged",({newTool:X}={})=>{var nt;if(e==null||e.classList.remove("selected"),h&&h.classList.remove("active-tool"),X==="eraser")e==null||e.classList.add("selected");else if(X!=="tonicization"){if(X==="chord")h==null||h.classList.add("active-tool");else if(X==="note"){const mt=d.state.selectedNote;if(mt){const ct=document.querySelector(`.note-pair[data-color='${mt.color}']`);ct==null||ct.classList.add("selected"),(nt=ct==null?void 0:ct.querySelector(`.note[data-type='${mt.shape}']`))==null||nt.classList.add("selected")}}}y()}),d.on("activeChordIntervalsChanged",()=>{Tw(),Iw(),G()}),d.on("noteChanged",({newNote:X}={})=>{var st;if(!(X!=null&&X.color)||!X.shape)return;const{color:nt,shape:mt}=X;document.querySelectorAll(".note, .note-pair").forEach(At=>At.classList.remove("selected"));const ct=document.querySelector(`.note-pair[data-color='${nt}']`);ct==null||ct.classList.add("selected"),(st=ct==null?void 0:ct.querySelector(`.note[data-type='${mt}']`))==null||st.classList.add("selected"),Mw(h,nt);const J=document.querySelector(".tab-sidebar");J&&J.style.setProperty("--c-accent",nt)}),d.on("degreeDisplayModeChanged",X=>{i&&i.classList.toggle("active",X!=="off"),A&&A.classList.toggle("active",X==="modal"),Fw()}),d.on("accidentalModeChanged",X=>{const{sharp:nt,flat:mt}=X;a==null||a.classList.toggle("active",nt),r==null||r.classList.toggle("active",mt)}),d.on("frequencyLabelsChanged",X=>{at(X)}),at(d.state.showFrequencyLabels),h&&d.state.selectedNote){const X=d.state.selectedNote.color;Mw(h,X)}const Bt=document.querySelector(".tab-sidebar");Bt&&d.state.selectedNote&&Bt.style.setProperty("--c-accent",d.state.selectedNote.color),setTimeout(()=>G(),50),Fw();const dt=d.state.degreeDisplayMode;i&&i.classList.toggle("active",dt!=="off"),A&&(A.classList.toggle("active",dt==="modal"),A.classList.toggle("disabled",dt==="off")),Tw(),Iw(),G()}function MM(){const s=document.getElementById("play-button"),t=document.getElementById("stop-button"),e=document.getElementById("clear-button"),i=document.getElementById("loop-button"),A=document.getElementById("undo-button"),r=document.getElementById("redo-button");s&&s.addEventListener("click",()=>{const{isPlaying:l,isPaused:u}=d.state;l&&u?(d.setPlaybackState(!0,!1),hr.resume()):l&&!u?(d.setPlaybackState(!0,!0),hr.pause()):(d.setPlaybackState(!0,!1),hr.start())}),t&&t.addEventListener("click",()=>{d.setPlaybackState(!1,!1),hr.stop(),t.blur()}),e&&e.addEventListener("click",()=>{e.classList.add("flash"),setTimeout(()=>e.classList.remove("flash"),300),d.clearAllNotes(),qQ(),YQ(),e.blur()}),i&&i.addEventListener("click",()=>{d.setLooping(!d.state.isLooping)}),A&&A.addEventListener("click",()=>{d.undo(),A.blur()}),r&&r.addEventListener("click",()=>{d.redo(),r.blur()}),d.on("playbackStateChanged",l=>{const{isPlaying:u,isPaused:h}=l;if(s){const m=`<img src="${Bf("play.svg")}" alt="Play">`,g=`<img src="${Bf("pause.svg")}" alt="Pause">`;s.innerHTML=u&&!h?g:m}}),d.on("loopingChanged",l=>{const u=l;i&&i.classList.toggle("active",u)});const a=()=>{A&&(A.disabled=d.state.historyIndex<=0),r&&(r.disabled=d.state.historyIndex>=d.state.history.length-1)};d.on("historyChanged",a),a()}class pd{constructor(t,e={}){Q(this,"parent");Q(this,"settings");Q(this,"_em");Q(this,"_value");Q(this,"decimalPlaces");Q(this,"colors");Q(this,"element");Q(this,"_minDimension");Q(this,"actual",0);Q(this,"hasMoved",!1);Q(this,"clicked",!1);Q(this,"_start",{y:0});Q(this,"_changeFactor",1);var u,h,m,g;const i=typeof t=="string"?document.querySelector(t):t;if(this.parent=i,!this.parent)throw new Error("DraggableNumber: parent element not found");const A={size:[60,30],value:0,min:0,max:2e4,step:1,decimalPlaces:2,colors:{fill:"#e7e7e7",dark:"#333",light:"#fff",accent:"#b35"},useAppStyling:!1},r={fill:((u=e.colors)==null?void 0:u.fill)??A.colors.fill,dark:((h=e.colors)==null?void 0:h.dark)??A.colors.dark,light:((m=e.colors)==null?void 0:m.light)??A.colors.light,accent:((g=e.colors)==null?void 0:g.accent)??A.colors.accent};this.settings={...A,...e,colors:r},this._em=new PM,this._value=new UM(this.settings.min,this.settings.max,this.settings.step,this.settings.value),this.decimalPlaces=this.settings.decimalPlaces,this.colors=this.settings.colors,this.element=document.createElement("input"),this.element.type="text",this.parent.appendChild(this.element);const[a,l]=this.settings.size;this._minDimension=Math.min(a,l),this.settings.useAppStyling?(this.element.className="draggable-number-input",this.element.style.cssText=[`width:${a}px`,`height:${l}px`,"background-color: var(--c-bg)","color: var(--c-text)","border: 1px solid var(--c-border)","border-radius: var(--border-radius-sm)","font-family: var(--main-font)","font-weight: 400","font-size: 14px","text-align: center","outline: none","padding: 0","box-sizing: border-box","user-select: text"].join(";")):this.element.style.cssText=[`width:${a}px`,`height:${l}px`,`background-color:${this.colors.fill}`,`color:${this.colors.dark}`,"font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif","font-weight:500",`font-size:${this._minDimension/2}px`,"border: none","outline: none",`padding:${this._minDimension/4}px ${this._minDimension/4}px`,"box-sizing:border-box","user-select:text"].join(";"),kM(this.element,w=>/^-?\d*\.?\d*$/.test(w)),this.actual=0,this.hasMoved=!1,this.clicked=!1,this.element.value=Uw(this._value.value,this.decimalPlaces),this._bind()}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}emit(t,e){this._em.emit(t,e)}get value(){return this._value.value}set value(t){this._value.update(t),this.emit("change",this._value.value),this._render()}get min(){return this._value.min}set min(t){this._value.min=t,this._render()}get max(){return this._value.max}set max(t){this._value.max=t,this._render()}get step(){return this._value.step}set step(t){this._value.step=t,this._render()}passiveUpdate(t){this._value.update(t),this._render()}link(t){this.min=t.min,this.max=t.max,this.step=t.step,typeof t.on=="function"&&t.on("change",e=>this.passiveUpdate(e)),this.on("change",e=>{"value"in t&&(t.value=e)}),this.value=t.value}_bind(){this.element.addEventListener("blur",()=>{this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-bg)",this.element.style.color="var(--c-text)"):(this.element.style.backgroundColor=this.colors.fill,this.element.style.color=this.colors.dark);const t=parseFloat(this.element.value);!Number.isNaN(t)&&t!==this.value?this.value=t:this._render()}),this.element.addEventListener("keydown",t=>{if(t.key==="Enter"){this.element.blur();const e=parseFloat(this.element.value);Number.isNaN(e)||(this.value=e)}},!0),this.element.addEventListener("mousedown",t=>this._onMouseDown(t)),this.element.addEventListener("dragstart",t=>t.preventDefault())}_onMouseDown(t){this.hasMoved=!1,this.clicked=!0,this.element.readOnly=!0,this.actual=this.value,this._start={y:t.clientY};const e=this.element.getBoundingClientRect(),i=(t.clientX-e.left)/e.width;this._changeFactor=DM(i);const A=a=>this._onMouseMove(a),r=()=>this._onMouseUp(A,r);window.addEventListener("mousemove",A),window.addEventListener("mouseup",r)}_onMouseMove(t){if(!this.clicked)return;this.hasMoved=!0;const e=t.clientY-this._start.y,A=up(this.max-this.min,0,1e3)/200*Math.pow(this._changeFactor,2),r=this.actual-e*A;this._value.update(r),this._render(),this._value.changed&&this.emit("change",this._value.value)}_onMouseUp(t,e){this.clicked=!1,window.removeEventListener("mousemove",t),window.removeEventListener("mouseup",e),this.hasMoved?document.body.focus():(this.element.readOnly=!1,this.element.focus(),this.element.setSelectionRange(0,this.element.value.length),this.settings.useAppStyling?(this.element.style.backgroundColor="var(--c-accent)",this.element.style.color="var(--c-surface)"):(this.element.style.backgroundColor=this.colors.accent,this.element.style.color=this.colors.light))}_render(){this.element.value=Uw(this._value.value,this.decimalPlaces)}}class UM{constructor(t,e,i,A){Q(this,"min");Q(this,"max");Q(this,"step");Q(this,"_value");Q(this,"changed");this.min=Number(t),this.max=Number(e),this.step=Number(i)||1,this._value=0,this.changed=!1,this.update(A)}get value(){return this._value}update(t){const e=up(Number(t),this.min,this.max),i=this._stepTo(e),A=this._value;this._value=i,this.changed=i!==A}_stepTo(t){if(!isFinite(this.step)||this.step<=0)return t;const e=Math.round((t-this.min)/this.step);return this.min+e*this.step}}class PM{constructor(){Q(this,"_m");this._m=new Map}on(t,e){const i=this._m.get(t)||[];i.push(e),this._m.set(t,i)}off(t,e){const i=this._m.get(t);if(!i)return;const A=i.indexOf(e);A>=0&&i.splice(A,1)}emit(t,e){const i=this._m.get(t);if(i)for(const A of i.slice())A(e)}}function up(s,t,e){return Math.max(t,Math.min(e,s))}function DM(s){return 1-up(s,0,1)}function Uw(s,t=2){return isFinite(s)?Number(s).toFixed(Math.max(0,t)).replace(/\.0+$/,"").replace(/(\.\d*?)0+$/,"$1"):""}function kM(s,t){let e=s.value;s.addEventListener("input",()=>{t(s.value)?e=s.value:s.value=e})}class LM{constructor(){Q(this,"isActive",!1);Q(this,"pulseIntervals",new Map);Q(this,"tempoElements",new Map);Q(this,"popDuration",{scaleUp:40,scaleDown:80});Q(this,"popScale",1.4);Q(this,"activeAnimations",new Map);this.initElements()}initElements(){[{type:"eighth",containerId:"eighth-note-tempo",bpmMultiplier:2},{type:"quarter",containerId:"quarter-note-tempo",bpmMultiplier:1},{type:"dottedQuarter",containerId:"dotted-quarter-tempo",bpmMultiplier:.666}].forEach(({type:e,containerId:i,bpmMultiplier:A})=>{const r=document.getElementById(i),a=r==null?void 0:r.parentElement,l=a==null?void 0:a.querySelector(".tempo-label-icon");r&&l?this.tempoElements.set(e,{container:r,icon:l,bpmMultiplier:A,originalTransform:r.style.transform||"",originalIconTransform:l.style.transform||""}):b.warn("TempoVisualizer",`Could not find elements for ${e} tempo`,{container:!!r,icon:!!l,tempoGroup:!!a},"toolbar")})}start(){this.isActive||(this.isActive=!0,this.tempoElements.size===0&&this.initElements(),this.tempoElements.forEach((t,e)=>{this.startPulseForType(e)}))}stop(){this.isActive&&(this.isActive=!1,this.pulseIntervals.forEach(t=>{clearInterval(t)}),this.pulseIntervals.clear(),this.activeAnimations.clear(),this.tempoElements.forEach(t=>{t.container.style.transform=t.originalTransform,t.icon.style.transform=t.originalIconTransform}))}startPulseForType(t){const e=this.tempoElements.get(t);if(!e)return;const r=60/(d.state.tempo*e.bpmMultiplier)*1e3;this.triggerPulse(t);const a=setInterval(()=>{this.isActive&&this.triggerPulse(t)},r);this.pulseIntervals.set(t,a)}triggerPulse(t){const i={startTime:performance.now(),phase:"scaleUp"};this.activeAnimations.set(t,i);const A=this.isActive;this.isActive=!0,this.activeAnimations.size===1&&this.animationLoop(),A||setTimeout(()=>{this.activeAnimations.size===0&&(this.isActive=!1)},this.popDuration.scaleUp+this.popDuration.scaleDown+50)}animationLoop(){if(this.activeAnimations.size===0||!this.isActive)return;const t=performance.now();this.activeAnimations.forEach((e,i)=>{const A=this.calculateScale(e,t);this.applyScale(i,A),A===1&&e.phase==="complete"&&this.activeAnimations.delete(i)}),this.activeAnimations.size>0&&requestAnimationFrame(()=>this.animationLoop())}calculateScale(t,e){const i=e-t.startTime;if(t.phase==="scaleUp"){if(i>=this.popDuration.scaleUp)return t.phase="scaleDown",t.startTime=e,this.popScale;{const A=Math.min(i/this.popDuration.scaleUp,1);return 1+(this.popScale-1)*A}}else if(t.phase==="scaleDown"){if(i>=this.popDuration.scaleDown)return t.phase="complete",1;{const A=Math.min(i/this.popDuration.scaleDown,1);return this.popScale-(this.popScale-1)*A}}return 1}applyScale(t,e){const i=this.tempoElements.get(t);if(!i)return;const A=`scale(${e})`;i.container.style.transform=i.originalTransform+" "+A,i.icon.style.transform=i.originalIconTransform+" "+A;const r=e<this.popScale?"transform 0.08s ease-out":"none";i.container.style.transition=r,i.icon.style.transition=r}updateTempo(){this.isActive&&(this.stop(),this.start())}}const nr=new LM,wA=uA,Nn={blend:2,cutoff:31,resonance:0,type:"lowpass"};function _a(){return{coeffs:new Float32Array(wA).fill(0),phases:new Float32Array(wA).fill(0)}}function RM(){const s=_a();return s.coeffs[0]=1,s}function HM(){const s=_a();for(let t=1;t<=wA;t+=2){const e=t-1;s.coeffs[e]=1/t,s.phases[e]=0}return s}function NM(){const s=_a();for(let t=1;t<=wA;t+=2){const e=t-1;s.coeffs[e]=1/(t*t),s.phases[e]=Math.PI/2}return s}function OM(){const s=_a();for(let t=1;t<=wA;t++){const e=t-1;s.coeffs[e]=1/t,s.phases[e]=t&1?0:Math.PI}return s}const VM={strings:{amps:[.995,.94,.425,.48,0,.365,.04,.085,0,.09,0,0],phases:[0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,Math.PI/2,0,0]},piano:{amps:[1,.7,.6,.5,.4,.32,.25,.2,.17,.14,.12,.1],phases:Array(12).fill(0)},marimba:{amps:[1,.2,.15,.7,.05,.18,.03,.05,.02,.01,0,0],phases:Array(12).fill(0)},woodwind:{amps:[1,.05,.5,.05,.3,.05,.2,.05,.12,.05,.08,.05],phases:Array(12).fill(0)}};function Pl(s){const t=_a(),e=VM[s];if(!e)return t;const i=Math.min(wA,e.amps.length);for(let A=0;A<i;A++)t.coeffs[A]=e.amps[A]||0,t.phases[A]=e.phases[A]||0;return t}const vo={attack:.1,decay:.2,sustain:.8,release:.3},WM={sine:{name:"sine",gain:1,adsr:vo,...RM(),filter:{...Nn}},triangle:{name:"triangle",gain:.81,adsr:vo,...NM(),filter:{...Nn}},square:{name:"square",gain:4/Math.PI,adsr:vo,...HM(),filter:{...Nn}},sawtooth:{name:"sawtooth",gain:2/Math.PI,adsr:vo,...OM(),filter:{...Nn}},trapezium:{name:"trapezium",gain:4/Math.PI,adsr:vo,coeffs:new Float32Array([.993,0,.314,0,.168,0,.101,0,.06,0,.033,0]),phases:new Float32Array(wA).fill(0),filter:{...Nn}},impulse:{name:"impulse",gain:.18,adsr:{attack:.01,decay:.3,sustain:0,release:.2},coeffs:new Float32Array([1,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0]),phases:new Float32Array([0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,Math.PI/2,0,Math.PI*1.5,Math.PI,0]),filter:{...Nn}},strings:{name:"strings",gain:.49,adsr:{attack:.08,decay:.4,sustain:.7,release:.5},...Pl("strings"),filter:{...Nn,cutoff:28}},piano:{name:"piano",gain:.8,adsr:{attack:.01,decay:1.5,sustain:0,release:.4},...Pl("piano"),filter:{...Nn,cutoff:28}},marimba:{name:"marimba",gain:.9,adsr:{attack:.01,decay:.8,sustain:0,release:.4},...Pl("marimba"),filter:{...Nn,cutoff:25}},woodwind:{name:"woodwind",gain:.6,adsr:{attack:.1,decay:.2,sustain:.8,release:.3},...Pl("woodwind"),filter:{...Nn}}};function KM(){var C;const s=document.getElementById("tempo-slider");s||b.warn("AudioControlsInitializer","Tempo slider not found during initial load - will retry when rhythm tab is accessed",null,"toolbar");const t={size:[45,24],step:1,decimalPlaces:0,useAppStyling:!0},e=new pd("#eighth-note-tempo",{...t,value:180,min:60,max:480}),i=new pd("#quarter-note-tempo",{...t,value:90,min:30,max:240}),A=new pd("#dotted-quarter-tempo",{...t,value:60,min:20,max:160});function r(y){const E=Math.round(y),x=s||document.getElementById("tempo-slider");x&&parseInt(x.value,10)!==E&&(x.value=`${E}`);const T=E*2,U=Math.round(E/1.5);e.value!==T&&e.passiveUpdate(T),i.value!==E&&i.passiveUpdate(E),A.value!==U&&A.passiveUpdate(U),d.state.tempo!==E&&(d.setTempo(E),nr.updateTempo())}const a=y=>{if(!y)return;const E=y.closest(".tempo-slider-container");if(!E||E.querySelector(".tempo-slider-marks"))return;const x=[60,90,120,160,200],T=document.createElement("div");T.className="tempo-slider-marks",E.appendChild(T);const U=Number(y.min)||0,H=Number(y.max)||1,R=Math.max(H-U,1),D=[],P=()=>{const W=y.getBoundingClientRect().height||y.clientHeight,at=getComputedStyle(y),Bt=parseFloat(at.getPropertyValue("--slider-thumb-size"))||0,dt=parseFloat(at.getPropertyValue("--slider-thumb-border"))||0,X=Bt+dt*2,nt=Math.max(W-X,1),mt=X/2;D.forEach(({el:ct,bpm:J})=>{if(J<U||J>H){ct.style.display="none";return}ct.style.display="";const st=(J-U)/R,At=mt+nt*st;ct.style.bottom=`${At}px`})};x.forEach(Y=>{const W=document.createElement("span");W.className="tempo-slider-mark",W.setAttribute("aria-hidden","true"),T.appendChild(W),D.push({el:W,bpm:Y})}),P(),new ResizeObserver(P).observe(y)};let l=!1;if(s){a(s);const y=()=>{const E=document.querySelector(".tempo-content-box"),x=document.querySelector(".tempo-container"),T=document.querySelector(".tempo-column-2");b.debug("AudioControlsInitializer","[Tempo Slider Heights]",{slider:{offsetHeight:s.offsetHeight,clientHeight:s.clientHeight,scrollHeight:s.scrollHeight,computedHeight:getComputedStyle(s).height,computedMaxHeight:getComputedStyle(s).maxHeight},tempoColumn2:T?{offsetHeight:T.offsetHeight,clientHeight:T.clientHeight,computedHeight:getComputedStyle(T).height}:"not found",tempoContainer:x?{offsetHeight:x.offsetHeight,clientHeight:x.clientHeight,computedHeight:getComputedStyle(x).height,computedFlex:getComputedStyle(x).flex}:"not found",tempoContentBox:E?{offsetHeight:E.offsetHeight,clientHeight:E.clientHeight,computedHeight:getComputedStyle(E).height}:"not found"})};setTimeout(y,100),setTimeout(y,500),s.addEventListener("mousedown",()=>{l=!0,nr.start()}),s.addEventListener("touchstart",()=>{l=!0,nr.start()}),s.addEventListener("input",E=>{const x=E.target,T=x?parseInt(x.value,10):NaN;r(T)}),s.addEventListener("mouseup",()=>{s.blur()}),r(d.state.tempo)}else b.warn("AudioControlsInitializer","Tempo slider not found - will initialize when rhythm tab is opened",null,"toolbar");e.on("change",y=>{!isNaN(y)&&y>0&&r(y/2)}),i.on("change",y=>{!isNaN(y)&&y>0&&r(y)}),A.on("change",y=>{!isNaN(y)&&y>0&&r(y*1.5)}),r(d.state.tempo),document.addEventListener("mouseup",()=>{l&&(l=!1,nr.stop())}),document.addEventListener("touchend",()=>{l&&(l=!1,nr.stop())}),document.addEventListener("touchcancel",()=>{l&&(l=!1,nr.stop())});const u=document.querySelector(".preset-effects-container");document.querySelectorAll(".preset-button").forEach(y=>{const E=y,x=E.id.replace("preset-",""),T=WM[x];T&&E.addEventListener("click",()=>{var H;const U=(H=d.state.selectedNote)==null?void 0:H.color;U&&(d.applyPreset(U,T),setTimeout(()=>{g(U)},10)),E.blur()})});const h=(y,E=20)=>{const x=parseInt(y.slice(1,3),16),T=parseInt(y.slice(3,5),16),U=parseInt(y.slice(5,7),16),H=Math.max(0,Math.floor(x*(1-E/100))),R=Math.max(0,Math.floor(T*(1-E/100))),D=Math.max(0,Math.floor(U*(1-E/100)));return`#${H.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}${D.toString(16).padStart(2,"0")}`},m=(y,E=50)=>{const x=parseInt(y.slice(1,3),16),T=parseInt(y.slice(3,5),16),U=parseInt(y.slice(5,7),16),H=Math.min(255,Math.floor(x+(255-x)*(E/100))),R=Math.min(255,Math.floor(T+(255-T)*(E/100))),D=Math.min(255,Math.floor(U+(255-U)*(E/100)));return`#${H.toString(16).padStart(2,"0")}${R.toString(16).padStart(2,"0")}${D.toString(16).padStart(2,"0")}`},g=y=>{if(!y||!u)return;const E=d.state.timbres[y],x=d.state.colorPalette[y]||{primary:y,light:y},T=x.light,U=x.primary;document.querySelectorAll(".preset-button").forEach(R=>{const D=R,P=D.id.replace("preset-",""),G=(E==null?void 0:E.activePresetName)===P;D.classList.toggle("selected",G)});const H=m(T,60);u.style.setProperty("--c-accent",U),u.style.setProperty("--c-accent-light",H),u.style.setProperty("--c-accent-hover",h(U,20))};d.on("noteChanged",({newNote:y})=>{y.color?g(y.color):(document.querySelectorAll(".preset-button").forEach(E=>E.classList.remove("selected")),u&&(u.style.setProperty("--c-accent","#4A90E2"),u.style.setProperty("--c-accent-hover","#357ABD")))}),d.on("timbreChanged",y=>{var E;y===((E=d.state.selectedNote)==null?void 0:E.color)&&g(y)}),d.on("tempoChanged",y=>{r(y)});const w=(C=d.state.selectedNote)==null?void 0:C.color;w&&g(w)}function GM(){const s=document.getElementById("grid-zoom-in"),t=document.getElementById("grid-zoom-out"),e=document.getElementById("macrobeat-increase"),i=document.getElementById("macrobeat-decrease");s&&s.addEventListener("click",()=>{d.emit("zoomIn"),s.blur()}),t&&t.addEventListener("click",()=>{d.emit("zoomOut"),t.blur()}),e&&e.addEventListener("click",()=>d.increaseMacrobeatCount()),i&&i.addEventListener("click",()=>d.decreaseMacrobeatCount())}function qM(){const s=document.getElementById("modulation-2-3-btn"),t=document.getElementById("modulation-3-2-btn"),e=document.getElementById("modulation-clear-btn");if(!s||!t||!e){b.warn("ModulationInitializer","Modulation control buttons not found in DOM",null,"ui");return}let i=null;s.addEventListener("click",()=>{i===an.COMPRESSION_2_3?(i=null,s.classList.remove("active"),d.setSelectedTool("note"),b.info("ModulationInitializer","2:3 modulation tool deactivated",null,"ui")):(i=an.COMPRESSION_2_3,s.classList.add("active"),t.classList.remove("active"),d.setSelectedTool("modulation"),d.state.selectedModulationRatio=i,b.info("ModulationInitializer","2:3 modulation tool activated",null,"ui"))}),t.addEventListener("click",()=>{i===an.EXPANSION_3_2?(i=null,t.classList.remove("active"),d.setSelectedTool("note"),b.info("ModulationInitializer","3:2 modulation tool deactivated",null,"ui")):(i=an.EXPANSION_3_2,t.classList.add("active"),s.classList.remove("active"),d.setSelectedTool("modulation"),d.state.selectedModulationRatio=i,b.info("ModulationInitializer","3:2 modulation tool activated",null,"ui"))}),e.addEventListener("click",()=>{const r=(d.state.modulationMarkers||[]).length;if(r===0){b.info("ModulationInitializer","No modulation markers to clear",null,"ui");return}d.clearModulationMarkers(),b.info("ModulationInitializer",`Cleared ${r} modulation markers`,null,"ui")}),d.on("toolChanged",r=>{const a=r;(typeof a=="string"?a:a.newTool||a)!=="modulation"&&(i=null,s.classList.remove("active"),t.classList.remove("active"))}),d.on("modulationMarkersChanged",()=>{const r=(d.state.modulationMarkers||[]).length;r===0?(e.disabled=!0,e.style.opacity="0.5"):(e.disabled=!1,e.style.opacity="1"),e.textContent=r>0?`Clear (${r})`:"Clear"});const A=(d.state.modulationMarkers||[]).length;A===0&&(e.disabled=!0,e.style.opacity="0.5"),e.textContent=A>0?`Clear (${A})`:"Clear",b.info("ModulationInitializer","Modulation controls initialized",null,"ui")}b.moduleLoaded("ToolbarComponent","toolbar");const zM={init(){BM(),_M(),QM(),MM(),KM(),GM(),qM(),b.info("ToolbarComponent","All controls initialized",null,"toolbar")}},$M=16;class XM{constructor(){Q(this,"overlay",null);Q(this,"canvas",null);Q(this,"ctx",null);Q(this,"cropOverlay",null);Q(this,"cropCtx",null);Q(this,"canvasWrapper",null);Q(this,"orientationBtn",null);Q(this,"colorBtn",null);Q(this,"leftLegendBtn",null);Q(this,"rightLegendBtn",null);Q(this,"isDragging",!1);Q(this,"dragHandle",null);Q(this,"handleSize",20);Q(this,"handlePadding",5);Q(this,"cropState",null)}init(){var t,e,i,A,r,a,l,u,h,m,g,w,C;this.overlay=document.getElementById("print-preview-overlay"),this.canvas=document.getElementById("print-preview-canvas"),this.ctx=((t=this.canvas)==null?void 0:t.getContext("2d"))??null,this.cropOverlay=document.getElementById("print-crop-overlay"),this.cropCtx=((e=this.cropOverlay)==null?void 0:e.getContext("2d"))??null,this.canvasWrapper=((i=this.canvas)==null?void 0:i.parentElement)??null,this.orientationBtn=document.getElementById("print-orientation-toggle"),this.colorBtn=document.getElementById("print-color-mode-toggle"),this.leftLegendBtn=document.getElementById("print-left-legend-toggle"),this.rightLegendBtn=document.getElementById("print-right-legend-toggle"),(A=document.getElementById("print-close-button"))==null||A.addEventListener("click",()=>this.hide()),(r=document.getElementById("print-confirm-button"))==null||r.addEventListener("click",()=>{$l.generateAndPrint(),this.hide()}),(a=this.orientationBtn)==null||a.addEventListener("click",()=>this.handleToggle("orientation",["landscape","portrait"])),(l=this.colorBtn)==null||l.addEventListener("click",()=>this.handleToggle("colorMode",["color","bw"])),(u=this.leftLegendBtn)==null||u.addEventListener("click",()=>this.handleToggle("includeLeftLegend",[!0,!1])),(h=this.rightLegendBtn)==null||h.addEventListener("click",()=>this.handleToggle("includeRightLegend",[!0,!1])),(m=this.cropOverlay)==null||m.addEventListener("mousedown",y=>this.onCropMouseDown(y)),(g=this.cropOverlay)==null||g.addEventListener("mousemove",y=>this.onCropMouseMove(y)),(w=this.cropOverlay)==null||w.addEventListener("mouseup",()=>this.onCropMouseUp()),(C=this.cropOverlay)==null||C.addEventListener("mouseleave",()=>this.onCropMouseUp()),d.on("printPreviewStateChanged",y=>{y?this.show():this.hide()}),d.on("printOptionsChanged",()=>{this.render()}),d.on("notesChanged",()=>{d.state.isPrintPreviewActive&&this.render()}),this.canvasWrapper&&new ResizeObserver(()=>{d.state.isPrintPreviewActive&&this.render()}).observe(this.canvasWrapper)}show(){var t;d.state.isPrintPreviewActive||d.setPrintPreviewActive(!0),(t=this.overlay)==null||t.classList.remove("hidden"),d.setPrintOptions({cropTop:0,cropBottom:1,cropLeft:0,cropRight:1,includeButtonGrid:!0,includeDrums:!0,includeLeftLegend:!0,includeRightLegend:!0}),$l.prefetchButtonGridSnapshot(!0,!0),this.render()}hide(){var t;d.state.isPrintPreviewActive&&d.setPrintPreviewActive(!1),(t=this.overlay)==null||t.classList.add("hidden")}handleToggle(t,e){const A=d.state.printOptions[t]===e[0]?e[1]:e[0];d.setPrintOptions({[t]:A})}updateControls(){if([this.orientationBtn,this.colorBtn,this.leftLegendBtn,this.rightLegendBtn].some(a=>a===null))return;const{orientation:e,colorMode:i,includeLeftLegend:A,includeRightLegend:r}=d.state.printOptions;this.orientationBtn&&(this.orientationBtn.textContent=e.charAt(0).toUpperCase()+e.slice(1)),this.colorBtn&&(this.colorBtn.textContent=i==="color"?"Color":"B&W",this.colorBtn.classList.toggle("active",i==="color")),this.leftLegendBtn&&(this.leftLegendBtn.textContent=A?"Include":"Exclude",this.leftLegendBtn.classList.toggle("active",A)),this.rightLegendBtn&&(this.rightLegendBtn.textContent=r?"Include":"Exclude",this.rightLegendBtn.classList.toggle("active",r))}async render(){var x,T;if(!d.state.isPrintPreviewActive||!this.canvas||!this.ctx)return;this.updateControls();const t=((x=this.canvasWrapper)==null?void 0:x.clientWidth)??0,e=((T=this.canvasWrapper)==null?void 0:T.clientHeight)??0;if(t===0||e===0)return;const i=d.state.printOptions.orientation,A=i==="landscape"?10.5:8,r=i==="landscape"?8:10.5,a=.25,l=A/r,u=$M*2;let h=Math.max(t-u,100),m=Math.max(e-u,100);h/m>l?h=m*l:m=h/l;const g=a/A*h,w=h-2*g,C=m-2*g,y={...d.state.printOptions,includeButtonGrid:!0,includeDrums:!0,includeLeftLegend:d.state.printOptions.includeLeftLegend,includeRightLegend:d.state.printOptions.includeRightLegend,cropTop:0,cropBottom:1,cropLeft:0,cropRight:1},E=await $l.generateScoreCanvas(y,{width:w,height:C});E&&(this.canvas.width=h,this.canvas.height=m,this.ctx.fillStyle="#FFFFFF",this.ctx.fillRect(0,0,h,m),this.ctx.strokeStyle="#E0E0E0",this.ctx.lineWidth=1,this.ctx.strokeRect(g,g,w,C),this.ctx.drawImage(E,g,g),this.drawCornerMarks(g,w,C),this.renderCropOverlay(h,m,g,C))}drawCornerMarks(t,e,i){if(!this.ctx)return;this.ctx.strokeStyle="#CCCCCC",this.ctx.lineWidth=1;const A=10,r=t+e,a=t+i;this.ctx.beginPath(),this.ctx.moveTo(t,t-A),this.ctx.lineTo(t,t+A),this.ctx.moveTo(t-A,t),this.ctx.lineTo(t+A,t),this.ctx.moveTo(r,t-A),this.ctx.lineTo(r,t+A),this.ctx.moveTo(r-A,t),this.ctx.lineTo(r+A,t),this.ctx.moveTo(t,a-A),this.ctx.lineTo(t,a+A),this.ctx.moveTo(t-A,a),this.ctx.lineTo(t+A,a),this.ctx.moveTo(r,a-A),this.ctx.lineTo(r,a+A),this.ctx.moveTo(r-A,a),this.ctx.lineTo(r+A,a),this.ctx.stroke()}renderCropOverlay(t,e,i,A){var R,D;const r=(R=this.canvas)==null?void 0:R.getBoundingClientRect(),a=(D=this.canvasWrapper)==null?void 0:D.getBoundingClientRect();if(!r||!a||!this.cropOverlay||!this.cropCtx)return;this.cropOverlay.width=t,this.cropOverlay.height=e,this.cropOverlay.style.left=`${r.left-a.left}px`,this.cropOverlay.style.top=`${r.top-a.top}px`,this.cropOverlay.style.width=`${t}px`,this.cropOverlay.style.height=`${e}px`;const{cropTop:l,cropBottom:u,cropLeft:h,cropRight:m}=d.state.printOptions,g=i,w=i,C=t-2*i,y=A,E=C,x=g+l*y,T=g+u*y,U=w+h*E,H=w+m*E;this.cropCtx.clearRect(0,0,t,e),this.cropCtx.fillStyle="rgba(0, 0, 0, 0.5)",l>0&&this.cropCtx.fillRect(0,0,t,x),u<1&&this.cropCtx.fillRect(0,T,t,e-T),h>0&&this.cropCtx.fillRect(0,x,U,T-x),m<1&&this.cropCtx.fillRect(H,x,t-H,T-x),this.drawVerticalHandle(x,t,"top"),this.drawVerticalHandle(T,t,"bottom"),this.drawHorizontalHandle(U,e,"left"),this.drawHorizontalHandle(H,e,"right"),this.cropState={pageWidth:t,pageHeight:e,contentTop:g,contentLeft:w,contentHeight:y,contentWidth:E,cropTopY:x,cropBottomY:T,cropLeftX:U,cropRightX:H}}drawVerticalHandle(t,e,i){if(!this.cropCtx)return;const A=60,r=(e-A)/2;this.cropCtx.fillStyle="#4a90e2",this.cropCtx.fillRect(0,t-1,e,2),this.cropCtx.fillRect(r,t-this.handleSize/2,A,this.handleSize),this.cropCtx.strokeStyle="#FFFFFF",this.cropCtx.lineWidth=2,this.cropCtx.strokeRect(r,t-this.handleSize/2,A,this.handleSize),this.cropCtx.strokeStyle="#FFFFFF",this.cropCtx.lineWidth=1;const a=3,l=6,u=30,h=(e-u)/2;for(let m=0;m<a;m++){const g=t+(m-1)*l;this.cropCtx.beginPath(),this.cropCtx.moveTo(h,g),this.cropCtx.lineTo(h+u,g),this.cropCtx.stroke()}}drawHorizontalHandle(t,e,i){if(!this.cropCtx)return;const A=60,r=(e-A)/2;this.cropCtx.fillStyle="#4a90e2",this.cropCtx.fillRect(t-1,0,2,e),this.cropCtx.fillRect(t-this.handleSize/2,r,this.handleSize,A),this.cropCtx.strokeStyle="#FFFFFF",this.cropCtx.lineWidth=2,this.cropCtx.strokeRect(t-this.handleSize/2,r,this.handleSize,A),this.cropCtx.strokeStyle="#FFFFFF",this.cropCtx.lineWidth=1;const a=3,l=6,u=30,h=(e-u)/2;for(let m=0;m<a;m++){const g=t+(m-1)*l;this.cropCtx.beginPath(),this.cropCtx.moveTo(g,h),this.cropCtx.lineTo(g,h+u),this.cropCtx.stroke()}}onCropMouseDown(t){if(!this.cropState||!this.cropOverlay)return;const e=this.cropOverlay.getBoundingClientRect(),i=t.clientX-e.left,A=t.clientY-e.top,r=Math.abs(A-this.cropState.cropTopY)<this.handleSize+this.handlePadding,a=Math.abs(A-this.cropState.cropBottomY)<this.handleSize+this.handlePadding,l=Math.abs(i-this.cropState.cropLeftX)<this.handleSize+this.handlePadding,u=Math.abs(i-this.cropState.cropRightX)<this.handleSize+this.handlePadding;r?(this.isDragging=!0,this.dragHandle="top",this.cropOverlay.style.cursor="ns-resize"):a?(this.isDragging=!0,this.dragHandle="bottom",this.cropOverlay.style.cursor="ns-resize"):l?(this.isDragging=!0,this.dragHandle="left",this.cropOverlay.style.cursor="ew-resize"):u&&(this.isDragging=!0,this.dragHandle="right",this.cropOverlay.style.cursor="ew-resize")}onCropMouseMove(t){if(!this.cropState||!this.cropOverlay)return;const e=this.cropOverlay.getBoundingClientRect(),i=t.clientX-e.left,A=t.clientY-e.top;if(this.isDragging&&this.dragHandle){this.handleCropDrag(i,A);return}const r=Math.abs(A-this.cropState.cropTopY)<this.handleSize+this.handlePadding,a=Math.abs(A-this.cropState.cropBottomY)<this.handleSize+this.handlePadding,l=Math.abs(i-this.cropState.cropLeftX)<this.handleSize+this.handlePadding,u=Math.abs(i-this.cropState.cropRightX)<this.handleSize+this.handlePadding;r||a?this.cropOverlay.style.cursor="ns-resize":l||u?this.cropOverlay.style.cursor="ew-resize":this.cropOverlay.style.cursor="default"}handleCropDrag(t,e){if(!this.cropState)return;const{contentTop:i,contentLeft:A,contentHeight:r,contentWidth:a}=this.cropState,l=.05;if(this.dragHandle==="top"){const u=Math.max(0,Math.min(1,(e-i)/r)),h=d.state.printOptions.cropBottom;u<h-l&&d.setPrintOptions({cropTop:u})}else if(this.dragHandle==="bottom"){const u=Math.max(0,Math.min(1,(e-i)/r)),h=d.state.printOptions.cropTop;u>h+l&&d.setPrintOptions({cropBottom:u})}else if(this.dragHandle==="left"){const u=Math.max(0,Math.min(1,(t-A)/a)),h=d.state.printOptions.cropRight;u<h-l&&d.setPrintOptions({cropLeft:u})}else if(this.dragHandle==="right"){const u=Math.max(0,Math.min(1,(t-A)/a)),h=d.state.printOptions.cropLeft;u>h+l&&d.setPrintOptions({cropRight:u})}}onCropMouseUp(){this.isDragging=!1,this.dragHandle=null,this.cropOverlay&&(this.cropOverlay.style.cursor="default")}}const YM=new XM;function jM(){zM.init(),YM.init(),b.initSuccess("UiComponents")}const _n={container:null,parentContainer:null,sustainTrack:null,sustainThumb:null,multiSliderContainer:null,thumbA:null,thumbD:null,thumbR:null};function JM(){var s;return _n.container=document.querySelector("#adsr-envelope"),_n.parentContainer=((s=_n.container)==null?void 0:s.closest(".adsr-container"))||null,_n.sustainTrack=document.getElementById("sustain-slider-track"),_n.sustainThumb=document.getElementById("sustain-slider-thumb"),_n.multiSliderContainer=document.getElementById("multi-thumb-slider-container"),_n.thumbA=document.getElementById("thumb-a"),_n.thumbD=document.getElementById("thumb-d"),_n.thumbR=document.getElementById("thumb-r"),_n}const ZM={init:JM,get elements(){return _n}};function vy(){return yy*d.state.adsrTimeAxisScale}function By(s,t){const e=d.state.timbres[t.currentColor];if(!e)return;const{sustain:i}=e.adsr,A=.01;s.d=Math.max(s.a+A,s.d),s.r=Math.max(s.d+A,s.r);const r=s.a,a=s.d-s.a,l=s.r-s.d;if(isNaN(r)||isNaN(a)||isNaN(l)){b.error("AdsrInteractions","NaN value detected before setting ADSR. Aborting update.",{newAttack:r,newDecay:a,newRelease:l},"audio");return}d.setADSR(t.currentColor,{attack:r,decay:a,release:l,sustain:i})}function tU(s,t){var a;let e=!1;const i=l=>{var y;if(!e||!s.sustainTrack)return;const u=s.sustainTrack.getBoundingClientRect();let m=100-(l.clientY-u.top)/u.height*100;m=Math.max(0,Math.min(100,m));const w=(((y=window.staticWaveformVisualizer)==null?void 0:y.getNormalizedAmplitude())||1)*100;m=Math.min(m,w);const C=d.state.timbres[t.currentColor];C&&d.setADSR(t.currentColor,{...C.adsr,sustain:m/100})},A=l=>{e=!0,i(l)},r=()=>{e=!1};(a=s.sustainTrack)==null||a.addEventListener("pointerdown",A),document.addEventListener("pointermove",i),document.addEventListener("pointerup",r)}function eU(s,t){var a;let e=null;const i=l=>{if(!e||!s.multiSliderContainer)return;const u=s.multiSliderContainer.getBoundingClientRect();let m=(l.clientX-u.left)/u.width*100;m=Math.max(0,Math.min(100,m));const g=m/100*vy(),w=d.state.timbres[t.currentColor];if(!w)return;const{attack:C,decay:y,release:E}=w.adsr,x={a:C,d:C+y,r:C+y+E};e.id==="thumb-a"&&(x.a=g),e.id==="thumb-d"&&(x.d=g),e.id==="thumb-r"&&(x.r=g),By(x,t)},A=l=>{const u=l.target;u.classList.contains("time-slider-thumb")&&(e=u,i(l))},r=()=>{e=null};(a=s.multiSliderContainer)==null||a.addEventListener("pointerdown",A),document.addEventListener("pointermove",i),document.addEventListener("pointerup",r)}function sU(s,t){let e=null;const i=a=>{var P;if(!e)return;const l=t.svgContainer,u=l.createSVGPoint();u.x=a.clientX,u.y=a.clientY;const h=l.getScreenCTM();if(!h)return;const m=u.matrixTransform(h.inverse());let g=m.x/t.width*100,w=1-m.y/t.height;g=Math.max(0,Math.min(100,g)),w=Math.max(0,Math.min(1,w));const C=g/100*vy(),y=d.state.timbres[t.currentColor];if(!y)return;const{attack:E,decay:x,release:T}=y.adsr;let U=y.adsr.sustain;const H={a:E,d:E+x,r:E+x+T};switch(e.id){case"attack-node":H.a=C;break;case"decay-sustain-node":{H.d=C;const G=((P=window.staticWaveformVisualizer)==null?void 0:P.getNormalizedAmplitude())||1;U=Math.min(w,G);break}case"release-node":H.r=C;break}const R=d.state.timbres[t.currentColor];if(!R)return;const D=R.adsr.sustain;U!==D&&d.setADSR(t.currentColor,{attack:E,decay:x,release:T,sustain:U}),By(H,t)},A=a=>{const l=a.target;l.classList.contains("adsr-node")&&(e=l,e.style.cursor="grabbing",i(a))},r=()=>{e&&(e.style.cursor="grab",e=null)};t.nodeLayer.addEventListener("pointerdown",A),document.addEventListener("pointermove",i),document.addEventListener("pointerup",r)}function nU(s){const t=s.ui;tU(t,s),eU(t,s),sU(t,s)}function iU(s,{width:t,height:e},i){for(;s.firstChild;)s.removeChild(s.firstChild);if(i>0){for(let l=1;l<=5;l++)if(l<=i){const u=l/i*t,h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",String(u)),h.setAttribute("y",String(e-5)),h.setAttribute("fill","#d0d0d0"),h.setAttribute("font-size","24"),h.setAttribute("font-weight","bold"),h.setAttribute("text-anchor","middle"),h.setAttribute("dominant-baseline","auto"),h.setAttribute("opacity","0.3"),h.textContent=`${l}s`,s.appendChild(h)}}const A=d.state.tempo;if(A<=0||i<=0)return;const r=30/A;let a=0;for(let l=r;l<i;l+=r){const u=l/i*t,h=document.createElementNS("http://www.w3.org/2000/svg","line");h.setAttribute("x1",String(u)),h.setAttribute("y1","0"),h.setAttribute("x2",String(u)),h.setAttribute("y2",String(e));const m=(a+1)%2===0;h.setAttribute("stroke",m?"#adb5bd":"#ced4da"),h.setAttribute("stroke-width",m?"1":"0.5"),h.setAttribute("stroke-dasharray","3,3"),s.appendChild(h),a++}}function AU(s,t,e,{height:i,width:A},r,a,l){for(;s.firstChild;)s.removeChild(s.firstChild);for(;t.firstChild;)t.removeChild(t.firstChild);if(e.length<4)return;const u=e[0],h=e[1],m=e[2],g=e[3];if(!u||!h||!m||!g)return;const w=d.state.colorPalette[r]||{primary:r,light:r},C=w.primary,y=w.light;let E={time:0,feedback:0},x={decay:0,roomSize:0};window.effectsCoordinator&&(E=window.effectsCoordinator.getEffectParameters(r,"delay"),x=window.effectsCoordinator.getEffectParameters(r,"reverb")),l&&l.clearRect(0,0,A,i);const T=(at,Bt=1)=>{if(!l||x.decay===0||x.roomSize===0||!a)return;const dt=at[1],X=at[3];if(!dt||!X)return;const nt=(x.decay||0)/100*5*(A/a),mt=(x.roomSize||0)/100*Bt;l.filter="blur(30px)";const ct=parseInt(y.slice(1,3),16),J=parseInt(y.slice(3,5),16),st=parseInt(y.slice(5,7),16),At=60;for(let vt=0;vt<At;vt++){const ft=vt/At,Mt=(vt+1)/At,Pt=dt.y+(X.y-dt.y)*ft,Nt=dt.y+(X.y-dt.y)*Mt,Wt=dt.x+(X.x-dt.x)*ft,Qt=dt.x+(X.x-dt.x)*Mt,Et=l.createLinearGradient(Wt,Pt,Wt+nt,Pt);Et.addColorStop(0,`rgba(${ct}, ${J}, ${st}, ${mt})`),Et.addColorStop(1,`rgba(${ct}, ${J}, ${st}, 0)`),l.fillStyle=Et,l.beginPath(),l.moveTo(Wt,Pt),l.lineTo(Wt+nt,Pt),l.lineTo(Qt+nt,Nt),l.lineTo(Qt,Nt),l.closePath(),l.fill()}l.filter="none"};if(T(e,1),(E.time||0)>0&&(E.feedback||0)>0&&a){const at=Math.max(.01,(E.time||0)/100*.5),Bt=Math.min(.95,(E.feedback||0)/100),dt=.05;let X=Bt,nt=0;for(;X>dt&&nt<10;){nt++;const mt=at*nt/a*A,ct=e.map(At=>({x:At.x+mt,y:At.y})),J=ct[0],st=ct[3];if(!(!J||!st)){if(J.x<A){T(ct,X);const At=document.createElementNS("http://www.w3.org/2000/svg","polygon"),vt=`${J.x},${i} `+ct.map(Mt=>`${Mt.x},${Mt.y}`).join(" ")+` ${Math.min(st.x,A)},${i}`;At.setAttribute("points",vt),At.setAttribute("fill",qn(y,.7*X)),At.setAttribute("class","delay-echo"),s.appendChild(At);const ft=document.createElementNS("http://www.w3.org/2000/svg","polyline");ft.setAttribute("points",ct.map(Mt=>`${Mt.x},${Mt.y}`).join(" ")),ft.setAttribute("stroke-width","2"),ft.setAttribute("fill","none"),ft.setAttribute("stroke",qn(C,X)),ft.setAttribute("class","delay-echo"),s.appendChild(ft)}X*=Bt}}}const U=document.createElementNS("http://www.w3.org/2000/svg","polygon"),H=`0,${i} `+e.map(at=>`${at.x},${at.y}`).join(" ")+` ${A},${i}`;U.setAttribute("points",H),U.setAttribute("fill",qn(y,.7)),s.appendChild(U);const R=document.createElementNS("http://www.w3.org/2000/svg","line");R.setAttribute("x1",String(u.x)),R.setAttribute("y1",String(u.y)),R.setAttribute("x2",String(h.x)),R.setAttribute("y2",String(h.y)),R.setAttribute("stroke",C),R.setAttribute("stroke-width","2"),s.appendChild(R);const D=document.createElementNS("http://www.w3.org/2000/svg","line");D.setAttribute("x1",String(h.x)),D.setAttribute("y1",String(h.y)),D.setAttribute("x2",String(m.x)),D.setAttribute("y2",String(m.y)),D.setAttribute("stroke",C),D.setAttribute("stroke-width","2"),s.appendChild(D);const P=(x.decay||0)>0&&(x.roomSize||0)>0?Math.max(.3,1-(x.decay||0)/100*((x.roomSize||0)/100)*.7):1,G=document.createElementNS("http://www.w3.org/2000/svg","line");G.setAttribute("x1",String(m.x)),G.setAttribute("y1",String(m.y)),G.setAttribute("x2",String(g.x)),G.setAttribute("y2",String(g.y)),G.setAttribute("stroke",qn(C,P)),G.setAttribute("stroke-width","2"),s.appendChild(G);const Y=["attack-node","decay-sustain-node","release-node"];[h,m,g].forEach((at,Bt)=>{const dt=document.createElementNS("http://www.w3.org/2000/svg","circle");dt.setAttribute("id",Y[Bt]),dt.setAttribute("class","adsr-node"),dt.setAttribute("cx",String(at.x)),dt.setAttribute("cy",String(at.y)),dt.setAttribute("r","8"),dt.setAttribute("fill",C),dt.setAttribute("stroke",Yc(C,-.3)),dt.setAttribute("stroke-width","2"),dt.style.cursor="grab";const X=document.createElementNS("http://www.w3.org/2000/svg","title");dt.appendChild(X),t.appendChild(dt)})}function rU(s,t){if(!s)return;const e=Yc(t,-.2);s.style.setProperty("--c-accent",t),s.style.setProperty("--c-accent-hover",e)}const Ge={};let hn=null,vA=!1;function oU(s,t){const e=document.createElementNS("http://www.w3.org/2000/svg","g");e.setAttribute("data-playhead-id",s);const i=document.createElementNS("http://www.w3.org/2000/svg","line");i.setAttribute("stroke",t),i.setAttribute("stroke-width","2"),i.setAttribute("stroke-dasharray","3,3"),e.appendChild(i);const A=document.createElementNS("http://www.w3.org/2000/svg","circle");return A.setAttribute("r","5"),A.setAttribute("fill",t),e.appendChild(A),e}function aU(s,t,e,i=null){if(!(!hn||!i)){if(t==="attack"){Ge[s]&&(Ge[s].requestId!==null&&cancelAnimationFrame(Ge[s].requestId),Ge[s].group.remove());const A=oU(s,e);hn.playheadLayer.appendChild(A),Ge[s]={group:A,phase:t,color:e,adsr:i,requestId:null,startTimestamp:Z.now(),elapsed:0},hp(s)}else if(t==="release"){if(vA)return;const A=Ge[s];if(!A)return;A.requestId!==null&&cancelAnimationFrame(A.requestId),A.phase="release",A.adsr=i,A.startTimestamp=Z.now(),A.elapsed=0,fp(s)}}}function hp(s){if(!Ge[s]||vA||!hn)return;const t=Ge[s];if(!t.adsr)return;const{attack:e,decay:i}=t.adsr,A=hn.calculateEnvelopePoints(t.adsr);if(A.length<4)return;const r=A[0],a=A[1],l=A[2],u=Z.now()-t.startTimestamp;t.elapsed=u;const h=e+i,m=Math.min(u,h);let g,w;if(m<=e){const E=e>0?m/e:1;g=r.x+E*(a.x-r.x),w=r.y+E*(a.y-r.y)}else{const E=m-e,x=i>0?E/i:1;g=a.x+x*(l.x-a.x),w=a.y+x*(l.y-a.y)}const[C,y]=t.group.children;C.setAttribute("x1",String(g)),C.setAttribute("y1","0"),C.setAttribute("x2",String(g)),C.setAttribute("y2",String(hn.height)),y.setAttribute("cx",String(g)),y.setAttribute("cy",String(w)),m<h?t.requestId=requestAnimationFrame(()=>hp(s)):(t.phase="sustain",dp(s))}function dp(s){if(!Ge[s]||vA||!hn)return;const t=Ge[s];if(!t.adsr)return;const e=hn.calculateEnvelopePoints(t.adsr);if(e.length<4)return;const i=e[2],[A,r]=t.group.children;A.setAttribute("x1",String(i.x)),A.setAttribute("y1","0"),A.setAttribute("x2",String(i.x)),A.setAttribute("y2",String(hn.height)),r.setAttribute("cx",String(i.x)),r.setAttribute("cy",String(i.y)),t.requestId=requestAnimationFrame(()=>dp(s))}function fp(s){if(!Ge[s]||vA||!hn)return;const t=Ge[s];if(!t.adsr)return;const{release:e}=t.adsr,i=hn.calculateEnvelopePoints(t.adsr);if(i.length<4)return;const A=i[2],r=i[3],a=Z.now()-t.startTimestamp;t.elapsed=a;const l=Math.min(a,e),u=e>0?l/e:1,h=A.x+u*(r.x-A.x),m=A.y+u*(r.y-A.y),[g,w]=t.group.children;g.setAttribute("x1",String(h)),g.setAttribute("y1","0"),g.setAttribute("x2",String(h)),g.setAttribute("y2",String(hn.height)),w.setAttribute("cx",String(h)),w.setAttribute("cy",String(m)),l<e?t.requestId=requestAnimationFrame(()=>fp(s)):(t.group.remove(),delete Ge[s])}function lU(){vA=!0;for(const s in Ge){const t=Ge[s];t&&t.requestId!==null&&(cancelAnimationFrame(t.requestId),t.requestId=null)}}function cU(){vA=!1;for(const s in Ge){const t=Ge[s];t&&(t.startTimestamp=Z.now()-t.elapsed,t.phase==="attack"?hp(s):t.phase==="sustain"?dp(s):t.phase==="release"&&fp(s))}}function uU(){vA=!1;for(const s in Ge){const t=Ge[s];t&&(t.requestId!==null&&cancelAnimationFrame(t.requestId),t.group.remove())}for(const s in Ge)delete Ge[s]}function hU(s){return hn=s,{trigger:aU,pause:lU,resume:cU,clearAll:uU}}const yy=2.5;class dU{constructor(){Q(this,"ui");Q(this,"currentColor");Q(this,"attack");Q(this,"decay");Q(this,"sustain");Q(this,"release");Q(this,"width");Q(this,"height");Q(this,"reverbCanvas",null);Q(this,"reverbCtx",null);Q(this,"svgContainer");Q(this,"gridLayer");Q(this,"envelopeLayer");Q(this,"nodeLayer");Q(this,"playheadLayer");Q(this,"playheadManager");var e;if(this.ui=ZM.init(),!this.ui.container)throw b.error("AdsrComponent","ADSR container element not found",null,"adsr"),new Error("ADSR container element not found");this.currentColor=((e=d.state.selectedNote)==null?void 0:e.color)||"#4a90e2",this.attack=0,this.decay=0,this.sustain=0,this.release=0,this.width=0,this.height=0,this.createSVGLayers(),this.resize(),this.playheadManager=hU(this),Cs.adsrComponent=this,nU(this),this.listenForStoreChanges(),this.initControls();const t=this.ui.container;t&&new ResizeObserver(()=>this.resize()).observe(t),this.updateFromStore(),b.info("ADSR Component","Initialized",null,"adsr")}resize(){if(this.ui.container){if(this.width=this.ui.container.clientWidth,this.height=this.ui.container.clientHeight,this.reverbCanvas){const t=window.devicePixelRatio||1;this.reverbCanvas.width=this.width*t,this.reverbCanvas.height=this.height*t,this.reverbCtx&&(this.reverbCtx.setTransform(1,0,0,1,0,0),this.reverbCtx.scale(t,t))}this.svgContainer&&this.svgContainer.setAttribute("viewBox",`0 0 ${this.width} ${this.height}`),this.render()}}updateFromStore(){const t=d.state.timbres[this.currentColor];if(!t)return;const{attack:e,decay:i,sustain:A,release:r}=t.adsr;this.attack=e,this.decay=i,this.sustain=A,this.release=r,this.render(),this.updateControls()}getCurrentMaxTime(){return yy*d.state.adsrTimeAxisScale}initControls(){const t=document.getElementById("adsr-time-scale"),e=document.getElementById("adsr-time-scale-value");t&&e&&(t.value=String(d.state.adsrTimeAxisScale),e.textContent=`${d.state.adsrTimeAxisScale}x`,t.addEventListener("input",i=>{const A=i.currentTarget;if(!A)return;const r=parseFloat(A.value);Number.isFinite(r)&&(d.setAdsrTimeAxisScale(r),e.textContent=`${r}x`)}))}listenForStoreChanges(){d.on("noteChanged",t=>{var i;const e=(i=t==null?void 0:t.newNote)==null?void 0:i.color;e&&e!==this.currentColor&&(this.currentColor=e,this.updateFromStore())}),d.on("timbreChanged",t=>{t===this.currentColor&&this.updateFromStore()}),d.on("tempoChanged",()=>this.render()),d.on("adsrTimeAxisScaleChanged",()=>{this.render(),this.updateControls()}),d.on("tremoloAmplitudeUpdate",t=>{const e=t==null?void 0:t.activeColors;e!=null&&e.includes(this.currentColor)&&this.render()}),d.on("playbackStateChanged",t=>{if(!t)return;const{isPlaying:e,isPaused:i}=t;e?i?this.playheadManager.pause():this.playheadManager.resume():this.playheadManager.clearAll()}),d.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,color:i}=t;i===this.currentColor&&(e==="delay"||e==="reverb")&&this.render()})}createSVGLayers(){this.ui.container&&(this.reverbCanvas=document.createElement("canvas"),this.reverbCanvas.className="adsr-reverb-canvas",this.reverbCanvas.style.position="absolute",this.reverbCanvas.style.top="0",this.reverbCanvas.style.left="0",this.reverbCanvas.style.width="100%",this.reverbCanvas.style.height="100%",this.reverbCanvas.style.pointerEvents="none",this.ui.container.appendChild(this.reverbCanvas),this.reverbCtx=this.reverbCanvas.getContext("2d"),this.svgContainer=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgContainer.setAttribute("width","100%"),this.svgContainer.setAttribute("height","100%"),this.ui.container.appendChild(this.svgContainer),this.gridLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.gridLayer),this.envelopeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.envelopeLayer),this.nodeLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.nodeLayer),this.playheadLayer=document.createElementNS("http://www.w3.org/2000/svg","g"),this.svgContainer.appendChild(this.playheadLayer))}calculateEnvelopePoints(t){var E,x;const{attack:e,decay:i,sustain:A,release:r}=t??{attack:this.attack,decay:this.decay,sustain:this.sustain,release:this.release};if(!this.width||!this.height)return[];const a=T=>T/this.getCurrentMaxTime()*this.width;let l=1;const u=window.animationEffectsManager;(E=u==null?void 0:u.shouldTremoloBeRunning)!=null&&E.call(u)&&(l=u.getADSRTremoloAmplitudeMultiplier(this.currentColor));const h=((x=window.staticWaveformVisualizer)==null?void 0:x.calculatedAmplitude)??1,m=h*l;b.debug("AdsrComponent","[ADSR] Amplitude calculation",{originalAmplitude:h,tremoloMultiplier:l,normalizedAmplitude:m});const g={x:0,y:this.height},w={x:a(e),y:this.height*(1-m)},C={x:a(e+i),y:this.height*(1-Math.min(A*m,m))},y={x:a(e+i+r),y:this.height};return[g,w,C,y]}render(){if(!this.width||!this.height||!this.gridLayer||!this.envelopeLayer||!this.nodeLayer)return;const t={width:this.width,height:this.height},e=this.calculateEnvelopePoints(),i=this.getCurrentMaxTime();iU(this.gridLayer,t,i),AU(this.envelopeLayer,this.nodeLayer,e,t,this.currentColor,i,this.reverbCtx),rU(this.ui.parentContainer,this.currentColor)}updateControls(){var Y,W;const{sustainThumb:t,sustainTrack:e,thumbA:i,thumbD:A,thumbR:r,multiSliderContainer:a}=this.ui;if(!t||!e||!i||!A||!r||!a)return;const l=d.state.timbres[this.currentColor];if(!l)return;let u=1;const h=window.animationEffectsManager;(Y=h==null?void 0:h.shouldTremoloBeRunning)!=null&&Y.call(h)&&(u=h.getADSRTremoloAmplitudeMultiplier(this.currentColor));const g=(((W=window.staticWaveformVisualizer)==null?void 0:W.calculatedAmplitude)||1)*u,w=g*100;this.sustain>g&&(d.setADSR(this.currentColor,{...l.adsr,sustain:g}),this.sustain=g);const C=this.sustain*100;t.style.bottom=`${C}%`,e.style.setProperty("--sustain-progress",`${C}%`);const y=100-w;e.style.setProperty("--ineligible-height",`${y}%`);const E=this.getCurrentMaxTime(),x=this.attack/E*100,T=(this.attack+this.decay)/E*100,U=(this.attack+this.decay+this.release)/E*100;i.style.left=`${x}%`,A.style.left=`${T}%`,r.style.left=`${U}%`,a.style.setProperty("--adr-progress",`${U}%`);const H=at=>`${at.toFixed(3)}s`,R=at=>`${(at*100).toFixed(0)}%`;i.title=`Attack: ${H(this.attack)}`,A.title=`Decay: ${H(this.decay)}`,r.title=`Release: ${H(this.release)}`,t.title=`Sustain: ${R(this.sustain)}`;const D=this.nodeLayer.querySelector("#attack-node > title");D&&(D.textContent=`Attack: ${H(this.attack)}`);const P=this.nodeLayer.querySelector("#decay-sustain-node > title");P&&(P.textContent=`Decay: ${H(this.decay)}
Sustain: ${R(this.sustain)}`);const G=this.nodeLayer.querySelector("#release-node > title");G&&(G.textContent=`Release: ${H(this.release)}`)}}function fU(){return document.getElementById("adsr-envelope")?new dU:null}function xf(s,...t){}let dr,fa,Hi,pa,Jo,Zo,Er,Ef=!1,Sf=!1,Ff=!1,Ns;const xc=1,Cy=31,by=0,Ec=2;function pU(){if(!Ns)return null;const s=d.state.timbres[Ns];return s?(s.filter?s.filter.enabled===void 0&&(s.filter.enabled=!0):s.filter={enabled:!0,blend:0,cutoff:16,resonance:0,type:"lowpass",mix:0},s.filter):null}function md(){const s=pU();if(!s)return;const{cutoff:t=16,blend:e=0,mix:i=0}=s;if(dr&&fa){const A=(Ec-e)/(Ec-by);dr.style.left=`${A*100}%`,fa.style.setProperty("--progress",`${A*100}%`)}if(Zo&&Er){const A=(i||0)/100;Zo.style.bottom=`${A*100}%`,Er.style.setProperty("--blend-progress",`${A*100}%`)}if(Hi&&pa){const A=(t-xc)/(Cy-xc);Hi.style.left=`${A*100}%`,Hi.style.top="50%",Hi.style.transform="translate(-50%, -50%)",pa.style.setProperty("--progress",`${A*100}%`)}Jo&&Ns&&Jo.style.setProperty("--c-accent",Ns)}function mU(s){if(!Ef||!Ns||!pa)return;const t=pa.getBoundingClientRect(),e=s.clientX-t.left,i=t.width;let A=e/i;A=Math.max(0,Math.min(1,A));const r=A*(Cy-xc)+xc;d.setFilterSettings(Ns,{cutoff:r})}function gU(s){if(!Sf||!Ns||!fa)return;const t=fa.getBoundingClientRect(),e=s.clientX-t.left,i=t.width;let A=e/i;A=Math.max(0,Math.min(1,A));const r=Ec-A*(Ec-by);d.setFilterSettings(Ns,{blend:r})}function wU(s){if(!Ff||!Ns||!Er)return;const t=Er.getBoundingClientRect(),e=s.clientY-t.top,i=t.height;let A=1-e/i;A=Math.max(0,Math.min(1,A));const r=A*100;d.setFilterSettings(Ns,{mix:r})}function vU(){var s;if(Jo=document.querySelector(".filter-container"),dr=document.getElementById("thumb-b"),fa=document.getElementById("blend-slider-container"),Hi=document.getElementById("thumb-c"),pa=document.getElementById("cutoff-slider-container"),!Jo||!dr||!Hi){b.error("FilterControls","Missing required elements",{container:Jo,blendThumb:dr,cutoffThumb:Hi},"filter");return}BU(),dr.addEventListener("pointerdown",t=>{t.preventDefault(),Sf=!0,document.body.style.cursor="ew-resize";const e=A=>{xf("log","[BLEND SLIDER] Moving",{clientX:A.clientX}),gU(A)},i=()=>{Sf=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",i),d.recordState()};window.addEventListener("pointermove",e),window.addEventListener("pointerup",i)}),Hi.addEventListener("pointerdown",t=>{t.preventDefault(),Ef=!0,document.body.style.cursor="ew-resize";const e=A=>{xf("log","[CUTOFF SLIDER] Moving",{clientX:A.clientX}),mU(A)},i=()=>{Ef=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",e),window.removeEventListener("pointerup",i),d.recordState()};window.addEventListener("pointermove",e),window.addEventListener("pointerup",i)}),d.on("noteChanged",({newNote:t})=>{t.color&&t.color!==Ns&&(Ns=t.color,md())}),d.on("timbreChanged",t=>{t===Ns&&md()}),Ns=((s=d.state.selectedNote)==null?void 0:s.color)||"#4a90e2",md()}function BU(){if(Er=document.getElementById("vertical-blend-track"),Zo=document.getElementById("vertical-blend-thumb"),!Er||!Zo){b.error("FilterControls","Vertical blend slider elements not found",null,"filter");return}Zo.addEventListener("pointerdown",s=>{s.preventDefault(),Ff=!0,document.body.style.cursor="ns-resize";const t=i=>{xf("log","[VERTICAL BLEND] Moving",{clientY:i.clientY}),wU(i)},e=()=>{Ff=!1,document.body.style.cursor="default",window.removeEventListener("pointermove",t),window.removeEventListener("pointerup",e),d.recordState()};window.addEventListener("pointermove",t),window.addEventListener("pointerup",e)})}const gd=()=>window.synthEngine??null,Pw=()=>window.animationEffectsManager??null;b.moduleLoaded("DynamicWaveformVisualizer");class yU{constructor(){Q(this,"canvas",null);Q(this,"ctx",null);Q(this,"currentColor",null);Q(this,"isPlaybackActive",!1);Q(this,"liveAnalysers",new Map);Q(this,"liveWaveforms",new Map);Q(this,"playbackAnimationId",null);Q(this,"animationSpeed",100);Q(this,"frameSkipCounter",0);Q(this,"onWaveformUpdate")}initialize(t,e){var i;return this.canvas=t,this.ctx=e,this.currentColor=((i=d.state.selectedNote)==null?void 0:i.color)||"#4a90e2",this.setupEventListeners(),b.info("DynamicWaveformVisualizer","Initialized with canvas context",null,"waveform"),!0}setupEventListeners(){d.on("noteChanged",({newNote:t})=>{t!=null&&t.color&&t.color!==this.currentColor&&(this.currentColor=t.color)}),d.on("playbackStateChanged",({isPlaying:t,isPaused:e})=>{t&&!e?this.startLiveVisualization():this.stopLiveVisualization()}),d.on("spacebarPlayback",({color:t,isPlaying:e})=>{e&&t?this.startSingleNoteVisualization(t):this.stopLiveVisualization()}),d.on("tremoloAmplitudeUpdate",({activeColors:t})=>{this.isPlaybackActive&&(t!=null&&t.some(e=>this.liveWaveforms.has(e)))&&b.debug("DynamicWaveformVisualizer","Tremolo update received for active colors",t,"waveform")}),b.info("DynamicWaveformVisualizer","Event subscriptions established",null,"waveform")}setAnimationSpeed(t){this.animationSpeed=t,this.frameSkipCounter=0}startLiveVisualization(){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupLiveAnalysers(),this.updateContainerState(!0),this.animateLiveWaveforms(),b.debug("DynamicWaveformVisualizer","Started live visualization",null,"waveform"))}startSingleNoteVisualization(t){this.isPlaybackActive||(this.isPlaybackActive=!0,this.setupSingleAnalyser(t),this.updateContainerState(!0),this.animateLiveWaveforms(),b.debug("DynamicWaveformVisualizer",`Started single note visualization for ${t}`,null,"waveform"))}stopLiveVisualization(){this.isPlaybackActive=!1;const t=gd();this.liveAnalysers.forEach((e,i)=>{var A;(A=t==null?void 0:t.removeWaveformAnalyzer)==null||A.call(t,i)}),this.liveAnalysers.clear(),this.liveWaveforms.clear(),this.playbackAnimationId&&(cancelAnimationFrame(this.playbackAnimationId),this.playbackAnimationId=null),this.updateContainerState(!1),b.debug("DynamicWaveformVisualizer","Stopped live visualization",null,"waveform")}updateContainerState(t){var i;const e=(i=this.canvas)==null?void 0:i.parentElement;e&&(t?(e.classList.add("live-mode"),d.state.isPlaying&&!d.state.isPaused&&e.classList.add("pulsing")):e.classList.remove("live-mode","pulsing"))}setupLiveAnalysers(){const t=gd();if(!t){b.warn("DynamicWaveformVisualizer","SynthEngine not available for live analysis",null,"waveform");return}this.getActivePlayingColors().forEach(i=>{var r;const A=(r=t.createWaveformAnalyzer)==null?void 0:r.call(t,i);A&&(this.liveAnalysers.set(i,A),this.liveWaveforms.set(i,new Float32Array(1024)),b.debug("DynamicWaveformVisualizer",`Created analyser for ${i}`,null,"waveform"))})}setupSingleAnalyser(t){var A;const e=gd();if(!e)return;const i=(A=e.createWaveformAnalyzer)==null?void 0:A.call(e,t);i&&(this.liveAnalysers.set(t,i),this.liveWaveforms.set(t,new Float32Array(1024)),b.debug("DynamicWaveformVisualizer",`Created single analyser for ${t}`,null,"waveform"))}getActivePlayingColors(){const t=new Set,e=d.state.placedNotes;d.state.isPlaying&&e.forEach(A=>{!A.isDrum&&A.color&&t.add(A.color)}),t.size===0&&this.currentColor&&t.add(this.currentColor);const i=Array.from(t);return b.debug("DynamicWaveformVisualizer","Active playing colors detected",i,"waveform"),i}animateLiveWaveforms(){var e;if(!this.isPlaybackActive)return;this.frameSkipCounter++;const t=Math.max(1,Math.floor(100/Math.max(this.animationSpeed,1)));if(this.frameSkipCounter%t!==0){this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms());return}this.liveAnalysers.forEach((i,A)=>{const r=i.getValue();this.liveWaveforms.set(A,r)}),(e=this.onWaveformUpdate)==null||e.call(this),this.playbackAnimationId=requestAnimationFrame(()=>this.animateLiveWaveforms())}drawLiveWaveforms(t,e,i){if(!this.ctx)return;const r=Array.from(this.liveWaveforms.keys());if(r.length===1){const a=r[0];if(!a)return;const l=this.liveWaveforms.get(a);this.drawSingleLiveWaveform(l,a,t,e,i)}else r.length>1&&r.forEach(a=>{if(!a)return;const l=this.liveWaveforms.get(a);this.drawLayeredLiveWaveform(l,a,t,e,i,r.length)})}drawSingleLiveWaveform(t,e,i,A,r){const a=this.ctx;if(!a||!t||t.length===0)return;const l=Pw();let u=r;if(l){const x=l.getTremoloAmplitudeMultiplier(e);u*=x}let h=0;const m=l==null?void 0:l.vibratoCanvasEffect,g=m==null?void 0:m.animations.get(e);m&&g&&m.shouldBeRunning()&&(h=Math.sin(g.phase)*g.amplitude*.4);let w=0;for(let x=0;x<t.length;x++){const T=t[x]??0;w=Math.max(w,Math.abs(T))}const C=w>1?1/w:1;a.strokeStyle=e,a.lineWidth=2,a.beginPath();const E=t.length/i*(1+h);for(let x=0;x<i;x++){const T=h*i*.3,U=x+T,H=Math.floor(U*E),R=Math.max(0,Math.min(t.length-1,H)),D=(t[R]??0)*C,P=A-D*u;x===0?a.moveTo(x,P):a.lineTo(x,P)}a.stroke(),b.debug("DynamicWaveformVisualizer",`Drew single live waveform for ${e} with tremolo and vibrato stretch`,{amplitudeRatio:u/r,vibratoStretch:h},"waveform")}drawLayeredLiveWaveform(t,e,i,A,r,a){const l=this.ctx;if(!l||!t||t.length===0)return;const u=Pw();let h=r;u&&(h*=u.getTremoloAmplitudeMultiplier(e));let m=0;const g=u==null?void 0:u.vibratoCanvasEffect,w=g==null?void 0:g.animations.get(e);g&&w&&g.shouldBeRunning()&&(m=Math.sin(w.phase)*w.amplitude*.4);let C=0;for(let U=0;U<t.length;U++){const H=t[U]??0;C=Math.max(C,Math.abs(H))}const y=C>1?1/C:1,E=Math.max(.4,1/a);l.strokeStyle=qn(e,E*2),l.lineWidth=1.5,l.beginPath();const T=t.length/i*(1+m);for(let U=0;U<i;U++){const H=m*i*.3,R=U+H,D=Math.floor(R*T),P=Math.max(0,Math.min(t.length-1,D)),G=(t[P]??0)*y,Y=A-G*h*.7;U===0?l.moveTo(U,Y):l.lineTo(U,Y)}l.stroke()}isLiveMode(){return this.isPlaybackActive}getLiveColors(){return Array.from(this.liveWaveforms.keys())}dispose(){this.stopLiveVisualization(),b.info("DynamicWaveformVisualizer","Disposed",null,"waveform")}}const CU=512,iA=360,Bo=480,bU=()=>window.animationEffectsManager;b.moduleLoaded("StaticWaveformVisualizer");class _U{constructor(){Q(this,"canvas",null);Q(this,"ctx",null);Q(this,"currentColor",null);Q(this,"animationFrameId",null);Q(this,"waveformData",new Float32Array(CU));Q(this,"isInitialized",!1);Q(this,"isTransitioning",!1);Q(this,"transitionStartTime",0);Q(this,"transitionDuration",300);Q(this,"fromWaveform",null);Q(this,"toWaveform",null);Q(this,"transitionAnimationId",null);Q(this,"dynamicVisualizer",new yU);Q(this,"animationSpeed",100);Q(this,"frameSkipCounter",0);Q(this,"resizeObserver",null);Q(this,"calculatedAmplitude",0);b.info("StaticWaveformVisualizer","Initialized with dynamic visualizer integration",null,"waveform")}initialize(){var i,A;if(this.canvas=document.getElementById("static-waveform-canvas"),!this.canvas)return!1;const t=this.canvas.getContext("2d");if(!t)return!1;this.ctx=t,this.currentColor=((i=d.state.selectedNote)==null?void 0:i.color)||"#4a90e2";const e=this.canvas.parentElement;return e&&typeof ResizeObserver<"u"&&((A=this.resizeObserver)==null||A.disconnect(),this.resizeObserver=new ResizeObserver(()=>this.resize()),this.resizeObserver.observe(e)),this.resize(),this.setupEventListeners(),this.dynamicVisualizer.initialize(this.canvas,this.ctx),this.dynamicVisualizer.onWaveformUpdate=()=>this.draw(),this.generateWaveform(),this.isInitialized=!0,!0}resize(){if(!this.canvas||!this.ctx)return;const t=this.canvas.parentElement;if(!t)return;const{clientWidth:e,clientHeight:i}=t,A=this.canvas.width,r=this.canvas.height;if((e===0||i===0)&&this.canvas.width>0&&this.canvas.height>0)return;const l=Math.abs(e-A),u=Math.abs(i-r);(l>2||u>2)&&(this.canvas.width=e,this.canvas.height=i,this.draw())}setupEventListeners(){d.on("noteChanged",(e={})=>{var A;const i=(A=e.newNote)==null?void 0:A.color;i&&i!==this.currentColor&&(this.currentColor=i,this.generateWaveform())}),d.on("timbreChanged",e=>{e&&e===this.currentColor&&this.generateWaveform()}),d.on("waveformExtendedViewChanged",()=>{this.generateWaveform(),this.updateToggleButton()}),document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab==="timbre"&&setTimeout(()=>this.resize(),100)})}),this.setupSpeedControls(),this.setupExtendToggle()}setupSpeedControls(){const t=Array.from(document.querySelectorAll(".waveform-speed-btn"));t.length!==0&&t.forEach(e=>{e.addEventListener("click",()=>{const i=e.dataset.speed,A=i?parseInt(i,10):NaN;Number.isFinite(A)&&(e.classList.contains("active")?(e.classList.remove("active"),this.setAnimationSpeed(100)):(t.forEach(r=>r.classList.remove("active")),e.classList.add("active"),this.setAnimationSpeed(A)))})})}setAnimationSpeed(t){Number.isFinite(t)&&(this.animationSpeed=t,this.frameSkipCounter=0,this.dynamicVisualizer.setAnimationSpeed(t))}setupExtendToggle(){const t=document.getElementById("waveform-extend-toggle");t instanceof HTMLElement&&(t.addEventListener("click",()=>{d.toggleWaveformExtendedView()}),this.updateToggleButton())}updateToggleButton(){const t=document.getElementById("waveform-extend-toggle");if(!(t instanceof HTMLElement))return;const e=d.state.waveformExtendedView;t.classList.toggle("extended",e),t.textContent=e?"480 View":"360 View",t.title=e?"Switch to 360 waveform view":"Switch to 480 waveform view (shows extra 120)"}generateWaveform(){if(this.isTransitioning||!this.currentColor)return;const t=d.state.timbres[this.currentColor];if(!(t!=null&&t.coeffs))return;const e=bc(this.currentColor),i=t.phases??new Float32Array(uA),A=this.waveformData.length;this.waveformData.fill(0);let r=0;for(let a=0;a<A;a++){const u=(d.state.waveformExtendedView?Bo:iA)/iA,h=a/A*u*2*Math.PI;let m=0;for(let g=0;g<uA;g++){const w=e[g]??0;if(w<=.001)continue;const C=i[g]??0,y=g+1;m+=w*Math.sin(y*h+C)}this.waveformData[a]=m,r=Math.max(r,Math.abs(m))}if(this.calculatedAmplitude=Math.min(1,r),r>1){const a=1/r;for(let l=0;l<this.waveformData.length;l++){const u=this.waveformData[l]??0;this.waveformData[l]=u*a}}this.draw()}startPhaseTransition(t,e,i){!this.isInitialized||!this.currentColor||(this.isTransitioning&&this.transitionAnimationId&&cancelAnimationFrame(this.transitionAnimationId),this.fromWaveform=new Float32Array(this.waveformData),this.generateTargetWaveform(e),this.toWaveform=new Float32Array(this.waveformData),this.waveformData=this.fromWaveform,this.isTransitioning=!0,this.transitionStartTime=performance.now(),this.animateTransition())}generateTargetWaveform(t){if(!this.currentColor||!t)return;const e=d.state.timbres[this.currentColor];if(!(e!=null&&e.coeffs))return;const i=bc(this.currentColor),A=t instanceof Float32Array?t:new Float32Array(t),r=this.waveformData.length;this.waveformData.fill(0);let a=0;for(let l=0;l<r;l++){const h=(d.state.waveformExtendedView?Bo:iA)/iA,m=l/r*h*2*Math.PI;let g=0;for(let w=0;w<uA;w++){const C=i[w]??0;if(C<=.001)continue;const y=A[w]??0,E=w+1;g+=C*Math.sin(E*m+y)}this.waveformData[l]=g,a=Math.max(a,Math.abs(g))}if(this.calculatedAmplitude=Math.min(1,a),a>1){const l=1/a;for(let u=0;u<this.waveformData.length;u++){const h=this.waveformData[u]??0;this.waveformData[u]=h*l}}}animateTransition(){const t=this.fromWaveform,e=this.toWaveform;if(!this.isTransitioning||!t||!e)return;const i=performance.now()-this.transitionStartTime,A=Math.min(i/this.transitionDuration,1),r=1-Math.pow(1-A,3);for(let a=0;a<this.waveformData.length;a++){const l=t[a]??0,u=e[a]??0;this.waveformData[a]=l+(u-l)*r}this.draw(),A>=1?(this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.transitionAnimationId=null):this.transitionAnimationId=requestAnimationFrame(()=>this.animateTransition())}normalizeWaveform(){let t=0;for(let e=0;e<this.waveformData.length;e++){const i=this.waveformData[e]??0;t=Math.max(t,Math.abs(i))}if(t>0){const e=.9/t;for(let i=0;i<this.waveformData.length;i++){const A=this.waveformData[i]??0;this.waveformData[i]=A*e}}}draw(){const t=this.ctx,e=this.canvas;if(!t||!e)return;const{width:i,height:A}=e,r=A/2,a=A/2;t.fillStyle="#ffffff",t.fillRect(0,0,i,A),this.drawGrid(i,A,r,a),this.dynamicVisualizer.isLiveMode()?this.dynamicVisualizer.drawLiveWaveforms(i,r,a):this.drawWaveform(i,r,a),i>200&&A>100&&this.drawLabels(i,A)}drawGrid(t,e,i,A){const r=this.ctx;if(!r)return;r.strokeStyle="#ced4da",r.lineWidth=1,r.setLineDash([2,2]),r.beginPath(),r.moveTo(0,i),r.lineTo(t,i),r.stroke();const a=d.state.waveformExtendedView?Bo:iA;if((d.state.waveformExtendedView?[90,180,270,360,450]:[90,180,270]).forEach(g=>{const w=t/a*g;r.beginPath(),r.moveTo(w,0),r.lineTo(w,e),r.stroke()}),d.state.waveformExtendedView){const g=t/Bo*iA;r.fillStyle="rgba(128, 128, 128, 0.15)",r.fillRect(g,0,t-g,e)}[.5].forEach(g=>{const w=i-A*g,C=i+A*g;r.beginPath(),r.moveTo(0,w),r.lineTo(t,w),r.moveTo(0,C),r.lineTo(t,C),r.stroke()}),r.setLineDash([]),r.strokeStyle="#999999",r.lineWidth=1;const h=i-A,m=i+A;r.beginPath(),r.moveTo(0,h),r.lineTo(t,h),r.stroke(),r.beginPath(),r.moveTo(0,m),r.lineTo(t,m),r.stroke()}drawWaveform(t,e,i){const A=this.ctx;if(!A||this.waveformData.length===0)return;const r=this.currentColor||"#4a90e2";A.strokeStyle=r,A.lineWidth=2,A.beginPath();const a=this.waveformData.length/t;for(let u=0;u<t;u++){const h=Math.floor(u*a),m=this.waveformData[h]||0,g=e-m*i;u===0?A.moveTo(u,g):A.lineTo(u,g)}A.stroke(),A.lineTo(t,e),A.lineTo(0,e),A.closePath();const l=A.createLinearGradient(0,e-i,0,e+i);l.addColorStop(0,qn(r,.3)),l.addColorStop(.5,qn(r,.1)),l.addColorStop(1,qn(r,.3)),A.fillStyle=l,A.fill()}drawLabels(t,e){const i=this.ctx;if(!i)return;const A=d.state.waveformExtendedView,r=A?Bo:iA,a=A?["0","90","180","270","360","450"]:["0","90","180","270","360"],l=A?[0,90,180,270,360,450]:[0,90,180,270,360];i.fillStyle="#666666",i.font='12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',i.textAlign="center",a.forEach((u,h)=>{const m=l[h]??0,g=t/r*m+10;i.fillText(u,g,e/2+4)}),i.textAlign="left",i.fillText("+1.0",5,15),i.fillText("-1.0",5,e-8)}getNormalizedAmplitude(){return this.calculatedAmplitude||0}getADSRTremoloAmplitude(){const t=this.calculatedAmplitude||0,e=bU();if(this.currentColor&&(e!=null&&e.getADSRTremoloAmplitudeMultiplier)){const i=e.getADSRTremoloAmplitudeMultiplier(this.currentColor);return t*i}return t}startSingleNoteVisualization(t){this.dynamicVisualizer.startSingleNoteVisualization(t)}stopLiveVisualization(){this.dynamicVisualizer.stopLiveVisualization()}startLiveVisualization(){this.dynamicVisualizer.startLiveVisualization()}dispose(){var t;this.dynamicVisualizer.dispose(),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.transitionAnimationId&&(cancelAnimationFrame(this.transitionAnimationId),this.transitionAnimationId=null),(t=this.resizeObserver)==null||t.disconnect(),this.resizeObserver=null,this.isTransitioning=!1,this.fromWaveform=null,this.toWaveform=null,this.isInitialized=!1}}const _y=new _U;window.staticWaveformVisualizer=_y;function xU(){return _y.initialize()}class xy{constructor(t){Q(this,"effectName");Q(this,"animations");Q(this,"activeNoteAnimations");Q(this,"ghostNoteAnimation");Q(this,"activeSoundingNotes");Q(this,"isPlaybackActive");Q(this,"hasActiveInteraction");Q(this,"hasDialInteraction");this.effectName=t,this.animations=new Map,this.activeNoteAnimations=new Map,this.ghostNoteAnimation=null,this.activeSoundingNotes=new Map,this.isPlaybackActive=!1,this.hasActiveInteraction=!1,this.hasDialInteraction=!1,b.info(`${t}AnimationEffect`,"Base initialized",null,"animation")}initBase(){d.on("visualEffectChanged",t=>{if(!t)return;const{effectType:e,color:i,effectParams:A}=t;e===this.effectName.toLowerCase()&&this.updateAnimationParameters(i,A)}),d.on("playbackStarted",()=>{this.isPlaybackActive=!0,this.requestAnimationStateUpdate()}),d.on("playbackStopped",()=>{this.isPlaybackActive=!1,this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.requestAnimationStateUpdate()}),d.on("noteInteractionStart",t=>{t&&this.onNoteInteractionStart(t.noteId,t.color)}),d.on("noteInteractionEnd",t=>{const e=t==null?void 0:t.noteId;e&&this.onNoteInteractionEnd(e)}),d.on("ghostNoteUpdated",t=>{t&&this.onGhostNoteUpdated(t.color)}),d.on("ghostNoteCleared",()=>this.onGhostNoteCleared()),d.on("spacebarPlayback",t=>{t&&(this.isPlaybackActive=t.isPlaying,this.requestAnimationStateUpdate())}),d.on("noteAttack",t=>{t&&this.onNoteAttack(t.noteId,t.color)}),d.on("noteRelease",t=>{t&&this.onNoteRelease(t.noteId,t.color)}),d.on("effectDialInteractionStart",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionStart(t.color)}),d.on("effectDialInteractionEnd",t=>{t&&t.effectType===this.effectName.toLowerCase()&&this.onDialInteractionEnd(t.color)}),b.info(`${this.effectName}AnimationEffect`,"Base event subscriptions established",null,"animation")}shouldAnimateColor(t){return this.animations.has(t)}shouldAnimateNote(t){if(!(t!=null&&t.color)||!this.shouldAnimateColor(t.color))return!1;if(this.hasDialInteraction&&this.activeNoteAnimations.has("dial-preview")){const e=this.activeNoteAnimations.get("dial-preview");if(e&&t.color===e)return!0}return!!(this.isPlaybackActive&&t.uuid&&this.activeSoundingNotes.has(t.uuid)||this.hasActiveInteraction&&t.uuid&&this.activeNoteAnimations.has(t.uuid)||!t.uuid&&this.ghostNoteAnimation&&this.ghostNoteAnimation.color===t.color&&this.isPlaybackActive)}shouldBeRunning(){const t=this.animations.size>0;return t?!!(this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null||t):!1}onNoteInteractionStart(t,e){this.shouldAnimateColor(e)&&(this.activeNoteAnimations.set(t,e),this.hasActiveInteraction=!0,b.debug(`${this.effectName}AnimationEffect`,`Started interaction animation for note ${t} (${e})`,null,"animation"),this.requestAnimationStateUpdate())}onNoteInteractionEnd(t){this.activeNoteAnimations.delete(t),this.hasActiveInteraction=this.activeNoteAnimations.size>0,b.debug(`${this.effectName}AnimationEffect`,`Ended interaction animation for note ${t}`,null,"animation"),this.requestAnimationStateUpdate()}onGhostNoteUpdated(t){this.shouldAnimateColor(t)?(this.ghostNoteAnimation={color:t,active:!0},b.debug(`${this.effectName}AnimationEffect`,`Ghost note animation updated for color ${t}`,null,"animation")):this.ghostNoteAnimation=null}onGhostNoteCleared(){this.ghostNoteAnimation=null,b.debug(`${this.effectName}AnimationEffect`,"Ghost note animation cleared",null,"animation")}onNoteAttack(t,e){this.shouldAnimateColor(e)&&(this.activeSoundingNotes.set(t,e),b.debug(`${this.effectName}AnimationEffect`,`Note attack: ${t} (${e}) added to active sounding notes`,null,"animation"),this.requestAnimationStateUpdate())}onNoteRelease(t,e){this.activeSoundingNotes.delete(t),b.debug(`${this.effectName}AnimationEffect`,`Note release: ${t} (${e}) removed from active sounding notes`,null,"animation"),this.requestAnimationStateUpdate()}onDialInteractionStart(t){this.shouldAnimateColor(t)&&(this.hasDialInteraction=!0,this.activeNoteAnimations.set("dial-preview",t),b.debug(`${this.effectName}AnimationEffect`,`Dial interaction started for ${t}`,null,"animation"),this.requestAnimationStateUpdate())}onDialInteractionEnd(t){this.hasDialInteraction=!1,this.activeNoteAnimations.delete("dial-preview"),b.debug(`${this.effectName}AnimationEffect`,`Dial interaction ended for ${t}`,null,"animation"),this.requestAnimationStateUpdate()}getActiveColors(){const t=new Set;for(const[,e]of this.activeSoundingNotes.entries())this.shouldAnimateColor(e)&&t.add(e);for(const[,e]of this.activeNoteAnimations.entries())this.shouldAnimateColor(e)&&t.add(e);return this.ghostNoteAnimation&&this.shouldAnimateColor(this.ghostNoteAnimation.color)&&t.add(this.ghostNoteAnimation.color),Array.from(t)}disposeBase(){this.animations.clear(),this.activeNoteAnimations.clear(),this.activeSoundingNotes.clear(),this.ghostNoteAnimation=null,b.info(`${this.effectName}AnimationEffect`,"Base disposed",null,"animation")}requestAnimationStateUpdate(){var t;(t=window.animationEffectsManager)==null||t.updateAnimationState()}}b.moduleLoaded("VibratoCanvasEffect");class EU extends xy{constructor(){super("Vibrato"),b.info("VibratoCanvasEffect","Initialized for canvas note positions",null,"animation")}init(){return this.initBase(),b.info("VibratoCanvasEffect","Ready for canvas animation",null,"animation"),!0}updateAnimationParameters(t,e){const{speed:i,span:A}=e;if(i===0||A===0)this.animations.delete(t),b.debug("VibratoCanvasEffect",`Disabled vibrato animation for ${t}`,null,"animation");else{const r=this.animations.get(t),a=i/100*16,l=A/100*.5,u={frequency:a,amplitude:l,phase:(r==null?void 0:r.phase)||0,lastUpdate:performance.now()};this.animations.set(t,u),b.debug("VibratoCanvasEffect",`Updated vibrato animation for ${t}`,{frequency:a,amplitude:l,preservedPhase:!!r},"animation")}}updateAnimationPhases(t){this.animations.forEach(e=>{const i=(t-e.lastUpdate)/1e3;e.phase+=e.frequency*i*2*Math.PI,e.lastUpdate=t,e.phase>4*Math.PI&&(e.phase-=4*Math.PI)})}getVibratoYOffset(t){if(!t)return 0;const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldVibratoBeRunning())return 0;const i=Math.sin(e.phase),A=-i*e.amplitude;return b.debug("VibratoCanvasEffect","Visual vibrato",{sine:i.toFixed(3),offset:A.toFixed(3),phase:e.phase.toFixed(3)},"effects"),A}shouldBeRunning(){return this.animations.size>0?this.isPlaybackActive||this.hasActiveInteraction||this.hasDialInteraction||this.ghostNoteAnimation!==null&&this.isPlaybackActive:!1}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.amplitude>0:!1}dispose(){this.disposeBase(),b.info("VibratoCanvasEffect","Disposed",null,"animation")}}b.moduleLoaded("TremoloWaveformEffect");class SU extends xy{constructor(){super("Tremolo"),b.info("TremoloWaveformEffect","Initialized for waveform/ADSR amplitude",null,"animation")}init(){return this.initBase(),b.info("TremoloWaveformEffect","Ready for waveform/ADSR animation",null,"animation"),!0}updateAnimationParameters(t,e){var r,a;const{speed:i,span:A}=e;if(i===0||A===0)this.animations.delete(t),b.debug("TremoloWaveformEffect",`Disabled tremolo animation for ${t}`,null,"animation");else{const l=this.animations.get(t),u=i/100*16,h=A/100,m=(a=(r=window.Tone)==null?void 0:r.now)==null?void 0:a.call(r),g=typeof m=="number"?m*1e3:performance.now(),w={frequency:u,span:h,phase:(l==null?void 0:l.phase)||0,lastUpdate:g};this.animations.set(t,w),b.debug("TremoloWaveformEffect",`Updated tremolo animation for ${t}`,{frequency:u,span:h,preservedPhase:!!l},"animation")}}updateAnimationPhases(t){var r,a,l,u;let e=0;const i=(a=(r=window.Tone)==null?void 0:r.now)==null?void 0:a.call(r),A=typeof i=="number"?i*1e3:t;if(this.animations.forEach((h,m)=>{const g=(A-h.lastUpdate)/1e3,w=h.phase;h.phase+=h.frequency*g*2*Math.PI,h.lastUpdate=A,e++,Math.abs(h.phase-w)<.001&&b.warn("TremoloWaveformEffect",`Phase not advancing for ${m}`,{deltaSeconds:Number(g.toFixed(4)),frequency:h.frequency},"animation"),h.phase>4*Math.PI&&(h.phase-=4*Math.PI)}),e>0&&Math.random()<.05){const h=(l=window.Tone)!=null&&l.now?"Tone.js":"performance";b.debug("TremoloWaveformEffect","Timing sample",{hasTone:!!window.Tone,hasToneNow:!!((u=window.Tone)!=null&&u.now),toneTime:A,currentTime:t,timingSource:h},"animation")}}getTremoloAmplitudeMultiplier(t){var E,x,T;const e=this.animations.get(t);if(!e||window.animationEffectsManager&&!window.animationEffectsManager.shouldTremoloBeRunning())return 1;const i=((E=window.staticWaveformVisualizer)==null?void 0:E.calculatedAmplitude)??1,A=Math.sin(e.phase),r=e.span,a=i,l=i*(1-r),u=(a+l)/2,h=(a-l)/2,g=(u+A*h)/i,w=(T=(x=window.Tone)==null?void 0:x.now)==null?void 0:T.call(x),y=(typeof w=="number"?w*1e3:performance.now())-e.lastUpdate;if(y>100&&e.span>0){const U=e.frequency*(y/1e3)*2*Math.PI;U>.1&&b.warn("TremoloWaveformEffect",`Phase stagnation detected for ${t}`,{phase:Number(e.phase.toFixed(3)),millisecondsSinceUpdate:Number(y.toFixed(1)),expectedAdvancement:Number(U.toFixed(3))},"animation")}return Math.max(0,Math.min(1,g))}getADSRTremoloAmplitudeMultiplier(t){return this.getTremoloAmplitudeMultiplier(t)}shouldAnimateColor(t){const e=this.animations.get(t);return e?e.frequency>0&&e.span>0:!1}dispose(){this.disposeBase(),b.info("TremoloWaveformEffect","Disposed",null,"animation")}}b.moduleLoaded("EnvelopeFillEffect");class FU{constructor(){Q(this,"activeFills");Q(this,"instanceId");this.activeFills=new Map,this.instanceId=Math.random().toString(36).substring(7),b.info("EnvelopeFillEffect","Initialized",null,"animation")}init(){d.on("noteAttack",t=>{var r,a;const e=t==null?void 0:t.noteId,i=t==null?void 0:t.color;if(!e||!i)return;const A=(r=d.state.timbres)==null?void 0:r[i];if(!A){b.warn("EnvelopeFillEffect","No timbre found for color",{color:i},"effects");return}this.activeFills.set(e,{fillLevel:0,color:i,startTime:Z.now(),adsr:A.adsr,phase:"attack"}),b.debug("EnvelopeFillEffect",`Started fill animation for note ${e}`,null,"animation"),(a=window.animationEffectsManager)==null||a.updateAnimationState()}),d.on("noteRelease",t=>{const e=t==null?void 0:t.noteId;if(!e)return;const i=this.activeFills.get(e);i?(i.phase="release",i.releaseStartTime=Z.now(),i.releaseStartLevel=i.fillLevel,b.debug("EnvelopeFillEffect",`Started release phase for note ${e}`,null,"animation")):b.warn("EnvelopeFillEffect","No fill data found for release",{noteId:e},"effects")}),d.on("playbackStopped",()=>{var t;this.activeFills.clear(),(t=window.animationEffectsManager)==null||t.updateAnimationState(),d.emit("animationUpdate",{type:"envelopeFill",activeColors:[],hasEnvelopeFills:!1})}),b.info("EnvelopeFillEffect","Event subscriptions established",null,"animation")}updateAnimationPhases(t){var i;const e=Z.now();for(const[A,r]of this.activeFills.entries()){const{adsr:a,startTime:l,phase:u,releaseStartTime:h,releaseStartLevel:m}=r,g=e-l;if(u==="attack"){const w=a.attack||.01;g<w?r.fillLevel=g/w:(r.phase="decay",r.decayStartTime=e)}else if(u==="decay"){const w=a.decay||.1,C=e-(r.decayStartTime??e),y=a.sustain??.5;if(C<w){const E=C/w;r.fillLevel=1-E*(1-y)}else r.phase="sustain",r.fillLevel=y}else if(u==="sustain"){const w=a.sustain??.5;r.fillLevel=w}else if(u==="release"){const w=a.release||.5,C=h?e-h:0,y=m??r.fillLevel;if(C<w){const E=C/w;r.fillLevel=y*(1-E)}else this.activeFills.delete(A),b.debug("EnvelopeFillEffect",`Completed fill animation for note ${A}`,null,"animation"),this.activeFills.size===0&&((i=window.animationEffectsManager)==null||i.updateAnimationState())}}}getFillLevel(t){if(!t.uuid)return 0;const e=this.activeFills.get(t.uuid);return e?e.fillLevel:0}shouldFillNote(t){return t.uuid?this.activeFills.has(t.uuid):!1}shouldBeRunning(){return this.activeFills.size>0}dispose(){this.activeFills.clear(),b.info("EnvelopeFillEffect","Disposed",null,"animation")}}b.moduleLoaded("AnimationEffectsManager");class TU{constructor(){Q(this,"vibratoEffect");Q(this,"tremoloEffect");Q(this,"envelopeFillEffect");Q(this,"isRunning");Q(this,"animationFrameId");Q(this,"lastTime");Q(this,"lastRenderTrigger");this.vibratoEffect=new EU,this.tremoloEffect=new SU,this.envelopeFillEffect=new FU,this.isRunning=!1,this.animationFrameId=null,this.lastTime=0,this.lastRenderTrigger=0,b.info("AnimationEffectsManager","Initialized with single animation loop",null,"animation")}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.envelopeFillEffect.init(),d.on("visualEffectChanged",t=>{const e=t==null?void 0:t.effectType;(e==="vibrato"||e==="tremolo")&&(setTimeout(()=>this.updateAnimationState(),0),e==="tremolo"&&setTimeout(()=>this.triggerTremoloAmplitudeUpdate(),0))}),b.info("AnimationEffectsManager","Event subscriptions established",null,"animation"),!0}animate(t){this.isRunning&&(this.lastTime=t,this.vibratoEffect.updateAnimationPhases(t),this.tremoloEffect.updateAnimationPhases(t),this.envelopeFillEffect.updateAnimationPhases(t),this.triggerVisualUpdates(t),this.animationFrameId=requestAnimationFrame(e=>this.animate(e)))}start(){this.isRunning||(this.isRunning=!0,this.lastTime=performance.now(),this.animationFrameId=requestAnimationFrame(t=>this.animate(t)),b.debug("AnimationEffectsManager","Single animation loop started",null,"animation"))}stop(){this.isRunning&&(this.isRunning=!1,this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.triggerFinalUpdates(),b.debug("AnimationEffectsManager","Animation loop stopped",null,"animation"))}shouldTremoloBeRunning(){if(!(this.tremoloEffect.animations.size>0))return!1;const e=this.tremoloEffect.activeSoundingNotes.size>0,i=this.tremoloEffect.hasDialInteraction;return e||i}shouldVibratoBeRunning(){return this.vibratoEffect.animations.size>0?this.vibratoEffect.isPlaybackActive||this.vibratoEffect.hasActiveInteraction||this.vibratoEffect.hasDialInteraction||this.vibratoEffect.ghostNoteAnimation!==null:!1}shouldEnvelopeFillBeRunning(){return this.envelopeFillEffect.shouldBeRunning()}updateAnimationState(){const t=this.shouldVibratoBeRunning(),e=this.shouldTremoloBeRunning(),i=this.shouldEnvelopeFillBeRunning(),A=t||e||i;A&&!this.isRunning?this.start():!A&&this.isRunning&&this.stop()}triggerVisualUpdates(t){if(!this.lastRenderTrigger||t-this.lastRenderTrigger>=16.67){this.lastRenderTrigger=t;const e=this.vibratoEffect.getActiveColors(),i=this.tremoloEffect.getActiveColors(),A=this.envelopeFillEffect.activeFills.size>0;(e.length>0||A)&&d.emit("animationUpdate",{type:e.length>0?"vibrato":"envelopeFill",activeColors:e,hasEnvelopeFills:A}),i.length>0&&d.emit("tremoloAmplitudeUpdate",{activeColors:i})}}triggerFinalUpdates(){const t=Array.from(this.vibratoEffect.animations.keys());t.length>0&&d.emit("animationUpdate",{type:"vibrato",activeColors:t});const e=Array.from(this.tremoloEffect.animations.keys());e.length>0&&d.emit("tremoloAmplitudeUpdate",{activeColors:e})}shouldAnimateNote(t){return this.vibratoEffect.shouldAnimateNote(t)}getVibratoYOffset(t){return this.vibratoEffect.getVibratoYOffset(t)}getTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getTremoloAmplitudeMultiplier(t)}getADSRTremoloAmplitudeMultiplier(t){return this.tremoloEffect.getADSRTremoloAmplitudeMultiplier(t)}getFillLevel(t){return this.envelopeFillEffect.getFillLevel(t)}shouldFillNote(t){return this.envelopeFillEffect.shouldFillNote(t)}triggerTremoloAmplitudeUpdate(){const t=this.tremoloEffect.getActiveColors();t.length>0&&d.emit("tremoloAmplitudeUpdate",{activeColors:t})}getAllActiveColors(){const t=this.vibratoEffect.getActiveColors(),e=this.tremoloEffect.getActiveColors();return[...new Set([...t,...e])]}dispose(){this.stop(),this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.envelopeFillEffect.dispose(),b.info("AnimationEffectsManager","Disposed",null,"animation")}}const Dw=new TU;b.moduleLoaded("VibratoAudioEffect");class IU{constructor(){Q(this,"currentSettings",new Map);b.info("VibratoAudioEffect","Initialized",null,"audio")}init(){return b.info("VibratoAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:i,span:A}=t;this.currentSettings.set(e,{speed:i,span:A}),b.debug("VibratoAudioEffect",`Updated parameters for ${e}`,{speed:i,span:A},"audio")}applyToVoice(t,e){if(!t||typeof t._setVibrato!="function")return;const i=this.currentSettings.get(e);if(!i){b.debug("VibratoAudioEffect",`No vibrato settings found for color ${e}`,null,"audio");return}try{t._setVibrato(i),t.vibratoApplied=!0,b.debug("VibratoAudioEffect",`Applied vibrato to voice for ${e}`,i,"audio")}catch(A){b.warn("VibratoAudioEffect",`Failed to apply vibrato to voice for ${e}`,A,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createVibratoSettings(t,e){if(t===0||e===0)return null;const i=t/100*16,A=e/100*50;return{frequency:i,depth:A}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),b.info("VibratoAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("TremoloAudioEffect");class QU{constructor(){Q(this,"currentSettings",new Map);b.info("TremoloAudioEffect","Initialized",null,"audio")}init(){return b.info("TremoloAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){const{speed:i,span:A}=t;this.currentSettings.set(e,{speed:i,span:A}),b.debug("TremoloAudioEffect",`Updated parameters for ${e}`,{speed:i,span:A},"audio")}applyToVoice(t,e){if(!t||typeof t._setTremolo!="function")return;const i=this.currentSettings.get(e);if(!i){b.debug("TremoloAudioEffect",`No tremolo settings found for color ${e}`,null,"audio");return}try{t._setTremolo(i),t.tremoloApplied=!0,b.debug("TremoloAudioEffect",`Applied tremolo to voice for ${e}`,i,"audio")}catch(A){b.warn("TremoloAudioEffect",`Failed to apply tremolo to voice for ${e}`,A,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{speed:0,span:0}}getEffectInstance(){return null}createTremoloSettings(t,e){if(t===0||e===0)return null;const i=t/100*16,A=e/100;return{frequency:i,depth:A}}disableForColor(t){this.updateParameters({speed:0,span:0},t)}dispose(){this.currentSettings.clear(),b.info("TremoloAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("ReverbAudioEffect");const MU=()=>window.synthEngine;class UU{constructor(){Q(this,"currentSettings",new Map);Q(this,"reverbInstances",new Map)}init(){return b.info("ReverbAudioEffect","Ready for audio processing",null,"audio"),!0}async updateParameters(t,e){var l,u;const{decay:i,roomSize:A,wet:r}=t;this.currentSettings.set(e,{decay:i,roomSize:A,wet:r}),b.debug("ReverbAudioEffect",`Updated parameters for ${e}`,{decay:i,roomSize:A,wet:r},"audio");let a=this.reverbInstances.get(e);a?this.updateReverbInstance(a,i,A,r):(i>0||A>0)&&(a=await this.createReverbInstance(i,A,r),a&&(this.reverbInstances.set(e,a),b.debug("ReverbAudioEffect",`Created new reverb instance for ${e}`,{decay:i,roomSize:A,wet:r},"audio"),(u=(l=MU())==null?void 0:l.updateSynthForColor)==null||u.call(l,e)))}async applyToVoice(t,e){var A,r,a;if(!t)return;const i=this.currentSettings.get(e);if(!(!i||i.decay===0&&i.roomSize===0))try{let l=this.reverbInstances.get(e);if(!l){if(l=await this.createReverbInstance(i.decay,i.roomSize,i.wet),!l)return;this.reverbInstances.set(e,l)}if(typeof t.isDisposed=="function"&&t.isDisposed())return;try{(A=t.connect)==null||A.call(t,l)}catch{(a=(r=t.output)==null?void 0:r.connect)==null||a.call(r,l)}b.debug("ReverbAudioEffect",`Applied reverb to voice for ${e}`,i,"audio")}catch(l){b.warn("ReverbAudioEffect",`Failed to apply reverb to voice for ${e}`,l,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{decay:0,roomSize:0,wet:0}}getEffectInstance(t){return this.getCurrentSettings(t).wet>0?this.reverbInstances.get(t)??null:null}async createReverbInstance(t,e,i=10){if(t===0&&e===0)return null;const A=Math.max(.1,t/100*8),r=1+e/100*1.5,a=A*r,l=i/100,u=new Z.Reverb({decay:a,wet:l});return u._wetAmount=l,await u.ready,b.debug("ReverbAudioEffect","Created reverb instance",{decayTime:a,wetAmount:l,roomSize:e},"audio"),u}updateReverbInstance(t,e,i,A=10){const r=Math.max(.1,e/100*8),a=1+i/100*1.5,l=r*a,u=A/100;try{t.decay=l,t._crossFade&&(t._crossFade.fade.value=u),t._wetAmount=u,b.debug("ReverbAudioEffect","Updated reverb instance",{decayTime:l,wetAmount:u,roomSize:i},"audio")}catch(h){b.warn("ReverbAudioEffect","Failed to update reverb instance",h,"audio")}}createReverbSettings(t,e,i=25){if(t===0&&e===0)return null;const A=Math.max(.1,t/100*10),r=i/100;return{decay:A,roomSize:e/100,wet:r}}disableForColor(t){var i;this.updateParameters({decay:0,roomSize:0,wet:0},t);const e=this.reverbInstances.get(t);if(e)try{(i=e._crossFade)==null||i.dispose(),e.dispose()}finally{this.reverbInstances.delete(t)}}dispose(){this.reverbInstances.forEach((t,e)=>{var i;try{(i=t._crossFade)==null||i.dispose(),t.dispose()}catch(A){b.warn("ReverbAudioEffect",`Failed to dispose reverb for ${e}`,A,"audio")}}),this.currentSettings.clear(),this.reverbInstances.clear(),b.info("ReverbAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("DelayAudioEffect");const PU=()=>window.synthEngine;class DU{constructor(){Q(this,"currentSettings",new Map);Q(this,"delayInstances",new Map)}init(){return b.info("DelayAudioEffect","Ready for audio processing",null,"audio"),!0}updateParameters(t,e){var l,u;const{time:i,feedback:A,wet:r}=t;this.currentSettings.set(e,{time:i,feedback:A,wet:r}),b.debug("DelayAudioEffect",`Updated parameters for ${e}`,{time:i,feedback:A,wet:r},"audio");let a=this.delayInstances.get(e);a?this.updateDelayInstance(a,i,A,r):(i>0||A>0)&&(a=this.createDelayInstance(i,A,r),a&&(this.delayInstances.set(e,a),b.debug("DelayAudioEffect",`Created new delay instance for ${e}`,{time:i,feedback:A,wet:r},"audio"),(u=(l=PU())==null?void 0:l.updateSynthForColor)==null||u.call(l,e)))}applyToVoice(t,e){var A,r,a;if(!t)return;const i=this.currentSettings.get(e);if(!(!i||i.time===0&&i.feedback===0))try{let l=this.delayInstances.get(e);if(!l){if(l=this.createDelayInstance(i.time,i.feedback,i.wet),!l)return;this.delayInstances.set(e,l)}if(typeof t.isDisposed=="function"&&t.isDisposed())return;try{(A=t.connect)==null||A.call(t,l)}catch{(a=(r=t.output)==null?void 0:r.connect)==null||a.call(r,l)}b.debug("DelayAudioEffect",`Applied delay to voice for ${e}`,i,"audio")}catch(l){b.warn("DelayAudioEffect",`Failed to apply delay to voice for ${e}`,l,"audio")}}getCurrentSettings(t){return this.currentSettings.get(t)??{time:0,feedback:0,wet:0}}getEffectInstance(t){const e=this.getCurrentSettings(t);return e.time>0&&e.wet>0?this.delayInstances.get(t)??null:null}createDelayInstance(t,e,i=30){if(t===0&&e===0)return null;const A=Math.max(.01,t/100*.5),r=Math.min(.95,e/100),a=i/100,l=new Z.FeedbackDelay({delayTime:A,feedback:r,wet:a});return l._wetAmount=a,b.debug("DelayAudioEffect","Created delay instance",{delayTime:A,feedbackAmount:r,wetAmount:a},"audio"),l}updateDelayInstance(t,e,i,A=15){const r=Math.max(.01,e/100*.5),a=Math.min(.95,i/100),l=A/100;try{t.delayTime.value=r,t.feedback.value=a,t._crossFade&&(t._crossFade.fade.value=l),t._wetAmount=l,b.debug("DelayAudioEffect","Updated delay instance",{delayTime:r,feedbackAmount:a,wetAmount:l},"audio")}catch(u){b.warn("DelayAudioEffect","Failed to update delay instance",u,"audio")}}createDelaySettings(t,e,i=30){if(t===0&&e===0)return null;const A=Math.max(.01,t/100*.5),r=Math.min(.95,e/100),a=i/100;return{time:A,feedback:r,wet:a}}disableForColor(t){var i;this.updateParameters({time:0,feedback:0,wet:0},t);const e=this.delayInstances.get(t);if(e)try{(i=e._crossFade)==null||i.dispose(),e.dispose()}finally{this.delayInstances.delete(t)}}dispose(){this.delayInstances.forEach((t,e)=>{var i;try{(i=t._crossFade)==null||i.dispose(),t.dispose()}catch(A){b.warn("DelayAudioEffect",`Failed to dispose delay for ${e}`,A,"audio")}}),this.currentSettings.clear(),this.delayInstances.clear(),b.info("DelayAudioEffect","Disposed",null,"audio")}}b.moduleLoaded("AudioEffectsManager");const kU=()=>window.synthEngine;class LU{constructor(){Q(this,"vibratoEffect",new IU);Q(this,"tremoloEffect",new QU);Q(this,"reverbEffect",new UU);Q(this,"delayEffect",new DU)}init(){return this.vibratoEffect.init(),this.tremoloEffect.init(),this.reverbEffect.init(),this.delayEffect.init(),d.on("audioEffectChanged",t=>{if(!t)return;const{effectType:e,parameter:i,value:A,color:r,effectParams:a}=t;this.handleAudioEffectChange(e,i,A,r,a)}),b.info("AudioEffectsManager","Event subscriptions established",null,"audio"),!0}handleAudioEffectChange(t,e,i,A,r){switch(b.debug("AudioEffectsManager",`Processing audio effect: ${t}.${e} = ${i} for ${A}`,null,"audio"),t){case"vibrato":this.vibratoEffect.updateParameters(r,A);break;case"tremolo":this.tremoloEffect.updateParameters(r,A);break;case"reverb":this.reverbEffect.updateParameters(r,A);break;case"delay":this.delayEffect.updateParameters(r,A);break;default:b.debug("AudioEffectsManager",`Effect type ${t} not handled by audio system`,null,"audio")}}getEffectHandler(t){switch(t){case"vibrato":return this.vibratoEffect;case"tremolo":return this.tremoloEffect;case"reverb":return this.reverbEffect;case"delay":return this.delayEffect;default:return null}}applySynthEffects(t,e,i){var l,u;const A=this.reverbEffect.getEffectInstance(e),r=this.delayEffect.getEffectInstance(e);try{t.disconnect()}catch{}let a=t;if(A)try{A.disconnect(),a.connect(A),a=A}catch{}if(r)try{r.disconnect(),a.connect(r),a=r}catch{}try{a.connect(i);const h=(u=(l=kU())==null?void 0:l.getWaveformAnalyzer)==null?void 0:u.call(l,e);h&&t.connect(h)}catch{}}applyEffectsToVoice(t,e){this.vibratoEffect.applyToVoice(t,e),this.tremoloEffect.applyToVoice(t,e)}dispose(){this.vibratoEffect.dispose(),this.tremoloEffect.dispose(),this.reverbEffect.dispose(),this.delayEffect.dispose(),b.info("AudioEffectsManager","Disposed",null,"audio")}}const kw=new LU;b.moduleLoaded("EffectsCoordinator");let RU=class{constructor(){this.effectParameters=new Map,this.defaultEffects={vibrato:{speed:0,span:0},tremolo:{speed:0,span:0},reverb:{decay:0,roomSize:0},delay:{time:0,feedback:0}},b.info("EffectsCoordinator","Initialized as main coordinator",null,"effects")}init(){return Object.keys(d.state.timbres).forEach(t=>{this.initializeColorEffects(t)}),d.on("timbreCreated",({color:t})=>{this.initializeColorEffects(t)}),this.loadSavedValues(),b.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(t){if(!this.effectParameters.has(t)){const e={};Object.entries(this.defaultEffects).forEach(([A,r])=>{e[A]={...r}}),this.effectParameters.set(t,e);const i=d.state.timbres[t];i&&(i.vibrato&&(e.vibrato={...i.vibrato}),i.tremelo&&(e.tremolo={...i.tremelo})),b.debug("EffectsCoordinator",`Initialized effects for color ${t}`,e,"effects")}}updateParameter(t,e,i,A){if(!A){b.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:t,parameter:e,value:i},"effects");return}this.initializeColorEffects(A);const r=this.effectParameters.get(A);r[t]||(r[t]={...this.defaultEffects[t]}),r[t][e]=i,this.notifyAudioSystem(t,e,i,A,r[t]),this.notifyAnimationSystem(t,e,i,A,r[t]),this.updateTimbreState(t,r[t],A),this.saveValues()}notifyAudioSystem(t,e,i,A,r){d.emit("audioEffectChanged",{effectType:t,parameter:e,value:i,color:A,effectParams:{...r}}),b.debug("EffectsCoordinator",`Notified audio system: ${t}.${e} = ${i} for ${A}`,null,"effects")}notifyAnimationSystem(t,e,i,A,r){(t==="vibrato"||t==="tremolo")&&(d.emit("visualEffectChanged",{effectType:t,parameter:e,value:i,color:A,effectParams:{...r}}),b.debug("EffectsCoordinator",`Notified animation system: ${t}.${e} = ${i} for ${A}`,null,"effects"))}updateTimbreState(t,e,i){const A=d.state.timbres[i];if(!A)return;const a={vibrato:"vibrato",tremolo:"tremelo"}[t];a&&(A[a]||(A[a]={}),Object.assign(A[a],e),d.recordState())}getEffectParameters(t,e){const i=this.effectParameters.get(t);return i!=null&&i[e]?{...i[e]}:{...this.defaultEffects[e]}}getAllEffectParameters(t){const e=this.effectParameters.get(t);return e?{...e}:{...this.defaultEffects}}resetColorEffects(t){const e={};Object.entries(this.defaultEffects).forEach(([i,A])=>{e[i]={...A}}),this.effectParameters.set(t,e),Object.keys(e).forEach(i=>{Object.keys(e[i]).forEach(A=>{this.notifyAudioSystem(i,A,e[i][A],t,e[i]),this.notifyAnimationSystem(i,A,e[i][A],t,e[i])})}),b.info("EffectsCoordinator",`Reset all effects for color ${t}`,e,"effects")}saveValues(){const t={};Object.keys(d.state.timbres).forEach(e=>{const i=this.effectParameters.get(e);i&&(t[e]={vibrato:i.vibrato||{speed:0,span:0},tremelo:i.tremolo||{speed:0,span:0},reverb:i.reverb||{decay:0,roomSize:0},delay:i.delay||{time:0,feedback:0}})});try{localStorage.setItem("effectDialValues",JSON.stringify(t)),b.debug("EffectsCoordinator","Saved effect values to localStorage",null,"effects")}catch(e){b.warn("EffectsCoordinator","Failed to save effect values to localStorage",e,"effects")}}loadSavedValues(){try{const t=localStorage.getItem("effectDialValues");if(!t){b.debug("EffectsCoordinator","No saved effect values found",null,"effects");return}const e=JSON.parse(t);b.debug("EffectsCoordinator","Loading saved effect values",null,"effects"),Object.keys(e).forEach(i=>{const A=d.state.timbres[i],r=e[i];A&&r&&(r.vibrato&&Object.entries(r.vibrato).forEach(([a,l])=>{typeof l=="number"&&this.updateParameter("vibrato",a,l,i)}),r.tremelo&&Object.entries(r.tremelo).forEach(([a,l])=>{typeof l=="number"&&this.updateParameter("tremolo",a,l,i)}),r.reverb&&Object.entries(r.reverb).forEach(([a,l])=>{typeof l=="number"&&this.updateParameter("reverb",a,l,i)}),r.delay&&Object.entries(r.delay).forEach(([a,l])=>{typeof l=="number"&&this.updateParameter("delay",a,l,i)}))}),b.info("EffectsCoordinator","Applied saved effect values",null,"effects"),window.synthEngine&&Object.keys(e).forEach(i=>{const A=e[i];(A.reverb&&(A.reverb.decay>0||A.reverb.roomSize>0)||A.delay&&(A.delay.time>0||A.delay.feedback>0))&&(window.synthEngine.updateSynthForColor(i),b.debug("EffectsCoordinator",`Re-applied effects to synth for ${i}`,null,"effects"))})}catch(t){b.warn("EffectsCoordinator","Failed to load saved effect values",t,"effects")}}dispose(){this.effectParameters.clear(),b.info("EffectsCoordinator","Disposed",null,"effects")}};const Lw=new RU;b.moduleLoaded("EffectsCoordinator");class HU{constructor(){Q(this,"effectParameters",new Map);Q(this,"defaultEffects");this.defaultEffects={vibrato:{speed:0,span:0},tremolo:{speed:0,span:0},reverb:{roomSize:0,decay:0,wet:10},delay:{time:0,feedback:0,wet:15},phaser:{rate:50,depth:75,stages:6}},b.info("EffectsCoordinator","Initialized",null,"effects")}cloneDefault(t){return{...this.defaultEffects[t]||{}}}ensureEffect(t,e){return t[e]||(t[e]=this.cloneDefault(e)),t[e]}init(){return Object.keys(d.state.timbres).forEach(t=>{this.initializeColorEffects(t)}),d.on("timbreCreated",t=>{const{color:e}=t;this.initializeColorEffects(e)}),b.info("EffectsCoordinator","Event subscriptions established",null,"effects"),!0}initializeColorEffects(t){if(!this.effectParameters.has(t)){const e={};Object.entries(this.defaultEffects).forEach(([A,r])=>{e[A]={...r}}),this.effectParameters.set(t,e);const i=d.state.timbres[t];i&&(i.vibrato&&(e.vibrato={...i.vibrato}),i.tremelo&&(e.tremolo={...i.tremelo})),b.debug("EffectsCoordinator",`Initialized effects for color ${t}`,e,"effects")}}updateParameter(t,e,i,A){if(!A){b.warn("EffectsCoordinator","Cannot update parameter: no color provided",{effectType:t,parameter:e,value:i},"effects");return}this.initializeColorEffects(A);const r=this.effectParameters.get(A),a=this.ensureEffect(r,t);a[e],a[e]=i,this.notifyAudioEngine(t,e,i,A,a),this.notifyAnimationEngine(t,e,i,A,a),this.updateTimbreState(t,a,A)}notifyAudioEngine(t,e,i,A,r){d.emit("audioEffectChanged",{effectType:t,parameter:e,value:i,color:A,effectParams:{...r}}),b.debug("EffectsCoordinator",`Notified audio engine: ${t}.${e} = ${i} for ${A}`,null,"effects")}notifyAnimationEngine(t,e,i,A,r){(t==="vibrato"||t==="tremolo")&&(d.emit("visualEffectChanged",{effectType:t,parameter:e,value:i,color:A,effectParams:{...r}}),b.debug("EffectsCoordinator",`Notified animation engine: ${t}.${e} = ${i} for ${A}`,null,"effects"))}updateTimbreState(t,e,i){const A=d.state.timbres[i];if(!A)return;const a={vibrato:"vibrato",tremolo:"tremelo"}[t];if(a){const l=A;l[a]||(l[a]={}),Object.assign(l[a],e),d.recordState()}}getEffectParameters(t,e){const i=this.effectParameters.get(t),A=i==null?void 0:i[e];return A?{...A}:this.cloneDefault(e)}getAllEffectParameters(t){const e=this.effectParameters.get(t);if(!e){const A={};return Object.entries(this.defaultEffects).forEach(([r,a])=>{A[r]={...a}}),A}const i={};return Object.entries(e).forEach(([A,r])=>{i[A]=r?{...r}:void 0}),i}resetColorEffects(t){const e={};Object.entries(this.defaultEffects).forEach(([i,A])=>{e[i]={...A}}),this.effectParameters.set(t,e),Object.keys(e).forEach(i=>{const A=e[i];A&&Object.keys(A).forEach(r=>{const a=A[r];a!==void 0&&(this.notifyAudioEngine(i,r,a,t,A),this.notifyAnimationEngine(i,r,a,t,A))})}),b.info("EffectsCoordinator",`Reset all effects for color ${t}`,e,"effects")}dispose(){this.effectParameters.clear(),b.info("EffectsCoordinator","Disposed",null,"effects")}}const ir=new HU;class NU{constructor(){Q(this,"currentEffect",null);Q(this,"effectControlsContainer",null);Q(this,"effectButtons",[]);Q(this,"dials",[]);Q(this,"currentColor",null);Q(this,"isDialInteractionActive",!1);Q(this,"lastPreviewAt",{});Q(this,"previewThrottleMs",180);Q(this,"previewDurationMs",220);Q(this,"previewPitch","C4");Q(this,"holdPreviews",{});Q(this,"effectConfigs",{reverb:{name:"Reverb",controls:{decay:{label:"Time",min:0,max:100,default:0,unit:"%"},roomSize:{label:"Size",min:0,max:100,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:10,unit:"%"}}},delay:{name:"Delay",controls:{time:{label:"Time",min:0,max:100,default:0,unit:"%"},feedback:{label:"Echoes",min:0,max:95,default:0,unit:"%"},wet:{label:"Mix",min:0,max:100,default:15,unit:"%"}}},vibrato:{name:"Vibrato",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}},tremolo:{name:"Tremolo",controls:{speed:{label:"Speed",min:0,max:100,default:0,unit:"%"},span:{label:"Span",min:0,max:100,default:0,unit:"%"}}}})}init(){return b.initStart("Effects Controller"),this.effectControlsContainer=document.getElementById("effect-controls"),this.effectButtons=document.querySelectorAll(".effect-button[data-effect]"),!this.effectControlsContainer||this.effectButtons.length===0?(b.initFailed("Effects Controller","Required DOM elements not found"),!1):(this.setupEventListeners(),this.initializeSelectedColorTracking(),this.setupGlobalMouseUpHandler(),b.initSuccess("Effects Controller"),!0)}setupGlobalMouseUpHandler(){document.addEventListener("mouseup",()=>{this.isDialInteractionActive&&this.onDialInteractionEnd(this.currentEffect)})}setupEventListeners(){this.effectButtons.forEach(t=>{t.addEventListener("click",e=>{const A=e.currentTarget.dataset.effect;A&&this.selectEffect(A)})})}selectEffect(t){if(b.debug("Effects",`Selecting effect: ${t}`,null,"ui"),!this.effectConfigs[t]){b.info("Effects",`Effect ${t} not configured`,null,"ui");return}if(this.effectButtons.forEach(e=>{e.classList.remove("active"),e.dataset.effect===t&&e.classList.add("active")}),this.currentEffect===t){this.currentEffect=null,this.hideEffectControls();return}this.currentEffect=t,this.showEffectControls(t)}showEffectControls(t){const e=this.effectConfigs[t];if(!e||!this.effectControlsContainer){b.warn("Effects",`No configuration found for effect: ${t}`,null,"ui");return}this.clearControls(),this.effectControlsContainer.innerHTML='<div class="effect-controls"></div>';const i=this.effectControlsContainer.querySelector(".effect-controls");i&&Object.entries(e.controls).forEach(([A,r])=>{var y;const a=this.currentColor?(y=ir.getEffectParameters)==null?void 0:y.call(ir,this.currentColor,t):null,l=(a==null?void 0:a[A])??r.default??0,u=document.createElement("div");u.className="effect-slider-group",u.style.cssText="margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;",i.appendChild(u);const h=document.createElement("label");h.className="effect-slider-label",h.textContent=r.label,h.style.cssText="display: block; margin-bottom: 5px; font-weight: bold; color: #333;",u.appendChild(h);const m=document.createElement("input");m.type="range",m.min=`${r.min}`,m.max=`${r.max}`,m.value=`${l}`,m.className="effect-slider",m.style.cssText="width: 100%; margin: 5px 0;",u.appendChild(m);const g=document.createElement("div");g.className="effect-slider-value";const w=r.unit?`${Math.round(l)}${r.unit}`:Math.round(l);g.textContent=`${w}`,g.style.cssText="text-align: center; font-size: 12px; color: #666;",u.appendChild(g),this.dials.push({dial:{element:m,value:l,destroy:()=>{}},control:A,effectType:t,valueDisplay:g,controlConfig:r});const C=E=>{const x=E.target;if(!x)return;const T=parseFloat(x.value),U=r.unit?`${Math.round(T)}${r.unit}`:Math.round(T);g.textContent=`${U}`,b.debug("Effects",`${t} ${A}: ${T}`,null,"audio"),this.onEffectParameterChange(t,A,T)};m.addEventListener("input",C),m.addEventListener("change",C),m.addEventListener("mousedown",()=>this.onDialInteractionStart(t)),m.addEventListener("mouseup",()=>this.onDialInteractionEnd(t)),m.addEventListener("mouseleave",E=>{(E.buttons&1)===1&&this.onDialInteractionEnd(t)})})}hideEffectControls(){this.clearControls(),this.currentEffect=null}clearControls(){this.dials.forEach(t=>t.dial.destroy()),this.dials=[],this.effectControlsContainer&&(this.effectControlsContainer.innerHTML="")}onEffectParameterChange(t,e,i){var r;const A=this.currentColor||((r=d.state.selectedNote)==null?void 0:r.color);A&&ir.updateParameter(t,e,i,A)}updateEffect(t,e){var A;const i=this.currentColor||((A=d.state.selectedNote)==null?void 0:A.color);i&&Object.entries(e).forEach(([r,a])=>{typeof a=="number"&&ir.updateParameter(t,r,a,i)})}getEffectState(t){var i;const e=this.currentColor||((i=d.state.selectedNote)==null?void 0:i.color);return e?ir.getEffectParameters(e,t)||{}:{}}getActiveColor(){var t;return this.currentColor||((t=d.state.selectedNote)==null?void 0:t.color)||null}getPreviewNotes(){var a;const t=this.getActiveColor();if(!t)return null;const e=d.state.placedNotes.slice().reverse().find(l=>!l.isDrum),i=e?((a=d.state.fullRowData[e.row])==null?void 0:a.toneNote)||this.previewPitch:this.previewPitch,A=d.state.selectedTool;let r=[i];return A==="chord"&&Array.isArray(d.state.activeChordIntervals)&&(r=d.state.activeChordIntervals.map(u=>Lo(gr(i,u)))),{pitches:r,root:i,color:t}}previewEffect(t){var u;const e=this.getActiveColor();if(!e)return;const i=Date.now(),A=this.lastPreviewAt[t]??0;if(i-A<this.previewThrottleMs)return;this.lastPreviewAt[t]=i;const{isPlaying:r,isPaused:a}=d.state;if(r&&!a)return;const l=`effect-preview-${t}`;(u=d.emit)==null||u.call(d,"noteAttack",{noteId:l,color:e});try{Gt.triggerAttack(this.previewPitch,e),setTimeout(()=>Gt.triggerRelease(this.previewPitch,e),this.previewDurationMs)}catch(h){b.warn("Effects","Preview trigger failed",{err:h},"audio")}finally{setTimeout(()=>{var h;return(h=d.emit)==null?void 0:h.call(d,"noteRelease",{noteId:l,color:e})},this.previewDurationMs)}}startHoldPreview(t){var w;if(this.holdPreviews[t])return;const e=this.getPreviewNotes();if(!e)return;const{pitches:i,root:A,color:r}=e,a=`effect-hold-${t}-${Date.now()}`;this.holdPreviews[t]={pitches:i,root:A,color:r,noteId:a};const{isPlaying:l,isPaused:u}=d.state;if(l&&!u)return;i.forEach(C=>Gt.triggerAttack(C,r));const h=d.state.fullRowData.find(C=>C.toneNote===A),m=h?h.hex:"#888888",g=d.state.timbres[r];g&&((w=Cs.adsrComponent)==null||w.playheadManager.trigger(a,"attack",m,g.adsr)),d.emit("spacebarPlayback",{note:A,color:r,isPlaying:!0}),d.emit("noteAttack",{noteId:a,color:r})}stopHoldPreview(t){var m;const e=this.holdPreviews[t];if(!e)return;delete this.holdPreviews[t];const{pitches:i,root:A,color:r,noteId:a}=e;i.forEach(g=>Gt.triggerRelease(g,r));const l=d.state.fullRowData.find(g=>g.toneNote===A),u=l?l.hex:"#888888",h=d.state.timbres[r];h&&((m=Cs.adsrComponent)==null||m.playheadManager.trigger(a,"release",u,h.adsr)),d.emit("spacebarPlayback",{note:A,color:r,isPlaying:!1}),d.emit("noteRelease",{noteId:a,color:r})}initializeSelectedColorTracking(){var t;d.on("noteChanged",({newNote:e})=>{this.currentColor=e.color||null,this.currentColor&&this.currentEffect&&this.showEffectControls(this.currentEffect)}),this.currentColor=((t=d.state.selectedNote)==null?void 0:t.color)||null}onDialInteractionStart(t){this.isDialInteractionActive=!0,t&&b.debug("Effects",`Dial interaction start for ${t}`,null,"ui")}onDialInteractionEnd(t){this.isDialInteractionActive=!1,t&&b.debug("Effects",`Dial interaction end for ${t}`,null,"ui")}}const Mi=new NU;class OU{constructor(){Q(this,"listeners",new Map)}on(t,e){const i=this.listeners.get(t)||[];i.push(e),this.listeners.set(t,i)}off(t,e){const i=this.listeners.get(t);if(!i)return;const A=i.indexOf(e);A>=0&&i.splice(A,1)}emit(t,e){const i=this.listeners.get(t);i&&i.slice().forEach(A=>A(e))}}class Ey{constructor(t,e={}){Q(this,"_root");Q(this,"_svgWrapper");Q(this,"_bg");Q(this,"_gridFill");Q(this,"_gridPatternRect");Q(this,"_dial");Q(this,"_crosshairV");Q(this,"_crosshairH");Q(this,"_label");Q(this,"_em",new OU);Q(this,"_patternId");Q(this,"_size");Q(this,"_mode");Q(this,"_minX");Q(this,"_maxX");Q(this,"_stepX");Q(this,"_minY");Q(this,"_maxY");Q(this,"_stepY");Q(this,"_x");Q(this,"_y");Q(this,"_normX");Q(this,"_normY");Q(this,"_dragging",!1);Q(this,"colors",{accent:"#4a90e2",fill:"#1f1f1f",stroke:"#555",grid:"#333",text:"#fff"});if(this._root=typeof t=="string"?document.querySelector(t):t,!this._root)throw new Error("Position: target not found");const{size:i=[200,200],mode:A="absolute",x:r=.5,minX:a=0,maxX:l=1,stepX:u=0,y:h=.5,minY:m=0,maxY:g=1,stepY:w=0,colors:C}=e;this._patternId=`pos-grid-${Math.random().toString(36).slice(2,8)}`;try{const x=getComputedStyle(document.documentElement),T=x.getPropertyValue("--c-surface").trim(),U=x.getPropertyValue("--c-border").trim(),H=x.getPropertyValue("--c-border-strong").trim(),R=x.getPropertyValue("--c-text").trim();this.colors={...this.colors,fill:T||this.colors.fill,stroke:U||this.colors.stroke,grid:H||this.colors.grid,text:R||this.colors.text}}catch{}this._size=i,this._mode=A,this._minX=a,this._maxX=l,this._stepX=u,this._minY=m,this._maxY=g,this._stepY=w,C&&(this.colors={...this.colors,...C}),this._x=r,this._y=h,this._normX=0,this._normY=0,this._svgWrapper=document.createElementNS("http://www.w3.org/2000/svg","svg"),this._svgWrapper.setAttribute("width",`${i[0]}`),this._svgWrapper.setAttribute("height",`${i[1]}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${i[0]} ${i[1]}`),this._svgWrapper.style.touchAction="none";const y=document.createElementNS("http://www.w3.org/2000/svg","defs"),E=document.createElementNS("http://www.w3.org/2000/svg","pattern");E.setAttribute("id",this._patternId),E.setAttribute("width","20"),E.setAttribute("height","20"),E.setAttribute("patternUnits","userSpaceOnUse"),this._gridPatternRect=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridPatternRect.setAttribute("width","20"),this._gridPatternRect.setAttribute("height","20"),this._gridPatternRect.setAttribute("fill","none"),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridPatternRect.setAttribute("stroke-width","1"),E.appendChild(this._gridPatternRect),y.appendChild(E),this._svgWrapper.appendChild(y),this._bg=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._bg.setAttribute("x","0"),this._bg.setAttribute("y","0"),this._bg.setAttribute("width",`${i[0]}`),this._bg.setAttribute("height",`${i[1]}`),this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._svgWrapper.appendChild(this._bg),this._gridFill=document.createElementNS("http://www.w3.org/2000/svg","rect"),this._gridFill.setAttribute("x","0"),this._gridFill.setAttribute("y","0"),this._gridFill.setAttribute("width",`${i[0]}`),this._gridFill.setAttribute("height",`${i[1]}`),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._gridFill.setAttribute("opacity","0.2"),this._svgWrapper.appendChild(this._gridFill),this._crosshairV=document.createElementNS("http://www.w3.org/2000/svg","line"),this._crosshairH=document.createElementNS("http://www.w3.org/2000/svg","line"),[this._crosshairV,this._crosshairH].forEach(x=>{x.setAttribute("stroke",this.colors.grid),x.setAttribute("stroke-width","1"),x.setAttribute("opacity","0.6"),this._svgWrapper.appendChild(x)}),this._dial=document.createElementNS("http://www.w3.org/2000/svg","circle"),this._dial.setAttribute("r","10"),this._dial.setAttribute("fill",this.colors.accent),this._dial.setAttribute("stroke","#fff"),this._dial.setAttribute("stroke-width","2"),this._svgWrapper.appendChild(this._dial),this._label=document.createElementNS("http://www.w3.org/2000/svg","text"),this._label.setAttribute("x","8"),this._label.setAttribute("y",`${i[1]-8}`),this._label.setAttribute("fill",this.colors.text),this._label.setAttribute("font-size","12"),this._label.setAttribute("font-family","monospace"),this._label.textContent="",this._svgWrapper.appendChild(this._label),this._root.innerHTML="",this._root.appendChild(this._svgWrapper),this._bind(),this.setColors(),this._updateFromValues()}debugLog(...t){}on(t,e){return this._em.on(t,e),()=>this._em.off(t,e)}get value(){return{x:this._x,y:this._y}}get normalized(){return{x:this._normX,y:this._normY}}set x(t){this._x=this._clamp(this._maybeStep(t,this._minX,this._maxX,this._stepX),this._minX,this._maxX),this._updateFromValues()}get x(){return this._x}set y(t){this._y=this._clamp(this._maybeStep(t,this._minY,this._maxY,this._stepY),this._minY,this._maxY),this._updateFromValues()}get y(){return this._y}set minX(t){this._minX=t,this._updateFromValues()}set maxX(t){this._maxX=t,this._updateFromValues()}set minY(t){this._minY=t,this._updateFromValues()}set maxY(t){this._maxY=t,this._updateFromValues()}set stepX(t){this._stepX=t}set stepY(t){this._stepY=t}resize(t,e){this._size=[t,e],this._svgWrapper.setAttribute("width",`${t}`),this._svgWrapper.setAttribute("height",`${e}`),this._svgWrapper.setAttribute("viewBox",`0 0 ${t} ${e}`),this._label.setAttribute("y",`${e-8}`),this._updateFromValues()}destroy(){this._root.innerHTML=""}setColors(t={}){this.colors={...this.colors,...t},this._bg.setAttribute("fill",this.colors.fill),this._bg.setAttribute("stroke",this.colors.stroke),this._gridPatternRect.setAttribute("stroke",this.colors.grid),this._gridFill.setAttribute("fill",`url(#${this._patternId})`),this._crosshairV.setAttribute("stroke",this.colors.grid),this._crosshairH.setAttribute("stroke",this.colors.grid),this._dial.setAttribute("fill",this.colors.accent),this._label.setAttribute("fill",this.colors.text)}_updateFromValues(){if(this._x===this._minX&&this._y===this._minY)this.debugLog("At origin (off state)",{x:this._x,y:this._y});else{const i=this._x,A=this._y;if(this._x===this._minX){const r=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+r}if(this._y===this._minY){const r=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+r}this.debugLog("Adjusted single-axis zero",{from:{x:i,y:A},to:{x:this._x,y:this._y}})}const t=(this._x-this._minX)/(this._maxX-this._minX||1),e=(this._y-this._minY)/(this._maxY-this._minY||1);this._normX=this._clamp(t,0,1),this._normY=this._clamp(e,0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_updateGraphics(){const[t,e]=this._size,i=this._normX*t,A=this._mode==="absolute"?this._normY*e:(1-this._normY)*e;this._dial.setAttribute("cx",`${i}`),this._dial.setAttribute("cy",`${A}`),this._crosshairV.setAttribute("x1",`${i}`),this._crosshairV.setAttribute("x2",`${i}`),this._crosshairV.setAttribute("y1","0"),this._crosshairV.setAttribute("y2",`${e}`),this._crosshairH.setAttribute("x1","0"),this._crosshairH.setAttribute("x2",`${t}`),this._crosshairH.setAttribute("y1",`${A}`),this._crosshairH.setAttribute("y2",`${A}`),this._label.textContent=`x:${this._x.toFixed(3)} y:${this._y.toFixed(3)}`}_bind(){const t=A=>{var r,a;this._dragging=!0,this._handlePointer(A),(a=(r=A.target).setPointerCapture)==null||a.call(r,A.pointerId)},e=A=>{this._dragging&&this._handlePointer(A)},i=A=>{var r,a;this._dragging=!1,(a=(r=A.target).releasePointerCapture)==null||a.call(r,A.pointerId)};this._svgWrapper.addEventListener("pointerdown",t),this._svgWrapper.addEventListener("pointermove",e),this._svgWrapper.addEventListener("pointerup",i),this._svgWrapper.addEventListener("pointercancel",i)}_handlePointer(t){const e=this._svgWrapper.getBoundingClientRect(),i=(t.clientX-e.left)/e.width,A=(t.clientY-e.top)/e.height;this._normX=this._clamp(i,0,1);const r=this._mode==="relative"?1-A:A;if(this._normY=this._clamp(r,0,1),this._x=this._minX+this._normX*(this._maxX-this._minX),this._y=this._minY+this._normY*(this._maxY-this._minY),this.debugLog("Pointer move",{raw:{nx:i,ny:A},norm:{x:this._normX,y:this._normY},value:{x:this._x,y:this._y},mode:this._mode}),this._stepX>0){const a=this._maybeStep(this._x,this._minX,this._maxX,this._stepX);this._x=a}if(this._stepY>0){const a=this._maybeStep(this._y,this._minY,this._maxY,this._stepY);this._y=a}if(!(this._x===this._minX&&this._y===this._minY)){if(this._x===this._minX){const a=this._stepX>0?this._stepX:Math.max((this._maxX-this._minX)/100,.01);this._x=this._minX+a}if(this._y===this._minY){const a=this._stepY>0?this._stepY:Math.max((this._maxY-this._minY)/100,.01);this._y=this._minY+a}}this._normX=this._clamp((this._x-this._minX)/(this._maxX-this._minX||1),0,1),this._normY=this._clamp((this._y-this._minY)/(this._maxY-this._minY||1),0,1),this._updateGraphics(),this._em.emit("change",{x:this._x,y:this._y})}_maybeStep(t,e,i,A){if(A<=0)return t;const r=t-e,a=Math.round(r/A),l=e+a*A;return this._clamp(l,e,i)}_clamp(t,e,i){return Math.max(e,Math.min(i,t))}}Q(Ey,"DEBUG_POSITION",!1);b.moduleLoaded("PositionEffectsController");class VU{constructor(){Q(this,"positions",{});Q(this,"resizeObservers",[]);Q(this,"effectConfigs");Q(this,"isDragging",{});this.effectConfigs={reverb:{containerId:"reverb-position",xParam:"decay",yParam:"roomSize",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},delay:{containerId:"delay-position",xParam:"time",yParam:"feedback",xRange:{min:0,max:100,step:1},yRange:{min:0,max:95,step:1}},vibrato:{containerId:"vibrato-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}},tremolo:{containerId:"tremolo-position",xParam:"speed",yParam:"span",xRange:{min:0,max:100,step:1},yRange:{min:0,max:100,step:1}}},b.info("PositionEffectsController","Initialized",null,"ui")}init(){return b.initStart("Position Effects Controller"),Object.entries(this.effectConfigs).forEach(([t,e])=>{this.createPositionComponent(t,e)}),this.initializeColorTracking(),b.initSuccess("Position Effects Controller"),!0}createPositionComponent(t,e){const i=document.getElementById(e.containerId);if(!i){b.warn("PositionEffectsController",`Container not found for ${t}`,{containerId:e.containerId},"ui");return}try{const[A,r]=this.getPositionComponentSize(i),a=new Ey(i,{size:[A,r],mode:"relative",x:e.xRange.min,minX:e.xRange.min,maxX:e.xRange.max,stepX:e.xRange.step,y:e.yRange.min,minY:e.yRange.min,maxY:e.yRange.max,stepY:e.yRange.step});this.positions[t]=a,this.observePositionResize(i,a,A,r),a.on("change",({x:h,y:m})=>{this.onPositionChange(t,e.xParam,h,e.yParam,m)});const l=()=>{this.isDragging[t]=!0,this.onDialInteractionStart(t),Mi.startHoldPreview(t)},u=()=>{this.isDragging[t]&&(this.isDragging[t]=!1,this.onDialInteractionEnd(t),Mi.stopHoldPreview(t))};i.addEventListener("pointerdown",l),["pointerup","pointerleave","pointercancel"].forEach(h=>{i.addEventListener(h,u)}),this.loadInitialValues(t,e,a),b.debug("PositionEffectsController",`Created Position component for ${t}`,null,"ui")}catch(A){b.error("PositionEffectsController",`Failed to create Position component for ${t}`,A,"ui")}}getPositionComponentSize(t){const i=t.getBoundingClientRect();let A=(i==null?void 0:i.width)||t.clientWidth||t.offsetWidth||120,r=(i==null?void 0:i.height)||t.clientHeight||t.offsetHeight||A;return(!A||A<10)&&(A=120),(!r||r<10)&&(r=A),[Math.round(A),Math.round(r)]}observePositionResize(t,e,i,A){if(typeof ResizeObserver>"u")return;const r={currentWidth:Math.round(i)||0,currentHeight:Math.round(A)||0},a=new ResizeObserver(l=>{for(const u of l){const{width:h,height:m}=u.contentRect,g=Math.round(h),w=Math.round(m||h);!g||!w||g===r.currentWidth&&w===r.currentHeight||(r.currentWidth=g,r.currentHeight=w,e.resize(g,w))}});a.observe(t),this.resizeObservers.push(a)}onPositionChange(t,e,i,A,r){Mi.updateEffect(t,{[e]:i,[A]:r})}onDialInteractionStart(t){const e=Mi.getActiveColor();b.debug("PositionEffectsController",`Interaction start for ${t}`,null,"ui"),d.emit("effectDialInteractionStart",{effectType:t,color:e})}onDialInteractionEnd(t){const e=Mi.getActiveColor();b.debug("PositionEffectsController",`Interaction end for ${t}`,null,"ui"),d.emit("effectDialInteractionEnd",{effectType:t,color:e})}loadInitialValues(t,e,i){const A=Mi.getEffectState(t)||{},r=typeof A[e.xParam]=="number"?A[e.xParam]:e.xRange.min,a=typeof A[e.yParam]=="number"?A[e.yParam]:e.yRange.min;i.x=r,i.y=a}initializeColorTracking(){var t;d.on("noteChanged",({newNote:e})=>{e.color&&this.applyColorPalette(e.color)}),(t=d.state.selectedNote)!=null&&t.color&&this.applyColorPalette(d.state.selectedNote.color)}applyColorPalette(t){const e=d.state.colorPalette[t]||{primary:t,light:t},i=(a,l)=>{const u=C=>Math.max(0,Math.min(255,C)),h=a.replace("#",""),m=u(parseInt(h.slice(0,2),16)+l),g=u(parseInt(h.slice(2,4),16)+l),w=u(parseInt(h.slice(4,6),16)+l);return`#${m.toString(16).padStart(2,"0")}${g.toString(16).padStart(2,"0")}${w.toString(16).padStart(2,"0")}`},A=e.primary,r=e.light||i(A,80);Object.values(this.positions).forEach(a=>{a.setColors({accent:e.primary,fill:r,stroke:"#c3c9d0",grid:"#d7dce4",text:"#3c4048"})})}}const Rw=new VU;function WU(){fU(),SQ(),vU(),b.initStart("Static Waveform Visualizer"),xU()?b.initSuccess("Static Waveform Visualizer"):b.initFailed("Static Waveform Visualizer"),b.initStart("Effects Managers"),Dw.init(),kw.init(),Lw.init(),Mi.init(),Rw.init();const s=window;s.effectsCoordinator=Lw,s.animationEffectsManager=Dw,s.audioEffectsManager=kw,s.effectsController=Mi,s.positionEffectsController=Rw,b.initSuccess("Effects Managers")}function KU({kind:s,cx:t,cy:e,stroke:i="currentColor",strokeWidth:A=4,scale:r=1}){const a=20*r,l=60*r,u=document.createElementNS("http://www.w3.org/2000/svg","ellipse");return u.setAttribute("cx",`${t}`),u.setAttribute("cy",`${e}`),u.setAttribute("fill","none"),u.setAttribute("stroke",i),u.setAttribute("stroke-width",`${A}`),u.setAttribute("stroke-linecap","round"),s==="circleWide"?(u.setAttribute("rx",`${a*2}`),u.setAttribute("ry",`${l}`)):(u.setAttribute("rx",`${a}`),u.setAttribute("ry",`${l}`)),u}function GU(s,t=48,e=48){const i=document.createElementNS("http://www.w3.org/2000/svg","svg"),A=s.span==="quarter",r=A?200:100;i.setAttribute("viewBox",`0 0 ${r} 100`),i.setAttribute("width",`${t}`),i.setAttribute("height",`${e}`),i.setAttribute("aria-label",s.label),i.style.color="#000000";const a=50,l=s.span==="eighth"?"ovalWide":"circleWide";let u;return A?u=[33.33,100,166.67]:u=[16.67,50,83.33],s.hits.forEach(h=>{const m=KU({kind:l,cx:u[h]??0,cy:a,stroke:"currentColor",strokeWidth:3,scale:.8});i.appendChild(m)}),i}const Zc={selectedTripletId:1,init(){this.render(),this.bindEvents(),b.info("TripletsToolbar","Triplets toolbar initialized",null,"triplets")},render(){const s=document.getElementById("triplets-toolbar-container");if(!s){b.warn("TripletsToolbar","Container not found",null,"triplets");return}s.innerHTML="";const t=Wl.filter(A=>A.span==="eighth"),e=Wl.filter(A=>A.span==="quarter"),i=document.createElement("div");if(i.className="triplets-main-container",t.length>0){const A=document.createElement("div");A.className="triplets-row triplets-eighth-row",t.forEach(r=>{const a=this.createTripletButton(r);A.appendChild(a)}),i.appendChild(A)}if(e.length>0){const A=document.createElement("div");if(A.className="triplets-row triplets-quarter-row",e.slice(0,3).forEach(r=>{const a=this.createTripletButton(r);a.classList.add("triplet-button-wide"),A.appendChild(a)}),i.appendChild(A),e.length>3){const r=document.createElement("div");r.className="triplets-row triplets-quarter-row",e.slice(3).forEach(a=>{const l=this.createTripletButton(a);l.classList.add("triplet-button-wide"),r.appendChild(l)}),i.appendChild(r)}}s.appendChild(i),this.setInitialSelection(this.selectedTripletId)},createTripletButton(s){const t=document.createElement("button");t.className="triplet-button",t.dataset.tripletId=`${s.id}`,t.setAttribute("title",s.label||`Triplet ${s.id}`);const e=GU(s,40,40);return e.setAttribute("width","40"),e.setAttribute("height","40"),t.appendChild(e),t},bindEvents(){const s=document.getElementById("triplets-toolbar-container");s&&(s.addEventListener("click",t=>{var A;const e=(A=t.target)==null?void 0:A.closest(".triplet-button");if(!e)return;const i=parseInt(e.dataset.tripletId||"",10);Number.isNaN(i)||this.selectTriplet(i)}),d.on("toolChanged",({newTool:t})=>{t!=="triplet"&&this.clearSelection()}),d.on("stampToolSelected",()=>{this.clearSelection()}))},setInitialSelection(s){this.selectedTripletId=s;const t=document.getElementById("triplets-toolbar-container");t&&t.querySelectorAll(".triplet-button").forEach(e=>{const i=e;i.classList.toggle("active",parseInt(i.dataset.tripletId||"",10)===s)})},selectTriplet(s){this.selectedTripletId=s;const t=document.getElementById("triplets-toolbar-container");t&&t.querySelectorAll(".triplet-button").forEach(e=>{const i=e;i.classList.toggle("active",parseInt(i.dataset.tripletId||"",10)===s)}),d.setSelectedTool("triplet"),d.emit("tripletSelected",s),d.emit("tripletToolSelected")},clearSelection(){const s=document.getElementById("triplets-toolbar-container");s&&s.querySelectorAll(".triplet-button").forEach(t=>{t.classList.remove("active")})},getSelectedTripletStamp(){return Wl.find(t=>t.id===this.selectedTripletId)}};function qU(){var s,t;PE.init(),((s=As.initialize)==null?void 0:s.call(As))??((t=As.init)==null||t.call(As)),Jc.init(),Zc.init(),b.initSuccess("RhythmUi")}class zU{constructor(){Q(this,"gridsWrapper",null);Q(this,"pitchGridWrapper",null);Q(this,"drumGridWrapper",null);Q(this,"gridScrollbarProxy",null);Q(this,"isInitialized",!1);Q(this,"lastScrollTime",0);Q(this,"isSyncingFromProxy",!1);Q(this,"isSyncingFromWrapper",!1);Q(this,"handleWrapperScroll");Q(this,"handleProxyScroll")}init(){if(this.gridsWrapper=document.getElementById("grids-wrapper"),this.pitchGridWrapper=document.getElementById("pitch-grid-wrapper"),this.drumGridWrapper=document.getElementById("drum-grid-wrapper"),this.gridScrollbarProxy=document.getElementById("grid-scrollbar-proxy"),!this.gridsWrapper||!this.pitchGridWrapper||!this.drumGridWrapper){b.error("ScrollSyncService","Required elements not found for scroll sync",null,"scroll");return}this.setupScrollSynchronization(),this.isInitialized=!0,b.info("ScrollSyncService","Initialized with unified grids-wrapper structure",null,"scroll")}setupScrollSynchronization(){this.handleWrapperScroll=this.handleWrapperScrollInternal.bind(this),this.handleProxyScroll=this.handleProxyScrollInternal.bind(this),this.gridsWrapper.addEventListener("scroll",this.handleWrapperScroll,{passive:!0}),this.gridScrollbarProxy?this.gridScrollbarProxy.addEventListener("scroll",this.handleProxyScroll,{passive:!0}):b.warn("ScrollSyncService","Grid scrollbar proxy not found; falling back to native scrollbars.",null,"scroll")}handleWrapperScrollInternal(t){if(this.isSyncingFromProxy||!this.gridsWrapper)return;const e=Date.now();if(this.lastScrollTime=e,this.gridScrollbarProxy){const A=this.gridsWrapper.scrollLeft;Math.abs(this.gridScrollbarProxy.scrollLeft-A)>.5&&(this.isSyncingFromWrapper=!0,this.gridScrollbarProxy.scrollLeft=A,this.isSyncingFromWrapper=!1)}const i=t.target;b.debug("ScrollSyncService",`Unified scroll: ${(i==null?void 0:i.scrollLeft)??0}px`,null,"scroll")}handleProxyScrollInternal(){if(this.isSyncingFromWrapper||!this.gridScrollbarProxy)return;const t=this.gridScrollbarProxy.scrollLeft;this.gridsWrapper&&Math.abs(this.gridsWrapper.scrollLeft-t)>.5&&(this.isSyncingFromProxy=!0,this.gridsWrapper.scrollLeft=t,this.isSyncingFromProxy=!1)}syncScrollTo(t){!this.isInitialized||!this.gridsWrapper||(this.isSyncingFromProxy=!0,this.isSyncingFromWrapper=!0,this.gridsWrapper.scrollLeft=t,this.gridScrollbarProxy&&(this.gridScrollbarProxy.scrollLeft=t),this.isSyncingFromProxy=!1,this.isSyncingFromWrapper=!1)}}const $U=new zU;function Sc(s,t){return _t(s,t)}function Sy(s,t,e,i,A,r,a=1){const l=e+A/2,u=i+r/2,h=Math.min(A,r)*.4*a;if(s.beginPath(),t===0)s.moveTo(l,u-h),s.lineTo(l-h,u+h),s.lineTo(l+h,u+h),s.closePath();else if(t===1)s.moveTo(l,u-h),s.lineTo(l+h,u),s.lineTo(l,u+h),s.lineTo(l-h,u),s.closePath();else{for(let g=0;g<5;g++){const w=2*Math.PI/5*g-Math.PI/2,C=l+h*Math.cos(w),y=u+h*Math.sin(w);g===0?s.moveTo(C,y):s.lineTo(C,y)}s.closePath()}s.fill()}function XU(s,t){const{columnWidths:e,musicalColumnWidths:i,macrobeatGroupings:A,macrobeatBoundaryStyles:r,placedTonicSigns:a}=t,l=e.length,u=[];let h=2;for(let w=0;w<A.length;w++){for(;a.some(y=>y.columnIndex===h);)h+=2;const C=A[w]??0;h+=C,u.push(h)}const m=l-2,g=i||e.slice(2,-2);for(let w=0;w<=l;w++){let C;const y=w===2||w===m,E=Mv(w,a),x=a.some(D=>w===D.columnIndex+2),T=u.includes(w);if(!Uv(w,a))continue;if(y||E||x)C={lineWidth:2,strokeStyle:"#adb5bd",dash:[]};else if(T){const D=u.indexOf(w);if(D!==-1){const P=r[D];if(P==="anacrusis")continue;C={lineWidth:1,strokeStyle:"#adb5bd",dash:P==="solid"?[]:[5,5]};const G=w-2;Sc(G,t)}else continue}else continue;const H=w-2;if(H<0||H>g.length)continue;const R=Sc(H,t);s.beginPath(),s.moveTo(R,0),s.lineTo(R,_e(s.canvas)),s.lineWidth=C.lineWidth,s.strokeStyle=C.strokeStyle,s.setLineDash(C.dash),s.stroke()}s.setLineDash([])}function YU(s,t){const{placedNotes:e,columnWidths:i,cellWidth:A,cellHeight:r,placedTonicSigns:a}=t;s.clearRect(0,0,rs(s.canvas),_e(s.canvas));const l=Math.max(na,ia*r),u=i.length,h=["H","M","L"];for(let m=0;m<4;m++){const g=m*l;s.beginPath(),s.moveTo(0,g),s.lineTo(rs(s.canvas),g),s.strokeStyle="#ced4da",s.lineWidth=1,s.stroke()}XU(s,t);for(let m=2;m<u-2;m++){if(a.some(y=>y.columnIndex===m))continue;const g=m-2,w=Sc(g,t);let C;t.modulationMarkers&&t.modulationMarkers.length>0?C=Sc(g+1,t)-w:C=(i[m]??0)*A;for(let y=0;y<3;y++){const E=y*l,x=h[y],T=e.find(U=>U.isDrum&&(typeof U.drumTrack=="number"?String(U.drumTrack):U.drumTrack)===x&&U.startColumnIndex===g);if(T){s.fillStyle=T.color;const U=fA.getAnimationScale(g,x);Sy(s,y,w,E,C,l,U)}else s.fillStyle="#ced4da",s.beginPath(),s.arc(w+C/2,E+l/2,2,0,Math.PI*2),s.fill()}}t.modulationMarkers&&t.modulationMarkers.length>0&&Vv(s,t)}const un={getColumnIndex(s){const{cellWidth:t,modulationMarkers:e,cellHeight:i,musicalColumnWidths:A}=d.state,r=d.state.columnWidths||[];if(t===0)return 0;const a={...d.state,modulationMarkers:e,cellWidth:t,columnWidths:r,musicalColumnWidths:A,baseMicrobeatPx:d.state.baseMicrobeatPx||t},l=Ev(s,a),u=Math.floor(l);return u},getPitchRowIndex(s){const t=Ot.getViewportInfo();if(!(t!=null&&t.halfUnit)||t.halfUnit===0)return-1;const e=Math.floor((s+t.halfUnit*.5)/t.halfUnit);return t.startRank+e},getDrumRowIndex(s){const t=Math.max(na,ia*d.state.cellHeight);return t===0?-1:Math.floor(s/t)}},pp=["H","M","L"],jU="canvas-container",JU="drum-grid-wrapper",Fy="eraser-tool-button",ZU="drum-grid",tP="drum-hover-canvas";let Hs=null,Fc=!1,ma=!1,sc=1,ri=null,Hw=0;const eP=500,Tc=s=>{const t={modulationMarkers:d.state.modulationMarkers||[],columnWidths:d.state.columnWidths,musicalColumnWidths:d.state.musicalColumnWidths||d.state.columnWidths.slice(2,-2),cellWidth:d.state.cellWidth,cellHeight:d.state.cellHeight,baseMicrobeatPx:d.state.baseMicrobeatPx||d.state.cellWidth||40};return _t(s,t)},Ty=s=>{if(d.state.modulationMarkers&&d.state.modulationMarkers.length>0){const A=Tc(s);return Tc(s+1)-A}return((d.state.musicalColumnWidths||d.state.columnWidths.slice(2,-2))[s]??1)*d.state.cellWidth},Ic=()=>Math.max(na,ia*d.state.cellHeight),mp=()=>{Hs&&Hs.clearRect(0,0,rs(Hs.canvas),_e(Hs.canvas))};function Tf(s,t,e){if(!Hs)return;const i=Tc(s),A=t*Ic(),r=Ty(s);Hs.fillStyle=e,Hs.fillRect(i,A,r,Ic())}function sP(s,t){var u;if(!Hs)return;const e=Tc(s),i=t*Ic(),A=Ty(s),r=pp[t];if(!r)return;const a=fA.getAnimationScale(s,r),l=((u=d.state.selectedTool)==null?void 0:u.color)??"#212529";Hs.globalAlpha=.4,Hs.fillStyle=l,Sy(Hs,t,e,i,A,Ic(),a),Hs.globalAlpha=1}const Iy=()=>{const s=document.getElementById(jU);return(s==null?void 0:s.scrollLeft)??0};function nP(s){var h,m;const t=s.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),i=s.clientX-e.left,A=s.clientY-e.top,r=un.getColumnIndex(i+Iy()),a=un.getDrumRowIndex(A),l=((h=d.state.musicalColumnWidths)==null?void 0:h.length)||d.state.columnWidths.length-4;if(!Hs||r<0||r>=l||a<0||a>2){gp();return}mp();const u=pp[a];u&&(Fc?((m=d.eraseDrumNoteAt)!=null&&m.call(d,r,u,!1)&&(ma=!0),Tf(r,a,"rgba(220, 53, 69, 0.3)")):(Tf(r,a,"rgba(74, 144, 226, 0.2)"),sP(r,a)))}function gp(){mp()}function iP(s){var h,m,g,w,C;s.preventDefault();const t=s.currentTarget;if(!t)return;const e=t.getBoundingClientRect(),i=s.clientX-e.left,A=s.clientY-e.top,r=un.getColumnIndex(i+Iy()),a=((h=d.state.musicalColumnWidths)==null?void 0:h.length)||d.state.columnWidths.length-4;if(r<0||r>=a)return;const l=un.getDrumRowIndex(A);if(l<0||l>2)return;const u=pp[l];if(u){if(s.button===2){Fc=!0,ma=!1,(m=document.getElementById(Fy))==null||m.classList.add("erasing-active"),(g=d.eraseDrumNoteAt)!=null&&g.call(d,r,u,!1)&&(ma=!0),mp(),Tf(r,l,"rgba(220, 53, 69, 0.3)");return}if(s.button===0){const y=((w=d.state.selectedTool)==null?void 0:w.color)??"#000000",E={isDrum:!0,drumTrack:u,startColumnIndex:r,endColumnIndex:r,color:y,shape:u==="H"?"triangle":u==="M"?"square":"pentagon"};(C=d.toggleDrumNote)==null||C.call(d,E);const x=window.transportService,T=x==null?void 0:x.drumPlayers;T!=null&&T.player&&(T.player(u).start(),fA.triggerNotePop(r,u))}}}function AP(){var s,t;Fc&&(ma&&((s=d.recordState)==null||s.call(d)),Fc=!1,ma=!1,(t=document.getElementById(Fy))==null||t.classList.remove("erasing-active")),gp()}function rP(){const s=document.getElementById(JU),t=s==null?void 0:s.querySelector(".drum-grid-left-cell");if(!s||!t)return;let e=t.querySelector(".drum-left-content");if(!e){e=document.createElement("div"),e.className="drum-left-content";const a=document.createElement("button");a.className="drum-volume-button",a.type="button",a.setAttribute("aria-label","Drum volume"),a.innerHTML=`
      <span class="drum-volume-icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false" role="img">
          <path d="M3 10v4h4l5 5V5L7 10H3z" fill="currentColor"></path>
          <path d="M16 8.82v6.36c1.18-.85 2-2.22 2-3.64s-.82-2.79-2-3.64z" fill="currentColor"></path>
          <path d="M16 4v2c2.9 1.06 5 3.86 5 7s-2.1 5.94-5 7v2c4.01-1.15 7-4.97 7-9s-2.99-7.85-7-9z" fill="currentColor"></path>
        </svg>
      </span>
    `,a.style.gridRow="1 / span 3",a.style.gridColumn="1",["H","M","L"].forEach((l,u)=>{const h=document.createElement("span");h.className="drum-track-label",h.textContent=l,h.style.gridColumn="2",h.style.gridRow=`${u+1}`,e.appendChild(h)}),e.appendChild(a),t.appendChild(e)}const i=document.createElement("div");i.className="drum-volume-control",ri=document.createElement("input"),ri.type="range",ri.min="0",ri.max="100",ri.value="100",ri.className="drum-volume-slider",ri.style.cssText="width: 80px; margin: 0;",ri.addEventListener("input",a=>{const l=a.currentTarget;sc=Number(l.value)/100;const u=window.drumVolumeNode;if(u!=null&&u.volume){const h=sc===0?-60:20*Math.log10(sc);u.volume.value=h;const m=window.transportService,g=m==null?void 0:m.drumPlayers,w=Date.now();g!=null&&g.player&&w-Hw>=eP&&(g.player("M").start("+0.1"),Hw=w)}}),i.appendChild(ri),t.appendChild(i);const A=()=>{if(!i)return;i.classList.contains("visible")?i.classList.remove("visible"):i.classList.add("visible")},r=t.querySelector(".drum-volume-button");r&&r.addEventListener("click",a=>{a.stopPropagation(),A()}),document.addEventListener("click",a=>{const l=a.target,u=l==null?void 0:l.closest(".drum-volume-control"),h=l==null?void 0:l.closest(".drum-volume-button");!u&&!h&&i.classList.remove("visible")})}function oP(){return sc}window.getDrumVolume=oP;function aP(){const s=document.getElementById(ZU),t=document.getElementById(tP);!s||!t||(Hs=t.getContext("2d"),s.addEventListener("mousedown",iP),s.addEventListener("mousemove",nP),s.addEventListener("mouseleave",gp),s.addEventListener("contextmenu",e=>e.preventDefault()),window.addEventListener("mouseup",AP),rP())}function Nw(){const s=oa.getDrumContext();if(!(s!=null&&s.canvas))return;const t={placedNotes:ux(d.state),placedTonicSigns:hi(d.state),columnWidths:d.state.columnWidths,musicalColumnWidths:d.state.musicalColumnWidths,cellWidth:d.state.cellWidth,cellHeight:d.state.cellHeight,macrobeatGroupings:d.state.macrobeatGroupings,macrobeatBoundaryStyles:d.state.macrobeatBoundaryStyles,modulationMarkers:d.state.modulationMarkers,baseMicrobeatPx:d.state.cellWidth};YU(s,t)}const Qs={animationFrameId:null,render(){Nw(),fA.hasActiveAnimations()?Qs.animationFrameId||Qs.startAnimationLoop():Qs.stopAnimationLoop()},startAnimationLoop(){if(Qs.animationFrameId)return;const s=()=>{fA.cleanupAnimations(),Nw(),fA.hasActiveAnimations()?Qs.animationFrameId=requestAnimationFrame(s):Qs.animationFrameId=null};Qs.animationFrameId=requestAnimationFrame(s)},stopAnimationLoop(){Qs.animationFrameId&&(cancelAnimationFrame(Qs.animationFrameId),Qs.animationFrameId=null)}};window.drumGridRenderer=Qs;let Dl=!1,Ui="C4",Qc=null;function nc(){var s;return{pitches:[],rootNote:Ui,color:((s=d.state.selectedNote)==null?void 0:s.color)||"#000000"}}let On=nc();function lP(s){const t=d.state.fullRowData[s.row];return t?t.toneNote:"C4"}function Ow(){const s=d.state.placedNotes.slice().reverse().find(t=>!t.isDrum);Ui=s?lP(s):"C4"}function Vw(s){const{activeChordIntervals:t}=d.state;return!s||!(t!=null&&t.length)?[]:t.map(e=>{const i=gr(s,e);return Lo(i)})}function cP(){Ow(),d.on("notesChanged",Ow),document.addEventListener("keydown",s=>{var l,u;if(s.code!=="Space"||Dl)return;const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase(),i=t.contentEditable==="true";if(["input","textarea"].includes(e)||i)return;s.preventDefault(),Dl=!0;const A=(l=d.state.selectedNote)==null?void 0:l.color;let r,a=[];if(Qc&&A){const h=d.state.fullRowData[Qc.row];r=h?h.toneNote:Ui,d.state.selectedTool==="chord"?a=Vw(r):a=[r]}else A&&Ui&&(r=Ui,d.state.selectedTool==="chord"?a=Vw(Ui):a=[Ui]);if(a.length>0&&A&&r){On={pitches:[...a],rootNote:r,color:A},a.forEach(y=>{Gt.triggerAttack(y,A)});const h=d.state.fullRowData.find(y=>y.toneNote===r),m=h?h.hex:"#888888",g=d.state.timbres[A];if(!g)return;const w=g.adsr;(u=Cs.adsrComponent)==null||u.playheadManager.trigger("spacebar","attack",m,w),d.emit("spacebarPlayback",{note:r,color:A,isPlaying:!0});const C=`spacebar-${Date.now()}`;d.emit("noteAttack",{noteId:C,color:A}),On.noteId=C}}),document.addEventListener("keyup",s=>{var i;if(s.code!=="Space"||!Dl)return;s.preventDefault(),Dl=!1;const t=On.pitches;if(!Array.isArray(t)||t.length===0){On=nc();return}const e=On.color;if(e){t.forEach(h=>{Gt.triggerRelease(h,e)});const A=On.rootNote??Ui,r=d.state.fullRowData.find(h=>h.toneNote===A),a=r?r.hex:"#888888",l=d.state.timbres[e];if(!l){On=nc();return}const u=l.adsr;(i=Cs.adsrComponent)==null||i.playheadManager.trigger("spacebar","release",a,u),d.emit("spacebarPlayback",{note:A,color:e,isPlaying:!1}),On.noteId&&d.emit("noteRelease",{noteId:On.noteId,color:e})}On=nc()})}function Qy(s,t){var i;Qc={col:s,row:t};const e=(i=d.state.selectedNote)==null?void 0:i.color;e&&d.emit("ghostNoteUpdated",{color:e})}function My(){Qc=null,d.emit("ghostNoteCleared")}function uP(s,t,e,i){var m,g;const A=typeof e.stampId=="string"?Number(e.stampId):e.stampId,r=Rc(A);if(!r)return null;const a=_t(e.startColumn,i),l=i.cellWidth*2,u=i.cellHeight,h=[.125,.375,.625,.875].map(w=>a+w*l);for(const w of r.diamonds){const C=`diamond_${w}`,y=((m=e.shapeOffsets)==null?void 0:m[C])||0,E=e.row+y,x=qt(E,i),T=h[w];if(T===void 0)continue;const U=Math.sqrt(Math.pow(s-T,2)+Math.pow(t-x,2)),H=Math.min(l*.2,u*1);if(U<H)return{type:"diamond",slot:w??0,shapeKey:C,cx:T,cy:x,placement:e}}for(const w of r.ovals){const C=`oval_${w}`,y=((g=e.shapeOffsets)==null?void 0:g[C])||0,E=e.row+y,x=qt(E,i),T=w===0?a+.25*l:a+.75*l,U=Math.sqrt(Math.pow(s-T,2)+Math.pow(t-x,2)),H=Math.min(l*.25,u*1);if(U<H)return{type:"oval",slot:w,shapeKey:C,cx:T,cy:x,placement:e}}return null}function Uy(s,t,e,i){for(const A of e){const r=uP(s,t,A,i);if(r)return r}return null}function hP(s,t,e,i){var m;const A=typeof e.stampId=="string"?Number(e.stampId):e.stampId,r=Hc(A);if(!r)return null;const a=e.startCellIndex*2,l=_t(a,i),u=i.cellWidth*2*e.span,h=i.cellHeight;for(const g of r.hits){const w=`triplet_${g}`,C=((m=e.shapeOffsets)==null?void 0:m[w])||0,y=e.row+C,E=qt(y,i),x=Nv[g];if(x===void 0)continue;const T=l+u*x/100,U=Math.sqrt(Math.pow(s-T,2)+Math.pow(t-E,2)),H=Math.min(u*.15,h*1);if(U<H)return{type:"triplet",slot:g,shapeKey:w,cx:T,cy:E,placement:e}}return null}function Py(s,t,e,i){for(const A of e){const r=hP(s,t,A,i);if(r)return r}return null}let Zt,ga=!1,Ht=null,Ve=[],je=[];const fr=new Set;let wa=!1,Mc=!1,ic=null,Ni=null,pA=[],Zs=!1,En=null,Wn=null,va=!1,Kn=null,Ba=!1,If=null;const dP=275,fP=.25;let Ac=null,Le=null,Ki=!1;const pP=40,mP=20;let Ww=0,Kw=0;const Dy="#4a90e2";function gP(s,t=1){const e=s.startsWith("#")?s.slice(1):s;if(e.length!==6)return s;const i=parseInt(e.slice(0,2),16),A=parseInt(e.slice(2,4),16),r=parseInt(e.slice(4,6),16);return`rgba(${i}, ${A}, ${r}, ${t})`}function ky(s=.2){var e;const t=((e=d.state.selectedNote)==null?void 0:e.color)||Dy;return gP(t,s)}function Gw(){var s;return((s=d.state.selectedNote)==null?void 0:s.color)||Dy}const wP=20;let qw=0;function or(s,t={}){qw>=wP||(qw+=1)}function Ly(){return!!be.currentTool}function Ke(s){const t=d.state.fullRowData[s];return t?t.toneNote:null}function tu(s,t){var a;const e=(d.state.selectedTool==="note"||d.state.selectedTool==="chord")&&((a=d.state.selectedNote)==null?void 0:a.shape)==="circle",A=(d.state.musicalColumnWidths||[]).length,r=e?A-1:A;return s<0||s>=r?!1:Ke(t)!==null}function kl(s=!1){const t=performance.now(),e=s?mP:pP;return t-(s?Kw:Ww)<e?!1:(s?Kw=t:Ww=t,!0)}function vP(s){const{macrobeatGroupings:t,macrobeatBoundaryStyles:e,musicalColumnWidths:i}=d.state,A=(i||[]).length;if(s<0||s>=A)return null;let r=-1;for(let h=0;h<t.length;h++){const{startColumn:m,endColumn:g}=Os(d.state,h);if(s>=m&&s<=g){r=h;break}}if(r===-1)return null;let a=0;for(let h=r-1;h>=0;h--)if(e[h]==="solid"){a=h+1;break}const l=a-1;return{drawColumn:Os(d.state,a).startColumn,preMacrobeatIndex:l}}function Ry(s){const{activeChordIntervals:t,isIntervalsInverted:e,chordPositionState:i}=d.state;if(!s||!t||t.length===0)return[];if(e&&t.length===2&&t[0]==="1P"){const a="-"+t[1],l=gr(s,a),u=Lo(l),h=u.includes("#")&&li(u).includes("b")?li(u):u;return[s,h]}const A=t.map(r=>{const a=gr(s,r),l=Lo(a);if(l.includes("#")){const u=li(l);if(u.includes("b"))return u}return l});if(t.length>=3&&i>0){const r=[...A];for(let w=0;w<i;w++){const C=r.shift(),y=gr(C,"8P");r.push(Lo(y))}const a=r[0],l=s,u=oA(a),h=oA(l);let m=0,g=u;for(;g>h;)g-=12,m-=12;for(;g+12<=h;)g+=12,m+=12;return r.map(w=>{const C=oA(w)+m;return j_(C)})}return A}function ta(s,t,e){var h;if(!Zt)return;const i={...d.state,zoomLevel:Ot.getViewportInfo().zoomLevel},A=_t(s,i),a=qt(t,d.state)-d.state.cellHeight/2,l=d.state.selectedTool;let u;if(d.state.modulationMarkers&&d.state.modulationMarkers.length>0?u=_t(s+1,i)-A:u=d.state.columnWidths[s]*d.state.cellWidth,l==="eraser"||wa)d.state.modulationMarkers&&d.state.modulationMarkers.length>0?u=_t(s+2,i)-A:u=d.state.cellWidth*2;else if(l==="note"&&((h=d.state.selectedNote)==null?void 0:h.shape)==="circle")d.state.modulationMarkers&&d.state.modulationMarkers.length>0?u=_t(s+2,i)-A:u=d.state.cellWidth*2;else if(l==="stamp")d.state.modulationMarkers&&d.state.modulationMarkers.length>0?u=_t(s+2,i)-A:u=d.state.cellWidth*2;else if(l==="triplet"){const m=Zc.getSelectedTripletStamp();if(m){const w=2*(m.span==="eighth"?1:2);d.state.modulationMarkers&&d.state.modulationMarkers.length>0?u=_t(s+w,i)-A:u=d.state.cellWidth*w}else u=d.state.cellWidth*2}else l==="tonicization"&&(d.state.modulationMarkers&&d.state.modulationMarkers.length>0?u=_t(s+2,i)-A:u=d.state.cellWidth*2);Zt.fillStyle=e,Zt.fillRect(A,a,u,d.state.cellHeight)}function Hy(s,t,e=!1){if(!Zt||!d.state.selectedNote)return;const i=d.state.selectedTool,{shape:A,color:r}=d.state.selectedNote;if(Zt.globalAlpha=e?.2:.4,i==="tonicization"){const a={row:t,columnIndex:s,tonicNumber:d.state.selectedToolTonicNumber},l={...d.state,zoomLevel:Ot.getViewportInfo().zoomLevel};Yf(Zt,l,a)}else if(i==="note"){const a=A==="circle"?s+1:s,l={row:t,startColumnIndex:s,endColumnIndex:a,color:r,shape:A,isDrum:!1},u={...d.state,zoomLevel:Ot.getViewportInfo().zoomLevel};A==="oval"?Xf(Zt,u,l,t):$f(Zt,u,l,t)}Zt.globalAlpha=1}function Ny(s,t){var u,h;if(d.state.selectedTool!=="note")return or("skipped - not in note tool",{}),!1;if(!zf(s,d.state))return or("blocked - column not playable",{}),!1;if(!d.state.selectedNote)return or("blocked - no selected note",{}),!1;const{shape:e,color:i}=d.state.selectedNote,A=e==="circle"?s+1:s,r={row:t,startColumnIndex:s,endColumnIndex:A,color:i,shape:e,isDrum:!1},a=d.addNote(r);if(!a)return or("store.addNote returned null",{}),!1;or("note placed",{shape:a.shape,uuid:a.uuid}),Ht=a,a.uuid&&d.emit("noteInteractionStart",{noteId:a.uuid,color:a.color}),ga=!0,En=t;const l=Ke(t);if(l){a.uuid&&(fr.add(a.uuid),d.emit("noteAttack",{noteId:a.uuid,color:a.color})),je=[l],Gt.triggerAttack(l,Ht.color);const m=((u=d.state.fullRowData[t])==null?void 0:u.hex)||"#888888";(h=Cs.adsrComponent)==null||h.playheadManager.trigger(Ht.uuid,"attack",m,d.state.timbres[Ht.color].adsr);const g=window.staticWaveformVisualizer;g&&(g.currentColor=Ht.color,g.generateWaveform(),g.startSingleNoteVisualization(Ht.color))}return!0}function BP(){if(d.state.selectedTool!=="note")return!1;const s=d.state.deviceProfile;if(s&&typeof s.isMobile=="boolean")return s.isMobile;if(typeof window<"u"&&typeof window.matchMedia=="function")try{return window.matchMedia("(pointer: coarse)").matches}catch{return!1}return!1}function Oy(s){var l;if(!If)return null;const t=If.getBoundingClientRect(),e=s.clientX-t.left,i=s.clientY-t.top,A=((l=document.getElementById("canvas-container"))==null?void 0:l.scrollLeft)||0,r=un.getColumnIndex(e+A),a=un.getPitchRowIndex(i);return{x:e,y:i,colIndex:r,rowIndex:a}}function Qf(s,t){if(!s)return null;for(let e=0;e<s.length;e++){const i=s.item(e);if(i&&i.identifier===t)return i}return null}function Vy(){!Zt||!Le||(Zt.clearRect(0,0,rs(Zt.canvas),_e(Zt.canvas)),ta(Le.colIndex,Le.rowIndex,ky(fP)),Hy(Le.colIndex,Le.rowIndex),Qy(Le.colIndex,Le.rowIndex))}function yP(){if(Le){if(!tu(Le.colIndex,Le.rowIndex)){ya({clearOverlay:!1});return}Ki=!0,Vy()}}function ya({clearOverlay:s=!1}={}){Ac&&(clearTimeout(Ac),Ac=null),s&&Ki&&Fr(),Le=null,Ki=!1}function CP(s){var i;if(!BP()||Le)return;const t=(i=s.changedTouches)==null?void 0:i[0];if(!t)return;const e=Oy(t);!e||!tu(e.colIndex,e.rowIndex)||(s.preventDefault(),Le={identifier:t.identifier,colIndex:e.colIndex,rowIndex:e.rowIndex},Ac=window.setTimeout(()=>{yP()},dP))}function bP(s){if(!Le)return;const t=Qf(s.changedTouches,Le.identifier)||Qf(s.touches,Le.identifier);if(!t)return;const e=Oy(t);if(!e){ya({clearOverlay:Ki});return}if(!tu(e.colIndex,e.rowIndex)){ya({clearOverlay:Ki});return}s.preventDefault(),Le.colIndex=e.colIndex,Le.rowIndex=e.rowIndex,Ki&&Vy()}function _P(s){if(!Le||!Qf(s.changedTouches,Le.identifier))return;s.preventDefault();const e=Ki,i=Le.colIndex,A=Le.rowIndex;if(ya(),!e||d.state.selectedTool!=="note")return;Ny(i,A)?Wy():Fr()}function xP(){ya({clearOverlay:Ki})}function EP(s){var l,u,h,m,g;if(Ly()){Fr();return}const t=s.target.getBoundingClientRect(),e=s.clientX-t.left,i=s.clientY-t.top,A=document.getElementById("canvas-container").scrollLeft,r=un.getColumnIndex(e+A),a=un.getPitchRowIndex(i);if(!tu(r,a)){d.state.selectedTool==="note"&&or("blocked - outside pitch grid",{});return}if(s.button===2){s.preventDefault(),wa=!0,Zs=!1,d.state.selectedTool!=="eraser"&&(ic=d.state.selectedTool,d.setSelectedTool("eraser")),(l=gA.get("eraserButton"))==null||l.classList.add("erasing-active"),d.eraseInPitchArea(r,a,2,!1)&&(Zs=!0),d.eraseTonicSignAt(r,!1)&&(Zs=!0);const w=r+2-1,C=a-1,y=a+1;d.eraseStampsInArea(r,w,C,y)&&(Zs=!0),d.eraseTripletsInArea(r,w,C,y)&&(Zs=!0);const E=s.target.getBoundingClientRect(),x=s.clientX-E.left,T=s.clientY-E.top;be.eraseAtPoint(x,T)&&(Zs=!0),Zt.clearRect(0,0,rs(Zt.canvas),_e(Zt.canvas)),ta(r,a,"rgba(220, 53, 69, 0.3)");return}if(s.button===0){const w=e+A;for(const E of d.state.modulationMarkers||[]);const C=d.state.placedNotes.find(E=>!E.isDrum&&E.row===a&&r>=E.startColumnIndex&&r<=E.endColumnIndex);if(C&&d.state.selectedTool==="note"){const E=As.getStampAtPosition(r,a),x=Ke(a);if(E&&x){const T=window.staticWaveformVisualizer;T&&(T.currentColor=C.color,T.generateWaveform(),T.startSingleNoteVisualization(C.color)),As.playRhythmPattern(E.stampId,x,C.color,C.shape,E),je=[x],Ht=C}else if(x){const T=window.staticWaveformVisualizer;T&&(T.currentColor=C.color,T.generateWaveform(),T.startSingleNoteVisualization(C.color)),Gt.triggerAttack(x,C.color);const U=((u=d.state.fullRowData[a])==null?void 0:u.hex)||"#888888";(h=Cs.adsrComponent)==null||h.playheadManager.trigger(C.uuid,"attack",U,d.state.timbres[C.color].adsr),je=[x],Ht=C}return}const y=d.state.selectedTool;if(y==="chord"){if(!zf(r,d.state))return;const E=Ke(a);if(!E)return;const x=Ry(E),{shape:T,color:U}=d.state.selectedNote;je=[...x],je.forEach(R=>{Gt.triggerAttack(R,U)});const H=((m=d.state.fullRowData[a])==null?void 0:m.hex)||"#888888";(g=Cs.adsrComponent)==null||g.playheadManager.trigger("chord_preview","attack",H,d.state.timbres[U].adsr),Ve=[],x.forEach(R=>{const D=d.state.fullRowData.findIndex(P=>P.toneNote===R);if(D!==-1){const P=T==="circle"?r+1:r,G={row:D,startColumnIndex:r,endColumnIndex:P,color:U,shape:T,isDrum:!1},Y=d.addNote(G);Y&&(Ve.push(Y),Y.uuid&&(fr.add(Y.uuid),d.emit("noteAttack",{noteId:Y.uuid,color:Y.color}),d.emit("noteInteractionStart",{noteId:Y.uuid,color:Y.color})))}}),ga=!0,En=a;return}if(y==="tonicization"){if(Ni&&pA.length>0){const E=pA.map(x=>({row:x,tonicNumber:d.state.selectedToolTonicNumber,preMacrobeatIndex:Ni.preMacrobeatIndex,columnIndex:Ni.drawColumn}));d.addTonicSignGroup(E),Ni=null,pA=[]}return}if(y==="eraser"){Mc=!0,d.eraseInPitchArea(r,a,2,!1);const E=r+2-1,x=a-1,T=a+1;GQ(r,E,x,T),XQ(r,E,x,T);return}if(y==="stamp"){const E=d.getAllStampPlacements(),x=e+A,T={...d.state},U=Uy(x,i,E,T);if(U){Wn={...U,startRow:d.getShapeRow(U.placement,U.shapeKey),startMouseY:i},va=!0;return}const H=As.getStampAtPosition(r,a);if(H){const D=Ke(a);if(D){const P=d.state.placedNotes.find(Y=>!Y.isDrum&&Y.row===a&&r>=Y.startColumnIndex&&r<=Y.endColumnIndex),G=P?P.shape:"oval";As.playRhythmPattern(H.stampId,D,H.color,G,H),je=[D]}return}const R=Jc.getSelectedStamp();if(R){const{color:D,shape:P}=d.state.selectedNote;KQ(R.id,r,a,D);const G=Ke(a);G&&(As.playRhythmPattern(R.id,G,D,P),je=[G]),d.recordState()}return}if(y==="triplet"){const E=d.getAllTripletPlacements(),x=e+A,T={...d.state},U=Py(x,i,E,T);if(U){Kn={...U,startRow:d.getTripletShapeRow(U.placement,U.shapeKey),startMouseY:i},Ba=!0;return}const H=Math.floor(r/2),R=As.getTripletAtPosition(H,a);if(R){const P=Ke(a);P&&(As.playTripletPattern(R.stampId,P,R.color,R),je=[P]);return}const D=Zc.getSelectedTripletStamp();if(D&&d.state.selectedNote){const P=zQ(D.id,H,a,d.state.selectedNote.color),G=Ke(a);G&&P&&(As.playTripletPattern(D.id,G,d.state.selectedNote.color,P),je=[G]),d.recordState()}return}if(y==="modulation"){const E=d.state.selectedModulationRatio;if(!E){b.warn("PitchGridInteractor","No modulation ratio selected before placement",null,"grid");return}const x=Ky(w);if(!x){b.warn("PitchGridInteractor","Modulation placement must be near a measure boundary",{clickX:w},"grid");return}b.debug("PitchGridInteractor","Placing modulation marker at boundary",{measureIndex:x.measureIndex,ratio:E,clickX:w,boundaryX:x.xPosition},"grid");const T=d.addModulationMarker(x.measureIndex,E,x.xPosition,null,x.macrobeatIndex);b.debug("PitchGridInteractor","Modulation marker placed",{markerId:T,measureIndex:x.measureIndex,ratio:E},"grid");return}y==="note"&&Ny(r,a)}}function SP(s){var w,C,y,E,x,T,U,H;if(Ly()){Fr();return}const t=s.target.getBoundingClientRect(),e=s.clientX-t.left,i=s.clientY-t.top,A=document.getElementById("canvas-container").scrollLeft,r=un.getColumnIndex(e+A),a=un.getPitchRowIndex(i);if(!Zt)return;if(Zt.clearRect(0,0,rs(Zt.canvas),_e(Zt.canvas)),va&&Wn){const R=un.getPitchRowIndex(i),D=R-Wn.placement.row;if(d.updateStampShapeOffset(Wn.placement.id,Wn.shapeKey,D),R!==Wn.startRow){const P=Ke(R);if(P){const G=Wn.placement.color||((w=d.state.selectedNote)==null?void 0:w.color);Gt.triggerAttack(P,G),setTimeout(()=>Gt.triggerRelease(P,G),100)}Wn.startRow=R}s.target.style.cursor="ns-resize";return}if(Ba&&Kn){const R=un.getPitchRowIndex(i),D=R-Kn.placement.row;if(d.updateTripletShapeOffset(Kn.placement.id,Kn.shapeKey,D),R!==Kn.startRow){const P=Ke(R);if(P){const G=Kn.placement.color||((C=d.state.selectedNote)==null?void 0:C.color);Gt.triggerAttack(P,G),setTimeout(()=>Gt.triggerRelease(P,G),100)}Kn.startRow=R}s.target.style.cursor="ns-resize";return}const l=d.state.selectedTool;if(l==="stamp"&&!va){const R=e+A,D=d.getAllStampPlacements(),P={...d.state};Uy(R,i,D,P)?s.target.style.cursor="ns-resize":s.target.style.cursor="default"}if(l==="triplet"&&!Ba){const R=e+A,D=d.getAllTripletPlacements(),P={...d.state};Py(R,i,D,P)?s.target.style.cursor="ns-resize":s.target.style.cursor="default"}const u=e+A;for(const R of d.state.modulationMarkers||[]);if(d.state.selectedTool==="modulation"){const R=Ky(u);R&&FP(Zt,R.xPosition,d.state.selectedModulationRatio)}s.target;const h=(d.state.selectedTool==="note"||d.state.selectedTool==="chord")&&((y=d.state.selectedNote)==null?void 0:y.shape)==="circle",m=((E=d.state.musicalColumnWidths)==null?void 0:E.length)||d.state.columnWidths.length-4,g=h?m-1:m;if(r<0||r>=g||Ke(a)===null){Ni=null,pA=[],My();return}if(Qy(r,a),ga&&(Ht||Ve.length>0)){const R=r,D=a;if(Ht){if(Ht.shape==="circle"){if(R!==Ht.endColumnIndex&&d.updateNoteTail(Ht,R),D!==En&&D!==Ht.row){const P=Ke(D);if(P){const G=Ke(Ht.row);G&&Gt.quickReleasePitches([G],Ht.color),d.updateNoteRow(Ht,D),kl()&&(Gt.triggerAttack(P,Ht.color),je=[P]);const Y=((x=d.state.fullRowData[D])==null?void 0:x.hex)||"#888888";(T=Cs.adsrComponent)==null||T.playheadManager.trigger(Ht.uuid,"attack",Y,d.state.timbres[Ht.color].adsr),En=D}}}else if(Ht.shape==="oval"){const P=r;if(P!==Ht.startColumnIndex&&d.updateNotePosition(Ht,P),D!==Ht.row){const G=Ke(D);if(G){const Y=Ke(Ht.row);Y&&Gt.quickReleasePitches([Y],Ht.color),d.updateNoteRow(Ht,D),kl()&&(Gt.triggerAttack(G,Ht.color),je=[G]);const W=((U=d.state.fullRowData[D])==null?void 0:U.hex)||"#888888";(H=Cs.adsrComponent)==null||H.playheadManager.trigger(Ht.uuid,"attack",W,d.state.timbres[Ht.color].adsr)}}}}else if(Ve.length>0){const P=Ve[0];if(P.shape==="circle"){const G=Ve.filter(Y=>R!==Y.endColumnIndex);if(G.length>0&&d.updateMultipleNoteTails(G,R),D!==En){const Y=D-En;Gt.quickReleasePitches(je,Ve[0].color);const W=Ve.map(Bt=>Bt.row+Y);if(W.every(Bt=>Ke(Bt)!==null)){d.updateMultipleNoteRows(Ve,W);const Bt=W.map(dt=>Ke(dt)).filter(dt=>dt);kl(!0)&&(Bt.forEach(dt=>{Gt.triggerAttack(dt,Ve[0].color)}),je=Bt),En=D}}}else if(P.shape==="oval"){const G=r,Y=Ve.filter(at=>G!==at.startColumnIndex);Y.length>0&&d.updateMultipleNotePositions(Y,G);const W=D-(En!==null?En:Ve[0].row);if(W!==0){Gt.quickReleasePitches(je,Ve[0].color);const at=Ve.map(dt=>dt.row+W);if(at.every(dt=>Ke(dt)!==null)){d.updateMultipleNoteRows(Ve,at);const dt=at.map(X=>Ke(X)).filter(X=>X);kl(!0)&&(dt.forEach(X=>{Gt.triggerAttack(X,Ve[0].color)}),je=dt),En=D}}}}return}if(d.state.selectedTool==="chord"){const R=Ke(a);if(R){const D=Ry(R),{shape:P,color:G}=d.state.selectedNote;Zt.globalAlpha=.4,D.forEach(Y=>{const W=d.state.fullRowData.findIndex(at=>at.toneNote===Y);if(W>-1){const at=P==="circle"?r+1:r,Bt={row:W,startColumnIndex:r,endColumnIndex:at,color:G,shape:P,isDrum:!1},dt={...d.state,zoomLevel:Ot.getViewportInfo().zoomLevel};P==="oval"?Xf(Zt,dt,Bt,W):$f(Zt,dt,Bt,W)}}),Zt.globalAlpha=1}return}if(wa){d.eraseInPitchArea(r,a,2,!1)&&(Zs=!0),d.eraseTonicSignAt(r,!1)&&(Zs=!0);const R=r+2-1,D=a-1,P=a+1;d.eraseStampsInArea(r,R,D,P)&&(Zs=!0),d.eraseTripletsInArea(r,R,D,P)&&(Zs=!0);const G=s.target.getBoundingClientRect(),Y=s.clientX-G.left,W=s.clientY-G.top;be.eraseAtPoint(Y,W)&&(Zs=!0),ta(r,a,"rgba(220, 53, 69, 0.3)");return}if(Mc){d.eraseInPitchArea(r,a,2,!1);const R=r+2-1,D=a-1,P=a+1;d.eraseStampsInArea(r,R,D,P),d.eraseTripletsInArea(r,R,D,P),ta(r,a,"rgba(220, 53, 69, 0.3)");return}if(d.state.selectedTool==="tonicization"){const R=vP(r);if(R){const D=Ke(a);if(D){const P=d.state.fullRowData.map((Y,W)=>({...Y,index:W})).filter(Y=>Y.toneNote&&Y.toneNote.replace(/\d+$/,"")===D.replace(/\d+$/,"")).map(Y=>Y.index);Ni=R,pA=P,Zt.globalAlpha=.5;const G={...d.state,zoomLevel:Ot.getViewportInfo().zoomLevel};P.forEach(Y=>{const W={row:Y,columnIndex:R.drawColumn,tonicNumber:d.state.selectedToolTonicNumber};Yf(Zt,G,W)}),Zt.globalAlpha=1}}else Ni=null,pA=[]}else{const R=d.state.selectedTool==="note"||d.state.selectedTool==="chord"?zf(r,d.state):!0,D=d.state.selectedTool==="eraser"?"rgba(220, 53, 69, 0.3)":R?ky(.2):"rgba(220, 53, 69, 0.15)";if(ta(r,a,D),d.state.selectedTool==="stamp"){const G=Jc.getSelectedStamp();if(G){const Y={cellWidth:d.state.cellWidth,cellHeight:d.state.cellHeight,columnWidths:d.state.columnWidths,musicalColumnWidths:d.state.musicalColumnWidths,modulationMarkers:d.state.modulationMarkers,baseMicrobeatPx:d.state.cellWidth,macrobeatGroupings:d.state.macrobeatGroupings,previewColor:Gw()};sE(Zt,r,a,G,Y)}}else if(d.state.selectedTool==="triplet"){const G=Zc.getSelectedTripletStamp();if(G){const Y=Math.floor(r/2),W={cellWidth:d.state.cellWidth,cellHeight:d.state.cellHeight,columnWidths:d.state.columnWidths,musicalColumnWidths:d.state.musicalColumnWidths,modulationMarkers:d.state.modulationMarkers,baseMicrobeatPx:d.state.cellWidth,macrobeatGroupings:d.state.macrobeatGroupings,previewColor:Gw()};oE(Zt,Y,a,G,W)}}else R&&Hy(r,a)}}function Fr(){Zt&&Zt.clearRect(0,0,rs(Zt.canvas),_e(Zt.canvas)),Ni=null,pA=[],My()}function Wy(){var s,t,e,i,A,r;if(va&&Wn){va=!1,Wn=null,d.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(Ba&&Kn){Ba=!1,Kn=null,d.recordState();const a=document.getElementById("notation-grid");a&&(a.style.cursor="default");return}if(je.length>0){As.stopCurrentPattern();const a=(Ht==null?void 0:Ht.color)||(Ve.length>0?(s=Ve[0])==null?void 0:s.color:null)||((t=d.state.selectedNote)==null?void 0:t.color)||null;a&&je.forEach(h=>{Gt.triggerRelease(h,a)});const l=!!Ht;if(l&&a){const h=((e=d.state.fullRowData[Ht.row])==null?void 0:e.hex)||"#888888";(i=Cs.adsrComponent)==null||i.playheadManager.trigger(Ht.uuid,"release",h,d.state.timbres[a].adsr)}else if(!l&&a){const h=je[0],m=d.state.fullRowData.find(g=>g.toneNote===h);if(m){const g=m.hex;(A=Cs.adsrComponent)==null||A.playheadManager.trigger("chord_preview","release",g,d.state.timbres[a].adsr)}}je=[];const u=window.staticWaveformVisualizer;u&&u.stopLiveVisualization()}Ht!=null&&Ht.uuid&&fr.has(Ht.uuid)&&(d.emit("noteRelease",{noteId:Ht.uuid,color:Ht.color}),fr.delete(Ht.uuid)),Ve.forEach(a=>{a!=null&&a.uuid&&fr.has(a.uuid)&&(d.emit("noteRelease",{noteId:a.uuid,color:a.color}),fr.delete(a.uuid))}),ga&&d.recordState(),ga=!1,En=null,Ht!=null&&Ht.uuid&&d.emit("noteInteractionEnd",{noteId:Ht.uuid}),Ve.forEach(a=>{a.uuid&&d.emit("noteInteractionEnd",{noteId:a.uuid})}),Ht=null,Ve=[],Mc&&(d.recordState(),Mc=!1),wa&&(Zs&&d.recordState(),wa=!1,Zs=!1,ic&&(d.setSelectedTool(ic),ic=null),(r=gA.get("eraserButton"))==null||r.classList.remove("erasing-active")),Fr()}function Ky(s){const{macrobeatBoundaryStyles:t}=d.state,e=100,i=[],A=d.state.modulationMarkers&&d.state.modulationMarkers.length>0;b.debug("PitchGridInteractor","Boundary calculation modulation state",{hasModulation:A},"grid");for(let u=0;u<t.length;u++)if(t[u]==="solid"){const h=Os(d.state,u);if(h){const m=h.endColumn+1,g=_t(m,{...d.state,modulationMarkers:d.state.modulationMarkers||[],cellWidth:d.state.cellWidth,columnWidths:d.state.columnWidths,musicalColumnWidths:d.state.musicalColumnWidths||d.state.columnWidths.slice(2,-2),baseMicrobeatPx:d.state.cellWidth});b.debug("PitchGridInteractor","Computed measure boundary",{boundaryIndex:u,endColumn:h.endColumn,calculatedX:g,method:"canvas-space"},"grid"),i.push({measureIndex:u+1,xPosition:g,macrobeatIndex:u})}}const r=_t(0,{...d.state,modulationMarkers:d.state.modulationMarkers||[],cellWidth:d.state.cellWidth,columnWidths:d.state.columnWidths,musicalColumnWidths:d.state.musicalColumnWidths||d.state.columnWidths.slice(2,-2),baseMicrobeatPx:d.state.cellWidth});b.debug("PitchGridInteractor","Start boundary position",{startBoundaryX:r,method:"canvas-space"},"grid"),i.unshift({measureIndex:0,xPosition:r,macrobeatIndex:-1}),b.debug("PitchGridInteractor","Available measure boundaries",{boundaries:i},"grid"),b.debug("PitchGridInteractor","Modulation click context",{clickX:s,tolerance:e},"grid");let a=null,l=1/0;return i.forEach(u=>{const h=Math.abs(s-u.xPosition);b.debug("PitchGridInteractor","Boundary distance check",{boundaryX:u.xPosition,distance:h},"grid"),h<=e&&h<l&&(l=h,a=u)}),a?b.debug("PitchGridInteractor","Found closest boundary",{boundary:a,distance:l},"grid"):b.debug("PitchGridInteractor","No boundary found within tolerance",{tolerance:e},"grid"),a}function FP(s,t,e){if(!e)return;const i=bv(e),A=Cv(e);s.save();const r=3,a=2,l=_e(s.canvas);s.strokeStyle=i,s.lineWidth=a,s.globalAlpha=.7,s.setLineDash([]);for(let u=-1;u<=1;u++){const h=t+u*r;s.beginPath(),s.moveTo(h,0),s.lineTo(h,l),s.stroke()}s.globalAlpha=.8,s.font="12px Arial, sans-serif",s.textAlign="center",s.textBaseline="top",s.fillStyle=i,s.fillText(`Preview: ${A}`,t,10),s.restore()}function TP(){const s=document.getElementById("notation-grid"),t=document.getElementById("hover-canvas");if(!s||!t){b.error("PitchGridInteractor","Could not find required canvas elements.",{hasPitchCanvas:!!s,hasHoverCanvas:!!t},"grid");return}Zt=t.getContext("2d"),If=s,s.addEventListener("mousedown",EP),s.addEventListener("mousemove",SP),s.addEventListener("mouseleave",Fr),s.addEventListener("contextmenu",e=>e.preventDefault()),s.addEventListener("touchstart",CP,{passive:!1}),s.addEventListener("touchmove",bP,{passive:!1}),s.addEventListener("touchend",_P,{passive:!1}),s.addEventListener("touchcancel",xP,{passive:!1}),window.addEventListener("mouseup",Wy)}const IP={init(){TP(),aP(),document.addEventListener("canvasResized",()=>{this.renderPitchGrid(),this.renderDrumGrid()}),d.on("animationUpdate",s=>{s.type==="vibrato"&&s.activeColors&&s.activeColors.length>0?this.renderPitchGrid():s.type==="envelopeFill"||s.hasEnvelopeFills?this.renderPitchGrid():s.type==="combined"&&s.vibratoColors&&s.vibratoColors.length>0&&this.renderPitchGrid()}),b.debug("GridManager","Initialized pitch and drum grid interactions",null,"grid")},renderPitchGrid:la.render,renderDrumGrid:Qs.render};function QP(){const s=Ot.init();return oa.setContexts(s),$U.init(),IP.init(),s}const Mf=["#ef8aab","#f48e7d","#e89955","#cdaa42","#a4ba57","#6ec482","#2dc8b1","#16c3da","#58b8f6","#8fa9ff","#ba9bf2","#db8fd4"];function MP(s){if(s===0||!s)return"#888888";const t=(Math.round(s)%12+12)%12;return Mf[t]??"#888888"}function UP(s){if(s===0||!s)return cA("#888888");const t=Math.floor(s),e=s-t;if(e<0||e>=1)return cA(MP(s));const i=(t%12+12)%12,A=(i+1)%12,r=cA(Mf[i]??"#888888"),a=cA(Mf[A]??"#888888");return PP(r,a,e)}function cA(s){const t=parseInt(s.slice(1),16);return[t>>16&255,t>>8&255,t&255]}function PP(s,t,e){const[i,A,r]=s,[a,l,u]=t;return[Math.round(i+e*(a-i)),Math.round(A+e*(l-A)),Math.round(r+e*(u-r))]}function rc(s,t,e){return s===0||!s?cA("#888888"):t==="shapenote"?cA(e||"#4A90E2"):UP(s)}class DP{constructor(){Q(this,"canvas",null);Q(this,"ctx",null);Q(this,"animationFrameId",null);Q(this,"lastValidPitch",null);Q(this,"lastValidPitchTime",0);Q(this,"fadeOutDurationMs",100);Q(this,"isFading",!1)}initialize(){this.canvas=document.getElementById("playhead-canvas"),this.canvas&&(this.ctx=this.canvas.getContext("2d"),d.on("micPaintStateChanged",t=>this.handlePaintStateChange(t)),d.on("pitchDetected",t=>this.handlePitchDetection(t)),d.on("playbackStateChanged",()=>{d.state.paint.isMicPaintActive}))}handlePaintStateChange(t){const e=document.getElementById("hover-canvas");e&&(e.style.display=t?"none":"block"),t?this.startRendering():this.stopRendering()}handlePitchDetection(t){d.state.paint.isMicPaintActive&&d.state.isPlaying&&!d.state.isPaused&&this.addPaintAtPlayhead(t)}startRendering(){this.animationFrameId||this.render()}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null),this.ctx&&this.ctx.clearRect(0,0,rs(this.canvas),_e(this.canvas))}render(){const t=this.ctx;if(!d.state.paint.isMicPaintActive||!t){this.animationFrameId=null;return}t.clearRect(0,0,rs(this.canvas),_e(this.canvas)),d.state.isPlaying&&!d.state.isPaused?this.renderMovingPlayhead():this.renderStationaryPlayhead(),this.animationFrameId=requestAnimationFrame(()=>this.render())}renderStationaryPlayhead(){var m,g,w;const t=this.ctx;if(!t)return;const{detectedPitch:e}=d.state.paint,i=performance.now();t.clearRect(0,0,rs(this.canvas),_e(this.canvas));const A=this.midiToY(e.midi),r=A!==null,a={...d.state,modulationMarkers:d.state.modulationMarkers||[],cellWidth:d.state.cellWidth,columnWidths:d.state.columnWidths,musicalColumnWidths:d.state.musicalColumnWidths||d.state.columnWidths.slice(2,-2),baseMicrobeatPx:d.state.cellWidth},l=_t(0,a),u=(((m=a.musicalColumnWidths)==null?void 0:m.length)||0)-1,h=u>=0?_t(u+1,a):l;if(r){this.lastValidPitch=e,this.lastValidPitchTime=i,this.isFading=!1;const{colorMode:C}=d.state.paint.paintSettings,y=(g=d.state.selectedNote)==null?void 0:g.color,E=rc(e.midi,C,y),x=`rgb(${E[0]}, ${E[1]}, ${E[2]})`;t.strokeStyle=x,t.globalAlpha=Math.min(e.clarity*1.2,1),t.lineWidth=4,t.shadowColor=x,t.shadowBlur=6,t.beginPath(),t.moveTo(l,A),t.lineTo(h,A),t.stroke(),t.shadowBlur=0,t.globalAlpha=1}else if(this.lastValidPitch&&i-this.lastValidPitchTime<this.fadeOutDurationMs){this.isFading=!0;const C=(i-this.lastValidPitchTime)/this.fadeOutDurationMs,y=this.easeOutCubic(1-C),E=this.midiToY(this.lastValidPitch.midi);if(E!==null){const{colorMode:x}=d.state.paint.paintSettings,T=(w=d.state.selectedNote)==null?void 0:w.color,U=rc(this.lastValidPitch.midi,x,T),H=`rgb(${U[0]}, ${U[1]}, ${U[2]})`;t.strokeStyle=H,t.globalAlpha=y*Math.min(this.lastValidPitch.clarity*1.2,1),t.lineWidth=4,t.shadowColor=H,t.shadowBlur=6*y,t.beginPath(),t.moveTo(l,E),t.lineTo(h,E),t.stroke(),t.shadowBlur=0,t.globalAlpha=1}}else this.isFading=!1,this.lastValidPitch=null}easeOutCubic(t){return 1-Math.pow(1-t,3)}renderMovingPlayhead(){var r;const t=this.ctx;if(!t)return;const e=this.calculateXFromTime(Z.Transport.seconds);if(e===null)return;t.strokeStyle="#FF6B35",t.lineWidth=3,t.shadowColor="#FF6B35",t.shadowBlur=6,t.beginPath(),t.moveTo(e,0),t.lineTo(e,_e(this.canvas)),t.stroke(),t.shadowBlur=0;const{detectedPitch:i}=d.state.paint,A=this.midiToY(i.midi);if(A!==null){const{colorMode:a}=d.state.paint.paintSettings,l=(r=d.state.selectedNote)==null?void 0:r.color,u=rc(i.midi,a,l),h=`rgb(${u[0]}, ${u[1]}, ${u[2]})`;t.fillStyle=h,t.strokeStyle="white",t.lineWidth=2,t.shadowColor=h,t.shadowBlur=4,t.beginPath(),t.arc(e,A,8,0,2*Math.PI),t.fill(),t.stroke(),t.shadowBlur=0}}addPaintAtPlayhead(t){if(t.midi===0)return;const e=Z.Transport.seconds;wp.addPaintPoint(e,t.midi)}calculateXFromTime(t){const e=gf();if(!Array.isArray(e)||e.length<2)return null;for(let i=0;i<e.length-1;i++){const A=e[i],r=e[i+1];if(!(typeof A!="number"||typeof r!="number")&&t>=A&&t<r){const a=r-A,l=t-A,u=xr(i),h=rp(i);return u+(a>0?l/a*h:0)}}return null}midiToY(t){if(t===0)return null;const e=d.state.fullRowData;if(!e||e.length===0)return null;const i=e.map(E=>oA(E.toneNote)).filter(E=>typeof E=="number");if(i.length===0)return null;const A=Math.min(...i),r=Math.max(...i);if(t<24||t>96||t<A||t>r)return null;let a=-1,l=-1,u=-999,h=999;for(let E=0;E<e.length;E++){const x=e[E];if(!x)continue;const T=oA(x.toneNote);typeof T=="number"&&(T<=t&&T>u&&(a=E,u=T),T>=t&&T<h&&(l=E,h=T))}if(u===t&&a>=0){const E=qt(a,d.state);return Math.max(0,Math.min(E,_e(this.canvas)))}if(a>=0&&l>=0&&u!==h){const E=qt(a,d.state),x=qt(l,d.state),T=(t-u)/(h-u),U=E+(x-E)*T;return Math.max(0,Math.min(U,_e(this.canvas)))}const m=e[0];if(!m)return null;let g=0,w=oA(m.toneNote);typeof w!="number"&&(w=t);let C=Math.abs(w-t);for(let E=1;E<e.length;E++){const x=e[E];if(!x)continue;const T=oA(x.toneNote);if(typeof T!="number")continue;const U=Math.abs(T-t);U<C&&(C=U,g=E)}const y=qt(g,d.state);return Math.max(0,Math.min(y,_e(this.canvas)))}}const Uf=new DP;class kP{constructor(){Q(this,"canvas",null);Q(this,"ctx",null);Q(this,"isInitialized",!1);Q(this,"animationFrameId",null);Q(this,"lastHistoryLength",0)}initialize(){if(this.canvas=document.getElementById("pitch-paint-canvas"),!this.canvas){b.error("PaintCanvas","Could not find #pitch-paint-canvas element",null,"paint");return}if(this.ctx=this.canvas.getContext("2d"),!document.getElementById("pitch-canvas-wrapper")){b.error("PaintCanvas","Could not find #pitch-canvas-wrapper element",null,"paint");return}d.on("paintHistoryChanged",()=>this.render()),d.on("layoutConfigChanged",()=>this.resize()),d.on("micPaintStateChanged",e=>{e?this.startRendering():this.stopRendering()}),this.resize(),this.isInitialized=!0}startRendering(){this.animationFrameId||(this.animationFrameId=requestAnimationFrame(()=>this.animationLoop()))}stopRendering(){this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null)}animationLoop(){d.state.paint.paintHistory.length!==this.lastHistoryLength&&(this.render(),this.lastHistoryLength=d.state.paint.paintHistory.length),this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}resize(){this.canvas&&this.render()}render(){if(!this.ctx||!this.canvas)return;this.ctx.clearRect(0,0,rs(this.canvas),_e(this.canvas));const t=d.state.paint.paintHistory;t.length!==0&&this.renderPaintTrail(t)}renderPaintTrail(t){if(t.length<2)return;const e=t.map(A=>{const r=Uf.calculateXFromTime(A.musicalTime),a=Uf.midiToY(A.midi);return r===null||a===null?null:{...A,x:r,y:a}}).filter(A=>A!==null);if(e.length<2)return;const i=d.state.paint.paintSettings.opacity/100;this.ctx.globalAlpha=i,this.ctx.lineCap="round",this.ctx.lineJoin="round";for(let A=1;A<e.length;A++){const r=e[A-1],a=e[A];!r||!a||a.timestamp-r.timestamp>200||this.drawPaintSegment(r,a)}this.ctx.globalAlpha=1}drawPaintSegment(t,e){const i=this.ctx.createLinearGradient(t.x,t.y,e.x,e.y);i.addColorStop(0,`rgb(${t.color.join(",")})`),i.addColorStop(1,`rgb(${e.color.join(",")})`),this.ctx.strokeStyle=i,this.ctx.lineWidth=(t.thickness+e.thickness)/2,this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()}addPaintPoint(t,e){var l;const{colorMode:i}=d.state.paint.paintSettings,A=(l=d.state.selectedNote)==null?void 0:l.color,r=rc(e,i,A),a={musicalTime:t,midi:e,color:r,timestamp:performance.now(),thickness:d.state.paint.paintSettings.thickness};d.addPaintPoint(a)}clear(){d.clearPaintHistory()}}const wp=new kP;var wd,zw;function LP(){if(zw)return wd;zw=1;function s(t){if(this.size=t|0,this.size<=1||(this.size&this.size-1)!==0)throw new Error("FFT size must be a power of two and bigger than 1");this._csize=t<<1;for(var e=new Array(this.size*2),i=0;i<e.length;i+=2){const h=Math.PI*i/this.size;e[i]=Math.cos(h),e[i+1]=-Math.sin(h)}this.table=e;for(var A=0,r=1;this.size>r;r<<=1)A++;this._width=A%2===0?A-1:A,this._bitrev=new Array(1<<this._width);for(var a=0;a<this._bitrev.length;a++){this._bitrev[a]=0;for(var l=0;l<this._width;l+=2){var u=this._width-l-2;this._bitrev[a]|=(a>>>l&3)<<u}}this._out=null,this._data=null,this._inv=0}return wd=s,s.prototype.fromComplexArray=function(e,i){for(var A=i||new Array(e.length>>>1),r=0;r<e.length;r+=2)A[r>>>1]=e[r];return A},s.prototype.createComplexArray=function(){const e=new Array(this._csize);for(var i=0;i<e.length;i++)e[i]=0;return e},s.prototype.toComplexArray=function(e,i){for(var A=i||this.createComplexArray(),r=0;r<A.length;r+=2)A[r]=e[r>>>1],A[r+1]=0;return A},s.prototype.completeSpectrum=function(e){for(var i=this._csize,A=i>>>1,r=2;r<A;r+=2)e[i-r]=e[r],e[i-r+1]=-e[r+1]},s.prototype.transform=function(e,i){if(e===i)throw new Error("Input and output buffers must be different");this._out=e,this._data=i,this._inv=0,this._transform4(),this._out=null,this._data=null},s.prototype.realTransform=function(e,i){if(e===i)throw new Error("Input and output buffers must be different");this._out=e,this._data=i,this._inv=0,this._realTransform4(),this._out=null,this._data=null},s.prototype.inverseTransform=function(e,i){if(e===i)throw new Error("Input and output buffers must be different");this._out=e,this._data=i,this._inv=1,this._transform4();for(var A=0;A<e.length;A++)e[A]/=this.size;this._out=null,this._data=null},s.prototype._transform4=function(){var e=this._out,i=this._csize,A=this._width,r=1<<A,a=i/r<<1,l,u,h=this._bitrev;if(a===4)for(l=0,u=0;l<i;l+=a,u++){const x=h[u];this._singleTransform2(l,x,r)}else for(l=0,u=0;l<i;l+=a,u++){const x=h[u];this._singleTransform4(l,x,r)}var m=this._inv?-1:1,g=this.table;for(r>>=2;r>=2;r>>=2){a=i/r<<1;var w=a>>>2;for(l=0;l<i;l+=a)for(var C=l+w,y=l,E=0;y<C;y+=2,E+=r){const x=y,T=x+w,U=T+w,H=U+w,R=e[x],D=e[x+1],P=e[T],G=e[T+1],Y=e[U],W=e[U+1],at=e[H],Bt=e[H+1],dt=R,X=D,nt=g[E],mt=m*g[E+1],ct=P*nt-G*mt,J=P*mt+G*nt,st=g[2*E],At=m*g[2*E+1],vt=Y*st-W*At,ft=Y*At+W*st,Mt=g[3*E],Pt=m*g[3*E+1],Nt=at*Mt-Bt*Pt,Wt=at*Pt+Bt*Mt,Qt=dt+vt,Et=X+ft,zt=dt-vt,oe=X-ft,ge=ct+Nt,re=J+Wt,Re=m*(ct-Nt),ae=m*(J-Wt),bs=Qt+ge,Qn=Et+re,$t=Qt-ge,Me=Et-re,Ms=zt+ae,os=oe-Re,BA=zt-ae,di=oe+Re;e[x]=bs,e[x+1]=Qn,e[T]=Ms,e[T+1]=os,e[U]=$t,e[U+1]=Me,e[H]=BA,e[H+1]=di}}},s.prototype._singleTransform2=function(e,i,A){const r=this._out,a=this._data,l=a[i],u=a[i+1],h=a[i+A],m=a[i+A+1],g=l+h,w=u+m,C=l-h,y=u-m;r[e]=g,r[e+1]=w,r[e+2]=C,r[e+3]=y},s.prototype._singleTransform4=function(e,i,A){const r=this._out,a=this._data,l=this._inv?-1:1,u=A*2,h=A*3,m=a[i],g=a[i+1],w=a[i+A],C=a[i+A+1],y=a[i+u],E=a[i+u+1],x=a[i+h],T=a[i+h+1],U=m+y,H=g+E,R=m-y,D=g-E,P=w+x,G=C+T,Y=l*(w-x),W=l*(C-T),at=U+P,Bt=H+G,dt=R+W,X=D-Y,nt=U-P,mt=H-G,ct=R-W,J=D+Y;r[e]=at,r[e+1]=Bt,r[e+2]=dt,r[e+3]=X,r[e+4]=nt,r[e+5]=mt,r[e+6]=ct,r[e+7]=J},s.prototype._realTransform4=function(){var e=this._out,i=this._csize,A=this._width,r=1<<A,a=i/r<<1,l,u,h=this._bitrev;if(a===4)for(l=0,u=0;l<i;l+=a,u++){const bA=h[u];this._singleRealTransform2(l,bA>>>1,r>>>1)}else for(l=0,u=0;l<i;l+=a,u++){const bA=h[u];this._singleRealTransform4(l,bA>>>1,r>>>1)}var m=this._inv?-1:1,g=this.table;for(r>>=2;r>=2;r>>=2){a=i/r<<1;var w=a>>>1,C=w>>>1,y=C>>>1;for(l=0;l<i;l+=a)for(var E=0,x=0;E<=y;E+=2,x+=r){var T=l+E,U=T+C,H=U+C,R=H+C,D=e[T],P=e[T+1],G=e[U],Y=e[U+1],W=e[H],at=e[H+1],Bt=e[R],dt=e[R+1],X=D,nt=P,mt=g[x],ct=m*g[x+1],J=G*mt-Y*ct,st=G*ct+Y*mt,At=g[2*x],vt=m*g[2*x+1],ft=W*At-at*vt,Mt=W*vt+at*At,Pt=g[3*x],Nt=m*g[3*x+1],Wt=Bt*Pt-dt*Nt,Qt=Bt*Nt+dt*Pt,Et=X+ft,zt=nt+Mt,oe=X-ft,ge=nt-Mt,re=J+Wt,Re=st+Qt,ae=m*(J-Wt),bs=m*(st-Qt),Qn=Et+re,$t=zt+Re,Me=oe+bs,Ms=ge-ae;if(e[T]=Qn,e[T+1]=$t,e[U]=Me,e[U+1]=Ms,E===0){var os=Et-re,BA=zt-Re;e[H]=os,e[H+1]=BA;continue}if(E!==y){var di=oe,de=-ge,qi=Et,Xn=-zt,yA=-m*bs,xa=-m*ae,Tr=-m*Re,CA=-m*re,eu=di+yA,Ir=de+xa,Qr=qi+CA,Ea=Xn-Tr,Sa=l+C-E,zi=l+w-E;e[Sa]=eu,e[Sa+1]=Ir,e[zi]=Qr,e[zi+1]=Ea}}}},s.prototype._singleRealTransform2=function(e,i,A){const r=this._out,a=this._data,l=a[i],u=a[i+A],h=l+u,m=l-u;r[e]=h,r[e+1]=0,r[e+2]=m,r[e+3]=0},s.prototype._singleRealTransform4=function(e,i,A){const r=this._out,a=this._data,l=this._inv?-1:1,u=A*2,h=A*3,m=a[i],g=a[i+A],w=a[i+u],C=a[i+h],y=m+w,E=m-w,x=g+C,T=l*(g-C),U=y+x,H=E,R=-T,D=y-x,P=E,G=T;r[e]=U,r[e+1]=0,r[e+2]=H,r[e+3]=R,r[e+4]=D,r[e+5]=0,r[e+6]=P,r[e+7]=G},wd}var RP=LP();const HP=bb(RP);class ea{constructor(t,e){Q(this,"_inputLength");Q(this,"_fft");Q(this,"_bufferSupplier");Q(this,"_paddedInputBuffer");Q(this,"_transformBuffer");Q(this,"_inverseBuffer");if(t<1)throw new Error("Input length must be at least one");this._inputLength=t,this._fft=new HP(VP(2*t)),this._bufferSupplier=e,this._paddedInputBuffer=this._bufferSupplier(this._fft.size),this._transformBuffer=this._bufferSupplier(2*this._fft.size),this._inverseBuffer=this._bufferSupplier(2*this._fft.size)}static forFloat32Array(t){return new ea(t,e=>new Float32Array(e))}static forFloat64Array(t){return new ea(t,e=>new Float64Array(e))}static forNumberArray(t){return new ea(t,e=>Array(e))}get inputLength(){return this._inputLength}autocorrelate(t,e=this._bufferSupplier(t.length)){if(t.length!==this._inputLength)throw new Error(`Input must have length ${this._inputLength} but had length ${t.length}`);for(let A=0;A<t.length;A++)this._paddedInputBuffer[A]=t[A];for(let A=t.length;A<this._paddedInputBuffer.length;A++)this._paddedInputBuffer[A]=0;this._fft.realTransform(this._transformBuffer,this._paddedInputBuffer),this._fft.completeSpectrum(this._transformBuffer);const i=this._transformBuffer;for(let A=0;A<i.length;A+=2)i[A]=i[A]*i[A]+i[A+1]*i[A+1],i[A+1]=0;this._fft.inverseTransform(this._inverseBuffer,this._transformBuffer);for(let A=0;A<t.length;A++)e[A]=this._inverseBuffer[2*A];return e}}function NP(s){const t=[];let e=!1,i=-1/0,A=-1;for(let r=1;r<s.length-1;r++)s[r-1]<=0&&s[r]>0?(e=!0,A=r,i=s[r]):s[r-1]>0&&s[r]<=0?(e=!1,A!==-1&&t.push(A)):e&&s[r]>i&&(i=s[r],A=r);return t}function OP(s,t){const[e,i,A]=[s-1,s,s+1],[r,a,l]=[t[e],t[i],t[A]],u=r/2-a+l/2,h=-(r/2)*(i+A)+a*(e+A)-l/2*(e+i),m=r*i*A/2-a*e*A+l*e*i/2,g=-h/(2*u),w=u*g*g+h*g+m;return[g,w]}class sa{constructor(t,e){Q(this,"_autocorrelator");Q(this,"_nsdfBuffer");Q(this,"_clarityThreshold",.9);Q(this,"_minVolumeAbsolute",0);Q(this,"_maxInputAmplitude",1);this._autocorrelator=new ea(t,e),this._nsdfBuffer=e(t)}static forFloat32Array(t){return new sa(t,e=>new Float32Array(e))}static forFloat64Array(t){return new sa(t,e=>new Float64Array(e))}static forNumberArray(t){return new sa(t,e=>Array(e))}get inputLength(){return this._autocorrelator.inputLength}set clarityThreshold(t){if(!Number.isFinite(t)||t<=0||t>1)throw new Error("clarityThreshold must be a number in the range (0, 1]");this._clarityThreshold=t}set minVolumeAbsolute(t){if(!Number.isFinite(t)||t<0||t>this._maxInputAmplitude)throw new Error(`minVolumeAbsolute must be a number in the range [0, ${this._maxInputAmplitude}]`);this._minVolumeAbsolute=t}set minVolumeDecibels(t){if(!Number.isFinite(t)||t>0)throw new Error("minVolumeDecibels must be a number <= 0");this._minVolumeAbsolute=this._maxInputAmplitude*10**(t/10)}set maxInputAmplitude(t){if(!Number.isFinite(t)||t<=0)throw new Error("maxInputAmplitude must be a number > 0");this._maxInputAmplitude=t}findPitch(t,e){if(this._belowMinimumVolume(t))return[0,0];this._nsdf(t);const i=NP(this._nsdfBuffer);if(i.length===0)return[0,0];const A=Math.max(...i.map(u=>this._nsdfBuffer[u])),r=i.find(u=>this._nsdfBuffer[u]>=this._clarityThreshold*A),[a,l]=OP(r,this._nsdfBuffer);return[e/a,Math.min(l,1)]}_belowMinimumVolume(t){if(this._minVolumeAbsolute===0)return!1;let e=0;for(let i=0;i<t.length;i++)e+=t[i]**2;return Math.sqrt(e/t.length)<this._minVolumeAbsolute}_nsdf(t){this._autocorrelator.autocorrelate(t,this._nsdfBuffer);let e=2*this._nsdfBuffer[0],i;for(i=0;i<this._nsdfBuffer.length&&e>0;i++)this._nsdfBuffer[i]=2*this._nsdfBuffer[i]/e,e-=t[i]**2+t[t.length-i-1]**2;for(;i<this._nsdfBuffer.length;i++)this._nsdfBuffer[i]=0}}function VP(s){return s--,s|=s>>1,s|=s>>2,s|=s>>4,s|=s>>8,s|=s>>16,s++,s}class WP{constructor(){Q(this,"mic",null);Q(this,"analyser",null);Q(this,"detector",null);Q(this,"animationFrameId",null);Q(this,"isInitialized",!1);Q(this,"micGain",null);Q(this,"micSplitter",null);Q(this,"lastLogTime",0);Q(this,"logThrottleMs",5e3);Q(this,"pitchHistory",[]);Q(this,"maxHistoryLength",3);Q(this,"maxPitchJumpSemitones",24);Q(this,"maxJumpTimeMs",20);Q(this,"config",{FFT_SIZE:2048,MIN_PITCH_HZ:75,MAX_PITCH_HZ:1300,MIN_VOLUME_DB:-50})}async initialize(){if(!this.isInitialized)try{await(typeof window<"u"&&window.initAudio||(()=>Z.start()))(),this.mic=new Z.UserMedia,this.analyser=new Z.Analyser({type:"waveform",size:this.config.FFT_SIZE}),this.micGain=new Z.Gain({gain:2}),this.detector=sa.forFloat32Array(this.analyser.size),this.micSplitter=new Z.Gain({gain:1}),await this.mic.open(),this.mic.connect(this.micGain),this.micGain.connect(this.micSplitter),this.micSplitter.connect(this.analyser),this.isInitialized=!0}catch(t){throw b.error("PitchPaintService","Failed to initialize microphone",t,"paint"),d.setMicPaintActive(!1),t}}startDetection(){!this.isInitialized||d.state.paint.isDetecting||(d.setPaintDetectionState(!0),this.animationLoop())}stopDetection(){d.state.paint.isDetecting&&(d.setPaintDetectionState(!1),this.animationFrameId&&(cancelAnimationFrame(this.animationFrameId),this.animationFrameId=null))}animationLoop(){if(!d.state.paint.isDetecting){this.animationFrameId=null;return}const t=this.analyser.getValue(),e=Math.sqrt(t.reduce((u,h)=>u+h*h,0)/t.length),i=performance.now();let A=null,r=0;if(e>1e-5)try{[A,r]=this.detector.findPitch(t,Z.context.sampleRate),A==null&&(A=null),r==null&&(r=0),A&&r>.1&&i-this.lastLogTime>this.logThrottleMs&&(this.lastLogTime=i)}catch{A=null,r=0}const a=d.state.paint.paintSettings.minClarity;if(A!==null&&r>a&&A>this.config.MIN_PITCH_HZ&&A<this.config.MAX_PITCH_HZ&&A!==null){const u=this.frequencyToMidi(A);if(this.isPitchJumpValid(u,i)){this.addPitchToHistory(u,i);const h=this.getSmoothedPitch(),m={frequency:A,clarity:r,midi:h,pitchClass:Math.round(h)%12,timestamp:i};d.setDetectedPitch(m)}else{const h=this.getSmoothedPitch();if(h!==null){const m={frequency:A,clarity:r,midi:h,pitchClass:Math.round(h)%12,timestamp:i};d.setDetectedPitch(m)}else d.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i})}}else d.setDetectedPitch({frequency:0,clarity:0,midi:0,pitchClass:0,timestamp:i});this.animationFrameId=requestAnimationFrame(()=>this.animationLoop())}frequencyToMidi(t){return 12*Math.log2(t/440)+69}addPitchToHistory(t,e){this.pitchHistory.push({midi:t,timestamp:e}),this.pitchHistory.length>this.maxHistoryLength&&this.pitchHistory.shift()}isPitchJumpValid(t,e){if(this.pitchHistory.length===0)return!0;const i=this.pitchHistory[this.pitchHistory.length-1];if(!i)return!0;const A=e-i.timestamp,r=Math.abs(t-i.midi);return A>this.maxJumpTimeMs?!0:r>this.maxPitchJumpSemitones?(b.debug("PitchPaintService","Pitch jump rejected",{semitoneDiff:r.toFixed(1),timeDiff:A.toFixed(0)},"paint"),!1):!0}getSmoothedPitch(){if(this.pitchHistory.length<3){const e=this.pitchHistory[this.pitchHistory.length-1];return e?e.midi:null}return this.pitchHistory.slice(-3).map(e=>e.midi).sort((e,i)=>e-i)[1]??null}testMicrophoneInput(){if(!this.isInitialized)return!1;const t=this.analyser.getValue();return Math.sqrt(t.reduce((i,A)=>i+A*A,0)/t.length)>1e-4}async dispose(){this.stopDetection(),this.mic&&(this.mic.close(),this.mic=null),this.micGain&&(this.micGain.dispose(),this.micGain=null),this.micSplitter&&(this.micSplitter.dispose(),this.micSplitter=null),this.analyser=null,this.detector=null,this.isInitialized=!1}}const Cr=new WP;class KP{constructor(){Q(this,"elements",{toggleBtn:null,clearBtn:null,thicknessSelect:null,opacitySelect:null,colorToggle:null,playbackToggle:null})}initialize(){this.cacheDOMElements(),this.elements.toggleBtn&&(this.setupEventListeners(),this.updateUI(),d.on("micPaintStateChanged",()=>this.updateUI()),d.on("paintHistoryChanged",()=>this.updateUI()),d.on("paintSettingsChanged",()=>this.updateUI()))}cacheDOMElements(){this.elements.toggleBtn=document.getElementById("mic-paint-toggle"),this.elements.clearBtn=document.getElementById("paint-clear-btn"),this.elements.thicknessSelect=document.getElementById("sidebar-trail-thickness"),this.elements.opacitySelect=document.getElementById("sidebar-trail-opacity"),this.elements.colorToggle=document.getElementById("paint-color-toggle"),this.elements.playbackToggle=document.getElementById("paint-playback-toggle")}setupEventListeners(){this.elements.toggleBtn.addEventListener("click",()=>void this.handleMicPaintToggle()),this.elements.clearBtn.addEventListener("click",()=>this.handleClearPaint()),this.elements.thicknessSelect.addEventListener("change",t=>{const e=parseInt(t.target.value,10);d.setPaintSettings({thickness:e})}),this.elements.opacitySelect.addEventListener("change",t=>{const e=parseInt(t.target.value,10);d.setPaintSettings({opacity:e})}),this.elements.colorToggle.addEventListener("click",()=>this.handleColorToggle()),this.elements.playbackToggle.addEventListener("click",()=>this.handlePlaybackToggle())}async handleMicPaintToggle(){const t=d.state.paint.isMicPaintActive;if(this.elements.toggleBtn.disabled=!0,t)Cr.stopDetection(),d.setMicPaintActive(!1);else try{await Cr.initialize(),d.setMicPaintActive(!0),Cr.startDetection()}catch{alert("Microphone access is required for Pitch Painting. Please check your browser permissions and try again."),d.setMicPaintActive(!1)}this.elements.toggleBtn.disabled=!1}handleClearPaint(){confirm("Are you sure you want to clear the painted pitch trail? This cannot be undone.")&&wp.clear()}handleColorToggle(){const e=d.state.paint.paintSettings.colorMode==="chromatic"?"shapenote":"chromatic";d.setPaintSettings({colorMode:e})}handlePlaybackToggle(){const t=d.state.paint.paintSettings.playbackEnabled;d.setPaintSettings({playbackEnabled:!t})}updateUI(){const{isMicPaintActive:t,paintHistory:e,paintSettings:i}=d.state.paint;if(this.elements.toggleBtn.textContent=t?"Mic Paint (ON)":"Mic Paint (OFF)",this.elements.toggleBtn.classList.toggle("active",t),this.elements.clearBtn.disabled=e.length===0,this.elements.thicknessSelect&&this.elements.thicknessSelect.value!==i.thickness.toString()&&(this.elements.thicknessSelect.value=i.thickness.toString()),this.elements.opacitySelect&&this.elements.opacitySelect.value!==i.opacity.toString()&&(this.elements.opacitySelect.value=i.opacity.toString()),this.elements.colorToggle){const A=i.colorMode==="shapenote";this.elements.colorToggle.classList.toggle("active",A)}this.elements.playbackToggle&&this.elements.playbackToggle.classList.toggle("active",i.playbackEnabled)}}const GP=new KP;b.moduleLoaded("PaintPlaybackService");class qP{constructor(){Q(this,"paintSynth",null);Q(this,"scheduledEvents",[]);Q(this,"isInitialized",!1);Q(this,"paintGain",null)}async initialize(){var t;if(!this.isInitialized)try{if(this.paintSynth=new Z.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.1,sustain:0,release:.1}}),this.paintGain=new Z.Gain({gain:.3}),this.paintSynth.connect(this.paintGain),typeof window<"u"&&((t=window.synthEngine)!=null&&t.getMainVolumeNode)){const e=window.synthEngine.getMainVolumeNode();e?(this.paintGain.connect(e),b.info("PaintPlaybackService","Connected to SynthEngine master chain (with limiter)")):(this.paintGain.toDestination(),b.warn("PaintPlaybackService","SynthEngine main volume node not found, connecting directly to destination"))}else this.paintGain.toDestination(),b.warn("PaintPlaybackService","SynthEngine not available, connecting directly to destination");this.isInitialized=!0,b.info("PaintPlaybackService","Initialized with sine wave synthesis")}catch(e){throw b.error("PaintPlaybackService","Failed to initialize",e),e}}midiToFrequency(t){return 440*Math.pow(2,(t-69)/12)}schedulePaintPlayback(){if(!this.isInitialized||!d.state.paint.paintSettings.playbackEnabled)return;this.clearScheduledEvents();const t=d.state.paint.paintHistory;if(!t||t.length===0){b.debug("PaintPlaybackService","No paint history to schedule");return}b.info("PaintPlaybackService",`Scheduling ${t.length} paint points for playback`),t.forEach((e,i)=>{const A=this.midiToFrequency(e.midi),r=.2,a=Z.Transport.schedule(l=>{this.paintSynth&&d.state.paint.paintSettings.playbackEnabled&&(this.paintSynth.triggerAttackRelease(A,r,l),b.debug("PaintPlaybackService",`Playing paint point ${i}: ${e.midi.toFixed(2)} MIDI (${A.toFixed(1)}Hz) at time ${e.musicalTime.toFixed(2)}s`))},e.musicalTime);this.scheduledEvents.push(a)}),b.info("PaintPlaybackService",`Scheduled ${this.scheduledEvents.length} paint events`)}clearScheduledEvents(){this.scheduledEvents.forEach(t=>{Z.Transport.clear(t)}),this.scheduledEvents=[],b.debug("PaintPlaybackService","Cleared all scheduled paint events")}onTransportStart(){d.state.paint.paintSettings.playbackEnabled&&this.schedulePaintPlayback()}onTransportStop(){this.clearScheduledEvents()}setPaintVolume(t){this.paintGain&&(this.paintGain.gain.value=Math.max(0,Math.min(1,t)))}getPaintVolume(){return this.paintGain?this.paintGain.gain.value:.3}async dispose(){this.clearScheduledEvents(),this.paintSynth&&(this.paintSynth.dispose(),this.paintSynth=null),this.paintGain&&(this.paintGain.dispose(),this.paintGain=null),this.isInitialized=!1,b.info("PaintPlaybackService","Disposed")}}const $w=new qP,zP="modulepreload",$P=function(s){return"/Student-Notation/"+s},Xw={},XP=function(t,e,i){let A=Promise.resolve();if(e&&e.length>0){let a=function(h){return Promise.all(h.map(m=>Promise.resolve(m).then(g=>({status:"fulfilled",value:g}),g=>({status:"rejected",reason:g}))))};document.getElementsByTagName("link");const l=document.querySelector("meta[property=csp-nonce]"),u=(l==null?void 0:l.nonce)||(l==null?void 0:l.getAttribute("nonce"));A=a(e.map(h=>{if(h=$P(h),h in Xw)return;Xw[h]=!0;const m=h.endsWith(".css"),g=m?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${g}`))return;const w=document.createElement("link");if(w.rel=m?"stylesheet":zP,m||(w.as="script"),w.crossOrigin="",w.href=h,u&&w.setAttribute("nonce",u),document.head.appendChild(w),m)return new Promise((C,y)=>{w.addEventListener("load",C),w.addEventListener("error",()=>y(new Error(`Unable to preload CSS for ${h}`)))})}))}function r(a){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=a,window.dispatchEvent(l),!l.defaultPrevented)throw a}return A.then(a=>{for(const l of a||[])l.status==="rejected"&&r(l.reason);return t().catch(r)})};class YP{constructor(){Q(this,"meter",null);Q(this,"isInitialized",!1);Q(this,"meterWrapper",null);Q(this,"meterPlaceholder",null);Q(this,"meterSource",null);Q(this,"settingsPanel",null);Q(this,"settingsBtn",null);Q(this,"sizeSelect",null);Q(this,"fpsSelect",null);Q(this,"batterySaverCheckbox",null);Q(this,"calibrateBtn",null);Q(this,"resetBtn",null);Q(this,"settings",{size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1});Q(this,"permissionState","unknown");Q(this,"errorMessage",null)}initialize(){this.isInitialized||(this.cacheDOMElements(),this.setupEventListeners(),this.updateUI(),d.on("micPaintStateChanged",t=>void this.handlePitchPaintingToggle(t)),this.isInitialized=!0)}cacheDOMElements(){this.meterWrapper=document.getElementById("mic-meter-wrapper"),this.meterPlaceholder=document.getElementById("meter-placeholder"),this.settingsPanel=document.getElementById("meter-settings-panel"),this.settingsBtn=document.getElementById("meter-settings-btn"),this.sizeSelect=document.getElementById("meter-size-select"),this.fpsSelect=document.getElementById("meter-fps-select"),this.batterySaverCheckbox=document.getElementById("meter-battery-saver"),this.calibrateBtn=document.getElementById("meter-calibrate-btn"),this.resetBtn=document.getElementById("meter-reset-btn")}setupEventListeners(){var t,e,i,A,r,a;(t=this.settingsBtn)==null||t.addEventListener("click",()=>this.toggleSettingsPanel()),(e=this.sizeSelect)==null||e.addEventListener("change",l=>this.handleSizeChange(l.target.value)),(i=this.fpsSelect)==null||i.addEventListener("change",l=>this.handleFpsChange(parseInt(l.target.value,10))),(A=this.batterySaverCheckbox)==null||A.addEventListener("change",l=>this.handleBatterySaverChange(l.target.checked)),(r=this.calibrateBtn)==null||r.addEventListener("click",()=>this.handleAutoCalibrate()),(a=this.resetBtn)==null||a.addEventListener("click",()=>this.handleReset())}async handlePitchPaintingToggle(t){t?await this.startMeter():this.stopMeter()}async startMeter(){if(!this.meter)try{await this.ensureMicrophoneAccess();const t=Z.context;if(!t||t.state==="suspended")throw new Error("Audio context not available or suspended");await this.createMeterFromExistingMic(),this.updateUI()}catch(t){this.handleMeterError(t)}}async ensureMicrophoneAccess(){this.permissionState="pending",this.updateUI(),this.permissionState="granted"}async createMeterFromExistingMic(){if(!this.meterWrapper)throw new Error("Meter wrapper not found - cannot create meter");this.meterWrapper.innerHTML="";const t=this.getMeterDimensions(),e=(await XP(async()=>{const{default:r}=await import("./meter-MPHTlek5.js");return{default:r}},[])).default,i=Cr==null?void 0:Cr.micSplitter;if(!i)throw new Error("PitchPaintService microphone splitter not available");const A=new e({target:this.meterWrapper,size:t,fps:this.settings.fps,colors:{fill:"#1a1a1a",accent:"#00ff88"},floorDb:this.settings.noiseFloor,ceilingDb:5});A.connect(i),this.meter=A,this.meterSource=i,this.meterWrapper.classList.add("active"),this.meterWrapper.classList.remove("error")}stopMeter(){if(this.meter){this.meter.disconnect();try{this.meter.destroy()}catch{}this.meter=null}this.meterSource=null,this.updateUI()}handleMeterError(t){this.errorMessage="Meter error",this.permissionState="denied",this.updateUI()}getMeterDimensions(){return this.settings.size==="compact"?[80,60]:[200,100]}updateUI(){!this.meterWrapper||!this.meterPlaceholder||(this.meter?(this.meterWrapper.classList.add("active"),this.meterPlaceholder.classList.add("hidden")):(this.meterWrapper.classList.remove("active"),this.meterPlaceholder.classList.remove("hidden")))}toggleSettingsPanel(){var t;(t=this.settingsPanel)==null||t.classList.toggle("open")}handleSizeChange(t){if(this.settings.size=t==="compact"?"compact":"wide",this.meterWrapper&&this.meter){const[e,i]=this.getMeterDimensions();this.meter.destroy(),this.meter=null,this.createMeterFromExistingMic().catch(()=>{})}}handleFpsChange(t){var e,i;this.settings.fps=Number.isFinite(t)?t:this.settings.fps,this.meter&&"setFramerate"in this.meter&&((i=(e=this.meter).setFramerate)==null||i.call(e,this.settings.fps))}handleBatterySaverChange(t){var e,i;if(this.settings.batterySaver=t,this.meter&&"setFramerate"in this.meter){const A=t?15:this.settings.fps;(i=(e=this.meter).setFramerate)==null||i.call(e,A)}}handleAutoCalibrate(){this.settings.autoCalibrated=!0}handleReset(){this.settings={size:"wide",fps:30,batterySaver:!1,noiseFloor:-70,autoCalibrated:!1},this.updateUI()}}const jP=new YP;async function JP(){b.initStart("Paint components"),wp.initialize(),Uf.initialize(),GP.initialize(),await $w.initialize(),window.PaintPlaybackService=$w,jP.initialize(),b.initSuccess("Paint components")}class ZP{constructor(){Q(this,"currentTool",null);Q(this,"toolButtons",[]);Q(this,"toolPanels",[]);Q(this,"lastSelectedNote",null);Q(this,"optionsContainers",{arrow:null,text:null,marker:null,highlighter:null,lasso:null});Q(this,"settings",{arrow:{lineStyle:"solid",strokeWeight:4,startArrowhead:"none",endArrowhead:"filled-arrow",arrowheadSize:12},text:{color:"#000000",size:16,bold:!1,italic:!1,underline:!1,background:!1,superscript:!1,subscript:!1},marker:{color:"#4a90e2",size:6},highlighter:{color:"#4a90e2",size:10},lasso:{}})}initialize(){if(this.toolButtons=document.querySelectorAll(".draw-tool-button"),this.toolPanels=document.querySelectorAll(".draw-tool-panel"),this.optionsContainers={arrow:document.getElementById("arrow-tool-options"),text:document.getElementById("text-tool-options"),marker:document.getElementById("marker-tool-options"),highlighter:document.getElementById("highlighter-tool-options"),lasso:document.getElementById("lasso-tool-options")},!this.toolButtons.length||!this.optionsContainers.arrow){b.warn("DrawToolsController","Could not find draw tool elements",null,"draw");return}this.attachEventListeners(),this.setupChordTabListeners(),this.setupMainTabListeners(),this.populateAllPanels(),this.initializePanelWidthSync(),this.logPanelMetrics(),window.addEventListener("resize",()=>this.logPanelMetrics(),{passive:!0}),d.on("noteChanged",({newNote:t})=>{this.lastSelectedNote=t,this.currentTool&&this.deselectAllTools()})}attachEventListeners(){this.toolButtons.forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.drawTool;this.selectTool(e)})})}setupMainTabListeners(){document.querySelectorAll(".tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.tab!=="pitch"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}setupChordTabListeners(){document.querySelectorAll(".pitch-tab-button").forEach(e=>{e.addEventListener("click",()=>{e.dataset.pitchTab!=="draw"&&this.currentTool&&(this.deselectAllTools(),this.restoreLastSelectedNote())})})}restoreLastSelectedNote(){this.lastSelectedNote?(d.setSelectedNote(this.lastSelectedNote.shape,this.lastSelectedNote.color),d.setSelectedTool("note")):d.state.selectedNote&&(d.setSelectedNote(d.state.selectedNote.shape,d.state.selectedNote.color),d.setSelectedTool("note"))}deselectAllTools(){this.toolButtons.forEach(t=>t.classList.remove("active")),this.toolPanels.forEach(t=>t.classList.remove("active")),this.currentTool=null,be.setTool(null,null),d.state.selectedTool==="draw"&&d.setSelectedTool("note")}selectTool(t){var i;this.toolButtons.forEach(A=>A.classList.remove("active")),this.toolPanels.forEach(A=>A.classList.remove("active"));const e=Array.from(this.toolButtons).find(A=>A.dataset.drawTool===t);if(e){e.classList.add("active");const A=e.closest(".draw-tool-panel");A==null||A.classList.add("active")}this.currentTool=t,be.setTool(t,this.settings),d.setSelectedTool("draw"),d.state.selectedNote={shape:"circle",color:((i=d.state.selectedNote)==null?void 0:i.color)||"#4a90e2"}}populateAllPanels(){this.populateArrowOptions(),this.populateTextOptions(),this.populateMarkerOptions(),this.populateHighlighterOptions()}initializePanelWidthSync(){const t=Array.from(this.toolPanels);t.length&&t.forEach(e=>{e.style.minWidth="",e.style.width="fit-content",e.style.maxWidth="100%",e.style.flex="0 0 auto"})}logPanelMetrics(){try{const t=document.querySelector(".draw-layout-grid"),i=Array.from(this.toolPanels??[]).map(r=>{const a=r.getBoundingClientRect();return{id:r.id||"panel",width:a.width,height:a.height}}),A=t==null?void 0:t.getBoundingClientRect()}catch{}}populateArrowOptions(){const t=this.optionsContainers.arrow;if(!t)return;const e=t.querySelector("#arrow-start-head-trigger"),i=t.querySelector("#arrow-end-head-trigger"),A=(w,C)=>C!=="filled-arrow"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="4" y1="12" x2="20" y2="12"/>
          </svg>
        `:w==="start"?`
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="9,5 3,12 9,19"/>
            <line x1="3" y1="12" x2="21" y2="12"/>
          </svg>
        `:`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,5 21,12 15,19"/>
          <line x1="3" y1="12" x2="21" y2="12"/>
        </svg>
      `,r=(w,C,y)=>{w&&(w.innerHTML=A(C,y))},a=t.querySelector("#arrow-stroke-weight");a&&(a.value=`${this.settings.arrow.strokeWeight}`,a.addEventListener("input",()=>{this.settings.arrow.strokeWeight=parseInt(a.value,10),be.setTool("arrow",this.settings)}));const l=t.querySelector("#arrow-head-size");l&&(l.value=`${this.settings.arrow.arrowheadSize}`,l.addEventListener("input",()=>{this.settings.arrow.arrowheadSize=parseInt(l.value,10),be.setTool("arrow",this.settings)}));const u=Array.from(t.querySelectorAll("[data-line-style]"));if(u.length){const w=C=>{u.forEach(y=>y.classList.toggle("active",y.dataset.lineStyle===C))};w(this.settings.arrow.lineStyle),u.forEach(C=>{C.addEventListener("click",()=>{const y=C.dataset.lineStyle;y&&(this.settings.arrow.lineStyle=y,w(y),be.setTool("arrow",this.settings))})})}const h=Array.from(t.querySelectorAll("[data-arrow-start]"));if(h.length){const w=C=>{h.forEach(y=>y.classList.toggle("active",y.dataset.arrowStart===C)),r(e,"start",C)};w(this.settings.arrow.startArrowhead),h.forEach(C=>{C.addEventListener("click",()=>{const y=C.dataset.arrowStart;y&&(this.settings.arrow.startArrowhead=y,w(y),be.setTool("arrow",this.settings))})})}const m=Array.from(t.querySelectorAll("[data-arrow-end]"));if(m.length){const w=C=>{m.forEach(y=>y.classList.toggle("active",y.dataset.arrowEnd===C)),r(i,"end",C)};w(this.settings.arrow.endArrowhead),m.forEach(C=>{C.addEventListener("click",()=>{const y=C.dataset.arrowEnd;y&&(this.settings.arrow.endArrowhead=y,w(y),be.setTool("arrow",this.settings))})})}const g=t.querySelector("#arrow-swap-heads");g&&g.addEventListener("click",()=>{const w=this.settings.arrow.startArrowhead;if(this.settings.arrow.startArrowhead=this.settings.arrow.endArrowhead,this.settings.arrow.endArrowhead=w,h.length){const C=this.settings.arrow.startArrowhead;h.forEach(y=>y.classList.toggle("active",y.dataset.arrowStart===C)),r(e,"start",C)}if(m.length){const C=this.settings.arrow.endArrowhead;m.forEach(y=>y.classList.toggle("active",y.dataset.arrowEnd===C)),r(i,"end",C)}be.setTool("arrow",this.settings)})}populateTextOptions(){const t=this.optionsContainers.text;if(!t)return;const e=t.querySelector("#text-size-input");e&&(e.value=`${this.settings.text.size}`,e.addEventListener("input",()=>{this.settings.text.size=parseInt(e.value,10),be.setTool("text",this.settings)}));const i=Array.from(t.querySelectorAll(".draw-color-button"));if(i.length){const r=a=>{i.forEach(l=>{const u=l.dataset.color||"";l.classList.toggle("active",u.toLowerCase()===a.toLowerCase())})};r(this.settings.text.color),i.forEach(a=>{a.addEventListener("click",()=>{const l=a.dataset.color;l&&(this.settings.text.color=l,r(l),be.setTool("text",this.settings))})})}const A=Array.from(t.querySelectorAll("[data-text-style]"));if(A.length){const r=["bold","italic","underline","background","superscript","subscript"],a=l=>{r.includes(l)&&(this.settings.text[l]=!this.settings.text[l],be.setTool("text",this.settings))};A.forEach(l=>{const u=l.dataset.textStyle||"";r.includes(u)&&l.classList.toggle("active",!!this.settings.text[u])}),A.forEach(l=>{l.addEventListener("click",()=>{const u=l.dataset.textStyle||"";r.includes(u)&&(a(u),l.classList.toggle("active",!!this.settings.text[u]))})})}}populateMarkerOptions(){const t=this.optionsContainers.marker;if(!t)return;const e=t.querySelector("#marker-size-input");e&&(e.value=`${this.settings.marker.size}`,e.addEventListener("input",()=>{this.settings.marker.size=parseInt(e.value,10),be.setTool("marker",this.settings)}));const i=Array.from(t.querySelectorAll(".draw-color-button"));if(i.length){const A=r=>{i.forEach(a=>{const l=a.dataset.color||"";a.classList.toggle("active",l.toLowerCase()===r.toLowerCase())})};A(this.settings.marker.color),i.forEach(r=>{r.addEventListener("click",()=>{const a=r.dataset.color;a&&(this.settings.marker.color=a,A(a),be.setTool("marker",this.settings))})})}}populateHighlighterOptions(){const t=this.optionsContainers.highlighter;if(!t)return;const e=t.querySelector("#highlighter-size-input");e&&(e.value=`${this.settings.highlighter.size}`,e.addEventListener("input",()=>{this.settings.highlighter.size=parseInt(e.value,10),be.setTool("highlighter",this.settings)}));const i=Array.from(t.querySelectorAll(".draw-color-button"));if(i.length){const A=r=>{i.forEach(a=>{const l=a.dataset.color||"";a.classList.toggle("active",l.toLowerCase()===r.toLowerCase())})};A(this.settings.highlighter.color),i.forEach(r=>{r.addEventListener("click",()=>{const a=r.dataset.color;a&&(this.settings.highlighter.color=a,A(a),be.setTool("highlighter",this.settings))})})}}}const vd=new ZP;function t2(){var s;return be.initialize(),(s=vd.initialize)==null||s.call(vd),b.initSuccess("DrawSystem"),typeof window<"u"&&(window.annotationService=be),{annotationService:be}}b.moduleLoaded("KeyboardHandler","keyboard");function e2(){document.addEventListener("keydown",s=>{var r,a,l;const t=document.activeElement;if(!t)return;const e=t.tagName.toLowerCase(),i=t.contentEditable==="true";if(["input","textarea"].includes(e)||i)return;if(s.ctrlKey&&s.key.toLowerCase()==="p"){s.preventDefault(),b.info("KeyboardHandler","Ctrl+P pressed. Opening print preview",null,"keyboard"),d.emit("printPreviewStateChanged",!0);return}if(s.ctrlKey&&s.key.toLowerCase()==="z"){s.preventDefault(),d.undo();return}if(s.ctrlKey&&s.key.toLowerCase()==="y"){s.preventDefault(),d.redo();return}let A=!1;switch(s.key){case"Escape":(r=d.state.lassoSelection)!=null&&r.isActive&&(d.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},d.emit("lassoSelectionCleared"),d.emit("render"),A=!0,b.debug("KeyboardHandler","Lasso selection cleared (Escape)",null,"keyboard"));break;case"Enter":(a=d.state.lassoSelection)!=null&&a.isActive&&(d.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},d.emit("lassoSelectionCleared"),d.emit("render"),A=!0,b.debug("KeyboardHandler","Lasso selection cleared (Enter)",null,"keyboard"));break;case"Backspace":case"Delete":if((l=d.state.lassoSelection)!=null&&l.isActive){const u=d.state.lassoSelection.selectedItems;u.forEach(h=>{if(h.type==="note"){const m=h.data,g=d.state.placedNotes.findIndex(w=>w.uuid===m.uuid);g!==-1&&d.state.placedNotes.splice(g,1)}else if(h.type==="stamp"){const m=h.data,g=d.state.stampPlacements.findIndex(w=>w.id===m.id);g!==-1&&d.state.stampPlacements.splice(g,1)}else if(h.type==="triplet"){const m=h.data,g=d.state.tripletPlacements.findIndex(w=>w.id===m.id);g!==-1&&d.state.tripletPlacements.splice(g,1)}}),d.state.lassoSelection={selectedItems:[],convexHull:null,isActive:!1},d.recordState(),d.emit("render"),A=!0,b.info("KeyboardHandler",`Deleted ${u.length} items from lasso selection`,null,"keyboard")}break;case"ArrowUp":d.shiftGridUp(),A=!0;break;case"ArrowDown":d.shiftGridDown(),A=!0;break;case"ArrowLeft":b.debug("KeyboardHandler","Emitting 'zoomOut' event",null,"keyboard"),d.emit("zoomOut"),A=!0;break;case"ArrowRight":b.debug("KeyboardHandler","Emitting 'zoomIn' event",null,"keyboard"),d.emit("zoomIn"),A=!0;break}A&&s.preventDefault()}),b.info("KeyboardHandler","Initialized",null,"keyboard")}const s2=[{label:"Toolbar",selector:"#toolbar"},{label:"Toolbar Primary",selector:"#toolbar-primary"},{label:"Primary Actions Grid",selector:"#toolbar-primary .primary-toolbar-actions"},{label:"Primary Playback Row",selector:"#toolbar-primary .primary-toolbar-playback"},{label:"Toolbar Secondary",selector:"#toolbar-secondary"},{label:"Toolbar Preset Controls",selector:"#toolbar-secondary .preset-effects-controls"},{label:"Toolbar Tab Sidebar",selector:"#toolbar-secondary .tab-sidebar"},{label:"Sidebar",selector:"#sidebar"},{label:"Timbre Tab Panel",selector:"#timbre-panel"},{label:"Pitch Tab Panel",selector:"#pitch-panel"},{label:"Rhythm Tab Panel",selector:"#rhythm-panel"},{label:"Macrobeat Tools",selector:"#canvas-macrobeat-tools, #macrobeat-tools"},{label:"Waveform Card",selector:"#timbre-panel .waveform-content-box"},{label:"Preset Card",selector:"#timbre-panel .preset-content-box"},{label:"Echo Card",selector:"#timbre-panel #reverb-delay-panel .effects-content-box, #timbre-panel #echo-panel .effects-content-box"},{label:"Shake Card",selector:"#timbre-panel #vibrato-tremolo-panel .effects-content-box, #timbre-panel #shake-panel .effects-content-box"},{label:"Envelope Card",selector:"#adsr-envelope"},{label:"Harmonics Card",selector:".harmonic-bins-container"},{label:"Canvas Container",selector:"#canvas-container"},{label:"Pitch Grid Wrapper",selector:"#pitch-grid-wrapper"},{label:"Pitch Grid Container",selector:"#pitch-grid-container"},{label:"Drum Grid Wrapper",selector:"#drum-grid-wrapper"},{label:"Drum Grid",selector:"#drum-grid"}],Pf=new Map;let Df,Bd,yd=null,yo="",pr=!1;function Ll(s){return Number.isFinite(s)?Number(s.toFixed(1)):s}function n2(s){const t=s.getBoundingClientRect(),e=window.getComputedStyle(s);return{tag:s.tagName.toLowerCase(),id:s.id||null,class:s.className||null,top:Ll(t.top),left:Ll(t.left),width:Ll(t.width),height:Ll(t.height),offsetWidth:s.offsetWidth,offsetHeight:s.offsetHeight,scrollWidth:s.scrollWidth,scrollHeight:s.scrollHeight,clientWidth:s.clientWidth,clientHeight:s.clientHeight,display:e.display,position:e.position,overflowX:e.overflowX,overflowY:e.overflowY,transform:e.transform!=="none"?e.transform:void 0}}function Gy(s="manual"){const t=window.__uiDiagnosticsTrackedElements;if(!t)return[];if(!pr&&s!=="manual")return[];oc();const e=[];return t.forEach(i=>{const A=Array.from(document.querySelectorAll(i.selector));if(!A.length){e.push({label:i.label,selector:i.selector,missing:!0});return}A.forEach((r,a)=>{const l=A.length>1?`${i.label} [${a}]`:i.label,u=n2(r);e.push({label:l,selector:i.selector,info:u})})}),window.__uiDiagnosticsLastSnapshot=e,e}function ar(s){pr&&(yo=yo?`${yo}; ${s}`:s,yd===null&&(yd=requestAnimationFrame(()=>{const t=yo||"auto";yd=null,yo="",Gy(t)})))}function oc(){const s=window.__uiDiagnosticsTrackedElements;!s||!Df||s.forEach(t=>{document.querySelectorAll(t.selector).forEach(i=>{Pf.has(i)||(Pf.set(i,t.label),Df.observe(i),i.addEventListener("scroll",()=>ar(`${t.label} scroll`),{passive:!0}))})})}function i2(s={}){if(window.__uiDiagnosticsInitialized)return;window.__uiDiagnosticsInitialized=!0;const{elements:t,autoLog:e=!1}=s;pr=!!e,window.__uiDiagnosticsAutoLog=pr;const i=t||s2;window.__uiDiagnosticsTrackedElements=i,Df=new ResizeObserver(A=>{const r=A.map(a=>Pf.get(a.target)||a.target.id||a.target.tagName.toLowerCase()).filter(Boolean);r.length&&ar(`Resize: ${r.join(", ")}`)}),Bd=new MutationObserver(()=>oc()),document.body?Bd.observe(document.body,{childList:!0,subtree:!0}):document.addEventListener("DOMContentLoaded",()=>{Bd.observe(document.body,{childList:!0,subtree:!0}),oc(),ar("init")},{once:!0}),window.addEventListener("resize",()=>ar("window resize")),oc(),ar("init"),window.logUIState=(A="manual")=>Gy(A),window.enableUIDiagnosticsAutoLog=()=>{pr=!0,window.__uiDiagnosticsAutoLog=!0,ar("auto-log enabled")},window.disableUIDiagnosticsAutoLog=()=>{pr=!1,window.__uiDiagnosticsAutoLog=!1}}function A2(){b.section("SETTING UP INPUT HANDLERS"),e2(),cP(),window.enableUIDiagnostics&&i2()}function r2(){d.on("tempoChanged",()=>{Gt.setBpm(d.state.tempo)}),d.on("layoutChanged",()=>{Ot.reflow()}),d.on("rhythmPatternChanged",()=>{As.refresh&&As.refresh()});const s=()=>{var t;try{la.render(),(t=Qs.render)==null||t.call(Qs),b.debug("StateSubscriptions","renderAll invoked",null,"grid")}catch(e){b.error("StateSubscriptions","renderAll failed",e,"grid")}};return d.on("notesChanged",s),d.on("stampPlacementsChanged",s),d.on("tripletPlacementsChanged",s),d.on("accidentalModeChanged",s),d.on("frequencyLabelsChanged",s),d.on("layoutConfigChanged",()=>{la.renderMacrobeatTools()}),d.on("rhythmStructureChanged",()=>{Ot.reflow()}),d.on("modulationMarkersChanged",()=>{Ot.reflow(),s()}),b.initSuccess("StateSubscriptions"),{renderAll:s}}let Yw=!1,Co=null;window.initAudio=async()=>{if(!Yw)return Co||(Co=(async()=>{try{Z.context.state!=="running"&&(await Z.start(),b.info("Main.js","AudioContext started successfully")),Yw=!0}catch(s){throw b.error("Main.js","Could not start AudioContext",s),Co=null,s}})(),Co)};let jw=!1;const br=()=>{var s;jw||(jw=!0,(s=window.initAudio)==null||s.call(window).catch(t=>b.warn("Main.js","Failed to initialize audio after user interaction",t,"initialization")),document.removeEventListener("click",br,!0),document.removeEventListener("keydown",br,!0),document.removeEventListener("touchstart",br,!0))};document.addEventListener("click",br,!0);document.addEventListener("keydown",br,!0);document.addEventListener("touchstart",br,!0);window.addEventListener("beforeunload",()=>{typeof Gt.teardown=="function"&&Gt.teardown()});const Uc={domCache:!1,layoutService:!1,canvasContextService:!1,synthEngine:!1,transportService:!1,scrollSync:!1,uiComponents:!1,audioComponents:!1,rhythmPlaybackService:!1,initialized:!1},o2={top:"Ab5",bottom:"C4"};function a2(s){if(!(s!=null&&s.top)||!(s!=null&&s.bottom))return null;const t=me.findIndex(i=>i.toneNote===s.top),e=me.findIndex(i=>i.toneNote===s.bottom);return t===-1||e===-1?(b.warn("Main.js","Failed to resolve preset range from tone notes",s),null):{topIndex:Math.min(t,e),bottomIndex:Math.max(t,e)}}function l2(){return a2(o2)}function oi(s){Uc[s]=!0}function Jw(s,t=5e3){return new Promise((e,i)=>{if(Uc[s]){e();return}const A=Date.now(),r=()=>{Uc[s]?e():Date.now()-A>t?i(new Error(`Component ${s} not ready within ${t}ms`)):setTimeout(r,50)};r()})}document.addEventListener("DOMContentLoaded",()=>void(async()=>{window.initStartTime=Date.now(),b.info("Main.js","DOMContentLoaded event fired"),b.section("STARTING INITIALIZATION");const s=["dom-cache","core-services","ui-components","audio-components","initial-render","finalize"];try{await vs.init(),s.forEach(a=>vs.registerTask(a)),oM(),(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1")&&dy(),vs.updateStatus("Initializing interface..."),gA.init(),oi("domCache"),vs.completeTask("dom-cache"),(()=>{const a=gA.get("appContainer")||document.getElementById("app-container");if(a){const l=["click","keydown","touchstart"],u=()=>{var h;(h=window.initAudio)==null||h.call(window)};l.forEach(h=>{a.addEventListener(h,u,{once:!0})})}})(),vs.updateStatus("Preparing core systems..."),dM(d.state);const e=d.state.pitchRange||{topIndex:0,bottomIndex:me.length-1},i=Math.max(0,Math.min(me.length-1,e.topIndex??0)),A=Math.max(i,Math.min(me.length-1,e.bottomIndex??me.length-1));d.state.pitchRange={topIndex:i,bottomIndex:A},d.state.fullRowData=me.slice(i,A+1),QP(),oi("layoutService"),oi("canvasContextService"),await Ot.waitForInitialLayout(),Gt.init(),oi("synthEngine"),As.initialize().catch(a=>{b.warn("Main.js","RhythmPlaybackService initialization deferred (needs user interaction)",a,"initialization")}),oi("rhythmPlaybackService"),hr.init(),oi("transportService"),A2(),vs.completeTask("core-services"),vs.updateStatus("Loading interface components..."),jM(),oi("uiComponents"),vs.completeTask("ui-components"),await Jw("uiComponents"),vs.updateStatus("Preparing audio components..."),WU(),oi("audioComponents"),vs.completeTask("audio-components"),fM(d.state,"audio-components-initialization"),qU(),await JP(),t2(),await Jw("audioComponents"),b.section("SETTING UP STATE SUBSCRIPTIONS");const{renderAll:r}=r2();if(b.section("PERFORMING INITIAL RENDER"),d.setSelectedTool("note"),d.setSelectedNote("circle","#4a90e2"),vs.updateStatus("Rendering workspace..."),r(),la.renderMacrobeatTools(),vs.completeTask("initial-render"),$l.prefetchButtonGridSnapshot(),oi("initialized"),b.section("INITIALIZATION COMPLETE"),vs.updateStatus("Finalizing..."),vs.completeTask("finalize"),d.isColdStart){const a=l2(),l=d.state.pitchRange,u=a&&l&&l.topIndex===a.topIndex&&l.bottomIndex===a.bottomIndex,h=d.state.isPitchRangeLocked!==!1;a&&!u?(b.info("Main.js",`Cold start detected, applying Treble Clef preset range (locked=${h})`),d.setSnapZoomToRange(h),d.setPitchRange(a,{trimOutsideRange:h,preserveContent:!h}),h&&Ot.snapZoomToCurrentRange?Ot.snapZoomToCurrentRange():Ot.recalculateLayout&&Ot.recalculateLayout()):a||b.warn("Main.js","Treble Clef preset range could not be resolved during cold start")}await vs.complete(),window.ModulationTest=my}catch(t){b.error("Main.js","Initialization failed",t,"initialization"),b.error("Main.js","Component readiness snapshot at failure",{...Uc},"initialization");const e=t instanceof Error?t:new Error(String(t));vs.showError(e);const i=document.createElement("div");i.style.cssText=`
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: #ff4444; color: white; padding: 20px; border-radius: 8px;
            z-index: 10000; font-family: monospace; max-width: 80vw;
        `,i.innerHTML=`
            <h3>Initialization Error</h3>
            <p>The application failed to initialize properly.</p>
            <details>
                <summary>Technical Details</summary>
                <pre>${e.message}</pre>
                <pre>Stack: ${e.stack}</pre>
            </details>
            <button onclick="location.reload()">Reload Page</button>
        `,document.body.appendChild(i)}})());
