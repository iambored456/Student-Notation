<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Student Notation Web Applet</title>
<link rel="icon" href="/favicon.ico" sizes="any" />
<link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
<link rel="mask-icon" href="/favicon.svg" color="#a88cf3" />
<link rel="manifest" href="/site.webmanifest" />
<meta name="theme-color" content="#ffffff" />
<link rel="stylesheet" href="style.css" />
<style id="print-style-rules"></style>
</head>
<body>
<!-- Sidebar for File/App Actions -->
<div id="sidebar-overlay"></div>
<aside id="sidebar" role="complementary" aria-label="Application settings and controls">
<div class="sidebar-container">
<div class="app-title">Student Notation</div>
</div>
<div class="sidebar-container">
<button class="sidebar-button" id="save-as-button" title="Save As"><img src="assets/sidebar/saveAs.svg" alt="Save As"><span class="sidebar-button-text">Save As</span></button>
<button class="sidebar-button" id="import-button" title="Open"><img src="assets/sidebar/open.svg" alt="Open"><span class="sidebar-button-text">Open</span></button>
<button class="sidebar-button" id="print-button" title="Print"><img src="assets/sidebar/print.svg" alt="Print"><span class="sidebar-button-text">Print</span></button>
<button class="sidebar-button" id="reset-canvas-button" title="New File"><img src="assets/sidebar/newPage.svg" alt="New Page"><span class="sidebar-button-text">New Page</span></button>
</div>
<div class="sidebar-container">
<button class="sidebar-button" id="hide-drumgrid-toggle" title="Toggle Drum Grid"><img src="assets/sidebar/hideDrums.svg" alt="Toggle Drum Grid"><span class="sidebar-button-text">Hide Drum Grid</span></button>
</div>
</aside>
<main id="app-container" role="main">
  <!-- =======================================================
        Toolbar Container
       ======================================================= -->
  <nav id="toolbar" role="navigation" aria-label="Music notation tools">
    <!-- Primary Toolbar -->
    <div id="toolbar-primary" class="toolbar-primary">
        <div class="primary-toolbar-grid">
            <div class="primary-toolbar-cell primary-toolbar-actions">
                <button class="toolkit-icon-button" id="settings-button" title="Settings"><img src="assets/icons/settings.svg" alt="Settings"></button>
                <div id="volume-control-wrapper">
                    <button class="toolkit-icon-button" id="volume-icon-button" aria-label="Volume" title="Volume"><img src="assets/icons/volume.svg" alt="Volume"></button>
                    <div id="volume-popup">
                        <input type="range" id="vertical-volume-slider" orient="vertical" min="0" max="100" value="70" step="1" />
                    </div>
                </div>
                <button class="toolkit-icon-button" id="grid-zoom-in" title="Zoom In"><img src="assets/icons/zoomIn.svg" alt="Zoom In"></button>
                <button class="toolkit-icon-button" id="grid-zoom-out" title="Zoom Out"><img src="assets/icons/zoomOut.svg" alt="Zoom Out"></button>
                <button class="toolkit-icon-button" id="redo-button" title="Redo"><img src="assets/icons/redo.svg" alt="Redo"></button>
                <button class="toolkit-icon-button" id="undo-button" title="Undo"><img src="assets/icons/undo.svg" alt="Undo"></button>
                <button class="toolkit-icon-button" id="clear-button" title="Clear"><img src="assets/icons/clear.svg" alt="Clear"></button>
                <button class="toolkit-icon-button eraser-button" id="eraser-tool-button" title="Eraser">
                    <img src="assets/icons/eraser.svg" alt="Eraser" class="eraser-icon">
                </button>
            </div>
            <div class="primary-toolbar-cell primary-toolbar-notebank">
                <div id="note-bank-container">
                    <div class="note-bank-column">
                        <div class="note-pair" data-color="#4a90e2">
                            <div class="note circle-note" data-type="circle"></div>
                            <div class="note oval-note" data-type="oval"></div>
                            <div class="note diamond-note" data-type="diamond" aria-label="Sixteenth note jewel">
                                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">
                                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />
                                </svg>
                            </div>
                        </div>
                        <div class="note-pair" data-color="#2d2d2d">
                            <div class="note circle-note" data-type="circle"></div>
                            <div class="note oval-note" data-type="oval"></div>
                            <div class="note diamond-note" data-type="diamond" aria-label="Sixteenth note jewel">
                                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">
                                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />
                                </svg>
                            </div>
                        </div>
                        <div class="note-pair" data-color="#d66573">
                            <div class="note circle-note" data-type="circle"></div>
                            <div class="note oval-note" data-type="oval"></div>
                            <div class="note diamond-note" data-type="diamond" aria-label="Sixteenth note jewel">
                                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">
                                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />
                                </svg>
                            </div>
                        </div>
                        <div class="note-pair" data-color="#68a03f">
                            <div class="note circle-note" data-type="circle"></div>
                            <div class="note oval-note" data-type="oval"></div>
                            <div class="note diamond-note" data-type="diamond" aria-label="Sixteenth note jewel">
                                <svg class="diamond-icon" viewBox="0 0 120 120" aria-hidden="true" focusable="false">
                                    <path d="M60 5 L35 48.3 L35 71.7 L60 115 L85 71.7 L85 48.3 Z" />
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="primary-toolbar-cell primary-toolbar-playback">
                <button class="toolkit-icon-button" id="play-button" title="Play"><img src="assets/icons/play.svg" alt="Play"></button>
                <button class="toolkit-icon-button" id="stop-button" title="Stop"><img src="assets/icons/stop.svg" alt="Stop"></button>
                <button class="toolkit-icon-button" id="loop-button" title="Loop"><img src="assets/icons/loop.svg" alt="Loop"></button>
            </div>
        </div>
    </div>
    <!-- Secondary Toolbar -->
    <div id="toolbar-secondary" class="toolbar-secondary">
        <div class="tab-sidebar">
            <button class="tab-button" data-tab="timbre">Timbre</button>
            <button class="tab-button" data-tab="pitch">Pitch</button>
            <button class="tab-button" data-tab="rhythm">Rhythm</button>
        </div>
        <div class="tab-content">
            <!-- Timbre Tab -->
            <div class="tab-panel" id="timbre-panel">
                <!-- Waveform Section (Separate) -->
                <div class="control-section waveform-container">
                    <div class="waveform-section">
                        <button class="preset-tab-button waveform-tab-button active" disabled>Waveform</button>
                        <div class="waveform-content-box">
                            <div class="waveform-display-wrapper">
                                <canvas id="static-waveform-canvas"></canvas>
                                <div class="waveform-speed-controls">
                                    <button class="waveform-speed-btn" data-speed="50">50%</button>
                                    <button class="waveform-speed-btn" data-speed="10">10%</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Presets/Effects Section (Separate) -->
                <div class="control-section preset-effects-container">
                    <div class="preset-effects-controls">
                            <div class="preset-effects-tabs">
                                <button class="preset-tab-button active" data-preset-tab="presets">Presets</button>
                                <button class="preset-tab-button" data-preset-tab="reverb-delay">Echo</button>
                                <button class="preset-tab-button" data-preset-tab="vibrato-tremolo">Shake</button>
                            </div>
                            <div class="preset-effects-content">
                                <!-- Presets Tab -->
                                <div class="preset-tab-panel active" id="presets-panel">
                            <div class="preset-content-box">
                                <div class="preset-grid" id="preset-buttons">
                                    <div class="preset-column">
                                        <button class="preset-button" id="preset-sine">Sine</button>
                                        <button class="preset-button" id="preset-triangle">Triangle</button>
                                        <button class="preset-button" id="preset-square">Square</button>
                                        <button class="preset-button" id="preset-sawtooth">Sawtooth</button>
                                    </div>
                                    <div class="preset-column">
                                        <button class="preset-button" id="preset-piano">Piano</button>
                                        <button class="preset-button" id="preset-marimba">Marimba</button>
                                        <button class="preset-button" id="preset-woodwind">Woodwind</button>
                                        <button class="preset-button" id="preset-strings">Strings</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Reverb/Delay Tab -->
                        <div class="preset-tab-panel" id="reverb-delay-panel">
                            <div class="effects-content-box">
                                <div class="position-controls-container">
                                    <div class="position-control-group">
                                        <h5 class="position-label">Reverb</h5>
                                        <div class="position-component" id="reverb-position"></div>
                                        <div class="position-axis-labels" data-axis-x="Time" data-axis-y="Size"></div>
                                    </div>
                                    <div class="position-control-group">
                                        <h5 class="position-label">Delay</h5>
                                        <div class="position-component" id="delay-position"></div>
                                        <div class="position-axis-labels" data-axis-x="Time" data-axis-y="Echoes"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Vibrato/Tremolo Tab -->
                        <div class="preset-tab-panel" id="vibrato-tremolo-panel">
                            <div class="effects-content-box">
                                <div class="position-controls-container">
                                    <div class="position-control-group">
                                        <h5 class="position-label">Vibrato</h5>
                                        <div class="position-component" id="vibrato-position"></div>
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>
                                    </div>
                                    <div class="position-control-group">
                                        <h5 class="position-label">Tremolo</h5>
                                        <div class="position-component" id="tremolo-position"></div>
                                        <div class="position-axis-labels" data-axis-x="Speed" data-axis-y="Span"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Legacy slider controls (kept for data sharing) -->
                        <div class="effects-grid" style="display: none;">
                            <button class="effect-button" data-effect="reverb">Reverb</button>
                            <button class="effect-button" data-effect="delay">Delay</button>
                            <button class="effect-button" data-effect="vibrato">Vibrato</button>
                            <button class="effect-button" data-effect="tremolo">Tremolo</button>
                        </div>
                        <div class="effect-controls-container" id="effect-controls" style="display: none;">
                            <!-- Effect controls will be dynamically inserted here for data synchronization -->
                        </div>
                            </div>
                    </div>
                </div>

                <div class="control-section filter-container">
                    <!-- Row 1, Col 1: Blend slider -->
                    <div class="blend-slider-container"><div id="blend-slider-container"><div class="filter-blend-thumb" id="thumb-b" tabindex="0">B</div></div></div>

                    <!-- Row 2, Col 1: Bins grid (appended via JS) -->
                    <div class="filter-bins-wrapper"></div>

                    <!-- Row 3, Col 1: Cutoff slider -->
                    <div id="cutoff-slider-container"><div class="filter-cutoff-thumb" id="thumb-c" tabindex="0">C</div></div>

                    <!-- Row 2, Col 2: Vertical M slider (appended via JS) -->
                    <div class="filter-vertical-blend-wrapper"></div>
                </div>
                <div class="control-section adsr-container">
                    <!-- Row 1, Col 1: ADSR graph -->
                    <div class="adsr-graph-wrapper"><div id="adsr-envelope"></div></div>

                    <!-- Row 1, Col 2: Sustain slider -->
                    <div class="sustain-slider-wrapper"><div id="sustain-slider-track"><div id="sustain-slider-thumb" tabindex="0">S</div></div></div>

                    <!-- Row 2, Col 1: ADR slider -->
                    <div id="multi-thumb-slider-container"><div class="time-slider-thumb" id="thumb-a" tabindex="0">A</div><div class="time-slider-thumb" id="thumb-d" tabindex="0">D</div><div class="time-slider-thumb" id="thumb-r" tabindex="0">R</div></div>
                </div>
            </div>

            <!-- Pitch Tab -->
            <div class="tab-panel" id="pitch-panel">
                <div class="control-section pitch-tabs-container">
                    <div class="pitch-tabs">
                        <button class="pitch-tab-button active" data-pitch-tab="range">Range</button>
                        <button class="pitch-tab-button" data-pitch-tab="chords">Chords</button>
                        <button class="pitch-tab-button" data-pitch-tab="mic-paint">Mic Paint</button>
                        <button class="pitch-tab-button" data-pitch-tab="draw">Draw</button>
                    </div>
                    <div class="pitch-tab-content">
                        <div class="pitch-tab-panel active" id="range-panel">
                            <div class="range-content-box">
                                <div class="range-layout">
                                   <div class="range-panel-section modes-section">
                                       <h4 class="panel-section-title">Modes</h4>
                                       <div class="tonic-modes-container">
                                           <div class="tonic-modes-grid">
                                               <button class="tonic-mode-button" data-tonic="1">
                                                   <img src="assets/tabicons/tonicShape_1.svg" alt="Major" class="tonic-mode-icon">
                                                   <span class="tonic-mode-label">Major</span>
                                               </button>
                                               <button class="tonic-mode-button" data-tonic="2">
                                                   <img src="assets/tabicons/tonicShape_2.svg" alt="Dorian" class="tonic-mode-icon">
                                                   <span class="tonic-mode-label">Dorian</span>
                                               </button>
                                               <button class="tonic-mode-button" data-tonic="3">
                                                   <img src="assets/tabicons/tonicShape_3.svg" alt="Phrygian" class="tonic-mode-icon">
                                                   <span class="tonic-mode-label">Phrygian</span>
                                               </button>
                                               <button class="tonic-mode-button" data-tonic="4">
                                                   <img src="assets/tabicons/tonicShape_4.svg" alt="Lydian" class="tonic-mode-icon">
                                                   <span class="tonic-mode-label">Lydian</span>
                                               </button>
                                               <button class="tonic-mode-button" data-tonic="5">
                                                   <img src="assets/tabicons/tonicShape_5.svg" alt="Mixolydian" class="tonic-mode-icon">
                                                   <span class="tonic-mode-label">Mixolydian</span>
                                               </button>
                                               <button class="tonic-mode-button" data-tonic="6">
                                                   <img src="assets/tabicons/tonicShape_6.svg" alt="Minor" class="tonic-mode-icon">
                                                   <span class="tonic-mode-label">Minor</span>
                                               </button>
                                               <button class="tonic-mode-button" data-tonic="7">
                                                   <img src="assets/tabicons/tonicShape_7.svg" alt="Locrian" class="tonic-mode-icon">
                                                   <span class="tonic-mode-label">Locrian</span>
                                               </button>
                                           </div>
                                       </div>
                                   </div>
                                   <div class="range-panel-section degrees-section">
                                       <h4 class="panel-section-title">Degrees</h4>
                                       <div class="two-state-toggle" id="degree-visibility-toggle">
                                           <div class="two-state-slider"></div>
                                           <div class="toggle-labels">
                                               <span class="toggle-label">Show</span>
                                               <span class="toggle-label">Hide</span>
                                           </div>
                                       </div>
                                       <div class="two-state-toggle" id="degree-mode-toggle">
                                           <div class="two-state-slider"></div>
                                           <div class="toggle-labels">
                                               <span class="toggle-label">Scale</span>
                                               <span class="toggle-label">Mode</span>
                                           </div>
                                       </div>
                                       <label class="checkbox-label">
                                           <input type="checkbox" id="focus-colours-toggle" class="toolkit-checkbox">
                                           <span class="checkbox-text">Focus Colours</span>
                                       </label>
                                   </div>
                                   <div class="range-panel-section wheels-section">
                                       <h4 class="panel-section-title">Select Range</h4>
                                       <div class="clef-wheels-wrapper">
                                           <div class="clef-picker-column">
                                               <div class="clef-wheel" id="clef-bottom-wheel" tabindex="0" aria-label="Select bottom note">
                                                   <div class="clef-wheel-viewport">
                                                       <div class="clef-wheel-options"></div>
                                                   </div>
                                                   <div class="clef-wheel-overlay"></div>
                                               </div>
                                           </div>
                                           <div class="clef-picker-column">
                                               <div class="clef-wheel" id="clef-top-wheel" tabindex="0" aria-label="Select top note">
                                                   <div class="clef-wheel-viewport">
                                                       <div class="clef-wheel-options"></div>
                                                   </div>
                                                   <div class="clef-wheel-overlay"></div>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                                   <div class="range-panel-section summary-section">
                                       <h4 class="panel-section-title">Range Info</h4>
                                       <div class="clef-summary-column">
                                           <div class="clef-summary-card">
                                               <div class="clef-summary-label" id="clef-range-label">C8 - C1</div>
                                               <div class="clef-summary-metadata">
                                                   <span id="clef-range-count">88 pitches</span>
                                               </div>
                                               <div class="clef-lock-row">
                                                   <label class="clef-lock-label">
                                                       <input type="checkbox" id="clef-lock-toggle">
                                                       Lock Range
                                                   </label>
                                               </div>
                                           </div>
                                       </div>
                                   </div>
                                   <div class="range-panel-section presets-section">
                                       <h4 class="panel-section-title">Presets</h4>
                                       <div class="clef-presets-column">
                                           <div class="clef-preset-buttons">
                                               <button class="toolkit-button clef-preset-button" id="clef-full-range-button" type="button">
                                                   Full Range
                                               </button>
                                               <button class="toolkit-button clef-preset-button" id="clef-treble-button" type="button">
                                                   Treble
                                               </button>
                                               <button class="toolkit-button clef-preset-button" id="clef-alto-button" type="button">
                                                   Alto
                                               </button>
                                               <button class="toolkit-button clef-preset-button" id="clef-bass-button" type="button">
                                                   Bass
                                               </button>
                                           </div>
                                       </div>
                                   </div>
                                </div>
                        </div>
                    </div>
                        <div class="pitch-tab-panel" id="chords-panel">
            <div class="chords-content-box">
                <div class="chords-layout">
                    <div class="chords-panel-section inversion-section">
                        <h4 class="panel-section-title">Inversion</h4>
                        <div class="inversion-column">
                            <div class="toggle-switch" id="inversion-toggle">
                                <div class="toggle-slider"></div>
                                <div class="state-labels">
                                    <span class="state-label">Asc.</span>
                                    <span class="state-label">Desc.</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chords-panel-section intervals-grid-section">
                        <h4 class="panel-section-title">Intervals</h4>
                        <div class="intervals-grid-column">
                            <div class="harmony-preset-grid intervals-4x4-grid">
                                <button class="harmony-preset-button">M6</button>
                                <button class="harmony-preset-button">A6</button>
                                <button class="harmony-preset-button">m7</button>
                                <button class="harmony-preset-button">M7</button>
                                <button class="harmony-preset-button">d5</button>
                                <button class="harmony-preset-button">P5</button>
                                <button class="harmony-preset-button">A5</button>
                                <button class="harmony-preset-button">m6</button>
                                <button class="harmony-preset-button">m3</button>
                                <button class="harmony-preset-button">M3</button>
                                <button class="harmony-preset-button">P4</button>
                                <button class="harmony-preset-button">A4</button>
                                <button class="harmony-preset-button">U</button>
                                <button class="harmony-preset-button">m2</button>
                                <button class="harmony-preset-button">M2</button>
                                <button class="harmony-preset-button">A2</button>
                            </div>
                        </div>
                    </div>
                    <div class="chords-panel-section position-section">
                        <h4 class="panel-section-title">Position</h4>
                        <div class="chord-inversion-column">
                            <div class="six-state-toggle" id="chord-position-toggle-6">
                                <div class="six-state-slider"></div>
                                <div class="state-labels-6">
                                    <span class="state-label">Root</span>
                                    <span class="state-label">1st</span>
                                    <span class="state-label">2nd</span>
                                    <span class="state-label">3rd</span>
                                    <span class="state-label">4th</span>
                                    <span class="state-label">5th</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="chords-panel-section chords-grid-section">
                        <h4 class="panel-section-title">Chords</h4>
                        <div class="chords-grid-column">
                            <div class="harmony-preset-grid chords-grid chords-grid-6col" id="chords-preset-grid">
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;]" title="Major triad">X</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;]" title="Minor triad">x</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;]" title="Diminished triad">x°</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;6m&quot;]" title="Augmented triad">X+</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Dominant 7">X⁷</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;]" title="Minor 7">x⁷</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Major 7">Xmaj⁷</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;7m&quot;]" title="Half-diminished 7">ø⁷</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5d&quot;, &quot;6M&quot;]" title="Fully diminished 7">x°⁷</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Major 6">X⁶</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;2M&quot;, &quot;5P&quot;]" title="Suspended 2">Xsus2</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;4P&quot;, &quot;5P&quot;]" title="Suspended 4">Xsus4</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7M&quot;]" title="Minor-major 7">xmaj⁷</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Major add 9">Xadd9</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;9M&quot;]" title="Minor add 9">xadd9</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;6M&quot;, &quot;9M&quot;]" title="Major 6/9">X6/9</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Dominant 9">X9</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Dominant 11">X11</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;13M&quot;]" title="Dominant 13">X13</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;9M&quot;]" title="Major 9">Xmaj9</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;]" title="Minor 9">x⁹</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;6M&quot;]" title="Minor 6">x⁶</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3m&quot;, &quot;5P&quot;, &quot;7m&quot;, &quot;9M&quot;, &quot;11P&quot;]" title="Minor 11">x¹¹</button>
                                <button class="harmony-preset-button" data-chord-intervals="[&quot;1P&quot;, &quot;3M&quot;, &quot;5P&quot;, &quot;7M&quot;, &quot;11A&quot;]" title="Major 7 sharp 11 (Lydian)">Xmaj7♯11</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="pitch-tab-panel" id="mic-paint-panel">
                            <div class="paint-content-box">
                                <div class="paint-layout-grid">
                                    <div class="paint-main-controls">
                                        <div class="paint-buttons-column">
                                            <button class="toolkit-button" id="mic-paint-toggle">Mic Paint (OFF)</button>
                                            <button class="toolkit-button" id="paint-clear-btn" disabled>Clear Paint</button>
                                            <select id="mic-device-select" class="mic-device-selector">
                                                <option value="default">Default Device</option>
                                                <option value="detecting">Detecting devices...</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="paint-toggles-controls">
                                        <div class="paint-color-toggle-container">
                                            <h5>Colour</h5>
                                            <div class="two-state-toggle" id="paint-color-toggle">
                                                <div class="two-state-slider"></div>
                                                <div class="toggle-labels">
                                                    <span class="toggle-label">Chromatic</span>
                                                    <span class="toggle-label">Shape Note</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="paint-playback-toggle-container">
                                            <h5>Playback</h5>
                                            <div class="two-state-toggle active" id="paint-playback-toggle">
                                                <div class="two-state-slider"></div>
                                                <div class="toggle-labels">
                                                    <span class="toggle-label">Off</span>
                                                    <span class="toggle-label">On</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="paint-settings-controls">
                                        <div class="paint-settings-box">
                                            <h5>Trail Settings</h5>
                                            <div class="paint-control-group">
                                                <label for="sidebar-trail-thickness">Thickness</label>
                                                <select id="sidebar-trail-thickness" class="paint-control-select">
                                                    <option value="2">2px</option>
                                                    <option value="4">4px</option>
                                                    <option value="6" selected>6px</option>
                                                    <option value="8">8px</option>
                                                    <option value="10">10px</option>
                                                    <option value="12">12px</option>
                                                    <option value="14">14px</option>
                                                    <option value="16">16px</option>
                                                    <option value="18">18px</option>
                                                    <option value="20">20px</option>
                                                </select>
                                            </div>
                                            <div class="paint-control-group">
                                                <label for="sidebar-trail-opacity">Opacity</label>
                                                <select id="sidebar-trail-opacity" class="paint-control-select">
                                                    <option value="5">5%</option>
                                                    <option value="10">10%</option>
                                                    <option value="15">15%</option>
                                                    <option value="20">20%</option>
                                                    <option value="25">25%</option>
                                                    <option value="30">30%</option>
                                                    <option value="35">35%</option>
                                                    <option value="40">40%</option>
                                                    <option value="45">45%</option>
                                                    <option value="50">50%</option>
                                                    <option value="55">55%</option>
                                                    <option value="60">60%</option>
                                                    <option value="65">65%</option>
                                                    <option value="70">70%</option>
                                                    <option value="75">75%</option>
                                                    <option value="80" selected>80%</option>
                                                    <option value="85">85%</option>
                                                    <option value="90">90%</option>
                                                    <option value="95">95%</option>
                                                    <option value="100">100%</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mic-meter-container-vertical">
                                        <div class="mic-meter-wrapper-vertical" id="mic-meter-wrapper">
                                            <div class="meter-placeholder" id="meter-placeholder">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="meter-settings-panel hidden" id="meter-settings-panel">
                                    <div class="meter-setting-group">
                                        <label for="meter-size-select">Size:</label>
                                        <select id="meter-size-select" class="meter-control">
                                            <option value="compact">Compact</option>
                                            <option value="wide" selected>Wide</option>
                                        </select>
                                    </div>
                                    <div class="meter-setting-group">
                                        <label for="meter-fps-select">Frame Rate:</label>
                                        <select id="meter-fps-select" class="meter-control">
                                            <option value="12">12 FPS</option>
                                            <option value="20">20 FPS</option>
                                            <option value="30" selected>30 FPS</option>
                                            <option value="60">60 FPS</option>
                                        </select>
                                    </div>
                                    <div class="meter-setting-group">
                                        <label for="meter-battery-saver">Battery Saver:</label>
                                        <input type="checkbox" id="meter-battery-saver" class="meter-control">
                                    </div>
                                    <div class="meter-setting-group">
                                        <button class="toolkit-button" id="meter-calibrate-btn">Auto-Calibrate</button>
                                        <button class="toolkit-button" id="meter-reset-btn">Reset</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="pitch-tab-panel" id="draw-panel">
                            <div class="draw-content-box">
                                <div class="draw-layout-grid">
                                    <!-- Arrow Tool Panel -->
                                    <div class="draw-tool-panel" id="draw-arrow-controls" data-draw-tool="arrow">
                                        <div class="draw-tool-header">
                                            <button class="draw-tool-button" data-draw-tool="arrow" title="Arrow Tool">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <line x1="4" y1="20" x2="20" y2="4"/>
                                                    <polyline points="14,4 20,4 20,10"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="draw-tool-options" id="arrow-tool-options">
                                            <div class="draw-option-group">
                                                <div class="draw-toolbar-row">
                                                    <!-- Stroke weight popup -->
                                                    <div class="draw-popup-trigger">
                                                        <button class="draw-toolbar-button" title="Stroke width">
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <line x1="4" y1="12" x2="20" y2="12"/>
                                                            </svg>
                                                        </button>
                                                        <div class="draw-popup-menu">
                                                            <div class="draw-option-label">Stroke</div>
                                                            <input type="range" id="arrow-stroke-weight" min="1" max="20" value="4" aria-label="Arrow stroke weight">
                                                        </div>
                                                    </div>

                                                    <!-- Line style popup -->
                                                    <div class="draw-popup-trigger">
                                                        <button class="draw-toolbar-button" title="Line style">
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <line x1="4" y1="8" x2="20" y2="8" stroke-dasharray="4 3"/>
                                                                <line x1="4" y1="16" x2="20" y2="16"/>
                                                            </svg>
                                                        </button>
                                                        <div class="draw-popup-menu">
                                                            <div class="draw-option-label">Line Style</div>
                                                            <div class="draw-button-group">
                                                                <button class="draw-option-button active" data-line-style="solid">Solid</button>
                                                                <button class="draw-option-button" data-line-style="dashed">Dashed</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="draw-toolbar-row">
                                                    <!-- Left arrowhead popup -->
                                                    <div class="draw-popup-trigger">
                                                        <button class="draw-toolbar-button" id="arrow-start-head-trigger" title="Start head">
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <polyline points="9,5 3,12 9,19"/>
                                                                <line x1="3" y1="12" x2="21" y2="12"/>
                                                            </svg>
                                                        </button>
                                                                <div class="draw-popup-menu">
                                                                    <div class="draw-option-label">Start</div>
                                                                    <div class="draw-button-group">
                                                                    <button class="draw-option-button active" data-arrow-start="none">No head</button>
                                                                    <button class="draw-option-button" data-arrow-start="filled-arrow">Arrow</button>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                    <!-- Swap heads -->
                                                    <button class="draw-toolbar-button" id="arrow-swap-heads" title="Swap heads">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <polyline points="9 5 15 5 15 11"/>
                                                            <polyline points="15 19 9 19 9 13"/>
                                                            <line x1="9" y1="5" x2="5" y2="9"/>
                                                            <line x1="15" y1="19" x2="19" y2="15"/>
                                                        </svg>
                                                    </button>

                                                    <!-- Right arrowhead popup -->
                                                    <div class="draw-popup-trigger">
                                                        <button class="draw-toolbar-button" id="arrow-end-head-trigger" title="End head">
                                                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                                <polyline points="15,5 21,12 15,19"/>
                                                                <line x1="3" y1="12" x2="21" y2="12"/>
                                                            </svg>
                                                        </button>
                                                                <div class="draw-popup-menu">
                                                                    <div class="draw-option-label">End</div>
                                                                    <div class="draw-button-group">
                                                                    <button class="draw-option-button active" data-arrow-end="filled-arrow">Arrow</button>
                                                                    <button class="draw-option-button" data-arrow-end="none">No head</button>
                                                                    </div>
                                                                    <div class="draw-option-label">Head Size</div>
                                                                    <input type="range" id="arrow-head-size" min="8" max="32" value="12" aria-label="Arrowhead size">
                                                                </div>
                                                            </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Text Tool Panel -->
                                    <div class="draw-tool-panel" id="draw-text-controls" data-draw-tool="text">
                                        <div class="draw-tool-header">
                                            <button class="draw-tool-button" data-draw-tool="text" title="Text Tool">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="4,7 4,4 20,4 20,7"/>
                                                    <line x1="12" y1="4" x2="12" y2="20"/>
                                                    <line x1="9" y1="20" x2="15" y2="20"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="draw-tool-options" id="text-tool-options">
                                            <div class="draw-option-group draw-toolbar-row">
                                                <!-- Size popup -->
                                                <div class="draw-popup-trigger">
                                                    <button class="draw-toolbar-button" title="Text size">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M4 18h16"/>
                                                            <path d="M8 18l4-12 4 12"/>
                                                            <path d="M10 12h4"/>
                                                        </svg>
                                                    </button>
                                                    <div class="draw-popup-menu">
                                                        <div class="draw-option-label">Size (px)</div>
                                                        <input type="number" id="text-size-input" min="8" max="72" value="16" aria-label="Text size (px)">
                                                    </div>
                                                </div>

                                                <!-- Colour popup -->
                                                <div class="draw-popup-trigger">
                                                    <button class="draw-toolbar-button" title="Text colour">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M12 3l6 16"/>
                                                            <path d="M6 19l6-16"/>
                                                            <path d="M10 12h4"/>
                                                        </svg>
                                                    </button>
                                                    <div class="draw-popup-menu">
                                                        <div class="draw-option-label">Colour</div>
                                                        <div class="draw-color-picker">
                                                            <button class="draw-color-button active" data-color="#000000" style="background-color: #000000;" aria-label="Black text"></button>
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue text"></button>
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red text"></button>
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green text"></button>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Style buttons -->
                                                <div class="text-style-rows">
                                                    <div class="draw-button-group">
                                                        <button class="draw-option-button" data-text-style="bold">B</button>
                                                        <button class="draw-option-button" data-text-style="italic">I</button>
                                                        <button class="draw-option-button" data-text-style="underline">U</button>
                                                    </div>
                                                    <div class="draw-button-group">
                                                        <button class="draw-option-button" data-text-style="background">Bg</button>
                                                        <button class="draw-option-button" data-text-style="superscript">x<sup>2</sup></button>
                                                        <button class="draw-option-button" data-text-style="subscript">x<sub>2</sub></button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Marker Tool Panel -->
                                    <div class="draw-tool-panel" id="draw-marker-controls" data-draw-tool="marker">
                                        <div class="draw-tool-header">
                                            <button class="draw-tool-button" data-draw-tool="marker" title="Marker Tool">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <!-- Pointed marker tip -->
                                                    <path d="M18 2L6 14l-2 6 6-2L22 6l-4-4z"/>
                                                    <line x1="10" y1="18" x2="6" y2="14"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="draw-tool-options" id="marker-tool-options">
                                            <div class="draw-option-group draw-toolbar-row">
                                                <!-- Size popup -->
                                                <div class="draw-popup-trigger">
                                                    <button class="draw-toolbar-button" title="Marker size">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M6 19l12-14"/>
                                                            <path d="M6 19l-2 4 4-2"/>
                                                        </svg>
                                                    </button>
                                                    <div class="draw-popup-menu">
                                                        <div class="draw-option-label">Size</div>
                                                        <input type="range" id="marker-size-input" min="2" max="20" value="6" aria-label="Marker size">
                                                    </div>
                                                </div>

                                                <!-- Colours popup -->
                                                <div class="draw-popup-trigger">
                                                    <button class="draw-toolbar-button" title="Marker colour">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <path d="M19 4l-7 7"/>
                                                            <path d="M5 20l3.5-1.5"/>
                                                            <path d="M16 7l1.5 1.5"/>
                                                        </svg>
                                                    </button>
                                                    <div class="draw-popup-menu">
                                                        <div class="draw-option-label">Colours</div>
                                                        <div class="draw-color-picker">
                                                            <button class="draw-color-button" data-color="#4a90e2" style="background-color: #4a90e2;" aria-label="Blue marker"></button>
                                                            <button class="draw-color-button" data-color="#2d2d2d" style="background-color: #2d2d2d;" aria-label="Black marker"></button>
                                                            <button class="draw-color-button" data-color="#d66573" style="background-color: #d66573;" aria-label="Red marker"></button>
                                                            <button class="draw-color-button" data-color="#68a03f" style="background-color: #68a03f;" aria-label="Green marker"></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Highlighter Tool Panel -->
                                    <div class="draw-tool-panel" id="draw-highlighter-controls" data-draw-tool="highlighter">
                                        <div class="draw-tool-header">
                                            <button class="draw-tool-button" data-draw-tool="highlighter" title="Highlighter Tool">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" opacity="0.5">
                                                    <!-- Flat highlighter head -->
                                                    <rect x="3" y="3" width="4" height="18" rx="1"/>
                                                    <path d="M7 5h12l-2 14H7z"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="draw-tool-options" id="highlighter-tool-options">
                                            <div class="draw-option-group draw-toolbar-row">
                                                <!-- Size popup -->
                                                <div class="draw-popup-trigger">
                                                    <button class="draw-toolbar-button" title="Highlighter size">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <rect x="5" y="5" width="10" height="10" rx="2"/>
                                                            <path d="M9 15l-2 4"/>
                                                        </svg>
                                                    </button>
                                                    <div class="draw-popup-menu">
                                                        <div class="draw-option-label">Size</div>
                                                        <input type="range" id="highlighter-size-input" min="4" max="30" value="10" aria-label="Highlighter size">
                                                    </div>
                                                </div>

                                                <!-- Colours popup -->
                                                <div class="draw-popup-trigger">
                                                    <button class="draw-toolbar-button" title="Highlighter colour">
                                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                            <rect x="7" y="7" width="10" height="10" rx="2"/>
                                                        </svg>
                                                    </button>
                                                    <div class="draw-popup-menu">
                                                        <div class="draw-option-label">Colours</div>
                                                        <div class="draw-color-picker">
                                                            <button class="draw-color-button" data-color="#9fc5ff" style="background-color: #9fc5ff;" aria-label="Light blue highlighter"></button>
                                                            <button class="draw-color-button" data-color="#c2c2c2" style="background-color: #c2c2c2;" aria-label="Gray highlighter"></button>
                                                            <button class="draw-color-button" data-color="#ffd166" style="background-color: #ffd166;" aria-label="Yellow highlighter"></button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Lasso Tool Panel -->
                                    <div class="draw-tool-panel" id="draw-lasso-controls" data-draw-tool="lasso">
                                        <div class="draw-tool-header">
                                            <button class="draw-tool-button" data-draw-tool="lasso" title="Lasso Select">
                                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-dasharray="3 2">
                                                    <ellipse cx="12" cy="12" rx="8" ry="6" transform="rotate(-15 12 12)"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="draw-tool-options" id="lasso-tool-options">
                                            <div class="draw-option-group draw-toolbar-row">
                                                <div class="draw-option-help">
                                                    Draw around notes to select and drag them as a group.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rhythm Tab -->
            <div class="tab-panel" id="rhythm-panel">
                <!-- Controls Section (Separate) -->
                <div class="control-section rhythm-controls-container">
                    <div class="rhythm-controls-section">
                        <button class="rhythm-tab-button rhythm-controls-tab-button active" disabled>Controls</button>
                        <div class="rhythm-controls-content-box">
                            <div class="tempo-content-box">
                                <div class="tempo-container rhythm-controls-grid">
                                    <div class="tempo-boxes-container tempo-column">
                                        <div class="tempo-input-group tempo-row">
                                            <img src="assets/tabicons/eigthNote.svg" alt="Eighth Note Tempo" class="tempo-label-icon">
                                            <div id="eighth-note-tempo"></div>
                                        </div>
                                        <div class="tempo-input-group tempo-row">
                                            <img src="assets/tabicons/quarterNote.svg" alt="Quarter Note Tempo" class="tempo-label-icon">
                                            <div id="quarter-note-tempo"></div>
                                        </div>
                                        <div class="tempo-input-group tempo-row">
                                            <img src="assets/tabicons/dottedQuarterNote.svg" alt="Dotted Quarter Note Tempo" class="tempo-label-icon">
                                            <div id="dotted-quarter-tempo"></div>
                                        </div>
                                    </div>
                                    <div class="tempo-slider-container tempo-column-2">
                                        <input type="range" id="tempo-slider" min="30" max="240" value="90">
 </div>
                                </div>
                            </div>
                            <div class="rhythm-structure-container">
                                <div class="control-subsection">
                                    <h4>Add/Del Beat</h4>
                                    <div class="macrobeat-adjust-group">
                                        <button class="toolkit-button" id="macrobeat-decrease">–</button>
                                        <button class="toolkit-button" id="macrobeat-increase">+</button>
                                    </div>
                                </div>
                                <div class="control-subsection">
                                    <h4>Pickup</h4>
                                    <div class="toggle-button-group"><button class="sidebar-toggle-button" id="anacrusis-on-btn">On</button><button class="sidebar-toggle-button" id="anacrusis-off-btn">Off</button></div>
                                </div>
                            </div>
                            <div class="modulation-container">
                                <div class="control-subsection">
                                    <h4>Modulation</h4>
                                    <div class="modulation-controls">
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-2-3-btn" data-ratio="2:3" title="Place 2:3 modulation marker (33% faster)">2:3 - 33% faster</button>
                                        <button class="toolkit-button modulation-ratio-btn" id="modulation-3-2-btn" data-ratio="3:2" title="Place 3:2 modulation marker (33% slower)">3:2 - 33% slower</button>
                                        <button class="toolkit-button" id="modulation-clear-btn" title="Clear all modulation markers">Clear</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stamps/Triplets Section (Separate) -->
                <div class="control-section rhythm-stamps-container">
                    <div class="rhythm-stamps-controls">
                        <div class="rhythm-tabs">
                            <button class="rhythm-tab-button active" data-rhythm-tab="stamps">Sixteenths</button>
                            <button class="rhythm-tab-button" data-rhythm-tab="triplets">Triplets</button>
                        </div>
                        <div class="rhythm-tab-content">
                            <div class="rhythm-tab-panel active" id="stamps-panel">
                                <div id="stamps-toolbar-container" class="stamps-toolbar-container">
                                    <!-- Stamps toolbar will be rendered here by JavaScript -->
                                </div>
                            </div>
                            <div class="rhythm-tab-panel" id="triplets-panel">
                                <div id="triplets-toolbar-container" class="triplets-toolbar-container">
                                    <!-- Triplets toolbar will be rendered here by JavaScript -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
  </nav>

  <div id="canvas-container" role="region" aria-label="Musical notation canvas">
    <div id="canvas-content">
        <div id="grids-wrapper">
            <div id="button-grid">
                <div class="button-grid-left-cell">
                    <div class="left-cell-row" id="left-cell-row-1">
                        <div id="sharp-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true">♯</div>
                    </div>
                    <div class="left-cell-row" id="left-cell-row-2">
                        <div id="flat-toggle-btn" class="accidental-btn active" role="button" tabindex="0" aria-pressed="true">♭</div>
                    </div>
                    <div class="left-cell-row" id="left-cell-row-3">
                        <div id="hz-toggle-btn" class="accidental-btn" role="button" tabindex="0" aria-pressed="false">Hz</div>
                    </div>
                </div>
                <div class="button-grid-middle-cell">
                    <div id="beat-line-button-layer">
                        <div id="time-signature-row" class="beat-line-row"></div>
                        <div id="grouping-buttons-row" class="beat-line-row"></div>
                        <div id="boundary-buttons-row" class="beat-line-row"></div>
                    </div>
                </div>
                <div class="button-grid-right-cell">
                    <!-- Null/empty cell for alignment with pitch grid right legend -->
                </div>
            </div>
            <div id="pitch-grid-wrapper">
                <div id="pitch-grid-container">
                    <div id="grid-container">
                        <div id="pitch-canvas-wrapper">
                            <canvas id="legend-left-canvas"></canvas>
                            <canvas id="notation-grid"></canvas>
                            <canvas id="legend-right-canvas"></canvas>
                            <canvas id="pitch-paint-canvas"></canvas>
                            <canvas id="playhead-canvas"></canvas>
                            <canvas id="hover-canvas"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div id="grid-scrollbar-proxy" role="scrollbar" aria-label="Horizontal scroll for notation grids" tabindex="0">
                <div class="grid-scrollbar-inner"></div>
            </div>
            <div id="drum-grid-wrapper">
                <div class="drum-grid-left-cell">
                    <!-- Reserved for future drum legends/controls -->
                </div>
                <div class="drum-grid-middle-cell">
                    <div id="drum-canvas-wrapper">
                        <canvas id="drum-grid"></canvas>
                        <canvas id="drum-playhead-canvas"></canvas>
                        <canvas id="drum-hover-canvas"></canvas>
                    </div>
                </div>
                <div class="drum-grid-right-cell">
                    <!-- Placeholder for alignment with right legend spacing -->
                </div>
            </div>
        </div>
    </div>
</div>

</main>

<!-- Notification Overlay -->
<div id="notification-overlay">
    <div class="notification-modal">
        <div class="notification-header">
            <h3 class="notification-title">Notice</h3>
            <button class="notification-close">×</button>
        </div>
        <div class="notification-message"></div>
        <div class="notification-actions">
            <button class="notification-button">OK</button>
        </div>
    </div>
</div>

<!-- ... (Print Preview Modal remains the same) ... -->
<div id="print-preview-overlay" class="hidden">
    <div id="print-preview-modal">
        <div class="print-preview-header">
            <h2>Print Preview</h2>
            <button id="print-close-button" class="close-button">×</button>
        </div>
        <div class="print-preview-content">
            <div class="print-preview-canvas-wrapper">
                <canvas id="print-preview-canvas"></canvas>
                <canvas id="print-crop-overlay"></canvas>
            </div>
            <div class="print-preview-options">
                <div class="print-info-box">
                    <p>Prints the three grids in order: button controls, pitch grid, and drum grid.</p>
                    <p>Use the crop handles on the preview to trim what gets sent to the printer.</p>
                </div>

                <h3>Layout</h3>
                <div class="print-option-row">
                    <label>Orientation</label>
                    <button id="print-orientation-toggle" class="toggle-button">Landscape</button>
                </div>
                <div class="print-option-row">
                    <label>Left Legend</label>
                    <button id="print-left-legend-toggle" class="toggle-button active">Include</button>
                </div>
                <div class="print-option-row">
                    <label>Right Legend</label>
                    <button id="print-right-legend-toggle" class="toggle-button active">Include</button>
                </div>
                <div class="print-option-row">
                    <label>Color</label>
                    <button id="print-color-mode-toggle" class="toggle-button active">Color</button>
                </div>
            </div>
        </div>
        <div class="print-preview-footer">
            <button id="print-confirm-button" class="confirm-button">Print</button>
        </div>
    </div>
</div>
<div id="print-staging-area"></div>

<script>
    // Function to save the current tab to localStorage
    function saveCurrentTab(tabId) {
        localStorage.setItem('selectedTab', tabId);
    }
    
    // Function to restore the saved tab on page load
    function restoreSavedTab() {
        const savedTab = localStorage.getItem('selectedTab') || 'timbre'; // Default to timbre if none saved
        
        // Remove active class from all tabs
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
        
        // Activate the saved tab (or default)
        const targetButton = document.querySelector(`[data-tab="${savedTab}"]`);
        const targetPanel = document.getElementById(`${savedTab}-panel`);
        
        if (targetButton && targetPanel) {
            targetButton.classList.add('active');
            targetPanel.classList.add('active');
            
            // Initialize tempo slider if rhythm tab is restored on page load
            if (savedTab === 'rhythm') {
                // Use a longer delay since page is still loading
                setTimeout(() => {
                    if (window.initTempoSliderIfNeeded) {
                        window.initTempoSliderIfNeeded();
                    }
                }, 200);
            }
        }
    }

    function preMeasureEffectsWidth() {
        const measurementPanels = Array.from(document.querySelectorAll('.preset-tab-panel'))
            .filter(panel => panel.querySelector('.effects-content-box'));

        if (!measurementPanels.length) {
            logPresetWidth('Pre-measure skipped: no effects panels found');
            return Promise.resolve(false);
        }

        logPresetWidth('Starting pre-measurement for effects panels');

        const measurementRoot = document.createElement('div');
        measurementRoot.className = 'preset-effects-premeasure-root';
        measurementRoot.style.position = 'absolute';
        measurementRoot.style.left = '-9999px';
        measurementRoot.style.top = '-9999px';
        measurementRoot.style.pointerEvents = 'none';
        measurementRoot.style.visibility = 'hidden';
        measurementRoot.style.display = 'flex';
        measurementRoot.style.alignItems = 'stretch';
        measurementRoot.style.gap = '0';
        document.body.appendChild(measurementRoot);

        let widest = 0;

        measurementPanels.forEach(panel => {
            const effectsBox = panel.querySelector('.effects-content-box');
            if (!effectsBox) {
                return;
            }

            const wrapper = document.createElement('div');
            wrapper.className = `${panel.className} active premeasure-wrapper`.trim();
            wrapper.style.display = 'flex';
            wrapper.style.flex = '0 0 auto';
            wrapper.style.alignItems = 'stretch';
            wrapper.style.minHeight = '0';

            const clone = effectsBox.cloneNode(true);
            clone.style.flex = '1 1 auto';
            clone.style.minWidth = 'fit-content';
            wrapper.appendChild(clone);
            measurementRoot.appendChild(wrapper);

            const rect = clone.getBoundingClientRect();
            const measuredWidth = rect.width || clone.scrollWidth || 0;

            logPresetWidth('Pre-measure sample', {
                panel: panel.id,
                width: measuredWidth
            });

            if (measuredWidth > widest) {
                widest = measuredWidth;
            }

            measurementRoot.removeChild(wrapper);
        });

        measurementRoot.remove();

        if (widest > 0) {
            setPresetWidthValue(widest, {
                source: 'pre-measurement',
                markAsMeasured: true
            });
            logPresetWidth('Pre-measured effects width established', widest);
            return Promise.resolve(true);
        }

        logPresetWidth('Pre-measurement produced zero width');
        return Promise.resolve(false);
    }

    const EFFECTS_WIDTH_VAR = '--preset-effects-synced-width';
    const PRESET_WIDTH_DEBUG = true;
    const rootStyle = document.documentElement ? document.documentElement.style : null;
    let hasMeasuredEffectsWidth = false;

    function logPresetWidth(message, details) {
        // Logging disabled
    }

    function logPresetBoxMetrics(context) {
        // Logging disabled
    }

    function setPresetWidthValue(width, options = {}) {
        if (!rootStyle || !(width > 0)) return;
        const { source = 'manual', markAsMeasured = false } = options;
        rootStyle.setProperty(EFFECTS_WIDTH_VAR, `${width}px`);
        if (markAsMeasured) {
            hasMeasuredEffectsWidth = true;
        }
        logPresetWidth('CSS variable updated', { width, source });
        logPresetBoxMetrics('After CSS variable update');
    }

    function setPresetWidthFromElement(element, options = {}) {
        if (!rootStyle || !element) return;
        const width = element.getBoundingClientRect().width;
        if (width > 0) {
            const sourceLabel = options.source || element.classList.value || 'element-measurement';
            const shouldMark = options.markAsMeasured ?? element.classList.contains('effects-content-box');
            setPresetWidthValue(width, { source: sourceLabel, markAsMeasured: shouldMark });
        } else {
            logPresetWidth('Skipped width update due to zero width measurement', element.classList.value || 'unknown');
        }
    }

    function syncPresetBoxWidthToActiveEffects() {
        const activeEffectsBox = document.querySelector('.preset-tab-panel.active .effects-content-box');
        if (activeEffectsBox) {
            logPresetWidth('Syncing from active effects box', activeEffectsBox.closest('.preset-tab-panel')?.id || 'unknown');
            setPresetWidthFromElement(activeEffectsBox);
            return true;
        }
        logPresetWidth('No active effects box found during sync');
        logPresetBoxMetrics('Sync attempt complete (no active effects)');
        return false;
    }

    function initPresetWidthBinding() {
        const effectsBoxes = document.querySelectorAll('.effects-content-box');
        if (!effectsBoxes.length || !rootStyle) {
            logPresetWidth('Init aborted: missing effects boxes or root style');
            return;
        }

        if ('ResizeObserver' in window) {
            const effectsWidthObserver = new ResizeObserver(entries => {
                entries.forEach(entry => {
                    const panel = entry.target.closest('.preset-tab-panel');
                    if (panel && panel.classList.contains('active')) {
                        setPresetWidthFromElement(entry.target);
                        logPresetWidth('ResizeObserver update', {
                            panel: panel.id,
                            measuredWidth: entry.target.getBoundingClientRect().width
                        });
                    } else {
                        logPresetWidth('ResizeObserver entry ignored (panel inactive)', panel ? panel.id : 'unknown');
                    }
                });
            });

            effectsBoxes.forEach(box => {
                effectsWidthObserver.observe(box);
                logPresetWidth('Observing effects box for resize', box.closest('.preset-tab-panel')?.id || 'unknown');
            });
        } else {
            logPresetWidth('ResizeObserver unavailable; relying on manual measurements');
        }

        window.addEventListener('resize', () => {
            logPresetWidth('Window resize triggered manual sync');
            if (!syncPresetBoxWidthToActiveEffects()) {
                const contentContainer = document.querySelector('.preset-effects-content');
                if (contentContainer) {
                    if (!hasMeasuredEffectsWidth) {
                        setPresetWidthFromElement(contentContainer);
                        logPresetWidth('Resize fallback used preset-effects-content width');
                    } else {
                        logPresetWidth('Resize fallback skipped (using last effects width)');
                    }
                } else {
                    logPresetWidth('No preset-effects-content container during resize fallback');
                }
                logPresetBoxMetrics('After resize fallback sync');
            }
        });

        // Initial sync for whichever tab is active on load
        if (!syncPresetBoxWidthToActiveEffects()) {
            if (hasMeasuredEffectsWidth) {
                logPresetWidth('Initial sync skipped - effects width already established');
            } else {
                const contentContainer = document.querySelector('.preset-effects-content');
                if (contentContainer) {
                    setPresetWidthFromElement(contentContainer);
                    logPresetWidth('Initial sync fallback to preset-effects-content');
                    logPresetBoxMetrics('After initial fallback');
                } else {
                    logPresetWidth('Initial sync failed: no preset-effects-content container');
                }
            }
        } else {
            logPresetWidth('Initial sync succeeded via active effects box');
        }
    }
    
    document.querySelectorAll('.tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.tab;
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tabId}-panel`).classList.add('active');
            
            // Save the selected tab to localStorage
            saveCurrentTab(tabId);
            
            // Initialize tempo slider if rhythm tab is activated
            if (tabId === 'rhythm' && window.initTempoSliderIfNeeded) {
                setTimeout(() => {
                    window.initTempoSliderIfNeeded();
                }, 50); // Small delay to ensure tab content is fully visible
            }

            if (tabId !== 'presets') {
                requestAnimationFrame(() => {
                    logPresetWidth('Tab switch (non-presets) triggering sync', tabId);
                    syncPresetBoxWidthToActiveEffects();
                    logPresetBoxMetrics('After tab switch sync');
                });
            } else {
                logPresetWidth('Tab switch to presets (using stored width)');
                requestAnimationFrame(() => {
                    logPresetBoxMetrics('Preset tab visible after switch');
                });
            }
        });
    });
    
    function initializePresetEffectsSection() {
        preMeasureEffectsWidth()
            .catch(error => {
                logPresetWidth('Pre-measurement failed', error);
            })
            .finally(() => {
                // Restore the saved tab immediately (before DOMContentLoaded)
                // This prevents layout issues with hidden tab panels
                restoreSavedTab();
                initPresetWidthBinding();
            });
    }
    initializePresetEffectsSection();
    
    document.querySelectorAll('.preset-tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.presetTab;
            document.querySelectorAll('.preset-tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            document.querySelectorAll('.preset-tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tabId}-panel`).classList.add('active');

            // Hide harmonic bins when effects tabs are selected
            const harmonicBinsContainer = document.querySelector('.harmonic-bins-container');
            if (harmonicBinsContainer) {
                if (tabId === 'reverb-delay' || tabId === 'vibrato-tremolo') {
                    harmonicBinsContainer.style.display = 'none';
                } else {
                    harmonicBinsContainer.style.display = 'flex';
                }
            }

            requestAnimationFrame(() => {
                if (tabId !== 'presets') {
                    logPresetWidth('Preset tab button switch -> syncing from effects tab', tabId);
                    syncPresetBoxWidthToActiveEffects();
                    logPresetBoxMetrics('After preset button sync');
                } else {
                    logPresetWidth('Preset tab button switch -> staying on presets, width unchanged');
                    logPresetBoxMetrics('Preset tab visible via preset button');
                }
            });
        });
    });
    
    document.querySelectorAll('.pitch-tab-button').forEach(button => {
        button.addEventListener('click', () => {
            const tabId = button.dataset.pitchTab;
            document.querySelectorAll('.pitch-tab-button').forEach(btn => btn.classList.remove('active'));
            button.classList.add('active');
            document.querySelectorAll('.pitch-tab-panel').forEach(panel => panel.classList.remove('active'));
            document.getElementById(`${tabId}-panel`).classList.add('active');
        });
    });
</script>
<script type="module" src="/js/core/main.js"></script>
</body>
</html>
